<?
header('Content-type:text/html; charset=utf-8');
session_start();
require_once('../../includes/common.php');
require_once('../../includes/class4/class.conditions.php');
require_once('../../includes/class4/class.reports.php');
require_once('../../includes/class4/class.conversions.php');

$user_id = $_SESSION['logic_erp']["user_id"];
if ($_SESSION['logic_erp']['user_id'] == "") {
	header("location:login.php");
	die;
}

$permission = $_SESSION['page_permission'];

$data = $_REQUEST['data'];
$action = $_REQUEST['action'];
$user_store_ids = $_SESSION['logic_erp']['store_location_id'];
$user_supplier_ids = $_SESSION['logic_erp']['supplier_id'];
$user_comp_location_ids = $_SESSION['logic_erp']['company_location_id'];
//--------------------------------------------------------------------------------------------

$user_lib_name=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

// Linking selected report buttons with this page
if($action=="company_wise_report_button_setting")
{
	extract($_REQUEST); // 230
	$buttonIdArr = ['109#Printt1', '110#print_vat1', '111#print_vat2', '227#print_vat15', '112#print_vat3', '89#print_vat4', '113#search1', '114#without_prog1', '172#print_vat8', '235#Printt16', '241#print_vat11', '129#print_vat9', '129#no_copy', '161#print_6', '161#organic_check', '274#print_vat17', '274#no_copy', '768#print_vat28', '768#no_copy', '764#print_fso_v2', '427#Printt12', '28#Printt13', '280#Printt14', '304#Printt15', '304#no_copy', '719#Printt17', '846#print18', '846#no_copy', '723#Printb17', '863#multiple_issue_no_print', '864#multiple_issue_no_print2', '425#print_vat21', '419#print22', '886#print_vatEKL','230#print_7'];
	$print_report_format_arr = get_report_button_array($data, 6, 37, $user_id,$buttonIdArr);
	  
	 
	$yarn_rate_match_sql=sql_select("select during_issue from variable_settings_inventory where variable_list=25 and company_name=$data and status_active=1 and is_deleted=0");
	echo "$('#yarn_rate_match').val(".$yarn_rate_match_sql[0][csf("during_issue")].");\n";

	exit();
}

if($action=="upto_variable_settings")
{
    $sql =  sql_select("select store_method from variable_settings_inventory where company_name = $data and item_category_id=1 and variable_list=21 and status_active=1 and is_deleted=0 and rack_balance=1");
	$return_data="";
    if(count($sql)>0)
	{
		$return_data=$sql[0][csf('store_method')];
	}
	else
	{
		$return_data=0;
	}

	echo $return_data;
	die;
}

//load drop down supplier
if ($action == "load_drop_down_supplier")
{
	if(trim($user_supplier_ids)) $user_supplier_cond = " and c.id in (".trim($user_supplier_ids).")";else $user_supplier_cond = "";
	echo create_drop_down("cbo_supplier", 170, "select c.supplier_name,c.id from lib_supplier_tag_company a, lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$data' $user_supplier_cond and b.party_type=2 and c.status_active=1 and c.is_deleted=0 group by c.id, c.supplier_name order by c.supplier_name", "id,supplier_name", 1, "-- Select --", 0, "", 0);
	exit();
}
if($action=="load_drop_down_supplier_new")
{
	
	extract($data);
	$exdata = explode("*",$data);
	
	$comId = $exdata[0];
	$suppId = $exdata[1];
	$user_supplier_cond = ($suppId) ? "and c.id in ($suppId)" :"";
  
	echo create_drop_down("cbo_supplier", 170, "SELECT c.supplier_name,c.id from lib_supplier_tag_company a,lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$comId' and b.party_type =2 and c.status_active IN(1) and c.is_deleted=0 group by c.id, c.supplier_name   UNION ALL  SELECT c.supplier_name,c.id from lib_supplier_tag_company a,lib_supplier_party_type b, lib_supplier c, INV_ISSUE_MASTER d where c.id=b.supplier_id and a.supplier_id = b.supplier_id and c.id=d.supplier_id and a.tag_company='$comId' $user_supplier_cond and b.party_type =2 and c.status_active IN(1,3) and c.is_deleted=0 group by c.id, c.supplier_name    order by supplier_name    ", "id,supplier_name", 1, "-- Select --", 0, "", 0);
	exit();
}
if ($action == "load_drop_down_supplier_loan")
{
	echo create_drop_down("cbo_loan_party", 170, "select c.supplier_name,c.id from lib_supplier_tag_company a, lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$data' and b.party_type=91 and c.status_active=1 and c.is_deleted=0 group by c.id, c.supplier_name order by c.supplier_name", "id,supplier_name", 1, "-- Select --", 0, "", 0);
	exit();
}

if ($action == "load_drop_down_basis")
{

	$issue_basis_requisition_or_demand_variable = return_field_value("yarn_issue_basis", "variable_settings_inventory", "company_name=$data and variable_list=28 and status_active=1 and is_deleted=0");

	$independent_basis_control_variable = return_field_value("independent_controll", "variable_settings_inventory", "company_name=$data and variable_list=20 and menu_page_id=3 and status_active=1 and is_deleted=0");

	if($issue_basis_requisition_or_demand_variable==2){

		if($independent_basis_control_variable!=1) // controll no
		{
			$issue_basis = array(1 => "Booking", 2 => "Independent", 8 => "Demand", 4 => "Sales Order");
		}else{
			$issue_basis = array(1 => "Booking", 8 => "Demand", 4 => "Sales Order");
		}

	}else{
		if($independent_basis_control_variable!=1) // controll no
		{
			$issue_basis = array(1 => "Booking", 2 => "Independent", 3 => "Requisition", 4 => "Sales Order");
		}else{
			$issue_basis = array(1 => "Booking", 3 => "Requisition", 4 => "Sales Order");
		}
	}

	echo create_drop_down( "cbo_basis", 170, $issue_basis,"", 1, "-- Select Basis --", $selected, "active_inactive(this.value);load_purpose();", "", "");
	exit();
}

if ($action == "load_drop_down_purpose")
{
	$data=explode("_",$data);
	if($data[0]==1) // Booking
	{
		echo create_drop_down("cbo_issue_purpose", 170, $yarn_issue_purpose, "", 1, "-- Select Purpose --", $selected, "load_supplier();active_inactive();change_basis(this.value)", "", "1,2,7,8,12,15,38,44,46,50,51,63,81","","","");
	}
	else
	{
		if($data[0]==2) // Independent
		{
			echo create_drop_down("cbo_issue_purpose", 170, $yarn_issue_purpose, "", 1, "-- Select Purpose --", $selected, "load_supplier();active_inactive();change_basis(this.value)", "", "3,5,6,7,12,26,29,30,39,40,45,54,74,78","","","");
		}
		else if( $data[0]==3 || $data[0]==8 ) //Requisition/Demand
		{
			if($data[2]==2) // Without order
			{
				echo create_drop_down("cbo_issue_purpose", 170, $yarn_issue_purpose, "", 1, "-- Select Purpose --", 8, "load_supplier();active_inactive();change_basis(this.value)", "", "8","","","");
			}
			else
			{
				echo create_drop_down("cbo_issue_purpose", 170, $yarn_issue_purpose, "", 1, "-- Select Purpose --", 1, "load_supplier();active_inactive();change_basis(this.value)", "", "1,4,8","","","");
			}
		}
		else // Sales Order
		{
			echo create_drop_down("cbo_issue_purpose", 170, $yarn_issue_purpose, "", 1, "-- Select Purpose --", $selected, "load_supplier();active_inactive();change_basis(this.value)", "", "1,2,4,7,8,15,16,38,46","","","");
		}
	}
	exit();
}

//load drop down company location
if ($action == "load_drop_down_location")
{
	$dataArr = explode("_", $data);
	$company_id=$dataArr[0];
	$knitting_source=$dataArr[1];

	if($knitting_source==1)
	{
		if($user_comp_location_ids) $user_comp_location_cond = " and id in ($user_comp_location_ids)"; else $user_comp_location_cond = "";

		echo create_drop_down("cbo_location_id", 170, "select id,location_name from lib_location where status_active =1 and is_deleted=0 and company_id='$company_id' $user_comp_location_cond order by location_name", "id,location_name", 1, "-- Select Location --", $selected, "", 0);
	}
	else
	{
		echo create_drop_down("cbo_location_id", 170, $blank_array, "", 1, "-- Select Location --", $selected, "", 0);
	}
	exit();
}

if ($action=="load_room_rack_self_bin")
{
	$explodeData = explode('*', $data);
	$explodeData[11] = 'storeUpdateUptoDisable();';
	$data=implode('*', $explodeData);
	load_room_rack_self_bin("requires/yarn_issue_controller",$data);
}

//load drop down based on reqsition
if ($action == "load_drop_down_store_req")
{
	echo create_drop_down("cbo_store_name", 142, "select a.id, a.store_name from lib_store_location a, lib_store_location_category b where a.id= b.store_location_id and a.id in($data) and b.category_type=1 and a.status_active=1 and a.is_deleted=0 group by a.id, a.store_name order by a.store_name", "id,store_name", 1, "-- Select Store --", $selected, "fn_empty_lot(this.value);", 0);
	exit();
}

if ($action == "load_drop_down_buyer")
{
	$data = explode("_", $data);
	if ($data[1] == 1) $party = "1,3,21,90,30"; else $party = "80";

	echo create_drop_down("cbo_buyer_name", 170, "select buy.id, buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$data[0]' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in ($party)) group by buy.id, buy.buyer_name order by buy.buyer_name", "id,buyer_name", 1, "-- Select Buyer --", $selected, "", $data[1]);
	exit();
}

if ($action == "load_drop_down_dyeing_color")
{
	$data = explode("_", $data);
	$mstid = $data[0];
	$dtlsid = $data[1];
	$dyeing_color_id = $data[2];

	if($dtlsid>0)
	{
		$dtlsCond = "and b.id=$dtlsid";
	}
	if($dyeing_color_id>0)
	{
		$dyeingColorCond = "and b.yarn_color=$dyeing_color_id";
	}

	echo create_drop_down("cbo_dyeing_color", 142, "select a.id, a.color_name from lib_color a, wo_yarn_dyeing_dtls b where a.id=b.yarn_color and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and b.mst_id='$mstid' $dtlsCond $dyeingColorCond group by a.id, a.color_name order by a.color_name", "id,color_name", 1, "-- Select --", $selected, "", $color_id);
	exit();
}


//load drop down knitting company
if ($action == "load_drop_down_knit_com")
{
	$exDataArr = explode("**", $data);
	$knit_source = $exDataArr[0];
	$company = $exDataArr[1];
	$issuePurpose = $exDataArr[2];

	if ($company == "" || $company == 0) $company_cod = ""; else $company_cod = " and id=$company";

	// $party_cond = ($issuePurpose == 1)? " and b.party_type in(1,9,20)" : " and b.party_type in(1,9,21,24)";
	if($issuePurpose == 1)
	{
		$party_cond = " and b.party_type in(1,9,20)";
	}
	else if($issuePurpose == 8 || $issuePurpose == 15)
	{
		$party_cond = " and b.party_type in(1,9,20,21,24)";
	}
	else
	{
		$party_cond = " and b.party_type in(1,9,21,24)";
	}

	if ($knit_source == 1 )
	{
		echo create_drop_down("cbo_knitting_company", 170, "select id,company_name from lib_company where status_active=1 and is_deleted=0 order by company_name", "id,company_name", 1, "-- Select --", "", "load_drop_down( 'requires/yarn_issue_controller', this.value+'_'+$knit_source, 'load_drop_down_location', 'location_td' );");
	}
	else
	{
		echo create_drop_down("cbo_knitting_company", 170, "select a.id,a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id $party_cond and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id,supplier_name", 1, "-- Select --", 0, "load_drop_down( 'requires/yarn_issue_controller', this.value+'_'+$knit_source, 'load_drop_down_location', 'location_td' );", 0);
	}

	/* else if ($knit_source == 3 && $issuePurpose == 1)
		echo create_drop_down("cbo_knitting_company", 170, "select a.id,a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(1,9,20) and a.status_active=1 group by a.id, a.supplier_name order by a.supplier_name", "id,supplier_name", 1, "-- Select --", 0, "load_drop_down( 'requires/yarn_issue_controller', this.value+'_'+$knit_source, 'load_drop_down_location', 'location_td' );", 0);
	else if ($knit_source == 3 && $issuePurpose == 2)
		echo create_drop_down("cbo_knitting_company", 170, "select a.id,a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(1,9,21,24) and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id,supplier_name", 1, "-- Select --", 0, "load_drop_down( 'requires/yarn_issue_controller', this.value+'_'+$knit_source, 'load_drop_down_location', 'location_td' );", 0);

	else if ($knit_source == 3)
		echo create_drop_down("cbo_knitting_company", 170, "select a.id,a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id,supplier_name", 1, "-- Select --", 0, "load_drop_down( 'requires/yarn_issue_controller', this.value+'_'+$knit_source, 'load_drop_down_location', 'location_td' );", 0);

		else if ($knit_source == 0)
		echo create_drop_down("cbo_knitting_company", 170, $blank_array, "", 1, "-- Select --", $selected, "", "", "");
	*/

	exit();
}

// wo/pi popup here----------------------//
if ($action == "fabbook_popup")
{
	echo load_html_head_contents("Popup Info", "../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>

		function fn_check()
		{
            /*if(form_validation('cbo_buyer_name','Buyer Name')==false )
             return;
             else*/
             	show_list_view(document.getElementById('cbo_buyer_name').value + '_' + document.getElementById('cbo_search_by').value + '_' + document.getElementById('txt_search_common').value + '_' + document.getElementById('txt_date_from').value + '_' + document.getElementById('txt_date_to').value + '_' + '<? echo $company; ?>' +
             		'_' + '<? echo $issue_purpose; ?>' +
             		'_' + '<? echo $basis; ?>', 'create_fabbook_search_list_view', 'search_div', 'yarn_issue_controller', 'setFilterGrid(\'list_view\',-1)'
             		)
             ;
        }

        function js_set_value(booking_dtls)
		{
         	$("#hidden_booking_number").val(booking_dtls);
			if (booking_dtls!="") str=booking_dtls.split("__");
			var is_approved=str[10];
			var approved_setting=str[11];
			var entry_form=str[5];
			if (entry_form==135)
			{
				if(is_approved==3 && approved_setting ==1)
				{
					alert("Work Order is Partial Approved. Please Approve it to Select"); return;
				}
				else if(is_approved!=1 && is_approved!=3 && approved_setting ==1)
				{
					alert("Work Order is not Approved. Please Approve it to Select"); return;
				}
			}
         	parent.emailwindow.hide();
        }
     </script>
 </head>
 <body>
 	<div align="center" style="width:100%;">
 		<form name="searchorderfrm_1" id="searchorderfrm_1" autocomplete="off">
 			<table width="800" cellspacing="0" cellpadding="0" border="1" rules="all" class="rpt_table" align="center">
 				<thead>
 					<tr>
 						<th>Buyer Name</th>
 						<th>Search By</th>
 						<th align="center" id="search_by_td_up">Enter WO/PI Number</th>
 						<th width="200">Date Range</th>
 						<th><input type="reset" name="re_button" id="re_button" value="Reset" style="width:100px"
 							class="formbutton"/></th>
 						</tr>
 					</thead>
 					<tbody>
 						<tr class="general">
 							<td>
 								<?
 								if ($basis == 4) {
 									$search_by = array(1 => "Sales Order No", 2 => "Sales / Booking No", 3 => "Style Ref.");
 									$dd = "change_search_event(this.value, '0*0*0', '0*0*0', '../../')";
 									$disable = 1;
 								} else {
 									$search_by = array(1 => 'Booking No', 2 => 'Buyer Order', 3 => 'Job No', 4 => "Internal Ref", 5 => "File No");
 									$dd = "change_search_event(this.value, '0*0*0*0*0', '0*0*0*0*0', '../../')";
 									$disable = 0;
 								}

 								echo create_drop_down("cbo_buyer_name", 150, "select buy.id, buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$company' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,30,90)) group by buy.id, buy.buyer_name order by buy.buyer_name", "id,buyer_name", 1, "-- Select --", $selected, "", $disable);
 								?>
 							</td>
 							<td>
 								<?
 								echo create_drop_down("cbo_search_by", 130, $search_by, "", 0, "--Select--", "", $dd, 0);
 								?>
 							</td>
 							<td width="180" align="center" id="search_by_td">
 								<input type="text" style="width:130px" class="text_boxes" name="txt_search_common"
 								id="txt_search_common"/>
 							</td>

 							<td align="center">
 								<input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:70px"
 								placeholder="From Date"/>
 								<input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:70px"
 								placeholder="To Date"/>
 							</td>
 							<td align="center">
 								<input type="button" name="btn_show" class="formbutton" value="Show" onClick="fn_check()"
 								style="width:100px;"/>
 							</td>
 						</tr>
 						<tr>
 							<td align="center" height="40" valign="middle" colspan="7">
 								<? echo load_month_buttons(1); ?>
 								<!-- Hidden field here -->
 								<input type="hidden" id="hidden_booking_id" value=""/>
 								<input type="hidden" id="hidden_booking_number" value=""/>
 								<!---END -->
 							</td>
 						</tr>
 					</tbody>
 				</tr>
 			</table>
 			<div align="center" valign="top" id="search_div"></div>
 		</form>
 	</div>
 </body>
 <script src="../../includes/functions_bottom.js" type="text/javascript"></script>
 </html>
 <?
}

if ($action == "create_fabbook_search_list_view")
{

	$ex_data = explode("_", $data);
	$buyer = $ex_data[0];
	$txt_search_by = $ex_data[1];
	$txt_search_common = trim($ex_data[2]);
	$txt_date_from = $ex_data[3];
	$txt_date_to = $ex_data[4];
	$company = $ex_data[5];
	$issue_purpose = $ex_data[6];
	$basis = $ex_data[7];

	if ($basis == 4)
	{
		$company_arr = return_library_array("select id,company_name from lib_company", 'id', 'company_name');
		$buyer_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');
		$location_arr = return_library_array("select id, location_name from lib_location", 'id', 'location_name');

		$search_field_cond = '';
		if ($txt_search_common != "")
		{
			if ($txt_search_by == 1) {
				$search_field_cond = " and a.job_no like '%" . $txt_search_common . "'";
			} else if ($txt_search_by == 2) {
				$search_field_cond = " and a.sales_booking_no like '%" . $txt_search_common . "'";
			} else {
				$search_field_cond = " and a.style_ref_no like '" . $txt_search_common . "%'";
			}
		}

		if ($db_type == 0) $year_field = "YEAR(a.insert_date) as year";
		else if ($db_type == 2) $year_field = "to_char(a.insert_date,'YYYY') as year";
		else $year_field = "";

		if($issue_purpose == 4)
		{
			$sql = "select a.id,$year_field,a.job_no_prefix_num, a.job_no fso_no, a.within_group, a.sales_booking_no, a.booking_date, a.buyer_id,a.po_buyer,a.po_job_no,a.style_ref_no,a.location_id from fabric_sales_order_mst a,wo_booking_mst b where a.sales_booking_no=b.booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.booking_type=4 and a.within_group=1 and a.company_id=$company $search_field_cond order by a.id DESC";
		}
		else if($issue_purpose == 8)
		{
			$sql = "select a.id, $year_field, a.job_no_prefix_num, a.job_no fso_no, a.within_group, a.sales_booking_no, a.booking_date, a.buyer_id,a.po_buyer,a.po_job_no,a.style_ref_no,a.location_id from fabric_sales_order_mst a,wo_non_ord_samp_booking_mst b where a.sales_booking_no=b.booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.booking_type=4 and a.within_group=1 and a.company_id=$company $search_field_cond order by a.id DESC";
		}
		else
		{
			$sql = "select a.id, $year_field, a.job_no_prefix_num, a.job_no fso_no, a.within_group, a.sales_booking_no, a.booking_date, a.buyer_id,a.po_buyer,a.po_job_no,a.style_ref_no,a.location_id from fabric_sales_order_mst a where a.status_active=1 and a.is_deleted=0 and a.within_group=1 and a.company_id=$company $search_field_cond order by a.id DESC";
		}
		//echo $sql;

		$result = sql_select($sql);
		?>
		<div style="margin-top:5px">
			<table cellspacing="0" cellpadding="0" border="1" rules="all" width="920" class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="70">Job No.</th>
					<th width="60">Year</th>
					<th width="80">Within Group</th>
					<th width="140">Buyer</th>
					<th width="150">Sales/ Booking No</th>
					<th width="80">Booking date</th>
					<th width="140">Style Ref.</th>
					<th>Location</th>
				</thead>
			</table>
			<div style="width:920px; max-height:260px; overflow-y:scroll" id="list_container_batch" align="left">
				<table cellspacing="0" cellpadding="0" border="1" rules="all" width="900" class="rpt_table"
				id="list_view">
				<?
				$i = 1;
				foreach ($result as $row)
				{
					if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";

					if ($row[csf('within_group')] == 1)
					{
						$buyer_id = $row[csf('po_buyer')];
						$buyer_name = $buyer_arr[$row[csf('po_buyer')]];
						$job_no=$row[csf('po_job_no')];
					}
					else
					{
						$buyer_id = $row[csf('buyer_id')];
						$buyer_name = $buyer_arr[$row[csf('buyer_id')]];
						$job_no=$row[csf('job_no')];
					}
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
						onClick="js_set_value('<? echo $row[csf('id')]; ?>__<? echo $row[csf('fso_no')]; ?>__<? echo $buyer_id; ?>__<? echo $buyer_name; ?>__<? echo $row[csf('style_ref_no')]; ?>__<? echo $job_no; ?>');">
						<td width="40"><? echo $i; ?></td>
						<td width="70"><p>&nbsp;<? echo $row[csf('job_no_prefix_num')]; ?></p></td>
						<td width="60" align="center"><p><? echo $row[csf('year')]; ?></p></td>
						<td width="80"><p><? echo $yes_no[$row[csf('within_group')]]; ?>&nbsp;</p></td>
						<td width="140"><p><? echo $buyer_name; ?>&nbsp;</p></td>
						<td width="150"><p><? echo $row[csf('sales_booking_no')]; ?></p></td>
						<td width="80" align="center"><? echo change_date_format($row[csf('booking_date')]); ?></td>
						<td width="140"><p><? echo $row[csf('style_ref_no')]; ?></p></td>
						<td><p><? echo $location_arr[$row[csf('location_id')]]; ?></p></td>
					</tr>
					<?
					$i++;
				}
				?>
			</table>
		</div>
		</div>
		<?
	}
	else
	{
		$sql_cond = "";
		if (trim($txt_search_common) != "")
		{

			if (trim($txt_search_by) == 1)
			{
				// for Booking No
				$sql_cond .= " and a.booking_no LIKE '%$txt_search_common'";
			}
			else if (trim($txt_search_by) == 2)
			{
				// for buyer order
				// wo_po_break_down
				$sql_cond .= " and b.po_number LIKE '%$txt_search_common%'";
			}
			else if (trim($txt_search_by) == 3)
			{
					 // for job no
				$sql_cond .= " and a.job_no LIKE '%$txt_search_common%'";
			}
			else if (trim($txt_search_by) == 4)
			{
					// for Internal Ref no
				$sql_cond = " and b.grouping LIKE '%$txt_search_common%'";
			}
			else if (trim($txt_search_by) == 5)
			{
					// for File no
				$sql_cond = " and b.file_no LIKE '%$txt_search_common%'";
			}
		}

		if ($txt_date_from != "" && $txt_date_to != "")
		{
			if ($db_type == 0)
			{
				$sql_cond .= " and a.booking_date between '" . change_date_format($txt_date_from, 'yyyy-mm-dd') . "' and '" . change_date_format($txt_date_to, 'yyyy-mm-dd') . "'";
			}
			else
			{
				$sql_cond .= " and a.booking_date between '" . change_date_format($txt_date_from, '', '', 1) . "' and '" . change_date_format($txt_date_to, '', '', 1) . "'";
			}
		}

		if (trim($company) != 0) $sql_cond .= " and a.company_id='$company'";
		if (trim($buyer) != 0) $sql_cond .= " and a.buyer_id='$buyer'";
		if (trim($issue_purpose) == 1) $sql_cond .= " and a.booking_type!=4";
		else if (trim($issue_purpose) == 4) $sql_cond .= " and a.booking_type=4";

		if (trim($issue_purpose) == 8)
		{
			$sql = "select a.id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.po_break_down_id, a.item_category, a.delivery_date, a.job_no as job_no_mst, a.is_approved, c.current_approval_status
			from wo_non_ord_samp_booking_mst a left join approval_history c on c.mst_id = a.id and c.entry_form = 9, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $sql_cond and a.fabric_source!=2 group by a.id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.po_break_down_id, a.item_category, a.delivery_date, a.job_no, a.is_approved, c.current_approval_status";
		}
		else if ( trim($issue_purpose) == 2 || trim($issue_purpose) == 7 || trim($issue_purpose) == 12 || trim($issue_purpose) == 15 || trim($issue_purpose) == 38 || trim($issue_purpose) == 44 || trim($issue_purpose) == 46 || trim($issue_purpose) == 50 || trim($issue_purpose) == 51 )
		{
			$sql_cond = '';
			if (trim($txt_search_by) == 1)
			{
				// for Booking No
				$sql_cond .= " and a.ydw_no LIKE '%$txt_search_common'";
			} else if (trim($txt_search_by) == 3)
			{
				// for job no
				$sql_cond .= " and b.job_no LIKE '%$txt_search_common%'";
			}

			if ($txt_date_from != "" && $txt_date_to != "")
			{
				if ($db_type == 0)
				{
					$sql_cond .= " and a.booking_date between '" . change_date_format($txt_date_from, 'yyyy-mm-dd') . "' and '" . change_date_format($txt_date_to, 'yyyy-mm-dd') . "'";
				}
				else
				{
					$sql_cond .= " and a.booking_date between '" . change_date_format($txt_date_from, '', '', 1) . "' and '" . change_date_format($txt_date_to, '', '', 1) . "'";
				}
			}

			if (trim($company) != 0) $sql_cond .= " and a.company_id='$company'";

			$job_arr = array();
			$job_data = sql_select("select a.id as job_id,a.buyer_name, a.style_ref_no, b.id, b.po_number, b.pub_shipment_date, b.po_quantity, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.status_active=1 and b.is_deleted=0");
			foreach ($job_data as $row) {
				$job_arr[$row[csf('job_id')]] .= $row[csf('po_number')] . "**" . $row[csf('pub_shipment_date')] . "**" . $row[csf('po_quantity')] . "**" . $row[csf('po_qnty_in_pcs')] . "**" . $row[csf('style_ref_no')] . "**" . $row[csf('buyer_name')] . ",";
			}

			if( trim($issue_purpose) == 2 )
			{
				$entry_form_cond = " and a.entry_form in(41,42,114,125,135)";
			}
			else
			{
				$entry_form_cond = "  and a.entry_form in(94,340) and a.service_type=$issue_purpose";
			}

			if ($db_type == 0)
			{
				if (trim($buyer) == 0)
				{
					$sql = "select a.id, a.yarn_dyeing_prefix_num as booking_no_prefix_num, a.entry_form, a.ydw_no as booking_no,(b.booking_no || b.fab_booking_no) fab_booking_no, a.booking_date, a.is_approved, a.delivery_date, 1 as item_category, group_concat(distinct(b.job_no)) as job_no_mst, group_concat(distinct(b.job_no_id)) as job_no_id,a.supplier_id,a.source,a.service_type,a.pay_mode,a.pay_mode,max(c.buyer_name) as buyer_id
					from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b left join sample_development_mst c on b.job_no_id=c.id
					where
					a.id=b.mst_id and
					a.status_active=1 and
					a.is_deleted=0 and
					b.status_active=1 and
					b.is_deleted=0
					$sql_cond $entry_form_cond
					group by a.id, a.yarn_dyeing_prefix_num, a.ydw_no,b.booking_no , b.fab_booking_no, a.entry_form, a.booking_date, a.is_approved, a.delivery_date,a.supplier_id,a.source,a.service_type,a.pay_mode

					order by a.entry_form";
				}
				else
				{
					$sql_cond .= " and c.buyer_name='$buyer'";
					$sql = "select a.id, a.yarn_dyeing_prefix_num as booking_no_prefix_num, a.entry_form, a.ydw_no as booking_no,(b.booking_no || b.fab_booking_no) fab_booking_no, a.booking_date, a.is_approved, a.delivery_date, 1 as item_category, group_concat(distinct(c.job_no)) as job_no_mst, group_concat(distinct(c.id)) as job_no_id,a.supplier_id,a.source,a.service_type,a.pay_mode
					from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b, wo_po_details_master c
					where
					a.id=b.mst_id and
					b.job_no_id=c.id and
					a.status_active=1 and
					a.is_deleted=0 and
					b.status_active=1 and
					b.is_deleted=0
					and a.entry_form in(41,125)
					$sql_cond $entry_form_cond
					group by a.id, a.yarn_dyeing_prefix_num, a.ydw_no, b.booking_no , b.fab_booking_no, a.entry_form, a.booking_date, a.is_approved, a.delivery_date,a.supplier_id,a.source,a.service_type,a.pay_mode
					order by a.entry_form";
				}
			}
			else
			{
				if (trim($buyer) == 0)
				{
					if ($issue_purpose==4 || $issue_purpose==8)
					{
						$sql = "select a.id, a.yarn_dyeing_prefix_num as booking_no_prefix_num, a.entry_form, a.ydw_no as booking_no, a.booking_date,(b.booking_no || b.fab_booking_no) fab_booking_no, a.delivery_date, 1 as item_category, LISTAGG(cast(b.job_no as varchar(4000)), ',') WITHIN GROUP (ORDER BY b.job_no_id) as job_no_mst, LISTAGG(b.job_no_id, ',') WITHIN GROUP (ORDER BY b.job_no_id) as job_no_id,a.supplier_id,a.source,a.service_type,a.pay_mode, max(c.buyer_name) as buyer_id
						from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b left join sample_development_mst c on b.job_no_id=c.id
						where
						a.id=b.mst_id and
						a.status_active=1 and
						a.is_deleted=0 and
						b.status_active=1 and
						b.is_deleted=0
						$sql_cond $entry_form_cond
						group by a.id, a.yarn_dyeing_prefix_num, a.ydw_no, b.booking_no , b.fab_booking_no, a.entry_form, a.booking_date, a.delivery_date,a.supplier_id,a.source,a.service_type,a.pay_mode order by a.id DESC";
					}
					else
					{

						$sql = "select a.id, a.yarn_dyeing_prefix_num as booking_no_prefix_num, a.entry_form, a.ydw_no as booking_no,(b.booking_no || b.fab_booking_no) fab_booking_no, a.booking_date, a.is_approved, a.delivery_date, 1 as item_category,a.is_sales, LISTAGG(cast(b.job_no as varchar(4000)), ',') WITHIN GROUP (ORDER BY b.job_no_id) as job_no_mst, LISTAGG(b.job_no_id, ',') WITHIN GROUP (ORDER BY b.job_no_id) as job_no_id,a.supplier_id,a.source,a.service_type,a.pay_mode, max(c.buyer_name) as buyer_id, d.buyer_id as sample_buyer_id,e.within_group,e.po_buyer,e.buyer_id as sales_buyer_id from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b
							left join wo_po_details_master c on b.job_no_id=c.id
							left join wo_non_ord_samp_booking_mst d on b.booking_no=d.booking_no
							left join fabric_sales_order_mst e on e.job_no=b.job_no
						where
						a.id=b.mst_id and
						a.status_active=1 and
						a.is_deleted=0 and
						b.status_active=1 and
						b.is_deleted=0
						$sql_cond $entry_form_cond
						group by a.id, a.yarn_dyeing_prefix_num, a.ydw_no,b.booking_no, b.fab_booking_no, a.entry_form, a.booking_date, a.is_approved, a.delivery_date,a.is_sales,a.supplier_id,a.source,a.service_type,a.pay_mode,d.buyer_id,e.within_group,e.po_buyer,e.buyer_id order by a.id DESC ";

						//echo $sql;
					}
				}
				else
				{
					$sql_cond .= " and c.buyer_name='$buyer'";
					$sql = "select a.id, a.yarn_dyeing_prefix_num as booking_no_prefix_num, a.entry_form, a.ydw_no as booking_no,(b.booking_no || b.fab_booking_no) fab_booking_no, a.booking_date, a.is_approved, a.delivery_date, 1 as item_category, max(c.buyer_name) as buyer_id, LISTAGG(cast(b.job_no as varchar(4000)), ',') WITHIN GROUP (ORDER BY c.job_no) as job_no_mst, LISTAGG(c.id, ',') WITHIN GROUP (ORDER BY c.id) as job_no_id,a.supplier_id,a.source,a.service_type,a.pay_mode
					from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b, wo_po_details_master c
					where
					a.id=b.mst_id and
					b.job_no_id=c.id and
					a.status_active=1 and
					a.is_deleted=0 and
					b.status_active=1 and
					b.is_deleted=0
					and a.entry_form in(41,125)
					$sql_cond $entry_form_cond
					group by a.id, a.yarn_dyeing_prefix_num, a.ydw_no, b.booking_no, b.fab_booking_no, a.entry_form, a.booking_date, a.is_approved, a.delivery_date,a.supplier_id,a.source,a.service_type,a.pay_mode order by a.id DESC";

					//echo $sql;
				}
			}
		}
		else
		{
			// check variable settings if allocation is available or not
			$variable_set_allocation = return_field_value("allocation", "variable_settings_inventory", "company_name=$company and variable_list=18 and item_category_id = 1");
			$po_arr = array();
			$po_data = sql_select("select a.style_ref_no, b.id, b.po_number, b.pub_shipment_date, b.file_no, b.grouping, b.po_quantity, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst");
			foreach ($po_data as $row) {
				$po_arr[$row[csf('id')]] = $row[csf('po_number')] . "**" . $row[csf('pub_shipment_date')] . "**" . $row[csf('po_quantity')] . "**" . $row[csf('po_qnty_in_pcs')] . "**" . $row[csf('style_ref_no')] . "**" . $row[csf('grouping')] . "**" . $row[csf('file_no')];
			}

			$po_arr = array();
			$po_data = sql_select("select a.style_ref_no, b.id, b.po_number, b.pub_shipment_date, b.file_no, b.grouping, b.po_quantity, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst");
			foreach ($po_data as $row) {
				$po_arr[$row[csf('id')]] = $row[csf('po_number')] . "**" . $row[csf('pub_shipment_date')] . "**" . $row[csf('po_quantity')] . "**" . $row[csf('po_qnty_in_pcs')] . "**" . $row[csf('style_ref_no')] . "**" . $row[csf('grouping')] . "**" . $row[csf('file_no')];
			}


			$sql_cond .= ($variable_set_allocation==1)?" and a.booking_type not in(1,4)":"";

			$sql = "select a.id, a.booking_no_prefix_num, a.booking_no,a.is_short,a.is_approved,a.booking_date, a.buyer_id, c.po_break_down_id, a.item_category, a.delivery_date, c.job_no as job_no_mst
			from wo_booking_mst a, wo_booking_dtls c, wo_po_break_down b
			where
			a.booking_no=c.booking_no and
			c.po_break_down_id=b.id and
			a.item_category=2 and
			a.fabric_source=1 and
			a.status_active=1 and
			a.is_deleted=0 and
			b.status_active=1 and
			b.is_deleted=0 and
			c.status_active=1 and
			c.is_deleted=0
			$sql_cond
			group by a.id, a.booking_no_prefix_num, a.booking_no, a.is_short,a.is_approved, a.booking_date, a.buyer_id, c.po_break_down_id, a.item_category, a.delivery_date, c.job_no";
		}

		// echo $sql;die;
		$result = sql_select($sql);

        if( $basis == 1 && trim($issue_purpose) == 1) //  basis=booking and purpose = kniting
	    {

	    	//  Fabric Booking  = 5, Short Fabric Booking =6
           	$approval_necessity_sql = "select c.page_id, c.approval_need, c.allow_partial from ( select row_number() over (partition by b.page_id order by a.id desc) as rownumber, b.page_id, b.approval_need, b.allow_partial from approval_setup_mst a, approval_setup_dtls b where  a.id = b.mst_id and a.company_id = $company and b.page_id in (5,6) and a.status_active = 1 and a.is_deleted=0 and b.status_active = 1 and b.is_deleted=0 ) c  where rownumber = 1 order by  c.page_id desc";

           //	echo 	$approval_necessity_sql;

           	$approval_necessity_result = sql_select($approval_necessity_sql);

            $approval_necessity_setup = array();
            if( !empty($approval_necessity_result) )
            {
            	foreach ($approval_necessity_result as $row)
               	{
               		$approval_necessity_setup[$row[csf('page_id')]]['approval_need'] = $row[csf('approval_need')];
               		$approval_necessity_setup[$row[csf('page_id')]]['allow_partial'] = $row[csf('allow_partial')];
               	}
            }

           	/*echo "<pre>";
            print_r($approval_necessity_setup);*/
            //die;

	        $app_nessity_wise_print_status = array();
	        if( (!empty($result)) && (!empty($approval_necessity_setup)) )
	        {
	        	foreach ($result as $row)
		        {
		        	if( $row[csf('is_short')]==1 ) // shot fabric booking
		        	{
		        		$approval_need = $approval_necessity_setup[6]['approval_need'];
		        		$allow_partial = $approval_necessity_setup[6]['allow_partial'];

		        		if($allow_partial==1)
		        		{
		        			if( !empty($row[csf('is_approved')]) && $row[csf('is_approved')]!=0)
		        			{
		        				$app_nessity_wise_print_status[$row[csf('booking_no')]]['status'] = 1 ;
		        			}
		        			else
		        			{
		        				$app_nessity_wise_print_status[$row[csf('booking_no')]]['status'] = 0;
		        			}
		        		}
		        		else if($approval_need==1) // full approved
		        		{

		        			if($row[csf('is_approved')]==1)
		        			{
		        				$app_nessity_wise_print_status[$row[csf('booking_no')]]['status'] = 1 ;
		        			}
		        			else
		        			{
		        				$app_nessity_wise_print_status[$row[csf('booking_no')]]['status'] = 0;
		        			}
		        		}
		        		else
		        		{
		        			$app_nessity_wise_print_status[$row[csf('booking_no')]]['status'] = 1 ;
		        		}
		        	}
		        	else // main fabric
		        	{
		        		$approval_need = $approval_necessity_setup[5]['approval_need'];
		        		$allow_partial = $approval_necessity_setup[5]['allow_partial'];

		        		if($allow_partial==1)
		        		{
		        			if( !empty($row[csf('is_approved')]) && $row[csf('is_approved')]!=0)
		        			{
		        				$app_nessity_wise_print_status[$row[csf('booking_no')]]['status'] = 1 ;
		        			}
		        			else
		        			{
		        				$app_nessity_wise_print_status[$row[csf('booking_no')]]['status'] = 0;
		        			}
		        		}
		        		else if($approval_need==1) // full approved
		        		{

		        			if($row[csf('is_approved')]==1)
		        			{
		        				$app_nessity_wise_print_status[$row[csf('booking_no')]]['status'] = 1 ;
		        			}
		        			else
		        			{
		        				$app_nessity_wise_print_status[$row[csf('booking_no')]]['status'] = 0;
		        			}
		        		}
		        		else
		        		{
		        			$app_nessity_wise_print_status[$row[csf('booking_no')]]['status'] = 1 ;
		        		}
		        	}
		        }
	        }
	        else
	        {
	        	$app_nessity_wise_print_status[$row[csf('booking_no')]]['status'] = 1 ;
	        }
    	}
		else if( $basis == 1 && trim($issue_purpose) == 2)
		{
			$approval_need_arr=array();
			$sql_app=sql_select("select approval_need,b.page_id, a.setup_date from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$company and b.page_id=58 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
			foreach($sql_app as $row){
				$approval_need_arr[$row[csf('page_id')]]=$row[csf('approval_need')];
			}
		}
		else if ( $basis == 1 && trim($issue_purpose) == 8) //basis booking, purpose sample without booking
		{
			$approval_need_arr=array();
			$sql_app=sql_select("select approval_need,b.page_id, a.setup_date, b.allow_partial from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$company and b.page_id=8 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
			foreach($sql_app as $row){
				$approval_need_arr[$row[csf('page_id')]]['APPROVAL_NEED']=$row[csf('approval_need')];
				$approval_need_arr[$row[csf('page_id')]]['ALLOW_PARTIAL']=$row[csf('allow_partial')];
			}
		}

        // echo "<pre>";
        // print_r($approval_check_arr);die;


		$buyer_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');
		?>
		<div align="left" style="margin-top:5px">
			<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1060" class="rpt_table">
				<thead>
					<th width="30">SL</th>
					<th width="70">Booking No</th>
					<th width="80">Book. Date</th>
					<th width="100">Buyer</th>
					<th width="90">Item Category</th>
					<th width="90">Job No</th>
					<th width="90">Style No</th>
					<th width="90">Order Qnty</th>
					<th width="80">Ship. Date</th>
					<th width="150">Order No</th>
					<th width="80">Internal Ref</th>
					<th>File No</th>
				</thead>
			</table>
			<div style="width:1080px; max-height:240px; overflow-y:scroll" id="list_container_batch">
				<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1060" class="rpt_table"
				id="list_view">
				<?
				$i = 1;
				foreach ($result as $row) {
					if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
					if (trim($issue_purpose) == 2 && $row[csf('entry_form')]==135) //Yarn Dyeing Salse Order
					{
						$approval_setting=$approval_need_arr[58];
						if($row[csf('is_approved')]!=1 && $approval_setting==1) $bgcolor="#ffa38f";
					}
					else if(trim($issue_purpose) == 8 && $basis == 1)
					{
						$approval_setting=$approval_need_arr[8]['APPROVAL_NEED'];
					}

					$po_qnty_in_pcs = 0;
					$po_no = '';
					$min_shipment_date = '';
					$style_ref_no = "";
					$buyer_name = "";
					$fileNo = "";
					$internal_ref = "";

					if (trim($issue_purpose) != 8)
					{
						if (trim($issue_purpose) == 2)
						{
							if ($row[csf('entry_form')] == 41)
							{
								$job_no_id = array_unique(explode(",", $row[csf('job_no_id')]));
								foreach ($job_no_id as $job_id)
								{
									$job_data = explode(",", substr($job_arr[$job_id], 0, -1));
									foreach ($job_data as $value)
									{
										$po_data = explode("**", $value);
										$po_number = $po_data[0];
										$pub_shipment_date = $po_data[1];
										$po_qnty = $po_data[2];
										$poQntyPcs = $po_data[3];
										$style_ref_no = $po_data[4];
										$buyer_id = $po_data[5];
										$supplier_id = $po_data[5];

										if ($po_no == "") {
											$po_no = $po_number;
										} else {
											$po_no .= "," . $po_number;
										}

										if ($min_shipment_date == '')
										{
											$min_shipment_date = $pub_shipment_date;
										}
										else
										{
											if ($pub_shipment_date < $min_shipment_date) $min_shipment_date = $pub_shipment_date; else $min_shipment_date = $min_shipment_date;
										}

										$po_qnty_in_pcs += $poQntyPcs;
										$style_ref_no = $style_ref_no;
										$buyer_name = $buyer_arr[$buyer_id];
									}
								}

								if (trim($buyer) != 0) $buyer_name = $buyer_arr[$row[csf('buyer_id')]];
							}
							else
							{

								if( $row[csf('entry_form')] == 42 || $row[csf('entry_form')]==114) // Without order === Sample
								{
									$buyer_name = $buyer_arr[$row[csf('sample_buyer_id')]];
									$row[csf('buyer_id')] = $row[csf('sample_buyer_id')];
								}
								else if($row[csf('entry_form')] == 135)
								{
									if($row[csf('within_group')]==1)
									{
										$buyer_name = $buyer_arr[$row[csf('po_buyer')]];
										$row[csf('buyer_id')] = $row[csf('po_buyer')];
									}
									else
									{
										$buyer_name = $buyer_arr[$row[csf('sales_buyer_id')]];
										$row[csf('buyer_id')] = $row[csf('sales_buyer_id')];
									}
								}
								else
								{
									$buyer_name = $buyer_arr[$row[csf('buyer_id')]];
								}

								$po_no = "&nbsp;";
								$po_qnty_in_pcs = "&nbsp;";
							}
						}
						else
						{
							$po_id = explode(",", $row[csf('po_break_down_id')]);
							foreach ($po_id as $id)
							{
								$po_data = explode("**", $po_arr[$id]);
								$po_number = $po_data[0];
								$pub_shipment_date = $po_data[1];
								$po_qnty = $po_data[2];
								$poQntyPcs = $po_data[3];
								$style_ref_no = $po_data[4];
								$grouping = $po_data[5];

								if ($po_no == "") $po_no = $po_number; else $po_no .= "," . $po_number;
								if ($internal_ref == "") $internal_ref = $grouping; else $internal_ref .= "," . $grouping;
								if ($fileNo == "") $fileNo = $file_no; else $fileNo .= "," . $file_no;

								if ($min_shipment_date == '') {
									$min_shipment_date = $pub_shipment_date;
								} else {
									if ($pub_shipment_date < $min_shipment_date) $min_shipment_date = $pub_shipment_date; else $min_shipment_date = $min_shipment_date;
								}

								$po_qnty_in_pcs += $poQntyPcs;
								$style_ref_no = $style_ref_no;
							}

							$buyer_name = $buyer_arr[$row[csf('buyer_id')]];
						}
					}
					else
					{
						$buyer_name = $buyer_arr[$row[csf('buyer_id')]];
						$po_no = "&nbsp;";
						$po_qnty_in_pcs = "&nbsp;";
					}

					if($row[csf('pay_mode')]!=0){ $pay_mode=$row[csf('pay_mode')];}else{$pay_mode=0;}
					if($row[csf('service_type')]!=0){ $service_type=$row[csf('service_type')];}else{$service_type=0;}

					if($row[csf('entry_form')]==42 || $row[csf('entry_form')]==114) // Sample booking of  buyer
					{
						$row[csf('buyer_id')] = $row[csf('sample_buyer_id')];
						$buyer_name = $buyer_arr[$row[csf('sample_buyer_id')]];

					}
					else
					{
						if( $row[csf('is_sales')] == 1 && $row[csf('within_group')] == 1)
						{
                            $row[csf('buyer_id')] = $row[csf('po_buyer')];
                            $buyer_name = $buyer_arr[$row[csf('po_buyer')]];
						}
						else if( $row[csf('is_sales')] == 1 && $row[csf('within_group')] != 1)
						{

                            $row[csf('buyer_id')] = $row[csf('sales_buyer_id')];
                            $buyer_name = $buyer_arr[$row[csf('sales_buyer_id')]];
						}
						else{

							$row[csf('buyer_id')] = $row[csf('buyer_id')];
							$buyer_name = $buyer_arr[$row[csf('buyer_id')]];
						}
					}

					if( !empty($approval_necessity_setup) && $basis == 1 && trim($issue_purpose) == 1 ) //  basis=booking and purpose = kniting
                    {
                    	$print_status = $app_nessity_wise_print_status[$row[csf('booking_no')]]['status'];

                    	if($print_status==1)
                    	{
                    		?>
                    		<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
                    			onClick="js_set_value('<? echo $row[csf('id')]; ?>__<? echo $row[csf('booking_no')]; ?>__<? echo $row[csf('buyer_id')]; ?>__<? echo trim(implode(",", array_unique(explode(",", $row[csf('job_no_mst')])))); ?>__<? echo $style_ref_no; ?>__<? echo $row[csf('entry_form')]; ?>__<? echo $row[csf('supplier_id')]; ?>__<? echo $row[csf('source')]; ?>__<? echo $pay_mode; ?>__<? echo $service_type; ?>__<? echo $row[csf('is_approved')]; ?>__<? echo $approval_setting; ?>__<? echo $row[csf('fab_booking_no')]; ?>');">
                    			<td width="30" align="center"><? echo $i; ?></td>
                    			<td width="70" align="center"><? echo $row[csf('booking_no_prefix_num')]; ?></td>
                    			<td width="80" align="center"><? echo change_date_format($row[csf('booking_date')]); ?></td>
                    			<td width="100"><p><? echo $buyer_name; ?></p></td>
                    			<td width="90" align="center"><? echo $item_category[$row[csf('item_category')]]; ?></td>
                    			<td width="90"><? echo implode(",", array_unique(explode(",", $row[csf('job_no_mst')]))); ?></td>
								<td width="90"><? echo implode(",", array_unique(explode(",", $style_ref_no))); ?></td>
                    			<td width="90" align="right"><? echo $po_qnty_in_pcs; ?></td>
                    			<td width="80" align="center"><? if ($min_shipment_date != "") echo change_date_format($min_shipment_date); ?></td>
                    			<td width="150"><p><? echo $po_no; ?></p></td>
                    			<td width="80"><? echo implode(",", array_unique(explode(",", $internal_ref))); ?></td>
                    			<td width=""><? echo implode(",", array_unique(explode(",", $fileNo))); ?></td>
                    		</tr>
                    		<?
                    		$i++;
                    	}
					}
					else if($basis == 1 && trim($issue_purpose) == 8)
					{
						if($approval_setting == 1)
						{
							if($row['CURRENT_APPROVAL_STATUS'] != 1)
								continue;
						}
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
							onClick="js_set_value('<? echo $row[csf('id')]; ?>__<? echo $row[csf('booking_no')]; ?>__<? echo $row[csf('buyer_id')]; ?>__<? echo trim(implode(",", array_unique(explode(",", $row[csf('job_no_mst')])))); ?>__<? echo $style_ref_no; ?>__<? echo $row[csf('entry_form')]; ?>__<? echo $row[csf('supplier_id')]; ?>__<? echo $row[csf('source')]; ?>__<? echo $pay_mode; ?>__<? echo $service_type; ?>__<? echo $row[csf('is_approved')]; ?>__<? echo $approval_setting; ?>__<? echo $row[csf('fab_booking_no')]; ?>');">
							<td width="30" align="center"><? echo $i; ?></td>
							<td width="70" align="center"><? echo $row[csf('booking_no_prefix_num')]; ?></td>
							<td width="80" align="center"><? echo change_date_format($row[csf('booking_date')]); ?></td>
							<td width="100"><p><? echo $buyer_name; ?></p></td>
							<td width="90" align="center"><? echo $item_category[$row[csf('item_category')]]; ?></td>
							<td width="90"><? echo implode(",", array_unique(explode(",", $row[csf('job_no_mst')]))); ?></td>
							<td width="90"><? echo implode(",", array_unique(explode(",", $style_ref_no))); ?></td>
							<td width="90" align="right"><? echo $po_qnty_in_pcs; ?></td>
							<td width="80" align="center"><? if ($min_shipment_date != "") echo change_date_format($min_shipment_date); ?></td>
							<td width="150"><p><? echo $po_no; ?></p></td>
							<td width="80"><? echo implode(",", array_unique(explode(",", $internal_ref))); ?></td>
							<td width=""><? echo implode(",", array_unique(explode(",", $fileNo))); ?></td>
						</tr>
						<?
						$i++;
					}
					else
					{
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
							onClick="js_set_value('<? echo $row[csf('id')]; ?>__<? echo $row[csf('booking_no')]; ?>__<? echo $row[csf('buyer_id')]; ?>__<? echo trim(implode(",", array_unique(explode(",", $row[csf('job_no_mst')])))); ?>__<? echo $style_ref_no; ?>__<? echo $row[csf('entry_form')]; ?>__<? echo $row[csf('supplier_id')]; ?>__<? echo $row[csf('source')]; ?>__<? echo $pay_mode; ?>__<? echo $service_type; ?>__<? echo $row[csf('is_approved')]; ?>__<? echo $approval_setting; ?>__<? echo $row[csf('fab_booking_no')]; ?>');">
							<td width="30" align="center"><? echo $i; ?></td>
							<td width="70" align="center"><? echo $row[csf('booking_no_prefix_num')]; ?></td>
							<td width="80" align="center"><? echo change_date_format($row[csf('booking_date')]); ?></td>
							<td width="100"><p><? echo $buyer_name; ?></p></td>
							<td width="90" align="center"><? echo $item_category[$row[csf('item_category')]]; ?></td>
							<td width="90"><? echo implode(",", array_unique(explode(",", $row[csf('job_no_mst')]))); ?></td>
							<td width="90"><? echo implode(",", array_unique(explode(",", $style_ref_no))); ?></td>
							<td width="90" align="right"><? echo $po_qnty_in_pcs; ?></td>
							<td width="80" align="center"><? if ($min_shipment_date != "") echo change_date_format($min_shipment_date); ?></td>
							<td width="150"><p><? echo $po_no; ?></p></td>
							<td width="80"><? echo implode(",", array_unique(explode(",", $internal_ref))); ?></td>
							<td width=""><? echo implode(",", array_unique(explode(",", $fileNo))); ?></td>
						</tr>
						<?
						$i++;
					}
				}
				?>
			</table>
		</div>
		</div>
		<?
	}
	exit();
}

if ($action == "check_booking_req")
{
	$data_ref = explode("**", $data);
	$booking_id = $data_ref[0];
	$job_no = $data_ref[1];
	$yarn_count = $data_ref[2];
	$composition_id = $data_ref[3];
	$composition_percent = $data_ref[4];
	$yarn_type = $data_ref[5];
	$yarn_color = $data_ref[6];
	$yarn_dyeing_color = $data_ref[7];
	$txt_prod_id = $data_ref[8];
	$txt_issue_qnty = $data_ref[9];
	$update_id = $data_ref[10];

	$booking_req_qnty = 0;
	$job_cond = "";
	if ($job_no != "") $job_cond = " and job_no='$job_no'";
	$comp_cond = "";
	if ($composition_id != "") $comp_cond = " and yarn_comp_type1st=$composition_id";

	$booking_req_sql = sql_select("select sum(yarn_wo_qty) as yarn_wo_qty from wo_yarn_dyeing_dtls where mst_id=$booking_id  and product_id=$txt_prod_id and yarn_color='$yarn_dyeing_color' and entry_form in(41,42) $job_cond
		union all
		select sum(yarn_wo_qty) as yarn_wo_qty from wo_yarn_dyeing_dtls where mst_id=$booking_id  $comp_cond and yarn_type=$yarn_type and yarn_color='$yarn_dyeing_color' and entry_form in(114,125) $job_cond");
	foreach ($booking_req_sql as $row) {
		if ($row[csf("yarn_wo_qty")] > 0) $booking_req_qnty += $row[csf("yarn_wo_qty")];
	}
	$trans_cond = "";
	if ($update_id != "") $trans_cond = " and b.id <> $update_id";

	$prev_issue_qnty = return_field_value("sum(b.cons_quantity) as cons_quantity", "inv_issue_master a, inv_transaction b", "a.id=b.mst_id and a.entry_form = 3 AND a.issue_basis = 1  AND a.issue_purpose = 2 and b.transaction_type=2 and b.item_category=1 and b.prod_id=$txt_prod_id $trans_cond", "cons_quantity");

	$cu_required = $booking_req_qnty - $prev_issue_qnty;
	$over_qnty = 0;
	if (($txt_issue_qnty * 1) > ($cu_required * 1)) {
		$over_qnty = ($txt_issue_qnty * 1) - ($cu_required * 1);
	}
	echo $over_qnty;
}

//=============================
if ($action=="service_booking_popup")
{
	echo load_html_head_contents("Booking Search","../../", 1, 1, $unicode);
	extract($_REQUEST);

	//$company_id;
    //$txt_buyer_job_no;
    //$cbo_buyer_name;
	?>
	<script>
		function js_set_value(booking_no)
		{
			document.getElementById('selected_booking').value=booking_no;
			parent.emailwindow.hide();
		}
	</script>
</head>
<body>
	<div align="center" style="width:100%;" >
		<form name="searchorderfrm_1"  id="searchorderfrm_1" autocomplete="off">
			<table width="900" cellspacing="0" cellpadding="0" border="1" class="rpt_table" align="center" rules="all">
				<thead>
					<tr>
						<th width="150">Company Name</th>
						<th width="172">Buyer Name</th>
						<th width="110">Booking No</th>
						<th width="110">Job No</th>
						<th width="180">Date Range</th>
						<th><!--<input type="checkbox" value="0" onClick="set_checkvalue()" id="chk_job_wo_po">Job Without PO--></th>
					</tr>
				</thead>
				<tr class="general">
					<td> <input type="hidden" id="selected_booking">
						<?
					//echo $company.'ddd';
					//cbo_company_name
						echo create_drop_down( "cbo_company_id", 150, "select id,company_name from lib_company comp where status_active=1 $company_cond order by company_name","id,company_name",1, "-- Select Company --", $company_id, "");
						?>
					</td>
					<td>
						<?
						$arr1= "select buy.id as id, buy.buyer_name as byuer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$company_id'";
						//echo $arr1;
						echo create_drop_down( "cbo_buyer_name", 172, $arr1,"id,byuer_name", 1, "-- Select Buyer --",$cbo_buyer_name,"");

						?>
					</td>
					<td><input name="txt_booking_no" id="txt_booking_no" class="text_boxes" style="width:100px"></td>
					<td><input name="txt_job_no" id="txt_job_no" class="text_boxes" style="width:100px" value="<? echo $txt_buyer_job_no; ?>"></td>
					<td>
						<input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:70px">
						<input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:70px">
					</td>
					<td>
						<input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('cbo_company_id').value+'_'+document.getElementById('cbo_buyer_name').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('txt_job_no').value+'_'+document.getElementById('txt_booking_no').value, 'create_service_booking_search_list_view', 'search_div', 'yarn_issue_controller', 'setFilterGrid(\'list_view\',-1)') " style="width:100px;" /></td>
					</tr>
					<tr>
						<td align="center" valign="middle" colspan="6"><? echo load_month_buttons(1); ?> </td>
					</tr>
				</table>
			</form>
			<div id="search_div"></div>

		</div>
	</body>
	<script>
		load_drop_down( 'yarn_issue_controller', <? echo $company_id;?>, 'load_drop_down_buyer', 'buyer_td' );
	</script>
	<script src="../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if ($action=="create_service_booking_search_list_view")
{
	$data=explode('_',$data);
	if ($data[0]!=0) $company="a.company_id='$data[0]'"; else { echo "Please Select Company First."; die; }
	if ($data[1]!=0) $buyer=" and a.buyer_id='$data[1]'"; else $buyer="";//{ echo "Please Select Buyer First."; die; }
	//if ($data[4]!="") $jobNoCond=" and a.job_no='$data[4]'"; else $jobNoCond="";
	if (str_replace("'","",$data[4])!="") $jobNoCond=" and b.job_no like '%$data[4]%'"; else  $jobNoCond="";
	if (str_replace("'","",$data[5])!="") $bookingNoCond=" and a.booking_no_prefix_num like '%$data[5]%'  $booking_year_cond  "; else $bookingNoCond="";


	if($db_type==0)
	{
		if ($data[2]!="" &&  $data[3]!="") $booking_date  = "and a.booking_date  between '".change_date_format($data[2], "yyyy-mm-dd", "-")."' and '".change_date_format($data[3], "yyyy-mm-dd", "-")."'"; else $booking_date ="";
	}
	else if($db_type==2)
	{
		if ($data[2]!="" &&  $data[3]!="") $booking_date  = "and a.booking_date  between '".change_date_format($data[2], "yyyy-mm-dd", "-",1)."' and '".change_date_format($data[3], "yyyy-mm-dd", "-",1)."'"; else $booking_date ="";
	}

	$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');
	$comp=return_library_array( "select id, company_short_name from lib_company",'id','company_short_name');
	$suplier=return_library_array( "select id, short_name from lib_supplier",'id','short_name');
	//$po_no=return_library_array( "select id, job_no_prefix_num from wo_po_details_master",'id','job_no_prefix_num');

	$arr=array (2=>$comp,3=>$buyer_arr,5=>$item_category,7=>$fabric_source,8=>$suplier);
	//$arr=array (3=>$comp,3=>$buyer_arr,5=>$po_no,6=>$item_category,7=>$fabric_source,8=>$suplier);

	$sql= "SELECT a.id, a.process, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.company_id, a.buyer_id, a.delivery_date,  a.job_no, a.po_break_down_id, a.item_category, a.fabric_source, a.supplier_id from wo_booking_mst a,wo_booking_dtls d ,wo_po_details_master b
	where $company and a.booking_no = d.booking_no and d.job_no = b.job_no  $buyer $booking_date $jobNoCond $bookingNoCond and a.booking_type=3  and ((a.entry_form=228 and a.process =1) or ( a.entry_form is null and a.process =0)) and a.status_active=1 and a.is_deleted=0  group by a.id, a.process, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.company_id, a.buyer_id, a.delivery_date,  a.job_no, a.po_break_down_id, a.item_category, a.fabric_source, a.supplier_id order by a.id desc";
	  //echo $sql;
	echo  create_list_view("list_view", "Booking No,Booking Date,Company,Buyer,Delivery Date,Category", "70,80,100,100,100,100","870","320",0, $sql , "js_set_value", "booking_no", "", 1, "0,0,company_id,buyer_id,0,item_category", $arr , "booking_no_prefix_num,booking_date,company_id,buyer_id,delivery_date,item_category", '','','0,3,0,0,3,0','','');
	exit();
}
//=============================

//yarn LOT POP UP Search Here
if ($action == "yarnLot_popup")
{
	echo load_html_head_contents("Popup Info", "../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		function fn_check_lot(search_type) {
			show_list_view(document.getElementById('cbo_supplier').value + '_' + document.getElementById('cbo_search_by').value + '_' + document.getElementById('txt_search_common').value + '_<? echo $company; ?>' +
				'_<? echo $issue_purpose; ?>' +
				'_<? echo $cbo_store_name; ?>' +
				'_<? echo $txt_composition_id; ?>' + '_<? echo $txt_composition_percent; ?>' + '_<? echo $cbo_yarn_type; ?>' + '_<? echo $cbo_color; ?>' + '_<? echo $cbo_yarn_count; ?>'+ '_<? echo $yarn_rate_match; ?>'+ '_<? echo $txt_booking_no; ?>'+ '_<? echo $cbo_basis; ?>'+ '_<? echo $issue_purpose; ?>'+ '_<? echo $job_no; ?>_'+search_type,'create_lot_search_list_view','search_div','yarn_issue_controller','setFilterGrid(\'list_view\',-1)');
		}

		function js_set_value(prod_id) {
			$("#hidden_prod_id").val(prod_id);
			var prod_data=prod_id.split("**");
			var prod_id=prod_data[0];
			var yarn_rate=prod_data[2];
			var budge_rate=prod_data[3];
			var budge_cond=prod_data[4];
			var issue_perpose=prod_data[5];
			var job_no=prod_data[6];
			var booking_no=prod_data[7];
			var buyer=prod_data[8];
			if(budge_cond==11 && (yarn_rate*1)>(budge_rate*1) && issue_perpose != 8)
			{
				var page_link = 'yarn_issue_controller.php?action=budget_yarn_comparision_popup&job_no=' + job_no + '&booking_no=' + booking_no + '&buyer=' + buyer + '&prod_id=' + prod_id + '&yarn_rate=' + yarn_rate;
				var title = "Yarn Info Budget VS Actual";
				emailwindow = dhtmlmodal.open('EmailBox','iframe',page_link,title,'width=450px,height=250px,center=1,resize=0,scrolling=0','');
				return;
			}
			parent.emailwindow.hide();
		}
	</script>
</head>
<body>
	<div align="center" style="width:100%;">
		<form name="searchorderfrm_1" id="searchorderfrm_1" autocomplete="off">
			<table width="800" cellspacing="0" cellpadding="0" border="1" rules="all" class="rpt_table" align="center">
				<thead>
					<tr>
						<th>Supplier Name</th>
						<th>Search By</th>
						<th align="center" width="200" id="search_by_td_up">Enter Lot Number</th>
						<th><input type="reset" name="re_button" id="re_button" value="Reset" style="width:100px"
							class="formbutton"/></th>
						</tr>
					</thead>
					<tbody>
						<tr align="center">
							<td>
								<?
								echo create_drop_down("cbo_supplier", 170, "select c.id, c.supplier_name from lib_supplier_tag_company a,lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$company' and b.party_type=2 and c.status_active=1 and c.is_deleted=0 group by c.id, c.supplier_name order by c.supplier_name", "id,supplier_name", 1, "-- Select --", $supplier, "", 0);
								?>
							</td>
							<td align="center">
								<?
								$search_by = array(1 => 'Lot No', 2 => 'Yarn Count');
								$dd = "change_search_event(this.value, '0*0', '0*0', '../../')";
								echo create_drop_down("cbo_search_by", 150, $search_by, "", 0, "--Select--", "", $dd, 0);
								?>
							</td>
							<td width="180" align="center" id="search_by_td">
								<input type="text" style="width:130px" class="text_boxes" name="txt_search_common"
								id="txt_search_common"/>
							</td>
							<td align="center">
								<input type="button" name="btn_show" class="formbutton" value="Show" onClick="fn_check_lot(1)" style="width:100px;"/>
								<?
								$print_report_format=return_field_value("format_id"," lib_report_template","template_name=$company and module_id=6 and report_id=37 and is_deleted=0 and status_active=1");

								$print_report_format_arr=explode(",",$print_report_format);
								if($print_report_format != "")
								{
									foreach($print_report_format_arr as $id)
									{
										if($id==184){
											?>
											<input type="button" id="btnCompWise" value="Composition wise" onClick="fn_check_lot(2)" style="width:120px;" class="formbutton" />
											<?
										}
									}
								}
								?>
							</td>
						</tr>
						<input type="hidden" id="hidden_prod_id" value=""/>
					</tbody>
				</table>
				<div align="center" valign="top" style="margin-top:5px" id="search_div"></div>
			</form>
		</div>
	</body>
	<script src="../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
}

if ($action == "budget_yarn_comparision_popup")
{
	echo load_html_head_contents("PO Info", "../../", 1, 1, '', '', '');
	extract($_REQUEST);
	ob_start();
	$buyer_arr 			= return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');
	$yarn_count_arr 	= return_library_array("select id,yarn_count from lib_yarn_count", 'id', 'yarn_count');
	$composition_arr 	= return_library_array("select id,composition_name from lib_composition_array", 'id', 'composition_name');
	$product_info 		= sql_select("select lot,yarn_comp_type1st,yarn_count_id,yarn_type from product_details_master where id=$prod_id");

	$sql_budge=sql_select("select id,count_id,copm_one_id,type_id,rate from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_no' and status_active=1");
	$count_arr=$type_arr=$rate_arr=array();
	foreach($sql_budge as $row)
	{
		$count_arr[] = trim($row[csf("count_id")]);
		$type_arr[] = $row[csf("type_id")];
		$rate_arr[] = $row[csf("rate")];
	}
	?>
	<div id="report_container">
		<table cellspacing="0" cellpadding="3" border="1" rules="all" width="100%" class="rpt_table">
			<thead>
				<tr>
					<td width="60" style="font-weight: bold;">Buyer</td>
					<td width="130"><?php echo $buyer_arr[$buyer];?></td>
					<td width="70" style="font-weight: bold;">Job No</td>
					<td width="80"><?php echo $job_no;?></td>
				</tr>
				<tr>
					<td style="font-weight: bold;">Booking No</td>
					<td><?php echo $booking_no;?></td>
					<td style="font-weight: bold;">Lot</td>
					<td><?php echo $product_info[0][csf("lot")];?></td>
				</tr>
				<tr>
					<th colspan="4" align="center">Yarn info as budget</th>
				</tr>
				<tr>
					<th>Count</th>
					<th>Composition</th>
					<th>Type</th>
					<th>Rate (USD)</th>
				</tr>
				<?php
				foreach($sql_budge as $row)
				{
					?>
					<tr>
						<td><?php echo $yarn_count_arr[$row[csf("count_id")]];?></td>
						<td><?php echo $composition_arr[$row[csf("copm_one_id")]];?></td>
						<td><?php echo $yarn_type[$row[csf("type_id")]];?></td>
						<td align="right"><?php echo $row[csf("rate")];?></td>
					</tr>
					<?
				}
				?>
				<tr>
					<th colspan="4" align="center">Yarn info as issue</th>
				</tr>
				<tr>
					<?php
					$count_bg = (!in_array($product_info[0][csf("yarn_count_id")], $count_arr))?"background-color:red;color:#fff;":"";
					$type_bg = (!in_array($product_info[0][csf("yarn_type")], $type_arr))?"background-color:red;color:#fff;":"";
					$rate_bg = (!in_array($yarn_rate, $rate_arr))?"background-color:red;color:#fff;":"";
					$budget_bg = ($yarn_rate > $budge_data[$product_info[0][csf("yarn_count_id")]][$product_info[0][csf("yarn_type")]]["rate"])?"background-color:red;color:white;":"";
					?>
					<td style="<?php //echo $count_bg;?>"><?php echo $yarn_count_arr[$product_info[0][csf("yarn_count_id")]];?></td>
					<td><?php echo $composition_arr[$product_info[0][csf("yarn_comp_type1st")]];?></td>
					<td style="<?php //echo $type_bg;?>"><?php echo $yarn_type[$product_info[0][csf("yarn_type")]];?></td>
					<td  style="<?php //echo $rate_bg;?>" align="right"><?php echo $yarn_rate;?></td>
				</tr>
			</thead>
		</table>
		<h3 style="color: red;text-align: center;">Selected yarn does not match with budget</h3>
		<input type="button" value="Export To Excel" name="excel" id="excel" class="formbutton" style="width:155px; margin-left: 150px;"  />
	</div>
	<?
	$name=time();
	$filename=$user_name."_".$name.".xls";
	$create_new_doc = fopen($filename, 'w');
	$is_created = fwrite($create_new_doc,ob_get_contents());
	$filename= $user_name."_".$name.".xls";
	?>
	<script type="text/javascript">
		$("#excel").click(function(e) {
			window.open("<? echo $filename ; ?>", + $('#report_container').html());
			e.preventDefault();
		});
	</script>
	<?
	die;
}

if ($action == "create_lot_search_list_view")
{
	$ex_data = explode("_", $data);
	$supplier = $ex_data[0];
	$txt_search_by = $ex_data[1];
	$txt_search_common = trim($ex_data[2]);
	$company = $ex_data[3];
	$issue_purpose = $ex_data[4];
	$store_name = $ex_data[5];
	$txt_composition_id = trim($ex_data[6]);
	$txt_composition_percent = $ex_data[7];
	$cbo_yarn_type = $ex_data[8];
	$cbo_color = $ex_data[9];
	$cbo_yarn_count = $ex_data[10];
	$yarn_rate_match = $ex_data[11];
	$txt_booking_no = $ex_data[12];
	$cbo_basis = $ex_data[13];
	$issue_purpose = $ex_data[14];
	$job_no = $ex_data[15];
	$search_type = $ex_data[16];

	if($yarn_rate_match==1 && $cbo_basis==1)
	{
		$sql_book_job=sql_select("select distinct b.job_no,a.buyer_id from wo_booking_mst a,wo_booking_dtls b where a.booking_no=b.booking_no and b.booking_no='$txt_booking_no' and b.status_active=1");
		$book_job_no=$sql_book_job[0][csf("job_no")];
		$buyer_id=$sql_book_job[0][csf("buyer_id")];
		$sql_budge=sql_select("select id, count_id, copm_one_id, type_id, rate from wo_pre_cost_fab_yarn_cost_dtls where job_no='$book_job_no' and status_active=1");
		$budge_data=array();
		foreach($sql_budge as $row)
		{
			$budge_data[$row[csf("count_id")]][$row[csf("type_id")]]["id"]=$row[csf("id")];
			$budge_data[$row[csf("count_id")]][$row[csf("type_id")]]["rate"]=$row[csf("rate")];
		}
	}

	$sql_cond = "";
	if (trim($txt_search_common) != "")
	{
		if (trim($txt_search_by) == 1) // for LOT NO
		{
			$sql_cond .= " and b.lot LIKE '%$txt_search_common%'";
		} else if (trim($txt_search_by) == 2) // for Yarn Count
		{
			$yarn_sql=" select listagg(id, ',') within group (order by id) as YARN_COUNT_IDS from lib_yarn_count where  yarn_count like '%$txt_search_common%' and status_active=1 and is_deleted=0";
			$yarn_sql_result = sql_select($yarn_sql);
			$yarn_count_ids = $yarn_sql_result[0]['YARN_COUNT_IDS'];
			$sql_cond .= " and b.yarn_count_id in ($yarn_count_ids)";
		}
	}

	if (trim($supplier) != 0) $sql_cond .= " and b.supplier_id='$supplier'";
	if (trim($company) != 0) $sql_cond .= " and b.company_id='$company'";
	if (trim($store_name) > 0) $sql_cond .= " and a.store_id='$store_name'";

	if($search_type == 1)
	{
		if (trim($txt_composition_id) > 0) $sql_cond .= " and b.yarn_comp_type1st='$txt_composition_id'";
		//if (trim($txt_composition_percent) > 0) $sql_cond .= " and b.yarn_comp_percent1st='$txt_composition_percent'";
		//if (trim($cbo_yarn_type) > 0) $sql_cond .= " and b.yarn_type='$cbo_yarn_type'";
		//if (trim($cbo_yarn_count) > 0) $sql_cond .= " and b.yarn_count_id='$cbo_yarn_count'";
	}
	else
	{
		if (trim($txt_composition_id) > 0) $sql_cond .= " and b.yarn_comp_type1st='$txt_composition_id'";
		if (trim($cbo_yarn_type) > 0) $sql_cond .= " and b.yarn_type='$cbo_yarn_type'";
		if (trim($cbo_yarn_count) > 0) $sql_cond .= " and b.yarn_count_id='$cbo_yarn_count'";
	}

	$variable_set_allocation = return_field_value("allocation", "variable_settings_inventory", "company_name=$company and variable_list=18 and item_category_id = 1","allocation");

	if ($variable_set_allocation == 1) // IF ALLOCATION IS SET TO YES IN VARIABLE SETTINGS
	{
		if(($cbo_basis == 2) || ($cbo_basis == 1 && $issue_purpose == 8))
		{
			if ($db_type == 0)
			{
				$sql = "SELECT b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit, a.store_id as store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box, sum((case when a.transaction_type in(1,4,5) then a.cons_quantity else 0 end)-(case when a.transaction_type in(2,3,6) then a.cons_quantity else 0 end)) as balance_qnty, sum(case when a.transaction_type=1 then a.order_qnty else 0 end) as rcv_qnty, sum(case when a.transaction_type=1 then a.order_amount else 0 end) as rcv_amt
				from product_details_master b, inv_transaction a
				where a.prod_id=b.id and a.item_category=1 and b.item_category_id=1 and b.status_active=1 and a.status_active=1 and b.current_stock>0 $sql_cond
				group by b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit,a.store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box order by b.lot";
			}
			else
			{
				$sql = "SELECT b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit, a.store_id as store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box, sum((case when a.transaction_type in(1,4,5) then a.cons_quantity else 0 end)-(case when a.transaction_type in(2,3,6) then a.cons_quantity else 0 end)) as balance_qnty, sum(case when a.transaction_type=1 then a.order_qnty else 0 end) as rcv_qnty, sum(case when a.transaction_type=1 then a.order_amount else 0 end) as rcv_amt
				from product_details_master b, inv_transaction a
				where a.prod_id=b.id and a.item_category=1 and b.item_category_id=1 and b.status_active=1 and a.status_active=1 and b.current_stock>0 $sql_cond
				group by b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit,a.store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box order by b.lot";
			}
		}
		else
		{
			if($job_no!="")
			{
				if ($db_type == 0)
				{
					$sql = "SELECT b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit, a.store_id as store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box, sum((case when a.transaction_type in(1,4,5) then a.cons_quantity else 0 end)-(case when a.transaction_type in(2,3,6) then a.cons_quantity else 0 end)) as balance_qnty, sum(case when a.transaction_type=1 then a.order_qnty else 0 end) as rcv_qnty, sum(case when a.transaction_type=1 then a.order_amount else 0 end) as rcv_amt
					from product_details_master b, inv_transaction a,inv_material_allocation_mst c
					where a.prod_id=b.id and a.prod_id=c.item_id and a.item_category=1 and b.item_category_id=1 and b.status_active=1 and a.status_active=1 and c.status_active=1 and b.current_stock>0 and c.job_no='$job_no'$sql_cond
					group by b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit,a.store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box order by b.lot";
				}
				else
				{
					$sql = "SELECT b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit, a.store_id as store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box, sum((case when a.transaction_type in(1,4,5) then a.cons_quantity else 0 end)-(case when a.transaction_type in(2,3,6) then a.cons_quantity else 0 end)) as balance_qnty, sum(case when a.transaction_type=1 then a.order_qnty else 0 end) as rcv_qnty, sum(case when a.transaction_type=1 then a.order_amount else 0 end) as rcv_amt
					from product_details_master b, inv_transaction a,inv_material_allocation_mst c
					where a.prod_id=b.id and a.prod_id=c.item_id and a.item_category=1 and b.item_category_id=1 and b.status_active=1 and a.status_active=1 and c.status_active=1 and b.current_stock>0 and c.job_no='$job_no'$sql_cond
					group by b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit,a.store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box order by b.lot";
					//echo $sql;
				}
			}
			else
			{
				if ($db_type == 0)
				{
					$sql = "SELECT b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit, a.store_id as store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box, sum((case when a.transaction_type in(1,4,5) then a.cons_quantity else 0 end)-(case when a.transaction_type in(2,3,6) then a.cons_quantity else 0 end)) as balance_qnty, sum(case when a.transaction_type=1 then a.order_qnty else 0 end) as rcv_qnty, sum(case when a.transaction_type=1 then a.order_amount else 0 end) as rcv_amt
					from product_details_master b, inv_transaction a
					where a.prod_id=b.id and a.item_category=1 and b.item_category_id=1 and b.status_active=1 and a.status_active=1 and b.current_stock>0 $sql_cond
					group by b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit,a.store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box order by b.lot";
				}
				else
				{
					$sql = "SELECT b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit, a.store_id as store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box, sum((case when a.transaction_type in(1,4,5) then a.cons_quantity else 0 end)-(case when a.transaction_type in(2,3,6) then a.cons_quantity else 0 end)) as balance_qnty, sum(case when a.transaction_type=1 then a.order_qnty else 0 end) as rcv_qnty, sum(case when a.transaction_type=1 then a.order_amount else 0 end) as rcv_amt
					from product_details_master b, inv_transaction a
					where a.prod_id=b.id and a.item_category=1 and b.item_category_id=1 and b.status_active=1 and a.status_active=1 and b.current_stock>0 $sql_cond
					group by b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit,a.store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box
					order by b.lot";
				}
			}
		}
	}
	else
	{
		if ($db_type == 0)
		{
			$sql = "SELECT b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit, a.store_id as store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box, sum((case when a.transaction_type in(1,4,5) then a.cons_quantity else 0 end)-(case when a.transaction_type in(2,3,6) then a.cons_quantity else 0 end)) as balance_qnty, sum(case when a.transaction_type=1 then a.order_qnty else 0 end) as rcv_qnty, sum(case when a.transaction_type=1 then a.order_amount else 0 end) as rcv_amt
			from product_details_master b, inv_transaction a
			where a.prod_id=b.id and a.item_category=1 and b.item_category_id=1 and b.status_active=1 and a.status_active=1 and b.current_stock>0 $sql_cond
			group by b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit,a.store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box order by b.lot";
		}
		else
		{
			$sql = "SELECT b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit, a.store_id as store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box, sum((case when a.transaction_type in(1,4,5) then a.cons_quantity else 0 end)-(case when a.transaction_type in(2,3,6) then a.cons_quantity else 0 end)) as balance_qnty, sum(case when a.transaction_type=1 then a.order_qnty else 0 end) as rcv_qnty, sum(case when a.transaction_type=1 then a.order_amount else 0 end) as rcv_amt
			from product_details_master b, inv_transaction a
			where a.prod_id=b.id and a.item_category=1 and b.item_category_id=1 and b.status_active=1 and a.status_active=1 and b.current_stock>0 $sql_cond
			group by b.id, b.company_id, b.supplier_id, b.lot, b.current_stock, b.allocated_qnty, b.available_qnty, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.avg_rate_per_unit,a.store_id, a.floor_id, a.room, a.rack, a.self, a.bin_box order by b.lot";
			//echo $sql;

		}
	}
	// echo $sql;
	$result = sql_select($sql);
	foreach ($result as $row) {
		$prodIds.=$row[csf("id")].",";
	}

	//echo $prodIds."ttt"; die()
	//$prodIds = "";
	// prod id condition
	if($prodIds!="")
	{
		$prodIds = implode(",",array_unique(explode(",",chop($prodIds,','))));
		$prod_id_cond="";

		if($db_type==2 && $tot_rows>1000)
		{
			$prod_id_cond=" and (";

			$poIdArr=array_chunk(explode(",",$prodIds),999);
			foreach($poIdArr as $ids)
			{
				$ids=implode(",",$ids);
				$prod_id_cond.=" prod_id in($ids) or ";
			}
			$prod_id_cond=chop($prod_id_cond,'or ');
			$prod_id_cond.=")";
		}
		else
		{
			$prod_id_cond=" and prod_id in ($prodIds)";
		}

		$transec_prod_data = array();

		$trans_sql = "select prod_id, min(transaction_date) as min_date, max(transaction_date) as max_date,weight_per_cone from inv_transaction where is_deleted=0 and status_active=1 and item_category=1 $prod_id_cond group by prod_id,weight_per_cone";
		$result_returnRes_date = sql_select($trans_sql);
		foreach ($result_returnRes_date as $row)
		{
			$transec_prod_data[$row[csf("prod_id")]]['min_date'] = $row[csf("min_date")];
			$transec_prod_data[$row[csf("prod_id")]]['weight_per_cone'] .= $row[csf("weight_per_cone")].",";
		}
	}

	$color_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$yarn_count_arr = return_library_array("select id,yarn_count from lib_yarn_count", 'id', 'yarn_count');
	$store_arr = return_library_array("select id,store_name from lib_store_location", 'id', 'store_name');
	$supplier_arr = return_library_array("select id,supplier_name from lib_supplier", 'id', 'supplier_name');
	$floor_room_rack_arr = return_library_array("select floor_room_rack_id,floor_room_rack_name from lib_floor_room_rack_mst", 'floor_room_rack_id', 'floor_room_rack_name');
	?>
	<div align="left" style="margin-left:20px">
		<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1560" class="rpt_table">
			<thead>
				<th width="30">SL</th>
				<th width="130">Supplier</th>
				<th width="70">Yarn Lot</th>
				<th width="80">Yarn Count</th>
				<th width="200">Composition</th>
				<th width="80">Yarn Type</th>
				<th width="110">Color</th>
				<th width="110">Store</th>
				<th width="80">Floor</th>
				<th width="80">Room</th>
				<th width="80">Rack</th>
				<th width="80">Shelf</th>
				<th width="80">Bin/Box</th>
				<th>Current Stock</th>
				<th width="70">Rate</th>
				<th width="70">Weight @ Cone</th>
				<th width="70">Age (Days)</th>
			</thead>
		</table>

		<div style="width:1580px; max-height:240px; overflow-y:scroll" id="list_container_batch">
			<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1560" class="rpt_table" id="list_view">
				<?
				$i = 1;
				foreach ($result as $row)
				{
					if ($i % 2 == 0) $bgcolor = "#E9F3FF";
					else $bgcolor = "#FFFFFF";

					$composition_string = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%";
					if ($row[csf('yarn_comp_type2nd')] != 0) $composition_string .= " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";

					$store = '';
					$store_id = array_unique(explode(",", $row[csf('store_id')]));
					foreach ($store_id as $val) {
						if ($store == '') $store = $store_arr[$val]; else $store .= "," . $store_arr[$val];
					}

					$yarn_rate=number_format(($row[csf('rcv_amt')]/$row[csf('rcv_qnty')]),4,'.','');
					$budge_rate=number_format($budge_data[$row[csf('yarn_count_id')]][$row[csf('yarn_type')]]["rate"],4,'.','');
					$budge_cond_data=$yarn_rate_match.$cbo_basis;
					$stock_qnty = $row[csf("balance_qnty")];

					$weight_per_cone_string = chop($transec_prod_data[$row[csf("id")]]['weight_per_cone'],",");
					$weight_per_cone = implode(",", array_unique(explode(",", $weight_per_cone_string )));

					$count = $row[csf('yarn_count_id')];
					$lot = $row[csf('lot')];
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
						onClick="js_set_value('<? echo $row[csf('id')] . "**" . $weight_per_cone. "**" . $yarn_rate. "**" . $budge_rate. "**" . $budge_cond_data. "**" . $issue_purpose . "**" . $book_job_no . "**" . $txt_booking_no . "**" . $buyer_id . "**" . $row[csf('floor_id')] . "**" . $row[csf('room')] . "**" . $row[csf('rack')] . "**" . $row[csf('self')] . "**" . $row[csf('bin_box')]; ?>');">
						<td width="30" align="center"><? echo $i; ?></td>
						<td width="130"><p><? echo $supplier_arr[$row[csf('supplier_id')]]; ?>&nbsp;</p></td>
						<td width="70" align="center"><p>&nbsp;<? echo $row[csf('lot')]; ?></p></td>
						<td width="80" align="center"><p><? echo $yarn_count_arr[$row[csf('yarn_count_id')]]; ?>&nbsp;</p></td>
						<td width="200"><p><? echo $composition_string; ?></p></td>
						<td width="80"><p><? echo $yarn_type[$row[csf('yarn_type')]]; ?>&nbsp;</p></td>
						<td width="110"><p><? echo $color_arr[$row[csf('color')]]; ?>&nbsp;</p></td>
						<td width="110"><p><? echo $store; ?>&nbsp;</p></td>
						<td width="80"><p><? echo $floor_room_rack_arr[$row[csf('floor_id')]]; ?>&nbsp;</p></td>
						<td width="80"><p><? echo $floor_room_rack_arr[$row[csf('room')]]; ?>&nbsp;</p></td>
						<td width="80"><p><? echo $floor_room_rack_arr[$row[csf('rack')]]; ?>&nbsp;</p></td>
						<td width="80"><p><? echo $floor_room_rack_arr[$row[csf('self')]]; ?>&nbsp;</p></td>
						<td width="80"><p><? echo $floor_room_rack_arr[$row[csf('bin_box')]]; ?>&nbsp;</p></td>
						<td align="right"><p><? echo number_format($stock_qnty, 2); ?>&nbsp;</p></td>
						<td width="70" align="right"><? echo $yarn_rate; ?></td>
						<td width="70" align="right"><p><? echo $weight_per_cone; ?></p></td>
						<td width="70" align="center">
							<?
							$ageOfDays = datediff("d", $transec_prod_data[$row[csf("id")]]['min_date'], date("Y-m-d"));
							echo $ageOfDays;
							?>
						</td>
					</tr>
					<?
					$i++;
				}
				?>
			</table>
		</div>
	</div>
	<?
	exit();
}

// child form data populate after lot pop up search
if ($action == "populate_data_child_from")
{
	$data = explode("**", $data);
	$prodID = $data[0];
	$issue_purpose = $data[1];
	$store_name = $data[2];
	$weight_cone = $data[3];
	$company = $data[4];
	$floor = $data[5]; $room = $data[6]; $rack = $data[7]; $shelf = $data[8]; $bin = $data[9];

	$weight_cone = explode(",", $weight_cone);
	//if (trim($store_name) > 0) $sql_cond = " and a.store_id='$store_name'";
	$sql_cond="";
	if (trim($store_name) > 0) { $sql_cond= " and a.store_id='$store_name'"; }
	if ($floor!="") { $sql_cond.= " and a.floor_id=$floor"; }
	if($room!="") { $sql_cond.= " and a.room=$room"; }
	if($rack!="") { $sql_cond.= " and a.rack=$rack"; }
	if($shelf!="") { $sql_cond.= " and a.self=$shelf"; }
	if($bin!="") { $sql_cond.= " and a.bin_box=$bin"; }
	// echo $sql_cond;die;

	$sql = "SELECT b.id, b.company_id, b.supplier_id, b.store_id, b.item_category_id, b.detarmination_id, b.sub_group_code, b.sub_group_name, b.item_group_id, b.item_description, b.product_name_details, b.lot, b.item_code, b.unit_of_measure, b.re_order_label, b.minimum_label, b.maximum_label, b.item_account, b.packing_type, b.avg_rate_per_unit, b.last_purchased_qnty, b.current_stock, b.last_issued_qnty, b.stock_value, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.brand, b.allocated_qnty, b.available_qnty, a.store_id as rcv_store_id, sum((case when a.transaction_type in(1,4,5) then a.cons_quantity else 0 end)-(case when a.transaction_type in(2,3,6) then a.cons_quantity else 0 end)) as balance_qnty
	from product_details_master b,  inv_transaction a
	where a.prod_id=b.id and a.item_category=1 and b.id='$prodID' and b.item_category_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $sql_cond
	group by b.id, b.company_id, b.supplier_id, b.store_id, b.item_category_id, b.detarmination_id, b.sub_group_code, b.sub_group_name, b.item_group_id, b.item_description, b.product_name_details, b.lot, b.item_code, b.unit_of_measure, b.re_order_label, b.minimum_label, b.maximum_label, b.item_account, b.packing_type, b.avg_rate_per_unit, b.last_purchased_qnty, b.current_stock, b.last_issued_qnty, b.stock_value, b.yarn_count_id, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.color, b.brand, b.allocated_qnty, b.available_qnty, a.store_id";
	// echo $sql;die;
	$result = sql_select($sql);
	foreach ($result as $row)
	{
		$composition_string = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')];
		if ($row[csf('yarn_comp_type2nd')] != 0) $composition_string .= " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')];

		/*if($db_type==0)
		{
			$invData=sql_select("select group_concat(distinct(store_id)) as store_id, max(weight_per_bag) as weight_per_bag, max(weight_per_cone) as weight_per_cone from inv_transaction where prod_id=".$row[csf('id')]." and item_category=1 and transaction_type=1");

			//$store_id=return_field_value("group_concat(distinct(store_id)) as store_id","inv_transaction","prod_id=".$row[csf('id')]." and item_category=1 and transaction_type=1","store_id");
			$store_id=$invData[0][csf('store_id')];
		}
		else
		{
			$invData=sql_select("select LISTAGG(store_id, ',') WITHIN GROUP (ORDER BY store_id) as store_id, max(weight_per_bag) as weight_per_bag, max(weight_per_cone) as weight_per_cone from inv_transaction where prod_id=".$row[csf('id')]." and item_category=1 and transaction_type=1");

			//$store_id=return_field_value("LISTAGG(store_id, ',') WITHIN GROUP (ORDER BY store_id) as store_id","inv_transaction","prod_id=".$row[csf('id')]." and item_category=1 and transaction_type=1","store_id");
			$store_id=$invData[0][csf('store_id')];
			$store_id=implode(",",array_unique(explode(",",$store_id)));
		}*/

		$stock_qnty = $row[csf("balance_qnty")];

		//echo "$('#cbo_store_name').val('".$store_id."');\n";

		echo "$('#cbo_supplier').val('" . $row[csf("supplier_id")] . "');\n";
		echo "$('#cbo_supplier_lot').val('" . $row[csf("supplier_id")] . "');\n";
		echo "$('#txt_lot_no').val('" . $row[csf("lot")] . "');\n";
		echo "$('#txt_prod_id').val('" . $row[csf("id")] . "');\n";
		echo "$('#txt_current_stock').val(" . $stock_qnty . ");\n";
		echo "$('#cbo_yarn_count').val(" . $row[csf("yarn_count_id")] . ");\n";
		echo "$('#txt_composition').val('" . $composition_string . "');\n";
		echo "$('#hdn_composition_id').val(" . $row[csf("yarn_comp_type1st")] . ");\n";
		echo "$('#hdn_color_id').val(" . $row[csf("color")] . ");\n";
		echo "$('#cbo_yarn_type').val('" . $row[csf("yarn_type")] . "');\n";
		echo "$('#cbo_uom').val('" . $row[csf("unit_of_measure")] . "');\n";
		echo "$('#cbo_color').val('" . $row[csf("color")] . "');\n";
		echo "$('#cbo_brand').val('" . $row[csf("brand")] . "');\n";

		echo "$('#cbo_store_name').val('" . $row[csf("rcv_store_id")] . "');\n";
		echo "$('#cbo_store_name').attr('disabled', 'disabled');\n";

		echo "$('#txt_weight_per_bag').val('" . $invData[0][csf("weight_per_bag")] . "');\n";
		//echo "$('#txt_weight_per_cone').val('".$invData[0][csf("weight_per_cone")]."');\n";
		echo "$('#txt_weight_per_cone').val('" . $weight_cone[0] . "');\n";
	}

	exit();
}

// floor_room_rack_populate_data
if ($action == "floor_room_rack_populate_data")
{
	$data = explode("**", $data);
	$company = $data[0];
	$store_name = $data[1];
	$floor = $data[2]; $room = $data[3]; $rack = $data[4]; $shelf = $data[5]; $bin = $data[6];

	// echo "load_room_rack_self_bin('requires/yarn_issue_controller*1', 'store','store_td', '".$company."','".''."',this.value);\n";
	// echo "$('#cbo_store_name').val(".$store_name.");\n";

	echo "load_room_rack_self_bin('requires/yarn_issue_controller', 'floor','floor_td', '".$company."','".''."','".$store_name."',this.value);\n";
	echo "$('#cbo_floor').val('".$floor."');\n";

	echo "load_room_rack_self_bin('requires/yarn_issue_controller', 'room','room_td', '".$company."','".''."','".$store_name."','".$floor."',this.value);\n";
	echo "$('#cbo_room').val('".$room."');\n";
	echo "load_room_rack_self_bin('requires/yarn_issue_controller', 'rack','rack_td', '".$company."','".''."','".$store_name."','".$floor."','".$room."',this.value);\n";
	echo "$('#txt_rack').val('".$rack."');\n";
	echo "load_room_rack_self_bin('requires/yarn_issue_controller', 'shelf','shelf_td', '".$company."','".''."','".$store_name."','".$floor."','".$room."','".$rack."',this.value);\n";
	echo "$('#txt_shelf').val('".$shelf."');\n";
	echo "load_room_rack_self_bin('requires/yarn_issue_controller', 'bin','bin_td', '".$company."','".''."','".$store_name."','".$floor."','".$room."','".$rack."','".$shelf."',this.value);\n";
	echo "$('#cbo_bin').val('".$bin."');\n";
	echo "storeUpdateUptoDisable();\n";

	exit();
}

if ($action == "po_popup")
{
	echo load_html_head_contents("PO Info", "../../", 1, 1, '', '', '');
	extract($_REQUEST);

	$data = explode("_", $data);
	$po_id = $data[0]; //order ID
	if ( $receive_basis == 2 && $data[1] == 1 ) //is popup search or not
	{
		$type = $data[1];
	}
	else
	{
		$type = 0;
	}
	$prevQnty = $data[2]; //previous input qnty po wise
	if ($data[3] != "") $prev_method = $data[3];
	else $prev_method = $distribution_method;
	if ($data[4] != "") $issueQnty = $data[4];
	else $issueQnty = $issueQnty;
	if ($data[5] != "") $retnQnty = $data[5];
	if ($update_id=="") {$update_id=0;}

	if($issue_purpose == 2  || $issue_purpose == 7 || $issue_purpose == 12 || $issue_purpose == 15 || $issue_purpose == 38 || $issue_purpose == 44 || $issue_purpose == 46 || $issue_purpose == 50 || $issue_purpose == 51 )
	{
		$entry_form = return_field_value("entry_form", "wo_yarn_dyeing_mst", "id='$booking_id'", "entry_form");
	}

	?>
	<script>
		var receive_basis = <? echo $receive_basis; ?>;
		var issue_purpose = <? echo $issue_purpose; ?>;
		var updateIDs = <? echo $update_id; ?>;


		function fn_show_check() {
			if (form_validation('cbo_buyer_name', 'Buyer Name') == false) {
				return;
			}
			show_list_view($('#txt_search_common').val() + '_' + $('#cbo_search_by').val() + '_<? echo $cbo_company_id; ?>' +
				'_' + $('#cbo_buyer_name').val() + '_<? echo $all_po_id; ?>_' +<? echo $receive_basis;?>, 'create_po_search_list_view', 'search_div', 'yarn_issue_controller', 'setFilterGrid(\'tbl_list_search\',-1);hidden_field_reset();'
				)
			;
			set_all();
		}
		var tot_extra_qnty = 0;

		function distribute_qnty(str)
		{
            if (str == 1) //Proportionate
            {
            	var tot_issue_qnty = $('#tot_issue_qnty').val() * 1;
            	$('#txt_prop_grey_qnty').attr('readonly', false);
            	var tot_po_qnty = $('#tot_po_qnty').val() * 1- tot_issue_qnty;
            	var tot_req_qnty = $('#tot_req_qnty').val() * 1 - tot_issue_qnty;
            	var txt_prop_grey_qnty = $('#txt_prop_grey_qnty').val() * 1;
            	var tblRow = $("#tbl_list_search tr").length;
            	var len = 0;
				var totalGrey = 0;
            	var tot_extra_qnty = 0;
				var hdnIsSales = $('#hdnIsSales').val();

            	$("#tbl_list_search").find('tr').each(function ()
            	{
            		var extra_quantity = 0;
            		len = len + 1;
            		var txtOrginal = $(this).find('input[name="txtOrginal[]"]').val() * 1;
            		var txtGreyQnty_placeholder = $(this).find('input[name="txtGreyQnty[]"]').attr('placeholder') * 1;

            		if (txtOrginal == 0)
					{
            			$(this).remove();
            		}
            		else
					{
            			if (txt_prop_grey_qnty > 0)
						{
            				var cum_issue = $(this).find('#txt_cum_issue_'+len).val() * 1;

            				if(receive_basis == 3 || receive_basis == 8)
							{
            					if(hdnIsSales == 0)
								{
									var req_qnty = $(this).find('input[name="txtReqQnty[]"]').val() * 1;
									var totReqQty = $('#tot_req_qnty').val();
									var grey_qnty = (req_qnty*txt_prop_grey_qnty)/totReqQty;
								}
								else
								{
									var req_qnty = $(this).find('input[name="txtReqQnty[]"]').val() * 1;
									var order_allocation_qnty = $(this).find('input[name="txtOrderAllocationQnty[]"]').val() * 1;
									var perc = (req_qnty-cum_issue) / tot_req_qnty * 100;
									if(isNaN(perc)){perc=0};
									var grey_qnty = (perc * txt_prop_grey_qnty) / 100;
								}
            				}
							else if(receive_basis == 1)
							{
            					if(issue_purpose == 2 || issue_purpose == 7 || issue_purpose == 12 || issue_purpose == 15 || issue_purpose == 38 || issue_purpose == 44 || issue_purpose == 46 || issue_purpose == 50 || issue_purpose == 51 )
								{
            						var req_qnty = $(this).find('input[name="txtReqQnty[]"]').val() * 1;
            						var perc = (req_qnty-cum_issue) / tot_req_qnty * 100;
            						if(isNaN(perc)){perc=0};
            					}
            					else
            					{
            						var po_qnty = $(this).find('input[name="txtPoQnty[]"]').val() * 1;
            						var perc = (po_qnty-cum_issue) / tot_po_qnty * 100;
            						if(isNaN(perc)){perc=0};
            					}

            					var grey_qnty = (perc * txt_prop_grey_qnty) / 100;
            				}
							else
							{
            					var po_qnty = $(this).find('input[name="txtPoQnty[]"]').val() * 1;
            					var perc = (po_qnty-cum_issue) / tot_po_qnty * 100;
            					if(isNaN(perc)){perc=0};
            					var grey_qnty = (perc * txt_prop_grey_qnty) / 100;
            				}

            				//var grey_qnty = (perc * txt_prop_grey_qnty) / 100;
            				totalGrey += grey_qnty.toFixed(2)*1;

            				if (tblRow == len)
							{
            					var balance = (txt_prop_grey_qnty.toFixed(2)*1) - (totalGrey*1);
								if(receive_basis == 3 && hdnIsSales ==0)
								{
								}
								else
								{
									if(balance.toFixed(2)*1 > 0)
									{
										if(grey_qnty.toFixed(2)*1>0)
										{
											//grey_qnty = grey_qnty - balance;
											grey_qnty = grey_qnty.toFixed(2)*1 - balance.toFixed(2)*1;

										}
									}
									else
									{
										grey_qnty = grey_qnty.toFixed(2)*1 + balance.toFixed(2)*1;
									}
								}
            				}

            				var is_work_order = 0;
            				if(issue_purpose == 2 || issue_purpose == 7 || issue_purpose == 12 || issue_purpose == 15 || issue_purpose == 38 || issue_purpose == 44 || issue_purpose == 46 || issue_purpose == 50 || issue_purpose == 51  )
							{
            					is_work_order = 1;
            				}

							if ((grey_qnty.toFixed(2) * 1 > txtGreyQnty_placeholder.toFixed(2) * 1) && (receive_basis == 1 && (is_work_order != 1))) {
            					$(this).find('input[name="txtGreyQnty[]"]').val(grey_qnty.toFixed(2));
            					extra_quantity = ((grey_qnty.toFixed(2) * 1) - (txtGreyQnty_placeholder.toFixed(2) * 1));
            					tot_extra_qnty += extra_quantity;
            					$(this).find('input[name="txtReturnQnty[]"]').val(extra_quantity.toFixed(2));
            					$(this).find('input[name="txtReturnQnty[]"]').attr('disabled', false).attr('readonly', false);
            					return;
            				}
            				else
							{
								$(this).find('input[name="txtReturnQnty[]"]').val("");

								if(isNaN(grey_qnty))
								{
									$(this).find('input[name="txtGreyQnty[]"]').val('0.00');
								}
								else
								{
            						$(this).find('input[name="txtGreyQnty[]"]').val(grey_qnty.toFixed(2));
								}

            					$(this).find('input[name="txtReturnQnty[]"]').attr('disabled', false).attr('readonly', false);
            					if(receive_basis == 3 || receive_basis == 8)
								{
            						calculate_returnable_qnty(len,grey_qnty.toFixed(2));
            					}
            				}
            			}
            			else
						{
            				extra_quantity = 0;
            				$('#txt_prop_grey_qnty').val('');
            				$("#tbl_list_search").find('tr').each(function () {
            					$(this).find('input[name="txtGreyQnty[]"]').val('');
            				});
            			}
            			$(this).find('input[name="txtGreyQnty[]"]').attr('readonly', true);
            		}
            	});

				if (tot_extra_qnty > 0)
				{
            		$('#extra_quantity').val(tot_extra_qnty.toFixed(2));
            		$('#txt_prop_retn_qnty').val(tot_extra_qnty.toFixed(2));
            		$('#txt_prop_retn_qnty').attr('readonly', false);
            	}
            	else
				{
            		$('#extra_quantity').val("");
            		$('#txt_prop_retn_qnty').val("");
            		$('#txt_prop_retn_qnty').attr('readonly', false);
            	}

            }
            else
			{
            	$('#txt_prop_grey_qnty').val('');
            	$('#extra_quantity').val("");
            	$('#txt_prop_grey_qnty').attr('readonly', true);
            	$("#tbl_list_search").find('tr').each(function () {
            		$(this).find('input[name="txtGreyQnty[]"]').val('');
            		$(this).find('input[name="txtGreyQnty[]"]').removeAttr('readonly');
            		$(this).find('input[name="txtReturnQnty[]"]').removeAttr('readonly');
            		$(this).find('input[name="txtReturnQnty[]"]').attr('disabled', false).attr('readonly', false);
            	});
            }
        }

		//tot_req_qnty
        function fn_bal_check(str)
        {

        	var tot_extra_qnty = $('#extra_quantity').val()*1;

        	var previous_issue_qty = $('#txtPrevQnty_' + str).val()*1;
        	var update_id = $('#update_id').val();

        	var cbo_distribiution_method = $('#cbo_distribiution_method').val() * 1;
        	var extra_quantity = 0;
        	var txtGreyQnty_placeholder = $('#txtGreyQnty_' + str).attr('placeholder') * 1;

        	var grey_qnty = $('#txtGreyQnty_' + str).val() * 1;

        	var is_work_order = 0;
        	if(issue_purpose == 2 || issue_purpose == 7 || issue_purpose == 12 || issue_purpose == 15  || issue_purpose == 38 || issue_purpose == 44 || issue_purpose == 46 || issue_purpose == 50  || issue_purpose == 51 ){
        		is_work_order = 1;
        	}

        	if ((grey_qnty.toFixed(2) * 1 > txtGreyQnty_placeholder.toFixed(2) * 1) && (receive_basis == 1 && is_work_order != 1) && cbo_distribiution_method == 2) {

        		if(update_id!="" && previous_issue_qty>0)
        		{
        			extra_quantity = (grey_qnty.toFixed(2) - (previous_issue_qty + txtGreyQnty_placeholder));
        		}else{
        			extra_quantity = ((grey_qnty.toFixed(2)) - (txtGreyQnty_placeholder.toFixed(2)));
        		}

        		tot_extra_qnty = (tot_extra_qnty  + extra_quantity);

        		$('#extra_quantity').val(tot_extra_qnty.toFixed(2));
        		$('#txtReturnQnty_' + str).val(extra_quantity.toFixed(2));
        		$('#txtReturnQnty_' + str).attr('disabled', true);
        		return;
        	}
        }

        function distribute_retn_qnty(str)
        {
        	if (str == 1)
        	{
        		if(receive_basis != 3){
        			$('#txt_prop_retn_qnty').attr('readonly', false);
        		}else if(receive_basis != 8){
        			$('#txt_prop_retn_qnty').attr('readonly', false);
        		}else{
        			$('#txt_prop_retn_qnty').attr('readonly', true).attr('disabled', true);
        		}

        		var tot_po_qnty = $('#tot_po_qnty').val() * 1;
        		var txt_prop_retn_qnty = $('#txt_prop_retn_qnty').val() * 1;
        		var tblRow = $("#tbl_list_search tr").length;
        		var len = totalGreyRetn = 0;
        		$("#tbl_list_search").find('tr').each(function ()
        		{
        			len = len + 1;
        			var txtOrginal = $(this).find('input[name="txtOrginal[]"]').val() * 1;
        			if (txtOrginal == 0)
        			{
        				$(this).remove();
        			}
        			else
        			{
        				var po_qnty = $(this).find('input[name="txtPoQnty[]"]').val() * 1;

        				var perc = (po_qnty / tot_po_qnty) * 100;
        				var grey_retn_qnty = (perc * txt_prop_retn_qnty) / 100;

        				totalGreyRetn = totalGreyRetn * 1 + grey_retn_qnty * 1;
        				totalGreyRetn = totalGreyRetn.toFixed(2);
        				if (tblRow == len) {
        					var balance = txt_prop_retn_qnty - totalGreyRetn;
        					if (balance != 0) grey_retn_qnty = grey_retn_qnty + (balance);
        				}
        				if(receive_basis == 3 || receive_basis == 8){
        					$(this).find('input[name="txtReturnQnty[]"]').val(grey_retn_qnty.toFixed(2)).attr('disabled', true);
        				}else{
        					$(this).find('input[name="txtReturnQnty[]"]').val(grey_retn_qnty.toFixed(2));
        				}
        			}
        		});
        	}
        	else
        	{
        		$('#txt_prop_retn_qnty').val('');
        		$('#txt_prop_retn_qnty').attr('readonly', true).attr('disabled', true);
        		$("#tbl_list_search").find('tr').each(function () {
        			if(receive_basis == 3 || receive_basis == 8){
        				$(this).find('input[name="txtReturnQnty[]"]').val('').attr('readonly', true).attr('disabled', true);
        			}else{
        				$(this).find('input[name="txtReturnQnty[]"]').val('');
        			}
        		});
        	}
        }

        var selected_id = new Array();
        function check_all_data()
        {
        	var tbl_row_count = document.getElementById('tbl_list_search').rows.length;

        	tbl_row_count = tbl_row_count - 1;
        	for (var i = 1; i <= tbl_row_count; i++) {
        		js_set_value(i);
        	}
        }

        function toggle(x, origColor)
        {
        	var newColor = 'yellow';
        	if (x.style) {
        		x.style.backgroundColor = ( newColor == x.style.backgroundColor ) ? origColor : newColor;
        	}
        }

        function set_all()
        {
        	var old = document.getElementById('txt_po_row_id').value;
        	if (old != "") {
        		old = old.split(",");
        		for (var i = 0; i < old.length; i++) {
        			js_set_value(old[i])
        		}
        	}
        }

        function js_set_value(str)
        {
        	toggle(document.getElementById('search' + str), '#FFFFCC');

        	if (jQuery.inArray($('#txt_individual_id' + str).val(), selected_id) == -1) {
        		selected_id.push($('#txt_individual_id' + str).val());
        	}
        	else {
        		for (var i = 0; i < selected_id.length; i++) {
        			if (selected_id[i] == $('#txt_individual_id' + str).val()) break;
        		}
        		selected_id.splice(i, 1);
        	}
        	var id = '';
        	for (var i = 0; i < selected_id.length; i++) {
        		id += selected_id[i] + ',';
        	}
        	id = id.substr(0, id.length - 1);

        	$('#po_id').val(id);
        }

        function show_grey_prod_recv()
        {
        	var po_id = $('#po_id').val();
        	var prev_save_string = $('#prev_save_string').val();
        	var prev_method = $('#prev_method').val();
        	var prev_total_qnty = $('#prev_total_qnty').val();
        	var prev_retn_qnty = $('#prev_retn_qnty').val();
        	show_list_view(po_id + '_' + '1' + '_' + prev_save_string + '_' + prev_method + '_' + prev_total_qnty + '_' + prev_retn_qnty, 'po_popup', 'search_div', 'yarn_issue_controller', '');
        }

        function hidden_field_reset()
        {
        	$('#po_id').val('');
        	$('#save_string').val('');
        	$('#tot_grey_qnty').val('');
        	selected_id = new Array();
        }

        function fnc_close()
        {
        	var save_string = '';
        	var tot_grey_qnty = 0;
        	var tot_retn_qnty = '';
        	var no_of_roll = '';
        	var po_id_array = new Array();
        	$("#tbl_list_search").find('tr').each(function () {
        		var txtPoId = $(this).find('input[name="txtPoId[]"]').val();
        		var txtGreyQnty = $(this).find('input[name="txtGreyQnty[]"]').val();
        		var txtReturnQnty = $(this).find('input[name="txtReturnQnty[]"]').val();
        		tot_grey_qnty = tot_grey_qnty * 1 + txtGreyQnty * 1;
        		tot_retn_qnty = tot_retn_qnty * 1 + txtReturnQnty * 1;

        		if (txtGreyQnty * 1 > 0) {
        			if (save_string == "") {
        				save_string = txtPoId + "**" + txtGreyQnty + "**" + txtReturnQnty;
        			}
        			else {
        				save_string += "," + txtPoId + "**" + txtGreyQnty + "**" + txtReturnQnty;
        			}
        		}
        		if (jQuery.inArray(txtPoId, po_id_array) == -1) {
        			po_id_array.push(txtPoId);
        		}
        	});

        	if (tot_grey_qnty.toString().indexOf(".") == -1) {
        		$('#tot_grey_qnty').val(tot_grey_qnty);
        	}
        	else {
        		$('#tot_grey_qnty').val(tot_grey_qnty.toFixed(2));
        	}

        	$('#save_string').val(save_string);
        	$('#tot_retn_qnty').val(tot_retn_qnty);
        	$('#all_po_id').val(po_id_array);
        	$('#distribution_method').val($('#cbo_distribiution_method').val());
        	parent.emailwindow.hide();
        }

        function calculate_returnable_qnty(i,thisValue)
        {
        	if(thisValue != "")
        	{
        		var plan_qnty = $("#txt_plan_qnty_"+i).val() * 1;
        		var cum_issue = $("#txt_cum_issue_"+i).val() * 1;
        		var hdn_grey_qnty = $("#hdn_grey_qnty_"+i).val() * 1;
        		var hdn_grey_qnty_fixed = $("#hdn_grey_qnty_fixed_"+i).val() * 1;
        		var hdn_returnable_qnty = $("#txt_cum_returnable_"+i).val() * 1;
        		var txtReturnQnty = $("#txtReturnQnty_"+i).val() * 1;
        		var hdnReturnQnty = $("#hdnReturnQnty_"+i).val() * 1;

                // Returnable Formula = (Cummulative Issue Qnty + Given Issue Qnty) - Program Quantity
                if(hdn_grey_qnty > 0 || hdn_grey_qnty != '')
                {

                	var returnable = (cum_issue - (hdn_grey_qnty_fixed - (thisValue*1)) - (hdn_returnable_qnty-hdnReturnQnty)) - plan_qnty;
                }
                else
                {
                	var returnable = ((cum_issue - hdn_returnable_qnty) + (thisValue*1)) - plan_qnty;
                }

                $("#txtReturnQnty_"+i).val((returnable > 0) ? returnable.toFixed(2) : '').attr('readonly', false);
            }
            else
            {
            	$("#txtReturnQnty_"+i).val('');
            }
        }
    </script>

	</head>
	<body>
	<? if ($type != 1)
	{

		?>
		<form name="searchdescfrm" id="searchdescfrm">
		<fieldset style="width:950px;margin-left:10px">
			<!-- previous data here -->
			<input type="hidden" name="prev_save_string" id="prev_save_string" class="text_boxes" value="<? echo $save_data; ?>">
			<input type="hidden" name="prev_total_qnty" id="prev_total_qnty" class="text_boxes" value="<? echo $issueQnty; ?>">
			<input type="hidden" name="prev_retn_qnty" id="prev_retn_qnty" class="text_boxes" value="<? echo $retnQnty; ?>">
			<input type="hidden" name="prev_method" id="prev_method" class="text_boxes" value="<? echo $distribution_method; ?>">
			<!--- END-->
			<input type="hidden" name="save_string" id="save_string" class="text_boxes" value="<? echo $save_data; ?>">
			<input type="hidden" name="tot_grey_qnty" id="tot_grey_qnty" class="text_boxes" value="">
			<input type="hidden" name="tot_retn_qnty" id="tot_retn_qnty" class="text_boxes" value="">
			<input type="hidden" name="all_po_id" id="all_po_id" class="text_boxes" value="">
			<input type="hidden" name="distribution_method" id="distribution_method" class="text_boxes" value="">
			<input type="hidden" name="extra_quantity" id="extra_quantity" class="text_boxes"
			value="<? echo $extra_quantity; ?>">
			<?
    }

	$req_qty_array = array();
	$is_salesOrder = 0;
	$program_qnty_arr=array();
	if ($receive_basis == 3)
	{
		$req_no = $req_no;
	}

	if ($receive_basis == 8)
	{
		$req_no = $hdn_req_no;
	}

	if ($receive_basis == 2 || ($receive_basis == 1 && $issue_purpose == 2))
	{
		$po_cond_req = "";
		$po_cond_iss = "";
		$po_cond_req2 = "";

		if($entry_form == 135)
		{
			$is_salesOrder = 1;
		}
	}
	else
	{
		$po_id_req_iss = '';
		if ($receive_basis == 3 || $receive_basis == 8)
		{
			$req_booking_sql = sql_select("select y.po_id,x.requisition_no,x.knit_id,y.program_qnty program_qnty,y.is_sales from(select distinct(a.requisition_no),a.knit_id from ppl_yarn_requisition_entry a where a.requisition_no=$req_no and a.prod_id=$txt_prod_id and a.status_active=1 and a.is_deleted=0) x, ppl_planning_entry_plan_dtls y where x.knit_id = y.dtls_id ");// and y.status_active=1 and y.is_deleted=0 omit : cause program can deleted even after issue
			$is_salesOrder = $req_booking_sql[0][csf('is_sales')];
			foreach($req_booking_sql as $req_row)
			{
				$program_qnty_arr[$req_row[csf('po_id')]][$req_row[csf('requisition_no')]] += number_format($req_row[csf('program_qnty')], 2, '.', '');
			}
		}
		else if($entry_form == 135)
		{
			$is_salesOrder = 1;
		}
		else if($entry_form == 94)
		{
			$yarn_dyeing_info=sql_select("select entry_form,is_sales from wo_yarn_dyeing_mst where status_active=1 and ydw_no='$booking_no' and company_id=$cbo_company_id and entry_form=94");
			//$is_salesOrder = 1;
			$is_salesOrder = $yarn_dyeing_info[0][csf("is_sales")];
		}
		else
		{
			$req_booking_sql = sql_select("select po_break_down_id as po_id from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no='$booking_no' group by po_break_down_id");
		}

		foreach ($req_booking_sql as $row)
		{
			$po_id_req_iss .= $row[csf('po_id')] . ",";
		}
		$po_id_req_iss = chop($po_id_req_iss, ",");

		if ($po_id_req_iss != "")
		{
			$po_cond_req = " and b.po_break_down_id in($po_id_req_iss)";
			$po_cond_req2 = " and b.id in($po_id_req_iss)";
			$po_cond_iss = " and po_breakdown_id in($po_id_req_iss)";
		}
	}

	$req_qty_array = array();
	$req_val_array = array();

	if ($is_salesOrder == 1)
	{
		if($receive_basis==3)
		{
			$req_data_array=sql_select("select b.requisition_no id,sum(b.yarn_qnty) qnty from ppl_yarn_requisition_entry b where b.requisition_no='$req_no' and b.prod_id='$txt_prod_id' and b.is_deleted=0 and b.is_deleted=0 group by b.requisition_no");
		}
		else if($receive_basis == 8)
		{
			$req_data_array = sql_select("select b.mst_id as id,b.requisition_no,b.prod_id, b.yarn_demand_qnty as qnty from ppl_yarn_demand_reqsn_dtls b where b.mst_id = ".$demand_id." and b.yarn_demand_qnty>0 and b.status_active=1 and b.is_deleted = 0");//hdn_dmnd_req_id
		}
		else
		{
			if($entry_form == 94)
			{
				$req_data_array=sql_select("select b.job_no_id id,b.product_id,sum(b.yarn_wo_qty) qnty,sum(b.amount*b.dyeing_charge) val from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='$booking_no' group by b.job_no_id,b.product_id");
			}
			else if($entry_form == 135)
			{
				$req_data_array=sql_select("select b.job_no_id id,b.product_id,b.yarn_color, sum(b.yarn_wo_qty) qnty,sum(b.amount*b.dyeing_charge) val from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='$booking_no' group by b.job_no_id,b.product_id,b.yarn_color");
			}
			else
			{
				$req_data_array = sql_select("select a.id, sum(b.grey_qty) qnty,sum (b.amount*b.avg_rate) val from fabric_sales_order_mst a inner join fabric_sales_order_dtls b on a.id = b.mst_id where a.id in($po_id_req_iss) group by a.id");
			}
		}
	}
	else if($is_salesOrder == 0)
	{
		if($receive_basis==3)
		{
			$sqlReqBreakdown="select  b.requisition_id, order_id, item_id, order_requisition_qty, b.requisition_qty as qnty from ppl_yarn_requisition_breakdown b where b.requisition_id='".$req_no."' and b.item_id='".$txt_prod_id."' and b.is_deleted=0 and b.is_deleted=0";

			$sqlReqRsltSet = sql_select($sqlReqBreakdown);
			$reqBrkDownArr = array();
			foreach($sqlReqRsltSet as $row)
			{
				$reqBrkDownArr[$row[csf('order_id')]]['order_requisition_qty'] = $row[csf('order_requisition_qty')];
			}
		}
		else if($receive_basis == 8)
		{
			if($all_po_id!="")
			{
				$po_id_arr = explode(",",$all_po_id);


				$demand_qnty = return_field_value("yarn_demand_qnty", "ppl_yarn_demand_reqsn_dtls a", "a.mst_id = ".$demand_id." and a.requisition_no = $hdn_req_no and a.prod_id=$txt_prod_id and a.status_active=1 and a.is_deleted=0", "yarn_demand_qnty");

				$total_po_qnty_in_pcs = return_field_value("sum(b.po_quantity*a.total_set_qnty) as total_po_qnty_in_pcs","wo_po_details_master a, wo_po_break_down b","a.job_no=b.job_no_mst and b.id in ($all_po_id)","total_po_qnty_in_pcs");

				$po_sql_result = sql_select(" select b.id, (b.po_quantity*a.total_set_qnty) as po_quantity_in_pcs
				from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in ($all_po_id) $po_cond_req2" );

				$number_of_po = count($po_sql_result);

				//$po_wise_demand_qty = 0;
				$demand_req_qty_array = array();
				$i=0;
				foreach($po_sql_result as $row)
				{
					$i++;
					$percentage = ($row[csf('po_quantity_in_pcs')] / $total_po_qnty_in_pcs) * 100;
					//echo $percentage."test".$row[csf('po_quantity')] ."/". $total_po_qnty_in_pcs;
					$distribiute_demand_qnty = ($percentage * $demand_qnty) / 100;
					$demand_req_qty_array[$row[csf('id')]]['distribiute_demand_qnty'] = $distribiute_demand_qnty;
				}
			}
		}
		else
		{
			if($entry_form == 94 || $entry_form == 41 || $entry_form == 42 || $entry_form == 125 || $entry_form == 340)
			{
				$req_data_array=sql_select("select b.job_no_id id,b.product_id,sum(b.yarn_wo_qty) qnty,sum(b.amount*b.dyeing_charge) val from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='$booking_no' group by b.job_no_id,b.product_id");
			}
			else
			{
				$req_data_array = sql_select("select b.po_break_down_id, sum(b.grey_fab_qnty) as qnty, sum(b.amount*a.exchange_rate) as val from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category in(2,13) and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 $po_cond_req group by b.po_break_down_id");
			}
		}
	}
	else
	{

		if($receive_basis==3)
		{
			$req_data_array=sql_select("select b.requisition_no id,sum(b.yarn_qnty) qnty from ppl_yarn_requisition_entry b where b.requisition_no='$req_no' and b.prod_id='$txt_prod_id' and b.is_deleted=0 and b.is_deleted=0 group by b.requisition_no");
		}
		else if($receive_basis == 8)
		{
			$req_data_array = sql_select("select b.mst_id as id,b.requisition_no,sum(b.yarn_demand_qnty) as qnty from ppl_yarn_demand_reqsn_dtls b where b.mst_id = ".$demand_id." and b.status_active=1 and b.is_deleted = 0 group by b.mst_id,b.requisition_no");//hdn_dmnd_req_id
		}
		else
		{
			if($entry_form == 94 || $entry_form == 41 || $entry_form == 42 || $entry_form == 125 || $entry_form == 340)
			{
				$req_data_array=sql_select("select b.job_no_id id,b.product_id,sum(b.yarn_wo_qty) qnty,sum(b.amount*b.dyeing_charge) val from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='$booking_no' group by b.job_no_id,b.product_id");
			}
			else
			{
				$req_data_array = sql_select("select b.po_break_down_id, sum(b.grey_fab_qnty) as qnty, sum(b.amount*a.exchange_rate) as val from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category in(2,13) and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 $po_cond_req group by b.po_break_down_id");

			}
		}
	}

	//for requisition information
	foreach ($req_data_array as $row)
	{
		if ($is_salesOrder == 1)
		{
			if($receive_basis==3)
			{
				$req_qty_array[$row[csf('id')]] = $row[csf('qnty')];
				$req_val_array[$row[csf('id')]] = $row[csf('val')];
			}
			else if($receive_basis == 8)
			{
				$req_qty_array[$row[csf('id')]][$row[csf('requisition_no')]][$row[csf('prod_id')]] = $row[csf('qnty')];
				$req_val_array[$row[csf('id')]][$row[csf('requisition_no')]][$row[csf('prod_id')]] = $row[csf('val')];
			}
			else
			{
				if($entry_form == 94)
				{
					$req_qty_array[$row[csf('id')]][$row[csf('product_id')]] = $row[csf('qnty')];
					$req_val_array[$row[csf('id')]][$row[csf('product_id')]] = $row[csf('val')];
				}
				else if($entry_form == 135)
				{
					$req_qty_array[$row[csf('id')]][$row[csf('product_id')]][$row[csf('yarn_color')]] = $row[csf('qnty')];
					$req_val_array[$row[csf('id')]][$row[csf('product_id')]][$row[csf('yarn_color')]] = $row[csf('val')];
				}
				else
				{
					$req_qty_array[$row[csf('id')]] = $row[csf('qnty')];
					$req_val_array[$row[csf('id')]] = $row[csf('val')];
				}
			}
		}
		else
		{
			if($receive_basis==3)
			{
				$req_qty_array[$row[csf('id')]] = $row[csf('qnty')];
				$req_val_array[$row[csf('id')]] = 0;
			}
			else
			{
				if($entry_form == 94 || $entry_form == 41 || $entry_form == 42 || $entry_form == 114 || $entry_form == 125 || $entry_form == 340)
				{
					$req_qty_array[$row[csf('id')]][$row[csf('product_id')]] = $row[csf('qnty')];
					$req_val_array[$row[csf('id')]][$row[csf('product_id')]] = $row[csf('val')];
				}
				else
				{
					$req_qty_array[$row[csf('po_break_down_id')]] = $row[csf('qnty')];
					$req_val_array[$row[csf('po_break_down_id')]] = $row[csf('val')];
				}
			}
		}
	}

	//echo "<pre>";
	//print_r($req_qty_array);
	//die();

	$product_arr = return_library_array("select id, avg_rate_per_unit from product_details_master where item_category_id=1", 'id', 'avg_rate_per_unit');
	$cum_issue_array = $cum_returnable_array= array();
	$sales_order_cond = '';
	if ($is_salesOrder == 1)
	{
		$sales_order_cond = ' and is_sales=1';
	}
	else
	{
		$sales_order_cond = '';
	}

	if($receive_basis == 3)
	{
		$cum_issu_return_sql = "select a.po_breakdown_id, a.prod_id,b.issue_id,sum(a.quantity) return_qnty,c.booking_no req_no from order_wise_pro_details a,inv_transaction b,inv_receive_master c where a.trans_id=b.id and b.mst_id=c.id and a.status_active=1 and a.is_deleted=0 and a.issue_purpose!=2 $po_cond_iss $sales_order_cond and a.prod_id=$txt_prod_id and a.entry_form ='9' and a.trans_type=4 group by a.po_breakdown_id, a.prod_id,b.issue_id,c.booking_no";
		$cum_issu_return_res = sql_select($cum_issu_return_sql);
		$cum_issue_return_array=array();
		foreach ($cum_issu_return_res as $row)
		{
			$cum_issue_return_array[$row[csf('po_breakdown_id')]][$row[csf('prod_id')]][$row[csf('issue_id')]][$row[csf('req_no')]] += $row[csf('return_qnty')];
		}

		$cum_issu_sql = "select a.po_breakdown_id, a.prod_id,b.requisition_no,b.mst_id issue_id,
		sum(CASE WHEN a.entry_form ='3' and a.trans_type=2 THEN quantity ELSE 0 END) AS issue_qnty,
		sum(case when a.entry_form ='3' and a.trans_type=2 then returnable_qnty else 0 end) as returnable_qnty,
		sum(CASE WHEN a.entry_form ='11' and a.trans_type=5 THEN quantity ELSE 0 END) AS transfer_in_qnty_yarn,
		sum(CASE WHEN a.entry_form ='11' and a.trans_type=6 THEN quantity ELSE 0 END) AS transfer_out_qnty_yarn
		from order_wise_pro_details a,inv_transaction b
		where a.trans_id=b.id and a.status_active=1 and a.is_deleted=0 and a.issue_purpose!=2 and b.status_active=1
		$po_cond_iss $sales_order_cond and a.prod_id=$txt_prod_id
		group by a.po_breakdown_id, a.prod_id,b.requisition_no,b.mst_id";
		//echo $cum_issu_sql;
		$cum_issu_sql_res = sql_select($cum_issu_sql);
		$issue_return_qnty=0;
		foreach ($cum_issu_sql_res as $row)
		{
			$issue_return_qnty = $cum_issue_return_array[$row[csf('po_breakdown_id')]][$row[csf('prod_id')]][$row[csf('issue_id')]][$row[csf('requisition_no')]];

			$cum_issue_array[$row[csf('po_breakdown_id')]][$row[csf('requisition_no')]] += $row[csf('issue_qnty')] + $row[csf('transfer_in_qnty_yarn')] - $issue_return_qnty - $row[csf('transfer_out_qnty_yarn')];

			$cum_returnable_array[$row[csf('po_breakdown_id')]][$row[csf('requisition_no')]] += $row[csf('returnable_qnty')];

			$value = ($row[csf('issue_qnty')] * $product_arr[$row[csf('prod_id')]]) + ($row[csf('transfer_in_qnty_yarn')] * $product_arr[$row[csf('prod_id')]]) - ($issue_return_qnty * $product_arr[$row[csf('prod_id')]]) - ($row[csf('transfer_out_qnty_yarn')] * $product_arr[$row[csf('prod_id')]]);

			$cum_issue_val_array[$row[csf('po_breakdown_id')]][$row[csf('requisition_no')]] += $value;
		}
	}
	else if($receive_basis == 8)
	{
		$cum_issu_return_sql = "select a.po_breakdown_id, a.prod_id,b.issue_id,sum(a.quantity) return_qnty,c.booking_no req_no from order_wise_pro_details a,inv_transaction b,inv_receive_master c where a.trans_id=b.id and b.mst_id=c.id and a.status_active=1 and a.is_deleted=0 and a.issue_purpose!=2 $po_cond_iss $sales_order_cond and a.prod_id=$txt_prod_id and a.entry_form ='9' and a.trans_type=4 group by a.po_breakdown_id, a.prod_id,b.issue_id,c.booking_no";
		$cum_issu_return_res = sql_select($cum_issu_return_sql);
		$cum_issue_return_array=array();
		foreach ($cum_issu_return_res as $row) {
			$cum_issue_return_array[$row[csf('po_breakdown_id')]][$row[csf('prod_id')]][$row[csf('issue_id')]][$row[csf('req_no')]] += $row[csf('return_qnty')];
		}

		$cum_issu_sql = "select a.po_breakdown_id, a.prod_id,b.requisition_no,b.demand_id,b.mst_id issue_id,
		sum(CASE WHEN a.entry_form ='3' and a.trans_type=2 THEN quantity ELSE 0 END) AS issue_qnty,
		sum(case when a.entry_form ='3' and a.trans_type=2 then returnable_qnty else 0 end) as returnable_qnty,
		sum(CASE WHEN a.entry_form ='11' and a.trans_type=5 THEN quantity ELSE 0 END) AS transfer_in_qnty_yarn,
		sum(CASE WHEN a.entry_form ='11' and a.trans_type=6 THEN quantity ELSE 0 END) AS transfer_out_qnty_yarn
		from order_wise_pro_details a,inv_transaction b
		where a.trans_id=b.id and a.status_active=1 and a.is_deleted=0 and a.issue_purpose!=2 and b.status_active=1
		$po_cond_iss $sales_order_cond and a.prod_id=$txt_prod_id
		group by a.po_breakdown_id, a.prod_id,b.requisition_no,b.demand_id,b.mst_id";

		//echo $cum_issu_sql; die();
		$cum_issu_sql_res = sql_select($cum_issu_sql);

		$issue_return_qnty=0;
		foreach ($cum_issu_sql_res as $row)
		{
			$issue_return_qnty = $cum_issue_return_array[$row[csf('po_breakdown_id')]][$row[csf('prod_id')]][$row[csf('issue_id')]][$row[csf('requisition_no')]];


			$cum_issue_array[$row[csf('po_breakdown_id')]][$row[csf('demand_id')]][$row[csf('requisition_no')]] += $row[csf('issue_qnty')] + $row[csf('transfer_in_qnty_yarn')] - $issue_return_qnty - $row[csf('transfer_out_qnty_yarn')];

			$cum_returnable_array[$row[csf('po_breakdown_id')]][$row[csf('demand_id')]][$row[csf('requisition_no')]] += $row[csf('returnable_qnty')];
			$value = ($row[csf('issue_qnty')] * $product_arr[$row[csf('prod_id')]]) + ($row[csf('transfer_in_qnty_yarn')] * $product_arr[$row[csf('prod_id')]]) - ($issue_return_qnty * $product_arr[$row[csf('prod_id')]]) - ($row[csf('transfer_out_qnty_yarn')] * $product_arr[$row[csf('prod_id')]]);
			$cum_issue_val_array[$row[csf('po_breakdown_id')]][$row[csf('demand_id')]][$row[csf('requisition_no')]] += $value;
		}
	}
	else
	{

		if($entry_form == 94 || $entry_form == 41 || $entry_form == 125 || $entry_form == 135 || $entry_form == 340)
		{
			if( str_replace("'","",$cbo_dyeing_color)!="" )
			{
				$dyeing_color_cond = " and b.dyeing_color_id=".str_replace("'","",$cbo_dyeing_color);
			}

			$cum_issu_sql = "select a.po_breakdown_id, a.prod_id, sum(case when a.entry_form ='3' and a.trans_type=2 then a.quantity else 0 end) as issue_qnty,
			sum(case when a.entry_form ='3' and a.trans_type=2 then a.returnable_qnty else 0 end) as returnable_qnty,
			sum(case when a.entry_form ='9' and a.trans_type=4 then a.quantity else 0 end) as return_qnty,
			sum(case when a.entry_form ='11' and a.trans_type=5 then a.quantity else 0 end) as transfer_in_qnty_yarn,
			sum(case when a.entry_form ='11' and a.trans_type=6 then a.quantity else 0 end) as transfer_out_qnty_yarn,c.issue_number
			from order_wise_pro_details a,inv_transaction b,inv_issue_master c
			where a.status_active=1 and a.is_deleted=0 and a.trans_id=b.id and b.mst_id=c.id and c.issue_basis=1 and c.issue_purpose=$issue_purpose $po_cond_iss $sales_order_cond and c.booking_id='$booking_id' $dyeing_color_cond
			group by a.po_breakdown_id, a.prod_id,c.issue_number";
		}
		else
		{

			$cum_issu_sql = "select po_breakdown_id, prod_id,
			sum(CASE WHEN entry_form ='3' and trans_type=2 THEN quantity ELSE 0 END) AS issue_qnty,
			sum(case when entry_form ='3' and trans_type=2 then returnable_qnty else 0 end) as returnable_qnty,
			sum(CASE WHEN entry_form ='9' and trans_type=4 THEN quantity ELSE 0 END) AS return_qnty,
			sum(CASE WHEN entry_form ='11' and trans_type=5 THEN quantity ELSE 0 END) AS transfer_in_qnty_yarn,
			sum(CASE WHEN entry_form ='11' and trans_type=6 THEN quantity ELSE 0 END) AS transfer_out_qnty_yarn
			from order_wise_pro_details where status_active=1 and is_deleted=0 and issue_purpose=$issue_purpose $po_cond_iss $sales_order_cond group by po_breakdown_id, prod_id";

		}

		$cum_issu_sql_res = sql_select($cum_issu_sql);
		foreach ($cum_issu_sql_res as $row)
		{
			$value = ($row[csf('issue_qnty')] * $product_arr[$row[csf('prod_id')]]) + ($row[csf('transfer_in_qnty_yarn')] * $product_arr[$row[csf('prod_id')]]) - ($row[csf('return_qnty')] * $product_arr[$row[csf('prod_id')]]) - ($row[csf('transfer_out_qnty_yarn')] * $product_arr[$row[csf('prod_id')]]);

			if($entry_form == 94 || $entry_form == 41 || $entry_form == 42 || $entry_form == 114 || $entry_form == 125 || $entry_form == 135 || $entry_form == 340)
			{
				$cum_issue_array[$row[csf('po_breakdown_id')]][$row[csf('prod_id')]] += $row[csf('issue_qnty')] + $row[csf('transfer_in_qnty_yarn')] - $row[csf('return_qnty')] - $row[csf('transfer_out_qnty_yarn')];
				$cum_returnable_array[$row[csf('po_breakdown_id')]][$row[csf('prod_id')]] += $row[csf('returnable_qnty')];
			}
			else
			{
				$cum_issue_array[$row[csf('po_breakdown_id')]] += $row[csf('issue_qnty')] + $row[csf('transfer_in_qnty_yarn')] - $row[csf('return_qnty')] - $row[csf('transfer_out_qnty_yarn')];
				$cum_returnable_array[$row[csf('po_breakdown_id')]] += $row[csf('returnable_qnty')];
			}



            if($entry_form != 135)
            {	//yarn dyeing sales order
            	if($entry_form == 94 || $entry_form == 41 || $entry_form == 125 || $entry_form == 340)
            	{
            		$cum_issue_val_array[$row[csf('po_breakdown_id')]][$row[csf('prod_id')]] += $value;
            	}
            	else
            	{
            		$cum_issue_val_array[$row[csf('po_breakdown_id')]] += $value;
            	}
            }
            else
            {
            	$cum_issue_val_array[$row[csf('po_breakdown_id')]] = 0;
            }
        }
    }

    /*echo "<pre>";
	print_r($cum_issue_array);
	echo "</pre>";*/

	if ($receive_basis == 2 || $receive_basis == 3 || $receive_basis == 8)
    {

    	$basis_arr = array(3,8);
    	if (!in_array($receive_basis, $basis_arr))
    	{
    		?>
    		<table style="margin-left:50px" cellpadding="0" cellspacing="0" width="800" border="1" rules="all"
    		class="rpt_table">
    		<thead>
    			<th>Buyer</th>
    			<th>Search By</th>
    			<th>Search</th>
    			<th>
    				<input type="reset" name="reset" id="reset" value="Reset" style="width:100px" class="formbutton"/>
    				<input type="hidden" name="po_id" id="po_id" value="">
    			</th>
    		</thead>
    		<tr class="general">
    			<td align="center">
    				<?
    				echo create_drop_down("cbo_buyer_name", 180, "select buy.id, buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$cbo_company_id' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) group by buy.id, buy.buyer_name order by buy.buyer_name", "id,buyer_name", 1, "-- Select Buyer --", $selected, "", "");
    				?>
    			</td>
    			<td align="center">
    				<?
    				$search_by_arr = array(1 => "PO No", 2 => "Job No", 3 => "File No", 4 => "Internal Ref No");
    				echo create_drop_down("cbo_search_by", 170, $search_by_arr, "", 0, "--Select--", "", $dd, 0);
    				?>
    			</td>
    			<td align="center">
    				<input type="text" style="width:130px" class="text_boxes" name="txt_search_common" id="txt_search_common"/>
    			</td>
    			<td align="center">
    				<input type="button" name="button2" class="formbutton" value="Show" onClick="fn_show_check()" style="width:100px;"/>
    			</td>
    		</tr>
    		</table>
    		<?
    	}
    	?>
    	<div id="search_div" style="margin-top:2px">
		<?
        if ($all_po_id != "" || $po_id != "")
        {
            ?>
            <div style="width:930px; margin-top:2px" align="center">
                <table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="300"
                align="center">
                    <thead>
                        <th>Total Issue Qnty</th>
                        <th>Total Returnable Qnty</th>
                        <th>Distribution Method</th>
                    </thead>
                    <tr class="general">
                        <td><input type="text" name="txt_prop_grey_qnty" id="txt_prop_grey_qnty"
                            class="text_boxes_numeric"
                            value="<? if ($prev_method == 1) echo $issueQnty; ?>" style="width:120px"
                            onBlur="distribute_qnty(document.getElementById('cbo_distribiution_method').value)">
                        </td>
                        <td><input type="text" name="txt_prop_retn_qnty" id="txt_prop_retn_qnty"
                            class="text_boxes_numeric"
                            value="<? if ($prev_method == 1) echo $retnQnty; ?>" style="width:120px"
                            onBlur="distribute_retn_qnty(document.getElementById('cbo_distribiution_method').value)"
                            <?php echo ($receive_basis == 3 || $receive_basis == 8)?"disabled='disabled'":''; ?> >
                        </td>
                        <td>
                            <?
                            $distribiution_method = array(1 => "Proportionately", 2 => "Manually");
                            echo create_drop_down("cbo_distribiution_method", 160, $distribiution_method, "", 0, "--Select--", $prev_method, "distribute_qnty(this.value);distribute_retn_qnty(this.value);", 0);
                            ?>
                        </td>
                    </tr>
                </table>
            </div>
            <div style="margin-left:5px; margin-top:2px">
            <?
            $distribute_qnty_variable ="";
            if(trim($cbo_company_id)!="")
            {
            $distribute_qnty_variable = return_field_value("distribute_qnty", "variable_settings_production", "company_name='$cbo_company_id' and variable_list=5 and status_active=1 and is_deleted=0", "distribute_qnty");
            }
            ?>
            <table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="950">
                <thead>
                    <th width="120"><?php echo ($is_salesOrder==1)?"Sales Order No":"PO No"?></th>
                    <th width="80">Internal Ref</th>
                    <th width="80">File No</th>
                    <?
                    if($distribute_qnty_variable == 1)
                    {
                        ?>
                        <th width="70">Distribution Qty</th>
                        <?
                    }
                    ?>
                    <th width="70">Req. Qty</th>
                    <th width="70">Req. Value</th>
                    <th width="70">PO Qty</th>
                    <th width="70">Cum. Iss. Qty</th>
                    <th width="70">Cum. Iss. Value</th>
                    <th width="70">Balance Value</th>
                    <th width="85">Issue Qty</th>
                    <th>Returnable Qty</th>
                </thead>
            </table>
            <div style="width:970px; max-height:200px; overflow-y:scroll" id="list_container" align="left">
                <table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="950" id="tbl_list_search">
                <?
                if ($po_id == "") $po_id = $all_po_id; else $po_id = $po_id;
                $i = 1;
                $tot_po_qnty = 0;
                $allocation_sql = "select a.booking_no,b.po_break_down_id,a.qnty total_allocation_qnty,b.qnty order_wise_allocation from inv_material_allocation_mst a,inv_material_allocation_dtls b where a.id=b.mst_id and a.item_id=$txt_prod_id and b.po_break_down_id in($po_id) and a.status_active=1 and b.status_active=1";

                $allocation_result = sql_select($allocation_sql);
				$order_wise_allocation_arr = $allocated_po_id_arr = array();
                $total_allocation_qnty=0;
                foreach ($allocation_result as $allocation_row)
                {
                    $order_wise_allocation_arr[$allocation_row[csf("po_break_down_id")]] = $allocation_row[csf("order_wise_allocation")];
                    $total_allocation_qnty += $allocation_row[csf("order_wise_allocation")];
					$allocated_po_id_arr[$allocation_row[csf("po_break_down_id")]] = $allocation_row[csf("po_break_down_id")];
                }

				$alocated_po_id = implode(",",$allocated_po_id_arr);
				$alocated_po_id_cond = ($alocated_po_id!="")?" and b.id in($alocated_po_id) ":"";

                if ($is_salesOrder == 1)
                {
                    $po_sql = "select a.id, a.job_no as po_number, sum(b.grey_qty) as po_quantity, 1 as total_set_qnty
                    from fabric_sales_order_mst a, fabric_sales_order_dtls b where a.id=b.mst_id and a.id in ($po_id) group by a.id, a.job_no";
                }
                else
                {
                    if( $po_id != "" && $receive_basis == 3 || $receive_basis==8)
                    {
                        $po_sql = "select b.id, b.po_number,b.file_no,b.grouping, b.po_quantity, a.total_set_qnty
                        from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst $po_cond_req2 $alocated_po_id_cond";
                    }
                    else
                    {
                        $po_sql = "select b.id, b.po_number,b.file_no,b.grouping, b.po_quantity, a.total_set_qnty
                        from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in ($po_id) $alocated_po_id_cond";
                    }
                }

                if($receive_basis == 3 || $receive_basis == 8)
                {
                    $distribiution_info = sql_select("select requisition_no,po_break_down_id,prod_id,sum(distribution_qnty) distribution_qnty from  ppl_yarn_req_distribution where requisition_no=$req_no and prod_id=$txt_prod_id and status_active=1 group by requisition_no,po_break_down_id,prod_id");

                    foreach ($distribiution_info as $dist_row)
                    {
                        $order_wise_dist[$dist_row[csf("requisition_no")]][$dist_row[csf("po_break_down_id")]] = $dist_row[csf("distribution_qnty")];
                    }
                }

                $explSaveData = explode(",", $save_data);
                $po_dataArray = array();
                foreach ($explSaveData as $val)
                {
                    $woQnty = explode("**", $val);
                    $po_dataArray[$woQnty[0]]['qnty'] = $woQnty[1];
                    $po_dataArray[$woQnty[0]]['retQnty'] = $woQnty[2];
                }

                $nameArray = sql_select($po_sql);
                $total_req_qnty=$tot_cum_issue=0;
                foreach ($nameArray as $row)
                {
                    if ($i % 2 == 0)
                        $bgcolor = "#E9F3FF";
                    else
                        $bgcolor = "#FFFFFF";

                    if ($is_salesOrder != 1)
                    {
                        $po_qnty_in_pcs = $row[csf('po_quantity')] * $row[csf('total_set_qnty')];
                        $tot_po_qnty += $po_qnty_in_pcs;
                    }
                    else
                    {
                        $po_qnty_in_pcs = 0;
                        $tot_po_qnty += 0;
                    }

                    $qnty = $po_dataArray[$row[csf('id')]]['qnty'];
                    $returnQnty = $po_dataArray[$row[csf('id')]]['retQnty'];
                    if($receive_basis ==3  || $receive_basis == 8)
                    {
                        if($is_salesOrder == 0)
                        {
                            $balance_qty = '';
                            $balance_val = '';

                            if($receive_basis == 8)
                            {
                                $req_qnty = number_format($demand_req_qty_array[$row[csf('id')]]['distribiute_demand_qnty'], 2, '.', '');
                            }
                            else
                            {
                                $req_qnty = number_format($reqBrkDownArr[$row[csf('id')]]['order_requisition_qty'], 2, '.', '');
                            }

                            $total_req_qnty += $req_qnty;
                        }
                        else
                        {
                            $balance_qty = '';
                            $balance_val = '';
                            if($receive_basis == 8)
                            {
                                $requisition_qnty = number_format($req_qty_array[$demand_id][$req_no][$txt_prod_id], 2, '.', '');
                            }
                            else
                            {
                                $requisition_qnty = number_format($req_qty_array[$req_no], 2, '.', '');
                            }

                            if(count($order_wise_allocation_arr) > 1)
                            {
                                $req_qnty = ($requisition_qnty/$total_allocation_qnty)*$order_wise_allocation_arr[$row[csf("id")]];
                            }
                            else
                            {
                                $req_qnty = $requisition_qnty;
                            }

                            $total_req_qnty += $req_qnty;
                        }
                    }
                    else
                    {
                        $balance_qty = $req_qty_array[$row[csf('id')]] - $cum_issue_array[$row[csf('id')]];
                        $balance_val = $req_val_array[$row[csf('id')]] - $cum_issue_val_array[$row[csf('id')]];
                        $req_qnty = number_format($req_qty_array[$row[csf('id')]], 2, '.', '');
                    }

                    $allocation_q=$order_wise_allocation_arr[$row[csf("id")]];

                    if ($is_salesOrder != 1)
                    {
                        if($distribute_qnty_variable == 1)
                        {
                            $distribiution_qnty = $order_wise_dist[$req_no][$row[csf("id")]];
                        }
                        else
                        {
                            $distribiution_qnty = $program_qnty_arr[$row[csf('id')]][$req_no];
                        }
                    }
                    else
                    {
                        $distribiution_qnty = $program_qnty_arr[$row[csf('id')]][$req_no];
                    }
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
                        <td width="120" align="center">
                            <? echo $row[csf('po_number')]; ?>
                            <input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
                            <input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="1">
                        </td>
                        <td width="80">
                            <p><? echo $row[csf('grouping')]; ?></p>
                        </td>
                        <td width="80"><? echo $row[csf('file_no')]; ?></td>
                        <?
                        if($distribute_qnty_variable == 1)
                        {
                            ?>
                            <td width="70" align="right"><? echo $distribiution_qnty; ?></td>
                            <?
                        }
                        ?>
                        <td width="70" align="right" title="(Requisition Quantity[<?php echo $requisition_qnty;?>] &#247; Total Allocation[<?php echo $total_allocation_qnty;?>]) &#215; Order Wise Allocation[<?php echo $allocation_q;?>]">
                        <? echo number_format($req_qnty, 2, '.', ''); ?>
                        <input type="hidden" name="txtReqQnty[]" id="txtReqQnty_<? echo $i; ?>" value="<? echo number_format($req_qnty, 2, '.', ''); ?>">
                        <input type="hidden" name="txtOrderAllocationQnty[]" id="txtOrderAllocationQnty_<? echo $i; ?>" value="<? echo number_format($allocation_q, 2, '.', ''); ?>">
                        </td>
                        <td width="70" align="right">
                        <?php
                        if ($is_salesOrder != 1)
                        {
                            echo number_format($req_val_array[$row[csf('id')]], 2, '.', '');
                        }
                        ?>
                        </td>
                        <td width="70" align="right">
                        <? if ($is_salesOrder != 1)
                        {
                            echo number_format($po_qnty_in_pcs, 2, '.', ''); ?>
                            <input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>"
                            value="<? echo number_format($po_qnty_in_pcs, 2, '.', ''); ?>">
                            <?
                        }
                        ?>
                        </td>
                        <td width="70" align="right">
                        <? if ($receive_basis == 3)
                        {
                            //$req_no = ($receive_basis == 8)?$demand_id:$req_no;

                            echo number_format($cum_issue_array[$row[csf('id')]][$req_no], 2, '.', '');
                            $tot_cum_issue += $cum_issue_array[$row[csf('id')]][$req_no];

                            //for balance_qty
                            $balance_qty = $req_qnty - $cum_issue_array[$row[csf('id')]][$req_no];
                            ?>
                            <input type="hidden" id="txt_cum_issue_<? echo $i; ?>" value="<? echo $cum_issue_array[$row[csf('id')]][$req_no]; ?>" />
                            <input type="hidden" id="txt_cum_issue_fixed_<? echo $i; ?>" value="<? echo $cum_issue_array[$row[csf('id')]][$req_no]; ?>" />
                            <input type="hidden" id="txt_cum_returnable_<? echo $i; ?>" value="<? echo $cum_returnable_array[$row[csf('id')]][$req_no]; ?>" />
                        <?
                        }
                        else if($receive_basis == 8)
                        {
                            //$req_no = ($receive_basis == 8)?$demand_id:$req_no;

                            echo number_format($cum_issue_array[$row[csf('id')]][$demand_id][$req_no], 2, '.', '');
                            $tot_cum_issue += $cum_issue_array[$row[csf('id')]][$demand_id][$req_no];

                            //for balance_qty
                            $balance_qty = $req_qnty - $cum_issue_array[$row[csf('id')]][$demand_id][$req_no];
                            ?>
                            <input type="hidden" id="txt_cum_issue_<? echo $i; ?>" value="<? echo $cum_issue_array[$row[csf('id')]][$demand_id][$req_no]; ?>" />
                            <input type="hidden" id="txt_cum_issue_fixed_<? echo $i; ?>" value="<? echo $cum_issue_array[$row[csf('id')]][$demand_id][$req_no]; ?>" />
                            <input type="hidden" id="txt_cum_returnable_<? echo $i; ?>" value="<? echo $cum_returnable_array[$row[csf('id')]][$demand_id][$req_no]; ?>" />
                        <?
                        }
                        else
                        {
                            echo number_format($cum_issue_array[$row[csf('id')]], 2, '.', '');
                            $tot_cum_issue += $cum_issue_array[$row[csf('id')]];
                            ?>
                            <input type="hidden" id="txt_cum_issue_<? echo $i; ?>" value="<? echo $cum_issue_array[$row[csf('id')]]; ?>" />
                            <input type="hidden" id="txt_cum_returnable_<? echo $i; ?>" value="<? echo $cum_returnable_array[$row[csf('id')]]; ?>" />
                            <?php
                        }
                        ?>
                        </td>
                        <td width="70" align="right">
                        <?
                        if($receive_basis == 3)
                        {
                            //$req_no = ($receive_basis == 8)?$demand_id:$req_no;
                            echo number_format($cum_issue_val_array[$row[csf('id')]][$req_no], 2, '.', '');
                        }
                        else if ($receive_basis == 8)
                        {
                            //$req_no = ($receive_basis == 8)?$demand_id:$req_no;
                            echo number_format($cum_issue_val_array[$row[csf('id')]][$demand_id][$req_no], 2, '.', '');
                        }
                        else
                        {
                            echo number_format($cum_issue_val_array[$row[csf('id')]], 2, '.', '');
                        }
                        ?>
                        </td>
                        <td width="70" align="right">
                            <? echo number_format($balance_val, 2, '.', ''); ?>
                        </td>
                        <td width="85" align="center">
                            <?

                            ?>
                            <input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:70px" placeholder="<? echo number_format($balance_qty, 2, '.', ''); ?>" value="<? echo $qnty = ($qnty>0)?number_format($qnty,2,'.',''):"";?>" onKeyUp="calculate_returnable_qnty(<?php echo $i;?>,this.value)">

                            <input type="hidden" id="txt_plan_qnty_<? echo $i; ?>" value="<?php echo number_format($distribiution_qnty, 2, '.', '');?>">
                            <?php
                            if($update_id !="")
                            {
                                ?>
                                <input type="hidden" id="hdn_grey_qnty_<? echo $i; ?>" value="<? echo number_format($qnty, 2, '.', ''); ?>">
                                <input type="hidden" id="hdn_grey_qnty_fixed_<? echo $i; ?>" value="<? echo number_format($qnty, 2, '.', ''); ?>">
                                <?php
                            }
                            else
                            {
                                ?>
                                <input type="hidden" id="hdn_grey_qnty_<? echo $i; ?>" value="">
                                <?
                            }
                            ?>
                        </td>
                        <td align="center">
                            <input type="text" name="txtReturnQnty[]"
                            id="txtReturnQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:70px" value="<? echo number_format($returnQnty, 2, '.', ''); ?>">
                            <input type="hidden" id="hdnReturnQnty_<? echo $i; ?>" value="<? echo number_format($returnQnty, 2, '.', ''); ?>">
                        </td>
                    </tr>
                    <?
                    $i++;
                }
                ?>
                <input type="hidden" name="tot_po_qnty" id="tot_po_qnty" class="text_boxes" value="<? echo $tot_po_qnty; ?>">
                <input type="hidden" name="tot_req_qnty" id="tot_req_qnty" class="text_boxes" value="<? echo $total_req_qnty; ?>">
                <input type="hidden" name="tot_issue_qnty" id="tot_issue_qnty" class="text_boxes" value="<? echo $tot_cum_issue; ?>">
                <input type="hidden" name="hdnIsSales" id="hdnIsSales" class="text_boxes" value="<? echo $is_salesOrder; ?>">
                </table>
            </div>
            <table width="950" id="table_id">
            <tr>
                <td align="center">
                    <input type="button" name="close" class="formbutton" value="Close"
                    id="main_close" onClick="fnc_close();" style="width:100px"/>
                </td>
            </tr>
            </table>
            </div>
            <?
        }
        ?>
		</div>
		<?
	}
	else
	{
		//echo "hi==$type";die;
		?>
		<div style="width:930px; margin-top:2px" align="center">
			<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="300"
			align="center">
				<thead>
					<th>Total Issue Qnty</th>
					<th>Total Returnable Qnty</th>
					<th>Distribution Method</th>
				</thead>
				<tr class="general">
					<td><input type="text" name="txt_prop_grey_qnty" id="txt_prop_grey_qnty"
						class="text_boxes_numeric" value="<? if ($prev_method == 1) echo $issueQnty; ?>"
						style="width:120px"
						onBlur="distribute_qnty(document.getElementById('cbo_distribiution_method').value)">
					</td>
					<td><input type="text"
						name="txt_prop_retn_qnty" <? if ($extra_quantity > 0 && $receive_basis == 1 && $issue_purpose != 2) echo "disabled"; ?>
						id="txt_prop_retn_qnty" class="text_boxes_numeric"
						value="<? if ($prev_method == 1) echo $retnQnty; ?>" style="width:120px"
						onBlur="distribute_retn_qnty(document.getElementById('cbo_distribiution_method').value)">
					</td>
					<td>
						<?
						$distribiution_method = array(1 => "Proportionately", 2 => "Manually");
						echo create_drop_down("cbo_distribiution_method", 160, $distribiution_method, "", 0, "--Select--", $prev_method, "distribute_qnty(this.value);distribute_retn_qnty(this.value);", 0);
						?>
					</td>
				</tr>
			</table>
		</div>
		<div style="margin-left:5px; margin-top:2px">

			<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="980">
				<thead>
					<th width="120"><?php echo ($is_salesOrder==1)?"Sales Order No":"PO No"?></th>
					<th width="80">Internal Ref</th>
					<th width="80">File No</th>
					<th width="70">Req. Qnty</th>
					<th width="70">Req. Value</th>
					<th width="70">PO Qnty</th>
					<? if($receive_basis==1 && $issue_purpose==2){ ?>
						<th width="70">Allocation Qnty</th>
					<?}?>
					<th width="70">Cum. Iss. Qty</th>
					<th width="70">Cum. Iss. Value</th>
					<th width="70">Balance Value</th>
					<th width="85">Issue Qnty</th>
					<th>Returnable Qnty</th>
				</thead>
			</table>
			<div style="width:1000px; max-height:150px; overflow-y:scroll" id="list_container" align="left">
				<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="980" id="tbl_list_search">
					<?
					if ($type == 1 && $po_id != "")
					{
						if ($booking_no == "")
						{
							$po_sql = "select b.id, b.po_number, b.po_quantity,b.file_no,b.grouping, a.total_set_qnty from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in ($po_id)";
						}
						else
						{
							$po_sql = "select b.id, b.po_number,b.file_no,b.grouping, b.po_quantity, a.total_set_qnty from wo_po_details_master a, wo_booking_dtls c, wo_po_break_down b where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and c.booking_no='$booking_no' and b.id in ($po_id) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by b.id, b.po_number,b.file_no,b.grouping, b.po_quantity, a.total_set_qnty";
						}
					}
					else
					{
						if ($issue_purpose == 2 || $issue_purpose == 7 || $issue_purpose == 12 || $issue_purpose == 15 || $issue_purpose == 38 || $issue_purpose == 44 || $issue_purpose == 46 || $issue_purpose == 50 || $issue_purpose == 51 )
						{

							if($db_type==0)
							{
								$group_con_booking_no="group_concat(b.fab_booking_no) as fab_booking_no";
								$group_con_alocation_po="group_concat(b.po_break_down_id) as allocated_po";
							}
							else
							{
								$group_con_booking_no="LISTAGG(b.fab_booking_no, ',') WITHIN GROUP (ORDER BY b.fab_booking_no) as fab_booking_no";
								$group_con_alocation_po="LISTAGG(b.po_break_down_id, ',') WITHIN GROUP (ORDER BY b.po_break_down_id) as allocated_po";
							}

							$yarn_dyeing_info=sql_select("select a.entry_form,a.is_sales,$group_con_booking_no from wo_yarn_dyeing_mst a,wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.id='$booking_id' and a.company_id=$cbo_company_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.entry_form,a.is_sales");

							$entry_form = $yarn_dyeing_info[0][csf("entry_form")];
							$is_sales = $yarn_dyeing_info[0][csf("is_sales")];
							$entry_form_cond = ($entry_form != "")?" and entry_form=$entry_form":"";
							$job_no_cond =( $job_no !="")?" and e.job_no='$job_no'":"";

							if( $yarn_dyeing_info[0][csf("fab_booking_no")] !="" )
							{
								$fabric_booking_no_str = "'".implode("','",array_unique(explode(",", $yarn_dyeing_info[0][csf("fab_booking_no")])))."'";
								$booking_no_cond = " and e.booking_no in ($fabric_booking_no_str) ";
							}else{
								$booking_no_cond = "";
							}

							$alocated_po_id = return_field_value("$group_con_alocation_po", "inv_material_allocation_mst e, inv_material_allocation_dtls b","e.id=b.mst_id and e.item_id=$txt_prod_id and e.status_active=1 and b.status_active=1 and b.qnty>0 $job_no_cond $booking_no_cond","allocated_po");

							$alocated_po_id_cond = ($alocated_po_id!="")?" and b.id in($alocated_po_id) ":"";

							if( ($entry_form == 94 || $entry_form == 135) && $is_sales==1)
							{
								$po_sql = "select a.id,a.id as job_id, a.job_no as po_number, sum(b.grey_qty) as po_quantity, 1 as total_set_qnty
								from fabric_sales_order_mst a, fabric_sales_order_dtls b
								where a.id=b.mst_id and a.job_no ='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.id, a.job_no";
							}
							else if($entry_form == 94 && $issue_purpose != 2)
							{
								$po_sql = "select b.id,a.id as job_id, b.po_number,b.file_no,b.grouping, b.po_quantity, a.total_set_qnty from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $alocated_po_id_cond ";
							}
							else
							{
								if($issue_purpose == 2)
								{
									$color_type_id_cond = "and d.color_type_id in (2,3,4,6,32,33,44,47,48,63,71)";
								}else{
									$color_type_id_cond = "";
								}

								$sql_strip="select c.pre_cost_fabric_cost_dtls_id as fab_dtlsid,c.color_number_id,c.stripe_color from  wo_pre_stripe_color c where  c.job_no='$job_no' and c.status_active=1 and c.is_deleted=0 ";

								$result_sql = sql_select($sql_strip);

								foreach($result_sql as $row)
								{
									$fab_strip_colo_arr[$row[csf('fab_dtlsid')]][$row[csf('stripe_color')]][]=$row[csf('color_number_id')];
								}

								//echo $booking_no_cond.test;die; $selectColorType

								$color_fabrication_sql = "select d.id AS fab_dtls_id,d.color_type_id AS color_type_id,  a.id as job_id, a.buyer_name, a.style_ref_no, b.id, b.po_number, b.pub_shipment_date, b.po_quantity, a.total_set_qnty
								from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_fabric_cost_dtls d, wo_booking_dtls e
								where a.id=b.job_id and a.id=d.job_id and b.id=e.PO_BREAK_DOWN_ID and d.id=e.PRE_COST_FABRIC_COST_DTLS_ID and b.status_active=1 and b.is_deleted=0 and a.job_no='$job_no' $color_type_id_cond and d.status_active=1 and d.is_deleted=0 $alocated_po_id_cond $booking_no_cond
								group by d.id,d.color_type_id,a.id, a.buyer_name, a.style_ref_no, b.id, b.po_number, b.pub_shipment_date, b.po_quantity, a.total_set_qnty";

								$color_fabrication_result = sql_select($color_fabrication_sql);

								foreach($color_fabrication_result as $frow)
								{
									$fabrication_string_arr[$frow[csf('job_id')]][$frow[csf('id')]][$frow[csf('style_ref_no')]]['fab_dtls_id'] .= $frow[csf('fab_dtls_id')].",";
									$fabrication_string_arr[$frow[csf('job_id')]][$frow[csf('id')]][$frow[csf('style_ref_no')]]['color_type_id'] .=$frow[csf('color_type_id')].",";
								}
								unset($color_fabrication_result);

								$po_sql = "select a.id as job_id, a.buyer_name, a.style_ref_no, b.id, b.po_number, b.pub_shipment_date, b.po_quantity, a.total_set_qnty
								from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_fabric_cost_dtls d, wo_booking_dtls e
								where a.id=b.job_id and a.id=d.job_id and b.id=e.PO_BREAK_DOWN_ID and d.id=e.PRE_COST_FABRIC_COST_DTLS_ID and b.status_active=1 and b.is_deleted=0 and a.job_no='$job_no' $color_type_id_cond and d.status_active=1 and d.is_deleted=0 $alocated_po_id_cond $booking_no_cond
								group by a.id, a.buyer_name, a.style_ref_no, b.id, b.po_number, b.pub_shipment_date, b.po_quantity, a.total_set_qnty";
								//echo $po_sql;die;
							}
						}
						else
						{
							if ($booking_no == "")
							{
								$po_sql = "select b.id,a.id as job_id, b.po_number,b.file_no,b.grouping, b.po_quantity, a.total_set_qnty from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
							}
							else
							{
								//if($buyer_job_no!="") $buyer_job_no_cond="and a.job_no='$buyer_job_no'";else $buyer_job_no_cond="";
								$po_sql = "select b.id,a.id as job_id, b.po_number,b.file_no,b.grouping, b.po_quantity, a.total_set_qnty
								from wo_po_details_master a, wo_booking_dtls c, wo_po_break_down b
								where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and c.booking_no='$booking_no' $buyer_job_no_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by b.id,a.id, b.po_number,b.file_no,b.grouping, b.po_quantity, a.total_set_qnty";
							}
						}
					}

					if ($save_string == "" && $type == 1) $save_data = $prevQnty;
					$explSaveData = explode(",", $save_data);

					$po_dataArray = array();
					foreach ($explSaveData as $val) {
						$woQnty = explode("**", $val);
						$po_dataArray[$woQnty[0]]['qnty'] = $woQnty[1];
						$po_dataArray[$woQnty[0]]['retQnty'] = $woQnty[2];
					}

					$po_original_dataArray = array();
					$explOriginalSaveData = explode(",", $original_save_data);
					foreach ($explOriginalSaveData as $orival) {
						$originalWoQnty = explode("**", $orival);
						$po_original_dataArray[$originalWoQnty[0]]['qnty'] = $originalWoQnty[1];
						$po_original_dataArray[$originalWoQnty[0]]['retQnty'] = $originalWoQnty[2];
					}

					$i = 1;
					$tot_po_qnty = 0;

					//echo $po_sql;
					$nameArray = sql_select($po_sql);
					$allocation_qty = sql_select("SELECT a.QNTY as allocated_qnty, a.PO_BREAK_DOWN_ID
					from INV_MATERIAL_ALLOCATION_DTLS a, PRODUCT_DETAILS_MASTER b
					where a.item_id = b.id and a.JOB_NO = '$job_no' and b.LOT = '$lot'");
					$allocation_arr = array();
					foreach($allocation_qty as $val)
					{
						$allocation_arr[$val['PO_BREAK_DOWN_ID']]['ALLOCATED_QTY'] = $val['ALLOCATED_QNTY'];
					}
					// echo "<pre>";
					// print_r($allocation_arr);
					foreach ($nameArray as $row)
					{
						if ($i % 2 == 0)
							$bgcolor = "#E9F3FF";
						else
							$bgcolor = "#FFFFFF";

						$po_qnty_in_pcs = $row[csf('po_quantity')] * $row[csf('total_set_qnty')];
						$tot_po_qnty += $po_qnty_in_pcs;

						$qnty = $po_dataArray[$row[csf('id')]]['qnty'];
						$returnQnty = $po_dataArray[$row[csf('id')]]['retQnty'];

						$prev_qty = $po_original_dataArray[$row[csf('id')]]['qnty'];

						if($receive_basis ==3 || $entry_form == 135)
						{
							$balance_qty = '';
							$balance_val = '';
						}
						else
						{
							if($entry_form == 94 || $entry_form == 340 || $entry_form == 41 ||  $entry_form == 125 )
							{
								$balance_qty = $req_qty_array[$row[csf('job_id')]][$txt_prod_id] - $cum_issue_array[$row[csf('id')]][$txt_prod_id];
								$balance_val = $req_val_array[$row[csf('job_id')]][$txt_prod_id] - $cum_issue_val_array[$row[csf('id')]][$txt_prod_id];
							}
							else
							{
								$balance_qty = $req_qty_array[$row[csf('id')]] - $cum_issue_array[$row[csf('id')]];
								$balance_val = $req_val_array[$row[csf('id')]] - $cum_issue_val_array[$row[csf('id')]];
							}
						}

						if( $issue_purpose == 2 && ($entry_form == 41 || $entry_form == 125) )
						{

							//echo "DFGGGGGGGGGGGG".$job_no;die;
							$condition= new condition();
							if($job_no!='')
							{
							 	//echo $job_no.'DDD';die;
								$condition->job_no("='$job_no'");
							}

							$condition->init();
							$conversion= new conversion($condition);
							//echo $conversion->getQuery(); die;
							//$poId,$colorId,$colorTypeId,$process,$uom
							$conversion_qty_arr=$conversion->getQtyArray_by_OrderColorColorTypeAndProcess();
							$conversion_amt_arr=$conversion->getAmountArray_by_OrderColorColorTypeAndProcess();
							//echo $conversion->getQuery();
							// echo "<pre>";
							// print_r($conversion_qty_arr);
							// echo "</pre>";
							$cbo_dyeing_color = str_replace("'", " ", $cbo_dyeing_color);
							$fab_dtls_ids = array_unique(explode(",",chop($fabrication_string_arr[$row[csf('job_id')]][$row[csf('id')]][$row[csf('style_ref_no')]]['fab_dtls_id'],",")));//array_unique(explode(",",$row[csf('fab_dtls_id')]));
							$color_type_ids=array_unique(explode(",",chop($fabrication_string_arr[$row[csf('job_id')]][$row[csf('id')]][$row[csf('style_ref_no')]]['color_type_id'],",")));//array_unique(explode(",",$row[csf('color_type_id')]));

							$tot_precost_req_qnty=0;

							foreach($fab_dtls_ids as $fid)
							{
								$color_number_id = $fab_strip_colo_arr[$fid][$cbo_dyeing_color];
								foreach ($fab_strip_colo_arr[$fid][$cbo_dyeing_color] as $color_number_id_arr=>$color_number_id)
								{
									//echo $row[csf('id')]."=".$cbo_dyeing_color."=".$fid."=".$color_number_id."<br>";
									foreach ($color_type_ids as $color_type_id)
									{
										$tot_precost_req_qnty+= array_sum($conversion_qty_arr[$row[csf('id')]][$color_number_id][$color_type_id][30]);
										$precost_req_val += number_format(array_sum($conversion_amt_arr[$row[csf('id')]][$color_number_id][$color_type_id][30]), 2, '.', '');
									}
								}
							}

							if($tot_precost_req_qnty>0)
							{
									 $po_id = $row[csf('id')];
									// echo "po:".$po_id."<br>";
									// echo "job:".$job_no."<br>";
									// echo "lot:".$lot."<br>";
									$allocation_qty = sql_select("SELECT a.QNTY as allocated_qnty
									from INV_MATERIAL_ALLOCATION_DTLS a, PRODUCT_DETAILS_MASTER b
									where a.item_id = b.id and a.JOB_NO = '$job_no' and b.LOT = '$lot' and a.PO_BREAK_DOWN_ID = $po_id");
								?>
									<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
										<td width="120">
											<p><? echo $row[csf('po_number')];?></p>
											<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
											<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="1">
										</td>
										<td width="80" align="right">
											<p><? echo $row[csf('grouping')]; ?>&nbsp;</p>
										</td>
										<td width="80" align="right">
											<p><? echo $row[csf('file_no')]; ?>&nbsp;</p>
										</td>
										<td width="70" align="right">
											<?
											$req_qnty = number_format($tot_precost_req_qnty, 2, '.', '');
											//perc = (req_qnty-cum_issue) / tot_req_qnty * 100;
											echo $req_qnty;
											$total_req_qnty += $req_qnty;
											?>
											<input type="hidden" name="txtReqQnty[]" id="txtReqQnty_<? echo $i; ?>" value="<? echo number_format($req_qnty, 2, '.', ''); ?>">
										</td>
										<td width="70" align="right">
											<?
											$req_val = number_format($precost_req_val, 2, '.', '');
											echo $req_val;
											?>
										</td>
										<td width="70" align="right">
											<? echo number_format($po_qnty_in_pcs, 2, '.', ''); ?>
											<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo number_format($po_qnty_in_pcs, 2, '.', ''); ?>">
										</td>
										<? if($receive_basis==1 && $issue_purpose==2){ ?>
										<td width="70" align="right">
											<? echo $allocation_arr[$po_id]['ALLOCATED_QTY'];?>
											<!-- <input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? //echo $i; ?>" value="<? //echo number_format($po_qnty_in_pcs, 2, '.', ''); ?>"> -->
										</td>
										<?}?>

										<td width="70" align="right">
											<?
											if( $entry_form == 41 || $entry_form == 125 ){
												$cum_issue = $cum_issue_array[$row[csf('id')]][$txt_prod_id];
												echo number_format($cum_issue_array[$row[csf('id')]][$txt_prod_id], 2, '.', '');
											}
											?>


											<input type="hidden" id="txt_cum_issue_<? echo $i; ?>" value="<? echo number_format($cum_issue, 2, '.', ''); ?>" />
										</td>
										<td width="70" align="right">
											<?

											if($entry_form == 41 || $entry_form == 125 ){
												echo number_format($cum_issue_val_array[$row[csf('id')]][$txt_prod_id], 2, '.', '');
											}
											?>
										</td>
										<td width="70" align="right">
											<?
											if( $entry_form == 41 || $entry_form == 125 )
											{
												$balance_qty = ($req_qnty -$cum_issue_array[$row[csf('id')]][$txt_prod_id]);
												$balance_val = ($req_val - $cum_issue_val_array[$row[csf('id')]][$txt_prod_id]);
												echo number_format($balance_val, 2, '.', '');
											}else{
												$balance_val = $balance_val;
												$balance_qty = $balance_qty;
											}
											?>
										</td>
										<td width="85" align="center">
											<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:70px"
											placeholder="<? echo number_format($balance_qty, 2, '.', ''); ?>" value="<? echo $qnty; ?>" onBlur="fn_bal_check(<? echo $i; ?>)" readonly>

											<input type="hidden" name="txtPrevQnty[]" id="txtPrevQnty_<? echo $i; ?>" value="<? echo $prev_qty; ?>"  readonly>
											<input type="hidden" name="update_id" id="update_id" value="<? echo $update_id; ?>"  readonly>

										</td>
										<td align="center">
											<input type="text" name="txtReturnQnty[]" id="txtReturnQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:70px"
											value="<? echo number_format($returnQnty, 2, '.', ''); ?>" readonly>
										</td>
									</tr>
								<?
								$tot_cum_issue += $cum_issue;
								$i++;
							}
						}
						else
						{

							?>
								<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
									<td width="120">
										<p><? echo $row[csf('po_number')]; ?></p>
										<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
										<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="1">
									</td>
									<td width="80" align="right">
										<p><? echo $row[csf('grouping')]; ?>&nbsp;</p>
									</td>
									<td width="80" align="right">
										<p><? echo $row[csf('file_no')]; ?>&nbsp;</p>
									</td>
									<td width="70" align="right">
										<?
										if($entry_form == 94 || $entry_form == 340)
										{
											//echo $row[csf('job_id')]."==".$txt_prod_id;
											$req_qnty = number_format($req_qty_array[$row[csf('job_id')]][$txt_prod_id], 2, '.', '');
										}
										else if($entry_form == 135)
										{
											$cbo_dyeing_color = str_replace("'", " ", $cbo_dyeing_color);
											$req_qnty = number_format($req_qty_array[$row[csf('job_id')]][$txt_prod_id][$cbo_dyeing_color], 2, '.', '');
										}
										else
										{
											$req_qnty = number_format($req_qty_array[$row[csf('id')]], 2, '.', '');
										}

										//perc = (req_qnty-cum_issue) / tot_req_qnty * 100;
										echo $req_qnty;
										$total_req_qnty += $req_qnty;
										?>
										<input type="hidden" name="txtReqQnty[]" id="txtReqQnty_<? echo $i; ?>" value="<? echo number_format($req_qnty, 2, '.', ''); ?>">
									</td>
									<td width="70" align="right">
										<?

										if($entry_form == 94 || $entry_form == 340)
										{
											//echo $row[csf('job_id')]."==".$txt_prod_id;
											$req_val = number_format($req_val_array[$row[csf('job_id')]][$txt_prod_id], 2, '.', '');
										}
										else
										{
											$req_val = number_format($req_val_array[$row[csf('id')]], 2, '.', '');
										}
										echo $req_val;
										?>
									</td>
									<td width="70" align="right">
										<? echo number_format($po_qnty_in_pcs, 2, '.', ''); ?>
										<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo number_format($po_qnty_in_pcs, 2, '.', ''); ?>">
									</td>
									<td width="70" align="right">
										<?
										if($entry_form == 94 || $entry_form == 340 || $entry_form == 41 || $entry_form == 125 || $entry_form == 135){
											$cum_issue = $cum_issue_array[$row[csf('job_id')]][$txt_prod_id];
											echo number_format($cum_issue_array[$row[csf('job_id')]][$txt_prod_id], 2, '.', '');
										}else{
											$cum_issue = $cum_issue_array[$row[csf('id')]];
											echo number_format($cum_issue_array[$row[csf('id')]], 2, '.', '');
										}
										?>
										<input type="hidden" id="txt_cum_issue_<? echo $i; ?>" value="<? echo number_format($cum_issue, 2, '.' , ''); ?>" />
									</td>
									<td width="70" align="right">
										<?
										if($entry_form == 94 || $entry_form == 340 || $entry_form == 41 || $entry_form == 125 || $entry_form == 135 ){
											echo number_format($cum_issue_val_array[$row[csf('job_id')]][$txt_prod_id], 2, '.', '');
										}else{
											echo number_format($cum_issue_val_array[$row[csf('id')]], 2, '.', '');
										}
										?>

									</td>
									<td width="70" align="right">
										<? echo number_format($balance_val, 2, '.', ''); ?>
									</td>
									<td width="85" align="center">
										<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:70px"
										placeholder="<? echo number_format($balance_qty, 2, '.', ''); ?>" value="<? echo $qnty; ?>" onBlur="fn_bal_check(<? echo $i; ?>)" readonly>

										<input type="hidden" name="txtPrevQnty[]" id="txtPrevQnty_<? echo $i; ?>" value="<? echo $prev_qty; ?>"  readonly>
										<input type="hidden" name="update_id" id="update_id" value="<? echo $update_id; ?>"  readonly>

									</td>
									<td align="center">
										<input type="text" name="txtReturnQnty[]" id="txtReturnQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:70px"
										value="<? echo number_format($returnQnty, 2, '.', ''); ?>" readonly>
									</td>
								</tr>
							<?

							$tot_cum_issue += $cum_issue;
							$i++;
						}
					}
					?>

					<input type="hidden" name="tot_po_qnty" id="tot_po_qnty" class="text_boxes" value="<? echo $tot_po_qnty; ?>">
					<input type="hidden" name="tot_req_qnty" id="tot_req_qnty" class="text_boxes" value="<? echo $total_req_qnty; ?>">
					<input type="hidden" name="tot_issue_qnty" id="tot_issue_qnty" class="text_boxes" value="<? echo $tot_cum_issue; ?>">
				</table>
			</div>
			<table width="950" id="table_id">
				<tr>
					<td align="center">
						<input type="button" name="close" class="formbutton" value="Close" id="main_close"
						onClick="fnc_close();" style="width:100px"/>
					</td>
				</tr>
			</table>
		</div>
		<?
	}

	if ($type != 1)
	{
		?>
		</fieldset>
		</form>
		<?
	}
	?>
	</body>
	<script src="../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if ($action == "create_po_search_list_view")
{
	$data = explode("_", $data);
	$search_string = trim($data[0]);
	$search_by = $data[1];
	$search_con = "";
	if ($search_by == 1 && $search_string != "")
		$search_con = " and b.po_number like '%$search_string%'";
	else if ($search_by == 2 && $search_string != "")
		$search_con = " and a.job_no like '%$search_string%'";
	else if ($search_by == 3 && $search_string != "")
		$search_con = " and b.file_no like '%$search_string%'";
	else if ($search_by == 4 && $search_string != "")
		$search_con = " and b.grouping like '%$search_string%'";

	$company_id = $data[2];
	$buyer_id = $data[3];
	$all_po_id = $data[4];
	$receiveBasis = $data[5];

	if ($all_po_id != "")
		$po_id_cond = " or b.id in($all_po_id)";
	else
		$po_id_cond = "";

	$hidden_po_id = explode(",", $all_po_id);
	if ($buyer_id == 0) {
		echo "<b>Please Select Buyer First</b>";
		die;
	}

	if ($receiveBasis == 1) {
		$sql = "select a.job_no, a.style_ref_no, a.order_uom, b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping, b.file_no
		from wo_po_details_master a, wo_po_break_down b, wo_booking_dtls c
		where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and a.company_name=$company_id and a.buyer_name=$buyer_id $search_con and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, a.job_no, a.style_ref_no, a.order_uom,b.grouping,b.file_no";
	} else {
		$sql = "select a.job_no, a.style_ref_no, a.order_uom, b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping, b.file_no
		from wo_po_details_master a, wo_po_break_down b
		where a.job_no=b.job_no_mst and a.company_name=$company_id and a.buyer_name=$buyer_id $search_con and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, a.job_no, a.style_ref_no, a.order_uom, b.grouping, b.file_no";
	}
	//echo $sql;die;
	?>
	<div>
		<table cellspacing="0" cellpadding="0" border="1" rules="all" width="910" class="rpt_table">
			<thead>
				<th width="40">SL</th>
				<th width="120">Job No</th>
				<th width="150">Style No</th>
				<th width="140">PO No</th>
				<th width="90">Internal Ref.</th>
				<th width="90">File No</th>
				<th width="90">PO Quantity</th>
				<th width="50">UOM</th>
				<th>Shipment Date</th>
			</thead>
		</table>
		<div style="width:930px; overflow-y:scroll; max-height:220px;" id="buyer_list_view" align="center">
			<table cellspacing="0" cellpadding="0" border="1" rules="all" width="910" class="rpt_table"
			id="tbl_list_search">
			<?
			$i = 1;
			$po_row_id = '';

			$nameArray = sql_select($sql);
			foreach ($nameArray as $selectResult) {
				if ($i % 2 == 0)
					$bgcolor = "#E9F3FF";
				else
					$bgcolor = "#FFFFFF";
				if (in_array($selectResult[csf('id')], $hidden_po_id)) {
					if ($po_row_id == "") $po_row_id = $i; else $po_row_id .= "," . $i;
				}

				$po_qnty_in_pcs = $selectResult[csf('po_quantity')] * $selectResult[csf('total_set_qnty')];
				?>
				<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
					id="search<? echo $i; ?>" onClick="js_set_value(<? echo $i; ?>)">
					<td width="40" align="center"><?php echo "$i"; ?>
					<input type="hidden" name="txt_individual_id" id="txt_individual_id<?php echo $i ?>"
					value="<? echo $selectResult[csf('id')]; ?>"/>
				</td>
				<td width="120"><p><? echo $selectResult[csf('job_no')]; ?></p></td>
				<td width="150"><p><? echo $selectResult[csf('style_ref_no')]; ?></p></td>
				<td width="140"><p><? echo $selectResult[csf('po_number')]; ?></p></td>
				<td width="90"><p><? echo $selectResult[csf('grouping')]; ?>&nbsp;</p></td>
				<td width="90"><p><? echo $selectResult[csf('file_no')]; ?>&nbsp;</p></td>
				<td width="90" align="right"><? echo $po_qnty_in_pcs; ?></td>
				<td width="50" align="center">
					<p><? echo $unit_of_measurement[$selectResult[csf('order_uom')]]; ?></p></td>
					<td align="center"><? echo change_date_format($selectResult[csf('pub_shipment_date')]); ?></td>
				</tr>
				<?
				$i++;
			}
			?>
			<input type="hidden" name="txt_po_row_id" id="txt_po_row_id" value="<?php echo $po_row_id; ?>"/>
		</table>
	</div>
	<table width="820" cellspacing="0" cellpadding="0" style="border:none" align="center">
		<tr>
			<td align="center" height="30" valign="bottom">
				<div style="width:100%">
					<div style="width:50%; float:left" align="left">
						<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()"/> Check /
						Uncheck All
					</div>
					<div style="width:50%; float:left" align="left">
						<input type="button" name="close" onClick="show_grey_prod_recv();" class="formbutton"
						value="Close" style="width:100px"/>
					</div>
				</div>
			</td>
		</tr>
	</table>
</div>
<?
exit();
}

//data save update delete here------------------------------//
if ($action == "save_update_delete")
{
	$process = array(&$_POST);
	extract(check_magic_quote_gpc($process));
	$con = connect();

	if ($db_type == 0)
	{
		mysql_query("BEGIN");
	}

	$txt_issue_qnty=str_replace("'", "", $txt_issue_qnty);
	$update_id=str_replace("'", "", $update_id);

	$variable_store_wise_rate=return_field_value("auto_transfer_rcv","variable_settings_inventory","company_name=$cbo_company_id and variable_list=47 and item_category_id=1 and status_active=1 and is_deleted=0","auto_transfer_rcv");
	if($variable_store_wise_rate != 1) $variable_store_wise_rate=2;

	$store_wise_cond = ($variable_store_wise_rate==1)?" and store_id=$cbo_store_name":"";
	$max_trans_query = sql_select("SELECT max(case when transaction_type in (1,4,5) then transaction_date else null end) as max_date, max(id) as max_id from inv_transaction where prod_id=$txt_prod_id $store_wise_cond and item_category=1 and status_active=1 and transaction_type in (1,4,5)");
	//and transaction_type in (1,4,5)

	if(!empty($max_trans_query))
	{
		$max_recv_date = $max_trans_query[0][csf('max_date')];

		if($max_recv_date!="")
		{
			$max_recv_date = date("Y-m-d", strtotime($max_recv_date));
			$issue_date = date("Y-m-d", strtotime(str_replace("'", "", $txt_issue_date)));

			if ($issue_date < $max_recv_date)
			{
				echo "20**Issue Date Can not Be Less Than Last Receive Date Of This Lot.\nIssue Date $issue_date \nReceived date $max_recv_date ";
				disconnect($con);die;
			}
		}

		if($operation == 1 || $operation == 2)
		{
			$currentTransId = (int)str_replace("'","",$update_id);
			$max_trans_id = (int)$max_trans_query[0][csf('max_id')];

			if ( $max_trans_id > $currentTransId )
			{
				echo "20**Transaction found of this store and product ";
				disconnect($con);die;
			}
		}
	}

	//=====Ref Closing-========
	$issue_basis_id=str_replace("'", "", $cbo_basis);
	if($issue_basis_id==3)
	{
		$req_no_id=str_replace("'", "", $txt_req_no);
		$req_sql = "select c.knit_id as prog_no
		from ppl_planning_info_entry_mst a,ppl_planning_info_entry_dtls b,ppl_yarn_requisition_entry c
		where a.id=b.mst_id and b.id=c.knit_id and c.requisition_no='$req_no_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by c.knit_id";

		$req_result = sql_select($req_sql,1);
		$prog_no=$req_result[0][csf('prog_no')];

		//$sql_ref="select inv_pur_req_mst_id from inv_reference_closing where inv_pur_req_mst_id=$txt_booking_no_id and  reference_type==2";
		$sql_ref="select ref_closing_status,id as prog_no from ppl_planning_info_entry_dtls where id=$prog_no  and status_active=1";
		$prod_result=sql_select($sql_ref,1);
		$ref_closing_status=$prod_result[0][csf('ref_closing_status')];
		if($ref_closing_status==1)
		{
			echo "23**This Req. against prog no is closed";
			disconnect($con);die;
		}
	}

	// check variable settings if allocation is available or not
	$variable_set_allocation = return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_id and variable_list=18 and item_category_id = 1");

	$variable_set_smn_allocation = return_field_value("smn_allocation", "variable_settings_inventory", "company_name=$cbo_company_id and variable_list=18 and item_category_id = 1","smn_allocation");

	$is_auto_allocation_from_requisition = return_field_value("auto_allocate_yarn_from_requis", "variable_settings_production", "company_name=$cbo_company_id and variable_list=6 and status_active=1 and is_deleted=0", "auto_allocate_yarn_from_requis");

	//---- booking basis control start
	$variable_set_booking_basis_control = sql_select("select yes_no,tolerant_percent as over_percentage from variable_settings_inventory where company_name = $cbo_company_id and variable_list = 46 and item_category_id = 1 and is_deleted = 0 and status_active = 1");

	$over_issue_status = preg_replace('/\s+/', '', $variable_set_booking_basis_control[0][csf('yes_no')]); // For all whitespace (including tabs and line ends)
	$over_percentage =  ($variable_set_booking_basis_control[0][csf('over_percentage')]=="")?0:$variable_set_booking_basis_control[0][csf('over_percentage')];

	if( $operation == 0 || $operation == 1 )
	{
		if( $variable_set_allocation != 1 && $over_issue_status==1 && str_replace("'", "", $cbo_basis) == 1 && (  (str_replace("'", "", $cbo_issue_purpose)==1 || str_replace("'", "", $cbo_issue_purpose)==8 ) ) )
		{
			if( str_replace("'", "", $cbo_issue_purpose)==1 )
			{
				$req_booking_sql = sql_select("select sum(b.grey_fab_qnty) as qnty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category in(2,13) and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and b.booking_no=$txt_booking_no");
			}
			else{
				$req_booking_sql = sql_select("select sum(b.grey_fabric) as qnty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category in(2,13) and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and b.booking_no=$txt_booking_no");
			}
			
			$req_booking_qnty = number_format($req_booking_sql[0][csf('qnty')],2,'.','');
			$over_percentage_qty = number_format((($req_booking_qnty/100)*$over_percentage),2,'.','');
			$allowed_qnty = number_format(($req_booking_qnty+$over_percentage_qty),2,'.','');

			if($operation == 1) {$update_id_cond =" and b.id <> $update_id";}

			$previous_issue_sql="select LISTAGG(a.issue_number_prefix_num, ',') WITHIN GROUP (ORDER BY a.id) as issue_mrr,sum(b.cons_quantity) as issue_qnty from inv_issue_master a, inv_transaction b where a.id=b.mst_id and a.issue_basis=1 and a.issue_purpose in (1,8) and a.item_category =1 and a.booking_no=$txt_booking_no and a.booking_id=$txt_booking_id and a.entry_form=3 and b.transaction_type=2 and a.status_active =1 and a.is_deleted=0  and b.status_active=1 and b.is_deleted=0 $update_id_cond";
			$previous_issue_sql_result = sql_select($previous_issue_sql);
			$previous_total_issue_qnty = $previous_issue_sql_result[0][csf('issue_qnty')];
			$issue_mrr = $previous_issue_sql_result[0][csf('issue_mrr')];

			$total_issue_rtn_qty = return_field_value("sum(b.cons_quantity) total_issue_rtn", "inv_receive_master a, inv_transaction b", "a.id=b.mst_id and b.item_category=1 and b.transaction_type=4 and a.booking_no=$txt_booking_no and a.booking_id=$txt_booking_id and a.receive_basis=1  and a.status_active =1 and a.is_deleted=0  and b.status_active=1 and b.is_deleted=0", "total_issue_rtn");

			$total_issue_rtn_sql = "select LISTAGG(a.recv_number_prefix_num, ',') WITHIN GROUP (ORDER BY a.id) as return_mrr, sum(b.cons_quantity) total_issue_rtn from inv_receive_master a, inv_transaction b where a.id=b.mst_id and b.item_category=1 and b.transaction_type=4 and a.booking_no=$txt_booking_no and a.booking_id=$txt_booking_id and a.receive_basis=1  and a.status_active =1 and a.is_deleted=0  and b.status_active=1 and b.is_deleted=0";

			$total_issue_rtn_sql_result = sql_select($total_issue_rtn_sql);
			$total_issue_rtn_qty = $total_issue_rtn_sql_result[0][csf('total_issue_rtn')];
			$return_mrr = $total_issue_rtn_sql_result[0][csf('return_mrr')];

			$actual_previous_issue_qty = ($previous_total_issue_qnty-$total_issue_rtn_qty);
			$total_issue_qnty = number_format(($actual_previous_issue_qty + $txt_issue_qnty),2,'.','');

			//echo "10**".$total_issue_qnty."==".$allowed_qnty."per".$over_percentage_qty; die();
			$msg = "";
			if($allowed_qnty<$total_issue_qnty)
			{
				if($over_percentage>0)
				{
					$msg = "\nOver percentage =$over_percentage%";
				}

				if($total_issue_qnty>0)
				{
					$msg .= "\nIssue No=$issue_mrr\nIssue quantity=$previous_total_issue_qnty";
				}

				if($total_issue_rtn_qty>0)
				{
					$msg .= "\nIssue return No=$return_mrr\nIssue return quantity=$total_issue_rtn_qty";
				}

				echo "20**Issue quantity can not be greater than booking required quantity\nBooking required quantity=$req_booking_qnty".$msg;
				disconnect($con);die;
			}
		}
	}
	
	//---- booking basis control end
	//echo "10**".$over_issue_status."hh"; die();


	$wo_purpose = array(2,7,15,12,38,44,46,50,51);
	// IF BASIS WORK ORDER ISSUE CAN NOT BE GREATER THAN WO QUANTITY
	if( str_replace("'", "", $cbo_basis) == 1 && in_array(str_replace("'", "", $cbo_issue_purpose), $wo_purpose))
	{
		$wo_entry_form = str_replace("'", "", $txt_entry_form);
		$wo_no = str_replace("'", "", $txt_booking_no);

		if(str_replace("'", "", $cbo_issue_purpose)==2) // dyeing color
		{
			$dyeing_color_id = str_replace("'", "", $cbo_dyeing_color);
			$dyeing_color_cond = "and b.dyeing_color_id=$dyeing_color_id";
		}

		$yarn_dyeing_info=sql_select("select a.booking_without_order,a.is_sales from wo_yarn_dyeing_mst a where a.ydw_no='$wo_no' and a.company_id=$cbo_company_id and a.status_active=1 and a.is_deleted=0");
		$is_sales = $yarn_dyeing_info[0][csf("is_sales")];
		$is_with_order_yarn_service_work_order = $yarn_dyeing_info[0][csf("booking_without_order")];

		// 41,114,125,94,340
		if( $wo_entry_form ==41 || $wo_entry_form== 125 || ( $wo_entry_form == 94 && $is_with_order_yarn_service_work_order==1) )
		{
			$previous_issue_qnty = return_field_value("sum(c.quantity) as issue_qnty", "inv_issue_master a, inv_transaction b,order_wise_pro_details c,wo_po_break_down d", "a.id=b.mst_id and a.booking_no=$txt_booking_no and a.booking_id=$txt_booking_id and a.issue_basis=1 and b.prod_id=$txt_prod_id and b.id=c.trans_id and c.trans_type=2 and c.po_breakdown_id=d.id and a.entry_form=3 and b.transaction_type=2 and a.status_active =1 and a.is_deleted=0  and b.status_active =1 and b.is_deleted=0 and d.job_no_mst=$job_no $dyeing_color_cond","issue_qnty");
		}
		else
		{
			$job_no_cond = (str_replace("'", "", $job_no)!="")?" and b.job_no = $job_no":"";

			if( $wo_entry_form == 94 && $is_sales==1)
			{
				$previous_issue_qnty = return_field_value("sum(b.cons_quantity) as issue_qnty", "inv_issue_master a, inv_transaction b", "a.id=b.mst_id and a.booking_no=$txt_booking_no and a.booking_id=$txt_booking_id and a.issue_basis=1 and b.prod_id=$txt_prod_id and b.job_no=$job_no and a.entry_form=3 and b.transaction_type=2 and a.status_active =1 and a.is_deleted=0  and b.status_active =1 and b.is_deleted=0 $dyeing_color_cond $job_no_cond", "issue_qnty");
			}
			else
			{
				$previous_issue_qnty = return_field_value("sum(b.cons_quantity) as issue_qnty", "inv_issue_master a, inv_transaction b", "a.id=b.mst_id and a.booking_no=$txt_booking_no and a.booking_id=$txt_booking_id and a.issue_basis=1 and b.prod_id=$txt_prod_id and a.entry_form=3 and b.transaction_type=2 and a.status_active =1 and a.is_deleted=0  and b.status_active =1 and b.is_deleted=0 $dyeing_color_cond $job_no_cond", "issue_qnty");
			}
		}

		$total_issue_rtn_qty = return_field_value("sum(b.cons_quantity) total_issue_rtn", "inv_receive_master a, inv_transaction b", "a.id=b.mst_id and b.item_category=1 and b.transaction_type=4 and a.booking_id=$txt_booking_id and a.receive_basis in(1) and b.prod_id=$txt_prod_id  and b.status_active=1", "total_issue_rtn");

		$actualPreviousIssue = ($previous_issue_qnty-$total_issue_rtn_qty);

		if ( $operation == 0 )
		{
			if ( ($txt_issue_qnty+$actualPreviousIssue) > str_replace("'", "", $hdn_wo_qnty) )
			{
				$balance = str_replace("'", "", $hdn_wo_qnty)-$actualPreviousIssue;
				echo "11**Issue Quantity can not be greater than Work Order quantity.\nWork Order Quantity = ".str_replace("'", "", $hdn_wo_qnty)."\nCummulative Issue = ".$actualPreviousIssue."\nBalance = ".$balance;
				disconnect($con);die;
			}
		}
		else if ( $operation == 1 )
		{

			if($wo_entry_form==125 || $wo_entry_form==340 || $wo_entry_form==114)
			{
				$wo_qnty = return_field_value("yarn_wo_qty", "wo_yarn_dyeing_dtls", "mst_id=$txt_booking_id and yarn_color=$cbo_dyeing_color and count=$cbo_yarn_count and yarn_type=$cbo_yarn_type and status_active=1 and is_deleted=0");//and product_id=$txt_prod_id
			}
			else
			{
				$wo_qnty = return_field_value("yarn_wo_qty", "wo_yarn_dyeing_dtls", "mst_id=$txt_booking_id and yarn_color=$cbo_dyeing_color and product_id=$txt_prod_id and status_active=1 and is_deleted=0");
			}

			$hidden_p_issue_qnty = str_replace("'", "", $hidden_p_issue_qnty);
			$iss_qnty = ($actualPreviousIssue - $hidden_p_issue_qnty) + ($hidden_p_issue_qnty - ($hidden_p_issue_qnty - $txt_issue_qnty));

			if ( $iss_qnty > str_replace("'", "", $wo_qnty) )
			{
				$balance = str_replace("'", "", $wo_qnty) - $iss_qnty;
				echo "11**Issue Quantity can not be greater than Work Order quantity.\nWork Order Quantity = ".str_replace("'", "", $wo_qnty)."\nCummulative Issue = ".$iss_qnty."\nBalance = ".$balance;
				disconnect($con);die;
			}
		}
	}
	//echo "11**Failed $iss_qnty";die;

	if($operation == 0 || $operation == 1)
	{
		if($operation == 0)
		{
			if ( $txt_issue_qnty > str_replace("'", "", $txt_current_stock) )
			{
				echo "11**Issue Quantity can not be greater than Current Stock quantity.\nCurrent Stock = " . str_replace("'", "", $txt_current_stock);
				disconnect($con);die;
			}
		}
		else if($operation == 1)
		{
			$prevIssueQty = return_field_value("cons_quantity", "inv_transaction" ," item_category=1 and transaction_type=2 and prod_id=$txt_prod_id and id=$update_id and store_id=$cbo_store_name and status_active=1 and is_deleted=0","cons_quantity");

			 $currentStock = number_format(str_replace("'", "", $txt_current_stock)+$prevIssueQty,2,'.','');

			if ( number_format($txt_issue_qnty,2,'.','') > ($currentStock+$prevIssueQty) )
			{
				echo "11**Issue Quantity can not be greater than Current Stock quantity.\nCurrent Stock = " . $currentStock;
				disconnect($con);die;
			}
		}
	}

	if( ($operation == 0 || $operation == 1) && (str_replace("'", "", $txt_system_no)!="") ) // once save
	{
		if (  ( str_replace("'", "", $cbo_knitting_company) != str_replace("'", "", $saved_knitting_company) )  )
		{
			echo "20**Party mixing is not allowed in same issue number";
			disconnect($con);die;
		}
	}

	//######### this stock item store level and calculate rate ########//
	$update_conds="";
	if($update_id > 0) $update_conds=" and id <> $update_id";
	$store_stock_sql="select sum((case when transaction_type in(1,4,5) then cons_quantity else 0 end)-(case when transaction_type in(2,3,6) then cons_quantity else 0 end)) as BALANCE_STOCK, sum((case when transaction_type in(1,4,5) then store_amount else 0 end)-(case when transaction_type in(2,3,6) then store_amount else 0 end)) as BALANCE_AMT
	from inv_transaction
	where status_active=1 and prod_id=$txt_prod_id and store_id=$cbo_store_name $update_conds";
	//echo "20**$store_stock_sql";disconnect($con);die;
	$store_stock_sql_result=sql_select($store_stock_sql);
	$store_item_rate=0;
	if($store_stock_sql_result[0]["BALANCE_AMT"]!=0 && $store_stock_sql_result[0]["BALANCE_STOCK"]!=0)
	{
		$store_item_rate=$store_stock_sql_result[0]["BALANCE_AMT"]/$store_stock_sql_result[0]["BALANCE_STOCK"];
	}
	$store_wise_stock = $store_stock_sql_result[0]["BALANCE_STOCK"];
	$issue_store_value = $store_item_rate*$txt_issue_qnty;

	if ($operation == 0) // Insert Here----------------------------------------------------------
	{
		//---------------Check Duplicate product in Same MRR number ------------------------//
		$requigitionCond = "";
		if (str_replace("'", "", $cbo_basis) == 8) $requigitionCond = " and a.buyer_id=" . $cbo_buyer_name . " and b.demand_no=" . $txt_req_no . " and b.requisition_no = ".$hdn_req_no;

		if (str_replace("'", "", $cbo_basis) == 3) $requigitionCond = " and a.buyer_id=" . $cbo_buyer_name . " and b.requisition_no=" . $txt_req_no . "";

		if ( str_replace("'", "", $cbo_basis) == 3 || str_replace("'", "", $cbo_basis) == 8 )
		{
			$store_floor_rom_rack_self_bin_cond = " and b.store_id=$cbo_store_name";

			if(str_replace("'", "", $cbo_floor)>0)
			{
				$store_floor_rom_rack_self_bin_cond .= " and b.floor_id=$cbo_floor";
			}
			if(str_replace("'", "", $cbo_room)>0)
			{
				$store_floor_rom_rack_self_bin_cond .= " and b.room=$cbo_room";
			}
			if(str_replace("'", "", $txt_rack)>0)
			{
				$store_floor_rom_rack_self_bin_cond .= " and b.rack=$txt_rack";
			}
			if(str_replace("'", "", $txt_shelf)>0)
			{
				$store_floor_rom_rack_self_bin_cond .= " and b.self=$txt_shelf";
			}
			if(str_replace("'", "", $cbo_bin)>0)
			{
				$store_floor_rom_rack_self_bin_cond .= " and b.bin_box=$cbo_bin";
			}			

			$duplicate = is_duplicate_field("b.id", "inv_issue_master a, inv_transaction b", "a.id=b.mst_id and a.issue_number=".$txt_system_no." and b.prod_id=".$txt_prod_id."  and b.transaction_type=2 and a.status_active=1 and b.status_active=1 $store_floor_rom_rack_self_bin_cond".$requigitionCond );

			if ($duplicate == 1 && str_replace("'", "", $txt_system_no) != "")
			{
				echo "20**Duplicate Product is Not Allow in Same Issue Number.";
				disconnect($con);
				die;
			}
		}

		//------------------------------Check Brand END---------------------------------------//
		if (str_replace("'", "", $txt_system_no) != "") //new insert cbo_ready_to_approved
		{
			$check_in_gate_pass = return_field_value("sys_number", "inv_gate_pass_mst", "challan_no=$txt_system_no and status_active=1 and is_deleted=0", "sys_number");
			if ($check_in_gate_pass != "") {
				echo "20**Gate Pass found.\nGate Pass ID = $check_in_gate_pass";
				disconnect($con);die;
			}
		}

		//check for Requistion and Demand
		if ( (str_replace("'", "", $cbo_basis) == 3 || str_replace("'", "", $cbo_basis) == 8) && ( str_replace("'", "", $cbo_issue_purpose) == 1 || str_replace("'", "", $cbo_issue_purpose) == 4 || ( $variable_set_smn_allocation == 1 && str_replace("'", "", $cbo_issue_purpose) == 8) ) )
		{
			$req_con = (str_replace("'", "", $cbo_basis) == 8)?" and b.demand_id=$demand_id and b.requisition_no=$hdn_req_no":" and b.requisition_no=$txt_req_no";

			$sql_issue = "select listagg(a.issue_number_prefix_num,',') within group  (order by a.id) as ISSUE_NUMBERS,sum(cons_quantity) TOTAL_ISSUE from inv_issue_master a ,inv_transaction b where a.id=b.mst_id and a.item_category=1 and b.transaction_type=2 $req_con and b.prod_id=$txt_prod_id  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
			//echo $sql_issue;
			$sql_issue_result = sql_select($sql_issue);
			$issue_numbers = $sql_issue_result[0]['ISSUE_NUMBERS'];
			$total_pre_issue_qty = $sql_issue_result[0]['TOTAL_ISSUE'];


			$sql_issue_return = "select listagg(a.recv_number_prefix_num,'') within group (order by a.id) AS RECV_NUMBERS,sum(b.cons_quantity) TOTAL_ISSUE_RTN from inv_receive_master a, inv_transaction b where a.id=b.mst_id and b.item_category=1 and b.transaction_type=4 and a.booking_id=$hdn_req_no and a.receive_basis in(3,8) and b.prod_id=$txt_prod_id  and b.status_active=1";
			$sql_issue_return_result = sql_select($sql_issue_return);
			$issue_rtn_numbers = $sql_issue_return_result[0]['RECV_NUMBERS'];
			$total_issue_rtn_qty = $sql_issue_return_result[0]['TOTAL_ISSUE_RTN'];


			if(str_replace("'", "", $cbo_basis) == 8)
			{
				$total_req_qty = return_field_value("sum(yarn_demand_qnty) as total_req_qty", "ppl_yarn_demand_reqsn_dtls", "requisition_no=$hdn_req_no and mst_id=$demand_id and prod_id=$txt_prod_id and status_active=1", "total_req_qty");
				$basis_label = "Demand";
			}
			else
			{
				$total_req_qty = return_field_value("sum(yarn_qnty) as total_req_qty", "ppl_yarn_requisition_entry", "requisition_no=$txt_req_no and prod_id=$txt_prod_id and status_active=1 and is_deleted=0", "total_req_qty");

				$demand_sql = "select listagg(a.demand_prefix_number,',') within group ( order by a.id) AS DEMAND_SYSTEM_NO,sum(b.yarn_demand_qnty) as TOTAL_DEMAND_QNTY from ppl_yarn_demand_entry_mst a , ppl_yarn_demand_reqsn_dtls b where a.id=b.mst_id and b.requisition_no=$txt_req_no and b.prod_id=$txt_prod_id and b.status_active=1 and b.is_deleted=0";
				$demand_sql_result =  sql_select($demand_sql);
				$demand_system_numbers = $demand_sql_result[0]['DEMAND_SYSTEM_NO'];
				$total_demand_qnty = $demand_sql_result[0]['TOTAL_DEMAND_QNTY'];

				$basis_label = "Requisition";
			}

			$total_req_qty = number_format($total_req_qty,2,".","");
			$total_pre_issue_qty = number_format($total_pre_issue_qty,2,".","");
			$total_issue_rtn_qty = number_format($total_issue_rtn_qty,2,".","");
			$txt_issue_qnty = number_format($txt_issue_qnty,2,".","");
			$issueQtyZs = (($total_pre_issue_qty - $total_issue_rtn_qty) + $txt_issue_qnty);

			/*
			| if issue qty is greater than requisition qty and
			| difference between issue qty and requisition qty is greater than 1 then
			| system will give the following msg and execution will be stop
			| ommit :  && ($issueQtyZs - $total_req_qty)>1
			*/
			if($issueQtyZs > $total_req_qty) 
			{
				echo "11**Issue Quantity can not be greater than $basis_label Quantity.\n$basis_label quantity = ".$total_req_qty . "\nBefore Issue = ". number_format($total_pre_issue_qty,2) . "\nAvailable quantity = " . ($total_req_qty - $total_pre_issue_qty);
				disconnect($con);die;
			}
		}

        //product master table information
		$sql = sql_select("select supplier_id, avg_rate_per_unit, current_stock, stock_value, allocated_qnty, available_qnty, dyed_type, is_twisted from product_details_master where id=$txt_prod_id and item_category_id=1");

		// transaction wise stock check
		$trans_sql = sql_select("select sum((case when transaction_type in(1,4,5) then cons_quantity else 0 end) -(case when transaction_type in(2,3,6) then cons_quantity else 0 end)) as bal_qnty from inv_transaction where item_category = 1 AND status_active=1 and is_deleted=0 and prod_id=$txt_prod_id");

		//Store level transaction wise stock check
		$trans_store_sql = sql_select("select sum((case when transaction_type in(1,4,5) then cons_quantity else 0 end) -(case when transaction_type in(2,3,6) then cons_quantity else 0 end)) as bal_qnty from inv_transaction where  item_category = 1 AND status_active=1 and is_deleted=0 and prod_id=$txt_prod_id and store_id=$cbo_store_name");

		if($sql[0][csf('current_stock')]<=0 || $trans_sql[0][csf('bal_qnty')]<=0 || $trans_store_sql[0][csf('bal_qnty')]<=0)
		{
			echo "11**Stock quantity is not available";
			disconnect($con);
			die();
		}

		$avg_rate = $stock_qnty = $stock_value = $allocated_qnty = $available_qnty = 0;
		$supplier_id_for_tran = '';
		foreach ($sql as $result)
		{
			$avg_rate = $result[csf("avg_rate_per_unit")];
			$stock_qnty = $result[csf("current_stock")];
			$stock_value = $result[csf("stock_value")];
			$allocated_qnty = $result[csf("allocated_qnty")];
			$available_qnty = $result[csf("available_qnty")];
			$supplier_id_for_tran = $result[csf("supplier_id")];
			$dyed_type = $result[csf("dyed_type")];
			$is_twisted = $result[csf("is_twisted")];
		}

		// If allocation is allowed
		// echo "20**".$variable_set_allocation;die;
		if ($variable_set_allocation == 1)
		{
			if ( (str_replace("'", "", $cbo_basis) == 3 || str_replace("'", "", $cbo_basis) == 8) && ( str_replace("'", "", $cbo_issue_purpose) == 1 || str_replace("'", "", $cbo_issue_purpose) == 4  || ( $variable_set_smn_allocation == 1 && str_replace("'", "", $cbo_issue_purpose) == 8) ) )
			{
				$store_balance = $allocated_qnty;
				$msg_qnt = "\nAllocation Quantity = ".$store_balance;
				$msg_label = "Allocation";
			}
			else if ( str_replace("'", "", $cbo_basis) == 1 && ( str_replace("'", "", $cbo_issue_purpose) == 2 || str_replace("'", "", $cbo_issue_purpose) == 7 || str_replace("'", "", $cbo_issue_purpose) == 12 || str_replace("'", "", $cbo_issue_purpose) == 15 || str_replace("'", "", $cbo_issue_purpose) == 38 || str_replace("'", "", $cbo_issue_purpose) == 44 || str_replace("'", "", $cbo_issue_purpose) == 46 || str_replace("'", "", $cbo_issue_purpose) == 50 || str_replace("'", "", $cbo_issue_purpose) == 51 ) )
			{
				if (str_replace("'", "", $txt_entry_form) == 42 ||  str_replace("'", "", $txt_entry_form) == 114) // Without order
				{
					if($variable_set_smn_allocation==1) // sample booking allocation
					{
						$store_balance = $allocated_qnty;
						$msg_label = "Allocation";
						$msg_qnt = "\nAllocation Quantity = ".$store_balance;
					}
					else
					{
						$store_balance = $available_qnty;
						$msg_label = "Available";
						$msg_qnt = "\nAvailable Quantity = ".$store_balance;
					}
				}
				else if( str_replace("'", "", $txt_entry_form) == 94 || str_replace("'", "", $txt_entry_form) == 340 ) // service wo
				{
					if ( str_replace("'", "", $job_no) != "" ) // With order
					{
						$store_balance = $allocated_qnty;
						$msg_label = "Allocation";
						$msg_qnt = "\nAllocation Quantity = ".$store_balance;
					}
					else // without order
					{
						/*if($variable_set_smn_allocation==1) // sample booking allocation
						{
							$store_balance = $allocated_qnty;
							$msg_label = "Allocation";
							$msg_qnt = "\nAllocation Quantity = ".$store_balance;
						}
						else
						{*/
							$store_balance = $available_qnty;
							$msg_label = "Available";
							$msg_qnt = "\nAvailable Quantity = ".$store_balance;
						//}
					}
				}
				else
				{
					$store_balance = $allocated_qnty;
					$msg_label = "Allocation";
					$msg_qnt = "\nAllocation Quantity = ".$store_balance;
				}
			}
			else
			{
				$store_balance = $available_qnty;
				$msg_label = "Available";
				$msg_qnt = "\nAvailable Quantity = ".$store_balance;
			}
		}
		else
		{
			$store_balance = $available_qnty;
			$msg_label = "Available";
			$msg_qnt = "\nAvailable Quantity = ".$store_balance;
		}

		$store_balance = number_format($store_balance,2,".","");
		$availableChk = ( $store_balance >= $txt_issue_qnty ) ? true : false;

		$msg = "Issue Quantity can not be greater than $msg_label quantity.".$msg_qnt;
		if ($availableChk == false)
		{
			if ($db_type == 0) {
				mysql_query("ROLLBACK");
			} else {
				oci_rollback($con);
			}
			echo "11**" . $msg;
			disconnect($con);
			exit();
		}

        //if LIFO/FIFO then START -----------------------------------------//
		$field_array = "id,recv_trans_id,issue_trans_id,entry_form,prod_id,issue_qnty,rate,amount,inserted_by,insert_date";
		$update_array = "balance_qnty*balance_amount*updated_by*update_date";
		$cons_rate = 0;
		$data_array = "";
		$updateID_array = array();
		$update_data = array();
		$issueQnty = $txt_issue_qnty;
		// check variable settings issue method(LIFO/FIFO)
		$isLIFOfifo = '';
		$check_allocation = '';
		$sql_variable = sql_select("select store_method,allocation,variable_list from variable_settings_inventory where company_name=$cbo_company_id and variable_list in(17,18) and item_category_id=1 and status_active=1 and is_deleted=0");
		foreach ($sql_variable as $row)
		{
			if ($row[csf('variable_list')] == 17)
			{
				$isLIFOfifo = $row[csf('store_method')];
			}
			else if ($row[csf('variable_list')] == 18)
			{
				$check_allocation = $row[csf('allocation')];
			}
		}

        $transactionID = return_next_id_by_sequence("INV_TRANSACTION_PK_SEQ", "inv_transaction", $con);

		if ($isLIFOfifo == 2) $cond_lifofifo = " DESC"; else $cond_lifofifo = " ASC";
		// Trans type: 1=>"Receive",4=>"Issue Return",5=>"Item Transfer Receive"
		$sql_result = sql_select("select id,cons_rate,balance_qnty,balance_amount from inv_transaction where prod_id=$txt_prod_id and store_id=$cbo_store_name and balance_qnty>0 and transaction_type in (1,4,5) and item_category=1 and status_active=1 order by transaction_date,id $cond_lifofifo");

		if(!empty($sql_result))
		{
            foreach ($sql_result as $result)
		    {
			    $recv_trans_id = $result[csf("id")]; // this row will be updated
			    $balance_qnty = $result[csf("balance_qnty")];
			    $balance_amount = $result[csf("balance_amount")];
			    $cons_rate = $result[csf("cons_rate")];
			    $issueQntyBalance = $balance_qnty - $issueQnty; // minus issue qnty
			    $issueStockBalance = $balance_amount - ($issueQnty * $cons_rate);
			    
				if ($issueQntyBalance >= 0)
			    {
					$amount = $issueQnty * $cons_rate;
					//for insert
					$mrrWiseIsID = return_next_id_by_sequence("INV_MRR_WISE_ISSUE_PK_SEQ", "inv_mrr_wise_issue_details", $con);
					if ($data_array != "") $data_array .= ",";
					$data_array .= "(" . $mrrWiseIsID . "," . $recv_trans_id . "," . $transactionID . ",3," . $txt_prod_id . "," . $issueQnty . "," . number_format($cons_rate,10,'.','') . "," . number_format($amount,8,'.','') . ",'" . $user_id . "','" . $pc_date_time . "')";
					//for update
					$updateID_array[] = $recv_trans_id;
					$update_data[$recv_trans_id] = explode("*", ("" . $issueQntyBalance . "*" . $issueStockBalance . "*'" . $user_id . "'*'" . $pc_date_time . "'"));
					break;
			    }
			    else if ($issueQntyBalance < 0)
			    {
					//$issueQntyBalance = $balance_qnty+$issueQntyBalance; // adjust issue qnty
					//$issueQntyBalance = $issueQntyBalance-$balance_qnty;
					$issueQntyBalance = $issueQnty - $balance_qnty;
					$issueQnty = $balance_qnty;
					$amount = $issueQnty * $cons_rate;

					//for insert
					$mrrWiseIsID = return_next_id_by_sequence("INV_MRR_WISE_ISSUE_PK_SEQ", "inv_mrr_wise_issue_details", $con);
					if ($data_array != "") $data_array .= ",";
					$data_array .= "(" . $mrrWiseIsID . "," . $recv_trans_id . "," . $transactionID . ",3," . $txt_prod_id . "," . $balance_qnty . "," . number_format($cons_rate,10,'.','') . "," . number_format($amount,8,'.','') . ",'" . $user_id . "','" . $pc_date_time . "')";
					//for update
					$updateID_array[] = $recv_trans_id;
					$update_data[$recv_trans_id] = explode("*", ("0*0*'" . $user_id . "'*'" . $pc_date_time . "'"));
					$issueQnty = $issueQntyBalance;
			    }

		    }//end foreach
		}
		else
		{
			if ($db_type == 0) {
				mysql_query("ROLLBACK");
			} else {
				oci_rollback($con);
			}
			echo "11**" . "Mrr wise Balance is zero for this lot and store";
			disconnect($con);
			exit();
		}

		$mrrWiseIssueID = true;
		$upTrID = true;
		// LIFO/FIFO then END-----------------------------------------------//


        // ------- order wise proportion start here ------------------------//
		$proportQ = true;
		$data_array_prop = "";
		$save_string = explode(",", str_replace("'", "", $save_data));

		if (count($save_string) > 0 && str_replace("'", "", $save_data) != "")
		{
			$field_array_proportionate = "id,trans_id,trans_type,entry_form,po_breakdown_id,prod_id,quantity,issue_purpose,returnable_qnty,is_sales,inserted_by,insert_date";
			//order_wise_pro_details table data insert START-----//

			$po_array = $po_id_arr = array();
			for ($i = 0; $i < count($save_string); $i++)
			{
				$order_dtls = explode("**", $save_string[$i]);
				$order_id = $order_dtls[0];
				$order_qnty = $order_dtls[1];
				$returnable_qnty = $order_dtls[2];
				$po_id_arr[$order_id] = $order_id;

				if (array_key_exists($order_id, $po_array))
				{
					$po_array[$order_id] += $order_qnty;
					$po_rt_array[$order_id] += $returnable_qnty;
				}
				else
				{
					$po_array[$order_id] = $order_qnty;
					$po_rt_array[$order_id] = $returnable_qnty;
				}
			}
			//echo "10**";
			$is_salesOrder = 0;
			if (str_replace("'", "", $cbo_basis) == 3 || str_replace("'", "", $cbo_basis) == 8)
			{
				if(str_replace("'", "", $cbo_basis) == 3)
				{
					$requisition_cond =" and b.requisition_no=$txt_req_no";
				}
				else{
					$requisition_cond =" and b.requisition_no=$hdn_req_no";
				}

				$planning_info = sql_select("select a.is_sales,a.booking_no from ppl_planning_entry_plan_dtls a, ppl_yarn_requisition_entry b where a.dtls_id=b.knit_id and b.prod_id = $txt_prod_id and a.status_active=1 and b.status_active=1 and a.is_deleted=0 and b.is_deleted=0 $requisition_cond group by a.is_sales,a.booking_no");

				$is_salesOrder = $planning_info[0][csf("is_sales")];
				$requisition_booking = $planning_info[0][csf("booking_no")];
			}

			$order_wise_allocation_validation = 0;
			if ($variable_set_allocation == 1)
			{
				if ( (str_replace("'", "", $cbo_basis) == 3 || str_replace("'", "", $cbo_basis) == 8) && (str_replace("'", "", $cbo_issue_purpose) == 1 || str_replace("'", "", $cbo_issue_purpose) == 4) )
				{
					$order_wise_allocation_validation = ($is_auto_allocation_from_requisition==1)?0:1;

					$requisition_booking_cond = ($requisition_booking!="")?"and a.booking_no='$requisition_booking'":"";
					$allocation_sql = "select b.po_break_down_id,sum(b.qnty) order_wise_allocation from inv_material_allocation_mst a,inv_material_allocation_dtls b where a.id=b.mst_id and a.item_id=$txt_prod_id and b.po_break_down_id in(".implode(",",$po_id_arr).") $requisition_booking_cond and a.status_active=1 and b.status_active=1 group by b.po_break_down_id";
				}
				else if (str_replace("'", "", $cbo_basis) == 1 && (str_replace("'", "", $cbo_issue_purpose) == 2 || str_replace("'", "", $cbo_issue_purpose) == 15 || str_replace("'", "", $cbo_issue_purpose) == 50 || str_replace("'", "", $cbo_issue_purpose) == 51 || str_replace("'", "", $cbo_issue_purpose) == 38 || str_replace("'", "", $cbo_issue_purpose) == 44 || str_replace("'", "", $cbo_issue_purpose) == 46 || str_replace("'", "", $cbo_issue_purpose) == 7 || str_replace("'", "", $cbo_issue_purpose) == 12 ) )
				{
					$wo_id = str_replace("'", "", $txt_booking_id);
					$wo_job_no = str_replace("'", "", $job_no);
					$prod_id_cond = " And product_id=$txt_prod_id";

					$wo_booking_no = return_field_value(" (fab_booking_no || booking_no) fab_booking_no ","wo_yarn_dyeing_dtls","mst_id ='".$wo_id."' and job_no ='".$wo_job_no."' $prod_id_cond and is_deleted=0 and status_active=1 group by fab_booking_no,booking_no","fab_booking_no");
					
					$wo_booking_cond = ($wo_booking_no!="")?"and a.booking_no='$wo_booking_no'":"";

					if ( $variable_set_smn_allocation ==1 && str_replace("'", "", $txt_entry_form) == 42 || str_replace("'", "", $txt_entry_form) == 114 || str_replace("'", "", $txt_entry_form) == 135)
					{
						$order_wise_allocation_validation = ($is_auto_allocation_from_requisition==1)?0:1;

						$allocation_sql = "select b.po_break_down_id,sum(b.qnty) order_wise_allocation from inv_material_allocation_mst a,inv_material_allocation_dtls b where a.id=b.mst_id and a.item_id=$txt_prod_id and b.po_break_down_id in(".implode(",",$po_id_arr).") and a.status_active=1 and b.status_active=1 $wo_booking_cond group by b.po_break_down_id";
					}
					else if ( str_replace("'", "", $txt_entry_form) == 94 || str_replace("'", "", $txt_entry_form) == 340)
					{
						if (str_replace("'", "", $job_no) != "" )
						{
							$order_wise_allocation_validation = ($is_auto_allocation_from_requisition==1)?0:1;

							$allocation_sql = "select b.po_break_down_id,sum(b.qnty) order_wise_allocation from inv_material_allocation_mst a,inv_material_allocation_dtls b where a.id=b.mst_id and a.item_id=$txt_prod_id and b.po_break_down_id in(".implode(",",$po_id_arr).") and a.status_active=1 and b.status_active=1 $wo_booking_cond group by b.po_break_down_id";
						}
					}
					else
					{
						$order_wise_allocation_validation = ($is_auto_allocation_from_requisition==1)?0:1;
						$allocation_sql = "select b.po_break_down_id,sum(b.qnty) order_wise_allocation from inv_material_allocation_mst a,inv_material_allocation_dtls b where a.id=b.mst_id and a.item_id=$txt_prod_id and b.po_break_down_id in(".implode(",",$po_id_arr).") and a.status_active=1 and b.status_active=1 $wo_booking_cond group by b.po_break_down_id";
					}

				}

				$allocation_result = sql_select($allocation_sql);
				$order_wise_allocation_arr = array();
				$total_allocation_qnty=0;
				foreach ($allocation_result as $allocation_row) {
					$order_wise_allocation_arr[$allocation_row[csf("po_break_down_id")]] = $allocation_row[csf("order_wise_allocation")];
				}
			}

			if (str_replace("'", "", $txt_entry_form) == 135)
			{
				$is_salesOrder = 1;
			}

			if(str_replace("'", "", $txt_entry_form) == 94 || str_replace("'", "", $txt_entry_form) == 340)
			{
				$yarn_dyeing_info=sql_select("select entry_form,is_sales from wo_yarn_dyeing_mst where status_active=1 and ydw_no=$txt_booking_no and company_id=$cbo_company_id");
				$is_salesOrder = $yarn_dyeing_info[0][csf('is_sales')];
			}

			$wo_job_cond = ($wo_job_no!="")?" and b.job_no='".$wo_job_no."'":"";
			$wo_fabric_booking_cond = (str_replace("'","",$hdn_fabric_booking_no)!="")?" and b.booking_no=$hdn_fabric_booking_no":"";
			$requisition_cond = ($hdn_req_no!="")?" and b.requisition_no=".$hdn_req_no."":"";

			$order_wise_issue_sql = "select b.mst_id as issue_id,b.issue_id as rtn_issue_id, a.trans_type,a.trans_id,a.po_breakdown_id, a.quantity, a.returnable_qnty,b.requisition_no,b.job_no
			from order_wise_pro_details a, inv_transaction b
			where a.entry_form =3  and a.trans_type = 2 and a.status_active=1 and a.prod_id=$txt_prod_id and a.trans_id=b.id and b.status_active=1 and b.transaction_type=2 $wo_job_cond $requisition_cond $wo_fabric_booking_cond";

			$order_wise_result = sql_select($order_wise_issue_sql);

			foreach ($order_wise_result as $order_row)
			{
				$order_wise_issue_arr[$order_row[csf("po_breakdown_id")]][$order_row[csf("requisition_no")]] += $order_row[csf("quantity")];
			}

			$order_wise_issue_rtn_sql = sql_select("select b.mst_id as issue_id,b.issue_id as rtn_issue_id, a.trans_type,a.trans_id,a.po_breakdown_id, a.quantity, a.returnable_qnty,b.requisition_no,b.job_no
				from order_wise_pro_details a, inv_transaction b
				where a.entry_form = 9 and a.trans_type = 4 and a.status_active=1 and a.prod_id=$txt_prod_id and a.trans_id=b.id and b.status_active=1 and b.transaction_type=4 $wo_job_cond $requisition_cond");

			foreach ($order_wise_issue_rtn_sql as $order_row)
			{
				$order_wise_issue_ret_arr[$order_row[csf("po_breakdown_id")]] += $order_row[csf("quantity")];
			}

			$i = 0;
			//echo "10**";
			foreach ($po_array as $key => $val)
			{
				if ($i > 0) $data_array_prop .= ",";

				$order_id = $key;
				$order_qnty = number_format($val,2,".","");
				$req_no = str_replace("'", "", $hdn_req_no);
				$returnable_qnty = $po_rt_array[$key];

				$order_wise_allocation_qnty = number_format($order_wise_allocation_arr[$order_id] - ($order_wise_issue_arr[$order_id][$req_no]-$order_wise_issue_ret_arr[$order_id]),2,".","");

				if ($variable_set_allocation == 1 && $order_wise_allocation_validation==1 && $dyed_type!=1)
				{
					if($order_qnty > $order_wise_allocation_qnty)
					{
						//echo "10**".$order_qnty .">". $order_wise_allocation_qnty."<br>";
						$msg = "Issue Quantity can not be greater than Allocation quantity of this Order.\nAllocation in this Order = ".$order_wise_allocation_arr[$order_id]."\nTotal Issue = " . $order_wise_issue_arr[$order_id][$req_no] . "\nTotal Issue Return = " . $order_wise_issue_ret_arr[$order_id] . "\nBalance = $order_wise_allocation_qnty";

						if ($db_type == 0)
						{
							mysql_query("ROLLBACK");
						}
						else
						{
							oci_rollback($con);
						}
						echo "11**" . $msg;
						disconnect($con);
						exit();
					}
				}

				$id_proport = return_next_id_by_sequence("ORDER_WISE_PROP_PK_SEQ", "order_wise_pro_details", $con);
				$data_array_prop .= "(" . $id_proport . "," . $transactionID . ",2,3," . $order_id . "," . $txt_prod_id . "," . $order_qnty . "," . $cbo_issue_purpose . ",'" . $returnable_qnty . "','" . $is_salesOrder . "'," . $user_id . ",'" . $pc_date_time . "')";
				$i++;
			}
		}
		//end if

		if (str_replace("'", "", $cbo_basis) == 4)
		{
			$field_array_proportionate = "id,trans_id,trans_type,entry_form,po_breakdown_id,prod_id,quantity,issue_purpose,returnable_qnty,is_sales,inserted_by,insert_date";
			$id_proport = return_next_id_by_sequence("ORDER_WISE_PROP_PK_SEQ", "order_wise_pro_details", $con);
			$data_array_prop = "(" . $id_proport . "," . $transactionID . ",2,3," . $txt_booking_id . "," . $txt_prod_id . "," . $txt_issue_qnty . "," . $cbo_issue_purpose . "," . $txt_returnable_qty . ",1," . $user_id . ",'" . $pc_date_time . "')";
		}
        //order_wise_pro_details table data insert END -----//

		//yarn issue master table entry here START---------------------------------------//
		if (str_replace("'", "", $txt_system_no) == "") //new insert cbo_ready_to_approved
		{
			if ($db_type == 0) $year_cond = "YEAR(insert_date)";
			else if ($db_type == 2) $year_cond = "to_char(insert_date,'YYYY')";
			else $year_cond = "";//defined Later

			$id = return_next_id_by_sequence("INV_ISSUE_MASTER_PK_SEQ", "inv_issue_master", $con);
			$new_mrr_number = explode("*", return_next_id_by_sequence("INV_ISSUE_MASTER_PK_SEQ", "inv_issue_master",$con,1,$cbo_company_id,'YIS',3,date("Y",time()),1 ));

			$field_array_mst = "id,issue_number_prefix, issue_number_prefix_num, issue_number, issue_basis, issue_purpose, entry_form, item_category, company_id, location_id, supplier_id, store_id, buyer_id, buyer_job_no, style_ref, booking_id, booking_no,service_booking_no, issue_date, sample_type, knit_dye_source, knit_dye_company, challan_no, loan_party, remarks, ready_to_approve, attention, inserted_by, insert_date";
			$data_array_mst = "(" . $id . ",'" . $new_mrr_number[1] . "','" . $new_mrr_number[2] . "','" . $new_mrr_number[0] . "'," . $cbo_basis . "," . $cbo_issue_purpose . ",3,1," . $cbo_company_id . "," . $cbo_location_id . "," . $cbo_supplier . "," . $cbo_store_name . "," . $cbo_buyer_name . "," . $txt_buyer_job_no . "," . $txt_style_ref . "," . $txt_booking_id . "," . $txt_booking_no . "," . $txt_service_booking_no . "," . $txt_issue_date . "," . $cbo_sample_type . "," . $cbo_knitting_source . "," . $cbo_knitting_company . "," . $txt_challan_no . "," . $cbo_loan_party . "," . $txt_remarks . "," . $cbo_ready_to_approved . "," . $txt_attention . ",'" . $user_id . "','" . $pc_date_time . "')";
		}
		else //update
		{
			$new_mrr_number[0] = str_replace("'", "", $txt_system_no);
			$id = return_field_value("id", "inv_issue_master", "issue_number=$txt_system_no");
			$field_array_mst = "issue_basis*issue_purpose*entry_form*item_category*company_id*location_id*supplier_id*store_id*buyer_id*buyer_job_no*style_ref*booking_id*booking_no*service_booking_no*issue_date*sample_type*knit_dye_source*knit_dye_company*challan_no*loan_party*remarks*ready_to_approve*attention*updated_by*update_date";
			$data_array_mst = "" . $cbo_basis . "*" . $cbo_issue_purpose . "*3*1*" . $cbo_company_id . "*" . $cbo_location_id . "*" . $cbo_supplier . "*" . $cbo_store_name . "*" . $cbo_buyer_name . "*" . $txt_buyer_job_no . "*" . $txt_style_ref . "*" . $txt_booking_id . "*" . $txt_booking_no . "*" . $txt_service_booking_no . "*" . $txt_issue_date . "*" . $cbo_sample_type . "*" . $cbo_knitting_source . "*" . $cbo_knitting_company . "*" . $txt_challan_no . "*" . $cbo_loan_party . "*" . $txt_remarks . "*" . $cbo_ready_to_approved . "*" . $txt_attention . "*'" . $user_id . "'*'" . $pc_date_time . "'";
			$id = str_replace("'", "", $update_id_mst);
		}
		//yarn issue master table entry here END---------------------------------------//

		//for transaction log
		$log_ref_id = $id;
		$log_ref_number = $new_mrr_number[0];
		$log_entry_form = 3;
		$log_prod_id = $txt_prod_id;

		/******** original product id check start ********/
		$origin_prod_id = return_field_value("origin_prod_id", "inv_transaction", "prod_id=$txt_prod_id and status_active=1 and store_id=$cbo_store_name and balance_qnty>0 and transaction_type in (1,4,5) and item_category=1", "origin_prod_id");
		/******** original product id check end ********/

		//inventory TRANSACTION table data entry START----------------------------------------------------------//
		//$transaction_type=array(1=>"Receive",2=>"Issue",3=>"Receive Return",4=>"Issue Return");
		$txt_issue_qnty = str_replace("'", "", $txt_issue_qnty);
		$issue_stock_value = $avg_rate * $txt_issue_qnty;

		$basis = str_replace("'", "", $cbo_basis);
		$demand_system_no = ($basis==8)?str_replace("'", "", $txt_req_no):'';
		if(str_replace("'", "", $hdn_req_no)!="")
			$txt_req_no = str_replace("'", "", $hdn_req_no);

		$txt_req_no=str_replace("'", "", $txt_req_no);
		$fabric_booking_no = $requisition_booking = $wo_booking_no;
		$field_array_trans = "id,mst_id,requisition_no,receive_basis,company_id,supplier_id,prod_id,origin_prod_id,dyeing_color_id,item_category,transaction_type,transaction_date,store_id,brand_id,cons_uom,cons_quantity,return_qnty,item_return_qty,cons_rate,cons_amount,no_of_bags,cone_per_bag,weight_per_bag,weight_per_cone,floor_id,room,rack,self,bin_box,using_item,job_no,inserted_by,insert_date,btb_lc_id,demand_id,demand_no,remarks,wo_id,pi_wo_batch_no,booking_no,store_rate,store_amount";
		$data_array_trans = "(" . $transactionID . "," . $id . ",'" . $txt_req_no . "'," . $cbo_basis . "," . $cbo_company_id . ",'" . $supplier_id_for_tran . "'," . $txt_prod_id . ",'" . $origin_prod_id . "'," . $cbo_dyeing_color . ",1,2," . $txt_issue_date . "," . $cbo_store_name . "," . $cbo_brand . "," . $cbo_uom . "," . $txt_issue_qnty . "," . $txt_returnable_qty . "," . $extra_quantity . "," . number_format($avg_rate,10,'.','') . "," . number_format($issue_stock_value,8,'.','') . "," . $txt_no_bag . "," . $txt_no_cone . "," . $txt_weight_per_bag . "," . $txt_weight_per_cone . "," . $cbo_floor . "," . $cbo_room . "," . $txt_rack . "," . $txt_shelf . "," . $cbo_bin . "," . $cbo_item . "," . $job_no . ",'" . $user_id . "','" . $pc_date_time . "'," . $txt_btb_lc_id . "," . $demand_id . ",'" . $demand_system_no . "'," . $txt_remarks_dtls . "," . $txt_wo_id . "," . $txt_pi_id . ",'" . $fabric_booking_no . "',".number_format($store_item_rate,10,'.','').",".number_format($issue_store_value,8,'.','').")";
		//
		//remarks

		//inventory TRANSACTION table data entry  END----------------------------------------------------------//

		//weighted and average rate START here------------------------//
		//product master table data UPDATE START----------------------//
		$currentStock = $stock_qnty - $txt_issue_qnty;
		$StockValue = $stock_value - ($txt_issue_qnty * $avg_rate);
		//$avgRate	 	= number_format($StockValue/$currentStock,10,'.','');
		$avgRate = number_format($avg_rate, '.', '');
		//newly added code here =============================================

		//item allocation----------------------------------------------------
		$allocated_qnty_balance = 0;
		$available_qnty_balance = 0;
		// if yarn allocation variable set to yes
		if ($variable_set_allocation == 1)
		{
			if ( ( str_replace("'", "", $cbo_basis) == 3 || str_replace("'", "", $cbo_basis) == 8 ) && (str_replace("'", "", $cbo_issue_purpose) == 1 || str_replace("'", "", $cbo_issue_purpose) == 4 || ( $variable_set_smn_allocation == 1 && str_replace("'", "", $cbo_issue_purpose) == 8) ) )
			{
				$allocated_qnty_balance = $allocated_qnty - $txt_issue_qnty;
				$available_qnty_balance = $available_qnty;
			}
			else if ( str_replace("'", "", $cbo_basis) == 1 && ( str_replace("'", "", $cbo_issue_purpose) == 2 || str_replace("'", "", $cbo_issue_purpose) == 7 || str_replace("'", "", $cbo_issue_purpose) == 12 || str_replace("'", "", $cbo_issue_purpose) == 15 || str_replace("'", "", $cbo_issue_purpose) == 38 || str_replace("'", "", $cbo_issue_purpose) == 44 || str_replace("'", "", $cbo_issue_purpose) == 46  || str_replace("'", "", $cbo_issue_purpose) == 50 || str_replace("'", "", $cbo_issue_purpose) == 51 ) )
			{

				if (str_replace("'", "", $txt_entry_form) == 42 || str_replace("'", "", $txt_entry_form) == 114) // Without order
				{
					if($variable_set_smn_allocation==1) // sample booking allocation
					{
						$allocated_qnty_balance = $allocated_qnty - $txt_issue_qnty;
						$available_qnty_balance = $available_qnty;
					}
					else
					{
						$allocated_qnty_balance = $allocated_qnty;
						$available_qnty_balance = $available_qnty - $txt_issue_qnty;
					}
				}
				else if(str_replace("'", "", $txt_entry_form) == 94 || str_replace("'", "", $txt_entry_form) == 340) // service wo
				{
					if (str_replace("'", "", $job_no) != "" ) // with order
					{
						$allocated_qnty_balance = $allocated_qnty - $txt_issue_qnty;
						$available_qnty_balance = $available_qnty;
					}
					else // without order
					{
						/*
						if($variable_set_smn_allocation==1) // sample booking allocation
						{
							$allocated_qnty_balance = $allocated_qnty - $txt_issue_qnty;
							$available_qnty_balance = $available_qnty;
						}
						else
						{*/
							$allocated_qnty_balance = $allocated_qnty;
							$available_qnty_balance = $available_qnty - $txt_issue_qnty;
						//}
					}
				}
				else // 41,125,135
				{
					$allocated_qnty_balance = $allocated_qnty - $txt_issue_qnty;
					$available_qnty_balance = $available_qnty;
				}
			}
			else
			{
				$allocated_qnty_balance = $allocated_qnty;
				$available_qnty_balance = $available_qnty - $txt_issue_qnty;
			}
		}
		else
		{
			$allocated_qnty_balance = $allocated_qnty;
			$available_qnty_balance = $available_qnty - $txt_issue_qnty;
		}

		if ($allocated_qnty_balance == "") $allocated_qnty_balance = 0;
		if ($available_qnty_balance == "") $available_qnty_balance = 0;

		$field_array_prod = "last_issued_qnty*current_stock*stock_value*allocated_qnty*available_qnty*updated_by*update_date";
		$data_array_prod = "" . $txt_issue_qnty . "*" . $currentStock . "*" . number_format($StockValue, 8, '.', '') . "*" . $allocated_qnty_balance . "*" . $available_qnty_balance . "*'" . $user_id . "'*'" . $pc_date_time . "'";

		//for transaction log
		$log_current_stock = $currentStock;
		$log_allocated_qty = $allocated_qnty_balance;
		$log_available_qty = $available_qnty_balance;

		//------------------ product_details_master END--------------//
		$store_up_id=0;
		if($variable_store_wise_rate == 1)
		{
			$sql_store = sql_select("select id, rate as avg_rate_per_unit, cons_qty as current_stock, amount as stock_value from inv_store_wise_yarn_qty_dtls where status_active=1 and prod_id=$txt_prod_id and category_id=1 and store_id=$cbo_store_name and company_id=$cbo_company_id");

			if(count($sql_store)<1)
			{
				echo "20**No Data Found.";disconnect($con);die;
			}
			elseif(count($sql_store)>1)
			{
				echo "20**Duplicate Product is Not Allow in Same REF Number.";disconnect($con);die;
			}
			else
			{
				$store_presentStock=$store_presentStockValue=$store_presentAvgRate=0;
				foreach($sql_store as $result)
				{
					$store_up_id=$result[csf("id")];
					$store_presentStock	=$result[csf("current_stock")];
					$store_presentStockValue =$result[csf("stock_value")];
					$store_presentAvgRate	=$result[csf("avg_rate_per_unit")];
				}

				$field_array_store="last_issued_qnty*cons_qty*amount*updated_by*update_date";
				$currentStock_store		=$store_presentStock-$txt_issue_qnty;
				$currentValue_store		=$store_presentStockValue-$issue_store_value;
				$data_array_store= "".$txt_issue_qnty."*".$currentStock_store."*".number_format($currentValue_store,8,'.','')."*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'";
			}
		}

		//weighted and average rate END here-------------------------//


		if (str_replace("'", "", $txt_system_no) == "")
		{
			$rID = sql_insert("inv_issue_master", $field_array_mst, $data_array_mst, 0);
		}
		else
		{
			$rID = sql_update("inv_issue_master", $field_array_mst, $data_array_mst, "id", $id, 0);
		}

		//echo "10**INSERT INTO inv_transaction (".$field_array_trans.") VALUES ".$data_array_trans.""; die;
		//echo "10**INSERT INTO inv_mrr_wise_issue_details (".$field_array.") VALUES ".$data_array.""; die;
		$transID = sql_insert("inv_transaction", $field_array_trans, $data_array_trans, 0);
		$mrrWiseIssueID = sql_insert("inv_mrr_wise_issue_details", $field_array, $data_array, 0);
		$upTrID = execute_query(bulk_update_sql_statement("inv_transaction", "id", $update_array, $update_data, $updateID_array),0);
		$prodUpdate = sql_update("product_details_master", $field_array_prod, $data_array_prod, "id", $txt_prod_id, 0);

		$proportQ=$storeRID=true;
		if ($data_array_prop != "")
		{
			//echo "10**INSERT INTO order_wise_pro_details (".$field_array_proportionate.") VALUES ".$data_array_prop.""; die;
			$proportQ = sql_insert("order_wise_pro_details", $field_array_proportionate, $data_array_prop, 0);
		}

		if($store_up_id>0 && $variable_store_wise_rate == 1)
		{
			$storeRID=sql_update("inv_store_wise_yarn_qty_dtls",$field_array_store,$data_array_store,"id",$store_up_id,1);
		}

		//echo "10**".$rID. "&&". $transID. "&&".$prodUpdate. "&&". $proportQ . "&&". $mrrWiseIssueID . "&&". $upTrID . "&&". $storeRID;oci_rollback($con);disconnect($con); die;

		if ($db_type == 0)
		{
			if ($rID && $transID && $prodUpdate && $proportQ && $mrrWiseIssueID && $upTrID && $storeRID)
			{
				mysql_query("COMMIT");
				echo "0**" . $new_mrr_number[0] . "**" . $id. "**" . str_replace("'", "", $cbo_knitting_company);
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**" . $new_mrr_number[0] . "**" . $id. "**" . str_replace("'", "", $cbo_knitting_company);
			}
		}
		else if ($db_type == 2 || $db_type == 1)
		{
			if ($rID && $transID && $prodUpdate && $proportQ && $mrrWiseIssueID && $upTrID && $storeRID)
			{
				//for transaction log
				$log_data['entry_form'] = $log_entry_form;
				$log_data['ref_id'] = $log_ref_id;
				$log_data['ref_number'] = $log_ref_number;
				$log_data['product_id'] = $log_prod_id;
				$log_data['current_stock'] = $log_current_stock;
				$log_data['allocated_qty'] = $log_allocated_qty;
				$log_data['available_qty'] = $log_available_qty;
				$log_data['dyed_type'] = $dyed_type;
				$log_data['insert_date'] = $pc_date_time;
				$allocation_log = manage_allocation_transaction_log($log_data);

				if($allocation_log)
				{
					oci_commit($con);
					echo "0**" . $new_mrr_number[0] . "**" . $id. "**" . str_replace("'", "", $cbo_knitting_company);
				}
				else
				{
					oci_rollback($con);
					echo "10**" . $new_mrr_number[0] . "**" . $id. "**" . str_replace("'", "", $cbo_knitting_company);
				}

			}
			else
			{
				oci_rollback($con);
				echo "10**0";
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation == 1) // Update Here----------------------------------------------------------
	{
		$systemNo=str_replace("'", "", $txt_system_no);
		$check_in_gate_pass = return_field_value("sys_number", "inv_gate_pass_mst", "challan_no like ('%$systemNo%') and status_active=1 and is_deleted=0", "sys_number");
		$check_in_gate_pass = preg_replace('/\s+/', '', $check_in_gate_pass);
		if ($check_in_gate_pass != "")
		{
			echo "20**Gate Pass found.\nGate Pass ID = $check_in_gate_pass";
			disconnect($con);die;
		}

		$isLIFOfifo = '';
		$check_allocation = '';
		$sql_variable = sql_select("select store_method,allocation,variable_list from variable_settings_inventory where company_name=$cbo_company_id and variable_list in(17,18) and item_category_id=1 and status_active=1 and is_deleted=0");
		foreach ($sql_variable as $row)
		{
			if ($row[csf('variable_list')] == 17) {
				$isLIFOfifo = $row[csf('store_method')];
			} else if ($row[csf('variable_list')] == 18) {
				$check_allocation = $row[csf('allocation')];
			}
		}

		//****************************************** BEFORE ENTRY ADJUST START *****************************************//
		//product master table information
		//before stock update
		$req_con = (str_replace("'", "", $cbo_basis) == 8)?" and demand_id=$demand_id and requisition_no=$hdn_req_no":" and requisition_no=$txt_req_no";

		$total_pre_issue_qty = return_field_value("sum(cons_quantity) total_issue", "inv_transaction", "item_category=1 and transaction_type=2 $req_con and prod_id=$txt_prod_id and id !=$update_id and status_active=1", "total_issue");

		if(str_replace("'", "", $cbo_basis) == 8)
		{
			$bookind_con = "and booking_id=$demand_id";
		}
		else if(str_replace("'", "", $cbo_basis) == 3)
		{
			$bookind_con = "and booking_id=$txt_req_no";
		}
		else
		{
			$bookind_con = "and booking_id=$txt_booking_id";
		}

		$total_issue_rtn_qty = return_field_value("sum(b.cons_quantity) total_issue_rtn", "inv_receive_master a, inv_transaction b", "a.id=b.mst_id and b.item_category=1 and b.transaction_type=4 $bookind_con and a.receive_basis in(1,3,8) and b.prod_id=$txt_prod_id  and b.status_active=1", "total_issue_rtn");

		$sql = sql_select("select a.id,a.avg_rate_per_unit,a.current_stock,a.stock_value, b.cons_quantity, b.cons_amount, b.store_amount, a.allocated_qnty, a.available_qnty
		from product_details_master a, inv_transaction b
		where a.id=b.prod_id and b.id=$update_id and a.item_category_id=1 and b.item_category=1 and b.transaction_type=2 and b.status_active=1");

		$before_prod_id = $before_issue_qnty = $before_stock_qnty = $before_stock_value = 0;
		foreach ($sql as $result)
		{
			$before_prod_id = $result[csf("id")];
			$before_stock_qnty = $result[csf("current_stock")];
			$before_stock_value = $result[csf("stock_value")];
			//before quantity and stock value
			$before_issue_qnty = $result[csf("cons_quantity")];
			$before_issue_value = $result[csf("cons_amount")];
			$before_store_amount = $result[csf("store_amount")];
			$before_allocated_qnty = $result[csf("allocated_qnty")];
			$before_available_qnty = $result[csf("available_qnty")];
		}
		//current product ID
		$txt_prod_id = str_replace("'", "", $txt_prod_id);
		$txt_issue_qnty = str_replace("'", "", $txt_issue_qnty);
		$txt_current_stock = str_replace("'", "", $txt_current_stock);

		if ( (str_replace("'", "", $cbo_basis) == 3 || str_replace("'", "", $cbo_basis) == 8) && (str_replace("'", "", $cbo_issue_purpose) == 1 || str_replace("'", "", $cbo_issue_purpose) == 4 || ( $variable_set_smn_allocation == 1 && str_replace("'", "", $cbo_issue_purpose) == 8) ) ) {
			if(str_replace("'", "", $cbo_basis) == 8){
				$total_req_qty = return_field_value("sum(yarn_demand_qnty) as total_req_qty", "PPL_YARN_DEMAND_REQSN_DTLS", "requisition_no=$hdn_req_no and mst_id=$demand_id and prod_id=$txt_prod_id and status_active=1", "total_req_qty");
				$basis_label = "Demand";
			}else{
				$total_req_qty = return_field_value("sum(yarn_qnty) as total_req_qty", "ppl_yarn_requisition_entry", "requisition_no=$txt_req_no and prod_id=$txt_prod_id and status_active=1", "total_req_qty");
				$basis_label = "Requisition";
			}

			$issueQty = ($total_pre_issue_qty-$total_issue_rtn_qty) + ($before_issue_qnty + ($txt_issue_qnty - $before_issue_qnty));
			$issueQty = number_format($issueQty,2,".","");
			$total_req_qty = number_format($total_req_qty,2,".","");

			if( $issueQty > $total_req_qty  )
			{
				echo "11**Issue Quantity can not be greater than $basis_label Quantity.\n$basis_label quantity = ".$total_req_qty . "\nBefore Issue = ". number_format($total_pre_issue_qty,2) . "\nAvailable quantity = " . ($total_req_qty - $total_pre_issue_qty);
				die;
			}
		}

		$issueReturnQty = return_field_value("sum(b.cons_quantity) as issue_return_qty",  "inv_receive_master a, inv_transaction b","a.id=b.mst_id and a.item_category=1 and b.item_category=1 and b.transaction_type=4 and b.prod_id=$txt_prod_id and b.issue_id=$update_id_mst and b.company_id=$cbo_company_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0","issue_return_qty");

		if($issueReturnQty>0)
		{
			if($txt_issue_qnty<$issueReturnQty)
			{
				echo "11**Issue Quantity can not be less Issue Return quantity.\nIssue Return quantity = $issueReturnQty";
				disconnect($con);die();
			}
		}

		// == After work order basis rcv issue quantity can not less than received quantity
		if(str_replace("'", "", $cbo_basis)==1) // work order basis
		{
			$receive_sql = "select a.recv_number_prefix_num,b.cons_quantity as receive_qty from inv_receive_master a, inv_transaction b where a.id=b.mst_id and a.receive_basis=2 and a.receive_purpose in(2,12,15,38,44,46,50,51) and b.item_category=1 and b.transaction_type=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_id=$txt_booking_id order by a.recv_number_prefix_num";

			$rcvData = sql_select($receive_sql);
			$rcvMrrData = array();
			$totalRcvQty = 0;
			foreach ($rcvData as  $row) {
				$rcvMrrData[$row[csf('recv_number_prefix_num')]] = $row[csf('receive_qty')];
				$totalRcvQty += $row[csf('receive_qty')];

			}

			if( (str_replace("'", "", $txt_issue_qnty))<$totalRcvQty )
			{
				$rcvNum = implode(",",array_keys($rcvMrrData));
				echo "20**Receive Found\nReceive No=$rcvNum\nReceive quantity=$totalRcvQty";
				disconnect($con);
				die();
			}
		}

		$sql = sql_select("select supplier_id, avg_rate_per_unit, current_stock, stock_value, allocated_qnty, available_qnty, dyed_type, is_twisted from product_details_master where id=$txt_prod_id and item_category_id=1");

		$curr_avg_rate = $curr_stock_qnty = $curr_stock_value = $allocated_qnty = $available_qnty = 0;
		$supplier_id_for_tran = '';
		foreach ($sql as $result) {
			$curr_avg_rate = $result[csf("avg_rate_per_unit")];
			$curr_stock_qnty = $result[csf("current_stock")];
			$curr_stock_value = $result[csf("stock_value")];
			$allocated_qnty = $result[csf("allocated_qnty")];
			$available_qnty = $result[csf("available_qnty")];
			$supplier_id_for_tran = $result[csf("supplier_id")];
			$dyed_type = $result[csf("dyed_type")];
			$is_twisted = $result[csf("is_twisted")];
		}

		//weighted and average rate START here------------------------//
		//product master table data UPDATE START----------------------//
		$update_array_prod = "last_issued_qnty*current_stock*stock_value*allocated_qnty*available_qnty*updated_by*update_date";
		$field_array_store="last_issued_qnty*cons_qty*amount*updated_by*update_date";
		if ($before_prod_id == $txt_prod_id) // sample product
		{
			// CurrentStock + Before Issue Qnty - Current Issue Qnty
			$adj_stock_qnty = $curr_stock_qnty + $before_issue_qnty - $txt_issue_qnty;
			//item allocation----------------------------------------------------
			if ($variable_set_allocation == 1)
			{

				if ( (str_replace("'", "", $cbo_basis) == 3 || str_replace("'", "", $cbo_basis) == 8) && (str_replace("'", "", $cbo_issue_purpose) == 1 || str_replace("'", "", $cbo_issue_purpose) == 4 || ( $variable_set_smn_allocation == 1 && str_replace("'", "", $cbo_issue_purpose) == 8)) ) {
					$availableChk = $allocated_qnty + $before_issue_qnty >= $txt_issue_qnty ? true : false;
					$msg_label = "Allocation";
					$msg_qnt = $allocated_qnty + $before_issue_qnty - $txt_issue_qnty;
				}
				else if ( str_replace("'", "", $cbo_basis) == 1 && ( str_replace("'", "", $cbo_issue_purpose) == 2 || str_replace("'", "", $cbo_issue_purpose) == 15 || str_replace("'", "", $cbo_issue_purpose) == 50 || str_replace("'", "", $cbo_issue_purpose) == 51 || str_replace("'", "", $cbo_issue_purpose) == 38 || str_replace("'", "", $cbo_issue_purpose) == 44 || str_replace("'", "", $cbo_issue_purpose) == 46 || str_replace("'", "", $cbo_issue_purpose) == 7 || str_replace("'", "", $cbo_issue_purpose) == 12 ) )
				{
					if (str_replace("'", "", $txt_entry_form) == 42  || str_replace("'", "", $txt_entry_form) == 114 )  // Without order
					{
						if($variable_set_smn_allocation==1)
						{
							$availableChk = $allocated_qnty + $before_issue_qnty >= $txt_issue_qnty ? true : false;
							$msg_label = "Allocation";
							$msg_qnt = $allocated_qnty + $before_issue_qnty - $txt_issue_qnty;
						}
						else
						{
							$availableChk = $available_qnty + $before_issue_qnty >= $txt_issue_qnty ? true : false;
							$msg_label = "Available";
							$msg_qnt = $available_qnty + $before_issue_qnty - $txt_issue_qnty;
						}
					}
					else if ( str_replace("'", "", $txt_entry_form) == 94 || str_replace("'", "", $txt_entry_form) == 340)//Service work
					{
						if (str_replace("'", "", $job_no) != "" ) // with order
						{
							$availableChk = $allocated_qnty + $before_issue_qnty >= $txt_issue_qnty ? true : false;
							$msg_label = "Allocation";
							$msg_qnt = $allocated_qnty + $before_issue_qnty - $txt_issue_qnty;
						}
						else // without order
						{
							/*
							if($variable_set_smn_allocation==1) // sample booking allocation
							{
								$availableChk = $allocated_qnty + $before_issue_qnty >= $txt_issue_qnty ? true : false;
								$msg_label = "Allocation";
								$msg_qnt = $allocated_qnty + $before_issue_qnty - $txt_issue_qnty;
							}
							else
							{*/
								$availableChk = $available_qnty + $before_issue_qnty >= $txt_issue_qnty ? true : false;
								$msg_label = "Available";
								$msg_qnt = $available_qnty + $before_issue_qnty - $txt_issue_qnty;
							//}
						}
					}
					else // 41,125,135
					{
						$availableChk = $allocated_qnty + $before_issue_qnty >= $txt_issue_qnty ? true : false;
						$msg_label = "Allocation";
						$msg_qnt = $allocated_qnty + $before_issue_qnty - $txt_issue_qnty;
					}
				}
				else
				{
					$availableChk = $available_qnty + $before_issue_qnty >= $txt_issue_qnty ? true : false;
					$msg_label = "Available";
					$msg_qnt = $available_qnty + $before_issue_qnty - $txt_issue_qnty;
				}
			}
			else
			{
				$availableChk = $available_qnty + $before_issue_qnty >= $txt_issue_qnty ? true : false;
				$msg_label = "Available";
				$msg_qnt = $available_qnty + $before_issue_qnty - $txt_issue_qnty;
			}

			$storeWiseIssue = ($before_issue_qnty+($txt_issue_qnty-$before_issue_qnty));

			$currentStock = ( $txt_current_stock+$before_issue_qnty );

			$storeAvailableChk = ($storeWiseIssue > $currentStock) ?  false : true;

			$msg = "Issue Quantity can not be greater than $msg_label quantity.\n$msg_label quantity = ".(($msg_qnt < 0)?0:$msg_qnt);
			$msg2 = "Issue Quantity can not be greater than Stock Quantity of this Store.\nStock in this Store $storeWiseIssue >= $currentStock";

			if ($availableChk == false) {
				if ($db_type == 0) {
					mysql_query("ROLLBACK");
				} else {
					oci_rollback($con);
				}
				echo "11**" . $msg;
				disconnect($con);
				exit();
			}
			if ($storeAvailableChk == false) {
				if ($db_type == 0) {
					mysql_query("ROLLBACK");
				} else {
					oci_rollback($con);
				}
				echo "11**" . $msg2;
				disconnect($con);
				exit();
			}

			$allocated_qnty_balance = 0;
			$available_qnty_balance = 0;
			// if yarn allocation variable set to yes
			if ($variable_set_allocation == 1)
			{
				if ( (str_replace("'", "", $cbo_basis) == 3 || str_replace("'", "", $cbo_basis) == 8) && (str_replace("'", "", $cbo_issue_purpose) == 1 || str_replace("'", "", $cbo_issue_purpose) == 4 || ( $variable_set_smn_allocation == 1 && str_replace("'", "", $cbo_issue_purpose) == 8)) ) {
					$allocated_qnty_balance = $allocated_qnty + $before_issue_qnty - $txt_issue_qnty;
					$available_qnty_balance = $available_qnty;
				}
				else if ((str_replace("'", "", $cbo_basis) == 1) && (str_replace("'", "", $cbo_issue_purpose) == 2 || str_replace("'", "", $cbo_issue_purpose) == 15 || str_replace("'", "", $cbo_issue_purpose) == 50 || str_replace("'", "", $cbo_issue_purpose) == 51 || str_replace("'", "", $cbo_issue_purpose) == 38 || str_replace("'", "", $cbo_issue_purpose) == 44 || str_replace("'", "", $cbo_issue_purpose) == 46 || str_replace("'", "", $cbo_issue_purpose) == 7 || str_replace("'", "", $cbo_issue_purpose) == 12 ))
				{
					if (str_replace("'", "", $txt_entry_form) == 42 || str_replace("'", "", $txt_entry_form) == 114) // without order
					{
						if($variable_set_smn_allocation==1) // sample booking allocation
						{
							$allocated_qnty_balance = $allocated_qnty + $before_issue_qnty - $txt_issue_qnty;
							$available_qnty_balance = $available_qnty;
						}
						else
						{
							$allocated_qnty_balance = $allocated_qnty;
							$available_qnty_balance = $available_qnty + $before_issue_qnty - $txt_issue_qnty;
						}
					}
					else if ( str_replace("'", "", $txt_entry_form) == 94 || str_replace("'", "", $txt_entry_form) == 340) // service wo
					{
						if (str_replace("'", "", $job_no) != "" ) // with order
						{
							$allocated_qnty_balance = $allocated_qnty + $before_issue_qnty - $txt_issue_qnty;
							$available_qnty_balance = $available_qnty;
						}
						else
						{
							/*
							if($variable_set_smn_allocation==1) // sample booking allocation
							{
								$allocated_qnty_balance = $allocated_qnty + $before_issue_qnty - $txt_issue_qnty;
								$available_qnty_balance = $available_qnty;
							}
							else
							{*/
								$allocated_qnty_balance = $allocated_qnty;
								$available_qnty_balance = $available_qnty + $before_issue_qnty - $txt_issue_qnty;
							//}
						}
					}
					else // 41,125,135
					{
						$allocated_qnty_balance = $allocated_qnty + $before_issue_qnty - $txt_issue_qnty;
						$available_qnty_balance = $available_qnty;
					}
				}
				else
				{
					$allocated_qnty_balance = $allocated_qnty;
					$available_qnty_balance = $available_qnty + $before_issue_qnty - $txt_issue_qnty;
				}
			}
			else
			{
				$allocated_qnty_balance = $allocated_qnty;
				$available_qnty_balance = $available_qnty + $before_issue_qnty - $txt_issue_qnty;
			}
			// CurrentStockValue + Before Issue Value - Current Issue Value
			$adj_stock_val = $curr_stock_value + $before_issue_value - ($txt_issue_qnty * $curr_avg_rate);
			//$adj_avgrate	= number_format($adj_stock_val/$adj_stock_qnty,10,'.','');
			$adj_avgrate = number_format($curr_avg_rate, 10, '.', '');

			$data_array_prod = "" . $txt_issue_qnty . "*" . $adj_stock_qnty . "*" . number_format($adj_stock_val, 8, '.', '') . "*" . $allocated_qnty_balance . "*" . $available_qnty_balance . "*'" . $user_id . "'*'" . $pc_date_time . "'";

			//now current stock
			$curr_avg_rate = $adj_avgrate;
			$curr_stock_qnty = $adj_stock_qnty;
			$curr_stock_value = $adj_stock_val;

			//for transaction log
			$log_entry_form = 3;
			$log_ref_id = str_replace("'", "", $update_id_mst);
			$log_ref_number = str_replace("'", "", $txt_system_no);
			$log_prod_id = str_replace("'", "", $txt_prod_id);
			$log_current_stock = $adj_stock_qnty;
			$log_allocated_qty = $allocated_qnty_balance;
			$log_available_qty = $available_qnty_balance;

			$store_up_id=0;
			if($variable_store_wise_rate == 1)
			{
				$sql_store = sql_select("select id, rate as avg_rate_per_unit, cons_qty as current_stock, amount as stock_value from inv_store_wise_yarn_qty_dtls where status_active=1 and prod_id=$txt_prod_id and category_id=1 and store_id=$cbo_store_name and company_id=$cbo_company_id");

				if(count($sql_store)<1)
				{
					echo "20**No Data Found.";disconnect($con);die;
				}
				elseif(count($sql_store)>1)
				{
					echo "20**Duplicate Product is Not Allow in Same REF Number.";disconnect($con);die;
				}
				else
				{
					$store_presentStock=$store_presentStockValue=$store_presentAvgRate=0;
					foreach($sql_store as $result)
					{
						$store_up_id=$result[csf("id")];
						$store_presentStock	=$result[csf("current_stock")];
						$store_presentStockValue =$result[csf("stock_value")];
						$store_presentAvgRate	=$result[csf("avg_rate_per_unit")];
					}

					if($store_up_id)
					{
						$adj_beforeStock_store			=$store_presentStock+$before_issue_qnty;
						$adj_beforeStockValue_store		=$store_presentStockValue+$before_store_amount;

						$currentStock_store		=$adj_beforeStock_store-$txt_issue_qnty;
						$currentValue_store		=$adj_beforeStockValue_store-$issue_store_value;
						$updateID_Storeprod[] = $store_up_id;
						$data_array_store[$store_up_id]= explode("*", ("".$txt_issue_qnty."*".$currentStock_store."*".number_format($currentValue_store,8,'.','')."*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'"));
					}

				}
			}
		}
		else
		{
			$issuertn_result = sql_select("select LISTAGG(b.recv_number_prefix_num, ',') WITHIN GROUP (ORDER BY b.id) as return_mrr,LISTAGG(a.id, ',') WITHIN GROUP (ORDER BY a.id) as trans_id from inv_transaction a,inv_receive_master b where a.mst_id=b.id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.prod_id=$before_prod_id and a.transaction_type in (4) and a.item_category=1 and a.issue_id=$update_id_mst");

			if($issuertn_result[0][csf('return_mrr')]!="")
			{
				echo "20**Issue Return Found\nReturn MRR No=".$issuertn_result[0][csf('return_mrr')]."\nCan not change Lot number";
				disconnect($con);
				die();
			}

			$updateID_array_prod = $update_data_prod = array();
			//before product adjust
			$adj_before_stock_qnty = $before_stock_qnty + $before_issue_qnty; // CurrentStock + Before Issue Qnty
			//$before_allocated_qnty	= $before_allocated_qnty+$before_issue_qnty;
			//$before_available_qnty	= $adj_before_stock_qnty-$before_allocated_qnty;
			$allocated_qnty_balance = 0;
			$available_qnty_balance = 0;

			if ($variable_set_allocation == 1)
			{
				if ( (str_replace("'", "", $cbo_basis) == 3 || str_replace("'", "", $cbo_basis) == 8) && (str_replace("'", "", $cbo_issue_purpose) == 1 || str_replace("'", "", $cbo_issue_purpose) == 4 || ( $variable_set_smn_allocation == 1 && str_replace("'", "", $cbo_issue_purpose) == 8)) )
				{
					$before_allocated_qnty = $before_allocated_qnty + $before_issue_qnty;
					$before_available_qnty = $before_available_qnty;

					$allocated_qnty_balance = $allocated_qnty - $txt_issue_qnty;
					$available_qnty_balance = $available_qnty;
				}
				else if (str_replace("'", "", $cbo_basis) == 1 && (str_replace("'", "", $cbo_issue_purpose) == 2 || str_replace("'", "", $cbo_issue_purpose) == 15 || str_replace("'", "", $cbo_issue_purpose) == 50 || str_replace("'", "", $cbo_issue_purpose) == 51 || str_replace("'", "", $cbo_issue_purpose) == 38 || str_replace("'", "", $cbo_issue_purpose) == 44 || str_replace("'", "", $cbo_issue_purpose) == 46 || str_replace("'", "", $cbo_issue_purpose) == 7 || str_replace("'", "", $cbo_issue_purpose) == 12 ))
				{
					if ( str_replace("'", "", $txt_entry_form) == 42 || str_replace("'", "", $txt_entry_form) == 114 ) // Without order
					{
						if($variable_set_smn_allocation==1)
						{
							$before_allocated_qnty = $before_allocated_qnty + $before_issue_qnty;
							$before_available_qnty = $before_available_qnty;

							$allocated_qnty_balance = $allocated_qnty - $txt_issue_qnty;
							$available_qnty_balance = $available_qnty;
						}
						else
						{
							$before_allocated_qnty = $before_allocated_qnty;
							$before_available_qnty = $before_available_qnty + $before_issue_qnty;

							$allocated_qnty_balance = $allocated_qnty;
							$available_qnty_balance = $available_qnty - $txt_issue_qnty;
						}
					}
					else if ( str_replace("'", "", $txt_entry_form) == 94 || str_replace("'", "", $txt_entry_form) == 340) //service wo
					{
						if (str_replace("'", "", $job_no) != "" ) // with order
						{
							$before_allocated_qnty = $before_allocated_qnty + $before_issue_qnty;
							$before_available_qnty = $before_available_qnty;

							$allocated_qnty_balance = $allocated_qnty - $txt_issue_qnty;
							$available_qnty_balance = $available_qnty;
						}
						else // without order
						{
							/*
							if($variable_set_smn_allocation==1)
							{
								$before_allocated_qnty = $before_allocated_qnty + $before_issue_qnty;
								$before_available_qnty = $before_available_qnty;

								$allocated_qnty_balance = $allocated_qnty - $txt_issue_qnty;
								$available_qnty_balance = $available_qnty;
							}
							else
							{*/
								$before_allocated_qnty = $before_allocated_qnty;
								$before_available_qnty = $before_available_qnty + $before_issue_qnty;

								$allocated_qnty_balance = $allocated_qnty;
								$available_qnty_balance = $available_qnty - $txt_issue_qnty;
							//}
						}
					}
					else // 41,125,135
					{
						$before_allocated_qnty = $before_allocated_qnty + $before_issue_qnty;
						$before_available_qnty = $before_available_qnty;

						$allocated_qnty_balance = $allocated_qnty - $txt_issue_qnty;
						$available_qnty_balance = $available_qnty;
					}
				}
				else
				{
					$before_allocated_qnty = $before_allocated_qnty;
					$before_available_qnty = $before_available_qnty + $before_issue_qnty;

					$allocated_qnty_balance = $allocated_qnty;
					$available_qnty_balance = $available_qnty - $txt_issue_qnty;
				}
			}
			else
			{
				$before_allocated_qnty = $before_allocated_qnty;
				$before_available_qnty = $before_available_qnty + $before_issue_qnty;

				$allocated_qnty_balance = $allocated_qnty;
				$available_qnty_balance = $available_qnty - $txt_issue_qnty;
			}

			$adj_before_stock_val = $before_stock_value + $before_issue_value; // CurrentStockValue + Before Issue Value
			$adj_before_avgrate = number_format($adj_before_stock_val / $adj_before_stock_qnty, 10, '.', '');

			$updateID_array_prod[] = $before_prod_id;
			$update_data_prod[$before_prod_id] = explode("*", ("" . $txt_issue_qnty . "*" . $adj_before_stock_qnty . "*" . number_format($adj_before_stock_val, 8, '.', '') . "*" . $before_allocated_qnty . "*" . $before_available_qnty . "*'" . $user_id . "'*'" . $pc_date_time . "'"));//$adj_before_avgrate."*".

			//for transaction log
			$log_entry_form1 = 3;
			$log_ref_id1 = str_replace("'", "", $update_id_mst);
			$log_ref_number1 = str_replace("'", "", $txt_system_no);
			$log_prod_id1 = str_replace("'", "", $before_prod_id);
			$log_current_stock1 = $adj_before_stock_qnty;
			$log_allocated_qty1 = $before_allocated_qnty;
			$log_available_qty1 = $before_available_qnty;

			//current product adjust
			$adj_curr_stock_qnty = $curr_stock_qnty - $txt_issue_qnty; // CurrentStock + Before Issue Qnty
			$adj_curr_stock_val = $curr_stock_value - ($txt_issue_qnty * $curr_avg_rate); // CurrentStockValue + Before Issue Value
			//$adj_curr_avgrate	 = number_format($adj_curr_stock_val/$adj_curr_stock_qnty,10,'.','');
			$adj_curr_avgrate = number_format($curr_avg_rate, 10, '.', '');
			//for current product-------------
			//item allocation----------------------------------------------------

			$availableChk = $curr_stock_qnty >= $txt_issue_qnty ? true : false;
			$msg = "Issue Quantity is exceed the current Stock Quantity";

			if ($availableChk == false) {

				if ($db_type == 0) {
					mysql_query("ROLLBACK");
				} else {
					oci_rollback($con);
				}
				echo "11**" . $msg;
				disconnect($con);
				exit();
			}

			$updateID_array_prod[] = $txt_prod_id;
			$update_data_prod[$txt_prod_id] = explode("*", ("" . $txt_issue_qnty . "*" . $adj_curr_stock_qnty . "*" . number_format($adj_curr_stock_val, 8, '.', '') . "*" . $allocated_qnty_balance . "*" . $available_qnty_balance . "*'" . $user_id . "'*'" . $pc_date_time . "'"));//.$adj_curr_avgrate."*"

			//for transaction log
			$log_entry_form = 3;
			$log_ref_id = str_replace("'", "", $update_id_mst);
			$log_ref_number = str_replace("'", "", $txt_system_no);
			$log_prod_id = str_replace("'", "", $txt_prod_id);
			$log_current_stock = $adj_curr_stock_qnty;
			$log_allocated_qty = $allocated_qnty_balance;
			$log_available_qty = $available_qnty_balance;

			//now current stock
			$curr_avg_rate = $adj_curr_avgrate;
			$curr_stock_qnty = $adj_curr_stock_qnty;
			$curr_stock_value = $adj_curr_stock_val;

			$store_up_id=0;
			if($variable_store_wise_rate == 1)
			{
				$sql_store_before = sql_select("select id, rate as avg_rate_per_unit, cons_qty as current_stock, amount as stock_value from inv_store_wise_yarn_qty_dtls where status_active=1 and prod_id=$before_prod_id and category_id=1 and store_id=$cbo_store_name and company_id=$cbo_company_id");
				if(count($sql_store_before)<1)
				{
					echo "20**No Data Found.";disconnect($con);die;
				}
				elseif(count($sql_store_before)>1)
				{
					echo "20**Duplicate Product is Not Allow in Same REF Number.";disconnect($con);die;
				}
				else
				{
					$store_presentStock=$store_presentStockValue=$store_presentAvgRate=0;
					foreach($sql_store_before as $result)
					{
						$store_up_id=$result[csf("id")];
						$store_presentStock	=$result[csf("current_stock")];
						$store_presentStockValue =$result[csf("stock_value")];
						$store_presentAvgRate	=$result[csf("avg_rate_per_unit")];
					}

					if($store_up_id)
					{
						$currentStock_store		=$store_presentStock+$before_issue_qnty;
						$currentValue_store		=$store_presentStockValue+$before_store_amount;
						$updateID_Storeprod[] = $store_up_id;
						$data_array_store[$store_up_id]= explode("*", ("".$before_issue_qnty."*".$currentStock_store."*".number_format($currentValue_store,8,'.','')."*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'"));
					}
				}

				$store_up_id=0;
				$sql_store_after = sql_select("select id, rate as avg_rate_per_unit, cons_qty as current_stock, amount as stock_value from inv_store_wise_yarn_qty_dtls where status_active=1 and prod_id=$txt_prod_id and category_id=1 and store_id=$cbo_store_name and company_id=$cbo_company_id");
				if(count($sql_store_after)<1)
				{
					echo "20**No Data Found.";disconnect($con);die;
				}
				elseif(count($sql_store_after)>1)
				{
					echo "20**Duplicate Product is Not Allow in Same REF Number.";disconnect($con);die;
				}
				else
				{
					$store_presentStock=$store_presentStockValue=$store_presentAvgRate=0;
					foreach($sql_store_after as $result)
					{
						$store_up_id=$result[csf("id")];
						$store_presentStock	=$result[csf("current_stock")];
						$store_presentStockValue =$result[csf("stock_value")];
						$store_presentAvgRate	=$result[csf("avg_rate_per_unit")];
					}
					if($store_up_id)
					{
						$currentStock_store		=$store_presentStock-$txt_issue_qnty;
						$currentValue_store		=$store_presentStockValue-$issue_store_value;
						$updateID_Storeprod[] = $store_up_id;
						$data_array_store[$store_up_id]= explode("*", ("".$txt_issue_qnty."*".$currentStock_store."*".number_format($currentValue_store,8,'.','')."*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'"));
					}
				}
			}
		}
		//------------------ product_details_master END--------------//
		//weighted and average rate END here-------------------------//
		//transaction table START--------------------------//
		$trans_data_array = array();
		$update_array_trans = "balance_qnty*balance_amount*updated_by*update_date";
		$sql = sql_select("select a.id,a.balance_qnty,a.balance_amount,b.issue_qnty,b.rate,b.amount, b.recv_trans_id from inv_transaction a, inv_mrr_wise_issue_details b where a.id=b.recv_trans_id and b.issue_trans_id=$update_id and b.entry_form=3 and a.item_category=1");
		$updateID_array_trans = array();
		$update_data_trans = array();
		foreach ($sql as $result) {
			$adjBalance = $result[csf("balance_qnty")] + $result[csf("issue_qnty")];
			$adjAmount = $result[csf("balance_amount")] + $result[csf("amount")];
			$updateID_array_trans[] = $result[csf("id")];
			$update_data_trans[$result[csf("id")]] = explode("*", ("" . $adjBalance . "*" . $adjAmount . "*'" . $user_id . "'*'" . $pc_date_time . "'"));

			$trans_data_array[$result[csf("id")]]['qnty'] = $adjBalance;
			$trans_data_array[$result[csf("id")]]['amnt'] = $adjAmount;
			$recv_trans_id .= $result[csf("recv_trans_id")] . ",";
		}

		$recv_trans_id = chop($recv_trans_id, ",");

		$query2 = true;
		$query3 = true;
			/*if(count($updateID_array_trans)>0)
			{
 				$query2=execute_query(bulk_update_sql_statement("inv_transaction","id",$update_array_trans,$update_data_trans,$updateID_array_trans));
			}

			//transaction table END----------------------------//
			//LIFO/FIFO  START here------------------------//

			if(count($updateID_array_trans)>0)
			{
			 	$updateIDArray = implode(",",$updateID_array);
			 	$query3 = execute_query("DELETE FROM inv_mrr_wise_issue_details WHERE issue_trans_id=$update_id and entry_form=3");
			}
			*/
			//PROPORTIONATE table here-------------------------//
			//$query4 = execute_query("DELETE FROM  order_wise_pro_details WHERE trans_id=$update_id and entry_form=3");
			//****************************************** BEFORE ENTRY ADJUST END *****************************************//
			//############## SAVE POINT START  ###################
			if ($db_type == 0) {
				$savepoint = "updatesql";
				mysql_query("SAVEPOINT $savepoint");
			}
			//############## SAVE POINT END    ###################
			//****************************************** NEW ENTRY START *****************************************//
			//issue master update START--------------------------------------//

			/*#### Stop not eligible field from update operation start ####*/
			// issue_basis*company_id*location_id*supplier_id*knit_dye_source*knit_dye_company*issue_purpose*
			// $cbo_basis . "*" . $cbo_company_id . "*" . $cbo_location_id . "*" . $cbo_supplier . "*" . $cbo_knitting_source . "*" . $cbo_knitting_company . "*" . " . $cbo_issue_purpose . "*
			/*#### Stop not eligible field from update operation end ####*/


			$field_array_mst = "entry_form*item_category*store_id*buyer_id*buyer_job_no*style_ref*booking_id*booking_no*service_booking_no*issue_date*sample_type*challan_no*loan_party*remarks*ready_to_approve*attention*updated_by*update_date";
			$data_array_mst = "3*1*" . $cbo_store_name . "*" . $cbo_buyer_name . "*" . $txt_buyer_job_no . "*" . $txt_style_ref . "*" . $txt_booking_id . "*" . $txt_booking_no . "*" . $txt_service_booking_no . "*" . $txt_issue_date . "*" . $cbo_sample_type . "*" . $txt_challan_no . "*" . $cbo_loan_party . "*" . $txt_remarks . "*" . $cbo_ready_to_approved . "*" . $txt_attention . "*'" . $user_id . "'*'" . $pc_date_time . "'";
			$id = str_replace("'", "", $update_id_mst);
			//echo $field_array."<br>".$data_array;."-".;
			//$rID=sql_update("inv_issue_master",$field_array_mst,$data_array_mst,"issue_number",$txt_system_no,0);

			/******** original product id check start ********/

			//$origin_prod_id=return_field_value("origin_prod_id","inv_transaction","prod_id=$txt_prod_id and status_active=1","origin_prod_id");
			if ($before_prod_id == $txt_prod_id) $balance_cond = " and( balance_qnty>0 or id in($recv_trans_id))";
			else $balance_cond = " and balance_qnty>0";
			$origin_prod_id = return_field_value("origin_prod_id", "inv_transaction", "prod_id=$txt_prod_id and status_active=1 and store_id=$cbo_store_name $balance_cond and transaction_type in (1,4,5) and item_category=1", "origin_prod_id");

			/******** original product id check end ********/


			//issue master update END---------------------------------------//
			//inventory TRANSACTION table data UPDATE START----------------------------------------------------------//
			//$transaction_type=array(1=>"Receive",2=>"Issue",3=>"Receive Return",4=>"Issue Return");
			$txt_issue_qnty = str_replace("'", "", $txt_issue_qnty);
			$avg_rate = $curr_avg_rate; // asign current rate
			$issue_stock_value = $avg_rate * $txt_issue_qnty;

			$basis = str_replace("'", "", $cbo_basis);
			$demand_system_no = ($basis==8)?str_replace("'", "", $txt_req_no):'';
			$txt_req_no = ($basis==3)?str_replace("'", "", $txt_req_no):str_replace("'", "", $hdn_req_no);

			$cbo_bin = (str_replace("'", "", $cbo_bin) == "" ) ? 0 : $cbo_bin ;
			$field_array_trans = "requisition_no*receive_basis*company_id*supplier_id*prod_id*origin_prod_id*dyeing_color_id*item_category*transaction_type*transaction_date*store_id*brand_id*cons_uom*cons_quantity*return_qnty*item_return_qty*cons_rate*cons_amount*no_of_bags*cone_per_bag*weight_per_bag*weight_per_cone*floor_id*room*rack*self*bin_box*using_item*job_no*updated_by*update_date*btb_lc_id*demand_id*demand_no*remarks*wo_id*pi_wo_batch_no*store_rate*store_amount";
			$data_array_trans = "'" . $txt_req_no . "'*" . $cbo_basis . "*" . $cbo_company_id . "*'" . $supplier_id_for_tran . "'*" . $txt_prod_id . "*'" . $origin_prod_id . "'*" . $cbo_dyeing_color . "*1*2*" . $txt_issue_date . "*" . $cbo_store_name . "*" . $cbo_brand . "*" . $cbo_uom . "*" . $txt_issue_qnty . "*" . $txt_returnable_qty . "*" . $extra_quantity . "*" . number_format($avg_rate,10,'.','') . "*" . number_format($issue_stock_value,8,'.','') . "*" . $txt_no_bag . "*" . $txt_no_cone . "*" . $txt_weight_per_bag . "*" . $txt_weight_per_cone . "*" . $cbo_floor . "*" . $cbo_room . "*" . $txt_rack . "*" . $txt_shelf . "*" . $cbo_bin . "*" . $cbo_item . "*" . $job_no . "*'" . $user_id . "'*'" . $pc_date_time . "'*" . $txt_btb_lc_id . "*" . $demand_id . "*'" . $demand_system_no."'*" . $txt_remarks_dtls . "*" . $txt_wo_id . "*" . $txt_pi_id . "*".number_format($store_item_rate,10,'.','')."*".number_format($issue_store_value,8,'.','')."";
			//echo $field_array."<br>".$data_array;."-".;
			//$transID = sql_update("inv_transaction",$field_array_trans,$data_array_trans,"id",$update_id,1);
			//inventory TRANSACTION table data UPDATE  END----------------------------------------------------------//
			//if LIFO/FIFO then START -----------------------------------------//
			$field_array = "id,recv_trans_id,issue_trans_id,entry_form,prod_id,issue_qnty,rate,amount,inserted_by,insert_date";
			$update_array = "balance_qnty*balance_amount*updated_by*update_date";
			$cons_rate = 0;
			$data_array = "";
			$updateID_array = array();
			$update_data = array();
			$issueQnty = $txt_issue_qnty;


			if ($isLIFOfifo == 2) $cond_lifofifo = " DESC"; else $cond_lifofifo = " ASC";
			if ($before_prod_id == $txt_prod_id) $balance_cond = " and( balance_qnty>0 or id in($recv_trans_id))";
			else $balance_cond = " and balance_qnty>0";
			$sql = sql_select("select id,cons_rate,balance_qnty,balance_amount from inv_transaction where prod_id=$txt_prod_id and store_id=$cbo_store_name $balance_cond and transaction_type in (1,4,5) and item_category=1 and status_active=1 order by transaction_date, id $cond_lifofifo");
			foreach ($sql as $result) {
			$issue_trans_id = $result[csf("id")]; // this row will be updated
			if ($trans_data_array[$issue_trans_id]['qnty'] == "") {
				$balance_qnty = $result[csf("balance_qnty")];
				$balance_amount = $result[csf("balance_amount")];
			} else {
				$balance_qnty = $trans_data_array[$issue_trans_id]['qnty'];
				$balance_amount = $trans_data_array[$issue_trans_id]['amnt'];
			}

			$cons_rate = $result[csf("cons_rate")];
			$issueQntyBalance = $balance_qnty - $issueQnty; // minus issue qnty
			$issueStockBalance = $balance_amount - ($issueQnty * $cons_rate);
			if ($issueQntyBalance >= 0)
			{
				$amount = $issueQnty * $cons_rate;
				//for insert
				$mrrWiseIsID = return_next_id_by_sequence("INV_MRR_WISE_ISSUE_PK_SEQ", "inv_mrr_wise_issue_details", $con);
				if ($data_array != "") $data_array .= ",";
				$data_array .= "(" . $mrrWiseIsID . "," . $issue_trans_id . "," . $update_id . ",3," . $txt_prod_id . "," . $issueQnty . "," . number_format($cons_rate,10,'.','') . "," . number_format($amount,8,'.','') . ",'" . $user_id . "','" . $pc_date_time . "')";
				//for update
				$updateID_array[] = $issue_trans_id;
				$update_data[$issue_trans_id] = explode("*", ("" . $issueQntyBalance . "*" . $issueStockBalance . "*'" . $user_id . "'*'" . $pc_date_time . "'"));
				break;
			}
			else if ($issueQntyBalance < 0)
			{
				$issueQntyBalance = $issueQnty - $balance_qnty;
				$issueQnty = $balance_qnty;
				$amount = $issueQnty * $cons_rate;

				//for insert
				$mrrWiseIsID = return_next_id_by_sequence("INV_MRR_WISE_ISSUE_PK_SEQ", "inv_mrr_wise_issue_details", $con);
				if ($data_array != "") $data_array .= ",";
				$data_array .= "(" . $mrrWiseIsID . "," . $issue_trans_id . "," . $update_id . ",3," . $txt_prod_id . "," . $issueQnty . "," . number_format($cons_rate,10,'.','') . "," . number_format($amount,8,'.','') . ",'" . $user_id . "','" . $pc_date_time . "')";
				//echo "20**".$data_array;die;
				//for update
				$updateID_array[] = $issue_trans_id;
				$update_data[$issue_trans_id] = explode("*", ("0*0*'" . $user_id . "'*'" . $pc_date_time . "'"));
				$issueQnty = $issueQntyBalance;
			}
		}//end foreach
		// LIFO/FIFO then END-----------------------------------------------//txt_prod_id

		//echo "20**".$data_array;mysql_query("ROLLBACK");die;
		//mrr wise issue data insert here----------------------------//
		$mrrWiseIssueID = true;
		$upTrID = true;

		//----------order_wise_pro_details table data insert Start --------------------------------//
		$proportQ = true;
		$save_string = explode(",", str_replace("'", "", $save_data));
		if (count($save_string) > 0 && str_replace("'", "", $save_data) != "")
		{
			//order_wise_pro_details table data insert START-----//
			$field_array_proportionate = "id,trans_id,trans_type,entry_form,po_breakdown_id,prod_id,quantity,issue_purpose,returnable_qnty,is_sales,inserted_by,insert_date";

			$po_array = array();
			$po_rt_array = array();
			for ($i = 0; $i < count($save_string); $i++) {
				$order_dtls = explode("**", $save_string[$i]);
				$order_id = $order_dtls[0];
				$order_qnty = $order_dtls[1];
				$returnable_qnty = $order_dtls[2];
				$po_id_arr[$order_id] = $order_id;
				if (array_key_exists($order_id, $po_array)) {
					$po_array[$order_id] += $order_qnty;
					$po_rt_array[$order_id] += $returnable_qnty;
				} else {
					$po_array[$order_id] = $order_qnty;
					$po_rt_array[$order_id] = $returnable_qnty;
				}
			}

			$po_original_dataArray = array();
			$explOriginalSaveData = explode(",", str_replace("'", "", $original_save_data));
			foreach ($explOriginalSaveData as $orival) {
				$originalWoQnty = explode("**", $orival);
				$po_original_dataArray[$originalWoQnty[0]] += $originalWoQnty[1];
			}
			/*echo "<pre>";
			print_r($po_original_dataArray);
			die;*/

			$is_salesOrder = 0;
			if (str_replace("'", "", $cbo_basis) == 3 || str_replace("'", "", $cbo_basis) == 8)
			{
				if(str_replace("'", "", $cbo_basis) == 3)
				{
					$requisition_cond =" and b.requisition_no=$txt_req_no";
				}
				else{
					$requisition_cond =" and b.requisition_no=$hdn_req_no";
				}

				$planning_info = sql_select("select a.is_sales,a.booking_no from ppl_planning_entry_plan_dtls a, ppl_yarn_requisition_entry b where a.dtls_id=b.knit_id and b.prod_id = $txt_prod_id and a.status_active=1 and b.status_active=1 and a.is_deleted=0 and b.is_deleted=0 $requisition_cond group by a.is_sales,a.booking_no");

				$is_salesOrder = $planning_info[0][csf("is_sales")];
				$requisition_booking = $planning_info[0][csf("booking_no")];
			}

			if ($variable_set_allocation == 1)
			{
				if ((str_replace("'", "", $cbo_basis) == 3 || str_replace("'", "", $cbo_basis) == 8) && (str_replace("'", "", $cbo_issue_purpose) == 1 || str_replace("'", "", $cbo_issue_purpose) == 4)) {

					$order_wise_allocation_validation = ($is_auto_allocation_from_requisition==1)?0:1;
					$requisition_booking_cond = ($requisition_booking!="")?"and a.booking_no='$requisition_booking'":"";
					$allocation_sql = "select b.po_break_down_id,sum(b.qnty) order_wise_allocation from inv_material_allocation_mst a,inv_material_allocation_dtls b where a.id=b.mst_id and a.item_id=$txt_prod_id and b.po_break_down_id in(".implode(",",$po_id_arr).") $requisition_booking_cond and a.status_active=1 and b.status_active=1 group by b.po_break_down_id";

				} else if (str_replace("'", "", $cbo_basis) == 1 && (str_replace("'", "", $cbo_issue_purpose) == 2 || str_replace("'", "", $cbo_issue_purpose) == 15 || str_replace("'", "", $cbo_issue_purpose) == 50 || str_replace("'", "", $cbo_issue_purpose) == 51 || str_replace("'", "", $cbo_issue_purpose) == 38 || str_replace("'", "", $cbo_issue_purpose) == 44 || str_replace("'", "", $cbo_issue_purpose) == 46 || str_replace("'", "", $cbo_issue_purpose) == 7 || str_replace("'", "", $cbo_issue_purpose) == 12 )) {
					if ( $variable_set_smn_allocation == 1 && str_replace("'", "", $txt_entry_form) == 42 || str_replace("'", "", $txt_entry_form) == 114 || str_replace("'", "", $txt_entry_form) == 135)
					{
						$order_wise_allocation_validation = ($is_auto_allocation_from_requisition==1)?0:1;
							$allocation_sql = "select b.po_break_down_id,sum(b.qnty) order_wise_allocation from inv_material_allocation_mst a,inv_material_allocation_dtls b where a.id=b.mst_id and a.item_id=$txt_prod_id and b.po_break_down_id in(".implode(",",$po_id_arr).") and a.status_active=1 and b.status_active=1 group by b.po_break_down_id";
					}
					else if ( str_replace("'", "", $txt_entry_form) == 94 || str_replace("'", "", $txt_entry_form) == 340)
					{
						if (str_replace("'", "", $job_no) != "" )
						{

							$order_wise_allocation_validation = ($is_auto_allocation_from_requisition==1)?0:1;
							$allocation_sql = "select b.po_break_down_id,sum(b.qnty) order_wise_allocation from inv_material_allocation_mst a,inv_material_allocation_dtls b where a.id=b.mst_id and a.item_id=$txt_prod_id and b.po_break_down_id in(".implode(",",$po_id_arr).") and a.status_active=1 and b.status_active=1 group by b.po_break_down_id";
						}
					}
					else
					{

						$order_wise_allocation_validation = ($is_auto_allocation_from_requisition==1)?0:1;
						$allocation_sql = "select b.po_break_down_id,sum(b.qnty) order_wise_allocation from inv_material_allocation_mst a,inv_material_allocation_dtls b where a.id=b.mst_id and a.item_id=$txt_prod_id and b.po_break_down_id in(".implode(",",$po_id_arr).") and a.status_active=1 and b.status_active=1 group by b.po_break_down_id";
					}
				}

				$allocation_result = sql_select($allocation_sql);
				$order_wise_allocation_arr = array();
				foreach ($allocation_result as $allocation_row) {
					$order_wise_allocation_arr[$allocation_row[csf("po_break_down_id")]] = $allocation_row[csf("order_wise_allocation")];
				}
			}

			if (str_replace("'", "", $txt_entry_form) == 135)
			{
				$is_salesOrder = 1;
			}

			if(str_replace("'", "", $txt_entry_form) == 94 || str_replace("'", "", $txt_entry_form) == 340)
			{
				$yarn_dyeing_info=sql_select("select entry_form,is_sales from wo_yarn_dyeing_mst where status_active=1 and ydw_no=$txt_booking_no and company_id=$cbo_company_id");
				$is_salesOrder = $yarn_dyeing_info[0][csf('is_sales')];

			}

			$wo_job_cond = ($wo_job_no!="")?" and b.job_no='".$wo_job_no."'":"";
			$wo_fabric_booking_cond = (str_replace("'","",$hdn_fabric_booking_no)!="")?" and b.booking_no=$hdn_fabric_booking_no":"";
			$requisition_cond = ($hdn_req_no!="")?" and b.requisition_no=".$hdn_req_no."":"";

			$order_wise_sql = sql_select("select trans_type,trans_id,po_breakdown_id, quantity, returnable_qnty from order_wise_pro_details where entry_form in(3,9) and trans_type in(2,4) and status_active=1 and prod_id=$txt_prod_id and trans_id!=$update_id $wo_job_cond $wo_fabric_booking_cond $requisition_cond");

			foreach ($order_wise_sql as $order_row)
			{
				if($order_row[csf("trans_type")]==2)
				{
					$order_wise_issue_arr[$order_row[csf("po_breakdown_id")]] += $order_row[csf("quantity")];
				}
				if($order_row[csf("trans_type")]==4)
				{
					$order_wise_issue_ret_arr[$order_row[csf("po_breakdown_id")]] += $order_row[csf("quantity")];
				}
			}

			$i = 0;
			foreach ($po_array as $key => $val)
			{

				if ($i > 0) $data_array_prop .= ",";

				$order_id = $key;
				$order_qnty = $val;
				$returnable_qnty = $po_rt_array[$key];

				$order_wise_allocation_qnty = number_format($order_wise_allocation_arr[$order_id],2,".","");
				$order_qnty = number_format($order_qnty,2,".","");

				$order_wise_allocation_balance = ( number_format($order_wise_allocation_arr[$order_id],2,".","") + number_format($order_wise_issue_ret_arr[$order_id],2,".","")) - ((number_format($po_original_dataArray[$order_id],2,".","") + ($order_qnty - number_format($po_original_dataArray[$order_id],2,".","")) + number_format($order_wise_issue_arr[$order_id],2,".","")));

				if ($variable_set_allocation == 1 && $order_wise_allocation_validation==1 && $dyed_type!=1)
				{
					if(number_format($order_wise_allocation_balance,2,".","") < 0)
					{
						$msg = "Issue Quantity can not be greater than Allocation quantity of this Order.\nAllocation in this Order = ".$order_wise_allocation_arr[$order_id]."\nTotal Previous Issue = " . $order_wise_issue_arr[$order_id] . "\nTotal Issue Return = " . $order_wise_issue_ret_arr[$order_id] . "\nCurrent Issue = $order_qnty";

						if ($db_type == 0)
						{
							mysql_query("ROLLBACK");
						}
						else
						{
							oci_rollback($con);
						}

						echo "11**" . $msg;
						disconnect($con);
						exit();
					}
				}

				$id_proport = return_next_id_by_sequence("ORDER_WISE_PROP_PK_SEQ", "order_wise_pro_details", $con);
				$data_array_prop .= "(" . $id_proport . "," . $update_id . ",2,3," . $order_id . "," . $txt_prod_id . "," . $order_qnty . "," . $cbo_issue_purpose . ",'" . $returnable_qnty . "','" . $is_salesOrder . "'," . $user_id . ",'" . $pc_date_time . "')";
				$i++;
			}

			//echo "10**";
			//echo "<pre>";
			//print_r($allocationBalance);
			//die();

		}


		if (str_replace("'", "", $cbo_basis) == 4)
		{
			$field_array_proportionate = "id,trans_id,trans_type,entry_form,po_breakdown_id,prod_id,quantity,issue_purpose,returnable_qnty,is_sales,inserted_by,insert_date";
			$id_proport = return_next_id_by_sequence("ORDER_WISE_PROP_PK_SEQ", "order_wise_pro_details", $con);
			$data_array_prop = "(" . $id_proport . "," . $update_id . ",2,3," . $txt_booking_id . "," . $txt_prod_id . "," . $txt_issue_qnty . "," . $cbo_issue_purpose . "," . $txt_returnable_qty . ",1," . $user_id . ",'" . $pc_date_time . "')";
		}///$transactionID
		//----------order_wise_pro_details table data insert END --------------------------------//
		//****************************************** NEW ENTRY END *****************************************//
		//echo "10**"."insert into order_wise_pro_details (".$field_array_proportionate.") values ".$data_array_prop;die;

		if ($before_prod_id == $txt_prod_id)
		{
			$query1 = sql_update("product_details_master", $update_array_prod, $data_array_prod, "id", $before_prod_id, 0);
		}
		else
		{
			$query1 = execute_query(bulk_update_sql_statement("product_details_master", "id", $update_array_prod, $update_data_prod, $updateID_array_prod),0);
		}

		/*if (count($updateID_array_trans) > 0) {
			$query2 = execute_query(bulk_update_sql_statement("inv_transaction", "id", $update_array_trans, $update_data_trans, $updateID_array_trans));
			$query3 = execute_query("DELETE FROM inv_mrr_wise_issue_details WHERE issue_trans_id=$update_id and entry_form=3");
		}*/
		$query2 = execute_query(bulk_update_sql_statement("inv_transaction", "id", $update_array_trans, $update_data_trans, $updateID_array_trans),0);
		$query3 = execute_query("DELETE FROM inv_mrr_wise_issue_details WHERE issue_trans_id=$update_id and entry_form=3",0);
		$query4 = execute_query("DELETE FROM order_wise_pro_details WHERE trans_id=$update_id and entry_form=3",0);
		$rID = sql_update("inv_issue_master", $field_array_mst, $data_array_mst, "issue_number", $txt_system_no, 0);
		$transID = sql_update("inv_transaction", $field_array_trans, $data_array_trans, "id", $update_id, 0);
		$mrrWiseIssueID = sql_insert("inv_mrr_wise_issue_details", $field_array, $data_array, 0);
		$upTrID = execute_query(bulk_update_sql_statement("inv_transaction", "id", $update_array, $update_data, $updateID_array),0);
		/*if ($data_array != "") {
			$mrrWiseIssueID = sql_insert("inv_mrr_wise_issue_details", $field_array, $data_array, 0);
		}
		if (count($updateID_array) > 0) {
			$upTrID = execute_query(bulk_update_sql_statement("inv_transaction", "id", $update_array, $update_data, $updateID_array));
		}*/

		if ($data_array_prop != "")
		{
			//echo "10**".$update_id."test"; die();
			//echo "10**"."insert into order_wise_pro_details (".$field_array_proportionate.") values ".$data_array_prop;die;
			$proportQ = sql_insert("order_wise_pro_details", $field_array_proportionate, $data_array_prop, 0);
		}

		$storeRID =true;
		if(count($updateID_Storeprod)>0 && $variable_store_wise_rate == 1)
		{
			$storeRID = execute_query(bulk_update_sql_statement("inv_store_wise_yarn_qty_dtls", "id", $field_array_store, $data_array_store, $updateID_Storeprod),0);
		}


		//mysql_query("ROLLBACK");
		/* echo "10**".$transID;
		die; */
		//release lock table
		//check_table_status( $_SESSION['menu_id'],0);
		//echo "10**$query1 && $query2 && $query3 && $query4 && $rID && $transID && $upTrID && $mrrWiseIssueID && $proportQ && $storeRID";die;
		if ($db_type == 0)
		{
			if ($query1 && $query2 && $query3 && $query4 && $rID && $transID && $upTrID && $mrrWiseIssueID && $proportQ && $storeRID)
			{
				mysql_query("COMMIT");
				echo "1**" . str_replace("'", "", $txt_system_no) . "**" . $id. "**" . str_replace("'", "", $cbo_knitting_company);
			}
			else
			{
				mysql_query("ROLLBACK");
				mysql_query("ROLLBACK TO $savepoint");
				echo "10**" . str_replace("'", "", $txt_system_no) . "**" . $id. "**" . str_replace("'", "", $cbo_knitting_company);
			}
		}
		else if ($db_type == 2 || $db_type == 1)
		{
			if ($query1 && $query2 && $query3 && $query4 && $rID && $transID && $upTrID && $mrrWiseIssueID && $proportQ && $storeRID)
			{
				if ($before_prod_id == $txt_prod_id)
				{
					//for transaction log
					$log_data = array();
					$log_data['entry_form'] = $log_entry_form;
					$log_data['ref_id'] = $log_ref_id;
					$log_data['ref_number'] = $log_ref_number;
					$log_data['product_id'] = $log_prod_id;
					$log_data['current_stock'] = $log_current_stock;
					$log_data['allocated_qty'] = $log_allocated_qty;
					$log_data['available_qty'] = $log_available_qty;
					$log_data['dyed_type'] = $dyed_type;
					$log_data['insert_date'] = $pc_date_time;
					$allocation_log = manage_allocation_transaction_log($log_data);
					//end for transaction log
				}
				else
				{
					//for transaction log
					$log_data = array();
					$log_data['entry_form'] = $log_entry_form1;
					$log_data['ref_id'] = $log_ref_id1;
					$log_data['ref_number'] = $log_ref_number1;
					$log_data['product_id'] = $log_prod_id1;
					$log_data['current_stock'] = $log_current_stock1;
					$log_data['allocated_qty'] = $log_allocated_qty1;
					$log_data['available_qty'] = $log_available_qty1;
					$log_data['dyed_type'] = return_field_value('dyed_type', 'product_details_master', " status_active = 1 and id = ".$log_prod_id1, 'dyed_type');
					$log_data['insert_date'] = $pc_date_time;
					$allocation_log = manage_allocation_transaction_log($log_data);
					//end for transaction log
				}

				if($allocation_log)
				{
					oci_commit($con);
					echo "1**" . str_replace("'", "", $txt_system_no) . "**" . $id. "**" . str_replace("'", "", $cbo_knitting_company);
				}
				else
				{
					oci_rollback($con);
					echo "10**" . str_replace("'", "", $txt_system_no) . "**" . $id. "**" . str_replace("'", "", $cbo_knitting_company);
				}
			}
			else
			{
				oci_rollback($con);
				echo "10**" . str_replace("'", "", $txt_system_no) . "**" . $id. "**" . str_replace("'", "", $cbo_knitting_company);
			}
		}
		//check_table_status($_SESSION['menu_id'], 0);
		disconnect($con);
		die;
	}
	else if ($operation == 2) //Delete Here----------------------------------------------------------
	{

		$id = str_replace("'", "", $update_id_mst);
		$con = connect();
		if ($db_type == 0) {
			mysql_query("BEGIN");
		}

		//for production check
		//for requisition basis and knitting issue purpose
		if( ( str_replace("'", "", $cbo_basis) == 3 ) && ( str_replace("'", "", $cbo_issue_purpose) == 1 || ( $variable_set_smn_allocation == 1 && str_replace("'", "", $cbo_issue_purpose) == 8) ) )
		{
			//txt_req_no
			$sql_production = sql_select("SELECT b.recv_number AS RECV_NUMBER FROM ppl_yarn_requisition_entry a, inv_receive_master b WHERE a.knit_id = b.booking_id AND a.requisition_no = ".$txt_req_no." AND a.status_active = 1 AND a.is_deleted = 0 AND b.status_active = 1 AND b.is_deleted = 0 AND b.entry_form = 2 AND b.item_category = 13 AND b.receive_basis = 2");
			$productionData = array();
			foreach($sql_production as $row)
			{
				$productionData[$row['RECV_NUMBER']] = $row['RECV_NUMBER'];
			}

			if(!empty($productionData))
			{
				echo "40**Production Found\nProduction Id = ".implode(', ',$productionData);
				disconnect($con);
				die();
			}
		}

		//and a.booking_no=$txt_req_no
		$return_result = sql_select("SELECT a.recv_number,b.order_qnty FROM inv_receive_master a, inv_transaction b WHERE a.id=b.mst_id and a.item_category=1 and b.item_category=1 and b.prod_id=$txt_prod_id and a.issue_id=$update_id_mst and b.company_id=$cbo_company_id and b.transaction_type=4 and b.transaction_type=4 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

		if(!empty($return_result))
		{
			foreach ($return_result as $return_row)
			{
				$returnString .= ",".$return_row[csf('recv_number')]." -> ".$return_row[csf('order_qnty')];
			}
			disconnect($con);
			exit("30**".$returnString);
		}

		if (str_replace("'", "", $txt_system_no) != "") //new insert cbo_ready_to_approved
		{
			$check_in_gate_pass = return_field_value("sys_number", "inv_gate_pass_mst", "challan_no=$txt_system_no and status_active=1 and is_deleted=0", "sys_number");
			if ($check_in_gate_pass != "")
			{
				echo "20**Gate Pass found.\nGate Pass ID = $check_in_gate_pass";
				disconnect($con);
				die;
			}
		}

		if(str_replace("'", "", $cbo_basis)==1) // work order basis
		{
			$receive_sql = "select a.recv_number_prefix_num,b.cons_quantity as receive_qty from inv_receive_master a, inv_transaction b where a.id=b.mst_id and a.receive_basis=2 and b.item_category=1 and b.transaction_type=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_id=$txt_booking_id and a.booking_no=$txt_booking_no order by a.recv_number_prefix_num";

			$rcvData = sql_select($receive_sql);
			$rcvMrrData = array();
			$totalRcvQty = 0;
			foreach ($rcvData as  $row)
			{
				$rcvMrrData[$row[csf('recv_number_prefix_num')]] = $row[csf('receive_qty')];
				$totalRcvQty += $row[csf('receive_qty')];
			}

			if($totalRcvQty>0)
			{
				$rcvNum = implode(",",array_keys($rcvMrrData));
				echo "20**Receive Found\nReceive No=$rcvNum\nReceive quantity=$totalRcvQty";
				disconnect($con);
				die();
			}
		}

		//check update id
		if (str_replace("'", "", $update_id) == "" || str_replace("'", "", $txt_system_no) == "")
		{
			echo "15";
			disconnect($con);
			exit();
		}
		/*
		???
		oci_rollback($con);
		echo "10**" . str_replace("'", "", $txt_system_no);
		disconnect($con);
		die;
		*/

		//product master table information
		//before stock update
		$sql = sql_select("select a.id,a.avg_rate_per_unit,a.current_stock,a.stock_value, b.cons_quantity, a.dyed_type, b.cons_amount, b.store_amount, a.allocated_qnty, a.available_qnty from product_details_master a, inv_transaction b where a.id=b.prod_id and b.id=$update_id and a.item_category_id=1 and b.item_category=1 and b.transaction_type=2");
		$before_prod_id = $before_issue_qnty = $before_stock_qnty = $before_stock_value = 0;
		foreach ($sql as $result)
		{
			$before_prod_id = $result[csf("id")];
			$before_stock_qnty = $result[csf("current_stock")];
			$before_avg_rate_per_unit = $result[csf("avg_rate_per_unit")];

			$before_issue_qnty = $result[csf("cons_quantity")];
			$before_issue_value = $result[csf("cons_amount")];
			$before_store_amount = $result[csf("store_amount")];
			$before_allocated_qnty = $result[csf("allocated_qnty")];
			$before_available_qnty = $result[csf("available_qnty")];
			$dyed_type = $result[csf("dyed_type")];
		}

		//weighted and average rate START here------------------------//
		//product master table data UPDATE START----------------------//
		$field_array_prod = "current_stock*stock_value*allocated_qnty*available_qnty*updated_by*update_date";
		$adj_stock_qnty = $before_stock_qnty + $before_issue_qnty;
		$adj_stock_val = $adj_stock_qnty * $before_avg_rate_per_unit;
		$allocated_qnty_balance = 0;
		$available_qnty_balance = 0;

		if ($variable_set_allocation == 1)
		{
			if ( (str_replace("'", "", $cbo_basis) == 3 || str_replace("'", "", $cbo_basis) == 8) && (str_replace("'", "", $cbo_issue_purpose) == 1 || str_replace("'", "", $cbo_issue_purpose) == 4 || ( $variable_set_smn_allocation == 1 && str_replace("'", "", $cbo_issue_purpose) == 8)) )
			{
				$allocated_qnty_balance = $before_allocated_qnty + $before_issue_qnty;
				$available_qnty_balance = $before_available_qnty;
			}
			else if ((str_replace("'", "", $cbo_basis) == 1) && (str_replace("'", "", $cbo_issue_purpose) == 2 || str_replace("'", "", $cbo_issue_purpose) == 15 || str_replace("'", "", $cbo_issue_purpose) == 50 || str_replace("'", "", $cbo_issue_purpose) == 51 || str_replace("'", "", $cbo_issue_purpose) == 38 || str_replace("'", "", $cbo_issue_purpose) == 44 || str_replace("'", "", $cbo_issue_purpose) == 46 || str_replace("'", "", $cbo_issue_purpose) == 7 || str_replace("'", "", $cbo_issue_purpose) == 12 ))
			{
				if (str_replace("'", "", $txt_entry_form) == 42 || str_replace("'", "", $txt_entry_form) == 114) // Without order
				{
					if($variable_set_smn_allocation==1)
					{
						$allocated_qnty_balance = $before_allocated_qnty + $before_issue_qnty;
						$available_qnty_balance = $before_available_qnty;
					}
					else
					{
						$allocated_qnty_balance = $before_allocated_qnty;
						$available_qnty_balance = $before_available_qnty + $before_issue_qnty;
					}
				}
				else if ( str_replace("'", "", $txt_entry_form) == 94 || str_replace("'", "", $txt_entry_form) == 340)// Service workorder
				{
					if (str_replace("'", "", $job_no) != "" ) // with order
					{
						$allocated_qnty_balance = $before_allocated_qnty + $before_issue_qnty;
						$available_qnty_balance = $before_available_qnty;
					}
					else // Without order
					{
						/*
						if($variable_set_smn_allocation==1)
						{
							$allocated_qnty_balance = $before_allocated_qnty + $before_issue_qnty;
							$available_qnty_balance = $before_available_qnty;
						}
						else
						{*/
							$allocated_qnty_balance = $before_allocated_qnty;
							$available_qnty_balance = $before_available_qnty + $before_issue_qnty;
						//}
					}
				}
				else
				{
					$allocated_qnty_balance = $before_allocated_qnty + $before_issue_qnty;
					$available_qnty_balance = $before_available_qnty;
				}
			}
			else
			{
				$allocated_qnty_balance = $before_allocated_qnty;
				$available_qnty_balance = $before_available_qnty + $before_issue_qnty;
			}
		}
		else
		{
			$allocated_qnty_balance = $before_allocated_qnty;
			$available_qnty_balance = $before_available_qnty + $before_issue_qnty;
		}

		//echo "10**testing==$txt_entry_form"; die();
		$data_array_prod = "" . $adj_stock_qnty . "*" . number_format($adj_stock_val,8,'.','') . "*" . $allocated_qnty_balance . "*" . $available_qnty_balance . "*'" . $user_id . "'*'" . $pc_date_time . "'";

		$store_up_id=0;
		if($variable_store_wise_rate == 1)
		{
			$sql_store = sql_select("select id, rate as avg_rate_per_unit, cons_qty as current_stock, amount as stock_value from inv_store_wise_yarn_qty_dtls where status_active=1 and prod_id=$before_prod_id and category_id=1 and store_id=$cbo_store_name and company_id=$cbo_company_id");

			if(count($sql_store)<1)
			{
				echo "20**No Data Found.";disconnect($con);die;
			}
			elseif(count($sql_store)>1)
			{
				echo "20**Duplicate Product is Not Allow in Same REF Number.";disconnect($con);die;
			}
			else
			{
				$store_presentStock=$store_presentStockValue=$store_presentAvgRate=$store_before_receive_qnty=0;
				foreach($sql_store as $result)
				{
					$store_up_id=$result[csf("id")];
					$store_presentStock	=$result[csf("current_stock")];
					$store_presentStockValue =$result[csf("stock_value")];
					$store_presentAvgRate	=$result[csf("avg_rate_per_unit")];
				}
				$currentStock_store		=$store_presentStock+$before_issue_qnty;
				$currentValue_store		=$store_presentStockValue+$before_store_amount;

				$field_array_store="last_issued_qnty*cons_qty*amount*updated_by*update_date";
				$data_array_store= "".$before_issue_qnty."*".$currentStock_store."*".number_format($currentValue_store,8,'.','')."*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'";
			}
		}

		//for transaction log
		$log_entry_form = 3;
		$log_ref_id = str_replace("'", "", $update_id_mst);
		$log_ref_number = str_replace("'", "", $txt_system_no);
		$log_prod_id = str_replace("'", "", $txt_prod_id);
		$log_current_stock = $adj_stock_qnty;
		$log_allocated_qty = $allocated_qnty_balance;
		$log_available_qty = $available_qnty_balance;

		$trans_data_array = array();
		$update_array_trans = "balance_qnty*balance_amount*updated_by*update_date";
		$sql = sql_select("select a.id,a.balance_qnty,a.balance_amount,b.issue_qnty,b.rate,b.amount from inv_transaction a, inv_mrr_wise_issue_details b where a.id=b.recv_trans_id and b.issue_trans_id=$update_id and b.entry_form=3 and a.item_category=1");
		$updateID_array_trans = array();
		$update_data_trans = array();
		foreach ($sql as $result)
		{
			$adjBalance = $result[csf("balance_qnty")] + $result[csf("issue_qnty")];
			$adjAmount = $result[csf("balance_amount")] + $result[csf("amount")];
			$updateID_array_trans[] = $result[csf("id")];
			$update_data_trans[$result[csf("id")]] = explode("*", ("" . $adjBalance . "*" . $adjAmount . "*'" . $user_id . "'*'" . $pc_date_time . "'"));
		}
		// echo "10**<pre>";
		// print_r($data_array_prod);
		// echo "10**ok";die;
		$query1 = sql_update("product_details_master", $field_array_prod, $data_array_prod, "id", $before_prod_id, 0);
		$query2 = execute_query(bulk_update_sql_statement("inv_transaction", "id", $update_array_trans, $update_data_trans, $updateID_array_trans));
		/*if (!empty($update_data_trans))
		{
			$query2 = execute_query(bulk_update_sql_statement("inv_transaction", "id", $update_array_trans, $update_data_trans, $updateID_array_trans));
		} else {
			$query2 = 1;
		}*/
		$query3 = execute_query("DELETE FROM inv_mrr_wise_issue_details WHERE issue_trans_id=$update_id and entry_form=3");
		$query4 = execute_query("DELETE FROM order_wise_pro_details WHERE trans_id=$update_id and entry_form=3");
		$field_array_status = "updated_by*update_date*status_active*is_deleted";
		$data_array_status = $_SESSION['logic_erp']['user_id'] . "*'" . $pc_date_time . "'*0*1";
		$changeStatus = sql_update("inv_transaction", $field_array_status, $data_array_status, "id", $update_id, 1);
		$storeRID=true;
		if($store_up_id>0 && $variable_store_wise_rate == 1)
		{
			$storeRID=sql_update("inv_store_wise_yarn_qty_dtls",$field_array_store,$data_array_store,"id",$store_up_id,1);
		}
		/*oci_rollback($con);
		echo "10**" .$query1."&&".$query2."&&".$query3."&&".$query4."&&".$changeStatus;
		disconnect($con);
		die;*/

		if ($db_type == 0)
		{
			if ($query1 && $query2 && $query3 && $query4 && $changeStatus && $storeRID)
			{
				mysql_query("COMMIT");
				echo "2**" . str_replace("'", "", $txt_system_no) . "**" . $id. "**" . str_replace("'", "", $cbo_knitting_company);
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**" . str_replace("'", "", $txt_system_no) . "**" . $id. "**" . str_replace("'", "", $cbo_knitting_company);
			}
		}
		else if ($db_type == 2 || $db_type == 1)
		{
			if ($query1 && $query2 && $query3 && $query4 && $changeStatus && $storeRID)
			{
				//for transaction log
				$log_data = array();
				$log_data['entry_form'] = $log_entry_form;
				$log_data['ref_id'] = $log_ref_id;
				$log_data['ref_number'] = $log_ref_number;
				$log_data['product_id'] = $log_prod_id;
				$log_data['current_stock'] = $log_current_stock;
				$log_data['allocated_qty'] = $log_allocated_qty;
				$log_data['available_qty'] = $log_available_qty;
				$log_data['dyed_type'] = $dyed_type;
				$log_data['insert_date'] = $pc_date_time;
				$allocation_log = manage_allocation_transaction_log($log_data);
				//end for transaction log
				if($allocation_log)
				{
					oci_commit($con);
					echo "2**" . str_replace("'", "", $txt_system_no) . "**" . $id. "**" . str_replace("'", "", $cbo_knitting_company);
				}
				else
				{
					oci_rollback($con);
					echo "10**" . str_replace("'", "", $txt_system_no) . "**" . $id. "**" . str_replace("'", "", $cbo_knitting_company);
				}
			}
			else
			{
				oci_rollback($con);
				echo "10**" . str_replace("'", "", $txt_system_no) . "**" . $id. "**" . str_replace("'", "", $cbo_knitting_company);
			}
		}
		disconnect($con);
		die;
	}

}

if ($action == "mrr_popup")
{
	echo load_html_head_contents("Popup Info", "../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		function js_set_value(sys_number) {
            $("#hidden_sys_number").val(sys_number); // mrr number
            parent.emailwindow.hide();
        }
    </script>

	</head>
	<body>
	<div align="center" style="width:100%;">
		<form name="searchorderfrm_1" id="searchorderfrm_1" autocomplete="off">
			<table width="880" cellspacing="0" cellpadding="0" border="1" class="rpt_table" align="center" rules="all">
				<thead>
					<tr>
						<th width="150">Supplier</th>
						<th width="150">Search By</th>

						<th width="250" align="center" id="search_by_td_up">Enter Issue Number</th>
						<th width="200">Date Range</th>
						<th><input type="reset" name="re_button" id="re_button" value="Reset" style="width:100px"
							class="formbutton"/></th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td>
								<?
								echo create_drop_down("cbo_supplier", 150, "select c.supplier_name,c.id from lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and b.party_type=2 and c.status_active=1 and c.is_deleted=0 group by c.id, c.supplier_name order by supplier_name", "id,supplier_name", 1, "-- Select --", 0, "", 0);
								?>
							</td>
							<td>
								<?
								$search_by = array(1 => 'Issue No', 2 => 'Challan No', 3 => 'In House', 4 => 'Out Bound Subcontact', 5 => 'Job No', 6 => 'Wo No', 7 => 'Buyer', 8=>'Requisition No', 9=>'Program No');
								$dd = "change_search_event(this.value, '0*0*1*1*0*0*1*0*0', '0*0*select id,company_name from lib_company where status_active=1 and is_deleted=0 order by company_name*select c.id, c.supplier_name from lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and b.party_type=2 and c.status_active=1 and c.is_deleted=0 group by c.id, c.supplier_name order by supplier_name*0*0*select buy.id, buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company=$company $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buy.buyer_name', '../../') ";
								echo create_drop_down("cbo_search_by", 150, $search_by, "", 0, "--Select--", "", $dd, 0);
								?>
							</td>
							<td width="" align="center" id="search_by_td">
								<input type="text" style="width:230px" class="text_boxes" name="txt_search_common"
								id="txt_search_common"/>
							</td>
							<td align="center">
								<input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:70px"
								placeholder="From Date"/>
								<input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:70px"
								placeholder="To Date"/>
							</td>
							<td align="center">
								<input type="button" name="btn_show" class="formbutton" value="Show"
								onClick="show_list_view ( document.getElementById('cbo_supplier').value+'_'+document.getElementById('cbo_search_by').value+'_'+document.getElementById('txt_search_common').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+<? echo $company; ?>+'_'+document.getElementById('cbo_year_selection').value,'create_mrr_search_list_view', 'search_div', 'yarn_issue_controller', 'setFilterGrid(\'list_view\',-1)')"
								style="width:100px;"/>
							</td>
						</tr>
						<tr>
							<td align="center" height="40" valign="middle" colspan="5">
								<? echo load_month_buttons(1); ?>
								<!-- Hidden field here-->
								<input type="hidden" id="hidden_sys_number" value=""/>
								<!-- END -->
							</td>
						</tr>
					</tbody>
				</table>
				<div align="center" valign="top" id="search_div"></div>
			</form>
		</div>
	</body>
	<script src="../../includes/functions_bottom.js" type="text/javascript"></script>

	</html>
	<?
	exit();
}

if ($action == "create_mrr_search_list_view")
{
	$ex_data = explode("_", $data);
	$supplier = $ex_data[0];
	$txt_search_by = $ex_data[1];
	$txt_search_common = trim($ex_data[2]);
	$fromDate = $ex_data[3];
	$toDate = $ex_data[4];
	$company = $ex_data[5];
	$search_year = $ex_data[6];
	$sql_cond = "";

	if ($fromDate != "" && $toDate != "")
	{
		if ($db_type == 0) {
			$sql_cond .= " and issue_date between '" . change_date_format($fromDate, 'yyyy-mm-dd') . "' and '" . change_date_format($toDate, 'yyyy-mm-dd') . "'";
		} else {
			$sql_cond .= " and issue_date between '" . change_date_format($fromDate, '', '', 1) . "' and '" . change_date_format($toDate, '', '', 1) . "'";
		}
	}

	if (trim($search_year) != 0)
	{
		$year_cond = " AND TO_CHAR(a.INSERT_DATE,'YYYY') = ".$search_year;
	}
	else $year_cond = "";

	if ($supplier != "" && $supplier * 1 != 0) $sql_cond .= " and a.supplier_id='$supplier'";
	if ($company != "" && $company * 1 != 0) $sql_cond .= " and a.company_id='$company'";

	$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
	$company_arr = return_library_array("select id, company_name from lib_company", 'id', 'company_name');
	$buyer_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$within_group_arr = return_library_array("select id, within_group from fabric_sales_order_mst", 'id', 'within_group');
	$floor_room_rack_arr = return_library_array("select floor_room_rack_id, floor_room_rack_name from lib_floor_room_rack_mst", 'floor_room_rack_id', 'floor_room_rack_name');

	if ($txt_search_common != "" || $txt_search_common != 0) {
		if ($txt_search_by == 1) {
			$sql_cond .= " and a.issue_number like '%$txt_search_common%'";
		} else if ($txt_search_by == 2) {
			$sql_cond .= " and a.challan_no like '%$txt_search_common%'";
		} else if ($txt_search_by == 3) {
			$sql_cond .= " and a.knit_dye_source=1 and a.knit_dye_company='$txt_search_common'";
		} else if ($txt_search_by == 4) {
			$sql_cond .= " and a.knit_dye_source=2 and a.knit_dye_company='$txt_search_common'";
		} else if ($txt_search_by == 5) {
			$sql_cond .= " and a.buyer_job_no like '%$txt_search_common%'";
		} else if ($txt_search_by == 6) {
			$sql_cond .= " and a.booking_no like '%$txt_search_common%'";
		} else if ($txt_search_by == 7) {
			$sql_cond .= " and a.buyer_id = '$txt_search_common'";
		}
		else if ($txt_search_by == 8) {
			$sql_cond .= " and b.requisition_no = '$txt_search_common'";
		}
		else if ($txt_search_by == 9) {
			$sql_cond .= " and c.knit_id = '$txt_search_common'";
		}
	}

	if ($db_type == 0) $year_field = "YEAR(a.insert_date) as year,";
	else if ($db_type == 2) $year_field = "to_char(a.insert_date,'YYYY') as year,";
	else $year_field = "";

	if($user_store_ids) $user_store_cond = " and b.store_id in ($user_store_ids)"; else $user_store_cond = "";

	if ($db_type == 0) {
		$sql = "select a.id, a.issue_number_prefix_num, a.issue_number, a.issue_basis, a.issue_purpose, a.entry_form, a.item_category, a.company_id, a.location_id, a.supplier_id, a.store_id, a.buyer_id, a.buyer_job_no, a.style_ref, a.booking_id, a.booking_no, a.issue_date, a.sample_type, a.knit_dye_source, a.knit_dye_company, a.challan_no, a.loan_party, a.lap_dip_no, a.gate_pass_no, a.item_color, a.color_range, a.remarks, a.ready_to_approve, a.loan_party,a.is_posted_account , $year_field a.is_approved,sum(b.cons_quantity) issue_quantity from inv_issue_master a,inv_transaction b where a.id=b.mst_id and b.transaction_type=2 and b.item_category=1 and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and a.entry_form=3 $sql_cond $user_store_cond $year_cond group by a.id order by a.issue_number DESC";
	}else{

		// $sql = "select a.id, a.issue_number_prefix_num, a.issue_number, a.issue_basis, a.issue_purpose, a.entry_form, a.item_category, a.company_id, a.location_id, a.supplier_id, a.store_id, a.buyer_id, a.buyer_job_no, a.style_ref, a.booking_id, a.booking_no, a.issue_date, a.sample_type, a.knit_dye_source, a.knit_dye_company, a.challan_no, a.loan_party, a.lap_dip_no, a.gate_pass_no, a.item_color, a.color_range, a.remarks, a.ready_to_approve, a.loan_party,a.is_posted_account , $year_field a.is_approved,sum(b.cons_quantity) issue_quantity from inv_issue_master a,inv_transaction b where a.id=b.mst_id and b.transaction_type=2 and b.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.entry_form=3 $sql_cond $user_store_cond $year_cond group by a.id, a.issue_number_prefix_num, a.issue_number, a.issue_basis, a.issue_purpose, a.entry_form, a.item_category, a.company_id, a.location_id, a.supplier_id, a.store_id, a.buyer_id, a.buyer_job_no, a.style_ref, a.booking_id, a.booking_no, a.issue_date, a.sample_type, a.knit_dye_source, a.knit_dye_company, a.challan_no, a.loan_party, a.lap_dip_no, a.gate_pass_no, a.item_color, a.color_range, a.remarks, a.ready_to_approve, a.loan_party,a.insert_date,a.is_posted_account,a.is_approved order by a.issue_number DESC";

		$sql = "select a.id, a.issue_number_prefix_num, a.issue_number,b.requisition_no, c.KNIT_ID as program_no, a.issue_basis, a.issue_purpose, a.entry_form, a.item_category, a.company_id, a.location_id, a.supplier_id, a.store_id, a.buyer_id, a.buyer_job_no, a.style_ref, a.booking_id, a.booking_no, a.issue_date, a.sample_type, a.knit_dye_source, a.knit_dye_company, a.challan_no, a.loan_party, a.lap_dip_no, a.gate_pass_no, a.item_color, a.color_range, a.remarks, a.ready_to_approve, a.loan_party,a.is_posted_account , $year_field a.is_approved,sum(b.cons_quantity) issue_quantity from inv_issue_master a,inv_transaction b LEFT JOIN PPL_YARN_REQUISITION_ENTRY c ON b.REQUISITION_NO = c.REQUISITION_NO where a.id=b.mst_id and b.transaction_type=2 and b.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.entry_form=3 $sql_cond $user_store_cond $year_cond group by a.id, a.issue_number_prefix_num, a.issue_number, a.issue_basis, a.issue_purpose, a.entry_form, a.item_category, a.company_id, a.location_id, a.supplier_id, a.store_id, a.buyer_id, a.buyer_job_no, a.style_ref, a.booking_id, a.booking_no, a.issue_date, a.sample_type, a.knit_dye_source, a.knit_dye_company, a.challan_no, a.loan_party, a.lap_dip_no, a.gate_pass_no, a.item_color, a.color_range, a.remarks, a.ready_to_approve, a.loan_party,a.insert_date,a.is_posted_account,a.is_approved, b.requisition_no, c.KNIT_ID order by a.issue_number DESC";

	}
	// echo $sql;
	$result = sql_select($sql);
	?>
	<div style="margin-top:5px">
		<div style="width:100%;">
			<table cellspacing="0" cellpadding="0" width="1250px" class="rpt_table" border="1" rules="all">
				<thead>
					<th width="30">SL</th>
					<th width="60">Issue No</th>
					<th width="50">Year</th>
					<th width="70">Date</th>
					<th width="100">Purpose</th>
					<th width="70">Challan No</th>
					<th width="60">Issue Qnty</th>
					<th width="110">Booking No</th>
					<th width="100">knitting Comp.</th>
					<th width="115">Buyer</th>
					<th width="85">Job No.</th>
					<th width="85">Requisition No.</th>
					<th width="85">Program No.</th>
					<th width="90">Store</th>
					<th>Ready to Approve</th>
				</thead>
			</table>
		</div>
		<div style="width:1250px;overflow-y:scroll; max-height:210px;" id="search_div">
			<table cellspacing="0" cellpadding="0" width="1250px" class="rpt_table" id="list_view" border="1" rules="all">
				<?php
				$i = 1;
				foreach ($result as $row)
				{
					if ($i % 2 == 0)
						$bgcolor = "#E9F3FF";
					else
						$bgcolor = "#FFFFFF";

					if ($row[csf("issue_basis")] == 4)
					{
						if ($within_group_arr[$row[csf("booking_id")]] == 1)
						{
							$buyer = $company_arr[$row[csf("buyer_id")]];
						}
						else
						{
							$buyer = $buyer_arr[$row[csf("buyer_id")]];
						}
					}
					else
					{
						$buyer = $buyer_arr[$row[csf("buyer_id")]];
					}

					if($row[csf("is_approved")]==3)
					{
						$is_approved=1;
					}
					else
					{
						$is_approved=$row[csf("is_approved")];
					}
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
						onclick="js_set_value('<? echo $row[csf("issue_number")]; ?>,<? echo $is_approved; ?>,<? echo $row[csf("id")]; ?>,<? echo $within_group_arr[$row[csf("booking_id")]] . "," . $row[csf("buyer_id")] . "," . $buyer . "," . $row[csf("is_posted_account")]; ?>,<?php echo $row['SUPPLIER_ID']; ?>   ');">
						<td width="30"><?php echo $i; ?></td>
						<td width="60"><p><?php echo $row[csf("issue_number_prefix_num")]; ?></p></td>
						<td width="50"><p><?php echo $row[csf("year")]; ?></p></td>
						<td width="70"><p><?php echo change_date_format($row[csf("issue_date")]); ?></p></td>
						<td width="100"><p><?php echo $yarn_issue_purpose[$row[csf("issue_purpose")]]; ?></p></td>
						<td width="70"><p><?php echo $row[csf("challan_no")]; ?>&nbsp;</p></td>
						<td width="60" align="right"><?php echo number_format($row[csf("issue_quantity")], 2, '.', ''); ?></p></td>
						<td width="110"><p><?php echo $row[csf("booking_no")]; ?></p></td>
						<td width="100">
							<p>
								<?php
								if ($row[csf("knit_dye_source")] == 1) $knit_com = $company_arr[$row[csf("knit_dye_company")]];
								else $knit_com = $supplier_arr[$row[csf("knit_dye_company")]];
								echo $knit_com;
								?>
							</p>
						</td>
						<td width="115"><p><?php echo $buyer; ?>&nbsp;</p></td>
						<td width="85"><p><?php echo $floor_room_rack_arr[$row[csf("buyer_job_no")]]; ?>&nbsp;</p></td>
						<td width="85"><p><?php echo $row[csf("requisition_no")]; ?>&nbsp;</p></td>
						<td width="85"><p><?php echo $row[csf("program_no")]; ?>&nbsp;</p></td>
						<td width="90"><p><?php echo $floor_room_rack_arr[$store_arr[$row[csf("store_id")]]]; ?></p></td>
						<td>
                            <p><?php echo $yes_no[$row[csf("ready_to_approve")]]; //if($row[csf("ready_to_approve")]!=1) else echo "";
                            ?>&nbsp;</p></td>
                    </tr>
                    <?php
                    $i++;
                }
                ?>
                </table>
            </div>
        </div>
        <?
	exit();
}

if ($action == "populate_data_from_data")
{
	$sql = "select id, issue_number, issue_basis, issue_purpose, entry_form, item_category, company_id, location_id, supplier_id, store_id, buyer_id, buyer_job_no, style_ref, booking_id, booking_no,service_booking_no, issue_date, sample_type, knit_dye_source, knit_dye_company, challan_no, loan_party, lap_dip_no, gate_pass_no, item_color, color_range, remarks, ready_to_approve, loan_party, is_approved, attention
	from inv_issue_master
	where id='$data' and entry_form=3";
	//echo $sql;
	$res = sql_select($sql);
	foreach ($res as $row) {
		echo "$('#cbo_company_id').val(" . $row[csf("company_id")] . ");\n";
		echo "$('#update_id_mst').val(" . $row[csf("id")] . ");\n";
		echo "$('#cbo_basis').val(" . $row[csf("issue_basis")] . ");\n";
		echo "$('#saved_knitting_company').val(" . $row[csf("knit_dye_company")] . ");\n";
		echo "load_drop_down('requires/yarn_issue_controller', '" . $row[csf("issue_basis")] . "_1', 'load_drop_down_purpose', 'issue_purpose_td');";
		echo "$('#cbo_issue_purpose').val(" . $row[csf("issue_purpose")] . ");\n";
		echo "load_supplier();\n";
		echo "active_inactive();\n";
		echo "disable_enable_fields( 'cbo_company_id*cbo_basis', 1, '', '');\n";
		echo "$('#txt_issue_date').val('" . change_date_format($row[csf("issue_date")]) . "');\n";
		echo "$('#txt_booking_id').val(" . $row[csf("booking_id")] . ");\n";
		echo "$('#txt_booking_no').val('" . $row[csf("booking_no")] . "');\n";
		echo "$('#txt_service_booking_no').val('" . $row[csf("service_booking_no")] . "');\n";
		echo "$('#cbo_knitting_source').val(" . $row[csf("knit_dye_source")] . ");\n";

		if ($row[csf("knit_dye_source")] != 0) {
			echo "load_drop_down( 'requires/yarn_issue_controller', " . $row[csf("knit_dye_source")] . "+'**'+" . $row[csf("company_id")]. "+'**'+" .$row[csf("issue_purpose")].  ", 'load_drop_down_knit_com', 'knitting_company_td' );\n";
		}

		echo"load_drop_down( 'requires/yarn_issue_controller', ".$row[csf("knit_dye_company")]."+'_'+".$row[csf("knit_dye_source")].", 'load_drop_down_location', 'location_td' );\n";

		echo "$('#cbo_location_id').val(" . $row[csf("location_id")] . ");\n";

		if ( $row[csf("issue_basis")] == 1 && ($row[csf("issue_purpose")] == 2 || $row[csf("issue_purpose")] == 7 || $row[csf("issue_purpose")] == 12 || $row[csf("issue_purpose")] == 15 || $row[csf("issue_purpose")] == 38 || $row[csf("issue_purpose")] == 44 || $row[csf("issue_purpose")] == 46 || $row[csf("issue_purpose")] == 50 || $row[csf("issue_purpose")] == 51 ) )
		{
			$entry_form = return_field_value("entry_form", "wo_yarn_dyeing_mst", "id='" . $row[csf("booking_id")] . "'");
		}

		if ($row[csf("issue_purpose")] == 2)
		{

			if ($entry_form == 42) {
				echo "$('#txt_issue_qnty').attr('placeholder','Entry');\n";
				echo "$('#txt_issue_qnty').removeAttr('ondblclick');\n";
				echo "$('#txt_issue_qnty').removeAttr('readOnly');\n";
				echo "$('#txt_returnable_qty').removeAttr('readOnly');\n";
				echo "$('#txt_returnable_qty').attr('placeholder','Entry');\n";
			} else {
				echo "$('#txt_issue_qnty').attr('placeholder','Double Click');\n";
				echo "$('#txt_issue_qnty').attr('ondblclick','openmypage_po()');\n";
				echo "$('#txt_issue_qnty').attr('readOnly',true);\n";
				echo "$('#txt_returnable_qty').attr('readOnly',true);\n";
				echo "$('#txt_returnable_qty').attr('placeholder','Display');\n";
			}

			echo "show_list_view('" . $row[csf("booking_id")] . "','show_yarn_dyeing_list_view','requisition_item','requires/yarn_issue_controller','');\n";
			echo "load_drop_down( 'requires/yarn_issue_controller','" . $row[csf("booking_id")] . "','load_drop_down_dyeing_color', 'dyeingColor_td' );\n";
		} else {
			echo "load_drop_down( 'requires/yarn_issue_controller','0','load_drop_down_dyeing_color', 'dyeingColor_td' );\n";
		}

		echo "$('#txt_entry_form').val(" . $entry_form . ");\n";
		echo "$('#cbo_knitting_company').val(" . $row[csf("knit_dye_company")] . ");\n";

		echo "$('#cbo_supplier').val(" . $row[csf("supplier_id")] . ");\n";
		echo "$('#txt_challan_no').val('" . $row[csf("challan_no")] . "');\n";
		echo "$('#cbo_loan_party').val(" . $row[csf("loan_party")] . ");\n";
		echo "$('#cbo_sample_type').val(" . $row[csf("sample_type")] . ");\n";
		echo "$('#cbo_buyer_name').val(" . $row[csf("buyer_id")] . ");\n";
		echo "$('#txt_style_ref').val('" . $row[csf("style_ref")] . "');\n";
		echo "$('#txt_buyer_job_no').val('" . $row[csf("buyer_job_no")] . "');\n";
		echo "$('#txt_remarks').val('" . $row[csf("remarks")] . "');\n";
		echo "$('#cbo_ready_to_approved').val(" . $row[csf("ready_to_approve")] . ");\n";
		echo "$('#txt_attention').val('".$row[csf("attention")]."');\n";

		//clear child form
		echo "$('#tbl_child').find('select,input').not('#issue_view').val('');\n";
		if($row[csf("is_approved")]==3){
			$is_approved=1;
		}else{
			$is_approved=$row[csf("is_approved")];
		}
		if ($is_approved == 1) {
			echo "$('#approved').text('Approved');\n";
		} else {
			echo "$('#approved').text('');\n";
		}
	}
	exit();
}

if ($action == "show_dtls_list_view")
{
	$ex_data = explode("**", $data);
	$up_id = $ex_data[0];

	$cond = "";
	if ($up_id != "") $cond .= " and a.id='$up_id'";
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$yarn_count_arr = return_library_array("select id, yarn_count from lib_yarn_count", 'id', 'yarn_count');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$supplier_arr = return_library_array("select id, short_name from lib_supplier", 'id', 'short_name');
	$company_arr = return_library_array("select id, company_short_name from lib_company", 'id', 'company_short_name');
	$floor_room_rack_arr = return_library_array("select floor_room_rack_id, floor_room_rack_name from lib_floor_room_rack_mst", 'floor_room_rack_id', 'floor_room_rack_name');

	$sql = "select a.challan_no,a.knit_dye_company,b.requisition_no,c.yarn_count_id, c.yarn_comp_type1st, c.yarn_comp_percent1st, c.yarn_comp_type2nd, c.yarn_comp_percent2nd, c.yarn_type, c.color, c.lot, b.id, b.company_id, b.store_id, b.cons_uom, b.cons_quantity, b.cons_amount, b.rack, b.self, b.supplier_id, c.is_within_group, b.no_of_bags
	from inv_issue_master a, inv_transaction b, product_details_master c
	where a.id=b.mst_id and b.prod_id=c.id and b.transaction_type=2 and b.item_category=1 and a.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond";
	//echo $sql;
	$result = sql_select($sql);
	$i = 1;
	$total_qnty = 0;
	?>
	<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="970" rules="all">
		<thead>
			<tr>
				<th>SL</th>
				<th>Challan No</th>
				<th>Lot No</th>
				<th>Supplier</th>
				<th>Yarn Count</th>
				<th>Composition</th>
				<th>Yarn Type</th>
				<th>Color</th>
				<th>Store</th>
				<th>Issue Qnty</th>
				<th>UOM</th>
				<th>No of Bag</th>
				<th>Req. No</th>
				<th>Rack</th>
				<th>Shelf</th>
			</tr>
		</thead>
		<tbody>
			<? foreach ($result as $row) {

				if ($i % 2 == 0) $bgcolor = "#E9F3FF";
				else $bgcolor = "#FFFFFF";

				$composition_string = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')];
				if ($row[csf('yarn_comp_type2nd')] != 0)
					$composition_string .= " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')];

				$total_qnty += $row[csf("cons_quantity")];

				//for supplier
				if($row[csf('is_within_group')] == 1)
				{
					$supplier_name = $company_arr[$row[csf('supplier_id')]];
				}
				else
				{
					$supplier_name = $supplier_arr[$row[csf('supplier_id')]];
				}
				?>
				<tr bgcolor="<? echo $bgcolor; ?>"
					onClick='get_php_form_data("<? echo $row[csf("id")]. "_" . $row[csf("company_id")]; ?>","child_form_input_data","requires/yarn_issue_controller")'
					style="cursor:pointer">
					<td width="30"><?php echo $i; ?></td>
					<td width="70"><p><?php echo $row[csf("challan_no")]; ?>&nbsp;</p></td>
					<td width="70"><p><?php echo $row[csf("lot")]; ?></p></td>
					<td width="70"><p><?php echo $supplier_name; ?></p></td>
					<td width="70"><p><?php echo $yarn_count_arr[$row[csf("yarn_count_id")]]; ?></p></td>
					<td width="120"><p><?php echo $composition_string; ?></p></td>
					<td width="70"><p><?php echo $yarn_type[$row[csf("yarn_type")]]; ?></p></td>
					<td width="80"><p><?php echo $color_name_arr[$row[csf("color")]]; ?></p></td>
					<td width="80"><p><?php echo $store_arr[$row[csf("store_id")]]; ?></p></td>
					<td width="70" align="right"><p><?php echo number_format($row[csf("cons_quantity")], 2, '.', ''); ?></p>
					</td>
					<td width="50"><p><?php echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></p></td>
					<td width="50"><p><?php echo $row[csf("no_of_bags")]; ?></p></td>
					<td width="60"><p><?php echo $row[csf("requisition_no")]; ?>&nbsp;</p></td>
					<td width="50"><p><?php echo $floor_room_rack_arr[$row[csf("rack")]]; ?>&nbsp;</p></td>
					<td><p><?php echo $floor_room_rack_arr[$row[csf("self")]]; ?>&nbsp;</p></td>
				</tr>
				<? $i++;
			} ?>
			<tfoot>
				<th colspan="9" align="right">Total</th>
				<th><?php echo number_format($total_qnty,2); ?></th>
				<th>&nbsp;</th>
				<th>&nbsp;</th>
				<th>&nbsp;</th>
				<th>&nbsp;</th>
				<th>&nbsp;</th>
			</tfoot>
		</tbody>
	</table>
	<?

	exit();
}

if ($action == "child_form_input_data")
{

	$exp_data = explode("_", str_replace("'", "", $data));
	$rcv_dtls_id = $exp_data[0];
	$companyId = $exp_data[1];

	$brand_arr = return_library_array("select id, brand_name from lib_brand where status_active=1 and is_deleted=0", 'id', 'brand_name');

	$sql = "SELECT a.company_id, a.issue_basis, a.issue_purpose,a.id as issue_id, a.booking_id, a.knit_dye_company, b.requisition_no, b.id, b.store_id, b.supplier_id, b.cons_uom, b.cons_quantity, b.return_qnty, b.item_return_qty, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, b.dyeing_color_id, b.room, b.rack, b.self,b.floor_id, b.bin_box, b.using_item, b.job_no, b.demand_id, b.demand_no, b.remarks, c.current_stock, c.allocated_qnty, c.available_qnty, c.yarn_count_id, c.yarn_comp_type1st, c.yarn_comp_percent1st, c.yarn_comp_type2nd, c.yarn_comp_percent2nd, c.yarn_type, c.color, c.brand, c.lot, c.id as prod_id, b.btb_lc_id,b.wo_id,b.pi_wo_batch_no,(select sum(d.yarn_qnty)
	from ppl_yarn_requisition_entry d where b.requisition_no=d.requisition_no and c.id=d.prod_id and d.status_active=1) yarn_qnty
	from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and b.prod_id=c.id and b.id='$rcv_dtls_id' and b.transaction_type=2 and b.item_category=1";
	//echo $sql;die;
	$result = sql_select($sql);
	foreach ($result as $row)
	{
		$product_id_arr[] = $row[csf("prod_id")];
		$product_store_id_arr[] = $row[csf("store_id")];
		$trans_arr[] = $row[csf("id")];
	}
	$trans_cond = (!empty($trans_arr))?" and trans_id in(".implode(",",$trans_arr).")":"";
	$order_wise_sql = sql_select("select trans_id,po_breakdown_id, quantity, returnable_qnty from order_wise_pro_details where entry_form=3 and trans_type=2 and status_active=1 $trans_cond");
	foreach ($order_wise_sql as $order_row) {
		$order_wise_arr[$order_row[csf("trans_id")]] = $order_row[csf("po_breakdown_id")]."**".$order_row[csf("quantity")]."**".$order_row[csf("returnable_qnty")];
	}

	$prod_cond = !empty($product_id_arr)?" and prod_id in(".implode(",",$product_id_arr).")":"";
	$store_cond = !empty($product_store_id_arr)?" and store_id in(".implode(",",$product_store_id_arr).")":"";
	$store_wise_sql = sql_select("select prod_id,store_id,sum((case when transaction_type in(1,4,5) then cons_quantity else 0 end)- (case when transaction_type in(2,3,6) then cons_quantity else 0 end)) as balance_qnty from inv_transaction where item_category=1 and company_id=$companyId $prod_cond $store_cond and status_active=1 and is_deleted=0 group by prod_id,store_id");

	foreach ($store_wise_sql as $store_row) {
		$product_store_arr[$store_row[csf("prod_id")]][$store_row[csf("store_id")]] += $store_row[csf("balance_qnty")];
	}

	if($db_type==0)
	{
		$all_store = sql_select("select group_concat(distinct(store_id)) as store_id from inv_transaction where item_category=1 and transaction_type in(1,4,5) $prod_cond");
	}else{
		$all_store = sql_select("select LISTAGG(store_id, ',') WITHIN GROUP (ORDER BY store_id) as store_id from inv_transaction where item_category=1 and transaction_type in(1,4,5) $prod_cond");
	}

	$store_id = $all_store[0][csf('store_id')];
	$dyeing_color_id = $all_store[0][csf('dyeing_color_id')];

	$load_store_dropdown = return_library_array("select id, store_name from lib_store_location where id in ($store_id)", 'id', 'store_name');

	echo "$('#store_td').html('" . create_drop_down("cbo_store_name", 142, $load_store_dropdown, "", 1, "-- Select Store --", 0, "fn_empty_lot(this.value);", 0) . "');\n";

	echo "load_supplier();\n";
	$customer_buyer_sql = sql_select("SELECT  a.REQUISITION_NO,c.customer_buyer from PPL_YARN_REQUISITION_ENTRY a, PPL_PLANNING_ENTRY_PLAN_DTLS b, FABRIC_SALES_ORDER_MST c where a.knit_id = b.dtls_id and b.po_id = c.id");
	foreach($customer_buyer_sql as $value)
	{
		$custbuyer_arr[$value['REQUISITION_NO']]['CUST_BUYER'] = $value['CUSTOMER_BUYER'];
	}

	foreach ($result as $row)
	{

		if ($row[csf("issue_basis")] == 3)
		{
			echo "$('#txt_req_no').val(" . $row[csf("requisition_no")] . ");\n";
		}
		else if($row[csf("issue_basis")] == 8)
		{
			echo "$('#txt_req_no').val('" . $row[csf("demand_no")] . "');\n";
			echo "$('#demand_id').val('" . $row[csf("demand_id")] . "');\n";
			echo "$('#hdn_req_no').val(" . $row[csf("requisition_no")] . ");\n";

			//for demand basis
			$sql_dmnd = sql_select("SELECT ID FROM PPL_YARN_DEMAND_REQSN_DTLS WHERE PROD_ID = ".implode(",",$product_id_arr)." AND MST_ID = ".$row[csf("demand_id")]."");
			$dreq_id = '';
			foreach($sql_dmnd as $drow)
			{
				$dreq_id = $drow['ID'];
			}
			echo "$('#hdn_dmnd_req_id').val('" . $dreq_id . "');\n";
		}

		if ($row[csf("issue_basis")] == 3 || $row[csf("issue_basis")] == 8)
		{
			echo "show_list_view('" . $row[csf("requisition_no")] . "," . $row[csf("company_id")] . ",0," . $row[csf("demand_id")] . "," . $row[csf("issue_basis")] . "','show_req_list_view','requisition_item','requires/yarn_issue_controller','');\n";
		}

		if($custbuyer_arr[$row["REQUISITION_NO"]]["CUST_BUYER"])
		{
			echo "$('#cbo_buyer_name').val('" .$custbuyer_arr[$row["REQUISITION_NO"]]["CUST_BUYER"]. "');\n";
		}

		echo "$('#txt_lot_no').val('" . $row[csf("lot")] . "');\n";
		echo "$('#txt_prod_id').val(" . $row[csf("prod_id")] . ");\n";
		echo "$('#txt_issue_qnty').val(" . $row[csf("cons_quantity")] . ");\n";
		echo "$('#hidden_p_issue_qnty').val(" . $row[csf("cons_quantity")] . ");\n";
		echo "$('#txt_returnable_qty').val('" . number_format($row[csf("return_qnty")], 2, '.', '') . "');\n";
		echo "$('#extra_quantity').val(" . $row[csf("item_return_qty")] . ");\n";
		$txt_prod_id = $row[csf("prod_id")];
		$store_name = $row[csf("store_id")];
		$stock_qnty = $product_store_arr[$txt_prod_id][$store_name];

		echo "$('#txt_current_stock').val(" . $stock_qnty . ");\n";
		echo "$('#txt_no_bag').val(" . $row[csf("no_of_bags")] . ");\n";
		echo "$('#cbo_supplier_lot').val(" . $row[csf("supplier_id")] . ");\n";
		echo "$('#txt_no_cone').val(" . $row[csf("cone_per_bag")] . ");\n";
		echo "$('#txt_weight_per_bag').val(" . $row[csf("weight_per_bag")] . ");\n";
		echo "$('#txt_weight_per_cone').val(" . $row[csf("weight_per_cone")] . ");\n";
		echo "$('#cbo_store_name').val(" . $row[csf("store_id")] . ");\n";
		echo "$('#txt_remarks_dtls').val('" . $row[csf("remarks")] . "');\n";

		echo "load_room_rack_self_bin('requires/yarn_issue_controller', 'floor','floor_td', '".$row[csf('company_id')]."','"."','".$row[csf('store_id')]."',this.value);\n";
		echo "$('#cbo_yarn_count').val(" . $row[csf("yarn_count_id")] . ");\n";
		echo "$('#hdn_composition_id').val(" . $row[csf("yarn_comp_type1st")] . ");\n";

		$composition_string = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')];
		if ($row[csf('yarn_comp_type2nd')] != 0) $composition_string .= " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')];
		echo "$('#txt_composition').val('" . $composition_string . "');\n";
		echo "$('#txt_composition_id').val('" . $row[csf("yarn_comp_type1st")] . "');\n";
		echo "$('#txt_composition_percent').val('" . $row[csf("yarn_comp_percent1st")] . "');\n";
		echo "$('#cbo_yarn_type').val('" . $row[csf("yarn_type")] . "');\n";
		echo "$('#cbo_color').val(" . $row[csf("color")] . ");\n";
		echo "$('#cbo_brand').html('<option value=\'" . $row[csf("brand")] . "\'>" . $brand_arr[$row[csf("brand")]] . "</option>');\n";

		echo "load_drop_down( 'requires/yarn_issue_controller'," . $row[csf("booking_id")] . "+'_0'+'_'+" . $row[csf("dyeing_color_id")] . ",'load_drop_down_dyeing_color', 'dyeingColor_td' );\n";

		echo "$('#cbo_dyeing_color').val('" . $row[csf("dyeing_color_id")] . "');\n";
		echo "$('#cbo_uom').val(" . $row[csf("cons_uom")] . ");\n";

		// ==================================================================================
		echo "load_room_rack_self_bin('requires/yarn_issue_controller*1', 'store','store_td', '".$row[csf('company_id')]."','".$row[csf('location_id')]."',this.value);\n";
		echo "$('#cbo_store_name').val(".$row[csf("store_id")].");\n";

		echo "load_room_rack_self_bin('requires/yarn_issue_controller', 'floor','floor_td', '".$row[csf('company_id')]."','".$row[csf('location_id')]."','".$row[csf('store_id')]."',this.value);\n";
		echo "$('#cbo_floor').val('".$row[csf("floor_id")]."');\n";
		echo "load_room_rack_self_bin('requires/yarn_issue_controller', 'room','room_td', '".$row[csf('company_id')]."','".$row[csf('location_id')]."','".$row[csf('store_id')]."','".$row[csf('floor_id')]."',this.value);\n";
		echo "$('#cbo_room').val('".$row[csf("room")]."');\n";
		echo "load_room_rack_self_bin('requires/yarn_issue_controller', 'rack','rack_td', '".$row[csf('company_id')]."','".$row[csf('location_id')]."','".$row[csf('store_id')]."','".$row[csf('floor_id')]."','".$row[csf('room')]."',this.value);\n";
		echo "$('#txt_rack').val('".$row[csf("rack")]."');\n";
		echo "load_room_rack_self_bin('requires/yarn_issue_controller', 'shelf','shelf_td', '".$row[csf('company_id')]."','".$row[csf('location_id')]."','".$row[csf('store_id')]."','".$row[csf('floor_id')]."','".$row[csf('room')]."','".$row[csf('rack')]."',this.value);\n";
		echo "$('#txt_shelf').val('".$row[csf("self")]."');\n";
		echo "load_room_rack_self_bin('requires/yarn_issue_controller', 'bin','bin_td', '".$row[csf('company_id')]."','".$row[csf('location_id')]."','".$row[csf('store_id')]."','".$row[csf('floor_id')]."','".$row[csf('room')]."','".$row[csf('rack')]."','".$row[csf('self')]."',this.value);\n";
		echo "$('#cbo_bin').val('".$row[csf("bin_box")]."');\n";
		echo "$('#cbo_store_name').attr('disabled','disabled');\n";
		echo "$('#cbo_floor').attr('disabled','disabled');\n";
		echo "$('#cbo_room').attr('disabled','disabled');\n";
		echo "$('#txt_rack').attr('disabled','disabled');\n";
		echo "$('#txt_shelf').attr('disabled','disabled');\n";
		echo "$('#cbo_bin').attr('disabled','disabled');\n";
		// ==================================================================================
		/*echo "$('#cbo_floor').val(" . $row[csf("floor_id")] . ");\n";
		echo "load_room_rack_self_bin('requires/yarn_issue_controller', 'room','room_td', '".$row[csf('company_id')]."','"."','".$row[csf('store_id')]."','".$row[csf('floor_id')]."',this.value);\n";
		echo "$('#cbo_room').val(" . $row[csf("room")] . ");\n";
		echo "load_room_rack_self_bin('requires/yarn_issue_controller', 'rack','rack_td', '".$row[csf('company_id')]."','"."','".$row[csf('store_id')]."','".$row[csf('floor_id')]."','".$row[csf('room')]."',this.value);\n";
		echo "$('#txt_rack').val(" . $row[csf("rack")] . ");\n";
		echo "load_room_rack_self_bin('requires/yarn_issue_controller', 'shelf','shelf_td', '".$row[csf('company_id')]."','"."','".$row[csf('store_id')]."','".$row[csf('floor_id')]."','".$row[csf('room')]."','".$row[csf('rack')]."',this.value);\n";
		echo "$('#txt_shelf').val(" . $row[csf("self")] . ");\n";*/

		echo "$('#saved_knitting_company').val(" . $row[csf("knit_dye_company")] . ");\n";
		echo "$('#cbo_item').val(" . $row[csf("using_item")] . ");\n";
		echo "$('#job_no').val('" . $row[csf("job_no")] . "');\n";
		echo "$('#hdn_requis_qnty').val('" . $row[csf("yarn_qnty")] . "');\n";

		if ($row[csf("btb_lc_id")] > 0)
		{
			$btb_lc_num = return_field_value("lc_number", "com_btb_lc_master_details", "id='" . $row[csf("btb_lc_id")]."'", "lc_number");
			echo "$('#txt_btb_selection').val('" . $btb_lc_num . "');\n";
			echo "$('#txt_btb_lc_id').val('" . $row[csf("btb_lc_id")] . "');\n";
		}

		if ($row[csf("wo_id")] > 0)
		{
			$wo_no = return_field_value("wo_number", "wo_non_order_info_mst", "id='" . $row[csf("wo_id")]."'", "wo_number");
			echo "$('#txt_wo_selection').val('" . $wo_no . "');\n";
			echo "$('#txt_wo_id').val('" . $row[csf("wo_id")] . "');\n";
		}

		if ($row[csf("pi_wo_batch_no")] > 0 )
		{

			$pi_no = return_field_value("pi_number", "com_pi_master_details", "id='" . $row[csf("pi_wo_batch_no")]."'", "pi_number");
			echo "$('#txt_pi_selection').val('" . $pi_no . "');\n";
			echo "$('#txt_pi_id').val('" . $row[csf("pi_wo_batch_no")] . "');\n";
		}


		//issue qnty popup data arrange
		if($row[csf("issue_basis")] == 8)
		{
			$sqlIN = sql_select("select po_breakdown_id, sum(quantity) as quantity, sum(returnable_qnty) as returnable_qnty from inv_transaction a,order_wise_pro_details b where     a.id=b.trans_id and b.entry_form = 3 and b.trans_type = 2 and a.prod_id=b.prod_id and a.mst_id=" . $row[csf("issue_id")] . " and a.requisition_no=" . $row[csf("requisition_no")] . "  and  a.demand_no='" . $row[csf("demand_no")] . "'  and a.prod_id = " . $row[csf("prod_id")] . "  and b.status_active = 1 group by po_breakdown_id");
		}else{
			$sqlIN = sql_select("select po_breakdown_id, quantity, returnable_qnty from order_wise_pro_details where trans_id=" . $row[csf("id")] . " and entry_form=3 and trans_type=2 and status_active=1");
		}

		$poWithValue = "";
		$poID = "";
		if (count($sqlIN) > 0)
		{
			foreach ($sqlIN as $res)
			{
				if ($poWithValue != "") $poWithValue .= ",";
				if ($poID != "") $poID .= ",";
				$poWithValue .= $res[csf("po_breakdown_id")] . "**" . $res[csf("quantity")] . "**" . $res[csf("returnable_qnty")];
				$poID .= $res[csf("po_breakdown_id")];
			}
			echo "$('#save_data').val('" . $poWithValue . "');\n";
			echo "$('#original_save_data').val('" . $poWithValue . "');\n";
			echo "$('#all_po_id').val('" . $poID . "');\n";
		}
		else
		{
			echo "$('#txt_issue_qnty').removeAttr('placeholder').removeAttr('readonly').removeAttr('onDblClick');\n";
		}

		//update id here
		echo "$('#update_id').val(" . $row[csf("id")] . ");\n";
		echo "set_button_status(1, permission, 'fnc_yarn_issue_entry',1);\n";
	}
	
	exit();
}

if ($action == "requis_popup")
{
	echo load_html_head_contents("Popup Info", "../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script src="../../includes/functions_bottom.js" type="text/javascript"></script>
	<script>
		<?
		$data_arr = json_encode($_SESSION['logic_erp']['data_arr'][3]);
		echo "var field_level_data= " . $data_arr . ";\n";
		?>
		window.onload = function () {
			set_field_level_access( <? echo $company; ?> );
		};

		function fn_show_check()
		{
			var basis = '<? echo $cbo_basis; ?>';
			if(basis == 3)
			{
				var action = "create_req_search_list";
			}
			else
			{
				var action = "create_demand_search_list";
			}

			show_list_view(document.getElementById('cbo_buyer_name').value + '_' + document.getElementById('txt_search_common').value + '_' + '<? echo $company; ?>' + '_' + document.getElementById('cbo_sales_order').value + '_' + '<? echo $cbo_location_id; ?>' + '_' + '<? echo $txt_system_no; ?>' + '_' + '<? echo $cbo_basis; ?>' + '_' + document.getElementById('cbo_booking_type').value+ '_' + <? echo $knitting_source_id;?>,action,'search_divs','yarn_issue_controller','setFilterGrid(\'list_view\',-1)');
		}

		function js_set_value(req_no)
		{
			$("#hidden_req_no").val(req_no);
			parent.emailwindow.hide();
		}

		function fnc_disable(str)
		{
			$("#cbo_buyer_name").val(0);
			if (str == 1)
			{
				$('#cbo_buyer_name').attr('disabled', 'disabled');
				$('#cbo_booking_type').val(1).attr('disabled', 'disabled');
			}
			else
			{
				$('#cbo_buyer_name').removeAttr('disabled', 'disabled');
				$('#cbo_booking_type').val(1).removeAttr('disabled', 'disabled');
			}
		}
	</script>
</head>
<body>
	<div align="center" style="width:100%;">
		<form name="searchorderfrm_1" id="searchorderfrm_1" autocomplete="off">
			<table width="700" cellspacing="0" cellpadding="0" border="1" rules="all" class="rpt_table" align="center">
				<thead>
					<tr>
						<th>Sales Order</th>
						<th>Booking Type</th>
						<th>Buyer Name</th>
						<th align="center">Requisition/Demand No</th>
						<th><input type="reset" name="re_button" id="re_button" value="Reset" style="width:100px" class="formbutton"/></th>
					</tr>
				</thead>
				<tbody>
					<tr class="general">
						<td>
							<? echo create_drop_down("cbo_sales_order", 100, $yes_no, "", 0, "-- Select --", 2, "fnc_disable(this.value);", '', ''); ?>
						</td>
						<td>
							<? $bookingTypeArr=array(1=>'With',2=>'Without'); echo create_drop_down("cbo_booking_type", 100, $bookingTypeArr, '', 0, '', 1, '', '', ''); ?>
						</td>
						<td>
							<?
							echo create_drop_down("cbo_buyer_name", 170, "select buy.id, buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$company' $buyer_cond group by buy.id, buy.buyer_name order by buy.buyer_name", "id,buyer_name", 1, "-- Select --", $selected, "");
							?>
						</td>
						<td width="180" align="center">
							<input type="text" style="width:130px" class="text_boxes" name="txt_search_common" id="txt_search_common"/>
						</td>
						<td align="center">
							<input type="button" name="btn_show" class="formbutton" value="Show" onClick="fn_show_check()" style="width:100px;"/>
						</td>
					</tr>
					<!-- Hidden field here -->
					<input type="hidden" id="hidden_req_no" value=""/>
					<!-- END -->
				</tbody>
			</tr>
		</table>
		<div align="center" valign="top" id="search_divs"></div>
	</form>
</div>
</body>
</html>
<?
exit();
}

if ($action == "create_req_search_list")
{
	$ex_data = explode("_", $data);
	$buyer = str_replace("'", "", $ex_data[0]);
	$req_no = str_replace("'", "", $ex_data[1]);
	$company = str_replace("'", "", $ex_data[2]);
	$sales_order = str_replace("'", "", $ex_data[3]);
	$location_id = str_replace("'", "", $ex_data[4]);
	$system_no = str_replace("'", "", $ex_data[5]);
	$basis = str_replace("'", "", $ex_data[6]);
	$bookingType = str_replace("'", "", $ex_data[7]);
	$knitting_source_id = str_replace("'", "", $ex_data[7]);

	$buyer_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');

	$cond = "";
	if ($buyer != "" && $buyer != 0) $cond .= " and a.buyer_id=$buyer";
	if ($req_no != "" && $req_no != 0) $cond .= " and c.requisition_no=$req_no";
	if ($company != "" && $company != 0) $cond .= " and a.company_id=$company";
	if ($system_no != "" && $location_id != 0) $cond .= " and b.location_id=$location_id";

	if ($sales_order == 1)
	{

		$company_arr = return_library_array("select id, company_name from lib_company", 'id', 'company_name');

		$sql = "SELECT a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id, '' as issue_qnty from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c
		where a.id=b.mst_id and b.id=c.knit_id and a.is_sales=1 and c.status_active=1 and c.is_deleted=0 $cond
		group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id";
		// echo $sql;
		$result = sql_select($sql);
		foreach ($result as $row) {
			$plan_id_arr[]=$row[csf("knit_id")];
		}

		$plan_cond = (!empty($plan_id_arr))?" and dtls_id in(".implode(",",$plan_id_arr).")":"";
		if ($db_type == 2) {
			$plan_details_array = sql_select("select dtls_id, LISTAGG(po_id, ',') WITHIN GROUP (ORDER BY po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company and is_sales=1 $plan_cond group by dtls_id");
		}else{
			$plan_details_array = sql_select("select dtls_id, group_concat(po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company and is_sales=1 $plan_cond group by dtls_id");
		}

		$plan_arr=array();
		foreach ($plan_details_array as $plan_row) {
			$sales_order_arr[$plan_row[csf("dtls_id")]] = $plan_row[csf("po_id")];
			$sales_order_id_arr[] = $plan_row[csf("po_id")];
		}

		$sales_no_array = array();
		$sales_id_cond = (!empty($sales_order_id_arr))?" and id in(".implode(",",$sales_order_id_arr).")":"";
		$salesData = sql_select("select id,job_no,style_ref_no,buyer_id,sales_booking_no,within_group from fabric_sales_order_mst where company_id=$company and status_active=1 and is_deleted=0 $sales_id_cond");
		foreach ($salesData as $row)
		{
			$sales_no_array[$row[csf('id')]]['sales_order'] = $row[csf('job_no')];
			$sales_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
			$sales_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
			$sales_no_array[$row[csf('id')]]['sales_booking'] = $row[csf('sales_booking_no')];
			$sales_booking[]= "'".$row[csf('sales_booking_no')]."'";
		}

		$job_arr = array();
		$booking_cond = (!empty($sales_booking))?" and c.booking_no in(".implode(",",$sales_booking).")":"";
		$jobData = sql_select("select a.job_no, a.style_ref_no,a.buyer_name, c.booking_no from wo_po_details_master a, wo_po_break_down b, wo_booking_dtls c where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 $booking_cond group by a.job_no, a.style_ref_no,a.buyer_name, c.booking_no");
		foreach ($jobData as $row)
		{
			$job_arr[$row[csf('booking_no')]]['job_no'] = $row[csf('job_no')];
			$job_arr[$row[csf('booking_no')]]['buyer_name'] = $row[csf('buyer_name')];
		}
		$i = 1;
		?>
		<div align="center">
			<div style="width:1070px;">
				<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="100%" rules="all">
					<thead>
						<tr>
							<th width="50">SL</th>
							<th width="150">Buyer</th>
							<th width="120">Job No</th>
							<th width="130">FSO</th>
							<th width="100">Sales/ Booking No</th>
							<th width="130">Style Ref.</th>
							<th width="100">Req. No</th>
							<th width="100">Req. Date</th>
							<th>Quantity</th>
						</tr>
					</thead>
				</table>
			</div>
			<div style="width:1070px; overflow-y:scroll; max-height:250px;">
				<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="1050" rules="all"
				id="list_view">
					<tbody>
						<?
						foreach ($result as $row)
						{
							if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
							$job_id = array_unique(explode(",", $sales_order_arr[$row[csf('knit_id')]]));
							$style_ref = '';
							$sales_order = '';
							$buyer_id = '';
							$sales_booking = '';
							foreach ($job_id as $val)
							{
								if ($style_ref == '') $style_ref = $sales_no_array[$val]['style_ref'];
								if ($sales_order == '') $sales_order = $sales_no_array[$val]['sales_order'];
								if ($buyer_id == '') $buyer_id = $sales_no_array[$val]['buyer_id'];
								if ($sales_booking == '') $sales_booking = $sales_no_array[$val]['sales_booking'];
							}
							if ($row[csf('within_group')] == 1) {
								$buyer = $job_arr[$sales_booking]['buyer_name'];
								$job_no= $job_arr[$sales_booking]['job_no'];
							} else {
								$buyer = $buyer_id;
								$job_no="";
							}

							?>
							<tr bgcolor="<? echo $bgcolor; ?>"
								onClick="js_set_value('<? echo $row[csf('requisition_no')] . ',' . $row[csf('company_id')] . ',' . $buyer . ',' . $row[csf("yarn_qnty")] . ',' . $row[csf("issue_qnty")] . ',' . $row[csf("knitting_source")]. ',' . $row[csf("knitting_party")] . ',' . $row[csf("location_id")]. ',,,1'; ?>')"
								style="cursor:pointer">
								<td width="50"><?php echo $i; ?></td>
								<td width="150"><p><?php echo $buyer_arr[$buyer]; ?></p></td>
								<td width="120"><p><?php echo $job_no; ?></p></td>
								<td width="130"><p><?php echo $sales_order; ?></p></td>
								<td width="100"><p><?php echo $sales_booking; ?></p></td>
								<td width="130"><p><?php echo $style_ref; ?></p></td>
								<td width="100" align="center"><p><?php echo $row[csf("requisition_no")]; ?></p></td>
								<td width="100" align="center"><p>
								<?php echo change_date_format($row[csf("requisition_date")]); ?></p></td>
								<td width="" align="right">
									<p><?php echo number_format($row[csf("yarn_qnty")], 2, '.', ''); ?></p></td>
							</tr>
							<?
							$i++;
						}
						?>
					</tbody>
				</table>
			</div>
		</div>
		<?
	}
	else
	{
		//for booking type with
		if($bookingType == 1)
		{
			$po_array = array();
			$po_sql = sql_select("select a.job_no,a.style_ref_no,b.grouping,b.file_no,b.id,b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$company");
			foreach ($po_sql as $row)
			{
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
				$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
				$po_array[$row[csf('id')]]['internal'] = $row[csf('grouping')];
			}

			if ($db_type == 0) {
				$plan_details_array = return_library_array("select dtls_id, group_concat(po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company group by dtls_id", "dtls_id", "po_id");
			} else {
				$plan_details_array = return_library_array("select dtls_id, LISTAGG(po_id, ',') WITHIN GROUP (ORDER BY po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company group by dtls_id", "dtls_id", "po_id");
			}

			$app_nessity=2;
			$app_nessity=return_field_value("yarn_iss_with_serv_app","variable_order_tracking","company_name =$company and variable_list=60 and is_deleted=0 and status_active=1");
			if($app_nessity=="" || $app_nessity==0){
				$app_nessity=2;
			}


			if($knitting_source_id==1)
			{
				$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where a.id=b.mst_id and b.id=c.knit_id and a.is_sales != 1 and c.status_active=1 and c.is_deleted=0 $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id";

			}
			else
			{
				if($app_nessity==2)
				{
					$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where a.id=b.mst_id and b.id=c.knit_id and a.is_sales != 1 and c.status_active=1 and c.is_deleted=0 $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id";
				}
				else
				{
					$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,wo_booking_dtls d,wo_booking_mst e where a.id=b.mst_id and b.id=c.knit_id and b.id=d.program_no and d.booking_no=e.booking_no and e.is_approved=1 and a.is_sales != 1 and c.status_active=1 and c.is_deleted=0  $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id";
				}
			}

			if($app_nessity==2)
			{
				//a.is_sales != 1
				$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where a.id=b.mst_id and b.id=c.knit_id and a.is_sales = 0 and c.status_active=1 and c.is_deleted=0 $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id";
				//echo $sql;
			}
			else
			{
				//a.is_sales != 1
				$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,wo_booking_dtls d,wo_booking_mst e where a.id=b.mst_id and b.id=c.knit_id and a.booking_no=d.booking_no and d.booking_no=e.booking_no and e.is_approved=1 and a.is_sales = 0 and c.status_active=1 and c.is_deleted=0  $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id";
				//echo $sql;
			}

			//echo $sql;
			$result = sql_select($sql);
			$i = 1;
			?>
			<div align="center">
				<div style="width:970px;">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="100%" rules="all">
						<thead>
							<tr>
								<th width="50">SL</th>
								<th width="130">Buyer</th>
								<th width="250">Order No</th>
								<th width="100">Internal Ref</th>
								<th width="100">File No</th>
								<th width="100">Req. No</th>
								<th width="100">Req. Date</th>
								<th width="">Quantity</th>
							</tr>
						</thead>
					</table>
				</div>
				<div style="width:970px; overflow-y:scroll; max-height:250px;">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="950" rules="all"
					id="list_view">
						<tbody>
							<? foreach ($result as $row)
							{
								if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";

								$po_id = array_unique(explode(",", $plan_details_array[$row[csf('knit_id')]]));
								$po_no = '';
								$style_no = '';
								$job_no = '';
								$internal_ref = '';
								$file_no = '';

								foreach ($po_id as $val)
								{
									if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= "," . $po_array[$val]['no'];
									if ($job_no == '') $job_no = $po_array[$val]['job_no'];
									if ($style_no == '') $style_no = $po_array[$val]['style_ref'];
									if ($internal_ref == '') $internal_ref = $po_array[$val]['internal']; else $internal_ref .= "," . $po_array[$val]['internal'];
									if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
								}
								?>
								<tr bgcolor="<? echo $bgcolor; ?>"
									onClick="js_set_value('<? echo $row[csf('requisition_no')] . ',' . $row[csf('company_id')] . ',' . $row[csf('buyer_id')] . ',' . $row[csf("yarn_qnty")] . ',' . $row[csf("issue_qnty")] . ',' . $row[csf("knitting_source")]. ',' . $row[csf("knitting_party")]. ',' . $row[csf("location_id")]. ',,,1'; ?>')"
									style="cursor:pointer">
									<td width="50"><?php echo $i; ?></td>
									<td width="130"><p><?php echo $buyer_arr[$row[csf("buyer_id")]]; ?></p></td>
									<td width="250"><p><?php echo $po_no; ?></p></td>
									<td width="100"><p><?php echo $internal_ref; ?>&nbsp;</p></td>
									<td width="100"><p><?php echo $file_no; ?>&nbsp;</p></td>
									<td width="100" align="center"><p>&nbsp;<?php echo $row[csf("requisition_no")]; ?></p></td>
									<td width="100" align="center"><p>
									&nbsp;<?php echo change_date_format($row[csf("requisition_date")]); ?></p></td>
									<td width="" align="right">
										<p><?php echo number_format($row[csf("yarn_qnty")], 2, '.', ''); ?></p></td>
									</tr>
									<?
									$i++;
							}
							?>
						</tbody>
					</table>
				</div>
			</div>
			<?
		}
		else//for booking type without
		{
			$app_nessity=2;
			$app_nessity=return_field_value("yarn_iss_with_serv_app","variable_order_tracking","company_name = ".$company." and variable_list=60 and is_deleted=0 and status_active=1");
			if($app_nessity=="" || $app_nessity==0)
			{
				$app_nessity=2;
			}

			if($app_nessity==2)
			{
				$sql = "select
					a.company_id, a.buyer_id, a.within_group, a.booking_no,
					c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,
					b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty
				from
					ppl_planning_info_entry_mst a,
					ppl_planning_info_entry_dtls b,
					ppl_yarn_requisition_entry c
				where
					a.id=b.mst_id and b.id=c.knit_id and a.is_sales = 2 and c.status_active=1 and c.is_deleted=0 $cond
					group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id";
			}
			else
			{
				$sql = "select
					a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty
				from
					ppl_planning_info_entry_mst a,
					ppl_planning_info_entry_dtls b,
					ppl_yarn_requisition_entry c,
					wo_booking_dtls d,
					wo_booking_mst e
				where
					a.id=b.mst_id and b.id=c.knit_id and b.id=d.program_no and d.booking_no=e.booking_no and e.is_approved=1 and a.is_sales = 2 and c.status_active=1 and c.is_deleted=0 $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id";
			}
			//echo $sql;
			$result = sql_select($sql);
			$i = 1;
			?>
			<div align="center">
				<div style="width:650px;">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="100%" rules="all">
						<thead>
							<tr>
								<th width="50">SL</th>
								<th width="130">Buyer</th>
                                <th width="130">Booking No</th>
								<th width="100">Req. No</th>
								<th width="100">Req. Date</th>
								<th width="">Quantity</th>
							</tr>
						</thead>
					</table>
				</div>
				<div style="width:650px; overflow-y:scroll; max-height:250px;">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="630" rules="all" id="list_view">
						<tbody>
							<? foreach ($result as $row)
							{
								if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
								?>
								<tr bgcolor="<? echo $bgcolor; ?>"
									onClick="js_set_value('<? echo $row[csf('requisition_no')] . ',' . $row[csf('company_id')] . ',' . $row[csf('buyer_id')] . ',' . $row[csf("yarn_qnty")] . ',' . $row[csf("issue_qnty")] . ',' . $row[csf("knitting_source")]. ',' . $row[csf("knitting_party")]. ',' . $row[csf("location_id")]. ',,,2'; ?>')" style="cursor:pointer">
									<td width="50"><?php echo $i; ?></td>
									<td width="130"><p><?php echo $buyer_arr[$row[csf("buyer_id")]]; ?></p></td>
									<td width="130"><p><?php echo $row[csf("booking_no")]; ?></p></td>
									<td width="100" align="center"><p>&nbsp;<?php echo $row[csf("requisition_no")]; ?></p></td>
									<td width="100" align="center"><p>&nbsp;<?php echo change_date_format($row[csf("requisition_date")]); ?></p></td>
									<td width="" align="right"><p><?php echo number_format($row[csf("yarn_qnty")], 2, '.', ''); ?></p></td>
                                </tr>
                                <?
                                $i++;
							}
							?>
						</tbody>
					</table>
				</div>
			</div>
			<?
		}
	}
	exit();
}

if ($action == "create_demand_search_list_old")
{
	$ex_data = explode("_", $data);
	$buyer = str_replace("'", "", $ex_data[0]);
	$req_demand_no = str_replace("'", "", $ex_data[1]);
	$company = str_replace("'", "", $ex_data[2]);
	$sales_order = str_replace("'", "", $ex_data[3]);
	$location_id = str_replace("'", "", $ex_data[4]);
	$system_no = str_replace("'", "", $ex_data[5]);
	$basis = str_replace("'", "", $ex_data[6]);
	$bookingType = str_replace("'", "", $ex_data[7]);
	$knitting_source_id = str_replace("'", "", $ex_data[8]);

	$buyer_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');

	$cond = "";
	if ($buyer != "" && $buyer != 0) $cond .= " and a.buyer_id=$buyer";
	if($basis==8){
		if ($req_demand_no != "" && $req_demand_no != 0) $cond .= " and e.demand_prefix_number=$req_demand_no";
	}else{
		if ($req_demand_no != "" && $req_demand_no != 0) $cond .= " and c.requisition_no=$req_demand_no";
	}

	if ($company != "" && $company != 0) $cond .= " and a.company_id=$company";
	if ($system_no != "" && $location_id != 0) $cond .= " and b.location_id=$location_id";

	if ($sales_order == 1)
	{
		$company_arr = return_library_array("select id, company_name from lib_company", 'id', 'company_name');

		$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty, b.knitting_source, b.knitting_party, b.location_id, '' as issue_qnty, e.id demand_id, e.demand_system_no, sum(d.yarn_demand_qnty) demand_qnty, e.demand_date from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c, ppl_yarn_demand_reqsn_dtls d, ppl_yarn_demand_entry_mst e where a.id=b.mst_id and b.id=c.knit_id and c.id=d.requisition_id and d.mst_id=e.id and a.is_sales=1 and c.status_active=1 and c.is_deleted=0 $cond and d.status_active=1 and e.status_active=1 group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id, b.knitting_source, b.knitting_party, b.location_id, e.id, e.demand_system_no, e.demand_date order by c.requisition_date desc";
		$result = sql_select($sql);
		foreach ($result as $row)
		{
			$plan_id_arr[]=$row[csf("knit_id")];
		}

		$plan_cond = (!empty($plan_id_arr))?" and dtls_id in(".implode(",",$plan_id_arr).")":"";
		if ($db_type == 2)
		{
			$plan_details_array = sql_select("select dtls_id, LISTAGG(po_id, ',') WITHIN GROUP (ORDER BY po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company and is_sales=1 $plan_cond group by dtls_id");
		}
		else
		{
			$plan_details_array = sql_select("select dtls_id, group_concat(po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company and is_sales=1 $plan_cond group by dtls_id");
		}

		$plan_arr=array();
		foreach ($plan_details_array as $plan_row)
		{
			$sales_order_arr[$plan_row[csf("dtls_id")]] = $plan_row[csf("po_id")];
			$sales_order_id_arr[] = $plan_row[csf("po_id")];
		}

		$sales_no_array = array();
		$sales_id_cond = (!empty($sales_order_id_arr))?" and id in(".implode(",",$sales_order_id_arr).")":"";
		$salesData = sql_select("select id,job_no,style_ref_no,buyer_id,sales_booking_no,within_group,po_job_no,po_buyer from fabric_sales_order_mst where company_id=$company and status_active=1 and is_deleted=0 $sales_id_cond");
		foreach ($salesData as $row)
		{
			$sales_no_array[$row[csf('id')]]['sales_order'] = $row[csf('job_no')];
			$sales_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
			$sales_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
			$sales_no_array[$row[csf('id')]]['sales_booking'] = $row[csf('sales_booking_no')];
			$sales_no_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
			$sales_no_array[$row[csf('id')]]['po_job_no'] = $row[csf('po_job_no')];
			$sales_booking[]= "'".$row[csf('sales_booking_no')]."'";
		}
		?>
		<div align="center">
			<div style="width:1120px; margin-top:10px;">
				<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="1115" rules="all">
					<thead>
						<tr>
							<th width="30">SL</th>
							<th width="100">Buyer</th>
							<th width="90">Job No</th>
							<th width="120">FSO No</th>
							<th width="100">Sales/Booking No</th>
							<th width="80">Within Group</th>
							<th width="100">Style Ref.</th>
							<th width="60">Req. No</th>
							<th width="70">Req. Date</th>
							<th width="80">Req. Quantity</th>
							<th width="100">Demand No</th>
							<th width="70">Demand Date</th>
							<th>Demand Quantity</th>
						</tr>
					</thead>
				</table>
			</div>
			<div style="width:1120px; overflow-y:scroll; max-height:250px;">
				<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="1100" rules="all" id="list_view">
					<tbody>
						<?
						$i = 1;
						foreach ($result as $row) {
							if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
							$job_id = array_unique(explode(",", $sales_order_arr[$row[csf('knit_id')]]));
							$style_ref = $sales_order = $buyer_id = $sales_booking = $po_job_no = '';
							foreach ($job_id as $val) {
								if ($style_ref == '') $style_ref = $sales_no_array[$val]['style_ref'];
								if ($sales_order == '') $sales_order = $sales_no_array[$val]['sales_order'];
								if ($sales_booking == '') $sales_booking = $sales_no_array[$val]['sales_booking'];

								if ($row[csf('within_group')] == 1) {
									if ($po_job_no == '') $job_no = $sales_no_array[$val]['po_job_no'];
									if ($sales_booking != '') $buyer = $sales_no_array[$val]['po_buyer'];
								} else {
									if ($buyer_id == '') $buyer = $sales_no_array[$val]['buyer_id'];
									$job_no="";
								}
							}

							?>
							<tr bgcolor="<? echo $bgcolor; ?>"
								onClick="js_set_value('<? echo $row[csf('requisition_no')] . ',' . $row[csf('company_id')] . ',' . $buyer . ',' . $row[csf("yarn_qnty")] . ',' . $row[csf("issue_qnty")] . ',' . $row[csf("knitting_source")]. ',' . $row[csf("knitting_party")]. ',' . $row[csf("location_id")]. ',' . $row[csf("demand_id")] . ','.$row[csf("demand_system_no")].',1'; ?>')" style="cursor:pointer">
								<td width="30" align="center"><?php echo $i; ?></td>
								<td width="100"><p><?php echo $buyer_arr[$buyer]; ?></p></td>
								<td width="90"><p><?php echo $job_no; ?></p></td>
								<td width="120"><p><?php echo $sales_order; ?></p></td>
								<td width="100"><p><?php echo $sales_booking; ?></p></td>
								<td width="80" align="center"><p><?php echo $yes_no[$row[csf('within_group')]]; ?></p></td>
								<td width="100"><p><?php echo $style_ref; ?></p></td>
								<td width="60" align="center"><p><?php echo $row[csf("requisition_no")]; ?></p></td>
								<td width="70" align="center"><?php echo change_date_format($row[csf("requisition_date")]); ?></td>
								<td width="80" align="right"><?php echo number_format($row[csf("yarn_qnty")], 2, '.', ''); ?></td>
								<td width="100" align="center"><p><?php echo $row[csf("demand_system_no")]; ?></p></td>
								<td width="70" align="center"><?php echo change_date_format($row[csf("demand_date")]); ?></td>
								<td width="" align="right"><?php echo number_format($row[csf("demand_qnty")], 2, '.', ''); ?></p></td>
							</tr>
							<?
							$i++;
						}
						?>
					</tbody>
				</table>
			</div>
		</div>
		<?
	}
	else
	{
		//for booking type with
		if($bookingType == 1)
		{
			$po_array = array();
			$po_sql = sql_select("select a.job_no,a.style_ref_no,b.grouping,b.file_no,b.id,b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$company");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
				$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
				$po_array[$row[csf('id')]]['internal'] = $row[csf('grouping')];
			}

			if ($db_type == 0) {
				$plan_details_array = return_library_array("select dtls_id, group_concat(po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company group by dtls_id", "dtls_id", "po_id");
			} else {
				$plan_details_array = return_library_array("select dtls_id, LISTAGG(po_id, ',') WITHIN GROUP (ORDER BY po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company group by dtls_id", "dtls_id", "po_id");
			}

			$app_nessity=2;
			$app_nessity=return_field_value("yarn_iss_with_serv_app","variable_order_tracking","company_name =$company and variable_list=60 and is_deleted=0 and status_active=1");
			if($app_nessity=="" || $app_nessity==0){
				$app_nessity=2;
			}

			if($knitting_source_id==1)
			{
				$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty,e.id demand_id,e.demand_system_no, sum(d.yarn_demand_qnty) demand_qnty,e.demand_date from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,ppl_yarn_demand_reqsn_dtls d,ppl_yarn_demand_entry_mst e where a.id=b.mst_id and b.id=c.knit_id and c.id=d.requisition_id and d.mst_id=e.id and a.is_sales != 1 and c.status_active=1 and c.is_deleted=0 $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id,e.id,e.demand_system_no,e.demand_date order by e.demand_date desc";

			}
			else
			{
				if($app_nessity==2)
				{
					$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty,e.id demand_id,e.demand_system_no, sum(d.yarn_demand_qnty) demand_qnty,e.demand_date from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,ppl_yarn_demand_reqsn_dtls d,ppl_yarn_demand_entry_mst e where a.id=b.mst_id and b.id=c.knit_id and c.id=d.requisition_id and d.mst_id=e.id and a.is_sales != 1 and c.status_active=1 and c.is_deleted=0 $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id,e.id,e.demand_system_no,e.demand_date order by e.demand_date desc";
				}
				else
				{
					$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty,g.id demand_id,g.demand_system_no, sum(f.yarn_demand_qnty) demand_qnty,g.demand_date from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,ppl_yarn_demand_reqsn_dtls f,ppl_yarn_demand_entry_mst g,wo_booking_dtls d,wo_booking_mst e where a.id=b.mst_id and b.id=c.knit_id and b.id=d.program_no and d.booking_no=e.booking_no and e.is_approved=1 and c.id=f.requisition_id and f.mst_id=g.id and a.is_sales != 1 and c.status_active=1 and c.is_deleted=0  $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id,g.id,g.demand_system_no,g.demand_date order by g.demand_date desc";
				}
			}

			if($app_nessity==2)
			{
				$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty,e.id demand_id,e.demand_system_no, sum(d.yarn_demand_qnty) demand_qnty,e.demand_date from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,ppl_yarn_demand_reqsn_dtls d,ppl_yarn_demand_entry_mst e where a.id=b.mst_id and b.id=c.knit_id and c.id=d.requisition_id and d.mst_id=e.id and a.is_sales = 0 and c.status_active=1 and c.is_deleted=0 $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id,e.id,e.demand_system_no,e.demand_date order by e.demand_date desc";
			}
			else
			{
				$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,ppl_yarn_demand_reqsn_dtls d,ppl_yarn_demand_entry_mst e,wo_booking_dtls f,wo_booking_mst g where a.id=b.mst_id and b.id=c.knit_id and b.id=f.program_no and a.booking_no=f.booking_no and g.is_approved=1 and c.id=d.requisition_id and d.mst_id=e.id and a.is_sales = 0 and c.status_active=1 and c.is_deleted=0  $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id,e.id,e.demand_system_no,e.demand_date order by e.demand_date desc";
			}
			//echo $sql;
			$result = sql_select($sql);
			$i = 1;
			?>
			<div align="center">
				<div style="width:1090px;">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="1087" rules="all">
						<thead>
							<tr>
								<th width="30">SL</th>
								<th width="130">Buyer</th>
								<th width="250">Order No</th>
								<th width="100">Internal Ref</th>
								<th width="100">File No</th>
								<th width="60">Req. No</th>
								<th width="70">Req. Date</th>
								<th width="80">Quantity</th>
								<th width="110">Demand No</th>
								<th width="70">Demand Date</th>
								<th>Demand Quantity</th>
							</tr>
						</thead>
					</table>
				</div>
				<div style="width:1090px; overflow-y:scroll; max-height:250px;">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="1070" rules="all"
					id="list_view">
					<tbody>
						<? foreach ($result as $row)
						{
							if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";

							$po_id = array_unique(explode(",", $plan_details_array[$row[csf('knit_id')]]));
							$po_no = '';
							$style_no = '';
							$job_no = '';
							$internal_ref = '';
							$file_no = '';

							foreach ($po_id as $val)
							{
								if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= "," . $po_array[$val]['no'];
								if ($job_no == '') $job_no = $po_array[$val]['job_no'];
								if ($style_no == '') $style_no = $po_array[$val]['style_ref'];
								if ($internal_ref == '') $internal_ref = $po_array[$val]['internal']; else $internal_ref .= "," . $po_array[$val]['internal'];
								if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
							}
							?>
							<tr bgcolor="<? echo $bgcolor; ?>"
								onClick="js_set_value('<? echo $row[csf('requisition_no')] . ',' . $row[csf('company_id')] . ',' . $row[csf('buyer_id')] . ',' . $row[csf("yarn_qnty")] . ',' . $row[csf("issue_qnty")] . ',' . $row[csf("knitting_source")]. ',' . $row[csf("knitting_party")]. ',' . $row[csf("location_id")] . ',' . $row[csf("demand_id")] . ',' . $row[csf("demand_system_no")].',1'; ?>')"
								style="cursor:pointer">
								<td width="30" align="center"><?php echo $i; ?></td>
								<td width="130"><p><?php echo $buyer_arr[$row[csf("buyer_id")]]; ?></p></td>
								<td width="250"><p><?php echo $po_no; ?></p></td>
								<td width="100"><p><?php echo $internal_ref; ?></p></td>
								<td width="100"><p><?php echo $file_no; ?></p></td>
								<td width="60" align="center"><p><?php echo $row[csf("requisition_no")]; ?></p></td>
								<td width="70" align="center"><?php echo change_date_format($row[csf("requisition_date")]); ?></td>
								<td width="80" align="right"><?php echo number_format($row[csf("yarn_qnty")], 2, '.', ''); ?></td>
								<td width="110" align="center"><p><?php echo $row[csf("demand_system_no")]; ?></p></td>
								<td width="70" align="center"><?php echo change_date_format($row[csf("demand_date")]); ?></td>
								<td width="" align="right"><?php echo number_format($row[csf("demand_qnty")], 2, '.', ''); ?></p></td>
							</tr>
							<?
							$i++;
						}
						?>
					</tbody>
				</table>
			</div>
			</div>
			<?
		}
		else //for booking type without
		{
			$app_nessity=2;
			$app_nessity=return_field_value("yarn_iss_with_serv_app","variable_order_tracking","company_name =$company and variable_list=60 and is_deleted=0 and status_active=1");
			if($app_nessity=="" || $app_nessity==0)
			{
				$app_nessity=2;
			}

			if($app_nessity==2)
			{
				$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty,e.id demand_id,e.demand_system_no, sum(d.yarn_demand_qnty) demand_qnty,e.demand_date from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,ppl_yarn_demand_reqsn_dtls d,ppl_yarn_demand_entry_mst e where a.id=b.mst_id and b.id=c.knit_id and c.id=d.requisition_id and d.mst_id=e.id and a.is_sales = 2 and c.status_active=1 and c.is_deleted=0 $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id,e.id,e.demand_system_no,e.demand_date order by e.demand_date desc";
			}
			else
			{
				$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,ppl_yarn_demand_reqsn_dtls d,ppl_yarn_demand_entry_mst e,wo_booking_dtls d,wo_booking_mst e where a.id=b.mst_id and b.id=c.knit_id and b.id=d.program_no and d.booking_no=e.booking_no and e.is_approved=1 and c.id=f.requisition_id and f.mst_id=g.id and and a.is_sales = 2 and c.status_active=1 and c.is_deleted=0  $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id,g.id,g.demand_system_no,g.demand_date order by g.demand_date desc";
			}
			//echo $sql;
			$result = sql_select($sql);
			$i = 1;
			?>
			<div align="center">
				<div style="width:640px;">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="1087" rules="all">
						<thead>
							<tr>
								<th width="30">SL</th>
								<th width="130">Buyer</th>
								<th width="60">Req. No</th>
								<th width="70">Req. Date</th>
								<th width="80">Quantity</th>
								<th width="110">Demand No</th>
								<th width="70">Demand Date</th>
								<th>Demand Quantity</th>
							</tr>
						</thead>
					</table>
				</div>
				<div style="width:640px; overflow-y:scroll; max-height:250px;">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="620" rules="all"
					id="list_view">
					<tbody>
						<?
						foreach ($result as $row)
						{
							if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
							?>
							<tr bgcolor="<? echo $bgcolor; ?>"
								onClick="js_set_value('<? echo $row[csf('requisition_no')] . ',' . $row[csf('company_id')] . ',' . $row[csf('buyer_id')] . ',' . $row[csf("yarn_qnty")] . ',' . $row[csf("issue_qnty")] . ',' . $row[csf("knitting_source")]. ',' . $row[csf("knitting_party")]. ',' . $row[csf("location_id")] . ',' . $row[csf("demand_id")] . ',' . $row[csf("demand_system_no")].',0'; ?>')"
								style="cursor:pointer">
								<td width="30" align="center"><?php echo $i; ?></td>
								<td width="130"><p><?php echo $buyer_arr[$row[csf("buyer_id")]]; ?></p></td>
								<td width="60" align="center"><p><?php echo $row[csf("requisition_no")]; ?></p></td>
								<td width="70" align="center"><?php echo change_date_format($row[csf("requisition_date")]); ?></td>
								<td width="80" align="right"><?php echo number_format($row[csf("yarn_qnty")], 2, '.', ''); ?></td>
								<td width="110" align="center"><p><?php echo $row[csf("demand_system_no")]; ?></p></td>
								<td width="70" align="center"><?php echo change_date_format($row[csf("demand_date")]); ?></td>
								<td width="" align="right"><?php echo number_format($row[csf("demand_qnty")], 2, '.', ''); ?></p></td>
							</tr>
							<?
							$i++;
						}
						?>
					</tbody>
				</table>
			</div>
			</div>
			<?
		}
	}
	exit();
}

if ($action == "create_demand_search_list")
{
	function where_con_using_array_2($arrayData,$dataType=0,$table_coloum){
		$chunk_list_arr=array_chunk($arrayData,800);
		if(count($chunk_list_arr)<1){return " and ".$table_coloum." in(0)";}
		$p=1;
		foreach($chunk_list_arr as $process_arr)
		{
			if($dataType==0){
				if($p==1){$sql .=" and (".$table_coloum." in(".implode(',',$process_arr).")"; }
				else {$sql .=" or ".$table_coloum." in(".implode(',',$process_arr).")";}
			}
			else{
				if($p==1){$sql .=" and (".$table_coloum." in('".implode("','",$process_arr)."')"; }
				else {$sql .=" or ".$table_coloum." in('".implode("','",$process_arr)."')";}
			}
			$p++;
		}
		
		$sql.=") ";
		return $sql;
	}
	$ex_data = explode("_", $data);
	$buyer = str_replace("'", "", $ex_data[0]);
	$req_demand_no = str_replace("'", "", $ex_data[1]);
	$company = str_replace("'", "", $ex_data[2]);
	$sales_order = str_replace("'", "", $ex_data[3]);
	$location_id = str_replace("'", "", $ex_data[4]);
	$system_no = str_replace("'", "", $ex_data[5]);
	$basis = str_replace("'", "", $ex_data[6]);
	$bookingType = str_replace("'", "", $ex_data[7]);
	$knitting_source_id = str_replace("'", "", $ex_data[8]);

	$buyer_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');

	$cond = "";
	if ($buyer != "" && $buyer != 0) $cond .= " and a.buyer_id=$buyer";
	if($basis==8){
		if ($req_demand_no != "" && $req_demand_no != 0) $cond .= " and e.demand_prefix_number=$req_demand_no";
	}else{
		if ($req_demand_no != "" && $req_demand_no != 0) $cond .= " and c.requisition_no=$req_demand_no";
	}

	if ($company != "" && $company != 0) $cond .= " and a.company_id=$company";
	if ($system_no != "" && $location_id != 0) $cond .= " and b.location_id=$location_id";

	if ($sales_order == 1)
	{
		$company_arr = return_library_array("select id, company_name from lib_company", 'id', 'company_name');

		$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty, b.knitting_source, b.knitting_party, b.location_id, '' as issue_qnty, e.id demand_id, e.demand_system_no, sum(d.yarn_demand_qnty) demand_qnty, e.demand_date from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c, ppl_yarn_demand_reqsn_dtls d, ppl_yarn_demand_entry_mst e where a.id=b.mst_id and b.id=c.knit_id and c.id=d.requisition_id and d.mst_id=e.id and a.is_sales=1 and c.status_active=1 and c.is_deleted=0 $cond and d.status_active=1 and e.status_active=1 group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id, b.knitting_source, b.knitting_party, b.location_id, e.id, e.demand_system_no, e.demand_date order by c.requisition_date desc";
		// echo $cz; die;
		$result = sql_select($sql);
		foreach ($result as $row)
		{
			$plan_id_arr[$row[csf("knit_id")]]=$row[csf("knit_id")];
		}
		$plan_cond = where_con_using_array($plan_id_arr, '0', 'dtls_id');
		// $plan_cond = (!empty($plan_id_arr))?" and dtls_id in(".implode(",",$plan_id_arr).")":"";
		if ($db_type == 2)
		{
			$plan_details_array = sql_select("select dtls_id, LISTAGG(po_id, ',') WITHIN GROUP (ORDER BY po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company and is_sales=1 $plan_cond group by dtls_id");
		}
		else
		{
			$plan_details_array = sql_select("select dtls_id, group_concat(po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company and is_sales=1 $plan_cond group by dtls_id");
		}

		$plan_arr=array();
		
		foreach ($plan_details_array as $plan_row)
		{
			$sales_order_arr[$plan_row[csf("dtls_id")]] = $plan_row[csf("po_id")];
			$sales_order_id_arr[$plan_row[csf("po_id")]] = $plan_row[csf("po_id")];
		}

		// echo count($sales_order_id_arr);

		$sales_no_array = array();
		$sales_id_cond =  where_con_using_array_2($sales_order_id_arr, '0', 'id');
		// $sales_id_cond = (!empty($sales_order_id_arr))?" and id in(".implode(",",$sales_order_id_arr).")":"";
		$salesData = sql_select("select id,job_no,style_ref_no,buyer_id,sales_booking_no,within_group,po_job_no,po_buyer from fabric_sales_order_mst where company_id=$company and status_active=1 and is_deleted=0 $sales_id_cond");
		// echo "select id,job_no,style_ref_no,buyer_id,sales_booking_no,within_group,po_job_no,po_buyer from fabric_sales_order_mst where company_id=$company and status_active=1 and is_deleted=0 $sales_id_cond"; die;
		foreach ($salesData as $row)
		{
			$sales_no_array[$row[csf('id')]]['sales_order'] = $row[csf('job_no')];
			$sales_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
			$sales_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
			$sales_no_array[$row[csf('id')]]['sales_booking'] = $row[csf('sales_booking_no')];
			$sales_no_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
			$sales_no_array[$row[csf('id')]]['po_job_no'] = $row[csf('po_job_no')];
			$sales_booking[]= "'".$row[csf('sales_booking_no')]."'";
		}
		?>
		<div align="center">
			<div style="width:1120px; margin-top:10px;">
				<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="1115" rules="all">
					<thead>
						<tr>
							<th width="30">SL</th>
							<th width="100">Buyer</th>
							<th width="90">Job No</th>
							<th width="120">FSO No</th>
							<th width="100">Sales/Booking No</th>
							<th width="80">Within Group</th>
							<th width="100">Style Ref.</th>
							<th width="60">Req. No</th>
							<th width="70">Req. Date</th>
							<th width="80">Req. Quantity</th>
							<th width="100">Demand No</th>
							<th width="70">Demand Date</th>
							<th>Demand Quantity</th>
						</tr>
					</thead>
				</table>
			</div>
			<div style="width:1120px; overflow-y:scroll; max-height:250px;">
				<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="1100" rules="all" id="list_view">
					<tbody>
						<?
						$i = 1;
						foreach ($result as $row) {
							if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
							$job_id = array_unique(explode(",", $sales_order_arr[$row[csf('knit_id')]]));
							$style_ref = $sales_order = $buyer_id = $sales_booking = $po_job_no = '';
							foreach ($job_id as $val) {
								if ($style_ref == '') $style_ref = $sales_no_array[$val]['style_ref'];
								if ($sales_order == '') $sales_order = $sales_no_array[$val]['sales_order'];
								if ($sales_booking == '') $sales_booking = $sales_no_array[$val]['sales_booking'];

								if ($row[csf('within_group')] == 1) {
									if ($po_job_no == '') $job_no = $sales_no_array[$val]['po_job_no'];
									if ($sales_booking != '') $buyer = $sales_no_array[$val]['po_buyer'];
								} else {
									if ($buyer_id == '') $buyer = $sales_no_array[$val]['buyer_id'];
									$job_no="";
								}
							}

							?>
							<tr bgcolor="<? echo $bgcolor; ?>"
								onClick="js_set_value('<? echo $row[csf('requisition_no')] . ',' . $row[csf('company_id')] . ',' . $buyer . ',' . $row[csf("yarn_qnty")] . ',' . $row[csf("issue_qnty")] . ',' . $row[csf("knitting_source")]. ',' . $row[csf("knitting_party")]. ',' . $row[csf("location_id")]. ',' . $row[csf("demand_id")] . ','.$row[csf("demand_system_no")].',1'; ?>')" style="cursor:pointer">
								<td width="30" align="center"><?php echo $i; ?></td>
								<td width="100"><p><?php echo $buyer_arr[$buyer]; ?></p></td>
								<td width="90"><p><?php echo $job_no; ?></p></td>
								<td width="120"><p><?php echo $sales_order; ?></p></td>
								<td width="100"><p><?php echo $sales_booking; ?></p></td>
								<td width="80" align="center"><p><?php echo $yes_no[$row[csf('within_group')]]; ?></p></td>
								<td width="100"><p><?php echo $style_ref; ?></p></td>
								<td width="60" align="center"><p><?php echo $row[csf("requisition_no")]; ?></p></td>
								<td width="70" align="center"><?php echo change_date_format($row[csf("requisition_date")]); ?></td>
								<td width="80" align="right"><?php echo number_format($row[csf("yarn_qnty")], 2, '.', ''); ?></td>
								<td width="100" align="center"><p><?php echo $row[csf("demand_system_no")]; ?></p></td>
								<td width="70" align="center"><?php echo change_date_format($row[csf("demand_date")]); ?></td>
								<td width="" align="right"><?php echo number_format($row[csf("demand_qnty")], 2, '.', ''); ?></p></td>
							</tr>
							<?
							$i++;
						}
						?>
					</tbody>
				</table>
			</div>
		</div>
		<?
	}
	else
	{
		//for booking type with
		if($bookingType == 1)
		{
			$po_array = array();
			$po_sql = sql_select("select a.job_no,a.style_ref_no,b.grouping,b.file_no,b.id,b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$company");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
				$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
				$po_array[$row[csf('id')]]['internal'] = $row[csf('grouping')];
			}

			if ($db_type == 0) {
				$plan_details_array = return_library_array("select dtls_id, group_concat(po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company group by dtls_id", "dtls_id", "po_id");
			} else {
				$plan_details_array = return_library_array("select dtls_id, LISTAGG(po_id, ',') WITHIN GROUP (ORDER BY po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company group by dtls_id", "dtls_id", "po_id");
			}

			$app_nessity=2;
			$app_nessity=return_field_value("yarn_iss_with_serv_app","variable_order_tracking","company_name =$company and variable_list=60 and is_deleted=0 and status_active=1");
			if($app_nessity=="" || $app_nessity==0){
				$app_nessity=2;
			}

			if($knitting_source_id==1)
			{
				$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty,e.id demand_id,e.demand_system_no, sum(d.yarn_demand_qnty) demand_qnty,e.demand_date from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,ppl_yarn_demand_reqsn_dtls d,ppl_yarn_demand_entry_mst e where a.id=b.mst_id and b.id=c.knit_id and c.id=d.requisition_id and d.mst_id=e.id and a.is_sales != 1 and c.status_active=1 and c.is_deleted=0 $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id,e.id,e.demand_system_no,e.demand_date order by e.demand_date desc";

			}
			else
			{
				if($app_nessity==2)
				{
					$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty,e.id demand_id,e.demand_system_no, sum(d.yarn_demand_qnty) demand_qnty,e.demand_date from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,ppl_yarn_demand_reqsn_dtls d,ppl_yarn_demand_entry_mst e where a.id=b.mst_id and b.id=c.knit_id and c.id=d.requisition_id and d.mst_id=e.id and a.is_sales != 1 and c.status_active=1 and c.is_deleted=0 $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id,e.id,e.demand_system_no,e.demand_date order by e.demand_date desc";
				}
				else
				{
					$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty,g.id demand_id,g.demand_system_no, sum(f.yarn_demand_qnty) demand_qnty,g.demand_date from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,ppl_yarn_demand_reqsn_dtls f,ppl_yarn_demand_entry_mst g,wo_booking_dtls d,wo_booking_mst e where a.id=b.mst_id and b.id=c.knit_id and b.id=d.program_no and d.booking_no=e.booking_no and e.is_approved=1 and c.id=f.requisition_id and f.mst_id=g.id and a.is_sales != 1 and c.status_active=1 and c.is_deleted=0  $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id,g.id,g.demand_system_no,g.demand_date order by g.demand_date desc";
				}
			}

			if($app_nessity==2)
			{
				$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty,e.id demand_id,e.demand_system_no, sum(d.yarn_demand_qnty) demand_qnty,e.demand_date from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,ppl_yarn_demand_reqsn_dtls d,ppl_yarn_demand_entry_mst e where a.id=b.mst_id and b.id=c.knit_id and c.id=d.requisition_id and d.mst_id=e.id and a.is_sales = 0 and c.status_active=1 and c.is_deleted=0 $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id,e.id,e.demand_system_no,e.demand_date order by e.demand_date desc";
			}
			else
			{
				$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,ppl_yarn_demand_reqsn_dtls d,ppl_yarn_demand_entry_mst e,wo_booking_dtls f,wo_booking_mst g where a.id=b.mst_id and b.id=c.knit_id and b.id=f.program_no and a.booking_no=f.booking_no and g.is_approved=1 and c.id=d.requisition_id and d.mst_id=e.id and a.is_sales = 0 and c.status_active=1 and c.is_deleted=0  $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id,e.id,e.demand_system_no,e.demand_date order by e.demand_date desc";
			}
			//echo $sql;
			$result = sql_select($sql);
			$i = 1;
			?>
			<div align="center">
				<div style="width:1090px;">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="1087" rules="all">
						<thead>
							<tr>
								<th width="30">SL</th>
								<th width="130">Buyer</th>
								<th width="250">Order No</th>
								<th width="100">Internal Ref</th>
								<th width="100">File No</th>
								<th width="60">Req. No</th>
								<th width="70">Req. Date</th>
								<th width="80">Quantity</th>
								<th width="110">Demand No</th>
								<th width="70">Demand Date</th>
								<th>Demand Quantity</th>
							</tr>
						</thead>
					</table>
				</div>
				<div style="width:1090px; overflow-y:scroll; max-height:250px;">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="1070" rules="all"
					id="list_view">
					<tbody>
						<? foreach ($result as $row)
						{
							if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";

							$po_id = array_unique(explode(",", $plan_details_array[$row[csf('knit_id')]]));
							$po_no = '';
							$style_no = '';
							$job_no = '';
							$internal_ref = '';
							$file_no = '';

							foreach ($po_id as $val)
							{
								if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= "," . $po_array[$val]['no'];
								if ($job_no == '') $job_no = $po_array[$val]['job_no'];
								if ($style_no == '') $style_no = $po_array[$val]['style_ref'];
								if ($internal_ref == '') $internal_ref = $po_array[$val]['internal']; else $internal_ref .= "," . $po_array[$val]['internal'];
								if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
							}
							?>
							<tr bgcolor="<? echo $bgcolor; ?>"
								onClick="js_set_value('<? echo $row[csf('requisition_no')] . ',' . $row[csf('company_id')] . ',' . $row[csf('buyer_id')] . ',' . $row[csf("yarn_qnty")] . ',' . $row[csf("issue_qnty")] . ',' . $row[csf("knitting_source")]. ',' . $row[csf("knitting_party")]. ',' . $row[csf("location_id")] . ',' . $row[csf("demand_id")] . ',' . $row[csf("demand_system_no")].',1'; ?>')"
								style="cursor:pointer">
								<td width="30" align="center"><?php echo $i; ?></td>
								<td width="130"><p><?php echo $buyer_arr[$row[csf("buyer_id")]]; ?></p></td>
								<td width="250"><p><?php echo $po_no; ?></p></td>
								<td width="100"><p><?php echo $internal_ref; ?></p></td>
								<td width="100"><p><?php echo $file_no; ?></p></td>
								<td width="60" align="center"><p><?php echo $row[csf("requisition_no")]; ?></p></td>
								<td width="70" align="center"><?php echo change_date_format($row[csf("requisition_date")]); ?></td>
								<td width="80" align="right"><?php echo number_format($row[csf("yarn_qnty")], 2, '.', ''); ?></td>
								<td width="110" align="center"><p><?php echo $row[csf("demand_system_no")]; ?></p></td>
								<td width="70" align="center"><?php echo change_date_format($row[csf("demand_date")]); ?></td>
								<td width="" align="right"><?php echo number_format($row[csf("demand_qnty")], 2, '.', ''); ?></p></td>
							</tr>
							<?
							$i++;
						}
						?>
					</tbody>
				</table>
			</div>
			</div>
			<?
		}
		else //for booking type without
		{
			$app_nessity=2;
			$app_nessity=return_field_value("yarn_iss_with_serv_app","variable_order_tracking","company_name =$company and variable_list=60 and is_deleted=0 and status_active=1");
			if($app_nessity=="" || $app_nessity==0)
			{
				$app_nessity=2;
			}

			if($app_nessity==2)
			{
				$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty,e.id demand_id,e.demand_system_no, sum(d.yarn_demand_qnty) demand_qnty,e.demand_date from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,ppl_yarn_demand_reqsn_dtls d,ppl_yarn_demand_entry_mst e where a.id=b.mst_id and b.id=c.knit_id and c.id=d.requisition_id and d.mst_id=e.id and a.is_sales = 2 and c.status_active=1 and c.is_deleted=0 $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id,e.id,e.demand_system_no,e.demand_date order by e.demand_date desc";
			}
			else
			{
				$sql = "select a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id as knit_id, sum(c.yarn_qnty) as yarn_qnty,b.knitting_source,b.knitting_party,b.location_id,'' as issue_qnty from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c,ppl_yarn_demand_reqsn_dtls d,ppl_yarn_demand_entry_mst e,wo_booking_dtls d,wo_booking_mst e where a.id=b.mst_id and b.id=c.knit_id and b.id=d.program_no and d.booking_no=e.booking_no and e.is_approved=1 and c.id=f.requisition_id and f.mst_id=g.id and and a.is_sales = 2 and c.status_active=1 and c.is_deleted=0  $cond group by a.company_id, a.buyer_id, a.within_group, a.booking_no, c.requisition_no, c.prod_id, c.requisition_date, c.knit_id,b.knitting_source,b.knitting_party,b.location_id,g.id,g.demand_system_no,g.demand_date order by g.demand_date desc";
			}
			//echo $sql;
			$result = sql_select($sql);
			$i = 1;
			?>
			<div align="center">
				<div style="width:640px;">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="1087" rules="all">
						<thead>
							<tr>
								<th width="30">SL</th>
								<th width="130">Buyer</th>
								<th width="60">Req. No</th>
								<th width="70">Req. Date</th>
								<th width="80">Quantity</th>
								<th width="110">Demand No</th>
								<th width="70">Demand Date</th>
								<th>Demand Quantity</th>
							</tr>
						</thead>
					</table>
				</div>
				<div style="width:640px; overflow-y:scroll; max-height:250px;">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" width="620" rules="all"
					id="list_view">
					<tbody>
						<?
						foreach ($result as $row)
						{
							if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
							?>
							<tr bgcolor="<? echo $bgcolor; ?>"
								onClick="js_set_value('<? echo $row[csf('requisition_no')] . ',' . $row[csf('company_id')] . ',' . $row[csf('buyer_id')] . ',' . $row[csf("yarn_qnty")] . ',' . $row[csf("issue_qnty")] . ',' . $row[csf("knitting_source")]. ',' . $row[csf("knitting_party")]. ',' . $row[csf("location_id")] . ',' . $row[csf("demand_id")] . ',' . $row[csf("demand_system_no")].',0'; ?>')"
								style="cursor:pointer">
								<td width="30" align="center"><?php echo $i; ?></td>
								<td width="130"><p><?php echo $buyer_arr[$row[csf("buyer_id")]]; ?></p></td>
								<td width="60" align="center"><p><?php echo $row[csf("requisition_no")]; ?></p></td>
								<td width="70" align="center"><?php echo change_date_format($row[csf("requisition_date")]); ?></td>
								<td width="80" align="right"><?php echo number_format($row[csf("yarn_qnty")], 2, '.', ''); ?></td>
								<td width="110" align="center"><p><?php echo $row[csf("demand_system_no")]; ?></p></td>
								<td width="70" align="center"><?php echo change_date_format($row[csf("demand_date")]); ?></td>
								<td width="" align="right"><?php echo number_format($row[csf("demand_qnty")], 2, '.', ''); ?></p></td>
							</tr>
							<?
							$i++;
						}
						?>
					</tbody>
				</table>
			</div>
			</div>
			<?
		}
	}
	exit();
}

if ($action == "show_req_list_view")
{
	$ex_data = explode(",", $data);
	$requisition_no = $ex_data[0];
	$company 		= $ex_data[1];
	$buyer 			= $ex_data[2];
	$demand_id 		= $ex_data[3];
	$issue_basis 	= $ex_data[4];

	$product_array = array();

	$count_arr = return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	if($issue_basis == 3)
	{
		if ($reqsation_no != '' || $company != 0)
		{
			$sql = "SELECT a.company_id,a.booking_no,a.buyer_id,a.is_sales,c.requisition_no,c.prod_id,c.requisition_date,sum(c.yarn_qnty) as yarn_qnty
			from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c
			where a.id=b.mst_id and b.id=c.knit_id and c.requisition_no='$requisition_no' and a.company_id='$company' and c.status_active=1 and c.is_deleted=0
			group by a.company_id,a.booking_no,a.buyer_id,a.is_sales,c.requisition_no,c.prod_id,c.requisition_date";
		}
	}
	else
	{
		$sql = "SELECT a.buyer_id, a.is_sales, c.requisition_no, c.prod_id,  d.id demand_id, e.demand_system_no,sum(c.yarn_qnty) as yarn_qnty, sum(d.yarn_demand_qnty) demand_qnty
		from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c, ppl_yarn_demand_reqsn_dtls d, ppl_yarn_demand_entry_mst e
		where a.company_id='$company' and a.id=b.mst_id and b.id=c.knit_id and c.id=d.requisition_id and d.mst_id=e.id and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and e.status_active=1 and e.id=$demand_id
		group by a.buyer_id,a.is_sales,c.requisition_no, c.prod_id, d.id, e.demand_system_no
		order by c.requisition_no asc";
	}
	//echo $sql;
	$result = sql_select($sql);

	$prod_arr = array();
	foreach ($result as $key => $val)
	{
		$prod_arr[$val[csf("prod_id")]] = $val[csf("prod_id")];
	}
	if(!empty($prod_arr))
	{
		$product_ids = implode(",", $prod_arr);
		$productDataArray = sql_select("select a.id, a.product_name_details, a.color,b.color_name, a.lot,a.yarn_count_id,a.yarn_comp_type1st,a.yarn_comp_percent1st,a.yarn_type from product_details_master a, lib_color b where a.color=b.id and a.item_category_id=1 and a.id in($product_ids)");
		foreach ($productDataArray as $rowProd) {
			$product_array[$rowProd[csf('id')]]['desc'] = $count_arr[$rowProd[csf('yarn_count_id')]]." ".$composition[$rowProd[csf('yarn_comp_type1st')]]." ".$rowProd[csf('yarn_comp_percent1st')]."% ".$yarn_type[$rowProd[csf('yarn_type')]]." ". $rowProd[csf('color_name')];
			$product_array[$rowProd[csf('id')]]['color'] = $rowProd[csf('color')];
			$product_array[$rowProd[csf('id')]]['color_name'] = $rowProd[csf('color_name')];
			$product_array[$rowProd[csf('id')]]['lot'] = $rowProd[csf('lot')];
		}
	}
	$i = 1;
	?>
	<fieldset style="width:330px;">
		<table width="100%" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all">
			<thead>
				<th>SL</th>
				<th>Product</th>
				<th>Lot No</th>
				<th>Color</th>
                <?
				//requisition no will be shown only for demand basis
				if($issue_basis==8)
				{
				?>
				<th>Req. No</th>
                <?
				}
				?>
				<th>Qnty</th>
			</thead>
			<tbody>
				<?
				$qnty=0;
				foreach ($result as $key => $val)
				{
					if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";

					$product_name = $product_array[$val[csf("prod_id")]]['desc'];
					$color = $product_array[$val[csf("prod_id")]]['color'];
					$color_name = $product_array[$val[csf("prod_id")]]['color_name'];
					$lot = $product_array[$val[csf("prod_id")]]['lot'];
					$qnty = ($issue_basis == 3) ? $val[csf("yarn_qnty")]:$val[csf("demand_qnty")];

					$expBookinNo = explode("-", $val[csf("booking_no")]);

					if($expBookinNo[1] == 'SMN')
					{
                        $smn_requsition = 1;
					}else{
						$smn_requsition = 0;
					}
					?>
					<tr bgcolor="<? echo $bgcolor; ?>"
						onClick="get_php_form_data('<? echo $val[csf("requisition_no")] . "_" . $val[csf("prod_id")] . "_" . $demand_id . "_" . $val[csf("demand_id")]. "_" . $issue_basis. "_" . $smn_requsition. "_" . $val[csf("company_id")]. "_" . $val[csf("is_sales")]; ?>', 'populate_child_from_data', 'requires/yarn_issue_controller');"
						style="cursor:pointer">
						<td width="20"><? echo $i; ?></td>
						<td width="130"><? echo $product_name; ?></td>
						<td width="60"><p><? echo $lot; ?></p></td>
						<td width="60"><? echo $color_name; ?></td>
                        <?
						//requisition no will be shown only for demand basis
						if($issue_basis==8)
						{
							?>
                            <td width="50" align="center"><p><? echo $val[csf("requisition_no")]; ?></p></td>
                            <?
						}
						?>
						<td align="right"><? echo $qnty; ?></td>
					</tr>
					<?
					$i++;
				}
				?>
			</tbody>
		</table>
	</fieldset>
	<?
	exit();
}

if ($action == "populate_child_from_data")
{
	$exp_data = explode("_", str_replace("'", "", $data));
	$req_no = $exp_data[0];
	$prod_id = $exp_data[1];
	$dmnd_id = $exp_data[2];
	$dmnd_req_id = $exp_data[3];
	$issue_basis = $exp_data[4];
	$smn_requsition = $exp_data[5];
	$company_id = $exp_data[6];
	$is_sales = $exp_data[7];

    $brand_arr = return_library_array("select id, brand_name from lib_brand where status_active=1 and is_deleted=0", 'id', 'brand_name');
	$distribute_qnty_variable="";
	if(trim($company_id)!="")
	{
		$distribute_qnty_variable = return_field_value("distribute_qnty", "variable_settings_production", "company_name='$company_id' and variable_list=5 and status_active=1 and is_deleted=0", "distribute_qnty");
	}

	if($distribute_qnty_variable == 1 && $issue_basis == 3 && $smn_requsition==1)
    {
    	$distribiution_sql = "select requisition_no,prod_id,distribution_qnty from  ppl_yarn_req_distribution where requisition_no=$req_no and prod_id=$prod_id and status_active=1" ;

    	//echo $distribiution_sql; die();

    	$distribiution_rslt = sql_select($distribiution_sql);

		foreach($distribiution_rslt as $row)
		{
			$distribiution_qnty_arr[$row[csf('prod_id')]][$row[csf('requisition_no')]] += number_format($row[csf('distribution_qnty')], 2, '.', '');
		}

		//print_r($distribiution_qnty_arr);

		$cum_issu_return_sql = "select b.prod_id,b.issue_id,b.cons_quantity as return_qnty,c.booking_no req_no from inv_transaction b,inv_receive_master c where  b.mst_id=c.id and b.receive_basis=3 and b.prod_id=$prod_id and b.entry_form ='9' and b.transaction_type=4";
		//echo $cum_issu_return_sql; die();
		$cum_issu_return_res = sql_select($cum_issu_return_sql);
		$cum_issue_return_array=array();
		foreach ($cum_issu_return_res as $row)
		{
			$cum_issue_return_array[$row[csf('prod_id')]][$row[csf('issue_id')]][$row[csf('req_no')]] += number_format($row[csf('return_qnty')], 2, '.', '');
		}

		$cum_issu_sql = "select b.prod_id,b.requisition_no,b.mst_id issue_id,
		sum(CASE WHEN b.receive_basis =3 and b.transaction_type=2 THEN b.cons_quantity ELSE 0 END) AS issue_qnty,
		sum(case when b.receive_basis =3 and b.transaction_type=2 then b.return_qnty else 0 end) as returnable_qnty
		from inv_transaction b where b.status_active=1 and b.is_deleted=0 and b.item_category=1 and b.receive_basis=3 and b.prod_id=$prod_id and b.requisition_no=$req_no
		group by b.prod_id,b.requisition_no,b.mst_id";

		//echo $cum_issu_sql;die();
		$cum_issu_sql_res = sql_select($cum_issu_sql);
		$issue_return_qnty=0;
		foreach ($cum_issu_sql_res as $row)
		{
			$issue_return_qnty = $cum_issue_return_array[$row[csf('prod_id')]][$row[csf('issue_id')]][$row[csf('requisition_no')]];
			$cum_issue_array[$row[csf('prod_id')]][$row[csf('requisition_no')]] += number_format(($row[csf('issue_qnty')] - $issue_return_qnty), 2, '.', '');
			$cum_returnable_array[$row[csf('prod_id')]][$row[csf('requisition_no')]] += number_format($row[csf('returnable_qnty')], 2, '.', '');
		}

        $distribiution_qnty = $distribiution_qnty_arr[$prod_id][$req_no];
        $cum_issue_qnty = $cum_issue_array[$prod_id][$req_no];
        $cum_returnable_qnty = $cum_returnable_array[$prod_id][$req_no];

        echo "$('#hdn_smn_requsition').val('" . $smn_requsition . "');\n";
	    echo "$('#hdn_distribution_qnty').val('" . $distribiution_qnty . "');\n";
	    echo "$('#hdn_cum_issue_qnty').val('" . $cum_issue_qnty . "');\n";
	    echo "$('#hdn_cum_returnable_qnty').val(" . $cum_returnable_qnty . ");\n";

	    echo "$('#txt_returnable_qty').attr('disabled','disabled').attr('placeholder','Display');\n";
    }
    else
    {
    	echo "$('#txt_returnable_qty').removeAttr('disabled','disabled').attr('placeholder','Display');\n";
    }

	$balance_arr=array();
	$sql_trans = sql_select("select sum((case when transaction_type in(1,4,5) then cons_quantity else 0 end)-(case when transaction_type in(2,3,6) then cons_quantity else 0 end)) as balance,prod_id,store_id from inv_transaction where prod_id=" . $prod_id . " and status_active=1 and is_deleted=0 group by prod_id,store_id");
	foreach ($sql_trans as $trans_row) {
		$balance_arr[$trans_row[csf("prod_id")]][$trans_row[csf("store_id")]] += $trans_row[csf("balance")];
	}

	if($db_type==0)
	{
		$sql = "select a.requisition_no,a.prod_id, a.yarn_qnty,b.*,(select sum(d.cons_quantity )  from inv_transaction d where d.transaction_type=2 and d.item_category=1 and a.requisition_no=d.requisition_no and b.id=d.prod_id  and d.status_active=1 and d.is_deleted=0 )issue_qnty,(select group_concat(d.mst_id) from inv_transaction d where  d.transaction_type=2 and d.item_category=1 and a.requisition_no=d.requisition_no and b.id=d.prod_id and d.status_active=1 and d.is_deleted=0) issue_id,c.color_name
		from ppl_yarn_requisition_entry a, product_details_master b,lib_color c
		where a.prod_id=b.id and b.color=c.id and a.requisition_no=$req_no and a.prod_id=$prod_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0";
	}
	else
	{
		$sql = "SELECT a.requisition_no,a.prod_id, a.yarn_qnty,b.*,(select sum(d.cons_quantity )
		from inv_transaction d
		where d.transaction_type=2 and d.item_category=1 and a.requisition_no=d.requisition_no and b.id=d.prod_id  and d.status_active=1 and d.is_deleted=0 )issue_qnty,(select listagg(cast(d.mst_id as varchar(4000)),',') within group (order by d.mst_id) from inv_transaction d where d.transaction_type=2 and d.item_category=1 and a.requisition_no=d.requisition_no and b.id=d.prod_id  and d.status_active=1 and d.is_deleted=0) issue_id,c.color_name
		from ppl_yarn_requisition_entry a, product_details_master b,lib_color c
		where a.prod_id=b.id and b.color=c.id and a.requisition_no=$req_no and a.prod_id=$prod_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
		//and c.status_active=1 and c.is_deleted=0
	}

	$result = sql_select($sql);
	foreach ($result as $row)
	{
		$composition_string = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')];
		if ($row[csf('yarn_comp_type2nd')] != 0) $composition_string .= $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')];

		echo "$('#cbo_supplier').val('" . $row[csf("supplier_id")] . "');\n";
		echo "$('#txt_lot_no').val('" . $row[csf("lot")] . "');\n";
		echo "$('#txt_prod_id').val('" . $row[csf("id")] . "');\n";
		echo "$('#cbo_yarn_count').val(" . $row[csf("yarn_count_id")] . ");\n";
		echo "$('#txt_composition').val('" . $composition_string . "');\n";
		echo "$('#cbo_yarn_type').val('" . $row[csf("yarn_type")] . "');\n";
		echo "$('#cbo_uom').val('" . $row[csf("unit_of_measure")] . "');\n";
		echo "$('#cbo_color').html('<option value=\'" . $row[csf("color")] . "\'>" . $row[csf("color_name")] . "</option>');\n";
		echo "$('#cbo_brand').html('<option value=\'" . $row[csf("brand")] . "\'>" . $brand_arr[$row[csf("brand")]] . "</option>');\n";

		if($row[csf("issue_id")]!="")
		{
			$issue_rtn_qnty=return_field_value("sum(cons_quantity) as cons_quantity", "inv_transaction", "issue_id in(".$row[csf("issue_id")].") and prod_id=".$row[csf("id")]." and transaction_type=4 and status_active=1 and item_category=1", "cons_quantity");
		}

		echo "$('#hidden_p_issue_qnty').val('" . ($row[csf("issue_qnty")] - $issue_rtn_qnty) . "');\n";
		echo "$('#hdn_requis_qnty').val('" . $row[csf("yarn_qnty")] . "');\n";

		if ($db_type == 0)
		{
			$poID = return_field_value("group_concat(distinct(a.po_id)) as po_id", "ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c", "b.id=a.dtls_id and b.id=c.knit_id and requisition_no='" . $row[csf("requisition_no")] . "' and c.prod_id= ".$row[csf("id")]." and a.status_active=1 and b.status_active=1 and c.status_active=1", "po_id");

			$invData = sql_select("select group_concat(distinct(store_id)) as store_id, max(weight_per_bag) as weight_per_bag, max(weight_per_cone) as weight_per_cone from inv_transaction where prod_id=" . $row[csf('id')] . " and item_category=1 and transaction_type in(1,4,5)");
			$store_id = $invData[0][csf('store_id')];
		}
		else
		{
			$poID = return_field_value("LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as po_id", "ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c", "b.id=a.dtls_id and b.id=c.knit_id and requisition_no='" . $row[csf("requisition_no")] . "' and c.prod_id= ".$row[csf("id")]." and a.status_active=1 and b.status_active=1 and c.status_active=1", "po_id");

			$invData = sql_select("select LISTAGG(store_id, ',') WITHIN GROUP (ORDER BY store_id) as store_id, max(weight_per_bag) as weight_per_bag, max(weight_per_cone) as weight_per_cone from inv_transaction where prod_id=" . $row[csf('id')] . " and item_category=1 and transaction_type in(1,4,5)");

			$store_id = $invData[0][csf('store_id')];

		}


		$store_ids = implode(",",array_unique(explode(",", $store_id)));

		echo "load_drop_down( 'requires/yarn_issue_controller', '$store_ids', 'load_drop_down_store_req', 'store_td' );\n";
		echo "$('#cbo_store_name').val('" . $store_ids. "');\n";
		// echo $store_id;die;
		echo "popup_description('".$row[csf("id")]."','".$store_ids."');\n";

		$store_id_arr = array_unique(explode(",", $store_id));
		foreach ($store_id_arr as $store_row) {
			$store_balance += $balance_arr[$row[csf('id')]][$store_row];
		}

		echo "$('#txt_current_stock').val('" . number_format($store_balance,2,'.','') . "');\n";
		echo "set_all_onclick();\n";
		echo "$('#txt_weight_per_bag').val('" . $invData[0][csf("weight_per_bag")] . "');\n";
		echo "$('#txt_weight_per_cone').val('" . $invData[0][csf("weight_per_cone")] . "');\n";
		echo "$('#all_po_id').val('" . $poID . "');\n";

		//for demand basis
		echo "$('#hdn_req_no').val('" . $req_no . "');\n";
		echo "$('#demand_id').val('" . $dmnd_id . "');\n";
		echo "$('#hdn_dmnd_req_id').val('" . $dmnd_req_id . "');\n";
	}


	/**
	 * This is for a just infomational of requisiiton into alert message box, requirement has come from urmi group
	*/
	if ( $issue_basis == 3 && $is_sales==1)
	{
		if($req_no!="")
		{
			$req_con = ($ssue_basis == 8)?" and b.demand_id=$dmnd_id and b.requisition_no=$req_no":" and b.requisition_no=$req_no";

			$sql_issue = "select listagg(a.issue_number_prefix_num,',') within group  (order by a.id) as ISSUE_NUMBERS,sum(cons_quantity) TOTAL_ISSUE from inv_issue_master a ,inv_transaction b where a.id=b.mst_id and a.item_category=1 and b.transaction_type=2 $req_con and b.prod_id=$prod_id  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
			//echo $sql_issue; die;
			$sql_issue_result = sql_select($sql_issue);
			$issue_numbers = $sql_issue_result[0]['ISSUE_NUMBERS'];
			$total_pre_issue_qty = $sql_issue_result[0]['TOTAL_ISSUE'];

			$sql_issue_return = "select listagg(a.recv_number_prefix_num,'') within group (order by a.id) AS RECV_NUMBERS,sum(b.cons_quantity) TOTAL_ISSUE_RTN from inv_receive_master a, inv_transaction b where a.id=b.mst_id and b.item_category=1 and b.transaction_type=4 and b.requisition_no=$req_no and a.receive_basis in(3,8) and b.prod_id=$prod_id  and b.status_active=1";
			//echo $sql_issue_return; die;
			$sql_issue_return_result = sql_select($sql_issue_return);
			$issue_rtn_numbers = $sql_issue_return_result[0]['RECV_NUMBERS'];
			$total_issue_rtn_qty = $sql_issue_return_result[0]['TOTAL_ISSUE_RTN'];

			$total_req_qty = return_field_value("sum(yarn_qnty) as total_req_qty", "ppl_yarn_requisition_entry", "requisition_no=$req_no and prod_id=$prod_id and status_active=1 and is_deleted=0", "total_req_qty");

			$demand_sql = "select listagg(a.demand_prefix_number,',') within group ( order by a.id) AS DEMAND_SYSTEM_NO,sum(b.yarn_demand_qnty) as TOTAL_DEMAND_QNTY from ppl_yarn_demand_entry_mst a , ppl_yarn_demand_reqsn_dtls b where a.id=b.mst_id and b.requisition_no=$req_no and b.prod_id=$prod_id and b.status_active=1 and b.is_deleted=0";
			$demand_sql_result =  sql_select($demand_sql);
			$demand_system_numbers = $demand_sql_result[0]['DEMAND_SYSTEM_NO'];
			$total_demand_qnty = $demand_sql_result[0]['TOTAL_DEMAND_QNTY'];

			$total_req_qty = number_format($total_req_qty,2,".","");
			$total_pre_issue_qty = number_format($total_pre_issue_qty,2,".","");
			$total_issue_rtn_qty = number_format($total_issue_rtn_qty,2,".","");
			$txt_issue_qnty = number_format($txt_issue_qnty,2,".","");
			$issueQtyZs = (($total_pre_issue_qty - $total_issue_rtn_qty) + $txt_issue_qnty);

			$msgString = "Requisition No=$req_no\\nRequisition Quantity=$total_req_qty\\nDemand Numbers=$demand_system_numbers\\nDemand Quantity=$total_demand_qnty\\nIssue Mrr numbers=$issue_numbers\\nIssue quantity=$total_pre_issue_qty\\nIssue Return Numbers=$issue_rtn_numbers\\nIssue Return Quantity=$total_issue_rtn_qty";	
			$msgString = ($msgString!="")?$msgString:"";	

		}
		
		echo "$('#hdn_req_info').val('" . $msgString . "');\n";	
		
	}


	exit();
}

if ($action=="item_description_popup")
{
	echo load_html_head_contents("Item popup", "../../", 1, 1,'','1','');
	extract($_REQUEST);
	?>
	<script>
		function js_set_value(item_description)
		{
			var splitArr = item_description.split("_");
			$("#product_id_td").val(splitArr[0]);
			$("#store_id").val(splitArr[1]);
			$("#floor_id").val(splitArr[2]);
			$("#room").val(splitArr[3]);
            $("#rack").val(splitArr[4]);
            $("#shelf").val(splitArr[5]);
            $("#bin_box").val(splitArr[6]);
            $("#current_stock").val(splitArr[7]);
			parent.emailwindow.hide();
		}
	</script>
	</head>
	<body>
		<div align="center" style="width:100%" >
			<form name="item_popup_1"  id="item_popup_1">
		      	<?
				$sql="SELECT prod_id, store_id, floor_id, room, rack, self, bin_box, round (sum((case when transaction_type in(1,4,5) then cons_quantity else 0 end)-(case when transaction_type in(2,3,6) then cons_quantity else 0 end)),2) as balance
				from inv_transaction b
				where company_id=$company_id and prod_id=$prod_id and store_id in($stores) and item_category=1 and status_active=1 and is_deleted=0
				group by prod_id, store_id, floor_id, room, rack, self, bin_box";
				//echo $sql;
				$store_arr = return_library_array("select id, store_name from lib_store_location","id","store_name");
				$floor_room_rack_arr = return_library_array("select floor_room_rack_id, floor_room_rack_name from lib_floor_room_rack_mst","floor_room_rack_id","floor_room_rack_name");
				$arr=array(1=>$store_arr,2=>$floor_room_rack_arr,3=>$floor_room_rack_arr,4=>$floor_room_rack_arr,5=>$floor_room_rack_arr,6=>$floor_room_rack_arr,7=>$floor_room_rack_arr);

				echo  create_list_view ( "list_view","Product Id,Store,Floor,Room,Rack,Shelf,Bin,Current Stock", "50,110,70,70,70,70,70","680","250",0, $sql, "js_set_value", "prod_id,store_id,floor_id,room,rack,self,bin_box,balance", "", 1, "0,store_id,floor_id,room,rack,self,bin_box,0", $arr, "prod_id,store_id,floor_id,room,rack,self,bin_box,balance", "", 'setFilterGrid("list_view",-1);');

		    	?>
				<input type="hidden" id="product_id_td" />
				<input type="hidden" id="store_id" />
				<input type="hidden" id="floor_id" />
				<input type="hidden" id="room" />
				<input type="hidden" id="rack" />
				<input type="hidden" id="shelf" />
				<input type="hidden" id="bin_box" />
				<input type="hidden" id="current_stock" />
		   	</form>
	   </div>
	</body>
	<script src="../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
}

if ($action == "populate_req_store_data")
{
	$exp_data = explode("**", str_replace("'", "", $data));
	$prod_id = $exp_data[0];
	$store_id = $exp_data[1];
	$comp_id = $exp_data[2];
	$sql_trans = sql_select("select sum((case when transaction_type in(1,4,5) then cons_quantity else 0 end)-(case when transaction_type in(2,3,6) then cons_quantity else 0 end)) as balance from inv_transaction where prod_id=$prod_id and store_id=$store_id and company_id=$comp_id and status_active=1 and is_deleted=0");
	echo "$('#txt_current_stock').val('" . $sql_trans[0][csf("balance")] . "');\n";
}

if ($action == "show_yarn_dyeing_list_view")
{
	$product_array = return_library_array("select id, lot from product_details_master where item_category_id=1", 'id', 'lot');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", 'id', 'yarn_count');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');

	$sql = "select id, job_no,job_no_id, product_id, count, yarn_description, entry_form, yarn_comp_type1st, yarn_comp_percent1st, yarn_type, yarn_color, yarn_wo_qty from wo_yarn_dyeing_dtls where mst_id=$data and status_active=1 and is_deleted=0";
	$result = sql_select($sql);
	foreach ($result as $row) {
		$sample_arr[] = $row[csf("job_no_id")];
		if ($row[csf("entry_form")] == 42 || $row[csf("entry_form")] == 114) {
			$job_label = "Style";
		}else{
			$job_label = "Job";
		}
	}
	$sample_array = return_library_array("select id,style_ref_no from sample_development_mst where id in(".implode(",",$sample_arr).") and status_active=1 and is_deleted=0 ", 'id', 'style_ref_no');
	?>
	<fieldset style="width:310px;">
		<table width="100%" class="rpt_table" cellpadding="0" cellspacing="0" rules="all" border="1">
			<thead>
				<th>SL</th>
				<th><? echo $job_label;?></th>
				<th>Lot</th>
				<th>Product</th>
				<th>Qnty</th>
			</thead>
			<tbody>
				<?
				$i = 1;
				foreach ($result as $row) {
					if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";

					if ($row[csf("entry_form")] == 114 || $row[csf("entry_form")] == 125) {
						$product_name = $count_arr[$row[csf("count")]] . " " . $composition[$row[csf("yarn_comp_type1st")]] . " " . $row[csf("yarn_comp_percent1st")] . " " . $yarn_type[$row[csf("yarn_type")]] . " " . $color_name_arr[$row[csf("yarn_color")]];
						$lot = "&nbsp;";
					} else {
						if ($row[csf("product_id")] == 0) {
							$product_name = $count_arr[$row[csf("count")]] . " " . $row[csf("yarn_description")];
							$lot = "&nbsp;";
						} else {
							$product_name = $count_arr[$row[csf("count")]] . " " . $row[csf("yarn_description")];
							$lot = $product_array[$row[csf("product_id")]];
						}
					}
					if ($row[csf("entry_form")] == 42 || $row[csf("entry_form")] == 114) {
						$job_no = $sample_array[$row[csf("job_no_id")]];
					}else{
						$job_no = $row[csf("job_no")];
					}
					?>
					<tr bgcolor="<? echo $bgcolor; ?>"
						onClick="get_php_form_data(<? echo "'".$row[csf("id")]."_".$row[csf("yarn_color")]."'"; ?>, 'populate_child_from_yarn_dyeing_data', 'requires/yarn_issue_controller');"
						style="cursor:pointer">
						<td width="20"><? echo $i; ?></td>
						<td width="80"><? echo $job_no; ?>&nbsp;</td>
						<td width="50"><p><? echo $lot; ?></p></td>
						<td><p><? echo $product_name; ?></p></td>
						<td width="50" align="right"><? echo number_format($row[csf("yarn_wo_qty")], 2, '.', '');  ?></td>
					</tr>
					<?
					$i++;
				}
				?>
			</tbody>
		</table>
	</fieldset>
	<?
	exit();
}

if ($action == "populate_child_from_yarn_dyeing_data")
{

	$dataArr = explode("_", $data);
	$id = $dataArr[0];
	$color_id = $dataArr[1];

	$sql = "select a.id,a.mst_id, a.job_no, a.product_id, a.count, a.yarn_description, a.entry_form, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_type, a.yarn_color, a.yarn_wo_qty, b.lot, b.supplier_id,(booking_no || fab_booking_no) as fabric_booking_no from wo_yarn_dyeing_dtls a left join product_details_master b on a.product_id=b.id where a.id=$id and a.yarn_color=$color_id and a.status_active=1 and a.is_deleted=0";

	$result = sql_select($sql);
	foreach ($result as $row)
	{
		echo "$('#job_no').val('" . $row[csf("job_no")] . "');\n";
		echo "$('#hdn_fabric_booking_no').val('" . $row[csf("fabric_booking_no")] . "');\n";
		$style_ref_no = return_field_value("style_ref_no", "wo_po_details_master", "job_no='" . $row[csf("job_no")] . "'");
		echo "$('#txt_style_ref').val('" . $style_ref_no . "');\n";
		echo "$('#txt_buyer_job_no').val('" . $row[csf("job_no")] . "');\n";

		$prodData = sql_select("select id, unit_of_measure, supplier_id, lot, current_stock, yarn_count_id, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_type, color, brand, item_code from product_details_master where id=" . $row[csf("product_id")]);


		if ($db_type == 0) {
			$invData = sql_select("select group_concat(distinct(store_id)) as store_id, max(weight_per_bag) as weight_per_bag, max(weight_per_cone) as weight_per_cone from inv_transaction where prod_id=" . $row[csf("product_id")] . " and item_category=1 and transaction_type in(1,5,4)");
			$store_id = $invData[0][csf('store_id')];
		} else {
			// $invData = sql_select("select LISTAGG(store_id, ',') WITHIN GROUP (ORDER BY store_id) as store_id, max(weight_per_bag) as weight_per_bag, max(weight_per_cone) as weight_per_cone from inv_transaction where prod_id=" . $row[csf("product_id")] . " and item_category=1 and transaction_type in(1,5,4)");

			$invData = sql_select("select LISTAGG(store_id, ',') WITHIN GROUP (ORDER BY store_id) as store_id, max(nvl(weight_per_bag,0)) as weight_per_bag, max(nvl(weight_per_cone,0)) as weight_per_cone from inv_transaction where prod_id=" . $row[csf("product_id")] . " and item_category=1 and transaction_type in(1,5,4)");

			$store_id = $invData[0][csf('store_id')];
			$store_id = implode(",", array_unique(explode(",", $store_id)));
		}

		if ($row[csf("entry_form")] == 42 || $row[csf("entry_form")] == 114) {
			echo "$('#txt_issue_qnty').removeAttr('placeholder').removeAttr('readonly').removeAttr('onDblClick');\n";
		} else {
			echo "$('#txt_issue_qnty').attr('placeholder','Double Click').attr('onDblClick','openmypage_po()').attr('readonly',true);\n";
		}

		if($row[csf("entry_form")] == 135)
		{
			echo "$('#txt_current_stock').val(" . $prodData[0][csf("current_stock")] . ");\n";

			echo "load_drop_down( 'requires/yarn_issue_controller', '$store_id', 'load_drop_down_store_req', 'store_td' );\n";
			echo "$('#cbo_store_name').val('" . $store_id . "');\n";
		}

		if ($row[csf("entry_form")] == 114 || $row[csf("entry_form")] == 125 || $row[csf("entry_form")] == 135) // with ref
		{
			echo "$('#cbo_yarn_count').val(" . $row[csf("count")] . ");\n";
			$composition_string = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%";
			echo "$('#txt_lot_no').val('" . $row[csf("lot")] . "');\n";
			echo "$('#txt_prod_id').val('" . $row[csf("product_id")] . "');\n";
			echo "$('#txt_composition').val('" . $composition_string . "');\n";
			echo "$('#cbo_yarn_type').val('" . $row[csf("yarn_type")] . "');\n";
			echo "$('#cbo_color').val('" . $row[csf("yarn_color")] . "');\n";
			echo "$('#cbo_dyeing_color').val('" . $row[csf("yarn_color")] . "');\n";
			echo "$('#txt_composition_id').val('" . $row[csf("yarn_comp_type1st")] . "');\n";
			echo "$('#txt_composition_percent').val('" . $row[csf("yarn_comp_percent1st")] . "');\n";
			echo "$('#cbo_supplier').val('" . $row[csf("supplier_id")] . "');\n";
		}
		else
		{
			$composition_string = $composition[$prodData[0][csf('yarn_comp_type1st')]] . " " . $prodData[0][csf('yarn_comp_percent1st')] . "%";
			if ($prodData[0][csf('yarn_comp_type2nd')] != 0) $composition_string .= $composition[$prodData[0][csf('yarn_comp_type2nd')]] . " " . $prodData[0][csf('yarn_comp_percent2nd')] . "%";

			echo "$('#cbo_supplier').val('" . $prodData[0][csf("supplier_id")] . "');\n";
			echo "$('#txt_lot_no').val('" . $prodData[0][csf("lot")] . "');\n";
			echo "$('#txt_prod_id').val('" . $prodData[0][csf("id")] . "');\n";
			echo "$('#txt_current_stock').val(" . $prodData[0][csf("current_stock")] . ");\n";
			echo "$('#cbo_yarn_count').val(" . $prodData[0][csf("yarn_count_id")] . ");\n";
			echo "$('#txt_composition').val('" . $composition_string . "');\n";
			echo "$('#cbo_yarn_type').val('" . $prodData[0][csf("yarn_type")] . "');\n";
			echo "$('#cbo_uom').val('" . $prodData[0][csf("unit_of_measure")] . "');\n";
			echo "$('#cbo_color').val('" . $prodData[0][csf("color")] . "');\n";
			echo "$('#cbo_brand').val('" . $prodData[0][csf("brand")] . "');\n";

			if($row[csf("job_no")]=="") // without ref
			{
				echo "$('#txt_issue_qnty').removeAttr('ondblclick').removeAttr('readonly').attr('placeholder','Write');\n";
			}
			else // with ref
			{
				echo "$('#txt_issue_qnty').attr('ondblclick','openmypage_po()').attr('readonly','readonly').attr('placeholder','Double Click');\n";
			}


			//echo "load_drop_down( 'requires/yarn_issue_controller', '$store_id', 'load_drop_down_store_req', 'store_td' );\n";

			echo "$('#cbo_store_name').val('" . $store_id . "');\n";
			echo "$('#txt_weight_per_bag').val('" . $invData[0][csf("weight_per_bag")] . "');\n";
			echo "$('#txt_weight_per_cone').val('" . $invData[0][csf("weight_per_cone")] . "');\n";
		}

		echo "$('#hdn_wo_qnty').val('" . $row[csf("yarn_wo_qty")] . "');\n";
		if( $row[csf("entry_form")] == 41 || $row[csf("entry_form")] == 42 || $row[csf("entry_form")] == 114 || $row[csf("entry_form")] == 125 || $row[csf("entry_form")] || $row[csf("entry_form")] == 135)
		{
			echo "load_drop_down( 'requires/yarn_issue_controller'," . $row[csf("mst_id")] . "+'_'+" . $row[csf("id")] . "+'_'+" . $row[csf("yarn_color")] . ",'load_drop_down_dyeing_color', 'dyeingColor_td' );\n";

			echo "$('#cbo_dyeing_color').val('" . $row[csf("yarn_color")] . "');\n";
		}

		//for palpal group
		if($row[csf("product_id")]*1 != 0)
		{
			echo "popup_description('".$row[csf("product_id")]."','".$store_id."');\n";
		}
	}
	exit();
}

if ($action == "yarn_issue_print")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);
	$print_with_vat = $data[7];
	$company=$data[0];
	$location=$data[8];
	$store_id=$data[9];

	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	//echo $store_location_id.'system';

	//$supplier_arr = return_library_array("select id, short_name from lib_supplier", 'id', 'short_name');
	$supplier_arr = return_library_array("select id,supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
    //$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');

	$sql = "select a.id, a.issue_number, a.issue_basis, a.location_id, a.buyer_job_no, a.booking_id, a.booking_no, a.loan_party, a.knit_dye_source, a.challan_no, a.issue_purpose, a.buyer_id, a.issue_date, a.knit_dye_company, a.gate_pass_no, a.remarks  from inv_issue_master a where a.id='$data[5]'";
    //echo $sql;die;
	$dataArray = sql_select($sql);
	$demand_no = array();
	if( $dataArray[0][csf('issue_basis')]==3 || $dataArray[0][csf('issue_basis')]==8 )
	{

		$planbooking = sql_select("select b.requisition_no, e.booking_no as pln_booking_no, d.id from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.is_deleted=0 and d.status_active=1
		and e.is_deleted=0 and e.status_active=1 and b.transaction_type = 2 and a.id='$data[5]' ");

		//for demand no
		if( $dataArray[0][csf('issue_basis')]==8 )
		{
			$req_no_arr = array();
			foreach($planbooking as $row)
			{
				$req_no_arr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];
			}

			$req_sql_zs = sql_select("select a.demand_system_no from ppl_yarn_demand_entry_mst a, ppl_yarn_demand_entry_dtls b where a.id = b.mst_id and b.requisition_no in(".implode(',', $req_no_arr).")");
			foreach($req_sql_zs as $row)
			{
				$demand_no[$row[csf('demand_system_no')]] = $row[csf('demand_system_no')];
			}
		}

	}

	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$copyNo = "";
	for ($x = 1; $x <= 3; $x++)
	{
		if($x==1)
		{
			$copyNo ="<span style='font-size:x-large;'>1<sup>st</sup> Copy</span>";
		} else if($x==2){
			$copyNo ="<span style='font-size:x-large;'>2<sup>nd</sup> Copy</span>";
		} else {
			$copyNo ="<span style='font-size:x-large;'>3<sup>rd</sup> Copy</span>";
		}

		$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
		?>
		<div style="width:1150px;">
			<table width="1100" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td colspan="6" align="center" style="font-size:18px"></td>
					<td style="font-size:x-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">
					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="4" align="center" style="font-size:18px">
						<strong style="font-size:25px"><? echo $com_dtls[0]; ?></strong><br>
						<?
						echo $com_dtls[1];
						?>
					</td>
					<td colspan="2" id="barcode_img_id">&nbsp;</td>
					<td colspan="3" style="color:black; font-weight:bold;"><? echo $copyNo;?></td>
				</tr>
				<tr>
					<td colspan="6" align="center" style="font-size:20px"><strong><u>Yarn Delivery Challan/Gate
					Pass</u></strong></center></td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td style="font-size:18px" width="160"><strong>Issue No</strong></td>
					<td style="font-size:18px" width="175px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('issue_number')]; ?></td>
					<td style="font-size:18px" width="120"><strong>Booking</strong></td>
					<td style="font-size:18px" width="175px"><strong>:</strong>&nbsp;
						<?
						if( $dataArray[0][csf('issue_basis')]==3 || $dataArray[0][csf('issue_basis')]==8 )
						{
							$bookingNo = $planbooking[0][csf('pln_booking_no')];
							$challan_prog = $planbooking[0][csf('id')];

						}
						else
						{
							$bookingNo = $dataArray[0][csf('booking_no')];
							$challan_prog = $dataArray[0][csf('challan_no')];
						}
						echo $bookingNo;
						?>
					</td>
					<td style="font-size:18px" width="125"><strong>Knitting Source</strong></td>
					<td style="font-size:18px" width="175px"><strong>:</strong>&nbsp;<? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
				</tr>
				<tr>
					<td style="font-size:18px"><strong>Challan/Program No</strong></td>
					<td style="font-size:18px" width="175px"><strong>:</strong>&nbsp;<? echo $challan_prog; ?></td>
					<td style="font-size:18px"><strong>Issue Purpose</strong></td>
					<td style="font-size:18px" width="175px"><strong>:</strong>&nbsp;<? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
					echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
					?></td>
		<td style="font-size:18px"><strong>Issue Date</strong></td>
		<td width="175px" style="font-size:18px"><strong>:</strong>&nbsp;<? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
	</tr>
	<tr>
		<td style="font-size:18px"><strong>Issue To</strong></td>
		<?
		if ($dataArray[0][csf('knit_dye_source')] == 3)
		{
			$supp_add = $dataArray[0][csf('knit_dye_company')];
			$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
			foreach ($nameArray as $result) {
				$address = "";
							if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
						}
						unset($nameArray);
					}

					$loan_party_add = $dataArray[0][csf('loan_party')];
					$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
					foreach ($loanPartyArray as $result) {
						$addressParty = "";
						if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($loanPartyArray);
					?>
					<td style="font-size:18px" colspan="3"><strong>:</strong>&nbsp;
						<?
						if ($dataArray[0][csf('issue_purpose')] == 3) {
							echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
						} else if ($dataArray[0][csf('issue_purpose')] == 5) {
							echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
						} else {
							if ($dataArray[0][csf('knit_dye_source')] == 1)
								echo $company_library[$dataArray[0][csf('knit_dye_company')]];
							else
								echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
						}
						?>
					</td>
                    <td style="font-size:18px"><strong>Location</strong></td>
					<td style="font-size:18px"><strong>:</strong>&nbsp;<? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>
				</tr>
				<tr>
					<td style="font-size:18px"><strong>Demand No.</strong></td>
					<td style="font-size:18px" width="175px"><strong>:</strong>&nbsp;<? echo implode(', ', $demand_no); ?></td>
					<td style="font-size:18px"><strong>Gate Pass No.</strong></td>
					<td style="font-size:18px" width="175px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('gate_pass_no')]; ?></td>
					<td style="font-size:18px"><strong>Do No</strong></td>
					<td style="font-size:18px" width="175px"><strong>:</strong>&nbsp;<? //echo $dataArray[0][csf('remarks')];
					?></td>
				</tr>
				<tr>
					<td style="font-size:18px" valign="top"><strong>Remarks</strong></td>
					<td style="font-size:18px" colspan="5"><strong>:</strong>&nbsp;<p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
				</tr>
				<?
				if ($print_with_vat == 1)
				{
					?>
					<tr>
						<td style="font-size:18px"><strong>VAT Number</strong></td>
						<td style="font-size:18px"><strong>:</strong>&nbsp;<p>
							<?
							$vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
							echo $vat_no;
							?>
                        </p></td>
                    </tr>
                    <?
                }
				else
				{
                    ?>
                    <tr>
                        <td style="font-size:18px" valign="top">&nbsp;</strong></td>
                        <td>&nbsp;</td>
                    </tr>
                    <?
                }
                ?>
            </table>
            <br>
            <div style="width:100%;">
                <div style="clear:both;">
                    <table style="margin-right:-40px;" cellspacing="0" width="1250" border="1" rules="all"
                    class="rpt_table">
                    <thead bgcolor="#dddddd" style="font-size:18px">
                        <th style="font-size:17px" width="20">SL</th>
                        <th style="font-size:17px" width="45">Req. No</th>
                        <th style="font-size:17px" width="50">Program No</th>
                        <th style="font-size:17px" width="50">Lot No</th>
                        <th style="font-size:17px" style="font-size:17px" width="65">Y. Type</th>
                        <th style="font-size:17px" width="110">Item Details</th>
                        <th style="font-size:17px" width="65">Grey Color</th>
                        <th style="font-size:17px" width="65">Dye. Color</th>
                        <th style="font-size:17px" width="60">Supp.</th>
                        <th style="font-size:17px" width="60"><b>Issue Qty(kg)</b></th>
                        <th style="font-size:17px" width="60">Rtnbl Qty(kg)</th>
                        <th style="font-size:17px" width="80">Bag & Cone</th>
                        <th style="font-size:17px" width="80">Store</th>
                        <th style="font-size:17px" width="100">Buyer & Job</th>
                        <th style="font-size:17px" width="100">Cust. Buyer</th>
                        <th style="font-size:17px" width="120">Order & Style</th>
                        <th style="font-size:17px" width="100">Inte. Ref & File</th>
                        <th style="font-size:17px">Remarks</th>
                    </thead>
                    <?
                    $wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");

                    $cond = "";
                    if ($data[5] != "") $cond .= " and c.id='$data[5]'";

                    $po_array = array();
                    $job_array = array();


                    $costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0]");
                    foreach ($costing_sql as $row)
                    {
                        $po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
                        $po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
                        $po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
                        $po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
                        $job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
                        $job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];

						$job_intfarray[$row[csf('job_no')]]['grouping'] = $row[csf('grouping')];
                    }

                    unset($costing_sql);

					$sales_order_array = array();
					$sales_order_sql = sql_select("select a.id,a.sales_booking_no, a.job_no,a.style_ref_no, a.buyer_id,b.job_no po_job_no,b.buyer_id po_buyer,a.within_group from fabric_sales_order_mst a left join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.status_active = 1 and a.is_deleted = 0 and a.company_id=$data[0]");
					foreach ($sales_order_sql as $row)
					{
						$sales_order_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
						$sales_order_array[$row[csf('id')]]['sales_order_no'] = $row[csf('job_no')];
						$sales_order_array[$row[csf('id')]]['po_job_no'] = $row[csf('po_job_no')];
						$sales_order_array[$row[csf('id')]]['sales_booking_no'] = $row[csf('sales_booking_no')];
						$sales_order_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
						$sales_order_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
						$sales_order_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
					}

					$sales_style_des_arr = array();
					$sales_samp_booking_sql = sql_select("SELECT b.booking_no, b.style_des FROM fabric_sales_order_mst a, wo_non_ord_samp_booking_dtls b WHERE a.sales_booking_no = b.booking_no and a.company_id=$data[0] and b.status_active=1 and b.is_deleted=0");
					foreach ($sales_samp_booking_sql as $row)
					{
						$sales_style_des_arr[$row[csf('booking_no')]]['style_des'] .= $row[csf('style_des')].',';
					}
					unset($sales_samp_booking_sql);

                    $stl_array = array();

                    $stl_sql = sql_select("select job_no, style_ref_no from wo_po_details_master");
                    foreach ($stl_sql as $row)
                    {
                        $stl_array[$row[csf('style_ref_no')]]['job'] = $row[csf('job_no')];
                    }
                    //var_dump($stl_array);
                    unset($stl_sql);

                    $job_no_array = array();
                    $jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id, po_buyer, customer_buyer from fabric_sales_order_mst");
                    foreach ($jobData as $row)
                    {
                        $job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
                        $job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
                        $job_no_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
                        $job_no_array[$row[csf('id')]]['customer_buyer'] = $row[csf('customer_buyer')];
                    }
                    //var_dump($po_array);
                    $po_id_req_array = array();
                    $is_sales_array = array();
                    if ($db_type == 0)
					{
                        $poID = " select c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales";
                    }
					else
					{
                        $poID = "select c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales";
                    }
                    $poID_sql_result = sql_select($poID);
                    foreach ($poID_sql_result as $row)
					{
                        $po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
                        $is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];

						$program_array[$row[csf('requisition_no')]]['program_no'] = $row[csf('knit_id')];
						$program_array[$row[csf('requisition_no')]]['poid'] = $row[csf('poid')];
						//$program_array[$row[csf('requisition_no')]]['buyer_id'] = $row[csf('buyer_id')];
                    }
                    unset($poID_sql_result);


                    $i = 1;
                    if ($db_type == 0) {
                        $sql_result = sql_select("SELECT a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, b.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose,b.remarks
                            from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id left join fabric_sales_order_mst e on d.po_breakdown_id=e.id
                            where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
                            group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose,b.remarks order by b.requisition_no DESC");
                    } else {
                        $sql_result = sql_select("SELECT a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, b.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose,b.remarks
                        from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id left join fabric_sales_order_mst e on d.po_breakdown_id=e.id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
                        group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose,b.remarks order by b.requisition_no DESC");

                    }
                    $all_req_no = '';
                    $all_prod_id = '';
                    $order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
                    $tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
                    foreach ($sql_result as $row)
					{
                        if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
                        if ($row[csf('requisition_no')] != '')
						{
                            if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
                            if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
                        }
                        $order_qnty_val = $row[csf('cons_quantity')];
                        $order_qnty_val_sum += $order_qnty_val;

                        $order_amount_val = $row[csf('order_amount')];
                        $order_amount_val_sum += $order_amount_val;

                        $no_of_bags_val = $row[csf('no_of_bags')];
                        $no_of_bags_val_sum += $no_of_bags_val;

                        $po_id = explode(",", $row[csf('po_id')]);
                        $po_no = '';
                        $style_ref = '';
                        $job_no = '';
                        $buyer = '';
                        //$data=explode('*',$data);
                        $productdtls = $row[csf('product_name_details')];
                        $productArr = explode(' ', $productdtls);

                        $proddtls='';
                        $proddtls=$yarn_count_details[$row[csf('yarn_count_id')]];
                        if($row[csf('yarn_count_id')]>0) $proddtls.=", ";
                        $proddtls.=$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."%";

                    /*if($row[csf('yarn_comp_type1st')]>0) $proddtls.=", ";
                    $proddtls.=$yarn_type[$row[csf('yarn_type')]];*/

                    /*if ($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' && $productArr[4]!=''&& $productArr[5]!='')
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].'%, '.$productArr[3].' '.$productArr[4]."%, ".$productArr[5].", ".$productArr[6];
                    }
                    else if ($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' && $productArr[4]!='')
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, '.$productArr[3].', '.$productArr[4];
                    }
                    else if($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' )
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, '.$productArr[3];
                    }
                    else if($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='')
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, ';
                    }
                    else if($productArr[0]!='' && $productArr[1]!='' )
                    {
                        $proddtls=$productArr[0].', '.$productArr[1];
                    }
                    else if($productArr[0]!='')
                    {
                        $proddtls=$productArr[0];
                    }
                    else
                    {
                        $proddtls='';
                    }*/

                    $internal_ref = '';
                    $style_ref = '';
                    $file_no = '';

                    if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
                    {
                        foreach ($po_id as $val)
                        {
							if($row[csf('is_sales')]==1)
							{
								if ($po_no== '') $po_no = $sales_order_array[$val]['sales_booking_no'];
								if ($style_ref == '') $style_ref = $sales_style_des_arr[$sales_order_array[$val]['sales_booking_no']]['style_des'];

								$po_job = $sales_order_array[$val]['po_job_no'];

								if ($internal_ref == '') $internal_ref = $job_intfarray[$po_job]['grouping']; else $internal_ref .= "," . $job_intfarray[$po_job]['grouping'];
							}
							else
							{
								if($po_array[$val]['no'] !='')
								{
									if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
									if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								}

								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];

							}

                            if ($job_no == '') $job_no = $po_array[$val]['job_no'];

                            if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                            if ($sales_booking_no== '') $sales_booking_no = $sales_order_array[$val]['sales_booking_no'];

                            if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                        }
                        $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                        $job_file = array_unique(explode(",", rtrim($file_no, ", ")));
                        $ref_cond = '';
                        foreach ($job_ref as $ref) {
                            //$ref_cond.=", ".$ref;
                            if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                        }
                        $file_con = '';
                        foreach ($job_file as $file) {
                            if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                        }

                        $buyer_job = '';
                        if ($row[csf('issue_basis')] == 1)
                        {
                            if ($dataArray[0][csf('issue_purpose')] == 8)
                            {
                                $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                            }
                            else
                            {
                                if ($row[csf('buyer_job_no')] != "")
                                {
									if($row[csf('job_no')])
									{
                                       $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('job_no')];
									}
									else
									{
                                        $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
									}
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                                }

                            }

                        }
                        else if ($row[csf('issue_basis')] == 2)
                        {
                            $buyer_job = '';
                        }
						if(!empty($row[csf('customer_buyer')]))
						{
							$customer_buyer = $buyer_arr[$row[csf('customer_buyer')]];
						}
						else
						{
                           $customer_buyer = $buyer_arr[$job_no_array[$row[csf('buyer_job_no')]]['customer_buyer']];
						}
                    }
					// else if ($row[csf('issue_basis')] == 1 && $row[csf('issue_purpose')] == 2)
                    // {

					// }
                    else if ($row[csf('issue_basis')] == 3)
                    {
                        if ($is_sales_array[$row[csf('requisition_no')]] == 1)
                        {
                            $buyer_job = '';
                            foreach (array_unique($po_id) as $val) {
                                if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
                                if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
                                $customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];

                                if ($buyer_job == '')
                                {
                                    if ($job_no_array[$val]['within_group'] == 1)
                                    {
                                        $buyer_data = $buyer_arr[$job_no_array[$val]['po_buyer']];
                                        $job_data = $stl_array[$job_no_array[$val]['style_ref']]['job'];
                                        $buyer_job = $buyer_data.' & '.$job_data;
                                    }
                                    else
                                    {
                                        $buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
                                    }
                                }
                            }
                        }
                        else
                        {
                            foreach ($po_id as $val)
                            {
                                if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
                                if ($job_no == '') $job_no = $po_array[$val]['job_no'];
                                if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
                                if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                                if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
                                if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                            }

                            $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                            $job_file = array_unique(explode(",", rtrim($file_no, ", ")));

                            $ref_cond = '';
                            foreach ($job_ref as $ref) {
                                //$ref_cond.=", ".$ref;
                                if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                            }

                            $file_con = '';
                            foreach ($job_file as $file) {
                                if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                            }
                            if ($job_no != '')
                            {
                                $buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
                            }
                            else
                            {
                                if(!empty($po_array[$val]['buyer_name']))
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                            }
                        }
                    }

                    else
                    {
                        foreach (array_unique($po_id) as $val)
                        {
                            if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
                            if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
                            $customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];
                            if ($buyer_job == '')
                            {
                                if ($job_no_array[$val]['within_group'] == 1)
                                {

                                    $buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
                                }
                            }

							if ($is_sales_array[$row[csf('requisition_no')]] == 1)
                        	{
								$po_job = $sales_order_array[$val]['po_job_no'];

								 if ($internal_ref == '') $internal_ref = $job_intfarray[$po_job]['grouping']; else $internal_ref .= "," . $job_intfarray[$po_job]['grouping'];

							}
                        }

						$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));

						$ref_cond = '';
						foreach ($job_ref as $ref)
						{
							if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
						}



                    }

                    $no_bag_cone = "";
                    $wt_bag_cone = "";
                    if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

                    if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" style="font-size:13px">
                        <td style="font-size:17px" width="20"><? echo $i; ?></td>
                        <td style="font-size:17px" width="45">
                            <div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
                        </td>
                        <td style="font-size:17px" width="50">
                            <div style="word-wrap:break-word; width:50px"><? echo $program_array[$row[csf('requisition_no')]]['program_no']; ?></div>
                        </td>
                        <td style="font-size:17px" width="50">
                            <div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
                        </td>
                        <td style="font-size:17px" width="65">
                            <div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
                        </td>
                        <td style="font-size:17px" width="110">
                            <div style="word-wrap:break-word; width:110px">
                                <?
                                //echo $proddtls;
                                echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
                                ?>
                            </div>
                        </td>
                        <td style="font-size:17px" width="65">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('color')]]; ?></div>
                        </td>
                        <td style="font-size:17px" width="65">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
                        &nbsp;</div>
                    </td>
                    <td style="font-size:17px" width="60">
                        <div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
                    </td>
                    <td style="font-size:17px" align="right"
                    width="60"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
                    <td style="font-size:17px" align="right"
                    width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
                    <td style="font-size:17px" width="80">
                        <div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
                    &nbsp;</div>
                </td>
                <td style="font-size:17px" width="80">
                    <div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
                </td>
                <td style="font-size:17px" width="100">
                    <div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
                </td>
                <td style="font-size:17px" width="100">
                    <div style="word-wrap:break-word; width:100px"><? echo $customer_buyer; ?></div>
                </td>
                <td style="font-size:17px" width="120">
                    <div style="word-wrap:break-word; width:120px"><? echo $po_no;
                    if ($style_ref != "") echo ' & ' . trim($style_ref,','); else echo '&nbsp;'; ?></div>
                </td>
                <td style="font-size:17px">
                    <div style="word-wrap:break-word; width:100px"><? echo ltrim($ref_cond, ", ");
                    if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?></div>
                </td>
				<td style="font-size:17px">
                    <div style="word-wrap:break-word; width:100px"><? echo $row[csf('remarks')];?></div>
                </td>
            </tr>
            <?
            $uom_unit = "Kg";
            $uom_gm = "Grams";
            $tot_return_qty += $row[csf('returnable_qnty')];
            $tot_bag += $no_of_bags_val;
            $tot_cone += $row[csf('cone_per_bag')];
            $tot_w_bag += $row[csf('weight_per_bag')];
            $tot_w_cone += $row[csf('weight_per_cone')];
            $req_no = $row[csf('requisition_no')];
            $i++;
        }
        ?>
        <tr bgcolor="#CCCCCC" style="font-size:13px">
            <td style="font-size:17px" align="right" colspan="9"><b>Total</b></td>
            <td style="font-size:17px" align="right">
                <b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
            </td>
            <td style="font-size:17px" align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
            <td style="font-size:17px"><? echo 'N:' . number_format($tot_bag, 2);
            if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
            echo '<br>W:' . number_format($tot_w_bag, 2);
            if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
            <td style="font-size:17px" align="right" colspan="6">&nbsp;</td>
        </tr>
        <tr>
            <td style="font-size:17px" colspan="18" align="left"><b>In
                Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
            </tr>
        </table>
    </div>
    <br>
    <!--================================================================-->
    <?
    if ($data[6] == 1)
    {
        if ($dataArray[0][csf('issue_basis')] == 3)
        {
            ?>
            <div style="">
                <table width="850" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
                    <thead>
                        <tr>
                            <th colspan="7" align="center">Requisition Details</th>
                        </tr>
                        <tr>
                            <th style="font-size:17px" width="40">SL</th>
                            <th style="font-size:17px" width="100">Requisition No</th>
                            <th style="font-size:17px" width="110">Lot No</th>
                            <th style="font-size:17px" width="220">Yarn Description</th>
                            <th style="font-size:17px" width="110">Brand</th>
                            <th style="font-size:17px" width="90">Requisition Qty</th>
                            <th style="font-size:17px">Remarks</th>
                        </tr>
                    </thead>
                    <?
                //echo $all_req_no;
                    $i = 1;
                    $tot_reqsn_qnty = 0;
                    $brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
                    $product_details_array = array();
                    $sql = "select id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where item_category_id=1 and company_id='$data[0]' and status_active=1 and is_deleted=0";
                    $result = sql_select($sql);

                    foreach ($result as $row) {
                        $compos = '';
                        if ($row[csf('yarn_comp_percent2nd')] != 0) {
                            $compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
                        } else {
                            $compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
                        }
                        $product_details_array[$row[csf('id')]]['count'] = $count_arr[$row[csf('yarn_count_id')]];
                        $product_details_array[$row[csf('id')]]['comp'] = $compos;
                        $product_details_array[$row[csf('id')]]['type'] = $yarn_type[$row[csf('yarn_type')]];
                        $product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
                        $product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
                    }
                    unset($result);
                    $sql = "select knit_id, requisition_no, prod_id, sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where requisition_no in ($all_req_no) and status_active=1 and is_deleted=0 group by requisition_no, prod_id, knit_id";
                    $nameArray = sql_select($sql);
                    foreach ($nameArray as $selectResult) {
                        ?>
                        <tr>
                            <td style="font-size:17px" width="40" align="center"><? echo $i; ?></td>
                            <td style="font-size:17px" width="100" align="center">&nbsp;<? echo $selectResult[csf('requisition_no')]; ?></td>
                            <td style="font-size:17px" width="110" align="center">
                                &nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['lot']; ?></td>
                                <td style="font-size:17px" width="220">
                                    &nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['count'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['comp'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['type']; ?></td>
                                    <td style="font-size:17px" width="110" align="center">
                                        &nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['brand']; ?></td>
                                        <td style="font-size:17px" width="90" align="right"><? echo number_format($selectResult[csf('yarn_qnty')], 2); ?>
                                    &nbsp;</td>
                        <td style="font-size:17px">&nbsp;<? //echo $selectResult[csf('requisition_no')];
                        ?></td>
                    </tr>
                    <?
                    $tot_reqsn_qnty += $selectResult[csf('yarn_qnty')];
                    $i++;
                }
                ?>
                <tfoot>
                    <th style="font-size:17px" colspan="5" align="right"><b>Total</b></th>
                    <th style="font-size:17px" align="right"><? echo number_format($tot_reqsn_qnty, 2); ?>&nbsp;</th>
                    <th style="font-size:17px">&nbsp;</th>
                </tfoot>
            </table>
            <?
            if ($data[5] != 1) {
                $z = 1;
                $k = 1;
                $colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

                $booking_al = "";
                foreach ($colorArray as $book) {
                    if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];
                }
                //unset($colorArray);
                //echo $booking_no;
                $booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
                $booking_count = count(array_unique(explode(',', $booking_no)));
                //$booking_job_arr=array();
                if ($dataArray[0][csf('issue_purpose')] == 2)
                {
                    $booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
                } else {
                    $booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
                }
                //
                $booking_job_no = $booking_job[0][csf('job_no')];
                unset($booking_job);

                if ($db_type == 0) $poNoCond = "group_concat(id)";
                else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
                /*echo '='.$sql_Job.'=';
            if($sql_Job!="")
            {*/
                $sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

                $job_po = $sql_returnJob[0][csf('po_break_down_id')];
                unset($sql_returnJob);
                ?>

                <table width="710" cellpadding="0" cellspacing="0" border="1" rules="all" style="margin-top:20px;"
                class="rpt_table">
                <thead>
                    <th style="font-size:17px" width="40">SL</th>
                    <th style="font-size:17px" width="250">Fabrication</th>
                    <th style="font-size:17px" width="120">Color</th>
                    <th style="font-size:17px" width="120">GGSM OR S/L</th>
                    <th style="font-size:17px">FGSM</th>
                </thead>
                <tbody>
                    <tr>
                        <td style="font-size:17px" width="40" align="center"><? echo $z; ?></td>
                        <td style="font-size:17px" width="250"
                        align="center"><? echo $body_part[$colorArray[0][csf('body_part_id')]] . ', ' . $colorArray[0][csf('fabric_desc')]; ?></td>
                        <td style="font-size:17px" width="120"
                        align="center"><? echo $color_range[$colorArray[0][csf('color_range')]]; ?></td>
                        <td style="font-size:17px" width="120" align="center"><? echo $colorArray[0][csf('stitch_length')]; ?></td>
                        <td style="font-size:17px" align="center"><? echo $colorArray[0][csf('gsm_weight')]; ?></td>
                    </tr>
                </tbody>
            </table>
            <table style="margin-top:20px;" width="650" border="1" rules="all" cellpadding="0" cellspacing="0"
            class="rpt_table">
            <thead>
                <th style="font-size:17px" width="40">SL</th>
                <th style="font-size:17px" width="50">Prog. No</th>
                <th style="font-size:17px" width="110">Finish Dia</th>
                <th style="font-size:17px" width="170">Machine Dia & Gauge</th>
                <th style="font-size:17px" width="110">Program Qty</th>
                <th style="font-size:17px">Remarks</th>
            </thead>
            <tbody>
                <?
                $k=1;
                foreach ($colorArray as $program_row) {
                    ?>
                    <tr>
                        <td style="font-size:17px" width="40" align="center"><? echo $k; ?></td>
                        <td style="font-size:17px" width="50" align="center"><? echo $program_row[csf('knit_id')]; ?></td>
                        <td style="font-size:17px" width="110" align="center"><? echo $program_row[csf('dia')]; ?></td>
                        <td style="font-size:17px" width="170" align="center"><? echo $program_row[csf('machine_dia')] . "X" . $program_row[csf('machine_gg')]; ?></td>
                        <td style="font-size:17px" width="110" align="right"><? echo number_format($program_row[csf('program_qnty')], 2); ?></td>
                        <td style="font-size:17px"><? echo $program_row[csf('remarks')]; ?></td>
                    </tr>
                    <?
                    $k++;
                    $tot_prog_qty += $program_row[csf('program_qnty')];
                }
                ?>
                <tr>
                    <td style="font-size:17px" colspan="4" align="right"><strong>Total : </strong></td>
                    <td style="font-size:17px" align="right"><? echo number_format($tot_prog_qty, 2); ?></td>
                    <td style="font-size:17px">&nbsp;</td>
                </tr>
            </tbody>
        </table>
        <?
        $returnJob = '';
        $returnPo = '';
        if ($db_type == 0) {
            $booking_cond = "group_concat(a.booking_no)";
            $wo_cond = "group_concat(a.ydw_no)";
            $reqs_no = "group_concat(b.requisition_no)";
        } else if ($db_type == 2) {
            $booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
            $wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
            $reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
        }

        if ($dataArray[0][csf('issue_purpose')] == 8) {
            $sql_returnJob = sql_select("select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
        } else if ($dataArray[0][csf('issue_purpose')] == 2) {
            $sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

            if ($db_type == 0) $poNoCond = "group_concat(id)";
            else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
            $sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
        } else {

                    $sql_returnJob = sql_select("select a.job_no, a.booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' and a.booking_no in($booking_no) group by a.job_no,a.booking_no"); //and a.booking_no='".$dataArray[0][csf('booking_no')]."'

                }
                $returnJob = $sql_returnJob[0][csf('job_no')];
                //$returnPo=$sql_po[0][csf('po_break_down_id')];
                $returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
                $returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
                $returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
                unset($sql_returnJob);

                /*$req_no_retInJob=sql_select("select $reqs_no as req_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");
                $reqNo_inJob=$req_no_retInJob[0][csf('req_no')];*/
                ?>
                <table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
                class="rpt_table">
                <thead>
                    <tr>
                        <th colspan="6" align="center">Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking Job
                        Deatils]</p></th>
                    </tr>
                    <tr>
                        <th style="font-size:17px">Buyer</th>
                        <th style="font-size:17px">Job</th>
                        <th style="font-size:17px">Req. Qty</th>
                        <th style="font-size:17px">Cuml. Issue Qty</th>
                        <th style="font-size:17px">Balance Qty</th>
                        <th style="font-size:17px">Remarks</th>
                    </tr>
                </thead>
                <?

                $all_requ_no = "";
                if ($dataArray[0][csf('issue_purpose')] != 8) {
                    $all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");

                    //$all_requ_no="'".$all_booking_sql[0][csf('requisition_no')]."'";
                    $all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
                }
                if ($dataArray[0][csf('issue_purpose')] == 8) {
                    $total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");    //
                    $total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
                } else if ($dataArray[0][csf('issue_purpose')] == 2) {
                    if ($all_requ_no != "" || $all_requ_no != 0) {
                        $req_cond = "or a.requisition_no in ($all_requ_no)";
                        $reqRet_cond = "or b.booking_no in ($all_requ_no)";
                    } else {
                        $req_cond = "or a.requisition_no in (0)";
                        $reqRet_cond = "or b.booking_no in (0)";
                    }

                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
                } else {
                    if ($all_requ_no != "" || $all_requ_no != 0) {
                        $req_cond = "or a.requisition_no in ($all_requ_no)";
                        $reqRet_cond = "or b.booking_no in ($all_requ_no)";
                    } else {
                        $req_cond = "or a.requisition_no in (0)";
                        $reqRet_cond = "or b.booking_no in (0)";
                    }
                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");


                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
                }
                $cumulative_qty = 0;
                if ($booking_count == 1) {
                    ?>
                    <tbody>
                        <tr>
                            <td style="font-size:17px" align="center">
                                <? echo $buyer_arr[$job_array[$booking_job_no]['buyer']]; ?>
                            </td>
                            <td style="font-size:17px" align="center">
                                <? echo $job_array[$booking_job_no]['job']; ?>
                            </td>
                            <td style="font-size:17px" align="center">
                                <? echo number_format($returnReqQty, 3); ?>
                            </td>
                            <td style="font-size:17px" align="center">
                                <? $cumulative_qty = $total_issue_qty - $total_return_qty;
                                echo number_format($cumulative_qty, 3); ?>
                            </td>
                            <td style="font-size:17px" align="center">
                                <? $balance_qty = $returnReqQty - $cumulative_qty;
                                echo number_format($balance_qty, 3); ?>
                            </td>
                            <td style="font-size:17px" align="center">
                                <? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <?
            }
        }
    }
        else if ($dataArray[0][csf('issue_basis')] == 1)
        {
            ?>
            <table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
            class="rpt_table">
            <thead>
                <tr>
                    <th colspan="6" align="center">Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
                        if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
                    } ?> </th>
                </tr>
                <tr>
                    <th style="font-size:17px">Buyer</th>
                    <th style="font-size:17px">Job</th>
                    <th style="font-size:17px">Req. Qty</th>
                    <th style="font-size:17px">Cuml. Qty</th>
                    <th style="font-size:17px">Balance Qty</th>
                    <th style="font-size:17px">Remarks</th>
                </tr>
            </thead>
            <?
            //$booking_job_arr=array();
            $returnJob = '';
            $returnPo = '';
            if ($db_type == 0)
            {
                $booking_cond = "group_concat( distinct a.booking_no)";
                $wo_cond = "group_concat(a.ydw_no)";
                $reqs_no = "group_concat(b.requisition_no)";
            }
            else if ($db_type == 2)
            {
                $booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
                $wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
                $reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
            }

            if ($dataArray[0][csf('issue_purpose')] == 8)
            {
                $sql_returnJob = sql_select("select a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
            }
            else if ($dataArray[0][csf('issue_purpose')] == 2)
            {
                if ($dataArray[0][csf('buyer_job_no')] != '') {
                    $sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

                    if ($db_type == 0) $poNoCond = "group_concat(id)";
                    else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
                    $sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
                } else {
                    $sql_returnJob = sql_select("select a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
                }
            }
            else
            {
                //echo "select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
                $sql_returnJob = sql_select("select b.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

                /*$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");*///and a.booking_no='".$dataArray[0][csf('booking_no')]."'
            }
            $returnJob = $sql_returnJob[0][csf('job_no')];
            $returnPo = $sql_po[0][csf('po_break_down_id')];
            $returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
            $returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

            $returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
            unset($sql_returnJob);

            //$booking_all="'".implode("','",explode(",",$bill_item_id))."'";
            //echo $returnJob.'---------'.$returnPo.'dfgdfgd';

            /*if( $dataArray[0][csf('issue_purpose')]==8 )
            {
                $sql = "select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='".$dataArray[0][csf('booking_no')]."' group by a.id";
            }
            else if( $dataArray[0][csf('issue_purpose')]==2)
            {
                if($dataArray[0][csf('buyer_job_no')]!="")
                {
                    $sql = "select sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='".$dataArray[0][csf('buyer_job_no')]."'"; // and a.ydw_no='".$dataArray[0][csf('booking_no')]."'
                }
            }
            else
            {
                if($dataArray[0][csf('buyer_job_no')]!="")
                {
                    $sql = "select a.job_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($returnBooking) and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
                }
            }
            $result = sql_select($sql);*/
            $all_requ_no = "";
            if ($dataArray[0][csf('issue_purpose')] != 8)
            {
                //echo "select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no";
                $all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

                $all_requ_no = $all_booking_sql[0][csf('requisition_no')];
                unset($all_booking_sql);
            }

            if ($dataArray[0][csf('issue_purpose')] == 8)
            {
                    $total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");    //
                    $total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
            }
            else if ($dataArray[0][csf('issue_purpose')] == 2)
            {
                /*if($all_requ_no!="" || $all_requ_no!=0)
                {
                    //$req_cond="or a.requisition_no in ($all_requ_no)";
                    //$reqRet_cond="or b.booking_no in ($all_requ_no)";
                }
                else
                {
                    //$req_cond="or a.requisition_no in (0)";
                    $reqRet_cond="or b.booking_no in (0)";
                }*/
                if ($dataArray[0][csf('buyer_job_no')] != "")
                {
                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
                        //echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
                }
                else
                {
                    //echo "select sum(a.cons_quantity) as total_issue_qty from inv_transaction a, inv_issue_master b where b.id=a.mst_id and b.booking_no='".$dataArray[0][csf('booking_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.buyer_job_no<>'' and b.issue_purpose=2";
                    $total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
                    //echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
                    $total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
                }
            }
            else
            {
                if ($dataArray[0][csf('buyer_job_no')] != "")
                {
                    if ($all_requ_no != "" || $all_requ_no != 0)
                    {
                        $req_cond = "or a.requisition_no in ($all_requ_no)";
                        $reqRet_cond = "or b.booking_no in ($all_requ_no)";
                    }
                    else
                    {
                        $req_cond = "";//or a.requisition_no in (0)
                        $reqRet_cond = "";//or b.booking_no in (0)
                    }

                    $total_issue_qty = 0;
                    //echo "select sum(c.quantity) as total_issue_qty from inv_transaction a, inv_issue_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2";
                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");
                    //echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2";
                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");

                    //$total_issue_qty=return_field_value("sum(quantity) as total_issue_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=2 and entry_form=3","total_issue_qty");
                    //$total_return_qty=return_field_value("sum(quantity) as total_return_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=4 and entry_form=8","total_return_qty");
                    }
                }
                ?>
                <tbody>
                    <tr>
                        <td style="font-size:17px" align="center">
                            <?
                            if ($dataArray[0][csf('issue_purpose')] == 8)
                            {
                                echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
                            }
                            else
                            {
                                if($job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']!="")
                                {
                                    echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
                                }
                                else
                                {
                                    echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
                                }
                            }
                            ?>
                        </td>
                        <td style="font-size:17px" align="center">
                            <? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
                        </td>
                        <td style="font-size:17px" align="center">
                            <? echo number_format($returnReqQty, 3); ?>
                        </td>
                        <td style="font-size:17px" align="center">
                            <? $cumulative_qty = 0;
                            $cumulative_qty = $total_issue_qty - $total_return_qty;
                            echo number_format($cumulative_qty, 3); ?>
                        </td>
                        <td style="font-size:17px" align="center">
                            <? $balance_qty = $returnReqQty - $cumulative_qty;
                            echo number_format($balance_qty, 3); ?>
                        </td>
                        <td style="font-size:17px" align="center">
                            <? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
                        </td>
                    </tr>
                </tbody>
            </table>
            <?
        }
    }

        echo "<br><br>";

        echo "Note: Received The Above in Goods Condition For Handling and Delivery.";

        echo "<br><br><br><br><br><br><br><br>";

		echo  signature_table(49, $data[0], "1030px",'',0);
		?>
    </div>
 </div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');
		</script>
		<p style="page-break-after: always;"> </p>

		<?
	}
	exit();
}

if ($action == "yarn_issue_print_16052023")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);
	$print_with_vat = $data[7];
	$company=$data[0];
	$location=$data[8];
	$store_id=$data[9];

	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	//echo $store_location_id.'system';

	//$supplier_arr = return_library_array("select id, short_name from lib_supplier", 'id', 'short_name');
	$supplier_arr = return_library_array("select id,supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
    //$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
    //echo $sql;die;
	$dataArray = sql_select($sql);
	$demand_no = array();
	if( $dataArray[0][csf('issue_basis')]==3 || $dataArray[0][csf('issue_basis')]==8 )
	{
		$planbooking = sql_select("select b.requisition_no, e.booking_no as pln_booking_no, d.id from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$data[5]'");

		//for demand no
		if( $dataArray[0][csf('issue_basis')]==8 )
		{
			$req_no_arr = array();
			foreach($planbooking as $row)
			{
				$req_no_arr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];
			}

			$req_sql_zs = sql_select("select a.demand_system_no from ppl_yarn_demand_entry_mst a, ppl_yarn_demand_entry_dtls b where a.id = b.mst_id and b.requisition_no in(".implode(',', $req_no_arr).")");
			foreach($req_sql_zs as $row)
			{
				$demand_no[$row[csf('demand_system_no')]] = $row[csf('demand_system_no')];
			}
		}
	}

	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$copyNo = "";
	for ($x = 1; $x <= 3; $x++)
	{
		if($x==1)
		{
			$copyNo ="<span style='font-size:x-large;'>1<sup>st</sup> Copy</span>";
		} else if($x==2){
			$copyNo ="<span style='font-size:x-large;'>2<sup>nd</sup> Copy</span>";
		} else {
			$copyNo ="<span style='font-size:x-large;'>3<sup>rd</sup> Copy</span>";
		}

		$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
		?>
		<div style="width:1150px;">
			<table width="1100" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td colspan="6" align="center" style="font-size:18px"></td>
					<td style="font-size:x-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">
					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="4" align="center">
						<strong style="font-size:18px"><? echo $com_dtls[0]; ?></strong><br>
						<?
						echo $com_dtls[1];
						?>
					</td>
					<td colspan="2" id="barcode_img_id">&nbsp;</td>
					<td colspan="3" style="color:black; font-weight:bold;"><? echo $copyNo;?></td>
				</tr>
				<tr>
					<td colspan="6" align="center" style="font-size:16px"><strong><u>Yarn Delivery Challan/Gate
					Pass</u></strong></center></td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td width="160"><strong>Issue No</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('issue_number')]; ?></td>
					<td width="120"><strong>Booking</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;
						<?
						if( $dataArray[0][csf('issue_basis')]==3 || $dataArray[0][csf('issue_basis')]==8 )
						{
							$bookingNo = $planbooking[0][csf('pln_booking_no')];
							$challan_prog = $planbooking[0][csf('id')];
						}
						else
						{
							$bookingNo = $dataArray[0][csf('booking_no')];
							$challan_prog = $dataArray[0][csf('challan_no')];
						}
						echo $bookingNo;
						?>
					</td>
					<td width="125"><strong>Knitting Source</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
				</tr>
				<tr>
					<td><strong>Challan/Program No</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? echo $challan_prog; ?></td>
					<td><strong>Issue Purpose</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
					echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
					?></td>
		<td><strong>Issue Date</strong></td>
		<td width="175px"><strong>:</strong>&nbsp;<? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
	</tr>
	<tr>
		<td><strong>Issue To</strong></td>
		<?
		if ($dataArray[0][csf('knit_dye_source')] == 3)
		{
			$supp_add = $dataArray[0][csf('knit_dye_company')];
			$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
			foreach ($nameArray as $result) {
				$address = "";
							if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
						}
						unset($nameArray);
					}

					$loan_party_add = $dataArray[0][csf('loan_party')];
					$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
					foreach ($loanPartyArray as $result) {
						$addressParty = "";
						if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($loanPartyArray);
					?>
					<td colspan="3"><strong>:</strong>&nbsp;
						<?
						if ($dataArray[0][csf('issue_purpose')] == 3) {
							echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
						} else if ($dataArray[0][csf('issue_purpose')] == 5) {
							echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
						} else {
							if ($dataArray[0][csf('knit_dye_source')] == 1)
								echo $company_library[$dataArray[0][csf('knit_dye_company')]];
							else
								echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
						}
						?>
					</td>
                    <td><strong>Location</strong></td>
					<td><strong>:</strong>&nbsp;<? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>
				</tr>
				<tr>
					<td><strong>Demand No.</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? echo implode(', ', $demand_no); ?></td>
					<td><strong>Gate Pass No.</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('gate_pass_no')]; ?></td>
					<td><strong>Do No</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? //echo $dataArray[0][csf('remarks')];
					?></td>
				</tr>
				<tr>
					<td valign="top"><strong>Remarks</strong></td>
					<td colspan="5"><strong>:</strong>&nbsp;<p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
				</tr>
				<?
				if ($print_with_vat == 1)
				{
					?>
					<tr>
						<td><strong>VAT Number</strong></td>
						<td><strong>:</strong>&nbsp;<p>
							<?
							$vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
							echo $vat_no;
							?>
                        </p></td>
                    </tr>
                    <?
                }
				else
				{
                    ?>
                    <tr>
                        <td valign="top">&nbsp;</strong></td>
                        <td>&nbsp;</td>
                    </tr>
                    <?
                }
                ?>
            </table>
            <br>
            <div style="width:100%;">
                <div style="clear:both;">
                    <table style="margin-right:-40px;" cellspacing="0" width="1150" border="1" rules="all"
                    class="rpt_table">
                    <thead bgcolor="#dddddd" style="font-size:13px">
                        <th width="20">SL</th>
                        <th width="45">Req. No</th>
                        <th width="50">Program No</th>
                        <th width="50">Lot No</th>
                        <th width="65">Y. Type</th>
                        <th width="110">Item Details</th>
                        <th width="65">Grey Color</th>
                        <th width="65">Dye. Color</th>
                        <th width="60">Supp.</th>
                        <th width="60"><b>Issue Qty(kg)</b></th>
                        <th width="60">Rtnbl Qty(kg)</th>
                        <th width="80">Bag & Cone</th>
                        <th width="80">Store</th>
                        <th width="100">Buyer & Job</th>
                        <th width="100">Cust. Buyer</th>
                        <th width="120">Order & Style</th>
                        <th>Inte. Ref & File</th>
                    </thead>
                    <?
                    $wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");

                    $cond = "";
                    if ($data[5] != "") $cond .= " and c.id='$data[5]'";

                    $po_array = array();
                    $job_array = array();


                    $costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0]");
                    foreach ($costing_sql as $row)
                    {
                        $po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
                        $po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
                        $po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
                        $po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
                        $job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
                        $job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];

						$job_intfarray[$row[csf('job_no')]]['grouping'] = $row[csf('grouping')];
                    }

                    unset($costing_sql);

					$sales_order_array = array();
					$sales_order_sql = sql_select("select a.id,a.sales_booking_no, a.job_no,a.style_ref_no, a.buyer_id,b.job_no po_job_no,b.buyer_id po_buyer,a.within_group from fabric_sales_order_mst a left join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.status_active = 1 and a.is_deleted = 0 and a.company_id=$data[0]");
					foreach ($sales_order_sql as $row)
					{
						$sales_order_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
						$sales_order_array[$row[csf('id')]]['sales_order_no'] = $row[csf('job_no')];
						$sales_order_array[$row[csf('id')]]['po_job_no'] = $row[csf('po_job_no')];
						$sales_order_array[$row[csf('id')]]['sales_booking_no'] = $row[csf('sales_booking_no')];
						$sales_order_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
						$sales_order_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
						$sales_order_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
					}

					$sales_style_des_arr = array();
					$sales_samp_booking_sql = sql_select("SELECT b.booking_no, b.style_des FROM fabric_sales_order_mst a, wo_non_ord_samp_booking_dtls b WHERE a.sales_booking_no = b.booking_no and a.company_id=$data[0] and b.status_active=1 and b.is_deleted=0");
					foreach ($sales_samp_booking_sql as $row)
					{
						$sales_style_des_arr[$row[csf('booking_no')]]['style_des'] .= $row[csf('style_des')].',';
					}
					unset($sales_samp_booking_sql);

                    $stl_array = array();

                    $stl_sql = sql_select("select job_no, style_ref_no from wo_po_details_master");
                    foreach ($stl_sql as $row)
                    {
                        $stl_array[$row[csf('style_ref_no')]]['job'] = $row[csf('job_no')];
                    }
                    //var_dump($stl_array);
                    unset($stl_sql);

                    $job_no_array = array();
                    $jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id, po_buyer, customer_buyer from fabric_sales_order_mst");
                    foreach ($jobData as $row)
                    {
                        $job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
                        $job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
                        $job_no_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
                        $job_no_array[$row[csf('id')]]['customer_buyer'] = $row[csf('customer_buyer')];
                    }
                    //var_dump($po_array);
                    $po_id_req_array = array();
                    $is_sales_array = array();
                    if ($db_type == 0)
					{
                        $poID = " select c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales";
                    }
					else
					{
                        $poID = "select c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales";
                    }
                    $poID_sql_result = sql_select($poID);
                    foreach ($poID_sql_result as $row)
					{
                        $po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
                        $is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];

						$program_array[$row[csf('requisition_no')]]['program_no'] = $row[csf('knit_id')];
						$program_array[$row[csf('requisition_no')]]['poid'] = $row[csf('poid')];
						//$program_array[$row[csf('requisition_no')]]['buyer_id'] = $row[csf('buyer_id')];
                    }
                    unset($poID_sql_result);


                    $i = 1;
                    if ($db_type == 0) {
                        $sql_result = sql_select("SELECT a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose
                            from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id left join fabric_sales_order_mst e on d.po_breakdown_id=e.id
                            where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
                            group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose order by b.requisition_no DESC");
                    } else {

                        $sql_result = sql_select("SELECT a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose
                        from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id left join fabric_sales_order_mst e on d.po_breakdown_id=e.id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
                        group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose order by b.requisition_no DESC");

                    }
                    $all_req_no = '';
                    $all_prod_id = '';
                    $order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
                    $tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
                    foreach ($sql_result as $row)
					{
                        if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
                        if ($row[csf('requisition_no')] != '')
						{
                            if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
                            if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
                        }
                        $order_qnty_val = $row[csf('cons_quantity')];
                        $order_qnty_val_sum += $order_qnty_val;

                        $order_amount_val = $row[csf('order_amount')];
                        $order_amount_val_sum += $order_amount_val;

                        $no_of_bags_val = $row[csf('no_of_bags')];
                        $no_of_bags_val_sum += $no_of_bags_val;

                        $po_id = explode(",", $row[csf('po_id')]);
                        $po_no = '';
                        $style_ref = '';
                        $job_no = '';
                        $buyer = '';
                        //$data=explode('*',$data);
                        $productdtls = $row[csf('product_name_details')];
                        $productArr = explode(' ', $productdtls);

                        $proddtls='';
                        $proddtls=$yarn_count_details[$row[csf('yarn_count_id')]];
                        if($row[csf('yarn_count_id')]>0) $proddtls.=", ";
                        $proddtls.=$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."%";

                    /*if($row[csf('yarn_comp_type1st')]>0) $proddtls.=", ";
                    $proddtls.=$yarn_type[$row[csf('yarn_type')]];*/

                    /*if ($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' && $productArr[4]!=''&& $productArr[5]!='')
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].'%, '.$productArr[3].' '.$productArr[4]."%, ".$productArr[5].", ".$productArr[6];
                    }
                    else if ($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' && $productArr[4]!='')
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, '.$productArr[3].', '.$productArr[4];
                    }
                    else if($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' )
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, '.$productArr[3];
                    }
                    else if($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='')
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, ';
                    }
                    else if($productArr[0]!='' && $productArr[1]!='' )
                    {
                        $proddtls=$productArr[0].', '.$productArr[1];
                    }
                    else if($productArr[0]!='')
                    {
                        $proddtls=$productArr[0];
                    }
                    else
                    {
                        $proddtls='';
                    }*/

                    $internal_ref = '';
                    $style_ref = '';
                    $file_no = '';

                    if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
                    {
                        foreach ($po_id as $val)
                        {
							if($row[csf('is_sales')]==1)
							{
								if ($po_no== '') $po_no = $sales_order_array[$val]['sales_booking_no'];
								if ($style_ref == '') $style_ref = $sales_style_des_arr[$sales_order_array[$val]['sales_booking_no']]['style_des'];

								$po_job = $sales_order_array[$val]['po_job_no'];

								if ($internal_ref == '') $internal_ref = $job_intfarray[$po_job]['grouping']; else $internal_ref .= "," . $job_intfarray[$po_job]['grouping'];
							}
							else
							{
								if($po_array[$val]['no'] !='')
								{
									if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
									if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								}

								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];

							}

                            if ($job_no == '') $job_no = $po_array[$val]['job_no'];

                            if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                            if ($sales_booking_no== '') $sales_booking_no = $sales_order_array[$val]['sales_booking_no'];

                            if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                        }
                        $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                        $job_file = array_unique(explode(",", rtrim($file_no, ", ")));
                        $ref_cond = '';
                        foreach ($job_ref as $ref) {
                            //$ref_cond.=", ".$ref;
                            if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                        }
                        $file_con = '';
                        foreach ($job_file as $file) {
                            if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                        }

                        $buyer_job = '';
                        if ($row[csf('issue_basis')] == 1)
                        {
                            if ($dataArray[0][csf('issue_purpose')] == 8)
                            {
                                $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                            }
                            else
                            {
                                if ($row[csf('buyer_job_no')] != "")
                                {
									if($row[csf('job_no')])
									{
                                       $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('job_no')];
									}
									else
									{
                                        $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
									}
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                                }

                            }

                        }
                        else if ($row[csf('issue_basis')] == 2)
                        {
                            $buyer_job = '';
                        }
						if(!empty($row[csf('customer_buyer')]))
						{
							$customer_buyer = $buyer_arr[$row[csf('customer_buyer')]];
						}
						else
						{
                           $customer_buyer = $buyer_arr[$job_no_array[$row[csf('buyer_job_no')]]['customer_buyer']];
						}
                    }
					// else if ($row[csf('issue_basis')] == 1 && $row[csf('issue_purpose')] == 2)
                    // {

					// }
                    else if ($row[csf('issue_basis')] == 3)
                    {
                        if ($is_sales_array[$row[csf('requisition_no')]] == 1)
                        {
                            $buyer_job = '';
                            foreach (array_unique($po_id) as $val) {
                                if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
                                if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
                                $customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];

                                if ($buyer_job == '')
                                {
                                    if ($job_no_array[$val]['within_group'] == 1)
                                    {
                                        $buyer_data = $buyer_arr[$job_no_array[$val]['po_buyer']];
                                        $job_data = $stl_array[$job_no_array[$val]['style_ref']]['job'];
                                        $buyer_job = $buyer_data.' & '.$job_data;
                                    }
                                    else
                                    {
                                        $buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
                                    }
                                }
                            }
                        }
                        else
                        {
                            foreach ($po_id as $val)
                            {
                                if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
                                if ($job_no == '') $job_no = $po_array[$val]['job_no'];
                                if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
                                if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                                if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
                                if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                            }

                            $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                            $job_file = array_unique(explode(",", rtrim($file_no, ", ")));

                            $ref_cond = '';
                            foreach ($job_ref as $ref) {
                                //$ref_cond.=", ".$ref;
                                if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                            }

                            $file_con = '';
                            foreach ($job_file as $file) {
                                if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                            }
                            if ($job_no != '')
                            {
                                $buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
                            }
                            else
                            {
                                if(!empty($po_array[$val]['buyer_name']))
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                            }
                        }
                    }

                    else
                    {
                        foreach (array_unique($po_id) as $val)
                        {
                            if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
                            if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
                            $customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];
                            if ($buyer_job == '')
                            {
                                if ($job_no_array[$val]['within_group'] == 1)
                                {

                                    $buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
                                }
                            }

							if ($is_sales_array[$row[csf('requisition_no')]] == 1)
                        	{
								$po_job = $sales_order_array[$val]['po_job_no'];

								 if ($internal_ref == '') $internal_ref = $job_intfarray[$po_job]['grouping']; else $internal_ref .= "," . $job_intfarray[$po_job]['grouping'];

							}
                        }

						$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));

						$ref_cond = '';
						foreach ($job_ref as $ref)
						{
							if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
						}



                    }

                    $no_bag_cone = "";
                    $wt_bag_cone = "";
                    if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

                    if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" style="font-size:13px">
                        <td width="20"><? echo $i; ?></td>
                        <td width="45">
                            <div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
                        </td>
                        <td width="50">
                            <div style="word-wrap:break-word; width:50px"><? echo $program_array[$row[csf('requisition_no')]]['program_no']; ?></div>
                        </td>
                        <td width="50">
                            <div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
                        </td>
                        <td width="65">
                            <div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
                        </td>
                        <td width="110">
                            <div style="word-wrap:break-word; width:110px">
                                <?
                                //echo $proddtls;
                                echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
                                ?>
                            </div>
                        </td>
                        <td width="65">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('color')]]; ?></div>
                        </td>
                        <td width="65">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
                        &nbsp;</div>
                    </td>
                    <td width="60">
                        <div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
                    </td>
                    <td align="right"
                    width="60"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
                    <td align="right"
                    width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
                    <td width="80">
                        <div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
                    &nbsp;</div>
                </td>
                <td width="80">
                    <div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
                </td>
                <td width="100">
                    <div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
                </td>
                <td width="100">
                    <div style="word-wrap:break-word; width:100px"><? echo $customer_buyer; ?></div>
                </td>
                <td width="120">
                    <div style="word-wrap:break-word; width:120px"><? echo $po_no;
                    if ($style_ref != "") echo ' & ' . trim($style_ref,','); else echo '&nbsp;'; ?></div>
                </td>
                <td>
                    <div style="word-wrap:break-word; width:80px"><? echo ltrim($ref_cond, ", ");
                    if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?></div>
                </td>
            </tr>
            <?
            $uom_unit = "Kg";
            $uom_gm = "Grams";
            $tot_return_qty += $row[csf('returnable_qnty')];
            $tot_bag += $no_of_bags_val;
            $tot_cone += $row[csf('cone_per_bag')];
            $tot_w_bag += $row[csf('weight_per_bag')];
            $tot_w_cone += $row[csf('weight_per_cone')];
            $req_no = $row[csf('requisition_no')];
            $i++;
        }
        ?>
        <tr bgcolor="#CCCCCC" style="font-size:13px">
            <td align="right" colspan="9"><b>Total</b></td>
            <td align="right">
                <b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
            </td>
            <td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
            <td><? echo 'N:' . number_format($tot_bag, 2);
            if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
            echo '<br>W:' . number_format($tot_w_bag, 2);
            if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
            <td align="right" colspan="5">&nbsp;</td>
        </tr>
        <tr>
            <td colspan="17" align="left"><b>In
                Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
            </tr>
        </table>
    </div>
    <br>
    <!--================================================================-->
    <?
    if ($data[6] == 1)
    {
        if ($dataArray[0][csf('issue_basis')] == 3)
        {
            ?>
            <div style="">
                <table width="850" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
                    <thead>
                        <tr>
                            <th colspan="7" align="center">Requisition Details</th>
                        </tr>
                        <tr>
                            <th width="40">SL</th>
                            <th width="100">Requisition No</th>
                            <th width="110">Lot No</th>
                            <th width="220">Yarn Description</th>
                            <th width="110">Brand</th>
                            <th width="90">Requisition Qty</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <?
                //echo $all_req_no;
                    $i = 1;
                    $tot_reqsn_qnty = 0;
                    $brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
                    $product_details_array = array();
                    $sql = "select id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where item_category_id=1 and company_id='$data[0]' and status_active=1 and is_deleted=0";
                    $result = sql_select($sql);

                    foreach ($result as $row) {
                        $compos = '';
                        if ($row[csf('yarn_comp_percent2nd')] != 0) {
                            $compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
                        } else {
                            $compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
                        }
                        $product_details_array[$row[csf('id')]]['count'] = $count_arr[$row[csf('yarn_count_id')]];
                        $product_details_array[$row[csf('id')]]['comp'] = $compos;
                        $product_details_array[$row[csf('id')]]['type'] = $yarn_type[$row[csf('yarn_type')]];
                        $product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
                        $product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
                    }
                    unset($result);
                    $sql = "select knit_id, requisition_no, prod_id, sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where requisition_no in ($all_req_no) and status_active=1 and is_deleted=0 group by requisition_no, prod_id, knit_id";
                    $nameArray = sql_select($sql);
                    foreach ($nameArray as $selectResult) {
                        ?>
                        <tr>
                            <td width="40" align="center"><? echo $i; ?></td>
                            <td width="100" align="center">&nbsp;<? echo $selectResult[csf('requisition_no')]; ?></td>
                            <td width="110" align="center">
                                &nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['lot']; ?></td>
                                <td width="220">
                                    &nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['count'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['comp'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['type']; ?></td>
                                    <td width="110" align="center">
                                        &nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['brand']; ?></td>
                                        <td width="90" align="right"><? echo number_format($selectResult[csf('yarn_qnty')], 2); ?>
                                    &nbsp;</td>
                        <td>&nbsp;<? //echo $selectResult[csf('requisition_no')];
                        ?></td>
                    </tr>
                    <?
                    $tot_reqsn_qnty += $selectResult[csf('yarn_qnty')];
                    $i++;
                }
                ?>
                <tfoot>
                    <th colspan="5" align="right"><b>Total</b></th>
                    <th align="right"><? echo number_format($tot_reqsn_qnty, 2); ?>&nbsp;</th>
                    <th>&nbsp;</th>
                </tfoot>
            </table>
            <?
            if ($data[5] != 1) {
                $z = 1;
                $k = 1;
                $colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

                $booking_al = "";
                foreach ($colorArray as $book) {
                    if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];
                }
                //unset($colorArray);
                //echo $booking_no;
                $booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
                $booking_count = count(array_unique(explode(',', $booking_no)));
                //$booking_job_arr=array();
                if ($dataArray[0][csf('issue_purpose')] == 2)
                {
                    $booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
                } else {
                    $booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
                }
                //
                $booking_job_no = $booking_job[0][csf('job_no')];
                unset($booking_job);

                if ($db_type == 0) $poNoCond = "group_concat(id)";
                else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
                /*echo '='.$sql_Job.'=';
            if($sql_Job!="")
            {*/
                $sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

                $job_po = $sql_returnJob[0][csf('po_break_down_id')];
                unset($sql_returnJob);
                ?>

                <table width="710" cellpadding="0" cellspacing="0" border="1" rules="all" style="margin-top:20px;"
                class="rpt_table">
                <thead>
                    <th width="40">SL</th>
                    <th width="250">Fabrication</th>
                    <th width="120">Color</th>
                    <th width="120">GGSM OR S/L</th>
                    <th>FGSM</th>
                </thead>
                <tbody>
                    <tr>
                        <td width="40" align="center"><? echo $z; ?></td>
                        <td width="250"
                        align="center"><? echo $body_part[$colorArray[0][csf('body_part_id')]] . ', ' . $colorArray[0][csf('fabric_desc')]; ?></td>
                        <td width="120"
                        align="center"><? echo $color_range[$colorArray[0][csf('color_range')]]; ?></td>
                        <td width="120" align="center"><? echo $colorArray[0][csf('stitch_length')]; ?></td>
                        <td align="center"><? echo $colorArray[0][csf('gsm_weight')]; ?></td>
                    </tr>
                </tbody>
            </table>
            <table style="margin-top:20px;" width="650" border="1" rules="all" cellpadding="0" cellspacing="0"
            class="rpt_table">
            <thead>
                <th width="40">SL</th>
                <th width="50">Prog. No</th>
                <th width="110">Finish Dia</th>
                <th width="170">Machine Dia & Gauge</th>
                <th width="110">Program Qty</th>
                <th>Remarks</th>
            </thead>
            <tbody>
                <?
                $k=1;
                foreach ($colorArray as $program_row) {
                    ?>
                    <tr>
                        <td width="40" align="center"><? echo $k; ?></td>
                        <td width="50" align="center"><? echo $program_row[csf('knit_id')]; ?></td>
                        <td width="110" align="center"><? echo $program_row[csf('dia')]; ?></td>
                        <td width="170" align="center"><? echo $program_row[csf('machine_dia')] . "X" . $program_row[csf('machine_gg')]; ?></td>
                        <td width="110" align="right"><? echo number_format($program_row[csf('program_qnty')], 2); ?></td>
                        <td><? echo $program_row[csf('remarks')]; ?></td>
                    </tr>
                    <?
                    $k++;
                    $tot_prog_qty += $program_row[csf('program_qnty')];
                }
                ?>
                <tr>
                    <td colspan="4" align="right"><strong>Total : </strong></td>
                    <td align="right"><? echo number_format($tot_prog_qty, 2); ?></td>
                    <td>&nbsp;</td>
                </tr>
            </tbody>
        </table>
        <?
        $returnJob = '';
        $returnPo = '';
        if ($db_type == 0) {
            $booking_cond = "group_concat(a.booking_no)";
            $wo_cond = "group_concat(a.ydw_no)";
            $reqs_no = "group_concat(b.requisition_no)";
        } else if ($db_type == 2) {
            $booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
            $wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
            $reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
        }

        if ($dataArray[0][csf('issue_purpose')] == 8) {
            $sql_returnJob = sql_select("select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
        } else if ($dataArray[0][csf('issue_purpose')] == 2) {
            $sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

            if ($db_type == 0) $poNoCond = "group_concat(id)";
            else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
            $sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
        } else {

                    $sql_returnJob = sql_select("select a.job_no, a.booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' and a.booking_no in($booking_no) group by a.job_no,a.booking_no"); //and a.booking_no='".$dataArray[0][csf('booking_no')]."'

                }
                $returnJob = $sql_returnJob[0][csf('job_no')];
                //$returnPo=$sql_po[0][csf('po_break_down_id')];
                $returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
                $returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
                $returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
                unset($sql_returnJob);

                /*$req_no_retInJob=sql_select("select $reqs_no as req_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");
                $reqNo_inJob=$req_no_retInJob[0][csf('req_no')];*/
                ?>
                <table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
                class="rpt_table">
                <thead>
                    <tr>
                        <th colspan="6" align="center">Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking Job
                        Deatils]</p></th>
                    </tr>
                    <tr>
                        <th>Buyer</th>
                        <th>Job</th>
                        <th>Req. Qty</th>
                        <th>Cuml. Issue Qty</th>
                        <th>Balance Qty</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <?

                $all_requ_no = "";
                if ($dataArray[0][csf('issue_purpose')] != 8) {
                    $all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");

                    //$all_requ_no="'".$all_booking_sql[0][csf('requisition_no')]."'";
                    $all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
                }
                if ($dataArray[0][csf('issue_purpose')] == 8) {
                    $total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");    //
                    $total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
                } else if ($dataArray[0][csf('issue_purpose')] == 2) {
                    if ($all_requ_no != "" || $all_requ_no != 0) {
                        $req_cond = "or a.requisition_no in ($all_requ_no)";
                        $reqRet_cond = "or b.booking_no in ($all_requ_no)";
                    } else {
                        $req_cond = "or a.requisition_no in (0)";
                        $reqRet_cond = "or b.booking_no in (0)";
                    }

                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
                } else {
                    if ($all_requ_no != "" || $all_requ_no != 0) {
                        $req_cond = "or a.requisition_no in ($all_requ_no)";
                        $reqRet_cond = "or b.booking_no in ($all_requ_no)";
                    } else {
                        $req_cond = "or a.requisition_no in (0)";
                        $reqRet_cond = "or b.booking_no in (0)";
                    }
                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");


                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
                }
                $cumulative_qty = 0;
                if ($booking_count == 1) {
                    ?>
                    <tbody>
                        <tr>
                            <td align="center">
                                <? echo $buyer_arr[$job_array[$booking_job_no]['buyer']]; ?>
                            </td>
                            <td align="center">
                                <? echo $job_array[$booking_job_no]['job']; ?>
                            </td>
                            <td align="center">
                                <? echo number_format($returnReqQty, 3); ?>
                            </td>
                            <td align="center">
                                <? $cumulative_qty = $total_issue_qty - $total_return_qty;
                                echo number_format($cumulative_qty, 3); ?>
                            </td>
                            <td align="center">
                                <? $balance_qty = $returnReqQty - $cumulative_qty;
                                echo number_format($balance_qty, 3); ?>
                            </td>
                            <td align="center">
                                <? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <?
            }
        }
    }
        else if ($dataArray[0][csf('issue_basis')] == 1)
        {
            ?>
            <table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
            class="rpt_table">
            <thead>
                <tr>
                    <th colspan="6" align="center">Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
                        if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
                    } ?> </th>
                </tr>
                <tr>
                    <th>Buyer</th>
                    <th>Job</th>
                    <th>Req. Qty</th>
                    <th>Cuml. Qty</th>
                    <th>Balance Qty</th>
                    <th>Remarks</th>
                </tr>
            </thead>
            <?
            //$booking_job_arr=array();
            $returnJob = '';
            $returnPo = '';
            if ($db_type == 0)
            {
                $booking_cond = "group_concat( distinct a.booking_no)";
                $wo_cond = "group_concat(a.ydw_no)";
                $reqs_no = "group_concat(b.requisition_no)";
            }
            else if ($db_type == 2)
            {
                $booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
                $wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
                $reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
            }

            if ($dataArray[0][csf('issue_purpose')] == 8)
            {
                $sql_returnJob = sql_select("select a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
            }
            else if ($dataArray[0][csf('issue_purpose')] == 2)
            {
                if ($dataArray[0][csf('buyer_job_no')] != '') {
                    $sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

                    if ($db_type == 0) $poNoCond = "group_concat(id)";
                    else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
                    $sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
                } else {
                    $sql_returnJob = sql_select("select a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
                }
            }
            else
            {
                //echo "select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
                $sql_returnJob = sql_select("select b.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

                /*$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");*///and a.booking_no='".$dataArray[0][csf('booking_no')]."'
            }
            $returnJob = $sql_returnJob[0][csf('job_no')];
            $returnPo = $sql_po[0][csf('po_break_down_id')];
            $returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
            $returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

            $returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
            unset($sql_returnJob);

            //$booking_all="'".implode("','",explode(",",$bill_item_id))."'";
            //echo $returnJob.'---------'.$returnPo.'dfgdfgd';

            /*if( $dataArray[0][csf('issue_purpose')]==8 )
            {
                $sql = "select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='".$dataArray[0][csf('booking_no')]."' group by a.id";
            }
            else if( $dataArray[0][csf('issue_purpose')]==2)
            {
                if($dataArray[0][csf('buyer_job_no')]!="")
                {
                    $sql = "select sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='".$dataArray[0][csf('buyer_job_no')]."'"; // and a.ydw_no='".$dataArray[0][csf('booking_no')]."'
                }
            }
            else
            {
                if($dataArray[0][csf('buyer_job_no')]!="")
                {
                    $sql = "select a.job_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($returnBooking) and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
                }
            }
            $result = sql_select($sql);*/
            $all_requ_no = "";
            if ($dataArray[0][csf('issue_purpose')] != 8)
            {
                //echo "select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no";
                $all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

                $all_requ_no = $all_booking_sql[0][csf('requisition_no')];
                unset($all_booking_sql);
            }

            if ($dataArray[0][csf('issue_purpose')] == 8)
            {
                    $total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");    //
                    $total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
            }
            else if ($dataArray[0][csf('issue_purpose')] == 2)
            {
                /*if($all_requ_no!="" || $all_requ_no!=0)
                {
                    //$req_cond="or a.requisition_no in ($all_requ_no)";
                    //$reqRet_cond="or b.booking_no in ($all_requ_no)";
                }
                else
                {
                    //$req_cond="or a.requisition_no in (0)";
                    $reqRet_cond="or b.booking_no in (0)";
                }*/
                if ($dataArray[0][csf('buyer_job_no')] != "")
                {
                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
                        //echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
                }
                else
                {
                    //echo "select sum(a.cons_quantity) as total_issue_qty from inv_transaction a, inv_issue_master b where b.id=a.mst_id and b.booking_no='".$dataArray[0][csf('booking_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.buyer_job_no<>'' and b.issue_purpose=2";
                    $total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
                    //echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
                    $total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
                }
            }
            else
            {
                if ($dataArray[0][csf('buyer_job_no')] != "")
                {
                    if ($all_requ_no != "" || $all_requ_no != 0)
                    {
                        $req_cond = "or a.requisition_no in ($all_requ_no)";
                        $reqRet_cond = "or b.booking_no in ($all_requ_no)";
                    }
                    else
                    {
                        $req_cond = "";//or a.requisition_no in (0)
                        $reqRet_cond = "";//or b.booking_no in (0)
                    }

                    $total_issue_qty = 0;
                    //echo "select sum(c.quantity) as total_issue_qty from inv_transaction a, inv_issue_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2";
                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");
                    //echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2";
                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");

                    //$total_issue_qty=return_field_value("sum(quantity) as total_issue_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=2 and entry_form=3","total_issue_qty");
                    //$total_return_qty=return_field_value("sum(quantity) as total_return_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=4 and entry_form=8","total_return_qty");
                    }
                }
                ?>
                <tbody>
                    <tr>
                        <td align="center">
                            <?
                            if ($dataArray[0][csf('issue_purpose')] == 8)
                            {
                                echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
                            }
                            else
                            {
                                if($job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']!="")
                                {
                                    echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
                                }
                                else
                                {
                                    echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
                                }
                            }
                            ?>
                        </td>
                        <td align="center">
                            <? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
                        </td>
                        <td align="center">
                            <? echo number_format($returnReqQty, 3); ?>
                        </td>
                        <td align="center">
                            <? $cumulative_qty = 0;
                            $cumulative_qty = $total_issue_qty - $total_return_qty;
                            echo number_format($cumulative_qty, 3); ?>
                        </td>
                        <td align="center">
                            <? $balance_qty = $returnReqQty - $cumulative_qty;
                            echo number_format($balance_qty, 3); ?>
                        </td>
                        <td align="center">
                            <? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
                        </td>
                    </tr>
                </tbody>
            </table>
            <?
        }
    }

        echo "<br><br>";

        echo "Note: Received The Above in Goods Condition For Handling and Delivery.";

        echo "<br><br><br><br><br><br><br><br>";

        echo signature_table(49, $data[0], "1030px",'',0);
        ?>
    </div>
 </div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');
		</script>
		<p style="page-break-after: always;"> </p>

		<?
	}
	exit();
}

if ($action == "yarn_issue_store_print12")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);
	//var_dump($data);
	$print_with_vat = $data[7];
	$company  = $data[0];
	$location = $data[8];
	$store_id = $data[9];
	$basis    = $data[10];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	//echo $store_location_id.'system';
	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	//$supplier_arr = return_library_array("select id, short_name from lib_supplier", 'id', 'short_name');
	$supplier_arr = return_library_array("select id,supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
    //$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');

	if($basis == 1 || $basis == 3)
	{
		$group_sql = "select a.id, b.group_name from lib_company a, lib_group b where a.group_id=b.id and a.id='$company'";
		//echo $group_sql;
		$groupSqlResult = sql_select($group_sql);
		$group_arr= array();
		foreach($groupSqlResult as $row)
		{
			$group_arr[$row[csf('id')]]['group_name'] = $row[csf('group_name')];
		}
	}

	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
    //echo $sql;die;
	$dataArray = sql_select($sql);
	$demand_no = array();

	if( $dataArray[0][csf('issue_basis')]==3 || $dataArray[0][csf('issue_basis')]==8 )
	{
		$planbooking = sql_select("select b.requisition_no, e.booking_no as pln_booking_no, d.id from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$data[5]'");

		//for demand no
		if( $dataArray[0][csf('issue_basis')]==8 )
		{
			$req_no_arr = array();
			foreach($planbooking as $row)
			{
				$req_no_arr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];
			}

			$req_sql_zs = sql_select("select a.demand_system_no from ppl_yarn_demand_entry_mst a, ppl_yarn_demand_entry_dtls b where a.id = b.mst_id and b.requisition_no in(".implode(',', $req_no_arr).")");
			foreach($req_sql_zs as $row)
			{
				$demand_no[$row[csf('demand_system_no')]] = $row[csf('demand_system_no')];
			}
		}

		if( $dataArray[0][csf('issue_basis')]==3 )
		{
			$bookingNo = $planbooking[0][csf('pln_booking_no')];
		}
		else
		{
			$bookingNo = $dataArray[0][csf('booking_no')];

		}

		if(!empty($bookingNo))
		{
			$sql_stl_owner= "SELECT a.id, b.style_owner from wo_booking_mst a, wo_po_details_master b
			where a.booking_no='$bookingNo' and a.job_no=b.job_no and a.status_active=1 and a.is_deleted=0 and b.Status_active=1 and b.is_deleted=0
			group by a.id, b.style_owner order by a.id DESC";

			//echo $sql_stl_owner;
			$sqlStlOwnerResult = sql_select($sql_stl_owner);
			$style_owner_arr = array();
			foreach($sqlStlOwnerResult as $row)
			{
				$style_owner_arr[$row[csf('style_owner')]] = $company_library[$row[csf('style_owner')]];
			}
		}
	}
	else if( $dataArray[0][csf('issue_basis')]==1 )
	{
		$wo_no = $dataArray[0][csf('booking_no')];

		//echo "tttt".$wo_no ; die;
		$sql_stl_owner= "SELECT a.id, b.style_owner from wo_booking_mst a, wo_po_details_master b , wo_yarn_dyeing_mst c,wo_yarn_dyeing_dtls d where a.job_no=b.job_no and (a.booking_no=d.fab_booking_no or a.booking_no=d.booking_no) and b.job_no=d.job_no and c.id=d.mst_id and c.ydw_no='$wo_no' and a.status_active=1 and a.is_deleted=0 and b.Status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 group by a.id, b.style_owner order by a.id DESC";

		//echo $sql_stl_owner;
		$sqlStlOwnerResult = sql_select($sql_stl_owner);
		$style_owner_arr = array();
		foreach($sqlStlOwnerResult as $row)
		{
			$style_owner_arr[$row[csf('style_owner')]] = $company_library[$row[csf('style_owner')]];
		}
	}



	//$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$copyNo = "";
	for ($x = 1; $x <= 3; $x++)
	{
		if($x==1)
		{
			$copyNo ="<span style='font-size:x-large;'>1<sup>st</sup> Copy</span>";
		} else if($x==2){
			$copyNo ="<span style='font-size:x-large;'>2<sup>nd</sup> Copy</span>";
		} else {
			$copyNo ="<span style='font-size:x-large;'>3<sup>rd</sup> Copy</span>";
		}

		$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
		?>
		<div style="width:1150px;">
			<table width="1100" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td colspan="6" align="center" style="font-size:18px"></td>
					<td style="font-size:x-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">
					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="4" align="center">
						<?
						if($basis == 1 || $basis == 3)
						{ ?>
							<? echo $group_arr[$company]['group_name'];  ?><br>
							<strong style="font-size:18px"><? echo 'Style Owner : '.implode(', ', $style_owner_arr); ?></strong><br>
							<? echo $com_dtls[0]; ?><br>
						<?}else{?>
							<strong style="font-size:18px"><? echo $com_dtls[0]; ?></strong><br>
						<?}

						?>

						<?
						echo $com_dtls[1];
						?>
					</td>
					<td colspan="2" id="barcode_img_id">&nbsp;</td>
					<td colspan="3" style="color:black; font-weight:bold;"><? echo $copyNo;?></td>
				</tr>
				<tr>
					<td colspan="6" align="center" style="font-size:16px"><strong><u>Yarn Delivery Challan/Gate
					Pass</u></strong></center></td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td width="160"><strong>Issue No</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('issue_number')]; ?></td>
					<td width="120"><strong>Booking</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;
						<?
						if( $dataArray[0][csf('issue_basis')]==3 || $dataArray[0][csf('issue_basis')]==8 )
						{
							$bookingNo = $planbooking[0][csf('pln_booking_no')];
							$challan_prog = $planbooking[0][csf('id')];
						}
						else
						{
							$bookingNo = $dataArray[0][csf('booking_no')];
							$challan_prog = $dataArray[0][csf('challan_no')];
						}
						echo $bookingNo;
						?>
					</td>
					<td width="125"><strong>Knitting Source</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
				</tr>
				<tr>
					<td><strong>Challan/Program No</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? echo $challan_prog; ?></td>
					<td><strong>Issue Purpose</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
					echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
					?></td>
		<td><strong>Issue Date</strong></td>
		<td width="175px"><strong>:</strong>&nbsp;<? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
	</tr>
	<tr>
		<td><strong>Issue To</strong></td>
		<?
		if ($dataArray[0][csf('knit_dye_source')] == 3)
		{
			$supp_add = $dataArray[0][csf('knit_dye_company')];
			$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
			foreach ($nameArray as $result) {
				$address = "";
							if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
						}
						unset($nameArray);
					}

					$loan_party_add = $dataArray[0][csf('loan_party')];
					$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
					foreach ($loanPartyArray as $result) {
						$addressParty = "";
						if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($loanPartyArray);
					?>
					<td colspan="3"><strong>:</strong>&nbsp;
						<?
						if ($dataArray[0][csf('issue_purpose')] == 3) {
							echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
						} else if ($dataArray[0][csf('issue_purpose')] == 5) {
							echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
						} else {
							if ($dataArray[0][csf('knit_dye_source')] == 1)
								echo $company_library[$dataArray[0][csf('knit_dye_company')]];
							else
								echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
						}
						?>
					</td>
                    <td><strong>Location</strong></td>
					<td><strong>:</strong>&nbsp;<? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>
				</tr>
				<tr>
					<td><strong>Demand No.</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? echo implode(', ', $demand_no); ?></td>
					<td><strong>Gate Pass No.</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('gate_pass_no')]; ?></td>
					<td><strong>Do No</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? //echo $dataArray[0][csf('remarks')];
					?></td>
				</tr>
				<tr>
					<td valign="top"><strong>Remarks</strong></td>
					<td colspan="5"><strong>:</strong>&nbsp;<p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
				</tr>
				<?
				if ($print_with_vat == 1)
				{
					?>
					<tr>
						<td><strong>VAT Number</strong></td>
						<td><strong>:</strong>&nbsp;<p>
							<?
							$vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
							echo $vat_no;
							?>
                        </p></td>
                    </tr>
                    <?
                }
				else
				{
                    ?>
                    <tr>
                        <td valign="top">&nbsp;</strong></td>
                        <td>&nbsp;</td>
                    </tr>
                    <?
                }
                ?>
            </table>
            <br>
            <div style="width:100%;">
                <div style="clear:both;">
                    <table style="margin-right:-40px;" cellspacing="0" width="1150" border="1" rules="all"
                    class="rpt_table">
                    <thead bgcolor="#dddddd" style="font-size:13px">
                        <th width="20">SL</th>
                        <th width="45">Req. No</th>
                        <th width="50">Program No</th>
                        <th width="50">Lot No</th>
                        <th width="65">Y. Type</th>
                        <th width="110">Item Details</th>
                        <th width="65">Grey Color</th>
                        <th width="65">Dye. Color</th>
                        <th width="60">Supp.</th>
                        <th width="60"><b>Issue Qty(kg)</b></th>
                        <th width="60">Rtnbl Qty(kg)</th>
                        <th width="80">Bag & Cone</th>
                        <th width="80">Store</th>
                        <th width="100">Buyer & Job</th>
                        <th width="100">Cust. Buyer</th>
                        <th width="120">Order & Style</th>
                        <th>Inte. Ref & File</th>
                    </thead>
                    <?
                    $wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");

                    $cond = "";
                    if ($data[5] != "") $cond .= " and c.id='$data[5]'";

                    $po_array = array();
                    $job_array = array();

                    $costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0]");
                    foreach ($costing_sql as $row)
                    {
                        $po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
                        $po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
                        $po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
                        $po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
                        $job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
                        $job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
                    }

                    unset($costing_sql);
                    $stl_array = array();

                    $stl_sql = sql_select("select job_no, style_ref_no from wo_po_details_master");
                    foreach ($stl_sql as $row)
                    {
                        $stl_array[$row[csf('style_ref_no')]]['job'] = $row[csf('job_no')];
                    }
                    //var_dump($stl_array);
                    unset($stl_sql);

                    $job_no_array = array();
                    $jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id, po_buyer, customer_buyer from fabric_sales_order_mst");
                    foreach ($jobData as $row)
                    {
                        $job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
                        $job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
                        $job_no_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
                        $job_no_array[$row[csf('id')]]['customer_buyer'] = $row[csf('customer_buyer')];
                    }
                    //var_dump($po_array);
                    $po_id_req_array = array();
                    $is_sales_array = array();
                    if ($db_type == 0)
					{
                        $poID = " select c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales";
                    }
					else
					{
                        $poID = "select c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales";
                    }
                    $poID_sql_result = sql_select($poID);
                    foreach ($poID_sql_result as $row)
					{
                        $po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
                        $is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];

						$program_array[$row[csf('requisition_no')]]['program_no'] = $row[csf('knit_id')];
						//$program_array[$row[csf('requisition_no')]]['buyer_id'] = $row[csf('buyer_id')];
                    }
                    unset($poID_sql_result);

                    $i = 1;
                    if ($db_type == 0) {
                        $sql_result = sql_select("select a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro
                            from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
                            where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
                            group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no");
                    } else {
                        $sql_result = sql_select("select a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro
                        from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
                        group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no");
                    }
                    $all_req_no = '';
                    $all_prod_id = '';
                    $order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
                    $tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
                    foreach ($sql_result as $row)
					{
                        if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
                        if ($row[csf('requisition_no')] != '')
						{
                            if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
                            if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
                        }
                        $order_qnty_val = $row[csf('cons_quantity')];
                        $order_qnty_val_sum += $order_qnty_val;

                        $order_amount_val = $row[csf('order_amount')];
                        $order_amount_val_sum += $order_amount_val;

                        $no_of_bags_val = $row[csf('no_of_bags')];
                        $no_of_bags_val_sum += $no_of_bags_val;

                        $po_id = explode(",", $row[csf('po_id')]);
                        $po_no = '';
                        $style_ref = '';
                        $job_no = '';
                        $buyer = '';
                        //$data=explode('*',$data);
                        $productdtls = $row[csf('product_name_details')];
                        $productArr = explode(' ', $productdtls);

                        $proddtls='';
                        $proddtls=$yarn_count_details[$row[csf('yarn_count_id')]];
                        if($row[csf('yarn_count_id')]>0) $proddtls.=", ";
                        $proddtls.=$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."%";

                    /*if($row[csf('yarn_comp_type1st')]>0) $proddtls.=", ";
                    $proddtls.=$yarn_type[$row[csf('yarn_type')]];*/

                    /*if ($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' && $productArr[4]!=''&& $productArr[5]!='')
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].'%, '.$productArr[3].' '.$productArr[4]."%, ".$productArr[5].", ".$productArr[6];
                    }
                    else if ($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' && $productArr[4]!='')
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, '.$productArr[3].', '.$productArr[4];
                    }
                    else if($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' )
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, '.$productArr[3];
                    }
                    else if($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='')
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, ';
                    }
                    else if($productArr[0]!='' && $productArr[1]!='' )
                    {
                        $proddtls=$productArr[0].', '.$productArr[1];
                    }
                    else if($productArr[0]!='')
                    {
                        $proddtls=$productArr[0];
                    }
                    else
                    {
                        $proddtls='';
                    }*/

                    $internal_ref = '';
                    $file_no = '';
                    if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
                    {
                        foreach ($po_id as $val)
                        {
                            if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
                            if ($job_no == '') $job_no = $po_array[$val]['job_no'];
                            if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
                            if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                            if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
                            if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                        }
                        $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                        $job_file = array_unique(explode(",", rtrim($file_no, ", ")));
                        $ref_cond = '';
                        foreach ($job_ref as $ref) {
                            //$ref_cond.=", ".$ref;
                            if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                        }
                        $file_con = '';
                        foreach ($job_file as $file) {
                            if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                        }

                        $buyer_job = '';
                        if ($row[csf('issue_basis')] == 1)
                        {
                            if ($dataArray[0][csf('issue_purpose')] == 8)
                            {
                                $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                            }
                            else
                            {
                                if ($row[csf('buyer_job_no')] != "")
                                {
                                    $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                                }
                            }
                        }
                        else if ($row[csf('issue_basis')] == 2)
                        {
                            $buyer_job = '';
                        }

                        $customer_buyer = $buyer_arr[$job_no_array[$row[csf('buyer_job_no')]]['customer_buyer']];
                    }
                    else if ($row[csf('issue_basis')] == 3)
                    {
                        if ($is_sales_array[$row[csf('requisition_no')]] == 1)
                        {
                            $buyer_job = '';
                            foreach (array_unique($po_id) as $val) {
                                if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
                                if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
                                $customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];

                                if ($buyer_job == '')
                                {
                                    if ($job_no_array[$val]['within_group'] == 1)
                                    {
                                        $buyer_data = $buyer_arr[$job_no_array[$val]['po_buyer']];
                                        $job_data = $stl_array[$job_no_array[$val]['style_ref']]['job'];
                                        $buyer_job = $buyer_data.' & '.$job_data;
                                    }
                                    else
                                    {
                                        $buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
                                    }
                                }
                            }
                        }
                        else
                        {
                            foreach ($po_id as $val)
                            {
                                if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
                                if ($job_no == '') $job_no = $po_array[$val]['job_no'];
                                if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
                                if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                                if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
                                if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                            }

                            $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                            $job_file = array_unique(explode(",", rtrim($file_no, ", ")));

                            $ref_cond = '';
                            foreach ($job_ref as $ref) {
                                //$ref_cond.=", ".$ref;
                                if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                            }

                            $file_con = '';
                            foreach ($job_file as $file) {
                                if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                            }
                            if ($job_no != '')
                            {
                                $buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
                            }
                            else
                            {
                                if(!empty($po_array[$val]['buyer_name']))
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                            }
                        }
                    }
                    else
                    {
                        foreach (array_unique($po_id) as $val)
                        {
                            if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
                            if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
                            $customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];
                            if ($buyer_job == '')
                            {
                                if ($job_no_array[$val]['within_group'] == 1)
                                {

                                    $buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
                                }
                            }
                        }
                    }

                    $no_bag_cone = "";
                    $wt_bag_cone = "";
                    if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

                    if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" style="font-size:13px">
                        <td width="20"><? echo $i; ?></td>
                        <td width="45">
                            <div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
                        </td>
                        <td width="50">
                            <div style="word-wrap:break-word; width:50px"><? echo $program_array[$row[csf('requisition_no')]]['program_no']; ?></div>
                        </td>
                        <td width="50">
                            <div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
                        </td>
                        <td width="65">
                            <div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
                        </td>
                        <td width="110">
                            <div style="word-wrap:break-word; width:110px">
                                <?
                                //echo $proddtls;
                                echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
                                ?>
                            </div>
                        </td>
                        <td width="65">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('color')]]; ?></div>
                        </td>
                        <td width="65">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
                        &nbsp;</div>
                    </td>
                    <td width="60">
                        <div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
                    </td>
                    <td align="right"
                    width="60"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
                    <td align="right"
                    width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
                    <td width="80">
                        <div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
                    &nbsp;</div>
                </td>
                <td width="80">
                    <div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
                </td>
                <td width="100">
                    <div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
                </td>
                <td width="100">
                    <div style="word-wrap:break-word; width:100px"><? echo $customer_buyer; ?></div>
                </td>
                <td width="120">
                    <div style="word-wrap:break-word; width:120px"><? echo $po_no;
                    if ($style_ref != "") echo ' & ' . $style_ref; else echo '&nbsp;'; ?></div>
                </td>
                <td>
                    <div style="word-wrap:break-word; width:80px"><? echo ltrim($ref_cond, ", ");
                    if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?></div>
                </td>
            </tr>
            <?
            $uom_unit = "Kg";
            $uom_gm = "Grams";
            $tot_return_qty += $row[csf('returnable_qnty')];
            $tot_bag += $no_of_bags_val;
            $tot_cone += $row[csf('cone_per_bag')];
            $tot_w_bag += $row[csf('weight_per_bag')];
            $tot_w_cone += $row[csf('weight_per_cone')];
            $req_no = $row[csf('requisition_no')];
            $i++;
        }
        ?>
        <tr bgcolor="#CCCCCC" style="font-size:13px">
            <td align="right" colspan="9"><b>Total</b></td>
            <td align="right">
                <b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
            </td>
            <td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
            <td><? echo 'N:' . number_format($tot_bag, 2);
            if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
            echo '<br>W:' . number_format($tot_w_bag, 2);
            if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
            <td align="right" colspan="5">&nbsp;</td>
        </tr>
        <tr>
            <td colspan="17" align="left"><b>In
                Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
            </tr>
        </table>
    </div>
    <br>
    <!--================================================================-->
    <?
    if ($data[6] == 1)
    {
        if ($dataArray[0][csf('issue_basis')] == 3)
        {
            ?>
            <div style="">
                <table width="850" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
                    <thead>
                        <tr>
                            <th colspan="7" align="center">Requisition Details</th>
                        </tr>
                        <tr>
                            <th width="40">SL</th>
                            <th width="100">Requisition No</th>
                            <th width="110">Lot No</th>
                            <th width="220">Yarn Description</th>
                            <th width="110">Brand</th>
                            <th width="90">Requisition Qty</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <?
                //echo $all_req_no;
                    $i = 1;
                    $tot_reqsn_qnty = 0;
                    $brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
                    $product_details_array = array();
                    $sql = "select id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where item_category_id=1 and company_id='$data[0]' and status_active=1 and is_deleted=0";
                    $result = sql_select($sql);

                    foreach ($result as $row) {
                        $compos = '';
                        if ($row[csf('yarn_comp_percent2nd')] != 0) {
                            $compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
                        } else {
                            $compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
                        }
                        $product_details_array[$row[csf('id')]]['count'] = $count_arr[$row[csf('yarn_count_id')]];
                        $product_details_array[$row[csf('id')]]['comp'] = $compos;
                        $product_details_array[$row[csf('id')]]['type'] = $yarn_type[$row[csf('yarn_type')]];
                        $product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
                        $product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
                    }
                    unset($result);
                    $sql = "select knit_id, requisition_no, prod_id, sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where requisition_no in ($all_req_no) and status_active=1 and is_deleted=0 group by requisition_no, prod_id, knit_id";
                    $nameArray = sql_select($sql);
                    foreach ($nameArray as $selectResult) {
                        ?>
                        <tr>
                            <td width="40" align="center"><? echo $i; ?></td>
                            <td width="100" align="center">&nbsp;<? echo $selectResult[csf('requisition_no')]; ?></td>
                            <td width="110" align="center">
                                &nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['lot']; ?></td>
                                <td width="220">
                                    &nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['count'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['comp'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['type']; ?></td>
                                    <td width="110" align="center">
                                        &nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['brand']; ?></td>
                                        <td width="90" align="right"><? echo number_format($selectResult[csf('yarn_qnty')], 2); ?>
                                    &nbsp;</td>
                        <td>&nbsp;<? //echo $selectResult[csf('requisition_no')];
                        ?></td>
                    </tr>
                    <?
                    $tot_reqsn_qnty += $selectResult[csf('yarn_qnty')];
                    $i++;
                }
                ?>
                <tfoot>
                    <th colspan="5" align="right"><b>Total</b></th>
                    <th align="right"><? echo number_format($tot_reqsn_qnty, 2); ?>&nbsp;</th>
                    <th>&nbsp;</th>
                </tfoot>
            </table>
            <?
            if ($data[5] != 1) {
                $z = 1;
                $k = 1;
                $colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

                $booking_al = "";
                foreach ($colorArray as $book) {
                    if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];
                }
                //unset($colorArray);
                //echo $booking_no;
                $booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
                $booking_count = count(array_unique(explode(',', $booking_no)));
                //$booking_job_arr=array();
                if ($dataArray[0][csf('issue_purpose')] == 2)
                {
                    $booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
                } else {
                    $booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
                }
                //
                $booking_job_no = $booking_job[0][csf('job_no')];
                unset($booking_job);

                if ($db_type == 0) $poNoCond = "group_concat(id)";
                else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
                /*echo '='.$sql_Job.'=';
            if($sql_Job!="")
            {*/
                $sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

                $job_po = $sql_returnJob[0][csf('po_break_down_id')];
                unset($sql_returnJob);
                ?>

                <table width="710" cellpadding="0" cellspacing="0" border="1" rules="all" style="margin-top:20px;"
                class="rpt_table">
                <thead>
                    <th width="40">SL</th>
                    <th width="250">Fabrication</th>
                    <th width="120">Color</th>
                    <th width="120">GGSM OR S/L</th>
                    <th>FGSM</th>
                </thead>
                <tbody>
                    <tr>
                        <td width="40" align="center"><? echo $z; ?></td>
                        <td width="250"
                        align="center"><? echo $body_part[$colorArray[0][csf('body_part_id')]] . ', ' . $colorArray[0][csf('fabric_desc')]; ?></td>
                        <td width="120"
                        align="center"><? echo $color_range[$colorArray[0][csf('color_range')]]; ?></td>
                        <td width="120" align="center"><? echo $colorArray[0][csf('stitch_length')]; ?></td>
                        <td align="center"><? echo $colorArray[0][csf('gsm_weight')]; ?></td>
                    </tr>
                </tbody>
            </table>
            <table style="margin-top:20px;" width="650" border="1" rules="all" cellpadding="0" cellspacing="0"
            class="rpt_table">
            <thead>
                <th width="40">SL</th>
                <th width="50">Prog. No</th>
                <th width="110">Finish Dia</th>
                <th width="170">Machine Dia & Gauge</th>
                <th width="110">Program Qty</th>
                <th>Remarks</th>
            </thead>
            <tbody>
                <?
                $k=1;
                foreach ($colorArray as $program_row) {
                    ?>
                    <tr>
                        <td width="40" align="center"><? echo $k; ?></td>
                        <td width="50" align="center"><? echo $program_row[csf('knit_id')]; ?></td>
                        <td width="110" align="center"><? echo $program_row[csf('dia')]; ?></td>
                        <td width="170" align="center"><? echo $program_row[csf('machine_dia')] . "X" . $program_row[csf('machine_gg')]; ?></td>
                        <td width="110" align="right"><? echo number_format($program_row[csf('program_qnty')], 2); ?></td>
                        <td><? echo $program_row[csf('remarks')]; ?></td>
                    </tr>
                    <?
                    $k++;
                    $tot_prog_qty += $program_row[csf('program_qnty')];
                }
                ?>
                <tr>
                    <td colspan="4" align="right"><strong>Total : </strong></td>
                    <td align="right"><? echo number_format($tot_prog_qty, 2); ?></td>
                    <td>&nbsp;</td>
                </tr>
            </tbody>
        </table>
        <?
        $returnJob = '';
        $returnPo = '';
        if ($db_type == 0) {
            $booking_cond = "group_concat(a.booking_no)";
            $wo_cond = "group_concat(a.ydw_no)";
            $reqs_no = "group_concat(b.requisition_no)";
        } else if ($db_type == 2) {
            $booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
            $wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
            $reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
        }

        if ($dataArray[0][csf('issue_purpose')] == 8) {
            $sql_returnJob = sql_select("select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
        } else if ($dataArray[0][csf('issue_purpose')] == 2) {
            $sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

            if ($db_type == 0) $poNoCond = "group_concat(id)";
            else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
            $sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
        } else {

                    $sql_returnJob = sql_select("select a.job_no, a.booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' and a.booking_no in($booking_no) group by a.job_no,a.booking_no"); //and a.booking_no='".$dataArray[0][csf('booking_no')]."'

                }
                $returnJob = $sql_returnJob[0][csf('job_no')];
                //$returnPo=$sql_po[0][csf('po_break_down_id')];
                $returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
                $returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
                $returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
                unset($sql_returnJob);

                /*$req_no_retInJob=sql_select("select $reqs_no as req_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");
                $reqNo_inJob=$req_no_retInJob[0][csf('req_no')];*/
                ?>
                <table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
                class="rpt_table">
                <thead>
                    <tr>
                        <th colspan="6" align="center">Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking Job
                        Deatils]</p></th>
                    </tr>
                    <tr>
                        <th>Buyer</th>
                        <th>Job</th>
                        <th>Req. Qty</th>
                        <th>Cuml. Issue Qty</th>
                        <th>Balance Qty</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <?

                $all_requ_no = "";
                if ($dataArray[0][csf('issue_purpose')] != 8) {
                    $all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");

                    //$all_requ_no="'".$all_booking_sql[0][csf('requisition_no')]."'";
                    $all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
                }
                if ($dataArray[0][csf('issue_purpose')] == 8) {
                    $total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");    //
                    $total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
                } else if ($dataArray[0][csf('issue_purpose')] == 2) {
                    if ($all_requ_no != "" || $all_requ_no != 0) {
                        $req_cond = "or a.requisition_no in ($all_requ_no)";
                        $reqRet_cond = "or b.booking_no in ($all_requ_no)";
                    } else {
                        $req_cond = "or a.requisition_no in (0)";
                        $reqRet_cond = "or b.booking_no in (0)";
                    }

                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
                } else {
                    if ($all_requ_no != "" || $all_requ_no != 0) {
                        $req_cond = "or a.requisition_no in ($all_requ_no)";
                        $reqRet_cond = "or b.booking_no in ($all_requ_no)";
                    } else {
                        $req_cond = "or a.requisition_no in (0)";
                        $reqRet_cond = "or b.booking_no in (0)";
                    }
                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");


                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
                }
                $cumulative_qty = 0;
                if ($booking_count == 1) {
                    ?>
                    <tbody>
                        <tr>
                            <td align="center">
                                <? echo $buyer_arr[$job_array[$booking_job_no]['buyer']]; ?>
                            </td>
                            <td align="center">
                                <? echo $job_array[$booking_job_no]['job']; ?>
                            </td>
                            <td align="center">
                                <? echo number_format($returnReqQty, 3); ?>
                            </td>
                            <td align="center">
                                <? $cumulative_qty = $total_issue_qty - $total_return_qty;
                                echo number_format($cumulative_qty, 3); ?>
                            </td>
                            <td align="center">
                                <? $balance_qty = $returnReqQty - $cumulative_qty;
                                echo number_format($balance_qty, 3); ?>
                            </td>
                            <td align="center">
                                <? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <?
            }
        }
    }
        else if ($dataArray[0][csf('issue_basis')] == 1)
        {
            ?>
            <table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
            class="rpt_table">
            <thead>
                <tr>
                    <th colspan="6" align="center">Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
                        if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
                    } ?> </th>
                </tr>
                <tr>
                    <th>Buyer</th>
                    <th>Job</th>
                    <th>Req. Qty</th>
                    <th>Cuml. Qty</th>
                    <th>Balance Qty</th>
                    <th>Remarks</th>
                </tr>
            </thead>
            <?
            //$booking_job_arr=array();
            $returnJob = '';
            $returnPo = '';
            if ($db_type == 0)
            {
                $booking_cond = "group_concat( distinct a.booking_no)";
                $wo_cond = "group_concat(a.ydw_no)";
                $reqs_no = "group_concat(b.requisition_no)";
            }
            else if ($db_type == 2)
            {
                $booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
                $wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
                $reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
            }

            if ($dataArray[0][csf('issue_purpose')] == 8)
            {
                $sql_returnJob = sql_select("select a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
            }
            else if ($dataArray[0][csf('issue_purpose')] == 2)
            {
                if ($dataArray[0][csf('buyer_job_no')] != '') {
                    $sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

                    if ($db_type == 0) $poNoCond = "group_concat(id)";
                    else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
                    $sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
                } else {
                    $sql_returnJob = sql_select("select a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
                }
            }
            else
            {
                //echo "select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
                $sql_returnJob = sql_select("select b.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

                /*$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");*///and a.booking_no='".$dataArray[0][csf('booking_no')]."'
            }
            $returnJob = $sql_returnJob[0][csf('job_no')];
            $returnPo = $sql_po[0][csf('po_break_down_id')];
            $returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
            $returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

            $returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
            unset($sql_returnJob);

            //$booking_all="'".implode("','",explode(",",$bill_item_id))."'";
            //echo $returnJob.'---------'.$returnPo.'dfgdfgd';

            /*if( $dataArray[0][csf('issue_purpose')]==8 )
            {
                $sql = "select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='".$dataArray[0][csf('booking_no')]."' group by a.id";
            }
            else if( $dataArray[0][csf('issue_purpose')]==2)
            {
                if($dataArray[0][csf('buyer_job_no')]!="")
                {
                    $sql = "select sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='".$dataArray[0][csf('buyer_job_no')]."'"; // and a.ydw_no='".$dataArray[0][csf('booking_no')]."'
                }
            }
            else
            {
                if($dataArray[0][csf('buyer_job_no')]!="")
                {
                    $sql = "select a.job_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($returnBooking) and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
                }
            }
            $result = sql_select($sql);*/
            $all_requ_no = "";
            if ($dataArray[0][csf('issue_purpose')] != 8)
            {
                //echo "select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no";
                $all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

                $all_requ_no = $all_booking_sql[0][csf('requisition_no')];
                unset($all_booking_sql);
            }

            if ($dataArray[0][csf('issue_purpose')] == 8)
            {
                    $total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");    //
                    $total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
            }
            else if ($dataArray[0][csf('issue_purpose')] == 2)
            {
                /*if($all_requ_no!="" || $all_requ_no!=0)
                {
                    //$req_cond="or a.requisition_no in ($all_requ_no)";
                    //$reqRet_cond="or b.booking_no in ($all_requ_no)";
                }
                else
                {
                    //$req_cond="or a.requisition_no in (0)";
                    $reqRet_cond="or b.booking_no in (0)";
                }*/
                if ($dataArray[0][csf('buyer_job_no')] != "")
                {
                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
                        //echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
                }
                else
                {
                    //echo "select sum(a.cons_quantity) as total_issue_qty from inv_transaction a, inv_issue_master b where b.id=a.mst_id and b.booking_no='".$dataArray[0][csf('booking_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.buyer_job_no<>'' and b.issue_purpose=2";
                    $total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
                    //echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
                    $total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
                }
            }
            else
            {
                if ($dataArray[0][csf('buyer_job_no')] != "")
                {
                    if ($all_requ_no != "" || $all_requ_no != 0)
                    {
                        $req_cond = "or a.requisition_no in ($all_requ_no)";
                        $reqRet_cond = "or b.booking_no in ($all_requ_no)";
                    }
                    else
                    {
                        $req_cond = "";//or a.requisition_no in (0)
                        $reqRet_cond = "";//or b.booking_no in (0)
                    }

                    $total_issue_qty = 0;
                    //echo "select sum(c.quantity) as total_issue_qty from inv_transaction a, inv_issue_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2";
                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");
                    //echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2";
                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");

                    //$total_issue_qty=return_field_value("sum(quantity) as total_issue_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=2 and entry_form=3","total_issue_qty");
                    //$total_return_qty=return_field_value("sum(quantity) as total_return_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=4 and entry_form=8","total_return_qty");
                    }
                }
                ?>
                <tbody>
                    <tr>
                        <td align="center">
                            <?
                            if ($dataArray[0][csf('issue_purpose')] == 8)
                            {
                                echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
                            }
                            else
                            {
                                if($job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']!="")
                                {
                                    echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
                                }
                                else
                                {
                                    echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
                                }
                            }
                            ?>
                        </td>
                        <td align="center">
                            <? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
                        </td>
                        <td align="center">
                            <? echo number_format($returnReqQty, 3); ?>
                        </td>
                        <td align="center">
                            <? $cumulative_qty = 0;
                            $cumulative_qty = $total_issue_qty - $total_return_qty;
                            echo number_format($cumulative_qty, 3); ?>
                        </td>
                        <td align="center">
                            <? $balance_qty = $returnReqQty - $cumulative_qty;
                            echo number_format($balance_qty, 3); ?>
                        </td>
                        <td align="center">
                            <? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
                        </td>
                    </tr>
                </tbody>
            </table>
            <?
        }
    }

        echo "<br><br>";

        echo "Note: Received The Above in Goods Condition For Handling and Delivery.";

        echo "<br><br><br><br><br><br><br><br>";

        echo signature_table(49, $data[0], "1030px",'',0);
        ?>
    </div>
 </div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');
		</script>
		<p style="page-break-after: always;"> </p>

		<?
	}
	exit();
}

if ($action == "yarn_issue_store_printccl")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$print_with_vat = $data[7];
	$company  = $data[0];
	$cust_buyer  = $data[6];
	$location = $data[8];
	$store_id = $data[9];
	$basis    = $data[10];
	$buyer_id = $data[11];
	$no_copy    = $data[12];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	//echo $store_location_id.'system';
	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	//$supplier_arr = return_library_array("select id, short_name from lib_supplier", 'id', 'short_name');
	$supplier_arr = return_library_array("select id,supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');
    //$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$floor_room_rack_arr = return_library_array("select floor_room_rack_id, floor_room_rack_name from lib_floor_room_rack_mst", 'floor_room_rack_id', 'floor_room_rack_name');
	$booking_type= array(1=>'Short',2=>'Main');
	// $customer_buyer_name_arr =  return_library_array("select buyer_name from lib_buyer","id","buyer_name");
	// print_r($customer_buyer_name_arr);
	$customer_buyer_name = return_field_value("buyer_name", "lib_buyer", "id=$buyer_id and is_deleted=0");

	if($basis == 1 || $basis == 3)
	{
		$group_sql = "select a.id, b.group_name from lib_company a, lib_group b where a.group_id=b.id and a.id='$company'";
		//echo $group_sql;
		$groupSqlResult = sql_select($group_sql);
		$group_arr= array();
		foreach($groupSqlResult as $row)
		{
			$group_arr[$row[csf('id')]]['group_name'] = $row[csf('group_name')];
		}
	}

	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
    //echo $sql;die;
	$dataArray = sql_select($sql);
	$demand_no_arr = array();

	if( $dataArray[0][csf('issue_basis')]==3 || $dataArray[0][csf('issue_basis')]==8 )
	{
		$planbooking = sql_select("select b.requisition_no, e.booking_no as pln_booking_no, d.id from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$data[5]'");

		//for demand no
		if( $dataArray[0][csf('issue_basis')]==8 )
		{
			$req_no_arr = array();
			foreach($planbooking as $row)
			{
				$req_no_arr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];
			}


			$req_sql_zs = sql_select("SELECT a.demand_system_no, b.requisition_no FROM ppl_yarn_demand_entry_mst a, ppl_yarn_demand_entry_dtls b WHERE     a.id = b.mst_id AND b.requisition_no in(".implode(',', $req_no_arr).") and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.demand_system_no, b.requisition_no");
			foreach($req_sql_zs as $row)
			{
				$demand_no_arr[$row[csf('requisition_no')]]['demand_system_no'] = $row[csf('demand_system_no')];
			}
		}
		//var_dump($demand_no_arr);

		if( $dataArray[0][csf('issue_basis')]==3 )
		{
			$bookingNo = $planbooking[0][csf('pln_booking_no')];
		}
		else
		{
			$bookingNo = $dataArray[0][csf('booking_no')];

		}

		if(!empty($bookingNo))
		{
			$sql_stl_owner= "SELECT a.id, b.style_owner from wo_booking_mst a, wo_po_details_master b
			where a.booking_no='$bookingNo' and a.job_no=b.job_no and a.status_active=1 and a.is_deleted=0 and b.Status_active=1 and b.is_deleted=0
			group by a.id, b.style_owner order by a.id DESC";

			//echo $sql_stl_owner;
			$sqlStlOwnerResult = sql_select($sql_stl_owner);
			$style_owner_arr = array();
			foreach($sqlStlOwnerResult as $row)
			{
				$style_owner_arr[$row[csf('style_owner')]] = $company_library[$row[csf('style_owner')]];
			}
		}
	}
	else if( $dataArray[0][csf('issue_basis')]==1 || $dataArray[0][csf('issue_purpose')]==2 )
	{
		$booking_id = $dataArray[0][csf('booking_id')];
		$sql_smn = "SELECT a.mst_id, a.job_no_id, a.booking_no, b.internal_ref from wo_yarn_dyeing_dtls a, sample_development_mst b where a.job_no_id=b.id and a.mst_id=$booking_id and a.status_active=1 and a.is_deleted=0 group by a.mst_id,a.job_no_id, a.booking_no, b.internal_ref";
		//echo $sql;
		$smn_info_arr = array();
		$sql_smn_res = sql_select($sql_smn);
		foreach ($sql_smn_res as $row)
		{
			$smn_info_arr[$row[csf('mst_id')]]['int_ref']=$row[csf('internal_ref')];
			$smn_booking_number = $row[csf('booking_no')];
		}
		unset($sql_smn_res);
		//echo "<pre>";print_r($smn_info_arr);
	}
	else if( $dataArray[0][csf('issue_basis')]==1 )
	{
		$wo_no = $dataArray[0][csf('booking_no')];

		//echo "tttt".$wo_no ; die;
		$sql_stl_owner= "SELECT a.id, b.style_owner from wo_booking_mst a, wo_po_details_master b , wo_yarn_dyeing_mst c,wo_yarn_dyeing_dtls d where a.job_no=b.job_no and (a.booking_no=d.fab_booking_no or a.booking_no=d.booking_no) and b.job_no=d.job_no and c.id=d.mst_id and c.ydw_no='$wo_no' and a.status_active=1 and a.is_deleted=0 and b.Status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 group by a.id, b.style_owner order by a.id DESC";

		//echo $sql_stl_owner;
		$sqlStlOwnerResult = sql_select($sql_stl_owner);
		$style_owner_arr = array();
		foreach($sqlStlOwnerResult as $row)
		{
			$style_owner_arr[$row[csf('style_owner')]] = $company_library[$row[csf('style_owner')]];
		}
	}



	//$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$copyNo = "";
	for ($x = 1; $x <= $no_copy; $x++)
	{
		if($x==1)
		{
			$copyNo ="<span style='font-size:x-large;'>1<sup>st</sup> Copy</span>";
		}
		else if($x==2)
		{
			$copyNo ="<span style='font-size:x-large;'>2<sup>nd</sup> Copy</span>";
		}
		else if($x==3)
		{
			$copyNo ="<span style='font-size:x-large;'>3<sup>rd</sup> Copy</span>";
		}
		else if($x==4)
		{
			$copyNo ="<span style='font-size:x-large;'>4<sup>th</sup> Copy</span>";
		}
		else if($x==5)
		{
			$copyNo ="<span style='font-size:x-large;'>5<sup>th</sup> Copy</span>";
		}
		else if($x==6)
		{
			$copyNo ="<span style='font-size:x-large;'>6<sup>th</sup> Copy</span>";
		}
		else if($x==7)
		{
			$copyNo ="<span style='font-size:x-large;'>7<sup>th</sup> Copy</span>";
		}
		else if($x==8)
		{
			$copyNo ="<span style='font-size:x-large;'>8<sup>th</sup> Copy</span>";
		}
		else if($x==9)
		{
			$copyNo ="<span style='font-size:x-large;'>9<sup>th</sup> Copy</span>";
		}
		else  if($x==10)
		{
			$copyNo ="<span style='font-size:x-large;'10<sup>th</sup> Copy</span>";
		}

		$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
		?>
		<div style="width:1150px;">
			<table width="1100" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td colspan="6" align="center" style="font-size:18px"></td>
					<td style="font-size:x-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">
					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="4" align="center">
							<strong style="font-size:18px"><? echo $com_dtls[0]; ?></strong><br>
						<?
						echo $com_dtls[1];
						?>
					</td>
					<td colspan="2" id="barcode_img_id">&nbsp;</td>
					<td colspan="3" style="color:black; font-weight:bold;"><? echo $copyNo;?></td>
				</tr>
				<tr>
					<td colspan="6" align="center" style="font-size:16px"><strong><u>Yarn Delivery Challan/Gate
					Pass</u></strong></center></td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td style="font-size: 15px;" width="160"><strong>Issue No</strong></td>
					<td style="font-size: 15px;" width="175px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('issue_number')]; ?></td>
					<td style="font-size: 15px;" width="120"><strong>Issue Purpose</strong></td>
					<td style="font-size: 15px;" width="175px"><strong>:</strong>&nbsp;
						<?
						echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];
						?>
					</td>
					<td style="font-size: 15px;" width="125"><strong>Knitting Source</strong></td>
					<td style="font-size: 15px;" width="175px"><strong>:</strong>&nbsp;<? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
				</tr>
				<tr>
					<td style="font-size: 15px;"><strong>Challan</strong></td>
					<td style="font-size: 15px;" width="175px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('challan_no')]; ?></td>
					<td style="font-size: 15px;"><strong>Issue Date</strong></td>
					<td style="font-size: 15px;" width="175px"><strong>:</strong>&nbsp;
						<? echo change_date_format($dataArray[0][csf('issue_date')]);?>
					</td>
		<td style="font-size: 15px;"><strong>Issue To</strong></td>
		<?
		if ($dataArray[0][csf('knit_dye_source')] == 3)
		{
			$supp_add = $dataArray[0][csf('knit_dye_company')];
			$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
			foreach ($nameArray as $result) {
				$address = "";
							if ($result != "") $address = $result[csf('address_1')];
						}
						unset($nameArray);
					}

					$loan_party_add = $dataArray[0][csf('loan_party')];
					$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
					foreach ($loanPartyArray as $result) {
						$addressParty = "";
						if ($result != "") $addressParty = $result['address'];
					}
					unset($loanPartyArray);
					?>
		<td style="font-size: 15px;" width="175px"><strong>:</strong>&nbsp;
			<?
			if ($dataArray[0][csf('issue_purpose')] == 3) {
				echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
			} else if ($dataArray[0][csf('issue_purpose')] == 5) {
				echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
			} else {
				if ($dataArray[0][csf('knit_dye_source')] == 1)
					echo $company_library[$dataArray[0][csf('knit_dye_company')]];
				else
					echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
			}
			?>
		</td>
	</tr>

	<tr>
		<td style="font-size: 15px;"><strong>Location</strong></td>
		<td style="font-size: 15px;"><strong>:</strong>&nbsp;<? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>
		<td style="font-size: 15px;"><strong>Gate Pass No.</strong></td>
		<td style="font-size: 15px;" width="175px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('gate_pass_no')]; ?></td>
		<td style="font-size: 15px;"><strong>Do No</strong></td>
		<td width="175px"><strong>:</strong>&nbsp;</td>
	</tr>
	<tr>
		<td style="font-size: 15px;" valign="top"><strong>Remarks</strong></td>
		<td style="font-size: 15px;" colspan="5"><strong>:</strong>&nbsp;<p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
	</tr>
	<tr>
		<td style="font-size: 15px;"><strong>Driver Name</strong></td>
		<td><strong>:</strong>&nbsp;</td>
		<td style="font-size: 15px;"><strong>Driver Mobile No</strong></td>
		<td width="175px"><strong>:</strong>&nbsp;</td>
		<td style="font-size: 15px;"><strong>Vehicle No</strong></td>
		<td width="175px"><strong>:</strong>&nbsp;</td>
	</tr>

     </table>
            <br>
            <div style="width:100%;">
                <div style="clear:both;">
                    <table style="margin-right:-40px;" cellspacing="0" width="1380" border="1" rules="all"
                    class="rpt_table">
                    <thead bgcolor="#dddddd" style="font-size:13px">
                        <th width="20">SL</th>
                        <th width="145">Req. No  & <br>Demand No.</th>
                        <th width="100">S.Booking No.<br> & Prog No. </th>
                        <th width="50">Lot No</th>
                        <th width="65">Y. Type</th>
                        <th width="110">Item Details</th>
                        <th width="65">Grey Color</th>
                        <th width="65">Dye. Color</th>
                        <th width="60">Supp.</th>
                        <th width="60"><b>Issue Qty(kg)</b></th>
                        <th width="60">Rtnbl Qty(kg)</th>
                        <th width="80">Bag & Cone</th>
                        <th width="80">Store</th>
                        <th width="80">Floor</th>
                        <!-- <th width="100">Buyer & Job</th> -->
						<? if($cust_buyer==1){?>
                        <th width="100">Cust. Buyer</th>
						<? } ?>
                        <!-- <th width="120">Order & Style</th> -->
                        <th>IR /IB &  B.Type</th>
                    </thead>
                    <?
                    $wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");

                    $cond = "";
                    if ($data[5] != "") $cond .= " and c.id='$data[5]'";

                    $po_array = array();
                    $job_array = array();

                    $costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0]");
                    foreach ($costing_sql as $row)
                    {
                        $po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
                        $po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
                        $po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
                        $po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
                        $job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
                        $job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];

						$job_intfarray[$row[csf('job_no')]]['grouping'] = $row[csf('grouping')].',';
                    }

                    unset($costing_sql);

					$sales_order_array = array();
					$sales_order_sql = sql_select("select a.id,a.sales_booking_no, a.job_no,a.style_ref_no, a.buyer_id,b.job_no po_job_no,b.buyer_id po_buyer,a.within_group, b.is_short from fabric_sales_order_mst a left join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.status_active = 1 and a.is_deleted = 0 and a.company_id=$data[0]");
					foreach ($sales_order_sql as $row)
					{
						$sales_order_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
						$sales_order_array[$row[csf('id')]]['sales_order_no'] = $row[csf('job_no')];
						$sales_order_array[$row[csf('id')]]['po_job_no'] = $row[csf('po_job_no')];
						$sales_order_array[$row[csf('id')]]['sales_booking_no'] = $row[csf('sales_booking_no')];
						$sales_order_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
						$sales_order_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
						$sales_order_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
						$sales_order_array[$row[csf('id')]]['is_short'] = $row[csf('is_short')];
					}

                    $stl_array = array();

                    $stl_sql = sql_select("select job_no, style_ref_no from wo_po_details_master");
                    foreach ($stl_sql as $row)
                    {
                        $stl_array[$row[csf('style_ref_no')]]['job'] = $row[csf('job_no')];
                    }
                    //var_dump($stl_array);
                    unset($stl_sql);

                    $job_no_array = array();
                    $jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id, po_buyer, customer_buyer from fabric_sales_order_mst");
                    foreach ($jobData as $row)
                    {
                        $job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
                        $job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
                        $job_no_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
                        $job_no_array[$row[csf('id')]]['customer_buyer'] = $row[csf('customer_buyer')];
                    }
                    //var_dump($po_array);
                    $po_id_req_array = array();
                    $is_sales_array = array();
                    if ($db_type == 0)
					{
                        $poID = " SELECT c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, group_concat(distinct(a.po_id)) as poid,a.booking_no from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id and c.requisition_no in(".implode(',', $req_no_arr).") group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales,a.booking_no";
                    }
					else
					{
                        $poID = "SELECT c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid,a.booking_no from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id and c.requisition_no in(".implode(',', $req_no_arr).") group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales,a.booking_no";
                    }
					//echo $poID;
                    $poID_sql_result = sql_select($poID);
					$smnBookingNoArr = array();
                    foreach ($poID_sql_result as $row)
					{
                        $po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
                        $is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];

						$program_array[$row[csf('requisition_no')]]['program_no'] = $row[csf('knit_id')];
						$program_array[$row[csf('requisition_no')]]['booking_no'] = $row[csf('booking_no')];
						//$program_array[$row[csf('requisition_no')]]['buyer_id'] = $row[csf('buyer_id')];
						array_push($smnBookingNoArr,$row[csf('booking_no')]);
                    }
                    unset($poID_sql_result);
					//$booking_number = $program_array[$row[csf('requisition_no')]]['booking_no'];
					$i_ref_sql = "SELECT a.booking_no,b.internal_ref, b.buyer_name from SAMPLE_DEVELOPMENT_MST b, WO_NON_ORD_SAMP_BOOKING_DTLS a where b.id = a.style_id ".where_con_using_array($smnBookingNoArr, '1', 'a.booking_no')." group by a.booking_no,b.internal_ref, b.buyer_name";
					//$i_ref_sql = "select b.internal_ref from SAMPLE_DEVELOPMENT_MST b, WO_NON_ORD_SAMP_BOOKING_DTLS a where b.id = a.style_id and a.booking_no = '$booking_number'";
					//echo $i_ref_sql;
					$i_sql_result = sql_select($i_ref_sql);
					// echo($i_ref_sql);
					$smIintRefCondArr = array();
					foreach($i_sql_result as $row=>$key){
						$smIintRefCondArr[$key[csf('booking_no')]]['internal_ref'] = $key[csf('internal_ref')];
						$smIintRefCondArr[$key[csf('booking_no')]]['buyer_name'] = $key[csf('buyer_name')];
						$smn_booking_number=$key[csf('booking_no')];
					}
					// echo $i_ref_sql;
					// print_r($int_ref);
					// die;
                    $i = 1;
                    if ($db_type == 0) {
                        $sql_result = sql_select("SELECT a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, d.is_sales, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro,b.floor_id,c.booking_id,b.booking_no as book_no
                            from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
                            where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
                            group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, d.is_sales, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no,b.floor_id,c.booking_id,b.booking_no");
                    } else {
                        $sql_result = sql_select("SELECT a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, d.is_sales, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro,b.floor_id,c.booking_id,b.booking_no as book_no
                        from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
                        group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, d.is_sales, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no,b.floor_id,c.booking_id,b.booking_no");
                    }
                    $all_req_no = '';
                    $all_prod_id = '';
                    $order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
                    $tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
					// echo "<pre>";
					// print_r($sql_result);die;
                    foreach ($sql_result as $row)
					{
                        if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
                        if ($row[csf('requisition_no')] != '')
						{
                            if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
                            if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
                        }
                        $order_qnty_val = $row[csf('cons_quantity')];
                        $order_qnty_val_sum += $order_qnty_val;

                        $order_amount_val = $row[csf('order_amount')];
                        $order_amount_val_sum += $order_amount_val;

                        $no_of_bags_val = $row[csf('no_of_bags')];
                        $no_of_bags_val_sum += $no_of_bags_val;

                        $po_id = explode(",", $row[csf('po_id')]);
                        $po_no = '';
                        $style_ref = '';
                        $job_no = '';
                        $buyer = '';
                        //$data=explode('*',$data);
                        $productdtls = $row[csf('product_name_details')];
                        $productArr = explode(' ', $productdtls);

                        $proddtls='';
                        $proddtls=$yarn_count_details[$row[csf('yarn_count_id')]];
                        if($row[csf('yarn_count_id')]>0) $proddtls.=", ";
                        $proddtls.=$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."%";


                    $internal_ref = '';
                    $file_no = '';
                    if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
                    {
                        foreach ($po_id as $val)
                        {
							if($row[csf('is_sales')]==1)
							{
								if ($po_no== '') $po_no = $sales_order_array[$val]['sales_booking_no'];
								// if ($style_ref == '') $style_ref = $sales_style_des_arr[$sales_order_array[$val]['sales_booking_no']]['style_des'];

								$po_job = $sales_order_array[$val]['po_job_no'];

								if ($internal_ref == '') $internal_ref = $job_intfarray[$po_job]['grouping']; else $internal_ref .= "," . $job_intfarray[$po_job]['grouping'];
							}
                            else
							{
								if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
							}
							if ($job_no == '') $job_no = $po_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
							if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];
							if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                        }
                        $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                        $job_file = array_unique(explode(",", rtrim($file_no, ", ")));
                        $ref_cond = '';
                        foreach ($job_ref as $ref) {
                            //$ref_cond.=", ".$ref;
                            if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                        }
                        $file_con = '';
                        foreach ($job_file as $file) {
                            if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                        }

                        $buyer_job = '';
                        $buyer = '';
                        if ($row[csf('issue_basis')] == 1)
                        {
                            if ($dataArray[0][csf('issue_purpose')] == 8)
                            {
                                $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                            }
							else if ($dataArray[0][csf('issue_purpose')] == 2)
							{
								$book_no_data = explode('-',$row[csf('book_no')]);
								if($book_no_data[1] =='SMN')
								{
									if ($internal_ref == '') $internal_ref = $smn_info_arr[$row[csf('booking_id')]]['int_ref']; else $internal_ref .= "," . $smn_info_arr[$row[csf('booking_id')]]['int_ref'];
								}
								$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
								$ref_cond = '';
								foreach ($job_ref as $ref) {
									//$ref_cond.=", ".$ref;
									if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
								}
								if ($row[csf('buyer_job_no')] != "")
                                {
									if($row[csf('job_no')])
									{
                                       $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('job_no')];
                                       $buyer = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
									}
									else
									{
                                        $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
                                        $buyer = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
									}
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                                    $buyer = $buyer_arr[$row[csf('buyer_id')]];
                                }
							}
                            else
                            {
                                if ($row[csf('buyer_job_no')] != "")
                                {
                                    $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                                }
                            }
                        }
                        else if ($row[csf('issue_basis')] == 2)
                        {
                            $buyer_job = '';
                        }

                        $customer_buyer = $buyer_arr[$job_no_array[$row[csf('buyer_job_no')]]['customer_buyer']];
                    }
                    else if ($row[csf('issue_basis')] == 3)
                    {
                        if ($is_sales_array[$row[csf('requisition_no')]] == 1)
                        {
                            $buyer_job = '';
                            foreach (array_unique($po_id) as $val) {
                                if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
                                if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
                                $customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];

                                if ($buyer_job == '')
                                {
                                    if ($job_no_array[$val]['within_group'] == 1)
                                    {
                                        $buyer_data = $buyer_arr[$job_no_array[$val]['po_buyer']];
                                        $job_data = $stl_array[$job_no_array[$val]['style_ref']]['job'];
                                        $buyer_job = $buyer_data.' & '.$job_data;
                                    }
                                    else
                                    {
                                        $buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
                                    }
                                }
                            }
                        }
                        else
                        {
                            foreach ($po_id as $val)
                            {
                                if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
                                if ($job_no == '') $job_no = $po_array[$val]['job_no'];
                                if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
                                if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                                if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
                                if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                            }

                            $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                            $job_file = array_unique(explode(",", rtrim($file_no, ", ")));

                            $ref_cond = '';
                            foreach ($job_ref as $ref) {
                                //$ref_cond.=", ".$ref;
                                if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                            }

                            $file_con = '';
                            foreach ($job_file as $file) {
                                if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                            }
                            if ($job_no != '')
                            {
                                $buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
                            }
                            else
                            {
                                if(!empty($po_array[$val]['buyer_name']))
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                            }
                        }
                    }
                    else
                    {
						if(!empty($row[csf('po_id')]))
						{
							foreach (array_unique($po_id) as $val)
							{
								if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
								$customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];
								if ($buyer_job == '')
								{
									if ($job_no_array[$val]['within_group'] == 1)
									{

										$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
									}
									else
									{
										$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
									}
								}

								if ($is_sales_array[$row[csf('requisition_no')]] == 1)
								{

									$po_job = $sales_order_array[$val]['po_job_no'];
									$is_short = $sales_order_array[$val]['is_short'];

									 if ($internal_ref == '') $internal_ref = $job_intfarray[$po_job]['grouping']; else $internal_ref .= "," . $job_intfarray[$po_job]['grouping'];

								}
							}

							$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));

							$ref_cond = '';
							foreach ($job_ref as $ref)
							{
								if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
							}
						}else
						{
							$customer_buyer= $buyer_arr[$smIintRefCondArr[$program_array[$row[csf('requisition_no')]]['booking_no']]['buyer_name']];

							$ref_cond = $smIintRefCondArr[$program_array[$row[csf('requisition_no')]]['booking_no']]['internal_ref'];

						}


                    }

                    $no_bag_cone = "";
                    $wt_bag_cone = "";
                    if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

                    if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" style="font-size:13px">
                        <td width="20" style="font-size: 15px;"><? echo $i; ?></td>
                        <td width="145" style="font-size: 15px;">
                            <div style="word-wrap:break-word; width:145px">
								<?
								if ($row[csf('requisition_no')] != 0)
								{
									echo $row[csf('requisition_no')];
									$demand_system_no = "& ".$demand_no_arr[$row[csf('requisition_no')]]['demand_system_no'];
								}
								else
								{
								echo '&nbsp;';
								}
								echo $demand_system_no;
								?>
							</div>
                        </td>
                        <td width="100" style="font-size: 15px;">
                            <div style="word-wrap:break-word; width:100px">
								<?
								if($program_array[$row[csf('requisition_no')]]['booking_no'] !="")
								{
									echo $program_array[$row[csf('requisition_no')]]['booking_no']."  <br>&". $program_array[$row[csf('requisition_no')]]['program_no'];
								}
								else
								{
									echo $row[csf('book_no')];
								}

								?>
							</div>
                        </td>
                        <td width="50" style="font-size: 15px;">
                            <div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
                        </td>
                        <td width="65" style="font-size: 15px;">
                            <div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
                        </td>
                        <td width="110" style="font-size: 15px;">
                            <div style="word-wrap:break-word; width:110px">
                                <?
                                //echo $proddtls;
                                echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
                                ?>
                            </div>
                        </td>
                        <td width="65" style="font-size: 15px;">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('color')]]; ?></div>
                        </td>
                        <td width="65" style="font-size: 15px;">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
                        &nbsp;</div>
                    </td>
                    <td width="60" style="font-size: 15px;">
                        <div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
                    </td>
                    <td align="right" style="font-size: 15px;"
                    width="60"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
                    <td align="right" style="font-size: 15px;"
                    width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
                    <td width="80" style="font-size: 15px;">
                        <div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
                    &nbsp;</div>
                </td>
                <td width="80" style="font-size: 15px;">
                    <div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
                </td>
				<td width="80" style="font-size: 15px;">
                    <div style="word-wrap:break-word; width:80px"><? echo $floor_room_rack_arr[$row[csf('floor_id')]]; ?></div>
                </td>
                <!-- <td width="100" style="font-size: 15px;">
                    <div style="word-wrap:break-word; width:100px"><? //echo $buyer_job; ?></div>
                </td> -->
				<? if($cust_buyer==1){?>
                <td width="100" style="font-size: 15px;">
                    <div style="word-wrap:break-word; width:100px">
						<?  echo $customer_buyer?$customer_buyer:$buyer ?>
					</div>
                </td>
				<? }?>
                <!-- <td width="120" style="font-size: 15px;">
                    <div style="word-wrap:break-word; width:120px"><? //echo $po_no;
                   // if ($style_ref != "") echo ' & ' . $style_ref; else echo '&nbsp;'; ?></div>
                </td> -->

				<!-- <td>
                    <div style="word-wrap:break-word; width:80px"><? //echo $int_ref ?></div>
                </td> -->
				<?

				// echo "<pre>";
				// print_r($booking_type);die;


				?>
				<td style="font-size: 15px;">
					<div style="word-wrap:break-word; width:80px"><?
					echo ltrim($ref_cond, ", ");


					if ($is_short != "")
					{
						echo '<br> & ' . $booking_type[$is_short];
					}
					if($is_short != 1 && $is_short != 2 && ($booking_number!='' or $smn_booking_number!=''))
					{
						echo '<br> & sample';
					}
					?></div>
				</td>


            </tr>

            <?
            $uom_unit = "Kg";
            $uom_gm = "Grams";
            $tot_return_qty += $row[csf('returnable_qnty')];
            $tot_bag += $no_of_bags_val;
            $tot_cone += $row[csf('cone_per_bag')];
            $tot_w_bag += $row[csf('weight_per_bag')];
            $tot_w_cone += $row[csf('weight_per_cone')];
            $req_no = $row[csf('requisition_no')];
            $i++;
        }
        ?>
        <tr bgcolor="#CCCCCC" style="font-size:15px">
            <td align="right" colspan="9" style="font-size: 15px;"><b>Total</b></td>
            <td align="right" style="font-size: 15px;">
                <b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
            </td>
            <td align="right" style="font-size: 15px;"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
            <td style="font-size: 15px;"><? echo 'N:' . number_format($tot_bag, 2);
            if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
            echo '<br>W:' . number_format($tot_w_bag, 2);
            if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>

            <td style="font-size: 15px;" align="right" colspan="<? echo ($cust_buyer==1) ? 4 : 3;?>">&nbsp;</td>

        </tr>
        <tr>
            <td style="font-size: 15px;" colspan="<? echo ($cust_buyer==1) ? 16 : 15;?>" align="left"><b>In
                Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
            </tr>
        </table>
    </div>
    <br>
    <!--================================================================-->
    <?
    if ($data[6] == 1)
    {
        if ($dataArray[0][csf('issue_basis')] == 3)
        {
            ?>
            <div style="">
                <table width="850" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
                    <thead>
                        <tr>
                            <th colspan="7" align="center">Requisition Details</th>
                        </tr>
                        <tr>
                            <th width="40">SL</th>
                            <th width="100">Requisition No</th>
                            <th width="110">Lot No</th>
                            <th width="220">Yarn Description</th>
                            <th width="110">Brand</th>
                            <th width="90">Requisition Qty</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <?
                //echo $all_req_no;
                    $i = 1;
                    $tot_reqsn_qnty = 0;
                    $brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
                    $product_details_array = array();
                    $sql = "select id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where item_category_id=1 and company_id='$data[0]' and status_active=1 and is_deleted=0";
                    $result = sql_select($sql);

                    foreach ($result as $row) {
                        $compos = '';
                        if ($row[csf('yarn_comp_percent2nd')] != 0) {
                            $compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
                        } else {
                            $compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
                        }
                        $product_details_array[$row[csf('id')]]['count'] = $count_arr[$row[csf('yarn_count_id')]];
                        $product_details_array[$row[csf('id')]]['comp'] = $compos;
                        $product_details_array[$row[csf('id')]]['type'] = $yarn_type[$row[csf('yarn_type')]];
                        $product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
                        $product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
                    }
                    unset($result);
                    $sql = "select knit_id, requisition_no, prod_id, sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where requisition_no in ($all_req_no) and status_active=1 and is_deleted=0 group by requisition_no, prod_id, knit_id";
                    $nameArray = sql_select($sql);
                    foreach ($nameArray as $selectResult) {
                        ?>
                        <tr>
                            <td width="40" align="center"><? echo $i; ?></td>
                            <td width="100" align="center">&nbsp;<? echo $selectResult[csf('requisition_no')]; ?></td>
                            <td width="110" align="center">
                                &nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['lot']; ?></td>
                                <td width="220">
                                    &nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['count'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['comp'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['type']; ?></td>
                                    <td width="110" align="center">
                                        &nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['brand']; ?></td>
                                        <td width="90" align="right"><? echo number_format($selectResult[csf('yarn_qnty')], 2); ?>
                                    &nbsp;</td>
                        <td>&nbsp;<? //echo $selectResult[csf('requisition_no')];
                        ?></td>
                    </tr>
                    <?
                    $tot_reqsn_qnty += $selectResult[csf('yarn_qnty')];
                    $i++;
                }
                ?>
                <tfoot>
                    <th colspan="5" align="right"><b>Total</b></th>
                    <th align="right"><? echo number_format($tot_reqsn_qnty, 2); ?>&nbsp;</th>
                    <th>&nbsp;</th>
                </tfoot>
            </table>
            <?
            if ($data[5] != 1) {
                $z = 1;
                $k = 1;
                $colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

                $booking_al = "";
                foreach ($colorArray as $book) {
                    if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];
                }
                //unset($colorArray);
                //echo $booking_no;
                $booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
                $booking_count = count(array_unique(explode(',', $booking_no)));
                //$booking_job_arr=array();
                if ($dataArray[0][csf('issue_purpose')] == 2)
                {
                    $booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
                } else {
                    $booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
                }
                //
                $booking_job_no = $booking_job[0][csf('job_no')];
                unset($booking_job);

                if ($db_type == 0) $poNoCond = "group_concat(id)";
                else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
                /*echo '='.$sql_Job.'=';
            if($sql_Job!="")
            {*/
                $sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

                $job_po = $sql_returnJob[0][csf('po_break_down_id')];
                unset($sql_returnJob);
                ?>

                <table width="710" cellpadding="0" cellspacing="0" border="1" rules="all" style="margin-top:20px;"
                class="rpt_table">
                <thead>
                    <th width="40">SL</th>
                    <th width="250">Fabrication</th>
                    <th width="120">Color</th>
                    <th width="120">GGSM OR S/L</th>
                    <th>FGSM</th>
                </thead>
                <tbody>
                    <tr>
                        <td width="40" align="center"><? echo $z; ?></td>
                        <td width="250"
                        align="center"><? echo $body_part[$colorArray[0][csf('body_part_id')]] . ', ' . $colorArray[0][csf('fabric_desc')]; ?></td>
                        <td width="120"
                        align="center"><? echo $color_range[$colorArray[0][csf('color_range')]]; ?></td>
                        <td width="120" align="center"><? echo $colorArray[0][csf('stitch_length')]; ?></td>
                        <td align="center"><? echo $colorArray[0][csf('gsm_weight')]; ?></td>
                    </tr>
                </tbody>
            </table>
            <table style="margin-top:20px;" width="650" border="1" rules="all" cellpadding="0" cellspacing="0"
            class="rpt_table">
            <thead>
                <th width="40">SL</th>
                <th width="50">Prog. No</th>
                <th width="110">Finish Dia</th>
                <th width="170">Machine Dia & Gauge</th>
                <th width="110">Program Qty</th>
                <th>Remarks</th>
            </thead>
            <tbody>
                <?
                $k=1;
                foreach ($colorArray as $program_row) {
                    ?>
                    <tr>
                        <td width="40" align="center"><? echo $k; ?></td>
                        <td width="50" align="center"><? echo $program_row[csf('knit_id')]; ?></td>
                        <td width="110" align="center"><? echo $program_row[csf('dia')]; ?></td>
                        <td width="170" align="center"><? echo $program_row[csf('machine_dia')] . "X" . $program_row[csf('machine_gg')]; ?></td>
                        <td width="110" align="right"><? echo number_format($program_row[csf('program_qnty')], 2); ?></td>
                        <td><? echo $program_row[csf('remarks')]; ?></td>
                    </tr>
                    <?
                    $k++;
                    $tot_prog_qty += $program_row[csf('program_qnty')];
                }
                ?>
                <tr>
                    <td colspan="4" align="right"><strong>Total : </strong></td>
                    <td align="right"><? echo number_format($tot_prog_qty, 2); ?></td>
                    <td>&nbsp;</td>
                </tr>
            </tbody>
        </table>
        <?
        $returnJob = '';
        $returnPo = '';
        if ($db_type == 0) {
            $booking_cond = "group_concat(a.booking_no)";
            $wo_cond = "group_concat(a.ydw_no)";
            $reqs_no = "group_concat(b.requisition_no)";
        } else if ($db_type == 2) {
            $booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
            $wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
            $reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
        }

        if ($dataArray[0][csf('issue_purpose')] == 8) {
            $sql_returnJob = sql_select("select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
        } else if ($dataArray[0][csf('issue_purpose')] == 2) {
            $sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

            if ($db_type == 0) $poNoCond = "group_concat(id)";
            else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
            $sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
        } else {

                    $sql_returnJob = sql_select("select a.job_no, a.booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' and a.booking_no in($booking_no) group by a.job_no,a.booking_no"); //and a.booking_no='".$dataArray[0][csf('booking_no')]."'

                }
                $returnJob = $sql_returnJob[0][csf('job_no')];
                //$returnPo=$sql_po[0][csf('po_break_down_id')];
                $returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
                $returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
                $returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
                unset($sql_returnJob);

                /*$req_no_retInJob=sql_select("select $reqs_no as req_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");
                $reqNo_inJob=$req_no_retInJob[0][csf('req_no')];*/
                ?>
                <table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
                class="rpt_table">
                <thead>
                    <tr>
                        <th colspan="6" align="center">Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking Job
                        Deatils]</p></th>
                    </tr>
                    <tr>
                        <th>Buyer</th>
                        <th>Job</th>
                        <th>Req. Qty</th>
                        <th>Cuml. Issue Qty</th>
                        <th>Balance Qty</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <?

                $all_requ_no = "";
                if ($dataArray[0][csf('issue_purpose')] != 8) {
                    $all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");

                    //$all_requ_no="'".$all_booking_sql[0][csf('requisition_no')]."'";
                    $all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
                }
                if ($dataArray[0][csf('issue_purpose')] == 8) {
                    $total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");    //
                    $total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
                } else if ($dataArray[0][csf('issue_purpose')] == 2) {
                    if ($all_requ_no != "" || $all_requ_no != 0) {
                        $req_cond = "or a.requisition_no in ($all_requ_no)";
                        $reqRet_cond = "or b.booking_no in ($all_requ_no)";
                    } else {
                        $req_cond = "or a.requisition_no in (0)";
                        $reqRet_cond = "or b.booking_no in (0)";
                    }

                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
                } else {
                    if ($all_requ_no != "" || $all_requ_no != 0) {
                        $req_cond = "or a.requisition_no in ($all_requ_no)";
                        $reqRet_cond = "or b.booking_no in ($all_requ_no)";
                    } else {
                        $req_cond = "or a.requisition_no in (0)";
                        $reqRet_cond = "or b.booking_no in (0)";
                    }
                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");


                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
                }
                $cumulative_qty = 0;
                if ($booking_count == 1) {
                    ?>
                    <tbody>
                        <tr>
                            <td align="center">
                                <? echo $buyer_arr[$job_array[$booking_job_no]['buyer']]; ?>
                            </td>
                            <td align="center">
                                <? echo $job_array[$booking_job_no]['job']; ?>
                            </td>
                            <td align="center">
                                <? echo number_format($returnReqQty, 3); ?>
                            </td>
                            <td align="center">
                                <? $cumulative_qty = $total_issue_qty - $total_return_qty;
                                echo number_format($cumulative_qty, 3); ?>
                            </td>
                            <td align="center">
                                <? $balance_qty = $returnReqQty - $cumulative_qty;
                                echo number_format($balance_qty, 3); ?>
                            </td>
                            <td align="center">
                                <? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <?
            }
        }
    }
        else if ($dataArray[0][csf('issue_basis')] == 1)
        {
            ?>
            <table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
            class="rpt_table">
            <thead>
                <tr>
                    <th colspan="6" align="center">Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
                        if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
                    } ?> </th>
                </tr>
                <tr>
                    <th>Buyer</th>
                    <th>Job</th>
                    <th>Req. Qty</th>
                    <th>Cuml. Qty</th>
                    <th>Balance Qty</th>
                    <th>Remarks</th>
                </tr>
            </thead>
            <?
            //$booking_job_arr=array();
            $returnJob = '';
            $returnPo = '';
            if ($db_type == 0)
            {
                $booking_cond = "group_concat( distinct a.booking_no)";
                $wo_cond = "group_concat(a.ydw_no)";
                $reqs_no = "group_concat(b.requisition_no)";
            }
            else if ($db_type == 2)
            {
                $booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
                $wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
                $reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
            }

            if ($dataArray[0][csf('issue_purpose')] == 8)
            {
                $sql_returnJob = sql_select("select a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
            }
            else if ($dataArray[0][csf('issue_purpose')] == 2)
            {
                if ($dataArray[0][csf('buyer_job_no')] != '') {
                    $sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

                    if ($db_type == 0) $poNoCond = "group_concat(id)";
                    else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
                    $sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
                } else {
                    $sql_returnJob = sql_select("select a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
                }
            }
            else
            {
                //echo "select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
                $sql_returnJob = sql_select("select b.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

                /*$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");*///and a.booking_no='".$dataArray[0][csf('booking_no')]."'
            }
            $returnJob = $sql_returnJob[0][csf('job_no')];
            $returnPo = $sql_po[0][csf('po_break_down_id')];
            $returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
            $returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

            $returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
            unset($sql_returnJob);

            //$booking_all="'".implode("','",explode(",",$bill_item_id))."'";
            //echo $returnJob.'---------'.$returnPo.'dfgdfgd';

            /*if( $dataArray[0][csf('issue_purpose')]==8 )
            {
                $sql = "select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='".$dataArray[0][csf('booking_no')]."' group by a.id";
            }
            else if( $dataArray[0][csf('issue_purpose')]==2)
            {
                if($dataArray[0][csf('buyer_job_no')]!="")
                {
                    $sql = "select sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='".$dataArray[0][csf('buyer_job_no')]."'"; // and a.ydw_no='".$dataArray[0][csf('booking_no')]."'
                }
            }
            else
            {
                if($dataArray[0][csf('buyer_job_no')]!="")
                {
                    $sql = "select a.job_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($returnBooking) and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
                }
            }
            $result = sql_select($sql);*/
            $all_requ_no = "";
            if ($dataArray[0][csf('issue_purpose')] != 8)
            {
                //echo "select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no";
                $all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

                $all_requ_no = $all_booking_sql[0][csf('requisition_no')];
                unset($all_booking_sql);
            }

            if ($dataArray[0][csf('issue_purpose')] == 8)
            {
                    $total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");    //
                    $total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
            }
            else if ($dataArray[0][csf('issue_purpose')] == 2)
            {
                /*if($all_requ_no!="" || $all_requ_no!=0)
                {
                    //$req_cond="or a.requisition_no in ($all_requ_no)";
                    //$reqRet_cond="or b.booking_no in ($all_requ_no)";
                }
                else
                {
                    //$req_cond="or a.requisition_no in (0)";
                    $reqRet_cond="or b.booking_no in (0)";
                }*/
                if ($dataArray[0][csf('buyer_job_no')] != "")
                {
                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
                        //echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
                }
                else
                {
                    //echo "select sum(a.cons_quantity) as total_issue_qty from inv_transaction a, inv_issue_master b where b.id=a.mst_id and b.booking_no='".$dataArray[0][csf('booking_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.buyer_job_no<>'' and b.issue_purpose=2";
                    $total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
                    //echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
                    $total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
                }
            }
            else
            {
                if ($dataArray[0][csf('buyer_job_no')] != "")
                {
                    if ($all_requ_no != "" || $all_requ_no != 0)
                    {
                        $req_cond = "or a.requisition_no in ($all_requ_no)";
                        $reqRet_cond = "or b.booking_no in ($all_requ_no)";
                    }
                    else
                    {
                        $req_cond = "";//or a.requisition_no in (0)
                        $reqRet_cond = "";//or b.booking_no in (0)
                    }

                    $total_issue_qty = 0;
                    //echo "select sum(c.quantity) as total_issue_qty from inv_transaction a, inv_issue_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2";
                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");
                    //echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2";
                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");

                    //$total_issue_qty=return_field_value("sum(quantity) as total_issue_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=2 and entry_form=3","total_issue_qty");
                    //$total_return_qty=return_field_value("sum(quantity) as total_return_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=4 and entry_form=8","total_return_qty");
                    }
                }
                ?>
                <tbody>
                    <tr>
                        <td align="center">
                            <?
                            if ($dataArray[0][csf('issue_purpose')] == 8)
                            {
                                echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
                            }
                            else
                            {
                                if($job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']!="")
                                {
                                    echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
                                }
                                else
                                {
                                    echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
                                }
                            }
                            ?>
                        </td>
                        <td align="center">
                            <? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
                        </td>
                        <td align="center">
                            <? echo number_format($returnReqQty, 3); ?>
                        </td>
                        <td align="center">
                            <? $cumulative_qty = 0;
                            $cumulative_qty = $total_issue_qty - $total_return_qty;
                            echo number_format($cumulative_qty, 3); ?>
                        </td>
                        <td align="center">
                            <? $balance_qty = $returnReqQty - $cumulative_qty;
                            echo number_format($balance_qty, 3); ?>
                        </td>
                        <td align="center">
                            <? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
                        </td>
                    </tr>
                </tbody>
            </table>
            <?
        }
    }

        echo "<br><br>";

        echo "<p style='font-size: 15px;'>Note: Received The Above in Goods Condition For Handling and Delivery.</p>";

        // echo "<br><br><br><br><br><br><br><br>";
		echo signature_table(49, $data[0], "1030px",'',0,$user_id);

        ?>
    </div>
 </div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');
		</script>
		<p style="page-break-after: always;"> </p>

		<?
	}
	exit();
}

if ($action == "yarn_issue_store_printccl_old")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$print_with_vat = $data[7];
	$company  = $data[0];
	$cust_buyer  = $data[6];
	$location = $data[8];
	$store_id = $data[9];
	$basis    = $data[10];
	$buyer_id = $data[11];
	$no_copy    = $data[12];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	//echo $store_location_id.'system';
	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	//$supplier_arr = return_library_array("select id, short_name from lib_supplier", 'id', 'short_name');
	$supplier_arr = return_library_array("select id,supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');
    //$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$floor_room_rack_arr = return_library_array("select floor_room_rack_id, floor_room_rack_name from lib_floor_room_rack_mst", 'floor_room_rack_id', 'floor_room_rack_name');
	$booking_type= array(1=>'Short',2=>'Main');
	// $customer_buyer_name_arr =  return_library_array("select buyer_name from lib_buyer","id","buyer_name");
	// print_r($customer_buyer_name_arr);
	$customer_buyer_name = return_field_value("buyer_name", "lib_buyer", "id=$buyer_id and is_deleted=0");

	if($basis == 1 || $basis == 3)
	{
		$group_sql = "select a.id, b.group_name from lib_company a, lib_group b where a.group_id=b.id and a.id='$company'";
		//echo $group_sql;
		$groupSqlResult = sql_select($group_sql);
		$group_arr= array();
		foreach($groupSqlResult as $row)
		{
			$group_arr[$row[csf('id')]]['group_name'] = $row[csf('group_name')];
		}
	}

	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
    //echo $sql;die;
	$dataArray = sql_select($sql);
	$demand_no_arr = array();

	if( $dataArray[0][csf('issue_basis')]==3 || $dataArray[0][csf('issue_basis')]==8 )
	{
		$planbooking = sql_select("select b.requisition_no, e.booking_no as pln_booking_no, d.id from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$data[5]'");

		//for demand no
		if( $dataArray[0][csf('issue_basis')]==8 )
		{
			$req_no_arr = array();
			foreach($planbooking as $row)
			{
				$req_no_arr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];
			}


			$req_sql_zs = sql_select("SELECT a.demand_system_no, b.requisition_no FROM ppl_yarn_demand_entry_mst a, ppl_yarn_demand_entry_dtls b WHERE     a.id = b.mst_id AND b.requisition_no in(".implode(',', $req_no_arr).") and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.demand_system_no, b.requisition_no");
			foreach($req_sql_zs as $row)
			{
				$demand_no_arr[$row[csf('requisition_no')]]['demand_system_no'] = $row[csf('demand_system_no')];
			}
		}
		//var_dump($demand_no_arr);

		if( $dataArray[0][csf('issue_basis')]==3 )
		{
			$bookingNo = $planbooking[0][csf('pln_booking_no')];
		}
		else
		{
			$bookingNo = $dataArray[0][csf('booking_no')];

		}

		if(!empty($bookingNo))
		{
			$sql_stl_owner= "SELECT a.id, b.style_owner from wo_booking_mst a, wo_po_details_master b
			where a.booking_no='$bookingNo' and a.job_no=b.job_no and a.status_active=1 and a.is_deleted=0 and b.Status_active=1 and b.is_deleted=0
			group by a.id, b.style_owner order by a.id DESC";

			//echo $sql_stl_owner;
			$sqlStlOwnerResult = sql_select($sql_stl_owner);
			$style_owner_arr = array();
			foreach($sqlStlOwnerResult as $row)
			{
				$style_owner_arr[$row[csf('style_owner')]] = $company_library[$row[csf('style_owner')]];
			}
		}
	}
	else if( $dataArray[0][csf('issue_basis')]==1 || $dataArray[0][csf('issue_purpose')]==2 )
	{
		$booking_id = $dataArray[0][csf('booking_id')];
		$sql_smn = "SELECT a.mst_id, a.job_no_id, a.booking_no, b.internal_ref from wo_yarn_dyeing_dtls a, sample_development_mst b where a.job_no_id=b.id and a.mst_id=$booking_id and a.status_active=1 and a.is_deleted=0 group by a.mst_id,a.job_no_id, a.booking_no, b.internal_ref";
		//echo $sql;
		$smn_info_arr = array();
		$sql_smn_res = sql_select($sql_smn);
		foreach ($sql_smn_res as $row)
		{
			$smn_info_arr[$row[csf('mst_id')]]['int_ref']=$row[csf('internal_ref')];
			$smn_booking_number = $row[csf('booking_no')];
		}
		unset($sql_smn_res);
		//echo "<pre>";print_r($smn_info_arr);
	}
	else if( $dataArray[0][csf('issue_basis')]==1 )
	{
		$wo_no = $dataArray[0][csf('booking_no')];

		//echo "tttt".$wo_no ; die;
		$sql_stl_owner= "SELECT a.id, b.style_owner from wo_booking_mst a, wo_po_details_master b , wo_yarn_dyeing_mst c,wo_yarn_dyeing_dtls d where a.job_no=b.job_no and (a.booking_no=d.fab_booking_no or a.booking_no=d.booking_no) and b.job_no=d.job_no and c.id=d.mst_id and c.ydw_no='$wo_no' and a.status_active=1 and a.is_deleted=0 and b.Status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 group by a.id, b.style_owner order by a.id DESC";

		//echo $sql_stl_owner;
		$sqlStlOwnerResult = sql_select($sql_stl_owner);
		$style_owner_arr = array();
		foreach($sqlStlOwnerResult as $row)
		{
			$style_owner_arr[$row[csf('style_owner')]] = $company_library[$row[csf('style_owner')]];
		}
	}



	//$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$copyNo = "";
	for ($x = 1; $x <= $no_copy; $x++)
	{
		if($x==1)
		{
			$copyNo ="<span style='font-size:x-large;'>1<sup>st</sup> Copy</span>";
		}
		else if($x==2)
		{
			$copyNo ="<span style='font-size:x-large;'>2<sup>nd</sup> Copy</span>";
		}
		else if($x==3)
		{
			$copyNo ="<span style='font-size:x-large;'>3<sup>rd</sup> Copy</span>";
		}
		else if($x==4)
		{
			$copyNo ="<span style='font-size:x-large;'>4<sup>th</sup> Copy</span>";
		}
		else if($x==5)
		{
			$copyNo ="<span style='font-size:x-large;'>5<sup>th</sup> Copy</span>";
		}
		else if($x==6)
		{
			$copyNo ="<span style='font-size:x-large;'>6<sup>th</sup> Copy</span>";
		}
		else if($x==7)
		{
			$copyNo ="<span style='font-size:x-large;'>7<sup>th</sup> Copy</span>";
		}
		else if($x==8)
		{
			$copyNo ="<span style='font-size:x-large;'>8<sup>th</sup> Copy</span>";
		}
		else if($x==9)
		{
			$copyNo ="<span style='font-size:x-large;'>9<sup>th</sup> Copy</span>";
		}
		else  if($x==10)
		{
			$copyNo ="<span style='font-size:x-large;'10<sup>th</sup> Copy</span>";
		}

		$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
		?>
		<div style="width:1150px;">
			<table width="1100" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td colspan="6" align="center" style="font-size:18px"></td>
					<td style="font-size:x-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">
					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="4" align="center">
							<strong style="font-size:18px"><? echo $com_dtls[0]; ?></strong><br>
						<?
						echo $com_dtls[1];
						?>
					</td>
					<td colspan="2" id="barcode_img_id">&nbsp;</td>
					<td colspan="3" style="color:black; font-weight:bold;"><? echo $copyNo;?></td>
				</tr>
				<tr>
					<td colspan="6" align="center" style="font-size:16px"><strong><u>Yarn Delivery Challan/Gate
					Pass</u></strong></center></td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td style="font-size: 15px;" width="160"><strong>Issue No</strong></td>
					<td style="font-size: 15px;" width="175px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('issue_number')]; ?></td>
					<td style="font-size: 15px;" width="120"><strong>Issue Purpose</strong></td>
					<td style="font-size: 15px;" width="175px"><strong>:</strong>&nbsp;
						<?
						echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];
						?>
					</td>
					<td style="font-size: 15px;" width="125"><strong>Knitting Source</strong></td>
					<td style="font-size: 15px;" width="175px"><strong>:</strong>&nbsp;<? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
				</tr>
				<tr>
					<td style="font-size: 15px;"><strong>Challan</strong></td>
					<td style="font-size: 15px;" width="175px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('challan_no')]; ?></td>
					<td style="font-size: 15px;"><strong>Issue Date</strong></td>
					<td style="font-size: 15px;" width="175px"><strong>:</strong>&nbsp;
						<? echo change_date_format($dataArray[0][csf('issue_date')]);?>
					</td>
		<td style="font-size: 15px;"><strong>Issue To</strong></td>
		<?
		if ($dataArray[0][csf('knit_dye_source')] == 3)
		{
			$supp_add = $dataArray[0][csf('knit_dye_company')];
			$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
			foreach ($nameArray as $result) {
				$address = "";
							if ($result != "") $address = $result[csf('address_1')];
						}
						unset($nameArray);
					}

					$loan_party_add = $dataArray[0][csf('loan_party')];
					$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
					foreach ($loanPartyArray as $result) {
						$addressParty = "";
						if ($result != "") $addressParty = $result['address'];
					}
					unset($loanPartyArray);
					?>
		<td style="font-size: 15px;" width="175px"><strong>:</strong>&nbsp;
			<?
			if ($dataArray[0][csf('issue_purpose')] == 3) {
				echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
			} else if ($dataArray[0][csf('issue_purpose')] == 5) {
				echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
			} else {
				if ($dataArray[0][csf('knit_dye_source')] == 1)
					echo $company_library[$dataArray[0][csf('knit_dye_company')]];
				else
					echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
			}
			?>
		</td>
	</tr>

	<tr>
		<td style="font-size: 15px;"><strong>Location</strong></td>
		<td style="font-size: 15px;"><strong>:</strong>&nbsp;<? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>
		<td style="font-size: 15px;"><strong>Gate Pass No.</strong></td>
		<td style="font-size: 15px;" width="175px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('gate_pass_no')]; ?></td>
		<td style="font-size: 15px;"><strong>Do No</strong></td>
		<td width="175px"><strong>:</strong>&nbsp;</td>
	</tr>
	<tr>
		<td style="font-size: 15px;" valign="top"><strong>Remarks</strong></td>
		<td style="font-size: 15px;" colspan="5"><strong>:</strong>&nbsp;<p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
	</tr>
	<tr>
		<td style="font-size: 15px;"><strong>Driver Name</strong></td>
		<td><strong>:</strong>&nbsp;</td>
		<td style="font-size: 15px;"><strong>Driver Mobile No</strong></td>
		<td width="175px"><strong>:</strong>&nbsp;</td>
		<td style="font-size: 15px;"><strong>Vehicle No</strong></td>
		<td width="175px"><strong>:</strong>&nbsp;</td>
	</tr>

     </table>
            <br>
            <div style="width:100%;">
                <div style="clear:both;">
                    <table style="margin-right:-40px;" cellspacing="0" width="1380" border="1" rules="all"
                    class="rpt_table">
                    <thead bgcolor="#dddddd" style="font-size:13px">
                        <th width="20">SL</th>
                        <th width="145">Req. No  & <br>Demand No.</th>
                        <th width="100">S.Booking No.<br> & Prog No. </th>
                        <th width="50">Lot No</th>
                        <th width="65">Y. Type</th>
                        <th width="110">Item Details</th>
                        <th width="65">Grey Color</th>
                        <th width="65">Dye. Color</th>
                        <th width="60">Supp.</th>
                        <th width="60"><b>Issue Qty(kg)</b></th>
                        <th width="60">Rtnbl Qty(kg)</th>
                        <th width="80">Bag & Cone</th>
                        <th width="80">Store</th>
                        <th width="80">Floor</th>
                        <!-- <th width="100">Buyer & Job</th> -->
						<? if($cust_buyer==1){?>
                        <th width="100">Cust. Buyer</th>
						<? } ?>
                        <!-- <th width="120">Order & Style</th> -->
                        <th>IR /IB &  B.Type</th>
                    </thead>
                    <?
                    $wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");

                    $cond = "";
                    if ($data[5] != "") $cond .= " and c.id='$data[5]'";

                    $po_array = array();
                    $job_array = array();

                    $costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0]");
                    foreach ($costing_sql as $row)
                    {
                        $po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
                        $po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
                        $po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
                        $po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
                        $job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
                        $job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];

						$job_intfarray[$row[csf('job_no')]]['grouping'] .= $row[csf('grouping')].',';
                    }

                    unset($costing_sql);

					$sales_order_array = array();
					$sales_order_sql = sql_select("select a.id,a.sales_booking_no, a.job_no,a.style_ref_no, a.buyer_id,b.job_no po_job_no,b.buyer_id po_buyer,a.within_group, b.is_short from fabric_sales_order_mst a left join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.status_active = 1 and a.is_deleted = 0 and a.company_id=$data[0]");
					foreach ($sales_order_sql as $row)
					{
						$sales_order_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
						$sales_order_array[$row[csf('id')]]['sales_order_no'] = $row[csf('job_no')];
						$sales_order_array[$row[csf('id')]]['po_job_no'] = $row[csf('po_job_no')];
						$sales_order_array[$row[csf('id')]]['sales_booking_no'] = $row[csf('sales_booking_no')];
						$sales_order_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
						$sales_order_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
						$sales_order_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
						$sales_order_array[$row[csf('id')]]['is_short'] = $row[csf('is_short')];
					}

                    $stl_array = array();

                    $stl_sql = sql_select("select job_no, style_ref_no from wo_po_details_master");
                    foreach ($stl_sql as $row)
                    {
                        $stl_array[$row[csf('style_ref_no')]]['job'] = $row[csf('job_no')];
                    }
                    //var_dump($stl_array);
                    unset($stl_sql);

                    $job_no_array = array();
                    $jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id, po_buyer, customer_buyer from fabric_sales_order_mst");
                    foreach ($jobData as $row)
                    {
                        $job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
                        $job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
                        $job_no_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
                        $job_no_array[$row[csf('id')]]['customer_buyer'] = $row[csf('customer_buyer')];
                    }
                    //var_dump($po_array);
                    $po_id_req_array = array();
                    $is_sales_array = array();
                    if ($db_type == 0)
					{
                        $poID = " SELECT c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, group_concat(distinct(a.po_id)) as poid,a.booking_no from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id and c.requisition_no in(".implode(',', $req_no_arr).") group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales,a.booking_no";
                    }
					else
					{
                        $poID = "SELECT c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid,a.booking_no from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id and c.requisition_no in(".implode(',', $req_no_arr).") group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales,a.booking_no";
                    }
					//echo $poID;
                    $poID_sql_result = sql_select($poID);
                    foreach ($poID_sql_result as $row)
					{
                        $po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
                        $is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];

						$program_array[$row[csf('requisition_no')]]['program_no'] = $row[csf('knit_id')];
						$program_array[$row[csf('requisition_no')]]['booking_no'] = $row[csf('booking_no')];
						//$program_array[$row[csf('requisition_no')]]['buyer_id'] = $row[csf('buyer_id')];
                    }
                    unset($poID_sql_result);
					$booking_number = $program_array[$row[csf('requisition_no')]]['booking_no'];
					$i_ref_sql = "select b.internal_ref from SAMPLE_DEVELOPMENT_MST b, WO_NON_ORD_SAMP_BOOKING_DTLS a where b.id = a.style_id and a.booking_no = '$booking_number'";
					$i_sql_result = sql_select($i_ref_sql);
					// echo($i_ref_sql);
					$int_ref = '';
					foreach($i_sql_result as $row=>$key){
						$int_ref = $key[csf('internal_ref')];
					}
					// echo $i_ref_sql;
					// print_r($int_ref);
					// die;
                    $i = 1;
                    if ($db_type == 0) {
                        $sql_result = sql_select("SELECT a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro,b.floor_id,c.booking_id,b.booking_no as book_no
                            from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
                            where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
                            group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no,b.floor_id,c.booking_id,b.booking_no");
                    } else {
                        $sql_result = sql_select("SELECT a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro,b.floor_id,c.booking_id,b.booking_no as book_no
                        from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
                        group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no,b.floor_id,c.booking_id,b.booking_no");
                    }
                    $all_req_no = '';
                    $all_prod_id = '';
                    $order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
                    $tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
                    foreach ($sql_result as $row)
					{
                        if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
                        if ($row[csf('requisition_no')] != '')
						{
                            if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
                            if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
                        }
                        $order_qnty_val = $row[csf('cons_quantity')];
                        $order_qnty_val_sum += $order_qnty_val;

                        $order_amount_val = $row[csf('order_amount')];
                        $order_amount_val_sum += $order_amount_val;

                        $no_of_bags_val = $row[csf('no_of_bags')];
                        $no_of_bags_val_sum += $no_of_bags_val;

                        $po_id = explode(",", $row[csf('po_id')]);
                        $po_no = '';
                        $style_ref = '';
                        $job_no = '';
                        $buyer = '';
                        //$data=explode('*',$data);
                        $productdtls = $row[csf('product_name_details')];
                        $productArr = explode(' ', $productdtls);

                        $proddtls='';
                        $proddtls=$yarn_count_details[$row[csf('yarn_count_id')]];
                        if($row[csf('yarn_count_id')]>0) $proddtls.=", ";
                        $proddtls.=$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."%";


                    $internal_ref = '';
                    $file_no = '';
                    if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
                    {
                        foreach ($po_id as $val)
                        {
                            if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
                            if ($job_no == '') $job_no = $po_array[$val]['job_no'];
                            if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
                            if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                            if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
                            if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                        }
                        $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                        $job_file = array_unique(explode(",", rtrim($file_no, ", ")));
                        $ref_cond = '';
                        foreach ($job_ref as $ref) {
                            //$ref_cond.=", ".$ref;
                            if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                        }
                        $file_con = '';
                        foreach ($job_file as $file) {
                            if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                        }

                        $buyer_job = '';
                        $buyer = '';
                        if ($row[csf('issue_basis')] == 1)
                        {
                            if ($dataArray[0][csf('issue_purpose')] == 8)
                            {
                                $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                            }
							else if ($dataArray[0][csf('issue_purpose')] == 2)
							{
								$book_no_data = explode('-',$row[csf('book_no')]);
								if($book_no_data[1] =='SMN')
								{
									if ($internal_ref == '') $internal_ref = $smn_info_arr[$row[csf('booking_id')]]['int_ref']; else $internal_ref .= "," . $smn_info_arr[$row[csf('booking_id')]]['int_ref'];
								}
								$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
								$ref_cond = '';
								foreach ($job_ref as $ref) {
									//$ref_cond.=", ".$ref;
									if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
								}
								if ($row[csf('buyer_job_no')] != "")
                                {
									if($row[csf('job_no')])
									{
                                       $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('job_no')];
                                       $buyer = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
									}
									else
									{
                                        $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
                                        $buyer = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
									}
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                                    $buyer = $buyer_arr[$row[csf('buyer_id')]];
                                }
							}
                            else
                            {
                                if ($row[csf('buyer_job_no')] != "")
                                {
                                    $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                                }
                            }
                        }
                        else if ($row[csf('issue_basis')] == 2)
                        {
                            $buyer_job = '';
                        }

                        $customer_buyer = $buyer_arr[$job_no_array[$row[csf('buyer_job_no')]]['customer_buyer']];
                    }
                    else if ($row[csf('issue_basis')] == 3)
                    {
                        if ($is_sales_array[$row[csf('requisition_no')]] == 1)
                        {
                            $buyer_job = '';
                            foreach (array_unique($po_id) as $val) {
                                if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
                                if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
                                $customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];

                                if ($buyer_job == '')
                                {
                                    if ($job_no_array[$val]['within_group'] == 1)
                                    {
                                        $buyer_data = $buyer_arr[$job_no_array[$val]['po_buyer']];
                                        $job_data = $stl_array[$job_no_array[$val]['style_ref']]['job'];
                                        $buyer_job = $buyer_data.' & '.$job_data;
                                    }
                                    else
                                    {
                                        $buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
                                    }
                                }
                            }
                        }
                        else
                        {
                            foreach ($po_id as $val)
                            {
                                if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
                                if ($job_no == '') $job_no = $po_array[$val]['job_no'];
                                if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
                                if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                                if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
                                if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                            }

                            $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                            $job_file = array_unique(explode(",", rtrim($file_no, ", ")));

                            $ref_cond = '';
                            foreach ($job_ref as $ref) {
                                //$ref_cond.=", ".$ref;
                                if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                            }

                            $file_con = '';
                            foreach ($job_file as $file) {
                                if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                            }
                            if ($job_no != '')
                            {
                                $buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
                            }
                            else
                            {
                                if(!empty($po_array[$val]['buyer_name']))
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                            }
                        }
                    }
                    else
                    {
                        foreach (array_unique($po_id) as $val)
                        {
                            if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
                            if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
                            $customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];
                            if ($buyer_job == '')
                            {
                                if ($job_no_array[$val]['within_group'] == 1)
                                {

                                    $buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
                                }
                            }

							if ($is_sales_array[$row[csf('requisition_no')]] == 1)
                        	{

								$po_job = $sales_order_array[$val]['po_job_no'];
								$is_short = $sales_order_array[$val]['is_short'];

								 if ($internal_ref == '') $internal_ref = $job_intfarray[$po_job]['grouping']; else $internal_ref .= "," . $job_intfarray[$po_job]['grouping'];

							}
                        }

						$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));

						$ref_cond = '';
						foreach ($job_ref as $ref)
						{
							if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
						}
                    }

                    $no_bag_cone = "";
                    $wt_bag_cone = "";
                    if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

                    if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" style="font-size:13px">
                        <td width="20" style="font-size: 15px;"><? echo $i; ?></td>
                        <td width="145" style="font-size: 15px;">
                            <div style="word-wrap:break-word; width:145px">
								<?
								if ($row[csf('requisition_no')] != 0)
								{
									echo $row[csf('requisition_no')];
									$demand_system_no = "& ".$demand_no_arr[$row[csf('requisition_no')]]['demand_system_no'];
								}
								else
								{
								echo '&nbsp;';
								}
								echo $demand_system_no;
								?>
							</div>
                        </td>
                        <td width="100" style="font-size: 15px;">
                            <div style="word-wrap:break-word; width:100px">
								<?
								if($program_array[$row[csf('requisition_no')]]['booking_no'] !="")
								{
									echo $program_array[$row[csf('requisition_no')]]['booking_no']."  <br>&". $program_array[$row[csf('requisition_no')]]['program_no'];
								}
								else
								{
									echo $row[csf('book_no')];
								}

								?>
							</div>
                        </td>
                        <td width="50" style="font-size: 15px;">
                            <div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
                        </td>
                        <td width="65" style="font-size: 15px;">
                            <div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
                        </td>
                        <td width="110" style="font-size: 15px;">
                            <div style="word-wrap:break-word; width:110px">
                                <?
                                //echo $proddtls;
                                echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
                                ?>
                            </div>
                        </td>
                        <td width="65" style="font-size: 15px;">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('color')]]; ?></div>
                        </td>
                        <td width="65" style="font-size: 15px;">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
                        &nbsp;</div>
                    </td>
                    <td width="60" style="font-size: 15px;">
                        <div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
                    </td>
                    <td align="right" style="font-size: 15px;"
                    width="60"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
                    <td align="right" style="font-size: 15px;"
                    width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
                    <td width="80" style="font-size: 15px;">
                        <div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
                    &nbsp;</div>
                </td>
                <td width="80" style="font-size: 15px;">
                    <div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
                </td>
				<td width="80" style="font-size: 15px;">
                    <div style="word-wrap:break-word; width:80px"><? echo $floor_room_rack_arr[$row[csf('floor_id')]]; ?></div>
                </td>
                <!-- <td width="100" style="font-size: 15px;">
                    <div style="word-wrap:break-word; width:100px"><? //echo $buyer_job; ?></div>
                </td> -->
				<? if($cust_buyer==1){?>
                <td width="100" style="font-size: 15px;">
                    <div style="word-wrap:break-word; width:100px"><? echo $customer_buyer?$customer_buyer:$buyer ?></div>
                </td>
				<? }?>
                <!-- <td width="120" style="font-size: 15px;">
                    <div style="word-wrap:break-word; width:120px"><? //echo $po_no;
                   // if ($style_ref != "") echo ' & ' . $style_ref; else echo '&nbsp;'; ?></div>
                </td> -->

				<!-- <td>
                    <div style="word-wrap:break-word; width:80px"><? //echo $int_ref ?></div>
                </td> -->
				<?

				// echo "<pre>";
				// print_r($booking_type);die;


				?>
				<td style="font-size: 15px;">
					<div style="word-wrap:break-word; width:80px"><?
					echo ltrim($ref_cond, ", ");
					echo ltrim($int_ref, ", ");
					if ($is_short != "")
					{
						echo '<br> & ' . $booking_type[$is_short];
					}
					if($is_short != 1 && $is_short != 2 && ($booking_number!='' or $smn_booking_number!=''))
					{
						echo '<br> & sample';
					}
					?></div>
				</td>


            </tr>

            <?
            $uom_unit = "Kg";
            $uom_gm = "Grams";
            $tot_return_qty += $row[csf('returnable_qnty')];
            $tot_bag += $no_of_bags_val;
            $tot_cone += $row[csf('cone_per_bag')];
            $tot_w_bag += $row[csf('weight_per_bag')];
            $tot_w_cone += $row[csf('weight_per_cone')];
            $req_no = $row[csf('requisition_no')];
            $i++;
        }
        ?>
        <tr bgcolor="#CCCCCC" style="font-size:15px">
            <td align="right" colspan="9" style="font-size: 15px;"><b>Total</b></td>
            <td align="right" style="font-size: 15px;">
                <b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
            </td>
            <td align="right" style="font-size: 15px;"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
            <td style="font-size: 15px;"><? echo 'N:' . number_format($tot_bag, 2);
            if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
            echo '<br>W:' . number_format($tot_w_bag, 2);
            if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>

            <td style="font-size: 15px;" align="right" colspan="<? echo ($cust_buyer==1) ? 4 : 3;?>">&nbsp;</td>

        </tr>
        <tr>
            <td style="font-size: 15px;" colspan="<? echo ($cust_buyer==1) ? 16 : 15;?>" align="left"><b>In
                Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
            </tr>
        </table>
    </div>
    <br>
    <!--================================================================-->
    <?
    if ($data[6] == 1)
    {
        if ($dataArray[0][csf('issue_basis')] == 3)
        {
            ?>
            <div style="">
                <table width="850" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
                    <thead>
                        <tr>
                            <th colspan="7" align="center">Requisition Details</th>
                        </tr>
                        <tr>
                            <th width="40">SL</th>
                            <th width="100">Requisition No</th>
                            <th width="110">Lot No</th>
                            <th width="220">Yarn Description</th>
                            <th width="110">Brand</th>
                            <th width="90">Requisition Qty</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <?
                //echo $all_req_no;
                    $i = 1;
                    $tot_reqsn_qnty = 0;
                    $brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
                    $product_details_array = array();
                    $sql = "select id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where item_category_id=1 and company_id='$data[0]' and status_active=1 and is_deleted=0";
                    $result = sql_select($sql);

                    foreach ($result as $row) {
                        $compos = '';
                        if ($row[csf('yarn_comp_percent2nd')] != 0) {
                            $compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
                        } else {
                            $compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
                        }
                        $product_details_array[$row[csf('id')]]['count'] = $count_arr[$row[csf('yarn_count_id')]];
                        $product_details_array[$row[csf('id')]]['comp'] = $compos;
                        $product_details_array[$row[csf('id')]]['type'] = $yarn_type[$row[csf('yarn_type')]];
                        $product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
                        $product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
                    }
                    unset($result);
                    $sql = "select knit_id, requisition_no, prod_id, sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where requisition_no in ($all_req_no) and status_active=1 and is_deleted=0 group by requisition_no, prod_id, knit_id";
                    $nameArray = sql_select($sql);
                    foreach ($nameArray as $selectResult) {
                        ?>
                        <tr>
                            <td width="40" align="center"><? echo $i; ?></td>
                            <td width="100" align="center">&nbsp;<? echo $selectResult[csf('requisition_no')]; ?></td>
                            <td width="110" align="center">
                                &nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['lot']; ?></td>
                                <td width="220">
                                    &nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['count'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['comp'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['type']; ?></td>
                                    <td width="110" align="center">
                                        &nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['brand']; ?></td>
                                        <td width="90" align="right"><? echo number_format($selectResult[csf('yarn_qnty')], 2); ?>
                                    &nbsp;</td>
                        <td>&nbsp;<? //echo $selectResult[csf('requisition_no')];
                        ?></td>
                    </tr>
                    <?
                    $tot_reqsn_qnty += $selectResult[csf('yarn_qnty')];
                    $i++;
                }
                ?>
                <tfoot>
                    <th colspan="5" align="right"><b>Total</b></th>
                    <th align="right"><? echo number_format($tot_reqsn_qnty, 2); ?>&nbsp;</th>
                    <th>&nbsp;</th>
                </tfoot>
            </table>
            <?
            if ($data[5] != 1) {
                $z = 1;
                $k = 1;
                $colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

                $booking_al = "";
                foreach ($colorArray as $book) {
                    if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];
                }
                //unset($colorArray);
                //echo $booking_no;
                $booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
                $booking_count = count(array_unique(explode(',', $booking_no)));
                //$booking_job_arr=array();
                if ($dataArray[0][csf('issue_purpose')] == 2)
                {
                    $booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
                } else {
                    $booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
                }
                //
                $booking_job_no = $booking_job[0][csf('job_no')];
                unset($booking_job);

                if ($db_type == 0) $poNoCond = "group_concat(id)";
                else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
                /*echo '='.$sql_Job.'=';
            if($sql_Job!="")
            {*/
                $sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

                $job_po = $sql_returnJob[0][csf('po_break_down_id')];
                unset($sql_returnJob);
                ?>

                <table width="710" cellpadding="0" cellspacing="0" border="1" rules="all" style="margin-top:20px;"
                class="rpt_table">
                <thead>
                    <th width="40">SL</th>
                    <th width="250">Fabrication</th>
                    <th width="120">Color</th>
                    <th width="120">GGSM OR S/L</th>
                    <th>FGSM</th>
                </thead>
                <tbody>
                    <tr>
                        <td width="40" align="center"><? echo $z; ?></td>
                        <td width="250"
                        align="center"><? echo $body_part[$colorArray[0][csf('body_part_id')]] . ', ' . $colorArray[0][csf('fabric_desc')]; ?></td>
                        <td width="120"
                        align="center"><? echo $color_range[$colorArray[0][csf('color_range')]]; ?></td>
                        <td width="120" align="center"><? echo $colorArray[0][csf('stitch_length')]; ?></td>
                        <td align="center"><? echo $colorArray[0][csf('gsm_weight')]; ?></td>
                    </tr>
                </tbody>
            </table>
            <table style="margin-top:20px;" width="650" border="1" rules="all" cellpadding="0" cellspacing="0"
            class="rpt_table">
            <thead>
                <th width="40">SL</th>
                <th width="50">Prog. No</th>
                <th width="110">Finish Dia</th>
                <th width="170">Machine Dia & Gauge</th>
                <th width="110">Program Qty</th>
                <th>Remarks</th>
            </thead>
            <tbody>
                <?
                $k=1;
                foreach ($colorArray as $program_row) {
                    ?>
                    <tr>
                        <td width="40" align="center"><? echo $k; ?></td>
                        <td width="50" align="center"><? echo $program_row[csf('knit_id')]; ?></td>
                        <td width="110" align="center"><? echo $program_row[csf('dia')]; ?></td>
                        <td width="170" align="center"><? echo $program_row[csf('machine_dia')] . "X" . $program_row[csf('machine_gg')]; ?></td>
                        <td width="110" align="right"><? echo number_format($program_row[csf('program_qnty')], 2); ?></td>
                        <td><? echo $program_row[csf('remarks')]; ?></td>
                    </tr>
                    <?
                    $k++;
                    $tot_prog_qty += $program_row[csf('program_qnty')];
                }
                ?>
                <tr>
                    <td colspan="4" align="right"><strong>Total : </strong></td>
                    <td align="right"><? echo number_format($tot_prog_qty, 2); ?></td>
                    <td>&nbsp;</td>
                </tr>
            </tbody>
        </table>
        <?
        $returnJob = '';
        $returnPo = '';
        if ($db_type == 0) {
            $booking_cond = "group_concat(a.booking_no)";
            $wo_cond = "group_concat(a.ydw_no)";
            $reqs_no = "group_concat(b.requisition_no)";
        } else if ($db_type == 2) {
            $booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
            $wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
            $reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
        }

        if ($dataArray[0][csf('issue_purpose')] == 8) {
            $sql_returnJob = sql_select("select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
        } else if ($dataArray[0][csf('issue_purpose')] == 2) {
            $sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

            if ($db_type == 0) $poNoCond = "group_concat(id)";
            else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
            $sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
        } else {

                    $sql_returnJob = sql_select("select a.job_no, a.booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' and a.booking_no in($booking_no) group by a.job_no,a.booking_no"); //and a.booking_no='".$dataArray[0][csf('booking_no')]."'

                }
                $returnJob = $sql_returnJob[0][csf('job_no')];
                //$returnPo=$sql_po[0][csf('po_break_down_id')];
                $returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
                $returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
                $returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
                unset($sql_returnJob);

                /*$req_no_retInJob=sql_select("select $reqs_no as req_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");
                $reqNo_inJob=$req_no_retInJob[0][csf('req_no')];*/
                ?>
                <table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
                class="rpt_table">
                <thead>
                    <tr>
                        <th colspan="6" align="center">Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking Job
                        Deatils]</p></th>
                    </tr>
                    <tr>
                        <th>Buyer</th>
                        <th>Job</th>
                        <th>Req. Qty</th>
                        <th>Cuml. Issue Qty</th>
                        <th>Balance Qty</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <?

                $all_requ_no = "";
                if ($dataArray[0][csf('issue_purpose')] != 8) {
                    $all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");

                    //$all_requ_no="'".$all_booking_sql[0][csf('requisition_no')]."'";
                    $all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
                }
                if ($dataArray[0][csf('issue_purpose')] == 8) {
                    $total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");    //
                    $total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
                } else if ($dataArray[0][csf('issue_purpose')] == 2) {
                    if ($all_requ_no != "" || $all_requ_no != 0) {
                        $req_cond = "or a.requisition_no in ($all_requ_no)";
                        $reqRet_cond = "or b.booking_no in ($all_requ_no)";
                    } else {
                        $req_cond = "or a.requisition_no in (0)";
                        $reqRet_cond = "or b.booking_no in (0)";
                    }

                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
                } else {
                    if ($all_requ_no != "" || $all_requ_no != 0) {
                        $req_cond = "or a.requisition_no in ($all_requ_no)";
                        $reqRet_cond = "or b.booking_no in ($all_requ_no)";
                    } else {
                        $req_cond = "or a.requisition_no in (0)";
                        $reqRet_cond = "or b.booking_no in (0)";
                    }
                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");


                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
                }
                $cumulative_qty = 0;
                if ($booking_count == 1) {
                    ?>
                    <tbody>
                        <tr>
                            <td align="center">
                                <? echo $buyer_arr[$job_array[$booking_job_no]['buyer']]; ?>
                            </td>
                            <td align="center">
                                <? echo $job_array[$booking_job_no]['job']; ?>
                            </td>
                            <td align="center">
                                <? echo number_format($returnReqQty, 3); ?>
                            </td>
                            <td align="center">
                                <? $cumulative_qty = $total_issue_qty - $total_return_qty;
                                echo number_format($cumulative_qty, 3); ?>
                            </td>
                            <td align="center">
                                <? $balance_qty = $returnReqQty - $cumulative_qty;
                                echo number_format($balance_qty, 3); ?>
                            </td>
                            <td align="center">
                                <? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <?
            }
        }
    }
        else if ($dataArray[0][csf('issue_basis')] == 1)
        {
            ?>
            <table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
            class="rpt_table">
            <thead>
                <tr>
                    <th colspan="6" align="center">Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
                        if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
                    } ?> </th>
                </tr>
                <tr>
                    <th>Buyer</th>
                    <th>Job</th>
                    <th>Req. Qty</th>
                    <th>Cuml. Qty</th>
                    <th>Balance Qty</th>
                    <th>Remarks</th>
                </tr>
            </thead>
            <?
            //$booking_job_arr=array();
            $returnJob = '';
            $returnPo = '';
            if ($db_type == 0)
            {
                $booking_cond = "group_concat( distinct a.booking_no)";
                $wo_cond = "group_concat(a.ydw_no)";
                $reqs_no = "group_concat(b.requisition_no)";
            }
            else if ($db_type == 2)
            {
                $booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
                $wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
                $reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
            }

            if ($dataArray[0][csf('issue_purpose')] == 8)
            {
                $sql_returnJob = sql_select("select a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
            }
            else if ($dataArray[0][csf('issue_purpose')] == 2)
            {
                if ($dataArray[0][csf('buyer_job_no')] != '') {
                    $sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

                    if ($db_type == 0) $poNoCond = "group_concat(id)";
                    else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
                    $sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
                } else {
                    $sql_returnJob = sql_select("select a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
                }
            }
            else
            {
                //echo "select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
                $sql_returnJob = sql_select("select b.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

                /*$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");*///and a.booking_no='".$dataArray[0][csf('booking_no')]."'
            }
            $returnJob = $sql_returnJob[0][csf('job_no')];
            $returnPo = $sql_po[0][csf('po_break_down_id')];
            $returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
            $returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

            $returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
            unset($sql_returnJob);

            //$booking_all="'".implode("','",explode(",",$bill_item_id))."'";
            //echo $returnJob.'---------'.$returnPo.'dfgdfgd';

            /*if( $dataArray[0][csf('issue_purpose')]==8 )
            {
                $sql = "select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='".$dataArray[0][csf('booking_no')]."' group by a.id";
            }
            else if( $dataArray[0][csf('issue_purpose')]==2)
            {
                if($dataArray[0][csf('buyer_job_no')]!="")
                {
                    $sql = "select sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='".$dataArray[0][csf('buyer_job_no')]."'"; // and a.ydw_no='".$dataArray[0][csf('booking_no')]."'
                }
            }
            else
            {
                if($dataArray[0][csf('buyer_job_no')]!="")
                {
                    $sql = "select a.job_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($returnBooking) and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
                }
            }
            $result = sql_select($sql);*/
            $all_requ_no = "";
            if ($dataArray[0][csf('issue_purpose')] != 8)
            {
                //echo "select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no";
                $all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

                $all_requ_no = $all_booking_sql[0][csf('requisition_no')];
                unset($all_booking_sql);
            }

            if ($dataArray[0][csf('issue_purpose')] == 8)
            {
                    $total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");    //
                    $total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
            }
            else if ($dataArray[0][csf('issue_purpose')] == 2)
            {
                /*if($all_requ_no!="" || $all_requ_no!=0)
                {
                    //$req_cond="or a.requisition_no in ($all_requ_no)";
                    //$reqRet_cond="or b.booking_no in ($all_requ_no)";
                }
                else
                {
                    //$req_cond="or a.requisition_no in (0)";
                    $reqRet_cond="or b.booking_no in (0)";
                }*/
                if ($dataArray[0][csf('buyer_job_no')] != "")
                {
                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
                        //echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
                }
                else
                {
                    //echo "select sum(a.cons_quantity) as total_issue_qty from inv_transaction a, inv_issue_master b where b.id=a.mst_id and b.booking_no='".$dataArray[0][csf('booking_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.buyer_job_no<>'' and b.issue_purpose=2";
                    $total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
                    //echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
                    $total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
                }
            }
            else
            {
                if ($dataArray[0][csf('buyer_job_no')] != "")
                {
                    if ($all_requ_no != "" || $all_requ_no != 0)
                    {
                        $req_cond = "or a.requisition_no in ($all_requ_no)";
                        $reqRet_cond = "or b.booking_no in ($all_requ_no)";
                    }
                    else
                    {
                        $req_cond = "";//or a.requisition_no in (0)
                        $reqRet_cond = "";//or b.booking_no in (0)
                    }

                    $total_issue_qty = 0;
                    //echo "select sum(c.quantity) as total_issue_qty from inv_transaction a, inv_issue_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2";
                    $total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");
                    //echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2";
                    $total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");

                    //$total_issue_qty=return_field_value("sum(quantity) as total_issue_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=2 and entry_form=3","total_issue_qty");
                    //$total_return_qty=return_field_value("sum(quantity) as total_return_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=4 and entry_form=8","total_return_qty");
                    }
                }
                ?>
                <tbody>
                    <tr>
                        <td align="center">
                            <?
                            if ($dataArray[0][csf('issue_purpose')] == 8)
                            {
                                echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
                            }
                            else
                            {
                                if($job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']!="")
                                {
                                    echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
                                }
                                else
                                {
                                    echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
                                }
                            }
                            ?>
                        </td>
                        <td align="center">
                            <? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
                        </td>
                        <td align="center">
                            <? echo number_format($returnReqQty, 3); ?>
                        </td>
                        <td align="center">
                            <? $cumulative_qty = 0;
                            $cumulative_qty = $total_issue_qty - $total_return_qty;
                            echo number_format($cumulative_qty, 3); ?>
                        </td>
                        <td align="center">
                            <? $balance_qty = $returnReqQty - $cumulative_qty;
                            echo number_format($balance_qty, 3); ?>
                        </td>
                        <td align="center">
                            <? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
                        </td>
                    </tr>
                </tbody>
            </table>
            <?
        }
    }

        echo "<br><br>";

        echo "<p style='font-size: 15px;'>Note: Received The Above in Goods Condition For Handling and Delivery.</p>";

        // echo "<br><br><br><br><br><br><br><br>";
		echo signature_table(49, $data[0], "1030px",'',0,$user_id);

        ?>
    </div>
 </div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');
		</script>
		<p style="page-break-after: always;"> </p>

		<?
	}
	exit();
}

if ($action == "yarn_issue_store_print")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);
	//echo $data[6]; die;
	$print_with_vat = $data[7];
	$company=$data[0];
	$location=$data[8];
	$store_id=$data[9];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	// echo "<pre>";
	// print_r($data);die;
	//$supplier_arr = return_library_array("select id, short_name from lib_supplier", 'id', 'short_name');
	$supplier_arr = return_library_array("select id,supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
    //$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
    //echo $sql;die;

	$dataArray = sql_select($sql);

	if( $dataArray[0][csf('issue_basis')]==3 )
	{
		$planbooking = sql_select("select e.booking_no as pln_booking_no from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c,ppl_planning_info_entry_dtls d,ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$data[5]' ");
	}

	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	?>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<?
	$copyNo = "";
	for ($x = 1; $x <= 3; $x++)
	{
		if($x==1)
		{
			$copyNo ="<span style='font-size:x-large;'>1<sup>st</sup> Copy</span>";
		} else if($x==2){
			$copyNo ="<span style='font-size:x-large;'>2<sup>nd</sup> Copy</span>";
		} else {
			$copyNo ="<span style='font-size:x-large;'>3<sup>rd</sup> Copy</span>";
		}
		$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
		?>
		<div style="width:1100px;">
			<table width="1100" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td colspan="6" align="center" style="font-size:18px"></td>


					<td style="font-size:x-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">

					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="4" align="center"> <!-- address_id -->
						<strong style="font-size:18px"><? echo $com_dtls[0]; ?></strong><br>
						<span class="address_id">
							<? echo $com_dtls[1]; ?>
						</span>

					</td>
					<td colspan="2" id="barcode_img_id">&nbsp;</td>
					<td colspan="3" style="color:black; font-weight:bold;"><? echo $copyNo;?></td>
				</tr>
				<tr>
					<td colspan="6" align="center" style="font-size:16px"><strong><u>Yarn Delivery Challan/Gate
					Pass</u></strong></center></td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td width="160"><strong>Issue No:</strong></td>
					<td width="175px"><? echo $dataArray[0][csf('issue_number')]; ?></td>
					<td width="120"><strong>Booking:</strong></td>
					<td width="175px">
						<?
						if( $dataArray[0][csf('issue_basis')]==3 )
						{
							$bookingNo = $planbooking[0][csf('pln_booking_no')];
						} else {
							$bookingNo = $dataArray[0][csf('booking_no')];
						}
						echo $bookingNo;
						?>
					</td>
					<td width="125"><strong>Knitting Source:</strong></td>
					<td width="175px"><? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
				</tr>
				<tr>
					<td><strong>Challan/Program No:</strong></td>
					<td width="175px"><? echo $dataArray[0][csf('challan_no')]; ?></td>
					<td><strong>Issue Purpose:</strong></td>
		<td width="175px"><? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
		echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
		?></td>
		<td><strong>Issue Date:</strong></td>
		<td width="175px"><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
	</tr>
	<tr>
		<td><strong>Issue To:</strong></td>
		<?
		if ($dataArray[0][csf('knit_dye_source')] == 3) {
			$supp_add = $dataArray[0][csf('knit_dye_company')];
			$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
			foreach ($nameArray as $result) {
				$address = "";
							if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
						}
						unset($nameArray);
					}

					$loan_party_add = $dataArray[0][csf('loan_party')];
					$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
					foreach ($loanPartyArray as $result) {
						$addressParty = "";
						if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($loanPartyArray);
					?>
					<td colspan="3">
						<?
						if ($dataArray[0][csf('issue_purpose')] == 3) {
							echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
						} else if ($dataArray[0][csf('issue_purpose')] == 5) {
							echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
						} else {
							if ($dataArray[0][csf('knit_dye_source')] == 1)
								echo $company_library[$dataArray[0][csf('knit_dye_company')]];
							else
								echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
						}
						?>
					</td>
					<td colspan="2"><strong>Location : <? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></strong>
					</td>
				</tr>
				<tr>
					<td><strong>Demand No.:</strong></td>
					<td width="175px"><? //echo $dataArray[0][csf('booking_id')];
					?></td>
					<td><strong>Gate Pass No.:</strong></td>
					<td width="175px"><? echo $dataArray[0][csf('gate_pass_no')]; ?></td>
					<td><strong>Do No:</strong></td>
					<td width="175px"><? //echo $dataArray[0][csf('remarks')];
					?></td>
				</tr>
				<tr>
					<td valign="top"><strong>Remarks :</strong></td>
					<td colspan="5"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
				</tr>
				<?
				if ($print_with_vat == 1) {
					?>
					<tr>
						<td><strong>VAT Number :</strong></td>
						<td><p>
							<?
							$vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
							echo $vat_no;
							?></p></td>

						</tr>
						<?
					} else {
						?>
						<tr>
							<td valign="top">&nbsp;</strong></td>
							<td>&nbsp;</td>

						</tr>
						<?
					}
					?>
				</table>
				<br>
				<div style="width:100%;">
					<div style="clear:both;">
						<table style="margin-right:-40px;" cellspacing="0" width="1000" border="1" rules="all"
						class="rpt_table">
						<thead bgcolor="#dddddd" style="font-size:13px">
							<th width="20">SL</th>
							<th width="45">Req. No</th>
							<th width="50">Lot No</th>
							<th width="65">Y. Type</th>
							<th width="110">Item Details</th>
							<th width="65">Grey Color</th>
							<th width="65">Dye. Color</th>
							<th width="60">Supp.</th>
							<th width="60"><b>Issue Qty(kg)</b></th>
							<th width="60">Rtnbl Qty(kg)</th>
							<th width="80">Bag & Cone</th>
							<th width="80">Store</th>
							<th width="100">Buyer & Job</th>
							<th width="120">Order & Style</th>
							<th>Inte. Ref & File</th>
						</thead>
						<?
						$wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");

						$cond = "";
						if ($data[5] != "") $cond .= " and c.id='$data[5]'";

						$po_array = array();
						$job_array = array();
						$costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0]");
						foreach ($costing_sql as $row) {
							$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
							$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
							$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
							$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
							$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
							$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
							$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
							$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
						}
						unset($costing_sql);

						$job_no_array = array();
						$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst");
						foreach ($jobData as $row) {
							$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
							$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
							$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
							$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
						}
					//var_dump($po_array);
						$po_id_req_array = array();
						$is_sales_array = array();
						if ($db_type == 0) {
							$poID = " select c.requisition_no, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.requisition_no, a.is_sales ";
						} else {
							$poID = "select c.requisition_no, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.requisition_no, a.is_sales ";
						}
						$poID_sql_result = sql_select($poID);
						foreach ($poID_sql_result as $row) {
							$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
							$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
						}
						unset($poID_sql_result);

						$i = 1;
						if ($db_type == 0) {
							$sql_result = sql_select("select a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro
								from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
								where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
								group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no");
						} else {
							$sql_result = sql_select("select a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro
								from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
								group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no");
						}
						$all_req_no = '';
						$all_prod_id = '';
						$all_store=array();
						$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
						$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
						foreach ($sql_result as $row) {
							if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
							if ($row[csf('requisition_no')] != '') {
								if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
								if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
							}
							$order_qnty_val = $row[csf('cons_quantity')];
							$order_qnty_val_sum += $order_qnty_val;

							$order_amount_val = $row[csf('order_amount')];
							$order_amount_val_sum += $order_amount_val;

							$no_of_bags_val = $row[csf('no_of_bags')];
							$no_of_bags_val_sum += $no_of_bags_val;

							$po_id = explode(",", $row[csf('po_id')]);
							$po_no = '';
							$style_ref = '';
							$job_no = '';
							$buyer = '';
							//$data=explode('*',$data);
							$productdtls = $row[csf('product_name_details')];
							$productArr = explode(' ', $productdtls);

							$proddtls='';
							$proddtls=$yarn_count_details[$row[csf('yarn_count_id')]];
							if($row[csf('yarn_count_id')]>0) $proddtls.=", ";
							$proddtls.=$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."%";

						/*if($row[csf('yarn_comp_type1st')]>0) $proddtls.=", ";
						$proddtls.=$yarn_type[$row[csf('yarn_type')]];*/

						/*if ($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' && $productArr[4]!=''&& $productArr[5]!='')
						{
							$proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].'%, '.$productArr[3].' '.$productArr[4]."%, ".$productArr[5].", ".$productArr[6];
						}
						else if ($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' && $productArr[4]!='')
						{
							$proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, '.$productArr[3].', '.$productArr[4];
						}
						else if($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' )
						{
							$proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, '.$productArr[3];
						}
						else if($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='')
						{
							$proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, ';
						}
						else if($productArr[0]!='' && $productArr[1]!='' )
						{
							$proddtls=$productArr[0].', '.$productArr[1];
						}
						else if($productArr[0]!='')
						{
							$proddtls=$productArr[0];
						}
						else
						{
							$proddtls='';
						}*/

						$internal_ref = '';
						$file_no = '';
						if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2) {
							foreach ($po_id as $val) {
								if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
								if ($job_no == '') $job_no = $po_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
								if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];

							}
							$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
							$job_file = array_unique(explode(",", rtrim($file_no, ", ")));
							$ref_cond = '';
							foreach ($job_ref as $ref) {
								//$ref_cond.=", ".$ref;
								if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
							}
							$file_con = '';
							foreach ($job_file as $file) {
								if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
							}



							$buyer_job = '';
							if ($row[csf('issue_basis')] == 1) {
								if ($dataArray[0][csf('issue_purpose')] == 8) {
									$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
								} else {
									$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
									if ($row[csf('buyer_job_no')] != "") {
										$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
									}
								}
							} else if ($row[csf('issue_basis')] == 2) {
								$buyer_job = '';
							}
						} else if ($row[csf('issue_basis')] == 3) {
							//$ex_data = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
							//print_r($ex_data);

							if ($is_sales_array[$row[csf('requisition_no')]] == 1) {
								$buyer_job = '';
								foreach (array_unique($po_id) as $val) {
									if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
									if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];

									if ($buyer_job == '') {
										if ($job_no_array[$val]['within_group'] == 1) {
											$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
										} else {
											$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
										}
									}
								}
							} else {
								foreach ($po_id as $val) {
									if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
									if ($job_no == '') $job_no = $po_array[$val]['job_no'];
									if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
									if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

									if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
									if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
								}

								$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
								$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

								$ref_cond = '';
								foreach ($job_ref as $ref) {
									//$ref_cond.=", ".$ref;
									if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
								}

								$file_con = '';
								foreach ($job_file as $file) {
									if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
								}
								if ($job_no != '') {
									$buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
								} else {
									$buyer_job = $buyer_arr[$buyer_name];
								}
							}
						} else {
							foreach (array_unique($po_id) as $val) {
								if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
								if ($buyer_job == '') {
									if ($job_no_array[$val]['within_group'] == 1) {

										$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
									} else {
										$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
									}
								}
							}
						}

						$no_bag_cone = "";
						$wt_bag_cone = "";
						if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

						if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="font-size:13px">
							<td width="20"><? echo $i; ?></td>
							<td width="45">
								<div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
							</td>
							<td width="50">
								<div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
							</td>
							<td width="65">
								<div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
							</td>
							<td width="110">
								<div style="word-wrap:break-word; width:110px">
									<?
									//echo $proddtls;
									echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
									?>
								</div>
							</td>
							<td width="65">
								<div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('color')]]; ?></div>
							</td>
							<td width="65">
								<div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
							&nbsp;</div>
						</td>
						<td width="60">
							<div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
						</td>
						<td align="right"
						width="60"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
						<td align="right"
						width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
						<td width="80">
							<div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
						&nbsp;</div>
					</td>
					<td width="80">
						<div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]];
						$all_store[]=$row[csf('store_id')]; ?></div>
					</td>
					<td width="100">
						<div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
					</td>
					<td width="120">
						<div style="word-wrap:break-word; width:120px"><? echo $po_no;
						if ($style_ref != "") echo ' & ' . $style_ref; else echo '&nbsp;'; ?></div>
					</td>
					<td>
						<div style="word-wrap:break-word; width:80px"><? echo ltrim($ref_cond, ", ");
						if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?></div>
					</td>
				</tr>
				<?
				$uom_unit = "Kg";
				$uom_gm = "Grams";
				$tot_return_qty += $row[csf('returnable_qnty')];
				$tot_bag += $no_of_bags_val;
				$tot_cone += $row[csf('cone_per_bag')];
				$tot_w_bag += $row[csf('weight_per_bag')];
				$tot_w_cone += $row[csf('weight_per_cone')];
				$req_no = $row[csf('requisition_no')];
				$i++;
			}
			?>
			<tr bgcolor="#CCCCCC" style="font-size:13px">
				<td align="right" colspan="8"><b>Total</b></td>
				<td align="right">
					<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
				</td>
				<td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
				<td><? echo 'N:' . number_format($tot_bag, 2);
				if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
				echo '<br>W:' . number_format($tot_w_bag, 2);
				if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
				<td align="right" colspan="4">&nbsp;</td>
			</tr>
			<tr>
				<td colspan="14" align="left"><b>In
					Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
				</tr>
			</table>
			<?  $all_stores = implode(",",array_unique($all_store));
			if($all_stores !=''){
				$store_address = return_field_value("a.address", "lib_location a, lib_store_location b", "a.id=b.location_id and a.status_active=1 and b.id in ($all_stores) ", "address");
			}
			?>
			<script type="text/javascript">
				var store_address="<? echo $store_address; ?>";
				if(store_address){
					$('.address_id').html("").html(store_address);
				}
			</script>
		</div>
		<br>
		<!--================================================================-->
		<?
		if ($data[6] == 1)
		{
			if ($dataArray[0][csf('issue_basis')] == 3)
			{
				?>
				<div style="">
					<table width="850" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
						<thead>
							<tr>
								<th colspan="7" align="center">Requisition Details</th>
							</tr>
							<tr>
								<th width="40">SL</th>
								<th width="100">Requisition No</th>
								<th width="110">Lot No</th>
								<th width="220">Yarn Description</th>
								<th width="110">Brand</th>
								<th width="90">Requisition Qty</th>
								<th>Remarks</th>
							</tr>
						</thead>
						<?
						//echo $all_req_no;
						$i = 1;
						$tot_reqsn_qnty = 0;
						$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
						$product_details_array = array();
						$sql = "select id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where item_category_id=1 and company_id='$data[0]' and status_active=1 and is_deleted=0";
						$result = sql_select($sql);

						foreach ($result as $row) {
							$compos = '';
							if ($row[csf('yarn_comp_percent2nd')] != 0) {
								$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
							} else {
								$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
							}
							$product_details_array[$row[csf('id')]]['count'] = $count_arr[$row[csf('yarn_count_id')]];
							$product_details_array[$row[csf('id')]]['comp'] = $compos;
							$product_details_array[$row[csf('id')]]['type'] = $yarn_type[$row[csf('yarn_type')]];
							$product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
							$product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
						}
						unset($result);
						$sql = "select knit_id, requisition_no, prod_id, sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where requisition_no in ($all_req_no) and status_active=1 and is_deleted=0 group by requisition_no, prod_id, knit_id";
						$nameArray = sql_select($sql);
						foreach ($nameArray as $selectResult) {
							?>
							<tr>
								<td width="40" align="center"><? echo $i; ?></td>
								<td width="100" align="center">&nbsp;<? echo $selectResult[csf('requisition_no')]; ?></td>
								<td width="110" align="center">
									&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['lot']; ?></td>
									<td width="220">
										&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['count'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['comp'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['type']; ?></td>
										<td width="110" align="center">
											&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['brand']; ?></td>
											<td width="90" align="right"><? echo number_format($selectResult[csf('yarn_qnty')], 2); ?>
										&nbsp;</td>
							<td>&nbsp;<? //echo $selectResult[csf('requisition_no')];
							?></td>
						</tr>
						<?
						$tot_reqsn_qnty += $selectResult[csf('yarn_qnty')];
						$i++;
					}
					?>
					<tfoot>
						<th colspan="5" align="right"><b>Total</b></th>
						<th align="right"><? echo number_format($tot_reqsn_qnty, 2); ?>&nbsp;</th>
						<th>&nbsp;</th>
					</tfoot>
				</table>
				<?
				if ($data[5] != 1) {
					$z = 1;
					$k = 1;
					$colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

					$booking_al = "";
					foreach ($colorArray as $book) {
						if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];
					}
					//unset($colorArray);
					//echo $booking_no;
					$booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
					$booking_count = count(array_unique(explode(',', $booking_no)));
					//$booking_job_arr=array();
					if ($dataArray[0][csf('issue_purpose')] == 2)
					{
						$booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
					} else {
						$booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
					}
					//
					$booking_job_no = $booking_job[0][csf('job_no')];
					unset($booking_job);

					if ($db_type == 0) $poNoCond = "group_concat(id)";
					else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
					/*echo '='.$sql_Job.'=';
				if($sql_Job!="")
				{*/
					$sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

					$job_po = $sql_returnJob[0][csf('po_break_down_id')];
					unset($sql_returnJob);
					?>

					<table width="710" cellpadding="0" cellspacing="0" border="1" rules="all" style="margin-top:20px;"
					class="rpt_table">
					<thead>
						<th width="40">SL</th>
						<th width="250">Fabrication</th>
						<th width="120">Color</th>
						<th width="120">GGSM OR S/L</th>
						<th>FGSM</th>
					</thead>
					<tbody>
						<tr>
							<td width="40" align="center"><? echo $z; ?></td>
							<td width="250"
							align="center"><? echo $body_part[$colorArray[0][csf('body_part_id')]] . ', ' . $colorArray[0][csf('fabric_desc')]; ?></td>
							<td width="120"
							align="center"><? echo $color_range[$colorArray[0][csf('color_range')]]; ?></td>
							<td width="120" align="center"><? echo $colorArray[0][csf('stitch_length')]; ?></td>
							<td align="center"><? echo $colorArray[0][csf('gsm_weight')]; ?></td>
						</tr>
					</tbody>
				</table>
				<table style="margin-top:20px;" width="650" border="1" rules="all" cellpadding="0" cellspacing="0"
				class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="50">Prog. No</th>
					<th width="110">Finish Dia</th>
					<th width="170">Machine Dia & Gauge</th>
					<th width="110">Program Qty</th>
					<th>Remarks</th>
				</thead>
				<tbody>
					<?
					$k=1;
					foreach ($colorArray as $program_row) {
						?>
						<tr>
							<td width="40" align="center"><? echo $k; ?></td>
							<td width="50" align="center"><? echo $program_row[csf('knit_id')]; ?></td>
							<td width="110" align="center"><? echo $program_row[csf('dia')]; ?></td>
							<td width="170" align="center"><? echo $program_row[csf('machine_dia')] . "X" . $program_row[csf('machine_gg')]; ?></td>
							<td width="110" align="right"><? echo number_format($program_row[csf('program_qnty')], 2); ?></td>
							<td><? echo $program_row[csf('remarks')]; ?></td>
						</tr>
						<?
						$k++;
						$tot_prog_qty += $program_row[csf('program_qnty')];
					}
					?>
					<tr>
						<td colspan="4" align="right"><strong>Total : </strong></td>
						<td align="right"><? echo number_format($tot_prog_qty, 2); ?></td>
						<td>&nbsp;</td>
					</tr>
				</tbody>
			</table>
			<?
			$returnJob = '';
			$returnPo = '';
			if ($db_type == 0) {
				$booking_cond = "group_concat(a.booking_no)";
				$wo_cond = "group_concat(a.ydw_no)";
				$reqs_no = "group_concat(b.requisition_no)";
			} else if ($db_type == 2) {
				$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
				$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
				$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
			}

			if ($dataArray[0][csf('issue_purpose')] == 8) {
				$sql_returnJob = sql_select("select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
			} else if ($dataArray[0][csf('issue_purpose')] == 2) {
				$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

				if ($db_type == 0) $poNoCond = "group_concat(id)";
				else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
				$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
			} else {

						$sql_returnJob = sql_select("select a.job_no, a.booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' and a.booking_no in($booking_no) group by a.job_no,a.booking_no"); //and a.booking_no='".$dataArray[0][csf('booking_no')]."'

					}
					$returnJob = $sql_returnJob[0][csf('job_no')];
					//$returnPo=$sql_po[0][csf('po_break_down_id')];
					$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
					$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
					$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
					unset($sql_returnJob);

					/*$req_no_retInJob=sql_select("select $reqs_no as req_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");
					$reqNo_inJob=$req_no_retInJob[0][csf('req_no')];*/
					?>
					<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
					class="rpt_table">
					<thead>
						<tr>
							<th colspan="6" align="center">Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking Job
							Deatils]</p></th>
						</tr>
						<tr>
							<th>Buyer</th>
							<th>Job</th>
							<th>Req. Qty</th>
							<th>Cuml. Issue Qty</th>
							<th>Balance Qty</th>
							<th>Remarks</th>
						</tr>
					</thead>
					<?

					$all_requ_no = "";
					if ($dataArray[0][csf('issue_purpose')] != 8) {
						$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");

						//$all_requ_no="'".$all_booking_sql[0][csf('requisition_no')]."'";
						$all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
					}
					if ($dataArray[0][csf('issue_purpose')] == 8) {
						$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");    //
						$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
					} else if ($dataArray[0][csf('issue_purpose')] == 2) {
						if ($all_requ_no != "" || $all_requ_no != 0) {
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						} else {
							$req_cond = "or a.requisition_no in (0)";
							$reqRet_cond = "or b.booking_no in (0)";
						}

						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
					} else {
						if ($all_requ_no != "" || $all_requ_no != 0) {
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						} else {
							$req_cond = "or a.requisition_no in (0)";
							$reqRet_cond = "or b.booking_no in (0)";
						}
						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");


						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
					}
					$cumulative_qty = 0;
					if ($booking_count == 1) {
						?>
						<tbody>
							<tr>
								<td align="center">
									<? echo $buyer_arr[$job_array[$booking_job_no]['buyer']]; ?>
								</td>
								<td align="center">
									<? echo $job_array[$booking_job_no]['job']; ?>
								</td>
								<td align="center">
									<? echo number_format($returnReqQty, 3); ?>
								</td>
								<td align="center">
									<? $cumulative_qty = $total_issue_qty - $total_return_qty;
									echo number_format($cumulative_qty, 3); ?>
								</td>
								<td align="center">
									<? $balance_qty = $returnReqQty - $cumulative_qty;
									echo number_format($balance_qty, 3); ?>
								</td>
								<td align="center">
									<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
								</td>
							</tr>
						</tbody>
					</table>
					<?
				}
			}
		}
		else if ($dataArray[0][csf('issue_basis')] == 1)
		{
			?>
			<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
			class="rpt_table">
			<thead>
				<tr>
					<th colspan="6" align="center">Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
						if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
					} ?> </th>
				</tr>
				<tr>
					<th>Buyer</th>
					<th>Job</th>
					<th>Req. Qty</th>
					<th>Cuml. Qty</th>
					<th>Balance Qty</th>
					<th>Remarks</th>
				</tr>
			</thead>
			<?
						//$booking_job_arr=array();
			$returnJob = '';
			$returnPo = '';
			if ($db_type == 0) {
				$booking_cond = "group_concat( distinct a.booking_no)";
				$wo_cond = "group_concat(a.ydw_no)";
				$reqs_no = "group_concat(b.requisition_no)";
			} else if ($db_type == 2) {
				$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
				$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
				$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
			}

			if ($dataArray[0][csf('issue_purpose')] == 8) {
				$sql_returnJob = sql_select("select a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
			} else if ($dataArray[0][csf('issue_purpose')] == 2) {
				if ($dataArray[0][csf('buyer_job_no')] != '') {
					$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

					if ($db_type == 0) $poNoCond = "group_concat(id)";
					else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
					$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
				} else {
					$sql_returnJob = sql_select("select a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
				}
			} else {
							//echo "select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
							$sql_returnJob = sql_select("select b.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

							/*$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");*///and a.booking_no='".$dataArray[0][csf('booking_no')]."'
						}
						$returnJob = $sql_returnJob[0][csf('job_no')];
						$returnPo = $sql_po[0][csf('po_break_down_id')];
						$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
						$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

						$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
						unset($sql_returnJob);

						//$booking_all="'".implode("','",explode(",",$bill_item_id))."'";
						//echo $returnJob.'---------'.$returnPo.'dfgdfgd';

						/*if( $dataArray[0][csf('issue_purpose')]==8 )
					{
						$sql = "select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='".$dataArray[0][csf('booking_no')]."' group by a.id";
					}
					else if( $dataArray[0][csf('issue_purpose')]==2)
					{
						if($dataArray[0][csf('buyer_job_no')]!="")
						{
							$sql = "select sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='".$dataArray[0][csf('buyer_job_no')]."'"; // and a.ydw_no='".$dataArray[0][csf('booking_no')]."'
						}
					}
					else
					{
						if($dataArray[0][csf('buyer_job_no')]!="")
						{
							$sql = "select a.job_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($returnBooking) and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
						}
					}
					$result = sql_select($sql);*/
					$all_requ_no = "";
					if ($dataArray[0][csf('issue_purpose')] != 8) {
							//echo "select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no";
						$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

						$all_requ_no = $all_booking_sql[0][csf('requisition_no')];
						unset($all_booking_sql);
					}

					if ($dataArray[0][csf('issue_purpose')] == 8)
					{
							$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");    //
							$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
						}
						else if ($dataArray[0][csf('issue_purpose')] == 2)
						 {
								/*if($all_requ_no!="" || $all_requ_no!=0)
							{
								//$req_cond="or a.requisition_no in ($all_requ_no)";
								//$reqRet_cond="or b.booking_no in ($all_requ_no)";
							}
							else
							{
								//$req_cond="or a.requisition_no in (0)";
								$reqRet_cond="or b.booking_no in (0)";
							}*/
						if ($dataArray[0][csf('buyer_job_no')] != "") {
							$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
							$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
						} else {
								//echo "select sum(a.cons_quantity) as total_issue_qty from inv_transaction a, inv_issue_master b where b.id=a.mst_id and b.booking_no='".$dataArray[0][csf('booking_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.buyer_job_no<>'' and b.issue_purpose=2";
							$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
							$total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
						}
					} else {
						if ($dataArray[0][csf('buyer_job_no')] != "") {
							if ($all_requ_no != "" || $all_requ_no != 0) {
								$req_cond = "or a.requisition_no in ($all_requ_no)";
								$reqRet_cond = "or b.booking_no in ($all_requ_no)";
							} else {
									$req_cond = "";//or a.requisition_no in (0)
									$reqRet_cond = "";//or b.booking_no in (0)
								}
								$total_issue_qty = 0;
								//echo "select sum(c.quantity) as total_issue_qty from inv_transaction a, inv_issue_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2";
								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2";
								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");

								//$total_issue_qty=return_field_value("sum(quantity) as total_issue_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=2 and entry_form=3","total_issue_qty");
								//$total_return_qty=return_field_value("sum(quantity) as total_return_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=4 and entry_form=8","total_return_qty");
							}
						}
						?>
						<tbody>
							<tr>
								<td align="center">
									<?
									if ($dataArray[0][csf('issue_purpose')] == 8) echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
									else echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
									?>
								</td>
								<td align="center">
									<? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
								</td>
								<td align="center">
									<? echo number_format($returnReqQty, 3); ?>
								</td>
								<td align="center">
									<? $cumulative_qty = 0;
									$cumulative_qty = $total_issue_qty - $total_return_qty;
									echo number_format($cumulative_qty, 3); ?>
								</td>
								<td align="center">
									<? $balance_qty = $returnReqQty - $cumulative_qty;
									echo number_format($balance_qty, 3); ?>
								</td>
								<td align="center">
									<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
								</td>
							</tr>
						</tbody>
					</table>
					<?
				}
		}
			echo "<br><br><br><br><br><br><br><br>";

			echo signature_table(49, $data[0], "1030px",'',0);
			?>
			</div>
			</div>

			<script>
			function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');
		</script>
		<p style="page-break-after: always;"> </p>

		<?
	}
	exit();
}

if ($action == "yarn_issue_print12")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print7", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);
	$print_with_vat = $data[7];
	$company=$data[0];
	$location=$data[9];
	$store_id=$data[9];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	//$supplier_arr = return_library_array("select id, short_name from lib_supplier", 'id', 'short_name');
	$supplier_arr = return_library_array("select id,supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
    //$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
    //echo $sql;die;

	$dataArray = sql_select($sql);

	if( $dataArray[0][csf('issue_basis')]==3 )
	{
		$planbooking = sql_select("select e.booking_no as pln_booking_no from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c,ppl_planning_info_entry_dtls d,ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$data[5]' ");
	}

	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$no_copy = ($data[8]=="")?1:$data[8];

	$copyNo = "";
	for ($x = 1; $x <= $no_copy; $x++)
	{
		if($x==1)
		{
			$copyTextPostFix = "st";
		}else if($x==2){
			$copyTextPostFix = "nd";
		}else if($x==3){
			$copyTextPostFix = "rd";
		}else{
			$copyTextPostFix = "th";
		}

		if($no_copy>1)
		{
			$copyNo ="<span style='font-size:x-large;'>$x<sup>$copyTextPostFix</sup> Copy</span>";
		}
		$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
		?>
		<div style="width:1100px;">
			<table width="1100" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td colspan="6" align="center" style="font-size:18px"></td>


					<td style="font-size:x-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">

					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="2" align="center">
						<strong style="font-size:18px"><? echo $com_dtls[0]; ?></strong><br>
						<?
						echo $com_dtls[1];
						?>
					</td>
					<td colspan="2" id="barcode_img_id">&nbsp;</td>
					<td colspan="3" style="color:black; font-weight:bold;"><? echo $copyNo;?></td>
				</tr>
				<tr>
					<td colspan="6" align="center" style="font-size:16px"><strong><u>Yarn Delivery Challan/Gate
					Pass</u></strong></center></td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td width="160"><strong>Issue No:</strong></td>
					<td width="175px"><? echo $dataArray[0][csf('issue_number')]; ?></td>
					<td width="120"><strong>Booking:</strong></td>
					<td width="175px">
						<?
						if( $dataArray[0][csf('issue_basis')]==3 )
						{
							$bookingNo = $planbooking[0][csf('pln_booking_no')];
						} else {
							$bookingNo = $dataArray[0][csf('booking_no')];
						}
						echo $bookingNo;
						?>
					</td>
					<td width="125"><strong>Knitting Source:</strong></td>
					<td width="175px"><? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
				</tr>
				<tr>
					<td><strong>Challan/Program No:</strong></td>
					<td width="175px"><? echo $dataArray[0][csf('challan_no')]; ?></td>
					<td><strong>Issue Purpose:</strong></td>
		<td width="175px"><? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
		echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
		?></td>
		<td><strong>Issue Date:</strong></td>
		<td width="175px"><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
	</tr>
	<tr>
		<td><strong>Issue To:</strong></td>
		<?
		if ($dataArray[0][csf('knit_dye_source')] == 3) {
			$supp_add = $dataArray[0][csf('knit_dye_company')];
			$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
			foreach ($nameArray as $result) {
				$address = "";
							if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
						}
						unset($nameArray);
					}

					$loan_party_add = $dataArray[0][csf('loan_party')];
					$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
					foreach ($loanPartyArray as $result) {
						$addressParty = "";
						if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($loanPartyArray);
					?>
					<td colspan="3">
						<?
						if ($dataArray[0][csf('issue_purpose')] == 3) {
							echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
						} else if ($dataArray[0][csf('issue_purpose')] == 5) {
							echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
						} else {
							if ($dataArray[0][csf('knit_dye_source')] == 1)
								echo $company_library[$dataArray[0][csf('knit_dye_company')]];
							else
								echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
						}
						?>
					</td>
					<td colspan="2"><strong>Location : <? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></strong>
					</td>
				</tr>
				<tr>
					<td><strong>Demand No.:</strong></td>
					<td width="175px"><? //echo $dataArray[0][csf('booking_id')];
					?></td>
					<td><strong>Gate Pass No.:</strong></td>
					<td width="175px"><? echo $dataArray[0][csf('gate_pass_no')]; ?></td>
					<td><strong>Do No:</strong></td>
					<td width="175px"><? //echo $dataArray[0][csf('remarks')];
					?></td>
				</tr>
				<tr>
					<td valign="top"><strong>Remarks :</strong></td>
					<td colspan="5"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
				</tr>
				<?
				if ($print_with_vat == 1) {
					?>
					<tr>
						<td><strong>VAT Number :</strong></td>
						<td><p>
							<?
							$vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
							echo $vat_no;
							?></p></td>

						</tr>
						<?
					} else {
						?>
						<tr>
							<td valign="top">&nbsp;</strong></td>
							<td>&nbsp;</td>

						</tr>
						<?
					}
					?>
				</table>
				<br>
				<div style="width:100%;">
					<div style="clear:both;">
						<table style="margin-right:-40px;" cellspacing="0" width="1000" border="1" rules="all"
						class="rpt_table">
						<thead bgcolor="#dddddd" style="font-size:13px">
							<th width="20">SL</th>
							<th width="45">Req. No</th>
							<th width="50">Lot No</th>
							<th width="65">Y. Type</th>
							<th width="110">Item Details</th>
							<th width="65">Grey Color</th>
							<th width="65">Dye. Color</th>
							<th width="60">Supp.</th>
							<th width="60"><b>Issue Qty(kg)</b></th>
							<th width="60">Rtnbl Qty(kg)</th>
							<th width="80">Bag & Cone</th>
							<th width="80">Store</th>
							<th width="100">Buyer & Job</th>
							<th width="120">Order & Style</th>
							<th>Inte. Ref & File</th>
						</thead>
						<?
						$wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");

						$cond = "";
						if ($data[5] != "") $cond .= " and c.id='$data[5]'";

						$po_array = array();
						$job_array = array();
						$costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0]");
						foreach ($costing_sql as $row) {
							$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
							$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
							$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
							$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
							$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
							$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
							$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
							$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
						}
						unset($costing_sql);

						$job_no_array = array();
						$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst");
						foreach ($jobData as $row) {
							$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
							$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
							$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
							$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
						}
					//var_dump($po_array);
						$po_id_req_array = array();
						$is_sales_array = array();
						if ($db_type == 0) {
							$poID = " select c.requisition_no, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.requisition_no, a.is_sales ";
						} else {
							$poID = "select c.requisition_no, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.requisition_no, a.is_sales ";
						}
						$poID_sql_result = sql_select($poID);
						foreach ($poID_sql_result as $row) {
							$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
							$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
						}
						unset($poID_sql_result);

						$i = 1;
						if ($db_type == 0) {
							$sql_result = sql_select("select a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro
								from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
								where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
								group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no");
						} else {
							$sql_result = sql_select("select a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro
								from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
								group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no");
						}
						$all_req_no = '';
						$all_prod_id = '';
						$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
						$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
						foreach ($sql_result as $row) {
							if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
							if ($row[csf('requisition_no')] != '') {
								if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
								if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
							}
							$order_qnty_val = $row[csf('cons_quantity')];
							$order_qnty_val_sum += $order_qnty_val;

							$order_amount_val = $row[csf('order_amount')];
							$order_amount_val_sum += $order_amount_val;

							$no_of_bags_val = $row[csf('no_of_bags')];
							$no_of_bags_val_sum += $no_of_bags_val;

							$po_id = explode(",", $row[csf('po_id')]);
							$po_no = '';
							$style_ref = '';
							$job_no = '';
							$buyer = '';
						//$data=explode('*',$data);
							$productdtls = $row[csf('product_name_details')];
							$productArr = explode(' ', $productdtls);

							$proddtls='';
							$proddtls=$yarn_count_details[$row[csf('yarn_count_id')]];
							if($row[csf('yarn_count_id')]>0) $proddtls.=", ";
							$proddtls.=$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."%";

						/*if($row[csf('yarn_comp_type1st')]>0) $proddtls.=", ";
						$proddtls.=$yarn_type[$row[csf('yarn_type')]];*/

						/*if ($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' && $productArr[4]!=''&& $productArr[5]!='')
						{
							$proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].'%, '.$productArr[3].' '.$productArr[4]."%, ".$productArr[5].", ".$productArr[6];
						}
						else if ($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' && $productArr[4]!='')
						{
							$proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, '.$productArr[3].', '.$productArr[4];
						}
						else if($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' )
						{
							$proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, '.$productArr[3];
						}
						else if($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='')
						{
							$proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, ';
						}
						else if($productArr[0]!='' && $productArr[1]!='' )
						{
							$proddtls=$productArr[0].', '.$productArr[1];
						}
						else if($productArr[0]!='')
						{
							$proddtls=$productArr[0];
						}
						else
						{
							$proddtls='';
						}*/

						$internal_ref = '';
						$file_no = '';
						if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2) {
							foreach ($po_id as $val) {
								if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
								if ($job_no == '') $job_no = $po_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
								if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
							}
							$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
							$job_file = array_unique(explode(",", rtrim($file_no, ", ")));
							$ref_cond = '';
							foreach ($job_ref as $ref) {
								//$ref_cond.=", ".$ref;
								if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
							}
							$file_con = '';
							foreach ($job_file as $file) {
								if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
							}



							$buyer_job = '';
							if ($row[csf('issue_basis')] == 1) {
								if ($dataArray[0][csf('issue_purpose')] == 8) {
									$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
								} else {
									$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
									if ($row[csf('buyer_job_no')] != "") {
										$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
									}
								}
							} else if ($row[csf('issue_basis')] == 2) {
								$buyer_job = '';
							}
						} else if ($row[csf('issue_basis')] == 3) {
							//$ex_data = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
							//print_r($ex_data);

							if ($is_sales_array[$row[csf('requisition_no')]] == 1) {
								$buyer_job = '';
								foreach (array_unique($po_id) as $val) {
									if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
									if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];

									if ($buyer_job == '') {
										if ($job_no_array[$val]['within_group'] == 1) {
											$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
										} else {
											$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
										}
									}
								}
							} else {
								foreach ($po_id as $val) {
									if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
									if ($job_no == '') $job_no = $po_array[$val]['job_no'];
									if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
									if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

									if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
									if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
								}

								$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
								$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

								$ref_cond = '';
								foreach ($job_ref as $ref) {
									//$ref_cond.=", ".$ref;
									if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
								}

								$file_con = '';
								foreach ($job_file as $file) {
									if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
								}
								if ($job_no != '') {
									$buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
								} else {
									$buyer_job = $buyer_arr[$buyer_name];
								}
							}
						} else {
							foreach (array_unique($po_id) as $val) {
								if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
								if ($buyer_job == '') {
									if ($job_no_array[$val]['within_group'] == 1) {

										$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
									} else {
										$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
									}
								}
							}
						}

						$no_bag_cone = "";
						$wt_bag_cone = "";
						if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

						if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="font-size:13px">
							<td width="20"><? echo $i; ?></td>
							<td width="45">
								<div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
							</td>
							<td width="50">
								<div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
							</td>
							<td width="65">
								<div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
							</td>
							<td width="110">
								<div style="word-wrap:break-word; width:110px">
									<?
									//echo $proddtls;
									echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
									?>
								</div>
							</td>
							<td width="65">
								<div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('color')]]; ?></div>
							</td>
							<td width="65">
								<div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
							&nbsp;</div>
						</td>
						<td width="60">
							<div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
						</td>
						<td align="right"
						width="60"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
						<td align="right"
						width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
						<td width="80">
							<div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
						&nbsp;</div>
					</td>
					<td width="80">
						<div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
					</td>
					<td width="100">
						<div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
					</td>
					<td width="120">
						<div style="word-wrap:break-word; width:120px"><? echo $po_no;
						if ($style_ref != "") echo ' & ' . $style_ref; else echo '&nbsp;'; ?></div>
					</td>
					<td>
						<div style="word-wrap:break-word; width:80px"><? echo ltrim($ref_cond, ", ");
						if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?></div>
					</td>
				</tr>
				<?
				$uom_unit = "Kg";
				$uom_gm = "Grams";
				$tot_return_qty += $row[csf('returnable_qnty')];
				$tot_bag += $no_of_bags_val;
				$tot_cone += $row[csf('cone_per_bag')];
				$tot_w_bag += $row[csf('weight_per_bag')];
				$tot_w_cone += $row[csf('weight_per_cone')];
				$req_no = $row[csf('requisition_no')];
				$i++;
			}
			?>
			<tr bgcolor="#CCCCCC" style="font-size:13px">
				<td align="right" colspan="8"><b>Total</b></td>
				<td align="right">
					<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
				</td>
				<td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
				<td><? echo 'N:' . number_format($tot_bag, 2);
				if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
				echo '<br>W:' . number_format($tot_w_bag, 2);
				if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
				<td align="right" colspan="4">&nbsp;</td>
			</tr>
			<tr>
				<td colspan="14" align="left"><b>In
					Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
				</tr>
			</table>
		</div>
		<br>
		<!--================================================================-->
		<?
		if ($data[6] == 1)
		{
			if ($dataArray[0][csf('issue_basis')] == 3)
			{
				?>
				<div style="">
					<table width="850" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
						<thead>
							<tr>
								<th colspan="7" align="center">Requisition Details</th>
							</tr>
							<tr>
								<th width="40">SL</th>
								<th width="100">Requisition No</th>
								<th width="110">Lot No</th>
								<th width="220">Yarn Description</th>
								<th width="110">Brand</th>
								<th width="90">Requisition Qty</th>
								<th>Remarks</th>
							</tr>
						</thead>
						<?
					//echo $all_req_no;
						$i = 1;
						$tot_reqsn_qnty = 0;
						$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
						$product_details_array = array();
						$sql = "select id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where item_category_id=1 and company_id='$data[0]' and status_active=1 and is_deleted=0";
						$result = sql_select($sql);

						foreach ($result as $row) {
							$compos = '';
							if ($row[csf('yarn_comp_percent2nd')] != 0) {
								$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
							} else {
								$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
							}
							$product_details_array[$row[csf('id')]]['count'] = $count_arr[$row[csf('yarn_count_id')]];
							$product_details_array[$row[csf('id')]]['comp'] = $compos;
							$product_details_array[$row[csf('id')]]['type'] = $yarn_type[$row[csf('yarn_type')]];
							$product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
							$product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
						}
						unset($result);
						$sql = "select knit_id, requisition_no, prod_id, sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where requisition_no in ($all_req_no) and status_active=1 and is_deleted=0 group by requisition_no, prod_id, knit_id";
						$nameArray = sql_select($sql);
						foreach ($nameArray as $selectResult) {
							?>
							<tr>
								<td width="40" align="center"><? echo $i; ?></td>
								<td width="100" align="center">&nbsp;<? echo $selectResult[csf('requisition_no')]; ?></td>
								<td width="110" align="center">
									&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['lot']; ?></td>
									<td width="220">
										&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['count'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['comp'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['type']; ?></td>
										<td width="110" align="center">
											&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['brand']; ?></td>
											<td width="90" align="right"><? echo number_format($selectResult[csf('yarn_qnty')], 2); ?>
										&nbsp;</td>
							<td>&nbsp;<? //echo $selectResult[csf('requisition_no')];
							?></td>
						</tr>
						<?
						$tot_reqsn_qnty += $selectResult[csf('yarn_qnty')];
						$i++;
					}
					?>
					<tfoot>
						<th colspan="5" align="right"><b>Total</b></th>
						<th align="right"><? echo number_format($tot_reqsn_qnty, 2); ?>&nbsp;</th>
						<th>&nbsp;</th>
					</tfoot>
				</table>
				<?
				if ($data[5] != 1) {
					$z = 1;
					$k = 1;
					$colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

					$booking_al = "";
					foreach ($colorArray as $book) {
						if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];
					}
					//unset($colorArray);
					//echo $booking_no;
					$booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
					$booking_count = count(array_unique(explode(',', $booking_no)));
					//$booking_job_arr=array();
					if ($dataArray[0][csf('issue_purpose')] == 2) {
						$booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
					} else {
						$booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
					}
					//
					$booking_job_no = $booking_job[0][csf('job_no')];
					unset($booking_job);

					if ($db_type == 0) $poNoCond = "group_concat(id)";
					else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
					/*echo '='.$sql_Job.'=';
				if($sql_Job!="")
				{*/
					$sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

					$job_po = $sql_returnJob[0][csf('po_break_down_id')];
					unset($sql_returnJob);
					?>

					<table width="710" cellpadding="0" cellspacing="0" border="1" rules="all" style="margin-top:20px;"
					class="rpt_table">
					<thead>
						<th width="40">SL</th>
						<th width="250">Fabrication</th>
						<th width="120">Color</th>
						<th width="120">GGSM OR S/L</th>
						<th>FGSM</th>
					</thead>
					<tbody>
						<tr>
							<td width="40" align="center"><? echo $z; ?></td>
							<td width="250"
							align="center"><? echo $body_part[$colorArray[0][csf('body_part_id')]] . ', ' . $colorArray[0][csf('fabric_desc')]; ?></td>
							<td width="120"
							align="center"><? echo $color_range[$colorArray[0][csf('color_range')]]; ?></td>
							<td width="120" align="center"><? echo $colorArray[0][csf('stitch_length')]; ?></td>
							<td align="center"><? echo $colorArray[0][csf('gsm_weight')]; ?></td>
						</tr>
					</tbody>
				</table>
				<table style="margin-top:20px;" width="650" border="1" rules="all" cellpadding="0" cellspacing="0"
				class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="50">Prog. No</th>
					<th width="110">Finish Dia</th>
					<th width="170">Machine Dia & Gauge</th>
					<th width="110">Program Qty</th>
					<th>Remarks</th>
				</thead>
				<tbody>
					<?
					$k=1;
					foreach ($colorArray as $program_row) {
						?>
						<tr>
							<td width="40" align="center"><? echo $k; ?></td>
							<td width="50" align="center"><? echo $program_row[csf('knit_id')]; ?></td>
							<td width="110" align="center"><? echo $program_row[csf('dia')]; ?></td>
							<td width="170" align="center"><? echo $program_row[csf('machine_dia')] . "X" . $program_row[csf('machine_gg')]; ?></td>
							<td width="110" align="right"><? echo number_format($program_row[csf('program_qnty')], 2); ?></td>
							<td><? echo $program_row[csf('remarks')]; ?></td>
						</tr>
						<?
						$k++;
						$tot_prog_qty += $program_row[csf('program_qnty')];
					}
					?>
					<tr>
						<td colspan="4" align="right"><strong>Total : </strong></td>
						<td align="right"><? echo number_format($tot_prog_qty, 2); ?></td>
						<td>&nbsp;</td>
					</tr>
				</tbody>
			</table>
			<?
			$returnJob = '';
			$returnPo = '';
			if ($db_type == 0) {
				$booking_cond = "group_concat(a.booking_no)";
				$wo_cond = "group_concat(a.ydw_no)";
				$reqs_no = "group_concat(b.requisition_no)";
			} else if ($db_type == 2) {
				$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
				$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
				$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
			}

			if ($dataArray[0][csf('issue_purpose')] == 8) {
				$sql_returnJob = sql_select("select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
			} else if ($dataArray[0][csf('issue_purpose')] == 2) {
				$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

				if ($db_type == 0) $poNoCond = "group_concat(id)";
				else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
				$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
			} else {

						$sql_returnJob = sql_select("select a.job_no, a.booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' and a.booking_no in($booking_no) group by a.job_no,a.booking_no"); //and a.booking_no='".$dataArray[0][csf('booking_no')]."'

					}
					$returnJob = $sql_returnJob[0][csf('job_no')];
					//$returnPo=$sql_po[0][csf('po_break_down_id')];
					$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
					$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
					$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
					unset($sql_returnJob);

					/*$req_no_retInJob=sql_select("select $reqs_no as req_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");
					$reqNo_inJob=$req_no_retInJob[0][csf('req_no')];*/
					?>
					<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
					class="rpt_table">
					<thead>
						<tr>
							<th colspan="6" align="center">Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking Job
							Deatils]</p></th>
						</tr>
						<tr>
							<th>Buyer</th>
							<th>Job</th>
							<th>Req. Qty</th>
							<th>Cuml. Issue Qty</th>
							<th>Balance Qty</th>
							<th>Remarks</th>
						</tr>
					</thead>
					<?

					$all_requ_no = "";
					if ($dataArray[0][csf('issue_purpose')] != 8) {
						$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");

						//$all_requ_no="'".$all_booking_sql[0][csf('requisition_no')]."'";
						$all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
					}
					if ($dataArray[0][csf('issue_purpose')] == 8) {
						$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");    //
						$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
					} else if ($dataArray[0][csf('issue_purpose')] == 2) {
						if ($all_requ_no != "" || $all_requ_no != 0) {
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						} else {
							$req_cond = "or a.requisition_no in (0)";
							$reqRet_cond = "or b.booking_no in (0)";
						}

						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
					} else {
						if ($all_requ_no != "" || $all_requ_no != 0) {
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						} else {
							$req_cond = "or a.requisition_no in (0)";
							$reqRet_cond = "or b.booking_no in (0)";
						}
						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");


						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
					}
					$cumulative_qty = 0;
					if ($booking_count == 1) {
						?>
						<tbody>
							<tr>
								<td align="center">
									<? echo $buyer_arr[$job_array[$booking_job_no]['buyer']]; ?>
								</td>
								<td align="center">
									<? echo $job_array[$booking_job_no]['job']; ?>
								</td>
								<td align="center">
									<? echo number_format($returnReqQty, 3); ?>
								</td>
								<td align="center">
									<? $cumulative_qty = $total_issue_qty - $total_return_qty;
									echo number_format($cumulative_qty, 3); ?>
								</td>
								<td align="center">
									<? $balance_qty = $returnReqQty - $cumulative_qty;
									echo number_format($balance_qty, 3); ?>
								</td>
								<td align="center">
									<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
								</td>
							</tr>
						</tbody>
					</table>
					<?
				}
			}
		}
		else if ($dataArray[0][csf('issue_basis')] == 1) {
			?>
			<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
			class="rpt_table">
			<thead>
				<tr>
					<th colspan="6" align="center">Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
						if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
					} ?> </th>
				</tr>
				<tr>
					<th>Buyer</th>
					<th>Job</th>
					<th>Req. Qty</th>
					<th>Cuml. Qty</th>
					<th>Balance Qty</th>
					<th>Remarks</th>
				</tr>
			</thead>
			<?
						//$booking_job_arr=array();
			$returnJob = '';
			$returnPo = '';
			if ($db_type == 0) {
				$booking_cond = "group_concat( distinct a.booking_no)";
				$wo_cond = "group_concat(a.ydw_no)";
				$reqs_no = "group_concat(b.requisition_no)";
			} else if ($db_type == 2) {
				$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
				$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
				$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
			}

			if ($dataArray[0][csf('issue_purpose')] == 8) {
				$sql_returnJob = sql_select("select a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
			} else if ($dataArray[0][csf('issue_purpose')] == 2) {
				if ($dataArray[0][csf('buyer_job_no')] != '') {
					$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");


					if ($db_type == 0) $poNoCond = "group_concat(id)";
					else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
					$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
				} else {
					$sql_returnJob = sql_select("select a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
				}
			} else {
							//echo "select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
							$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");//and a.booking_no='".$dataArray[0][csf('booking_no')]."'
						}
						$returnJob = $sql_returnJob[0][csf('job_no')];
						$returnPo = $sql_po[0][csf('po_break_down_id')];
						$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
						$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

						$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
						unset($sql_returnJob);

						//$booking_all="'".implode("','",explode(",",$bill_item_id))."'";
						//echo $returnJob.'---------'.$returnPo.'dfgdfgd';

						/*if( $dataArray[0][csf('issue_purpose')]==8 )
					{
						$sql = "select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='".$dataArray[0][csf('booking_no')]."' group by a.id";
					}
					else if( $dataArray[0][csf('issue_purpose')]==2)
					{
						if($dataArray[0][csf('buyer_job_no')]!="")
						{
							$sql = "select sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='".$dataArray[0][csf('buyer_job_no')]."'"; // and a.ydw_no='".$dataArray[0][csf('booking_no')]."'
						}
					}
					else
					{
						if($dataArray[0][csf('buyer_job_no')]!="")
						{
							$sql = "select a.job_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($returnBooking) and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
						}
					}
					$result = sql_select($sql);*/
					$all_requ_no = "";
					if ($dataArray[0][csf('issue_purpose')] != 8) {
							//echo "select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no";
						$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

						$all_requ_no = $all_booking_sql[0][csf('requisition_no')];
						unset($all_booking_sql);
					}

					if ($dataArray[0][csf('issue_purpose')] == 8) {
							$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");    //
							$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
						} else if ($dataArray[0][csf('issue_purpose')] == 2) {
							/*if($all_requ_no!="" || $all_requ_no!=0)
						{
							//$req_cond="or a.requisition_no in ($all_requ_no)";
							//$reqRet_cond="or b.booking_no in ($all_requ_no)";
						}
						else
						{
							//$req_cond="or a.requisition_no in (0)";
							$reqRet_cond="or b.booking_no in (0)";
						}*/
						if ($dataArray[0][csf('buyer_job_no')] != "") {
							$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
							$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
						} else {
								//echo "select sum(a.cons_quantity) as total_issue_qty from inv_transaction a, inv_issue_master b where b.id=a.mst_id and b.booking_no='".$dataArray[0][csf('booking_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.buyer_job_no<>'' and b.issue_purpose=2";
							$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
							$total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
						}
					} else {
						if ($dataArray[0][csf('buyer_job_no')] != "") {
							if ($all_requ_no != "" || $all_requ_no != 0) {
								$req_cond = "or a.requisition_no in ($all_requ_no)";
								$reqRet_cond = "or b.booking_no in ($all_requ_no)";
							} else {
									$req_cond = "";//or a.requisition_no in (0)
									$reqRet_cond = "";//or b.booking_no in (0)
								}
								$total_issue_qty = 0;
								//echo "select sum(c.quantity) as total_issue_qty from inv_transaction a, inv_issue_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2";
								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2";
								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");

								//$total_issue_qty=return_field_value("sum(quantity) as total_issue_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=2 and entry_form=3","total_issue_qty");
								//$total_return_qty=return_field_value("sum(quantity) as total_return_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=4 and entry_form=8","total_return_qty");
							}
						}
						?>
						<tbody>
							<tr>
								<td align="center">
									<?
									if ($dataArray[0][csf('issue_purpose')] == 8) echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
									else echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
									?>
								</td>
								<td align="center">
									<? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
								</td>
								<td align="center">
									<? echo number_format($returnReqQty, 3); ?>
								</td>
								<td align="center">
									<? $cumulative_qty = 0;
									$cumulative_qty = $total_issue_qty - $total_return_qty;
									echo number_format($cumulative_qty, 3); ?>
								</td>
								<td align="center">
									<? $balance_qty = $returnReqQty - $cumulative_qty;
									echo number_format($balance_qty, 3); ?>
								</td>
								<td align="center">
									<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
								</td>
							</tr>
						</tbody>
					</table>
					<?
				}
			}
			?>
			<table width="1030" cellspacing="0" border="0" style="margin-left:10px; margin-top:60px">
				<tr>
					<td><strong>Transport No:</strong></td>
					<td><strong>Driver Name:</strong></td>
					<td><strong>D/L No:</strong></td>
					<td><strong>Mobile No:</strong></td>
				</tr>
			</table>
			<br>
			<br>
			<?
			echo signature_table(49, $data[0], "1030px",'',0);
			?>
		</div>
	</div>



	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');
		</script>
		<p style="page-break-after: always;"> </p>

		<?
	}
	exit();
}

if ($action == "yarn_issue_print10")
{
		extract($_REQUEST);
		echo load_html_head_contents("Yarn Issue Challan Print", "../../", 1, 1, '', '', '');
		$data = explode('*', $data);

		$print_with_vat = $data[7];
		$company=$data[0];
		$location=$data[8];
		$store_id=$data[9];
		$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");

		$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
		$floor_room_rack_arr = return_library_array("select FLOOR_ROOM_RACK_ID, FLOOR_ROOM_RACK_NAME from LIB_FLOOR_ROOM_RACK_MST", 'FLOOR_ROOM_RACK_ID', 'FLOOR_ROOM_RACK_NAME');
		$buyer_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');
		$buyer_code_arr = return_library_array("select id, remark from lib_buyer", 'id', 'remark');
		//$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
		$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
		$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
		$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
		$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
		$user_arr = return_library_array("select id, user_name from user_passwd", 'id', 'user_name');
		$sql = " select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
		//echo $sql;die;

		$dataArray = sql_select($sql);

		$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
		$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
		?>
		<div style="width:1000px;">
			<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td colspan="3" style="font-size:xx-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">

					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="100">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td width="100" align="left">
						<strong style="font-size:18px"><? echo $com_dtls[0]; ?></strong><br>
						<?
						echo $com_dtls[1];
						?>
					</td>

					<td width="100" align="left">
						<div style="float:left; color:#000;">
							<table>
								<tr>
									<td>Issue No: </td>
									<td><? echo $dataArray[0][csf('issue_number')]; ?></td>
								</tr>
								<tr>
									<td>Issue Date: </td>
									<td><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
								</tr>
								<tr>
									<?
									$issueNumber="'".$dataArray[0][csf('issue_number')]."'";
									$sql_issue_approve=sql_select("select  c.approved_by,c.approved_date from  inv_issue_master a,  approval_history c where  a.id=c.mst_id and  a.issue_number=$issueNumber and a.is_approved in(1,3)and a.is_deleted=0 and a.status_active=1");
									?>
									<td>Approved Date & Time: </td>
									<td><? echo $sql_issue_approve[0][csf('approved_date')];   //date_format($sql_issue_approve[0][csf('insert_date')],"Y/m/d H:i"); ?></td>
								</tr>
								<tr>
									<td>Approved By: </td>
									<td><? echo $user_arr[$sql_issue_approve[0][csf('approved_by')]]; ?></td>
								</tr>
							</table>
						</div>
					</td>

				</tr>
			</table>




			<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td colspan="6" align="center" style="font-size:16px"><strong><u>Yarn Delivery Challan</u></strong></center></td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td><strong>Issue To:</strong></td>
					<?
					if ($dataArray[0][csf('knit_dye_source')] == 3) {
						$supp_add = $dataArray[0][csf('knit_dye_company')];
						$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
						foreach ($nameArray as $result) {
							$address = "";
                            if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
                        }
                        unset($nameArray);
                    }

                    $loan_party_add = $dataArray[0][csf('loan_party')];
                    $loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
                    foreach ($loanPartyArray as $result) {
                    	$addressParty = "";
                        if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
                    }
                    unset($loanPartyArray);
                    ?>
                    <td width="125">
                    	<?
                    	if ($dataArray[0][csf('issue_purpose')] == 3) {
                    		echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
                    	} else if ($dataArray[0][csf('issue_purpose')] == 5) {
                    		echo $supplier_arr[$dataArray[0][csf('loan_party')]];
                    	} else {
                    		if ($dataArray[0][csf('knit_dye_source')] == 1)
                    			echo $company_library[$dataArray[0][csf('knit_dye_company')]];
                    		else
                    			echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]];
                    	}
                    	?>
                    </td>
                    <td><strong>Gate Pass No.:</strong></td>
                    <td width="175px"><? echo $dataArray[0][csf('gate_pass_no')]; ?></td>
                    <td rowspan="5"  align="center" id="barcode_img_id">&nbsp;</td>
                </tr>
                <tr>
                	<td width="120"><strong>Address:</strong></td>
                	<td width="175">
                		<?
                		if ($dataArray[0][csf('issue_purpose')] == 3) {
                    		//echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
                		} else if ($dataArray[0][csf('issue_purpose')] == 5) {
                			echo ' : Address :- ' . $addressParty;
                		} else {
                			if ($dataArray[0][csf('knit_dye_source')] == 1)
                			{
                    			//echo $company_library[$dataArray[0][csf('knit_dye_company')]];
                			}
                			else{
                				echo  ' : Address :- ' . $address; }
                			}
                			?>
                		</td>
                		<td width="125"><strong>Knitting Source:</strong></td>
                		<td width="175px"><? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>

                	</tr>
                	<tr>

                		<td width="120"><strong>Booking:</strong></td>
                		<td width="175px"><? echo $dataArray[0][csf('booking_no')]; ?></td>



                		<td colspan="2"><strong>Location : <? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></strong>
                		</td>
                	</tr>
                	<tr>
                		<td><strong>Issue Purpose:</strong></td>
			        	<td width="175px"><? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
			       			 echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
			       			 ?></td>

			       			 <td><strong>Do No:</strong></td>
                    <td width="175px"><? //echo $dataArray[0][csf('remarks')];
                    ?></td>

                </tr>
                <tr>
                	<td valign="top" rowspan="2"><strong>Remarks :</strong></td>
                	<td colspan="3" rowspan="2"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
                </tr>
                <tr>
                	<td  align="center"><? echo $dataArray[0][csf('issue_number')];?></td>
                </tr>
                <?
                if ($print_with_vat == 1) {
                	?>
                	<tr>
                		<td><strong>VAT Number :</strong></td>
                		<td><p>
                			<?
                			$vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
                			echo $vat_no;
                			?></p></td>

                		</tr>
                		<?
                	} else {
                		?>
                		<tr>
                			<td valign="top">&nbsp;</strong></td>
                			<td>&nbsp;</td>

                		</tr>
                		<?
                	}
                	?>
                </table>
                <br>
                <div style="width:100%;">
                	<div style="clear:both;">
                		<table style="margin-right:-40px;" cellspacing="0" width="1320" border="1" rules="all"
                		class="rpt_table">
                		<thead bgcolor="#dddddd" style="font-size:13px">
                			<th width="20">SL</th>
                			<th width="45">Req. No</th>
                			<th width="50">Lot No</th>
                			<th width="65">Y. Type</th>
                			<th width="110">Item Details</th>
                			<th width="65">Grey Color</th>
                			<th width="65">Dye. Color</th>
                			<th width="60">Supp.</th>
                			<th width="60"><b>Issue Qty(kg)</b></th>
                			<th width="60">Rtnbl Qty(kg)</th>
                			<th width="80">Bag & Cone</th>
                			<th width="80">Store</th>
                			<th width="80">FLoor</th>
                			<th width="80">Room</th>
                			<th width="80">Rack</th>
                			<th width="80">Shelf</th>
                			<th width="100">Buyer & Job</th>
                			<th width="120">Order & Style</th>
                			<th>Inte. Ref & File</th>
                		</thead>
                		<?
                		$i = 1;
                		$cond = "";
                		if ($data[5] != "") $cond .= " and c.id='$data[5]'";
                		if ($db_type == 0) {
                			$sql_result = sql_select("select a.id prod_id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro
                				from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
                				where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
                				group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no");
                		} else {
                			$sql_result = sql_select("select a.id prod_id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id,b.floor_id, b.room, b.rack, b.self, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro
                				from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
                				group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no,b.floor_id, b.room, b.rack, b.self");
                		}

                		$all_req_no = '';
                		$all_prod_id = '';
						// echo "<pre>";
						// print_r($sql_result);die;
                		foreach ($sql_result as $row) {
                			if($row[csf("po_id")]!="")
                			{
                				$po_arr[] = $row[csf("po_id")];
                			}
                			$requisition_arr[] = $row[csf("requisition_no")];
                		}

                		$po_array = array();
                		$job_array = array();
                		$po_cond = (!empty($po_arr))?" and b.id in (".implode(",",$po_arr).")":"";
                		if(!empty($po_arr))
                		{
                			$costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0] $po_cond");
                			foreach ($costing_sql as $row) {
                				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
                				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                				$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                				$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
                				$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
                				$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
                				$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
                				$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
                			}
                		}
                		unset($costing_sql);

                		$job_no_array = array();
                		$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst");
                		foreach ($jobData as $row) {
                			$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                			$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                			$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
                			$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
                		}

                		$po_id_req_array = array();
                		$is_sales_array = array();
                		$requisition_arr_cond = (!empty($requisition_arr))?" and c.requisition_no in (".implode(",",$requisition_arr).")":"";
                		if ($db_type == 0) {
                			$poID = " select c.requisition_no, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id $requisition_arr_cond group by c.requisition_no, a.is_sales ";
                		} else {
                			$poID = "select c.requisition_no, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id $requisition_arr_cond group by c.requisition_no, a.is_sales ";
                		}
                		$poID_sql_result = sql_select($poID);
                		foreach ($poID_sql_result as $row) {
                			$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
                			$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
                		}
                		unset($poID_sql_result);

                		$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
                		$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
                		foreach ($sql_result as $row) {
                			if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
                			if ($row[csf('requisition_no')] != '') {
                				if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
                				if ($all_prod_id == '') $all_prod_id = $row[csf('prod_id')]; else $all_prod_id .= ',' . $row[csf('prod_id')];
                			}
                			$order_qnty_val = $row[csf('cons_quantity')];
                			$order_qnty_val_sum += $order_qnty_val;

                			$order_amount_val = $row[csf('order_amount')];
                			$order_amount_val_sum += $order_amount_val;

                			$no_of_bags_val = $row[csf('no_of_bags')];
                			$no_of_bags_val_sum += $no_of_bags_val;

                			$po_id = explode(",", $row[csf('po_id')]);
                			$po_no = '';
                			$style_ref = '';
                			$job_no = '';
                			$buyer = '';
                			$productdtls = $row[csf('product_name_details')];
                			$productArr = explode(' ', $productdtls);

                			$proddtls='';
                			$proddtls=$yarn_count_details[$row[csf('yarn_count_id')]];
                			if($row[csf('yarn_count_id')]>0) $proddtls.=", ";
                			$proddtls.=$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."%";

                			$internal_ref = '';
                			$file_no = '';
                			if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
                			{
                				foreach ($po_id as $val) {
                					if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
                					if ($job_no == '') $job_no = $po_array[$val]['job_no'];
                					if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
                					if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                					if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
                					if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                				}
                				$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                				$job_file = array_unique(explode(",", rtrim($file_no, ", ")));
                				$ref_cond = '';
                				foreach ($job_ref as $ref) {
								//$ref_cond.=", ".$ref;
                					if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                				}
                				$file_con = '';
                				foreach ($job_file as $file) {
                					if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                				}



                				$buyer_job = '';
                				if ($row[csf('issue_basis')] == 1) {
                					if ($dataArray[0][csf('issue_purpose')] == 8) {
                						$buyer_job = $buyer_code_arr[$row[csf('buyer_id')]];
                					} else {
                						$buyer_job = $buyer_code_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
                						if ($row[csf('buyer_job_no')] != "") {
                							$buyer_job = $buyer_code_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
                						}
                					}
                				} else if ($row[csf('issue_basis')] == 2) {
                					$buyer_job = '';
                				}
                			}
                			else if ($row[csf('issue_basis')] == 3)
                			{

                				if ($is_sales_array[$row[csf('requisition_no')]] == 1)
                				{
                					$buyer_job = '';
                					foreach (array_unique($po_id) as $val) {
                						if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
                						if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];

                						if ($buyer_job == '') {
                							if ($job_no_array[$val]['within_group'] == 1) {
                								$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
                							} else {
                								$buyer_job = $buyer_code_arr[$job_no_array[$val]['buyer_id']];
                							}
                						}
                					}
                				}
                				else
                				{

                					if($po_id[0]!="")
                					{
                						foreach ($po_id as $val)
                						{
	                						if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
	                						if ($job_no == '') $job_no = $po_array[$val]['job_no'];
	                						if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
	                						if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

	                						if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
	                						if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                						}
                					}
                					else{
                						$requisition_no = $row[csf('requisition_no')];
                						$sample_req_booking_buyer = return_field_value('buyer_id','ppl_yarn_requisition_entry a, ppl_planning_entry_plan_dtls b',"a.knit_id=b.dtls_id and a.requisition_no=$requisition_no");
                						if ($buyer == '') $buyer_name = $sample_req_booking_buyer;
                					}

                					$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                					$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

                					$ref_cond = '';
                					foreach ($job_ref as $ref) {
                						if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                					}

                					$file_con = '';
                					foreach ($job_file as $file) {
                						if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                					}
                					if ($job_no != '') {
                						$buyer_job = $buyer_code_arr[$buyer_name] . ' & ' . $job_no;
                					} else {
                						$buyer_job = $buyer_code_arr[$buyer_name];
                					}
                				}
                			}
                			else
                			{
                				foreach (array_unique($po_id) as $val) {
                					if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
                					if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
                					if ($buyer_job == '') {
                						if ($job_no_array[$val]['within_group'] == 1) {
                							$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
                						} else {
                							$buyer_job = $buyer_code_arr[$job_no_array[$val]['buyer_id']];
                						}
                					}
                				}
                			}

                			$no_bag_cone = "";
                			$wt_bag_cone = "";
                			if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

                			if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
                			?>
                			<tr bgcolor="<? echo $bgcolor; ?>" style="font-size:13px">
                				<td width="20"><? echo $i; ?></td>
                				<td width="45">
                					<div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
                				</td>
                				<td width="50">
                					<div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
                				</td>
                				<td width="65">
                					<div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
                				</td>
                				<td width="110">
                					<div style="word-wrap:break-word; width:110px">
                						<?
                						echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
                						?>
                					</div>
                				</td>
                				<td width="65">
                					<div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('color')]]; ?></div>
                				</td>
                				<td width="65">
                					<div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
                				&nbsp;</div>
                			</td>
                			<td width="60">
                				<div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
                			</td>
                			<td align="right"
                			width="60"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
                			<td align="right"
                			width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
                			<td width="80">
                				<div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
                			&nbsp;</div>
                		</td>
                		<td width="80">
                			<div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
                		</td>
                		<td width="80">
                			<div style="word-wrap:break-word; width:80px"><? echo $floor_room_rack_arr[$row[csf('floor_id')]]; ?></div>
                		</td>
                		<td width="80">
                			<div style="word-wrap:break-word; width:80px"><? echo $floor_room_rack_arr[$row[csf('room')]]; ?></div>
                		</td>
                		<td width="80">
                			<div style="word-wrap:break-word; width:80px"><? echo $floor_room_rack_arr[$row[csf('rack')]]; ?></div>
                		</td>
                		<td width="80">
                			<div style="word-wrap:break-word; width:80px"><? echo $floor_room_rack_arr[$row[csf('self')]]; ?></div>
                		</td>
                		<td width="100">
                			<div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
                		</td>
                		<td width="120">
                			<div style="word-wrap:break-word; width:120px"><? echo $po_no;
                			if ($style_ref != "") echo ' & ' . $style_ref; else echo '&nbsp;'; ?></div>
                		</td>
                		<td>
                			<div style="word-wrap:break-word; width:80px"><? echo ltrim($ref_cond, ", ");
                			if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?></div>
                		</td>
                	</tr>
                	<?
                	$uom_unit = "Kg";
                	$uom_gm = "Grams";
                	$tot_return_qty += $row[csf('returnable_qnty')];
                	$tot_bag += $no_of_bags_val;
                	$tot_cone += $row[csf('cone_per_bag')];
                	$tot_w_bag += $row[csf('weight_per_bag')];
                	$tot_w_cone += $row[csf('weight_per_cone')];
                	$req_no = $row[csf('requisition_no')];
                	$i++;
                }
                ?>
                <tr bgcolor="#CCCCCC" style="font-size:13px">
                	<td align="right" colspan="8"><b>Total</b></td>
                	<td align="right">
                		<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
                	</td>
                	<td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
                	<td><? echo 'N:' . number_format($tot_bag, 2);
                	if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
                	echo '<br>W:' . number_format($tot_w_bag, 2);
                	if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
                	<td align="right" colspan="8">&nbsp;</td>
                </tr>
                <tr>
                	<td colspan="19" align="left"><b>In
                		Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
                	</tr>
                </table>
            </div>
            <br>
            <!--================================================================-->
            <?
            if ($data[6] == 1)
            {
            	if ($dataArray[0][csf('issue_basis')] == 3)
            	{
            		?>
            		<div style="">
            			<table width="850" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
            				<thead>
            					<tr>
            						<th colspan="7" align="center">Requisition Details</th>
            					</tr>
            					<tr>
            						<th width="40">SL</th>
            						<th width="100">Requisition No</th>
            						<th width="110">Lot No</th>
            						<th width="220">Yarn Description</th>
            						<th width="110">Brand</th>
            						<th width="90">Requisition Qty</th>
            						<th>Remarks</th>
            					</tr>
            				</thead>
            				<?
            				$i = 1;
            				$tot_reqsn_qnty = 0;
            				$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
            				$product_details_array = array();
            				$sql = "select id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where item_category_id=1 and company_id='$data[0]' and status_active=1 and is_deleted=0 and id in(".trim($all_prod_id,", ").")";
            				$result = sql_select($sql);
            				foreach ($result as $row) {
            					$compos = '';
            					if ($row[csf('yarn_comp_percent2nd')] != 0) {
            						$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
            					} else {
            						$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
            					}
            					$product_details_array[$row[csf('id')]]['count'] = $count_arr[$row[csf('yarn_count_id')]];
            					$product_details_array[$row[csf('id')]]['comp'] = $compos;
            					$product_details_array[$row[csf('id')]]['type'] = $yarn_type[$row[csf('yarn_type')]];
            					$product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
            					$product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
            				}
            				unset($result);


            				$colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

            				$sql = "select knit_id, requisition_no, prod_id, sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where requisition_no in ($all_req_no) and status_active=1 and is_deleted=0 group by requisition_no, prod_id, knit_id";
            				$nameArray = sql_select($sql);
            				foreach ($nameArray as $selectResult) {
            					?>
            					<tr>
            						<td width="40" align="center"><? echo $i; ?></td>
            						<td width="100" align="center"><? echo $selectResult[csf('requisition_no')]; ?></td>
            						<td width="110" align="center">
            							<? echo $product_details_array[$selectResult[csf('prod_id')]]['lot']; ?></td>
            							<td width="220">
            								<? echo $product_details_array[$selectResult[csf('prod_id')]]['count'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['comp'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['type']; ?></td>
            								<td width="110" align="center">
            									<? echo $product_details_array[$selectResult[csf('prod_id')]]['brand']; ?></td>
            									<td width="90" align="right"><? echo number_format($selectResult[csf('yarn_qnty')], 2); ?>
            								</td>
            								<td></td>
            							</tr>
            							<?
            							$tot_reqsn_qnty += $selectResult[csf('yarn_qnty')];
            							$i++;
            						}
            						?>
            						<tfoot>
            							<th colspan="5" align="right"><b>Total</b></th>
            							<th align="right"><? echo number_format($tot_reqsn_qnty, 2); ?>&nbsp;</th>
            							<th>&nbsp;</th>
            						</tfoot>
            					</table>
            					<?
            					if ($data[5] != 1) {
            						$z = 1;
            						$k = 1;
            						$booking_al = "";
            						foreach ($colorArray as $book) {
            							if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];
            						}

            						$booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
            						$booking_count = count(array_unique(explode(',', $booking_no)));

            						if ($dataArray[0][csf('issue_purpose')] == 2) {
            							$booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
            						} else {
            							$booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
            						}

            						$booking_job_no = $booking_job[0][csf('job_no')];
            						unset($booking_job);

            						if ($db_type == 0) $poNoCond = "group_concat(id)";
            						else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";

            						$sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

            						$job_po = $sql_returnJob[0][csf('po_break_down_id')];
            						unset($sql_returnJob);
            						?>

            						<table width="710" cellpadding="0" cellspacing="0" border="1" rules="all" style="margin-top:20px;"
            						class="rpt_table">
            						<thead>
            							<th width="40">SL</th>
            							<th width="250">Fabrication</th>
            							<th width="120">Color</th>
            							<th width="120">GGSM OR S/L</th>
            							<th>FGSM</th>
            						</thead>
            						<tbody>
            							<tr>
            								<td width="40" align="center"><? echo $z; ?></td>
            								<td width="250"
            								align="center"><? echo $body_part[$colorArray[0][csf('body_part_id')]] . ', ' . $colorArray[0][csf('fabric_desc')]; ?></td>
            								<td width="120"
            								align="center"><? echo $color_range[$colorArray[0][csf('color_range')]]; ?></td>
            								<td width="120" align="center"><? echo $colorArray[0][csf('stitch_length')]; ?></td>
            								<td align="center"><? echo $colorArray[0][csf('gsm_weight')]; ?></td>
            							</tr>
            						</tbody>
            					</table>
            					<table style="margin-top:20px;" width="650" border="1" rules="all" cellpadding="0" cellspacing="0"
            					class="rpt_table">
            					<thead>
            						<th width="40">SL</th>
            						<th width="50">Prog. No</th>
            						<th width="110">Finish Dia</th>
            						<th width="170">Machine Dia & Gauge</th>
            						<th width="110">Program Qty</th>
            						<th>Remarks</th>
            					</thead>
            					<tbody>
            						<tr>
            							<td width="40" align="center"><? echo $k; ?></td>
            							<td width="50" align="center">&nbsp;<? echo $colorArray[0][csf('knit_id')]; ?></td>
            							<td width="110" align="center"><? echo $colorArray[0][csf('dia')]; ?></td>
            							<td width="170"
            							align="center"><? echo $colorArray[0][csf('machine_dia')] . "X" . $colorArray[0][csf('machine_gg')]; ?></td>
            							<td width="110"
            							align="right"><? echo number_format($colorArray[0][csf('program_qnty')], 2); ?>
            						&nbsp;</td>
            						<td><? echo $colorArray[0][csf('remarks')]; ?></td>
            					</tr>
            					<?
            					$tot_prog_qty += $colorArray[0][csf('program_qnty')];
            					?>
            					<tr>
            						<td colspan="4" align="right"><strong>Total : </strong></td>
            						<td align="right"><? echo number_format($tot_prog_qty, 2); ?></td>
            						<td>&nbsp;</td>
            					</tr>
            				</tbody>
            			</table>
            			<?
            			$returnJob = '';
            			$returnPo = '';
            			if ($db_type == 0) {
            				$booking_cond = "group_concat(a.booking_no)";
            				$wo_cond = "group_concat(a.ydw_no)";
            				$reqs_no = "group_concat(b.requisition_no)";
            			} else if ($db_type == 2) {
            				$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
            				$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
            				$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
            			}

            			if ($dataArray[0][csf('issue_purpose')] == 8) {
            				$sql_returnJob = sql_select("select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
            			} else if ($dataArray[0][csf('issue_purpose')] == 2) {
            				$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

            				if ($db_type == 0) $poNoCond = "group_concat(id)";
            				else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
            				$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
            			} else {
            				$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' group by a.job_no");
            			}
            			$returnJob = $sql_returnJob[0][csf('job_no')];
            			$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
            			$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
            			$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
            			unset($sql_returnJob);
            			?>
            			<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
            			class="rpt_table">
            			<thead>
            				<tr>
            					<th colspan="6" align="center">Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking Job
            					Deatils]</p></th>
            				</tr>
            				<tr>
            					<th>Buyer</th>
            					<th>Job</th>
            					<th>Req. Qty</th>
            					<th>Cuml. Issue Qty</th>
            					<th>Balance Qty</th>
            					<th>Remarks</th>
            				</tr>
            			</thead>
            			<?

            			$all_requ_no = "";
            			if ($dataArray[0][csf('issue_purpose')] != 8) {
            				$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");
            				$all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
            			}
            			if ($dataArray[0][csf('issue_purpose')] == 8) {
            				$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");
            				$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
            			} else if ($dataArray[0][csf('issue_purpose')] == 2) {
            				if ($all_requ_no != "" || $all_requ_no != 0) {
            					$req_cond = "or a.requisition_no in ($all_requ_no)";
            					$reqRet_cond = "or b.booking_no in ($all_requ_no)";
            				} else {
            					$req_cond = "or a.requisition_no in (0)";
            					$reqRet_cond = "or b.booking_no in (0)";
            				}

            				$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

            				$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
            			} else {
            				if ($all_requ_no != "" || $all_requ_no != 0) {
            					$req_cond = "or a.requisition_no in ($all_requ_no)";
            					$reqRet_cond = "or b.booking_no in ($all_requ_no)";
            				} else {
            					$req_cond = "or a.requisition_no in (0)";
            					$reqRet_cond = "or b.booking_no in (0)";
            				}
            				$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");


            				$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
            			}
            			$cumulative_qty = 0;
            			if ($booking_count == 1) {
            				?>
            				<tbody>
            					<tr>
            						<td align="center">
            							<? echo $buyer_arr[$job_array[$booking_job_no]['buyer']]; ?>
            						</td>
            						<td align="center">
            							<? echo $job_array[$booking_job_no]['job']; ?>
            						</td>
            						<td align="center">
            							<? echo number_format($returnReqQty, 3); ?>
            						</td>
            						<td align="center">
            							<? $cumulative_qty = $total_issue_qty - $total_return_qty;
            							echo number_format($cumulative_qty, 3); ?>
            						</td>
            						<td align="center">
            							<? $balance_qty = $returnReqQty - $cumulative_qty;
            							echo number_format($balance_qty, 3); ?>
            						</td>
            						<td align="center">
            							<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
            						</td>
            					</tr>
            				</tbody>
            			</table>
            			<?
            		}
            	}
            }
            else if ($dataArray[0][csf('issue_basis')] == 1) {
            	?>
            	<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0" cellspacing="0"
            	class="rpt_table">
            	<thead>
            		<tr>
            			<th colspan="6" align="center">Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
            				if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
            			} ?> </th>
            		</tr>
            		<tr>
            			<th>Buyer</th>
            			<th>Job</th>
            			<th>Req. Qty</th>
            			<th>Cuml. Qty</th>
            			<th>Balance Qty</th>
            			<th>Remarks</th>
            		</tr>
            	</thead>
            	<?
            	$returnJob = '';
            	$returnPo = '';
            	if ($db_type == 0) {
            		$booking_cond = "group_concat( distinct a.booking_no)";
            		$wo_cond = "group_concat(a.ydw_no)";
            		$reqs_no = "group_concat(b.requisition_no)";
            	} else if ($db_type == 2) {
            		$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
            		$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
            		$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
            	}

            	if ($dataArray[0][csf('issue_purpose')] == 8) {
            		$sql_returnJob = sql_select("select a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
            	} else if ($dataArray[0][csf('issue_purpose')] == 2) {
            		if ($dataArray[0][csf('buyer_job_no')] != '') {
            			$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

            			if ($db_type == 0) $poNoCond = "group_concat(id)";
            			else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
            			$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
            		} else {
            			$sql_returnJob = sql_select("select a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
            		}
            	} else {
            		$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");
            	}
            	$returnJob = $sql_returnJob[0][csf('job_no')];
            	$returnPo = $sql_po[0][csf('po_break_down_id')];
            	$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
            	$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

            	$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
            	unset($sql_returnJob);


            	$all_requ_no = "";
            	if ($dataArray[0][csf('issue_purpose')] != 8) {
            		$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

            		$all_requ_no = $all_booking_sql[0][csf('requisition_no')];
            		unset($all_booking_sql);
            	}

            	if ($dataArray[0][csf('issue_purpose')] == 8) {
            		$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");
            		$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
            	} else if ($dataArray[0][csf('issue_purpose')] == 2) {

            		if ($dataArray[0][csf('buyer_job_no')] != "") {
            			$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
            			$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
            		} else {
            			$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

            			$total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9  and c.issue_purpose=2", "total_return_qty");
            		}
            	} else {
            		if ($dataArray[0][csf('buyer_job_no')] != "") {
            			if ($all_requ_no != "" || $all_requ_no != 0) {
            				$req_cond = "or a.requisition_no in ($all_requ_no)";
            				$reqRet_cond = "or b.booking_no in ($all_requ_no)";
            			} else {
            				$req_cond = "";
            				$reqRet_cond = "";
            			}
            			$total_issue_qty = 0;
            			$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");
            			$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
            		}
            	}
            	?>
            	<tbody>
            		<tr>
            			<td align="center">
            				<?
            				if ($dataArray[0][csf('issue_purpose')] == 8) echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
            				else echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
            				?>
            			</td>
            			<td align="center">
            				<? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
            			</td>
            			<td align="center">
            				<? echo number_format($returnReqQty, 3); ?>
            			</td>
            			<td align="center">
            				<? $cumulative_qty = 0;
            				$cumulative_qty = $total_issue_qty - $total_return_qty;
            				echo number_format($cumulative_qty, 3); ?>
            			</td>
            			<td align="center">
            				<? $balance_qty = $returnReqQty - $cumulative_qty;
            				echo number_format($balance_qty, 3); ?>
            			</td>
            			<td align="center">
            				<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
            			</td>
            		</tr>
            	</tbody>
            </table>
            <?
        }
    }
    ?>
    <div style="text-align:center;font-size:xx-large; font-style:italic; margin-top:20px; color:#FF0000;">
    	<?
    	if($data[4] == 1){}else{echo "Draft";}
    	?>
    </div>

    <?
    echo signature_table(49, $data[0], "1030px",'',0);
    ?>
	</div>
	</div>

	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquery.qrcode.min.js"></script>
	<script>
		var main_value='<? echo json_encode($data[1]); ?>';
			//$('#barcode_img_id').qrcode({width: 120,height: 80, text: <? //echo json_encode($data[1]]); ?>});
			$('#barcode_img_id').qrcode({width: 80,height: 80, text: <? echo json_encode($data[1]); ?>});
			//$('#barcode_img_id').qrcode(main_value);
		</script>
		<?
	exit();
}

if ($action == "yarn_issue_print23")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);
	$print_with_vat = $data[7];
	$company=$data[0];
	$location=$data[8];
	$store_id=$data[9];

	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	//echo $store_location_id.'system';

	//$supplier_arr = return_library_array("select id, short_name from lib_supplier", 'id', 'short_name');
	$supplier_arr = return_library_array("select id,supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');
    //$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$floor_room_rack_arr = return_library_array("select floor_room_rack_id, floor_room_rack_name from lib_floor_room_rack_mst", 'floor_room_rack_id', 'floor_room_rack_name');

	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
    //echo $sql;die;
	$dataArray = sql_select($sql);
	//$demand_no = array();
	$demand_no = '';
	if( $dataArray[0][csf('issue_basis')]==3 || $dataArray[0][csf('issue_basis')]==8 )
	{
		$planbooking = sql_select("select a.id,b.requisition_no, e.booking_no as pln_booking_no, d.id, b.demand_no from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$data[5]'");

		//for demand no
		if( $dataArray[0][csf('issue_basis')]==8 )
		{
			foreach($planbooking as $row)
			{
				$demand_no = $row[csf('demand_no')];
			}
			$req_no_arr = array();
			foreach($planbooking as $row)
			{
				$req_no_arr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];
			}

			/* $req_sql_zs = sql_select("select a.demand_system_no from ppl_yarn_demand_entry_mst a, ppl_yarn_demand_entry_dtls b where a.id = b.mst_id and b.requisition_no in(".implode(',', $req_no_arr).")");
			foreach($req_sql_zs as $row)
			{
				$demand_no[$row[csf('demand_system_no')]] = $row[csf('demand_system_no')];
			} */
		}
	}
	else if( $dataArray[0][csf('issue_basis')]==1 || $dataArray[0][csf('issue_purpose')]==2 )
	{
		$booking_id = $dataArray[0][csf('booking_id')];
		$sql_smn = "SELECT a.mst_id,a.job_no_id,b.internal_ref from wo_yarn_dyeing_dtls a, sample_development_mst b where a.job_no_id=b.id and a.mst_id=$booking_id and a.status_active=1 and a.is_deleted=0 group by a.mst_id,a.job_no_id,b.internal_ref";
		//echo $sql_smn;
		$smn_info_arr = array();
		$sql_smn_res = sql_select($sql_smn);
		foreach ($sql_smn_res as $row)
		{
			$smn_info_arr[$row[csf('mst_id')]]['int_ref']=$row[csf('internal_ref')];
		}
		unset($sql_smn_res);
		//echo "<pre>";print_r($smn_info_arr);
	}


	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$copyNo = "";
	for ($x = 1; $x <= 5; $x++)
	{
		if($x==1)
		{
			$copyNo ="<span style='font-size:x-large;'>1<sup>st</sup> Copy</span>";
		} else if($x==2){
			$copyNo ="<span style='font-size:x-large;'>2<sup>nd</sup> Copy</span>";
		} else if($x==3){
			$copyNo ="<span style='font-size:x-large;'>3<sup>rd</sup> Copy</span>";
		} elseif($x==4)
		{
			$copyNo ="<span style='font-size:x-large;'>4<sup>th</sup> Copy</span>";
		}
		elseif($x==5)
		{
			$copyNo ="<span style='font-size:x-large;'>5<sup>th</sup> Copy</span>";
		}

		$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
		?>
		<div style="width:1150px;">
			<table width="1100" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td colspan="6" align="center" style="font-size:19px"></td>
					<td style="font-size:x-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">
					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="4" align="center">
						<strong style="font-size:19px"><? echo $com_dtls[0]; ?></strong><br>
						<?
						echo $com_dtls[1];
						?>
					</td>
					<td colspan="2" id="barcode_img_id">&nbsp;</td>
					<td colspan="3" style="color:black; font-weight:bold;"><? echo $copyNo;?></td>
				</tr>
				<tr>
					<td colspan="6" align="center" style="font-size:17px"><strong><u>Yarn Delivery Challan/Gate
					Pass</u></strong></center></td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td width="160" style="font-size:15px"><strong>Issue No</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('issue_number')]; ?></td>
					<td width="120" style="font-size:15px"><strong>Booking</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;
						<?
						if( $dataArray[0][csf('issue_basis')]==3 || $dataArray[0][csf('issue_basis')]==8 )
						{
							$bookingNo = $planbooking[0][csf('pln_booking_no')];
							$challan_prog = $planbooking[0][csf('id')];
						}
						else
						{
							$bookingNo = $dataArray[0][csf('booking_no')];
							$challan_prog = $dataArray[0][csf('challan_no')];
						}
						echo $bookingNo;
						?>
					</td>
					<td width="125" style="font-size:15px"><strong>Knitting Source</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
				</tr>
				<tr>
					<td style="font-size:14px"><strong>Challan/Program No</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? echo $challan_prog; ?></td>
					<td style="font-size:15px"><strong>Issue Purpose</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
					echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
					?></td>
		<td style="font-size:15px"><strong>Issue Date</strong></td>
		<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
	</tr>
	<tr>
		<td style="font-size:15px"><strong>Issue To</strong></td>
		<?
		if ($dataArray[0][csf('knit_dye_source')] == 3)
		{
			$supp_add = $dataArray[0][csf('knit_dye_company')];
			$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
			foreach ($nameArray as $result) {
				$address = "";
							if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
						}
						unset($nameArray);
					}

					$loan_party_add = $dataArray[0][csf('loan_party')];
					$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
					foreach ($loanPartyArray as $result) {
						$addressParty = "";
						if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($loanPartyArray);
					?>
					<td colspan="3" style="font-size:15px"><strong>:</strong>&nbsp;
						<?
						if ($dataArray[0][csf('issue_purpose')] == 3) {
							echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
						} else if ($dataArray[0][csf('issue_purpose')] == 5) {
							echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
						} else {
							if ($dataArray[0][csf('knit_dye_source')] == 1)
								echo $company_library[$dataArray[0][csf('knit_dye_company')]];
							else
								echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
						}
						?>
					</td>
                    <td style="font-size:15px"><strong>Location</strong></td>
					<td style="font-size:15px"><strong>:</strong>&nbsp;<? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>
				</tr>
				<tr>
					<td style="font-size:15px"><strong>Demand No.</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? echo $demand_no; //implode(', ', $demand_no); ?></td>
					<td style="font-size:14px"><strong>Gate Pass No.</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('gate_pass_no')]; ?></td>
					<td style="font-size:14px"><strong>Do No</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? //echo $dataArray[0][csf('remarks')];
					?></td>
				</tr>
				<tr>
					<td valign="top" style="font-size:15px"><strong>Remarks</strong></td>
					<td colspan="5" style="font-size:15px"><strong>:</strong>&nbsp;<p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
				</tr>
				<?
				if ($print_with_vat == 1)
				{
					?>
					<tr>
						<td style="font-size:15px"><strong>VAT Number</strong></td>
						<td style="font-size:15px"><strong>:</strong>&nbsp;<p>
							<?
							$vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
							echo $vat_no;
							?>
                        </p></td>
                    </tr>
                    <?
                }
				else
				{
                    ?>
                    <tr>
                        <td valign="top">&nbsp;</strong></td>
                        <td>&nbsp;</td>
                    </tr>
                    <?
                }
                ?>
				<tr>
					<td><strong>Driver Name.</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;</td>
					<td><strong>Driver Mobile No.</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;</td>
					<td><strong>Vehicle No</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;</td>
				</tr>
            </table>
            <br><br><br><br>
            <div style="width:100%;">
                <div style="clear:both;">
                    <table style="margin-right:-40px;" cellspacing="0" width="1230" border="1" rules="all"
                    class="rpt_table" >
                    <thead bgcolor="#dddddd" style="font-size:15px">
                        <th width="20">SL</th>
                        <th width="45">Req. No</th>
                        <th width="50">Program No</th>
                        <th width="50">Lot No</th>
                        <th width="65">Y. Type</th>
                        <th width="110">Item Details</th>
                        <th width="65">Grey Color</th>
                        <th width="65">Dye. Color</th>
                        <th width="60">Supp.</th>
                        <th width="60"><b>Issue Qty(kg)</b></th>
                        <th width="60">Rtnbl Qty(kg)</th>
                        <th width="80">Bag & Cone</th>
                        <th width="80">Store</th>
                        <th width="80">Floor</th>
                        <th width="100">Buyer & Job</th>
                        <th width="100">Cust. Buyer</th>
                        <th width="120">Order & Style</th>
                        <th>Inte. Ref & File</th>
                    </thead>
                    <?
                    $wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");

                    $cond = "";
                    if ($data[5] != "") $cond .= " and c.id='$data[5]'";

                    $po_array = array();
                    $job_array = array();


                    $costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.company_name=$data[0]");
                    foreach ($costing_sql as $row)
                    {
                        $po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
                        $po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
                        $po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
                        $po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
                        $job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
                        $job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];

						$job_intfarray[$row[csf('job_no')]]['grouping'] .= $row[csf('grouping')].',';
                    }

                    unset($costing_sql);

					$sales_order_array = array();
					$sales_order_sql = sql_select("select a.id,a.sales_booking_no, a.job_no,a.style_ref_no, a.buyer_id,b.job_no po_job_no,b.buyer_id po_buyer,a.within_group from fabric_sales_order_mst a left join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.status_active = 1 and a.is_deleted = 0 and a.company_id=$data[0]");
					foreach ($sales_order_sql as $row)
					{
						$sales_order_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
						$sales_order_array[$row[csf('id')]]['sales_order_no'] = $row[csf('job_no')];
						$sales_order_array[$row[csf('id')]]['po_job_no'] = $row[csf('po_job_no')];
						$sales_order_array[$row[csf('id')]]['sales_booking_no'] = $row[csf('sales_booking_no')];
						$sales_order_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
						$sales_order_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
						$sales_order_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
					}

					$sales_style_des_arr = array();
					$sales_samp_booking_sql = sql_select("SELECT b.booking_no, b.style_des FROM fabric_sales_order_mst a, wo_non_ord_samp_booking_dtls b WHERE a.sales_booking_no = b.booking_no and a.company_id=$data[0] and b.status_active=1 and b.is_deleted=0");
					foreach ($sales_samp_booking_sql as $row)
					{
						$sales_style_des_arr[$row[csf('booking_no')]]['style_des'] .= $row[csf('style_des')].',';
					}
					unset($sales_samp_booking_sql);

                    $stl_array = array();

                    $stl_sql = sql_select("select job_no, style_ref_no from wo_po_details_master");
                    foreach ($stl_sql as $row)
                    {
                        $stl_array[$row[csf('style_ref_no')]]['job'] = $row[csf('job_no')];
                    }
                    //var_dump($stl_array);
                    unset($stl_sql);

                    $job_no_array = array();
                    $jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id, po_buyer, customer_buyer from fabric_sales_order_mst");
                    foreach ($jobData as $row)
                    {
                        $job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
                        $job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
                        $job_no_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
                        $job_no_array[$row[csf('id')]]['customer_buyer'] = $row[csf('customer_buyer')];
                    }
                    //var_dump($po_array);
                    $po_id_req_array = array();
                    $is_sales_array = array();
                   /*  if ($db_type == 0)
					{
                        $poID = "SELECT c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, group_concat(distinct(a.po_id)) as poid,a.booking_no from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales,a.booking_no";
                    }
					else
					{
                        $poID = "SELECT c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid,a.booking_no from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales,a.booking_no";


                    } */
					if ($db_type == 0)
					{
                        $poID = " SELECT c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, group_concat(distinct(a.po_id)) as poid,a.booking_no from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id and c.requisition_no in(".implode(',', $req_no_arr).") group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales,a.booking_no";
                    }
					else
					{
                        $poID = "SELECT c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid,a.booking_no from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id and c.requisition_no in(".implode(',', $req_no_arr).") group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales,a.booking_no";
                    }
					//echo $poID;
                    $poID_sql_result = sql_select($poID);
					$smnBookingNoArr = array();
                    foreach ($poID_sql_result as $row)
					{
                        $po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
                        $is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];

						$program_array[$row[csf('requisition_no')]]['program_no'] = $row[csf('knit_id')];
						$program_array[$row[csf('requisition_no')]]['booking_no'] = $row[csf('booking_no')];
						$program_array[$row[csf('requisition_no')]]['poid'] = $row[csf('poid')];
						//$program_array[$row[csf('requisition_no')]]['buyer_id'] = $row[csf('buyer_id')];
						array_push($smnBookingNoArr,$row[csf('booking_no')]);
                    }
                    unset($poID_sql_result);

					if(!empty($smnBookingNoArr))
					{
						$i_ref_sql = "SELECT a.booking_no,b.internal_ref, b.buyer_name from SAMPLE_DEVELOPMENT_MST b, WO_NON_ORD_SAMP_BOOKING_DTLS a where b.id = a.style_id ".where_con_using_array($smnBookingNoArr, '1', 'a.booking_no')." group by a.booking_no,b.internal_ref, b.buyer_name";

						//echo $i_ref_sql;
						$i_sql_result = sql_select($i_ref_sql);
						// echo($i_ref_sql);
						$smIintRefCondArr = array();
						foreach($i_sql_result as $row=>$key)
						{
							$smIintRefCondArr[$key[csf('booking_no')]]['internal_ref'] = $key[csf('internal_ref')];
							$smIintRefCondArr[$key[csf('booking_no')]]['buyer_name'] = $key[csf('buyer_name')];
						}
						// echo $i_ref_sql;
						// print_r($int_ref);
						// die;
					}


                    $i = 1;
                    if ($db_type == 0) {
                        $sql_result = sql_select("SELECT a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose, b.floor_id,c.booking_id,b.booking_no as book_no
						from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id left join fabric_sales_order_mst e on d.po_breakdown_id=e.id
						where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
						group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose, b.floor_id,c.booking_id,b.booking_no order by b.requisition_no DESC");
                    } else {

                        $sql_result = sql_select("SELECT a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose, b.floor_id,c.booking_id,b.booking_no as book_no
                        from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id left join fabric_sales_order_mst e on d.po_breakdown_id=e.id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
                        group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose, b.floor_id,c.booking_id,b.booking_no  order by b.requisition_no DESC");

                    }
                    $all_req_no = '';
                    $all_prod_id = '';
                    $order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
                    $tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
                    foreach ($sql_result as $row)
					{
                        if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
                        if ($row[csf('requisition_no')] != '')
						{
                            if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
                            if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
                        }
                        $order_qnty_val = $row[csf('cons_quantity')];
                        $order_qnty_val_sum += $order_qnty_val;

                        $order_amount_val = $row[csf('order_amount')];
                        $order_amount_val_sum += $order_amount_val;

                        $no_of_bags_val = $row[csf('no_of_bags')];
                        $no_of_bags_val_sum += $no_of_bags_val;

                        $po_id = explode(",", $row[csf('po_id')]);
                        $po_no = '';
                        $style_ref = '';
                        $job_no = '';
                        $buyer = '';
                        //$data=explode('*',$data);
                        $productdtls = $row[csf('product_name_details')];
                        $productArr = explode(' ', $productdtls);

                        $proddtls='';
                        $proddtls=$yarn_count_details[$row[csf('yarn_count_id')]];
                        if($row[csf('yarn_count_id')]>0) $proddtls.=", ";
                        $proddtls.=$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."%";

                    /*if($row[csf('yarn_comp_type1st')]>0) $proddtls.=", ";
                    $proddtls.=$yarn_type[$row[csf('yarn_type')]];*/

                    /*if ($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' && $productArr[4]!=''&& $productArr[5]!='')
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].'%, '.$productArr[3].' '.$productArr[4]."%, ".$productArr[5].", ".$productArr[6];
                    }
                    else if ($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' && $productArr[4]!='')
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, '.$productArr[3].', '.$productArr[4];
                    }
                    else if($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' )
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, '.$productArr[3];
                    }
                    else if($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='')
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, ';
                    }
                    else if($productArr[0]!='' && $productArr[1]!='' )
                    {
                        $proddtls=$productArr[0].', '.$productArr[1];
                    }
                    else if($productArr[0]!='')
                    {
                        $proddtls=$productArr[0];
                    }
                    else
                    {
                        $proddtls='';
                    }*/

                    $internal_ref = '';
                    $style_ref = '';
                    $file_no = '';

                    if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
                    {
                        foreach ($po_id as $val)
                        {
							if($row[csf('is_sales')]==1)
							{
								if ($po_no== '') $po_no = $sales_order_array[$val]['sales_booking_no'];
								if ($style_ref == '') $style_ref = $sales_style_des_arr[$sales_order_array[$val]['sales_booking_no']]['style_des'];

								$po_job = $sales_order_array[$val]['po_job_no'];

								if ($internal_ref == '') $internal_ref = $job_intfarray[$po_job]['grouping']; else $internal_ref .= "," . $job_intfarray[$po_job]['grouping'];
							}
							else
							{
								if($po_array[$val]['no'] !='')
								{
									if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
									if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								}

								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];

							}

                            if ($job_no == '') $job_no = $po_array[$val]['job_no'];

                            if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                            if ($sales_booking_no== '') $sales_booking_no = $sales_order_array[$val]['sales_booking_no'];

                            if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                        }
                        $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                        $job_file = array_unique(explode(",", rtrim($file_no, ", ")));
                        $ref_cond = '';
                        foreach ($job_ref as $ref) {
                            //$ref_cond.=", ".$ref;
                            if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                        }
                        $file_con = '';
                        foreach ($job_file as $file) {
                            if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                        }

                        $buyer_job = '';
                        $buyer = '';
                        if ($row[csf('issue_basis')] == 1)
                        {

                            if ($dataArray[0][csf('issue_purpose')] == 8)
                            {
                                $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                            }
							else if ($dataArray[0][csf('issue_purpose')] == 2)
							{
								$book_no_data = explode('-',$row[csf('book_no')]);
								if($book_no_data[1] =='SMN')
								{
									if ($internal_ref == '') $internal_ref = $smn_info_arr[$row[csf('booking_id')]]['int_ref']; else $internal_ref .= "," . $smn_info_arr[$row[csf('booking_id')]]['int_ref'];
								}
								$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
								$ref_cond = '';
								foreach ($job_ref as $ref) {
									//$ref_cond.=", ".$ref;
									if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
								}
								if ($row[csf('buyer_job_no')] != "")
                                {
									if($row[csf('job_no')])
									{
                                       $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('job_no')];
                                       $buyer = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
									}
									else
									{
                                        $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
                                        $buyer = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
									}
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                                    $buyer = $buyer_arr[$row[csf('buyer_id')]];
                                }
							}
                            else
                            {
                                if ($row[csf('buyer_job_no')] != "")
                                {
									if($row[csf('job_no')])
									{
                                       $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('job_no')];
									}
									else
									{
                                        $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
									}
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                                }

                            }

                        }
                        else if ($row[csf('issue_basis')] == 2)
                        {
                            $buyer_job = '';
                        }
						if(!empty($row[csf('customer_buyer')]))
						{
							$customer_buyer = $buyer_arr[$row[csf('customer_buyer')]];
						}
						else
						{
                           $customer_buyer = $buyer_arr[$job_no_array[$row[csf('buyer_job_no')]]['customer_buyer']];
						}
                    }
					// else if ($row[csf('issue_basis')] == 1 && $row[csf('issue_purpose')] == 2)
                    // {

					// }
                    else if ($row[csf('issue_basis')] == 3)
                    {
                        if ($is_sales_array[$row[csf('requisition_no')]] == 1)
                        {
                            $buyer_job = '';
                            foreach (array_unique($po_id) as $val) {
                                if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
                                if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
                                $customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];

                                if ($buyer_job == '')
                                {
                                    if ($job_no_array[$val]['within_group'] == 1)
                                    {
                                        $buyer_data = $buyer_arr[$job_no_array[$val]['po_buyer']];
                                        $job_data = $stl_array[$job_no_array[$val]['style_ref']]['job'];
                                        $buyer_job = $buyer_data.' & '.$job_data;
                                    }
                                    else
                                    {
                                        $buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
                                    }
                                }
                            }
                        }
                        else
                        {
                            foreach ($po_id as $val)
                            {
                                if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
                                if ($job_no == '') $job_no = $po_array[$val]['job_no'];
                                if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
                                if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                                if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
                                if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                            }

                            $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                            $job_file = array_unique(explode(",", rtrim($file_no, ", ")));

                            $ref_cond = '';
                            foreach ($job_ref as $ref) {
                                //$ref_cond.=", ".$ref;
                                if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                            }

                            $file_con = '';
                            foreach ($job_file as $file) {
                                if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                            }
                            if ($job_no != '')
                            {
                                $buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
                            }
                            else
                            {
                                if(!empty($po_array[$val]['buyer_name']))
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                            }
                        }
                    }

                    else
                    {
						if(!empty($row[csf('po_id')]))
						{
							foreach (array_unique($po_id) as $val)
							{
								if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
								$customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];
								if ($buyer_job == '')
								{
									if ($job_no_array[$val]['within_group'] == 1)
									{

										$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
									}
									else
									{
										$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
									}
								}

								if ($is_sales_array[$row[csf('requisition_no')]] == 1)
								{
									$po_job = $sales_order_array[$val]['po_job_no'];

									 if ($internal_ref == '') $internal_ref = $job_intfarray[$po_job]['grouping']; else $internal_ref .= "," . $job_intfarray[$po_job]['grouping'];

								}
							}

							$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));

							$ref_cond = '';
							foreach ($job_ref as $ref)
							{
								if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
							}
						}else{

								$customer_buyer= $buyer_arr[$smIintRefCondArr[$program_array[$row[csf('requisition_no')]]['booking_no']]['buyer_name']];

								$ref_cond= $smIintRefCondArr[$program_array[$row[csf('requisition_no')]]['booking_no']]['internal_ref'];

						}

                    }

                    $no_bag_cone = "";
                    $wt_bag_cone = "";
                    if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

                    if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" style="font-size:15px">
                        <td width="20" style="font-size:15px"><? echo $i; ?></td>
                        <td width="45" style="font-size:15px">
                            <div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
                        </td>
                        <td width="50" style="font-size:15px">
                            <div style="word-wrap:break-word; width:50px"><? echo $program_array[$row[csf('requisition_no')]]['program_no']; ?></div>
                        </td>
                        <td width="50" style="font-size:15px">
                            <div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
                        </td>
                        <td width="65" style="font-size:15px">
                            <div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
                        </td>
                        <td width="110" style="font-size:15px">
                            <div style="word-wrap:break-word; width:110px">
                                <?
                                //echo $proddtls;
                                echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
                                ?>
                            </div>
                        </td>
                        <td width="65" style="font-size:15px">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('color')]]; ?></div>
                        </td>
                        <td width="65" style="font-size:15px">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
                        &nbsp;</div>
                    </td>
                    <td width="60" style="font-size:15px">
                        <div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
                    </td>
                    <td align="right"
                    width="60" style="font-size:15px"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
                    <td align="right"
                    width="60" style="font-size:15px"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
                    <td width="80" style="font-size:15px">
                        <div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
                    &nbsp;</div>
                </td>
                <td width="80" style="font-size:15px">
                    <div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
                </td>
				<td width="80" style="font-size:15px">
                    <div style="word-wrap:break-word; width:80px"><? echo $floor_room_rack_arr[$row[csf('floor_id')]]; ?></div>
                </td>
                <td width="100" style="font-size:15px">
                    <div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
                </td>
                <td width="100" style="font-size:14px">
                    <div style="word-wrap:break-word; width:100px">
						<? echo $customer_buyer ? $customer_buyer : $buyer; ?>
					</div>
                </td>
                <td width="120" style="font-size:15px">
                    <div style="word-wrap:break-word; width:120px"><? echo $po_no;
                    if ($style_ref != "") echo ' & ' . trim($style_ref,','); else echo '&nbsp;'; ?></div>
                </td>
                <td style="font-size:15px">
                    <div style="word-wrap:break-word; width:80px">
					<? 
					if($dataArray[0][csf('issue_purpose')] == 1)
					{
						if($dataArray[0][csf('knit_dye_source')] == 3)
						{
							echo "1";
						}
					}
					echo ltrim($ref_cond, ", ");

                    if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?></div>
                </td>
            </tr>
            <?
            $uom_unit = "Kg";
            $uom_gm = "Grams";
            $tot_return_qty += $row[csf('returnable_qnty')];
            $tot_bag += $no_of_bags_val;
            $tot_cone += $row[csf('cone_per_bag')];
            $tot_w_bag += $row[csf('weight_per_bag')];
            $tot_w_cone += $row[csf('weight_per_cone')];
            $req_no = $row[csf('requisition_no')];
            $i++;
        }
        ?>
        <tr bgcolor="#CCCCCC" >
            <td align="right" colspan="9" style="font-size:15px"><b>Total</b></td>
            <td align="right" style="font-size:14px">
                <b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
            </td>
            <td align="right" style="font-size:15px"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
            <td style="font-size:15px"><? echo 'N:' . number_format($tot_bag, 2);
            if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
            echo '<br>W:' . number_format($tot_w_bag, 2);
            if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
            <td align="right" colspan="6">&nbsp;</td>
        </tr>
        <tr>
            <td colspan="18" align="left" style="font-size:15px"><b>In
                Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
            </tr>
        </table>
    </div>
    <br>
    <!--================================================================-->
    <?


        echo "<br><br>";

        echo "<p style='font-size:15px'>Note: Received The Above in Goods Condition For Handling and Delivery.</p>";

        echo "<br><br><br><br><br><br><br><br>";

        //echo signature_table(49, $data[0], "1030px",'',0);
		echo signature_table(49, $data[0], "1030px",'',0,$user_id);
        ?>
    </div>
 </div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');
		</script>
		<p style="page-break-after: always;"> </p>

		<?
	}
	exit();
}

if ($action == "yarn_issue_print30")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);
	$print_with_vat = $data[7];
	$company=$data[0];
	$location=$data[8];
	$store_id=$data[9];

	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	//echo $store_location_id.'system';

	//$supplier_arr = return_library_array("select id, short_name from lib_supplier", 'id', 'short_name');
	$supplier_arr = return_library_array("select id,supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');
    //$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$floor_room_rack_arr = return_library_array("select floor_room_rack_id, floor_room_rack_name from lib_floor_room_rack_mst", 'floor_room_rack_id', 'floor_room_rack_name');

	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
    //echo $sql;die;
	$dataArray = sql_select($sql);
	//$demand_no = array();
	$demand_no = '';
	if( $dataArray[0][csf('issue_basis')]==3 || $dataArray[0][csf('issue_basis')]==8 )
	{
		$planbooking = sql_select("select a.id,b.requisition_no, e.booking_no as pln_booking_no, d.id, b.demand_no from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$data[5]'");

		//for demand no
		if( $dataArray[0][csf('issue_basis')]==8 )
		{
			foreach($planbooking as $row)
			{
				$demand_no = $row[csf('demand_no')];
			}
			$req_no_arr = array();
			foreach($planbooking as $row)
			{
				$req_no_arr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];
			}

			/* $req_sql_zs = sql_select("select a.demand_system_no from ppl_yarn_demand_entry_mst a, ppl_yarn_demand_entry_dtls b where a.id = b.mst_id and b.requisition_no in(".implode(',', $req_no_arr).")");
			foreach($req_sql_zs as $row)
			{
				$demand_no[$row[csf('demand_system_no')]] = $row[csf('demand_system_no')];
			} */
		}
	}
	else if( $dataArray[0][csf('issue_basis')]==1 || $dataArray[0][csf('issue_purpose')]==2 )
	{
		$booking_id = $dataArray[0][csf('booking_id')];
		$sql_smn = "SELECT a.mst_id,a.job_no_id,b.internal_ref from wo_yarn_dyeing_dtls a, sample_development_mst b where a.job_no_id=b.id and a.mst_id=$booking_id and a.status_active=1 and a.is_deleted=0 group by a.mst_id,a.job_no_id,b.internal_ref";
		//echo $sql_smn;
		$smn_info_arr = array();
		$sql_smn_res = sql_select($sql_smn);
		foreach ($sql_smn_res as $row)
		{
			$smn_info_arr[$row[csf('mst_id')]]['int_ref']=$row[csf('internal_ref')];
		}
		unset($sql_smn_res);
		//echo "<pre>";print_r($smn_info_arr);
	}


	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$copyNo = "";
	for ($x = 1; $x <= 1; $x++)
	{
		if($x==1)
		{
			$copyNo ="<span style='font-size:x-large;'>1<sup>st</sup> Copy</span>";
		} else if($x==2){
			$copyNo ="<span style='font-size:x-large;'>2<sup>nd</sup> Copy</span>";
		} else if($x==3){
			$copyNo ="<span style='font-size:x-large;'>3<sup>rd</sup> Copy</span>";
		} elseif($x==4)
		{
			$copyNo ="<span style='font-size:x-large;'>4<sup>th</sup> Copy</span>";
		}
		elseif($x==5)
		{
			$copyNo ="<span style='font-size:x-large;'>5<sup>th</sup> Copy</span>";
		}

		$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
		?>
		<div style="width:1150px;">
			<table width="1100" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td colspan="6" align="center" style="font-size:19px"></td>
					<td style="font-size:x-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">
					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="4" align="center">
						<strong style="font-size:19px"><? echo $com_dtls[0]; ?></strong><br>
						<?
						echo $com_dtls[1];
						?>
					</td>
					<td colspan="2" id="barcode_img_id">&nbsp;</td>
					<!-- <td colspan="3" style="color:black; font-weight:bold;"><? //echo $copyNo;?></td> -->
				</tr>
				<tr>
					<td colspan="6" align="center" style="font-size:17px"><strong><u>Yarn Delivery Challan/Gate
					Pass</u></strong></center></td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td width="160" style="font-size:15px"><strong>Issue No</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('issue_number')]; ?></td>
					<td width="120" style="font-size:15px"><strong>Booking</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;
						<?
						if( $dataArray[0][csf('issue_basis')]==3 || $dataArray[0][csf('issue_basis')]==8 )
						{
							$bookingNo = $planbooking[0][csf('pln_booking_no')];
							$challan_prog = $planbooking[0][csf('id')];
						}
						else
						{
							$bookingNo = $dataArray[0][csf('booking_no')];
							$challan_prog = $dataArray[0][csf('challan_no')];
						}
						echo $bookingNo;
						?>
					</td>
					<td width="125" style="font-size:15px"><strong>Knitting Source</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
				</tr>
				<tr>
					<td style="font-size:14px"><strong>Challan/Program No</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? echo $challan_prog; ?></td>
					<td style="font-size:15px"><strong>Issue Purpose</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
					echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
					?></td>
		<td style="font-size:15px"><strong>Issue Date</strong></td>
		<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
	</tr>
	<tr>
		<td style="font-size:15px"><strong>Issue To</strong></td>
		<?
		if ($dataArray[0][csf('knit_dye_source')] == 3)
		{
			$supp_add = $dataArray[0][csf('knit_dye_company')];
			$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
			foreach ($nameArray as $result) {
				$address = "";
							if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
						}
						unset($nameArray);
					}

					$loan_party_add = $dataArray[0][csf('loan_party')];
					$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
					foreach ($loanPartyArray as $result) {
						$addressParty = "";
						if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($loanPartyArray);
					?>
					<td colspan="3" style="font-size:15px"><strong>:</strong>&nbsp;
						<?
						if ($dataArray[0][csf('issue_purpose')] == 3) {
							echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
						} else if ($dataArray[0][csf('issue_purpose')] == 5) {
							echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
						} else {
							if ($dataArray[0][csf('knit_dye_source')] == 1)
								echo $company_library[$dataArray[0][csf('knit_dye_company')]];
							else
								echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
						}
						?>
					</td>
                    <td style="font-size:15px"><strong>Location</strong></td>
					<td style="font-size:15px"><strong>:</strong>&nbsp;<? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>
				</tr>
				<tr>
					<td style="font-size:15px"><strong>Demand No.</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? echo $demand_no; //implode(', ', $demand_no); ?></td>
					<td style="font-size:14px"><strong>Gate Pass No.</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('gate_pass_no')]; ?></td>
					<td style="font-size:14px"><strong>Do No</strong></td>
					<td width="175px" style="font-size:15px"><strong>:</strong>&nbsp;<? //echo $dataArray[0][csf('remarks')];
					?></td>
				</tr>
				<tr>
					<td valign="top" style="font-size:15px"><strong>Remarks</strong></td>
					<td colspan="5" style="font-size:15px"><strong>:</strong>&nbsp;<p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
				</tr>
				<?
				if ($print_with_vat == 1)
				{
					?>
					<tr>
						<td style="font-size:15px"><strong>VAT Number</strong></td>
						<td style="font-size:15px"><strong>:</strong>&nbsp;<p>
							<?
							$vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
							echo $vat_no;
							?>
                        </p></td>
                    </tr>
                    <?
                }
				else
				{
                    ?>
                    <tr>
                        <td valign="top">&nbsp;</strong></td>
                        <td>&nbsp;</td>
                    </tr>
                    <?
                }
                ?>
				<tr>
					<td><strong>Driver Name.</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;</td>
					<td><strong>Driver Mobile No.</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;</td>
					<td><strong>Vehicle No</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;</td>
				</tr>
            </table>
            <br><br><br><br>
            <div style="width:100%;">
                <div style="clear:both;">
                    <table style="margin-right:-40px;" cellspacing="0" width="1230" border="1" rules="all"
                    class="rpt_table" >
                    <thead bgcolor="#dddddd" style="font-size:15px">
                        <th width="20">SL</th>
                        <th width="45">Req. No</th>
                        <th width="50">Program No</th>
                        <th width="50">Lot No</th>
                        <th width="65">Y. Type</th>
                        <th width="110">Item Details</th>
                        <th width="65">Grey Color</th>
                        <th width="65">Dye. Color</th>
                        <th width="60">Supp.</th>
                        <th width="60"><b>Issue Qty(kg)</b></th>
                        <th width="60">Rtnbl Qty(kg)</th>
                        <th width="80">Bag & Cone</th>
                        <th width="80">Store</th>
                        <th width="80">Floor</th>
                        <th width="80">Room</th>
                        <th width="100">Buyer & Job</th>
                        <th width="100">Cust. Buyer</th>
                        <th width="120">Order & Style</th>
                        <th>Inte. Ref & File</th>
                    </thead>
                    <?
                    $wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");

                    $cond = "";
                    if ($data[5] != "") $cond .= " and c.id='$data[5]'";

                    $po_array = array();
                    $job_array = array();


                    $costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.company_name=$data[0]");
                    foreach ($costing_sql as $row)
                    {
                        $po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
                        $po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
                        $po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
                        $po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
                        $job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
                        $job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];

						$job_intfarray[$row[csf('job_no')]]['grouping'] .= $row[csf('grouping')].',';
                    }

                    unset($costing_sql);

					$sales_order_array = array();
					$sales_order_sql = sql_select("select a.id,a.sales_booking_no, a.job_no,a.style_ref_no, a.buyer_id,b.job_no po_job_no,b.buyer_id po_buyer,a.within_group from fabric_sales_order_mst a left join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.status_active = 1 and a.is_deleted = 0 and a.company_id=$data[0]");
					foreach ($sales_order_sql as $row)
					{
						$sales_order_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
						$sales_order_array[$row[csf('id')]]['sales_order_no'] = $row[csf('job_no')];
						$sales_order_array[$row[csf('id')]]['po_job_no'] = $row[csf('po_job_no')];
						$sales_order_array[$row[csf('id')]]['sales_booking_no'] = $row[csf('sales_booking_no')];
						$sales_order_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
						$sales_order_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
						$sales_order_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
					}

					$sales_style_des_arr = array();
					$sales_samp_booking_sql = sql_select("SELECT b.booking_no, b.style_des FROM fabric_sales_order_mst a, wo_non_ord_samp_booking_dtls b WHERE a.sales_booking_no = b.booking_no and a.company_id=$data[0] and b.status_active=1 and b.is_deleted=0");
					foreach ($sales_samp_booking_sql as $row)
					{
						$sales_style_des_arr[$row[csf('booking_no')]]['style_des'] .= $row[csf('style_des')].',';
					}
					unset($sales_samp_booking_sql);

                    $stl_array = array();

                    $stl_sql = sql_select("select job_no, style_ref_no from wo_po_details_master");
                    foreach ($stl_sql as $row)
                    {
                        $stl_array[$row[csf('style_ref_no')]]['job'] = $row[csf('job_no')];
                    }
                    //var_dump($stl_array);
                    unset($stl_sql);

                    $job_no_array = array();
                    $jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id, po_buyer, customer_buyer from fabric_sales_order_mst");
                    foreach ($jobData as $row)
                    {
                        $job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
                        $job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
                        $job_no_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
                        $job_no_array[$row[csf('id')]]['customer_buyer'] = $row[csf('customer_buyer')];
                    }
                    //var_dump($po_array);
                    $po_id_req_array = array();
                    $is_sales_array = array();
                   /*  if ($db_type == 0)
					{
                        $poID = "SELECT c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, group_concat(distinct(a.po_id)) as poid,a.booking_no from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales,a.booking_no";
                    }
					else
					{
                        $poID = "SELECT c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid,a.booking_no from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales,a.booking_no";


                    } */
					if ($db_type == 0)
					{
                        $poID = " SELECT c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, group_concat(distinct(a.po_id)) as poid,a.booking_no from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id and c.requisition_no in(".implode(',', $req_no_arr).") group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales,a.booking_no";
                    }
					else
					{
                        $poID = "SELECT c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid,a.booking_no from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id and c.requisition_no in(".implode(',', $req_no_arr).") group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales,a.booking_no";
                    }
					//echo $poID;
                    $poID_sql_result = sql_select($poID);
					$smnBookingNoArr = array();
                    foreach ($poID_sql_result as $row)
					{
                        $po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
                        $is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];

						$program_array[$row[csf('requisition_no')]]['program_no'] = $row[csf('knit_id')];
						$program_array[$row[csf('requisition_no')]]['booking_no'] = $row[csf('booking_no')];
						$program_array[$row[csf('requisition_no')]]['poid'] = $row[csf('poid')];
						//$program_array[$row[csf('requisition_no')]]['buyer_id'] = $row[csf('buyer_id')];
						array_push($smnBookingNoArr,$row[csf('booking_no')]);
                    }
                    unset($poID_sql_result);

					if(!empty($smnBookingNoArr))
					{
						$i_ref_sql = "SELECT a.booking_no,b.internal_ref, b.buyer_name from SAMPLE_DEVELOPMENT_MST b, WO_NON_ORD_SAMP_BOOKING_DTLS a where b.id = a.style_id ".where_con_using_array($smnBookingNoArr, '1', 'a.booking_no')." group by a.booking_no,b.internal_ref, b.buyer_name";

						//echo $i_ref_sql;
						$i_sql_result = sql_select($i_ref_sql);
						// echo($i_ref_sql);
						$smIintRefCondArr = array();
						foreach($i_sql_result as $row=>$key)
						{
							$smIintRefCondArr[$key[csf('booking_no')]]['internal_ref'] = $key[csf('internal_ref')];
							$smIintRefCondArr[$key[csf('booking_no')]]['buyer_name'] = $key[csf('buyer_name')];
						}
						// echo $i_ref_sql;
						// print_r($int_ref);
						// die;
					}


                    $i = 1;
                    if ($db_type == 0) {
                        $sql_result = sql_select("SELECT a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose, b.floor_id,b.room,c.booking_id,b.booking_no as book_no
						from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id left join fabric_sales_order_mst e on d.po_breakdown_id=e.id
						where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
						group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose, b.floor_id,b.room,c.booking_id,b.booking_no order by b.requisition_no DESC");
                    } else {

                        $sql_result = sql_select("SELECT a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose, b.floor_id,b.room, c.booking_id,b.booking_no as book_no
                        from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id left join fabric_sales_order_mst e on d.po_breakdown_id=e.id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
                        group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,c.issue_purpose, b.floor_id, b.room, c.booking_id,b.booking_no  order by b.requisition_no DESC");

                    }
                    $all_req_no = '';
                    $all_prod_id = '';
                    $order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
                    $tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
                    foreach ($sql_result as $row)
					{
                        if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
                        if ($row[csf('requisition_no')] != '')
						{
                            if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
                            if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
                        }
                        $order_qnty_val = $row[csf('cons_quantity')];
                        $order_qnty_val_sum += $order_qnty_val;

                        $order_amount_val = $row[csf('order_amount')];
                        $order_amount_val_sum += $order_amount_val;

                        $no_of_bags_val = $row[csf('no_of_bags')];
                        $no_of_bags_val_sum += $no_of_bags_val;

                        $po_id = explode(",", $row[csf('po_id')]);
                        $po_no = '';
                        $style_ref = '';
                        $job_no = '';
                        $buyer = '';
                        //$data=explode('*',$data);
                        $productdtls = $row[csf('product_name_details')];
                        $productArr = explode(' ', $productdtls);

                        $proddtls='';
                        $proddtls=$yarn_count_details[$row[csf('yarn_count_id')]];
                        if($row[csf('yarn_count_id')]>0) $proddtls.=", ";
                        $proddtls.=$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."%";

                    /*if($row[csf('yarn_comp_type1st')]>0) $proddtls.=", ";
                    $proddtls.=$yarn_type[$row[csf('yarn_type')]];*/

                    /*if ($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' && $productArr[4]!=''&& $productArr[5]!='')
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].'%, '.$productArr[3].' '.$productArr[4]."%, ".$productArr[5].", ".$productArr[6];
                    }
                    else if ($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' && $productArr[4]!='')
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, '.$productArr[3].', '.$productArr[4];
                    }
                    else if($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='' && $productArr[3]!='' )
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, '.$productArr[3];
                    }
                    else if($productArr[0]!='' && $productArr[1]!='' && $productArr[2]!='')
                    {
                        $proddtls=$productArr[0].', '.$productArr[1].' '.$productArr[2].' %, ';
                    }
                    else if($productArr[0]!='' && $productArr[1]!='' )
                    {
                        $proddtls=$productArr[0].', '.$productArr[1];
                    }
                    else if($productArr[0]!='')
                    {
                        $proddtls=$productArr[0];
                    }
                    else
                    {
                        $proddtls='';
                    }*/

                    $internal_ref = '';
                    $style_ref = '';
                    $file_no = '';

                    if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
                    {
                        foreach ($po_id as $val)
                        {
							if($row[csf('is_sales')]==1)
							{
								if ($po_no== '') $po_no = $sales_order_array[$val]['sales_booking_no'];
								if ($style_ref == '') $style_ref = $sales_style_des_arr[$sales_order_array[$val]['sales_booking_no']]['style_des'];

								$po_job = $sales_order_array[$val]['po_job_no'];

								if ($internal_ref == '') $internal_ref = $job_intfarray[$po_job]['grouping']; else $internal_ref .= "," . $job_intfarray[$po_job]['grouping'];
							}
							else
							{
								if($po_array[$val]['no'] !='')
								{
									if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
									if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								}

								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];

							}

                            if ($job_no == '') $job_no = $po_array[$val]['job_no'];

                            if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                            if ($sales_booking_no== '') $sales_booking_no = $sales_order_array[$val]['sales_booking_no'];

                            if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                        }
                        $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                        $job_file = array_unique(explode(",", rtrim($file_no, ", ")));
                        $ref_cond = '';
                        foreach ($job_ref as $ref) {
                            //$ref_cond.=", ".$ref;
                            if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                        }
                        $file_con = '';
                        foreach ($job_file as $file) {
                            if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                        }

                        $buyer_job = '';
                        $buyer = '';
                        if ($row[csf('issue_basis')] == 1)
                        {

                            if ($dataArray[0][csf('issue_purpose')] == 8)
                            {
                                $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                            }
							else if ($dataArray[0][csf('issue_purpose')] == 2)
							{
								$book_no_data = explode('-',$row[csf('book_no')]);
								if($book_no_data[1] =='SMN')
								{
									if ($internal_ref == '') $internal_ref = $smn_info_arr[$row[csf('booking_id')]]['int_ref']; else $internal_ref .= "," . $smn_info_arr[$row[csf('booking_id')]]['int_ref'];
								}
								$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
								$ref_cond = '';
								foreach ($job_ref as $ref) {
									//$ref_cond.=", ".$ref;
									if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
								}
								if ($row[csf('buyer_job_no')] != "")
                                {
									if($row[csf('job_no')])
									{
                                       $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('job_no')];
                                       $buyer = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
									}
									else
									{
                                        $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
                                        $buyer = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
									}
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                                    $buyer = $buyer_arr[$row[csf('buyer_id')]];
                                }
							}
                            else
                            {
                                if ($row[csf('buyer_job_no')] != "")
                                {
									if($row[csf('job_no')])
									{
                                       $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('job_no')];
									}
									else
									{
                                        $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
									}
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                                }

                            }

                        }
                        else if ($row[csf('issue_basis')] == 2)
                        {
                            $buyer_job = '';
                        }
						if(!empty($row[csf('customer_buyer')]))
						{
							$customer_buyer = $buyer_arr[$row[csf('customer_buyer')]];
						}
						else
						{
                           $customer_buyer = $buyer_arr[$job_no_array[$row[csf('buyer_job_no')]]['customer_buyer']];
						}
                    }
					// else if ($row[csf('issue_basis')] == 1 && $row[csf('issue_purpose')] == 2)
                    // {

					// }
                    else if ($row[csf('issue_basis')] == 3)
                    {
                        if ($is_sales_array[$row[csf('requisition_no')]] == 1)
                        {
                            $buyer_job = '';
                            foreach (array_unique($po_id) as $val) {
                                if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
                                if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
                                $customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];

                                if ($buyer_job == '')
                                {
                                    if ($job_no_array[$val]['within_group'] == 1)
                                    {
                                        $buyer_data = $buyer_arr[$job_no_array[$val]['po_buyer']];
                                        $job_data = $stl_array[$job_no_array[$val]['style_ref']]['job'];
                                        $buyer_job = $buyer_data.' & '.$job_data;
                                    }
                                    else
                                    {
                                        $buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
                                    }
                                }
                            }
                        }
                        else
                        {
                            foreach ($po_id as $val)
                            {
                                if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
                                if ($job_no == '') $job_no = $po_array[$val]['job_no'];
                                if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
                                if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                                if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
                                if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                            }

                            $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                            $job_file = array_unique(explode(",", rtrim($file_no, ", ")));

                            $ref_cond = '';
                            foreach ($job_ref as $ref) {
                                //$ref_cond.=", ".$ref;
                                if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                            }

                            $file_con = '';
                            foreach ($job_file as $file) {
                                if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                            }
                            if ($job_no != '')
                            {
                                $buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
                            }
                            else
                            {
                                if(!empty($po_array[$val]['buyer_name']))
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                            }
                        }
                    }

                    else
                    {
						if(!empty($row[csf('po_id')]))
						{
							foreach (array_unique($po_id) as $val)
							{
								if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
								$customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];
								if ($buyer_job == '')
								{
									if ($job_no_array[$val]['within_group'] == 1)
									{

										$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
									}
									else
									{
										$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
									}
								}

								if ($is_sales_array[$row[csf('requisition_no')]] == 1)
								{
									$po_job = $sales_order_array[$val]['po_job_no'];

									 if ($internal_ref == '') $internal_ref = $job_intfarray[$po_job]['grouping']; else $internal_ref .= "," . $job_intfarray[$po_job]['grouping'];

								}
							}

							$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));

							$ref_cond = '';
							foreach ($job_ref as $ref)
							{
								if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
							}
						}else{

								$customer_buyer= $buyer_arr[$smIintRefCondArr[$program_array[$row[csf('requisition_no')]]['booking_no']]['buyer_name']];

								$ref_cond= $smIintRefCondArr[$program_array[$row[csf('requisition_no')]]['booking_no']]['internal_ref'];

						}

                    }

                    $no_bag_cone = "";
                    $wt_bag_cone = "";
                    if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

                    if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" style="font-size:15px">
                        <td width="20" style="font-size:15px"><? echo $i; ?></td>
                        <td width="45" style="font-size:15px">
                            <div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
                        </td>
                        <td width="50" style="font-size:15px">
                            <div style="word-wrap:break-word; width:50px"><? echo $program_array[$row[csf('requisition_no')]]['program_no']; ?></div>
                        </td>
                        <td width="50" style="font-size:15px">
                            <div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
                        </td>
                        <td width="65" style="font-size:15px">
                            <div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
                        </td>
                        <td width="110" style="font-size:15px">
                            <div style="word-wrap:break-word; width:110px">
                                <?
                                //echo $proddtls;
                                echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
                                ?>
                            </div>
                        </td>
                        <td width="65" style="font-size:15px">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('color')]]; ?></div>
                        </td>
                        <td width="65" style="font-size:15px">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
                        &nbsp;</div>
                    </td>
                    <td width="60" style="font-size:15px">
                        <div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
                    </td>
                    <td align="right"
                    width="60" style="font-size:15px"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
                    <td align="right"
                    width="60" style="font-size:15px"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
                    <td width="80" style="font-size:15px">
                        <div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
                    &nbsp;</div>
                </td>
                <td width="80" style="font-size:15px">
                    <div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
                </td>
				<td width="80" style="font-size:15px">
                    <div style="word-wrap:break-word; width:80px"><? echo $floor_room_rack_arr[$row[csf('floor_id')]]; ?></div>
                </td>
				<td width="80" style="font-size:15px">
                    <div style="word-wrap:break-word; width:80px"><? echo $floor_room_rack_arr[$row[csf('room')]]; ?></div>
                </td>
                <td width="100" style="font-size:15px">
                    <div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
                </td>
                <td width="100" style="font-size:14px">
                    <div style="word-wrap:break-word; width:100px">
						<? echo $customer_buyer ? $customer_buyer : $buyer; ?>
					</div>
                </td>
                <td width="120" style="font-size:15px">
                    <div style="word-wrap:break-word; width:120px"><? echo $po_no;
                    if ($style_ref != "") echo ' & ' . trim($style_ref,','); else echo '&nbsp;'; ?></div>
                </td>
                <td style="font-size:15px">
                    <div style="word-wrap:break-word; width:80px">
					<? echo ltrim($ref_cond, ", ");

                    if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?></div>
                </td>
            </tr>
            <?
            $uom_unit = "Kg";
            $uom_gm = "Grams";
            $tot_return_qty += $row[csf('returnable_qnty')];
            $tot_bag += $no_of_bags_val;
            $tot_cone += $row[csf('cone_per_bag')];
            $tot_w_bag += $row[csf('weight_per_bag')];
            $tot_w_cone += $row[csf('weight_per_cone')];
            $req_no = $row[csf('requisition_no')];
            $i++;
        }
        ?>
        <tr bgcolor="#CCCCCC" >
            <td align="right" colspan="9" style="font-size:15px"><b>Total</b></td>
            <td align="right" style="font-size:14px">
                <b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
            </td>
            <td align="right" style="font-size:15px"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
            <td style="font-size:15px"><? echo 'N:' . number_format($tot_bag, 2);
            if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
            echo '<br>W:' . number_format($tot_w_bag, 2);
            if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
            <td align="right" colspan="7">&nbsp;</td>
        </tr>
        <tr>
            <td colspan="19" align="left" style="font-size:15px"><b>In
                Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
            </tr>
        </table>
    </div>
    <br>
    <!--================================================================-->
    <?


        echo "<br><br>";

        echo "<p style='font-size:15px'>Note: Received The Above in Goods Condition For Handling and Delivery.</p>";

        echo "<br><br><br><br><br><br><br><br>";

        //echo signature_table(49, $data[0], "1030px",'',0);
		echo signature_table(49, $data[0], "1030px",'',0,$user_id);
        ?>
    </div>
 </div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');
		</script>
		<p style="page-break-after: always;"> </p>

		<?
	}
	exit();
}

if ($action == "requisition_print")
{
	extract($_REQUEST);
	$data = explode('_', $data);

	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$color_library = return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$yarn_count_details = return_library_array("select id,yarn_count from lib_yarn_count", "id", "yarn_count");
	$brand_details = return_library_array("select id, brand_name from lib_brand", "id", "brand_name");
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", "id", "short_name");

	$order_id = str_replace("'", "", $hide_order_id);
	$company_name = $cbo_company_id;

	$po_array = array();
	$costing_sql = sql_select("select a.job_no, a.style_ref_no,b.file_no,b.grouping a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0]");
	foreach ($costing_sql as $row) {
		$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
		$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
		$po_array[$row[csf('id')]]['buyer_name'] = $buyer_arr[$row[csf('buyer_name')]];

		$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
		$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
	}

	$product_details_arr = array();
	$pro_sql = sql_select("select id, yarn_count_id, lot, color, brand from product_details_master where company_id=$data[0] and item_category_id=1");
	foreach ($pro_sql as $row) {
		$product_details_arr[$row[csf('id')]]['count'] = $yarn_count_details[$row[csf('yarn_count_id')]];
		$product_details_arr[$row[csf('id')]]['lot'] = $row[csf('lot')];
		$product_details_arr[$row[csf('id')]]['color'] = $color_library[$row[csf('color')]];
		$product_details_arr[$row[csf('id')]]['brand'] = $brand_details[$row[csf('brand')]];
	}
			//var_dump($product_details_arr);
	$reqsn_details_arr = array();
	$sql = sql_select("select prod_id, requisition_no, sum(yarn_demand_qnty) as demand_qnty from ppl_yarn_demand_reqsn_dtls group by prod_id, requisition_no");
	foreach ($sql as $row) {
		$reqsn_details_arr[$row[csf('prod_id')]][$row[csf('requisition_no')]] = $row[csf('demand_qnty')];
	}
	?>
	<div>
		<label><strong>Bar Code:</strong></label><label id="barcode_img_id"></label>
		<br> <br>
		<table id="" cellspacing="0" cellpadding="0" border="1" rules="all" width="1140" class="rpt_table">
			<thead bgcolor="#dddddd" align="center">
				<tr>
					<th colspan="13">Requisition Details</th>
				</tr>
				<tr>
					<th width="30">SL</th>
					<th width="60">Buyer</th>
					<th width="130">Order No</th>
					<th width="100">Internal Ref & File No</th>
					<th width="70">Reqsn. No.</th>
					<th width="70">Yarn Count</th>
					<th width="100">Yarn Brand</th>
					<th width="100">Lot No</th>
					<th width="100">Color</th>
					<th width="80">Reqsn. Qty</th>
					<th width="80">Demand Qty</th>
					<th width="80">Delivery Qty</th>
					<th width="80">Balance Qty</th>
				</tr>
			</thead>
		</table>
		<div style="width:1157px;" id="scroll_body">
			<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1140" class="rpt_table"
			id="table_body">
			<tbody>
				<?
				$i = 1;
				$tot_reqsn_qnty = 0;
				$tot_demand_qnty = 0;
				$tot_delivery_qnty = 0;
				$tot_balance = 0;
				if ($db_type == 0) {
					$sql = "select c.id, c.requisition_no as reqs_no, c.prod_id, c.no_of_cone, c.yarn_qnty as reqsn_qnty, group_concat(distinct(a.po_id)) as po_id from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id and c.requisition_no in ($data[1]) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by c.id, c.requisition_no, c.prod_id, c.no_of_cone, c.yarn_qnty order by c.requisition_no";
				} else {
					$sql = "select c.id, c.requisition_no as reqs_no, c.prod_id, c.no_of_cone, c.yarn_qnty as reqsn_qnty, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as po_id from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id and c.requisition_no in ($data[1]) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by c.id, c.requisition_no, c.prod_id, c.no_of_cone, c.yarn_qnty order by c.requisition_no";
				}
						//echo $sql;
				$nameArray = sql_select($sql);
				foreach ($nameArray as $row) {
					if ($i % 2 == 0)
						$bgcolor = "#E9F3FF";
					else
						$bgcolor = "#FFFFFF";

					$yarn_iss_data = sql_select("select sum(b.cons_quantity) as delivery_qnty, sum(b.no_of_bags) as no_of_bags from inv_issue_master a, inv_transaction b where a.id=b.mst_id and a.issue_basis=3 and a.item_category=1 and a.entry_form=3 and b.receive_basis=3 and b.transaction_type=2 and b.item_category=1 and b.requisition_no=" . $row[csf('reqs_no')] . " and b.prod_id=" . $row[csf('prod_id')] . " and b.status_active=1 and b.is_deleted=0");

					$delivery_qnty = $yarn_iss_data[0][csf('delivery_qnty')];
					$no_of_bags = $yarn_iss_data[0][csf('no_of_bags')];

					$demand_qnty = $reqsn_details_arr[$row[csf('prod_id')]][$row[csf('reqs_no')]];
					$balance_qnty = $row[csf('reqsn_qnty')] - $delivery_qnty;

					$po_id = array_unique(explode(",", $row[csf('po_id')]));
					$po_no = '';
					$buyer = '';
					$internal_ref = '';
					$file_no = '';

					foreach ($po_id as $val) {
						if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
						if ($buyer == '') $buyer = $po_array[$val]['buyer_name'];

						if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= ", " . $po_array[$val]['grouping'];
						if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= ", " . $po_array[$val]['file_no'];

					}
					$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
					$job_file = array_unique(explode(",", rtrim($file_no, ", ")));
					$ref_cond = '';
					foreach ($job_ref as $ref) {
						if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
								//$ref_cond.=", ".$ref;
					}
					$file_con = '';
					foreach ($job_file as $file) {
						if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
					}

					?>
					<tr bgcolor="<? echo $bgcolor; ?>"
						onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')"
						id="tr_<? echo $i; ?>">
						<td width="30"><? echo $i; ?></td>
						<td width="60"><p><? echo $buyer; ?></p></td>
						<td width="130"><p><? echo $po_no; ?></p></td>
						<td width="100">
							<p><? echo ltrim($ref_cond, ", ") . '<br>' . ltrim($file_no_cond, ", "); ?></p></td>

							<td width="70" align="center"><? echo $row[csf('reqs_no')]; ?></td>
							<td width="70"><p><? echo $product_details_arr[$row[csf('prod_id')]]['count']; ?></p>
							</td>
							<td width="100"><? echo $product_details_arr[$row[csf('prod_id')]]['brand']; ?></td>
							<td width="100"><p><? echo $product_details_arr[$row[csf('prod_id')]]['lot']; ?></p>
							</td>
							<td width="100"><p><? echo $product_details_arr[$row[csf('prod_id')]]['color']; ?></p>
							</td>
							<td align="right" width="80"><? echo number_format($row[csf('reqsn_qnty')], 2); ?></td>
							<td align="right" width="80"><? echo number_format($demand_qnty, 2); ?></td>
							<td align="right" width="80"><? echo number_format($delivery_qnty, 2); ?></td>
							<td align="right" width="80"><? echo number_format($balance_qnty, 2); ?></td>

						</tr>
						<?
						$tot_reqsn_qnty += $row[csf('reqsn_qnty')];
						$tot_demand_qnty += $demand_qnty;
						$tot_delivery_qnty += $delivery_qnty;
						$tot_balance += $balance_qnty;

						$i++;
					}
					?>
				</tbody>
			</table>
			<table class="rpt_table" width="1140" id="report_table_footer" cellpadding="0" cellspacing="0"
			border="1" rules="all">
			<tfoot>
				<th width="30">&nbsp;</th>
				<th width="60">&nbsp;</th>
				<th width="130">&nbsp;</th>
				<th width="100">&nbsp;</th>
				<th width="70">&nbsp;</th>
				<th width="70">&nbsp;</th>
				<th width="100">&nbsp;</th>
				<th width="100">&nbsp;</th>
				<th width="100" align="right">Total</th>
				<th width="80" align="right"
				id="value_tot_reqsn_qnty"><? echo number_format($tot_reqsn_qnty, 2, '.', ''); ?></th>
				<th width="80" align="right"
				id="value_tot_demand_qnty"><? echo number_format($tot_demand_qnty, 2, '.', ''); ?></th>
				<th width="80" align="right" id="value_tot_delivery_qnty">
					<b><? echo number_format($tot_delivery_qnty, 2, '.', ''); ?></b></th>
					<th width="80" align="right"
					id="value_tot_balance"><? echo number_format($tot_balance, 2, '.', ''); ?></th>
				</tfoot>
			</table>
		</div>
	</div>

	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		function generateBarcode(valuess) {
                    var value = valuess;//$("#barcodeValue").val();
                    var btype = 'code39';//$("input[name=btype]:checked").val();
                    var renderer = 'bmp';// $("input[name=renderer]:checked").val();
                    var settings = {
                    	output: renderer,
                    	bgColor: '#FFFFFF',
                    	color: '#000000',
                    	barWidth: 1,
                    	barHeight: 30,
                    	moduleSize: 5,
                    	posX: 10,
                    	posY: 20,
                    	addQuietZone: 1
                    };
                    //$("#barcode_img_id").html('11');
                    value = {code: value, rect: false};
                    $("#barcode_img_id").show().barcode(value, btype, settings);
                }
                generateBarcode('<? echo $data[2]; ?>');
            </script>
            <?
            exit();
}


if ($action == "btb_selection_popup")
{
	echo load_html_head_contents("Popup Info", "../../", 1, 1, $unicode);
	extract($_REQUEST);
	$supplier_arr = return_library_array("select id,supplier_name from lib_supplier", 'id', 'supplier_name');
	$company_arr = return_library_array("select id,company_name from lib_company", 'id', 'company_name');
	if ($update_id_mst > 0) $mst_cond = " and mst_id <> $update_id_mst";
	$issue_qnty_arr = return_library_array("select btb_lc_id, sum(cons_quantity) as issue_qnty from inv_transaction where item_category=1 and transaction_type=2 and status_active=1 and is_deleted=0 and btb_lc_id>0 $mst_cond group by btb_lc_id", 'btb_lc_id', 'issue_qnty');
	$suplier_cond = "";
	if ($supplier > 0) $suplier_cond = " and d.supplier_id=$supplier and b.supplier_id=$supplier";
	$sql = "select d.id, d.lc_number, d.importer_id, d.lc_date, d.last_shipment_date, d.supplier_id, sum(a.quantity) as lc_qnty
	from product_details_master p, inv_transaction b, com_pi_item_details a, com_btb_lc_pi c, com_btb_lc_master_details d
	where p.id=b.prod_id and b.pi_wo_batch_no=a.pi_id and a.pi_id=c.pi_id and c.com_btb_lc_master_details_id=d.id and b.item_category = 1 and p.item_category_id=1 and b.receive_basis = 1 and b.transaction_type=1 and p.lot='$lot_no' and p.company_id=$comany_name and b.company_id=$comany_name $suplier_cond
	group by d.id, d.lc_number, d.importer_id, d.lc_date, d.last_shipment_date, d.supplier_id";
	//echo $sql;
	?>
	<script>
		function js_set_value(data) {
			var splitSTR = data.split("**");
			var id = splitSTR[0];
			var lc_number = splitSTR[1];

			$("#hidden_btb_id").val(id);
			$("#hidden_btb_lc_no").val(lc_number);
			parent.emailwindow.hide();
		}
	</script>
	<form name="searchorderfrm_1" id="searchorderfrm_1" autocomplete="off">
		<table width="900" cellspacing="0" cellpadding="0" border="1" class="rpt_table" align="center"
		rules="all">
		<thead>
			<tr>
				<th width="30">SL</th>
				<th width="120">LC NO.</th>
				<th width="140">Importer</th>
				<th width="140">Supplier Name</th>
				<th width="80">LC Date</th>
				<th width="80">Last Shipment Date</th>
				<th width="100">LC Qty</th>
				<th width="100">Cumulative Issue Qty</th>
				<th>Balance Qty</th>
			</tr>
		</thead>
		<tbody>
			<? $nameArray = sql_select($sql);
			$i = 1;
			foreach ($nameArray as $row) {
				if ($i % 2 == 0)
					$bgcolor = "#E9F3FF";
				else
					$bgcolor = "#FFFFFF";
				$issue_balance = $row[csf('lc_qnty')] - $issue_qnty_arr[$row[csf('id')]];
				?>
				<tr bgcolor="<? echo $bgcolor; ?>"
					onClick="js_set_value('<? echo $row[csf('id')] . '**' . $row[csf('lc_number')]; ?>')"
					id="tr_<? echo $i; ?>" style=" cursor: pointer;">
					<td><? echo $i; ?></td>
					<td><? echo $row[csf('lc_number')] ?></td>
					<td><? echo $company_arr[$row[csf('importer_id')]]; ?></td>
					<td><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></td>
					<td><? echo ($row[csf('lc_date')] != "") ? date("d-m-Y", strtotime($row[csf('lc_date')])) : ""; ?></td>
					<td><? echo date("d-m-Y", strtotime($row[csf('last_shipment_date')])); ?></td>
					<td align="right"><? echo number_format($row[csf('lc_qnty')], 2); ?></td>
					<td align="right"><? echo number_format($issue_qnty_arr[$row[csf('id')]], 2); ?></td>
					<td align="right"><? echo number_format($issue_balance, 2); ?></td>
				</tr>
				<?
				$i++;
			} ?>
		</tbody>
		<tfoot>
			<input type="hidden" id="hidden_btb_id" value="">
			<input type="hidden" id="hidden_btb_lc_no" value="">
		</tfoot>

	</table>
	</form>
	<?
}

if ($action == "yarn_issue_print14")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);
	$print_with_vat = $data[7];
	$company=$data[0];
	$location=$data[8];
	$store_id=$data[9];

	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	//echo $store_location_id.'system';

	//$supplier_arr = return_library_array("select id, short_name from lib_supplier", 'id', 'short_name');
	$supplier_arr = return_library_array("select id,supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
	$buyer_name_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');
    //$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
    //echo $sql;die;
	$dataArray = sql_select($sql);
	$demand_no = array();
	if( $dataArray[0][csf('issue_basis')]==3 || $dataArray[0][csf('issue_basis')]==8 )
	{
		$planbooking = sql_select("select b.requisition_no, e.booking_no as pln_booking_no, d.id from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$data[5]'");

		//for demand no
		if( $dataArray[0][csf('issue_basis')]==8 )
		{
			$req_no_arr = array();
			foreach($planbooking as $row)
			{
				$req_no_arr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];
			}

			$req_sql_zs = sql_select("select a.demand_system_no from ppl_yarn_demand_entry_mst a, ppl_yarn_demand_entry_dtls b where a.id = b.mst_id and b.requisition_no in(".implode(',', $req_no_arr).")");
			foreach($req_sql_zs as $row)
			{
				$demand_no[$row[csf('demand_system_no')]] = $row[csf('demand_system_no')];
			}
		}
	}

	$sql_gate_pass = sql_select("SELECT id, issue_id, sys_number from inv_gate_pass_mst where status_active=1 and is_deleted=0 and (is_gate_out!=1 or is_gate_out is null) and issue_id= '$data[5]' ");
	//echo $sql_gate_pass;
	$issueInfoArr = array();
	foreach($sql_gate_pass as $row)
	{
		$issueInfoArr[$row[csf('issue_id')]]['gate_pass_no'] = $row[csf('sys_number')];
		$check_issue_id_arr[] = $row[csf('issue_id')];
	}


	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$copyNo = "";
	for ($x = 1; $x <= 3; $x++)
	{
		if($x==1)
		{
			$copyNo ="<span style='font-size:x-large;'>1<sup>st</sup> Copy</span>";
		} else if($x==2){
			$copyNo ="<span style='font-size:x-large;'>2<sup>nd</sup> Copy</span>";
		} else {
			$copyNo ="<span style='font-size:x-large;'>3<sup>rd</sup> Copy</span>";
		}

		$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
		?>
		<div style="width:1150px;">
			<table width="1100" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td colspan="6" align="center" style="font-size:18px"></td>
					<td style="font-size:x-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">
					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="4" align="center">
						<strong style="font-size:18px"><? echo $com_dtls[0]; ?></strong><br>
						<?
						echo $com_dtls[1];
						?>
					</td>
					<td colspan="2" id="barcode_img_id">&nbsp;</td>
					<td colspan="3" style="color:black; font-weight:bold;"><? echo $copyNo;?></td>
				</tr>
				<tr>
					<td colspan="6" align="center" style="font-size:16px"><strong><u>Yarn Delivery Challan/Gate
					Pass</u></strong></center></td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td width="160"><strong>Issue No</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? echo $dataArray[0][csf('issue_number')]; ?></td>
					<td width="120"><strong>Booking</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;
						<?
						if( $dataArray[0][csf('issue_basis')]==3 || $dataArray[0][csf('issue_basis')]==8 )
						{
							$bookingNo = $planbooking[0][csf('pln_booking_no')];
							$challan_prog = $planbooking[0][csf('id')];
						}
						else
						{
							$bookingNo = $dataArray[0][csf('booking_no')];
							$challan_prog = $dataArray[0][csf('challan_no')];
						}
						echo $bookingNo;
						?>
					</td>
					<td width="125"><strong>Knitting Source</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
				</tr>
				<tr>
					<td><strong>Challan/Program No</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? echo $challan_prog; ?></td>
					<td><strong>Issue Purpose</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
					echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
					?></td>
		<td><strong>Issue Date</strong></td>
		<td width="175px"><strong>:</strong>&nbsp;<? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
	</tr>
	<tr>
		<td><strong>Issue To</strong></td>
		<?
		if ($dataArray[0][csf('knit_dye_source')] == 3)
		{
			$supp_add = $dataArray[0][csf('knit_dye_company')];
			$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
			foreach ($nameArray as $result) {
				$address = "";
							if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
						}
						unset($nameArray);
					}

					$loan_party_add = $dataArray[0][csf('loan_party')];
					$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
					foreach ($loanPartyArray as $result) {
						$addressParty = "";
						if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($loanPartyArray);
					?>
					<td colspan="3"><strong>:</strong>&nbsp;
						<?
						if ($dataArray[0][csf('issue_purpose')] == 3) {
							echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
						} else if ($dataArray[0][csf('issue_purpose')] == 5) {
							echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
						} else {
							if ($dataArray[0][csf('knit_dye_source')] == 1)
								echo $company_library[$dataArray[0][csf('knit_dye_company')]];
							else
								echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
						}
						?>
					</td>
                    <td><strong>Location</strong></td>
					<td><strong>:</strong>&nbsp;<? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>
				</tr>
				<tr>
					<td><strong>Demand No.</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? echo implode(', ', $demand_no); ?></td>
					<td><strong>Gate Pass No.</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;
						<?
						if (in_array($dataArray[0][csf('id')], $check_issue_id_arr))
						{
							echo $issueInfoArr[$dataArray[0][csf('id')]]['gate_pass_no'];
						}
						else
						{
							echo $dataArray[0][csf('gate_pass_no')];
						}
						?>
					</td>
					<td><strong>Do No</strong></td>
					<td width="175px"><strong>:</strong>&nbsp;<? //echo $dataArray[0][csf('remarks')];
					?></td>
				</tr>
				<tr>
					<td valign="top"><strong>Remarks</strong></td>
					<td colspan="5"><strong>:</strong>&nbsp;<p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
				</tr>
				<?
				if ($print_with_vat == 1)
				{
					?>
					<tr>
						<td><strong>VAT Number</strong></td>
						<td><strong>:</strong>&nbsp;<p>
							<?
							$vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
							echo $vat_no;
							?>
                        </p></td>
                    </tr>
                    <?
                }
				else
				{
                    ?>
                    <tr>
                        <td valign="top">&nbsp;</strong></td>
                        <td>&nbsp;</td>
                    </tr>
                    <?
                }
                ?>
            </table>
            <br>
            <div style="width:100%;">
                <div style="clear:both;">
                    <table style="margin-right:-40px;" cellspacing="0" width="1050" border="1" rules="all"
                    class="rpt_table">
                    <thead bgcolor="#dddddd" style="font-size:13px">
                        <th width="20">SL</th>
                        <th width="45">Req. No</th>
                        <th width="50">Program No</th>
                        <th width="50">Lot No</th>
                        <th width="65">Y. Type</th>
                        <th width="110">Item Details</th>
                        <th width="65">Grey Color</th>
                        <th width="65">Dye. Color</th>
                        <th width="60">Supp.</th>
                        <th width="60"><b>Issue Qty(kg)</b></th>
                        <th width="60">Rtnbl Qty(kg)</th>
                        <th width="80">Bag & Cone</th>
                        <th width="80">Store</th>
                        <th width="120">Sales Order No</th>
                        <th width="100">Cust. Buyer</th>
                        <th>Style Name</th>
                    </thead>
                    <?
                    $wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");

                    $cond = "";
                    if ($data[5] != "") $cond .= " and c.id='$data[5]'";

                    $po_array = array();
                    $job_array = array();

                    $costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0]");
                    foreach ($costing_sql as $row)
                    {
                        $po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
                        $po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
                        $po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
                        $po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
                        $job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
                        $job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];

						$job_intfarray[$row[csf('job_no')]]['grouping'] = $row[csf('grouping')];
                    }

                    unset($costing_sql);

					$sales_order_array = array();
					$sales_order_sql = sql_select("select a.id,a.sales_booking_no, a.job_no,a.style_ref_no, a.buyer_id,b.job_no po_job_no,b.buyer_id po_buyer,a.within_group from fabric_sales_order_mst a left join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.status_active = 1 and a.is_deleted = 0 and a.company_id=$data[0]");
					foreach ($sales_order_sql as $row)
					{
						$sales_order_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
						$sales_order_array[$row[csf('id')]]['sales_order_no'] = $row[csf('job_no')];
						$sales_order_array[$row[csf('id')]]['po_job_no'] = $row[csf('po_job_no')];
						$sales_order_array[$row[csf('id')]]['sales_booking_no'] = $row[csf('sales_booking_no')];
						$sales_order_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
						$sales_order_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
						$sales_order_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
					}

					$sales_style_des_arr = array();
					$sales_samp_booking_sql = sql_select("SELECT b.booking_no, b.style_des FROM fabric_sales_order_mst a, wo_non_ord_samp_booking_dtls b WHERE a.sales_booking_no = b.booking_no and a.company_id=$data[0] and b.status_active=1 and b.is_deleted=0");
					foreach ($sales_samp_booking_sql as $row)
					{
						$sales_style_des_arr[$row[csf('booking_no')]]['style_des'] .= $row[csf('style_des')].',';
					}
					unset($sales_samp_booking_sql);

                    $stl_array = array();

                    $stl_sql = sql_select("select job_no, style_ref_no from wo_po_details_master");
                    foreach ($stl_sql as $row)
                    {
                        $stl_array[$row[csf('style_ref_no')]]['job'] = $row[csf('job_no')];
                    }
                    //var_dump($stl_array);
                    unset($stl_sql);

                    $job_no_array = array();
                    $jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id, po_buyer, customer_buyer from fabric_sales_order_mst");
                    foreach ($jobData as $row)
                    {
                        $job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
                        $job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
                        $job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
                        $job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
                        $job_no_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
                        $job_no_array[$row[csf('id')]]['customer_buyer'] = $row[csf('customer_buyer')];
                    }
                    //var_dump($po_array);
                    $po_id_req_array = array();
                    $is_sales_array = array();
                    if ($db_type == 0)
					{
                        $poID = " select c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales";
                    }
					else
					{
                        $poID = "select c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales";
                    }
                    $poID_sql_result = sql_select($poID);
                    foreach ($poID_sql_result as $row)
					{
                        $po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
                        $is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];

						$program_array[$row[csf('requisition_no')]]['program_no'] = $row[csf('knit_id')];
						$program_array[$row[csf('requisition_no')]]['poid'] = $row[csf('poid')];
						//$program_array[$row[csf('requisition_no')]]['buyer_id'] = $row[csf('buyer_id')];
                    }
                    unset($poID_sql_result);


                    $i = 1;
                    if ($db_type == 0) {
                        $sql_result = sql_select("SELECT a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales
						from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id left join fabric_sales_order_mst e on d.po_breakdown_id=e.id
						where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
						group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales order by b.requisition_no DESC");
                    } else {
                        $sql_result = sql_select("SELECT a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,e.style_ref_no
                        from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id left join fabric_sales_order_mst e on d.po_breakdown_id=e.id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
                        group by a.id, a.lot, a.yarn_count_id, a.yarn_comp_type1st, a.yarn_comp_percent1st, a.yarn_comp_type2nd, a.yarn_comp_percent2nd, a.yarn_type, a.color, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, e.sales_booking_no,e.job_no, e.customer_buyer, d.is_sales,e.style_ref_no order by b.requisition_no DESC");

                    }
                    $all_req_no = '';
                    $all_prod_id = '';
                    $order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
                    $tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
                    foreach ($sql_result as $row)
					{
                        if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
                        if ($row[csf('requisition_no')] != '')
						{
                            if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
                            if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
                        }
                        $order_qnty_val = $row[csf('cons_quantity')];
                        $order_qnty_val_sum += $order_qnty_val;

                        $order_amount_val = $row[csf('order_amount')];
                        $order_amount_val_sum += $order_amount_val;

                        $no_of_bags_val = $row[csf('no_of_bags')];
                        $no_of_bags_val_sum += $no_of_bags_val;

                        $po_id = explode(",", $row[csf('po_id')]);
                        $po_no = '';
                        $style_ref = '';
                        $job_no = '';
                        $buyer = '';
                        //$data=explode('*',$data);
                        $productdtls = $row[csf('product_name_details')];
                        $productArr = explode(' ', $productdtls);

                        $proddtls='';
                        $proddtls=$yarn_count_details[$row[csf('yarn_count_id')]];
                        if($row[csf('yarn_count_id')]>0) $proddtls.=", ";
                        $proddtls.=$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."%";


                    $internal_ref = '';
                    $style_ref = '';
                    $file_no = '';

                    if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
                    {
                        foreach ($po_id as $val)
                        {
							if($row[csf('is_sales')]==1)
							{
								if ($po_no== '') $po_no = $sales_order_array[$val]['sales_booking_no'];
								if ($style_ref == '') $style_ref = $sales_style_des_arr[$sales_order_array[$val]['sales_booking_no']]['style_des'];
							}
							else
							{
								if($po_array[$val]['no'] !='')
								{
									// if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
									// if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								}

							}

                            if ($job_no == '') $job_no = $po_array[$val]['job_no'];

                            if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                            if ($sales_booking_no== '') $sales_booking_no = $sales_order_array[$val]['sales_booking_no'];

                            if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
                            if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                        }
                        $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                        $job_file = array_unique(explode(",", rtrim($file_no, ", ")));
                        $ref_cond = '';
                        foreach ($job_ref as $ref) {
                            //$ref_cond.=", ".$ref;
                            if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                        }
                        $file_con = '';
                        foreach ($job_file as $file) {
                            if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                        }

                        $buyer_job = '';
                        if ($row[csf('issue_basis')] == 1)
                        {
                            if ($dataArray[0][csf('issue_purpose')] == 8)
                            {
                                $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                            }
                            else
                            {
                                if ($row[csf('buyer_job_no')] != "")
                                {
									if($row[csf('job_no')])
									{
                                       $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('job_no')];
									}
									else
									{
                                        $buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
									}
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$row[csf('buyer_id')]];
                                }

                            }

                        }
                        else if ($row[csf('issue_basis')] == 2)
                        {
                            $buyer_job = '';
                        }
						if(!empty($row[csf('customer_buyer')]))
						{
							$customer_buyer = $buyer_arr[$row[csf('customer_buyer')]];
						}
						else
						{
                           $customer_buyer = $buyer_arr[$job_no_array[$row[csf('buyer_job_no')]]['customer_buyer']];
						}
                    }
                    else if ($row[csf('issue_basis')] == 3)
                    {
                        if ($is_sales_array[$row[csf('requisition_no')]] == 1)
                        {
                            $buyer_job = '';
                            foreach (array_unique($po_id) as $val) {
                                if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
                                if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
                                $customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];

                                if ($buyer_job == '')
                                {
                                    if ($job_no_array[$val]['within_group'] == 1)
                                    {
                                        $buyer_data = $buyer_arr[$job_no_array[$val]['po_buyer']];
                                        $job_data = $stl_array[$job_no_array[$val]['style_ref']]['job'];
                                        $buyer_job = $buyer_data.' & '.$job_data;
                                    }
                                    else
                                    {
                                        $buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
                                    }
                                }
                            }
                        }
                        else
                        {
                            foreach ($po_id as $val)
                            {
                                //if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
                                if ($job_no == '') $job_no = $po_array[$val]['job_no'];
                                //if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
                                if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                                if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
                                if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                            }

                            $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                            $job_file = array_unique(explode(",", rtrim($file_no, ", ")));

                            $ref_cond = '';
                            foreach ($job_ref as $ref) {
                                //$ref_cond.=", ".$ref;
                                if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                            }

                            $file_con = '';
                            foreach ($job_file as $file) {
                                if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                            }
                            if ($job_no != '')
                            {
                                $buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
                            }
                            else
                            {
                                if(!empty($po_array[$val]['buyer_name']))
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$buyer_name];
                                }
                            }
                        }
                    }

                    else
                    {
                        foreach (array_unique($po_id) as $val)
                        {
                            //if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
                            //if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
                            $customer_buyer = $buyer_arr[$job_no_array[$val]['customer_buyer']];
                            if ($buyer_job == '')
                            {
                                if ($job_no_array[$val]['within_group'] == 1)
                                {

                                    $buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
                                }
                                else
                                {
                                    $buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
                                }
                            }

							if ($is_sales_array[$row[csf('requisition_no')]] == 1)
                        	{
								$po_job = $sales_order_array[$val]['po_job_no'];

								 if ($internal_ref == '') $internal_ref = $job_intfarray[$po_job]['grouping']; else $internal_ref .= "," . $job_intfarray[$po_job]['grouping'];

							}
                        }

						$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));

						$ref_cond = '';
						foreach ($job_ref as $ref)
						{
							if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
						}

                    }

                    $no_bag_cone = "";
                    $wt_bag_cone = "";
                    if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

                    if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" style="font-size:13px">
                        <td width="20"><? echo $i; ?></td>
                        <td width="45">
                            <div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
                        </td>
                        <td width="50">
                            <div style="word-wrap:break-word; width:50px"><? echo $program_array[$row[csf('requisition_no')]]['program_no']; ?></div>
                        </td>
                        <td width="50">
                            <div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
                        </td>
                        <td width="65">
                            <div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
                        </td>
                        <td width="110">
                            <div style="word-wrap:break-word; width:110px">
                                <?
                                //echo $proddtls;
                                echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
                                ?>
                            </div>
                        </td>
                        <td width="65">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('color')]]; ?></div>
                        </td>
                        <td width="65">
                            <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
                        &nbsp;</div>
                    </td>
                    <td width="60">
                        <div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
                    </td>
                    <td align="right"
                    width="60"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
                    <td align="right"
                    width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
                    <td width="80">
                        <div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
                    &nbsp;</div>
                </td>
                <td width="80">
                    <div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
                </td>
                <td width="120">
                    <div style="word-wrap:break-word; width:120px"><? echo $row[csf('job_no')];
                   ?></div>
                </td>
                <td width="100">
                    <div style="word-wrap:break-word; width:100px"><? echo $buyer_name_arr[$row[csf('customer_buyer')]]; ?></div>
                </td>
                <td>
                    <div style="word-wrap:break-word; width:80px"><? echo $row[csf('style_ref_no')];
                   ?></div>
                </td>
            </tr>
            <?
            $uom_unit = "Kg";
            $uom_gm = "Grams";
            $tot_return_qty += $row[csf('returnable_qnty')];
            $tot_bag += $no_of_bags_val;
            $tot_cone += $row[csf('cone_per_bag')];
            $tot_w_bag += $row[csf('weight_per_bag')];
            $tot_w_cone += $row[csf('weight_per_cone')];
            $req_no = $row[csf('requisition_no')];
            $i++;
        }
        ?>
        <tr bgcolor="#CCCCCC" style="font-size:13px">
            <td align="right" colspan="9"><b>Total</b></td>
            <td align="right">
                <b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
            </td>
            <td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
            <td><? echo 'N:' . number_format($tot_bag, 2);
            if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
            echo '<br>W:' . number_format($tot_w_bag, 2);
            if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
            <td align="right" colspan="5">&nbsp;</td>
        </tr>
        <tr>
            <td colspan="17" align="left"><b>In
                Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
            </tr>
        </table>
    </div>
    <br>
    <!--================================================================-->
    <?
        echo "<br><br>";

        echo "Note: Received The Above in Goods Condition For Handling and Delivery.";

        echo "<br><br><br><br><br><br><br><br>";

        echo signature_table(49, $data[0], "1030px",'',0);
        ?>
    </div>
 </div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');
		</script>
		<p style="page-break-after: always;"> </p>

		<?
	}
	exit();
}

if ($action == "pi_selection_popup")
{
	echo load_html_head_contents("Popup Info", "../../", 1, 1, $unicode);
	extract($_REQUEST);
	$supplier_arr = return_library_array("select id,supplier_name from lib_supplier", 'id', 'supplier_name');
	$company_arr = return_library_array("select id,company_name from lib_company", 'id', 'company_name');

	$search_cond = "";
	if ($supplier > 0) $search_cond .= " and a.supplier_id=$supplier";
	if ($color_id > 0) $search_cond .= " and b.color_id=$color_id";
	if ($hdn_composition_id > 0) $search_cond .= " and b.yarn_composition_item1=$hdn_composition_id";
	if ($yarn_count > 0) $search_cond .= " and b.count_name=$yarn_count";
	if ($yarn_type > 0) $search_cond .= " and b.yarn_type=$yarn_type";

	$txt_lot_no = str_replace("'","",$txt_lot_no);
	$txt_prod_id = str_replace("'","",$txt_prod_id);
	if ($txt_lot_no!="") $search_cond .= " and c.lot='".$txt_lot_no."'";;
	if ($txt_prod_id > 0) $search_cond .= " and c.id=$txt_prod_id";

	$sql ="SELECT distinct(c.lot),a.id AS mst_id, a.pi_number, a.supplier_id, a.pi_date FROM com_pi_master_details a, com_pi_item_details b, product_details_master c  WHERE  a.id = b.pi_id AND a.importer_id = $comany_name $search_cond AND a.importer_id=c.company_id and a.supplier_id = c.supplier_id AND b.color_id = c.color AND b.yarn_composition_item1 = c.yarn_comp_type1st AND b.count_name = c.yarn_count_id AND b.yarn_type=c.yarn_type and c.item_category_id=1 AND c.id in ( ( select prod_id from inv_transaction where receive_basis = 1 AND transaction_type = 1 and status_active=1 and is_deleted=0 and prod_id=$txt_prod_id) ) AND a.status_active = 1 AND a.is_deleted = 0 AND b.status_active = 1 AND b.is_deleted = 0 AND c.status_active = 1 AND c.is_deleted = 0";
	//echo $sql;
	$nameArray = sql_select($sql);

	?>
	<script>
		function js_set_value(data) {
			var splitSTR = data.split("**");
			var id = splitSTR[0];
			var pi_number = splitSTR[1];
			//alert(id+'='+pi_number);
			$("#hidden_pi_id").val(id);
			$("#hidden_pi_no").val(pi_number);
			parent.emailwindow.hide();
		}
	</script>
	<form name="searchorderfrm_1" id="searchorderfrm_1" autocomplete="off">
		<table width="550" cellspacing="0" cellpadding="0" border="1" class="rpt_table" align="center"
		rules="all">
		<thead>
			<tr>
				<th width="30">SL</th>
				<th width="180">Supplier Name</th>
				<th width="100">Lot</th>
				<th width="120">PI NO.</th>
				<th >PI Date</th>
			</tr>
		</thead>
		<tbody id="table_body">
			<?
			$i = 1;
			foreach ($nameArray as $row) {
				if ($i % 2 == 0)
					$bgcolor = "#E9F3FF";
				else
					$bgcolor = "#FFFFFF";

				?>
				<tr bgcolor="<? echo $bgcolor; ?>"
					onClick="js_set_value('<? echo $row[csf('mst_id')] . '**' . $row[csf('pi_number')]; ?>')"
					id="tr_<? echo $i; ?>" style=" cursor: pointer;">
					<td><? echo $i; ?></td>
					<td><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></td>
					<td><? echo $row[csf('lot')]; ?></td>
					<td><? echo $row[csf('pi_number')] ?></td>
					<td><? echo ($row[csf('pi_date')] != "") ? date("d-m-Y", strtotime($row[csf('pi_date')])) : ""; ?></td>
				</tr>
				<?
				$i++;
			} ?>
		</tbody>
		<tfoot>
			<input type="hidden" id="hidden_pi_id" value="">
			<input type="hidden" id="hidden_pi_no" value="">
		</tfoot>

	</table>
	</form>
	<script type="text/javascript">
		setFilterGrid('table_body',-1);
	</script>
	<?
}

if ($action =="find_similer_yarn_in_pi_ajax_responds")
{
	list($comany_name,$hdn_composition_id,$yarn_type,$color_id,$yarn_type,$color_id,$yarn_count,$supplier,$txt_lot_no,$txt_prod_id)=explode('*',$data);

	$search_cond = "";
	if ($supplier > 0) $search_cond .= " and a.supplier_id=$supplier";
	if ($color_id > 0) $search_cond .= " and b.color_id=$color_id";
	if ($hdn_composition_id > 0) $search_cond .= " and b.yarn_composition_item1=$hdn_composition_id";
	if ($yarn_count > 0) $search_cond .= " and b.count_name=$yarn_count";
	if ($yarn_type > 0) $search_cond .= " and b.yarn_type=$yarn_type";

	$txt_lot_no = str_replace("'","",$txt_lot_no);
	$txt_prod_id = str_replace("'","",$txt_prod_id);
	if ($txt_lot_no!="") $search_cond .= " and c.lot='".$txt_lot_no."'";;
	if ($txt_prod_id > 0) $search_cond .= " and c.id=$txt_prod_id";

	$sql ="SELECT distinct(c.lot),a.id AS mst_id, a.pi_number, a.supplier_id, a.pi_date FROM com_pi_master_details a, com_pi_item_details b, product_details_master c  WHERE  a.id = b.pi_id AND a.importer_id = $comany_name $search_cond AND a.importer_id=c.company_id and a.supplier_id = c.supplier_id AND b.color_id = c.color AND b.yarn_composition_item1 = c.yarn_comp_type1st AND b.count_name = c.yarn_count_id AND b.yarn_type=c.yarn_type and c.item_category_id=1 AND c.id in ( ( select prod_id from inv_transaction where receive_basis = 1 AND transaction_type = 1 and status_active=1 and is_deleted=0 and prod_id=$txt_prod_id) ) AND a.status_active = 1 AND a.is_deleted = 0 AND b.status_active = 1 AND b.is_deleted = 0 AND c.status_active = 1 AND c.is_deleted = 0";

	//echo $sql;die;

	$resultArray = sql_select($sql);

	$number_of_records = count($resultArray);
	echo $number_of_records;
	exit();
}


if ($action == "wo_selection_popup")
{
	echo load_html_head_contents("Popup Info", "../../", 1, 1, $unicode);
	extract($_REQUEST);
	$supplier_arr = return_library_array("select id,supplier_name from lib_supplier", 'id', 'supplier_name');
	$company_arr = return_library_array("select id,company_name from lib_company", 'id', 'company_name');
	if ($update_id_mst > 0) $mst_cond = " and mst_id <> $update_id_mst";

	// echo "select wo_id, sum(cons_quantity) as issue_qnty from inv_transaction where item_category=1 and transaction_type=2 and status_active=1 and is_deleted=0 and wo_id>0 $mst_cond group by wo_id";
	$issue_qnty_arr = return_library_array("select wo_id, sum(cons_quantity) as issue_qnty from inv_transaction where item_category=1 and transaction_type=2 and status_active=1 and is_deleted=0 and wo_id>0 $mst_cond group by wo_id", 'wo_id', 'issue_qnty');
	$suplier_cond = "";
	$color_id_cond = "";
	$hdn_composition_id_cond = "";
	$yarn_count_cond = "";
	if ($supplier > 0) $suplier_cond = " and a.supplier_id=$supplier";
	if ($color_id > 0) $color_id_cond = " and b.color_name=$color_id";
	if ($hdn_composition_id > 0) $hdn_composition_id_cond = " and b.yarn_comp_type1st=$hdn_composition_id";
	if ($yarn_count > 0) $yarn_count_cond = " and b.yarn_count=$yarn_count";

	$sql = "SELECT a.id as mst_id, a.wo_number,a.supplier_id,a.wo_date, b.supplier_order_quantity
	from wo_non_order_info_mst a, wo_non_order_info_dtls b
	where a.id=b.mst_id and a.company_name=$comany_name  $suplier_cond $color_id_cond $hdn_composition_id_cond $yarn_count_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  ";

	$nameArray = sql_select($sql);

	//echo $sql;
	?>
	<script>
		function js_set_value(data) {
			var splitSTR = data.split("**");
			var id = splitSTR[0];
			var wo_number = splitSTR[1];

			$("#hidden_wo_id").val(id);
			$("#hidden_wo_no").val(wo_number);
			parent.emailwindow.hide();
		}
	</script>
	<form name="searchorderfrm_1" id="searchorderfrm_1" autocomplete="off">
		<table width="680" cellspacing="0" cellpadding="0" border="1" class="rpt_table" align="center"
		rules="all">
		<thead>
			<tr>
				<th width="30">SL</th>
				<th width="120">WO NO.</th>
				<th width="140">Supplier Name</th>
				<th width="80">WO Date</th>
				<th width="100">WO Qty</th>
				<th width="100">Cumulative Issue Qty</th>
				<th>Balance Qty</th>
			</tr>
		</thead>
		<tbody>
			<?
			$i = 1;
			foreach ($nameArray as $row) {
				if ($i % 2 == 0)
					$bgcolor = "#E9F3FF";
				else
					$bgcolor = "#FFFFFF";
				$issue_balance = $row[csf('supplier_order_quantity')] - $issue_qnty_arr[$row[csf('mst_id')]];
				?>
				<tr bgcolor="<? echo $bgcolor; ?>"
					onClick="js_set_value('<? echo $row[csf('mst_id')] . '**' . $row[csf('wo_number')]; ?>')"
					id="tr_<? echo $i; ?>" style=" cursor: pointer;">
					<td><? echo $i; ?></td>
					<td><? echo $row[csf('wo_number')] ?></td>
					<td><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></td>
					<td><? echo ($row[csf('wo_date')] != "") ? date("d-m-Y", strtotime($row[csf('wo_date')])) : ""; ?></td>
					<td align="right"><? echo number_format($row[csf('supplier_order_quantity')], 2); ?></td>
					<td align="right"><? echo number_format($issue_qnty_arr[$row[csf('mst_id')]], 2); ?></td>
					<td align="right"><? echo number_format($issue_balance, 2); ?></td>
				</tr>
				<?
				$i++;
			} ?>
		</tbody>
		<tfoot>
			<input type="hidden" id="hidden_wo_id" value="">
			<input type="hidden" id="hidden_wo_no" value="">
		</tfoot>

	</table>
	</form>
	<?
}

/*#################### created by foysal ####################################*/

if ($action == "yarn_issue_print2")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print2", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$print_with_vat = $data[7];
	$company=$data[0];
	$location=$data[8];
	$store_id=$data[9];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	/*$supplier_arr=return_library_array( "select id, short_name from lib_supplier",'id','short_name');
	$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');*/

	$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');


	//$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$floor_room_rack_arr = return_library_array("select floor_room_rack_id, floor_room_rack_name from lib_floor_room_rack_mst", 'floor_room_rack_id', 'floor_room_rack_name');

	$sql = " select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
	//echo $sql;die;
	$dataArray = sql_select($sql);

	if( $dataArray[0][csf('issue_basis')]==3 )
	{
		$planbooking = sql_select("select e.booking_no as pln_booking_no from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c,ppl_planning_info_entry_dtls d,ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$data[5]' ");
	}

	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$country_arr = return_library_array("select id, country_name from lib_country", "id", "country_name");
	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);

	$PNG_TEMP_DIR = dirname(__FILE__).DIRECTORY_SEPARATOR.'qrcode_image'.DIRECTORY_SEPARATOR;
    $PNG_WEB_DIR = 'qrcode_image/';

	foreach (glob($PNG_WEB_DIR."*.png") as $filename) {
		@unlink($filename);
	}

	if (!file_exists($PNG_TEMP_DIR)) mkdir($PNG_TEMP_DIR);

	$filename = $PNG_TEMP_DIR.'test.png';
	$errorCorrectionLevel = 'L';
	$matrixPointSize = 4;

    include "../../ext_resource/phpqrcode/qrlib.php";

	$filename = $PNG_TEMP_DIR.md5($data[1]).'.png';
	QRcode::png($data[1], $filename, $errorCorrectionLevel, $matrixPointSize, 2);

	?>
	<style type="text/css">
		body{
			margin: 0 auto;
			padding:0;
			background-size:912px 1056px;
            background-repeat: no-repeat;
		}
		tr td {
			font-size: 9pt;
		}
		.stlinfo{font-size: 9pt;height: 40px; border: 1px solid black;}
		.stlinfobody{font-size: 9pt; border: 1px solid black;}
	</style>
	<div style="width:1000px;">
		<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;margin-bottom:10px; ">
			<tr>
				<td></td>
				<td colspan="7" align="center" style="font-size:25px; padding-bottom:5px">
					<strong><? echo $com_dtls[0]; ?></strong></td>
					<td style="font-size:xx-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">

					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='70' width='130'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='70' width='130'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="7" align="center" >
						<?
						//echo $com_dtls[1];
					$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$data[0]");
					foreach ($nameArray as $result)
					{
						echo $result[csf('city')];?>
						COUNTRY: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
						Email : <? echo $result[csf('email')];?>
						Website : <? echo $result[csf('website')];
					}
					?>
			</td>
			<td>&nbsp;</td>
		</tr>
		<tr>
		    <td></td>
			<td colspan="7" align="center" style="padding-top: 5px;padding-bottom: 10px;"><strong><u>Yarn Delivery Challan</u></strong>
			</td>
			<td>&nbsp;</td>
		</tr>
		<tr>
			<td width="80"><strong>Issue No:</strong></td>
			<td width="195px"><? echo $dataArray[0][csf('issue_number')]; ?></td>
			<td width="50"></td>
			<td width="120"><strong>Booking:</strong></td>
			<td width="185px">
				<?
				if( $dataArray[0][csf('issue_basis')]==3 )
				{
					$bookingNo = $planbooking[0][csf('pln_booking_no')];
				} else {
					$bookingNo = $dataArray[0][csf('booking_no')];
				}
				echo $bookingNo;
				?>
			</td>
			<td width="50"></td>
			<td width="150"><strong>Knitting Source:</strong></td>
			<td width="150px"><? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
		</tr>
		<tr>
			<td><strong>Program No:</strong></td>
			<td width="185px"><? echo $dataArray[0][csf('challan_no')]; ?></td>
			<td width="50"></td>
			<td><strong>Issue Purpose:</strong></td>
			<td width="175px"><? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
			echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
			?></td>
			<td width="50"></td>
			<td><strong>Issue Date:</strong></td>
			<td width="175px"><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
		</tr>
			<tr>
				<td valign="top"><strong>Issue To:</strong></td>
				<?
				if ($dataArray[0][csf('knit_dye_source')] == 3) {
					$supp_add = $dataArray[0][csf('knit_dye_company')];
					$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
					foreach ($nameArray as $result) {
						$address = "";
						if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($nameArray);
				}

				$loan_party_add = $dataArray[0][csf('loan_party')];
				$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
				foreach ($loanPartyArray as $result) {
					$addressParty = "";
					if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
				}
				unset($loanPartyArray);
				?>
				<td valign="top">
					<strong>
						<?
						if ($dataArray[0][csf('issue_purpose')] == 3) {
							echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
						} else if ($dataArray[0][csf('issue_purpose')] == 5) {
							echo $supplier_arr[$dataArray[0][csf('loan_party')]];
						} else {
							if ($dataArray[0][csf('knit_dye_source')] == 1)
								echo $company_library[$dataArray[0][csf('knit_dye_company')]];
							else
								echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]];
						}
						?>
					</strong>
				</td>
				<td width="50"></td>
				<td valign="top"><strong>Address:</strong></td>
				<td>
				    <?
					if ($dataArray[0][csf('issue_purpose')] == 3) {
						echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
					} else if ($dataArray[0][csf('issue_purpose')] == 5) {
						echo $addressParty;
					} else {
						if ($dataArray[0][csf('knit_dye_source')] == 1)
							echo $company_library[$dataArray[0][csf('knit_dye_company')]];
						else
							echo $address;
					}
					?>
				</td>
				<td width="50"></td>
				<td valign="top"><strong>Location:</strong></td>
				<td valign="top"><? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>


			</tr>
			<tr>
				<td><strong>Demand No.:</strong></td>
				<td width="185px"><? //echo $dataArray[0][csf('booking_id')];
				?></td>
			    <td width="50"></td>
				<td><strong>Do No:</strong></td>
				<td width="175px"><? //echo $dataArray[0][csf('remarks')];
				?></td>
			</tr>
			<tr>
				<td valign="top"><strong>Remarks :</strong></td>
				<td colspan="5"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
			</tr>
			<?
			if ($print_with_vat == 1) {
				?>
				<tr>
					<!-- <td><strong>VAT Number :</strong></td>
					<td><p>
						<?
					$vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
					echo $vat_no;
					?></p></td> -->
					<td><strong>QR Code:</strong></td>
					<td colspan="3" ><img src="<? echo $PNG_WEB_DIR.basename($filename);?>" height="70" width=""></td>
				</tr>
				<?
			} else {
				?>
				<tr>
					<td valign="top">&nbsp;</strong></td>
					<td>&nbsp;</td>
					<td ><strong>QR Code:</strong></td>
					<td colspan="3" ><img src="<? echo $PNG_WEB_DIR.basename($filename);?>" height="70" width=""></td>
				</tr>
				<?
			}
			?>
		</table>


		<div style="width:100%; padding-top:10px">
			<div style="clear:both;">
				<table style="margin-right:-40px; " cellspacing="0" width="1160" border="1" rules="all">
				<thead bgcolor="#CCCCCC">
					<th width="20" class='stlinfo'>SL</th>
					<th width="45" class='stlinfo'>Req. No</th>
					<th width="50" class='stlinfo'>Program No</th>
					<th width="50" class='stlinfo'>Lot No</th>
					<th width="65" class='stlinfo'>Y. Type</th>
					<th width="110" class='stlinfo'>Item Details</th>
					<th width="65" class='stlinfo'>Dye. Color</th>
					<th width="60" class='stlinfo'>Supp.</th>
					<th width="60" class='stlinfo'><b>Issue Qty(kg)</b></th>
					<th width="60" class='stlinfo'>Rtnbl Qty(kg)</th>
					<th width="80" class='stlinfo'>Bag & Cone</th>
					<th width="80" class='stlinfo'>Store</th>
					<th width="80" class='stlinfo'>Floor</th>
					<th width="80" class='stlinfo'>Room</th>

					<th width="100" class='stlinfo'>Buyer & Job</th>
					<th width="120" class='stlinfo'>Order & Style</th>
					<th class='stlinfo'>Inte. Ref & File</th>

				</thead>
				<?
				//$wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");
				$cond = "";
				if ($data[5] != "") $cond .= " and c.id='$data[5]'";

				$i = 1;
				if ($db_type == 0)
				{
					$sql_result = sql_select("select a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
				}
				else
				{
					$sql_result = sql_select("select a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
				}

				//for requisition no
				$tmp_req_no_arr = array();
				$tmp_po_id_arr = array();
				foreach ($sql_result as $row)
				{
					$tmp_req_no_arr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];

					//for po
					$exp_po_id = array();
					$exp_po_id = explode(",", $row[csf('po_id')]);
					foreach($exp_po_id as $pkey=>$pval)
					{
						$tmp_po_id_arr[$pval] = $pval;
					}
				}

				$con = connect();
				execute_query("DELETE FROM TMP_REQS_NO WHERE USERID = ".$user_id);
				execute_query("DELETE FROM TMP_POID WHERE USERID = ".$user_id);
				oci_commit($con);

				//for requisition no insert
				$con = connect();
				foreach($tmp_req_no_arr as $key=>$val)
				{
					execute_query("INSERT INTO TMP_REQS_NO(REQS_NO, USERID) VALUES('".$val."', '".$user_id."')");
				}

				foreach($tmp_po_id_arr as $key=>$val)
				{
					execute_query("INSERT INTO TMP_POID(POID, USERID) VALUES('".$val."', '".$user_id."')");
				}
				oci_commit($con);
				//end for requisition no

				//for requisition no
				$po_id_req_array = array();
				$is_sales_array = array();
				if ($db_type == 0)
				{
					$poID = " select c.knit_id,c.requisition_no,a.buyer_id,a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id AND c.requisition_no IN(SELECT REQS_NO FROM TMP_REQS_NO WHERE USERID = ".$user_id.") group by c.knit_id,c.requisition_no,a.buyer_id,a.is_sales ";
				}
				else
				{
					$poID = "select c.knit_id,c.requisition_no,a.buyer_id,a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id AND c.requisition_no IN(SELECT REQS_NO FROM TMP_REQS_NO WHERE USERID = ".$user_id.") group by c.knit_id,c.requisition_no,a.buyer_id,a.is_sales ";
				}

				//echo $poID;
				$poID_sql_result = sql_select($poID);
				foreach ($poID_sql_result as $row)
				{
					$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
					$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
					$program_array[$row[csf('requisition_no')]]['program_no'] = $row[csf('knit_id')];
					$program_array[$row[csf('requisition_no')]]['buyer_id'] = $row[csf('buyer_id')];
				}
				unset($poID_sql_result);
				//end for requisition no
				/*echo "<pre>";
				print_r($program_array);
				echo "</pre>";*/

				//for po
				$po_array = array();
				$job_array = array();
				$costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0] AND b.id IN(SELECT POID FROM TMP_POID WHERE USERID = ".$user_id.")");
				foreach ($costing_sql as $row)
				{
					$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
					$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
					$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
					$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
					$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
					$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
					$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
					$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
				}
				unset($costing_sql);
				//end for po

				//for sales order info
				$job_no_array = array();
				$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst where id IN(SELECT POID FROM TMP_POID WHERE USERID = ".$user_id.")");
				foreach ($jobData as $row)
				{
					$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
					$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
					$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
					$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
				}
				//end for sales order info
				execute_query("DELETE FROM TMP_REQS_NO WHERE USERID = ".$user_id); //after using temp tbl data delete
				execute_query("DELETE FROM TMP_POID WHERE USERID = ".$user_id);
				oci_commit($con);

				$all_req_no = '';
				$all_prod_id = '';
				$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
				$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
				foreach ($sql_result as $row) {
					//if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
					if ($row[csf('requisition_no')] != '') {
						if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
						if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
					}
					$order_qnty_val = $row[csf('cons_quantity')];
					$order_qnty_val_sum += $order_qnty_val;

					$order_amount_val = $row[csf('order_amount')];
					$order_amount_val_sum += $order_amount_val;

					$no_of_bags_val = $row[csf('no_of_bags')];
					$no_of_bags_val_sum += $no_of_bags_val;

					$po_id = explode(",", $row[csf('po_id')]);
					$po_no = '';
					$style_ref = '';
					$job_no = '';
					$buyer = '';
						//$data=explode('*',$data);
					$productdtls = $row[csf('product_name_details')];
					$productArr = explode(' ', $productdtls);

					$proddtls = '';
					if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
					} else if ($productArr[0] != '' && $productArr[1] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1];
					} else if ($productArr[0] != '') {
						$proddtls = $productArr[0];
					} else {
						$proddtls = '';
					}

					$internal_ref = '';
					$file_no = '';
					if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
					{
						foreach ($po_id as $val) {
							if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
							if ($job_no == '') $job_no = $po_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
							if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

							if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
							if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
						}
						$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
						$job_file = array_unique(explode(",", rtrim($file_no, ", ")));
						$ref_cond = '';
						foreach ($job_ref as $ref) {
								//$ref_cond.=", ".$ref;
							if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
						}
						$file_con = '';
						foreach ($job_file as $file) {
							if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
						}

						$buyer_job = '';
						if ($row[csf('issue_basis')] == 1)
						{
							if ($dataArray[0][csf('issue_purpose')] == 8)
							{
								$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
							}
							else
							{
								if ($row[csf('buyer_job_no')] != "")
								{
									$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
								}
								else
								{
									$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
								}
							}
						} else if ($row[csf('issue_basis')] == 2) {
							$buyer_job = '';
						}
					}
					else if ($row[csf('issue_basis')] == 3)
					{
						$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
							//print_r($ex_data);

						if ($is_sales_array[$row[csf('requisition_no')]] == 1)
						{
							$buyer_job = '';
							foreach (array_unique($po_id) as $val) {
								if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];

								if ($buyer_job == '') {
									if ($job_no_array[$val]['within_group'] == 1) {
										$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
									} else {
										$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
									}
								}

								if ($job_no_array[$val]['within_group'] != 1) {
									$ref_cond = '';
								}

							}
						}
						else
						{
							foreach ($po_id as $val)
							{
								if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
								if ($job_no == '') $job_no = $po_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
								if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
							}

							$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
							$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

							$ref_cond = '';
							foreach ($job_ref as $ref) {
									//$ref_cond.=", ".$ref;
								if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
							}

							$file_con = '';
							foreach ($job_file as $file) {
								if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
							}

							$buyer_job = $buyer_arr[$program_array[$row[csf('requisition_no')]]['buyer_id']];

							if ($job_no != '')
							{
								$buyer_job .= ' & ' . $job_no;
							}
						}
					}
					else
					{
						foreach (array_unique($po_id) as $val) {
							if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
							if ($buyer_job == '') {
								if ($job_no_array[$val]['within_group'] == 1) {
									$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
								} else {
									$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
								}
							}
						}
					}

					$no_bag_cone = "";
					$wt_bag_cone = "";
					if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

					if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];

					//for supplier
					if($row[csf('is_within_group')] == 1)
					{
						$supplier_name = $company_library[$row[csf('supplier_id')]];
					}
					else
					{
						$supplier_name = $supplier_arr[$row[csf('supplier_id')]];
					}
					?>
					<tbody>
						<tr bgcolor="<? echo $bgcolor; ?>">
							<td width="20" class='stlinfobody'><? echo $i; ?></td>
							<td width="45" class='stlinfobody'>
								<div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
							</td>
							<td width="50" class='stlinfobody'>
								<?  echo $program_array[$row[csf('requisition_no')]]['program_no']; ?>
							</td>
							<td width="50" class='stlinfobody'>
								<div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
							</td>

							<td width="65" class='stlinfobody'>
								<div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
							</td>
							<td width="110" class='stlinfobody'>
								<div style="word-wrap:break-word; width:110px">
									<?
									//echo $proddtls;
									echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
									?>
								</div>
							</td>


							<td width="65" class='stlinfobody'>
								<div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
							&nbsp;</div>
						</td>

						<td width="60" class='stlinfobody'>
							<div style="word-wrap:break-word; width:60px"><? echo $supplier_name; ?></div>
						</td>

						<td align="right"
						width="60" class='stlinfobody'><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
						<td align="right"
						width="60" class='stlinfobody'><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
						<td width="80" class='stlinfobody'>
							<div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
						&nbsp;</div>
					</td>
					<td width="80" class='stlinfobody'>
						<div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
					</td>
					<td width="80" class='stlinfobody'>
					<div style="word-wrap:break-word; width:80px"><? echo $floor_room_rack_arr[$row[csf('floor_id')]]; ?></div>
					</td>
					<td width="80" class='stlinfobody'>
						<div style="word-wrap:break-word; width:80px"><? echo $floor_room_rack_arr[$row[csf('room')]]; ?></div>
					</td>

					<td width="100" class='stlinfobody'>
						<div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
					</td>
					<td width="120" class='stlinfobody'>
						<div style="word-wrap:break-word; width:120px"><? echo $po_no;
						if ($style_ref != "") echo ' & ' . $style_ref; else echo '&nbsp;'; ?></div>
					</td>
					<td class='stlinfobody'>
						<div style="word-wrap:break-word; width:80px"><? echo ltrim($ref_cond, ", ");
						if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?></div>
					</td>

				</tr>
				<?
				$uom_unit = "Kg";
				$uom_gm = "Grams";
				$tot_return_qty += $row[csf('returnable_qnty')];
				$tot_bag += $no_of_bags_val;
				$tot_cone += $row[csf('cone_per_bag')];
				$tot_w_bag += $row[csf('weight_per_bag')];
				$tot_w_cone += $row[csf('weight_per_cone')];
				$req_no = $row[csf('requisition_no')];
				$i++;
			}
			?>
			<tr bgcolor="#CCCCCC" >
				<td align="right" colspan="8" class='stlinfobody'><b>Total&nbsp;</b></td>
				<td align="right" class='stlinfobody'>
					<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
				</td>
				<td align="right" class='stlinfobody'><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
				<td class='stlinfobody'><? echo 'N:' . number_format($tot_bag, 2);
				if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
				echo '<br>W:' . number_format($tot_w_bag, 2);
				if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
				<td align="right" colspan="6" class='stlinfobody'>&nbsp;</td>
			</tr>
			<tr>
				<td colspan="17" align="left" class='stlinfobody'><b>In
					Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
			</tr>
		</tbody>
	</table>
	<p><b>Note: Received The Above in Goods Condition For Handling and Delivery.</b></p>
	</div>
	<br>
	<br>&nbsp;
	<!--================================================================-->
	<?
	if ($data[6] == 1)
	{
		if ($dataArray[0][csf('issue_basis')] == 3)
		{
			?>
			<div style="">
				<table width="850" border="1" rules="all" cellpadding="0" cellspacing="0" >
					<thead bgcolor="#CCCCCC">
						<tr>
							<th colspan="7" align="center" class='stlinfo'>Requisition Details</th>
						</tr>
						<tr>
							<th width="40" class='stlinfo'>SL</th>
							<th width="100" class='stlinfo'>Requisition No</th>
							<th width="110" class='stlinfo'>Lot No</th>
							<th width="220" class='stlinfo'>Yarn Description</th>
							<th width="110" class='stlinfo'>Brand</th>
							<th width="90" class='stlinfo'>Requisition Qty</th>
							<th class='stlinfo'>Remarks</th>
						</tr>
					</thead>
					<?
					//echo $all_req_no;
					$i = 1;
					$tot_reqsn_qnty = 0;
					$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
					$product_details_array = array();
					$sql = "select id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where item_category_id=1 and company_id='$data[0]' and status_active=1 and is_deleted=0";
					$result = sql_select($sql);

					foreach ($result as $row) {
						$compos = '';
						if ($row[csf('yarn_comp_percent2nd')] != 0) {
							$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
						} else {
							$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
						}
						$product_details_array[$row[csf('id')]]['count'] = $count_arr[$row[csf('yarn_count_id')]];
						$product_details_array[$row[csf('id')]]['comp'] = $compos;
						$product_details_array[$row[csf('id')]]['type'] = $yarn_type[$row[csf('yarn_type')]];
						$product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
						$product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
					}
					unset($result);
					$sql = "select knit_id, requisition_no, prod_id, sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where requisition_no in ($all_req_no) and status_active=1 and is_deleted=0 group by requisition_no, prod_id, knit_id";
					$nameArray = sql_select($sql);
					foreach ($nameArray as $selectResult) {
						?>
						<tr>
							<td width="40" align="center" class='stlinfobody'><? echo $i; ?></td>
							<td width="100" align="center" class='stlinfobody'>
								&nbsp;<? echo $selectResult[csf('requisition_no')]; ?></td>
							<td width="110" align="center" class='stlinfobody'>
								&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['lot']; ?></td>
							<td width="220" class='stlinfobody'>
								&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['count'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['comp'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['type']; ?></td>
							<td width="110" align="center" class='stlinfobody'>
								&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['brand']; ?></td>
							<td width="90"
									align="right" class='stlinfobody'><? echo number_format($selectResult[csf('yarn_qnty')], 2); ?>
								&nbsp;</td>
							<td class='stlinfobody'>&nbsp;<? //echo $selectResult[csf('requisition_no')];
							?></td>
						</tr>
						<?
						$tot_reqsn_qnty += $selectResult[csf('yarn_qnty')];
						$i++;
					}
					?>
					<tfoot bgcolor="#CCCCCC">
						<th colspan="5" align="right" class='stlinfo'><b>Total</b></th>
						<th align="right" class='stlinfo'><? echo number_format($tot_reqsn_qnty, 2); ?>&nbsp;</th>
						<th class='stlinfo'>&nbsp;</th>
					</tfoot>
				</table>
				<?
				if ($data[5] != 1) {
					$z = 1;
					$k = 1;
					$colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia,c.buyer_id from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

					$booking_al = "";
					foreach ($colorArray as $book)
					{
						if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];

						$prog_booking_buyer[$book[csf('booking_no')]] = $book[csf('buyer_id')];
					}
					//unset($colorArray);
					//echo $booking_no;
					$booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
					$booking_count = count(array_unique(explode(',', $booking_no)));
					//$booking_job_arr=array();
					if ($dataArray[0][csf('issue_purpose')] == 2) {
						$booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
					} else {
						$booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
					}
					//
					$booking_job_no = $booking_job[0][csf('job_no')];
					unset($booking_job);

					if ($db_type == 0) $poNoCond = "group_concat(id)";
					else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
					/*echo '='.$sql_Job.'=';
			if($sql_Job!="")
			{*/
				$sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

				$job_po = $sql_returnJob[0][csf('po_break_down_id')];
				unset($sql_returnJob);
				?>

				<table width="710" cellpadding="0" cellspacing="0" border="1" rules="all"
				style="margin-top:20px;" >
				<thead bgcolor="#CCCCCC">
					<th width="40" class='stlinfo'>SL</th>
					<th width="250" class='stlinfo'>Fabrication</th>
					<th width="120" class='stlinfo'>Color</th>
					<th width="120" class='stlinfo'>GGSM OR S/L</th>
					<th class='stlinfo'>FGSM</th>
				</thead>
				<tbody>
					<tr>
						<td width="40" align="center" class='stlinfobody'><? echo $z; ?></td>
						<td width="250"
						align="center" class='stlinfobody'><? echo $body_part[$colorArray[0][csf('body_part_id')]] . ', ' . $colorArray[0][csf('fabric_desc')]; ?></td>
						<td width="120"
						align="center" class='stlinfobody'><? echo $color_range[$colorArray[0][csf('color_range')]]; ?></td>
						<td width="120" align="center" class='stlinfobody'><? echo $colorArray[0][csf('stitch_length')]; ?></td>
						<td align="center" class='stlinfobody'><? echo $colorArray[0][csf('gsm_weight')]; ?></td>
					</tr>
				</tbody>
			</table>
			<table style="margin-top:20px;" width="650" border="1" rules="all" cellpadding="0"
			cellspacing="0" >
			<thead bgcolor="#CCCCCC">
				<th width="40" class='stlinfo'>SL</th>
				<th width="50" class='stlinfo'>Prog. No</th>
				<th width="110" class='stlinfo'>Finish Dia</th>
				<th width="170" class='stlinfo'>Machine Dia & Gauge</th>
				<th width="110" class='stlinfo'>Program Qty</th>
				<th class='stlinfo'>Remarks</th>
			</thead>
			<tbody>
				<tr>
					<td width="40" align="center" class='stlinfobody'><? echo $k; ?></td>
					<td width="50" align="center" class='stlinfobody'>&nbsp;<? echo $colorArray[0][csf('knit_id')]; ?></td>
					<td width="110" align="center" class='stlinfobody'><? echo $colorArray[0][csf('dia')]; ?></td>
					<td width="170"
					align="center" class='stlinfobody'><? echo $colorArray[0][csf('machine_dia')] . "X" . $colorArray[0][csf('machine_gg')]; ?></td>
					<td width="110"
					align="right" class='stlinfobody'><? echo number_format($colorArray[0][csf('program_qnty')], 2); ?>
				&nbsp;</td>
				<td class='stlinfobody'><? echo $colorArray[0][csf('remarks')]; ?></td>
			</tr>
			<?
			$tot_prog_qty += $colorArray[0][csf('program_qnty')];
			?>
			<tr bgcolor="#CCCCCC">
				<td colspan="4" align="right" class='stlinfo'><strong>Total : </strong></td>
				<td align="right" class='stlinfo'><? echo number_format($tot_prog_qty, 2); ?></td>
				<td class='stlinfo'>&nbsp;</td>
			</tr>
		</tbody>
	</table>
	<?
	$returnJob = '';
	$returnPo = '';
	if ($db_type == 0) {
		$booking_cond = "group_concat(a.booking_no)";
		$wo_cond = "group_concat(a.ydw_no)";
		$reqs_no = "group_concat(b.requisition_no)";
	} else if ($db_type == 2) {
		$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
		$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
		$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
	}

	if ($dataArray[0][csf('issue_purpose')] == 8)
	{
		$sql_returnJob = sql_select("select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
	}
	else if ($dataArray[0][csf('issue_purpose')] == 2)
	{
		$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

		if ($db_type == 0) $poNoCond = "group_concat(id)";
		else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
		$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
	} else {
		$sql_returnJob = sql_select("select a.job_no, a.booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' and a.booking_no in($booking_no) group by a.job_no,a.booking_no");
	}

	$returnJob = $sql_returnJob[0][csf('job_no')];
	$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
	$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
	$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
	unset($sql_returnJob);
					?>
					<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
					cellspacing="0" >
					<thead bgcolor="#CCCCCC">
						<tr>
							<th colspan="6" align="center" class='stlinfo'>Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking
							Job Deatils]</p></th>
						</tr>
						<tr>
							<th class='stlinfo'>Buyer</th>
							<th class='stlinfo'>Job</th>
							<th class='stlinfo'>Req. Qty</th>
							<th class='stlinfo'>Cuml. Issue Qty</th>
							<th class='stlinfo'>Balance Qty</th>
							<th class='stlinfo'>Remarks</th>
						</tr>
					</thead>
					<?

					$all_requ_no = "";
					if ($dataArray[0][csf('issue_purpose')] != 8)
					{
						$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");

						//$all_requ_no="'".$all_booking_sql[0][csf('requisition_no')]."'";
						$all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
					}
					if ($dataArray[0][csf('issue_purpose')] == 8)
					{
						$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");    //
						$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
					}
					else if ($dataArray[0][csf('issue_purpose')] == 2)
					{
						if ($all_requ_no != "" || $all_requ_no != 0)
						{
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						}
						else
						{
							$req_cond = "or a.requisition_no in (0)";
							$reqRet_cond = "or b.booking_no in (0)";
						}

						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
					}
					else
					{
						if ($all_requ_no != "" || $all_requ_no != 0)
						{
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						}
						else
						{
							$req_cond = "or a.requisition_no in (0)";
							$reqRet_cond = "or b.booking_no in (0)";
						}

						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");

						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
					}

					$cumulative_qty = 0;

					if ($booking_count == 1)
					{
						?>
						<tbody>
							<tr>
								<td align="center" class='stlinfobody'>

									<?

									if($job_array[$booking_job_no]['buyer']!="")
									{
										echo $buyer_arr[$job_array[$booking_job_no]['buyer']];
									}else{
										echo $buyer_arr[$row[csf('buyer_id')]];
									}

									?>
								</td>
								<td align="center" class='stlinfobody'>
									<? echo $job_array[$booking_job_no]['job']; ?>
								</td>
								<td align="center" class='stlinfobody'>

									<? echo number_format($returnReqQty, 3); ?>
								</td>
								<td align="center" class='stlinfobody'>
									<? $cumulative_qty = $total_issue_qty - $total_return_qty;
									echo number_format($cumulative_qty, 3); ?>
								</td>
								<td align="center" class='stlinfobody'>
									<? $balance_qty = $returnReqQty - $cumulative_qty;
									echo number_format($balance_qty, 3); ?>
								</td>
								<td align="center" class='stlinfobody'>
									<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
								</td>
							</tr>
							</tbody>
						</table>
					<?
				}
			}
		}
		else if ($dataArray[0][csf('issue_basis')] == 1)
		{
			?>
			<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
			cellspacing="0" >
			<thead bgcolor="#CCCCCC">
				<tr>
					<th colspan="6" align="center" class='stlinfo'>
						Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
							if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
						} ?> </th>
					</tr>
					<tr>
						<th class='stlinfo'>Buyer</th>
						<th class='stlinfo'>Job</th>
						<th class='stlinfo'>Req. Qty</th>
						<th class='stlinfo'>Cuml. Qty</th>
						<th class='stlinfo'>Balance Qty</th>
						<th class='stlinfo'>Remarks</th>
					</tr>
				</thead>
				<?
						//$booking_job_arr=array();
				$returnJob = '';
				$returnPo = '';
				if ($db_type == 0) {
					$booking_cond = "group_concat( distinct a.booking_no)";
					$wo_cond = "group_concat(a.ydw_no)";
					$reqs_no = "group_concat(b.requisition_no)";
				} else if ($db_type == 2) {
					$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
					$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
					$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
				}

				if ($dataArray[0][csf('issue_purpose')] == 8) {
					$sql_returnJob = sql_select("select a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
				} else if ($dataArray[0][csf('issue_purpose')] == 2) {
					if ($dataArray[0][csf('buyer_job_no')] != '') {
						$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

						if ($db_type == 0) $poNoCond = "group_concat(id)";
						else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
						$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
					} else {
						$sql_returnJob = sql_select("select a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
					}
				} else {
							//echo "select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
							$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");//and a.booking_no='".$dataArray[0][csf('booking_no')]."'
						}
						$returnJob = $sql_returnJob[0][csf('job_no')];
						$returnPo = $sql_po[0][csf('po_break_down_id')];
						$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
						$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

						$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];

						unset($sql_returnJob);

						$all_requ_no = "";
						if ($dataArray[0][csf('issue_purpose')] != 8) {
							//echo "select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no";
							$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

							$all_requ_no = $all_booking_sql[0][csf('requisition_no')];
							unset($all_booking_sql);
						}

						if ($dataArray[0][csf('issue_purpose')] == 8) {
							$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");    //
							$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
						} else if ($dataArray[0][csf('issue_purpose')] == 2) {
							/*if($all_requ_no!="" || $all_requ_no!=0)
					{
						//$req_cond="or a.requisition_no in ($all_requ_no)";
						//$reqRet_cond="or b.booking_no in ($all_requ_no)";
					}
					else
					{
						//$req_cond="or a.requisition_no in (0)";
						$reqRet_cond="or b.booking_no in (0)";
					}*/
					if ($dataArray[0][csf('buyer_job_no')] != "") {
						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
					} else {
								//echo "select sum(a.cons_quantity) as total_issue_qty from inv_transaction a, inv_issue_master b where b.id=a.mst_id and b.booking_no='".$dataArray[0][csf('booking_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.buyer_job_no<>'' and b.issue_purpose=2";
						$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
						$total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
					}
				} else {
					if ($dataArray[0][csf('buyer_job_no')] != "") {
						if ($all_requ_no != "" || $all_requ_no != 0) {
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						} else {
									$req_cond = "";//or a.requisition_no in (0)
									$reqRet_cond = "";//or b.booking_no in (0)
								}
								$total_issue_qty = 0;
								//echo "select sum(c.quantity) as total_issue_qty from inv_transaction a, inv_issue_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2";
								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2";
								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");

								//$total_issue_qty=return_field_value("sum(quantity) as total_issue_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=2 and entry_form=3","total_issue_qty");
								//$total_return_qty=return_field_value("sum(quantity) as total_return_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=4 and entry_form=8","total_return_qty");
							}
						}
						?>
						<tbody>
							<tr>
								<td align="center" class='stlinfobody'>
									<?
									if ($dataArray[0][csf('issue_purpose')] == 8)
									{
										echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
									}
									else
									{
										if($job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']!="")
										{
											echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
										}
										else
										{
											echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
										}
									}
									?>
								</td>
								<td align="center" class='stlinfobody'>
									<? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
								</td>
								<td align="center" class='stlinfobody'>
									<? echo number_format($returnReqQty, 3); ?>
								</td>
								<td align="center" class='stlinfobody'>

									<? $cumulative_qty = 0;
									$cumulative_qty = $total_issue_qty - $total_return_qty;
									echo number_format($cumulative_qty, 3); ?>
								</td>
								<td align="center" class='stlinfobody'>
									<? $balance_qty = $returnReqQty - $cumulative_qty;
									echo number_format($balance_qty, 3); ?>
								</td>
								<td align="center" class='stlinfobody'>
									<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
								</td>
							</tr>
						</tbody>
					</table>
					<?
				}
			}
			?>
			<br>
			<?
			echo signature_table(49, $data[0], "1230px",'','','','','','font-size:22px;');
			?>
		</div>
	</div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		/* function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? //echo $data[1]; ?>'); */
		</script>
		<?
		exit();
}

if ($action == "yarn_issue_print211")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print21", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$print_with_vat = $data[7];
	$company=$data[0];
	$location=$data[8];
	$store_id=$data[9];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	/*$supplier_arr=return_library_array( "select id, short_name from lib_supplier",'id','short_name');
	$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');*/

	$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');


	//$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$floor_room_rack_arr = return_library_array("select floor_room_rack_id, floor_room_rack_name from lib_floor_room_rack_mst", 'floor_room_rack_id', 'floor_room_rack_name');

	$sql = " select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
	//echo $sql;die;
	$dataArray = sql_select($sql);

	if( $dataArray[0][csf('issue_basis')]==3 )
	{
		$planbooking = sql_select("select e.booking_no as pln_booking_no from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c,ppl_planning_info_entry_dtls d,ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$data[5]' ");
	}

	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$country_arr = return_library_array("select id, country_name from lib_country", "id", "country_name");
	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);

	$PNG_TEMP_DIR = dirname(__FILE__).DIRECTORY_SEPARATOR.'qrcode_image'.DIRECTORY_SEPARATOR;
    $PNG_WEB_DIR = 'qrcode_image/';

	foreach (glob($PNG_WEB_DIR."*.png") as $filename) {
		@unlink($filename);
	}

	if (!file_exists($PNG_TEMP_DIR)) mkdir($PNG_TEMP_DIR);

	$filename = $PNG_TEMP_DIR.'test.png';
	$errorCorrectionLevel = 'L';
	$matrixPointSize = 4;

    include "../../ext_resource/phpqrcode/qrlib.php";

	$filename = $PNG_TEMP_DIR.md5($data[1]).'.png';
	QRcode::png($data[1], $filename, $errorCorrectionLevel, $matrixPointSize, 2);

	?>
	<style type="text/css">
		body{
			margin: 0 auto;
			padding:0;
			background-size:912px 1056px;
            background-repeat: no-repeat;
		}
		tr td {
			font-size: 9pt;
		}
		.stlinfo{font-size: 9pt;height: 40px; border: 1px solid black;}
		.stlinfobody{font-size: 9pt; border: 1px solid black;}
	</style>
	<div style="width:1000px;">
		<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;margin-bottom:10px; ">
			<tr>
				<td></td>
				<td colspan="7" align="center" style="font-size:25px; padding-bottom:5px">
					<strong><? echo $com_dtls[0]; ?></strong></td>
					<td style="font-size:xx-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">

					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='70' width='130'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='70' width='130'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="7" align="center" >
						<?
						//echo $com_dtls[1];
					$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$data[0]");
					foreach ($nameArray as $result)
					{
						echo $result[csf('city')];?>
						COUNTRY: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
						Email : <? echo $result[csf('email')];?>
						Website : <? echo $result[csf('website')];
					}
					?>
			</td>
			<td>&nbsp;</td>
		</tr>
		<tr>
		    <td></td>
			<td colspan="7" align="center" style="padding-top: 5px;padding-bottom: 10px;"><strong><u>Yarn Delivery Challan</u></strong>
			</td>
			<td>&nbsp;</td>
		</tr>
		<tr>
			<td width="80"><strong>Issue No:</strong></td>
			<td width="195px"><? echo $dataArray[0][csf('issue_number')]; ?></td>
			<td width="50"></td>
			<td width="120"><strong>Booking:</strong></td>
			<td width="185px">
				<?
				if( $dataArray[0][csf('issue_basis')]==3 )
				{
					$bookingNo = $planbooking[0][csf('pln_booking_no')];
				} else {
					$bookingNo = $dataArray[0][csf('booking_no')];
				}
				echo $bookingNo;
				?>
			</td>
			<td width="50"></td>
			<!-- <td width="150"><strong>Knitting Source:</strong></td>
			<td width="150px"><? //echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td> -->
		</tr>
		<tr>
			<td><strong>Program No:</strong></td>
			<td width="185px"><? echo $dataArray[0][csf('challan_no')]; ?></td>
			<td width="50"></td>
			<td><strong>Issue Purpose:</strong></td>
			<td width="175px"><? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
			echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
			?></td>
			<td width="50"></td>
			<td><strong>Issue Date:</strong></td>
			<td width="175px"><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
		</tr>
			<tr>
				<td valign="top"><strong>Issue To:</strong></td>
				<?
				if ($dataArray[0][csf('knit_dye_source')] == 3) {
					$supp_add = $dataArray[0][csf('knit_dye_company')];
					$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
					foreach ($nameArray as $result) {
						$address = "";
						if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($nameArray);
				}

				$loan_party_add = $dataArray[0][csf('loan_party')];
				$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
				foreach ($loanPartyArray as $result) {
					$addressParty = "";
					if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
				}
				unset($loanPartyArray);
				?>
				<td valign="top">
					<strong>
						<?
						 echo $company_library[$data[0]];
						?>
					</strong>
				</td>
				<td width="50"></td>
				<td valign="top"><strong>Address:</strong></td>
				<td>
				    <?
					if ($dataArray[0][csf('issue_purpose')] == 3) {
						echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
					} else if ($dataArray[0][csf('issue_purpose')] == 5) {
						echo $addressParty;
					} else {
						if ($dataArray[0][csf('knit_dye_source')] == 1)
							echo $company_library[$dataArray[0][csf('knit_dye_company')]];
						else
							echo $address;
					}
					?>
				</td>
				<td width="50"></td>
				<td valign="top"><strong>Location:</strong></td>
				<td valign="top"><? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>


			</tr>
			<tr>
				<td><strong>Demand No.:</strong></td>
				<td width="185px"><? //echo $dataArray[0][csf('booking_id')];
				?></td>
			    <td width="50"></td>
				<td><strong>Do No:</strong></td>
				<td width="175px"><? //echo $dataArray[0][csf('remarks')];
				?></td>
			</tr>
			<tr>
				<td valign="top"><strong>Remarks :</strong></td>
				<td colspan="5"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
			</tr>
			<?
			if ($print_with_vat == 1) {
				?>
				<tr>
					<!-- <td><strong>VAT Number :</strong></td>
					<td><p>
						<?
					$vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
					echo $vat_no;
					?></p></td> -->
					<td><strong>QR Code:</strong></td>
					<td colspan="3" ><img src="<? echo $PNG_WEB_DIR.basename($filename);?>" height="70" width=""></td>
				</tr>
				<?
			} else {
				?>
				<tr>
					<td valign="top">&nbsp;</strong></td>
					<td>&nbsp;</td>
					<td ><strong>QR Code:</strong></td>
					<td colspan="3" ><img src="<? echo $PNG_WEB_DIR.basename($filename);?>" height="70" width=""></td>
				</tr>
				<?
			}
			?>
		</table>


		<div style="width:100%; padding-top:10px">
			<div style="clear:both;">
				<table style="margin-right:-40px; " cellspacing="0" width="1160" border="1" rules="all">
				<thead bgcolor="#CCCCCC">
					<th width="20" class='stlinfo'>SL</th>
					<th width="45" class='stlinfo'>Req. No</th>
					<th width="50" class='stlinfo'>Program No</th>
					<th width="50" class='stlinfo'>Lot No</th>
					<th width="65" class='stlinfo'>Y. Type</th>
					<th width="110" class='stlinfo'>Item Details</th>
					<th width="65" class='stlinfo'>Dye. Color</th>

					<th width="60" class='stlinfo'><b>Issue Qty(kg)</b></th>
					<th width="60" class='stlinfo'>Rtnbl Qty(kg)</th>
					<th width="80" class='stlinfo'>Bag & Cone</th>
					<th width="80" class='stlinfo'>Store</th>
					<th width="80" class='stlinfo'>Floor</th>
					<th width="80" class='stlinfo'>Room</th>

					<th width="100" class='stlinfo'>Buyer & Job</th>
					<th width="120" class='stlinfo'>Order & Style</th>
					<th class='stlinfo'>Inte. Ref & File</th>

				</thead>
				<?
				//$wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");
				$cond = "";
				if ($data[5] != "") $cond .= " and c.id='$data[5]'";

				$i = 1;
				if ($db_type == 0)
				{
					$sql_result = sql_select("select a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
				}
				else
				{
					$sql_result = sql_select("select a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
				}

				//for requisition no
				$tmp_req_no_arr = array();
				$tmp_po_id_arr = array();
				foreach ($sql_result as $row)
				{
					$tmp_req_no_arr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];

					//for po
					$exp_po_id = array();
					$exp_po_id = explode(",", $row[csf('po_id')]);
					foreach($exp_po_id as $pkey=>$pval)
					{
						$tmp_po_id_arr[$pval] = $pval;
					}
				}

				$con = connect();
				execute_query("DELETE FROM TMP_REQS_NO WHERE USERID = ".$user_id);
				execute_query("DELETE FROM TMP_POID WHERE USERID = ".$user_id);
				oci_commit($con);

				//for requisition no insert
				$con = connect();
				foreach($tmp_req_no_arr as $key=>$val)
				{
					execute_query("INSERT INTO TMP_REQS_NO(REQS_NO, USERID) VALUES('".$val."', '".$user_id."')");
				}

				foreach($tmp_po_id_arr as $key=>$val)
				{
					execute_query("INSERT INTO TMP_POID(POID, USERID) VALUES('".$val."', '".$user_id."')");
				}
				oci_commit($con);
				//end for requisition no

				//for requisition no
				$po_id_req_array = array();
				$is_sales_array = array();
				if ($db_type == 0)
				{
					$poID = " select c.knit_id,c.requisition_no,a.buyer_id,a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id AND c.requisition_no IN(SELECT REQS_NO FROM TMP_REQS_NO WHERE USERID = ".$user_id.") group by c.knit_id,c.requisition_no,a.buyer_id,a.is_sales ";
				}
				else
				{
					$poID = "select c.knit_id,c.requisition_no,a.buyer_id,a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id AND c.requisition_no IN(SELECT REQS_NO FROM TMP_REQS_NO WHERE USERID = ".$user_id.") group by c.knit_id,c.requisition_no,a.buyer_id,a.is_sales ";
				}

				//echo $poID;
				$poID_sql_result = sql_select($poID);
				foreach ($poID_sql_result as $row)
				{
					$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
					$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
					$program_array[$row[csf('requisition_no')]]['program_no'] = $row[csf('knit_id')];
					$program_array[$row[csf('requisition_no')]]['buyer_id'] = $row[csf('buyer_id')];
				}
				unset($poID_sql_result);
				//end for requisition no
				/*echo "<pre>";
				print_r($program_array);
				echo "</pre>";*/

				//for po
				$po_array = array();
				$job_array = array();
				$costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0] AND b.id IN(SELECT POID FROM TMP_POID WHERE USERID = ".$user_id.")");
				foreach ($costing_sql as $row)
				{
					$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
					$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
					$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
					$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
					$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
					$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
					$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
					$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
				}
				unset($costing_sql);
				//end for po

				//for sales order info
				$job_no_array = array();
				$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst where id IN(SELECT POID FROM TMP_POID WHERE USERID = ".$user_id.")");
				foreach ($jobData as $row)
				{
					$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
					$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
					$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
					$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
				}
				//end for sales order info
				execute_query("DELETE FROM TMP_REQS_NO WHERE USERID = ".$user_id); //after using temp tbl data delete
				execute_query("DELETE FROM TMP_POID WHERE USERID = ".$user_id);
				oci_commit($con);

				$all_req_no = '';
				$all_prod_id = '';
				$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
				$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
				foreach ($sql_result as $row) {
					//if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
					if ($row[csf('requisition_no')] != '') {
						if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
						if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
					}
					$order_qnty_val = $row[csf('cons_quantity')];
					$order_qnty_val_sum += $order_qnty_val;

					$order_amount_val = $row[csf('order_amount')];
					$order_amount_val_sum += $order_amount_val;

					$no_of_bags_val = $row[csf('no_of_bags')];
					$no_of_bags_val_sum += $no_of_bags_val;

					$po_id = explode(",", $row[csf('po_id')]);
					$po_no = '';
					$style_ref = '';
					$job_no = '';
					$buyer = '';
						//$data=explode('*',$data);
					$productdtls = $row[csf('product_name_details')];
					$productArr = explode(' ', $productdtls);

					$proddtls = '';
					if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
					} else if ($productArr[0] != '' && $productArr[1] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1];
					} else if ($productArr[0] != '') {
						$proddtls = $productArr[0];
					} else {
						$proddtls = '';
					}

					$internal_ref = '';
					$file_no = '';
					if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
					{
						foreach ($po_id as $val) {
							if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
							if ($job_no == '') $job_no = $po_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
							if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

							if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
							if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
						}
						$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
						$job_file = array_unique(explode(",", rtrim($file_no, ", ")));
						$ref_cond = '';
						foreach ($job_ref as $ref) {
								//$ref_cond.=", ".$ref;
							if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
						}
						$file_con = '';
						foreach ($job_file as $file) {
							if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
						}

						$buyer_job = '';
						if ($row[csf('issue_basis')] == 1)
						{
							if ($dataArray[0][csf('issue_purpose')] == 8)
							{
								$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
							}
							else
							{
								if ($row[csf('buyer_job_no')] != "")
								{
									$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
								}
								else
								{
									$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
								}
							}
						} else if ($row[csf('issue_basis')] == 2) {
							$buyer_job = '';
						}
					}
					else if ($row[csf('issue_basis')] == 3)
					{
						$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
							//print_r($ex_data);

						if ($is_sales_array[$row[csf('requisition_no')]] == 1)
						{
							$buyer_job = '';
							foreach (array_unique($po_id) as $val) {
								if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];

								if ($buyer_job == '') {
									if ($job_no_array[$val]['within_group'] == 1) {
										$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
									} else {
										$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
									}
								}

								if ($job_no_array[$val]['within_group'] != 1) {
									$ref_cond = '';
								}

							}
						}
						else
						{
							foreach ($po_id as $val)
							{
								if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
								if ($job_no == '') $job_no = $po_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
								if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
							}

							$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
							$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

							$ref_cond = '';
							foreach ($job_ref as $ref) {
									//$ref_cond.=", ".$ref;
								if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
							}

							$file_con = '';
							foreach ($job_file as $file) {
								if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
							}

							$buyer_job = $buyer_arr[$program_array[$row[csf('requisition_no')]]['buyer_id']];

							if ($job_no != '')
							{
								$buyer_job .= ' & ' . $job_no;
							}
						}
					}
					else
					{
						foreach (array_unique($po_id) as $val) {
							if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
							if ($buyer_job == '') {
								if ($job_no_array[$val]['within_group'] == 1) {
									$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
								} else {
									$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
								}
							}
						}
					}

					$no_bag_cone = "";
					$wt_bag_cone = "";
					if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

					if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];

					//for supplier
					if($row[csf('is_within_group')] == 1)
					{
						$supplier_name = $company_library[$row[csf('supplier_id')]];
					}
					else
					{
						$supplier_name = $supplier_arr[$row[csf('supplier_id')]];
					}
					?>
					<tbody>
						<tr bgcolor="<? echo $bgcolor; ?>">
							<td width="20" class='stlinfobody'><? echo $i; ?></td>
							<td width="45" class='stlinfobody'>
								<div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
							</td>
							<td width="50" class='stlinfobody'>
								<?  echo $program_array[$row[csf('requisition_no')]]['program_no']; ?>
							</td>
							<td width="50" class='stlinfobody'>
								<div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
							</td>

							<td width="65" class='stlinfobody'>
								<div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
							</td>
							<td width="110" class='stlinfobody'>
								<div style="word-wrap:break-word; width:110px">
									<?
									//echo $proddtls;
									echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
									?>
								</div>
							</td>


							<td width="65" class='stlinfobody'>
								<div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
							&nbsp;</div>
						</td>



						<td align="right"
						width="60" class='stlinfobody'><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
						<td align="right"
						width="60" class='stlinfobody'><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
						<td width="80" class='stlinfobody'>
							<div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
						&nbsp;</div>
					</td>
					<td width="80" class='stlinfobody'>
						<div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
					</td>
					<td width="80" class='stlinfobody'>
					<div style="word-wrap:break-word; width:80px"><? echo $floor_room_rack_arr[$row[csf('floor_id')]]; ?></div>
					</td>
					<td width="80" class='stlinfobody'>
						<div style="word-wrap:break-word; width:80px"><? echo $floor_room_rack_arr[$row[csf('room')]]; ?></div>
					</td>

					<td width="100" class='stlinfobody'>
						<div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
					</td>
					<td width="120" class='stlinfobody'>
						<div style="word-wrap:break-word; width:120px"><? echo $po_no;
						if ($style_ref != "") echo ' & ' . $style_ref; else echo '&nbsp;'; ?></div>
					</td>
					<td class='stlinfobody'>
						<div style="word-wrap:break-word; width:80px"><? echo ltrim($ref_cond, ", ");
						if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?></div>
					</td>

				</tr>
				<?
				$uom_unit = "Kg";
				$uom_gm = "Grams";
				$tot_return_qty += $row[csf('returnable_qnty')];
				$tot_bag += $no_of_bags_val;
				$tot_cone += $row[csf('cone_per_bag')];
				$tot_w_bag += $row[csf('weight_per_bag')];
				$tot_w_cone += $row[csf('weight_per_cone')];
				$req_no = $row[csf('requisition_no')];
				$i++;
			}
			?>
			<tr bgcolor="#CCCCCC" >
				<td align="right" colspan="7" class='stlinfobody'><b>Total&nbsp;</b></td>
				<td align="right" class='stlinfobody'>
					<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
				</td>
				<td align="right" class='stlinfobody'><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
				<td class='stlinfobody'><? echo 'N:' . number_format($tot_bag, 2);
				if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
				echo '<br>W:' . number_format($tot_w_bag, 2);
				if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
				<td align="right" colspan="6" class='stlinfobody'>&nbsp;</td>
			</tr>
			<tr>
				<td colspan="17" align="left" class='stlinfobody'><b>In
					Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
			</tr>
		</tbody>
	</table>
	<p><b>Note: Received The Above in Goods Condition For Handling and Delivery.</b></p>
	</div>
	<br>
	<br>&nbsp;
	<!--================================================================-->
	<?
	if ($data[6] == 1)
	{
		if ($dataArray[0][csf('issue_basis')] == 3)
		{
			?>
			<div style="">
				<table width="850" border="1" rules="all" cellpadding="0" cellspacing="0" >
					<thead bgcolor="#CCCCCC">
						<tr>
							<th colspan="7" align="center" class='stlinfo'>Requisition Details</th>
						</tr>
						<tr>
							<th width="40" class='stlinfo'>SL</th>
							<th width="100" class='stlinfo'>Requisition No</th>
							<th width="110" class='stlinfo'>Lot No</th>
							<th width="220" class='stlinfo'>Yarn Description</th>
							<th width="110" class='stlinfo'>Brand</th>
							<th width="90" class='stlinfo'>Requisition Qty</th>
							<th class='stlinfo'>Remarks</th>
						</tr>
					</thead>
					<?
					//echo $all_req_no;
					$i = 1;
					$tot_reqsn_qnty = 0;
					$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
					$product_details_array = array();
					$sql = "select id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where item_category_id=1 and company_id='$data[0]' and status_active=1 and is_deleted=0";
					$result = sql_select($sql);

					foreach ($result as $row) {
						$compos = '';
						if ($row[csf('yarn_comp_percent2nd')] != 0) {
							$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
						} else {
							$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
						}
						$product_details_array[$row[csf('id')]]['count'] = $count_arr[$row[csf('yarn_count_id')]];
						$product_details_array[$row[csf('id')]]['comp'] = $compos;
						$product_details_array[$row[csf('id')]]['type'] = $yarn_type[$row[csf('yarn_type')]];
						$product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
						$product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
					}
					unset($result);
					$sql = "select knit_id, requisition_no, prod_id, sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where requisition_no in ($all_req_no) and status_active=1 and is_deleted=0 group by requisition_no, prod_id, knit_id";
					$nameArray = sql_select($sql);
					foreach ($nameArray as $selectResult) {
						?>
						<tr>
							<td width="40" align="center" class='stlinfobody'><? echo $i; ?></td>
							<td width="100" align="center" class='stlinfobody'>
								&nbsp;<? echo $selectResult[csf('requisition_no')]; ?></td>
							<td width="110" align="center" class='stlinfobody'>
								&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['lot']; ?></td>
							<td width="220" class='stlinfobody'>
								&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['count'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['comp'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['type']; ?></td>
							<td width="110" align="center" class='stlinfobody'>
								&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['brand']; ?></td>
							<td width="90"
									align="right" class='stlinfobody'><? echo number_format($selectResult[csf('yarn_qnty')], 2); ?>
								&nbsp;</td>
							<td class='stlinfobody'>&nbsp;<? //echo $selectResult[csf('requisition_no')];
							?></td>
						</tr>
						<?
						$tot_reqsn_qnty += $selectResult[csf('yarn_qnty')];
						$i++;
					}
					?>
					<tfoot bgcolor="#CCCCCC">
						<th colspan="5" align="right" class='stlinfo'><b>Total</b></th>
						<th align="right" class='stlinfo'><? echo number_format($tot_reqsn_qnty, 2); ?>&nbsp;</th>
						<th class='stlinfo'>&nbsp;</th>
					</tfoot>
				</table>
				<?
				if ($data[5] != 1) {
					$z = 1;
					$k = 1;
					$colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia,c.buyer_id from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

					$booking_al = "";
					foreach ($colorArray as $book)
					{
						if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];

						$prog_booking_buyer[$book[csf('booking_no')]] = $book[csf('buyer_id')];
					}
					//unset($colorArray);
					//echo $booking_no;
					$booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
					$booking_count = count(array_unique(explode(',', $booking_no)));
					//$booking_job_arr=array();
					if ($dataArray[0][csf('issue_purpose')] == 2) {
						$booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
					} else {
						$booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
					}
					//
					$booking_job_no = $booking_job[0][csf('job_no')];
					unset($booking_job);

					if ($db_type == 0) $poNoCond = "group_concat(id)";
					else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
					/*echo '='.$sql_Job.'=';
			if($sql_Job!="")
			{*/
				$sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

				$job_po = $sql_returnJob[0][csf('po_break_down_id')];
				unset($sql_returnJob);
				?>

				<table width="710" cellpadding="0" cellspacing="0" border="1" rules="all"
				style="margin-top:20px;" >
				<thead bgcolor="#CCCCCC">
					<th width="40" class='stlinfo'>SL</th>
					<th width="250" class='stlinfo'>Fabrication</th>
					<th width="120" class='stlinfo'>Color</th>
					<th width="120" class='stlinfo'>GGSM OR S/L</th>
					<th class='stlinfo'>FGSM</th>
				</thead>
				<tbody>
					<tr>
						<td width="40" align="center" class='stlinfobody'><? echo $z; ?></td>
						<td width="250"
						align="center" class='stlinfobody'><? echo $body_part[$colorArray[0][csf('body_part_id')]] . ', ' . $colorArray[0][csf('fabric_desc')]; ?></td>
						<td width="120"
						align="center" class='stlinfobody'><? echo $color_range[$colorArray[0][csf('color_range')]]; ?></td>
						<td width="120" align="center" class='stlinfobody'><? echo $colorArray[0][csf('stitch_length')]; ?></td>
						<td align="center" class='stlinfobody'><? echo $colorArray[0][csf('gsm_weight')]; ?></td>
					</tr>
				</tbody>
			</table>
			<table style="margin-top:20px;" width="650" border="1" rules="all" cellpadding="0"
			cellspacing="0" >
			<thead bgcolor="#CCCCCC">
				<th width="40" class='stlinfo'>SL</th>
				<th width="50" class='stlinfo'>Prog. No</th>
				<th width="110" class='stlinfo'>Finish Dia</th>
				<th width="170" class='stlinfo'>Machine Dia & Gauge</th>
				<th width="110" class='stlinfo'>Program Qty</th>
				<th class='stlinfo'>Remarks</th>
			</thead>
			<tbody>
				<tr>
					<td width="40" align="center" class='stlinfobody'><? echo $k; ?></td>
					<td width="50" align="center" class='stlinfobody'>&nbsp;<? echo $colorArray[0][csf('knit_id')]; ?></td>
					<td width="110" align="center" class='stlinfobody'><? echo $colorArray[0][csf('dia')]; ?></td>
					<td width="170"
					align="center" class='stlinfobody'><? echo $colorArray[0][csf('machine_dia')] . "X" . $colorArray[0][csf('machine_gg')]; ?></td>
					<td width="110"
					align="right" class='stlinfobody'><? echo number_format($colorArray[0][csf('program_qnty')], 2); ?>
				&nbsp;</td>
				<td class='stlinfobody'><? echo $colorArray[0][csf('remarks')]; ?></td>
			</tr>
			<?
			$tot_prog_qty += $colorArray[0][csf('program_qnty')];
			?>
			<tr bgcolor="#CCCCCC">
				<td colspan="4" align="right" class='stlinfo'><strong>Total : </strong></td>
				<td align="right" class='stlinfo'><? echo number_format($tot_prog_qty, 2); ?></td>
				<td class='stlinfo'>&nbsp;</td>
			</tr>
		</tbody>
	</table>
	<?
	$returnJob = '';
	$returnPo = '';
	if ($db_type == 0) {
		$booking_cond = "group_concat(a.booking_no)";
		$wo_cond = "group_concat(a.ydw_no)";
		$reqs_no = "group_concat(b.requisition_no)";
	} else if ($db_type == 2) {
		$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
		$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
		$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
	}

	if ($dataArray[0][csf('issue_purpose')] == 8)
	{
		$sql_returnJob = sql_select("select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
	}
	else if ($dataArray[0][csf('issue_purpose')] == 2)
	{
		$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

		if ($db_type == 0) $poNoCond = "group_concat(id)";
		else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
		$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
	} else {
		$sql_returnJob = sql_select("select a.job_no, a.booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' and a.booking_no in($booking_no) group by a.job_no,a.booking_no");
	}

	$returnJob = $sql_returnJob[0][csf('job_no')];
	$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
	$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
	$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
	unset($sql_returnJob);
					?>
					<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
					cellspacing="0" >
					<thead bgcolor="#CCCCCC">
						<tr>
							<th colspan="6" align="center" class='stlinfo'>Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking
							Job Deatils]</p></th>
						</tr>
						<tr>
							<th class='stlinfo'>Buyer</th>
							<th class='stlinfo'>Job</th>
							<th class='stlinfo'>Req. Qty</th>
							<th class='stlinfo'>Cuml. Issue Qty</th>
							<th class='stlinfo'>Balance Qty</th>
							<th class='stlinfo'>Remarks</th>
						</tr>
					</thead>
					<?

					$all_requ_no = "";
					if ($dataArray[0][csf('issue_purpose')] != 8)
					{
						$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");

						//$all_requ_no="'".$all_booking_sql[0][csf('requisition_no')]."'";
						$all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
					}
					if ($dataArray[0][csf('issue_purpose')] == 8)
					{
						$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");    //
						$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
					}
					else if ($dataArray[0][csf('issue_purpose')] == 2)
					{
						if ($all_requ_no != "" || $all_requ_no != 0)
						{
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						}
						else
						{
							$req_cond = "or a.requisition_no in (0)";
							$reqRet_cond = "or b.booking_no in (0)";
						}

						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
					}
					else
					{
						if ($all_requ_no != "" || $all_requ_no != 0)
						{
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						}
						else
						{
							$req_cond = "or a.requisition_no in (0)";
							$reqRet_cond = "or b.booking_no in (0)";
						}

						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");

						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
					}

					$cumulative_qty = 0;

					if ($booking_count == 1)
					{
						?>
						<tbody>
							<tr>
								<td align="center" class='stlinfobody'>

									<?

									if($job_array[$booking_job_no]['buyer']!="")
									{
										echo $buyer_arr[$job_array[$booking_job_no]['buyer']];
									}else{
										echo $buyer_arr[$row[csf('buyer_id')]];
									}

									?>
								</td>
								<td align="center" class='stlinfobody'>
									<? echo $job_array[$booking_job_no]['job']; ?>
								</td>
								<td align="center" class='stlinfobody'>

									<? echo number_format($returnReqQty, 3); ?>
								</td>
								<td align="center" class='stlinfobody'>
									<? $cumulative_qty = $total_issue_qty - $total_return_qty;
									echo number_format($cumulative_qty, 3); ?>
								</td>
								<td align="center" class='stlinfobody'>
									<? $balance_qty = $returnReqQty - $cumulative_qty;
									echo number_format($balance_qty, 3); ?>
								</td>
								<td align="center" class='stlinfobody'>
									<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
								</td>
							</tr>
							</tbody>
						</table>
					<?
				}
			}
		}
		else if ($dataArray[0][csf('issue_basis')] == 1)
		{
			?>
			<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
			cellspacing="0" >
			<thead bgcolor="#CCCCCC">
				<tr>
					<th colspan="6" align="center" class='stlinfo'>
						Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
							if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
						} ?> </th>
					</tr>
					<tr>
						<th class='stlinfo'>Buyer</th>
						<th class='stlinfo'>Job</th>
						<th class='stlinfo'>Req. Qty</th>
						<th class='stlinfo'>Cuml. Qty</th>
						<th class='stlinfo'>Balance Qty</th>
						<th class='stlinfo'>Remarks</th>
					</tr>
				</thead>
				<?
						//$booking_job_arr=array();
				$returnJob = '';
				$returnPo = '';
				if ($db_type == 0) {
					$booking_cond = "group_concat( distinct a.booking_no)";
					$wo_cond = "group_concat(a.ydw_no)";
					$reqs_no = "group_concat(b.requisition_no)";
				} else if ($db_type == 2) {
					$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
					$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
					$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
				}

				if ($dataArray[0][csf('issue_purpose')] == 8) {
					$sql_returnJob = sql_select("select a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
				} else if ($dataArray[0][csf('issue_purpose')] == 2) {
					if ($dataArray[0][csf('buyer_job_no')] != '') {
						$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

						if ($db_type == 0) $poNoCond = "group_concat(id)";
						else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
						$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
					} else {
						$sql_returnJob = sql_select("select a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
					}
				} else {
							//echo "select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
							$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");//and a.booking_no='".$dataArray[0][csf('booking_no')]."'
						}
						$returnJob = $sql_returnJob[0][csf('job_no')];
						$returnPo = $sql_po[0][csf('po_break_down_id')];
						$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
						$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

						$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];

						unset($sql_returnJob);

						$all_requ_no = "";
						if ($dataArray[0][csf('issue_purpose')] != 8) {
							//echo "select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no";
							$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

							$all_requ_no = $all_booking_sql[0][csf('requisition_no')];
							unset($all_booking_sql);
						}

						if ($dataArray[0][csf('issue_purpose')] == 8) {
							$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");    //
							$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
						} else if ($dataArray[0][csf('issue_purpose')] == 2) {
							/*if($all_requ_no!="" || $all_requ_no!=0)
					{
						//$req_cond="or a.requisition_no in ($all_requ_no)";
						//$reqRet_cond="or b.booking_no in ($all_requ_no)";
					}
					else
					{
						//$req_cond="or a.requisition_no in (0)";
						$reqRet_cond="or b.booking_no in (0)";
					}*/
					if ($dataArray[0][csf('buyer_job_no')] != "") {
						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
					} else {
								//echo "select sum(a.cons_quantity) as total_issue_qty from inv_transaction a, inv_issue_master b where b.id=a.mst_id and b.booking_no='".$dataArray[0][csf('booking_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.buyer_job_no<>'' and b.issue_purpose=2";
						$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
						$total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
					}
				} else {
					if ($dataArray[0][csf('buyer_job_no')] != "") {
						if ($all_requ_no != "" || $all_requ_no != 0) {
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						} else {
									$req_cond = "";//or a.requisition_no in (0)
									$reqRet_cond = "";//or b.booking_no in (0)
								}
								$total_issue_qty = 0;
								//echo "select sum(c.quantity) as total_issue_qty from inv_transaction a, inv_issue_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2";
								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2";
								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");

								//$total_issue_qty=return_field_value("sum(quantity) as total_issue_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=2 and entry_form=3","total_issue_qty");
								//$total_return_qty=return_field_value("sum(quantity) as total_return_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=4 and entry_form=8","total_return_qty");
							}
						}
						?>
						<tbody>
							<tr>
								<td align="center" class='stlinfobody'>
									<?
									if ($dataArray[0][csf('issue_purpose')] == 8)
									{
										echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
									}
									else
									{
										if($job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']!="")
										{
											echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
										}
										else
										{
											echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
										}
									}
									?>
								</td>
								<td align="center" class='stlinfobody'>
									<? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
								</td>
								<td align="center" class='stlinfobody'>
									<? echo number_format($returnReqQty, 3); ?>
								</td>
								<td align="center" class='stlinfobody'>

									<? $cumulative_qty = 0;
									$cumulative_qty = $total_issue_qty - $total_return_qty;
									echo number_format($cumulative_qty, 3); ?>
								</td>
								<td align="center" class='stlinfobody'>
									<? $balance_qty = $returnReqQty - $cumulative_qty;
									echo number_format($balance_qty, 3); ?>
								</td>
								<td align="center" class='stlinfobody'>
									<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
								</td>
							</tr>
						</tbody>
					</table>
					<?
				}
			}
			?>
			<br>
			<?
			echo signature_table(49, $data[0], "1230px",'','','','','','font-size:22px;');
			?>
		</div>
	</div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		/* function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? //echo $data[1]; ?>'); */
		</script>
		<?
		exit();
}

//================ For Print Button 11 =================

if ($action == "yarn_issue_print11")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print2", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$print_with_vat = $data[7];
	$company=$data[0];
	$location=$data[8];
	$store_id=$data[9];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	/*$supplier_arr=return_library_array( "select id, short_name from lib_supplier",'id','short_name');
	$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');*/

	$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');


	//$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$sql = " select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
	//echo $sql;die;
	$dataArray = sql_select($sql);

	if( $dataArray[0][csf('issue_basis')]==3 )
	{
		$planbooking = sql_select("select e.booking_no as pln_booking_no from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c,ppl_planning_info_entry_dtls d,ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$data[5]' ");
	}

	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
	?>
	<style type="text/css">
		table tbody tr td {
			font-size: 14px;
		}
	</style>
	<div style="width:1000px;">
		<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
			<tr>
				<td colspan="6" align="center" style="font-size:18px">
					<strong><? echo $com_dtls[0]; ?></strong></td>
					<td style="font-size:xx-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">

					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="4" align="center">
						<?
						echo $com_dtls[1];
					/*$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$data[0]");
				foreach ($nameArray as $result)
				{
				?>
					Plot No: <? echo $result[csf('plot_no')]; ?>
					Level No: <? echo $result[csf('level_no')]?>
					Road No: <? echo $result[csf('road_no')]; ?>
					Block No: <? echo $result[csf('block_no')];?>
					City No: <? echo $result[csf('city')];?>
					Zip Code: <? echo $result[csf('zip_code')]; ?>
					Province No: <?php echo $result[csf('province')];?>
					Country: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
					Email Address: <? echo $result[csf('email')];?>
					Website No: <? echo $result[csf('website')];
				}*/
				?>
			</td>
			<td>&nbsp;</td>
		</tr>
		<tr>
			<td colspan="6" align="center" style="font-size:16px"><strong><u>Yarn Delivery Challan/Gate Pass</u></strong></center>
			</td>
			<td>&nbsp;</td>
		</tr>
		<tr>
			<td width="160"><strong>Issue No:</strong></td>
			<td width="175px"><? echo $dataArray[0][csf('issue_number')]; ?></td>
			<td width="120"><strong>Booking:</strong></td>
			<td width="175px">
				<?
				if( $dataArray[0][csf('issue_basis')]==3 )
				{
					$bookingNo = $planbooking[0][csf('pln_booking_no')];
				} else {
					$bookingNo = $dataArray[0][csf('booking_no')];
				}
				echo $bookingNo;
				?>
			</td>
			<td width="125"><strong>Knitting Source:</strong></td>
			<td width="175px"><? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
		</tr>
		<tr>
			<td><strong>Program No:</strong></td>
			<td width="175px"><? echo $dataArray[0][csf('challan_no')]; ?></td>

			<td><strong>Issue Purpose:</strong></td>
				<td width="175px"><? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
				echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
				?></td>
				<td><strong>Issue Date:</strong></td>
				<td width="175px"><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
			</tr>
			<tr>
				<td><strong>Issue To:</strong></td>
				<?
				if ($dataArray[0][csf('knit_dye_source')] == 3) {
					$supp_add = $dataArray[0][csf('knit_dye_company')];
					$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
					foreach ($nameArray as $result) {
						$address = "";
						if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($nameArray);
				}

				$loan_party_add = $dataArray[0][csf('loan_party')];
				$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
				foreach ($loanPartyArray as $result) {
					$addressParty = "";
					if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
				}
				unset($loanPartyArray);
				?>
				<td colspan="3">
					<?
					if ($dataArray[0][csf('issue_purpose')] == 3) {
						echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
					} else if ($dataArray[0][csf('issue_purpose')] == 5) {
						echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
					} else {
						if ($dataArray[0][csf('knit_dye_source')] == 1)
							echo $company_library[$dataArray[0][csf('knit_dye_company')]];
						else
							echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
					}
					?>
				</td>
				<td><strong>Location:</strong></td>
				<td><? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>


			</tr>
			<tr>
				<td><strong>Demand No.:</strong></td>
				<td width="175px"><? //echo $dataArray[0][csf('booking_id')];
				?></td>

				<td><strong>Do No:</strong></td>
				<td width="175px"><? //echo $dataArray[0][csf('remarks')];
				?></td>
			</tr>
			<tr>
				<td valign="top"><strong>Remarks :</strong></td>
				<td colspan="5"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
			</tr>
			<?
			if ($print_with_vat == 1) {
				?>
				<tr>
					<!-- <td><strong>VAT Number :</strong></td>
					<td><p>
						<?
					$vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
					echo $vat_no;
					?></p></td> -->
					<td><strong>Bar Code:</strong></td>
					<td colspan="3" id="barcode_img_id"></td>
				</tr>
				<?
			} else {
				?>
				<tr>
					<td valign="top">&nbsp;</strong></td>
					<td>&nbsp;</td>
					<td><strong>Bar Code:</strong></td>
					<td colspan="3" id="barcode_img_id"></td>
				</tr>
				<?
			}
			?>
		</table>
		<br>
		<div style="width:100%;">
			<div style="clear:both;">
				<table style="margin-right:-40px; " cellspacing="0" width="1000" border="1" rules="all"
				class="rpt_table">
				<thead bgcolor="#dddddd" style="font-size:13px">
					<th width="20">SL</th>
					<th width="45">Req. No</th>
					<th width="50">Program No</th>
					<th width="50">Lot No</th>
					<th width="65">Y. Type</th>
					<th width="110">Item Details</th>

					<th width="65">Dye. Color</th>
					<th width="60">Supp.</th>
					<th width="60"><b>Issue Qty(kg)</b></th>
					<th width="60">Rtnbl Qty(kg)</th>
					<th width="80">Bag & Cone</th>
					<th width="80">Store</th>
					<th width="100">Job</th>
					<th width="120">Order</th>
					<th>Inte. Ref & File</th>
				</thead>
				<?
				$wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");

				$cond = "";
				if ($data[5] != "") $cond .= " and c.id='$data[5]'";

				$po_array = array();
				$job_array = array();
				$costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0]");
				foreach ($costing_sql as $row) {
					$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
					$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
					$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
					$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
					$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
					$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
					$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
					$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
				}
				unset($costing_sql);

				$job_no_array = array();
				$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst");
				foreach ($jobData as $row) {
					$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
					$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
					$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
					$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
				}
					//var_dump($po_array);
				$po_id_req_array = array();
				$is_sales_array = array();
				if ($db_type == 0) {
					$poID = " select c.knit_id,c.requisition_no,a.buyer_id,a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id,c.requisition_no,a.buyer_id,a.is_sales ";
				} else {
					$poID = "select c.knit_id,c.requisition_no,a.buyer_id,a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id,c.requisition_no,a.buyer_id,a.is_sales ";
				}
				$poID_sql_result = sql_select($poID);
				foreach ($poID_sql_result as $row) {
					$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
					$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
					$program_array[$row[csf('requisition_no')]]['program_no'] = $row[csf('knit_id')];
					$program_array[$row[csf('requisition_no')]]['buyer_id'] = $row[csf('buyer_id')];
				}
				unset($poID_sql_result);

				$i = 1;
				if ($db_type == 0) {
					$sql_result = sql_select("select a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
				} else {
					$sql_result = sql_select("select a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
				}
				$all_req_no = '';
				$all_prod_id = '';
				$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
				$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
				foreach ($sql_result as $row) {
					if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
					if ($row[csf('requisition_no')] != '') {
						if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
						if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
					}
					$order_qnty_val = $row[csf('cons_quantity')];
					$order_qnty_val_sum += $order_qnty_val;

					$order_amount_val = $row[csf('order_amount')];
					$order_amount_val_sum += $order_amount_val;

					$no_of_bags_val = $row[csf('no_of_bags')];
					$no_of_bags_val_sum += $no_of_bags_val;

					$po_id = explode(",", $row[csf('po_id')]);
					$po_no = '';
					$style_ref = '';
					$job_no = '';
					$buyer = '';
						//$data=explode('*',$data);
					$productdtls = $row[csf('product_name_details')];
					$productArr = explode(' ', $productdtls);

					$proddtls = '';
					if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
					} else if ($productArr[0] != '' && $productArr[1] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1];
					} else if ($productArr[0] != '') {
						$proddtls = $productArr[0];
					} else {
						$proddtls = '';
					}

					$internal_ref = '';
					$file_no = '';
					if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
					{
						foreach ($po_id as $val) {
							if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
							if ($job_no == '') $job_no = $po_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
							if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

							if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
							if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
						}
						$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
						$job_file = array_unique(explode(",", rtrim($file_no, ", ")));
						$ref_cond = '';
						foreach ($job_ref as $ref) {
								//$ref_cond.=", ".$ref;
							if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
						}
						$file_con = '';
						foreach ($job_file as $file) {
							if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
						}

						$buyer_job = '';
						if ($row[csf('issue_basis')] == 1)
						{
							if ($dataArray[0][csf('issue_purpose')] == 8)
							{
								$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
							}
							else
							{
								if ($row[csf('buyer_job_no')] != "")
								{
									$buyer_job = $row[csf('buyer_job_no')];
								}
								else
								{
									$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
								}
							}
						} else if ($row[csf('issue_basis')] == 2) {
							$buyer_job = '';
						}
					}
					else if ($row[csf('issue_basis')] == 3)
					{
						$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
							//print_r($ex_data);

						if ($is_sales_array[$row[csf('requisition_no')]] == 1)
						{
							$buyer_job = '';
							foreach (array_unique($po_id) as $val) {
								if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];

								if ($buyer_job == '') {
									if ($job_no_array[$val]['within_group'] == 1) {
										$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
									} else {
										$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
									}
								}

								if ($job_no_array[$val]['within_group'] != 1) {
									$ref_cond = '';
								}

							}
						}
						else
						{
							foreach ($po_id as $val)
							{
								if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
								if ($job_no == '') $job_no = $po_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
								if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
							}

							$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
							$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

							$ref_cond = '';
							foreach ($job_ref as $ref) {
									//$ref_cond.=", ".$ref;
								if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
							}

							$file_con = '';
							foreach ($job_file as $file) {
								if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
							}

							//$buyer_job = $buyer_arr[$program_array[$row[csf('requisition_no')]]['buyer_id']];

							if ($job_no != '')
							{
								$buyer_job =  $job_no;
							}
						}
					}
					else
					{
						foreach (array_unique($po_id) as $val) {
							if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
							if ($buyer_job == '') {
								if ($job_no_array[$val]['within_group'] == 1) {
									//$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
								} else {
									//$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
								}
							}
						}
					}

					$no_bag_cone = "";
					$wt_bag_cone = "";
					if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

					if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
					?>
					<tbody>
						<tr bgcolor="<? echo $bgcolor; ?>">
							<td width="20"><? echo $i; ?></td>
							<td width="45">
								<div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
							</td>
							<td width="50">
								<?  echo $program_array[$row[csf('requisition_no')]]['program_no']; ?>
							</td>
							<td width="50">
								<div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
							</td>

							<td width="65">
								<div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
							</td>
							<td width="110">
								<div style="word-wrap:break-word; width:110px">
									<?
									//echo $proddtls;
									echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
									?>
								</div>
							</td>


							<td width="65">
								<div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
							&nbsp;</div>
						</td>

						<td width="60">
							<div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
						</td>

						<td align="right"
						width="60"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
						<td align="right"
						width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
						<td width="80">
							<div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
						&nbsp;</div>
					</td>
					<td width="80">
						<div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
					</td>
					<td width="100">
						<div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
					</td>
					<td width="120">
						<div style="word-wrap:break-word; width:120px"><? echo $po_no; ?></div>
					</td>
					<td>
						<div style="word-wrap:break-word; width:80px"><? echo ltrim($ref_cond, ", ");
						if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?></div>
					</td>
				</tr>
				<?
				$uom_unit = "Kg";
				$uom_gm = "Grams";
				$tot_return_qty += $row[csf('returnable_qnty')];
				$tot_bag += $no_of_bags_val;
				$tot_cone += $row[csf('cone_per_bag')];
				$tot_w_bag += $row[csf('weight_per_bag')];
				$tot_w_cone += $row[csf('weight_per_cone')];
				$req_no = $row[csf('requisition_no')];
				$i++;
			}
			?>
			<tr bgcolor="#CCCCCC" style="font-size:13px">
				<td align="right" colspan="8"><b>Total</b></td>
				<td align="right">
					<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
				</td>
				<td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
				<td><? echo 'N:' . number_format($tot_bag, 2);
				if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
				echo '<br>W:' . number_format($tot_w_bag, 2);
				if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
				<td align="right" colspan="4">&nbsp;</td>
			</tr>
			<tr>
				<td colspan="15" align="left"><b>In
					Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
			</tr>
		</tbody>
	</table>
	<p style="font-size:15px;"><b>Note: Received The Above in Goods Condition For Handling and Delivery.</b></p>
	</div>
	<br>
	<br>&nbsp;
	<!--================================================================-->
	<?
	if ($data[6] == 1)
	{
		if ($dataArray[0][csf('issue_basis')] == 3)
		{
			?>
			<div style="">
				<table width="850" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
					<thead>
						<tr>
							<th colspan="7" align="center">Requisition Details</th>
						</tr>
						<tr>
							<th width="40">SL</th>
							<th width="100">Requisition No</th>
							<th width="110">Lot No</th>
							<th width="220">Yarn Description</th>
							<th width="110">Brand</th>
							<th width="90">Requisition Qty</th>
							<th>Remarks</th>
						</tr>
					</thead>
					<?
					//echo $all_req_no;
					$i = 1;
					$tot_reqsn_qnty = 0;
					$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
					$product_details_array = array();
					$sql = "select id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where item_category_id=1 and company_id='$data[0]' and status_active=1 and is_deleted=0";
					$result = sql_select($sql);

					foreach ($result as $row) {
						$compos = '';
						if ($row[csf('yarn_comp_percent2nd')] != 0) {
							$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
						} else {
							$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
						}
						$product_details_array[$row[csf('id')]]['count'] = $count_arr[$row[csf('yarn_count_id')]];
						$product_details_array[$row[csf('id')]]['comp'] = $compos;
						$product_details_array[$row[csf('id')]]['type'] = $yarn_type[$row[csf('yarn_type')]];
						$product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
						$product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
					}
					unset($result);
					$sql = "select knit_id, requisition_no, prod_id, sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where requisition_no in ($all_req_no) and status_active=1 and is_deleted=0 group by requisition_no, prod_id, knit_id";
					$nameArray = sql_select($sql);
					foreach ($nameArray as $selectResult) {
						?>
						<tr>
							<td width="40" align="center"><? echo $i; ?></td>
							<td width="100" align="center">
								&nbsp;<? echo $selectResult[csf('requisition_no')]; ?></td>
								<td width="110" align="center">
									&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['lot']; ?></td>
									<td width="220">
										&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['count'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['comp'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['type']; ?></td>
										<td width="110" align="center">
											&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['brand']; ?></td>
											<td width="90"
											align="right"><? echo number_format($selectResult[csf('yarn_qnty')], 2); ?>
										&nbsp;</td>
							<td>&nbsp;<? //echo $selectResult[csf('requisition_no')];
							?></td>
						</tr>
						<?
						$tot_reqsn_qnty += $selectResult[csf('yarn_qnty')];
						$i++;
					}
					?>
					<tfoot>
						<th colspan="5" align="right"><b>Total</b></th>
						<th align="right"><? echo number_format($tot_reqsn_qnty, 2); ?>&nbsp;</th>
						<th>&nbsp;</th>
					</tfoot>
				</table>
				<?
				if ($data[5] != 1) {
					$z = 1;
					$k = 1;
					$colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia,c.buyer_id from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

					$booking_al = "";
					foreach ($colorArray as $book)
					{
						if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];

						$prog_booking_buyer[$book[csf('booking_no')]] = $book[csf('buyer_id')];
					}
					//unset($colorArray);
					//echo $booking_no;
					$booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
					$booking_count = count(array_unique(explode(',', $booking_no)));
					//$booking_job_arr=array();
					if ($dataArray[0][csf('issue_purpose')] == 2) {
						$booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
					} else {
						$booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
					}
					//
					$booking_job_no = $booking_job[0][csf('job_no')];
					unset($booking_job);

					if ($db_type == 0) $poNoCond = "group_concat(id)";
					else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
					/*echo '='.$sql_Job.'=';
			if($sql_Job!="")
			{*/

				$sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

				$job_po = $sql_returnJob[0][csf('po_break_down_id')];
				unset($sql_returnJob);
				?>

				<table width="710" cellpadding="0" cellspacing="0" border="1" rules="all"
				style="margin-top:20px;" class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="250">Fabrication</th>
					<th width="120">Color</th>
					<th width="120">GGSM OR S/L</th>
					<th>FGSM</th>
				</thead>
				<tbody>
					<tr>
						<td width="40" align="center"><? echo $z; ?></td>
						<td width="250"
						align="center"><? echo $body_part[$colorArray[0][csf('body_part_id')]] . ', ' . $colorArray[0][csf('fabric_desc')]; ?></td>
						<td width="120"
						align="center"><? echo $color_range[$colorArray[0][csf('color_range')]]; ?></td>
						<td width="120" align="center"><? echo $colorArray[0][csf('stitch_length')]; ?></td>
						<td align="center"><? echo $colorArray[0][csf('gsm_weight')]; ?></td>
					</tr>
				</tbody>
			</table>
			<table style="margin-top:20px;" width="650" border="1" rules="all" cellpadding="0"
			cellspacing="0" class="rpt_table">
			<thead>
				<th width="40">SL</th>
				<th width="50">Prog. No</th>
				<th width="110">Finish Dia</th>
				<th width="170">Machine Dia & Gauge</th>
				<th width="110">Program Qty</th>
				<th>Remarks</th>
			</thead>
			<tbody>
				<tr>
					<td width="40" align="center"><? echo $k; ?></td>
					<td width="50" align="center">&nbsp;<? echo $colorArray[0][csf('knit_id')]; ?></td>
					<td width="110" align="center"><? echo $colorArray[0][csf('dia')]; ?></td>
					<td width="170"
					align="center"><? echo $colorArray[0][csf('machine_dia')] . "X" . $colorArray[0][csf('machine_gg')]; ?></td>
					<td width="110"
					align="right"><? echo number_format($colorArray[0][csf('program_qnty')], 2); ?>
				&nbsp;</td>
				<td><? echo $colorArray[0][csf('remarks')]; ?></td>
			</tr>
			<?
			$tot_prog_qty += $colorArray[0][csf('program_qnty')];
			?>
			<tr>
				<td colspan="4" align="right"><strong>Total : </strong></td>
				<td align="right"><? echo number_format($tot_prog_qty, 2); ?></td>
				<td>&nbsp;</td>
			</tr>
		</tbody>
	</table>
	<?
	$returnJob = '';
	$returnPo = '';
	if ($db_type == 0) {
		$booking_cond = "group_concat(a.booking_no)";
		$wo_cond = "group_concat(a.ydw_no)";
		$reqs_no = "group_concat(b.requisition_no)";
	} else if ($db_type == 2) {
		$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
		$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
		$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
	}

	if ($dataArray[0][csf('issue_purpose')] == 8)
	{
		$sql_returnJob = sql_select("select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
	}
	else if ($dataArray[0][csf('issue_purpose')] == 2)
	{
		$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

		if ($db_type == 0) $poNoCond = "group_concat(id)";
		else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
		$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
	} else {
		$sql_returnJob = sql_select("select a.job_no, a.booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' and a.booking_no in($booking_no) group by a.job_no,a.booking_no");

	}

	$returnJob = $sql_returnJob[0][csf('job_no')];
					//$returnPo=$sql_po[0][csf('po_break_down_id')];
	$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
	$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
	$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
	unset($sql_returnJob);

					/*$req_no_retInJob=sql_select("select $reqs_no as req_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");
					$reqNo_inJob=$req_no_retInJob[0][csf('req_no')];*/
					?>
					<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
					cellspacing="0" class="rpt_table">
					<thead>
						<tr>
							<th colspan="6" align="center">Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking
							Job Deatils]</p></th>
						</tr>
						<tr>
							<th>Buyer</th>
							<th>Job</th>
							<th>Req. Qty</th>
							<th>Cuml. Issue Qty</th>
							<th>Balance Qty</th>
							<th>Remarks</th>
						</tr>
					</thead>
					<?

					$all_requ_no = "";
					if ($dataArray[0][csf('issue_purpose')] != 8)
					{
						$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");

						//$all_requ_no="'".$all_booking_sql[0][csf('requisition_no')]."'";
						$all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
					}
					if ($dataArray[0][csf('issue_purpose')] == 8)
					{
						$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");    //
						$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
					}
					else if ($dataArray[0][csf('issue_purpose')] == 2)
					{
						if ($all_requ_no != "" || $all_requ_no != 0)
						{
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						}
						else
						{
							$req_cond = "or a.requisition_no in (0)";
							$reqRet_cond = "or b.booking_no in (0)";
						}

						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
					}
					else
					{
						if ($all_requ_no != "" || $all_requ_no != 0)
						{
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						}
						else
						{
							$req_cond = "or a.requisition_no in (0)";
							$reqRet_cond = "or b.booking_no in (0)";
						}

						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");

						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
					}

					$cumulative_qty = 0;

					if ($booking_count == 1)
					{
						?>
						<tbody>
							<tr>
								<td align="center">

									<?

									if($job_array[$booking_job_no]['buyer']!="")
									{
										echo $buyer_arr[$job_array[$booking_job_no]['buyer']];
									}else{
										echo $buyer_arr[$row[csf('buyer_id')]];
									}

									?>
								</td>
								<td align="center">
									<? echo $job_array[$booking_job_no]['job']; ?>
								</td>
								<td align="center">

									<? echo number_format($returnReqQty, 3); ?>
								</td>
								<td align="center">
									<? $cumulative_qty = $total_issue_qty - $total_return_qty;
									echo number_format($cumulative_qty, 3); ?>
								</td>
								<td align="center">
									<? $balance_qty = $returnReqQty - $cumulative_qty;
									echo number_format($balance_qty, 3); ?>
								</td>
								<td align="center">
									<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
								</td>
							</tr>
							</tbody>
						</table>
					<?
				}
			}
		}
		else if ($dataArray[0][csf('issue_basis')] == 1)
		{
			?>
			<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
			cellspacing="0" class="rpt_table">
			<thead>
				<tr>
					<th colspan="6" align="center">
						Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
							if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
						} ?> </th>
					</tr>
					<tr>
						<th>Buyer</th>
						<th>Job</th>
						<th>Req. Qty</th>
						<th>Cuml. Qty</th>
						<th>Balance Qty</th>
						<th>Remarks</th>
					</tr>
				</thead>
				<?
						//$booking_job_arr=array();
				$returnJob = '';
				$returnPo = '';
				if ($db_type == 0) {
					$booking_cond = "group_concat( distinct a.booking_no)";
					$wo_cond = "group_concat(a.ydw_no)";
					$reqs_no = "group_concat(b.requisition_no)";
				} else if ($db_type == 2) {
					$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
					$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
					$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
				}

				if ($dataArray[0][csf('issue_purpose')] == 8) {
					$sql_returnJob = sql_select("select a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
				} else if ($dataArray[0][csf('issue_purpose')] == 2) {
					if ($dataArray[0][csf('buyer_job_no')] != '') {
						$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

						if ($db_type == 0) $poNoCond = "group_concat(id)";
						else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
						$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
					} else {
						$sql_returnJob = sql_select("select a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
					}
				} else {
							//echo "select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
							$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");//and a.booking_no='".$dataArray[0][csf('booking_no')]."'
						}
						$returnJob = $sql_returnJob[0][csf('job_no')];
						$returnPo = $sql_po[0][csf('po_break_down_id')];
						$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
						$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

						$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];

						unset($sql_returnJob);

						$all_requ_no = "";
						if ($dataArray[0][csf('issue_purpose')] != 8) {
							//echo "select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no";
							$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

							$all_requ_no = $all_booking_sql[0][csf('requisition_no')];
							unset($all_booking_sql);
						}

						if ($dataArray[0][csf('issue_purpose')] == 8) {
							$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");    //
							$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
						} else if ($dataArray[0][csf('issue_purpose')] == 2) {
							/*if($all_requ_no!="" || $all_requ_no!=0)
					{
						//$req_cond="or a.requisition_no in ($all_requ_no)";
						//$reqRet_cond="or b.booking_no in ($all_requ_no)";
					}
					else
					{
						//$req_cond="or a.requisition_no in (0)";
						$reqRet_cond="or b.booking_no in (0)";
					}*/
					if ($dataArray[0][csf('buyer_job_no')] != "") {
						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
					} else {
								//echo "select sum(a.cons_quantity) as total_issue_qty from inv_transaction a, inv_issue_master b where b.id=a.mst_id and b.booking_no='".$dataArray[0][csf('booking_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.buyer_job_no<>'' and b.issue_purpose=2";
						$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
						$total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
					}
				} else {
					if ($dataArray[0][csf('buyer_job_no')] != "") {
						if ($all_requ_no != "" || $all_requ_no != 0) {
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						} else {
									$req_cond = "";//or a.requisition_no in (0)
									$reqRet_cond = "";//or b.booking_no in (0)
								}
								$total_issue_qty = 0;
								//echo "select sum(c.quantity) as total_issue_qty from inv_transaction a, inv_issue_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2";
								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2";
								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");

								//$total_issue_qty=return_field_value("sum(quantity) as total_issue_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=2 and entry_form=3","total_issue_qty");
								//$total_return_qty=return_field_value("sum(quantity) as total_return_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=4 and entry_form=8","total_return_qty");
							}
						}
						?>
						<tbody>
							<tr>
								<td align="center">
									<?
									if ($dataArray[0][csf('issue_purpose')] == 8)
									{
										echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
									}
									else
									{
										if($job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']!="")
										{
											echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
										}
										else
										{
											echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
										}
									}
									?>
								</td>
								<td align="center">
									<? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
								</td>
								<td align="center">
									<? echo number_format($returnReqQty, 3); ?>
								</td>
								<td align="center">
									<? $cumulative_qty = 0;
									$cumulative_qty = $total_issue_qty - $total_return_qty;
									echo number_format($cumulative_qty, 3); ?>
								</td>
								<td align="center">
									<? $balance_qty = $returnReqQty - $cumulative_qty;
									echo number_format($balance_qty, 3); ?>
								</td>
								<td align="center">
									<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
								</td>
							</tr>
						</tbody>
					</table>
					<?
				}
			}
			?>
			<br>
			<?
			echo signature_table(49, $data[0], "1030px");
			?>
		</div>
	</div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');
		</script>
		<?
		exit();
	}


if ($action == "yarn_issue_print3")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print3", "../../", 1, 1, '', '', '');
	$data= explode('*', $data);
	$print_with_vat = $data[7];
	$company=$data[0];
	$location=$data[8];
	$store_id=$data[9];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");

	$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
    //$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");

	$sql = " select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
	//echo $sql;die;
	$dataArray = sql_select($sql);
	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
	?>
	<div style="width:1000px;">
		<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
			<tr>
				<td colspan="6" align="center" style="font-size:18px">
					<strong><? echo $com_dtls[0]; ?></strong></td>
					<td style="font-size:xx-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">
					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='70' width='150'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='70' width='150'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="4" align="center">
						<?
						echo $com_dtls[1];
						?>
					</td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td colspan="6" align="center" style="font-size:16px"><strong><u>Yarn Delivery Challan/Gate Pass</u></strong></center>
					</td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td><strong>Issue Date:</strong></td>
					<td width="175px"><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
				</tr>
				<tr>
					<td width="160"><strong>Issue No:</strong></td>
					<td width="175px"><? echo $dataArray[0][csf('issue_number')]; ?></td>
					<td><strong>Issue Purpose:</strong></td>
		<td width="175px"><? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
		echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
		?>
	</td>
	<td><strong>Gate Pass No:</strong></td>
	<td width="175px"><? echo $dataArray[0][csf('gate_pass_no')]; ?></td>
	</tr>
	<tr>
		<td><strong>Issue To:</strong></td>
		<?
		if ($dataArray[0][csf('knit_dye_source')] == 3)
		{
			$supp_add = $dataArray[0][csf('knit_dye_company')];
			$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
			foreach ($nameArray as $result) {
				$address = "";
					if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
				}
				unset($nameArray);
			}

			$loan_party_add = $dataArray[0][csf('loan_party')];
			$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
			foreach ($loanPartyArray as $result) {
				$addressParty = "";
				if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
			}
			unset($loanPartyArray);
			?>
			<td colspan="3">
				<?
				if ($dataArray[0][csf('issue_purpose')] == 3) {
					echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
				} else if ($dataArray[0][csf('issue_purpose')] == 5) {
					echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : <b>Address</b>: ' . $addressParty;
				} else {
					if ($dataArray[0][csf('knit_dye_source')] == 1)
						echo $company_library[$dataArray[0][csf('knit_dye_company')]];
					else
						echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]];
				}
				?>
			</td>
			<td><strong>Knitting Source:</strong></td>
			<td width="175px"><? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
		</tr>

		<tr>
			<td><strong>Address:</strong></td>
			<?
			if ($dataArray[0][csf('knit_dye_source')] == 3)
			{
				$supp_add = $dataArray[0][csf('knit_dye_company')];
				$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
				foreach ($nameArray as $result) {
					$address = "";
					if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
				}
				unset($nameArray);
			}

			$loan_party_add = $dataArray[0][csf('loan_party')];
			$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
			foreach ($loanPartyArray as $result) {
				$addressParty = "";
				if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
			}
			unset($loanPartyArray);
			?>
			<td>
				<?
				if ($dataArray[0][csf('issue_purpose')] == 3)
				{
					echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
				}
				else if ($dataArray[0][csf('issue_purpose')] == 5)
				{
					echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : <b>Address</b>: ' . $addressParty;
				}
				else
				{
					if ($dataArray[0][csf('knit_dye_source')] == 1)
						echo $company_library[$dataArray[0][csf('knit_dye_company')]];
					else
						echo $address;
				}
				?>
			</td>
			<td><strong>Challan No:</strong></td>
			<td width="175px"><? echo $dataArray[0][csf('challan_no')]; ?></td>
			<td valign="top"><strong>Remarks :</strong></td>
			<td colspan="5"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
		</tr>
		<?
		if ($print_with_vat == 1) {
			?>
			<tr>
				<td>&nbsp;</td>
				<td>&nbsp;</td>
				<td><strong>Bar Code:</strong></td>
				<td colspan="3" id="barcode_img_id"></td>
			</tr>
			<?
		} else {
			?>
			<tr>
				<td valign="top">&nbsp;</strong></td>
				<td>&nbsp;</td>
				<td><strong>Bar Code:</strong></td>
				<td colspan="3" id="barcode_img_id"></td>
			</tr>
			<?
		}
		?>
	</table>
	</div>
	<div style="width:100%;">
	<table style="margin-left:5px;"  cellspacing="0" width="1000" border="1" rules="all" class="rpt_table">
		<thead bgcolor="#dddddd" style="font-size:13px">
			<th width="30">SL</th>
			<th width="150">Buyer</th>
			<th width="100">FSO & Fab. Booking No</th>
			<th width="100">Req. No</th>
			<th width="120">Program No</th>
			<th width="100">Lot No</th>
			<th width="150">Supplier</th>
			<th width="150"><b>Item Details</b></th>
			<th width="100">Issue Qty(kg)</th>
			<th>Bag & Cone</th>
		</thead>
		<?
		//$wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");

		$cond = "";
		if ($data[5] != "") $cond .= " and c.id='$data[5]'";

		$po_array = array();
		$job_array = array();
		$costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0]");
		foreach ($costing_sql as $row)
		{
			$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
			$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
			$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
			$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
			$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
			$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
			$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
			$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
		}
		unset($costing_sql);

		$job_no_array = array();
		$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst");
		foreach ($jobData as $row)
		{
			$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
			$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
			$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
			$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
		}
				//var_dump($po_array);
		$po_id_req_array = array();
		$is_sales_array = array();
		if ($db_type == 0)
		{
			$poID = " select c.requisition_no, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.requisition_no, a.is_sales ";
		}
		else
		{
			$poID = "select c.requisition_no, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.requisition_no, a.is_sales ";
		}

		$poID_sql_result = sql_select($poID);
		foreach ($poID_sql_result as $row)
		{
			$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
			$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
		}
		unset($poID_sql_result);

		$i = 1;
		if ($db_type == 0)
		{
			$sql_result = sql_select("select a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group,
				f.knit_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty,
				b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone,
				c.issue_basis,e.sales_booking_no,c.buyer_id,c.buyer_job_no, a.supplier_id,group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro,e.job_no,e.buyer_id sales_buyer,e.within_group
				from product_details_master a,
				inv_issue_master c,
				inv_transaction b
				left join order_wise_pro_details d on b.id=d.trans_id
				left join fabric_sales_order_mst e on d.po_breakdown_id=e.id
				left join ppl_yarn_requisition_entry f on b.requisition_no=f.requisition_no
				where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group, f.knit_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, e.sales_booking_no, c.buyer_id, c.buyer_job_no,e.job_no,e.buyer_id,e.within_group");
			//left join wo_booking_mst h on h.booking_no=e.sales_booking_no
			//left join wo_non_ord_samp_booking_mst i on i.booking_no=e.sales_booking_no and e.within_group=1

		}
		else
		{
			$sql_result = sql_select("select a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group,
				f.knit_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty,
				b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone,
				c.issue_basis,e.sales_booking_no,c.buyer_id,c.buyer_job_no, a.supplier_id,listagg(d.po_breakdown_id, ',')
				within group (order by d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro,e.job_no,e.buyer_id sales_buyer,e.within_group, e.PO_BUYER
				from product_details_master a,
				inv_issue_master c,
				inv_transaction b
				left join order_wise_pro_details d on b.id=d.trans_id
				left join fabric_sales_order_mst e on d.po_breakdown_id=e.id
				left join ppl_yarn_requisition_entry f on b.requisition_no=f.requisition_no
				where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group, f.knit_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag,b.weight_per_cone, c.issue_basis, e.sales_booking_no, c.buyer_id, c.buyer_job_no,e.job_no,e.buyer_id,e.within_group, e.PO_BUYER");

			//left join wo_booking_mst h on h.booking_no=e.sales_booking_no
			//left join wo_non_ord_samp_booking_mst i on i.booking_no=e.sales_booking_no and e.within_group=1
		}

		$all_req_no = '';
		$all_prod_id = '';
		$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
		$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
		foreach ($sql_result as $row)
		{
			if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
			if ($row[csf('requisition_no')] != '')
			{
				if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
				if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
			}

			$order_qnty_val = $row[csf('cons_quantity')];
			$order_qnty_val_sum += $order_qnty_val;

			$order_amount_val = $row[csf('order_amount')];
			$order_amount_val_sum += $order_amount_val;

			$no_of_bags_val = $row[csf('no_of_bags')];
			$no_of_bags_val_sum += $no_of_bags_val;

			$po_id = explode(",", $row[csf('po_id')]);
			$po_no = '';
			$style_ref = '';
			$job_no = '';
			$buyer = '';
					//$data=explode('*',$data);
			$productdtls = $row[csf('product_name_details')];
			$productArr = explode(' ', $productdtls);

			$proddtls = '';
			if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '') {
				$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
			} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '') {
				$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
			} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '') {
				$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
			} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '') {
				$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
			} else if ($productArr[0] != '' && $productArr[1] != '') {
				$proddtls = $productArr[0] . ', ' . $productArr[1];
			} else if ($productArr[0] != '') {
				$proddtls = $productArr[0];
			} else {
				$proddtls = '';
			}

			$internal_ref = '';
			$file_no = '';
			if ( $row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2 )
			{
				foreach ($po_id as $val)
				{
					if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
					if ($job_no == '') $job_no = $po_array[$val]['job_no'];
					if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
					if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

					if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
					if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
				}

				$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
				$job_file = array_unique(explode(",", rtrim($file_no, ", ")));
				$ref_cond = '';
				foreach ($job_ref as $ref)
				{
							//$ref_cond.=", ".$ref;
					if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
				}
				$file_con = '';
				foreach ($job_file as $file)
				{
					if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
				}

				$buyer_job = '';
				if ($row[csf('issue_basis')] == 1)
				{

					if ($dataArray[0][csf('issue_purpose')] == 8)
					{
						$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
					}
					else
					{
						if ($row[csf('buyer_job_no')] != "")
						{
							$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
						}
						else
						{
							echo $row[csf('buyer_id')]."test";
							$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
						}
					}
				}
				else if ($row[csf('issue_basis')] == 2)
				{
					$buyer_job = '';
				}
			}
			else if ($row[csf('issue_basis')] == 3)
			{

				if ($is_sales_array[$row[csf('requisition_no')]] == 1)
				{
					$buyer_job = '';
					foreach (array_unique($po_id) as $val) {
						if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
						if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];

						if ($buyer_job == '') {
							if ($job_no_array[$val]['within_group'] == 1) {
								$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
							} else {
								$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
							}
						}
					}
				}
				else
				{
					foreach ($po_id as $val) {
						if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
						if ($job_no == '') $job_no = $po_array[$val]['job_no'];
						if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
						if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

						if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
						if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
					}

					$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
					$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

					$ref_cond = '';
					foreach ($job_ref as $ref) {
								//$ref_cond.=", ".$ref;
						if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
					}

					$file_con = '';
					foreach ($job_file as $file) {
						if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
					}
					if ($job_no != '')
					{
						$buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
					}
					else
					{
						if(!empty($po_array[$val]['buyer_name']))
						{
							$buyer_job = $buyer_arr[$buyer_name];
						}
						else
						{
							$buyer_job = $row[csf('buyer_id')];
						}
					}
				}
			}
			else
			{
				foreach (array_unique($po_id) as $val)
				{
					if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
					if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
					if ($buyer_job == '')
					{
						if ($job_no_array[$val]['within_group'] == 1)
						{
							$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
						}
						else
						{
							$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
						}
					}
				}
			}


			$job_buyer_arr = explode("&",$buyer_job);
			$buyer=$job_buyer_arr[0];
			$job_no=$job_buyer_arr[1];

			$no_bag_cone = "";
			$wt_bag_cone = "";
			if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

			if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];

					//$buyer_id = ($row[csf("within_group")] == 2)?$row[csf('sales_buyer')]:$row[csf('buyer_id')]
			if($row[csf("within_group")] == 2)
			{
				$buyer_id=$row[csf('sales_buyer')];
			}
			else if($row['PO_BUYER'])
			{
				$buyer_id=$row['PO_BUYER'];
			}
			else if($row[csf('buyer_id')])
			{
				$buyer_id=$row[csf('buyer_id')];
			}
			else
			{
				$buyer_id=$row[csf('non_ord_samp_buyer')];
			}

			//for supplier
			if($row[csf('is_within_group')] == 1)
			{
				$supplier_name = $company_library[$row[csf('supplier_id')]];
			}
			else
			{
				$supplier_name = $supplier_arr[$row[csf('supplier_id')]];
			}
			?>
			<tr bgcolor="<? echo $bgcolor; ?>" style="font-size:13px">
				<td width="30"><? echo $i; ?></td>
				<td width="150">
					<div style="word-wrap:break-word; width:100px"><? echo $buyer_arr[$buyer_id]; ?></div>
				</td>
				<td width="100">
					<div style="word-wrap:break-word; width:110px"><? echo $row[csf('job_no')]." &<br>".$row[csf('sales_booking_no')]; ?></div>
				</td>
				<td width="100">
					<div style="word-wrap:break-word; width:110px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
				</td>
				<td width="120">
					<div style="word-wrap:break-word; width:110px"><? echo $row[csf('knit_id')]; ?></div>
				</td>


				<td width="100">
					<div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
				</td>

				<td width="150">
					<? echo $supplier_name; ?>
				</td>

				<td width="150">
					<div style="word-wrap:break-word; width:110px"><? echo $proddtls; ?></div>
				</td>

				<td align="right"
				width="100"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?>
			</td>

			<td>
				<div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
			&nbsp;</div>
		</td>
	</tr>
	<?
	$uom_unit = "Kg";
	$uom_gm = "Grams";
	$tot_return_qty += $row[csf('returnable_qnty')];
	$tot_bag += $no_of_bags_val;
	$tot_cone += $row[csf('cone_per_bag')];
	$tot_w_bag += $row[csf('weight_per_bag')];
	$tot_w_cone += $row[csf('weight_per_cone')];
	$req_no = $row[csf('requisition_no')];
	$i++;
	}
	?>
	<tr bgcolor="#CCCCCC" style="font-size:14px">
		<td align="right" colspan="8"><b>Total:</b></td>
		<td align="right">
			<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
		</td>
		<td><? echo 'N:' . number_format($tot_bag, 2);
		if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
		echo '<br>W:' . number_format($tot_w_bag, 2);
		if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?>
	</td>
	</tr>
	<tr>
		<td colspan="10" align="left"><b>In Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
	</tr>
	</table>
	<table width="1030" cellspacing="0" border="0" style="margin-left:10px; margin-top:60px">
	<tr>
		<td><strong>Transport No:</strong></td>
		<td><strong>Driver Name:</strong></td>
		<td><strong>D/L No:</strong></td>
		<td><strong>Mobile No:</strong></td>
	</tr>
	</table>
	<br>
	<?
	echo signature_table(49, $data[0], "1030px");
	?>
	</div>

	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
	function generateBarcode(valuess)
	{
		var value = valuess;//$("#barcodeValue").val();
		var btype = 'code39';//$("input[name=btype]:checked").val();
		var renderer = 'bmp';// $("input[name=renderer]:checked").val();
		var settings = {
			output: renderer,
			bgColor: '#FFFFFF',
			color: '#000000',
			barWidth: 1,
			barHeight: 30,
			moduleSize: 5,
			posX: 10,
			posY: 20,
			addQuietZone: 1
		};
		$("#barcode_img_id").html('11');
		value = {code: value, rect: false};
		$("#barcode_img_id").show().barcode(value, btype, settings);
	}
	generateBarcode('<? echo $data[1]; ?>');
	</script>
	<?
	exit();
}

if ($action == "yarn_issue_fso_v2")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue FSO(V2)", "../../", 1, 1, '', '', '');
	$data= explode('*', $data);
	$print_with_vat = $data[7];
	$company=$data[0];
	$location=$data[8];
	$store_id=$data[9];
	$wo_no = $data[10];
	// echo $wo_no;die;
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");

	$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");

	$sql = " select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
	//echo $sql;die;
	$dataArray = sql_select($sql);
	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
	?>
	<div style="width:1000px;">
		<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
			<tr>
				<td colspan="6" align="center" style="font-size:20px">
					<strong><? echo $com_dtls[0]; ?></strong></td>
					<td style="font-size:xx-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
				</td>
			</tr>
			<tr class="form_caption">
				<?
				$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
				?>
				<td align="left" width="50">
					<?
					foreach ($data_array as $img_row) {
						if ($data[5] != 1) {
							?>
							<img src='../../<? echo $com_dtls[2]; ?>' height='70' width='150'
							align="middle"/>
							<?
						} else {
							?>
							<img src='../<? echo $com_dtls[2]; ?>' height='70' width='150'
							align="middle"/>
							<?
						}
					}
					?>
				</td>
				<td colspan="4" align="center">
					<?
					//echo $com_dtls[1];
					// echo "SELECT PLOT_NO, LEVEL_NO, ROAD_NO, BLOCK_NO, COUNTRY_ID, PROVINCE, CITY, ZIP_CODE, CONTACT_NO, EMAIL, WEBSITE, VAT_NUMBER FROM LIB_COMPANY WHERE ID='".$data[0]."' AND STATUS_ACTIVE=1 AND IS_DELETED=0";
					$nameArray_com=sql_select( "SELECT PLOT_NO, LEVEL_NO, ROAD_NO, BLOCK_NO, COUNTRY_ID, PROVINCE, CITY, ZIP_CODE, CONTACT_NO, EMAIL, WEBSITE, VAT_NUMBER FROM LIB_COMPANY WHERE ID='".$data[0]."' AND STATUS_ACTIVE=1 AND IS_DELETED=0");
							$loc = '';
							foreach ($nameArray_com as $result)
							{
								if($result['PLOT_NO'] != '')
								{
									$loc .= $result['PLOT_NO'];
								}

								if($result['LEVEL_NO'] != '')
								{
									if($loc != '')
									{
										$loc .= ', '.$result['PLOT_NO'];
									}
									else
									{
										$loc .= $result['PLOT_NO'];
									}
								}

								if($result['ROAD_NO'] != '')
								{
									if($loc != '')
									{
										$loc .= ', '.$result['ROAD_NO'];
									}
									else
									{
										$loc .= $result['ROAD_NO'];
									}
								}

								if($result['BLOCK_NO'] != '')
								{
									if($loc != '')
									{
										$loc .= ', '.$result['BLOCK_NO'];
									}
									else
									{
										$loc .= $result['BLOCK_NO'];
									}
								}

								if($result['CITY'] != '')
								{
									if($loc != '')
									{
										$loc .= ', '.$result['CITY'];
									}
									else
									{
										$loc .= $result['CITY'];
									}
								}
							}
							echo $loc;
					?>

				</td>
				<td>&nbsp;</td>
			</tr>
			<tr>
				<td colspan="6" align="center" style="font-size:18px"><strong><u>Yarn Delivery Challan</u></strong></center>
				</td>
				<td>&nbsp;</td>
			</tr>
			<tr>
				<td style="font-size:16px"><strong>Issue Date:</strong></td>
				<td width="175px" style="font-size:16px"><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
				<td style="font-size:16px"><strong>YD WO:</strong></td>
				<td width="175px" style="font-size:16px"><?= $wo_no ?></td>
			</tr>
			<tr>
				<td width="160" style="font-size:16px"><strong>Issue No:</strong></td>
				<td width="175px" style="font-size:16px"><? echo $dataArray[0][csf('issue_number')]; ?></td>
				<td style="font-size:16px"><strong>Issue Purpose:</strong></td>
				<td width="175px" style="font-size:16px"><? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
				echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
				?>
				</td>
				<td style="font-size:16px"><strong>Knitting Source:</strong></td>
				<td width="175px" style="font-size:16px"><? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
			</tr>
			<tr>
				<td style="font-size:16px"><strong>Issue To:</strong></td>
				<?
				if ($dataArray[0][csf('knit_dye_source')] == 3)
				{
					$supp_add = $dataArray[0][csf('knit_dye_company')];
					$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
					foreach ($nameArray as $result)
					{
						$address = "";
							if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($nameArray);
				}
				$loan_party_add = $dataArray[0][csf('loan_party')];
				$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
				foreach ($loanPartyArray as $result) {
					$addressParty = "";
					if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
				}
				unset($loanPartyArray);
					?>
				<td style="font-size:16px">
					<?
					if ($dataArray[0][csf('issue_purpose')] == 3) {
						echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
					} else if ($dataArray[0][csf('issue_purpose')] == 5) {
						echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : <b>Address</b>: ' . $addressParty;
					} else {
						if ($dataArray[0][csf('knit_dye_source')] == 1)
							echo $company_library[$dataArray[0][csf('knit_dye_company')]];
						else
							echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]];
					}
					?>
				</td>
				<td valign="top" style="font-size:16px"><strong>Challan No:</strong></td>
				<td width="175px" style="font-size:16px"><? echo $dataArray[0][csf('challan_no')]; ?></td>


			</tr>
			<tr>
				<td style="font-size:16px"><strong>Address:</strong></td>
				<?
				if ($dataArray[0][csf('knit_dye_source')] == 3)
				{
					$supp_add = $dataArray[0][csf('knit_dye_company')];
					$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
					foreach ($nameArray as $result) {
						$address = "";
						if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($nameArray);
				}

				$loan_party_add = $dataArray[0][csf('loan_party')];
				$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
				foreach ($loanPartyArray as $result) {
					$addressParty = "";
					if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
				}
				unset($loanPartyArray);
				?>
				<td style="font-size:16px">
					<?
					if ($dataArray[0][csf('issue_purpose')] == 3)
					{
						echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
					}
					else if ($dataArray[0][csf('issue_purpose')] == 5)
					{
						echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : <b>Address</b>: ' . $addressParty;
					}
					else
					{
						if ($dataArray[0][csf('knit_dye_source')] == 1)
							echo $company_library[$dataArray[0][csf('knit_dye_company')]];
						else
							echo $address;
					}
					?>
				</td>
				<tr>
					<td valign="top" style="font-size:16px"><strong>Remarks :</strong></td>
					<td colspan="5" style="font-size:16px"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
				</tr>


			</tr>
			<?
			if ($print_with_vat == 1)
			{
				?>
				<tr>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td style="font-size:16px"><strong>Bar Code:</strong></td>
					<td colspan="3" id="barcode_img_id"></td>
				</tr>
				<?
			}
			else
			{
				?>
				<tr>
					<td valign="top">&nbsp;</strong></td>
					<td>&nbsp;</td>
					<td><strong>Bar Code:</strong></td>
					<td colspan="3" id="barcode_img_id"></td>
				</tr>
				<?
			}
			?>
		</table>
	</div>

	<div style="width:100%;">
		<table style="margin-left:5px;"  cellspacing="0" width="1210" border="1" rules="all" class="rpt_table">
			<thead bgcolor="#dddddd" >
				<th width="30" style="font-size:16px">SL</th>
				<th width="150" style="font-size:16px">FSO & <br>Sales Job/Booking No</th>
				<th width="150" style="font-size:16px">IR/IB</th>
				<th width="80" style="font-size:16px">Customer</th>
				<th width="80" style="font-size:16px">Cust. Buyer</th>
				<th width="100" style="font-size:16px">Demand No/<br>Req. No</th>
				<th width="80" style="font-size:16px">Program No</th>
				<th width="140" style="font-size:16px"><b>Item Details<b></th>
				<th width="100" style="font-size:16px">Supplier</th>
				<th width="100" style="font-size:16px">Lot No</th>
				<th width="100" style="font-size:16px">Dye. Color</th>
				<th width="100" style="font-size:16px">Issue Qty(kg)</th>
				<th style="font-size:16px">Bag & Cone</th>
			</thead>
			<?
			$cond = "";
			if ($data[5] != "") $cond .= " and c.id='$data[5]'";

			$po_array = array();
			$job_array = array();
			$costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0]");
			foreach ($costing_sql as $row)
			{
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
				$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
				$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
				$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
				$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
				$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
			}
			unset($costing_sql);

			$job_no_array = array();
			$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id, po_buyer,customer_buyer from fabric_sales_order_mst");
			foreach ($jobData as $row)
			{
				$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
				$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
				$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
				$job_no_array[$row[csf('id')]]['customer_buyer'] = $row[csf('customer_buyer')];
			}

			//var_dump($po_array);
			$po_id_req_array = array();
			$is_sales_array = array();
			if ($db_type == 0)
			{
				$poID = " select c.requisition_no, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.requisition_no, a.is_sales ";
			}
			else
			{
				$poID = "select c.requisition_no, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.requisition_no, a.is_sales ";
			}

			$poID_sql_result = sql_select($poID);
			foreach ($poID_sql_result as $row)
			{
				$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
				$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
			}
			unset($poID_sql_result);

			$i = 1;
			if ($db_type == 0)
			{
				$sql_result = sql_select("SELECT a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group,
					f.knit_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty,
					b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone,
					c.issue_basis,e.sales_booking_no,c.buyer_id,c.buyer_job_no, a.supplier_id,group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro,e.job_no,e.buyer_id sales_buyer,e.customer_buyer,e.within_group,b.demand_no
					from product_details_master a,
					inv_issue_master c,
					inv_transaction b
					left join order_wise_pro_details d on b.id=d.trans_id
					left join fabric_sales_order_mst e on d.po_breakdown_id=e.id
					left join ppl_yarn_requisition_entry f on b.requisition_no=f.requisition_no
					where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group, f.knit_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, e.sales_booking_no, c.buyer_id, c.buyer_job_no,e.job_no,e.buyer_id,e.customer_buyer,e.within_group,b.demand_no");
			}
			else
			{

				$sql_result = sql_select("SELECT a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group,
					f.knit_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty,
					b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone,
					c.issue_basis,e.sales_booking_no,c.buyer_id,c.buyer_job_no, a.supplier_id,listagg(d.po_breakdown_id, ',')
					within group (order by d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro,e.job_no,e.buyer_id sales_buyer,e.customer_buyer,e.within_group,b.demand_no, h.grouping
					from product_details_master a,
					inv_issue_master c,
					inv_transaction b
					left join order_wise_pro_details d on b.id=d.trans_id
					left join fabric_sales_order_mst e on d.po_breakdown_id=e.id
					left join ppl_yarn_requisition_entry f on b.requisition_no=f.requisition_no
					LEFT JOIN WO_BOOKING_MST g on e.sales_booking_no = g.BOOKING_NO
         			LEFT JOIN WO_PO_BREAK_DOWN h on g.PO_BREAK_DOWN_ID = h.id
					where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group, f.knit_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag,b.weight_per_cone, c.issue_basis, e.sales_booking_no, c.buyer_id, c.buyer_job_no,e.job_no,e.buyer_id,e.customer_buyer,e.within_group,b.demand_no, h.grouping");
			}

			$all_req_no = '';
			$all_prod_id = '';
			$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
			$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
			foreach ($sql_result as $row)
			{
				if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
				if ($row[csf('requisition_no')] != '')
				{
					if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
					if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
				}

				$order_qnty_val = $row[csf('cons_quantity')];
				$order_qnty_val_sum += $order_qnty_val;

				$order_amount_val = $row[csf('order_amount')];
				$order_amount_val_sum += $order_amount_val;

				$no_of_bags_val = $row[csf('no_of_bags')];
				$no_of_bags_val_sum += $no_of_bags_val;

				$po_id = explode(",", $row[csf('po_id')]);
				$po_no = '';
				$style_ref = '';
				$job_no = '';
				$buyer = '';
						//$data=explode('*',$data);
				$productdtls = $row[csf('product_name_details')];
				$productArr = explode(' ', $productdtls);

				$proddtls = '';
				if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '') {
					$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
				} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '') {
					$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
				} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '') {
					$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
				} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '') {
					$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
				} else if ($productArr[0] != '' && $productArr[1] != '') {
					$proddtls = $productArr[0] . ', ' . $productArr[1];
				} else if ($productArr[0] != '') {
					$proddtls = $productArr[0];
				} else {
					$proddtls = '';
				}

				$internal_ref = '';
				$file_no = '';
				if ( $row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2 )
				{
					foreach ($po_id as $val)
					{
						if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
						if ($job_no == '') $job_no = $po_array[$val]['job_no'];
						if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
						if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

						if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
						if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
					}

					$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
					$job_file = array_unique(explode(",", rtrim($file_no, ", ")));
					$ref_cond = '';
					foreach ($job_ref as $ref)
					{
								//$ref_cond.=", ".$ref;
						if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
					}
					$file_con = '';
					foreach ($job_file as $file)
					{
						if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
					}

					$buyer_job = '';
					if ($row[csf('issue_basis')] == 1)
					{

						if ($dataArray[0][csf('issue_purpose')] == 8)
						{
							$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
						}
						else
						{
							if ($row[csf('buyer_job_no')] != "")
							{
								$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
							}
							else
							{
								echo $row[csf('buyer_id')]."test";
								$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
							}
						}
					}
					else if ($row[csf('issue_basis')] == 2)
					{
						$buyer_job = '';
					}
				}
				else if ($row[csf('issue_basis')] == 3)
				{

					if ($is_sales_array[$row[csf('requisition_no')]] == 1)
					{
						$buyer_job = '';
						foreach (array_unique($po_id) as $val) {
							if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];

							if ($buyer_job == '') {
								if ($job_no_array[$val]['within_group'] == 1) {
									$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
								} else {
									$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
								}
							}
						}
					}
					else
					{
						foreach ($po_id as $val) {
							if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
							if ($job_no == '') $job_no = $po_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
							if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

							if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
							if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
						}

						$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
						$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

						$ref_cond = '';
						foreach ($job_ref as $ref) {
									//$ref_cond.=", ".$ref;
							if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
						}

						$file_con = '';
						foreach ($job_file as $file) {
							if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
						}
						if ($job_no != '')
						{
							$buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
						}
						else
						{
							if(!empty($po_array[$val]['buyer_name']))
							{
								$buyer_job = $buyer_arr[$buyer_name];
							}
							else
							{
								$buyer_job = $row[csf('buyer_id')];
							}
						}
					}
				}
				else
				{
					foreach (array_unique($po_id) as $val)
					{
						if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
						if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
						if ($buyer_job == '')
						{
							if ($job_no_array[$val]['within_group'] == 1)
							{
								$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
							}
							else
							{
								$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
							}
						}
					}
				}

				$job_buyer_arr = explode("&",$buyer_job);
				$buyer=$job_buyer_arr[0];
				$job_no=$job_buyer_arr[1];

				$no_bag_cone = "";
				$wt_bag_cone = "";
				if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

				if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];

				if($row[csf("within_group")] == 2)
				{
					$buyer_id=$row[csf('sales_buyer')];
				}
				else if($row[csf('buyer_id')])
				{
					$buyer_id=$row[csf('buyer_id')];
				}
				else
				{
					$buyer_id=$row[csf('non_ord_samp_buyer')];
				}

				//for supplier
				if($row[csf('is_within_group')] == 1)
				{
					$supplier_name = $company_library[$row[csf('supplier_id')]];
				}
				else
				{
					$supplier_name = $supplier_arr[$row[csf('supplier_id')]];
				}

				$customer_buyer_id=$row[csf('customer_buyer')];
				?>

				<tr bgcolor="<? echo $bgcolor; ?>" >
					<td width="30" style="font-size:14px" align="center"><? echo $i; ?></td>
					<td width="150" style="font-size:14px" >
						<div style="word-wrap:break-word; width:145px"><? echo $row[csf('job_no')]." &<br>".$row[csf('sales_booking_no')]; ?></div>
					</td>
					<td width="150" style="font-size:14px" >
						<div style="word-wrap:break-word; width:145px"><? echo $row["GROUPING"]; ?></div>
					</td>
					<td width="80" style="font-size:14px">
						<div style="word-wrap:break-word; width:80px"><? echo $buyer_arr[$buyer_id]; ?></div>
					</td>
					<td width="80" style="font-size:14px">
						<div style="word-wrap:break-word; width:80px"><? echo $buyer_arr[$customer_buyer_id]; ?></div>
					</td>
					<td width="100" style="font-size:14px" align="center">
						<div style="word-wrap:break-word; width:100px">
						<?
						$demand_no= explode('-', $row[csf('demand_no')]);
						$demand= ltrim($demand_no[3],0 );
						if ( $demand != 0 || $row[csf('requisition_no')] != 0 ) echo $demand.'<br>'.$row[csf('requisition_no')]; else echo '&nbsp;'; ?>
					</div>
					</td>
					<td width="80" style="font-size:14px" align="center">
						<div style="word-wrap:break-word; width:80px"><? echo $row[csf('knit_id')]; ?></div>
					</td>
					<td width="140" style="font-size:14px" >
						<div style="word-wrap:break-word; width:140px"><? echo $proddtls; ?></div>
					</td>
					<td width="100" style="font-size:14px" >
						<? echo $supplier_name; ?>
					</td>
					<td width="100" style="font-size:14px" align="center">
						<div style="word-wrap:break-word; width:100px"><? echo $row[csf('lot')]; ?></div>
					</td>
					<td width="100" style="font-size:14px" >
						<div style="word-wrap:break-word; width:100px" ><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?></div>
					</td>
					<td align="right"
					width="100" style="font-size:14px"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?>
					</td>
					<td style="font-size:14px">
					<div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
					&nbsp;</div>
					</td>
				</tr>
				<?
				$uom_unit = "Kg";
				$uom_gm = "Grams";
				$tot_return_qty += $row[csf('returnable_qnty')];
				$tot_bag += $no_of_bags_val;
				$tot_cone += $row[csf('cone_per_bag')];
				$tot_w_bag += $row[csf('weight_per_bag')];
				$tot_w_cone += $row[csf('weight_per_cone')];
				$req_no = $row[csf('requisition_no')];
				$i++;
			}
			?>
			<tr bgcolor="#CCCCCC" >
				<td align="right" colspan="11" style="font-size:15px"><b>Total:</b></td>
				<td align="right" style="font-size:15px"><b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b></td>
				<td style="font-size:15px"><? echo 'N:' . number_format($tot_bag, 2);
				if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
				echo '<br>W:' . number_format($tot_w_bag, 2);
				if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?>
				</td>
			</tr>
			<tr>
				<td colspan="13" align="left" style="font-size:15px"><b>In Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
			</tr>
		</table>
		<br>
		<?
		echo signature_table(49, $data[0], "1030px", '', 20);
		?>
	</div>

	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
	function generateBarcode(valuess)
	{
		var value = valuess;//$("#barcodeValue").val();
		var btype = 'code39';//$("input[name=btype]:checked").val();
		var renderer = 'bmp';// $("input[name=renderer]:checked").val();
		var settings = {
			output: renderer,
			bgColor: '#FFFFFF',
			color: '#000000',
			barWidth: 1,
			barHeight: 30,
			moduleSize: 5,
			posX: 10,
			posY: 20,
			addQuietZone: 1
		};
		$("#barcode_img_id").html('11');
		value = {code: value, rect: false};
		$("#barcode_img_id").show().barcode(value, btype, settings);
	}
	generateBarcode('<? echo $data[1]; ?>');
	</script>
	<?
	exit();
}

if ($action == "yarn_issue_print5")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print5", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$print_with_vat = $data[7];
	$company=$data[0];
	$store_id=$data[8];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");

	$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$sql = " select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";

	$dataArray = sql_select($sql);

	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);

	?>
	<div style="width:1000px;">
		<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
			<tr>
				<td colspan="6" align="center" style="font-size:18px">
					<strong><? echo $com_dtls[0];; ?></strong></td>
					<td style="font-size:xx-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">

					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="4" align="center"><? echo $com_dtls[1]; ?></td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td colspan="6" align="center" style="font-size:16px"><strong><u>Yarn Delivery Challan</u></strong></center>
					</td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td width="160"><strong>Issue No:</strong></td>
					<td width="175px"><? echo $dataArray[0][csf('issue_number')]; ?></td>
					<td width="120"><strong>Booking:</strong></td>
					<td width="175px"><? echo $dataArray[0][csf('booking_no')]; ?></td>
					<td width="125"><strong>Knitting Source:</strong></td>
					<td width="175px"><? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
				</tr>
				<tr>
					<td><strong>Program No:</strong></td>
					<td width="175px"><? echo $dataArray[0][csf('challan_no')]; ?></td>

					<td><strong>Issue Purpose:</strong></td>
	<td width="175px"><? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
	echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
	?></td>
	<td><strong>Issue Date:</strong></td>
	<td width="175px"><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
</tr>
<tr>
	<td><strong>Issue To:</strong></td>
	<?
	if ($dataArray[0][csf('knit_dye_source')] == 3) {
		$supp_add = $dataArray[0][csf('knit_dye_company')];
		$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
		foreach ($nameArray as $result) {
			$address = "";
			if ($result != "") $address = $result[csf('address_1')];
		}
		unset($nameArray);
	}

	$loan_party_add = $dataArray[0][csf('loan_party')];
	$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
	foreach ($loanPartyArray as $result) {
		$addressParty = "";
		if ($result != "") $addressParty = $result['address'];
	}
	unset($loanPartyArray);
	?>
	<td colspan="3">
		<?
		if ($dataArray[0][csf('issue_purpose')] == 3) {
			echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
		} else if ($dataArray[0][csf('issue_purpose')] == 5) {
			echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
		} else {
			if ($dataArray[0][csf('knit_dye_source')] == 1)
				echo $company_library[$dataArray[0][csf('knit_dye_company')]];
			else
				echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
		}
		?>
	</td>
	<td><strong>Location:</strong></td>
	<td><? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>


</tr>
<tr>
	<td><strong>Demand No.:</strong></td>
	<td width="175px"><?
	?></td>

	<td><strong>Do No:</strong></td>
	<td width="175px"><?
	?></td>
</tr>
<tr>
	<td valign="top"><strong>Remarks :</strong></td>
	<td colspan="5"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
</tr>
<?
if ($print_with_vat == 1) {
	?>
	<tr>

		<td><strong>Bar Code:</strong></td>
		<td colspan="3" id="barcode_img_id"></td>
	</tr>
	<?
} else {
	?>
	<tr>
		<td valign="top">&nbsp;</strong></td>
		<td>&nbsp;</td>
		<td><strong>Bar Code:</strong></td>
		<td colspan="3" id="barcode_img_id"></td>
	</tr>
	<?
}
?>
</table>
<br>
<div style="width:100%;">
<div style="clear:both;">
	<table style="margin-right:-40px;" cellspacing="0" width="1100" border="1" rules="all"
	class="rpt_table">
	<thead bgcolor="#dddddd" style="font-size:13px">
		<th width="20">SL</th>
		<th width="45">Req. No</th>
		<th width="50">Lot No</th>
		<th width="65">Y. Type</th>
		<th width="110">Item Details</th>

		<th width="65">Dye. Color</th>
		<th width="60">Supp.</th>
		<th width="60"><b>Issue Qty(kg)</b></th>
		<th width="60">Rtnbl Qty(kg)</th>
		<th width="80">Bag & Cone</th>
		<th width="80">Store</th>
		<th width="100">Booking No</th>
		<th width="100">Buyer & Job</th>
		<th width="120">Order & Style</th>
		<th>Inte. Ref & File</th>
	</thead>
	<?
	$wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");

	$cond = "";
	if ($data[5] != "") $cond .= " and c.id='$data[5]'";

	$po_array = array();
	$job_array = array();

	$costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number ,c.booking_no
		from wo_po_details_master a, wo_po_break_down b left join wo_booking_dtls c on b.id = c.po_break_down_id and c.status_active = 1
		where a.job_no=b.job_no_mst and b.status_active = 1  and a.company_name= ".$data[0]."
		group by a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number, c.booking_no");

	foreach ($costing_sql as $row) {
		$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
		$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
		$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
		$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
		$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
		$po_array[$row[csf('id')]]['booking_no'] = $row[csf('booking_no')];
		$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
		$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];

	}
	unset($costing_sql);

	$job_no_array = array();
	$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id, sales_booking_no from fabric_sales_order_mst");
	foreach ($jobData as $row) {
		$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
		$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
		$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
		$job_no_array[$row[csf('id')]]['sales_booking_no'] = $row[csf('sales_booking_no')];
	}

	$po_id_req_array = array();
	$is_sales_array = array();

	$poID = "select c.requisition_no, a.booking_no, a.is_sales
	from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c
	where a.id = b.mst_id and b.id = c.knit_id and b.status_active=1 and c.status_active=1
	group by c.requisition_no, a.booking_no, a.is_sales";

	$poID_sql_result = sql_select($poID);
	foreach ($poID_sql_result as $row) {
		$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
		$bookFromRequ_array[$row[csf('requisition_no')]] = $row[csf('booking_no')];
	}
	unset($poID_sql_result);

	$i = 1;
	if ($db_type == 0) {
		$sql_result = sql_select("select a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
	} else {
		$sql_result = sql_select("select a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
	}
	$all_req_no = '';
	$all_prod_id = '';
	$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
	$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
	foreach ($sql_result as $row) {
		if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
		if ($row[csf('requisition_no')] != '') {
			if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
			if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
		}
		$order_qnty_val = $row[csf('cons_quantity')];
		$order_qnty_val_sum += $order_qnty_val;

		$order_amount_val = $row[csf('order_amount')];
		$order_amount_val_sum += $order_amount_val;

		$no_of_bags_val = $row[csf('no_of_bags')];
		$no_of_bags_val_sum += $no_of_bags_val;

		$po_id = explode(",", $row[csf('po_id')]);
		$po_no = '';
		$style_ref = '';
		$job_no = '';
		$buyer = '';

		$productdtls = $row[csf('product_name_details')];
		$productArr = explode(' ', $productdtls);

		$proddtls = '';
		if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '') {
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
		} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '') {
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
		} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '') {
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
		} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '') {
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
		} else if ($productArr[0] != '' && $productArr[1] != '') {
			$proddtls = $productArr[0] . ', ' . $productArr[1];
		} else if ($productArr[0] != '') {
			$proddtls = $productArr[0];
		} else {
			$proddtls = '';
		}


		$internal_ref = '';
		$file_no = '';$booking_no='';
		if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2) {
			foreach ($po_id as $val) {
				if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
				if ($job_no == '') $job_no = $po_array[$val]['job_no'];
				if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
				if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];
				if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
				if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];

				if ($booking_no == '') $booking_no = $po_array[$val]['booking_no']; else $booking_no .= "," . $po_array[$val]['booking_no'];
			}
			$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
			$job_file = array_unique(explode(",", rtrim($file_no, ", ")));
			$ref_cond = '';
			foreach ($job_ref as $ref) {

				if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
			}
			$file_con = '';
			foreach ($job_file as $file) {
				if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
			}

			$buyer_job = '';
			if ($row[csf('issue_basis')] == 1) {

				$booking_no =$row[csf('booking_no')];
				if ($dataArray[0][csf('issue_purpose')] == 8) {
					$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
				} else {
					$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
					if ($row[csf('buyer_job_no')] != "") {
						$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
					}
				}
			} else if ($row[csf('issue_basis')] == 2) {

				$buyer_job = '';
			}
		} else if ($row[csf('issue_basis')] == 3) {

			if ($is_sales_array[$row[csf('requisition_no')]] == 1) {
				$buyer_job = '';
				foreach (array_unique($po_id) as $val) {
					if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
					if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
					if ($booking_no == '') $booking_no = $job_no_array[$val]['sales_booking_no'];
					if ($buyer_job == '') {
						if ($job_no_array[$val]['within_group'] == 1) {
							$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
						} else {
							$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
						}
					}
				}
			} else {
				foreach ($po_id as $val) {
					if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
					if ($job_no == '') $job_no = $po_array[$val]['job_no'];
					if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
					if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

					if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
					if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
				}

				$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
				$job_file = array_unique(explode(",", rtrim($file_no, ", ")));


				$ref_cond = '';
				foreach ($job_ref as $ref) {

					if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
				}

				$file_con = '';
				foreach ($job_file as $file) {
					if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
				}
				if ($job_no != '') {
					$buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
				} else {
					$buyer_job = $buyer_arr[$buyer_name];
				}

				$booking_no = $bookFromRequ_array[$row[csf('requisition_no')]];
			}
		} else {
			foreach (array_unique($po_id) as $val) {
				if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
				if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
				if ($buyer_job == '') {
					if ($job_no_array[$val]['within_group'] == 1) {
						$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
					} else {
						$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
					}
				}

				if ($booking_no == '') $booking_no = $po_array[$val]['booking_no']; else $booking_no .= "," . $po_array[$val]['booking_no'];

			}
		}

		$no_bag_cone = "";
		$wt_bag_cone = "";
		if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

		if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
		?>
		<tr bgcolor="<? echo $bgcolor; ?>" style="font-size:13px">
			<td width="20"><? echo $i; ?></td>
			<td width="45">
				<div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
			</td>
			<td width="50">
				<div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
			</td>
			<td width="65">
				<div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
			</td>
			<td width="110">
				<div style="word-wrap:break-word; width:110px">
					<?

					echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
					?>
				</div>
			</td>


			<td width="65">
				<div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
			&nbsp;</div>
		</td>

		<td width="60">
			<div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
		</td>

		<td align="right"
		width="60"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
		<td align="right"
		width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
		<td width="80">
			<div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
		&nbsp;</div>
	</td>
	<td width="80">
		<div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
	</td>
	<td width="100">
		<div style="word-wrap:break-word; width:100px"><? echo $booking_no; ?></div>
	</td>
	<td width="100">
		<div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
	</td>
	<td width="120">
		<div style="word-wrap:break-word; width:120px"><? echo $po_no;
		if ($style_ref != "") echo ' & ' . $style_ref; else echo '&nbsp;'; ?></div>
	</td>
	<td>
		<div style="word-wrap:break-word; width:80px"><? echo ltrim($ref_cond, ", ");
		if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?></div>
	</td>
</tr>
<?
$uom_unit = "Kg";
$uom_gm = "Grams";
$tot_return_qty += $row[csf('returnable_qnty')];
$tot_bag += $no_of_bags_val;
$tot_cone += $row[csf('cone_per_bag')];
$tot_w_bag += $row[csf('weight_per_bag')];
$tot_w_cone += $row[csf('weight_per_cone')];
$req_no = $row[csf('requisition_no')];
$i++;
}
?>
<tr bgcolor="#CCCCCC" style="font-size:13px">
<td align="right" colspan="7"><b>Total</b></td>
<td align="right">
	<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
</td>
<td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
<td><? echo 'N:' . number_format($tot_bag, 2);
if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
echo '<br>W:' . number_format($tot_w_bag, 2);
if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
<td align="right" colspan="5">&nbsp;</td>
</tr>
<tr>
<td colspan="15" align="left"><b>In
	Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
</tr>
</table>
</div>
<br>
<br>&nbsp;

<?
if ($data[6] == 1)
{
if ($dataArray[0][csf('issue_basis')] == 3){
?>
<div style="">
	<table width="850" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
		<thead>
			<tr>
				<th colspan="7" align="center">Requisition Details</th>
			</tr>
			<tr>
				<th width="40">SL</th>
				<th width="100">Requisition No</th>
				<th width="110">Lot No</th>
				<th width="220">Yarn Description</th>
				<th width="110">Brand</th>
				<th width="90">Requisition Qty</th>
				<th>Remarks</th>
			</tr>
		</thead>
		<?

		$i = 1;
		$tot_reqsn_qnty = 0;
		$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
		$product_details_array = array();
		$sql = "select id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where item_category_id=1 and company_id='$data[0]' and status_active=1 and is_deleted=0";
		$result = sql_select($sql);

		foreach ($result as $row) {
			$compos = '';
			if ($row[csf('yarn_comp_percent2nd')] != 0) {
				$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
			} else {
				$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
			}
			$product_details_array[$row[csf('id')]]['count'] = $count_arr[$row[csf('yarn_count_id')]];
			$product_details_array[$row[csf('id')]]['comp'] = $compos;
			$product_details_array[$row[csf('id')]]['type'] = $yarn_type[$row[csf('yarn_type')]];
			$product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
			$product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
		}
		unset($result);
		$sql = "select knit_id, requisition_no, prod_id, sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where requisition_no in ($all_req_no) and status_active=1 and is_deleted=0 group by requisition_no, prod_id, knit_id";
		$nameArray = sql_select($sql);
		foreach ($nameArray as $selectResult) {
			?>
			<tr>
				<td width="40" align="center"><? echo $i; ?></td>
				<td width="100" align="center">
					&nbsp;<? echo $selectResult[csf('requisition_no')]; ?></td>
					<td width="110" align="center">
						&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['lot']; ?></td>
						<td width="220">
							&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['count'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['comp'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['type']; ?></td>
							<td width="110" align="center">
								&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['brand']; ?></td>
								<td width="90"
								align="right"><? echo number_format($selectResult[csf('yarn_qnty')], 2); ?>
							&nbsp;</td>
				<td>&nbsp;<? //echo $selectResult[csf('requisition_no')];
				?></td>
			</tr>
			<?
			$tot_reqsn_qnty += $selectResult[csf('yarn_qnty')];
			$i++;
		}
		?>
		<tfoot>
			<th colspan="5" align="right"><b>Total</b></th>
			<th align="right"><? echo number_format($tot_reqsn_qnty, 2); ?>&nbsp;</th>
			<th>&nbsp;</th>
		</tfoot>
	</table>
	<?
	if ($data[5] != 1) {
		$z = 1;
		$k = 1;
		$colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

		$booking_al = "";
		foreach ($colorArray as $book) {
			if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];
		}

		$booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
		$booking_count = count(array_unique(explode(',', $booking_no)));

		if ($dataArray[0][csf('issue_purpose')] == 2) {
			$booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
		} else {
			$booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
		}

		$booking_job_no = $booking_job[0][csf('job_no')];
		unset($booking_job);

		if ($db_type == 0) $poNoCond = "group_concat(id)";
		else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";

		$sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

		$job_po = $sql_returnJob[0][csf('po_break_down_id')];
		unset($sql_returnJob);
		?>

		<table width="710" cellpadding="0" cellspacing="0" border="1" rules="all"
		style="margin-top:20px;" class="rpt_table">
		<thead>
			<th width="40">SL</th>
			<th width="250">Fabrication</th>
			<th width="120">Color</th>
			<th width="120">GGSM OR S/L</th>
			<th>FGSM</th>
		</thead>
		<tbody>
			<tr>
				<td width="40" align="center"><? echo $z; ?></td>
				<td width="250"
				align="center"><? echo $body_part[$colorArray[0][csf('body_part_id')]] . ', ' . $colorArray[0][csf('fabric_desc')]; ?></td>
				<td width="120"
				align="center"><? echo $color_range[$colorArray[0][csf('color_range')]]; ?></td>
				<td width="120" align="center"><? echo $colorArray[0][csf('stitch_length')]; ?></td>
				<td align="center"><? echo $colorArray[0][csf('gsm_weight')]; ?></td>
			</tr>
		</tbody>
	</table>
	<table style="margin-top:20px;" width="650" border="1" rules="all" cellpadding="0"
	cellspacing="0" class="rpt_table">
	<thead>
		<th width="40">SL</th>
		<th width="50">Prog. No</th>
		<th width="110">Finish Dia</th>
		<th width="170">Machine Dia & Gauge</th>
		<th width="110">Program Qty</th>
		<th>Remarks</th>
	</thead>
	<tbody>
		<tr>
			<td width="40" align="center"><? echo $k; ?></td>
			<td width="50" align="center">&nbsp;<? echo $colorArray[0][csf('knit_id')]; ?></td>
			<td width="110" align="center"><? echo $colorArray[0][csf('dia')]; ?></td>
			<td width="170"
			align="center"><? echo $colorArray[0][csf('machine_dia')] . "X" . $colorArray[0][csf('machine_gg')]; ?></td>
			<td width="110"
			align="right"><? echo number_format($colorArray[0][csf('program_qnty')], 2); ?>
		&nbsp;</td>
		<td><? echo $colorArray[0][csf('remarks')]; ?></td>
	</tr>
	<?
	$tot_prog_qty += $colorArray[0][csf('program_qnty')];
	?>
	<tr>
		<td colspan="4" align="right"><strong>Total : </strong></td>
		<td align="right"><? echo number_format($tot_prog_qty, 2); ?></td>
		<td>&nbsp;</td>
	</tr>
</tbody>
</table>
<?
$returnJob = '';
$returnPo = '';
if ($db_type == 0) {
$booking_cond = "group_concat(a.booking_no)";
$wo_cond = "group_concat(a.ydw_no)";
$reqs_no = "group_concat(b.requisition_no)";
} else if ($db_type == 2) {
$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
}

if ($dataArray[0][csf('issue_purpose')] == 8) {
$sql_returnJob = sql_select("select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
} else if ($dataArray[0][csf('issue_purpose')] == 2) {
$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

if ($db_type == 0) $poNoCond = "group_concat(id)";
else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
} else {
$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' group by a.job_no");

}
$returnJob = $sql_returnJob[0][csf('job_no')];
		//$returnPo=$sql_po[0][csf('po_break_down_id')];
$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
unset($sql_returnJob);


?>
<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
cellspacing="0" class="rpt_table">
<thead>
<tr>
	<th colspan="6" align="center">Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking
	Job Deatils]</p></th>
</tr>
<tr>
	<th>Buyer</th>
	<th>Job</th>
	<th>Req. Qty</th>
	<th>Cuml. Issue Qty</th>
	<th>Balance Qty</th>
	<th>Remarks</th>
</tr>
</thead>
<?

$all_requ_no = "";
if ($dataArray[0][csf('issue_purpose')] != 8) {
$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");


$all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
}
if ($dataArray[0][csf('issue_purpose')] == 8) {
			$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");    //
			$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
		} else if ($dataArray[0][csf('issue_purpose')] == 2) {
			if ($all_requ_no != "" || $all_requ_no != 0) {
				$req_cond = "or a.requisition_no in ($all_requ_no)";
				$reqRet_cond = "or b.booking_no in ($all_requ_no)";
			} else {
				$req_cond = "or a.requisition_no in (0)";
				$reqRet_cond = "or b.booking_no in (0)";
			}

			$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

			$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
		} else {
			if ($all_requ_no != "" || $all_requ_no != 0) {
				$req_cond = "or a.requisition_no in ($all_requ_no)";
				$reqRet_cond = "or b.booking_no in ($all_requ_no)";
			} else {
				$req_cond = "or a.requisition_no in (0)";
				$reqRet_cond = "or b.booking_no in (0)";
			}
			$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");


			$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
		}
		$cumulative_qty = 0;
		if ($booking_count == 1) {
			?>
			<tbody>
				<tr>
					<td align="center">
						<? echo $buyer_arr[$job_array[$booking_job_no]['buyer']]; ?>
					</td>
					<td align="center">
						<? echo $job_array[$booking_job_no]['job']; ?>
					</td>
					<td align="center">
						<? echo number_format($returnReqQty, 3); ?>
					</td>
					<td align="center">
						<? $cumulative_qty = $total_issue_qty - $total_return_qty;
						echo number_format($cumulative_qty, 3); ?>
					</td>
					<td align="center">
						<? $balance_qty = $returnReqQty - $cumulative_qty;
						echo number_format($balance_qty, 3); ?>
					</td>
					<td align="center">
						<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
					</td>
				</tr>
			</tbody>
		</table>
		<?
	}
}
}
else if ($dataArray[0][csf('issue_basis')] == 1) {
?>
<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
cellspacing="0" class="rpt_table">
<thead>
	<tr>
		<th colspan="6" align="center">
			Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
				if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
			} ?> </th>
		</tr>
		<tr>
			<th>Buyer</th>
			<th>Job</th>
			<th>Req. Qty</th>
			<th>Cuml. Qty</th>
			<th>Balance Qty</th>
			<th>Remarks</th>
		</tr>
	</thead>
	<?

	$returnJob = '';
	$returnPo = '';
	if ($db_type == 0) {
		$booking_cond = "group_concat( distinct a.booking_no)";
		$wo_cond = "group_concat(a.ydw_no)";
		$reqs_no = "group_concat(b.requisition_no)";
	} else if ($db_type == 2) {
		$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
		$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
		$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
	}

	if ($dataArray[0][csf('issue_purpose')] == 8) {
		$sql_returnJob = sql_select("select a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
	} else if ($dataArray[0][csf('issue_purpose')] == 2) {
		if ($dataArray[0][csf('buyer_job_no')] != '') {
			$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

			if ($db_type == 0) $poNoCond = "group_concat(id)";
			else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
			$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
		} else {
			$sql_returnJob = sql_select("select a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
		}
	} else {

		$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");
	}
	$returnJob = $sql_returnJob[0][csf('job_no')];
	$returnPo = $sql_po[0][csf('po_break_down_id')];
	$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
	$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

	$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
	unset($sql_returnJob);


	$all_requ_no = "";
	if ($dataArray[0][csf('issue_purpose')] != 8) {

		$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

		$all_requ_no = $all_booking_sql[0][csf('requisition_no')];
		unset($all_booking_sql);
	}

	if ($dataArray[0][csf('issue_purpose')] == 8) {

				$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");    //
				$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
			} else if ($dataArray[0][csf('issue_purpose')] == 2) {

				if ($dataArray[0][csf('buyer_job_no')] != "") {
					$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

					$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
				} else {

					$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

					$total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
				}
			} else {
				if ($dataArray[0][csf('buyer_job_no')] != "") {
					if ($all_requ_no != "" || $all_requ_no != 0) {
						$req_cond = "or a.requisition_no in ($all_requ_no)";
						$reqRet_cond = "or b.booking_no in ($all_requ_no)";
					} else {
						$req_cond = "";
						$reqRet_cond = "";
					}
					$total_issue_qty = 0;

					$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");

					$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");


				}
			}
			?>
			<tbody>
				<tr>
					<td align="center">
						<?
						if ($dataArray[0][csf('issue_purpose')] == 8) echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
						else echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
						?>
					</td>
					<td align="center">
						<? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
					</td>
					<td align="center">
						<? echo number_format($returnReqQty, 3); ?>
					</td>
					<td align="center">
						<? $cumulative_qty = 0;
						$cumulative_qty = $total_issue_qty - $total_return_qty;
						echo number_format($cumulative_qty, 3); ?>
					</td>
					<td align="center">
						<? $balance_qty = $returnReqQty - $cumulative_qty;
						echo number_format($balance_qty, 3); ?>
					</td>
					<td align="center">
						<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
					</td>
				</tr>
			</tbody>
		</table>
		<?
	}
}
?>
<br>
<?
echo signature_table(49, $data[0], "1030px");
?>
</div>
</div>
<script type="text/javascript" src="../../js/jquery.js"></script>
<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
<script>
function generateBarcode(valuess) {
var value = valuess;
var btype = 'code39';
var renderer = 'bmp';
var settings = {
	output: renderer,
	bgColor: '#FFFFFF',
	color: '#000000',
	barWidth: 1,
	barHeight: 30,
	moduleSize: 5,
	posX: 10,
	posY: 20,
	addQuietZone: 1
};
$("#barcode_img_id").html('11');
value = {code: value, rect: false};
$("#barcode_img_id").show().barcode(value, btype, settings);
}
generateBarcode('<? echo $data[1]; ?>');
</script>
<?
exit();
}

// ==========================================
if ($action == "yarn_issue_print6")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print2", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);
	$print_with_vat = $data[7];
	$organicyesno = $data[8];
	$company=$data[0];
	$location=$data[9];
	$store_id=$data[9];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");

	$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$sql = " select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
	//echo $sql;die;
	$dataArray = sql_select($sql);

	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
	?>
	<div style="width:1000px;">
		<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
			<tr>
				<td colspan="6" align="center" style="font-size:18px">
					<strong><? echo $com_dtls[0]; ?></strong></td>
					<td style="font-size:xx-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">

					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="4" align="center"><? echo $com_dtls[1];?></td>
					<td>
						<?php
						if($organicyesno==1)
						{
							?>
							<div style="border: 2px solid #000; padding: 5px; color: #000;">ORGANIC</div>
							<?
						}else{
							echo "&nbsp;";
						}
						?>
					</td>
				</tr>
				<tr>
					<td colspan="6" align="center" style="font-size:16px"><strong><u>Yarn Delivery Challan/Gate Pass</u></strong></center>
					</td>
					<td>&nbsp;</td>
				</tr>
				<tr>
					<td width="160"><strong>Issue No:</strong></td>
					<td width="175px"><? echo $dataArray[0][csf('issue_number')]; ?></td>
					<td width="120"><strong>Booking:</strong></td>
					<td width="175px"><? echo $dataArray[0][csf('booking_no')]; ?></td>
					<td width="125"><strong>Knitting Source:</strong></td>
					<td width="175px"><? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
				</tr>
				<tr>
					<td><strong>Issue To:</strong></td>
					<?
					if ($dataArray[0][csf('knit_dye_source')] == 3) {
						$supp_add = $dataArray[0][csf('knit_dye_company')];
						$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
						foreach ($nameArray as $result) {
							$address = "";
						if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($nameArray);
				}

				$loan_party_add = $dataArray[0][csf('loan_party')];
				$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
				foreach ($loanPartyArray as $result) {
					$addressParty = "";
					if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
				}
				unset($loanPartyArray);
				?>
				<td>
					<?
					if ($dataArray[0][csf('issue_purpose')] == 3) {
						echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
					} else if ($dataArray[0][csf('issue_purpose')] == 5) {
						echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
					} else {
						if ($dataArray[0][csf('knit_dye_source')] == 1)
							echo $company_library[$dataArray[0][csf('knit_dye_company')]];
						else
							echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
					}
					?>
				</td>

				<td><strong>Issue Purpose:</strong></td>
				<td width="175px"><? if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
				?>
			</td>
			<td width="100"><strong>Issue Date:</strong></td>
			<td width="175px"><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
		</tr>
		<tr>
			<td colspan="3"><strong>Demand No.:</strong></td>
			<td><? //echo $dataArray[0][csf('booking_id')];?></td>
			<td><strong>Location:</strong></td>
			<td><? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>
		</tr>

		<tr height="25">
			<td><strong>Remarks :</strong></td>
			<td><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
			<td colspan="3"><strong>Do No:</strong></td>
			<td>&nbsp;</td>
		</tr>
		<?
		if ($print_with_vat == 1) {
			?>
			<tr>
				<td>
					<p>
						<?
						$vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
						echo $vat_no;
						?></p>
					</td>
					<td><strong>Bar Code:</strong></td>
					<td colspan="3" id="barcode_img_id"></td>
				</tr>
				<?
			} else {
				?>
				<tr>
					<td><strong>Bar Code:</strong></td>
					<td colspan="3" id="barcode_img_id"></td>
				</tr>
				<?
			}
			?>
		</table>
		<br>
		<div style="width:100%;">
			<div style="clear:both;">
				<table style="margin-right:-40px;" cellspacing="0" width="1000" border="1" rules="all"
				class="rpt_table">
				<thead bgcolor="#dddddd" style="font-size:13px">
					<th width="20">SL</th>
					<th width="45">Req. No</th>
					<th width="50">Lot No</th>
					<th width="65">Y. Type</th>
					<th width="110">Item Details</th>

					<th width="65">Dye. Color</th>
					<th width="60">Supp.</th>
					<th width="60"><b>Issue Qty(kg)</b></th>
					<th width="60">Rtnbl Qty(kg)</th>
					<th width="80">Bag & Cone</th>
					<th width="80">Store</th>
					<th width="100">Buyer & Job</th>
					<th width="120">Order & Style</th>
					<th>Remarks</th>
				</thead>
				<?
				$wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");

				$cond = "";
				if ($data[5] != "") $cond .= " and c.id='$data[5]'";

				$po_array = array();
				$job_array = array();
				$costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0]");
				foreach ($costing_sql as $row) {
					$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
					$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
					$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
					$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
					$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
					$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
					$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
					$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
				}
				unset($costing_sql);

				$job_no_array = array();
				$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst");
				foreach ($jobData as $row) {
					$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
					$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
					$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
					$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
				}
					//var_dump($po_array);
				$po_id_req_array = array();
				$is_sales_array = array();
				if ($db_type == 0) {
					$poID = " select c.requisition_no, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.requisition_no, a.is_sales ";
				} else {
					$poID = "select c.requisition_no, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.requisition_no, a.is_sales ";
				}
				$poID_sql_result = sql_select($poID);
				foreach ($poID_sql_result as $row) {
					$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
					$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
				}
				unset($poID_sql_result);

				$i = 1;
				if ($db_type == 0) {
					$sql_result = sql_select("select a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
				} else {
					$sql_result = sql_select("select a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
				}
				$all_req_no = '';
				$all_prod_id = '';
				$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
				$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
				foreach ($sql_result as $row) {
					if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
					if ($row[csf('requisition_no')] != '') {
						if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
						if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
					}
					$order_qnty_val = $row[csf('cons_quantity')];
					$order_qnty_val_sum += $order_qnty_val;

					$order_amount_val = $row[csf('order_amount')];
					$order_amount_val_sum += $order_amount_val;

					$no_of_bags_val = $row[csf('no_of_bags')];
					$no_of_bags_val_sum += $no_of_bags_val;

					$po_id = explode(",", $row[csf('po_id')]);
					$po_no = '';
					$style_ref = '';
					$job_no = '';
					$buyer = '';
						//$data=explode('*',$data);
					$productdtls = $row[csf('product_name_details')];
					$productArr = explode(' ', $productdtls);

					$proddtls = '';
					if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
					} else if ($productArr[0] != '' && $productArr[1] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1];
					} else if ($productArr[0] != '') {
						$proddtls = $productArr[0];
					} else {
						$proddtls = '';
					}

					$internal_ref = '';
					$file_no = '';
					if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
					{
						foreach ($po_id as $val) {
							if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
							if ($job_no == '') $job_no = $po_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
							if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

							if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
							if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
						}
						$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
						$job_file = array_unique(explode(",", rtrim($file_no, ", ")));
						$ref_cond = '';
						foreach ($job_ref as $ref) {
								//$ref_cond.=", ".$ref;
							if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
						}
						$file_con = '';
						foreach ($job_file as $file) {
							if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
						}

						$buyer_job = '';
						if ($row[csf('issue_basis')] == 1)
						{
							if ($dataArray[0][csf('issue_purpose')] == 8)
							{
								$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
							}
							else
							{
								if ($row[csf('buyer_job_no')] != "") {
									$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
								}
								else
								{
									$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
								}
							}
						} else if ($row[csf('issue_basis')] == 2) {
							$buyer_job = '';
						}
					}
					else if ($row[csf('issue_basis')] == 3)
					{
						if ($is_sales_array[$row[csf('requisition_no')]] == 1)
						{
							$buyer_job = '';
							foreach (array_unique($po_id) as $val) {
								if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];

								if ($buyer_job == '') {
									if ($job_no_array[$val]['within_group'] == 1) {
										$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
									} else {
										$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
									}
								}
							}
						}
						else
						{
							foreach ($po_id as $val)
							{
								if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
								if ($job_no == '') $job_no = $po_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
								if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
							}

							$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
							$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

							$ref_cond = '';
							foreach ($job_ref as $ref) {
									//$ref_cond.=", ".$ref;
								if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
							}

							$file_con = '';
							foreach ($job_file as $file) {
								if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
							}
							if ($job_no != '')
							{
								$buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
							}
							else
							{
								if(!empty($po_array[$val]['buyer_name']))
								{
									$buyer_job = $buyer_arr[$buyer_name];
								}
								else
								{
									$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
								}
							}
						}
					}
					else
					{
						foreach (array_unique($po_id) as $val)
						{
							if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
							if ($buyer_job == '')
							{
								if ($job_no_array[$val]['within_group'] == 1)
								{
									$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
								}
								else
								{
									$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
								}
							}
						}
					}

					$no_bag_cone = "";
					$wt_bag_cone = "";
					if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

					if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" style="font-size:13px">
						<td width="20"><? echo $i; ?></td>
						<td width="45">
							<div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
						</td>
						<td width="50">
							<div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
						</td>
						<td width="65">
							<div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
						</td>
						<td width="110">
							<div style="word-wrap:break-word; width:110px">
								<?
									//echo $proddtls;
								echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
								?>
							</div>
						</td>


						<td width="65">
							<div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
						&nbsp;</div>
					</td>

					<td width="60">
						<div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
					</td>

					<td align="right"
					width="60"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
					<td align="right"
					width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
					<td width="80">
						<div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
					&nbsp;</div>
				</td>
				<td width="80">
					<div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
				</td>
				<td width="100">
					<div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
				</td>
				<td width="120">
					<div style="word-wrap:break-word; width:120px"><? echo $po_no;
					if ($style_ref != "") echo ' & ' . $style_ref; else echo '&nbsp;'; ?></div>
				</td>
				<td width="150">&nbsp;</td>
			</tr>
			<?
			$uom_unit = "Kg";
			$uom_gm = "Grams";
			$tot_return_qty += $row[csf('returnable_qnty')];
			$tot_bag += $no_of_bags_val;
			$tot_cone += $row[csf('cone_per_bag')];
			$tot_w_bag += $row[csf('weight_per_bag')];
			$tot_w_cone += $row[csf('weight_per_cone')];
			$req_no = $row[csf('requisition_no')];
			$i++;
		}
		?>
		<tr bgcolor="#CCCCCC" style="font-size:13px">
			<td align="right" colspan="7"><b>Total</b></td>
			<td align="right">
				<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
			</td>
			<td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
			<td><? echo 'N:' . number_format($tot_bag, 2);
			if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
			echo '<br>W:' . number_format($tot_w_bag, 2);
			if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
			<td align="right" colspan="4">&nbsp;</td>
		</tr>
		<tr>
			<td colspan="14" align="left"><b>In
				Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
			</tr>
		</table>

		<br>
		<?
		echo signature_table(49, $data[0], "1030px");
		?>

	</div>
</div>

<script type="text/javascript" src="../../js/jquery.js"></script>
<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
<script>
	function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');
		</script>
		<?
		exit();
	}

if ($action == "yarn_issue_print8")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print2", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);
	$print_with_vat = $data[7];
	$company=$data[0];
	$location=$data[8];
	$store_id=$data[9];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");

		/*$supplier_arr=return_library_array( "select id, short_name from lib_supplier",'id','short_name');
		$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');*/

		$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
		$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');


		//$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
		$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
		$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
		$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
		$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
		$sql = " select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
		//echo $sql;die;
		$dataArray = sql_select($sql);

		$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
		$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
		?>
		<div style="width:1000px;">
			<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td colspan="6" align="center" style="font-size:18px">
						<strong><? echo $com_dtls[0]; ?></strong></td>
						<td style="font-size:xx-large; font-style:italic;" align="right">
							<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
						</td>
					</tr>
					<tr class="form_caption">

						<?
						$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
						?>
						<td align="left" width="50">
							<?
							foreach ($data_array as $img_row) {
								if ($data[5] != 1) {
									?>
									<img src='../../<? echo $com_dtls[2]; ?>' height='70' width='150'
									align="middle"/>
									<?
								} else {
									?>
									<img src='../<? echo $com_dtls[2]; ?>' height='70' width='150'
									align="middle"/>
									<?
								}
							}
							?>
						</td>
						<td colspan="4" align="center">
							<?
							echo $com_dtls[1];
						/*$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$data[0]");
					foreach ($nameArray as $result)
					{
					?>
						Plot No: <? echo $result[csf('plot_no')]; ?>
						Level No: <? echo $result[csf('level_no')]?>
						Road No: <? echo $result[csf('road_no')]; ?>
						Block No: <? echo $result[csf('block_no')];?>
						City No: <? echo $result[csf('city')];?>
						Zip Code: <? echo $result[csf('zip_code')]; ?>
						Province No: <?php echo $result[csf('province')];?>
						Country: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
						Email Address: <? echo $result[csf('email')];?>
						Website No: <? echo $result[csf('website')];
					}*/
					?>
				</td>
				<td>&nbsp;</td>
			</tr>
			<tr>
				<td colspan="6" align="center" style="font-size:16px"><strong><u>Yarn Delivery Challan</u></strong></center>
				</td>
				<td>&nbsp;</td>
			</tr>

			<tr>

				<td width="100"><strong>Issue To:</strong></td>
				<?
				if ($dataArray[0][csf('knit_dye_source')] == 3) {
					$supp_add = $dataArray[0][csf('knit_dye_company')];
					$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
					foreach ($nameArray as $result) {
						$address = "";
							if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
						}
						unset($nameArray);
					}

					$loan_party_add = $dataArray[0][csf('loan_party')];
					$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
					foreach ($loanPartyArray as $result) {
						$addressParty = "";
						if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($loanPartyArray);
					?>
					<td >
						<?
						if ($dataArray[0][csf('issue_purpose')] == 3) {
							echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
						} else if ($dataArray[0][csf('issue_purpose')] == 5) {
							echo $supplier_arr[$dataArray[0][csf('loan_party')]] ;
						} else {
							if ($dataArray[0][csf('knit_dye_source')] == 1)
								echo $company_library[$dataArray[0][csf('knit_dye_company')]];
							else
								echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]];
						}
						?>
					</td>
					<td width="120"><strong>Work Order:</strong></td>
					<td width="175px"><? //echo $dataArray[0][csf('booking_no')]; ?></td>
					<td width="160"><strong>Issue No:</strong></td>
					<td width="175px"><? echo $dataArray[0][csf('issue_number')]; ?></td>
				</tr>
				<tr>
					<td rowspan="2" valign="top"><strong>Address:</strong></td>
					<td rowspan="2" width="175px" valign="top">
						<?
						if ($dataArray[0][csf('issue_purpose')] == 3) {
							echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
						} else if ($dataArray[0][csf('issue_purpose')] == 5) {
							echo $addressParty;
						} else {
							if ($dataArray[0][csf('knit_dye_source')] == 1)
								echo $company_library[$dataArray[0][csf('knit_dye_company')]];
							else
								echo $address;
						}
						?>
					</td>

					<td width="125" valign="top"><strong>Knitting Source:</strong></td>
					<td width="175px" valign="top"><? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>


					<td valign="top"><strong>Issue Date:</strong></td>
					<td width="175px" valign="top"><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
				</tr>

				<tr>

					<td><strong>Issue Purpose:</strong></td>
                <td width="175px"><? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
                echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
                ?></td>

                <td><strong>Do No:</strong></td>
                <td width="175px"><? //echo $dataArray[0][csf('remarks')];
                ?></td>
            </tr>
            <tr>
            	<td></td>
            	<td></td>
            	<td><strong>Fabric Booking No:</strong></td>
            	<td width="175px"><? echo $dataArray[0][csf('booking_no')]; ?></td>
            	<td><strong>DL No:</strong></td>
                <td width="175px"><? //echo $dataArray[0][csf('remarks')];
                ?></td>
            </tr>
            <tr>
            	<td><strong>Through By:</strong></td>
            	<td></td>
            	<td><strong>Driver Name:</strong></td>
                <td width="175px"><? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
                ?></td>

                <td><strong>Gate Pass No:</strong></td>
                <td width="175px"><? //echo $dataArray[0][csf('remarks')];
                ?></td>
            </tr>
            <?
            if ($print_with_vat == 1) {
            	?>
            	<tr>
                    <!-- <td><strong>VAT Number :</strong></td>
                    <td><p>
                        <?
                    $vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
                    echo $vat_no;
                    ?></p></td> -->
                    <td><strong>Bar Code:</strong></td>
                    <td colspan="3" id="barcode_img_id"></td>

                    <td><strong>Demand No.:</strong></td>
                    <td width="175px"><? //echo $dataArray[0][csf('booking_id')];?></td>
                </tr>
                <?
            } else {
            	?>
            	<tr>
            		<td valign="top">&nbsp;</strong></td>
            		<td>&nbsp;</td>
            		<td><strong>Bar Code:</strong></td>
            		<td colspan="3" id="barcode_img_id"></td>

            		<td><strong>Demand No.:</strong></td>
            		<td width="175px"><? //echo $dataArray[0][csf('booking_id')];?></td>
            	</tr>
            	<?
            }
            ?>
            <tr>
            	<td valign="top"><strong>Remarks :</strong></td>
            	<td colspan="5"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
            </tr>

        </table>
        <br>
        <div style="width:100%;">
        	<div style="clear:both;">
        		<table style="margin-right:-40px;" cellspacing="0" width="1000" border="1" rules="all"
        		class="rpt_table">
        		<thead bgcolor="#dddddd" style="font-size:13px">
        			<th width="20">SL</th>
        			<th width="45">Req. No</th>
        			<th width="50">Lot No</th>
        			<th width="110">Item Details</th>
        			<th width="65">Y. Type</th>
        			<th width="80">Bag & Cone</th>
        			<th width="60">Rtnbl Qty(kg)</th>
						<!--<th width="65">Dye. Color</th>
							<th width="60">Supp.</th>-->
							<th width="60"><b>Issue Qty(kg)</b></th>
							<!--<th width="80">Store</th>-->
							<th width="100">Buyer & Job</th>
							<th width="120">Order</th>
							<!--<th>Inte. Ref & File</th>-->
						</thead>
						<?
						$wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");

						$cond = "";
						if ($data[5] != "") $cond .= " and c.id='$data[5]'";

						$po_array = array();
						$job_array = array();
						$costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0]");
						foreach ($costing_sql as $row) {
							$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
							$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
							$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
							$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
							$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
							$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
							$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
							$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
						}
						unset($costing_sql);

						$job_no_array = array();
						$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst");
						foreach ($jobData as $row) {
							$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
							$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
							$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
							$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
						}
						//var_dump($po_array);
						$po_id_req_array = array();
						$is_sales_array = array();
						if ($db_type == 0) {
							$poID = " select c.requisition_no, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.requisition_no, a.is_sales ";
						} else {
							$poID = "select c.requisition_no, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.requisition_no, a.is_sales ";
						}
						$poID_sql_result = sql_select($poID);
						foreach ($poID_sql_result as $row) {
							$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
							$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
						}
						unset($poID_sql_result);

						$i = 1;
						if ($db_type == 0) {
							$sql_result = sql_select("select a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
						} else {
							$sql_result = sql_select("select a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
						}
						$all_req_no = '';
						$all_prod_id = '';
						$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
						$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
						foreach ($sql_result as $row) {
							if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
							if ($row[csf('requisition_no')] != '') {
								if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
								if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
							}
							$order_qnty_val = $row[csf('cons_quantity')];
							$order_qnty_val_sum += $order_qnty_val;

							$order_amount_val = $row[csf('order_amount')];
							$order_amount_val_sum += $order_amount_val;

							$no_of_bags_val = $row[csf('no_of_bags')];
							$no_of_bags_val_sum += $no_of_bags_val;

							$po_id = explode(",", $row[csf('po_id')]);
							$po_no = '';
							$style_ref = '';
							$job_no = '';
							$buyer = '';
							//$data=explode('*',$data);
							$productdtls = $row[csf('product_name_details')];
							$productArr = explode(' ', $productdtls);

							$proddtls = '';
							if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '') {
								$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
							} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '') {
								$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
							} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '') {
								$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
							} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '') {
								$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
							} else if ($productArr[0] != '' && $productArr[1] != '') {
								$proddtls = $productArr[0] . ', ' . $productArr[1];
							} else if ($productArr[0] != '') {
								$proddtls = $productArr[0];
							} else {
								$proddtls = '';
							}

							$internal_ref = '';
							$file_no = '';
							if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2) {
								foreach ($po_id as $val) {
									if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
									if ($job_no == '') $job_no = $po_array[$val]['job_no'];
									if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
									if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

									if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
									if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
								}
								$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
								$job_file = array_unique(explode(",", rtrim($file_no, ", ")));
								$ref_cond = '';
								foreach ($job_ref as $ref) {
									//$ref_cond.=", ".$ref;
									if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
								}
								$file_con = '';
								foreach ($job_file as $file) {
									if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
								}

								$buyer_job = '';
								if ($row[csf('issue_basis')] == 1) {
									if ($dataArray[0][csf('issue_purpose')] == 8) {
										$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
									} else {
										$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
										if ($row[csf('buyer_job_no')] != "") {
											$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
										}
									}
								} else if ($row[csf('issue_basis')] == 2) {
									$buyer_job = '';
								}
							} else if ($row[csf('issue_basis')] == 3) {
								//$ex_data = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
								//print_r($ex_data);

								if ($is_sales_array[$row[csf('requisition_no')]] == 1) {
									$buyer_job = '';
									foreach (array_unique($po_id) as $val) {
										if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
										if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];

										if ($buyer_job == '') {
											if ($job_no_array[$val]['within_group'] == 1) {
												$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
											} else {
												$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
											}
										}
									}
								} else {
									foreach ($po_id as $val) {
										if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
										if ($job_no == '') $job_no = $po_array[$val]['job_no'];
										if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
										if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

										if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
										if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
									}

									$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
									$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

									$ref_cond = '';
									foreach ($job_ref as $ref) {
										//$ref_cond.=", ".$ref;
										if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
									}

									$file_con = '';
									foreach ($job_file as $file) {
										if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
									}
									if ($job_no != '') {
										$buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
									} else {
										$buyer_job = $buyer_arr[$buyer_name];
									}
								}
							} else {
								foreach (array_unique($po_id) as $val) {
									if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
									if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
									if ($buyer_job == '') {
										if ($job_no_array[$val]['within_group'] == 1) {
											$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
										} else {
											$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
										}
									}
								}
							}

							$no_bag_cone = "";
							$wt_bag_cone = "";
							if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

							if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
							?>
							<tr bgcolor="<? echo $bgcolor; ?>" style="font-size:13px">
								<td width="20"><? echo $i; ?></td>
								<td width="45">
									<div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
								</td>
								<td width="50">
									<div style="word-wrap:break-word; width:50px"><? echo $row[csf('lot')]; ?></div>
								</td>
								<td width="110">
									<div style="word-wrap:break-word; width:110px">
										<?
                                        //echo $proddtls;
										echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
										?>
									</div>
								</td>
								<td width="65">
									<div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
								</td>
								<td width="80">
									<div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
								&nbsp;</div>
							</td>
							<td align="right"
							width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>

								<?php /*?>
									<td width="65">
										<div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>
										&nbsp;</div>
									</td>

									<td width="60">
										<div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
									</td>
									<?php */?>
									<td align="right"
									width="60"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>


								<?php /*?>	<td width="80">
										<div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
										</td><?php */?>
										<td width="100">
											<div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
										</td>
										<td width="120">
											<div style="word-wrap:break-word; width:120px"><? echo $po_no;
										//if ($style_ref != "") echo ' & ' . $style_ref; else echo '&nbsp;'; ?></div>
									</td>
									<?php /*?><td>
										<div style="word-wrap:break-word; width:80px"><? echo ltrim($ref_cond, ", ");
										if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?></div>
										</td><?php */?>
									</tr>
									<?
									$uom_unit = "Kg";
									$uom_gm = "Grams";
									$tot_return_qty += $row[csf('returnable_qnty')];
									$tot_bag += $no_of_bags_val;
									$tot_cone += $row[csf('cone_per_bag')];
									$tot_w_bag += $row[csf('weight_per_bag')];
									$tot_w_cone += $row[csf('weight_per_cone')];
									$req_no = $row[csf('requisition_no')];
									$i++;
								}
								?>
								<tr bgcolor="#CCCCCC" style="font-size:13px">
									<td align="right" colspan="7"><b>Total</b></td>
									<td align="right">
										<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
									</td>
									<td><? echo 'N:' . number_format($tot_bag, 2);
									if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
									echo '<br>W:' . number_format($tot_w_bag, 2);
									if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>

									<td></td>
								<?php /*?><td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
								<td><? echo 'N:' . number_format($tot_bag, 2);
								if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
								echo '<br>W:' . number_format($tot_w_bag, 2);
								if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
								<td align="right" colspan="4">&nbsp;</td><?php */?>
							</tr>
							<tr>
								<td colspan="14" align="left"><b>In
									Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
								</tr>
							</table>
							<br>
							<?
							echo signature_table(49, $data[0], "1000px");
							?>
						</div>
						<br>
						<br>&nbsp;
						<!--================================================================-->


						<script type="text/javascript" src="../../js/jquery.js"></script>
						<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
						<script>
							function generateBarcode(valuess) {
							var value = valuess;//$("#barcodeValue").val();
							var btype = 'code39';//$("input[name=btype]:checked").val();
							var renderer = 'bmp';// $("input[name=renderer]:checked").val();
							var settings = {
								output: renderer,
								bgColor: '#FFFFFF',
								color: '#000000',
								barWidth: 1,
								barHeight: 30,
								moduleSize: 5,
								posX: 10,
								posY: 20,
								addQuietZone: 1
							};
							$("#barcode_img_id").html('11');
							value = {code: value, rect: false};
							$("#barcode_img_id").show().barcode(value, btype, settings);
						}
						generateBarcode('<? echo $data[1]; ?>');
					</script>
					<?
					exit();

				}

if ($action == "yarn_issue_print15")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print8", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$company   = $data[0];
	$system_no = $data[1];
	$report_title = $data[2];
	$booking_id = $data[3];
	$is_approved = $data[4];
	$mst_id     = $data[5];
	$show_val_column = $data[6];
	$print_with_vat = $data[7];
	$location  = $data[8];
	$store_id=$data[9];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");

	$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");

	//$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$machine_arr = return_library_array("select id, machine_no from lib_machine_name", 'id', 'machine_no');
	//$color_type_arr = return_library_array("select id, color_type_id from wo_pre_cost_fabric_cost_dtls", 'id', 'color_type_id')

	$sql = "SELECT id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$mst_id'";
	//echo $sql;die;
	$dataArray = sql_select($sql);
	if( $dataArray[0][csf('issue_basis')] == 3 )
	{
		$planbooking = sql_select("select e.booking_no as pln_booking_no, d.id as program_id from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$mst_id' ");
		foreach ($planbooking as $value) {
			$program_id .= $value[csf('program_id')].',';
		}
		$program_ids = implode(",", array_unique(explode(",", chop($program_id,','))));
	}
	//echo $program_ids;

	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
	?>
	<style type="text/css">
		table tr td {
			font-size: 16px;
		}
		.rpt_table thead th{
			font-size: 16px;
		}
		.rpt_table tfoot th{
			font-size: 16px;
		}
	</style>
	<div style="width:1000px;">
		<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
			<tr>
				<td colspan="6" align="center" style="font-size:20px">
					<strong><? echo $com_dtls[0]; ?></strong></td>
				<td style="font-size:xx-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($is_approved == 1) echo "<b>Approved</b>"; ?></div></td>
			</tr>
			<tr class="form_caption">
				<?
				$data_array = sql_select("select image_location from common_photo_library where master_tble_id='$company' and form_name='company_details' and is_deleted=0 and file_type=1");
				?>
				<td align="left" width="50">
					<?
					foreach ($data_array as $img_row)
					{
						if ($mst_id != 1) {
							?>
							<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
							align="middle"/>
							<?
						} else {
							?>
							<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
							align="middle"/>
							<?
						}
					}
					?>
				</td>
				<td colspan="4" align="center"><? echo $com_dtls[1]; ?></td>
				<td>&nbsp;</td>
			</tr>
			<tr>
				<td colspan="6" align="center" style="font-size:18px"><strong><u>Yarn Delivery Challan/Gate Pass</u></strong></center>
				</td>
				<td>&nbsp;</td>
			</tr>
			<tr>
				<td width="160"><strong>Issue No:</strong></td>
				<td width="175px"><? echo $dataArray[0][csf('issue_number')]; ?></td>
				<td width="120"><strong>Booking:</strong></td>
				<td width="175px">
					<?
					if( $dataArray[0][csf('issue_basis')]==3 )
					{
						$bookingNo = $planbooking[0][csf('pln_booking_no')];
					} else {
						$bookingNo = $dataArray[0][csf('booking_no')];
					}
					echo $bookingNo;
					?>
				</td>
				<td width="125"><strong>Knitting Source:</strong></td>
				<td width="175px"><? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
			</tr>
			<tr>
				<td><strong>Program No:</strong></td>
				<td width="175px"><? echo $dataArray[0][csf('challan_no')]; ?></td>

				<td><strong>Issue Purpose:</strong></td>
                    <td width="175px"><? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
                    echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
                    ?></td>
                    <td><strong>Issue Date:</strong></td>
                    <td width="175px"><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
            </tr>
            <tr>
            	<td><strong>Issue To:</strong></td>
            	<?
            	if ($dataArray[0][csf('knit_dye_source')] == 3)
            	{
            		$supp_add = $dataArray[0][csf('knit_dye_company')];
            		$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
            		foreach ($nameArray as $result) {
            			$address = "";
						if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($nameArray);
				}

				$loan_party_add = $dataArray[0][csf('loan_party')];
				$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
				foreach ($loanPartyArray as $result) {
					$addressParty = "";
					if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
				}
				unset($loanPartyArray);
				?>
				<td colspan="3">
					<?
					if ($dataArray[0][csf('issue_purpose')] == 3) {
						echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
					} else if ($dataArray[0][csf('issue_purpose')] == 5) {
						echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
					} else {
						if ($dataArray[0][csf('knit_dye_source')] == 1)
							echo $company_library[$dataArray[0][csf('knit_dye_company')]];
						else
							echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
					}
					?>
				</td>
				<td><strong>Location:</strong></td>
				<td><? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>
			</tr>
			<tr>
				<td><strong>Demand No.:</strong></td>
                <td width="175px"><? //echo $dataArray[0][csf('booking_id')];
                ?></td>

                <td><strong>Do No:</strong></td>
                <td width="175px"><? //echo $dataArray[0][csf('remarks')];
                ?></td>
            </tr>
            <tr>
            	<td valign="top"><strong>Remarks :</strong></td>
            	<td colspan="5"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
            </tr>
            <?
            if ($print_with_vat == 1)
            {
            	?>
            	<tr>
                    <!-- <td><strong>VAT Number :</strong></td>
					<td><p>
						<?
					$vat_no = return_field_value("vat_number", "lib_company", "id=" . $company, "vat_number");
					echo $vat_no;
					?></p></td> -->
					<td><strong>Bar Code:</strong></td>
					<td colspan="3" id="barcode_img_id"></td>
				</tr>
				<?
			}
			else
			{
				?>
				<tr>
					<td valign="top">&nbsp;</strong></td>
					<td>&nbsp;</td>
					<td><strong>Bar Code:</strong></td>
					<td colspan="3" id="barcode_img_id"></td>
				</tr>
				<?
			}
			?>
		</table>
		<br>
		<div style="width:100%;">
			<div style="clear:both;">
				<table style="margin-right:-40px; " cellspacing="0" width="1000" border="1" rules="all"
				class="rpt_table">
					<thead bgcolor="#dddddd">
						<th width="20">SL</th>
						<th width="45">Req. No</th>
						<th width="50">Program No</th>
						<th width="50">Lot No</th>
						<th width="65">Y. Type</th>
						<th width="110">Item Details</th>

						<th width="65">Dye. Color</th>
						<th width="60">Supp.</th>
						<th width="60"><b>Issue Qty(kg)</b></th>
						<th width="60">Rtnbl Qty(kg)</th>
						<th width="80">Bag & Cone</th>
						<th width="80">Store</th>
						<th width="100">Buyer & Job</th>
						<th width="120">Order & Style</th>
						<th>Inte. Ref & File</th>
					</thead>
					<?
					$wopi_library = return_library_array("select id, pi_number from com_pi_master_details", "id", "pi_number");

					$cond = "";
					if ($mst_id != "") $cond .= " and c.id='$mst_id'";

					$po_array = array();
					$job_array = array();
					$costing_sql = sql_select("select a.job_no, b.file_no, b.grouping, a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$company");
					foreach ($costing_sql as $row)
					{
						$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
						$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
						$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
						$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
						$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
						$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
						$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
						$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
					}
					unset($costing_sql);

					$job_no_array = array();
					$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst");
					foreach ($jobData as $row)
					{
						$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
						$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
						$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
						$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
					}

					$po_id_req_array = array();
					$is_sales_array = array();
					if ($db_type == 0) {
						$poID = " SELECT c.knit_id, c.requisition_no, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id,c.requisition_no, a.is_sales ";
					} else {
						$poID = "SELECT c.knit_id, c.requisition_no, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.is_sales";
					}
					$poID_sql_result = sql_select($poID);
					foreach ($poID_sql_result as $row)
					{
						$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
						$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
						$program_array[$row[csf('requisition_no')]] = $row[csf('knit_id')];
					}
					unset($poID_sql_result);

					$i = 1;
					if ($db_type == 0)
					{
						$sql_result = sql_select("SELECT a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro
						from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
						where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
						group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
					}
					else
					{
						$sql_result = sql_select("SELECT a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro
						from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
						where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
						group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
					}
					$all_req_no = "";
					$all_prod_id = "";
					$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
					$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
					foreach ($sql_result as $row)
					{
						if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
						if ($row[csf('requisition_no')] != "") {
							if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')];
							else $all_req_no .= ',' . $row[csf('requisition_no')];

							if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')];
							else $all_prod_id .= ',' . $row[csf('po_id')];
						}
						$order_qnty_val = $row[csf('cons_quantity')];
						$order_qnty_val_sum += $order_qnty_val;

						$order_amount_val = $row[csf('order_amount')];
						$order_amount_val_sum += $order_amount_val;

						$no_of_bags_val = $row[csf('no_of_bags')];
						$no_of_bags_val_sum += $no_of_bags_val;

						$po_id = explode(",", $row[csf('po_id')]);
						$po_no = "";
						$style_ref = "";
						$job_no = "";
						$buyer = "";
							//$data=explode('*',$data);
						$productdtls = $row[csf('product_name_details')];
						$productArr = explode(' ', $productdtls);

						$proddtls = "";
						if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '') {
							$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
						} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '') {
							$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
						} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '') {
							$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
						} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '') {
							$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
						} else if ($productArr[0] != '' && $productArr[1] != '') {
							$proddtls = $productArr[0] . ', ' . $productArr[1];
						} else if ($productArr[0] != '') {
							$proddtls = $productArr[0];
						} else {
							$proddtls = "";
						}

						$internal_ref = "";
						$file_no = "";

						if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
						{
							foreach ($po_id as $val)
							{
								if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
								if ($job_no == '') $job_no = $po_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
								if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
							}

							$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
							$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

							$ref_cond = "";
							foreach ($job_ref as $ref) {
								if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
							}

							$file_con = "";
							foreach ($job_file as $file) {
								if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
							}

							$buyer_job = "";
							if ($row[csf('issue_basis')] == 1)
							{
								if ($dataArray[0][csf('issue_purpose')] == 8) {
									$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
								} else {
									$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
									if ($row[csf('buyer_job_no')] != "") {
										$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
									}
								}
							}
							else if ($row[csf('issue_basis')] == 2)
							{
								$buyer_job = "";
							}
						}
						else if ($row[csf('issue_basis')] == 3)
						{
							$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
								//print_r($ex_data);

							if ($is_sales_array[$row[csf('requisition_no')]] == 1)
							{
								$buyer_job = "";
								foreach (array_unique($po_id) as $val)
								{
									if ($po_no == "") $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
									if ($style_ref == "") $style_ref = $job_no_array[$val]['style_ref'];

									if ($buyer_job == "") {
										if ($job_no_array[$val]['within_group'] == 1) {
											$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
										} else {
											$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
										}
									}

									if ($job_no_array[$val]['within_group'] != 1) {
										$ref_cond = "";
									}

								}
							}
							else
							{
								foreach ($po_id as $val)
								{
									if ($po_no == "") $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
									if ($job_no == "") $job_no = $po_array[$val]['job_no'];
									if ($style_ref == "") $style_ref = $po_array[$val]['style_ref'];
									if ($buyer == "") $buyer_name = $po_array[$val]['buyer_name'];

									if ($internal_ref == "") $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
									if ($file_no == "") $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
								}

								$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
								$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

								$ref_cond = "";
								foreach ($job_ref as $ref) {
									if ($ref_cond == "") $ref_cond = $ref; else $ref_cond .= ", " . $ref;
								}

								$file_con = "";
								foreach ($job_file as $file) {
									if ($file_con == "") $file_cond = $file; else $file_cond .= ", " . $file;
								}

								if ($job_no != "") {
									$buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
								} else {
									$buyer_job = $buyer_arr[$buyer_name];
								}
							}
						}
						else
						{
							foreach (array_unique($po_id) as $val)
							{
								if ($po_no == "") $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
								if ($style_ref == "") $style_ref = $job_no_array[$val]['style_ref'];
								if ($buyer_job == "") {
									if ($job_no_array[$val]['within_group'] == 1) {
										$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
									} else {
										$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
									}
								}
							}
						}

						$no_bag_cone = "";
						$wt_bag_cone = "";
						if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

						if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
						?>
						<tbody>
							<tr bgcolor="<? echo $bgcolor; ?>">
								<td width="20"><? echo $i; ?></td>
								<td width="45">
									<div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
								</td>
								<td width="50">
									<?  echo $program_array[$row[csf('requisition_no')]]; ?>
								</td>
								<td width="50">
									<div style="word-wrap:break-word; width:50px; font-size:18px;"><b><? echo $row[csf('lot')]; ?></b></div>
								</td>

								<td width="65">
									<div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
								</td>
								<td width="110">
									<div style="word-wrap:break-word; width:110px">
										<?
										echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
										?>
									</div>
								</td>

								<td width="65">
									<div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>&nbsp;</div>
								</td>

								<td width="60">
									<div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
								</td>

								<td align="right"
								width="60" style="font-size:18px;"><b><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></b></td>
								<td align="right"
								width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
								<td width="80">
									<div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
								&nbsp;</div></td>
								<td width="80">
									<div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
								</td>
								<td width="100">
									<div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
								</td>
								<td width="120">
									<div style="word-wrap:break-word; width:120px"><? echo $po_no;
									if ($style_ref != "") echo ' & ' . $style_ref; else echo '&nbsp;'; ?></div>
								</td>
								<td>
									<div style="word-wrap:break-word; width:80px"><? echo ltrim($ref_cond, ", ");
									if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?></div>
								</td>
							</tr>
						</tbody>
						<?
						$uom_unit = "Kg";
						$uom_gm = "Grams";
						$tot_return_qty += $row[csf('returnable_qnty')];
						$tot_bag += $no_of_bags_val;
						$tot_cone += $row[csf('cone_per_bag')];
						$tot_w_bag += $row[csf('weight_per_bag')];
						$tot_w_cone += $row[csf('weight_per_cone')];
						$req_no = $row[csf('requisition_no')];
						$i++;
					}
					?>
					<tr bgcolor="#CCCCCC" style="font-size:16px">
						<td align="right" colspan="8"><b>Total</b></td>
						<td align="right">
							<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
						</td>
						<td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
						<td><? echo 'N:' . number_format($tot_bag, 2);
						if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
						echo '<br>W:' . number_format($tot_w_bag, 2);
						if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
						<td align="right" colspan="4">&nbsp;</td>
					</tr>
					<tr>
						<td colspan="15" align="left"><b>In
						Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
					</tr>
				</table>
			</div>
			<br>
			<!--=====================================-->
			<?
			if ($show_val_column == 1)
			{
				if ($dataArray[0][csf('issue_basis')] == 3)
				{
					?>
					<table width="1010" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
						<thead>
							<th width="20">SL</th>
							<th width="60">Program No & Date</th>
							<th width="120">Fabrication</th>
							<th width="40">GSM</th>
							<th width="45">F. Dia</th>
							<th width="80">Dia Type</th>
							<th width="50">S/L</th>
							<th width="60">Color</th>
							<th width="60">Color Range</th>
							<th width="70">Machine Dia & GG</th>
							<th width="70">Prpgram Qty.</th>
							<th width="120">Yarn Description</th>
							<th width="50">Lot</th>
							<th width="70">Yarn Qty.(KG)</th>
							<th>Remarks</th>
						</thead>
						<?
						$knit_id_array = array();
						$prod_id_array = array();
						$rqsn_array = array();
						$reqsn_dataArray = sql_select("select knit_id, requisition_no, prod_id,sum(no_of_cone) as no_of_cone , sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where knit_id in($program_ids) and status_active=1 and is_deleted=0 group by knit_id, prod_id, requisition_no");
						foreach ($reqsn_dataArray as $row) {
							$prod_id_array[$row[csf('knit_id')]][$row[csf('prod_id')]] = $row[csf('yarn_qnty')];
							$knit_id_array[$row[csf('knit_id')]] .= $row[csf('prod_id')] . ",";
							$rqsn_array[$row[csf('prod_id')]]['reqsn'] .= $row[csf('requisition_no')] . ",";
							$rqsn_array[$row[csf('prod_id')]]['qnty'] += $row[csf('yarn_qnty')];
							$rqsn_array[$row[csf('prod_id')]]['no_of_cone'] += $row[csf('no_of_cone')];
							$prod_id .= $row[csf('prod_id')].',';
						}
						$prod_ids = implode(",", array_unique(explode(",", chop($prod_id,','))));

						$product_details_array = array();
						$sql = "select id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where id in($prod_ids) and item_category_id=1 and status_active=1 and is_deleted=0";
						$result = sql_select($sql);

						foreach ($result as $row) {
							$compos = '';
							if ($row[csf('yarn_comp_percent2nd')] != 0) {
								$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
							} else {
								$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
							}

							$product_details_array[$row[csf('id')]]['desc'] = $count_arr[$row[csf('yarn_count_id')]] . " " . $compos . " " . $yarn_type[$row[csf('yarn_type')]];
							$product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
							$product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
							$product_details_array[$row[csf('id')]]['color'] = $color_library[$row[csf('color')]];
						}

						$i = 1;
						$s = 1;
						$tot_program_qnty = 0;
						$tot_yarn_reqsn_qnty = 0;
						$company_id = '';
						$sql = "select a.company_id, a.fabric_desc, a.gsm_weight, a.dia, a.width_dia_type, b.id as program_id, b.color_id, b.color_range, b.machine_dia, b.width_dia_type as diatype, b.machine_gg, b.fabric_dia, b.program_qnty, b.program_date, b.stitch_length,b.spandex_stitch_length,b.feeder, b.machine_id, b.start_date, b.end_date, b.remarks from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id in($program_ids) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
						$nameArray = sql_select($sql);
						foreach ($nameArray as $row)
						{
							if ($i % 2 == 0)
								$bgcolor = "#E9F3FF";
							else
								$bgcolor = "#FFFFFF";

							$color = '';
							$color_id = explode(",", $row[csf('color_id')]);

							foreach ($color_id as $val) {
								if ($color == '')
									$color = $color_name_arr[$val];
								else
									$color .= "," . $color_name_arr[$val];
							}

							if ($company_id == '')
								$company_id = $row[csf('company_id')];

							$machine_no = '';
							$machine_id = explode(",", $row[csf('machine_id')]);

							foreach ($machine_id as $val) {
								if ($machine_no == '')
									$machine_no = $machine_arr[$val];
								else
									$machine_no .= "," . $machine_arr[$val];
							}

							if ($knit_id_array[$row[csf('program_id')]] != "")
							{
								$all_prod_id = explode(",", substr($knit_id_array[$row[csf('program_id')]], 0, -1));
								$row_span = count($all_prod_id);
								$z = 0;
								foreach ($all_prod_id as $prod_id)
								{
									?>
									<tr bgcolor="<? echo $bgcolor; ?>">
										<?
										if ($z == 0)
										{
											?>
											<td width="20" rowspan="<? echo $row_span; ?>"><? echo $i; ?></td>
											<td width="60" rowspan="<? echo $row_span; ?>" align="center"><? echo $row[csf('program_id')] . '<br>' . change_date_format($row[csf('program_date')]); ?></td>
											<td width="120" rowspan="<? echo $row_span; ?>"><p><? echo $row[csf('fabric_desc')]; ?></p></td>
											<td width="40" rowspan="<? echo $row_span; ?>"><p><? echo $row[csf('gsm_weight')]; ?></p></th>
											<td width="45" rowspan="<? echo $row_span; ?>"><p><? echo $row[csf('fabric_dia')]; ?></p></td>
											<td width="80" rowspan="<? echo $row_span; ?>"><p><? echo $fabric_typee[$row[csf('diatype')]]; ?></p></td>
											<td width="50" rowspan="<? echo $row_span; ?>"><p><? echo $row[csf('stitch_length')]; ?></p></td>
											<td width="60" rowspan="<? echo $row_span; ?>"><p><? echo $color; ?></p></td>
											<td width="60" rowspan="<? echo $row_span; ?>"><p><? echo $color_range[$row[csf('color_range')]]; ?></p></td>
											<td width="70" rowspan="<? echo $row_span; ?>"><p><? echo $row[csf('machine_dia')] . "X" . $row[csf('machine_gg')]; ?></p></td>
											<td width="70" align="right" rowspan="<? echo $row_span; ?>"><? echo number_format($row[csf('program_qnty')], 2, '.', ''); ?>&nbsp;</td>
											<?
											$tot_program_qnty += $row[csf('program_qnty')];
											$i++;
										}
										?>
										<td width="120"><p><? echo $product_details_array[$prod_id]['desc']; ?>&nbsp;</p></td>
										<td width="50"><p><? echo $product_details_array[$prod_id]['lot']; ?>&nbsp;</p></td>
										<td width="70" align="right"><? echo number_format($prod_id_array[$row[csf('program_id')]][$prod_id], 2, '.', ''); ?></td>
										<?
										if ($z == 0) {
											?>
											<td rowspan="<? echo $row_span; ?>"><p><? echo $row[csf('remarks')]; ?>&nbsp;</p></td>
											<?
										}
										?>
									</tr>
									<?
									$tot_yarn_reqsn_qnty += $prod_id_array[$row[csf('program_id')]][$prod_id];
									$z++;
								}
							}
							else
							{
								?>
								<tr bgcolor="<? echo $bgcolor; ?>">
									<td width="20"><? echo $i; ?></td>
									<td width="60" align="center"><? echo $row[csf('program_id')] . '<br>' . change_date_format($row[csf('program_date')]); ?></td>
									<td width="120"><p><? echo $row[csf('fabric_desc')]; ?></p></td>
									<td width="40"><p><? echo $row[csf('gsm_weight')]; ?></p></th>
									<td width="45"><p><? echo $row[csf('fabric_dia')]; ?></p></td>
									<td width="80"><p><? echo $fabric_typee[$row[csf('diatype')]]; ?></p></td>
									<td width="50"><p><? echo $row[csf('stitch_length')]; ?></p></td>
									<td width="60"><p><? echo $color; ?></p></td>
									<td width="60"><p><? echo $color_range[$row[csf('color_range')]]; ?></p></td>
									<td width="70"><p><? echo $row[csf('machine_dia')] . "X" . $row[csf('machine_gg')]; ?></p></td>
									<td width="70" align="right"><? echo number_format($row[csf('program_qnty')], 2, '.', ''); ?>&nbsp;</td>
									<td width="120"><p>&nbsp;</p></td>
									<td width="50"><p>&nbsp;</p></td>
									<td width="70" align="right">&nbsp;</td>
									<td><p><? echo $row[csf('remarks')]; ?>&nbsp;</p></td>
								</tr>
								<?
								$tot_program_qnty += $row[csf('program_qnty')];
								$i++;
							}
						}
						?>

						<tfoot>
							<th colspan="10" align="right"><b>Total</b></th>
							<th align="right"><? echo number_format($tot_program_qnty, 2, '.', ''); ?>&nbsp;</th>
							<th>&nbsp;</th>
							<th>&nbsp;</th>
							<th align="right"><? echo number_format($tot_yarn_reqsn_qnty, 2, '.', ''); ?></th>
							<th>&nbsp;</th>
						</tfoot>
					</table>
					<br>
					<?
					$sql_collarCuff=sql_select("select id, body_part_id, grey_size, finish_size, qty_pcs from ppl_planning_collar_cuff_dtls where status_active=1 and is_deleted=0 and dtls_id in($program_ids) order by id");
					if(count($sql_collarCuff)>0)
					{
						?>
						<table width="500" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
							<thead>
								<tr>
									<th width="50">SL</th>
									<th width="100">Body Part</th>
									<th width="100">Grey Size</th>
									<th width="100">Finish Size</th>
									<th>Quantity Pcs</th>
								</tr>
							</thead>
							<tbody>
								<?
								$i=1; $total_qty_pcs=0;
								foreach($sql_collarCuff as $row)
								{
									if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
									?>
									<tr>
										<td align="center"><p><? echo $i; ?>&nbsp;</p></td>
										<td><p><? echo $body_part[$row[csf('body_part_id')]]; ?>&nbsp;</p></td>
										<td><p><? echo $row[csf('grey_size')]; ?>&nbsp;</p></td>
										<td><p><? echo $row[csf('finish_size')]; ?>&nbsp;</p></td>
										<td align="right"><p><? echo number_format($row[csf('qty_pcs')],0); $total_qty_pcs+=$row[csf('qty_pcs')]; ?>&nbsp;&nbsp;</p></td>
									</tr>
									<?
									$i++;
								}
								?>
							</tbody>
							<tfoot>
								<tr>
									<th></th>
									<th></th>
									<th></th>
									<th align="right">Total</th>
									<th align="right"><? echo number_format($total_qty_pcs,0); ?>&nbsp;</th>
								</tr>
							</tfoot>
						</table>
						<br>
						<?
					}

					$sql_strip = "select a.color_number_id, a.stripe_color, a.measurement, a.uom, b.dtls_id as program_id, b.no_of_feeder as no_of_feeder, c.body_part_id from wo_pre_stripe_color a, ppl_planning_feeder_dtls b, wo_pre_cost_fabric_cost_dtls c where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.color_number_id=b.color_id and a.stripe_color=b.stripe_color_id and b.dtls_id in($program_ids) and b.no_of_feeder>0 and a.status_active=1 and a.is_deleted=0";
					$result_stripe = sql_select($sql_strip);
					$strip_dtls_arr=array();
					foreach ($result_stripe as $row)
					{
						$strip_dtls_arr[$row[csf('program_id')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['no_of_feeder']=$row[csf('no_of_feeder')];
						$strip_dtls_arr[$row[csf('program_id')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['measurement']=$row[csf('measurement')];
						$strip_dtls_arr[$row[csf('program_id')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['uom']=$row[csf('uom')];
					}

					$body_row_arr=array();
					foreach($strip_dtls_arr as $program => $program_val)
	                {
						$body_row_span=0;
						foreach($program_val as $body_id=>$body_part_val)
						{
							$color_row_span=0;
							foreach($body_part_val as $gmt_color => $color_val)
							{
								foreach($color_val as $strip_color => $row)
								{
									$body_row_span++;
									$color_row_span++;
								}
								$body_row_arr[$program] = $body_row_span;
								$color_row_arr[$program][$body_id] = $color_row_span;
							}
						}
					}

					if (count($result_stripe) > 0)
					{
						?>
						<table cellspacing="0" cellpadding="0" border="1" rules="all" width="600" class="rpt_table" >
							<thead>
								<tr>
									<th colspan="8">Stripe Measurement</th>
								</tr>
								<tr>
									<th width="30">SL</th>
									<th width="80">Prog. no</th>
									<th width="80">Body Part</th>
									<th width="100">Color</th>
									<th width="100">Stripe Color</th>
									<th width="100">Measurement</th>
									<th width="50">UOM</th>
									<th>No Of Feeder</th>
								</tr>
							</thead>
							<?
							$i = 1;
							$tot_feeder = 0;
							foreach($strip_dtls_arr as $program => $program_val)
			                {
								$p=0;
								foreach($program_val as $body_id=>$body_part_val)
								{
									$b=0;
									foreach($body_part_val as $gmt_color => $color_val)
									{
										foreach($color_val as $strip_color => $row)
										{
											if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
											$tot_feeder += $row[('no_of_feeder')];
											$body_row  = $body_row_arr[$program];
											$color_row = $color_row_arr[$program][$body_id];
											?>
											<tr valign="middle" bgcolor="<? echo $bgcolor; ?>" id="search<? echo $i; ?>">
												<td width="30" align="center"><? echo $i; ?></td>
												<td width="80" align="center"><? echo $program; ?></td>
												<?
												if($p==0)
												{
													?>
													<td width="80" rowspan="<? echo $body_row;?>" align="center"><? echo $body_part[$body_id]; ?></td>
													<?
												}
												if($p==0)
												{
													?>
													<td width="100" rowspan="<? echo $color_row;?>"><p><? echo $color_name_arr[$gmt_color]; ?></p></td>
													<?
												}
												?>
												<td width="100"><p><? echo $color_name_arr[$strip_color]; ?></p></td>
												<td width="100" align="center"><? echo $row[('measurement')]; ?></td>
												<td width="50" align="center"><p><? echo $unit_of_measurement[$row[('uom')]]; ?></p></td>
												<td align="right" style="padding-right:10px"><? echo $row[('no_of_feeder')]; ?>&nbsp;</td>
											</tr>
											<?
											$tot_masurement += $row[('measurement')];
											$i++;$p++;$b++;
										}
									}
								}
							}
							?>
							<tfoot>
								<th colspan="5">Total</th>
								<th>&nbsp;</th>
								<th>&nbsp;</th>
								<th style="padding-right:10px"><? echo $tot_feeder; ?>&nbsp;</th>
							</tfoot>
							<?
						}
						?>
					</table>
					<br>
                    <?
                    if ($mst_id != 1)
                    {
                    	$z = 1;
                    	$k = 1;
            			$colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

        				$booking_al = "";
                    	foreach ($colorArray as $book) {
                    		if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];
                    	}

                    	$booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
                    	$booking_count = count(array_unique(explode(',', $booking_no)));

                    	if ($dataArray[0][csf('issue_purpose')] == 2) {
                    		$booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
                    	} else {
                    		$booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
                    	}

                    	$booking_job_no = $booking_job[0][csf('job_no')];
                    	unset($booking_job);

                    	if ($db_type == 0) $poNoCond = "group_concat(id)";
                    	else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";

						$sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

						$job_po = $sql_returnJob[0][csf('po_break_down_id')];
						unset($sql_returnJob);

						$returnJob = '';
						$returnPo = '';
						if ($db_type == 0)
						{
							$booking_cond = "group_concat(a.booking_no)";
							$wo_cond = "group_concat(a.ydw_no)";
							$reqs_no = "group_concat(b.requisition_no)";
						}
						else if ($db_type == 2)
						{
							$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
							$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
							$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
						}

						if ($dataArray[0][csf('issue_purpose')] == 8)
						{
							$sql_returnJob = sql_select("select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
						}
						else if ($dataArray[0][csf('issue_purpose')] == 2)
						{
							$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

							if ($db_type == 0) $poNoCond = "group_concat(id)";
							else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
							$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
						}
						else
						{
							$sql_returnJob = sql_select("select a.job_no, a.booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' and a.booking_no in($booking_no) group by a.job_no,a.booking_no");
						}

						$returnJob = $sql_returnJob[0][csf('job_no')];
										//$returnPo=$sql_po[0][csf('po_break_down_id')];
						$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
						$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
						$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
						unset($sql_returnJob);
						?>
						<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
						cellspacing="0" class="rpt_table">
							<thead>
								<tr>
									<th colspan="6" align="center">Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking
									Job Deatils]</p></th>
								</tr>
								<tr>
									<th>Buyer</th>
									<th>Job</th>
									<th>Req. Qty</th>
									<th>Cuml. Issue Qty</th>
									<th>Balance Qty</th>
									<th>Remarks</th>
								</tr>
							</thead>
							<?
							$all_requ_no = "";
							if ($dataArray[0][csf('issue_purpose')] != 8)
							{
								$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");

								//$all_requ_no="'".$all_booking_sql[0][csf('requisition_no')]."'";
								$all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
							}
							if ($dataArray[0][csf('issue_purpose')] == 8)
							{
								$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");    //
								$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
							}
							else if ($dataArray[0][csf('issue_purpose')] == 2)
							{
								if ($all_requ_no != "" || $all_requ_no != 0) {
									$req_cond = "or a.requisition_no in ($all_requ_no)";
									$reqRet_cond = "or b.booking_no in ($all_requ_no)";
								} else {
									$req_cond = "or a.requisition_no in (0)";
									$reqRet_cond = "or b.booking_no in (0)";
								}

								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
							}
							else
							{
								if ($all_requ_no != "" || $all_requ_no != 0) {
									$req_cond = "or a.requisition_no in ($all_requ_no)";
									$reqRet_cond = "or b.booking_no in ($all_requ_no)";
								} else {
									$req_cond = "or a.requisition_no in (0)";
									$reqRet_cond = "or b.booking_no in (0)";
								}
								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");


								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
							}
							$cumulative_qty = 0;
							if ($booking_count == 1)
							{
								?>
								<tbody>
									<tr>
										<td align="center">
											<? echo $buyer_arr[$job_array[$booking_job_no]['buyer']]; ?>
										</td>
										<td align="center">
											<? echo $job_array[$booking_job_no]['job']; ?>
										</td>
										<td align="center">
											<? echo number_format($returnReqQty, 3); ?>
										</td>
										<td align="center">
											<? $cumulative_qty = $total_issue_qty - $total_return_qty;
											echo number_format($cumulative_qty, 3); ?>
										</td>
										<td align="center">
											<? $balance_qty = $returnReqQty - $cumulative_qty;
											echo number_format($balance_qty, 3); ?>
										</td>
										<td align="center">
											<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
										</td>
									</tr>
								</tbody>
								<?
							}
							?>
						</table>
						<?
					}
				}
				if ($dataArray[0][csf('issue_basis')] == 1)
				{
					?>
					<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
					cellspacing="0" class="rpt_table">
						<thead>
							<tr>
								<th colspan="6" align="center">
									Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
										if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
									} ?> </th>
							</tr>
							<tr>
								<th>Buyer</th>
								<th>Job</th>
								<th>Req. Qty</th>
								<th>Cuml. Qty</th>
								<th>Balance Qty</th>
								<th>Remarks</th>
							</tr>
						</thead>
						<?
						//$booking_job_arr=array();
						$returnJob = '';
						$returnPo = '';
						if ($db_type == 0) {
							$booking_cond = "group_concat( distinct a.booking_no)";
							$wo_cond = "group_concat(a.ydw_no)";
							$reqs_no = "group_concat(b.requisition_no)";
						} else if ($db_type == 2) {
							$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
							$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
							$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
						}

						if ($dataArray[0][csf('issue_purpose')] == 8)
						{
							$sql_returnJob = sql_select("select a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
						}
						else if ($dataArray[0][csf('issue_purpose')] == 2)
						{
							if ($dataArray[0][csf('buyer_job_no')] != '')
							{
								$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

								if ($db_type == 0) $poNoCond = "group_concat(id)";
								else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
								$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
							}
							else
							{
								$sql_returnJob = sql_select("select a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
							}
						}
						else
						{
							//echo "select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
							$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");//and a.booking_no='".$dataArray[0][csf('booking_no')]."'
						}
						$returnJob = $sql_returnJob[0][csf('job_no')];
						$returnPo = $sql_po[0][csf('po_break_down_id')];
						$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
						$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

						$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
						unset($sql_returnJob);

						$all_requ_no = "";
						if ($dataArray[0][csf('issue_purpose')] != 8)
						{
							//echo "select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no";
							$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

							$all_requ_no = $all_booking_sql[0][csf('requisition_no')];
							unset($all_booking_sql);
						}

						if ($dataArray[0][csf('issue_purpose')] == 8)
						{
							$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");    //
							$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
						}
						else if ($dataArray[0][csf('issue_purpose')] == 2)
						{

							if ($dataArray[0][csf('buyer_job_no')] != "")
							{
								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
							}
							else
							{
								//echo "select sum(a.cons_quantity) as total_issue_qty from inv_transaction a, inv_issue_master b where b.id=a.mst_id and b.booking_no='".$dataArray[0][csf('booking_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.buyer_job_no<>'' and b.issue_purpose=2";
								$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
								$total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
							}
						}
						else
						{
							if ($dataArray[0][csf('buyer_job_no')] != "")
							{
								if ($all_requ_no != "" || $all_requ_no != 0) {
									$req_cond = "or a.requisition_no in ($all_requ_no)";
									$reqRet_cond = "or b.booking_no in ($all_requ_no)";
								} else {
									$req_cond = "";//or a.requisition_no in (0)
									$reqRet_cond = "";//or b.booking_no in (0)
								}
										$total_issue_qty = 0;
								//echo "select sum(c.quantity) as total_issue_qty from inv_transaction a, inv_issue_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2";
								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2";
								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");

								//$total_issue_qty=return_field_value("sum(quantity) as total_issue_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=2 and entry_form=3","total_issue_qty");
								//$total_return_qty=return_field_value("sum(quantity) as total_return_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=4 and entry_form=8","total_return_qty");
							}
						}
						?>
						<tbody>
							<tr>
								<td align="center">
									<?
									if ($dataArray[0][csf('issue_purpose')] == 8) echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
									else echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
									?>
								</td>
								<td align="center">
									<? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
								</td>
								<td align="center" style="font-size:18px">
									<b><? echo number_format($returnReqQty, 3); ?></b>
								</td>
								<td align="center" style="font-size:18px">
									<b><? $cumulative_qty = 0;
									$cumulative_qty = $total_issue_qty - $total_return_qty;
									echo number_format($cumulative_qty, 3); ?></b>
								</td>
								<td align="center" style="font-size:18px">
									<b><? $balance_qty = $returnReqQty - $cumulative_qty;
									echo number_format($balance_qty, 3); ?></b>
								</td>
								<td align="center">
									<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
								</td>
							</tr>
						</tbody>
					</table>
					<?
				}
			}
			?>
			<br>
			<? echo signature_table(49, $company, "1030px"); ?>
		</div>
	</div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		function generateBarcode(valuess)
		{
            var value = valuess;//$("#barcodeValue").val();
            var btype = 'code39';//$("input[name=btype]:checked").val();
            var renderer = 'bmp';// $("input[name=renderer]:checked").val();
            var settings = {
            	output: renderer,
            	bgColor: '#FFFFFF',
            	color: '#000000',
            	barWidth: 1,
            	barHeight: 30,
            	moduleSize: 5,
            	posX: 10,
            	posY: 20,
            	addQuietZone: 1
            };
            $("#barcode_img_id").html('11');
            value = {code: value, rect: false};
            $("#barcode_img_id").show().barcode(value, btype, settings);
        }
        generateBarcode('<? echo $system_no; ?>');
    </script>
    <?
    exit();
}
if ($action == "yarn_issue_printEKL")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print8", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$company   = $data[0];
	$system_no = $data[1];
	$report_title = $data[2];
	$booking_id = $data[3];
	$is_approved = $data[4];
	$mst_id     = $data[5];
	$show_val_column = $data[6];
	$print_with_vat = $data[7];
	$location  = $data[8];
	$store_id=$data[9];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");

	$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");

	//$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$machine_arr = return_library_array("select id, machine_no from lib_machine_name", 'id', 'machine_no');
	//$color_type_arr = return_library_array("select id, color_type_id from wo_pre_cost_fabric_cost_dtls", 'id', 'color_type_id')

	$sql = "SELECT id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$mst_id'";
	// echo $sql;die;
	$dataArray = sql_select($sql);
	if( $dataArray[0][csf('issue_basis')] == 3 )
	{
		$planbooking = sql_select("select e.booking_no as pln_booking_no, d.id as program_id from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$mst_id' ");
		foreach ($planbooking as $value) {
			$program_id .= $value[csf('program_id')].',';
		}
		$program_ids = implode(",", array_unique(explode(",", chop($program_id,','))));
	}
	//echo $program_ids;

	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
	?>
	<style type="text/css">
		table tr td {
			font-size: 16px;
		}
		.rpt_table thead th{
			font-size: 16px;
		}
		.rpt_table tfoot th{
			font-size: 16px;
		}
	</style>
	<div style="width:1000px;">
		<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
			<tr>
				<td colspan="6" align="center" style="font-size:20px">
					<strong><? echo $com_dtls[0]; ?></strong></td>
				<td style="font-size:xx-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($is_approved == 1) echo "<b>Approved</b>"; ?></div></td>
			</tr>
			<tr class="form_caption">
				<?
				$data_array = sql_select("select image_location from common_photo_library where master_tble_id='$company' and form_name='company_details' and is_deleted=0 and file_type=1");
				?>
				<td align="left" width="50">
					<?
					foreach ($data_array as $img_row)
					{
						if ($mst_id != 1) {
							?>
							<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
							align="middle"/>
							<?
						} else {
							?>
							<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
							align="middle"/>
							<?
						}
					}
					?>
				</td>
				<td colspan="4" align="center"><? echo $com_dtls[1]; ?></td>
				<td>&nbsp;</td>
			</tr>
			<tr>
				<td colspan="6" align="center" style="font-size:18px"><strong><u>Yarn Delivery Challan/Gate Pass</u></strong></center>
				</td>
				<td>&nbsp;</td>
			</tr>
			<tr>
				<td width="160"><strong>Issue No:</strong></td>
				<td width="175px"><? echo $dataArray[0][csf('issue_number')]; ?></td>
				<td width="120"><strong>Booking:</strong></td>
				<td width="175px">
					<?
					if( $dataArray[0][csf('issue_basis')]==3 )
					{
						$bookingNo = $planbooking[0][csf('pln_booking_no')];
					} else {
						$bookingNo = $dataArray[0][csf('booking_no')];
					}
					echo $bookingNo;
					?>
				</td>
				<td width="125"><strong>Knitting Source:</strong></td>
				<td width="175px"><? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
			</tr>
			<tr>
				<td><strong>Program No:</strong></td>
				<td width="175px"><? echo $dataArray[0][csf('challan_no')]; ?></td>

				<td><strong>Issue Purpose:</strong></td>
                    <td width="175px"><? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
                    echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
                    ?></td>
                    <td><strong>Issue Date:</strong></td>
                    <td width="175px"><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
            </tr>
            <tr>
            	<td><strong>Issue To:</strong></td>
            	<?
            	if ($dataArray[0][csf('knit_dye_source')] == 3)
            	{
            		$supp_add = $dataArray[0][csf('knit_dye_company')];
            		$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
            		foreach ($nameArray as $result) {
            			$address = "";
						if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($nameArray);
				}

				$loan_party_add = $dataArray[0][csf('loan_party')];
				$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
				foreach ($loanPartyArray as $result) {
					$addressParty = "";
					if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
				}
				unset($loanPartyArray);
				?>
				<td colspan="3">
					<?
					if ($dataArray[0][csf('issue_purpose')] == 3) {
						echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
					} else if ($dataArray[0][csf('issue_purpose')] == 5) {
						echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
					} else {
						if ($dataArray[0][csf('knit_dye_source')] == 1)
							echo $company_library[$dataArray[0][csf('knit_dye_company')]];
						else
							echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
					}
					?>
				</td>
				<td><strong>Location:</strong></td>
				<td><? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>
			</tr>
			<tr>
				<td><strong>Demand No.:</strong></td>
                <td width="175px"><? //echo $dataArray[0][csf('booking_id')];
                ?></td>

                <td><strong>Do No:</strong></td>
                <td width="175px"><? //echo $dataArray[0][csf('remarks')];
                ?></td>
            </tr>
            <tr>
            	<td valign="top"><strong>Remarks :</strong></td>
            	<td colspan="5"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
            </tr>
            <?
            if ($print_with_vat == 1)
            {
            	?>
            	<tr>
                    <!-- <td><strong>VAT Number :</strong></td>
					<td><p>
						<?
					$vat_no = return_field_value("vat_number", "lib_company", "id=" . $company, "vat_number");
					echo $vat_no;
					?></p></td> -->
					<td><strong>Bar Code:</strong></td>
					<td colspan="3" id="barcode_img_id"></td>
				</tr>
				<?
			}
			else
			{
				?>
				<tr>
					<td valign="top">&nbsp;</strong></td>
					<td>&nbsp;</td>
					<td><strong>Bar Code:</strong></td>
					<td colspan="3" id="barcode_img_id"></td>
				</tr>
				<?
			}
			?>
		</table>
		<br>
		<div style="width:100%;">
			<div style="clear:both;">
				<table style="margin-right:-40px; " cellspacing="0" width="1000" border="1" rules="all"
				class="rpt_table">
					<thead bgcolor="#dddddd">
						<th width="20">SL</th>
						<th width="45">Req. No</th>
						<th width="50">Program No</th>
						<th width="50">Lot No</th>
						<th width="65">Y. Type</th>
						<th width="110">Item Details</th>

						<th width="65">Dye. Color</th>
						<th width="60">Supp.</th>
						<th width="60"><b>Issue Qty(kg)</b></th>
						<th width="60">Rtnbl Qty(kg)</th>
						<th width="80">Bag & Cone</th>
						<th width="80">Store</th>
						<th width="100">Buyer & Job</th>
						<th width="120">Order & Style</th>
						<th>Inte. Ref & File</th>
					</thead>
					<?
					$wopi_library = return_library_array("select id, pi_number from com_pi_master_details", "id", "pi_number");

					$cond = "";
					if ($mst_id != "") $cond .= " and c.id='$mst_id'";

					$po_array = array();
					$job_array = array();
					$costing_sql = sql_select("select a.job_no, b.file_no, b.grouping, a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$company");
					foreach ($costing_sql as $row)
					{
						$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
						$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
						$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
						$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
						$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
						$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
						$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
						$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
					}
					unset($costing_sql);

					$job_no_array = array();
					$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst");
					foreach ($jobData as $row)
					{
						$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
						$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
						$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
						$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
					}

					$po_id_req_array = array();
					$is_sales_array = array();
					if ($db_type == 0) {
						$poID = " SELECT c.knit_id, c.requisition_no, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id,c.requisition_no, a.is_sales ";
					} else {
						$poID = "SELECT c.knit_id, c.requisition_no, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.is_sales";
					}
					$poID_sql_result = sql_select($poID);
					foreach ($poID_sql_result as $row)
					{
						$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
						$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
						$program_array[$row[csf('requisition_no')]] = $row[csf('knit_id')];
					}
					unset($poID_sql_result);

					$i = 1;
					if ($db_type == 0)
					{
						$sql_result = sql_select("SELECT a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro
						from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
						where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
						group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
					}
					else
					{
						$sql_result = sql_select("SELECT a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro
						from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
						where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
						group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
					}
					$all_req_no = "";
					$all_prod_id = "";
					$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
					$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
					foreach ($sql_result as $row)
					{
						if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
						if ($row[csf('requisition_no')] != "") {
							if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')];
							else $all_req_no .= ',' . $row[csf('requisition_no')];

							if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')];
							else $all_prod_id .= ',' . $row[csf('po_id')];
						}
						$order_qnty_val = $row[csf('cons_quantity')];
						$order_qnty_val_sum += $order_qnty_val;

						$order_amount_val = $row[csf('order_amount')];
						$order_amount_val_sum += $order_amount_val;

						$no_of_bags_val = $row[csf('no_of_bags')];
						$no_of_bags_val_sum += $no_of_bags_val;

						$po_id = explode(",", $row[csf('po_id')]);
						$po_no = "";
						$style_ref = "";
						$job_no = "";
						$buyer = "";
							//$data=explode('*',$data);
						$productdtls = $row[csf('product_name_details')];
						$productArr = explode(' ', $productdtls);

						$proddtls = "";
						if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '') {
							$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
						} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '') {
							$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
						} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '') {
							$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
						} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '') {
							$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
						} else if ($productArr[0] != '' && $productArr[1] != '') {
							$proddtls = $productArr[0] . ', ' . $productArr[1];
						} else if ($productArr[0] != '') {
							$proddtls = $productArr[0];
						} else {
							$proddtls = "";
						}

						$internal_ref = "";
						$file_no = "";

						if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
						{
							foreach ($po_id as $val)
							{
								if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
								if ($job_no == '') $job_no = $po_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
								if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
							}

							$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
							$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

							$ref_cond = "";
							foreach ($job_ref as $ref) {
								if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
							}

							$file_con = "";
							foreach ($job_file as $file) {
								if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
							}

							$buyer_job = "";
							if ($row[csf('issue_basis')] == 1)
							{
								if ($dataArray[0][csf('issue_purpose')] == 8) {
									$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
								} else {
									$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
									if ($row[csf('buyer_job_no')] != "") {
										$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
									}
								}
							}
							else if ($row[csf('issue_basis')] == 2)
							{
								$buyer_job = "";
							}
						}
						else if ($row[csf('issue_basis')] == 3)
						{
							$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
								//print_r($ex_data);

							if ($is_sales_array[$row[csf('requisition_no')]] == 1)
							{
								$buyer_job = "";
								foreach (array_unique($po_id) as $val)
								{
									if ($po_no == "") $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
									if ($style_ref == "") $style_ref = $job_no_array[$val]['style_ref'];

									if ($buyer_job == "") {
										if ($job_no_array[$val]['within_group'] == 1) {
											$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
										} else {
											$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
										}
									}

									if ($job_no_array[$val]['within_group'] != 1) {
										$ref_cond = "";
									}

								}
							}
							else
							{
								foreach ($po_id as $val)
								{
									if ($po_no == "") $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
									if ($job_no == "") $job_no = $po_array[$val]['job_no'];
									if ($style_ref == "") $style_ref = $po_array[$val]['style_ref'];
									if ($buyer == "") $buyer_name = $po_array[$val]['buyer_name'];

									if ($internal_ref == "") $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
									if ($file_no == "") $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
								}

								$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
								$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

								$ref_cond = "";
								foreach ($job_ref as $ref) {
									if ($ref_cond == "") $ref_cond = $ref; else $ref_cond .= ", " . $ref;
								}

								$file_con = "";
								foreach ($job_file as $file) {
									if ($file_con == "") $file_cond = $file; else $file_cond .= ", " . $file;
								}

								if ($job_no != "") {
									$buyer_job = $buyer_arr[$buyer_name] . ' & ' . $job_no;
								} else {
									$buyer_job = $buyer_arr[$buyer_name];
								}
							}
						}
						else
						{
							foreach (array_unique($po_id) as $val)
							{
								if ($po_no == "") $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
								if ($style_ref == "") $style_ref = $job_no_array[$val]['style_ref'];
								if ($buyer_job == "") {
									if ($job_no_array[$val]['within_group'] == 1) {
										$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
									} else {
										$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
									}
								}
							}
						}

						$no_bag_cone = "";
						$wt_bag_cone = "";
						if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

						if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
						?>
						<tbody>
							<tr bgcolor="<? echo $bgcolor; ?>">
								<td width="20"><? echo $i; ?></td>
								<td width="45">
									<div style="word-wrap:break-word; width:45px"><? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?></div>
								</td>
								<td width="50">
									<?  echo $program_array[$row[csf('requisition_no')]]; ?>
								</td>
								<td width="50">
									<div style="word-wrap:break-word; width:50px; font-size:18px;"><b><? echo $row[csf('lot')]; ?></b></div>
								</td>

								<td width="65">
									<div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></div>
								</td>
								<td width="110">
									<div style="word-wrap:break-word; width:110px">
										<?
										echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
										?>
									</div>
								</td>

								<td width="65">
									<div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>&nbsp;</div>
								</td>

								<td width="60">
									<div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></div>
								</td>

								<td align="right"
								width="60" style="font-size:18px;"><b><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></b></td>
								<td align="right"
								width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
								<td width="80">
									<div style="word-wrap:break-word; width:80px"><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
								&nbsp;</div></td>
								<td width="80">
									<div style="word-wrap:break-word; width:80px"><? echo $store_arr[$row[csf('store_id')]]; ?></div>
								</td>
								<td width="100">
									<div style="word-wrap:break-word; width:100px"><? echo $buyer_job; ?></div>
								</td>
								<td width="120">
									<div style="word-wrap:break-word; width:120px"><? echo $po_no;
									if ($style_ref != "") echo ' & ' . $style_ref; else echo '&nbsp;'; ?></div>
								</td>
								<td>
									<div style="word-wrap:break-word; width:80px"><? echo ltrim($ref_cond, ", ");
									if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?></div>
								</td>
							</tr>
						</tbody>
						<?
						$uom_unit = "Kg";
						$uom_gm = "Grams";
						$tot_return_qty += $row[csf('returnable_qnty')];
						$tot_bag += $no_of_bags_val;
						$tot_cone += $row[csf('cone_per_bag')];
						$tot_w_bag += $row[csf('weight_per_bag')];
						$tot_w_cone += $row[csf('weight_per_cone')];
						$req_no = $row[csf('requisition_no')];
						$i++;
					}
					?>
					<tr bgcolor="#CCCCCC" style="font-size:16px">
						<td align="right" colspan="8"><b>Total</b></td>
						<td align="right">
							<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
						</td>
						<td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
						<td><? echo 'N:' . number_format($tot_bag, 2);
						if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
						echo '<br>W:' . number_format($tot_w_bag, 2);
						if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
						<td align="right" colspan="4">&nbsp;</td>
					</tr>
					<tr>
						<td colspan="15" align="left"><b>In
						Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
					</tr>
				</table>
			</div>
			<br>
			<!--=====================================-->
			<?
			if ($show_val_column == 1)
			{
				if ($dataArray[0][csf('issue_basis')] == 3)
				{

					$sql_collarCuff=sql_select("select id, body_part_id, grey_size, finish_size, qty_pcs from ppl_planning_collar_cuff_dtls where status_active=1 and is_deleted=0 and dtls_id in($program_ids) order by id");
					if(count($sql_collarCuff)>0)
					{
						?>
						<table width="500" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
							<thead>
								<tr>
									<th width="50">SL</th>
									<th width="100">Body Part</th>
									<th width="100">Grey Size</th>
									<th width="100">Finish Size</th>
									<th>Quantity Pcs</th>
								</tr>
							</thead>
							<tbody>
								<?
								$i=1; $total_qty_pcs=0;
								foreach($sql_collarCuff as $row)
								{
									if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
									?>
									<tr>
										<td align="center"><p><? echo $i; ?>&nbsp;</p></td>
										<td><p><? echo $body_part[$row[csf('body_part_id')]]; ?>&nbsp;</p></td>
										<td><p><? echo $row[csf('grey_size')]; ?>&nbsp;</p></td>
										<td><p><? echo $row[csf('finish_size')]; ?>&nbsp;</p></td>
										<td align="right"><p><? echo number_format($row[csf('qty_pcs')],0); $total_qty_pcs+=$row[csf('qty_pcs')]; ?>&nbsp;&nbsp;</p></td>
									</tr>
									<?
									$i++;
								}
								?>
							</tbody>
							<tfoot>
								<tr>
									<th></th>
									<th></th>
									<th></th>
									<th align="right">Total</th>
									<th align="right"><? echo number_format($total_qty_pcs,0); ?>&nbsp;</th>
								</tr>
							</tfoot>
						</table>
						<br>
						<?
					}

					$sql_strip = "select a.color_number_id, a.stripe_color, a.measurement, a.uom, b.dtls_id as program_id, b.no_of_feeder as no_of_feeder, c.body_part_id from wo_pre_stripe_color a, ppl_planning_feeder_dtls b, wo_pre_cost_fabric_cost_dtls c where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.color_number_id=b.color_id and a.stripe_color=b.stripe_color_id and b.dtls_id in($program_ids) and b.no_of_feeder>0 and a.status_active=1 and a.is_deleted=0";
					$result_stripe = sql_select($sql_strip);
					$strip_dtls_arr=array();
					foreach ($result_stripe as $row)
					{
						$strip_dtls_arr[$row[csf('program_id')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['no_of_feeder']=$row[csf('no_of_feeder')];
						$strip_dtls_arr[$row[csf('program_id')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['measurement']=$row[csf('measurement')];
						$strip_dtls_arr[$row[csf('program_id')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['uom']=$row[csf('uom')];
					}

					$body_row_arr=array();
					foreach($strip_dtls_arr as $program => $program_val)
	                {
						$body_row_span=0;
						foreach($program_val as $body_id=>$body_part_val)
						{
							$color_row_span=0;
							foreach($body_part_val as $gmt_color => $color_val)
							{
								foreach($color_val as $strip_color => $row)
								{
									$body_row_span++;
									$color_row_span++;
								}
								$body_row_arr[$program] = $body_row_span;
								$color_row_arr[$program][$body_id] = $color_row_span;
							}
						}
					}

					if (count($result_stripe) > 0)
					{
						?>
						<table cellspacing="0" cellpadding="0" border="1" rules="all" width="600" class="rpt_table" >
							<thead>
								<tr>
									<th colspan="8">Stripe Measurement</th>
								</tr>
								<tr>
									<th width="30">SL</th>
									<th width="80">Prog. no</th>
									<th width="80">Body Part</th>
									<th width="100">Color</th>
									<th width="100">Stripe Color</th>
									<th width="100">Measurement</th>
									<th width="50">UOM</th>
									<th>No Of Feeder</th>
								</tr>
							</thead>
							<?
							$i = 1;
							$tot_feeder = 0;
							foreach($strip_dtls_arr as $program => $program_val)
			                {
								$p=0;
								foreach($program_val as $body_id=>$body_part_val)
								{
									$b=0;
									foreach($body_part_val as $gmt_color => $color_val)
									{
										foreach($color_val as $strip_color => $row)
										{
											if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
											$tot_feeder += $row[('no_of_feeder')];
											$body_row  = $body_row_arr[$program];
											$color_row = $color_row_arr[$program][$body_id];
											?>
											<tr valign="middle" bgcolor="<? echo $bgcolor; ?>" id="search<? echo $i; ?>">
												<td width="30" align="center"><? echo $i; ?></td>
												<td width="80" align="center"><? echo $program; ?></td>
												<?
												if($p==0)
												{
													?>
													<td width="80" rowspan="<? echo $body_row;?>" align="center"><? echo $body_part[$body_id]; ?></td>
													<?
												}
												if($p==0)
												{
													?>
													<td width="100" rowspan="<? echo $color_row;?>"><p><? echo $color_name_arr[$gmt_color]; ?></p></td>
													<?
												}
												?>
												<td width="100"><p><? echo $color_name_arr[$strip_color]; ?></p></td>
												<td width="100" align="center"><? echo $row[('measurement')]; ?></td>
												<td width="50" align="center"><p><? echo $unit_of_measurement[$row[('uom')]]; ?></p></td>
												<td align="right" style="padding-right:10px"><? echo $row[('no_of_feeder')]; ?>&nbsp;</td>
											</tr>
											<?
											$tot_masurement += $row[('measurement')];
											$i++;$p++;$b++;
										}
									}
								}
							}
							?>
							<tfoot>
								<th colspan="5">Total</th>
								<th>&nbsp;</th>
								<th>&nbsp;</th>
								<th style="padding-right:10px"><? echo $tot_feeder; ?>&nbsp;</th>
							</tfoot>
							<?
						}
						?>
					</table>
					<br>
                    <?
                    if ($mst_id != 1)
                    {
                    	$z = 1;
                    	$k = 1;
            			$colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

        				$booking_al = "";
                    	foreach ($colorArray as $book) {
                    		if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];
                    	}

                    	$booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
                    	$booking_count = count(array_unique(explode(',', $booking_no)));

                    	if ($dataArray[0][csf('issue_purpose')] == 2) {
                    		$booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
                    	} else {
                    		$booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
                    	}

                    	$booking_job_no = $booking_job[0][csf('job_no')];
                    	unset($booking_job);

                    	if ($db_type == 0) $poNoCond = "group_concat(id)";
                    	else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";

						$sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

						$job_po = $sql_returnJob[0][csf('po_break_down_id')];
						unset($sql_returnJob);

						$returnJob = '';
						$returnPo = '';
						if ($db_type == 0)
						{
							$booking_cond = "group_concat(a.booking_no)";
							$wo_cond = "group_concat(a.ydw_no)";
							$reqs_no = "group_concat(b.requisition_no)";
						}
						else if ($db_type == 2)
						{
							$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
							$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
							$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
						}

						if ($dataArray[0][csf('issue_purpose')] == 8)
						{
							$sql_returnJob = sql_select("select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
						}
						else if ($dataArray[0][csf('issue_purpose')] == 2)
						{
							$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

							if ($db_type == 0) $poNoCond = "group_concat(id)";
							else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
							$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
						}
						else
						{
							$sql_returnJob = sql_select("select a.job_no, a.booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' and a.booking_no in($booking_no) group by a.job_no,a.booking_no");
						}

						$returnJob = $sql_returnJob[0][csf('job_no')];
										//$returnPo=$sql_po[0][csf('po_break_down_id')];
						$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
						$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
						$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
						unset($sql_returnJob);
						?>
						<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
						cellspacing="0" class="rpt_table">
							<thead>
								<tr>
									<th colspan="6" align="center">Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking
									Job Deatils]</p></th>
								</tr>
								<tr>
									<th>Buyer</th>
									<th>Job</th>
									<th>Req. Qty</th>
									<th>Cuml. Issue Qty</th>
									<th>Balance Qty</th>
									<th>Remarks</th>
								</tr>
							</thead>
							<?
							$all_requ_no = "";
							if ($dataArray[0][csf('issue_purpose')] != 8)
							{
								$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");

								//$all_requ_no="'".$all_booking_sql[0][csf('requisition_no')]."'";
								$all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
							}
							if ($dataArray[0][csf('issue_purpose')] == 8)
							{
								$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");    //
								$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
							}
							else if ($dataArray[0][csf('issue_purpose')] == 2)
							{
								if ($all_requ_no != "" || $all_requ_no != 0) {
									$req_cond = "or a.requisition_no in ($all_requ_no)";
									$reqRet_cond = "or b.booking_no in ($all_requ_no)";
								} else {
									$req_cond = "or a.requisition_no in (0)";
									$reqRet_cond = "or b.booking_no in (0)";
								}

								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
							}
							else
							{
								if ($all_requ_no != "" || $all_requ_no != 0) {
									$req_cond = "or a.requisition_no in ($all_requ_no)";
									$reqRet_cond = "or b.booking_no in ($all_requ_no)";
								} else {
									$req_cond = "or a.requisition_no in (0)";
									$reqRet_cond = "or b.booking_no in (0)";
								}
								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");


								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
							}
							$cumulative_qty = 0;
							if ($booking_count == 1)
							{
								?>
								<tbody>
									<tr>
										<td align="center">
											<? echo $buyer_arr[$job_array[$booking_job_no]['buyer']]; ?>
										</td>
										<td align="center">
											<? echo $job_array[$booking_job_no]['job']; ?>
										</td>
										<td align="center">
											<? echo number_format($returnReqQty, 3); ?>
										</td>
										<td align="center">
											<? $cumulative_qty = $total_issue_qty - $total_return_qty;
											echo number_format($cumulative_qty, 3); ?>
										</td>
										<td align="center">
											<? $balance_qty = $returnReqQty - $cumulative_qty;
											echo number_format($balance_qty, 3); ?>
										</td>
										<td align="center">
											<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
										</td>
									</tr>
								</tbody>
								<?
							}
							?>
						</table>
						<?
					}
				}
				if ($dataArray[0][csf('issue_basis')] == 1)
				{
					?>
					<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
					cellspacing="0" class="rpt_table">
						<thead>
							<tr>
								<th colspan="6" align="center">
									Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
										if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
									} ?> </th>
							</tr>
							<tr>
								<th>Buyer</th>
								<th>Job</th>
								<th>Req. Qty</th>
								<th>Cuml. Qty</th>
								<th>Balance Qty</th>
								<th>Remarks</th>
							</tr>
						</thead>
						<?
						//$booking_job_arr=array();
						$returnJob = '';
						$returnPo = '';
						if ($db_type == 0) {
							$booking_cond = "group_concat( distinct a.booking_no)";
							$wo_cond = "group_concat(a.ydw_no)";
							$reqs_no = "group_concat(b.requisition_no)";
						} else if ($db_type == 2) {
							$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
							$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
							$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
						}

						if ($dataArray[0][csf('issue_purpose')] == 8)
						{
							$sql_returnJob = sql_select("select a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
						}
						else if ($dataArray[0][csf('issue_purpose')] == 2)
						{
							if ($dataArray[0][csf('buyer_job_no')] != '')
							{
								$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

								if ($db_type == 0) $poNoCond = "group_concat(id)";
								else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
								$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
							}
							else
							{
								$sql_returnJob = sql_select("select a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
							}
						}
						else
						{
							$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");//and a.booking_no='".$dataArray[0][csf('booking_no')]."'
						}
						$returnJob = $sql_returnJob[0][csf('job_no')];
						$returnPo = $sql_po[0][csf('po_break_down_id')];
						$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
						$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

						$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
						unset($sql_returnJob);

						$all_requ_no = "";
						if ($dataArray[0][csf('issue_purpose')] != 8)
						{
							$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

							$all_requ_no = $all_booking_sql[0][csf('requisition_no')];
							unset($all_booking_sql);
						}

						if ($dataArray[0][csf('issue_purpose')] == 8)
						{
							$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");    //
							$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
						}
						else if ($dataArray[0][csf('issue_purpose')] == 2)
						{

							if ($dataArray[0][csf('buyer_job_no')] != "")
							{
								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
							}
							else
							{
								$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

								$total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
							}
						}
						else
						{
							if ($dataArray[0][csf('buyer_job_no')] != "")
							{
								if ($all_requ_no != "" || $all_requ_no != 0) {
									$req_cond = "or a.requisition_no in ($all_requ_no)";
									$reqRet_cond = "or b.booking_id in ($all_requ_no)";
								} else {
									$req_cond = "";//or a.requisition_no in (0)
									$reqRet_cond = "";//or b.booking_no in (0)
								}

								$total_issue_qty = 0;

								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");

								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");


							}
						}
						?>
						<tbody>
							<tr>
								<td align="center">
									<?
										if ($dataArray[0][csf('issue_purpose')] == 8) echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
										else echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
									?>
								</td>
								<td align="center">
									<? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
								</td>
								<td align="center" style="font-size:18px">
									<b><? echo number_format($returnReqQty, 3); ?></b>
								</td>
								<td align="center" style="font-size:18px">
									<b><? $cumulative_qty = 0;
									$cumulative_qty = $total_issue_qty - $total_return_qty;
									echo number_format($cumulative_qty, 3); ?></b>
								</td>
								<td align="center" style="font-size:18px">
									<b><? $balance_qty = $returnReqQty - $cumulative_qty;
									echo number_format($balance_qty, 3); ?></b>
								</td>
								<td align="center">
									<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
								</td>
							</tr>
						</tbody>
					</table>
					<?
				}
			}
			?>
			<br>
			<? echo signature_table(49, $company, "1030px"); ?>
		</div>
	</div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		function generateBarcode(valuess)
		{
            var value = valuess;//$("#barcodeValue").val();
            var btype = 'code39';//$("input[name=btype]:checked").val();
            var renderer = 'bmp';// $("input[name=renderer]:checked").val();
            var settings = {
            	output: renderer,
            	bgColor: '#FFFFFF',
            	color: '#000000',
            	barWidth: 1,
            	barHeight: 30,
            	moduleSize: 5,
            	posX: 10,
            	posY: 20,
            	addQuietZone: 1
            };
            $("#barcode_img_id").html('11');
            value = {code: value, rect: false};
            $("#barcode_img_id").show().barcode(value, btype, settings);
        }
        generateBarcode('<? echo $system_no; ?>');
    </script>
    <?
    exit();
}

//for norban
if ($action == "yarn_issue_print20")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print-20", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$company   = $data[0];
	$system_no = $data[1];
	$report_title = $data[2];
	$booking_id = $data[3];
	$is_approved = $data[4];
	$mst_id     = $data[5];
	$show_val_column = $data[6];
	$print_with_vat = $data[7];
	$location  = $data[8];
	$store_id = $data[9];
	$no_copy = $data[10];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$company_arr = return_library_array("select id, company_short_name from lib_company", "id", "company_short_name");
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$department_arr = return_library_array("select id, department_name from lib_department", "id", "department_name");

	//for buyer
	$sqlBuyer = sql_select("select id as ID, buyer_name as BUYER_NAME, short_name as SHORT_NAME from lib_buyer");
	foreach($sqlBuyer as $row)
	{
		$buyer_arr[$row['ID']] = $row['BUYER_NAME'];
		$buyer_dtls_arr[$row['ID']] = $row['BUYER_NAME'];
	}
	unset($sqlBuyer);

	//for supplier
	$sqlSupplier = sql_select("select id as ID, supplier_name as SUPPLIER_NAME, short_name as SHORT_NAME from lib_supplier");
	foreach($sqlSupplier as $row)
	{
		$supplier_arr[$row['ID']] = $row['SHORT_NAME'];
		$supplier_dtls_arr[$row['ID']] = $row['SUPPLIER_NAME'];
	}
	unset($sqlSupplier);

	//for gate pass
	$sql_get_pass = "SELECT a.ID, a.SYS_NUMBER, a.BASIS, a.COMPANY_ID, a.GET_PASS_NO, a.DEPARTMENT_ID, a.ATTENTION, a.SENT_BY, a.WITHIN_GROUP, a.SENT_TO, a.CHALLAN_NO, a.OUT_DATE, a.TIME_HOUR, a.TIME_MINUTE, a.RETURNABLE, a.DELIVERY_AS, a.EST_RETURN_DATE, a.INSERTED_BY, a.CARRIED_BY, a.LOCATION_ID, a.COM_LOCATION_ID, a.VHICLE_NUMBER, a.LOCATION_NAME, a.REMARKS, a.DO_NO, a.MOBILE_NO, a.ISSUE_ID, a.RETURNABLE_GATE_PASS_REFF, a.DELIVERY_COMPANY, a.ISSUE_PURPOSE,a.SECURITY_LOCK_NO,a.DRIVER_NAME,a.DRIVER_LICENSE_NO, b.QUANTITY, b.NO_OF_BAGS FROM inv_gate_pass_mst a, INV_GATE_PASS_DTLS b WHERE a.id = b.mst_id AND a.company_id = ".$company." AND a.basis = 2 AND a.STATUS_ACTIVE = 1 AND a.IS_DELETED = 0 AND a.challan_no LIKE '".$system_no."%'";
	//echo $sql_get_pass;
	$sql_get_pass_rslt = sql_select($sql_get_pass);
	$is_gate_pass = 0;
	$is_gate_out = 0;
	$gate_pass_id = '';
	$gatePassDataArr = array();
	foreach($sql_get_pass_rslt as $row)
	{
		$exp = explode(',', $row['CHALLAN_NO']);
		foreach($exp as $key=>$val)
		{
			if($val == $system_no)
			{
				$is_gate_pass = 1;
				$gate_pass_id = $row['ID'];

				$row['OUT_DATE'] = ($row['OUT_DATE']!=''?date('d-m-Y', strtotime($row['OUT_DATE'])):'');
				$row['EST_RETURN_DATE'] = ($row['EST_RETURN_DATE']!=''?date('d-m-Y', strtotime($row['EST_RETURN_DATE'])):'');
				$row['EST_RETURN_DATE'] = ($row['EST_RETURN_DATE']!=''?date('d-m-Y', strtotime($row['EST_RETURN_DATE'])):'');

				if($row['WITHIN_GROUP'] == 1)
				{
					//$row['SENT_TO'] = ($row['BASIS']==50?$buyer_dtls_arr[$row['SENT_TO']]:$supplier_dtls_arr[$row['SENT_TO']]);
					$row['SENT_TO'] = $company_library[$row['SENT_TO']];
					$row['LOCATION_NAME'] = $location_arr[$row['LOCATION_ID']];
				}

				//for gate pass info
				$gatePassDataArr[$row['CHALLAN_NO']]['gate_pass_id'] = $row['SYS_NUMBER'];
				$gatePassDataArr[$row['CHALLAN_NO']]['from_company'] = $company_library[$row['COMPANY_ID']];
				$gatePassDataArr[$row['CHALLAN_NO']]['from_location'] =$location_arr[ $row['COM_LOCATION_ID']];
				$gatePassDataArr[$row['CHALLAN_NO']]['gate_pass_date'] = date('d-m-Y', strtotime($row['OUT_DATE']));
				$gatePassDataArr[$row['CHALLAN_NO']]['returnable'] = $yes_no[$row['RETURNABLE']];
				$gatePassDataArr[$row['CHALLAN_NO']]['est_return_date'] = $row['EST_RETURN_DATE'];

				$gatePassDataArr[$row['CHALLAN_NO']]['to_company'] = $row['SENT_TO'];
				$gatePassDataArr[$row['CHALLAN_NO']]['to_location'] = $row['LOCATION_NAME'];
				$gatePassDataArr[$row['CHALLAN_NO']]['delivery_kg'] += $row['QUANTITY'];
				$gatePassDataArr[$row['CHALLAN_NO']]['delivery_bag'] += $row['NO_OF_BAGS'];

				$gatePassDataArr[$row['CHALLAN_NO']]['department'] = $department_arr[$row['DEPARTMENT_ID']];
				$gatePassDataArr[$row['CHALLAN_NO']]['attention'] = $row['ATTENTION'];
				$gatePassDataArr[$row['CHALLAN_NO']]['issue_purpose'] = $row['ISSUE_PURPOSE'];
				$gatePassDataArr[$row['CHALLAN_NO']]['remarks'] = $row['REMARKS'];
				$gatePassDataArr[$row['CHALLAN_NO']]['carried_by'] = $row['CARRIED_BY'];
				$gatePassDataArr[$row['CHALLAN_NO']]['vhicle_number'] = $row['VHICLE_NUMBER'];
				$gatePassDataArr[$row['CHALLAN_NO']]['mobile_no'] = $row['MOBILE_NO'];
				$gatePassDataArr[$row['CHALLAN_NO']]['security_lock_no'] = $row['SECURITY_LOCK_NO'];
				$gatePassDataArr[$row['CHALLAN_NO']]['driver_name'] = $row['DRIVER_NAME'];
				$gatePassDataArr[$row['CHALLAN_NO']]['driver_license_no'] = $row['DRIVER_LICENSE_NO'];
			}
		}
	}

	//for gate out
	if($gate_pass_id != '')
	{
		$sql_gate_out="SELECT OUT_DATE, OUT_TIME FROM INV_GATE_OUT_SCAN WHERE STATUS_ACTIVE = 1 AND IS_DELETED = 0 AND INV_GATE_PASS_MST_ID='".$gate_pass_id."'";
		$sql_gate_out_rslt = sql_select($sql_gate_out);
		if(!empty($sql_gate_out_rslt))
		{
			foreach($sql_gate_out_rslt as $row)
			{
				$is_gate_out = 1;
				$gatePassDataArr[$system_no]['out_date'] = date('d-m-Y', strtotime($row['OUT_DATE']));
				$gatePassDataArr[$system_no]['out_time'] = $row['OUT_TIME'];
			}
		}
	}

	// for booking no
	/*
	$sql_booking = "select a.id,b.job_no,b.booking_no from inv_issue_master a,wo_booking_mst b where a.buyer_job_no=b.job_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.id='".$data[5]."'";
	//echo $sql_booking;
	//die;
	$sql_booking_data = sql_select($sql_booking);
	$BookingNoArr = array();
	foreach($sql_booking_data as $row)
	{
		$BookingNoArr[$row[csf('job_no')]]['booking_no'] = $row[csf('booking_no')];
	}
	//var_dump($BookingNoArr);
	*/

	/*$sql_booking1 = "select job_no, booking_no from wo_booking_mst where status_active=1 and is_deleted=0 and company_id = ".$company;
	//echo $sql_booking1;
	//die;
	$sql_booking_data1 = sql_select($sql_booking1);
	$BookingNoArr1 = array();
	foreach($sql_booking_data1 as $row)
	{
		$BookingNoArr1[$row[csf('job_no')]]['booking_no'] = $row[csf('booking_no')];
	}*/
	//var_dump($BookingNoArr1);

	// for Yarn Dyeing Work Order Without Order booking no
	$sql_ydw_booking = "select a.id AS ID, a.booking_no AS YDW_YSW_NO, c.fab_booking_no AS YDW_YSW_BOOKING_NO from inv_issue_master a, wo_yarn_dyeing_mst b, wo_yarn_dyeing_dtls c where a.booking_no=b.ydw_no and b.id = c.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.id='".$data[5]."'";
	//echo $sql_ydw_booking; die;
	$sql_ydw_booking_data = sql_select($sql_ydw_booking);
	$YwdBookingNoArr = array();
	foreach($sql_ydw_booking_data as $row)
	{
		$YwdBookingNoArr[$row['YDW_YSW_NO']]['ydwbooking'] = $row['YDW_YSW_BOOKING_NO'];
	}

	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks, attention from inv_issue_master where id='".$data[5]."'";
	//echo $sql;die;
	$dataArray = sql_select($sql);
	$reqBookingNoArr = array();
	foreach($dataArray as $row)
	{
		$issue_no = $row[csf('issue_number')];
		$issue_date = $row[csf('issue_date')];
		$knit_source = $row[csf('knit_dye_source')];
		$issue_purpose = $row[csf('issue_purpose')];
		$attention = $row[csf('attention')];
		$remarks = $row[csf('remarks')];
		$inhouse_location = $row[csf('location_id')];

		//for issue to
		$issue_to = '';
		if ($row[csf('issue_purpose')] == 3)
		{
			$issue_to = $buyer_dtls_arr[$row[csf('buyer_id')]];
		}
		else if ($row[csf('issue_purpose')] == 5)
		{
			$issue_to = $supplier_dtls_arr[$row[csf('loan_party')]] ;
		}
		else
		{
			if ($row[csf('knit_dye_source')] == 1)
				$issue_to = $company_library[$row[csf('knit_dye_company')]];
			else
				$issue_to = $supplier_dtls_arr[$row[csf('knit_dye_company')]];
		}

		//for address
		$address = "";
		$addressParty = "";
		if ($row[csf('knit_dye_source')] == 3)
		{
			$nameArray = sql_select("select address_1 ,web_site, email, country_id from lib_supplier where id=".$row[csf('knit_dye_company')]."");
			foreach ($nameArray as $result)
			{
				if ($result != "")
					$address = $result[csf('address_1')];
			}
			unset($nameArray);
		}

		//for party address
		$loanPartyArray = sql_select("select address_1, web_site, email, country_id from lib_supplier where id=".$row[csf('loan_party')]."");
		foreach ($loanPartyArray as $result)
		{
			if ($result != "")
				$addressParty = $result[csf('address_1')];;
		}
		unset($loanPartyArray);

		$addressPrint = '';
		if ($row[csf('issue_purpose')] == 3)
		{
			$addressPrint = $buyer_arr[$row[csf('buyer_id')]];
		}
		else if ($row[csf('issue_purpose')] == 5)
		{
			$addressPrint = $addressParty;
		}
		else
		{
			if ($row[csf('knit_dye_source')] == 1)
			{
				$addressPrint = $company_library[$row[csf('knit_dye_company')]];
			}
			else
			{
				$addressPrint = $address;
			}
		}

		/*
		| if knitting source is out-bound subcontract then
		| address will show
		*/
		if ($row[csf('knit_dye_source')] != 3)
		{
			$addressPrint = '';
		}

		//for program no
		if( $row[csf('issue_basis')] == 3 )
		{
			$planbooking = sql_select("select b.requisition_no, e.booking_no as pln_booking_no, d.id as program_id, d.is_sales from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no = c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='".$mst_id."' ");
			foreach ($planbooking as $value)
			{
				$program_id .= $value[csf('program_id')].',';
				$reqBookingNoArr[$value[csf('requisition_no')]]['booking_no'] = $value[csf('pln_booking_no')];
				$reqBookingNoArr[$value[csf('requisition_no')]]['is_sample'] = $value[csf('is_sales')];
				$sampleBookingArr[$value[csf('pln_booking_no')]] = $value[csf('pln_booking_no')];
			}
			$program_ids = implode(",", array_unique(explode(",", chop($program_id,','))));
		}
		//echo $program_ids;
	}
	//echo "<pre>";
	//print_r($reqBookingNoArr);

	//for sample style ref. no
	$sql_sample = sql_select("SELECT a.BOOKING_NO, b.BUYER_NAME, b.STYLE_REF_NO,b.SUSTAINABILITY_STD_ID,b.FABRIC_MATERIAL_ID FROM WO_NON_ORD_SAMP_BOOKING_DTLS a, SAMPLE_DEVELOPMENT_MST b WHERE a.STYLE_ID=b.ID".where_con_using_array($sampleBookingArr, '1', 'a.BOOKING_NO'));
	$dataSampleArr = array();
	foreach($sql_sample as $row)
	{
		$dataSampleArr[$row['BOOKING_NO']]['buyer_id'] = $row['BUYER_NAME'];
		$dataSampleArr[$row['BOOKING_NO']]['style_ref_no'] = $row['STYLE_REF_NO'];
		$dataSampleArr[$row['BOOKING_NO']]['sustainability_std_id'] = $row['SUSTAINABILITY_STD_ID'];
		$dataSampleArr[$row['BOOKING_NO']]['fabric_material_id'] = $row['FABRIC_MATERIAL_ID'];
	}
	unset($sql_sample);

	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
	?>
	<style type="text/css">
		table tr td {
			font-size: 16px;
		}
		.rpt_table thead th{
			font-size: 16px;
		}
		.rpt_table tfoot th{
			font-size: 16px;
		}
	</style>
    <?php
	$data_array = sql_select("select image_location  from common_photo_library where master_tble_id='".$data[0]."' and form_name='company_details' and is_deleted=0 and file_type=1");
	$cond = "";
	if ($mst_id != "")
		$cond .= " and c.id='".$mst_id."'";

	$i = 1;
	if ($db_type == 0)
	{
		$sql_result = sql_select("SELECT a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, a.supplier_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, b.remarks
		from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
		where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
		group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, a.is_within_group, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, b.remarks");
	}
	else
	{
		$sql_result = sql_select("SELECT a.id, a.lot, a.color, a.yarn_type, a.product_name_details, a.yarn_count_id, a.yarn_comp_percent1st, a.yarn_comp_type1st, a.detarmination_id, a.supplier_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, b.remarks
		from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
		where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
		group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, a.is_within_group, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, b.remarks");
	}

	$poIdArr = array();
	$reqNoArr = array();
	foreach ($sql_result as $row)
	{
		//for po id
		$expPo = array();
		$expPo = explode(",", $row[csf('po_id')]);
		foreach ($expPo as $key=>$val)
		{
			if($val*1 > 0)
			{
				$poIdArr[$val] = $val;
			}
		}

		//for req no
		$reqNoArr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];
	}
	/*echo "<pre>";
	print_r($poIdArr);
	echo "</pre>";*/

	//for po information
	$po_array = array();
	$job_array = array();
	$costing_sql = sql_select("select a.job_no, b.file_no, b.grouping, a.style_ref_no, a.buyer_name,a.sustainability_standard,a.fab_material, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=".$company.where_con_using_array($poIdArr, '0', 'b.id'));
	// echo "select a.job_no, b.file_no, b.grouping, a.style_ref_no, a.buyer_name,a.sustainability_standard,a.fab_material, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=".$company.where_con_using_array($poIdArr, '0', 'b.id');
	foreach ($costing_sql as $row)
	{
		$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
		$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
		$po_array[$row[csf('id')]]['sustainability'] = $row[csf('sustainability_standard')];
		$po_array[$row[csf('id')]]['fab_material'] = $row[csf('fab_material')];
		$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
		$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
		$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
		$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
		$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
	}
	unset($costing_sql);
	$style_ref_arr = sql_select("SELECT id,
			TO_CHAR (insert_date, 'YYYY')     AS year,
			job_no_prefix_num,
			job_no,
			within_group,
			sales_order_type,
			sales_booking_no,
			booking_date,
			buyer_id,
			style_ref_no,
			location_id,
			customer_buyer
			FROM fabric_sales_order_mst
			WHERE     entry_form = 109
				AND status_active = 1
				AND is_deleted = 0
				AND company_id = $company
				--AND job_no LIKE '%FSOE-23-00918'
			ORDER BY id DESC");
	$job_style_arr = array();
	foreach($style_ref_arr as $row)
	{
		$job_style_arr[$row['JOB_NO']]['STYLE_REF'] = $row['STYLE_REF_NO'];
	}
	// echo "<pre>";
	// print_r($job_style_arr);
	// echo "</pre>";

	//for requisition information
	$po_id_req_array = array();
	$is_sales_array = array();
	if ($db_type == 0)
	{
		$poID = " SELECT c.knit_id, c.requisition_no, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id".where_con_using_array($reqNoArr, '0', 'c.requisition_no')." group by c.knit_id,c.requisition_no, a.is_sales ";
	}
	else
	{
		$poID = "SELECT c.knit_id, c.requisition_no, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id".where_con_using_array($reqNoArr, '0', 'c.requisition_no')." group by c.knit_id, c.requisition_no, a.is_sales";
	}

	$poID_sql_result = sql_select($poID);
	$poIdArr2 = array();
	foreach ($poID_sql_result as $row)
	{
		$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
		$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
		$program_array[$row[csf('requisition_no')]] = $row[csf('knit_id')];

		//for po id
		$expPo = array();
		$expPo = explode(",", $row[csf('poid')]);
		foreach ($expPo as $key=>$val)
		{
			$poIdArr2[$val] = $val;
		}
	}
	unset($poID_sql_result);
	/*echo "<pre>";
	print_r($po_id_req_array);
	echo "</pre>";*/

	//for job information
	$job_no_array = array();
	$jobData = sql_select("select id, job_no, style_ref_no, within_group,buyer_id, CUSTOMER_BUYER as cust_buyer_id from fabric_sales_order_mst where 1=1".where_con_using_array($poIdArr2, '0', 'id'));

	// echo "select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst where 1=1".where_con_using_array($poIdArr2, '0', 'id');
	foreach ($jobData as $row)
	{
		$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
		$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
		$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
		$job_no_array[$row[csf('id')]]['cust_buyer_id'] = $row[csf('cust_buyer_id')];
	}
	unset($jobData);

	// echo "<pre>";
	// print_r($job_no_array);


	$all_req_no = "";
	$all_prod_id = "";
	$order_qnty_val_sum=0;
	$order_amount_val_sum=0;
	$no_of_bags_val_sum=0;
	$tot_return_qty = 0;
	$tot_bag = 0;
	$tot_cone = 0;
	$tot_w_bag = 0;
	$tot_w_cone = 0;
	$z = 0;
	$printDataArr = array();
	$jobNoArr = array();
	foreach ($sql_result as $row)
	{
		//for booking no
		//$row[csf('buyer_job_no')];
		/*$mainbookingNo = '';
		if($row[csf('buyer_job_no')])
		{
			$mainbookingNo = $BookingNoArr[$row[csf('buyer_job_no')]]['booking_no'];
		}
		else
		{
			$mainbookingNo = $YwdBookingNoArr[$row[csf('booking_no')]]['ydwbooking'];

			if ($row[csf('issue_basis')] == 3 && $dataArray[0][csf('issue_purpose')] == 1)
			{
				$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
				foreach ($po_id as $val)
				{
					$mainbookingNo = $BookingNoArr1[$po_array[$val]['job_no']]['booking_no'];
					//$mainbookingNo = $po_array[$val]['job_no'];
				}

				$mainbookingNo = $reqBookingNoArr[$row[csf('requisition_no')]]['booking_no'];
			}
		}*/

		$bookingNo = $row[csf('booking_no')];
		if ($row[csf('requisition_no')] != "")
		{
			if ($all_req_no == '')
				$all_req_no = $row[csf('requisition_no')];
			else
				$all_req_no .= ',' . $row[csf('requisition_no')];

			if ($all_prod_id == '')
				$all_prod_id = $row[csf('po_id')];
			else
				$all_prod_id .= ',' . $row[csf('po_id')];
		}
		$order_qnty_val = $row[csf('cons_quantity')];
		$order_qnty_val_sum += $order_qnty_val;

		$order_amount_val = $row[csf('order_amount')];
		$order_amount_val_sum += $order_amount_val;

		$no_of_bags_val = $row[csf('no_of_bags')];
		$no_of_bags_val_sum += $no_of_bags_val;

		$po_id = explode(",", $row[csf('po_id')]);
		$po_no = "";
		$style_ref = "";
		$job_no = "";
		$buyer = "";
		$sustainability = "";
		$material = "";
		$fab_material=array(1=>"Organic",2=>"BCI");
			//$data=explode('*',$data);
		$productdtls = $row[csf('product_name_details')];
		$productArr = explode(' ', $productdtls);

		$proddtls = "";
		if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
		}
		else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
		}
		else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
		}
		else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
		}
		else if ($productArr[0] != '' && $productArr[1] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1];
		}
		else if ($productArr[0] != '')
		{
			$proddtls = $productArr[0];
		}
		else
		{
			$proddtls = "";
		}

		$internal_ref = "";
		$file_no = "";

		if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
		{
			foreach ($po_id as $val)
			{
				if ($po_no == '')
					$po_no = $po_array[$val]['no'];
				else
					$po_no .= ", " . $po_array[$val]['no'];

				if ($job_no == '')
				{
					$job_no = $po_array[$val]['job_no'];

					if($job_no != '')
					{
						$jobNoArr[$job_no] = $job_no;
					}
				}

				if ($sustainability  == '')
					$sustainability  = $po_array[$val]['sustainability'];

				if ($material   == '')
					$material  = $po_array[$val]['fab_material'];

				if ($style_ref == '')
				{
					if($knit_source==3 && $show_val_column==0 && $dataArray[0][csf('issue_purpose')] != 8)
					{
						$style_ref = 'WHS';
					}
					else
					{
						$style_ref = $po_array[$val]['style_ref'];


					}
					//$style_ref = $po_array[$val]['style_ref'];
				}
				// if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];


				if ($buyer == '')
					$buyer_name = $po_array[$val]['buyer_name'];

				if ($internal_ref == '')
					$internal_ref = $po_array[$val]['grouping'];
				else
					$internal_ref .= "," . $po_array[$val]['grouping'];

				if ($file_no == '')
					$file_no = $po_array[$val]['file_no'];
				else
					$file_no .= "," . $po_array[$val]['file_no'];
			}

			$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
			$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

			$ref_cond = "";
			foreach ($job_ref as $ref) {
				if ($ref_cond == '')
					$ref_cond = $ref;
				else
					$ref_cond .= ", " . $ref;
			}

			$file_con = "";
			foreach ($job_file as $file)
			{
				if ($file_con == '')
					$file_cond = $file;
				else
					$file_cond .= ", " . $file;
			}

			$buyer_job = "";
			if ($row[csf('issue_basis')] == 1)
			{
				if ($dataArray[0][csf('issue_purpose')] == 8 )
				{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS';
						}
						else
						{
							$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
						}

						//$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
				}
				if ($dataArray[0][csf('issue_purpose')] == 2 )
				{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS';
						}
						else
						{
							$buyer_job= $buyer_arr[$row[csf('buyer_id')]]. '::' . $row[csf('buyer_job_no')];
							// $buyer_job = $buyer_arr[$buyer_name];
						}


				}
				else
				{
					$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
					if ($row[csf('buyer_job_no')] != "")
					{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS' . '::' . $row[csf('buyer_job_no')];
						}
						else
						{
							$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['cust_buyer_id']] . '::' . $row[csf('buyer_job_no')];
						}
						//$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . '::' . $row[csf('buyer_job_no')];

						if($buyer_job != '')
						{
							$jobNoArr[$row[csf('buyer_job_no')]] = $row[csf('buyer_job_no')];
						}
					}
					else
					{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS';
						}
						else
						{
							$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
						}
					}
				}

				//for ydw and ysw booking no
				if ($dataArray[0][csf('issue_purpose')] == 2 || $dataArray[0][csf('issue_purpose')] == 7 || $dataArray[0][csf('issue_purpose')] == 12 || $dataArray[0][csf('issue_purpose')] == 15 || $dataArray[0][csf('issue_purpose')] == 38 || $dataArray[0][csf('issue_purpose')] == 46 || $dataArray[0][csf('issue_purpose')] == 50 || $dataArray[0][csf('issue_purpose')] == 51)
				{
					$bookingNo = $YwdBookingNoArr[$row[csf('booking_no')]]['ydwbooking'];
				}

			}


			else if ($row[csf('issue_basis')] == 2)
			{
				$buyer_job = "";
			}
			// $style_ref = $job_style_arr[$buyer_job]['STYLE_REF'];
			$buyer_job_ar = explode("::", $buyer_job);
			$buyer_job_no = $buyer_job_ar[1];
			$buyer_prefix = explode("-", $buyer_job_no);
			// echo $buyer_prefix[1];

			if($buyer_prefix[1] == "FSOE")
			{
				$style_ref = $job_style_arr[$buyer_job_no]['STYLE_REF'];
			}

		}
		else if ($row[csf('issue_basis')] == 3)
		{
			//for booking no
			$bookingNo = $reqBookingNoArr[$row[csf('requisition_no')]]['booking_no'];
			$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
			//print_r($ex_data);

			if ($is_sales_array[$row[csf('requisition_no')]] == 1)
			{
				$buyer_job = "";
				foreach (array_unique($po_id) as $val)
				{
					if ($po_no == "")
						$po_no = $job_no_array[$val]['job_no'];
					else
						$po_no .= ", " . $job_no_array[$val]['job_no'];

					if ($style_ref == "")
						$style_ref = $job_no_array[$val]['style_ref'];

					if ($sustainability  == '')
						$sustainability  = $po_array[$val]['sustainability'];

					if ($material   == '')
						$material  = $po_array[$val]['fab_material'];

					if ($buyer_job == "") {
						if ($job_no_array[$val]['within_group'] == 1)
						{
							$buyer_job = $buyer_arr[$job_no_array[$val]['cust_buyer_id']];
						}
						else
						{
							$buyer_job = $buyer_arr[$job_no_array[$val]['cust_buyer_id']];
						}
					}

					if ($job_no_array[$val]['within_group'] != 1)
					{
						$ref_cond = "";
					}
				}
			}
			else
			{
				foreach ($po_id as $val)
				{
					if ($po_no == "")
						$po_no = $po_array[$val]['no'];
					else
						$po_no .= ", " . $po_array[$val]['no'];

					if ($job_no == "")
					{
						$job_no = $po_array[$val]['job_no'];


						if($job_no != '')
						{
							$jobNoArr[$job_no] = $job_no;
						}
					}

					if ($style_ref == "")
					{
						if($knit_source==3 && $show_val_column==0)
						{
							$style_ref = 'WHS';
						}
						else
						{
							$style_ref = $po_array[$val]['style_ref'];
						}
						//$style_ref = $po_array[$val]['style_ref'];
					}


					if ($sustainability  == '')
						$sustainability  = $po_array[$val]['sustainability'];

					if ($material   == '')
						$material  = $po_array[$val]['fab_material'];

					if ($buyer == "")
						$buyer_name = $po_array[$val]['buyer_name'];

					if ($internal_ref == "")
						$internal_ref = $po_array[$val]['grouping'];
					else
						$internal_ref .= "," . $po_array[$val]['grouping'];

					if ($file_no == "")
						$file_no = $po_array[$val]['file_no'];
					else
						$file_no .= "," . $po_array[$val]['file_no'];
				}

				$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
				$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

				$ref_cond = "";
				foreach ($job_ref as $ref)
				{
					if ($ref_cond == "") $ref_cond = $ref; else $ref_cond .= ", " . $ref;
				}

				$file_con = "";
				foreach ($job_file as $file)
				{
					if ($file_con == "")
						$file_cond = $file;
					else
						$file_cond .= ", " . $file;
				}

				if ($job_no != "")
				{
					if($knit_source==3 && $show_val_column==0)
					{
						$buyer_job = 'WHS' . '::' . $job_no;
					}
					else
					{
						$buyer_job = $buyer_arr[$buyer_name] . '::' . $job_no;
					}

					$jobNoArr[$job_no] = $job_no;
				}
				else
				{
					$buyer_job = $buyer_arr[$buyer_name];
				}
			}

			//for sample
			if($reqBookingNoArr[$row[csf('requisition_no')]]['is_sample'] == 2)
			{
				$buyer_job = $buyer_arr[$dataSampleArr[$bookingNo]['buyer_id']];
				$style_ref = $dataSampleArr[$bookingNo]['style_ref_no'];
				$sustainability = $dataSampleArr[$bookingNo]['sustainability_std_id'];
				$material = $dataSampleArr[$bookingNo]['fabric_material_id'];
			}
		}
		else
		{
			foreach (array_unique($po_id) as $val)
			{
				if ($po_no == "")
					$po_no = $job_no_array[$val]['job_no'];
				else
					$po_no .= ", " . $job_no_array[$val]['job_no'];

				if ($style_ref == "")
					$style_ref = $job_no_array[$val]['style_ref'];


				if ($buyer_job == "")
				{
					if ($job_no_array[$val]['within_group'] == 1)
					{
						$buyer_job = $buyer_arr[$job_no_array[$val]['cust_buyer_id']];
					}
					else
					{
						$buyer_job = $buyer_arr[$job_no_array[$val]['cust_buyer_id']];
					}
				}
			}
		}
		// echo $buyer_job;
		// print_r($po_array);

		$buyer_job_ar = explode("::", $buyer_job);
		$buyer_job_no = $buyer_job_ar[1];
		$buyer_prefix = explode("-", $buyer_job_no);
		// echo $buyer_prefix[1];

		if($buyer_prefix[1] == "FSOE")
		{
			$sales_order = $buyer_job_no;
			// $style_ref = $job_style_arr[$buyer_job_no]['STYLE_REF'];
		}


		$no_bag_cone = "";
		$wt_bag_cone = "";
		if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0)
			$no_bag_cone = 'N:' . $no_of_bags_val;
		else
			$no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

		if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0)
			$wt_bag_cone = 'W:' . $row[csf('weight_per_bag')];
		else
			$wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];

		//for buyer job and style
		$buyer_job_style = $buyer_job.($style_ref != ''?'::'.$style_ref:'');
		$req_no = ($row[csf('requisition_no')] != 0 ? $row[csf('requisition_no')]:'');
		$item_description = $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];

		//for print data
		$z++;
		//$printDataArr[$z]['buyer_job_style'] = $buyer_job.($style_ref != ''?'::'.$style_ref:'').($mainbookingNo != ''?'::'.$mainbookingNo:'').($sustainability*1 != ''?'::'.$sustainability_standard[$sustainability]:'').($material*1 != ''?'::'.$fab_material[$material]:'');


		$printDataArr[$z]['buyer_job_style'] = $buyer_job.($style_ref != ''?'::'.$style_ref:'').($bookingNo != ''?'::'.$bookingNo:'').($sustainability*1 != ''?'::'.$sustainability_standard[$sustainability]:'').($material*1 != ''?'::'.$fab_material[$material]:'');
		$printDataArr[$z]['req_no'] = ($row[csf('requisition_no')] != 0 ? $row[csf('requisition_no')]:$row[csf('booking_no')]);
		$printDataArr[$z]['prog_no'] = $program_array[$row[csf('requisition_no')]];
		$printDataArr[$z]['lot'] = $row[csf('lot')];
		$printDataArr[$z]['yarn_type'] = $row[csf('yarn_type')];
		$printDataArr[$z]['item_description'] = $item_description;
		$printDataArr[$z]['dyeing_color_id'] = $row[csf('dyeing_color_id')];
		$printDataArr[$z]['color_id'] = $row[csf('color')];

		//for supplier
		//$printDataArr[$z]['supplier_id'] = $row[csf('supplier_id')];
		if($row[csf('is_within_group')] == 1)
		{
			$supplier_name = $company_arr[$row[csf('supplier_id')]];
		}
		else
		{
			$supplier_name = $supplier_arr[$row[csf('supplier_id')]];
		}
		$printDataArr[$z]['supplier_id'] = $supplier_name;

		$printDataArr[$z]['cons_quantity'] = $row[csf('cons_quantity')];
		$printDataArr[$z]['returnable_qnty'] = $row[csf('returnable_qnty')];
		$printDataArr[$z]['no_bag_cone'] = $no_bag_cone;
		$printDataArr[$z]['wt_bag_cone'] = $wt_bag_cone;
		$printDataArr[$z]['store_id'] = $row[csf('store_id')];
		$printDataArr[$z]['po_no'] = $po_no;
		$printDataArr[$z]['remarks'] = $row[csf('remarks')];

		$printDataArr[$z]['no_of_bags_val'] = $no_of_bags_val;
		$printDataArr[$z]['cone_per_bag'] = $row[csf('cone_per_bag')];
		$printDataArr[$z]['weight_per_bag'] = $row[csf('weight_per_bag')];
		$printDataArr[$z]['weight_per_cone'] = $row[csf('weight_per_cone')];
		$printDataArr[$z]['sales_order'] = $sales_order;
	}
	// echo "<pre>";
	// print_r($printDataArr);

	$noOfCopy = "";
	for ($x = 1; $x <= $no_copy; $x++)
	{
		if($x==1)
		{
			$sup = 'st';
		}
		else if($x==2)
		{
			$sup = 'nd';
		}
		else if($x==3)
		{
			$sup = 'rd';
		}
		else
		{
			$sup = 'th';
		}

		$noOfCopy ="<span style='font-size:x-large;font-weight:bold'>".$x."<sup>".$sup."</sup> Copy</span>";
		?>


		<div style="width:1020px;">
			<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row)
						{
							if ($data[5] != 1)
							{
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50' align="middle"/>
								<?
							}
							else
							{
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50' align="middle"/>
								<?
							}
						}
						?>
					</td>
                    <td align="center" style="font-size:30px" colspan="6"><strong><? echo $com_dtls[0]."<br><span style=\"font-size:14px;\">".$com_dtls[1]."</span>"; ?></strong></td>
					<td width="110" align="right"><?php echo $noOfCopy.($is_gate_pass==1?"<br><span style=\"color:#F00;font-weight:bold;\">Gate Pass Done</span>":'').($is_gate_out==1?"<br><span style=\"color:#F00;font-weight:bold;\">Gate Out Done</span>":''); ?></td>
				</tr>
				<tr>
					<td colspan="6" align="center" height="50" valign="middle" style="font-size:25px">
						<strong><u>Yarn Delivery Challan</u></strong>
						<?php
						if ($data[4] == 1)
						{

							?>
							<span style="color:#0F0; font-weight:bold;">[Approved]</span>
							<?php
						}
						?>
					</td>
				</tr>
			</table>
			<br>
            <table style="margin-right:-40px;" cellspacing="0" width="1020" border="1" rules="all" class="rpt_table">
				<tr>
					<td width="70"><strong>Issue No:</strong></td>
					<td width="260px"><? echo $issue_no; ?></td>
					<td width="80"><strong>Issue Date:</strong></td>
					<td width="260px"><? echo change_date_format($issue_date); ?></td>
					<td width="120"><strong>Knitting Source:</strong></td>
					<td><? echo $knitting_source[$knit_source]; ?></td>
				</tr>
				<tr>
					<td><strong>Issue To:</strong></td>
					<td><? echo $issue_to; ?></td>
					<td><strong>Address:</strong></td>
					<td><? echo $addressPrint; ?></td>
					<td><strong>Issue Purpose:</strong></td>
					<td><? echo $yarn_issue_purpose[$issue_purpose]; ?></td>
				</tr>
				<tr>
					<td><strong>Location:</strong></td>
					<td><? echo $location_arr[$inhouse_location]; ?></td>
					<td><strong>Attention:</strong></td>
					<td><? echo $attention; ?></td>
					<td><strong>Remarks:</strong></td>
					<td><? echo $remarks; ?></td>
				</tr>
				<tr>
					<td style="border-left:hidden;border-right:hidden;border-bottom:hidden;"></td>
					<td style="border-left:hidden;border-right:hidden;border-bottom:hidden;"></td>
					<td align="center" colspan="6" id="barcode_img_id_<?php echo $x; ?>" height="50" valign="middle" style="border-left:hidden;border-right:hidden;border-bottom:hidden;"></td>
				</tr>
			</table>
			<div style="width:100%;">
				<div style="clear:both;">
					<table style="margin-right:-40px;" cellspacing="0" width="1000" border="1" rules="all" class="rpt_table">
						<thead bgcolor="#dddddd">
							<th width="20">SL</th>
							<th width="100">Cust Buyer, Job, Style and Booking</th>
							<th width="45">Req. No/Work Order</th>
							<th width="50">Knitting Prog. No</th>
							<th width="50">Lot No</th>
							<th width="65">Yarn Type</th>
							<th width="110">Item Details</th>
							<th width="65">Dye. Color</th>
							<th width="60">Color</th>
							<th width="60">Supp.</th>
							<th width="60">Issue Qty(kg)</th>
							<th width="60">Rtnbl Qty(kg)</th>
							<th width="60">Bag & Cone</th>
							<th width="100">Sales Order No</th>

							<th>Remarks</th>
						</thead>
                        <tbody>
						<?
						$i= 0;
						foreach($printDataArr as $key=>$val)
						{
							$i++;
							if ($i % 2 == 0)
								$bgcolor = "#E9F3FF";
							else
								$bgcolor = "#FFFFFF";
							?>
                            <tr bgcolor="<? echo $bgcolor; ?>">
                                <td><? echo $i; ?></td>
                                <td>
                                    <div style="word-wrap:break-word; width:100px"><? echo $val['buyer_job_style']; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:45px"><? echo $val['req_no']; ?></div>
                                </td>
                                <td>
                                    <?  echo $val['prog_no']; ?>
                                </td>
                                <td width="50">
                                    <div style="word-wrap:break-word; width:50px"><? echo $val['lot']; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$val['yarn_type']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:110px">
                                        <? echo $val['item_description']; ?>
                                    </div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$val['dyeing_color_id']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $color_name_arr[$val['color_id']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $val['supplier_id']; ?></div>
                                </td>
                                <td align="right"><? echo number_format($val['cons_quantity'], 2, '.', ''); ?></td>
                                <td align="right"><? echo number_format($val['returnable_qnty'], 2, '.', ''); ?></td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $val['no_bag_cone'] . '<br>' . $val['wt_bag_cone'] ?>&nbsp;</div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:100px; font-size:12px;">
									<?
										$po_prefix = explode("-", $val['po_no']);
										if($po_prefix[1] == 'FSOE' || $po_prefix[1] == 'FSO')
										{
											echo $val['po_no'];
										}
										else echo $val['sales_order'];
									?></div>
                                </td>

                                <td>
                                    <div style="word-wrap:break-word; width:80px"><? echo $val['remarks']; ?></div>
                                </td>
                            </tr>
							<?
							$uom_unit = "Kg";
							$uom_gm = "Grams";
							$tot_return_qty += $val['returnable_qnty'];
							$tot_bag += $val['no_of_bags_val'];
							$tot_cone += $val['cone_per_bag'];
							$tot_w_bag += $val['weight_per_bag'];
							$tot_w_cone += $val['weight_per_cone'];
						}
						?>
						<tr bgcolor="#CCCCCC" style="font-size:16px">
							<td colspan="2"><b>Total Job:
                            <?php
							if(!empty($jobNoArr))
							{
                           		echo " ".count($jobNoArr);
							}
							?>
                            </b></td>
							<td align="right" colspan="8"><b>Total</b></td>
							<td align="right">
								<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 2, '.', ''); ?></b>
							</td>
							<td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
							<td><? echo 'N:' . number_format($tot_bag, 2);
							if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
							echo '<br>W:' . number_format($tot_w_bag, 2);
							if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
							<td align="right" colspan="4">&nbsp;</td>
						</tr>
						<tr>
							<td colspan="16" align="left"><b>In
							Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
						</tr>
                        <tr>
                        	<td colspan="16" height="30" style="border-left:hidden;border-right:hidden;">&nbsp;</td>
                        </tr>
							<?
								if($gatePassDataArr){
									?>
									<tr>
										<td colspan="8" align="center" valign="middle" style="font-size:25px;"><strong>&lt;&lt;Gate Pass&gt;&gt;</strong></td>
										<td colspan="8" align="center" valign="middle" id="gate_pass_barcode_img_id_<?php echo $x; ?>" height="50"></td>
									</tr>
									<tr>
										<td colspan="2"><strong>From Company:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['from_company']; ?></td>
										<td colspan="2"><strong>To Company:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['to_company']; ?></td>
										<td colspan="3"><strong>Carried By:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['carried_by']; ?></td>
									</tr>
									<tr>
										<td colspan="2"><strong>From Location:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['from_location']; ?></td>
										<td colspan="2"><strong>To Location:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['to_location']; ?></td>
										<td colspan="3"><strong>Driver Name:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['driver_name']; ?></td>
									</tr>
									<tr>
										<td colspan="2"><strong>Gate Pass ID:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['gate_pass_id']; ?></td>
										<td colspan="2" rowspan="2"><strong>Delivery Qnty</strong></td>
										<td align="center"><strong>Kg</strong></td>
										<td align="center" colspan="2"><strong>Bag</td>
										<td colspan="3"><strong>Vehicle Number:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['vhicle_number']; ?></td>
									</tr>
									<tr>
										<td colspan="2"><strong>Gate Pass Date:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['gate_pass_date']; ?></td>
										<td align="center"><?php echo $gatePassDataArr[$system_no]['delivery_kg']; ?></td>
										<td align="center" colspan="2"><?php echo $gatePassDataArr[$system_no]['delivery_bag']; ?></td>
										<td colspan="3"><strong>Driver License No.:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['driver_license_no']; ?></td>
									</tr>
									<tr>
										<td colspan="2"><strong>Out Date:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['out_date']; ?></td>
										<td colspan="2"><strong>Dept. Name:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['department']; ?></td>
										<td colspan="3"><strong>Mobile No.:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['mobile_no']; ?></td>
									</tr>
									<tr>
										<td colspan="2"><strong>Out Time:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['out_time']; ?></td>
										<td colspan="2"><strong>Attention:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['attention']; ?></td>
										<td colspan="3"><strong>Sequrity Lock No.:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['security_lock_no']; ?></td>
									</tr>
									<tr>
										<td colspan="2"><strong>Returnable:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['returnable']; ?></td>
										<td colspan="2"><strong>Purpose:</strong></td>
										<td colspan="9"><?php echo $gatePassDataArr[$system_no]['issue_purpose']; ?></td>
									</tr>
									<tr>
										<td colspan="2"><strong>Est. Return Date:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['est_return_date']; ?></td>
										<td colspan="2"><strong>Remarks:</strong></td>
										<td colspan="9"><?php echo $gatePassDataArr[$system_no]['remarks']; ?></td>
									</tr>

									<?
								}
							?>


                    </tbody>
                    </table>
				</div>
				<br>
				<? echo signature_table(49, $company, "1000px"); ?>
			</div>
		</div>
		<script type="text/javascript" src="../../js/jquery.js"></script>
        <script type="text/javascript" src="../../js/jquerybarcode.js"></script>
		<script>
			function generateBarcode(valuess)
			{
				var zs = '<?php echo $x; ?>';
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id_"+zs).html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id_"+zs).show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');

			//for gate pass barcode
			function generateBarcodeGatePass(valuess)
			{
				var zs = '<?php echo $x; ?>';
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#gate_pass_barcode_img_id_"+zs).html('11');
				value = {code: value, rect: false};
				$("#gate_pass_barcode_img_id_"+zs).show().barcode(value, btype, settings);
			}

			if('<? echo $gatePassDataArr[$system_no]['gate_pass_id']; ?>' != '')
			{
				generateBarcodeGatePass('<? echo strtoupper($gatePassDataArr[$system_no]['gate_pass_id']); ?>');
			}
		</script>
        <div style="page-break-after:always;"></div>
    <?php
	}
    exit();
}

if ($action == "yarn_issue_print20_old")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print-20", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$company   = $data[0];
	$system_no = $data[1];
	$report_title = $data[2];
	$booking_id = $data[3];
	$is_approved = $data[4];
	$mst_id     = $data[5];
	$show_val_column = $data[6];
	$print_with_vat = $data[7];
	$location  = $data[8];
	$store_id = $data[9];
	$no_copy = $data[10];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$company_arr = return_library_array("select id, company_short_name from lib_company", "id", "company_short_name");
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$department_arr = return_library_array("select id, department_name from lib_department", "id", "department_name");

	//for buyer
	$sqlBuyer = sql_select("select id as ID, buyer_name as BUYER_NAME, short_name as SHORT_NAME from lib_buyer");
	foreach($sqlBuyer as $row)
	{
		$buyer_arr[$row['ID']] = $row['BUYER_NAME'];
		$buyer_dtls_arr[$row['ID']] = $row['BUYER_NAME'];
	}
	unset($sqlBuyer);

	//for supplier
	$sqlSupplier = sql_select("select id as ID, supplier_name as SUPPLIER_NAME, short_name as SHORT_NAME from lib_supplier");
	foreach($sqlSupplier as $row)
	{
		$supplier_arr[$row['ID']] = $row['SHORT_NAME'];
		$supplier_dtls_arr[$row['ID']] = $row['SUPPLIER_NAME'];
	}
	unset($sqlSupplier);

	//for gate pass
	$sql_get_pass = "SELECT a.ID, a.SYS_NUMBER, a.BASIS, a.COMPANY_ID, a.GET_PASS_NO, a.DEPARTMENT_ID, a.ATTENTION, a.SENT_BY, a.WITHIN_GROUP, a.SENT_TO, a.CHALLAN_NO, a.OUT_DATE, a.TIME_HOUR, a.TIME_MINUTE, a.RETURNABLE, a.DELIVERY_AS, a.EST_RETURN_DATE, a.INSERTED_BY, a.CARRIED_BY, a.LOCATION_ID, a.COM_LOCATION_ID, a.VHICLE_NUMBER, a.LOCATION_NAME, a.REMARKS, a.DO_NO, a.MOBILE_NO, a.ISSUE_ID, a.RETURNABLE_GATE_PASS_REFF, a.DELIVERY_COMPANY, a.ISSUE_PURPOSE,a.SECURITY_LOCK_NO,a.DRIVER_NAME,a.DRIVER_LICENSE_NO, b.QUANTITY, b.NO_OF_BAGS FROM inv_gate_pass_mst a, INV_GATE_PASS_DTLS b WHERE a.id = b.mst_id AND a.company_id = ".$company." AND a.basis = 2 AND a.STATUS_ACTIVE = 1 AND a.IS_DELETED = 0 AND a.challan_no LIKE '".$system_no."%'";
	//echo $sql_get_pass;
	$sql_get_pass_rslt = sql_select($sql_get_pass);
	$is_gate_pass = 0;
	$is_gate_out = 0;
	$gate_pass_id = '';
	$gatePassDataArr = array();
	foreach($sql_get_pass_rslt as $row)
	{
		$exp = explode(',', $row['CHALLAN_NO']);
		foreach($exp as $key=>$val)
		{
			if($val == $system_no)
			{
				$is_gate_pass = 1;
				$gate_pass_id = $row['ID'];

				$row['OUT_DATE'] = ($row['OUT_DATE']!=''?date('d-m-Y', strtotime($row['OUT_DATE'])):'');
				$row['EST_RETURN_DATE'] = ($row['EST_RETURN_DATE']!=''?date('d-m-Y', strtotime($row['EST_RETURN_DATE'])):'');
				$row['EST_RETURN_DATE'] = ($row['EST_RETURN_DATE']!=''?date('d-m-Y', strtotime($row['EST_RETURN_DATE'])):'');

				if($row['WITHIN_GROUP'] == 1)
				{
					//$row['SENT_TO'] = ($row['BASIS']==50?$buyer_dtls_arr[$row['SENT_TO']]:$supplier_dtls_arr[$row['SENT_TO']]);
					$row['SENT_TO'] = $company_library[$row['SENT_TO']];
					$row['LOCATION_NAME'] = $location_arr[$row['LOCATION_ID']];
				}

				//for gate pass info
				$gatePassDataArr[$row['CHALLAN_NO']]['gate_pass_id'] = $row['SYS_NUMBER'];
				$gatePassDataArr[$row['CHALLAN_NO']]['from_company'] = $company_library[$row['COMPANY_ID']];
				$gatePassDataArr[$row['CHALLAN_NO']]['from_location'] =$location_arr[ $row['COM_LOCATION_ID']];
				$gatePassDataArr[$row['CHALLAN_NO']]['gate_pass_date'] = date('d-m-Y', strtotime($row['OUT_DATE']));
				$gatePassDataArr[$row['CHALLAN_NO']]['returnable'] = $yes_no[$row['RETURNABLE']];
				$gatePassDataArr[$row['CHALLAN_NO']]['est_return_date'] = $row['EST_RETURN_DATE'];

				$gatePassDataArr[$row['CHALLAN_NO']]['to_company'] = $row['SENT_TO'];
				$gatePassDataArr[$row['CHALLAN_NO']]['to_location'] = $row['LOCATION_NAME'];
				$gatePassDataArr[$row['CHALLAN_NO']]['delivery_kg'] += $row['QUANTITY'];
				$gatePassDataArr[$row['CHALLAN_NO']]['delivery_bag'] += $row['NO_OF_BAGS'];

				$gatePassDataArr[$row['CHALLAN_NO']]['department'] = $department_arr[$row['DEPARTMENT_ID']];
				$gatePassDataArr[$row['CHALLAN_NO']]['attention'] = $row['ATTENTION'];
				$gatePassDataArr[$row['CHALLAN_NO']]['issue_purpose'] = $row['ISSUE_PURPOSE'];
				$gatePassDataArr[$row['CHALLAN_NO']]['remarks'] = $row['REMARKS'];
				$gatePassDataArr[$row['CHALLAN_NO']]['carried_by'] = $row['CARRIED_BY'];
				$gatePassDataArr[$row['CHALLAN_NO']]['vhicle_number'] = $row['VHICLE_NUMBER'];
				$gatePassDataArr[$row['CHALLAN_NO']]['mobile_no'] = $row['MOBILE_NO'];
				$gatePassDataArr[$row['CHALLAN_NO']]['security_lock_no'] = $row['SECURITY_LOCK_NO'];
				$gatePassDataArr[$row['CHALLAN_NO']]['driver_name'] = $row['DRIVER_NAME'];
				$gatePassDataArr[$row['CHALLAN_NO']]['driver_license_no'] = $row['DRIVER_LICENSE_NO'];
			}
		}
	}

	//for gate out
	if($gate_pass_id != '')
	{
		$sql_gate_out="SELECT OUT_DATE, OUT_TIME FROM INV_GATE_OUT_SCAN WHERE STATUS_ACTIVE = 1 AND IS_DELETED = 0 AND INV_GATE_PASS_MST_ID='".$gate_pass_id."'";
		$sql_gate_out_rslt = sql_select($sql_gate_out);
		if(!empty($sql_gate_out_rslt))
		{
			foreach($sql_gate_out_rslt as $row)
			{
				$is_gate_out = 1;
				$gatePassDataArr[$system_no]['out_date'] = date('d-m-Y', strtotime($row['OUT_DATE']));
				$gatePassDataArr[$system_no]['out_time'] = $row['OUT_TIME'];
			}
		}
	}

	// for booking no
	/*
	$sql_booking = "select a.id,b.job_no,b.booking_no from inv_issue_master a,wo_booking_mst b where a.buyer_job_no=b.job_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.id='".$data[5]."'";
	//echo $sql_booking;
	//die;
	$sql_booking_data = sql_select($sql_booking);
	$BookingNoArr = array();
	foreach($sql_booking_data as $row)
	{
		$BookingNoArr[$row[csf('job_no')]]['booking_no'] = $row[csf('booking_no')];
	}
	//var_dump($BookingNoArr);
	*/

	/*$sql_booking1 = "select job_no, booking_no from wo_booking_mst where status_active=1 and is_deleted=0 and company_id = ".$company;
	//echo $sql_booking1;
	//die;
	$sql_booking_data1 = sql_select($sql_booking1);
	$BookingNoArr1 = array();
	foreach($sql_booking_data1 as $row)
	{
		$BookingNoArr1[$row[csf('job_no')]]['booking_no'] = $row[csf('booking_no')];
	}*/
	//var_dump($BookingNoArr1);

	// for Yarn Dyeing Work Order Without Order booking no
	$sql_ydw_booking = "select a.id AS ID, a.booking_no AS YDW_YSW_NO, c.fab_booking_no AS YDW_YSW_BOOKING_NO from inv_issue_master a, wo_yarn_dyeing_mst b, wo_yarn_dyeing_dtls c where a.booking_no=b.ydw_no and b.id = c.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.id='".$data[5]."'";
	//echo $sql_ydw_booking; die;
	$sql_ydw_booking_data = sql_select($sql_ydw_booking);
	$YwdBookingNoArr = array();
	foreach($sql_ydw_booking_data as $row)
	{
		$YwdBookingNoArr[$row['YDW_YSW_NO']]['ydwbooking'] = $row['YDW_YSW_BOOKING_NO'];
	}

	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks, attention from inv_issue_master where id='".$data[5]."'";
	//echo $sql;die;
	$dataArray = sql_select($sql);
	$reqBookingNoArr = array();
	foreach($dataArray as $row)
	{
		$issue_no = $row[csf('issue_number')];
		$issue_date = $row[csf('issue_date')];
		$knit_source = $row[csf('knit_dye_source')];
		$issue_purpose = $row[csf('issue_purpose')];
		$attention = $row[csf('attention')];
		$remarks = $row[csf('remarks')];
		$inhouse_location = $row[csf('location_id')];

		//for issue to
		$issue_to = '';
		if ($row[csf('issue_purpose')] == 3)
		{
			$issue_to = $buyer_dtls_arr[$row[csf('buyer_id')]];
		}
		else if ($row[csf('issue_purpose')] == 5)
		{
			$issue_to = $supplier_dtls_arr[$row[csf('loan_party')]] ;
		}
		else
		{
			if ($row[csf('knit_dye_source')] == 1)
				$issue_to = $company_library[$row[csf('knit_dye_company')]];
			else
				$issue_to = $supplier_dtls_arr[$row[csf('knit_dye_company')]];
		}

		//for address
		$address = "";
		$addressParty = "";
		if ($row[csf('knit_dye_source')] == 3)
		{
			$nameArray = sql_select("select address_1 ,web_site, email, country_id from lib_supplier where id=".$row[csf('knit_dye_company')]."");
			foreach ($nameArray as $result)
			{
				if ($result != "")
					$address = $result[csf('address_1')];
			}
			unset($nameArray);
		}

		//for party address
		$loanPartyArray = sql_select("select address_1, web_site, email, country_id from lib_supplier where id=".$row[csf('loan_party')]."");
		foreach ($loanPartyArray as $result)
		{
			if ($result != "")
				$addressParty = $result[csf('address_1')];;
		}
		unset($loanPartyArray);

		$addressPrint = '';
		if ($row[csf('issue_purpose')] == 3)
		{
			$addressPrint = $buyer_arr[$row[csf('buyer_id')]];
		}
		else if ($row[csf('issue_purpose')] == 5)
		{
			$addressPrint = $addressParty;
		}
		else
		{
			if ($row[csf('knit_dye_source')] == 1)
			{
				$addressPrint = $company_library[$row[csf('knit_dye_company')]];
			}
			else
			{
				$addressPrint = $address;
			}
		}

		/*
		| if knitting source is out-bound subcontract then
		| address will show
		*/
		if ($row[csf('knit_dye_source')] != 3)
		{
			$addressPrint = '';
		}

		//for program no
		if( $row[csf('issue_basis')] == 3 )
		{
			$planbooking = sql_select("select b.requisition_no, e.booking_no as pln_booking_no, d.id as program_id, d.is_sales from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no = c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='".$mst_id."' ");
			foreach ($planbooking as $value)
			{
				$program_id .= $value[csf('program_id')].',';
				$reqBookingNoArr[$value[csf('requisition_no')]]['booking_no'] = $value[csf('pln_booking_no')];
				$reqBookingNoArr[$value[csf('requisition_no')]]['is_sample'] = $value[csf('is_sales')];
				$sampleBookingArr[$value[csf('pln_booking_no')]] = $value[csf('pln_booking_no')];
			}
			$program_ids = implode(",", array_unique(explode(",", chop($program_id,','))));
		}
		//echo $program_ids;
	}
	//echo "<pre>";
	//print_r($reqBookingNoArr);

	//for sample style ref. no
	$sql_sample = sql_select("SELECT a.BOOKING_NO, b.BUYER_NAME, b.STYLE_REF_NO,b.SUSTAINABILITY_STD_ID,b.FABRIC_MATERIAL_ID FROM WO_NON_ORD_SAMP_BOOKING_DTLS a, SAMPLE_DEVELOPMENT_MST b WHERE a.STYLE_ID=b.ID".where_con_using_array($sampleBookingArr, '1', 'a.BOOKING_NO'));
	$dataSampleArr = array();
	foreach($sql_sample as $row)
	{
		$dataSampleArr[$row['BOOKING_NO']]['buyer_id'] = $row['BUYER_NAME'];
		$dataSampleArr[$row['BOOKING_NO']]['style_ref_no'] = $row['STYLE_REF_NO'];
		$dataSampleArr[$row['BOOKING_NO']]['sustainability_std_id'] = $row['SUSTAINABILITY_STD_ID'];
		$dataSampleArr[$row['BOOKING_NO']]['fabric_material_id'] = $row['FABRIC_MATERIAL_ID'];
	}
	unset($sql_sample);

	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
	?>
	<style type="text/css">
		table tr td {
			font-size: 16px;
		}
		.rpt_table thead th{
			font-size: 16px;
		}
		.rpt_table tfoot th{
			font-size: 16px;
		}
	</style>
    <?php
	$data_array = sql_select("select image_location  from common_photo_library where master_tble_id='".$data[0]."' and form_name='company_details' and is_deleted=0 and file_type=1");
	$cond = "";
	if ($mst_id != "")
		$cond .= " and c.id='".$mst_id."'";

	$i = 1;
	if ($db_type == 0)
	{
		$sql_result = sql_select("SELECT a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, a.supplier_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, b.remarks
		from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
		where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
		group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, a.is_within_group, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, b.remarks");
	}
	else
	{
		$sql_result = sql_select("SELECT a.id, a.lot, a.color, a.yarn_type, a.product_name_details, a.yarn_count_id, a.yarn_comp_percent1st, a.yarn_comp_type1st, a.detarmination_id, a.supplier_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, b.remarks
		from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
		where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
		group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, a.is_within_group, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, b.remarks");
	}

	$poIdArr = array();
	$reqNoArr = array();
	foreach ($sql_result as $row)
	{
		//for po id
		$expPo = array();
		$expPo = explode(",", $row[csf('po_id')]);
		foreach ($expPo as $key=>$val)
		{
			if($val*1 > 0)
			{
				$poIdArr[$val] = $val;
			}
		}

		//for req no
		$reqNoArr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];
	}
	/*echo "<pre>";
	print_r($poIdArr);
	echo "</pre>";*/

	//for po information
	$po_array = array();
	$job_array = array();
	$costing_sql = sql_select("select a.job_no, b.file_no, b.grouping, a.style_ref_no, a.buyer_name,a.sustainability_standard,a.fab_material, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=".$company.where_con_using_array($poIdArr, '0', 'b.id'));
	// echo "select a.job_no, b.file_no, b.grouping, a.style_ref_no, a.buyer_name,a.sustainability_standard,a.fab_material, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=".$company.where_con_using_array($poIdArr, '0', 'b.id');
	foreach ($costing_sql as $row)
	{
		$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
		$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
		$po_array[$row[csf('id')]]['sustainability'] = $row[csf('sustainability_standard')];
		$po_array[$row[csf('id')]]['fab_material'] = $row[csf('fab_material')];
		$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
		$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
		$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
		$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
		$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
	}
	unset($costing_sql);
	/*echo "<pre>";
	print_r($po_array[2235]);
	echo "</pre>";*/

	//for requisition information
	$po_id_req_array = array();
	$is_sales_array = array();
	if ($db_type == 0)
	{
		$poID = " SELECT c.knit_id, c.requisition_no, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id".where_con_using_array($reqNoArr, '0', 'c.requisition_no')." group by c.knit_id,c.requisition_no, a.is_sales ";
	}
	else
	{
		$poID = "SELECT c.knit_id, c.requisition_no, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id".where_con_using_array($reqNoArr, '0', 'c.requisition_no')." group by c.knit_id, c.requisition_no, a.is_sales";
	}

	$poID_sql_result = sql_select($poID);
	$poIdArr2 = array();
	foreach ($poID_sql_result as $row)
	{
		$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
		$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
		$program_array[$row[csf('requisition_no')]] = $row[csf('knit_id')];

		//for po id
		$expPo = array();
		$expPo = explode(",", $row[csf('poid')]);
		foreach ($expPo as $key=>$val)
		{
			$poIdArr2[$val] = $val;
		}
	}
	unset($poID_sql_result);
	/*echo "<pre>";
	print_r($po_id_req_array);
	echo "</pre>";*/

	//for job information
	$job_no_array = array();
	$jobData = sql_select("select id, job_no, style_ref_no, within_group,buyer_id, CUSTOMER_BUYER as cust_buyer_id from fabric_sales_order_mst where 1=1".where_con_using_array($poIdArr2, '0', 'id'));

	// echo "select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst where 1=1".where_con_using_array($poIdArr2, '0', 'id');
	foreach ($jobData as $row)
	{
		$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
		$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
		$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
		$job_no_array[$row[csf('id')]]['cust_buyer_id'] = $row[csf('cust_buyer_id')];
	}
	unset($jobData);

	// echo "<pre>";
	// print_r($job_no_array);


	$all_req_no = "";
	$all_prod_id = "";
	$order_qnty_val_sum=0;
	$order_amount_val_sum=0;
	$no_of_bags_val_sum=0;
	$tot_return_qty = 0;
	$tot_bag = 0;
	$tot_cone = 0;
	$tot_w_bag = 0;
	$tot_w_cone = 0;
	$z = 0;
	$printDataArr = array();
	$jobNoArr = array();
	foreach ($sql_result as $row)
	{
		//for booking no
		//$row[csf('buyer_job_no')];
		/*$mainbookingNo = '';
		if($row[csf('buyer_job_no')])
		{
			$mainbookingNo = $BookingNoArr[$row[csf('buyer_job_no')]]['booking_no'];
		}
		else
		{
			$mainbookingNo = $YwdBookingNoArr[$row[csf('booking_no')]]['ydwbooking'];

			if ($row[csf('issue_basis')] == 3 && $dataArray[0][csf('issue_purpose')] == 1)
			{
				$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
				foreach ($po_id as $val)
				{
					$mainbookingNo = $BookingNoArr1[$po_array[$val]['job_no']]['booking_no'];
					//$mainbookingNo = $po_array[$val]['job_no'];
				}

				$mainbookingNo = $reqBookingNoArr[$row[csf('requisition_no')]]['booking_no'];
			}
		}*/

		$bookingNo = $row[csf('booking_no')];
		if ($row[csf('requisition_no')] != "")
		{
			if ($all_req_no == '')
				$all_req_no = $row[csf('requisition_no')];
			else
				$all_req_no .= ',' . $row[csf('requisition_no')];

			if ($all_prod_id == '')
				$all_prod_id = $row[csf('po_id')];
			else
				$all_prod_id .= ',' . $row[csf('po_id')];
		}
		$order_qnty_val = $row[csf('cons_quantity')];
		$order_qnty_val_sum += $order_qnty_val;

		$order_amount_val = $row[csf('order_amount')];
		$order_amount_val_sum += $order_amount_val;

		$no_of_bags_val = $row[csf('no_of_bags')];
		$no_of_bags_val_sum += $no_of_bags_val;

		$po_id = explode(",", $row[csf('po_id')]);
		$po_no = "";
		$style_ref = "";
		$job_no = "";
		$buyer = "";
		$sustainability = "";
		$material = "";
		$fab_material=array(1=>"Organic",2=>"BCI");
			//$data=explode('*',$data);
		$productdtls = $row[csf('product_name_details')];
		$productArr = explode(' ', $productdtls);

		$proddtls = "";
		if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
		}
		else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
		}
		else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
		}
		else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
		}
		else if ($productArr[0] != '' && $productArr[1] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1];
		}
		else if ($productArr[0] != '')
		{
			$proddtls = $productArr[0];
		}
		else
		{
			$proddtls = "";
		}

		$internal_ref = "";
		$file_no = "";

		if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
		{
			foreach ($po_id as $val)
			{
				if ($po_no == '')
					$po_no = $po_array[$val]['no'];
				else
					$po_no .= ", " . $po_array[$val]['no'];

				if ($job_no == '')
				{
					$job_no = $po_array[$val]['job_no'];

					if($job_no != '')
					{
						$jobNoArr[$job_no] = $job_no;
					}
				}

				if ($sustainability  == '')
					$sustainability  = $po_array[$val]['sustainability'];

				if ($material   == '')
					$material  = $po_array[$val]['fab_material'];

				if ($style_ref == '')
				{
					if($knit_source==3 && $show_val_column==0 && $dataArray[0][csf('issue_purpose')] != 8)
					{
						$style_ref = 'WHS';
					}
					else
					{
						$style_ref = $po_array[$val]['style_ref'];
					}
					//$style_ref = $po_array[$val]['style_ref'];
				}


				if ($buyer == '')
					$buyer_name = $po_array[$val]['buyer_name'];

				if ($internal_ref == '')
					$internal_ref = $po_array[$val]['grouping'];
				else
					$internal_ref .= "," . $po_array[$val]['grouping'];

				if ($file_no == '')
					$file_no = $po_array[$val]['file_no'];
				else
					$file_no .= "," . $po_array[$val]['file_no'];
			}
			// echo "*************".$buyer_name;

			$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
			$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

			$ref_cond = "";
			foreach ($job_ref as $ref) {
				if ($ref_cond == '')
					$ref_cond = $ref;
				else
					$ref_cond .= ", " . $ref;
			}

			$file_con = "";
			foreach ($job_file as $file)
			{
				if ($file_con == '')
					$file_cond = $file;
				else
					$file_cond .= ", " . $file;
			}

			$buyer_job = "";
			if ($row[csf('issue_basis')] == 1)
			{
				if ($dataArray[0][csf('issue_purpose')] == 8 )
				{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS';
						}
						else
						{
							$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
						}

						//$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
				}
				if ($dataArray[0][csf('issue_purpose')] == 2 )
				{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS';
						}
						else
						{
							$buyer_job= $buyer_arr[$row[csf('buyer_id')]]. '::' . $row[csf('buyer_job_no')];
							// $buyer_job = $buyer_arr[$buyer_name];
						}
				}
				else
				{
					$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
					if ($row[csf('buyer_job_no')] != "")
					{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS' . '::' . $row[csf('buyer_job_no')];
						}
						else
						{
							$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['cust_buyer_id']] . '::' . $row[csf('buyer_job_no')];
						}
						//$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . '::' . $row[csf('buyer_job_no')];

						if($buyer_job != '')
						{
							$jobNoArr[$row[csf('buyer_job_no')]] = $row[csf('buyer_job_no')];
						}
					}
					else
					{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS';
						}
						else
						{
							$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
						}
					}
				}

				//for ydw and ysw booking no
				if ($dataArray[0][csf('issue_purpose')] == 2 || $dataArray[0][csf('issue_purpose')] == 7 || $dataArray[0][csf('issue_purpose')] == 12 || $dataArray[0][csf('issue_purpose')] == 15 || $dataArray[0][csf('issue_purpose')] == 38 || $dataArray[0][csf('issue_purpose')] == 46 || $dataArray[0][csf('issue_purpose')] == 50 || $dataArray[0][csf('issue_purpose')] == 51)
				{
					$bookingNo = $YwdBookingNoArr[$row[csf('booking_no')]]['ydwbooking'];
				}
			}
			else if ($row[csf('issue_basis')] == 2)
			{
				$buyer_job = "";
			}

		}
		else if ($row[csf('issue_basis')] == 3)
		{
			//for booking no
			$bookingNo = $reqBookingNoArr[$row[csf('requisition_no')]]['booking_no'];
			$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
			//print_r($ex_data);

			if ($is_sales_array[$row[csf('requisition_no')]] == 1)
			{
				$buyer_job = "";
				foreach (array_unique($po_id) as $val)
				{
					if ($po_no == "")
						$po_no = $job_no_array[$val]['job_no'];
					else
						$po_no .= ", " . $job_no_array[$val]['job_no'];

					if ($style_ref == "")
						$style_ref = $job_no_array[$val]['style_ref'];

					if ($sustainability  == '')
						$sustainability  = $po_array[$val]['sustainability'];

					if ($material   == '')
						$material  = $po_array[$val]['fab_material'];

					if ($buyer_job == "") {
						if ($job_no_array[$val]['within_group'] == 1)
						{
							$buyer_job = $buyer_arr[$job_no_array[$val]['cust_buyer_id']];
						}
						else
						{
							$buyer_job = $buyer_arr[$job_no_array[$val]['cust_buyer_id']];
						}
					}

					if ($job_no_array[$val]['within_group'] != 1)
					{
						$ref_cond = "";
					}
				}
			}
			else
			{
				foreach ($po_id as $val)
				{
					if ($po_no == "")
						$po_no = $po_array[$val]['no'];
					else
						$po_no .= ", " . $po_array[$val]['no'];

					if ($job_no == "")
					{
						$job_no = $po_array[$val]['job_no'];


						if($job_no != '')
						{
							$jobNoArr[$job_no] = $job_no;
						}
					}

					if ($style_ref == "")
					{
						if($knit_source==3 && $show_val_column==0)
						{
							$style_ref = 'WHS';
						}
						else
						{
							$style_ref = $po_array[$val]['style_ref'];
						}
						//$style_ref = $po_array[$val]['style_ref'];
					}


					if ($sustainability  == '')
						$sustainability  = $po_array[$val]['sustainability'];

					if ($material   == '')
						$material  = $po_array[$val]['fab_material'];

					if ($buyer == "")
						$buyer_name = $po_array[$val]['buyer_name'];

					if ($internal_ref == "")
						$internal_ref = $po_array[$val]['grouping'];
					else
						$internal_ref .= "," . $po_array[$val]['grouping'];

					if ($file_no == "")
						$file_no = $po_array[$val]['file_no'];
					else
						$file_no .= "," . $po_array[$val]['file_no'];
				}

				$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
				$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

				$ref_cond = "";
				foreach ($job_ref as $ref)
				{
					if ($ref_cond == "") $ref_cond = $ref; else $ref_cond .= ", " . $ref;
				}

				$file_con = "";
				foreach ($job_file as $file)
				{
					if ($file_con == "")
						$file_cond = $file;
					else
						$file_cond .= ", " . $file;
				}

				if ($job_no != "")
				{
					if($knit_source==3 && $show_val_column==0)
					{
						$buyer_job = 'WHS' . '::' . $job_no;
					}
					else
					{
						$buyer_job = $buyer_arr[$buyer_name] . '::' . $job_no;
					}

					$jobNoArr[$job_no] = $job_no;
				}
				else
				{
					$buyer_job = $buyer_arr[$buyer_name];
				}
			}

			//for sample
			if($reqBookingNoArr[$row[csf('requisition_no')]]['is_sample'] == 2)
			{
				$buyer_job = $buyer_arr[$dataSampleArr[$bookingNo]['buyer_id']];
				$style_ref = $dataSampleArr[$bookingNo]['style_ref_no'];
				$sustainability = $dataSampleArr[$bookingNo]['sustainability_std_id'];
				$material = $dataSampleArr[$bookingNo]['fabric_material_id'];
			}
		}
		else
		{
			foreach (array_unique($po_id) as $val)
			{
				if ($po_no == "")
					$po_no = $job_no_array[$val]['job_no'];
				else
					$po_no .= ", " . $job_no_array[$val]['job_no'];

				if ($style_ref == "")
					$style_ref = $job_no_array[$val]['style_ref'];


				if ($buyer_job == "")
				{
					if ($job_no_array[$val]['within_group'] == 1)
					{
						$buyer_job = $buyer_arr[$job_no_array[$val]['cust_buyer_id']];
					}
					else
					{
						$buyer_job = $buyer_arr[$job_no_array[$val]['cust_buyer_id']];
					}
				}
			}
		}
		// echo $buyer_name;
		// print_r($po_array);


		$no_bag_cone = "";
		$wt_bag_cone = "";
		if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0)
			$no_bag_cone = 'N:' . $no_of_bags_val;
		else
			$no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

		if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0)
			$wt_bag_cone = 'W:' . $row[csf('weight_per_bag')];
		else
			$wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];

		//for buyer job and style
		$buyer_job_style = $buyer_job.($style_ref != ''?'::'.$style_ref:'');
		$req_no = ($row[csf('requisition_no')] != 0 ? $row[csf('requisition_no')]:'');
		$item_description = $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];

		//for print data
		$z++;
		//$printDataArr[$z]['buyer_job_style'] = $buyer_job.($style_ref != ''?'::'.$style_ref:'').($mainbookingNo != ''?'::'.$mainbookingNo:'').($sustainability*1 != ''?'::'.$sustainability_standard[$sustainability]:'').($material*1 != ''?'::'.$fab_material[$material]:'');


		$printDataArr[$z]['buyer_job_style'] = $buyer_job.($style_ref != ''?'::'.$style_ref:'').($bookingNo != ''?'::'.$bookingNo:'').($sustainability*1 != ''?'::'.$sustainability_standard[$sustainability]:'').($material*1 != ''?'::'.$fab_material[$material]:'');
		$printDataArr[$z]['req_no'] = ($row[csf('requisition_no')] != 0 ? $row[csf('requisition_no')]:$row[csf('booking_no')]);
		$printDataArr[$z]['prog_no'] = $program_array[$row[csf('requisition_no')]];
		$printDataArr[$z]['lot'] = $row[csf('lot')];
		$printDataArr[$z]['yarn_type'] = $row[csf('yarn_type')];
		$printDataArr[$z]['item_description'] = $item_description;
		$printDataArr[$z]['dyeing_color_id'] = $row[csf('dyeing_color_id')];
		$printDataArr[$z]['color_id'] = $row[csf('color')];

		//for supplier
		//$printDataArr[$z]['supplier_id'] = $row[csf('supplier_id')];
		if($row[csf('is_within_group')] == 1)
		{
			$supplier_name = $company_arr[$row[csf('supplier_id')]];
		}
		else
		{
			$supplier_name = $supplier_arr[$row[csf('supplier_id')]];
		}
		$printDataArr[$z]['supplier_id'] = $supplier_name;

		$printDataArr[$z]['cons_quantity'] = $row[csf('cons_quantity')];
		$printDataArr[$z]['returnable_qnty'] = $row[csf('returnable_qnty')];
		$printDataArr[$z]['no_bag_cone'] = $no_bag_cone;
		$printDataArr[$z]['wt_bag_cone'] = $wt_bag_cone;
		$printDataArr[$z]['store_id'] = $row[csf('store_id')];
		$printDataArr[$z]['po_no'] = $po_no;
		$printDataArr[$z]['remarks'] = $row[csf('remarks')];

		$printDataArr[$z]['no_of_bags_val'] = $no_of_bags_val;
		$printDataArr[$z]['cone_per_bag'] = $row[csf('cone_per_bag')];
		$printDataArr[$z]['weight_per_bag'] = $row[csf('weight_per_bag')];
		$printDataArr[$z]['weight_per_cone'] = $row[csf('weight_per_cone')];
	}

	$noOfCopy = "";
	for ($x = 1; $x <= $no_copy; $x++)
	{
		if($x==1)
		{
			$sup = 'st';
		}
		else if($x==2)
		{
			$sup = 'nd';
		}
		else if($x==3)
		{
			$sup = 'rd';
		}
		else
		{
			$sup = 'th';
		}

		$noOfCopy ="<span style='font-size:x-large;font-weight:bold'>".$x."<sup>".$sup."</sup> Copy</span>";
		?>


		<div style="width:1020px;">
			<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row)
						{
							if ($data[5] != 1)
							{
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50' align="middle"/>
								<?
							}
							else
							{
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50' align="middle"/>
								<?
							}
						}
						?>
					</td>
                    <td align="center" style="font-size:30px" colspan="6"><strong><? echo $com_dtls[0]."<br><span style=\"font-size:14px;\">".$com_dtls[1]."</span>"; ?></strong></td>
					<td width="110" align="right"><?php echo $noOfCopy.($is_gate_pass==1?"<br><span style=\"color:#F00;font-weight:bold;\">Gate Pass Done</span>":'').($is_gate_out==1?"<br><span style=\"color:#F00;font-weight:bold;\">Gate Out Done</span>":''); ?></td>
				</tr>
				<tr>
					<td colspan="6" align="center" height="50" valign="middle" style="font-size:25px">
						<strong><u>Yarn Delivery Challan</u></strong>
						<?php
						if ($data[4] == 1)
						{

							?>
							<span style="color:#0F0; font-weight:bold;">[Approved]</span>
							<?php
						}
						?>
					</td>
				</tr>
			</table>
			<br>
            <table style="margin-right:-40px;" cellspacing="0" width="1020" border="1" rules="all" class="rpt_table">
				<tr>
					<td width="70"><strong>Issue No:</strong></td>
					<td width="260px"><? echo $issue_no; ?></td>
					<td width="80"><strong>Issue Date:</strong></td>
					<td width="260px"><? echo change_date_format($issue_date); ?></td>
					<td width="120"><strong>Knitting Source:</strong></td>
					<td><? echo $knitting_source[$knit_source]; ?></td>
				</tr>
				<tr>
					<td><strong>Issue To:</strong></td>
					<td><? echo $issue_to; ?></td>
					<td><strong>Address:</strong></td>
					<td><? echo $addressPrint; ?></td>
					<td><strong>Issue Purpose:</strong></td>
					<td><? echo $yarn_issue_purpose[$issue_purpose]; ?></td>
				</tr>
				<tr>
					<td><strong>Location:</strong></td>
					<td><? echo $location_arr[$inhouse_location]; ?></td>
					<td><strong>Attention:</strong></td>
					<td><? echo $attention; ?></td>
					<td><strong>Remarks:</strong></td>
					<td><? echo $remarks; ?></td>
				</tr>
				<tr>
					<td style="border-left:hidden;border-right:hidden;border-bottom:hidden;"></td>
					<td style="border-left:hidden;border-right:hidden;border-bottom:hidden;"></td>
					<td align="center" colspan="6" id="barcode_img_id_<?php echo $x; ?>" height="50" valign="middle" style="border-left:hidden;border-right:hidden;border-bottom:hidden;"></td>
				</tr>
			</table>
			<div style="width:100%;">
				<div style="clear:both;">
					<table style="margin-right:-40px;" cellspacing="0" width="1000" border="1" rules="all" class="rpt_table">
						<thead bgcolor="#dddddd">
							<th width="20">SL</th>
							<th width="100">Cust Buyer, Job, Style and Booking</th>
							<th width="45">Req. No/Work Order</th>
							<th width="50">Knitting Prog. No</th>
							<th width="50">Lot No</th>
							<th width="65">Yarn Type</th>
							<th width="110">Item Details</th>
							<th width="65">Dye. Color</th>
							<th width="60">Color</th>
							<th width="60">Supp.</th>
							<th width="60">Issue Qty(kg)</th>
							<th width="60">Rtnbl Qty(kg)</th>
							<th width="60">Bag & Cone</th>
							<th width="100">Order/PO</th>

							<th>Remarks</th>
						</thead>
                        <tbody>
						<?
						$i= 0;
						foreach($printDataArr as $key=>$val)
						{
							$i++;
							if ($i % 2 == 0)
								$bgcolor = "#E9F3FF";
							else
								$bgcolor = "#FFFFFF";
							?>
                            <tr bgcolor="<? echo $bgcolor; ?>">
                                <td><? echo $i; ?></td>
                                <td>
                                    <div style="word-wrap:break-word; width:100px"><? echo $val['buyer_job_style']; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:45px"><? echo $val['req_no']; ?></div>
                                </td>
                                <td>
                                    <?  echo $val['prog_no']; ?>
                                </td>
                                <td width="50">
                                    <div style="word-wrap:break-word; width:50px"><? echo $val['lot']; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$val['yarn_type']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:110px">
                                        <? echo $val['item_description']; ?>
                                    </div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$val['dyeing_color_id']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $color_name_arr[$val['color_id']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $val['supplier_id']; ?></div>
                                </td>
                                <td align="right"><? echo number_format($val['cons_quantity'], 2, '.', ''); ?></td>
                                <td align="right"><? echo number_format($val['returnable_qnty'], 2, '.', ''); ?></td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $val['no_bag_cone'] . '<br>' . $val['wt_bag_cone'] ?>&nbsp;</div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:100px; font-size:12px;"><? echo $val['po_no']; ?></div>
                                </td>

                                <td>
                                    <div style="word-wrap:break-word; width:80px"><? echo $val['remarks']; ?></div>
                                </td>
                            </tr>
							<?
							$uom_unit = "Kg";
							$uom_gm = "Grams";
							$tot_return_qty += $val['returnable_qnty'];
							$tot_bag += $val['no_of_bags_val'];
							$tot_cone += $val['cone_per_bag'];
							$tot_w_bag += $val['weight_per_bag'];
							$tot_w_cone += $val['weight_per_cone'];
						}
						?>
						<tr bgcolor="#CCCCCC" style="font-size:16px">
							<td colspan="2"><b>Total Job:
                            <?php
							if(!empty($jobNoArr))
							{
                           		echo " ".count($jobNoArr);
							}
							?>
                            </b></td>
							<td align="right" colspan="8"><b>Total</b></td>
							<td align="right">
								<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 2, '.', ''); ?></b>
							</td>
							<td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
							<td><? echo 'N:' . number_format($tot_bag, 2);
							if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
							echo '<br>W:' . number_format($tot_w_bag, 2);
							if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
							<td align="right" colspan="4">&nbsp;</td>
						</tr>
						<tr>
							<td colspan="16" align="left"><b>In
							Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
						</tr>
                        <tr>
                        	<td colspan="16" height="30" style="border-left:hidden;border-right:hidden;">&nbsp;</td>
                        </tr>
							<?
								if($gatePassDataArr){
									?>
									<tr>
										<td colspan="8" align="center" valign="middle" style="font-size:25px;"><strong>&lt;&lt;Gate Pass&gt;&gt;</strong></td>
										<td colspan="8" align="center" valign="middle" id="gate_pass_barcode_img_id_<?php echo $x; ?>" height="50"></td>
									</tr>
									<tr>
										<td colspan="2"><strong>From Company:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['from_company']; ?></td>
										<td colspan="2"><strong>To Company:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['to_company']; ?></td>
										<td colspan="3"><strong>Carried By:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['carried_by']; ?></td>
									</tr>
									<tr>
										<td colspan="2"><strong>From Location:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['from_location']; ?></td>
										<td colspan="2"><strong>To Location:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['to_location']; ?></td>
										<td colspan="3"><strong>Driver Name:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['driver_name']; ?></td>
									</tr>
									<tr>
										<td colspan="2"><strong>Gate Pass ID:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['gate_pass_id']; ?></td>
										<td colspan="2" rowspan="2"><strong>Delivery Qnty</strong></td>
										<td align="center"><strong>Kg</strong></td>
										<td align="center" colspan="2"><strong>Bag</td>
										<td colspan="3"><strong>Vehicle Number:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['vhicle_number']; ?></td>
									</tr>
									<tr>
										<td colspan="2"><strong>Gate Pass Date:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['gate_pass_date']; ?></td>
										<td align="center"><?php echo $gatePassDataArr[$system_no]['delivery_kg']; ?></td>
										<td align="center" colspan="2"><?php echo $gatePassDataArr[$system_no]['delivery_bag']; ?></td>
										<td colspan="3"><strong>Driver License No.:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['driver_license_no']; ?></td>
									</tr>
									<tr>
										<td colspan="2"><strong>Out Date:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['out_date']; ?></td>
										<td colspan="2"><strong>Dept. Name:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['department']; ?></td>
										<td colspan="3"><strong>Mobile No.:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['mobile_no']; ?></td>
									</tr>
									<tr>
										<td colspan="2"><strong>Out Time:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['out_time']; ?></td>
										<td colspan="2"><strong>Attention:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['attention']; ?></td>
										<td colspan="3"><strong>Sequrity Lock No.:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['security_lock_no']; ?></td>
									</tr>
									<tr>
										<td colspan="2"><strong>Returnable:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['returnable']; ?></td>
										<td colspan="2"><strong>Purpose:</strong></td>
										<td colspan="9"><?php echo $gatePassDataArr[$system_no]['issue_purpose']; ?></td>
									</tr>
									<tr>
										<td colspan="2"><strong>Est. Return Date:</strong></td>
										<td colspan="3"><?php echo $gatePassDataArr[$system_no]['est_return_date']; ?></td>
										<td colspan="2"><strong>Remarks:</strong></td>
										<td colspan="9"><?php echo $gatePassDataArr[$system_no]['remarks']; ?></td>
									</tr>

									<?
								}
							?>


                    </tbody>
                    </table>
				</div>
				<br>
				<? echo signature_table(49, $company, "1000px"); ?>
			</div>
		</div>
		<script type="text/javascript" src="../../js/jquery.js"></script>
        <script type="text/javascript" src="../../js/jquerybarcode.js"></script>
		<script>
			function generateBarcode(valuess)
			{
				var zs = '<?php echo $x; ?>';
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id_"+zs).html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id_"+zs).show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');

			//for gate pass barcode
			function generateBarcodeGatePass(valuess)
			{
				var zs = '<?php echo $x; ?>';
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#gate_pass_barcode_img_id_"+zs).html('11');
				value = {code: value, rect: false};
				$("#gate_pass_barcode_img_id_"+zs).show().barcode(value, btype, settings);
			}

			if('<? echo $gatePassDataArr[$system_no]['gate_pass_id']; ?>' != '')
			{
				generateBarcodeGatePass('<? echo strtoupper($gatePassDataArr[$system_no]['gate_pass_id']); ?>');
			}
		</script>
        <div style="page-break-after:always;"></div>
    <?php
	}
    exit();
}
if ($action == "yarn_issue_print17")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print-10", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$company   = $data[0];
	$system_no = $data[1];
	$report_title = $data[2];
	$booking_id = $data[3];
	$is_approved = $data[4];
	$mst_id     = $data[5];
	$show_val_column = $data[6];
	$print_with_vat = $data[7];
	$location  = $data[8];
	$store_id = $data[9];
	$no_copy = $data[10];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$company_arr = return_library_array("select id, company_short_name from lib_company", "id", "company_short_name");
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$department_arr = return_library_array("select id, department_name from lib_department", "id", "department_name");

	//for buyer
	$sqlBuyer = sql_select("select id as ID, buyer_name as BUYER_NAME, short_name as SHORT_NAME from lib_buyer");
	foreach($sqlBuyer as $row)
	{
		$buyer_arr[$row['ID']] = $row['SHORT_NAME'];
		$buyer_dtls_arr[$row['ID']] = $row['BUYER_NAME'];
	}
	unset($sqlBuyer);

	//for supplier
	$sqlSupplier = sql_select("select id as ID, supplier_name as SUPPLIER_NAME, short_name as SHORT_NAME from lib_supplier");
	foreach($sqlSupplier as $row)
	{
		$supplier_arr[$row['ID']] = $row['SHORT_NAME'];
		$supplier_dtls_arr[$row['ID']] = $row['SUPPLIER_NAME'];
	}
	unset($sqlSupplier);

	//for gate pass
	$sql_get_pass = "SELECT a.ID, a.SYS_NUMBER, a.BASIS, a.COMPANY_ID, a.GET_PASS_NO, a.DEPARTMENT_ID, a.ATTENTION, a.SENT_BY, a.WITHIN_GROUP, a.SENT_TO, a.CHALLAN_NO, a.OUT_DATE, a.TIME_HOUR, a.TIME_MINUTE, a.RETURNABLE, a.DELIVERY_AS, a.EST_RETURN_DATE, a.INSERTED_BY, a.CARRIED_BY, a.LOCATION_ID, a.COM_LOCATION_ID, a.VHICLE_NUMBER, a.LOCATION_NAME, a.REMARKS, a.DO_NO, a.MOBILE_NO, a.ISSUE_ID, a.RETURNABLE_GATE_PASS_REFF, a.DELIVERY_COMPANY, a.ISSUE_PURPOSE,a.SECURITY_LOCK_NO,a.DRIVER_NAME,a.DRIVER_LICENSE_NO, b.QUANTITY, b.NO_OF_BAGS FROM inv_gate_pass_mst a, INV_GATE_PASS_DTLS b WHERE a.id = b.mst_id AND a.company_id = ".$company." AND a.basis = 2 AND a.STATUS_ACTIVE = 1 AND a.IS_DELETED = 0 AND a.challan_no LIKE '".$system_no."%'";
	//echo $sql_get_pass;
	$sql_get_pass_rslt = sql_select($sql_get_pass);
	$is_gate_pass = 0;
	$is_gate_out = 0;
	$gate_pass_id = '';
	$gatePassDataArr = array();
	foreach($sql_get_pass_rslt as $row)
	{
		$exp = explode(',', $row['CHALLAN_NO']);
		foreach($exp as $key=>$val)
		{
			if($val == $system_no)
			{
				$is_gate_pass = 1;
				$gate_pass_id = $row['ID'];

				$row['OUT_DATE'] = ($row['OUT_DATE']!=''?date('d-m-Y', strtotime($row['OUT_DATE'])):'');
				$row['EST_RETURN_DATE'] = ($row['EST_RETURN_DATE']!=''?date('d-m-Y', strtotime($row['EST_RETURN_DATE'])):'');
				$row['EST_RETURN_DATE'] = ($row['EST_RETURN_DATE']!=''?date('d-m-Y', strtotime($row['EST_RETURN_DATE'])):'');

				if($row['WITHIN_GROUP'] == 1)
				{
					//$row['SENT_TO'] = ($row['BASIS']==50?$buyer_dtls_arr[$row['SENT_TO']]:$supplier_dtls_arr[$row['SENT_TO']]);
					$row['SENT_TO'] = $company_library[$row['SENT_TO']];
					$row['LOCATION_NAME'] = $location_arr[$row['LOCATION_ID']];
				}

				//for gate pass info
				$gatePassDataArr[$row['CHALLAN_NO']]['gate_pass_id'] = $row['SYS_NUMBER'];
				$gatePassDataArr[$row['CHALLAN_NO']]['from_company'] = $company_library[$row['COMPANY_ID']];
				$gatePassDataArr[$row['CHALLAN_NO']]['from_location'] =$location_arr[ $row['COM_LOCATION_ID']];
				$gatePassDataArr[$row['CHALLAN_NO']]['gate_pass_date'] = date('d-m-Y', strtotime($row['OUT_DATE']));
				$gatePassDataArr[$row['CHALLAN_NO']]['returnable'] = $yes_no[$row['RETURNABLE']];
				$gatePassDataArr[$row['CHALLAN_NO']]['est_return_date'] = $row['EST_RETURN_DATE'];

				$gatePassDataArr[$row['CHALLAN_NO']]['to_company'] = $row['SENT_TO'];
				$gatePassDataArr[$row['CHALLAN_NO']]['to_location'] = $row['LOCATION_NAME'];
				$gatePassDataArr[$row['CHALLAN_NO']]['delivery_kg'] += $row['QUANTITY'];
				$gatePassDataArr[$row['CHALLAN_NO']]['delivery_bag'] += $row['NO_OF_BAGS'];

				$gatePassDataArr[$row['CHALLAN_NO']]['department'] = $department_arr[$row['DEPARTMENT_ID']];
				$gatePassDataArr[$row['CHALLAN_NO']]['attention'] = $row['ATTENTION'];
				$gatePassDataArr[$row['CHALLAN_NO']]['issue_purpose'] = $row['ISSUE_PURPOSE'];
				$gatePassDataArr[$row['CHALLAN_NO']]['remarks'] = $row['REMARKS'];
				$gatePassDataArr[$row['CHALLAN_NO']]['carried_by'] = $row['CARRIED_BY'];
				$gatePassDataArr[$row['CHALLAN_NO']]['vhicle_number'] = $row['VHICLE_NUMBER'];
				$gatePassDataArr[$row['CHALLAN_NO']]['mobile_no'] = $row['MOBILE_NO'];
				$gatePassDataArr[$row['CHALLAN_NO']]['security_lock_no'] = $row['SECURITY_LOCK_NO'];
				$gatePassDataArr[$row['CHALLAN_NO']]['driver_name'] = $row['DRIVER_NAME'];
				$gatePassDataArr[$row['CHALLAN_NO']]['driver_license_no'] = $row['DRIVER_LICENSE_NO'];
			}
		}
	}

	//for gate out
	if($gate_pass_id != '')
	{
		$sql_gate_out="SELECT OUT_DATE, OUT_TIME FROM INV_GATE_OUT_SCAN WHERE STATUS_ACTIVE = 1 AND IS_DELETED = 0 AND INV_GATE_PASS_MST_ID='".$gate_pass_id."'";
		$sql_gate_out_rslt = sql_select($sql_gate_out);
		if(!empty($sql_gate_out_rslt))
		{
			foreach($sql_gate_out_rslt as $row)
			{
				$is_gate_out = 1;
				$gatePassDataArr[$system_no]['out_date'] = date('d-m-Y', strtotime($row['OUT_DATE']));
				$gatePassDataArr[$system_no]['out_time'] = $row['OUT_TIME'];
			}
		}
	}

	// for booking no
	/*
	$sql_booking = "select a.id,b.job_no,b.booking_no from inv_issue_master a,wo_booking_mst b where a.buyer_job_no=b.job_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.id='".$data[5]."'";
	//echo $sql_booking;
	//die;
	$sql_booking_data = sql_select($sql_booking);
	$BookingNoArr = array();
	foreach($sql_booking_data as $row)
	{
		$BookingNoArr[$row[csf('job_no')]]['booking_no'] = $row[csf('booking_no')];
	}
	//var_dump($BookingNoArr);
	*/

	/*$sql_booking1 = "select job_no, booking_no from wo_booking_mst where status_active=1 and is_deleted=0 and company_id = ".$company;
	//echo $sql_booking1;
	//die;
	$sql_booking_data1 = sql_select($sql_booking1);
	$BookingNoArr1 = array();
	foreach($sql_booking_data1 as $row)
	{
		$BookingNoArr1[$row[csf('job_no')]]['booking_no'] = $row[csf('booking_no')];
	}*/
	//var_dump($BookingNoArr1);

	// for Yarn Dyeing Work Order Without Order booking no
	$sql_ydw_booking = "select a.id AS ID, a.booking_no AS YDW_YSW_NO, c.fab_booking_no AS YDW_YSW_BOOKING_NO from inv_issue_master a, wo_yarn_dyeing_mst b, wo_yarn_dyeing_dtls c where a.booking_no=b.ydw_no and b.id = c.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.id='".$data[5]."'";
	//echo $sql_ydw_booking; die;
	$sql_ydw_booking_data = sql_select($sql_ydw_booking);
	$YwdBookingNoArr = array();
	foreach($sql_ydw_booking_data as $row)
	{
		$YwdBookingNoArr[$row['YDW_YSW_NO']]['ydwbooking'] = $row['YDW_YSW_BOOKING_NO'];
	}

	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks, attention from inv_issue_master where id='".$data[5]."'";
	//echo $sql;die;
	$dataArray = sql_select($sql);
	$reqBookingNoArr = array();
	foreach($dataArray as $row)
	{
		$issue_no = $row[csf('issue_number')];
		$issue_date = $row[csf('issue_date')];
		$knit_source = $row[csf('knit_dye_source')];
		$issue_purpose = $row[csf('issue_purpose')];
		$attention = $row[csf('attention')];
		$remarks = $row[csf('remarks')];
		$inhouse_location = $row[csf('location_id')];

		//for issue to
		$issue_to = '';
		if ($row[csf('issue_purpose')] == 3)
		{
			$issue_to = $buyer_dtls_arr[$row[csf('buyer_id')]];
		}
		else if ($row[csf('issue_purpose')] == 5)
		{
			$issue_to = $supplier_dtls_arr[$row[csf('loan_party')]] ;
		}
		else
		{
			if ($row[csf('knit_dye_source')] == 1)
				$issue_to = $company_library[$row[csf('knit_dye_company')]];
			else
				$issue_to = $supplier_dtls_arr[$row[csf('knit_dye_company')]];
		}

		//for address
		$address = "";
		$addressParty = "";
		if ($row[csf('knit_dye_source')] == 3)
		{
			$nameArray = sql_select("select address_1 ,web_site, email, country_id from lib_supplier where id=".$row[csf('knit_dye_company')]."");
			foreach ($nameArray as $result)
			{
				if ($result != "")
					$address = $result[csf('address_1')];
			}
			unset($nameArray);
		}

		//for party address
		$loanPartyArray = sql_select("select address_1, web_site, email, country_id from lib_supplier where id=".$row[csf('loan_party')]."");
		foreach ($loanPartyArray as $result)
		{
			if ($result != "")
				$addressParty = $result[csf('address_1')];;
		}
		unset($loanPartyArray);

		$addressPrint = '';
		if ($row[csf('issue_purpose')] == 3)
		{
			$addressPrint = $buyer_arr[$row[csf('buyer_id')]];
		}
		else if ($row[csf('issue_purpose')] == 5)
		{
			$addressPrint = $addressParty;
		}
		else
		{
			if ($row[csf('knit_dye_source')] == 1)
			{
				$addressPrint = $company_library[$row[csf('knit_dye_company')]];
			}
			else
			{
				$addressPrint = $address;
			}
		}

		/*
		| if knitting source is out-bound subcontract then
		| address will show
		*/
		if ($row[csf('knit_dye_source')] != 3)
		{
			$addressPrint = '';
		}

		//for program no
		if( $row[csf('issue_basis')] == 3 )
		{
			$planbooking = sql_select("select b.requisition_no, e.booking_no as pln_booking_no, d.id as program_id, d.is_sales from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no = c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='".$mst_id."' ");
			foreach ($planbooking as $value)
			{
				$program_id .= $value[csf('program_id')].',';
				$reqBookingNoArr[$value[csf('requisition_no')]]['booking_no'] = $value[csf('pln_booking_no')];
				$reqBookingNoArr[$value[csf('requisition_no')]]['is_sample'] = $value[csf('is_sales')];
				$sampleBookingArr[$value[csf('pln_booking_no')]] = $value[csf('pln_booking_no')];
			}
			$program_ids = implode(",", array_unique(explode(",", chop($program_id,','))));
		}
		//echo $program_ids;
	}
	//echo "<pre>";
	//print_r($reqBookingNoArr);

	//for sample style ref. no
	$sql_sample = sql_select("SELECT a.BOOKING_NO, b.BUYER_NAME, b.STYLE_REF_NO,b.SUSTAINABILITY_STD_ID,b.FABRIC_MATERIAL_ID FROM WO_NON_ORD_SAMP_BOOKING_DTLS a, SAMPLE_DEVELOPMENT_MST b WHERE a.STYLE_ID=b.ID".where_con_using_array($sampleBookingArr, '1', 'a.BOOKING_NO'));
	$dataSampleArr = array();
	foreach($sql_sample as $row)
	{
		$dataSampleArr[$row['BOOKING_NO']]['buyer_id'] = $row['BUYER_NAME'];
		$dataSampleArr[$row['BOOKING_NO']]['style_ref_no'] = $row['STYLE_REF_NO'];
		$dataSampleArr[$row['BOOKING_NO']]['sustainability_std_id'] = $row['SUSTAINABILITY_STD_ID'];
		$dataSampleArr[$row['BOOKING_NO']]['fabric_material_id'] = $row['FABRIC_MATERIAL_ID'];
	}
	unset($sql_sample);

	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
	?>
	<style type="text/css">
		table tr td {
			font-size: 16px;
		}
		.rpt_table thead th{
			font-size: 16px;
		}
		.rpt_table tfoot th{
			font-size: 16px;
		}
	</style>
    <?php
	$data_array = sql_select("select image_location  from common_photo_library where master_tble_id='".$data[0]."' and form_name='company_details' and is_deleted=0 and file_type=1");
	$cond = "";
	if ($mst_id != "")
		$cond .= " and c.id='".$mst_id."'";

	$i = 1;
	if ($db_type == 0)
	{
		$sql_result = sql_select("SELECT a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, a.supplier_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, b.remarks
		from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
		where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
		group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, a.is_within_group, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, b.remarks");
	}
	else
	{
		$sql_result = sql_select("SELECT a.id, a.lot, a.color, a.yarn_type, a.product_name_details, a.yarn_count_id, a.yarn_comp_percent1st, a.yarn_comp_type1st, a.detarmination_id, a.supplier_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, b.remarks
		from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
		where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
		group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, a.is_within_group, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, b.remarks");
	}

	$poIdArr = array();
	$reqNoArr = array();
	foreach ($sql_result as $row)
	{
		//for po id
		$expPo = array();
		$expPo = explode(",", $row[csf('po_id')]);
		foreach ($expPo as $key=>$val)
		{
			if($val*1 > 0)
			{
				$poIdArr[$val] = $val;
			}
		}

		//for req no
		$reqNoArr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];
	}
	/*echo "<pre>";
	print_r($poIdArr);
	echo "</pre>";*/

	//for po information
	$po_array = array();
	$job_array = array();
	$costing_sql = sql_select("select a.job_no, b.file_no, b.grouping, a.style_ref_no, a.buyer_name,a.sustainability_standard,a.fab_material, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=".$company.where_con_using_array($poIdArr, '0', 'b.id'));
	foreach ($costing_sql as $row)
	{
		$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
		$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
		$po_array[$row[csf('id')]]['sustainability'] = $row[csf('sustainability_standard')];
		$po_array[$row[csf('id')]]['fab_material'] = $row[csf('fab_material')];
		$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
		$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
		$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
		$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
		$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
	}
	unset($costing_sql);
	/*echo "<pre>";
	print_r($po_array[2235]);
	echo "</pre>";*/

	//for requisition information
	$po_id_req_array = array();
	$is_sales_array = array();
	if ($db_type == 0)
	{
		$poID = " SELECT c.knit_id, c.requisition_no, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id".where_con_using_array($reqNoArr, '0', 'c.requisition_no')." group by c.knit_id,c.requisition_no, a.is_sales ";
	}
	else
	{
		$poID = "SELECT c.knit_id, c.requisition_no, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id".where_con_using_array($reqNoArr, '0', 'c.requisition_no')." group by c.knit_id, c.requisition_no, a.is_sales";
	}

	$poID_sql_result = sql_select($poID);
	$poIdArr2 = array();
	foreach ($poID_sql_result as $row)
	{
		$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
		$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
		$program_array[$row[csf('requisition_no')]] = $row[csf('knit_id')];

		//for po id
		$expPo = array();
		$expPo = explode(",", $row[csf('poid')]);
		foreach ($expPo as $key=>$val)
		{
			$poIdArr2[$val] = $val;
		}
	}
	unset($poID_sql_result);
	/*echo "<pre>";
	print_r($po_id_req_array);
	echo "</pre>";*/

	//for job information
	$job_no_array = array();
	$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst where 1=1".where_con_using_array($poIdArr2, '0', 'id'));
	foreach ($jobData as $row)
	{
		$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
		$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
		$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
	}
	unset($jobData);

	$all_req_no = "";
	$all_prod_id = "";
	$order_qnty_val_sum=0;
	$order_amount_val_sum=0;
	$no_of_bags_val_sum=0;
	$tot_return_qty = 0;
	$tot_bag = 0;
	$tot_cone = 0;
	$tot_w_bag = 0;
	$tot_w_cone = 0;
	$z = 0;
	$printDataArr = array();
	$jobNoArr = array();
	foreach ($sql_result as $row)
	{
		//for booking no
		//$row[csf('buyer_job_no')];
		/*$mainbookingNo = '';
		if($row[csf('buyer_job_no')])
		{
			$mainbookingNo = $BookingNoArr[$row[csf('buyer_job_no')]]['booking_no'];
		}
		else
		{
			$mainbookingNo = $YwdBookingNoArr[$row[csf('booking_no')]]['ydwbooking'];

			if ($row[csf('issue_basis')] == 3 && $dataArray[0][csf('issue_purpose')] == 1)
			{
				$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
				foreach ($po_id as $val)
				{
					$mainbookingNo = $BookingNoArr1[$po_array[$val]['job_no']]['booking_no'];
					//$mainbookingNo = $po_array[$val]['job_no'];
				}

				$mainbookingNo = $reqBookingNoArr[$row[csf('requisition_no')]]['booking_no'];
			}
		}*/

		$bookingNo = $row[csf('booking_no')];
		if ($row[csf('requisition_no')] != "")
		{
			if ($all_req_no == '')
				$all_req_no = $row[csf('requisition_no')];
			else
				$all_req_no .= ',' . $row[csf('requisition_no')];

			if ($all_prod_id == '')
				$all_prod_id = $row[csf('po_id')];
			else
				$all_prod_id .= ',' . $row[csf('po_id')];
		}
		$order_qnty_val = $row[csf('cons_quantity')];
		$order_qnty_val_sum += $order_qnty_val;

		$order_amount_val = $row[csf('order_amount')];
		$order_amount_val_sum += $order_amount_val;

		$no_of_bags_val = $row[csf('no_of_bags')];
		$no_of_bags_val_sum += $no_of_bags_val;

		$po_id = explode(",", $row[csf('po_id')]);
		$po_no = "";
		$style_ref = "";
		$job_no = "";
		$buyer = "";
		$sustainability = "";
		$material = "";
		$fab_material=array(1=>"Organic",2=>"BCI");
			//$data=explode('*',$data);
		$productdtls = $row[csf('product_name_details')];
		$productArr = explode(' ', $productdtls);

		$proddtls = "";
		if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
		}
		else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
		}
		else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
		}
		else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
		}
		else if ($productArr[0] != '' && $productArr[1] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1];
		}
		else if ($productArr[0] != '')
		{
			$proddtls = $productArr[0];
		}
		else
		{
			$proddtls = "";
		}

		$internal_ref = "";
		$file_no = "";

		if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
		{
			foreach ($po_id as $val)
			{
				if ($po_no == '')
					$po_no = $po_array[$val]['no'];
				else
					$po_no .= ", " . $po_array[$val]['no'];

				if ($job_no == '')
				{
					$job_no = $po_array[$val]['job_no'];

					if($job_no != '')
					{
						$jobNoArr[$job_no] = $job_no;
					}
				}

				if ($sustainability  == '')
					$sustainability  = $po_array[$val]['sustainability'];

				if ($material   == '')
					$material  = $po_array[$val]['fab_material'];

				if ($style_ref == '')
				{
					if($knit_source==3 && $show_val_column==0 && $dataArray[0][csf('issue_purpose')] != 8)
					{
						$style_ref = 'WHS';
					}
					else
					{
						$style_ref = $po_array[$val]['style_ref'];
					}
					//$style_ref = $po_array[$val]['style_ref'];
				}


				if ($buyer == '')
					$buyer_name = $po_array[$val]['buyer_name'];

				if ($internal_ref == '')
					$internal_ref = $po_array[$val]['grouping'];
				else
					$internal_ref .= "," . $po_array[$val]['grouping'];

				if ($file_no == '')
					$file_no = $po_array[$val]['file_no'];
				else
					$file_no .= "," . $po_array[$val]['file_no'];
			}

			$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
			$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

			$ref_cond = "";
			foreach ($job_ref as $ref) {
				if ($ref_cond == '')
					$ref_cond = $ref;
				else
					$ref_cond .= ", " . $ref;
			}

			$file_con = "";
			foreach ($job_file as $file)
			{
				if ($file_con == '')
					$file_cond = $file;
				else
					$file_cond .= ", " . $file;
			}

			$buyer_job = "";
			if ($row[csf('issue_basis')] == 1)
			{
				if ($dataArray[0][csf('issue_purpose')] == 8 )
				{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS';
						}
						else
						{
							$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
						}

						//$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
				}
				else
				{
					$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
					if ($row[csf('buyer_job_no')] != "")
					{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS' . '::' . $row[csf('buyer_job_no')];
						}
						else
						{
							$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . '::' . $row[csf('buyer_job_no')];
						}
						//$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . '::' . $row[csf('buyer_job_no')];

						if($buyer_job != '')
						{
							$jobNoArr[$row[csf('buyer_job_no')]] = $row[csf('buyer_job_no')];
						}
					}
					else
					{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS';
						}
						else
						{
							$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
						}
					}
				}

				//for ydw and ysw booking no
				if ($dataArray[0][csf('issue_purpose')] == 2 || $dataArray[0][csf('issue_purpose')] == 7 || $dataArray[0][csf('issue_purpose')] == 12 || $dataArray[0][csf('issue_purpose')] == 15 || $dataArray[0][csf('issue_purpose')] == 38 || $dataArray[0][csf('issue_purpose')] == 46 || $dataArray[0][csf('issue_purpose')] == 50 || $dataArray[0][csf('issue_purpose')] == 51)
				{
					$bookingNo = $YwdBookingNoArr[$row[csf('booking_no')]]['ydwbooking'];
				}
			}
			else if ($row[csf('issue_basis')] == 2)
			{
				$buyer_job = "";
			}

		}
		else if ($row[csf('issue_basis')] == 3)
		{
			//for booking no
			$bookingNo = $reqBookingNoArr[$row[csf('requisition_no')]]['booking_no'];
			$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
			//print_r($ex_data);

			if ($is_sales_array[$row[csf('requisition_no')]] == 1)
			{
				$buyer_job = "";
				foreach (array_unique($po_id) as $val)
				{
					if ($po_no == "")
						$po_no = $job_no_array[$val]['job_no'];
					else
						$po_no .= ", " . $job_no_array[$val]['job_no'];

					if ($style_ref == "")
						$style_ref = $job_no_array[$val]['style_ref'];

					if ($sustainability  == '')
						$sustainability  = $po_array[$val]['sustainability'];

					if ($material   == '')
						$material  = $po_array[$val]['fab_material'];

					if ($buyer_job == "") {
						if ($job_no_array[$val]['within_group'] == 1)
						{
							$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
						}
						else
						{
							$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
						}
					}

					if ($job_no_array[$val]['within_group'] != 1)
					{
						$ref_cond = "";
					}
				}
			}
			else
			{
				foreach ($po_id as $val)
				{
					if ($po_no == "")
						$po_no = $po_array[$val]['no'];
					else
						$po_no .= ", " . $po_array[$val]['no'];

					if ($job_no == "")
					{
						$job_no = $po_array[$val]['job_no'];


						if($job_no != '')
						{
							$jobNoArr[$job_no] = $job_no;
						}
					}

					if ($style_ref == "")
					{
						if($knit_source==3 && $show_val_column==0)
						{
							$style_ref = 'WHS';
						}
						else
						{
							$style_ref = $po_array[$val]['style_ref'];
						}
						//$style_ref = $po_array[$val]['style_ref'];
					}


					if ($sustainability  == '')
						$sustainability  = $po_array[$val]['sustainability'];

					if ($material   == '')
						$material  = $po_array[$val]['fab_material'];

					if ($buyer == "")
						$buyer_name = $po_array[$val]['buyer_name'];

					if ($internal_ref == "")
						$internal_ref = $po_array[$val]['grouping'];
					else
						$internal_ref .= "," . $po_array[$val]['grouping'];

					if ($file_no == "")
						$file_no = $po_array[$val]['file_no'];
					else
						$file_no .= "," . $po_array[$val]['file_no'];
				}

				$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
				$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

				$ref_cond = "";
				foreach ($job_ref as $ref)
				{
					if ($ref_cond == "") $ref_cond = $ref; else $ref_cond .= ", " . $ref;
				}

				$file_con = "";
				foreach ($job_file as $file)
				{
					if ($file_con == "")
						$file_cond = $file;
					else
						$file_cond .= ", " . $file;
				}

				if ($job_no != "")
				{
					if($knit_source==3 && $show_val_column==0)
					{
						$buyer_job = 'WHS' . '::' . $job_no;
					}
					else
					{
						$buyer_job = $buyer_arr[$buyer_name] . '::' . $job_no;
					}

					$jobNoArr[$job_no] = $job_no;
				}
				else
				{
					$buyer_job = $buyer_arr[$buyer_name];
				}
			}

			//for sample
			if($reqBookingNoArr[$row[csf('requisition_no')]]['is_sample'] == 2)
			{
				$buyer_job = $buyer_arr[$dataSampleArr[$bookingNo]['buyer_id']];
				$style_ref = $dataSampleArr[$bookingNo]['style_ref_no'];
				$sustainability = $dataSampleArr[$bookingNo]['sustainability_std_id'];
				$material = $dataSampleArr[$bookingNo]['fabric_material_id'];
			}
		}
		else
		{
			foreach (array_unique($po_id) as $val)
			{
				if ($po_no == "")
					$po_no = $job_no_array[$val]['job_no'];
				else
					$po_no .= ", " . $job_no_array[$val]['job_no'];

				if ($style_ref == "")
					$style_ref = $job_no_array[$val]['style_ref'];


				if ($buyer_job == "")
				{
					if ($job_no_array[$val]['within_group'] == 1)
					{
						$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
					}
					else
					{
						$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
					}
				}
			}
		}

		$no_bag_cone = "";
		$wt_bag_cone = "";
		if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0)
			$no_bag_cone = 'N:' . $no_of_bags_val;
		else
			$no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

		if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0)
			$wt_bag_cone = 'W:' . $row[csf('weight_per_bag')];
		else
			$wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];

		//for buyer job and style
		$buyer_job_style = $buyer_job.($style_ref != ''?'::'.$style_ref:'');
		$req_no = ($row[csf('requisition_no')] != 0 ? $row[csf('requisition_no')]:'');
		$item_description = $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];

		//for print data
		$z++;
		//$printDataArr[$z]['buyer_job_style'] = $buyer_job.($style_ref != ''?'::'.$style_ref:'').($mainbookingNo != ''?'::'.$mainbookingNo:'').($sustainability*1 != ''?'::'.$sustainability_standard[$sustainability]:'').($material*1 != ''?'::'.$fab_material[$material]:'');
		$printDataArr[$z]['buyer_job_style'] = $buyer_job.($style_ref != ''?'::'.$style_ref:'').($bookingNo != ''?'::'.$bookingNo:'').($sustainability*1 != ''?'::'.$sustainability_standard[$sustainability]:'').($material*1 != ''?'::'.$fab_material[$material]:'');
		$printDataArr[$z]['req_no'] = ($row[csf('requisition_no')] != 0 ? $row[csf('requisition_no')]:$row[csf('booking_no')]);
		$printDataArr[$z]['prog_no'] = $program_array[$row[csf('requisition_no')]];
		$printDataArr[$z]['lot'] = $row[csf('lot')];
		$printDataArr[$z]['yarn_type'] = $row[csf('yarn_type')];
		$printDataArr[$z]['item_description'] = $item_description;
		$printDataArr[$z]['dyeing_color_id'] = $row[csf('dyeing_color_id')];
		$printDataArr[$z]['color_id'] = $row[csf('color')];

		//for supplier
		//$printDataArr[$z]['supplier_id'] = $row[csf('supplier_id')];
		if($row[csf('is_within_group')] == 1)
		{
			$supplier_name = $company_arr[$row[csf('supplier_id')]];
		}
		else
		{
			$supplier_name = $supplier_arr[$row[csf('supplier_id')]];
		}
		$printDataArr[$z]['supplier_id'] = $supplier_name;

		$printDataArr[$z]['cons_quantity'] = $row[csf('cons_quantity')];
		$printDataArr[$z]['returnable_qnty'] = $row[csf('returnable_qnty')];
		$printDataArr[$z]['no_bag_cone'] = $no_bag_cone;
		$printDataArr[$z]['wt_bag_cone'] = $wt_bag_cone;
		$printDataArr[$z]['store_id'] = $row[csf('store_id')];
		$printDataArr[$z]['po_no'] = $po_no;
		$printDataArr[$z]['remarks'] = $row[csf('remarks')];

		$printDataArr[$z]['no_of_bags_val'] = $no_of_bags_val;
		$printDataArr[$z]['cone_per_bag'] = $row[csf('cone_per_bag')];
		$printDataArr[$z]['weight_per_bag'] = $row[csf('weight_per_bag')];
		$printDataArr[$z]['weight_per_cone'] = $row[csf('weight_per_cone')];
	}

	$noOfCopy = "";
	for ($x = 1; $x <= $no_copy; $x++)
	{
		if($x==1)
		{
			$sup = 'st';
		}
		else if($x==2)
		{
			$sup = 'nd';
		}
		else if($x==3)
		{
			$sup = 'rd';
		}
		else
		{
			$sup = 'th';
		}

		$noOfCopy ="<span style='font-size:x-large;font-weight:bold'>".$x."<sup>".$sup."</sup> Copy</span>";
		?>


		<div style="width:1020px;">
			<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row)
						{
							if ($data[5] != 1)
							{
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50' align="middle"/>
								<?
							}
							else
							{
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50' align="middle"/>
								<?
							}
						}
						?>
					</td>
                    <td align="center" style="font-size:30px" colspan="6"><strong><? echo $com_dtls[0]."<br><span style=\"font-size:14px;\">".$com_dtls[1]."</span>"; ?></strong></td>
					<td width="110" align="right"><?php echo $noOfCopy.($is_gate_pass==1?"<br><span style=\"color:#F00;font-weight:bold;\">Gate Pass Done</span>":'').($is_gate_out==1?"<br><span style=\"color:#F00;font-weight:bold;\">Gate Out Done</span>":''); ?></td>
				</tr>
				<tr>
					<td colspan="6" align="center" height="50" valign="middle" style="font-size:25px">
						<strong><u>Yarn Delivery Challan</u></strong>
						<?php
						if ($data[4] == 1)
						{

							?>
							<span style="color:#0F0; font-weight:bold;">[Approved]</span>
							<?php
						}
						?>
					</td>
				</tr>
			</table>
			<br>
            <table style="margin-right:-40px;" cellspacing="0" width="1020" border="1" rules="all" class="rpt_table">
				<tr>
					<td width="70"><strong>Issue No:</strong></td>
					<td width="260px"><? echo $issue_no; ?></td>
					<td width="80"><strong>Issue Date:</strong></td>
					<td width="260px"><? echo change_date_format($issue_date); ?></td>
					<td width="120"><strong>Knitting Source:</strong></td>
					<td><? echo $knitting_source[$knit_source]; ?></td>
				</tr>
				<tr>
					<td><strong>Issue To:</strong></td>
					<td><? echo $issue_to; ?></td>
					<td><strong>Address:</strong></td>
					<td><? echo $addressPrint; ?></td>
					<td><strong>Issue Purpose:</strong></td>
					<td><? echo $yarn_issue_purpose[$issue_purpose]; ?></td>
				</tr>
				<tr>
					<td><strong>Location:</strong></td>
					<td><? echo $location_arr[$inhouse_location]; ?></td>
					<td><strong>Attention:</strong></td>
					<td><? echo $attention; ?></td>
					<td><strong>Remarks:</strong></td>
					<td><? echo $remarks; ?></td>
				</tr>
				<tr>
					<td align="center" colspan="6" id="barcode_img_id_<?php echo $x; ?>" height="50" valign="middle" style="border-left:hidden;border-right:hidden;border-bottom:hidden;"></td>
				</tr>
			</table>
			<div style="width:100%;">
				<div style="clear:both;">
					<table style="margin-right:-40px;" cellspacing="0" width="1000" border="1" rules="all" class="rpt_table">
						<thead bgcolor="#dddddd">
							<th width="20">SL</th>
							<th width="100">Buyer, Job, Style and Booking</th>
							<th width="45">Req. No/Work Order</th>
							<th width="50">Knitting Prog. No</th>
							<th width="50">Lot No</th>
							<th width="65">Yarn Type</th>
							<th width="110">Item Details</th>
							<th width="65">Dye. Color</th>
							<th width="60">Color</th>
							<th width="60">Supp.</th>
							<th width="60">Issue Qty(kg)</th>
							<th width="60">Rtnbl Qty(kg)</th>
							<th width="60">Bag & Cone</th>
							<th width="100">Order/PO</th>
							<th width="60">Store</th>
							<th>Remarks</th>
						</thead>
                        <tbody>
						<?
						$i= 0;
						foreach($printDataArr as $key=>$val)
						{
							$i++;
							if ($i % 2 == 0)
								$bgcolor = "#E9F3FF";
							else
								$bgcolor = "#FFFFFF";
							?>
                            <tr bgcolor="<? echo $bgcolor; ?>">
                                <td><? echo $i; ?></td>
                                <td>
                                    <div style="word-wrap:break-word; width:100px"><? echo $val['buyer_job_style']; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:45px"><? echo $val['req_no']; ?></div>
                                </td>
                                <td>
                                    <?  echo $val['prog_no']; ?>
                                </td>
                                <td width="50">
                                    <div style="word-wrap:break-word; width:50px"><? echo $val['lot']; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$val['yarn_type']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:110px">
                                        <? echo $val['item_description']; ?>
                                    </div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$val['dyeing_color_id']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $color_name_arr[$val['color_id']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $val['supplier_id']; ?></div>
                                </td>
                                <td align="right"><? echo number_format($val['cons_quantity'], 2, '.', ''); ?></td>
                                <td align="right"><? echo number_format($val['returnable_qnty'], 2, '.', ''); ?></td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $val['no_bag_cone'] . '<br>' . $val['wt_bag_cone'] ?>&nbsp;</div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:100px; font-size:12px;"><? echo $val['po_no']; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $store_arr[$val['store_id']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:80px"><? echo $val['remarks']; ?></div>
                                </td>
                            </tr>
							<?
							$uom_unit = "Kg";
							$uom_gm = "Grams";
							$tot_return_qty += $val['returnable_qnty'];
							$tot_bag += $val['no_of_bags_val'];
							$tot_cone += $val['cone_per_bag'];
							$tot_w_bag += $val['weight_per_bag'];
							$tot_w_cone += $val['weight_per_cone'];
						}
						?>
						<tr bgcolor="#CCCCCC" style="font-size:16px">
							<td colspan="2"><b>Total Job:
                            <?php
							if(!empty($jobNoArr))
							{
                           		echo " ".count($jobNoArr);
							}
							?>
                            </b></td>
							<td align="right" colspan="8"><b>Total</b></td>
							<td align="right">
								<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 2, '.', ''); ?></b>
							</td>
							<td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
							<td><? echo 'N:' . number_format($tot_bag, 2);
							if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
							echo '<br>W:' . number_format($tot_w_bag, 2);
							if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
							<td align="right" colspan="4">&nbsp;</td>
						</tr>
						<tr>
							<td colspan="16" align="left"><b>In
							Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
						</tr>
                        <tr>
                        	<td colspan="16" height="30" style="border-left:hidden;border-right:hidden;">&nbsp;</td>
                        </tr>
                        <tr>
                        	<td colspan="8" align="center" valign="middle" style="font-size:25px;"><strong>&lt;&lt;Gate Pass&gt;&gt;</strong></td>
                            <td colspan="8" align="center" valign="middle" id="gate_pass_barcode_img_id_<?php echo $x; ?>" height="50"></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>From Company:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['from_company']; ?></td>
                        	<td colspan="2"><strong>To Company:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['to_company']; ?></td>
                        	<td colspan="3"><strong>Carried By:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['carried_by']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>From Location:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['from_location']; ?></td>
                        	<td colspan="2"><strong>To Location:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['to_location']; ?></td>
                        	<td colspan="3"><strong>Driver Name:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['driver_name']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Gate Pass ID:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['gate_pass_id']; ?></td>
                        	<td colspan="2" rowspan="2"><strong>Delivery Qnty</strong></td>
                        	<td align="center"><strong>Kg</strong></td>
                        	<td align="center" colspan="2"><strong>Bag</td>
                        	<td colspan="3"><strong>Vehicle Number:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['vhicle_number']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Gate Pass Date:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['gate_pass_date']; ?></td>
                        	<td align="center"><?php echo $gatePassDataArr[$system_no]['delivery_kg']; ?></td>
                        	<td align="center" colspan="2"><?php echo $gatePassDataArr[$system_no]['delivery_bag']; ?></td>
                        	<td colspan="3"><strong>Driver License No.:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['driver_license_no']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Out Date:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['out_date']; ?></td>
                        	<td colspan="2"><strong>Dept. Name:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['department']; ?></td>
                        	<td colspan="3"><strong>Mobile No.:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['mobile_no']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Out Time:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['out_time']; ?></td>
                        	<td colspan="2"><strong>Attention:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['attention']; ?></td>
                        	<td colspan="3"><strong>Sequrity Lock No.:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['security_lock_no']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Returnable:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['returnable']; ?></td>
                        	<td colspan="2"><strong>Purpose:</strong></td>
                        	<td colspan="9"><?php echo $gatePassDataArr[$system_no]['issue_purpose']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Est. Return Date:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['est_return_date']; ?></td>
                        	<td colspan="2"><strong>Remarks:</strong></td>
                        	<td colspan="9"><?php echo $gatePassDataArr[$system_no]['remarks']; ?></td>
                        </tr>
                    </tbody>
                    </table>
				</div>
				<br>
				<? echo signature_table(49, $company, "1000px"); ?>
			</div>
		</div>
		<script type="text/javascript" src="../../js/jquery.js"></script>
        <script type="text/javascript" src="../../js/jquerybarcode.js"></script>
		<script>
			function generateBarcode(valuess)
			{
				var zs = '<?php echo $x; ?>';
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id_"+zs).html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id_"+zs).show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');

			//for gate pass barcode
			function generateBarcodeGatePass(valuess)
			{
				var zs = '<?php echo $x; ?>';
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#gate_pass_barcode_img_id_"+zs).html('11');
				value = {code: value, rect: false};
				$("#gate_pass_barcode_img_id_"+zs).show().barcode(value, btype, settings);
			}

			if('<? echo $gatePassDataArr[$system_no]['gate_pass_id']; ?>' != '')
			{
				generateBarcodeGatePass('<? echo strtoupper($gatePassDataArr[$system_no]['gate_pass_id']); ?>');
			}
		</script>
        <div style="page-break-after:always;"></div>
    <?php
	}
    exit();
}

if ($action == "yarn_issue_print17_04082021")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print-10", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$company   = $data[0];
	$system_no = $data[1];
	$report_title = $data[2];
	$booking_id = $data[3];
	$is_approved = $data[4];
	$mst_id     = $data[5];
	$show_val_column = $data[6];
	$print_with_vat = $data[7];
	$location  = $data[8];
	$store_id = $data[9];
	$no_copy = $data[10];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$department_arr = return_library_array("select id, department_name from lib_department", "id", "department_name");

	//for buyer
	$sqlBuyer = sql_select("select id as ID, buyer_name as BUYER_NAME, short_name as SHORT_NAME from lib_buyer");
	foreach($sqlBuyer as $row)
	{
		$buyer_arr[$row['ID']] = $row['SHORT_NAME'];
		$buyer_dtls_arr[$row['ID']] = $row['BUYER_NAME'];
	}
	unset($sqlBuyer);

	//for supplier
	$sqlSupplier = sql_select("select id as ID, supplier_name as SUPPLIER_NAME, short_name as SHORT_NAME from lib_supplier");
	foreach($sqlSupplier as $row)
	{
		$supplier_arr[$row['ID']] = $row['SHORT_NAME'];
		$supplier_dtls_arr[$row['ID']] = $row['SUPPLIER_NAME'];
	}
	unset($sqlSupplier);

	//for gate pass
	$sql_get_pass = "SELECT a.ID, a.SYS_NUMBER, a.BASIS, a.COMPANY_ID, a.GET_PASS_NO, a.DEPARTMENT_ID, a.ATTENTION, a.SENT_BY, a.WITHIN_GROUP, a.SENT_TO, a.CHALLAN_NO, a.OUT_DATE, a.TIME_HOUR, a.TIME_MINUTE, a.RETURNABLE, a.DELIVERY_AS, a.EST_RETURN_DATE, a.INSERTED_BY, a.CARRIED_BY, a.LOCATION_ID, a.COM_LOCATION_ID, a.VHICLE_NUMBER, a.LOCATION_NAME, a.REMARKS, a.DO_NO, a.MOBILE_NO, a.ISSUE_ID, a.RETURNABLE_GATE_PASS_REFF, a.DELIVERY_COMPANY, a.ISSUE_PURPOSE,a.SECURITY_LOCK_NO,a.DRIVER_NAME,a.DRIVER_LICENSE_NO, b.QUANTITY, b.NO_OF_BAGS FROM inv_gate_pass_mst a, INV_GATE_PASS_DTLS b WHERE a.id = b.mst_id AND a.company_id = ".$company." AND a.basis = 2 AND a.STATUS_ACTIVE = 1 AND a.IS_DELETED = 0 AND a.challan_no LIKE '".$system_no."%'";
	//echo $sql_get_pass;
	$sql_get_pass_rslt = sql_select($sql_get_pass);
	$is_gate_pass = 0;
	$is_gate_out = 0;
	$gate_pass_id = '';
	$gatePassDataArr = array();
	foreach($sql_get_pass_rslt as $row)
	{
		$exp = explode(',', $row['CHALLAN_NO']);
		foreach($exp as $key=>$val)
		{
			if($val == $system_no)
			{
				$is_gate_pass = 1;
				$gate_pass_id = $row['ID'];

				$row['OUT_DATE'] = ($row['OUT_DATE']!=''?date('d-m-Y', strtotime($row['OUT_DATE'])):'');
				$row['EST_RETURN_DATE'] = ($row['EST_RETURN_DATE']!=''?date('d-m-Y', strtotime($row['EST_RETURN_DATE'])):'');
				$row['EST_RETURN_DATE'] = ($row['EST_RETURN_DATE']!=''?date('d-m-Y', strtotime($row['EST_RETURN_DATE'])):'');

				if($row['WITHIN_GROUP'] == 1)
				{
					//$row['SENT_TO'] = ($row['BASIS']==50?$buyer_dtls_arr[$row['SENT_TO']]:$supplier_dtls_arr[$row['SENT_TO']]);
					$row['SENT_TO'] = $company_library[$row['SENT_TO']];
					$row['LOCATION_NAME'] = $location_arr[$row['LOCATION_ID']];
				}

				//for gate pass info
				$gatePassDataArr[$row['CHALLAN_NO']]['gate_pass_id'] = $row['SYS_NUMBER'];
				$gatePassDataArr[$row['CHALLAN_NO']]['from_company'] = $company_library[$row['COMPANY_ID']];
				$gatePassDataArr[$row['CHALLAN_NO']]['from_location'] =$location_arr[ $row['COM_LOCATION_ID']];
				$gatePassDataArr[$row['CHALLAN_NO']]['gate_pass_date'] = date('d-m-Y', strtotime($row['OUT_DATE']));
				$gatePassDataArr[$row['CHALLAN_NO']]['returnable'] = $yes_no[$row['RETURNABLE']];
				$gatePassDataArr[$row['CHALLAN_NO']]['est_return_date'] = $row['EST_RETURN_DATE'];

				$gatePassDataArr[$row['CHALLAN_NO']]['to_company'] = $row['SENT_TO'];
				$gatePassDataArr[$row['CHALLAN_NO']]['to_location'] = $row['LOCATION_NAME'];
				$gatePassDataArr[$row['CHALLAN_NO']]['delivery_kg'] += $row['QUANTITY'];
				$gatePassDataArr[$row['CHALLAN_NO']]['delivery_bag'] += $row['NO_OF_BAGS'];

				$gatePassDataArr[$row['CHALLAN_NO']]['department'] = $department_arr[$row['DEPARTMENT_ID']];
				$gatePassDataArr[$row['CHALLAN_NO']]['attention'] = $row['ATTENTION'];
				$gatePassDataArr[$row['CHALLAN_NO']]['issue_purpose'] = $row['ISSUE_PURPOSE'];
				$gatePassDataArr[$row['CHALLAN_NO']]['remarks'] = $row['REMARKS'];
				$gatePassDataArr[$row['CHALLAN_NO']]['carried_by'] = $row['CARRIED_BY'];
				$gatePassDataArr[$row['CHALLAN_NO']]['vhicle_number'] = $row['VHICLE_NUMBER'];
				$gatePassDataArr[$row['CHALLAN_NO']]['mobile_no'] = $row['MOBILE_NO'];
				$gatePassDataArr[$row['CHALLAN_NO']]['security_lock_no'] = $row['SECURITY_LOCK_NO'];
				$gatePassDataArr[$row['CHALLAN_NO']]['driver_name'] = $row['DRIVER_NAME'];
				$gatePassDataArr[$row['CHALLAN_NO']]['driver_license_no'] = $row['DRIVER_LICENSE_NO'];
			}
		}
	}

	//for gate out
	if($gate_pass_id != '')
	{
		$sql_gate_out="SELECT OUT_DATE, OUT_TIME FROM INV_GATE_OUT_SCAN WHERE STATUS_ACTIVE = 1 AND IS_DELETED = 0 AND INV_GATE_PASS_MST_ID='".$gate_pass_id."'";
		$sql_gate_out_rslt = sql_select($sql_gate_out);
		if(!empty($sql_gate_out_rslt))
		{
			foreach($sql_gate_out_rslt as $row)
			{
				$is_gate_out = 1;
				$gatePassDataArr[$system_no]['out_date'] = date('d-m-Y', strtotime($row['OUT_DATE']));
				$gatePassDataArr[$system_no]['out_time'] = $row['OUT_TIME'];
			}
		}
	}

	// for booking no
	$sql_booking = "select a.id,b.job_no,b.booking_no from inv_issue_master a,wo_booking_mst b where a.buyer_job_no=b.job_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.id='".$data[5]."'";
	//echo $sql_booking;die;
	$sql_booking_data = sql_select($sql_booking);
	$BookingNoArr = array();
	foreach($sql_booking_data as $row)
	{
		$BookingNoArr[$row[csf('job_no')]]['booking_no'] = $row[csf('booking_no')];
	}
	//var_dump($BookingNoArr);

	$sql_booking1 = "select job_no,booking_no from wo_booking_mst where status_active=1 and is_deleted=0 and company_id = ".$company."";
	//echo $sql_booking1;die;
	$sql_booking_data1 = sql_select($sql_booking1);
	$BookingNoArr1 = array();
	foreach($sql_booking_data1 as $row)
	{
		$BookingNoArr1[$row[csf('job_no')]]['booking_no'] = $row[csf('booking_no')];
	}
	//var_dump($BookingNoArr1);

	// for Yarn Dyeing Work Order Without Order booking no
	$sql_ydw_booking = "select a.id,a.booking_no,c.booking_no as ydwbooking from inv_issue_master a,wo_yarn_dyeing_mst b,wo_yarn_dyeing_dtls c where a.booking_no=b.ydw_no and b.id = c.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.id='".$data[5]."'";
	//echo $sql_ydw_booking;die;
	$sql_ydw_booking_data = sql_select($sql_ydw_booking);
	$YwdBookingNoArr = array();
	foreach($sql_ydw_booking_data as $row)
	{
		$YwdBookingNoArr[$row[csf('booking_no')]]['ydwbooking'] = $row[csf('ydwbooking')];
	}
	//var_dump($YwdBookingNoArr);

	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks, attention from inv_issue_master where id='".$data[5]."'";
	//echo $sql;die;
	$dataArray = sql_select($sql);
	$reqBookingNoArr = array();
	foreach($dataArray as $row)
	{
		$issue_no = $row[csf('issue_number')];
		$issue_date = $row[csf('issue_date')];
		$knit_source = $row[csf('knit_dye_source')];
		$issue_purpose = $row[csf('issue_purpose')];
		$attention = $row[csf('attention')];
		$remarks = $row[csf('remarks')];
		$inhouse_location = $row[csf('location_id')];

		//for issue to
		$issue_to = '';
		if ($row[csf('issue_purpose')] == 3)
		{
			$issue_to = $buyer_dtls_arr[$row[csf('buyer_id')]];
		}
		else if ($row[csf('issue_purpose')] == 5)
		{
			$issue_to = $supplier_dtls_arr[$row[csf('loan_party')]] ;
		}
		else
		{
			if ($row[csf('knit_dye_source')] == 1)
				$issue_to = $company_library[$row[csf('knit_dye_company')]];
			else
				$issue_to = $supplier_dtls_arr[$row[csf('knit_dye_company')]];
		}

		//for address
		$address = "";
		$addressParty = "";

		if ($row[csf('knit_dye_source')] == 3)
		{
			$nameArray = sql_select("select address_1 ,web_site, email, country_id from lib_supplier where id=".$row[csf('knit_dye_company')]."");
			foreach ($nameArray as $result)
			{
				if ($result != "")
					$address = $result[csf('address_1')];
			}
			unset($nameArray);
		}

		//for party address
		$loanPartyArray = sql_select("select address_1, web_site, email, country_id from lib_supplier where id=".$row[csf('loan_party')]."");
		foreach ($loanPartyArray as $result)
		{
			if ($result != "")
				$addressParty = $result[csf('address_1')];;
		}
		unset($loanPartyArray);

		$addressPrint = '';
		if ($row[csf('issue_purpose')] == 3)
		{
			$addressPrint = $buyer_arr[$row[csf('buyer_id')]];
		}
		else if ($row[csf('issue_purpose')] == 5)
		{
			$addressPrint = $addressParty;
		}
		else
		{
			if ($row[csf('knit_dye_source')] == 1)
			{
				$addressPrint = $company_library[$row[csf('knit_dye_company')]];
			}
			else
			{
				$addressPrint = $address;
			}
		}

		/*
		| if knitting source is out-bound subcontract then
		| address will show
		*/
		if ($row[csf('knit_dye_source')] != 3)
		{
			$addressPrint = '';
		}

		//for program no
		if( $row[csf('issue_basis')] == 3 )
		{
			$planbooking = sql_select("select b.requisition_no, e.booking_no as pln_booking_no, d.id as program_id, d.is_sales from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no = c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='".$mst_id."' ");
			foreach ($planbooking as $value)
			{
				$program_id .= $value[csf('program_id')].',';
				$reqBookingNoArr[$value[csf('requisition_no')]]['booking_no'] = $value[csf('pln_booking_no')];
				$reqBookingNoArr[$value[csf('requisition_no')]]['is_sample'] = $value[csf('is_sales')];
				$sampleBookingArr[$value[csf('pln_booking_no')]] = $value[csf('pln_booking_no')];
			}
			$program_ids = implode(",", array_unique(explode(",", chop($program_id,','))));
		}
		//echo $program_ids;
	}
	//echo "<pre>";
	//print_r($reqBookingNoArr);

	//for sample style ref. no
	$sql_sample = sql_select("SELECT a.BOOKING_NO, b.BUYER_NAME, b.STYLE_REF_NO,b.SUSTAINABILITY_STD_ID,b.FABRIC_MATERIAL_ID FROM WO_NON_ORD_SAMP_BOOKING_DTLS a, SAMPLE_DEVELOPMENT_MST b WHERE a.STYLE_ID=b.ID".where_con_using_array($sampleBookingArr, '1', 'a.BOOKING_NO'));
	$dataSampleArr = array();
	foreach($sql_sample as $row)
	{
		$dataSampleArr[$row['BOOKING_NO']]['buyer_id'] = $row['BUYER_NAME'];
		$dataSampleArr[$row['BOOKING_NO']]['style_ref_no'] = $row['STYLE_REF_NO'];
		$dataSampleArr[$row['BOOKING_NO']]['sustainability_std_id'] = $row['SUSTAINABILITY_STD_ID'];
		$dataSampleArr[$row['BOOKING_NO']]['fabric_material_id'] = $row['FABRIC_MATERIAL_ID'];
	}
	unset($sql_sample);

	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
	?>
	<style type="text/css">
		table tr td {
			font-size: 16px;
		}
		.rpt_table thead th{
			font-size: 16px;
		}
		.rpt_table tfoot th{
			font-size: 16px;
		}
	</style>
    <?php
	$data_array = sql_select("select image_location  from common_photo_library where master_tble_id='".$data[0]."' and form_name='company_details' and is_deleted=0 and file_type=1");
	$cond = "";
	if ($mst_id != "")
		$cond .= " and c.id='".$mst_id."'";

	$i = 1;
	if ($db_type == 0)
	{
		$sql_result = sql_select("SELECT a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, b.remarks
		from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
		where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
		group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, b.remarks");
	}
	else
	{
		$sql_result = sql_select("SELECT a.id, a.lot, a.color, a.yarn_type, a.product_name_details, a.yarn_count_id, a.yarn_comp_percent1st, a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, b.remarks
		from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
		where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
		group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, b.remarks");
	}

	$poIdArr = array();
	$reqNoArr = array();
	foreach ($sql_result as $row)
	{
		//for po id
		$expPo = array();
		$expPo = explode(",", $row[csf('po_id')]);
		foreach ($expPo as $key=>$val)
		{
			$poIdArr[$val] = $val;
		}

		//for req no
		$reqNoArr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];
	}

	//for po information
	$po_array = array();
	$job_array = array();
	$costing_sql = sql_select("select a.job_no, b.file_no, b.grouping, a.style_ref_no, a.buyer_name,a.sustainability_standard,a.fab_material, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=".$company.where_con_using_array($poIdArr, '0', 'b.id'));
	foreach ($costing_sql as $row)
	{
		$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
		$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
		$po_array[$row[csf('id')]]['sustainability'] = $row[csf('sustainability_standard')];
		$po_array[$row[csf('id')]]['fab_material'] = $row[csf('fab_material')];
		$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
		$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
		$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
		$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
		$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
	}
	unset($costing_sql);

	//for requisition information
	$po_id_req_array = array();
	$is_sales_array = array();
	if ($db_type == 0)
	{
		$poID = " SELECT c.knit_id, c.requisition_no, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id".where_con_using_array($reqNoArr, '0', 'c.requisition_no')." group by c.knit_id,c.requisition_no, a.is_sales ";
	}
	else
	{
		$poID = "SELECT c.knit_id, c.requisition_no, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id".where_con_using_array($reqNoArr, '0', 'c.requisition_no')." group by c.knit_id, c.requisition_no, a.is_sales";
	}

	$poID_sql_result = sql_select($poID);
	$poIdArr2 = array();
	foreach ($poID_sql_result as $row)
	{
		$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
		$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
		$program_array[$row[csf('requisition_no')]] = $row[csf('knit_id')];

		//for po id
		$expPo = array();
		$expPo = explode(",", $row[csf('poid')]);
		foreach ($expPo as $key=>$val)
		{
			$poIdArr2[$val] = $val;
		}
	}
	unset($poID_sql_result);

	//for job information
	$job_no_array = array();
	$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst where 1=1".where_con_using_array($poIdArr2, '0', 'id'));
	foreach ($jobData as $row)
	{
		$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
		$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
		$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
	}
	unset($jobData);

	$all_req_no = "";
	$all_prod_id = "";
	$order_qnty_val_sum=0;
	$order_amount_val_sum=0;
	$no_of_bags_val_sum=0;
	$tot_return_qty = 0;
	$tot_bag = 0;
	$tot_cone = 0;
	$tot_w_bag = 0;
	$tot_w_cone = 0;
	$z = 0;
	$printDataArr = array();
	$jobNoArr = array();
	foreach ($sql_result as $row)
	{
		//for booking no
		//$row[csf('buyer_job_no')];
		$mainbookingNo = '';
		if($row[csf('buyer_job_no')])
		{
			$mainbookingNo = $BookingNoArr[$row[csf('buyer_job_no')]]['booking_no'];
		}
		else
		{
			$mainbookingNo = $YwdBookingNoArr[$row[csf('booking_no')]]['ydwbooking'];

			if ($row[csf('issue_basis')] == 3 && $dataArray[0][csf('issue_purpose')] == 1)
			{
				$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
				foreach ($po_id as $val)
				{
					$mainbookingNo = $BookingNoArr1[$po_array[$val]['job_no']]['booking_no'];
					//$mainbookingNo = $po_array[$val]['job_no'];

				}
			}
		}


		$bookingNo = $row[csf('booking_no')];

		if ($row[csf('requisition_no')] != "")
		{
			if ($all_req_no == '')
				$all_req_no = $row[csf('requisition_no')];
			else
				$all_req_no .= ',' . $row[csf('requisition_no')];

			if ($all_prod_id == '')
				$all_prod_id = $row[csf('po_id')];
			else
				$all_prod_id .= ',' . $row[csf('po_id')];
		}
		$order_qnty_val = $row[csf('cons_quantity')];
		$order_qnty_val_sum += $order_qnty_val;

		$order_amount_val = $row[csf('order_amount')];
		$order_amount_val_sum += $order_amount_val;

		$no_of_bags_val = $row[csf('no_of_bags')];
		$no_of_bags_val_sum += $no_of_bags_val;

		$po_id = explode(",", $row[csf('po_id')]);
		$po_no = "";
		$style_ref = "";
		$job_no = "";
		$buyer = "";
		$sustainability = "";
		$material = "";
		$fab_material=array(1=>"Organic",2=>"BCI");
			//$data=explode('*',$data);
		$productdtls = $row[csf('product_name_details')];
		$productArr = explode(' ', $productdtls);

		$proddtls = "";
		if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
		}
		else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
		}
		else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
		}
		else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
		}
		else if ($productArr[0] != '' && $productArr[1] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1];
		}
		else if ($productArr[0] != '')
		{
			$proddtls = $productArr[0];
		}
		else
		{
			$proddtls = "";
		}

		$internal_ref = "";
		$file_no = "";

		if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
		{
			foreach ($po_id as $val)
			{
				if ($po_no == '')
					$po_no = $po_array[$val]['no'];
				else
					$po_no .= ", " . $po_array[$val]['no'];

				if ($job_no == '')
				{
					$job_no = $po_array[$val]['job_no'];

					if($job_no != '')
					{
						$jobNoArr[$job_no] = $job_no;
					}
				}

				if ($sustainability  == '')
					$sustainability  = $po_array[$val]['sustainability'];

				if ($material   == '')
					$material  = $po_array[$val]['fab_material'];

				if ($style_ref == '')
				{
					if($knit_source==3 && $show_val_column==0 && $dataArray[0][csf('issue_purpose')] != 8)
					{
						$style_ref = 'WHS';
					}
					else
					{
						$style_ref = $po_array[$val]['style_ref'];
					}
					//$style_ref = $po_array[$val]['style_ref'];
				}


				if ($buyer == '')
					$buyer_name = $po_array[$val]['buyer_name'];

				if ($internal_ref == '')
					$internal_ref = $po_array[$val]['grouping'];
				else
					$internal_ref .= "," . $po_array[$val]['grouping'];

				if ($file_no == '')
					$file_no = $po_array[$val]['file_no'];
				else
					$file_no .= "," . $po_array[$val]['file_no'];
			}

			$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
			$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

			$ref_cond = "";
			foreach ($job_ref as $ref) {
				if ($ref_cond == '')
					$ref_cond = $ref;
				else
					$ref_cond .= ", " . $ref;
			}

			$file_con = "";
			foreach ($job_file as $file)
			{
				if ($file_con == '')
					$file_cond = $file;
				else
					$file_cond .= ", " . $file;
			}

			$buyer_job = "";
			if ($row[csf('issue_basis')] == 1)
			{
				if ($dataArray[0][csf('issue_purpose')] == 8 )
				{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS';
						}
						else
						{
							$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
						}

						//$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
				}
				else
				{
					$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
					if ($row[csf('buyer_job_no')] != "")
					{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS' . '::' . $row[csf('buyer_job_no')];
						}
						else
						{
							$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . '::' . $row[csf('buyer_job_no')];
						}
						//$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . '::' . $row[csf('buyer_job_no')];

						if($buyer_job != '')
						{
							$jobNoArr[$row[csf('buyer_job_no')]] = $row[csf('buyer_job_no')];
						}
					}
					else
					{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS';
						}
						else
						{
							$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
						}
					}
				}
			}
			else if ($row[csf('issue_basis')] == 2)
			{
				$buyer_job = "";
			}

		}
		else if ($row[csf('issue_basis')] == 3)
		{
			//for booking no
			$bookingNo = $reqBookingNoArr[$row[csf('requisition_no')]]['booking_no'];
			$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
			//print_r($ex_data);

			if ($is_sales_array[$row[csf('requisition_no')]] == 1)
			{
				$buyer_job = "";
				foreach (array_unique($po_id) as $val)
				{
					if ($po_no == "")
						$po_no = $job_no_array[$val]['job_no'];
					else
						$po_no .= ", " . $job_no_array[$val]['job_no'];

					if ($style_ref == "")
						$style_ref = $job_no_array[$val]['style_ref'];

					if ($sustainability  == '')
						$sustainability  = $po_array[$val]['sustainability'];

					if ($material   == '')
						$material  = $po_array[$val]['fab_material'];

					if ($buyer_job == "") {
						if ($job_no_array[$val]['within_group'] == 1)
						{
							$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
						}
						else
						{
							$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
						}
					}

					if ($job_no_array[$val]['within_group'] != 1)
					{
						$ref_cond = "";
					}
				}
			}
			else
			{
				foreach ($po_id as $val)
				{
					if ($po_no == "")
						$po_no = $po_array[$val]['no'];
					else
						$po_no .= ", " . $po_array[$val]['no'];

					if ($job_no == "")
					{
						$job_no = $po_array[$val]['job_no'];


						if($job_no != '')
						{
							$jobNoArr[$job_no] = $job_no;
						}
					}

					if ($style_ref == "")
					{
						if($knit_source==3 && $show_val_column==0)
						{
							$style_ref = 'WHS';
						}
						else
						{
							$style_ref = $po_array[$val]['style_ref'];
						}
						//$style_ref = $po_array[$val]['style_ref'];
					}


					if ($sustainability  == '')
						$sustainability  = $po_array[$val]['sustainability'];

					if ($material   == '')
						$material  = $po_array[$val]['fab_material'];

					if ($buyer == "")
						$buyer_name = $po_array[$val]['buyer_name'];

					if ($internal_ref == "")
						$internal_ref = $po_array[$val]['grouping'];
					else
						$internal_ref .= "," . $po_array[$val]['grouping'];

					if ($file_no == "")
						$file_no = $po_array[$val]['file_no'];
					else
						$file_no .= "," . $po_array[$val]['file_no'];
				}

				$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
				$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

				$ref_cond = "";
				foreach ($job_ref as $ref)

				{
					if ($ref_cond == "") $ref_cond = $ref; else $ref_cond .= ", " . $ref;
				}

				$file_con = "";
				foreach ($job_file as $file)
				{
					if ($file_con == "")
						$file_cond = $file;
					else
						$file_cond .= ", " . $file;
				}

				if ($job_no != "")
				{
					if($knit_source==3 && $show_val_column==0)
					{
						$buyer_job = 'WHS' . '::' . $job_no;
					}
					else
					{
						$buyer_job = $buyer_arr[$buyer_name] . '::' . $job_no;
					}

					$jobNoArr[$job_no] = $job_no;
				}
				else
				{
					$buyer_job = $buyer_arr[$buyer_name];
				}
			}

			//for sample
			if($reqBookingNoArr[$row[csf('requisition_no')]]['is_sample'] == 2)
			{
				$buyer_job = $buyer_arr[$dataSampleArr[$bookingNo]['buyer_id']];
				$style_ref = $dataSampleArr[$bookingNo]['style_ref_no'];
				$sustainability = $dataSampleArr[$bookingNo]['sustainability_std_id'];
				$material = $dataSampleArr[$bookingNo]['fabric_material_id'];
			}
		}
		else
		{
			foreach (array_unique($po_id) as $val)
			{
				if ($po_no == "")
					$po_no = $job_no_array[$val]['job_no'];
				else
					$po_no .= ", " . $job_no_array[$val]['job_no'];

				if ($style_ref == "")
					$style_ref = $job_no_array[$val]['style_ref'];


				if ($buyer_job == "")
				{
					if ($job_no_array[$val]['within_group'] == 1)
					{
						$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
					}
					else
					{
						$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
					}
				}
			}
		}

		$no_bag_cone = "";
		$wt_bag_cone = "";
		if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0)
			$no_bag_cone = 'N:' . $no_of_bags_val;
		else
			$no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

		if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0)
			$wt_bag_cone = 'W:' . $row[csf('weight_per_bag')];
		else
			$wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];

		//for buyer job and style
		$buyer_job_style = $buyer_job.($style_ref != ''?'::'.$style_ref:'');
		$req_no = ($row[csf('requisition_no')] != 0 ? $row[csf('requisition_no')]:'');
		$item_description = $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];

		//for print data
		$z++;
		$printDataArr[$z]['buyer_job_style'] = $buyer_job.($style_ref != ''?'::'.$style_ref:'').($mainbookingNo != ''?'::'.$mainbookingNo:'').($sustainability*1 != ''?'::'.$sustainability_standard[$sustainability]:'').($material*1 != ''?'::'.$fab_material[$material]:'');
		$printDataArr[$z]['req_no'] = ($row[csf('requisition_no')] != 0 ? $row[csf('requisition_no')]:$bookingNo);
		$printDataArr[$z]['prog_no'] = $program_array[$row[csf('requisition_no')]];
		$printDataArr[$z]['lot'] = $row[csf('lot')];
		$printDataArr[$z]['yarn_type'] = $row[csf('yarn_type')];
		$printDataArr[$z]['item_description'] = $item_description;
		$printDataArr[$z]['dyeing_color_id'] = $row[csf('dyeing_color_id')];
		$printDataArr[$z]['color_id'] = $row[csf('color')];
		$printDataArr[$z]['supplier_id'] = $row[csf('supplier_id')];
		$printDataArr[$z]['cons_quantity'] = $row[csf('cons_quantity')];
		$printDataArr[$z]['returnable_qnty'] = $row[csf('returnable_qnty')];
		$printDataArr[$z]['no_bag_cone'] = $no_bag_cone;
		$printDataArr[$z]['wt_bag_cone'] = $wt_bag_cone;
		$printDataArr[$z]['store_id'] = $row[csf('store_id')];
		$printDataArr[$z]['po_no'] = $po_no;
		$printDataArr[$z]['remarks'] = $row[csf('remarks')];

		$printDataArr[$z]['no_of_bags_val'] = $no_of_bags_val;
		$printDataArr[$z]['cone_per_bag'] = $row[csf('cone_per_bag')];
		$printDataArr[$z]['weight_per_bag'] = $row[csf('weight_per_bag')];
		$printDataArr[$z]['weight_per_cone'] = $row[csf('weight_per_cone')];
	}

	$noOfCopy = "";
	for ($x = 1; $x <= $no_copy; $x++)
	{
		if($x==1)
		{
			$sup = 'st';
		}
		else if($x==2)
		{
			$sup = 'nd';
		}
		else if($x==3)
		{
			$sup = 'rd';
		}
		else
		{
			$sup = 'th';
		}

		$noOfCopy ="<span style='font-size:x-large;font-weight:bold'>".$x."<sup>".$sup."</sup> Copy</span>";
		?>

		<div style="width:1020px;">
			<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row)
						{
							if ($data[5] != 1)
							{
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50' align="middle"/>
								<?
							}
							else
							{
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50' align="middle"/>
								<?
							}
						}
						?>
					</td>
                    <td align="center" style="font-size:30px" colspan="6"><strong><? echo $com_dtls[0]."<br><span style=\"font-size:14px;\">".$com_dtls[1]."</span>"; ?></strong></td>
					<td width="110" align="right"><?php echo $noOfCopy.($is_gate_pass==1?"<br><span style=\"color:#F00;font-weight:bold;\">Gate Pass Done</span>":'').($is_gate_out==1?"<br><span style=\"color:#F00;font-weight:bold;\">Gate Out Done</span>":''); ?></td>
				</tr>
				<tr>
					<td colspan="6" align="center" height="50" valign="middle" style="font-size:25px">
						<strong><u>Yarn Delivery Challan</u></strong>
						<?php
						if ($data[4] == 1)
						{
							?>
							<span style="color:#0F0; font-weight:bold;">[Approved]</span>
							<?php
						}
						?>
					</td>
				</tr>
			</table>
			<br>
            <table style="margin-right:-40px;" cellspacing="0" width="1020" border="1" rules="all" class="rpt_table">
				<tr>
					<td width="70"><strong>Issue No:</strong></td>
					<td width="260px"><? echo $issue_no; ?></td>
					<td width="80"><strong>Issue Date:</strong></td>
					<td width="260px"><? echo change_date_format($issue_date); ?></td>
					<td width="120"><strong>Knitting Source:</strong></td>
					<td><? echo $knitting_source[$knit_source]; ?></td>
				</tr>
				<tr>
					<td><strong>Issue To:</strong></td>
					<td><? echo $issue_to; ?></td>
					<td><strong>Address:</strong></td>
					<td><? echo $addressPrint; ?></td>
					<td><strong>Issue Purpose:</strong></td>
					<td><? echo $yarn_issue_purpose[$issue_purpose]; ?></td>
				</tr>
				<tr>
					<td><strong>Location:</strong></td>
					<td><? echo $location_arr[$inhouse_location]; ?></td>
					<td><strong>Attention:</strong></td>
					<td><? echo $attention; ?></td>
					<td><strong>Remarks:</strong></td>
					<td><? echo $remarks; ?></td>
				</tr>
				<tr>
					<td align="center" colspan="6" id="barcode_img_id_<?php echo $x; ?>" height="50" valign="middle" style="border-left:hidden;border-right:hidden;border-bottom:hidden;"></td>
				</tr>
			</table>
			<div style="width:100%;">
				<div style="clear:both;">
					<table style="margin-right:-40px;" cellspacing="0" width="1000" border="1" rules="all" class="rpt_table">
						<thead bgcolor="#dddddd">
							<th width="20">SL</th>
							<th width="100">Buyer, Job, Style and Booking</th>
							<th width="45">Req. No/Work Order</th>
							<th width="50">Knitting Prog. No</th>
							<th width="50">Lot No</th>
							<th width="65">Yarn Type</th>
							<th width="110">Item Details</th>
							<th width="65">Dye. Color</th>
							<th width="60">Color</th>
							<th width="60">Supp.</th>
							<th width="60">Issue Qty(kg)</th>
							<th width="60">Rtnbl Qty(kg)</th>
							<th width="60">Bag & Cone</th>
							<th width="100">Order/PO</th>
							<th width="60">Store</th>
							<th>Remarks</th>
						</thead>
                        <tbody>
						<?
						$i= 0;
						foreach($printDataArr as $key=>$val)
						{
							$i++;
							if ($i % 2 == 0)
								$bgcolor = "#E9F3FF";
							else
								$bgcolor = "#FFFFFF";
							?>
                            <tr bgcolor="<? echo $bgcolor; ?>">
                                <td><? echo $i; ?></td>
                                <td>
                                    <div style="word-wrap:break-word; width:100px"><? echo $val['buyer_job_style']; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:45px"><? echo $val['req_no']; ?></div>
                                </td>
                                <td>
                                    <?  echo $val['prog_no']; ?>
                                </td>
                                <td width="50">
                                    <div style="word-wrap:break-word; width:50px"><? echo $val['lot']; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$val['yarn_type']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:110px">
                                        <? echo $val['item_description']; ?>
                                    </div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$val['dyeing_color_id']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $color_name_arr[$val['color_id']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $supplier_arr[$val['supplier_id']]; ?></div>
                                </td>
                                <td align="right"><? echo number_format($val['cons_quantity'], 2, '.', ''); ?></td>
                                <td align="right"><? echo number_format($val['returnable_qnty'], 2, '.', ''); ?></td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $val['no_bag_cone'] . '<br>' . $val['wt_bag_cone'] ?>&nbsp;</div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:100px; font-size:12px;"><? echo $val['po_no']; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $store_arr[$val['store_id']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:80px"><? echo $val['remarks']; ?></div>
                                </td>
                            </tr>
							<?
							$uom_unit = "Kg";
							$uom_gm = "Grams";
							$tot_return_qty += $val['returnable_qnty'];
							$tot_bag += $val['no_of_bags_val'];
							$tot_cone += $val['cone_per_bag'];
							$tot_w_bag += $val['weight_per_bag'];
							$tot_w_cone += $val['weight_per_cone'];
						}
						?>
						<tr bgcolor="#CCCCCC" style="font-size:16px">
							<td colspan="2"><b>Total Job:
                            <?php
							if(!empty($jobNoArr))
							{
                           		echo " ".count($jobNoArr);
							}
							?>
                            </b></td>
							<td align="right" colspan="8"><b>Total</b></td>
							<td align="right">
								<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 2, '.', ''); ?></b>
							</td>
							<td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
							<td><? echo 'N:' . number_format($tot_bag, 2);
							if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
							echo '<br>W:' . number_format($tot_w_bag, 2);
							if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
							<td align="right" colspan="4">&nbsp;</td>
						</tr>
						<tr>
							<td colspan="16" align="left"><b>In
							Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
						</tr>
                        <tr>
                        	<td colspan="16" height="30" style="border-left:hidden;border-right:hidden;">&nbsp;</td>
                        </tr>
                        <tr>
                        	<td colspan="8" align="center" valign="middle" style="font-size:25px;"><strong>&lt;&lt;Gate Pass&gt;&gt;</strong></td>
                            <td colspan="8" align="center" valign="middle" id="gate_pass_barcode_img_id_<?php echo $x; ?>" height="50"></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>From Company:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['from_company']; ?></td>
                        	<td colspan="2"><strong>To Company:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['to_company']; ?></td>
                        	<td colspan="3"><strong>Carried By:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['carried_by']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>From Location:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['from_location']; ?></td>
                        	<td colspan="2"><strong>To Location:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['to_location']; ?></td>
                        	<td colspan="3"><strong>Driver Name:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['driver_name']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Gate Pass ID:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['gate_pass_id']; ?></td>
                        	<td colspan="2" rowspan="2"><strong>Delivery Qnty</strong></td>
                        	<td align="center"><strong>Kg</strong></td>
                        	<td align="center" colspan="2"><strong>Bag</td>
                        	<td colspan="3"><strong>Vehicle Number:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['vhicle_number']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Gate Pass Date:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['gate_pass_date']; ?></td>
                        	<td align="center"><?php echo $gatePassDataArr[$system_no]['delivery_kg']; ?></td>
                        	<td align="center" colspan="2"><?php echo $gatePassDataArr[$system_no]['delivery_bag']; ?></td>
                        	<td colspan="3"><strong>Driver License No.:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['driver_license_no']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Out Date:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['out_date']; ?></td>
                        	<td colspan="2"><strong>Dept. Name:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['department']; ?></td>
                        	<td colspan="3"><strong>Mobile No.:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['mobile_no']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Out Time:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['out_time']; ?></td>
                        	<td colspan="2"><strong>Attention:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['attention']; ?></td>
                        	<td colspan="3"><strong>Sequrity Lock No.:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['security_lock_no']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Returnable:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['returnable']; ?></td>
                        	<td colspan="2"><strong>Purpose:</strong></td>
                        	<td colspan="9"><?php echo $gatePassDataArr[$system_no]['issue_purpose']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Est. Return Date:</strong></td>
                        	<td colspan="3"><?php echo $gatePassDataArr[$system_no]['est_return_date']; ?></td>
                        	<td colspan="2"><strong>Remarks:</strong></td>
                        	<td colspan="9"><?php echo $gatePassDataArr[$system_no]['remarks']; ?></td>
                        </tr>
                    </tbody>
                    </table>
				</div>
				<br>
				<? echo signature_table(49, $company, "1000px"); ?>
			</div>
		</div>
		<script type="text/javascript" src="../../js/jquery.js"></script>
        <script type="text/javascript" src="../../js/jquerybarcode.js"></script>
		<script>
			function generateBarcode(valuess)
			{
				var zs = '<?php echo $x; ?>';
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id_"+zs).html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id_"+zs).show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');

			//for gate pass barcode
			function generateBarcodeGatePass(valuess)
			{
				var zs = '<?php echo $x; ?>';
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#gate_pass_barcode_img_id_"+zs).html('11');
				value = {code: value, rect: false};
				$("#gate_pass_barcode_img_id_"+zs).show().barcode(value, btype, settings);
			}

			if('<? echo $gatePassDataArr[$system_no]['gate_pass_id']; ?>' != '')
			{
				generateBarcodeGatePass('<? echo strtoupper($gatePassDataArr[$system_no]['gate_pass_id']); ?>');
			}
		</script>
        <div style="page-break-after:always;"></div>
    <?php
	}
    exit();
}

if ($action == "yarn_issue_print16")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print2", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$print_with_vat = $data[7];
	$company=$data[0];
	$location=$data[8];
	$store_id=$data[9];

	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	/*$supplier_arr=return_library_array( "select id, short_name from lib_supplier",'id','short_name');
	$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');*/

	$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');


	//$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$floor_room_rack_arr = return_library_array("select floor_room_rack_id, floor_room_rack_name from lib_floor_room_rack_mst", 'floor_room_rack_id', 'floor_room_rack_name');
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');

	$sql = " select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$data[5]'";
	//echo $sql;die;
	$dataArray = sql_select($sql);

	if( $dataArray[0][csf('issue_basis')]==3 )
	{
		$planbooking = sql_select("select e.booking_no as pln_booking_no from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c,ppl_planning_info_entry_dtls d,ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$data[5]' ");
	}

	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$country_arr = return_library_array("select id, country_name from lib_country", "id", "country_name");
	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);

	$PNG_TEMP_DIR = dirname(__FILE__).DIRECTORY_SEPARATOR.'qrcode_image'.DIRECTORY_SEPARATOR;
    $PNG_WEB_DIR = 'qrcode_image/';

	foreach (glob($PNG_WEB_DIR."*.png") as $filename) {
		@unlink($filename);
	}

	if (!file_exists($PNG_TEMP_DIR)) mkdir($PNG_TEMP_DIR);

	$filename = $PNG_TEMP_DIR.'test.png';
	$errorCorrectionLevel = 'L';
	$matrixPointSize = 4;

    include "../../ext_resource/phpqrcode/qrlib.php";

	$filename = $PNG_TEMP_DIR.md5($data[1]).'.png';
	QRcode::png($data[1], $filename, $errorCorrectionLevel, $matrixPointSize, 2);

	?>
	<style type="text/css">
		body{
			margin: 0 auto;
			padding:0;
			background-size:912px 1056px;
            background-repeat: no-repeat;
		}
		tr td {
			font-size: 22px;
		}
		.stlinfo{font-size: 22px;height: 70px; border: 2px solid black;}
		.stlinfobody{font-size: 22px; border: 2px solid black;}
	</style>
	<div style="width:1000px;">
		<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;margin-bottom:10px; ">
			<tr>
				<td></td>
				<td colspan="7" align="center" style="font-size:25px; padding-bottom:5px">
					<strong><? echo $com_dtls[0]; ?></strong></td>
					<td style="font-size:xx-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">

					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='70' width='130'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='70' width='130'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="7" align="center" >
						<?
						//echo $com_dtls[1];
					$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$data[0]");
					foreach ($nameArray as $result)
					{
						echo $result[csf('city')];?>
						COUNTRY: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
						Email : <? echo $result[csf('email')];?>
						Website : <? echo $result[csf('website')];
					}
					?>
			</td>
			<td>&nbsp;</td>
		</tr>
		<tr>
		    <td></td>
			<td colspan="7" align="center" style="padding-top: 5px;padding-bottom: 10px;"><strong><u>Yarn Delivery Challan</u></strong>
			</td>
			<td>&nbsp;</td>
		</tr>
		<tr>
			<td width="80"><strong>Issue No:</strong></td>
			<td width="195px"><? echo $dataArray[0][csf('issue_number')]; ?></td>
			<td width="50"></td>
			<td width="150"><strong>Booking:</strong></td>
			<td width="185px">
				<?
				if( $dataArray[0][csf('issue_basis')]==3 )
				{
					$bookingNo = $planbooking[0][csf('pln_booking_no')];
				} else {
					$bookingNo = $dataArray[0][csf('booking_no')];
				}
				echo $bookingNo;
				?>
			</td>
			<td width="50"></td>
			<td width="170"><strong>Knitting Source:</strong></td>
			<td width="150px"><? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
		</tr>
		<tr>
		<td valign="top"><strong>Issue To:</strong></td>
			<?
			if ($dataArray[0][csf('knit_dye_source')] == 3) {
				$supp_add = $dataArray[0][csf('knit_dye_company')];
				$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
				foreach ($nameArray as $result) {
					$address = "";
					if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
				}
				unset($nameArray);
			}

			$loan_party_add = $dataArray[0][csf('loan_party')];
			$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
			foreach ($loanPartyArray as $result) {
				$addressParty = "";
				if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
			}
			unset($loanPartyArray);
			?>
			<td valign="top">
				<strong>
					<?
					if ($dataArray[0][csf('issue_purpose')] == 3) {
						echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
					} else if ($dataArray[0][csf('issue_purpose')] == 5) {
						echo $supplier_arr[$dataArray[0][csf('loan_party')]];
					} else {
						if ($dataArray[0][csf('knit_dye_source')] == 1)
							echo $company_library[$dataArray[0][csf('knit_dye_company')]];
						else
							echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]];
					}
					?>
				</strong>
			</td>
			<td width="50"></td>
			<td><strong>Issue Purpose:</strong></td>
			<td width="175px"><? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
			echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
			?></td>
			<td width="50"></td>
			<td><strong>Issue Date:</strong></td>
			<td width="175px"><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
		</tr>
			<tr>
			<td valign="top"><strong>Address:</strong></td>
			<td>
				<?
				if ($dataArray[0][csf('issue_purpose')] == 3) {
					echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
				} else if ($dataArray[0][csf('issue_purpose')] == 5) {
					echo $addressParty;
				} else {
					if ($dataArray[0][csf('knit_dye_source')] == 1)
						echo $company_library[$dataArray[0][csf('knit_dye_company')]];
					else
						echo $address;
				}
				?>
			</td>
				<td width="50"></td>
				<td><strong>Do No:</strong></td>
				<td width="175px"><? //echo $dataArray[0][csf('remarks')];
				?></td>
				<td width="50"></td>
				<td valign="top"><strong>Location:</strong></td>
				<td valign="top"><? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>


			</tr>
			<tr>
				<td valign="top"><strong>Remarks :</strong></td>
				<td colspan="5"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
			</tr>
			<?
			if ($print_with_vat == 1) {
				?>
				<tr>
					<!-- <td><strong>VAT Number :</strong></td>
					<td><p>
						<?
					$vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
					echo $vat_no;
					?></p></td> -->
					<td><strong>QR Code:</strong></td>
					<td colspan="3" ><img src="<? echo $PNG_WEB_DIR.basename($filename);?>" height="100" width=""></td>
				</tr>
				<?
			} else {
				?>
				<tr>
					<td valign="top">&nbsp;</strong></td>
					<td>&nbsp;</td>
					<td ><strong>QR Code:</strong></td>
					<td colspan="3" ><img src="<? echo $PNG_WEB_DIR.basename($filename);?>" height="100" width=""></td>
				</tr>
				<?
			}
			?>
		</table>



		<div style="width:100%; padding-top:10px">
			<div style="clear:both;">
				<table style="margin-right:-40px; " cellspacing="0" width="1410" border="1" rules="all">
				<thead bgcolor="#CCCCCC">
					<th width="20" class='stlinfo'>SL</th>
					<th width="100" class='stlinfo'>Req. No</th>
					<th width="100" class='stlinfo'>Program No</th>
					<th width="65" class='stlinfo'>Y. Type</th>
					<th width="150" class='stlinfo'>Item Details</th>
					<th width="50" class='stlinfo'>Lot No</th>
					<th width="65" class='stlinfo'>Brand</th>
					<th width="60" class='stlinfo'>Issue Qty(kg)</th>
					<th width="80" class='stlinfo'><b>Bag&Cone</b></th>
					<th width="60" class='stlinfo'>Rtubl Qty(kg)</th>
					<th width="100" class='stlinfo'>Cust Buyer</th>
					<th width="180" class='stlinfo'>Fso No.</th>
					<th width="100" class='stlinfo'> Style No.</th>
					<th width="80" class='stlinfo'>Store</th>
					<th class='stlinfo'>Remarks</th>
				</thead>
				<?
				//$wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");
				$cond = "";
				if ($data[5] != "") $cond .= " and c.id='$data[5]'";

				$i = 1;
				if ($db_type == 0)
				{
					$sql_result = sql_select("SELECT a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, a.brand,b.remarks from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.brand,b.remarks");
				}
				else
				{
					$sql_result = sql_select("SELECT a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, a.brand,b.remarks from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.brand,b.remarks");
				}

				//for requisition no
				$tmp_req_no_arr = array();
				$tmp_po_id_arr = array();
				foreach ($sql_result as $row)
				{
					$tmp_req_no_arr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];

					//for po
					$exp_po_id = array();
					$exp_po_id = explode(",", $row[csf('po_id')]);
					foreach($exp_po_id as $pkey=>$pval)
					{
						$tmp_po_id_arr[$pval] = $pval;
					}
				}

				$con = connect();
				execute_query("DELETE FROM TMP_REQS_NO WHERE USERID = ".$user_id);
				execute_query("DELETE FROM TMP_POID WHERE USERID = ".$user_id);
				oci_commit($con);

				//for requisition no insert
				$con = connect();
				foreach($tmp_req_no_arr as $key=>$val)
				{
					execute_query("INSERT INTO TMP_REQS_NO(REQS_NO, USERID) VALUES('".$val."', '".$user_id."')");
				}

				foreach($tmp_po_id_arr as $key=>$val)
				{
					execute_query("INSERT INTO TMP_POID(POID, USERID) VALUES('".$val."', '".$user_id."')");
				}
				oci_commit($con);
				//end for requisition no

				//for requisition no
				$po_id_req_array = array();
				$is_sales_array = array();
				if ($db_type == 0)
				{
					$poID = " select c.knit_id,c.requisition_no,a.buyer_id,a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id AND c.requisition_no IN(SELECT REQS_NO FROM TMP_REQS_NO WHERE USERID = ".$user_id.") group by c.knit_id,c.requisition_no,a.buyer_id,a.is_sales ";
				}
				else
				{
					$poID = "select c.knit_id,c.requisition_no,a.buyer_id,a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id AND c.requisition_no IN(SELECT REQS_NO FROM TMP_REQS_NO WHERE USERID = ".$user_id.") group by c.knit_id,c.requisition_no,a.buyer_id,a.is_sales ";
				}

				//echo $poID;
				$poID_sql_result = sql_select($poID);
				foreach ($poID_sql_result as $row)
				{
					$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
					$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
					$program_array[$row[csf('requisition_no')]]['program_no'] = $row[csf('knit_id')];
					$program_array[$row[csf('requisition_no')]]['buyer_id'] = $row[csf('buyer_id')];
				}
				unset($poID_sql_result);
				//end for requisition no
				/*echo "<pre>";
				print_r($program_array);
				echo "</pre>";*/

				//for po
				$po_array = array();
				$job_array = array();
				$costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0] AND b.id IN(SELECT POID FROM TMP_POID WHERE USERID = ".$user_id.")");
				foreach ($costing_sql as $row)
				{
					$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
					$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
					$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
					$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
					$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
					$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
					$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
					$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
				}
				unset($costing_sql);
				//end for po

				//for sales order info
				$job_no_array = array();
				$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id,customer_buyer from fabric_sales_order_mst where id IN(SELECT POID FROM TMP_POID WHERE USERID = ".$user_id.")");
				foreach ($jobData as $row)
				{
					$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
					$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
					$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
					$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
					$job_no_array[$row[csf('id')]]['customer_buyer'] = $row[csf('customer_buyer')];
				}
				//end for sales order info
				execute_query("DELETE FROM TMP_REQS_NO WHERE USERID = ".$user_id);
				execute_query("DELETE FROM TMP_POID WHERE USERID = ".$user_id);
				oci_commit($con);

				$all_req_no = '';
				$all_prod_id = '';
				$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
				$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
				foreach ($sql_result as $row) {
					//if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
					if ($row[csf('requisition_no')] != '') {
						if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
						if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
					}
					$order_qnty_val = $row[csf('cons_quantity')];
					$order_qnty_val_sum += $order_qnty_val;

					$order_amount_val = $row[csf('order_amount')];
					$order_amount_val_sum += $order_amount_val;

					$no_of_bags_val = $row[csf('no_of_bags')];
					$no_of_bags_val_sum += $no_of_bags_val;

					$po_id = explode(",", $row[csf('po_id')]);
					$po_no = '';
					$style_ref = '';
					$job_no = '';
					$buyer = '';
						//$data=explode('*',$data);
					$productdtls = $row[csf('product_name_details')];
					$productArr = explode(' ', $productdtls);

					$proddtls = '';
					if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
					} else if ($productArr[0] != '' && $productArr[1] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1];
					} else if ($productArr[0] != '') {
						$proddtls = $productArr[0];
					} else {
						$proddtls = '';
					}

					$internal_ref = '';
					$file_no = '';
					if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
					{
						foreach ($po_id as $val) {
							if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
							if ($job_no == '') $job_no = $po_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
							if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

							if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
							if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
						}
						$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
						$job_file = array_unique(explode(",", rtrim($file_no, ", ")));
						$ref_cond = '';
						foreach ($job_ref as $ref) {
								//$ref_cond.=", ".$ref;
							if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
						}
						$file_con = '';
						foreach ($job_file as $file) {
							if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
						}

						$buyer_job = '';
						if ($row[csf('issue_basis')] == 1)
						{
							if ($dataArray[0][csf('issue_purpose')] == 8)
							{
								$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
							}
							else
							{
								if ($row[csf('buyer_job_no')] != "")
								{
									$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
								}
								else
								{
									$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
								}
							}
						} else if ($row[csf('issue_basis')] == 2) {
							$buyer_job = '';
						}
					}
					else if ($row[csf('issue_basis')] == 3)
					{
						$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
							//print_r($ex_data);

						if ($is_sales_array[$row[csf('requisition_no')]] == 1)
						{
							$buyer_job = '';
							foreach (array_unique($po_id) as $val) {
								if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];

								if ($buyer_job == '') {
									if ($job_no_array[$val]['within_group'] == 1) {
										//$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
										$buyer_job = $buyer_arr[$job_no_array[$val]['customer_buyer']];
									} else {
										$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
									}
								}

								if ($job_no_array[$val]['within_group'] != 1) {
									$ref_cond = '';
								}

							}
						}
						else
						{
							foreach ($po_id as $val)
							{
								if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
								if ($job_no == '') $job_no = $po_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
								if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
							}

							$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
							$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

							$ref_cond = '';
							foreach ($job_ref as $ref) {
									//$ref_cond.=", ".$ref;
								if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
							}

							$file_con = '';
							foreach ($job_file as $file) {
								if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
							}

							$buyer_job = $buyer_arr[$program_array[$row[csf('requisition_no')]]['buyer_id']];


						}
					}
					else
					{
						foreach (array_unique($po_id) as $val) {
							if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
							if ($buyer_job == '') {
								if ($job_no_array[$val]['within_group'] == 1) {
									$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
								} else {
									$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
								}
							}
						}
					}

					$no_bag_cone = "";
					$wt_bag_cone = "";
					if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

					if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];

					//for supplier
					if($row[csf('is_within_group')] == 1)
					{
						$supplier_name = $company_library[$row[csf('supplier_id')]];
					}
					else
					{
						$supplier_name = $supplier_arr[$row[csf('supplier_id')]];
					}
					?>
					<tbody>
						<tr bgcolor="<? echo $bgcolor; ?>">
							<td width="20" class='stlinfobody'><? echo $i; ?></td>
							<td width="100" class='stlinfobody' style="word-wrap:break-word; ">
								<? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?>
							</td>
							<td width="100" class='stlinfobody'>
								<?  echo $program_array[$row[csf('requisition_no')]]['program_no']; ?>
							</td>

							<td width="65" class='stlinfobody' style="word-wrap:break-word; ">
								<? echo $yarn_type[$row[csf('yarn_type')]]; ?>
							</td>

							<td width="150" class='stlinfobody' style="word-wrap:break-word; ">
								<?
									echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
									?>
							</td>
							<td width="50" class='stlinfobody' style="word-wrap:break-word;">

								<? echo $row[csf('lot')]; ?>

							</td>
							<td width="65" class='stlinfobody' style="word-wrap:break-word; "><? echo $brand_arr[$row[csf('brand')]]; ?></td>

							<td width="60" class='stlinfobody' style="word-wrap:break-word; ">
								<? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?>
							</td>

							<td align="right"
							width="80" class='stlinfobody'><? echo $no_bag_cone . '<br>' . $wt_bag_cone ?>
						&nbsp;</td>
							<td align="right"
							width="60" class='stlinfobody'><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
							<td width="100" class='stlinfobody' style="word-wrap:break-word; "><? echo $buyer_job; ?></td>
							<td width="180" class='stlinfobody' style="word-wrap:break-word; ">
								<? echo $po_no; ?>
							</td>
							<td width="100" class='stlinfobody' style="word-wrap:break-word; ">
								 <? echo $style_ref;  ?>
							</td>
							<td width="80" class='stlinfobody' style="word-wrap:break-word; ">
								<? echo $store_arr[$row[csf('store_id')]]; ?>
							</td>
							<td class='stlinfobody' style="word-wrap:break-word; ">
								<? echo $row[csf('remarks')]; ?>
							</td>

					</tr>
				<?
				$uom_unit = "Kg";
				$uom_gm = "Grams";
				$tot_return_qty += $row[csf('returnable_qnty')];
				$tot_bag += $no_of_bags_val;
				$tot_cone += $row[csf('cone_per_bag')];
				$tot_w_bag += $row[csf('weight_per_bag')];
				$tot_w_cone += $row[csf('weight_per_cone')];
				$req_no = $row[csf('requisition_no')];
				$i++;
				}
				?>
				<tr bgcolor="#CCCCCC" >
					<td align="right" colspan="7" class='stlinfobody'><b>Total&nbsp;</b></td>
					<td align="right" class='stlinfobody'>
						<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
					</td>
					<td align="right" class='stlinfobody'><? echo 'N:' . number_format($tot_bag, 2);
					if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
					echo '<br>W:' . number_format($tot_w_bag, 2);
					if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
					<td class='stlinfobody'><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
					<td align="right" colspan="5" class='stlinfobody'>&nbsp;</td>
				</tr>
				<tr>
					<td colspan="17" align="left" class='stlinfobody'><b>In
						Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
				</tr>
				</tbody>
			</table>
			<p><b>Note: Received The Above in Goods Condition For Handling and Delivery.</b></p>

		</div>
	<br>
	<br>&nbsp;
	<!--================================================================-->
	<?
	if ($data[6] == 1)
	{
		if ($dataArray[0][csf('issue_basis')] == 3)
		{
			?>
			<div style="">
				<table width="850" border="1" rules="all" cellpadding="0" cellspacing="0" >
					<thead bgcolor="#CCCCCC">
						<tr>
							<th colspan="7" align="center" class='stlinfo'>Requisition Details</th>
						</tr>
						<tr>
							<th width="40" class='stlinfo'>SL</th>
							<th width="100" class='stlinfo'>Requisition No</th>
							<th width="110" class='stlinfo'>Lot No</th>
							<th width="220" class='stlinfo'>Yarn Description</th>
							<th width="110" class='stlinfo'>Brand</th>
							<th width="90" class='stlinfo'>Requisition Qty</th>
							<th class='stlinfo'>Remarks</th>
						</tr>
					</thead>
					<?
					//echo $all_req_no;
					$i = 1;
					$tot_reqsn_qnty = 0;
					$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
					$product_details_array = array();
					$sql = "select id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where item_category_id=1 and company_id='$data[0]' and status_active=1 and is_deleted=0";
					$result = sql_select($sql);

					foreach ($result as $row) {
						$compos = '';
						if ($row[csf('yarn_comp_percent2nd')] != 0) {
							$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
						} else {
							$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
						}
						$product_details_array[$row[csf('id')]]['count'] = $count_arr[$row[csf('yarn_count_id')]];
						$product_details_array[$row[csf('id')]]['comp'] = $compos;
						$product_details_array[$row[csf('id')]]['type'] = $yarn_type[$row[csf('yarn_type')]];
						$product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
						$product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
					}
					unset($result);
					$sql = "select knit_id, requisition_no, prod_id, sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where requisition_no in ($all_req_no) and status_active=1 and is_deleted=0 group by requisition_no, prod_id, knit_id";
					$nameArray = sql_select($sql);
					foreach ($nameArray as $selectResult) {
						?>
						<tr>
							<td width="40" align="center" class='stlinfobody'><? echo $i; ?></td>
							<td width="100" align="center" class='stlinfobody'>
								&nbsp;<? echo $selectResult[csf('requisition_no')]; ?></td>
							<td width="110" align="center" class='stlinfobody'>
								&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['lot']; ?></td>
							<td width="220" class='stlinfobody'>
								&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['count'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['comp'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['type']; ?></td>
							<td width="110" align="center" class='stlinfobody'>
								&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['brand']; ?></td>
							<td width="90"
									align="right" class='stlinfobody'><? echo number_format($selectResult[csf('yarn_qnty')], 2); ?>
								&nbsp;</td>
							<td class='stlinfobody'>&nbsp;<? //echo $selectResult[csf('requisition_no')];
							?></td>
						</tr>
						<?
						$tot_reqsn_qnty += $selectResult[csf('yarn_qnty')];
						$i++;
					}
					?>
					<tfoot bgcolor="#CCCCCC">
						<th colspan="5" align="right" class='stlinfo'><b>Total</b></th>
						<th align="right" class='stlinfo'><? echo number_format($tot_reqsn_qnty, 2); ?>&nbsp;</th>
						<th class='stlinfo'>&nbsp;</th>
					</tfoot>
				</table>
				<?
				if ($data[5] != 1) {
					$z = 1;
					$k = 1;
					$colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia,c.buyer_id from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

					$booking_al = "";
					foreach ($colorArray as $book)
					{
						if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];

						$prog_booking_buyer[$book[csf('booking_no')]] = $book[csf('buyer_id')];
					}
					//unset($colorArray);
					//echo $booking_no;
					$booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
					$booking_count = count(array_unique(explode(',', $booking_no)));
					//$booking_job_arr=array();
					if ($dataArray[0][csf('issue_purpose')] == 2) {
						$booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
					} else {
						$booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
					}
					//
					$booking_job_no = $booking_job[0][csf('job_no')];
					unset($booking_job);

					if ($db_type == 0) $poNoCond = "group_concat(id)";
					else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
					/*echo '='.$sql_Job.'=';
			if($sql_Job!="")
			{*/
				$sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

				$job_po = $sql_returnJob[0][csf('po_break_down_id')];
				unset($sql_returnJob);
				?>

				<table width="710" cellpadding="0" cellspacing="0" border="1" rules="all"
				style="margin-top:20px;" >
				<thead bgcolor="#CCCCCC">
					<th width="40" class='stlinfo'>SL</th>
					<th width="250" class='stlinfo'>Fabrication</th>
					<th width="120" class='stlinfo'>Color</th>
					<th width="120" class='stlinfo'>GGSM OR S/L</th>
					<th class='stlinfo'>FGSM</th>
				</thead>
				<tbody>

					<?
					$j=1;
					$programChk = array();
					foreach ($colorArray as $program_row) {
						if($programChk[$program_row[csf('knit_id')]] == "")
						{
							$programChk[$program_row[csf('knit_id')]] = $program_row[csf('knit_id')];
							?>
							<tr>
								<td width="40" align="center"  class='stlinfobody'><? echo $j; ?></td>
								<td width="250" align="center"  class='stlinfobody'><? echo $body_part[$program_row[csf('body_part_id')]] . ', ' . $program_row[csf('fabric_desc')]; ?></td>
								<td width="120" align="center"  class='stlinfobody'><? echo $color_range[$program_row[csf('color_range')]]; ?></td>
								<td width="120" align="center"  class='stlinfobody'><? echo $program_row[csf('stitch_length')]; ?></td>
								<td  class='stlinfobody'><? echo $program_row[csf('gsm_weight')]; ?></td>
							</tr>
							<?
							$j++;
						}

					}
					?>
				</tbody>
			</table>
			<table style="margin-top:20px;" width="650" border="1" rules="all" cellpadding="0"
			cellspacing="0" >
			<thead bgcolor="#CCCCCC">
				<th width="40" class='stlinfo'>SL</th>
				<th width="50" class='stlinfo'>Prog. No</th>
				<th width="110" class='stlinfo'>Finish Dia</th>
				<th width="170" class='stlinfo'>Machine Dia & Gauge</th>
				<th width="110" class='stlinfo'>Program Qty</th>
				<th class='stlinfo'>Remarks</th>
			</thead>
			<tbody>
				<?
                $k=1;
				$progChk = array();
                foreach ($colorArray as $program_row) {
					if($progChk[$program_row[csf('knit_id')]] == "")
					{
						$progChk[$program_row[csf('knit_id')]] = $program_row[csf('knit_id')];
						?>
						<tr>
							<td width="40" align="center"  class='stlinfobody'><? echo $k; ?></td>
							<td width="50" align="center"  class='stlinfobody'><? echo $program_row[csf('knit_id')]; ?></td>
							<td width="110" align="center"  class='stlinfobody'><? echo $program_row[csf('dia')]; ?></td>
							<td width="170" align="center"  class='stlinfobody'><? echo $program_row[csf('machine_dia')] . "X" . $program_row[csf('machine_gg')]; ?></td>
							<td width="110" align="right"  class='stlinfobody'><? echo number_format($program_row[csf('program_qnty')], 2); ?></td>
							<td  class='stlinfobody'><? echo $program_row[csf('remarks')]; ?></td>
						</tr>
						<?
						$k++;
						$tot_prog_qty += $program_row[csf('program_qnty')];
					}
                }
                ?>


			<tr bgcolor="#CCCCCC">
				<td colspan="4" align="right" class='stlinfo'><strong>Total : </strong></td>
				<td align="right" class='stlinfo'><? echo number_format($tot_prog_qty, 2); ?></td>
				<td class='stlinfo'>&nbsp;</td>
			</tr>
		</tbody>
	</table>
	<?

	}
		}

			}
			?>
			<br>
			<?
			echo signature_table(49, $data[0], "1230px",'','','','','','font-size:22px;');
			?>
		</div>
	</div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		/* function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? //echo $data[1]; ?>'); */
		</script>
		<?
		exit();
}

if ($action == "yarn_issue_print_btn17")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print17", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$company   = $data[0];
	$system_no = $data[1];
	$report_title = $data[2];
	$booking_id = $data[3];
	$is_approved = $data[4];
	$mst_id     = $data[5];
	$show_val_column = $data[6];
	$print_with_vat = $data[7];
	$location  = $data[8];
	$store_id=$data[9];

	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");

	$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");

	//$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$machine_arr = return_library_array("select id, machine_no from lib_machine_name", 'id', 'machine_no');
	//$color_type_arr = return_library_array("select id, color_type_id from wo_pre_cost_fabric_cost_dtls", 'id', 'color_type_id')

	$sql = "SELECT id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$mst_id'";
	//echo $sql;die;
	$dataArray = sql_select($sql);
	if( $dataArray[0][csf('issue_basis')] == 3 )
	{
		$planbooking = sql_select("select e.booking_no as pln_booking_no, d.id as program_id from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$mst_id' ");
		foreach ($planbooking as $value) {
			$program_id .= $value[csf('program_id')].',';
		}
		$program_ids = implode(",", array_unique(explode(",", chop($program_id,','))));
	}
	//echo $program_ids;

	$com_dtls = fnc_company_location_address($company, $store_location_id, 3);
	?>
	<style type="text/css">
		table tr td {
			font-size: 16px;
		}
		.rpt_table thead th{
			font-size: 16px;
		}
		.rpt_table tfoot th{
			font-size: 16px;
		}
	</style>
	<div style="width:1000px;">
		<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;margin-bottom:20px">
			<tr>
				<td colspan="6" align="center" style="font-size:20px">
					<strong><? echo $com_dtls[0]; ?></strong></td>
				<td style="font-size:xx-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($is_approved == 1) echo "<b>Approved</b>"; ?></div></td>
			</tr>
			<tr class="form_caption">
				<?
				$data_array = sql_select("select image_location from common_photo_library where master_tble_id='$company' and form_name='company_details' and is_deleted=0 and file_type=1");
				?>
				<td align="left" width="50">
					<?
					foreach ($data_array as $img_row)
					{
						if ($mst_id != 1) {
							?>
							<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
							align="middle"/>
							<?
						} else {
							?>
							<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
							align="middle"/>
							<?
						}
					}
					?>
				</td>
				<td colspan="4" align="center"><? echo $com_dtls[1]; ?></td>
				<td>&nbsp;</td>
			</tr>
			<tr>
				<td colspan="6" align="center" style="font-size:18px"><center></center><strong><u>Yarn Delivery Challan</u></strong></center>
				</td>
				<td>&nbsp;</td>
			</tr>
			<tr>
				<td width="160"><strong>Issue No:</strong></td>
				<td width="175px"><? echo $dataArray[0][csf('issue_number')]; ?></td>
				<td width="120"><strong>Booking:</strong></td>
				<td width="175px">
					<?
					if( $dataArray[0][csf('issue_basis')]==3 )
					{
						$bookingNo = $planbooking[0][csf('pln_booking_no')];
					} else {
						$bookingNo = $dataArray[0][csf('booking_no')];
					}
					echo $bookingNo;
					?>
				</td>
				<td width="150"><strong>Knitting Source:</strong></td>
				<td width="175px"><? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
			</tr>
			<tr>
				<td width="160"><strong>Issue Purpose:</strong></td>
				<td width="175px"><? echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
                    ?></td>
				<td width="120"><strong>Issue Date:</strong></td>
				<td width="175px"><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
				<td width="150"><strong>Location:</strong></td>
				<td width="175px"><? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>
			</tr>
            <tr>
            	<td><strong>Issue To:</strong></td>
            	<?
            	if ($dataArray[0][csf('knit_dye_source')] == 3)
            	{
            		$supp_add = $dataArray[0][csf('knit_dye_company')];
            		$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
            		foreach ($nameArray as $result)
					{
            			$address = "";
						if ($result != "") $address = $result[csf('address_1')];
					}
					unset($nameArray);
				}

				$loan_party_add = $dataArray[0][csf('loan_party')];
				$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
				foreach ($loanPartyArray as $result)
				{
					$addressParty = "";
					if ($result != "") $addressParty = $result['address'];
				}
				unset($loanPartyArray);
				?>
				<td colspan="5">
					<?
					if ($dataArray[0][csf('issue_purpose')] == 3) {
						echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
					} else if ($dataArray[0][csf('issue_purpose')] == 5) {
						echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
					} else {
						if ($dataArray[0][csf('knit_dye_source')] == 1)
							echo $company_library[$dataArray[0][csf('knit_dye_company')]];
						else
							echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
					}
					?>
				</td>
			</tr>
            <tr>
            	<td valign="top"><strong>Remarks :</strong></td>
            	<td colspan="5"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
            </tr>
            <?
            if ($print_with_vat == 1)
            {
            	?>
            	<tr>
                    <!-- <td><strong>VAT Number :</strong></td>
					<td><p>
						<?
					$vat_no = return_field_value("vat_number", "lib_company", "id=" . $company, "vat_number");
					echo $vat_no;
					?></p></td> -->
					<td><strong>Bar Code:</strong></td>
					<td colspan="3" id="barcode_img_id"></td>
				</tr>
				<?
			}
			else
			{
				?>
				<tr>
					<td valign="top">&nbsp;</strong></td>
					<td>&nbsp;</td>
					<td><strong>Bar Code:</strong></td>
					<td colspan="3" id="barcode_img_id"></td>
				</tr>
				<?
			}
			?>
		</table>
		<br>
		<div style="width:100%;">
			<div style="clear:both;">
				<table style="margin-right:-40px; " cellspacing="0" width="1150" border="1" rules="all"
				class="rpt_table">
					<thead bgcolor="#dddddd">
						<th width="20">SL</th>
						<th width="150">Item Details</th>
						<th width="70">Y. Type</th>
						<th width="50">Lot No</th>
						<th width="65">Dye. Color</th>
						<th width="110">Supplier</th>
						<th width="65">Issue Qty(kg)</th>
						<th width="60">Rtnbl Qty(kg)</th>
						<th width="60"><b>Bag</b></th>
						<th width="60">Store</th>
						<th width="80">Buyer</th>
						<th width="80">Job</th>
						<th width="100">Style no</th>
						<th>Inte. Ref & File</th>
					</thead>
					<?
					$wopi_library = return_library_array("select id, pi_number from com_pi_master_details", "id", "pi_number");

					$cond = "";
					if ($mst_id != "") $cond .= " and c.id=$mst_id";

					$i = 1;
					if ($db_type == 0)
					{
						$sql_result = sql_select("SELECT a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro
						from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
						where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
						group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
					}
					else
					{
						$sql_result = sql_select("SELECT a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro
						from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
						where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
						group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st");
					}

					$poIdchk = array();
					$reqNochk = array();
					$reqNoarr = array();
					$poIdarr = array();
					foreach ($sql_result as $row)
					{
						$po_id = explode(",", $row[csf('po_id')]);
						foreach ($po_id as $val)
						{
							if($poIdchk[$val] == "")
							{
								$poIdchk[$val] =$val;
								array_push($poIdarr,$val);
							}
						}
						if($reqNochk[$row[csf('requisition_no')]] == "")
						{
							$reqNochk[$row[csf('requisition_no')]] =$row[csf('requisition_no')];
							array_push($reqNoarr,$row[csf('requisition_no')]);
						}
					}
					//var_dump($poIdarr);
					if(!empty($poIdarr))
					{
						$po_array = array();
						$job_array = array();

						$costing_sql = sql_select("SELECT a.job_no, b.file_no, b.grouping, a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.id = b.job_id and a.company_name=$company and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 ".where_con_using_array($poIdarr,0,'b.id')."");
						foreach ($costing_sql as $row)
						{
							$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
							$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
							$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
							$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
							$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
							$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
							$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
							$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
						}
						unset($costing_sql);

						$job_no_array = array();

						$jobData = sql_select("SELECT id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst where status_active=1 and is_deleted=0 ".where_con_using_array($poIdarr,0,'id')."");
						foreach ($jobData as $row)
						{
							$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
							$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
							$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
							$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
						}
						unset($jobData);
					}

					if(!empty($reqNoarr))
					{
						$po_id_req_array = array();
						$is_sales_array = array();

						$sql_po = "SELECT c.knit_id, c.requisition_no, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id ".where_con_using_array($reqNoarr,0,'c.requisition_no')." group by c.knit_id, c.requisition_no, a.is_sales";
						//echo $sql_po;
						$po_sql_result = sql_select($sql_po);
						foreach ($po_sql_result as $row)
						{
							$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
							$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
							$program_array[$row[csf('requisition_no')]] = $row[csf('knit_id')];
						}
						unset($poID_sql_result);
					}


					$all_req_no = "";
					$all_prod_id = "";
					$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
					$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
					foreach ($sql_result as $row)
					{
						if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
						if ($row[csf('requisition_no')] != "") {
							if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')];
							else $all_req_no .= ',' . $row[csf('requisition_no')];

							if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')];
							else $all_prod_id .= ',' . $row[csf('po_id')];
						}
						$order_qnty_val = $row[csf('cons_quantity')];
						$order_qnty_val_sum += $order_qnty_val;

						$order_amount_val = $row[csf('order_amount')];
						$order_amount_val_sum += $order_amount_val;

						$no_of_bags_val = $row[csf('no_of_bags')];
						$no_of_bags_val_sum += $no_of_bags_val;

						$po_id = explode(",", $row[csf('po_id')]);
						$po_no = "";
						$style_ref = "";
						$job_no = "";
						$buyer = "";
							//$data=explode('*',$data);
						$productdtls = $row[csf('product_name_details')];
						$productArr = explode(' ', $productdtls);

						$proddtls = "";
						if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '') {
							$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
						} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '') {
							$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
						} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '') {
							$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
						} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '') {
							$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
						} else if ($productArr[0] != '' && $productArr[1] != '') {
							$proddtls = $productArr[0] . ', ' . $productArr[1];
						} else if ($productArr[0] != '') {
							$proddtls = $productArr[0];
						} else {
							$proddtls = "";
						}

						$internal_ref = "";
						$file_no = "";

						if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
						{
							foreach ($po_id as $val)
							{
								if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
								if ($job_no == '') $job_no = $po_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
								if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
							}

							$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
							$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

							$ref_cond = "";
							foreach ($job_ref as $ref) {
								if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
							}

							$file_con = "";
							foreach ($job_file as $file) {
								if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
							}

							$buyer_job = "";
							if ($row[csf('issue_basis')] == 1)
							{
								if ($dataArray[0][csf('issue_purpose')] == 8) {
									$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
								} else {
									$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
									if ($row[csf('buyer_job_no')] != "") {
										$job = $row[csf('buyer_job_no')];
									}
								}
							}
							else if ($row[csf('issue_basis')] == 2)
							{
								$buyer_job = "";
							}
						}
						else if ($row[csf('issue_basis')] == 3)
						{
							$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
								//print_r($ex_data);

							if ($is_sales_array[$row[csf('requisition_no')]] == 1)
							{
								$buyer_job = "";
								foreach (array_unique($po_id) as $val)
								{
									if ($po_no == "") $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
									if ($style_ref == "") $style_ref = $job_no_array[$val]['style_ref'];

									if ($buyer_job == "") {
										if ($job_no_array[$val]['within_group'] == 1) {
											$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
										} else {
											$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
										}
									}

									if ($job_no_array[$val]['within_group'] != 1) {
										$ref_cond = "";
									}

								}
							}
							else
							{
								foreach ($po_id as $val)
								{
									if ($po_no == "") $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
									if ($job_no == "") $job_no = $po_array[$val]['job_no'];
									if ($style_ref == "") $style_ref = $po_array[$val]['style_ref'];
									if ($buyer == "") $buyer_name = $po_array[$val]['buyer_name'];

									if ($internal_ref == "") $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
									if ($file_no == "") $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
								}

								$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
								$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

								$ref_cond = "";
								foreach ($job_ref as $ref) {
									if ($ref_cond == "") $ref_cond = $ref; else $ref_cond .= ", " . $ref;
								}

								$file_con = "";
								foreach ($job_file as $file) {
									if ($file_con == "") $file_cond = $file; else $file_cond .= ", " . $file;
								}

								if ($job_no != "") {
									$job = $job_no;
								} else {
									$buyer_job = $buyer_arr[$buyer_name];
								}
							}
						}
						else
						{
							foreach (array_unique($po_id) as $val)
							{
								if ($po_no == "") $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
								if ($style_ref == "") $style_ref = $job_no_array[$val]['style_ref'];
								if ($buyer_job == "") {
									if ($job_no_array[$val]['within_group'] == 1) {
										$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
									} else {
										$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
									}
								}
							}
						}

						$no_bag_cone = "";
						$wt_bag_cone = "";
						if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag_cone = 'N:' . $no_of_bags_val; else $no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

						if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];
						?>
						<tbody>
							<tr bgcolor="<? echo $bgcolor; ?>">
								<td width="20"><? echo $i; ?></td>
								<td width="150" style="word-wrap:break-word;">
									<?
									echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
									?>
								</td>
								<td width="70" style="word-wrap:break-word;"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></td>
								<td width="50" style="word-wrap:break-word;"><b><? echo $row[csf('lot')]; ?></b></td>
								<td width="65" style="word-wrap:break-word;"><? echo $color_name_arr[$row[csf('dyeing_color_id')]]; ?>&nbsp;</td>
								<td width="110" style="word-wrap:break-word;">
									<? echo $supplier_arr[$row[csf('supplier_id')]]; ?>
								</td>
								<td width="65" style="word-wrap:break-word;"><b><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></b></td>
								<td width="60" style="word-wrap:break-word;">
									<? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?>
								</td>
								<td align="right" width="60" style="font-size:18px;"><? echo $no_bag_cone; ?>&nbsp;</td>
								<td align="right" width="60"><? echo $store_arr[$row[csf('store_id')]]; ?></td>
								<td width="80" style="word-wrap:break-word;"><? echo $buyer_job; ?>&nbsp;</td>
								<td width="80" style="word-wrap:break-word;"><? echo $job; ?></td>
								<td width="100" style="word-wrap:break-word;"><? echo $style_ref; ?></td>
								<td style="word-wrap:break-word;">
									<? echo ltrim($ref_cond, ", ");
									if ($file_cond != "") echo ' & ' . ltrim($file_cond, ", "); else echo '&nbsp;'; ?>
								</td>
							</tr>
						</tbody>
						<?
						$uom_unit = "Kg";
						$uom_gm = "Grams";
						$tot_return_qty += $row[csf('returnable_qnty')];
						$tot_bag += $no_of_bags_val;
						$tot_cone += $row[csf('cone_per_bag')];
						$tot_w_bag += $row[csf('weight_per_bag')];
						$tot_w_cone += $row[csf('weight_per_cone')];
						$req_no = $row[csf('requisition_no')];
						$i++;
					}
					?>
					<tr bgcolor="#CCCCCC" style="font-size:16px">
						<td align="right" colspan="6"><b>Total</b></td>
						<td align="right">
							<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
						</td>
						<td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
						<td><? echo 'N:' . number_format($tot_bag, 2);
						if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
						echo '<br>W:' . number_format($tot_w_bag, 2);
						if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
						<td align="right" colspan="3">&nbsp;</td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td colspan="14" align="left"><b>In
						Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
					</tr>
				</table>
			</div>
			<br>
			<!--=====================================-->
			<?
			if ($show_val_column == 1)
			{
				if ($dataArray[0][csf('issue_basis')] == 3)
				{
					?>
					<table width="1010" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
						<thead>
							<th width="20">SL</th>
							<th width="60">Program No & Date</th>
							<th width="120">Fabrication</th>
							<th width="40">GSM</th>
							<th width="45">F. Dia</th>
							<th width="80">Dia Type</th>
							<th width="50">S/L</th>
							<th width="60">Color</th>
							<th width="60">Color Range</th>
							<th width="70">Machine Dia & GG</th>
							<th width="70">Prpgram Qty.</th>
							<th width="120">Yarn Description</th>
							<th width="50">Lot</th>
							<th width="70">Yarn Qty.(KG)</th>
							<th>Remarks</th>
						</thead>
						<?
						$knit_id_array = array();
						$prod_id_array = array();
						$rqsn_array = array();

						$reqsn_dataArray = sql_select("SELECT knit_id, requisition_no, prod_id,sum(no_of_cone) as no_of_cone , sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where knit_id in($program_ids) and status_active=1 and is_deleted=0 group by knit_id, prod_id, requisition_no");
						foreach ($reqsn_dataArray as $row) {
							$prod_id_array[$row[csf('knit_id')]][$row[csf('prod_id')]] = $row[csf('yarn_qnty')];
							$knit_id_array[$row[csf('knit_id')]] .= $row[csf('prod_id')] . ",";
							$rqsn_array[$row[csf('prod_id')]]['reqsn'] .= $row[csf('requisition_no')] . ",";
							$rqsn_array[$row[csf('prod_id')]]['qnty'] += $row[csf('yarn_qnty')];
							$rqsn_array[$row[csf('prod_id')]]['no_of_cone'] += $row[csf('no_of_cone')];
							$prod_id .= $row[csf('prod_id')].',';
						}
						$prod_ids = implode(",", array_unique(explode(",", chop($prod_id,','))));

						$product_details_array = array();
						$sql = "SELECT id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where id in($prod_ids) and item_category_id=1 and status_active=1 and is_deleted=0";
						$result = sql_select($sql);

						foreach ($result as $row) {
							$compos = '';
							if ($row[csf('yarn_comp_percent2nd')] != 0)
							{
								$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
							} else {
								$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
							}

							$product_details_array[$row[csf('id')]]['desc'] = $count_arr[$row[csf('yarn_count_id')]] . " " . $compos . " " . $yarn_type[$row[csf('yarn_type')]];
							$product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
							$product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
							$product_details_array[$row[csf('id')]]['color'] = $color_library[$row[csf('color')]];
						}

						$i = 1;
						$s = 1;
						$tot_program_qnty = 0;
						$tot_yarn_reqsn_qnty = 0;
						$company_id = '';
						$sql = "SELECT a.company_id, a.fabric_desc, a.gsm_weight, a.dia, a.width_dia_type, b.id as program_id, b.color_id, b.color_range, b.machine_dia, b.width_dia_type as diatype, b.machine_gg, b.fabric_dia, b.program_qnty, b.program_date, b.stitch_length,b.spandex_stitch_length,b.feeder, b.machine_id, b.start_date, b.end_date, b.remarks from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id in($program_ids) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
						//echo $sql;
						$nameArray = sql_select($sql);
						foreach ($nameArray as $row)
						{
							if ($i % 2 == 0)
								$bgcolor = "#E9F3FF";
							else
								$bgcolor = "#FFFFFF";

							$color = '';
							$color_id = explode(",", $row[csf('color_id')]);

							foreach ($color_id as $val) {
								if ($color == '')
									$color = $color_name_arr[$val];
								else
									$color .= "," . $color_name_arr[$val];
							}

							if ($company_id == '')
								$company_id = $row[csf('company_id')];

							$machine_no = '';
							$machine_id = explode(",", $row[csf('machine_id')]);

							foreach ($machine_id as $val) {
								if ($machine_no == '')
									$machine_no = $machine_arr[$val];
								else
									$machine_no .= "," . $machine_arr[$val];
							}

							if ($knit_id_array[$row[csf('program_id')]] != "")
							{
								$all_prod_id = explode(",", substr($knit_id_array[$row[csf('program_id')]], 0, -1));
								$row_span = count($all_prod_id);
								$z = 0;
								foreach ($all_prod_id as $prod_id)
								{
									?>
									<tr bgcolor="<? echo $bgcolor; ?>">
										<?
										if ($z == 0)
										{
											?>
											<td width="20" rowspan="<? echo $row_span; ?>"><? echo $i; ?></td>
											<td width="60" rowspan="<? echo $row_span; ?>" align="center"><? echo $row[csf('program_id')] . '<br>' . change_date_format($row[csf('program_date')]); ?></td>
											<td width="120" rowspan="<? echo $row_span; ?>"><p><? echo $row[csf('fabric_desc')]; ?></p></td>
											<td width="40" rowspan="<? echo $row_span; ?>"><p><? echo $row[csf('gsm_weight')]; ?></p></th>
											<td width="45" rowspan="<? echo $row_span; ?>"><p><? echo $row[csf('fabric_dia')]; ?></p></td>
											<td width="80" rowspan="<? echo $row_span; ?>"><p><? echo $fabric_typee[$row[csf('diatype')]]; ?></p></td>
											<td width="50" rowspan="<? echo $row_span; ?>"><p><? echo $row[csf('stitch_length')]; ?></p></td>
											<td width="60" rowspan="<? echo $row_span; ?>"><p><? echo $color; ?></p></td>
											<td width="60" rowspan="<? echo $row_span; ?>"><p><? echo $color_range[$row[csf('color_range')]]; ?></p></td>
											<td width="70" rowspan="<? echo $row_span; ?>"><p><? echo $row[csf('machine_dia')] . "X" . $row[csf('machine_gg')]; ?></p></td>
											<td width="70" align="right" rowspan="<? echo $row_span; ?>"><? echo number_format($row[csf('program_qnty')], 2, '.', ''); ?>&nbsp;</td>
											<?
											$tot_program_qnty += $row[csf('program_qnty')];
											$i++;
										}
										?>
										<td width="120"><p><? echo $product_details_array[$prod_id]['desc']; ?>&nbsp;</p></td>
										<td width="50"><p><? echo $product_details_array[$prod_id]['lot']; ?>&nbsp;</p></td>
										<td width="70" align="right"><? echo number_format($prod_id_array[$row[csf('program_id')]][$prod_id], 2, '.', ''); ?></td>
										<?
										if ($z == 0) {
											?>
											<td rowspan="<? echo $row_span; ?>"><p><? echo $row[csf('remarks')]; ?>&nbsp;</p></td>
											<?
										}
										?>
									</tr>
									<?
									$tot_yarn_reqsn_qnty += $prod_id_array[$row[csf('program_id')]][$prod_id];
									$z++;
								}
							}
							else
							{
								?>
								<tr bgcolor="<? echo $bgcolor; ?>">
									<td width="20"><? echo $i; ?></td>
									<td width="60" align="center"><? echo $row[csf('program_id')] . '<br>' . change_date_format($row[csf('program_date')]); ?></td>
									<td width="120"><p><? echo $row[csf('fabric_desc')]; ?></p></td>
									<td width="40"><p><? echo $row[csf('gsm_weight')]; ?></p></th>
									<td width="45"><p><? echo $row[csf('fabric_dia')]; ?></p></td>
									<td width="80"><p><? echo $fabric_typee[$row[csf('diatype')]]; ?></p></td>
									<td width="50"><p><? echo $row[csf('stitch_length')]; ?></p></td>
									<td width="60"><p><? echo $color; ?></p></td>
									<td width="60"><p><? echo $color_range[$row[csf('color_range')]]; ?></p></td>
									<td width="70"><p><? echo $row[csf('machine_dia')] . "X" . $row[csf('machine_gg')]; ?></p></td>
									<td width="70" align="right"><? echo number_format($row[csf('program_qnty')], 2, '.', ''); ?>&nbsp;</td>
									<td width="120"><p>&nbsp;</p></td>
									<td width="50"><p>&nbsp;</p></td>
									<td width="70" align="right">&nbsp;</td>
									<td><p><? echo $row[csf('remarks')]; ?>&nbsp;</p></td>
								</tr>
								<?
								$tot_program_qnty += $row[csf('program_qnty')];
								$i++;
							}
						}
						?>

						<tfoot>
							<th colspan="10" align="right"><b>Total</b></th>
							<th align="right"><? echo number_format($tot_program_qnty, 2, '.', ''); ?>&nbsp;</th>
							<th>&nbsp;</th>
							<th>&nbsp;</th>
							<th align="right"><? echo number_format($tot_yarn_reqsn_qnty, 2, '.', ''); ?></th>
							<th>&nbsp;</th>
						</tfoot>
					</table>
					<br>
					<?
					$sql_collarCuff=sql_select("SELECT id, body_part_id, grey_size, finish_size, qty_pcs from ppl_planning_collar_cuff_dtls where status_active=1 and is_deleted=0 and dtls_id in($program_ids) order by id");
					if(count($sql_collarCuff)>0)
					{
						?>
						<table width="500" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
							<thead>
								<tr>
									<th width="50">SL</th>
									<th width="100">Body Part</th>
									<th width="100">Grey Size</th>
									<th width="100">Finish Size</th>
									<th>Quantity Pcs</th>
								</tr>
							</thead>
							<tbody>
								<?
								$i=1; $total_qty_pcs=0;
								foreach($sql_collarCuff as $row)
								{
									if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
									?>
									<tr>
										<td align="center"><p><? echo $i; ?>&nbsp;</p></td>
										<td><p><? echo $body_part[$row[csf('body_part_id')]]; ?>&nbsp;</p></td>
										<td><p><? echo $row[csf('grey_size')]; ?>&nbsp;</p></td>
										<td><p><? echo $row[csf('finish_size')]; ?>&nbsp;</p></td>
										<td align="right"><p><? echo number_format($row[csf('qty_pcs')],0); $total_qty_pcs+=$row[csf('qty_pcs')]; ?>&nbsp;&nbsp;</p></td>
									</tr>
									<?
									$i++;
								}
								?>
							</tbody>
							<tfoot>
								<tr>
									<th></th>
									<th></th>
									<th></th>
									<th align="right">Total</th>
									<th align="right"><? echo number_format($total_qty_pcs,0); ?>&nbsp;</th>
								</tr>
							</tfoot>
						</table>
						<br>
						<?
					}

					$sql_strip = "SELECT a.color_number_id, a.stripe_color, a.measurement, a.uom, b.dtls_id as program_id, b.no_of_feeder as no_of_feeder, c.body_part_id from wo_pre_stripe_color a, ppl_planning_feeder_dtls b, wo_pre_cost_fabric_cost_dtls c where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.color_number_id=b.color_id and a.stripe_color=b.stripe_color_id and b.dtls_id in($program_ids) and b.no_of_feeder>0 and a.status_active=1 and a.is_deleted=0";
					//echo $sql_strip;
					$result_stripe = sql_select($sql_strip);
					$strip_dtls_arr=array();
					foreach ($result_stripe as $row)
					{
						$strip_dtls_arr[$row[csf('program_id')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['no_of_feeder']=$row[csf('no_of_feeder')];
						$strip_dtls_arr[$row[csf('program_id')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['measurement']=$row[csf('measurement')];
						$strip_dtls_arr[$row[csf('program_id')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['uom']=$row[csf('uom')];
					}

					$body_row_arr=array();
					foreach($strip_dtls_arr as $program => $program_val)
	                {
						$body_row_span=0;
						foreach($program_val as $body_id=>$body_part_val)
						{
							$color_row_span=0;
							foreach($body_part_val as $gmt_color => $color_val)
							{
								foreach($color_val as $strip_color => $row)
								{
									$body_row_span++;
									$color_row_span++;
								}
								$body_row_arr[$program] = $body_row_span;
								$color_row_arr[$program][$body_id] = $color_row_span;
							}
						}
					}

					if (count($result_stripe) > 0)
					{
						?>
						<table cellspacing="0" cellpadding="0" border="1" rules="all" width="600" class="rpt_table" >
							<thead>
								<tr>
									<th colspan="8">Stripe Measurement</th>
								</tr>
								<tr>
									<th width="30">SL</th>
									<th width="80">Prog. no</th>
									<th width="80">Body Part</th>
									<th width="100">Color</th>
									<th width="100">Stripe Color</th>
									<th width="100">Measurement</th>
									<th width="50">UOM</th>
									<th>No Of Feeder</th>
								</tr>
							</thead>
							<?
							$i = 1;
							$tot_feeder = 0;
							foreach($strip_dtls_arr as $program => $program_val)
			                {
								$p=0;
								foreach($program_val as $body_id=>$body_part_val)
								{
									$b=0;
									foreach($body_part_val as $gmt_color => $color_val)
									{
										foreach($color_val as $strip_color => $row)
										{
											if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
											$tot_feeder += $row[('no_of_feeder')];
											$body_row  = $body_row_arr[$program];
											$color_row = $color_row_arr[$program][$body_id];
											?>
											<tr valign="middle" bgcolor="<? echo $bgcolor; ?>" id="search<? echo $i; ?>">
												<td width="30" align="center"><? echo $i; ?></td>
												<td width="80" align="center"><? echo $program; ?></td>
												<?
												if($p==0)
												{
													?>
													<td width="80" rowspan="<? echo $body_row;?>" align="center"><? echo $body_part[$body_id]; ?></td>
													<?
												}
												if($p==0)
												{
													?>
													<td width="100" rowspan="<? echo $color_row;?>"><p><? echo $color_name_arr[$gmt_color]; ?></p></td>
													<?
												}
												?>
												<td width="100"><p><? echo $color_name_arr[$strip_color]; ?></p></td>
												<td width="100" align="center"><? echo $row[('measurement')]; ?></td>
												<td width="50" align="center"><p><? echo $unit_of_measurement[$row[('uom')]]; ?></p></td>
												<td align="right" style="padding-right:10px"><? echo $row[('no_of_feeder')]; ?>&nbsp;</td>
											</tr>
											<?
											$tot_masurement += $row[('measurement')];
											$i++;$p++;$b++;
										}
									}
								}
							}
							?>
							<tfoot>
								<th colspan="5">Total</th>
								<th>&nbsp;</th>
								<th>&nbsp;</th>
								<th style="padding-right:10px"><? echo $tot_feeder; ?>&nbsp;</th>
							</tfoot>
							<?
						}
						?>
					</table>
					<br>
                    <?
                    if ($mst_id != 1)
                    {
                    	$z = 1;
                    	$k = 1;

            			$colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

        				$booking_al = "";
                    	foreach ($colorArray as $book) {
                    		if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];
                    	}

                    	$booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
                    	$booking_count = count(array_unique(explode(',', $booking_no)));

                    	if ($dataArray[0][csf('issue_purpose')] == 2) {
                    		$booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
                    	} else {
                    		$booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
                    	}

                    	$booking_job_no = $booking_job[0][csf('job_no')];
                    	unset($booking_job);

                    	if ($db_type == 0) $poNoCond = "group_concat(id)";
                    	else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";

						$sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

						$job_po = $sql_returnJob[0][csf('po_break_down_id')];
						unset($sql_returnJob);

						$returnJob = '';
						$returnPo = '';
						if ($db_type == 0)
						{
							$booking_cond = "group_concat(a.booking_no)";
							$wo_cond = "group_concat(a.ydw_no)";
							$reqs_no = "group_concat(b.requisition_no)";
						}
						else if ($db_type == 2)
						{
							$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
							$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
							$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
						}

						if ($dataArray[0][csf('issue_purpose')] == 8)
						{
							$sql_returnJob = sql_select("SELECT a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.id=b.booking_mst_id and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
						}
						else if ($dataArray[0][csf('issue_purpose')] == 2)
						{
							$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

							if ($db_type == 0) $poNoCond = "group_concat(id)";
							else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
							$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
						}
						else
						{
							$sql_returnJob = sql_select("select a.job_no, a.booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.id=b.booking_mst_id and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' and a.booking_no in($booking_no) group by a.job_no,a.booking_no");
						}

						$returnJob = $sql_returnJob[0][csf('job_no')];
										//$returnPo=$sql_po[0][csf('po_break_down_id')];
						$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
						$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
						$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
						unset($sql_returnJob);
						?>
						<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
						cellspacing="0" class="rpt_table">
							<thead>
								<tr>
									<th colspan="6" align="center">Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking
									Job Deatils]</p></th>
								</tr>
								<tr>
									<th>Buyer</th>
									<th>Job</th>
									<th>Req. Qty</th>
									<th>Cuml. Issue Qty</th>
									<th>Balance Qty</th>
									<th>Remarks</th>
								</tr>
							</thead>
							<?
							$all_requ_no = "";
							if ($dataArray[0][csf('issue_purpose')] != 8)
							{
								$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");

								//$all_requ_no="'".$all_booking_sql[0][csf('requisition_no')]."'";
								$all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
							}
							if ($dataArray[0][csf('issue_purpose')] == 8)
							{
								$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");    //
								$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
							}
							else if ($dataArray[0][csf('issue_purpose')] == 2)
							{
								if ($all_requ_no != "" || $all_requ_no != 0) {
									$req_cond = "or a.requisition_no in ($all_requ_no)";
									$reqRet_cond = "or b.booking_no in ($all_requ_no)";
								} else {
									$req_cond = "or a.requisition_no in (0)";
									$reqRet_cond = "or b.booking_no in (0)";
								}

								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
							}
							else
							{
								if ($all_requ_no != "" || $all_requ_no != 0) {
									$req_cond = "or a.requisition_no in ($all_requ_no)";
									$reqRet_cond = "or b.booking_no in ($all_requ_no)";
								} else {
									$req_cond = "or a.requisition_no in (0)";
									$reqRet_cond = "or b.booking_no in (0)";
								}
								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");


								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
							}
							$cumulative_qty = 0;
							if ($booking_count == 1)
							{
								?>
								<tbody>
									<tr>
										<td align="center">
											<? echo $buyer_arr[$job_array[$booking_job_no]['buyer']]; ?>
										</td>
										<td align="center">
											<? echo $job_array[$booking_job_no]['job']; ?>
										</td>
										<td align="center">
											<? echo number_format($returnReqQty, 3); ?>
										</td>
										<td align="center">
											<? $cumulative_qty = $total_issue_qty - $total_return_qty;
											echo number_format($cumulative_qty, 3); ?>
										</td>
										<td align="center">
											<? $balance_qty = $returnReqQty - $cumulative_qty;
											echo number_format($balance_qty, 3); ?>
										</td>
										<td align="center">
											<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
										</td>
									</tr>
								</tbody>
								<?
							}
							?>
						</table>
						<?
					}
				}
				if ($dataArray[0][csf('issue_basis')] == 1)
				{
					?>
					<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
					cellspacing="0" class="rpt_table">
						<thead>
							<tr>
								<th colspan="6" align="center">
									Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
										if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
									} ?> </th>
							</tr>
							<tr>
								<th>Buyer</th>
								<th>Job</th>
								<th>Req. Qty</th>
								<th>Cuml. Qty</th>
								<th>Balance Qty</th>
								<th>Remarks</th>
							</tr>
						</thead>
						<?
						//$booking_job_arr=array();
						$returnJob = '';
						$returnPo = '';
						if ($db_type == 0) {
							$booking_cond = "group_concat( distinct a.booking_no)";
							$wo_cond = "group_concat(a.ydw_no)";
							$reqs_no = "group_concat(b.requisition_no)";
						} else if ($db_type == 2) {
							$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
							$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
							$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
						}

						if ($dataArray[0][csf('issue_purpose')] == 8)
						{
							$sql_returnJob = sql_select("SELECT a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.id=b.booking_mst_id and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
						}
						else if ($dataArray[0][csf('issue_purpose')] == 2)
						{
							if ($dataArray[0][csf('buyer_job_no')] != '')
							{
								$sql_returnJob = sql_select("SELECT b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

								if ($db_type == 0) $poNoCond = "group_concat(id)";
								else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
								$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
							}
							else
							{
								$sql_returnJob = sql_select("SELECT a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
							}
						}
						else
						{
							//echo "select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
							$sql_returnJob = sql_select("SELECT a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.id=b.booking_mst_id and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");//and a.booking_no='".$dataArray[0][csf('booking_no')]."'
						}
						$returnJob = $sql_returnJob[0][csf('job_no')];
						$returnPo = $sql_po[0][csf('po_break_down_id')];
						$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
						$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

						$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
						unset($sql_returnJob);

						$all_requ_no = "";
						if ($dataArray[0][csf('issue_purpose')] != 8)
						{
							//echo "select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no";
							$all_booking_sql = sql_select("SELECT $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

							$all_requ_no = $all_booking_sql[0][csf('requisition_no')];
							unset($all_booking_sql);
						}

						if ($dataArray[0][csf('issue_purpose')] == 8)
						{
							$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");    //
							$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
						}
						else if ($dataArray[0][csf('issue_purpose')] == 2)
						{

							if ($dataArray[0][csf('buyer_job_no')] != "")
							{
								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
							}
							else
							{
								//echo "select sum(a.cons_quantity) as total_issue_qty from inv_transaction a, inv_issue_master b where b.id=a.mst_id and b.booking_no='".$dataArray[0][csf('booking_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.buyer_job_no<>'' and b.issue_purpose=2";
								$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
								$total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
							}
						}
						else
						{
							if ($dataArray[0][csf('buyer_job_no')] != "")
							{
								if ($all_requ_no != "" || $all_requ_no != 0) {
									$req_cond = "or a.requisition_no in ($all_requ_no)";
									$reqRet_cond = "or b.booking_no in ($all_requ_no)";
								} else {
									$req_cond = "";//or a.requisition_no in (0)
									$reqRet_cond = "";//or b.booking_no in (0)
								}
										$total_issue_qty = 0;
								//echo "select sum(c.quantity) as total_issue_qty from inv_transaction a, inv_issue_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2";
								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2";
								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");

								//$total_issue_qty=return_field_value("sum(quantity) as total_issue_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=2 and entry_form=3","total_issue_qty");
								//$total_return_qty=return_field_value("sum(quantity) as total_return_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=4 and entry_form=8","total_return_qty");
							}
						}
						?>
						<tbody>
							<tr>
								<td align="center">
									<?
									if ($dataArray[0][csf('issue_purpose')] == 8) echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
									else echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
									?>
								</td>
								<td align="center">
									<? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
								</td>
								<td align="center" style="font-size:18px">
									<b><? echo number_format($returnReqQty, 3); ?></b>
								</td>
								<td align="center" style="font-size:18px">
									<b><? $cumulative_qty = 0;
									$cumulative_qty = $total_issue_qty - $total_return_qty;
									echo number_format($cumulative_qty, 3); ?></b>
								</td>
								<td align="center" style="font-size:18px">
									<b><? $balance_qty = $returnReqQty - $cumulative_qty;
									echo number_format($balance_qty, 3); ?></b>
								</td>
								<td align="center">
									<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
								</td>
							</tr>
						</tbody>
					</table>
					<?
				}
			}
			?>
			<br>
			<? echo signature_table(49, $company, "1030px"); ?>
		</div>
	</div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		function generateBarcode(valuess)
		{
            var value = valuess;//$("#barcodeValue").val();
            var btype = 'code39';//$("input[name=btype]:checked").val();
            var renderer = 'bmp';// $("input[name=renderer]:checked").val();
            var settings = {
            	output: renderer,
            	bgColor: '#FFFFFF',
            	color: '#000000',
            	barWidth: 1,
            	barHeight: 30,
            	moduleSize: 5,
            	posX: 10,
            	posY: 20,
            	addQuietZone: 1
            };
            $("#barcode_img_id").html('11');
            value = {code: value, rect: false};
            $("#barcode_img_id").show().barcode(value, btype, settings);
        }
        generateBarcode('<? echo $system_no; ?>');
    </script>
    <?
    exit();
}

if($action=="existing_issues_view")
{
		echo load_html_head_contents("Issue Info", "../../", 1, 1,'','','');
		extract($_REQUEST);

		$receive_basis = str_replace("'", "", $receive_basis);

		if($receive_basis==3)
		{
			//$booking_nos  = "'".implode("','", $booking_array)."'";
			if($req_no!="" && $txt_prod_id!="")
			{

				$sql_booking = "select a.booking_no,b.po_number,sum(a.grey_fab_qnty) as bk_yarn_qty,sum(a.amount) as bk_yarn_value,d.requisition_no,d.knit_id,d.prod_id,c.po_id,c.program_qnty,d.yarn_qnty as requsition_qty,e.program_qnty as total_prog_qnty,f.avg_rate_per_unit  from wo_booking_dtls a, wo_po_break_down b , ppl_planning_entry_plan_dtls c , ppl_yarn_requisition_entry d,ppl_planning_info_entry_dtls e,product_details_master f   where  a.po_break_down_id=b.id and b.id=c.po_id and a.job_no=b.job_no_mst and a.booking_no=c.booking_no and c.dtls_id = d.knit_id and c.dtls_id=e.id and d.prod_id=f.id and d.requisition_no=$req_no and d.prod_id=$txt_prod_id and c.company_id=$cbo_company_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 group by a.booking_no,b.po_number,d.requisition_no,d.knit_id,d.prod_id,c.po_id,c.program_qnty,d.yarn_qnty,e.program_qnty,f.avg_rate_per_unit ";

				$sql_booking_data = sql_select($sql_booking);

				foreach ($sql_booking_data as $row) {
					/*$booking_array[$row[csf('booking_no')]]['po_number']  		= $row[csf('po_number')];
					$booking_array[$row[csf('booking_no')]]['bk_yarn_qty']  	= $row[csf('bk_yarn_qty')];
					$booking_array[$row[csf('booking_no')]]['bk_yarn_value']	= $row[csf('bk_yarn_value')];
					$booking_array[$row[csf('booking_no')]]['program_qnty'] 	= $row[csf('program_qnty')];
					$booking_array[$row[csf('booking_no')]]['requsition_qty']	= $row[csf('requsition_qty')];*/
					$total_prog_qnty = $row[csf('total_prog_qnty')];
					$po_program_qnty = $row[csf('program_qnty')];
					$perc 			 = ($po_program_qnty / $total_prog_qnty) * 100;
					$req_qnty 		 = ($row[csf('requsition_qty')] / 100)*$perc;

					$requisition_qnty_array[$row[csf('po_id')]][$row[csf('requisition_no')]][$row[csf('prod_id')]]+=$req_qnty;
					$planning_array[$row[csf('po_id')]][$row[csf('prod_id')]]['req_qnty']+=$req_qnty;
					$po_id_arr[$row[csf('po_id')]] = $row[csf('po_id')];
				}
				//unset($sql_booking_data);

				//echo "<pre>";
				//print_r($requisition_qnty_array);
				$po_ids  = implode(",",array_unique($po_id_arr));
				/*
				$gmtsitem_ratio_array=array();
				$grmnt_items = "";
				$grmts_sql = "select a.job_no,a.gmts_item_id,a.set_item_ratio from wo_po_details_mas_set_details a,wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($po_ids) and b.status_active=1 and b.is_deleted=0 ";
				$grmts_data = sql_select($grmts_sql);
				foreach($grmts_data as $key=>$val)
				{
					$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].",";
					$gmtsitem_ratio_array[$val[csf('job_no')]][$val[csf('gmts_item_id')]]=$val[csf('set_item_ratio')];
				}
				$grmnt_items = rtrim($grmnt_items,",");


				$costing_per="";
				$costing_per_qnty=0;

				$costing_per_id=return_field_value( "a.costing_per as costing_per", "wo_pre_cost_mst a,wo_po_break_down b","a.job_no=b.job_no_mst and b.id in($po_ids) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0","costing_per");

				if($costing_per_id==1)
				{
					$costing_per="1 Dzn";
					$costing_per_qnty=12;
				}
				if($costing_per_id==2)
				{
					$costing_per="1 Pcs";
					$costing_per_qnty=1;
				}
				if($costing_per_id==3)
				{
					$costing_per="2 Dzn";
					$costing_per_qnty=24;
				}
				if($costing_per_id==4)
				{
					$costing_per="3 Dzn";
					$costing_per_qnty=36;
				}
				if($costing_per_id==5)
				{
					$costing_per="4 Dzn";
					$costing_per_qnty=48;
				}

				$sql_yarn="select c.item_number_id,c.order_quantity ,c.plan_cut_qnty,f.job_no,f.color,f.count_id,f.copm_one_id,f.percent_one,f.copm_two_id,f.percent_two,f.type_id,f.cons_ratio,f.cons_qnty,f.avg_cons_qnty,f.rate,f.amount,e.requirment from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e,wo_pre_cost_fab_yarn_cost_dtls f where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no and a.job_no=f.job_no and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and d.id=f.fabric_cost_dtls_id and b.id in ($po_ids) and e.cons !=0 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1";

				$yarn_data = sql_select($sql_yarn);

				foreach($yarn_data as $sql_y_r)
				{
					$set_item_ratio=$gmtsitem_ratio_array[$sql_y_r[csf('job_no')]][$sql_y_r[csf('item_number_id')]];

					$cons_qnty = def_number_format((($sql_y_r[csf("requirment")]*$sql_y_r[csf("cons_ratio")]/100)*($sql_y_r[csf("plan_cut_qnty")]/($costing_per_qnty*$set_item_ratio))),5,"");

					$avg_cons_qnty = def_number_format(($sql_y_r[csf("avg_cons_qnty")]*($sql_y_r[csf("plan_cut_qnty")]/($order_price_per_dzn*$set_item_ratio))),5,"");

					$amount = def_number_format(($cons_qnty*$sql_y_r[csf("rate")]),5,"");
					$yarn_data_array[$sql_y_r[csf("count_id")]][$sql_y_r[csf("copm_one_id")]][$sql_y_r[csf("percent_one")]][$sql_y_r[csf("copm_two_id")]][$sql_y_r[csf("percent_two")]][$sql_y_r[csf("type_id")]][$sql_y_r[csf("color")]][$sql_y_r[csf("rate")]][qnty]+=$cons_qnty;

					$yarn_data_array[$sql_y_r[csf("count_id")]][$sql_y_r[csf("copm_one_id")]][$sql_y_r[csf("percent_one")]][$sql_y_r[csf("copm_two_id")]][$sql_y_r[csf("percent_two")]][$sql_y_r[csf("type_id")]][$sql_y_r[csf("color")]][$sql_y_r[csf("rate")]][avg_qnty]+=$avg_cons_qnty;

					$yarn_data_array[$sql_y_r[csf("count_id")]][$sql_y_r[csf("copm_one_id")]][$sql_y_r[csf("percent_one")]][$sql_y_r[csf("copm_two_id")]][$sql_y_r[csf("percent_two")]][$sql_y_r[csf("type_id")]][$sql_y_r[csf("color")]][$sql_y_r[csf("rate")]][amount]+=$amount;
				}
				*/

				$sql_po = "select a.id, sum(order_quantity) as po_qnty_in_pcs  from wo_po_break_down a, wo_po_color_size_breakdown b where a.id=b.po_break_down_id and a.status_active=1 and a.is_deleted=0 and a.id in($po_ids) group by a.id";
				$po_data = sql_select($sql_po);

				$po_array = array();
				foreach ($po_data as $row) {
					$po_array[$row[csf('id')]]['po_qnty_in_pcs'] = $row[csf('po_qnty_in_pcs')];
					//$po_array[$row[csf('id')]]['amount'] = ($row[csf('po_qnty_in_pcs')]*$row[csf('rate')]);
				}
				unset($po_data);

				$sql_allocation = "select booking_no,po_break_down_id,item_id,sum(qnty) as allocation_qty from inv_material_allocation_dtls where item_category=1 and item_id=$txt_prod_id and status_active=1 and is_deleted=0 group by booking_no,po_break_down_id,item_id";

				$allocation_data = sql_select($sql_allocation);
				$allocation_array = array();
				foreach ($allocation_data as $row) {
					$allocation_array[$row[csf('booking_no')]][$row[csf('item_id')]][$row[csf('po_break_down_id')]] = $row[csf('allocation_qty')];
				}
				unset($allocation_data);

				$sql_issue = "select b.requisition_no,b.prod_id,sum(c.quantity) as issue_qty,sum(b.cons_amount) as cons_amount,c.po_breakdown_id from inv_issue_master a, inv_transaction b,order_wise_pro_details c where a.id=b.mst_id and b.id=c.trans_id and b.prod_id=c.prod_id and a.company_id=$cbo_company_id and a.entry_form in(3) and b.requisition_no=$req_no and b.prod_id=$txt_prod_id and b.company_id=$cbo_company_id and a.issue_basis=3 and a.issue_purpose=1 and a.item_category=1 and b.item_category=1 and b.transaction_type in(2) and c.trans_type in(2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.requisition_no,b.prod_id,c.po_breakdown_id";

				$issue_data = sql_select($sql_issue);

				$issue_array = array();
				foreach ($issue_data as $row) {
					$issue_array[$row[csf('requisition_no')]][$row[csf('po_breakdown_id')]][$row[csf('prod_id')]]['issue_qty'] = $row[csf('issue_qty')];
					$issue_array[$row[csf('requisition_no')]][$row[csf('po_breakdown_id')]][$row[csf('prod_id')]]['issue_value'] = $row[csf('cons_amount')];
				}
				unset($issue_data);

			}
		}
		?>
		<fieldset style="width:1080px; margin-left:3px">

			<table border="1" class="rpt_table" rules="all" width="1070" cellpadding="0" cellspacing="0" align="center">
				<thead>
					<tr>
						<th width="30">Sl</th>
						<th width="100">Booking No</th>
						<th width="135">PO No</th>
						<th width="80">PO Qty (Pcs)</th>
						<th width="80">BK Yarn Qty</th>
						<th width="80">BK Yarn Value</th>
						<th width="80">Allocated Yarn Qty</th>
						<th width="80">Program Qty</th>
						<th width="80">Issue Req. Qty</th>
						<th width="80">Cum. Iss. Qty</th>
						<th width="80">Cum. Iss. Value</th>
						<th width="80">Balance Qty</th>
						<th width="80">Balance Value</th>
					</tr>
				</thead>
			</table>

			<div style="width:1070px;" id="scroll_body" align="center">
				<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1070" class="rpt_table"
				id="table_body" align="center">
				<tbody>
					<?
					$k=1;
					foreach ($sql_booking_data as $row)
					{
						$requisition_qnty= $requisition_qnty_array[$row[csf('po_id')]][$row[csf('requisition_no')]][$row[csf('prod_id')]];

						$allocation_qty = $allocation_array[$row[csf('booking_no')]][$row[csf('prod_id')]][$row[csf('po_id')]];
						$po_qty_pcs = $po_array[$row[csf('po_id')]]['po_qnty_in_pcs'];

						$bk_yarn_qty = $row[csf('bk_yarn_qty')];
						$bk_yarn_value = ($bk_yarn_qty*$row[csf('avg_rate_per_unit')]);

						$issue_qnty = $issue_array[$row[csf('requisition_no')]][$row[csf('po_id')]][$row[csf('prod_id')]]['issue_qty'];
						$issue_value = $issue_array[$row[csf('requisition_no')]][$row[csf('po_id')]][$row[csf('prod_id')]]['issue_value'];
						$balance_qty = ($row[csf('bk_yarn_qty')]-$issue_qnty);
						$balance_value = ($bk_yarn_value-$issue_value);
						$bgcolor=($k%2==0)?"#E9F3FF":"#FFFFFF";
						?>
						<tr bgcolor="<? echo  $bgcolor; ?>" onClick="change_color('tr_<? echo $k; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $k;?>">
							<td width="30"><? echo $k; ?></td>
							<td width="100"><? echo $row[csf('booking_no')]; ?></td>
							<td width="135" title="<? echo $row[csf('po_id')];?>"><? echo $row[csf('po_number')]; ?></td>
							<td width="80"><? echo number_format($po_qty_pcs,2); ?></td>
							<td width="80" align="center"><? echo number_format($bk_yarn_qty,2); ?></td>
							<td width="80"><? echo number_format($bk_yarn_value,2,'.',''); ?></td>
							<td width="80"><? echo number_format($allocation_qty,2); ?></td>
							<td width="80" align="center"><? echo number_format($row[csf('program_qnty')],2); ?></td>
							<td width="80" align="center"><? echo number_format($requisition_qnty,2); ?></td>
							<td width="80"><? echo number_format($issue_qnty,2); ?></td>
							<td width="80"><? echo number_format($issue_value,2,'.',''); ?></td>
							<td width="80"><? echo $balance_qty; ?></td>
							<td width="80" align="right"><? echo number_format($balance_value,2,'.',''); ?></td>
						</tr>
						<?
						$k++;
					}
					?>
				</tbody>
				<tfoot>
					<tr class="tbl_bottom">

					</tr>
				</tfoot>
			</table>
		</div>
		</fieldset>
		<?
		exit();
	}

if($action=="multiple_issue_no_popup")
{
	echo load_html_head_contents("Popup Info","../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		function toggle( x, origColor )
		{
			var newColor = 'yellow';
			if ( x.style )
			{
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function check_all_data()
		{
			var tbl_row_count = document.getElementById( 'list_view' ).rows.length;
			tbl_row_count = tbl_row_count-1;
			for( var i = 1; i <= tbl_row_count; i++ )
			{
				var attrData=$('#tr_' +i).attr('onclick');
				var splitArr = attrData.split("'");
				js_set_value( splitArr[1] );
			}
		}

		var selected_id=Array();
		var selected_name=Array();
		function js_set_value(mrr)
		{
			var splitArr = mrr.split("_");
			//$("#hidden_return_number").val(splitArr[1]); // mrr number
			$("#hnd_issue_id").val(splitArr[1]); // id
			toggle( document.getElementById( 'tr_' + splitArr[0] ), '#FFFFCC' );

			if( jQuery.inArray(splitArr[1], selected_id ) == -1 )
			{
				//selected_name.push(splitArr[1]);
				selected_id.push( splitArr[1]);
			}
			else
			{
				for( var i = 0; i < selected_id.length; i++ )
				{
					if( selected_id[i] == splitArr[1]) break;
				}
				//selected_name.splice( i, 1 );
				selected_id.splice( i, 1 );
			}

			var id = ''; var name = '';
			for( var i = 0; i < selected_id.length; i++ )
			{
				id += selected_id[i] + ',';
				//name += selected_name[i] + ',';
			}

			id = id.substr( 0, id.length - 1 );
			//name = name.substr( 0, name.length - 1 );

			$('#hnd_issue_id').val(id);
			//$('#hidden_return_number').val(name);
		}
 	</script>
	</head>
	<body>
		<div align="center" style="width:100%;" >
			<form name="searchorderfrm_1"  id="searchorderfrm_1" autocomplete="off">
				<table width="850" cellspacing="0" cellpadding="0" border="1" rules="all" class="rpt_table" align="center">
					<thead>
						<tr>
							<th width="120" class="must_entry_caption">LC Company</th>
							<th width="120" class="must_entry_caption">Issue To</th>
							<th width="150">Issue No</th>
							<th width="220">Date Range</th>
							<th><input type="reset" name="re_button" id="re_button" value="Reset" style="width:100px" class="formbutton"  /></th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td align="center">
								<?
								echo create_drop_down("cbo_lc_company", 120, "select comp.id, comp.company_name from lib_company comp where comp.status_active=1 and comp.is_deleted=0 $company_cond order by comp.company_name", "id,company_name", 1, "-- Select Company --", $company, "");
								?>
							</td>
                            <td>
                            <?
							if ($company == "" || $company == 0) $company_cod = "";
							else $company_cod = " and id = ".$company;

							if ($knitting_source == 1)
								echo create_drop_down("cbo_issue_to", 120, "select id, company_name from lib_company where status_active=1 and is_deleted=0 order by company_name", "id,company_name", 1, "-- Select --", "", "");
							else if ($knitting_source == 3 && $issue_purpose == 1)
								echo create_drop_down("cbo_issue_to", 120, "select a.id, a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(1,9,20) and a.status_active=1 group by a.id, a.supplier_name order by a.supplier_name", "id,supplier_name", 1, "-- Select --", 0, "", 0);
							else if ($knitting_source == 3 && $issue_purpose == 2)
								echo create_drop_down("cbo_issue_to", 120, "select a.id, a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(1,9,21,24) and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id,supplier_name", 1, "-- Select --", 0, "", 0);
							else if ($knitting_source == 3)
								echo create_drop_down("cbo_issue_to", 120, "select a.id, a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id,supplier_name", 1, "-- Select --", 0, "", 0);
							else if ($knit_source == 0)
								echo create_drop_down("cbo_issue_to", 120, $blank_array, "", 1, "-- Select --", $selected, "", "", "");
							?>
                            </td>
							<td>
								<input type="text" style="width:150px" class="text_boxes"  name="text_issue_no" id="text_issue_no" />
							</td>
							<td align="center">
								<input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:80px" placeholder="From Date" />&nbsp;&nbsp;&nbsp;
								<input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:80px" placeholder="To Date" />
							</td>
							<td align="center">
								<input type="button" name="btn_show" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('cbo_lc_company').value+'_'+document.getElementById('cbo_issue_to').value+'_'+document.getElementById('text_issue_no').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('cbo_year_selection').value, 'multiple_issue_no_listview', 'search_div', 'yarn_issue_controller', 'setFilterGrid(\'list_view\',-1)')" style="width:100px;" />
							</td>
						</tr>
						<tr>
							<td align="center" height="40" valign="middle" colspan="5">
								<? echo load_month_buttons(1);  ?>
							</td>
						</tr>
					</tbody>
				</tr>
			</table>
			<div align="center" style="margin-top:10px" valign="top" id="search_div"> </div>
		</form>
	</div>
	</body>
	<script src="../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
}

if($action=="multiple_issue_no_popup2")
{
	echo load_html_head_contents("Popup Info","../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		function toggle( x, origColor )
		{
			var newColor = 'yellow';
			if ( x.style )
			{
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function check_all_data()
		{
			var tbl_row_count = document.getElementById( 'list_view' ).rows.length;
			tbl_row_count = tbl_row_count-1;
			for( var i = 1; i <= tbl_row_count; i++ )
			{
				var attrData=$('#tr_' +i).attr('onclick');
				var splitArr = attrData.split("'");
				js_set_value( splitArr[1] );
			}
		}

		var selected_id=Array();
		var selected_name=Array();
		function js_set_value(mrr)
		{
			var splitArr = mrr.split("_");
			//$("#hidden_return_number").val(splitArr[1]); // mrr number
			$("#hnd_issue_id").val(splitArr[1]); // id
			toggle( document.getElementById( 'tr_' + splitArr[0] ), '#FFFFCC' );

			if( jQuery.inArray(splitArr[1], selected_id ) == -1 )
			{
				//selected_name.push(splitArr[1]);
				selected_id.push( splitArr[1]);
			}
			else
			{
				for( var i = 0; i < selected_id.length; i++ )
				{
					if( selected_id[i] == splitArr[1]) break;
				}
				//selected_name.splice( i, 1 );
				selected_id.splice( i, 1 );
			}

			var id = ''; var name = '';
			for( var i = 0; i < selected_id.length; i++ )
			{
				id += selected_id[i] + ',';
				//name += selected_name[i] + ',';
			}

			id = id.substr( 0, id.length - 1 );
			//name = name.substr( 0, name.length - 1 );

			$('#hnd_issue_id').val(id);
			//$('#hidden_return_number').val(name);
		}
 	</script>
	</head>
	<body>
		<div align="center" style="width:100%;" >
			<form name="searchorderfrm_1"  id="searchorderfrm_1" autocomplete="off">
				<table width="850" cellspacing="0" cellpadding="0" border="1" rules="all" class="rpt_table" align="center">
					<thead>
						<tr>
							<th width="120" class="must_entry_caption">LC Company</th>
							<th width="120" class="must_entry_caption">Issue To</th>
							<th width="150">Issue No</th>
							<th width="220">Date Range</th>
							<th><input type="reset" name="re_button" id="re_button" value="Reset" style="width:100px" class="formbutton"  /></th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td align="center">
								<?
								echo create_drop_down("cbo_lc_company", 120, "select comp.id, comp.company_name from lib_company comp where comp.status_active=1 and comp.is_deleted=0 $company_cond order by comp.company_name", "id,company_name", 1, "-- Select Company --", $company, "");
								?>
							</td>
                            <td>
                            <?
							if ($company == "" || $company == 0) $company_cod = "";
							else $company_cod = " and id = ".$company;

							if ($knitting_source == 1)
								echo create_drop_down("cbo_issue_to", 120, "select id, company_name from lib_company where status_active=1 and is_deleted=0 order by company_name", "id,company_name", 1, "-- Select --", "", "");
							else if ($knitting_source == 3 && $issue_purpose == 1)
								echo create_drop_down("cbo_issue_to", 120, "select a.id, a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(1,9,20) and a.status_active=1 group by a.id, a.supplier_name order by a.supplier_name", "id,supplier_name", 1, "-- Select --", 0, "", 0);
							else if ($knitting_source == 3 && $issue_purpose == 2)
								echo create_drop_down("cbo_issue_to", 120, "select a.id, a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(1,9,21,24) and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id,supplier_name", 1, "-- Select --", 0, "", 0);
							else if ($knitting_source == 3)
								echo create_drop_down("cbo_issue_to", 120, "select a.id, a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id,supplier_name", 1, "-- Select --", 0, "", 0);
							else if ($knit_source == 0)
								echo create_drop_down("cbo_issue_to", 120, $blank_array, "", 1, "-- Select --", $selected, "", "", "");
							?>
                            </td>
							<td>
								<input type="text" style="width:150px"  value="<?php echo $txt_system_no;?>" class="text_boxes"  name="text_issue_no" id="text_issue_no" />
								<input type="hidden" style="width:150px" readonly value="<?php echo $update_id_mst;?>" class="text_boxes"  name="hidden_text_issue_no" id="hidden_text_issue_no" />
							</td>
							<td align="center">
								<input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:80px" placeholder="From Date" />&nbsp;&nbsp;&nbsp;
								<input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:80px" placeholder="To Date" />
							</td>
							<td align="center">
								<input type="button" name="btn_show" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('cbo_lc_company').value+'_'+document.getElementById('cbo_issue_to').value+'_'+document.getElementById('hidden_text_issue_no').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('cbo_year_selection').value, 'multiple_issue_no_listview2', 'search_div', 'yarn_issue_controller', 'setFilterGrid(\'list_view\',-1)')" style="width:100px;" />
							</td>
						</tr>
						<tr>
							<td align="center" height="40" valign="middle" colspan="5">
								<? echo load_month_buttons(1);  ?>
							</td>
						</tr>
					</tbody>
				</tr>
			</table>
			<div align="center" style="margin-top:10px" valign="top" id="search_div"> </div>
		</form>
	</div>
	</body>
	<script src="../../includes/functions_bottom.js" type="text/javascript"></script>
	<script>
		<?php
		$timestamp = strtotime($txt_issue_date);
		$date = date("Y", $timestamp);

		echo "$('#cbo_year_selection').val(".$date.");";
		?>
	</script>
	</html>
	<?
}

if($action=="multiple_issue_no_listview")
{
	echo '<input type="hidden" id="hnd_issue_id" value="" />';
	$ex_data = explode("_",$data);
	$company = $ex_data[0];
	$issue_to = $ex_data[1];
	$issue_no = $ex_data[2];
	$txt_date_from = $ex_data[3];
	$txt_date_to = $ex_data[4];
	$cbo_year = $ex_data[5];

	//for company
	if($company == 0)
	{
		echo "<p style='font-size:25px; color:#F00'>Please Select LC Company.</p>";
		die;
	}
	else
	{
		$company_cond = " and a.company_id = ".$company;
	}

	//for issue to
	$issue_to_cond = '';
	if($issue_to != 0)
	{
		$issue_to_cond = " and a.knit_dye_company = ".$issue_to;
	}

	//for issue no
	$issue_no_cond = '';
	if($issue_to != 0)
	{
		$issue_no_cond = " and a.issue_number like '%".trim($issue_no)."'";
	}

	//for date
	$date_cond = '';
	if( $txt_date_from != '' && $txt_date_to != '' )
	{
		$date_cond = " and a.issue_date between '".change_date_format($txt_date_from,'','',1)."' and '".change_date_format($txt_date_to,'','',1)."'";
	}
	else
	{
		if (trim($cbo_year) != 0)
		{
			$date_cond = " and to_char(a.insert_date,'YYYY') = ".$cbo_year;
		}
	}

	$year_field = "to_char(a.insert_date,'YYYY') as year,";
	$sql = "select a.id, a.issue_number_prefix_num, a.issue_number, a.issue_basis, a.issue_purpose, a.entry_form, a.item_category, a.company_id, a.location_id, a.supplier_id, a.store_id, a.buyer_id, a.buyer_job_no, a.style_ref, a.booking_id, a.booking_no, a.issue_date, a.sample_type, a.knit_dye_source, a.knit_dye_company, a.challan_no, a.loan_party, a.lap_dip_no, a.gate_pass_no, a.item_color, a.color_range, a.remarks, a.ready_to_approve, a.loan_party,a.is_posted_account , $year_field a.is_approved,sum(b.cons_quantity) issue_quantity
	from inv_issue_master a,inv_transaction b
	where a.id=b.mst_id and b.transaction_type=2 and b.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.entry_form=3".$company_cond.$issue_to_cond.$issue_no_cond.$date_cond."
	group by a.id, a.issue_number_prefix_num, a.issue_number, a.issue_basis, a.issue_purpose, a.entry_form, a.item_category, a.company_id, a.location_id, a.supplier_id, a.store_id, a.buyer_id, a.buyer_job_no, a.style_ref, a.booking_id, a.booking_no, a.issue_date, a.sample_type, a.knit_dye_source, a.knit_dye_company, a.challan_no, a.loan_party, a.lap_dip_no, a.gate_pass_no, a.item_color, a.color_range, a.remarks, a.ready_to_approve, a.loan_party,a.insert_date,a.is_posted_account,a.is_approved order by a.issue_number";
	//echo $sql; die;
	$company_arr = return_library_array("select id,company_name from lib_company","id","company_name");
	//$supplier_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');
	$arr=array(1=>$company_arr);
	echo create_list_view("list_view", "Year, LC Company, Issue No, Issue Date, Issue Qty","60,150,100,70,100","530","230",0, $sql , "js_set_value", "id", "1", 1, "0,company_id,0,0,0", $arr, "year,company_id,issue_number,issue_date,issue_quantity","","","0,0,0,3,1","",1);
	exit();
}

if($action=="multiple_issue_no_listview2")
{
	echo '<input type="hidden" id="hnd_issue_id" value="" />';
	$ex_data = explode("_",$data);
	$company = $ex_data[0];
	$issue_to = str_replace("'",$ex_data[1]);
	$issue_no = $ex_data[2];
	$txt_date_from = $ex_data[3];
	$txt_date_to = $ex_data[4];
	$cbo_year = $ex_data[5];


	$getPass_sql = "select issue_id from inv_gate_pass_mst where issue_id like '%$issue_no%'  and is_deleted=0 and status_active=1";

	$getPassArray = sql_select($getPass_sql);
	$getPassdata = array();

	foreach($getPassArray as $row)
	{
		$getPassdata[] = $row[csf("issue_id")];
	}

	$getPassdata = array_unique($getPassdata);
	$issue_ids = implode(',', $getPassdata);
	//for company
	if($company == 0)
	{
		echo "<p style='font-size:25px; color:#F00'>Please Select LC Company.</p>";
		die;
	}
	else
	{
		$company_cond = " and a.company_id = ".$company;
	}

	//for issue to
	$issue_to_cond = '';
	if($issue_to != 0)
	{
		$issue_to_cond = " and a.knit_dye_company = ".$issue_to;
	}

	//for issue no
	$issue_no_cond = '';
	if($issue_no != '')
	{
		$issue_no_cond = " and a.id in (".trim($issue_ids).")";
	}

	//for date
	$date_cond = '';
	if( $txt_date_from != '' && $txt_date_to != '' )
	{
		$date_cond = " and a.issue_date between '".change_date_format($txt_date_from,'','',1)."' and '".change_date_format($txt_date_to,'','',1)."'";
	}
	else
	{
		if (trim($cbo_year) != 0)
		{
			$date_cond = " and to_char(a.insert_date,'YYYY') = ".$cbo_year;
		}
	}


	$year_field = "to_char(a.insert_date,'YYYY') as year,";
	$sql = "select a.id, a.issue_number_prefix_num, a.issue_number, a.issue_basis, a.issue_purpose, a.entry_form, a.item_category, a.company_id, a.location_id, a.supplier_id, a.store_id, a.buyer_id, a.buyer_job_no, a.style_ref, a.booking_id, a.booking_no, a.issue_date, a.sample_type, a.knit_dye_source, a.knit_dye_company, a.challan_no, a.loan_party, a.lap_dip_no, a.gate_pass_no, a.item_color, a.color_range, a.remarks, a.ready_to_approve, a.loan_party,a.is_posted_account , $year_field a.is_approved,sum(b.cons_quantity) issue_quantity
	from inv_issue_master a,inv_transaction b
	where a.id=b.mst_id and b.transaction_type=2 and b.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.entry_form=3".$company_cond.$issue_to_cond.$issue_no_cond.$date_cond."
	group by a.id, a.issue_number_prefix_num, a.issue_number, a.issue_basis, a.issue_purpose, a.entry_form, a.item_category, a.company_id, a.location_id, a.supplier_id, a.store_id, a.buyer_id, a.buyer_job_no, a.style_ref, a.booking_id, a.booking_no, a.issue_date, a.sample_type, a.knit_dye_source, a.knit_dye_company, a.challan_no, a.loan_party, a.lap_dip_no, a.gate_pass_no, a.item_color, a.color_range, a.remarks, a.ready_to_approve, a.loan_party,a.insert_date,a.is_posted_account,a.is_approved order by a.issue_number";
	//echo $sql; die;
	$company_arr = return_library_array("select id,company_name from lib_company","id","company_name");
	//$supplier_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');
	$arr=array(1=>$company_arr);
	echo create_list_view("list_view", "Year, LC Company, Issue No, Issue Date, Issue Qty","60,150,100,70,100","530","230",0, $sql , "js_set_value", "id", "1", 1, "0,company_id,0,0,0", $arr, "year,company_id,issue_number,issue_date,issue_quantity","","","0,0,0,3,1","",1);
	exit();
}

//for multiple_issue_no_print
if ($action=="multiple_issue_no_print")
{
	extract($_REQUEST);
	$data = explode('*', $data);
	$issue_id = $data[0];


	$buyer_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');

	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$issue_id'";
	//echo $sql;die;

	$dataArray = sql_select($sql);

	$costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[1]");
	foreach ($costing_sql as $row)
	{
		$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
		$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
		$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
		$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
		$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
		$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
		$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];

		$job_intfarray[$row[csf('job_no')]]['grouping'] = $row[csf('grouping')];
	}

	unset($costing_sql);

	$sales_order_array = array();
	$sales_order_sql = sql_select("select a.id,a.sales_booking_no, a.job_no,a.style_ref_no, a.buyer_id,b.job_no po_job_no,b.buyer_id po_buyer,a.within_group from fabric_sales_order_mst a left join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.status_active = 1 and a.is_deleted = 0 and a.company_id=$data[1]");
	foreach ($sales_order_sql as $row)
	{
		$sales_order_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
		$sales_order_array[$row[csf('id')]]['sales_order_no'] = $row[csf('job_no')];
		$sales_order_array[$row[csf('id')]]['po_job_no'] = $row[csf('po_job_no')];
		$sales_order_array[$row[csf('id')]]['sales_booking_no'] = $row[csf('sales_booking_no')];
		$sales_order_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
		$sales_order_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
		$sales_order_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
	}

	$sales_style_des_arr = array();
	$sales_samp_booking_sql = sql_select("SELECT b.booking_no, b.style_des FROM fabric_sales_order_mst a, wo_non_ord_samp_booking_dtls b WHERE a.sales_booking_no = b.booking_no  and a.company_id=$data[1] and b.status_active=1 and b.is_deleted=0");
	foreach ($sales_samp_booking_sql as $row)
	{
		$sales_style_des_arr[$row[csf('booking_no')]]['style_des'] .= $row[csf('style_des')].',';
	}
	unset($sales_samp_booking_sql);

	$stl_array = array();

	$stl_sql = sql_select("select job_no, style_ref_no from wo_po_details_master");
	foreach ($stl_sql as $row)
	{
		$stl_array[$row[csf('style_ref_no')]]['job'] = $row[csf('job_no')];
	}
	//var_dump($stl_array);
	unset($stl_sql);

	$job_no_array = array();
	$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id, po_buyer, customer_buyer from fabric_sales_order_mst where company_id=$data[1]");
	foreach ($jobData as $row)
	{
		$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
		$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
		$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
		$job_no_array[$row[csf('id')]]['po_buyer'] = $row[csf('po_buyer')];
		$job_no_array[$row[csf('id')]]['customer_buyer'] = $row[csf('customer_buyer')];
	}

	if ($db_type == 0)
	{
		$poID = " select c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales";
	}
	else
	{
		$poID = "select c.knit_id, c.requisition_no, a.buyer_id, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id group by c.knit_id, c.requisition_no, a.buyer_id, a.is_sales";
	}
	$poID_sql_result = sql_select($poID);
	foreach ($poID_sql_result as $row)
	{
		$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
		$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];

		$program_array[$row[csf('requisition_no')]]['program_no'] = $row[csf('knit_id')];
		$program_array[$row[csf('requisition_no')]]['poid'] = $row[csf('poid')];
		//$program_array[$row[csf('requisition_no')]]['buyer_id'] = $row[csf('buyer_id')];
	}
	unset($poID_sql_result);

	$sql_issue = "SELECT a.company_id, a.issue_number, a.issue_basis, a.issue_purpose, a.issue_date, a.booking_id, a.booking_no,
	a.knit_dye_company, a.knit_dye_source, a.buyer_id,
	b.id as trans_id, b.requisition_no, b.pi_wo_batch_no, b.prod_id, b.transaction_date, b.store_id, b.floor_id, b.room, sum(b.cons_quantity) as issue_qnty, sum(b.return_qnty) as return_qnty, sum(b.no_of_bags) as no_of_bags, b.remarks,
	c.detarmination_id, c.lot, c.yarn_count_id, c.yarn_comp_type1st, c.yarn_comp_type2nd, c.yarn_comp_percent1st, c.yarn_type, c.color, c.supplier_id, b.booking_without_order,
	LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, d.is_sales, a.buyer_job_no
	FROM inv_issue_master a,  product_details_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id left join fabric_sales_order_mst e on d.po_breakdown_id=e.id
	WHERE a.id=b.mst_id and b.prod_id=c.id
	and a.entry_form=3 and a.item_category=1 and a.id in(".$issue_id.") and a.status_active=1 and a.is_deleted=0
	and b.item_category=1 and b.transaction_type=2
	and b.status_active=1 and b.is_deleted=0
	and c.status_active=1 and c.is_deleted=0
	GROUP BY a.company_id, a.issue_number, a.issue_basis, a.issue_purpose, a.issue_date, a.booking_id, a.booking_no,
	a.knit_dye_company, a.knit_dye_source, a.buyer_id,
	b.id, b.requisition_no, b.pi_wo_batch_no, b.prod_id, b.transaction_date, b.store_id, b.floor_id, b.room, b.remarks,
	c.detarmination_id, c.lot, c.yarn_count_id, c.yarn_comp_type1st, c.yarn_comp_type2nd, c.yarn_comp_percent1st, c.yarn_type, c.color, c.supplier_id, b.booking_without_order, d.is_sales,
	a.buyer_job_no ";
	//echo $sql_issue;
	$sql_issue_rslt = sql_select($sql_issue);
	$pdata = array();
	$trans_id = '';
	$requisition_no = '';
	$supplier_id = '';
	$store_id = '';
	$yarn_count_id = '';
	$color = '';
	$company = 0;
	$knit_dye_company = 0;
	$knit_dye_source = 0;



	foreach($sql_issue_rslt as $row)
	{
		$company = $row[csf('company_id')];
		$knit_dye_company = $row[csf('knit_dye_company')];
		$knit_dye_source = $row[csf('knit_dye_source')];

		$trans_id .= $row[csf('trans_id')].",";
		$supplier_id .= $row[csf('supplier_id')].",";
		$store_id .= $row[csf('store_id')].",";
		$yarn_count_id .= $row[csf('yarn_count_id')].",";
		$color .= $row[csf('color')].",";
		$po_id = explode(",", $row[csf('po_id')]);

		if($row[csf('issue_basis')] == 1  )
		{
			$booking_id .= $row[csf('booking_id')].",";
		}
		else if($row[csf('issue_basis')] == 3)
		{
			$requisition_no .= $row[csf('requisition_no')].",";
		}

	}

	$store_ids = implode(",",array_unique(explode(",",chop($store_id,','))));
	$supplier_ids = implode(",",array_unique(explode(",",chop($supplier_id,','))));
	$yarn_count_ids = implode(",",array_unique(explode(",",chop($yarn_count_id,','))));
	$colorids = implode(",",array_unique(explode(",",chop($color,','))));
	$trans_ids = implode(",",array_unique(explode(",",chop($trans_id,','))));
	$requisition_numbers = implode(",",array_unique(explode(",",chop($requisition_no,','))));
	$booking_ids = implode(",",array_unique(explode(",",chop($booking_id,','))));
	//var_dump($booking_numbers);
	//for company
	$company_library = return_library_array("select id, company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	//for buyer
	$sqlBuyer = sql_select("select id as ID, buyer_name as BUYER_NAME, short_name as SHORT_NAME from lib_buyer");
	foreach($sqlBuyer as $row)
	{
		$buyer_arr[$row['ID']] = $row['SHORT_NAME'];
		$buyer_dtls_arr[$row['ID']] = $row['BUYER_NAME'];
	}
	unset($sqlBuyer);
	//for store
	if($store_ids!="")
	{
		$store_library = return_library_array("select id, store_name from lib_store_location where status_active=1 and is_deleted=0 and id in(".$store_ids.")", "id", "store_name");
	}

	//for supplier
	if($supplier_ids!="")
	{
		$supplier_library = return_library_array("select id,supplier_name from lib_supplier where status_active=1 and is_deleted=0 and id in ($supplier_ids)", "id", "supplier_name");
	}

	//for yarn count
	if($yarn_count_ids!="")
	{
		$count_arr = return_library_array("select id,yarn_count from lib_yarn_count where status_active=1 and is_deleted=0 and id in ($yarn_count_ids)", "id", "yarn_count");
	}

	//for color
	if($colorids!="")
	{
		$color_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0 and id in($colorids)", "id", "color_name");
	}

	$location_arr=return_library_array( "select id, location_name from lib_location",'id','location_name');
	$floor_room_rack_arr = return_library_array("select floor_room_rack_id, floor_room_rack_name from lib_floor_room_rack_mst", 'floor_room_rack_id', 'floor_room_rack_name');

	if($booking_ids!="")
	{
		$sample_sql= "SELECT a.id, a.company_id, c.style_ref_no, c.internal_ref from wo_non_ord_samp_booking_mst  a left join wo_non_ord_samp_booking_dtls b on a.booking_no=b.booking_no  left join sample_development_mst c on b.style_id=c.id and b.status_active=1 and b.is_deleted=0  where a.id in(".$booking_ids.") and a.entry_form_id=140 and  b.entry_form_id=140 and   a.company_id='$company'". set_user_lavel_filtering(' and a.buyer_id','buyer_id')."  and a.booking_type=4 and  a.status_active=1 and a.is_deleted=0  order by b.id desc";
		//echo $sqls;
		$sample_sql_Array=sql_select($sample_sql);
		if(count($sample_sql_Array)>0)
		{
			$sample_alldata_arr = array();
			foreach ($sample_sql_Array as $row)
			{
				$sample_alldata_arr[$row[csf("id")]]['style_ref_no'] = $row[csf("style_ref_no")];
				$sample_alldata_arr[$row[csf("id")]]['internal_ref'] = $row[csf("internal_ref")];
			}
			//var_dump($sample_alldata_arr);
		}
	}

	if($trans_ids!="")
	{
		$job_sql="select a.trans_id, a.po_breakdown_id,c.buyer_name, c.job_no, c.style_ref_no, b.grouping from order_wise_pro_details a, wo_po_break_down b, wo_po_details_master c where a.trans_id in(".$trans_ids.") and a.po_breakdown_id=b.id and b.job_no_mst=c.job_no and b.status_active=1 and b.is_deleted=0 and c.is_deleted=0 and c.status_active=1 group by a.trans_id, a.po_breakdown_id, c.job_no, c.style_ref_no, c.buyer_name, b.grouping order by c.job_no, a.po_breakdown_id";
		$job_result_Array=sql_select($job_sql);
		if(count($job_result_Array)>0)
		{
			$job_alldata_arr = array();
			foreach($job_result_Array as $row)
			{
				$tot_rows++;
				$job_alldata_arr[$row[csf("trans_id")]]['job_no']   	= $row[csf("job_no")];
				$job_alldata_arr[$row[csf("trans_id")]]['style_ref_no'] = $row[csf("style_ref_no")];
				$job_alldata_arr[$row[csf("trans_id")]]['buyer_name']   = $row[csf("buyer_name")];

				if(!empty($job_alldata_arr[$row[csf("trans_id")]]['grouping']))
				{
					$job_alldata_arr[$row[csf("trans_id")]]['grouping'] .= ",".$row[csf("grouping")];
				}
				else
				{
					$job_alldata_arr[$row[csf("trans_id")]]['grouping'] = $row[csf("grouping")];
				}
				$buyer_name.=$row[csf("buyer_name")].",";
			}
			unset($job_result_Array);

			$buyer_ids = implode(",",array_unique(explode(",",chop($buyer_name,','))));
			// if($buyer_ids!="")
			// {
			// 	$buyer_arr = return_library_array( "select id, buyer_name from lib_buyer where status_active=1 and is_deleted=0 and id in($buyer_ids)",'id','buyer_name');
			// }
		}
	}

	if($requisition_numbers !="" )
	{
		$requsition_sql = "select a.knit_id as program_no, a.requisition_no from ppl_yarn_requisition_entry a where a.status_active=1 and a.is_deleted=0 and a.requisition_no in(".$requisition_numbers.") group by a.knit_id, a.requisition_no";
		$requsition_result_array=sql_select($requsition_sql);
		$requisition_data = array();
		foreach ($requsition_result_array as $row)
		{
			$requisition_data[$row[csf("requisition_no")]]['program_no'] = $row[csf("program_no")];
		}
	}
	?>
	<div style="width:1900px;">
		<table cellspacing="0" border="0" width="100%">
				<tr>
					<td colspan="19" align="center">
						<strong style="font-size:xx-large;"><? echo $company_library[$company]; ?></strong>
						<br><? echo chop(show_company($company, '', ''),","); ?>
					</td>
				</tr>
				<tr>
					<td colspan="19" align="center">
					<?
					if($knit_dye_source == 1)
					{
						$working_com_location = show_company($knit_dye_company, '', '');
						$working_company_name = $company_library[$knit_dye_company];
					}
					else
					{
						$working_company_name =  return_field_value("supplier_name", "lib_supplier", "id=".$knit_dye_company,"supplier_name");
						$working_com_location = return_field_value("address_1", "lib_supplier", "id=".$knit_dye_company,"address_1");
					}

					//$issue_id = $main_squery_result[0][csf('issue_id')];
					//$issue_location_id =  return_field_value("location_id", "INV_ISSUE_MASTER", "id=$issue_id","location_id");
					//$issue_location_name = ($location_arr[$issue_location_id]!="")?", ".$location_arr[$issue_location_id]:""
					?>
					<p style="font-size:20px;"><strong>Issue To: <? echo $working_company_name; ?></strong></p>
					</td>
				</tr>
				<tr>
					<td colspan="19" align="center"> <? echo chop($working_com_location,","); ?></td>
				</tr>
				<tr class="form_caption">
					<td colspan="19" style="font-size:x-large" align="center"><strong><u>Yarn Delivery Challan</u></strong></td>
				</tr>
                <tr><td colspan="19">&nbsp;</td></tr>
		</table>
		<div style="width:100%;">
			<table align="right" cellspacing="0" border="1" rules="all" class="rpt_table" >
				<thead bgcolor="#dddddd" align="center">
					<th width="30" align="center">SL</th>
					<th width="130">Trans. Ref.</th>
					<th width="180">Job No</th>
					<th width="130">Style Ref. No</th>
					<th width="100">Buyer</th>
					<th width="80">Internal Ref. No</th>
					<th width="80">Program No</th>
					<th width="80">Book. No/ Req. No</th>
					<th width="100">Store Name</th>
					<th width="100">Floor Name</th>
					<th width="100">Room Name</th>
					<th width="100">Supplier Name</th>
					<th width="80">Lot</th>
					<th width="80">Count</th>
					<th width="80">Composition</th>
					<th width="80">Yarn Type</th>
					<th width="80">Color</th>
					<th width="80" align="left">Issue Qty.</th>
					<th width="80" align=="left">Rtnbl Qty(kg)</th>
					<th width="60" align=="left">No of Bag</th>
					<th>Remarks</th>
				</thead>
				<?
				$i = 1;
				$buyer_b = '';
				$job_b = '';

				$buyer_r = '';
				$job_r = '';
				$style_ref_b = '';
				$style_ref_r = '';
				$style_ref = '';
				$po_no_b = '';
				$po_no_r = '';
				foreach ($sql_issue_rslt as $row)
				{
					$bgcolor =($i%2==0)?"#E9F3FF":"#FFFFFF";

					$buyer_name = "";

					if($job_alldata_arr[$row[csf("trans_id")]]['buyer_name'] !="")
					{
						$buyer_name = $buyer_dtls_arr[$job_alldata_arr[$row[csf("trans_id")]]['buyer_name']];
					}
					else
					{
						if($row[csf('issue_basis')] == 1)
						{
							if ($dataArray[0][csf('issue_purpose')] == 8 )
							{
								$buyer_name =$buyer_dtls_arr[$row[csf('buyer_id')]];
							}
						}
					}

					if($row[csf('yarn_count_id')]!="")
					{
						$compos = $composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]." %"." ".$composition[$row[csf('yarn_comp_type2nd')]];
					}
					else
					{
						$compos = "";
					}

					if($row[csf('issue_basis')] == 3)
					{
						$programNo = $requisition_data[$row[csf('requisition_no')]]['program_no'];

					}

					$style_ref_no = "";
					if($job_alldata_arr[$row[csf("trans_id")]]['style_ref_no'] !="")
					{
						$style_ref_no = $job_alldata_arr[$row[csf("trans_id")]]['style_ref_no'];
					}
					else
					{
						if($row[csf('issue_basis')] == 1)
						{
							$style_ref_no = $sample_alldata_arr[$row[csf("booking_id")]]['style_ref_no'];
						}
					}

					$internal_ref_no = "";
					if($job_alldata_arr[$row[csf("trans_id")]]['grouping'] !="")
					{
						$internal_ref_no = $job_alldata_arr[$row[csf("trans_id")]]['grouping'];
					}
					else
					{
						if($row[csf('issue_basis')] == 1)
						{
							$internal_ref_no = $sample_alldata_arr[$row[csf("booking_id")]]['internal_ref'];
						}
					}

					$po_id = explode(",", $row[csf('po_id')]);

					if($row[csf('issue_basis')] == 1  || $row[csf('issue_basis')] == 2)
					{
						foreach ($po_id as $val)
						{
							if($row[csf('is_sales')]==1)
							{
								if ($po_no_b== '') $po_no_b = $sales_order_array[$val]['sales_booking_no'];
								if ($style_ref_b == '') $style_ref_b = $sales_style_des_arr[$sales_order_array[$val]['sales_booking_no']]['style_des'];

								$po_job = $sales_order_array[$val]['po_job_no'];

								// if ($internal_ref == '') $internal_ref = $job_intfarray[$po_job]['grouping']; else $internal_ref .= "," . $job_intfarray[$po_job]['grouping'];
							}
							else
							{
								if($po_array[$val]['no'] !='')
								{
									if ($po_no_b == '') $po_no_b = $po_array[$val]['no']; else $po_no_b .= ", " . $po_array[$val]['no'];
									if ($style_ref_b == '') $style_ref_b = $po_array[$val]['style_ref'];
								}

								// if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];

							}

							if ($job_no == '') $job_no = $po_array[$val]['job_no'];

							if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

							if ($sales_booking_no== '') $sales_booking_no = $sales_order_array[$val]['sales_booking_no'];

							//if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
						}
						//$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
						// $job_file = array_unique(explode(",", rtrim($file_no, ", ")));
						// $ref_cond = '';
						// foreach ($job_ref as $ref) {
						// 	//$ref_cond.=", ".$ref;
						// 	if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
						// }
						// $file_con = '';
						// foreach ($job_file as $file) {
						// 	if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
						// }

						// $buyer = '';
						// $job = '';
						if ($row[csf('issue_basis')] == 1)
						{
							if ($dataArray[0][csf('issue_purpose')] == 8)
							{
								$buyer_b = $buyer_dtls_arr[$row[csf('buyer_id')]];
							}
							else
							{
								if ($row[csf('buyer_job_no')] != "")
								{
									if($row[csf('job_no')])
									{
										$buyer_b = $buyer_dtls_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
										$job_b = $row[csf('job_no')];
									}
									else
									{
										$buyer_b = $buyer_dtls_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
										$job_b = $row[csf('buyer_job_no')];
									}
								}
								else
								{
									$buyer_b = $buyer_dtls_arr[$row[csf('buyer_id')]];
								}
							}
						}
						else if ($row[csf('issue_basis')] == 2)
						{
							$buyer_b = '';
							$job_b = '';
						}
					}
					else if($row[csf('issue_basis')] == 3)
					{

						if ($is_sales_array[$row[csf('requisition_no')]] == 1)
						{
							// $buyer = '';
							// $job = '';
							foreach (array_unique($po_id) as $val) {
								if ($po_no_r == '') $po_no_r = $job_no_array[$val]['job_no']; //else $po_no_r .= ", " . $job_no_array[$val]['job_no'];
								if ($style_ref_r == '') $style_ref_r = $job_no_array[$val]['style_ref'];

								if ($buyer_r == '' && $job_r == '')
								{
									if ($job_no_array[$val]['within_group'] == 1)
									{
										$buyer_data = $buyer_dtls_arr[$job_no_array[$val]['po_buyer']];
										$job_data = $stl_array[$job_no_array[$val]['style_ref']]['job'];

										$buyer_r = $buyer_data;
										//$buyer_r = $val;

										$job_r = $job_data;
									}
									else
									{
										$buyer_r = $buyer_dtls_arr[$job_no_array[$val]['buyer_id']];
									}
								}
							}
						}
						else
                        {

                            foreach ($po_id as $val)
                            {
                                if ($po_no_r == '') $po_no_r = $po_array[$val]['no']; else $po_no_r .= ", " . $po_array[$val]['no'];
                                if ($job_no == '') $job_no = $po_array[$val]['job_no'];
                                if ($style_ref_r == '') $style_ref_r = $po_array[$val]['style_ref'];
                                if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

                                if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
                                if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
                            }

                            $job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
                            $job_file = array_unique(explode(",", rtrim($file_no, ", ")));

                            // $ref_cond = '';
                            // foreach ($job_ref as $ref) {
                            //     //$ref_cond.=", ".$ref;
                            //     if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
                            // }

                            // $file_con = '';
                            // foreach ($job_file as $file) {
                            //     if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
                            // }

                            if ($job_no != '')
                            {
                               $buyer_r = $buyer_dtls_arr[$buyer_name];
                                $job_r = $job_no;
                            }
                            else
                            {
                                if(!empty($po_array[$val]['buyer_name']))
                                {
                                    $buyer_r = $buyer_dtls_arr[$buyer_name];
                                }
                                else
                                {
                                    $buyer_r = $buyer_dtls_arr[$buyer_name];
                                }
                            }
                        }


					}
					else
					{

						foreach (array_unique($po_id) as $val)
						{
							//$buyer = '';
							if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];

							if ($buyer == '')
							{
								if ($job_no_array[$val]['within_group'] == 1)
								{
									$buyer = $company_library[$job_no_array[$val]['buyer_id']];
								}
								else
								{
									$buyer = $buyer_arr[$job_no_array[$val]['buyer_id']];
								}
							}

							if ($is_sales_array[$row[csf('requisition_no')]] == 1)
							{
								$po_job = $sales_order_array[$val]['po_job_no'];

								//if ($internal_ref == '') $internal_ref = $job_intfarray[$po_job]['grouping']; else $internal_ref .= "," . $job_intfarray[$po_job]['grouping'];

							}
						}

						

						// $ref_cond = '';
						// foreach ($job_ref as $ref)
						// {
						// 	if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
						// }
					}
					?>
					<tr bgcolor="<? echo $bgcolor; ?>">
						<td width="30" align="center"><? echo $i; ?></td>
						<td width="130"><? echo $row[csf('issue_number')]; ?></td>
						<td width="180">
							<?
							//echo $job;
							if($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
							{
								echo $job_b;
								// echo $job_b.'<br>'. $po_no_b;
							}
							else if($row[csf('issue_basis')] == 3)
							{
								echo $job_r;
								// echo $job_r.'<br>'. $po_no_r;
							}
							else
							{
								echo $job_alldata_arr[$row[csf("trans_id")]]['job_no'];
							}
							 ?>
						</td>
						<td width="130">
							<?
							//echo $style_ref;
							if($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
							{
								echo $style_ref_b;
							}
							else if($row[csf('issue_basis')] == 3)
							{
								echo $style_ref_r;
							}
							else
							{
								echo $style_ref_no;
							}

							?>
						</td>
						<td width="100">
							<?
							//echo $buyer;
							if($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
							{
								echo $buyer_b;
							}
							else if($row[csf('issue_basis')] == 3)
							{
								echo $buyer_r;
							}
							else
							{
								echo $buyer_name;
							}
							?>
						</td>
						<td width="80"><?
							$int_ref_unique = array_unique(explode(",", rtrim($internal_ref_no, ", ")));
							$int_ref_unique_str = implode(",", $int_ref_unique);
						 	echo $int_ref_unique_str; ?></td>
						<td width="80"><? echo $programNo; ?></td>
						<td width="80"><?
						echo ($row[csf('requisition_no')] != 0 ? $row[csf('requisition_no')]:$row[csf('booking_no')]);
						?></td>
						<td width="100"><? echo $store_library[$row[csf('store_id')]]; ?></td>
						<td width="100"><? echo $floor_room_rack_arr[$row[csf('floor_id')]]; ?></td>
						<td width="100"><? echo $floor_room_rack_arr[$row[csf('room')]]; ?></td>
						<td width="100"><? echo $supplier_library[$row[csf('supplier_id')]]; ?></td>
						<td width="80"><? echo $row[csf('lot')]; ?></td>
						<td width="80"><? echo $count_arr[$row[csf('yarn_count_id')]]; ?></td>
						<td width="80"><? echo $compos; ?></td>
						<td width="80"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></td>
						<td width="80" align="right"><? echo $color_arr[$row[csf('color')]]; ?></td>
						<td width="80" align="right"><? echo number_format($row[csf('issue_qnty')], 0, '', ',');?></td>
						<td width="80" align="right"><? echo number_format($row[csf('return_qnty')], 0, '', ',');?></td>
						<td width="80" align="right"><? echo number_format($row[csf('no_of_bags')], 0, '', ',');?></td>
						<td><? echo $row[csf('remarks')]; ?></td>
					</tr>
					<?php
					$total_issue_qnty += $row[csf('issue_qnty')];
					$total_return_qnty += $row[csf('return_qnty')];
					$total_no_of_bags += $row[csf('no_of_bags')];
					$i++;
				}
				?>
				<tr>
					<td align="right" colspan="17" >Total</td>
					<td align="right"><? echo number_format($total_issue_qnty, 0, '', ','); ?></td>
					<td align="right"><? echo number_format($total_return_qnty, 0, '', ','); ?></td>
					<td align="right"><? echo number_format($total_no_of_bags, 0, '', ','); ?></td>
					<td align="right">&nbsp;</td>
				</tr>
				<tfoot>
					<tr>
						<th colspan="21" align="left">In Word : <? echo number_to_words(number_format($total_issue_qnty, 2));?></th>
					</tr>
				</tfoot>
			</table>
			<br>
			<?
			echo signature_table(49, $data[1], "1200px");
			?>
		</div>
	</div>
	<?
	exit();
}

if ($action=="multiple_issue_no_print_S160223")
{
	extract($_REQUEST);
	$data = explode('*', $data);
	$issue_id = $data[0];
	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks from inv_issue_master where id='$issue_id'";
	//echo $sql;die;

	$dataArray = sql_select($sql);

	$sql_issue = "Select a.company_id, a.issue_number, a.issue_basis, a.issue_purpose, a.issue_date, a.booking_id, a.booking_no,
	a.knit_dye_company, a.knit_dye_source, a.buyer_id,
	b.id as trans_id, b.requisition_no, b.pi_wo_batch_no, b.prod_id, b.transaction_date, b.store_id, b.floor_id, b.room, sum(b.cons_quantity) as issue_qnty, sum(b.return_qnty) as return_qnty, sum(b.no_of_bags) as no_of_bags, b.remarks,
	c.detarmination_id, c.lot, c.yarn_count_id, c.yarn_comp_type1st, c.yarn_comp_type2nd, c.yarn_comp_percent1st, c.yarn_type, c.color, c.supplier_id, b.booking_without_order
	FROM inv_issue_master a, inv_transaction b, product_details_master c
	WHERE a.id=b.mst_id and b.prod_id=c.id
	and a.entry_form=3 and a.item_category=1 and a.id in(".$issue_id.") and a.status_active=1 and a.is_deleted=0
	and b.item_category=1 and b.transaction_type=2
	and b.status_active=1 and b.is_deleted=0
	and c.status_active=1 and c.is_deleted=0
	GROUP BY a.company_id, a.issue_number, a.issue_basis, a.issue_purpose, a.issue_date, a.booking_id, a.booking_no,
	a.knit_dye_company, a.knit_dye_source, a.buyer_id,
	b.id, b.requisition_no, b.pi_wo_batch_no, b.prod_id, b.transaction_date, b.store_id, b.floor_id, b.room, b.remarks,
	c.detarmination_id, c.lot, c.yarn_count_id, c.yarn_comp_type1st, c.yarn_comp_type2nd, c.yarn_comp_percent1st, c.yarn_type, c.color, c.supplier_id, b.booking_without_order";
	//echo $sql_issue;
	$sql_issue_rslt = sql_select($sql_issue);
	$pdata = array();
	$trans_id = '';
	$requisition_no = '';
	$supplier_id = '';
	$store_id = '';
	$yarn_count_id = '';
	$color = '';
	$company = 0;
	$knit_dye_company = 0;
	$knit_dye_source = 0;

	foreach($sql_issue_rslt as $row)
	{
		$company = $row[csf('company_id')];
		$knit_dye_company = $row[csf('knit_dye_company')];
		$knit_dye_source = $row[csf('knit_dye_source')];

		$trans_id .= $row[csf('trans_id')].",";
		$supplier_id .= $row[csf('supplier_id')].",";
		$store_id .= $row[csf('store_id')].",";
		$yarn_count_id .= $row[csf('yarn_count_id')].",";
		$color .= $row[csf('color')].",";

		if($row[csf('issue_basis')] == 3)
		{
			$requisition_no .= $row[csf('requisition_no')].",";
		}

		if($row[csf('issue_basis')] == 1)
		{
			$booking_id .= $row[csf('booking_id')].",";
		}
	}

	$store_ids = implode(",",array_unique(explode(",",chop($store_id,','))));
	$supplier_ids = implode(",",array_unique(explode(",",chop($supplier_id,','))));
	$yarn_count_ids = implode(",",array_unique(explode(",",chop($yarn_count_id,','))));
	$colorids = implode(",",array_unique(explode(",",chop($color,','))));
	$trans_ids = implode(",",array_unique(explode(",",chop($trans_id,','))));
	$requisition_numbers = implode(",",array_unique(explode(",",chop($requisition_no,','))));
	$booking_ids = implode(",",array_unique(explode(",",chop($booking_id,','))));
	//var_dump($booking_numbers);
	//for company
	$company_library = return_library_array("select id, company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	//for buyer
	$sqlBuyer = sql_select("select id as ID, buyer_name as BUYER_NAME, short_name as SHORT_NAME from lib_buyer");
	foreach($sqlBuyer as $row)
	{
		$buyer_arr[$row['ID']] = $row['SHORT_NAME'];
		$buyer_dtls_arr[$row['ID']] = $row['BUYER_NAME'];
	}
	unset($sqlBuyer);
	//for store
	if($store_ids!="")
	{
		$store_library = return_library_array("select id, store_name from lib_store_location where status_active=1 and is_deleted=0 and id in(".$store_ids.")", "id", "store_name");
	}

	//for supplier
	if($supplier_ids!="")
	{
		$supplier_library = return_library_array("select id,supplier_name from lib_supplier where status_active=1 and is_deleted=0 and id in ($supplier_ids)", "id", "supplier_name");
	}

	//for yarn count
	if($yarn_count_ids!="")
	{
		$count_arr = return_library_array("select id,yarn_count from lib_yarn_count where status_active=1 and is_deleted=0 and id in ($yarn_count_ids)", "id", "yarn_count");
	}

	//for color
	if($colorids!="")
	{
		$color_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0 and id in($colorids)", "id", "color_name");
	}

	$location_arr=return_library_array( "select id, location_name from lib_location",'id','location_name');
	$floor_room_rack_arr = return_library_array("select floor_room_rack_id, floor_room_rack_name from lib_floor_room_rack_mst", 'floor_room_rack_id', 'floor_room_rack_name');

	if($booking_ids!="")
	{
		$sample_sql= "SELECT a.id, a.company_id, c.style_ref_no, c.internal_ref from wo_non_ord_samp_booking_mst  a left join wo_non_ord_samp_booking_dtls b on a.booking_no=b.booking_no  left join sample_development_mst c on b.style_id=c.id and b.status_active=1 and b.is_deleted=0  where a.id in(".$booking_ids.") and a.entry_form_id=140 and  b.entry_form_id=140 and   a.company_id='$company'". set_user_lavel_filtering(' and a.buyer_id','buyer_id')."  and a.booking_type=4 and  a.status_active=1 and a.is_deleted=0  order by b.id desc";
		//echo $sqls;
		$sample_sql_Array=sql_select($sample_sql);
		if(count($sample_sql_Array)>0)
		{
			$sample_alldata_arr = array();
			foreach ($sample_sql_Array as $row)
			{
				$sample_alldata_arr[$row[csf("id")]]['style_ref_no'] = $row[csf("style_ref_no")];
				$sample_alldata_arr[$row[csf("id")]]['internal_ref'] = $row[csf("internal_ref")];
			}
			//var_dump($sample_alldata_arr);
		}
	}

	if($trans_ids!="")
	{
		$job_sql="select a.trans_id, a.po_breakdown_id,c.buyer_name, c.job_no, c.style_ref_no, b.grouping from order_wise_pro_details a, wo_po_break_down b, wo_po_details_master c where a.trans_id in(".$trans_ids.") and a.po_breakdown_id=b.id and b.job_no_mst=c.job_no and b.status_active=1 and b.is_deleted=0 and c.is_deleted=0 and c.status_active=1 group by a.trans_id, a.po_breakdown_id, c.job_no, c.style_ref_no, c.buyer_name, b.grouping order by c.job_no, a.po_breakdown_id";
		$job_result_Array=sql_select($job_sql);
		if(count($job_result_Array)>0)
		{
			$job_alldata_arr = array();
			foreach($job_result_Array as $row)
			{
				$tot_rows++;
				$job_alldata_arr[$row[csf("trans_id")]]['job_no']   	= $row[csf("job_no")];
				$job_alldata_arr[$row[csf("trans_id")]]['style_ref_no'] = $row[csf("style_ref_no")];
				$job_alldata_arr[$row[csf("trans_id")]]['buyer_name']   = $row[csf("buyer_name")];

				if(!empty($job_alldata_arr[$row[csf("trans_id")]]['grouping']))
				{
					$job_alldata_arr[$row[csf("trans_id")]]['grouping'] .= ",".$row[csf("grouping")];
				}
				else
				{
					$job_alldata_arr[$row[csf("trans_id")]]['grouping'] = $row[csf("grouping")];
				}
				$buyer_name.=$row[csf("buyer_name")].",";
			}
			unset($job_result_Array);

			$buyer_ids = implode(",",array_unique(explode(",",chop($buyer_name,','))));
			if($buyer_ids!="")
			{
				$buyer_arr = return_library_array( "select id, buyer_name from lib_buyer where status_active=1 and is_deleted=0 and id in($buyer_ids)",'id','buyer_name');
			}
		}
	}

	if($requisition_numbers !="" )
	{
		$requsition_sql = "select a.knit_id as program_no, a.requisition_no from ppl_yarn_requisition_entry a where a.status_active=1 and a.is_deleted=0 and a.requisition_no in(".$requisition_numbers.") group by a.knit_id, a.requisition_no";
		$requsition_result_array=sql_select($requsition_sql);
		$requisition_data = array();
		foreach ($requsition_result_array as $row)
		{
			$requisition_data[$row[csf("requisition_no")]]['program_no'] = $row[csf("program_no")];
		}
	}
	?>
	<div style="width:1900px;">
		<table cellspacing="0" border="0" width="100%">
				<tr>
					<td colspan="19" align="center">
						<strong style="font-size:xx-large;"><? echo $company_library[$company]; ?></strong>
						<br><? echo chop(show_company($company, '', ''),","); ?>
					</td>
				</tr>
				<tr>
					<td colspan="19" align="center">
					<?
					if($knit_dye_source == 1)
					{
						$working_com_location = show_company($knit_dye_company, '', '');
						$working_company_name = $company_library[$knit_dye_company];
					}
					else
					{
						$working_company_name =  return_field_value("supplier_name", "lib_supplier", "id=".$knit_dye_company,"supplier_name");
						$working_com_location = return_field_value("address_1", "lib_supplier", "id=".$knit_dye_company,"address_1");
					}

					//$issue_id = $main_squery_result[0][csf('issue_id')];
					//$issue_location_id =  return_field_value("location_id", "INV_ISSUE_MASTER", "id=$issue_id","location_id");
					//$issue_location_name = ($location_arr[$issue_location_id]!="")?", ".$location_arr[$issue_location_id]:""
					?>
					<p style="font-size:20px;"><strong>Issue To: <? echo $working_company_name; ?></strong></p>
					</td>
				</tr>
				<tr>
					<td colspan="19" align="center"> <? echo chop($working_com_location,","); ?></td>
				</tr>
				<tr class="form_caption">
					<td colspan="19" style="font-size:x-large" align="center"><strong><u>Yarn Delivery Challan</u></strong></td>
				</tr>
                <tr><td colspan="19">&nbsp;</td></tr>
		</table>
		<div style="width:100%;">
			<table align="right" cellspacing="0" border="1" rules="all" class="rpt_table" >
				<thead bgcolor="#dddddd" align="center">
					<th width="30" align="center">SL</th>
					<th width="130">Trans. Ref.</th>
					<th width="100">Job No</th>
					<th width="130">Style Ref. No</th>
					<th width="100">Buyer</th>
					<th width="80">Internal Ref. No</th>
					<th width="80">Program No</th>
					<th width="80">Book. No/ Req. No</th>
					<th width="100">Store Name</th>
					<th width="100">Floor Name</th>
					<th width="100">Room Name</th>
					<th width="100">Supplier Name</th>
					<th width="80">Lot</th>
					<th width="80">Count</th>
					<th width="80">Composition</th>
					<th width="80">Yarn Type</th>
					<th width="80">Color</th>
					<th width="80" align="left">Issue Qty.</th>
					<th width="80" align=="left">Rtnbl Qty(kg)</th>
					<th width="60" align=="left">No of Bag</th>
					<th>Remarks</th>
				</thead>
				<?
				$i = 1;
				foreach ($sql_issue_rslt as $row)
				{
					$bgcolor =($i%2==0)?"#E9F3FF":"#FFFFFF";

					$buyer_name = "";

					if($job_alldata_arr[$row[csf("trans_id")]]['buyer_name'] !="")
					{
						$buyer_name = $buyer_arr[$job_alldata_arr[$row[csf("trans_id")]]['buyer_name']];
					}
					else
					{
						if($row[csf('issue_basis')] == 1)
						{
							if ($dataArray[0][csf('issue_purpose')] == 8 )
							{
								$buyer_name =$buyer_arr[$row[csf('buyer_id')]];
							}
						}
					}

					if($row[csf('yarn_count_id')]!="")
					{
						$compos = $composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]." %"." ".$composition[$row[csf('yarn_comp_type2nd')]];
					}
					else
					{
						$compos = "";
					}

					if($row[csf('issue_basis')] == 3)
					{
						$programNo = $requisition_data[$row[csf('requisition_no')]]['program_no'];
					}

					$style_ref_no = "";
					if($job_alldata_arr[$row[csf("trans_id")]]['style_ref_no'] !="")
					{
						$style_ref_no = $job_alldata_arr[$row[csf("trans_id")]]['style_ref_no'];
					}
					else
					{
						if($row[csf('issue_basis')] == 1)
						{
							$style_ref_no = $sample_alldata_arr[$row[csf("booking_id")]]['style_ref_no'];
						}
					}

					$internal_ref_no = "";
					if($job_alldata_arr[$row[csf("trans_id")]]['grouping'] !="")
					{
						$internal_ref_no = $job_alldata_arr[$row[csf("trans_id")]]['grouping'];
					}
					else
					{
						if($row[csf('issue_basis')] == 1)
						{
							$internal_ref_no = $sample_alldata_arr[$row[csf("booking_id")]]['internal_ref'];
						}
					}
					?>
					<tr bgcolor="<? echo $bgcolor; ?>">
						<td width="30" align="center"><? echo $i; ?></td>
						<td width="130"><? echo $row[csf('issue_number')]; ?></td>
						<td width="100"><? echo $job_alldata_arr[$row[csf("trans_id")]]['job_no']; ?></td>
						<td width="130"><? echo $style_ref_no; ?></td>
						<td width="100"><? echo $buyer_name; ?></td>
						<td width="80"><? echo $internal_ref_no; ?></td>
						<td width="80"><? echo $programNo; ?></td>
						<td width="80"><?
						echo ($row[csf('requisition_no')] != 0 ? $row[csf('requisition_no')]:$row[csf('booking_no')]);
						?></td>
						<td width="100"><? echo $store_library[$row[csf('store_id')]]; ?></td>
						<td width="100"><? echo $floor_room_rack_arr[$row[csf('floor_id')]]; ?></td>
						<td width="100"><? echo $floor_room_rack_arr[$row[csf('room')]]; ?></td>
						<td width="100"><? echo $supplier_library[$row[csf('supplier_id')]]; ?></td>
						<td width="80"><? echo $row[csf('lot')]; ?></td>
						<td width="80"><? echo $count_arr[$row[csf('yarn_count_id')]]; ?></td>
						<td width="80"><? echo $compos; ?></td>
						<td width="80"><? echo $yarn_type[$row[csf('yarn_type')]]; ?></td>
						<td width="80" align="right"><? echo $color_arr[$row[csf('color')]]; ?></td>
						<td width="80" align="right"><? echo number_format($row[csf('issue_qnty')], 0, '', ',');?></td>
						<td width="80" align="right"><? echo number_format($row[csf('return_qnty')], 0, '', ',');?></td>
						<td width="80" align="right"><? echo number_format($row[csf('no_of_bags')], 0, '', ',');?></td>
						<td><? echo $row[csf('remarks')]; ?></td>
					</tr>
					<?php
					$total_issue_qnty += $row[csf('issue_qnty')];
					$total_return_qnty += $row[csf('return_qnty')];
					$total_no_of_bags += $row[csf('no_of_bags')];
					$i++;
				}
				?>
				<tr>
					<td align="right" colspan="17" >Total</td>
					<td align="right"><? echo number_format($total_issue_qnty, 0, '', ','); ?></td>
					<td align="right"><? echo number_format($total_return_qnty, 0, '', ','); ?></td>
					<td align="right"><? echo number_format($total_no_of_bags, 0, '', ','); ?></td>
					<td align="right">&nbsp;</td>
				</tr>
				<tfoot>
					<tr>
						<th colspan="21" align="left">In Word : <? echo number_to_words(number_format($total_issue_qnty, 2));?></th>
					</tr>
				</tfoot>
			</table>
			<br>
			<?
			echo signature_table(49, $data[1], "1200px");
			?>
		</div>
	</div>
	<?
	exit();
}

//for norban
if ($action == "multiple_issue_no_print2")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print Multi Issue No 2", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$issue_id   = $data[0];
	$company   = $data[1];
	$system_no = $data[2];
	$report_title = $data[3];
	$booking_id = $data[4];
	$is_approved = $data[5];
	$mst_id     = $data[6];
	$show_val_column = $data[7];
	$print_with_vat = $data[8];
	$location  = $data[9];
	$store_id = $data[10];
	$no_copy = $data[11];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$company_arr = return_library_array("select id, company_short_name from lib_company", "id", "company_short_name");
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$department_arr = return_library_array("select id, department_name from lib_department", "id", "department_name");

	//for buyer
	$sqlBuyer = sql_select("select id as ID, buyer_name as BUYER_NAME, short_name as SHORT_NAME from lib_buyer");
	foreach($sqlBuyer as $row)
	{
		$buyer_arr[$row['ID']] = $row['SHORT_NAME'];
		$buyer_dtls_arr[$row['ID']] = $row['BUYER_NAME'];
	}
	unset($sqlBuyer);

	//for supplier
	$sqlSupplier = sql_select("select id as ID, supplier_name as SUPPLIER_NAME, short_name as SHORT_NAME from lib_supplier");
	foreach($sqlSupplier as $row)
	{
		$supplier_arr[$row['ID']] = $row['SHORT_NAME'];
		$supplier_dtls_arr[$row['ID']] = $row['SUPPLIER_NAME'];
	}
	unset($sqlSupplier);

	$issue_id_arr = explode(',', $issue_id);
	$issue_in_no = $issue_id_arr[0];

	//for gate pass
	$sql_get_pass = "SELECT a.ID, a.SYS_NUMBER, a.BASIS, a.COMPANY_ID, a.GET_PASS_NO, a.DEPARTMENT_ID, a.ATTENTION, a.SENT_BY, a.WITHIN_GROUP, a.SENT_TO, a.CHALLAN_NO, a.OUT_DATE, a.TIME_HOUR, a.TIME_MINUTE, a.RETURNABLE, a.DELIVERY_AS, a.EST_RETURN_DATE, a.INSERTED_BY, a.CARRIED_BY, a.LOCATION_ID, a.COM_LOCATION_ID, a.VHICLE_NUMBER, a.LOCATION_NAME, a.REMARKS, a.DO_NO, a.MOBILE_NO, a.ISSUE_ID, a.RETURNABLE_GATE_PASS_REFF, a.DELIVERY_COMPANY, a.ISSUE_PURPOSE,a.SECURITY_LOCK_NO,a.DRIVER_NAME,a.DRIVER_LICENSE_NO, b.QUANTITY, b.NO_OF_BAGS FROM inv_gate_pass_mst a, INV_GATE_PASS_DTLS b WHERE a.id = b.mst_id AND a.company_id = ".$company." AND a.basis = 2 AND a.STATUS_ACTIVE = 1 AND a.IS_DELETED = 0 AND a.challan_no LIKE '%".$system_no."%'";
	//echo $sql_get_pass;
	$sql_get_pass_rslt = sql_select($sql_get_pass);
	$is_gate_pass = 0;
	$is_gate_out = 0;
	$gate_pass_id = '';
	$gatePassDataArr = array();
	foreach($sql_get_pass_rslt as $row)
	{
		$exp = explode(',', $row['CHALLAN_NO']);
		$gatePass  = $row['CHALLAN_NO'];
		foreach($exp as $key=>$val)
		{
			if($val == $system_no)
			{
				$is_gate_pass = 1;
				$gate_pass_id = $row['ID'];

				$row['OUT_DATE'] = ($row['OUT_DATE']!=''?date('d-m-Y', strtotime($row['OUT_DATE'])):'');
				$row['EST_RETURN_DATE'] = ($row['EST_RETURN_DATE']!=''?date('d-m-Y', strtotime($row['EST_RETURN_DATE'])):'');
				$row['EST_RETURN_DATE'] = ($row['EST_RETURN_DATE']!=''?date('d-m-Y', strtotime($row['EST_RETURN_DATE'])):'');

				if($row['WITHIN_GROUP'] == 1)
				{
					//$row['SENT_TO'] = ($row['BASIS']==50?$buyer_dtls_arr[$row['SENT_TO']]:$supplier_dtls_arr[$row['SENT_TO']]);
					$row['SENT_TO'] = $company_library[$row['SENT_TO']];
					$row['LOCATION_NAME'] = $location_arr[$row['LOCATION_ID']];
				}

				//for gate pass info
				$gatePassDataArr[$row['CHALLAN_NO']]['gate_pass_id'] = $row['SYS_NUMBER'];
				$gatePassDataArr[$row['CHALLAN_NO']]['from_company'] = $company_library[$row['COMPANY_ID']];
				$gatePassDataArr[$row['CHALLAN_NO']]['from_location'] =$location_arr[ $row['COM_LOCATION_ID']];
				$gatePassDataArr[$row['CHALLAN_NO']]['gate_pass_date'] = date('d-m-Y', strtotime($row['OUT_DATE']));
				$gatePassDataArr[$row['CHALLAN_NO']]['returnable'] = $yes_no[$row['RETURNABLE']];
				$gatePassDataArr[$row['CHALLAN_NO']]['est_return_date'] = $row['EST_RETURN_DATE'];
				$gatePassDataArr[$row['CHALLAN_NO']]['to_company'] = $row['SENT_TO'];
				$gatePassDataArr[$row['CHALLAN_NO']]['to_location'] = $row['LOCATION_NAME'];
				$gatePassDataArr[$row['CHALLAN_NO']]['delivery_kg'] += $row['QUANTITY'];
				$gatePassDataArr[$row['CHALLAN_NO']]['delivery_bag'] += $row['NO_OF_BAGS'];
				$gatePassDataArr[$row['CHALLAN_NO']]['department'] = $department_arr[$row['DEPARTMENT_ID']];
				$gatePassDataArr[$row['CHALLAN_NO']]['attention'] = $row['ATTENTION'];
				$gatePassDataArr[$row['CHALLAN_NO']]['issue_purpose'] = $row['ISSUE_PURPOSE'];
				$gatePassDataArr[$row['CHALLAN_NO']]['remarks'] = $row['REMARKS'];
				$gatePassDataArr[$row['CHALLAN_NO']]['carried_by'] = $row['CARRIED_BY'];
				$gatePassDataArr[$row['CHALLAN_NO']]['vhicle_number'] = $row['VHICLE_NUMBER'];
				$gatePassDataArr[$row['CHALLAN_NO']]['mobile_no'] = $row['MOBILE_NO'];
				$gatePassDataArr[$row['CHALLAN_NO']]['security_lock_no'] = $row['SECURITY_LOCK_NO'];
				$gatePassDataArr[$row['CHALLAN_NO']]['driver_name'] = $row['DRIVER_NAME'];
				$gatePassDataArr[$row['CHALLAN_NO']]['driver_license_no'] = $row['DRIVER_LICENSE_NO'];
			}
		}
	}
	//for gate out
	if($gate_pass_id != '')
	{
		$sql_gate_out="SELECT OUT_DATE, OUT_TIME FROM INV_GATE_OUT_SCAN WHERE STATUS_ACTIVE = 1 AND IS_DELETED = 0 AND INV_GATE_PASS_MST_ID='".$gate_pass_id."'";
		$sql_gate_out_rslt = sql_select($sql_gate_out);
		if(!empty($sql_gate_out_rslt))
		{
			foreach($sql_gate_out_rslt as $row)
			{
				$is_gate_out = 1;
				$gatePassDataArr[$gatePass]['out_date'] = date('d-m-Y', strtotime($row['OUT_DATE']));
				$gatePassDataArr[$gatePass]['out_time'] = $row['OUT_TIME'];
			}
		}
	}

	// for Yarn Dyeing Work Order Without Order booking no
	$sql_ydw_booking = "select a.id AS ID, a.booking_no AS YDW_YSW_NO, c.fab_booking_no AS YDW_YSW_BOOKING_NO from inv_issue_master a, wo_yarn_dyeing_mst b, wo_yarn_dyeing_dtls c where a.booking_no=b.ydw_no and b.id = c.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.id in ($issue_id)";
	//echo $sql_ydw_booking; die;
	$sql_ydw_booking_data = sql_select($sql_ydw_booking);
	$YwdBookingNoArr = array();
	foreach($sql_ydw_booking_data as $row)
	{
		$YwdBookingNoArr[$row['YDW_YSW_NO']]['ydwbooking'] = $row['YDW_YSW_BOOKING_NO'];
	}

	$sql = "select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks, attention from inv_issue_master where id in ($issue_id)";
	//echo $sql;die;
	$dataArray = sql_select($sql);
	$reqBookingNoArr = array();
	foreach($dataArray as $row)
	{
		$issue_no = $row[csf('issue_number')];
		$issue_date = $row[csf('issue_date')];
		$knit_source = $row[csf('knit_dye_source')];
		$issue_purpose = $row[csf('issue_purpose')];
		$attention = $row[csf('attention')];
		$remarks = $row[csf('remarks')];
		$inhouse_location = $row[csf('location_id')];

		//for issue to
		$issue_to = '';
		if ($row[csf('issue_purpose')] == 3)
		{
			$issue_to = $buyer_dtls_arr[$row[csf('buyer_id')]];
		}
		else if ($row[csf('issue_purpose')] == 5)
		{
			$issue_to = $supplier_dtls_arr[$row[csf('loan_party')]] ;
		}
		else
		{
			if ($row[csf('knit_dye_source')] == 1)
				$issue_to = $company_library[$row[csf('knit_dye_company')]];
			else
				$issue_to = $supplier_dtls_arr[$row[csf('knit_dye_company')]];
		}

		//for address
		$address = "";
		$addressParty = "";
		if ($row[csf('knit_dye_source')] == 3)
		{
			$nameArray = sql_select("select address_1 ,web_site, email, country_id from lib_supplier where id=".$row[csf('knit_dye_company')]."");
			foreach ($nameArray as $result)
			{
				if ($result != "")
					$address = $result[csf('address_1')];
			}
			unset($nameArray);
		}

		//for party address
		$loanPartyArray = sql_select("select address_1, web_site, email, country_id from lib_supplier where id=".$row[csf('loan_party')]."");
		foreach ($loanPartyArray as $result)
		{
			if ($result != "")
				$addressParty = $result[csf('address_1')];;
		}
		unset($loanPartyArray);

		$addressPrint = '';
		if ($row[csf('issue_purpose')] == 3)
		{
			$addressPrint = $buyer_arr[$row[csf('buyer_id')]];
		}
		else if ($row[csf('issue_purpose')] == 5)
		{
			$addressPrint = $addressParty;
		}
		else
		{
			if ($row[csf('knit_dye_source')] == 1)
			{
				$addressPrint = $company_library[$row[csf('knit_dye_company')]];
			}
			else
			{
				$addressPrint = $address;
			}
		}

		/*
		| if knitting source is out-bound subcontract then
		| address will show
		*/
		if ($row[csf('knit_dye_source')] != 3)
		{
			$addressPrint = '';
		}

		//for program no
		if( $row[csf('issue_basis')] == 3 )
		{
			$planbooking = sql_select("select b.requisition_no, e.booking_no as pln_booking_no, d.id as program_id, d.is_sales from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c, ppl_planning_info_entry_dtls d, ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no = c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='".$mst_id."' ");
			foreach ($planbooking as $value)
			{
				$program_id .= $value[csf('program_id')].',';
				$reqBookingNoArr[$value[csf('requisition_no')]]['booking_no'] = $value[csf('pln_booking_no')];
				$reqBookingNoArr[$value[csf('requisition_no')]]['is_sample'] = $value[csf('is_sales')];
				$sampleBookingArr[$value[csf('pln_booking_no')]] = $value[csf('pln_booking_no')];
			}
			$program_ids = implode(",", array_unique(explode(",", chop($program_id,','))));
		}
		//echo $program_ids;
	}
	//echo "<pre>";
	//print_r($reqBookingNoArr);

	//for sample style ref. no
	$sql_sample = sql_select("SELECT a.BOOKING_NO, b.BUYER_NAME, b.STYLE_REF_NO,b.SUSTAINABILITY_STD_ID,b.FABRIC_MATERIAL_ID FROM WO_NON_ORD_SAMP_BOOKING_DTLS a, SAMPLE_DEVELOPMENT_MST b WHERE a.STYLE_ID=b.ID".where_con_using_array($sampleBookingArr, '1', 'a.BOOKING_NO'));
	$dataSampleArr = array();
	foreach($sql_sample as $row)
	{
		$dataSampleArr[$row['BOOKING_NO']]['buyer_id'] = $row['BUYER_NAME'];
		$dataSampleArr[$row['BOOKING_NO']]['style_ref_no'] = $row['STYLE_REF_NO'];
		$dataSampleArr[$row['BOOKING_NO']]['sustainability_std_id'] = $row['SUSTAINABILITY_STD_ID'];
		$dataSampleArr[$row['BOOKING_NO']]['fabric_material_id'] = $row['FABRIC_MATERIAL_ID'];
	}
	unset($sql_sample);

	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
	?>
	<style type="text/css">
		table tr td {
			font-size: 16px;
		}
		.rpt_table thead th{
			font-size: 16px;
		}
		.rpt_table tfoot th{
			font-size: 16px;
		}
	</style>
    <?php
	$data_array = sql_select("select image_location  from common_photo_library where master_tble_id='".$data[1]."' and form_name='company_details' and is_deleted=0 and file_type=1");
	$cond = "";
	if ($mst_id != "")
		$cond .= " and c.id in (".$issue_id.")";

	$i = 1;
	if ($db_type == 0)
	{
		$sql_result = sql_select("SELECT a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, a.supplier_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, b.remarks , c.issue_purpose, c.knit_dye_source,c.knit_dye_company, c.issue_number
		from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
		where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
		group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, a.is_within_group, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, b.remarks, c.issue_purpose, c.knit_dye_source,c.knit_dye_company, c.issue_number");
	}
	else
	{
		$sql_result = sql_select("SELECT a.id, a.lot, a.color, a.yarn_type, a.product_name_details, a.yarn_count_id, a.yarn_comp_percent1st, a.yarn_comp_type1st, a.detarmination_id, a.supplier_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, b.remarks, c.issue_purpose, c.knit_dye_source, c.knit_dye_company, c.issue_number
		from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id
		where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond
		group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.supplier_id, a.is_within_group, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, b.remarks, c.issue_purpose, c.knit_dye_source,c.knit_dye_company, c.issue_number");
	}

	$poIdArr = array();
	$reqNoArr = array();
	foreach ($sql_result as $row)
	{
		//for po id
		$expPo = array();
		$expPo = explode(",", $row[csf('po_id')]);
		foreach ($expPo as $key=>$val)
		{
			if($val*1 > 0)
			{
				$poIdArr[$val] = $val;
			}
		}

		//for req no
		$reqNoArr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];
	}
	/*echo "<pre>";
	print_r($poIdArr);
	echo "</pre>";*/

	//for po information
	$po_array = array();
	$job_array = array();
	$costing_sql = sql_select("select a.job_no, b.file_no, b.grouping, a.style_ref_no, a.buyer_name,a.sustainability_standard,a.fab_material, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=".$company.where_con_using_array($poIdArr, '0', 'b.id'));
	foreach ($costing_sql as $row)
	{
		$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
		$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
		$po_array[$row[csf('id')]]['sustainability'] = $row[csf('sustainability_standard')];
		$po_array[$row[csf('id')]]['fab_material'] = $row[csf('fab_material')];
		$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
		$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
		$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
		$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
		$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
	}
	unset($costing_sql);
	/*echo "<pre>";
	print_r($po_array[2235]);
	echo "</pre>";*/

	//for requisition information
	$po_id_req_array = array();
	$is_sales_array = array();
	if ($db_type == 0)
	{
		$poID = " SELECT c.knit_id, c.requisition_no, a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id".where_con_using_array($reqNoArr, '0', 'c.requisition_no')." group by c.knit_id,c.requisition_no, a.is_sales ";
	}
	else
	{
		$poID = "SELECT c.knit_id, c.requisition_no, a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id".where_con_using_array($reqNoArr, '0', 'c.requisition_no')." group by c.knit_id, c.requisition_no, a.is_sales";
	}

	$poID_sql_result = sql_select($poID);
	$poIdArr2 = array();
	foreach ($poID_sql_result as $row)
	{
		$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
		$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
		$program_array[$row[csf('requisition_no')]] = $row[csf('knit_id')];

		//for po id
		$expPo = array();
		$expPo = explode(",", $row[csf('poid')]);
		foreach ($expPo as $key=>$val)
		{
			$poIdArr2[$val] = $val;
		}
	}
	unset($poID_sql_result);
	/*echo "<pre>";
	print_r($po_id_req_array);
	echo "</pre>";*/

	//for job information
	$job_no_array = array();
	$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst where 1=1".where_con_using_array($poIdArr2, '0', 'id'));
	foreach ($jobData as $row)
	{
		$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
		$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
		$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
	}
	unset($jobData);

	$all_req_no = "";
	$all_prod_id = "";
	$order_qnty_val_sum=0;
	$order_amount_val_sum=0;
	$no_of_bags_val_sum=0;
	$tot_return_qty = 0;
	$tot_bag = 0;
	$tot_cone = 0;
	$tot_w_bag = 0;
	$tot_w_cone = 0;
	$z = 0;
	$printDataArr = array();
	$jobNoArr = array();
	foreach ($sql_result as $row)
	{

		$bookingNo = $row[csf('booking_no')];
		if ($row[csf('requisition_no')] != "")
		{
			if ($all_req_no == '')
				$all_req_no = $row[csf('requisition_no')];
			else
				$all_req_no .= ',' . $row[csf('requisition_no')];

			if ($all_prod_id == '')
				$all_prod_id = $row[csf('po_id')];
			else
				$all_prod_id .= ',' . $row[csf('po_id')];
		}
		$order_qnty_val = $row[csf('cons_quantity')];
		$order_qnty_val_sum += $order_qnty_val;

		$order_amount_val = $row[csf('order_amount')];
		$order_amount_val_sum += $order_amount_val;

		$no_of_bags_val = $row[csf('no_of_bags')];
		$no_of_bags_val_sum += $no_of_bags_val;

		$po_id = explode(",", $row[csf('po_id')]);
		$po_no = "";
		$style_ref = "";
		$job_no = "";
		$buyer = "";
		$sustainability = "";
		$material = "";
		$fab_material=array(1=>"Organic",2=>"BCI");
			//$data=explode('*',$data);
		$productdtls = $row[csf('product_name_details')];
		$productArr = explode(' ', $productdtls);

		$proddtls = "";
		if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
		}
		else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
		}
		else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
		}
		else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
		}
		else if ($productArr[0] != '' && $productArr[1] != '')
		{
			$proddtls = $productArr[0] . ', ' . $productArr[1];
		}
		else if ($productArr[0] != '')
		{
			$proddtls = $productArr[0];
		}
		else
		{
			$proddtls = "";
		}

		$internal_ref = "";
		$file_no = "";

		if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
		{
			foreach ($po_id as $val)
			{
				if ($po_no == '')
					$po_no = $po_array[$val]['no'];
				else
					$po_no .= ", " . $po_array[$val]['no'];

				if ($job_no == '')
				{
					$job_no = $po_array[$val]['job_no'];

					if($job_no != '')
					{
						$jobNoArr[$job_no] = $job_no;
					}
				}

				if ($sustainability  == '')
					$sustainability  = $po_array[$val]['sustainability'];

				if ($material   == '')
					$material  = $po_array[$val]['fab_material'];

				if ($style_ref == '')
				{
					if($knit_source==3 && $show_val_column==0 && $dataArray[0][csf('issue_purpose')] != 8)
					{
						$style_ref = 'WHS';
					}
					else
					{
						$style_ref = $po_array[$val]['style_ref'];
					}
					//$style_ref = $po_array[$val]['style_ref'];
				}


				if ($buyer == '')
					$buyer_name = $po_array[$val]['buyer_name'];

				if ($internal_ref == '')
					$internal_ref = $po_array[$val]['grouping'];
				else
					$internal_ref .= "," . $po_array[$val]['grouping'];

				if ($file_no == '')
					$file_no = $po_array[$val]['file_no'];
				else
					$file_no .= "," . $po_array[$val]['file_no'];
			}

			$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
			$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

			$ref_cond = "";
			foreach ($job_ref as $ref) {
				if ($ref_cond == '')
					$ref_cond = $ref;
				else
					$ref_cond .= ", " . $ref;
			}

			$file_con = "";
			foreach ($job_file as $file)
			{
				if ($file_con == '')
					$file_cond = $file;
				else
					$file_cond .= ", " . $file;
			}

			$buyer_job = "";
			if ($row[csf('issue_basis')] == 1)
			{
				if ($dataArray[0][csf('issue_purpose')] == 8 )
				{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS';
						}
						else
						{
							$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
						}

						//$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
				}
				else
				{
					$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']];
					if ($row[csf('buyer_job_no')] != "")
					{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS' . '::' . $row[csf('buyer_job_no')];
						}
						else
						{
							$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . '::' . $row[csf('buyer_job_no')];
						}
						//$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . '::' . $row[csf('buyer_job_no')];

						if($buyer_job != '')
						{
							$jobNoArr[$row[csf('buyer_job_no')]] = $row[csf('buyer_job_no')];
						}
					}
					else
					{
						if($knit_source==3 && $show_val_column==0)
						{
							$buyer_job = 'WHS';
						}
						else
						{
							$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
						}
					}
				}

				//for ydw and ysw booking no
				if ($dataArray[0][csf('issue_purpose')] == 2 || $dataArray[0][csf('issue_purpose')] == 7 || $dataArray[0][csf('issue_purpose')] == 12 || $dataArray[0][csf('issue_purpose')] == 15 || $dataArray[0][csf('issue_purpose')] == 38 || $dataArray[0][csf('issue_purpose')] == 44 || $dataArray[0][csf('issue_purpose')] == 46 || $dataArray[0][csf('issue_purpose')] == 50 || $dataArray[0][csf('issue_purpose')] == 51)
				{
					$bookingNo = $YwdBookingNoArr[$row[csf('booking_no')]]['ydwbooking'];
				}
			}
			else if ($row[csf('issue_basis')] == 2)
			{
				$buyer_job = "";
			}

		}
		else if ($row[csf('issue_basis')] == 3)
		{
			//for booking no
			$bookingNo = $reqBookingNoArr[$row[csf('requisition_no')]]['booking_no'];
			$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
			//print_r($ex_data);

			if ($is_sales_array[$row[csf('requisition_no')]] == 1)
			{
				$buyer_job = "";
				foreach (array_unique($po_id) as $val)
				{
					if ($po_no == "")
						$po_no = $job_no_array[$val]['job_no'];
					else
						$po_no .= ", " . $job_no_array[$val]['job_no'];

					if ($style_ref == "")
						$style_ref = $job_no_array[$val]['style_ref'];

					if ($sustainability  == '')
						$sustainability  = $po_array[$val]['sustainability'];

					if ($material   == '')
						$material  = $po_array[$val]['fab_material'];

					if ($buyer_job == "") {
						if ($job_no_array[$val]['within_group'] == 1)
						{
							$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
						}
						else
						{
							$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
						}
					}

					if ($job_no_array[$val]['within_group'] != 1)
					{
						$ref_cond = "";
					}
				}
			}
			else
			{
				foreach ($po_id as $val)
				{
					if ($po_no == "")
						$po_no = $po_array[$val]['no'];
					else
						$po_no .= ", " . $po_array[$val]['no'];

					if ($job_no == "")
					{
						$job_no = $po_array[$val]['job_no'];


						if($job_no != '')
						{
							$jobNoArr[$job_no] = $job_no;
						}
					}

					if ($style_ref == "")
					{
						if($knit_source==3 && $show_val_column==0)
						{
							$style_ref = 'WHS';
						}
						else
						{
							$style_ref = $po_array[$val]['style_ref'];
						}
						//$style_ref = $po_array[$val]['style_ref'];
					}


					if ($sustainability  == '')
						$sustainability  = $po_array[$val]['sustainability'];

					if ($material   == '')
						$material  = $po_array[$val]['fab_material'];

					if ($buyer == "")
						$buyer_name = $po_array[$val]['buyer_name'];

					if ($internal_ref == "")
						$internal_ref = $po_array[$val]['grouping'];
					else
						$internal_ref .= "," . $po_array[$val]['grouping'];

					if ($file_no == "")
						$file_no = $po_array[$val]['file_no'];
					else
						$file_no .= "," . $po_array[$val]['file_no'];
				}

				$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
				$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

				$ref_cond = "";
				foreach ($job_ref as $ref)
				{
					if ($ref_cond == "") $ref_cond = $ref; else $ref_cond .= ", " . $ref;
				}

				$file_con = "";
				foreach ($job_file as $file)
				{
					if ($file_con == "")
						$file_cond = $file;
					else
						$file_cond .= ", " . $file;
				}

				if ($job_no != "")
				{
					if($knit_source==3 && $show_val_column==0)
					{
						$buyer_job = 'WHS' . '::' . $job_no;
					}
					else
					{
						$buyer_job = $buyer_arr[$buyer_name] . '::' . $job_no;
					}

					$jobNoArr[$job_no] = $job_no;
				}
				else
				{
					$buyer_job = $buyer_arr[$buyer_name];
				}
			}

			//for sample
			if($reqBookingNoArr[$row[csf('requisition_no')]]['is_sample'] == 2)
			{
				$buyer_job = $buyer_arr[$dataSampleArr[$bookingNo]['buyer_id']];
				$style_ref = $dataSampleArr[$bookingNo]['style_ref_no'];
				$sustainability = $dataSampleArr[$bookingNo]['sustainability_std_id'];
				$material = $dataSampleArr[$bookingNo]['fabric_material_id'];
			}
		}
		else
		{
			foreach (array_unique($po_id) as $val)
			{
				if ($po_no == "")
					$po_no = $job_no_array[$val]['job_no'];
				else
					$po_no .= ", " . $job_no_array[$val]['job_no'];

				if ($style_ref == "")
					$style_ref = $job_no_array[$val]['style_ref'];


				if ($buyer_job == "")
				{
					if ($job_no_array[$val]['within_group'] == 1)
					{
						$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
					}
					else
					{
						$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
					}
				}
			}
		}

		$no_bag_cone = "";
		$wt_bag_cone = "";
		if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0)
			$no_bag_cone = 'N:' . $no_of_bags_val;
		else
			$no_bag_cone = 'N:' . $no_of_bags_val . ' & ' . $row[csf('cone_per_bag')];

		if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0)
			$wt_bag_cone = 'W:' . $row[csf('weight_per_bag')];
		else
			$wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];

		//for buyer job and style
		$buyer_job_style = $buyer_job.($style_ref != ''?'::'.$style_ref:'');
		$req_no = ($row[csf('requisition_no')] != 0 ? $row[csf('requisition_no')]:'');
		$item_description = $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];

		//for print data
		$z++;
		//$printDataArr[$z]['buyer_job_style'] = $buyer_job.($style_ref != ''?'::'.$style_ref:'').($mainbookingNo != ''?'::'.$mainbookingNo:'').($sustainability*1 != ''?'::'.$sustainability_standard[$sustainability]:'').($material*1 != ''?'::'.$fab_material[$material]:'');
		//$printDataArr[$z]['buyer_job_style'] = $buyer_job.($style_ref != ''?'::'.$style_ref:'').($bookingNo != ''?'::'.$bookingNo:'').($sustainability*1 != ''?'::'.$sustainability_standard[$sustainability]:'').($material*1 != ''?'::'.$fab_material[$material]:'');

		$printDataArr[$z]['buyer_job_style'] = $buyer_job.($style_ref != ''?'::'.$style_ref:'');
		$printDataArr[$z]['req_no'] = ($row[csf('requisition_no')] != 0 ? $row[csf('requisition_no')]:$row[csf('booking_no')]);
		$printDataArr[$z]['prog_no'] = $program_array[$row[csf('requisition_no')]];
		$printDataArr[$z]['lot'] = $row[csf('lot')];
		$printDataArr[$z]['yarn_type'] = $row[csf('yarn_type')];
		$printDataArr[$z]['item_description'] = $item_description;
		$printDataArr[$z]['dyeing_color_id'] = $row[csf('dyeing_color_id')];
		$printDataArr[$z]['color_id'] = $row[csf('color')];

		//for supplier
		//$printDataArr[$z]['supplier_id'] = $row[csf('supplier_id')];
		if($row[csf('is_within_group')] == 1)
		{
			$supplier_name = $company_arr[$row[csf('supplier_id')]];
		}
		else
		{
			$supplier_name = $supplier_arr[$row[csf('supplier_id')]];
		}
		$printDataArr[$z]['supplier_id'] = $supplier_name;

		$printDataArr[$z]['cons_quantity'] = $row[csf('cons_quantity')];
		$printDataArr[$z]['returnable_qnty'] = $row[csf('returnable_qnty')];
		$printDataArr[$z]['no_bag_cone'] = $no_bag_cone;
		$printDataArr[$z]['wt_bag_cone'] = $wt_bag_cone;
		$printDataArr[$z]['store_id'] = $row[csf('store_id')];
		$printDataArr[$z]['po_no'] = $po_no;
		$printDataArr[$z]['remarks'] = $row[csf('remarks')];

		$printDataArr[$z]['no_of_bags_val'] = $no_of_bags_val;
		$printDataArr[$z]['cone_per_bag'] = $row[csf('cone_per_bag')];
		$printDataArr[$z]['weight_per_bag'] = $row[csf('weight_per_bag')];
		$printDataArr[$z]['weight_per_cone'] = $row[csf('weight_per_cone')];
		$printDataArr[$z]['issue_number'] = $row[csf('issue_number')];


		if ($row[csf('issue_purpose')] == 3)
		{
			$printDataArr[$z]['issue_to'] = $buyer_dtls_arr[$row[csf('buyer_id')]];
		}
		else if ($row[csf('issue_purpose')] == 5)
		{
			$printDataArr[$z]['issue_to'] = $supplier_dtls_arr[$row[csf('loan_party')]] ;
		}
		else
		{
			if ($row[csf('knit_dye_source')] == 1)
				$printDataArr[$z]['issue_to'] = $company_library[$row[csf('knit_dye_company')]];
			else
				$printDataArr[$z]['issue_to'] = $supplier_dtls_arr[$row[csf('knit_dye_company')]];
		}

	}



	$noOfCopy = "";
	for ($x = 1; $x <= $no_copy; $x++)
	{
		if($x==1)
		{
			$sup = 'st';
		}
		else if($x==2)
		{
			$sup = 'nd';
		}
		else if($x==3)
		{
			$sup = 'rd';
		}
		else
		{
			$sup = 'th';
		}

		$noOfCopy ="<span style='font-size:x-large;font-weight:bold'>".$x."<sup>".$sup."</sup> Copy</span>";
		?>


		<div style="width:1320px;">
			<table width="1300" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
				<tr>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row)
						{
							if ($data[5] != 1)
							{
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50' align="middle"/>
								<?
							}
							else
							{
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50' align="middle"/>
								<?
							}
						}
						?>
					</td>
                    <td align="center" style="font-size:30px" colspan="6"><strong><? echo $com_dtls[0]."<br><span style=\"font-size:14px;\">".$com_dtls[1]."</span>"; ?></strong></td>
					<td width="110" align="right"><?php echo $noOfCopy.($is_gate_pass==1?"<br><span style=\"color:#F00;font-weight:bold;\">Gate Pass Done</span>":'').($is_gate_out==1?"<br><span style=\"color:#F00;font-weight:bold;\">Gate Out Done</span>":''); ?></td>
				</tr>
				<tr>
					<td colspan="6" align="center" height="50" valign="middle" style="font-size:25px">
						<strong><u>Yarn Delivery Challan</u></strong>
						<?php
						if ($data[4] == 1)
						{

							?>
							<span style="color:#0F0; font-weight:bold;">[Approved]</span>
							<?php
						}
						?>
					</td>
				</tr>
			</table>
			<br>
			<div style="width:100%;">
				<div style="clear:both;">
					<table style="margin-right:-40px;" cellspacing="0" width="1000" border="1" rules="all" class="rpt_table">
						<thead bgcolor="#dddddd">
							<th width="20">SL</th>
							<th width="150">Trans. Ref.</th>
							<th width="180">Issue To</th>
							<th width="100">Buyer, Job, Style</th>
							<th width="45">Req. No/Work Order</th>
							<th width="50">Knitting Prog. No</th>
							<th width="50">Lot No</th>
							<th width="65">Yarn Type</th>
							<th width="110">Item Details</th>
							<th width="65">Dye. Color</th>
							<th width="60">Color</th>
							<th width="60">Supp.</th>
							<th width="60">Issue Qty(kg)</th>
							<th width="60">Rtnbl Qty(kg)</th>
							<th width="60">Bag & Cone</th>
							<th width="100">Order/PO</th>
							<th width="60">Store</th>
							<th>Remarks</th>
						</thead>
                        <tbody>
						<?
						$i= 0;
						foreach($printDataArr as $key=>$val)
						{
							$i++;
							if ($i % 2 == 0)
								$bgcolor = "#E9F3FF";
							else
								$bgcolor = "#FFFFFF";
							?>
                            <tr bgcolor="<? echo $bgcolor; ?>">
                                <td><? echo $i; ?></td>
                                <td>
                                    <div style="word-wrap:break-word; width:150px"><? echo $val['issue_number']; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:180px"><? echo $val['issue_to']; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:100px"><? echo $val['buyer_job_style']; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:45px"><? echo $val['req_no']; ?></div>
                                </td>
                                <td>
                                    <?  echo $val['prog_no']; ?>
                                </td>
                                <td width="50">
                                    <div style="word-wrap:break-word; width:50px"><? echo $val['lot']; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:65px"><? echo $yarn_type[$val['yarn_type']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:110px">
                                        <? echo $val['item_description']; ?>
                                    </div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:65px"><? echo $color_name_arr[$val['dyeing_color_id']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $color_name_arr[$val['color_id']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $val['supplier_id']; ?></div>
                                </td>
                                <td align="right"><? echo number_format($val['cons_quantity'], 2, '.', ''); ?></td>
                                <td align="right"><? echo number_format($val['returnable_qnty'], 2, '.', ''); ?></td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $val['no_bag_cone'] . '<br>' . $val['wt_bag_cone'] ?>&nbsp;</div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:100px; font-size:12px;"><? echo $val['po_no']; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:60px"><? echo $store_arr[$val['store_id']]; ?></div>
                                </td>
                                <td>
                                    <div style="word-wrap:break-word; width:80px"><? echo $val['remarks']; ?></div>
                                </td>
                            </tr>
							<?
							$uom_unit = "Kg";
							$uom_gm = "Grams";
							$tot_return_qty += $val['returnable_qnty'];
							$tot_bag += $val['no_of_bags_val'];
							$tot_cone += $val['cone_per_bag'];
							$tot_w_bag += $val['weight_per_bag'];
							$tot_w_cone += $val['weight_per_cone'];
						}
						?>
						<tr bgcolor="#CCCCCC" style="font-size:16px">
							<td colspan="2"><b>Total Job:
                            <?php
							if(!empty($jobNoArr))
							{
                           		echo " ".count($jobNoArr);
							}
							?>
                            </b></td>
							<td align="right" colspan="10"><b>Total</b></td>
							<td align="right">
								<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 2, '.', ''); ?></b>
							</td>
							<td align="right"><? echo number_format($tot_return_qty, 2, '.', ''); ?></td>
							<td><? echo 'N:' . number_format($tot_bag, 2);
							if ($tot_cone != "") echo ' & ' . number_format($tot_cone, 2);
							echo '<br>W:' . number_format($tot_w_bag, 2);
							if ($tot_w_cone != "") echo ' & ' . number_format($tot_w_cone, 2); ?></td>
							<td align="right" colspan="3">&nbsp;</td>
						</tr>
						<tr>
							<td colspan="18" align="left"><b>In
							Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
						</tr>
                        <tr>
                        	<td colspan="18" height="30" style="border-left:hidden;border-right:hidden;">&nbsp;</td>
                        </tr>
                        <tr>
                        	<td colspan="9" align="center" valign="middle" style="font-size:25px;"><strong>&lt;&lt;Gate Pass&gt;&gt;</strong></td>
                            <td colspan="9" align="center" valign="middle" id="gate_pass_barcode_img_id_<?php echo $x; ?>" height="50"></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>From Company:</strong></td>
                        	<td colspan="4"><?php echo $gatePassDataArr[$gatePass]['from_company']; ?></td>
                        	<td colspan="2"><strong>To Company:</strong></td>
                        	<td colspan="4"><?php echo $gatePassDataArr[$gatePass]['to_company']; ?></td>
                        	<td colspan="3"><strong>Carried By:</strong></td>
                        	<td colspan="4"><?php echo $gatePassDataArr[$gatePass]['carried_by']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>From Location:</strong></td>
                        	<td colspan="4"><?php echo $gatePassDataArr[$gatePass]['from_location']; ?></td>
                        	<td colspan="2"><strong>To Location:</strong></td>
                        	<td colspan="4"><?php echo $gatePassDataArr[$gatePass]['to_location']; ?></td>
                        	<td colspan="3"><strong>Driver Name:</strong></td>
                        	<td colspan="4"><?php echo $gatePassDataArr[$gatePass]['driver_name']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Gate Pass ID:</strong></td>
                        	<td colspan="4"><?php echo $gatePassDataArr[$gatePass]['gate_pass_id']; ?></td>
                        	<td colspan="2" rowspan="2"><strong>Delivery Qnty</strong></td>
                        	<td align="center" colspan="2"><strong>Kg</strong></td>
                        	<td align="center" colspan="2"><strong>Bag</td>
                        	<td colspan="3"><strong>Vehicle Number:</strong></td>
                        	<td colspan="5"><?php echo $gatePassDataArr[$gatePass]['vhicle_number']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Gate Pass Date:</strong></td>
                        	<td colspan="4"><?php echo $gatePassDataArr[$gatePass]['gate_pass_date']; ?></td>
                        	<td colspan="2" align="center"><?php echo $gatePassDataArr[$gatePass]['delivery_kg']; ?></td>
                        	<td colspan="2" align="center"><?php echo $gatePassDataArr[$gatePass]['delivery_bag']; ?></td>
                        	<td colspan="3"><strong>Driver License No.:</strong></td>
                        	<td colspan="5"><?php echo $gatePassDataArr[$gatePass]['driver_license_no']; ?></td>
	                    <tr>
                        	<td colspan="2"><strong>Out Date:</strong></td>
                        	<td colspan="4"><?php echo $gatePassDataArr[$gatePass]['out_date']; ?></td>
                        	<td colspan="2"><strong>Dept. Name:</strong></td>
                        	<td colspan="4"><?php echo $gatePassDataArr[$gatePass]['department']; ?></td>
                        	<td colspan="3"><strong>Mobile No.:</strong></td>
                        	<td colspan="5"><?php echo $gatePassDataArr[$gatePass]['mobile_no']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Out Time:</strong></td>
                        	<td colspan="4"><?php echo $gatePassDataArr[$gatePass]['out_time']; ?></td>
                        	<td colspan="2"><strong>Attention:</strong></td>
                        	<td colspan="4"><?php echo $gatePassDataArr[$gatePass]['attention']; ?></td>
                        	<td colspan="3"><strong>Sequrity Lock No.:</strong></td>
                        	<td colspan="5"><?php echo $gatePassDataArr[$gatePass]['security_lock_no']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Returnable:</strong></td>
                        	<td colspan="4"><?php echo $gatePassDataArr[$gatePass]['returnable']; ?></td>
                        	<td colspan="2"><strong>Purpose:</strong></td>
                        	<td colspan="10"><?php echo $gatePassDataArr[$gatePass]['issue_purpose']; ?></td>
                        </tr>
                        <tr>
                        	<td colspan="2"><strong>Est. Return Date:</strong></td>
                        	<td colspan="4"><?php echo $gatePassDataArr[$gatePass]['est_return_date']; ?></td>
                        	<td colspan="2"><strong>Remarks:</strong></td>
                        	<td colspan="10"><?php echo $gatePassDataArr[$gatePass]['remarks']; ?></td>
                        </tr>
                    </tbody>
                    </table>
				</div>
				<br>
				<? echo signature_table(49, $company, "1000px"); ?>
			</div>
		</div>
		<script type="text/javascript" src="../js/jquery.js"></script>
        <script type="text/javascript" src="../js/jquerybarcode.js"></script>
		<script>

			//for gate pass barcode
			function generateBarcodeGatePass(valuess)
			{
				var zs = '<?php echo $x; ?>';
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#gate_pass_barcode_img_id_"+zs).html('11');
				value = {code: value, rect: false};
				$("#gate_pass_barcode_img_id_"+zs).show().barcode(value, btype, settings);
			}

			if('<? echo $gatePassDataArr[$gatePass]['gate_pass_id']; ?>' != '')
			{
				generateBarcodeGatePass('<? echo strtoupper($gatePassDataArr[$gatePass]['gate_pass_id']); ?>');
			}
		</script>
        <div style="page-break-after:always;"></div>
    <?php
	}
    exit();
}


if ($action == "yarn_issue_print21")
{
	extract($_REQUEST);
	echo load_html_head_contents("Yarn Issue Challan Print2", "../../", 1, 1, '', '', '');
	$data = explode('*', $data);

	$print_with_vat = $data[7];
	$company=$data[0];
	$location=$data[8];
	$store_id=$data[9];
	$store_location_id=return_field_value("location_id","lib_store_location","id=$store_id and is_deleted=0","location_id");
	/*$supplier_arr=return_library_array( "select id, short_name from lib_supplier",'id','short_name');
	$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');*/

	$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');


	//$other_party_arr=return_library_array( "select id, other_party_name from  lib_other_party",'id','other_party_name');
	$store_arr = return_library_array("select id, store_name from lib_store_location", 'id', 'store_name');
	$color_name_arr = return_library_array("select id, color_name from lib_color where status_active=1 and is_deleted=0", 'id', 'color_name');
	$location_arr = return_library_array("select id,location_name from lib_location", "id", "location_name");
	$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count",'id','yarn_count');
	$floor_room_rack_arr = return_library_array("select floor_room_rack_id, floor_room_rack_name from lib_floor_room_rack_mst", 'floor_room_rack_id', 'floor_room_rack_name');

	$sql = " select id, issue_number, issue_basis, location_id, buyer_job_no, booking_id, booking_no, loan_party, knit_dye_source, challan_no, issue_purpose, buyer_id, issue_date, knit_dye_company, gate_pass_no, remarks, inserted_by from inv_issue_master where id='$data[5]'";
	//echo $sql;die;
	$dataArray = sql_select($sql);
	$inserted_by=$dataArray[0]['INSERTED_BY'];
	// echo "<pre>"; print_r($dataArray); die;

	if( $dataArray[0][csf('issue_basis')]==3 )
	{
		$planbooking = sql_select("select e.booking_no as pln_booking_no from inv_issue_master a, inv_transaction b, ppl_yarn_requisition_entry c,ppl_planning_info_entry_dtls d,ppl_planning_info_entry_mst e where a.id=b.mst_id and b.requisition_no=c.requisition_no and c.knit_id=d.id and d.mst_id=e.id and a.id='$data[5]' ");
	}

	$company_library = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$com_dtls = fnc_company_location_address($company, $store_location_id, 2);
	?>
	<style type="text/css">
		table tbody tr td {
			font-size: 14px;
		}
	</style>
	<div style="width:1000px;">
		<table width="1000" cellspacing="0" align="right" border="0" style="margin-right:-10px;">
			<tr>
				<td colspan="6" align="center" style="font-size:20px">
					<strong><? echo $com_dtls[0]; ?></strong></td>
					<td style="font-size:xx-large; font-style:italic;" align="right">
						<div style="color:#FF0000"><? if ($data[4] == 1) echo "<b>Approved</b>"; ?></div>
					</td>
				</tr>
				<tr class="form_caption">

					<?
					$data_array = sql_select("select image_location  from common_photo_library  where master_tble_id='$data[0]' and form_name='company_details' and is_deleted=0 and file_type=1");
					?>
					<td align="left" width="50">
						<?
						foreach ($data_array as $img_row) {
							if ($data[5] != 1) {
								?>
								<img src='../../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							} else {
								?>
								<img src='../<? echo $com_dtls[2]; ?>' height='50' width='50'
								align="middle"/>
								<?
							}
						}
						?>
					</td>
					<td colspan="4" style="font-size:16px" align="center">
						<?
						echo $com_dtls[1];
					/*$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$data[0]");
				foreach ($nameArray as $result)
				{
				?>
					Plot No: <? echo $result[csf('plot_no')]; ?>
					Level No: <? echo $result[csf('level_no')]?>
					Road No: <? echo $result[csf('road_no')]; ?>
					Block No: <? echo $result[csf('block_no')];?>
					City No: <? echo $result[csf('city')];?>
					Zip Code: <? echo $result[csf('zip_code')]; ?>
					Province No: <?php echo $result[csf('province')];?>
					Country: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
					Email Address: <? echo $result[csf('email')];?>
					Website No: <? echo $result[csf('website')];
				}*/
				?>
			</td>
			<td>&nbsp;</td>
		</tr>
		<tr>
			<td colspan="6" align="center" style="font-size:20px"><strong><u>Yarn Delivery Challan/Gate Pass</u></strong></center>
			</td>
			<td>&nbsp;</td>
		</tr>
		<tr>
			<td width="120"><strong>Issue No:</strong></td>
			<td width="175px"><strong style="font-size:20px !important"><? echo $dataArray[0][csf('issue_number')]; ?></strong></td>
			<td width="120"><strong>Booking:</strong></td>
			<td width="175px">
				<?
				if( $dataArray[0][csf('issue_basis')]==3 )
				{
					$bookingNo = $planbooking[0][csf('pln_booking_no')];
				} else {
					$bookingNo = $dataArray[0][csf('booking_no')];
				}
				echo $bookingNo;
				?>
			</td>
			<td width="125"><strong>Knitting Source:</strong></td>
			<td width="175px"><? echo $knitting_source[$dataArray[0][csf('knit_dye_source')]]; ?></td>
		</tr>
		<tr>


			<td><strong>Issue Purpose:</strong></td>
				<td width="175px"><? //if ($dataArray[0][csf('issue_purpose')] == 3) echo "Knitting Purpose"; else
				echo $yarn_issue_purpose[$dataArray[0][csf('issue_purpose')]];//
				?></td>
				<td><strong>Issue Date:</strong></td>
				<td width="175px"><? echo change_date_format($dataArray[0][csf('issue_date')]); ?></td>
			</tr>
			<tr>
				<td><strong>Issue To:</strong></td>
				<?
				if ($dataArray[0][csf('knit_dye_source')] == 3) {
					$supp_add = $dataArray[0][csf('knit_dye_company')];
					$nameArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$supp_add");
					foreach ($nameArray as $result) {
						$address = "";
						if ($result != "") $address = $result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
					}
					unset($nameArray);
				}

				$loan_party_add = $dataArray[0][csf('loan_party')];
				$loanPartyArray = sql_select("select address_1,web_site,email,country_id from lib_supplier where id=$loan_party_add");
				foreach ($loanPartyArray as $result) {
					$addressParty = "";
					if ($result != "") $addressParty = $result['address'];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
				}
				unset($loanPartyArray);
				?>
				<td colspan="4"><strong style="font-size:20px !important;">
					<?
					if ($dataArray[0][csf('issue_purpose')] == 3) {
						echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
					} else if ($dataArray[0][csf('issue_purpose')] == 5) {
						echo $supplier_arr[$dataArray[0][csf('loan_party')]] . ' : Address :- ' . $addressParty;
					} else {
						if ($dataArray[0][csf('knit_dye_source')] == 1)
							echo $company_library[$dataArray[0][csf('knit_dye_company')]];
						else
							echo $supplier_arr[$dataArray[0][csf('knit_dye_company')]] . ' : Address :- ' . $address;
					}
					?></strong>
				</td>
				<td><strong>Location:</strong></td>
				<td><? echo $location_arr[$dataArray[0][csf('location_id')]]; ?></td>


			</tr>
			<tr>
				<td><strong>Do No:</strong></td>
				<td width="175px"><? //echo $dataArray[0][csf('remarks')];
				?></td>
			</tr>
			<tr>
				<td valign="top"><strong>Remarks :</strong></td>
				<td colspan="5"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
			</tr>
			<?
			if ($print_with_vat == 1) {
				?>
				<tr>
					<!-- <td><strong>VAT Number :</strong></td>
					<td><p>
						<?
					$vat_no = return_field_value("vat_number", "lib_company", "id=" . $data[0], "vat_number");
					echo $vat_no;
					?></p></td> -->
					<td><strong>Bar Code:</strong></td>
					<td colspan="3" id="barcode_img_id"></td>
				</tr>
				<?
			} else {
				?>
				<tr>
					<td valign="top">&nbsp;</strong></td>
					<td>&nbsp;</td>
					<td><strong>Bar Code:</strong></td>
					<td colspan="3" id="barcode_img_id"></td>
				</tr>
				<?
			}
			?>
		</table>
		<br>
		<div style="width:100%;">
			<div style="clear:both;">
				<table style="margin-right:-40px; " cellspacing="0" width="1260" border="1" rules="all"
				class="rpt_table">
				<thead bgcolor="#dddddd" style="font-size:13px">
					<th width="20">SL</th>
					<th width="45">Req. No</th>
					<th width="50">Program No</th>
					<th width="50">Lot No</th>
					<th width="40">Y. Type</th>
					<th width="150">Item Details</th>
					<th width="110">Supp.</th>
					<th width="60"><b>Issue Qty(kg)</b></th>
					<th width="60">Rtnbl Qty(kg)</th>
					<th width="40">Bag</th>
					<th width="40">Cone</th>
					<th width="80">Store</th>
					<th width="100">Job</th>
					<th width="120">Order & Style</th>
				</thead>
				<?
				//$wopi_library = return_library_array("select id,pi_number from com_pi_master_details", "id", "pi_number");
				$cond = "";
				if ($data[5] != "") $cond .= " and c.id='$data[5]'";

				$i = 1;
				if ($db_type == 0)
				{
					$sql_result = sql_select("SELECT a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, group_concat(d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, c.issue_purpose, c.booking_id from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, c.issue_purpose, c.booking_id");
				}
				else
				{
					$sql_result = sql_select("SELECT a.id, a.lot,a.color,a.yarn_type, a.product_name_details, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, a.detarmination_id, a.is_within_group, b.dyeing_color_id, b.id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty as returnable_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.supplier_id, LISTAGG(d.po_breakdown_id, ',') WITHIN GROUP (ORDER BY d.po_breakdown_id) as po_id, sum(d.returnable_qnty) as returnable_qnty_pro, c.issue_purpose, c.booking_id from product_details_master a, inv_issue_master c, inv_transaction b left join order_wise_pro_details d on b.id=d.trans_id where c.id=b.mst_id and b.prod_id=a.id and b.transaction_type=2 and b.item_category=1 and c.entry_form=3 and b.status_active=1 and b.is_deleted=0 $cond group by a.id, a.lot,a.color, a.yarn_type, a.product_name_details, a.detarmination_id, a.is_within_group, a.supplier_id, b.id, b.dyeing_color_id, b.requisition_no, b.cons_uom, b.cons_quantity, b.return_qnty, b.store_id, b.floor_id, b.room, b.no_of_bags, b.cone_per_bag, b.weight_per_bag, b.weight_per_cone, c.issue_basis, c.booking_no, c.buyer_id, c.buyer_job_no, a.yarn_count_id,a.yarn_comp_percent1st,a.yarn_comp_type1st, c.issue_purpose, c.booking_id");
				}

				$bookingIdChk = array();
				$allbookingIdArr = array();
				foreach ($sql_result as $row)
				{
					if($bookingIdChk[$row[csf('booking_id')]] == "")
					{
						$bookingIdChk[$row[csf('booking_id')]] = $row[csf('booking_id')];
						array_push($allbookingIdArr,$row[csf('booking_id')]);
					}
				}

				$nameseason=sql_select("SELECT a.style_ref_no,a.requisition_number, c.booking_no from sample_development_mst a, sample_development_dtls b, wo_non_ord_samp_booking_dtls c where a.id=b.sample_mst_id and a.id=c.style_id ".where_con_using_array($allbookingIdArr,0,'c.booking_mst_id')." ");

				$smn_booking_no_arr = array();
				foreach ($nameseason as $smn_row)
				{
					$smn_booking_no_arr[$smn_row[csf('booking_no')]]['style_ref_no']= $smn_row[csf('style_ref_no')];
					$smn_booking_no_arr[$smn_row[csf('booking_no')]]['requisition_number'] = $smn_row[csf('requisition_number')];
				}


				//for requisition no
				$tmp_req_no_arr = array();
				$tmp_po_id_arr = array();
				foreach ($sql_result as $row)
				{
					$tmp_req_no_arr[$row[csf('requisition_no')]] = $row[csf('requisition_no')];

					//for po
					$exp_po_id = array();
					$exp_po_id = explode(",", $row[csf('po_id')]);
					foreach($exp_po_id as $pkey=>$pval)
					{
						$tmp_po_id_arr[$pval] = $pval;
					}
				}

				$con = connect();
				execute_query("DELETE FROM TMP_REQS_NO WHERE USERID = ".$user_id);
				execute_query("DELETE FROM TMP_POID WHERE USERID = ".$user_id);
				oci_commit($con);

				//for requisition no insert
				$con = connect();
				foreach($tmp_req_no_arr as $key=>$val)
				{
					execute_query("INSERT INTO TMP_REQS_NO(REQS_NO, USERID) VALUES('".$val."', '".$user_id."')");
				}

				foreach($tmp_po_id_arr as $key=>$val)
				{
					execute_query("INSERT INTO TMP_POID(POID, USERID) VALUES('".$val."', '".$user_id."')");
				}
				oci_commit($con);
				//end for requisition no

				//for requisition no
				$po_id_req_array = array();
				$is_sales_array = array();
				if ($db_type == 0)
				{
					$poID = " select c.knit_id,c.requisition_no,a.buyer_id,a.is_sales, group_concat(distinct(a.po_id)) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id AND c.requisition_no IN(SELECT REQS_NO FROM TMP_REQS_NO WHERE USERID = ".$user_id.") group by c.knit_id,c.requisition_no,a.buyer_id,a.is_sales ";
				}
				else
				{
					$poID = "select c.knit_id,c.requisition_no,a.buyer_id,a.is_sales, LISTAGG(a.po_id, ',') WITHIN GROUP (ORDER BY a.po_id) as poid from ppl_planning_entry_plan_dtls a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c where b.id=a.dtls_id and b.id=c.knit_id AND c.requisition_no IN(SELECT REQS_NO FROM TMP_REQS_NO WHERE USERID = ".$user_id.") group by c.knit_id,c.requisition_no,a.buyer_id,a.is_sales ";
				}

				//echo $poID;
				$poID_sql_result = sql_select($poID);
				foreach ($poID_sql_result as $row)
				{
					$po_id_req_array[$row[csf('requisition_no')]] = $row[csf('poid')];
					$is_sales_array[$row[csf('requisition_no')]] = $row[csf('is_sales')];
					$program_array[$row[csf('requisition_no')]]['program_no'] = $row[csf('knit_id')];
					$program_array[$row[csf('requisition_no')]]['buyer_id'] = $row[csf('buyer_id')];
				}
				unset($poID_sql_result);
				//end for requisition no
				/*echo "<pre>";
				print_r($program_array);
				echo "</pre>";*/

				//for po
				$po_array = array();
				$job_array = array();
				$costing_sql = sql_select("select a.job_no, b.file_no,b.grouping,a.style_ref_no, a.buyer_name, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$data[0] AND b.id IN(SELECT POID FROM TMP_POID WHERE USERID = ".$user_id.")");
				foreach ($costing_sql as $row)
				{
					$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
					$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
					$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
					$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
					$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
					$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
					$job_array[$row[csf('job_no')]]['job'] = $row[csf('job_no')];
					$job_array[$row[csf('job_no')]]['buyer'] = $row[csf('buyer_name')];
				}
				unset($costing_sql);
				//end for po

				//for sales order info
				$job_no_array = array();
				$jobData = sql_select("select id, job_no, style_ref_no, within_group, buyer_id from fabric_sales_order_mst where id IN(SELECT POID FROM TMP_POID WHERE USERID = ".$user_id.")");
				foreach ($jobData as $row)
				{
					$job_no_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
					$job_no_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
					$job_no_array[$row[csf('id')]]['within_group'] = $row[csf('within_group')];
					$job_no_array[$row[csf('id')]]['buyer_id'] = $row[csf('buyer_id')];
				}
				//end for sales order info

				execute_query("DELETE FROM TMP_REQS_NO WHERE USERID = ".$user_id);
				execute_query("DELETE FROM TMP_POID WHERE USERID = ".$user_id);
				oci_commit($con);

				$all_req_no = '';
				$all_prod_id = '';
				$order_qnty_val_sum=$order_amount_val_sum=$no_of_bags_val_sum=0;
				$tot_return_qty = $tot_bag = $tot_cone = $tot_w_bag = $tot_w_cone = 0;
				foreach ($sql_result as $row) {
					if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
					if ($row[csf('requisition_no')] != '') {
						if ($all_req_no == '') $all_req_no = $row[csf('requisition_no')]; else $all_req_no .= ',' . $row[csf('requisition_no')];
						if ($all_prod_id == '') $all_prod_id = $row[csf('po_id')]; else $all_prod_id .= ',' . $row[csf('po_id')];
					}
					$order_qnty_val = $row[csf('cons_quantity')];
					$order_qnty_val_sum += $order_qnty_val;

					$order_amount_val = $row[csf('order_amount')];
					$order_amount_val_sum += $order_amount_val;

					$no_of_bags_val = $row[csf('no_of_bags')];
					$no_of_bags_val_sum += $no_of_bags_val;

					$po_id = explode(",", $row[csf('po_id')]);
					$po_no = '';
					$style_ref = '';
					$job_no = '';
					$buyer = '';
						//$data=explode('*',$data);
					$productdtls = $row[csf('product_name_details')];
					$productArr = explode(' ', $productdtls);

					$proddtls = '';
					if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '' && $productArr[5] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . '%, ' . $productArr[3] . ' ' . $productArr[4] . "%, " . $productArr[5] . ", " . $productArr[6];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '' && $productArr[4] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3] . ', ' . $productArr[4];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '' && $productArr[3] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ' . $productArr[3];
					} else if ($productArr[0] != '' && $productArr[1] != '' && $productArr[2] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1] . ' ' . $productArr[2] . ' %, ';
					} else if ($productArr[0] != '' && $productArr[1] != '') {
						$proddtls = $productArr[0] . ', ' . $productArr[1];
					} else if ($productArr[0] != '') {
						$proddtls = $productArr[0];
					} else {
						$proddtls = '';
					}

					$internal_ref = '';
					$file_no = '';
					if ($row[csf('issue_basis')] == 1 || $row[csf('issue_basis')] == 2)
					{
						foreach ($po_id as $val) {
							if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
							if ($job_no == '') $job_no = $po_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
							if ($buyer == '') $buyer_name = $po_array[$val]['buyer_name'];

							if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
							if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
						}
						$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
						$job_file = array_unique(explode(",", rtrim($file_no, ", ")));
						$ref_cond = '';
						foreach ($job_ref as $ref) {
								//$ref_cond.=", ".$ref;
							if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
						}
						$file_con = '';
						foreach ($job_file as $file) {
							if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
						}

						$buyer_job = '';
						if ($row[csf('issue_basis')] == 1)
						{
							if ($dataArray[0][csf('issue_purpose')] == 8)
							{
								//$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
							}
							else
							{
								if ($row[csf('buyer_job_no')] != "")
								{
									//$buyer_job = $buyer_arr[$job_array[$row[csf('buyer_job_no')]]['buyer']] . ' & ' . $row[csf('buyer_job_no')];
									$buyer_job = $row[csf('buyer_job_no')];
								}
								else
								{
									//$buyer_job = $buyer_arr[$row[csf('buyer_id')]];
								}
							}
						} else if ($row[csf('issue_basis')] == 2) {
							$buyer_job = '';
						}
						if($row[csf('issue_basis')] == 1 && $row[csf('issue_purpose')]==8)
						{
							$style_ref = $smn_booking_no_arr[$row[csf('booking_no')]]['style_ref_no'];
							$buyer_job = $smn_booking_no_arr[$row[csf('booking_no')]]['requisition_number'];
						}
					}
					else if ($row[csf('issue_basis')] == 3)
					{
						$po_id = array_unique(explode(",",$po_id_req_array[$row[csf('requisition_no')]]));
							//print_r($ex_data);

						if ($is_sales_array[$row[csf('requisition_no')]] == 1)
						{
							$buyer_job = '';
							foreach (array_unique($po_id) as $val) {
								if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];

								if ($buyer_job == '') {
									if ($job_no_array[$val]['within_group'] == 1) {
										//$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
									} else {
										//$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
									}
								}

								if ($job_no_array[$val]['within_group'] != 1) {
									$ref_cond = '';
								}

							}
						}
						else
						{
							foreach ($po_id as $val)
							{
								if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= ", " . $po_array[$val]['no'];
								if ($job_no == '') $job_no = $po_array[$val]['job_no'];
								if ($style_ref == '') $style_ref = $po_array[$val]['style_ref'];
								if ($internal_ref == '') $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
								if ($file_no == '') $file_no = $po_array[$val]['file_no']; else $file_no .= "," . $po_array[$val]['file_no'];
							}

							$job_ref = array_unique(explode(",", rtrim($internal_ref, ", ")));
							$job_file = array_unique(explode(",", rtrim($file_no, ", ")));

							$ref_cond = '';
							foreach ($job_ref as $ref) {
									//$ref_cond.=", ".$ref;
								if ($ref_cond == '') $ref_cond = $ref; else $ref_cond .= ", " . $ref;
							}

							$file_con = '';
							foreach ($job_file as $file) {
								if ($file_con == '') $file_cond = $file; else $file_cond .= ", " . $file;
							}

							//$buyer_job = $buyer_arr[$program_array[$row[csf('requisition_no')]]['buyer_id']];

							if ($job_no != '')
							{
								//$buyer_job .= ' & ' . $job_no;
								$buyer_job = $job_no;
							}
						}
					}
					else
					{
						foreach (array_unique($po_id) as $val) {
							if ($po_no == '') $po_no = $job_no_array[$val]['job_no']; else $po_no .= ", " . $job_no_array[$val]['job_no'];
							if ($style_ref == '') $style_ref = $job_no_array[$val]['style_ref'];
							if ($buyer_job == '') {
								if ($job_no_array[$val]['within_group'] == 1) {
									//$buyer_job = $company_library[$job_no_array[$val]['buyer_id']];
								} else {
									//$buyer_job = $buyer_arr[$job_no_array[$val]['buyer_id']];
								}
							}
						}
					}

					$no_bag = "";
					$no_cone = "";
					$wt_bag_cone = "";
					if ($row[csf('cone_per_bag')] == "" || $row[csf('cone_per_bag')] == 0) $no_bag = 'N:' . $no_of_bags_val; else $no_bag = 'N:' . $no_of_bags_val; $no_cone =' N:' . $row[csf('cone_per_bag')];

					if ($row[csf('weight_per_cone')] == "" || $row[csf('weight_per_cone')] == 0) $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')]; else $wt_bag_cone = 'W:' . $row[csf('weight_per_bag')] . ' & ' . $row[csf('weight_per_cone')];

					//for supplier
					if($row[csf('is_within_group')] == 1)
					{
						$supplier_name = $company_library[$row[csf('supplier_id')]];
					}
					else
					{
						$supplier_name = $supplier_arr[$row[csf('supplier_id')]];
					}
					?>
					<tbody>
						<tr bgcolor="<? echo $bgcolor; ?>">
							<td width="20"><? echo $i; ?></td>
							<td width="45">
								<? if ($row[csf('requisition_no')] != 0) echo $row[csf('requisition_no')]; else echo '&nbsp;'; ?>
							<td width="50">
								<?  echo $program_array[$row[csf('requisition_no')]]['program_no']; ?>
							</td>
							<td width="50">
								<? echo $row[csf('lot')]; ?>
							</td>

							<td width="65">
								<? echo $yarn_type[$row[csf('yarn_type')]]; ?>
							</td>
							<td width="160">

									<?
									//echo $proddtls;
									echo $count_arr[$row[csf('yarn_count_id')]]." ".$composition[$row[csf('yarn_comp_type1st')]]." ".$row[csf('yarn_comp_percent1st')]."% ".$yarn_type[$row[csf('yarn_type')]]." ".$color_name_arr[$row[csf('color')]];
									?>
							</td>
						<td width="110">
							<? echo $supplier_name; ?>
						</td>

						<td align="right"
						width="60"><? echo number_format($row[csf('cons_quantity')], 3, '.', ''); ?></td>
						<td align="right"
						width="60"><? echo number_format($row[csf('returnable_qnty')], 2, '.', ''); ?></td>
						<td width="40">
							<? echo $no_bag; ?>
					</td>
					<td width="40">
							<? echo $no_cone."<br>".$wt_bag_cone; ?>

					</td>
					<td width="80">
						<? echo $store_arr[$row[csf('store_id')]]; ?>
					</td>
					<td width="100">
						<? echo $buyer_job; ?>
					</td>
					<td width="120">
						<?
						if($row[csf('issue_basis')] == 1 && $row[csf('issue_purpose')]==8)
						{
							echo $style_ref;
						}
						else
						{
							echo $po_no;
							if ($style_ref != "") echo ' & ' . $style_ref; else echo '&nbsp;';
						}

						?>
					</td>
				</tr>
				<?
				$uom_unit = "Kg";
				$uom_gm = "Grams";
				$tot_return_qty += $row[csf('returnable_qnty')];
				$tot_bag += $no_of_bags_val;
				$tot_cone += $row[csf('cone_per_bag')];
				$tot_w_bag += $row[csf('weight_per_bag')];
				$tot_w_cone += $row[csf('weight_per_cone')];
				$req_no = $row[csf('requisition_no')];
				$i++;
			}
			?>
			<tr bgcolor="#CCCCCC" style="font-size:13px">
				<td align="right" colspan="7"><b>Total</b></td>
				<td align="right">
					<b><? echo $format_total_amount = number_format($order_qnty_val_sum, 3, '.', ''); ?></b>
				</td>
				<td align="right"><b><? echo number_format($tot_return_qty, 2, '.', ''); ?></b></td>
				<td><b><? echo 'N:' . number_format($tot_bag, 2); ?></b></td>
				<td><b><?php
				echo ' N: ' . number_format($tot_cone, 2);
				echo '<br>';
				echo ' W: ' . number_format($tot_w_bag, 2); ?></b></td>
				<td align="right" colspan="5">&nbsp;</td>
			</tr>
			<tr>
				<td colspan="17" align="left"><b>In
					Word: <? echo number_to_words($format_total_amount, $uom_unit, $uom_gm); ?></b></td>
			</tr>
		</tbody>
	</table>
	<p style="font-size:15px;"><b>Note: Received The Above in Goods Condition For Handling and Delivery.</b></p>
	</div>
	<br>
	<br>&nbsp;
	<!--================================================================-->
	<?
	if ($data[6] == 1)
	{
		if ($dataArray[0][csf('issue_basis')] == 3)
		{
			?>
			<div style="">
				<table width="850" border="1" rules="all" cellpadding="0" cellspacing="0" class="rpt_table">
					<thead>
						<tr>
							<th colspan="7" align="center">Requisition Details</th>
						</tr>
						<tr>
							<th width="40">SL</th>
							<th width="100">Requisition No</th>
							<th width="110">Lot No</th>
							<th width="220">Yarn Description</th>
							<th width="110">Brand</th>
							<th width="90">Requisition Qty</th>
							<th>Remarks</th>
						</tr>
					</thead>
					<?
					//echo $all_req_no;
					$i = 1;
					$tot_reqsn_qnty = 0;
					$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
					$product_details_array = array();
					$sql = "select id, supplier_id, lot, current_stock, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color, brand from product_details_master where item_category_id=1 and company_id='$data[0]' and status_active=1 and is_deleted=0";
					$result = sql_select($sql);

					foreach ($result as $row) {
						$compos = '';
						if ($row[csf('yarn_comp_percent2nd')] != 0) {
							$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
						} else {
							$compos = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%" . " " . $composition[$row[csf('yarn_comp_type2nd')]];
						}
						$product_details_array[$row[csf('id')]]['count'] = $count_arr[$row[csf('yarn_count_id')]];
						$product_details_array[$row[csf('id')]]['comp'] = $compos;
						$product_details_array[$row[csf('id')]]['type'] = $yarn_type[$row[csf('yarn_type')]];
						$product_details_array[$row[csf('id')]]['lot'] = $row[csf('lot')];
						$product_details_array[$row[csf('id')]]['brand'] = $brand_arr[$row[csf('brand')]];
					}
					unset($result);
					$sql = "SELECT knit_id, requisition_no, prod_id, sum(yarn_qnty) as yarn_qnty from ppl_yarn_requisition_entry where requisition_no in ($all_req_no) and status_active=1 and is_deleted=0 group by requisition_no, prod_id, knit_id";
					$nameArray = sql_select($sql);
					foreach ($nameArray as $selectResult) {
						?>
						<tr>
							<td width="40" align="center"><? echo $i; ?></td>
							<td width="100" align="center">
								&nbsp;<? echo $selectResult[csf('requisition_no')]; ?></td>
								<td width="110" align="center">
									&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['lot']; ?></td>
									<td width="220">
										&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['count'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['comp'] . " " . $product_details_array[$selectResult[csf('prod_id')]]['type']; ?></td>
										<td width="110" align="center">
											&nbsp;<? echo $product_details_array[$selectResult[csf('prod_id')]]['brand']; ?></td>
											<td width="90"
											align="right"><? echo number_format($selectResult[csf('yarn_qnty')], 2); ?>
										&nbsp;</td>
							<td>&nbsp;<? //echo $selectResult[csf('requisition_no')];
							?></td>
						</tr>
						<?
						$tot_reqsn_qnty += $selectResult[csf('yarn_qnty')];
						$i++;
					}
					?>
					<tfoot>
						<th colspan="5" align="right"><b>Total</b></th>
						<th align="right"><? echo number_format($tot_reqsn_qnty, 2); ?>&nbsp;</th>
						<th>&nbsp;</th>
					</tfoot>
				</table>
				<?
				if ($data[5] != 1) {
					$z = 1;
					$k = 1;
					$colorArray = sql_select("select a.id, a.mst_id, a.knitting_source, a.knitting_party, a.program_date,a. color_range, a.stitch_length, a.machine_dia, a.machine_gg, a.program_qnty, a.remarks, b.knit_id, c.booking_no, c.body_part_id, c.fabric_desc, c.gsm_weight, c.dia,c.buyer_id from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and b.requisition_no in ($all_req_no) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0");

					$booking_al = "";
					foreach ($colorArray as $book)
					{
						if ($booking_al == "") $booking_al = $book[csf('booking_no')]; else $booking_al .= ',' . $book[csf('booking_no')];

						$prog_booking_buyer[$book[csf('booking_no')]] = $book[csf('buyer_id')];
					}
					//unset($colorArray);
					//echo $booking_no;
					$booking_no = "'" . implode(',', array_unique(explode(',', $booking_al))) . "'";
					$booking_count = count(array_unique(explode(',', $booking_no)));
					//$booking_job_arr=array();
					if ($dataArray[0][csf('issue_purpose')] == 2) {
						$booking_job = sql_select("select b.job_no from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and a.ydw_no in ($booking_no) group by b.job_no");
					} else {
						$booking_job = sql_select("select job_no from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no in ($booking_no) group by  job_no");
					}
					//
					$booking_job_no = $booking_job[0][csf('job_no')];
					unset($booking_job);

					if ($db_type == 0) $poNoCond = "group_concat(id)";
					else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
					/*echo '='.$sql_Job.'=';
			if($sql_Job!="")
			{*/
				$sql_returnJob = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");

				$job_po = $sql_returnJob[0][csf('po_break_down_id')];
				unset($sql_returnJob);
				?>

				<table width="710" cellpadding="0" cellspacing="0" border="1" rules="all"
				style="margin-top:20px;" class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="250">Fabrication</th>
					<th width="120">Color</th>
					<th width="120">GGSM OR S/L</th>
					<th>FGSM</th>
				</thead>
				<tbody>
					<tr>
						<td width="40" align="center"><? echo $z; ?></td>
						<td width="250"
						align="center"><? echo $body_part[$colorArray[0][csf('body_part_id')]] . ', ' . $colorArray[0][csf('fabric_desc')]; ?></td>
						<td width="120"
						align="center"><? echo $color_range[$colorArray[0][csf('color_range')]]; ?></td>
						<td width="120" align="center"><? echo $colorArray[0][csf('stitch_length')]; ?></td>
						<td align="center"><? echo $colorArray[0][csf('gsm_weight')]; ?></td>
					</tr>
				</tbody>
			</table>
			<table style="margin-top:20px;" width="650" border="1" rules="all" cellpadding="0"
			cellspacing="0" class="rpt_table">
			<thead>
				<th width="40">SL</th>
				<th width="50">Prog. No</th>
				<th width="110">Finish Dia</th>
				<th width="170">Machine Dia & Gauge</th>
				<th width="110">Program Qty</th>
				<th>Remarks</th>
			</thead>
			<tbody>
				<tr>
					<td width="40" align="center"><? echo $k; ?></td>
					<td width="50" align="center">&nbsp;<? echo $colorArray[0][csf('knit_id')]; ?></td>
					<td width="110" align="center"><? echo $colorArray[0][csf('dia')]; ?></td>
					<td width="170"
					align="center"><? echo $colorArray[0][csf('machine_dia')] . "X" . $colorArray[0][csf('machine_gg')]; ?></td>
					<td width="110"
					align="right"><? echo number_format($colorArray[0][csf('program_qnty')], 2); ?>
				&nbsp;</td>
				<td><? echo $colorArray[0][csf('remarks')]; ?></td>
			</tr>
			<?
			$tot_prog_qty += $colorArray[0][csf('program_qnty')];
			?>
			<tr>
				<td colspan="4" align="right"><strong>Total : </strong></td>
				<td align="right"><? echo number_format($tot_prog_qty, 2); ?></td>
				<td>&nbsp;</td>
			</tr>
		</tbody>
	</table>
	<?
	$returnJob = '';
	$returnPo = '';
	if ($db_type == 0) {
		$booking_cond = "group_concat(a.booking_no)";
		$wo_cond = "group_concat(a.ydw_no)";
		$reqs_no = "group_concat(b.requisition_no)";
	} else if ($db_type == 2) {
		$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
		$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
		$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
	}

	if ($dataArray[0][csf('issue_purpose')] == 8)
	{
		$sql_returnJob = sql_select("select a.id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no in ($booking_no) group by a.id");
	}
	else if ($dataArray[0][csf('issue_purpose')] == 2)
	{
		$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='$booking_job_no' group by b.job_no");

		if ($db_type == 0) $poNoCond = "group_concat(id)";
		else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
		$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='$booking_job_no' group by job_no_mst");
	} else {
		$sql_returnJob = sql_select("select a.job_no, a.booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$booking_job_no' and a.booking_no in($booking_no) group by a.job_no,a.booking_no");
	}

	$returnJob = $sql_returnJob[0][csf('job_no')];
	$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
	$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";
	$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];
	unset($sql_returnJob);
					?>
					<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
					cellspacing="0" class="rpt_table">
					<thead>
						<tr>
							<th colspan="6" align="center">Comments (Booking No:<p> <? echo $returnBooking; ?>) [Booking
							Job Deatils]</p></th>
						</tr>
						<tr>
							<th>Buyer</th>
							<th>Job</th>
							<th>Req. Qty</th>
							<th>Cuml. Issue Qty</th>
							<th>Balance Qty</th>
							<th>Remarks</th>
						</tr>
					</thead>
					<?

					$all_requ_no = "";
					if ($dataArray[0][csf('issue_purpose')] != 8)
					{
						$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 ");

						//$all_requ_no="'".$all_booking_sql[0][csf('requisition_no')]."'";
						$all_requ_no = "'" . implode("','", array_unique(explode(",", $all_booking_sql[0][csf('requisition_no')]))) . "'";
					}
					if ($dataArray[0][csf('issue_purpose')] == 8)
					{
						$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3", "total_issue_qty");    //
						$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and b.item_category=1", "total_issue_qty");
					}
					else if ($dataArray[0][csf('issue_purpose')] == 2)
					{
						if ($all_requ_no != "" || $all_requ_no != 0)
						{
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						}
						else
						{
							$req_cond = "or a.requisition_no in (0)";
							$reqRet_cond = "or b.booking_no in (0)";
						}

						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");

						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and b.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
					}
					else
					{
						if ($all_requ_no != "" || $all_requ_no != 0)
						{
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						}
						else
						{
							$req_cond = "or a.requisition_no in (0)";
							$reqRet_cond = "or b.booking_no in (0)";
						}

						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");

						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");
					}

					$cumulative_qty = 0;

					if ($booking_count == 1)
					{
						?>
						<tbody>
							<tr>
								<td align="center">

									<?

									if($job_array[$booking_job_no]['buyer']!="")
									{
										echo $buyer_arr[$job_array[$booking_job_no]['buyer']];
									}else{
										echo $buyer_arr[$row[csf('buyer_id')]];
									}

									?>
								</td>
								<td align="center">
									<? echo $job_array[$booking_job_no]['job']; ?>
								</td>
								<td align="center">

									<? echo number_format($returnReqQty, 3); ?>
								</td>
								<td align="center">
									<? $cumulative_qty = $total_issue_qty - $total_return_qty;
									echo number_format($cumulative_qty, 3); ?>
								</td>
								<td align="center">
									<? $balance_qty = $returnReqQty - $cumulative_qty;
									echo number_format($balance_qty, 3); ?>
								</td>
								<td align="center">
									<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($returnReqQty < $cumulative_qty) echo "Over"; else echo ""; ?>
								</td>
							</tr>
							</tbody>
						</table>
					<?
				}
			}
		}
		else if ($dataArray[0][csf('issue_basis')] == 1)
		{
			?>
			<table style="margin-top:20px;" width="500" border="1" rules="all" cellpadding="0"
			cellspacing="0" class="rpt_table">
			<thead>
				<tr>
					<th colspan="6" align="center">
						Comments <? if ($dataArray[0][csf('issue_purpose')] != 8) {
							if ($dataArray[0][csf('buyer_job_no')] != '') echo "(Booking Job Details)";
						} ?> </th>
					</tr>
					<tr>
						<th>Buyer</th>
						<th>Job</th>
						<th>Req. Qty</th>
						<th>Cuml. Qty</th>
						<th>Balance Qty</th>
						<th>Remarks</th>
					</tr>
				</thead>
				<?
						//$booking_job_arr=array();
				$returnJob = '';
				$returnPo = '';
				if ($db_type == 0) {
					$booking_cond = "group_concat( distinct a.booking_no)";
					$wo_cond = "group_concat(a.ydw_no)";
					$reqs_no = "group_concat(b.requisition_no)";
				} else if ($db_type == 2) {
					$booking_cond = "listagg(cast(a.booking_no as varchar2(4000)),',') within group (order by a.booking_no)";
					$wo_cond = "listagg(cast(a.ydw_no as varchar2(4000)),',') within group (order by a.ydw_no)";
					$reqs_no = "listagg(cast(b.requisition_no as varchar2(4000)),',') within group (order by b.requisition_no)";
				}

				if ($dataArray[0][csf('issue_purpose')] == 8) {
					$sql_returnJob = sql_select("select a.id, a.buyer_id, sum(b.grey_fabric) as fabric_qty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id, a.buyer_id");
				} else if ($dataArray[0][csf('issue_purpose')] == 2) {
					if ($dataArray[0][csf('buyer_job_no')] != '') {
						$sql_returnJob = sql_select("select b.job_no, $wo_cond as booking_no, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by b.job_no");

						if ($db_type == 0) $poNoCond = "group_concat(id)";
						else if ($db_type == 2) $poNoCond = "listagg(cast(id as varchar2(4000)),',') within group (order by id)";
						$sql_po = sql_select("select job_no_mst as job_no, $poNoCond as po_break_down_id from wo_po_break_down where job_no_mst='" . $dataArray[0][csf('buyer_job_no')] . "' group by job_no_mst");
					} else {
						$sql_returnJob = sql_select("select a.id, sum(b.yarn_wo_qty) as fabric_qty from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.item_category_id=24 and a.entry_form in(42,114) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ydw_no='" . $dataArray[0][csf('booking_no')] . "' group by a.id");
					}
				} else {
							//echo "select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='".$dataArray[0][csf('buyer_job_no')]."' group by a.job_no";
							$sql_returnJob = sql_select("select a.job_no, $booking_cond as booking_no, sum(b.grey_fab_qnty) as fabric_qty from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='" . $dataArray[0][csf('buyer_job_no')] . "' group by a.job_no");//and a.booking_no='".$dataArray[0][csf('booking_no')]."'
						}
						$returnJob = $sql_returnJob[0][csf('job_no')];
						$returnPo = $sql_po[0][csf('po_break_down_id')];
						$returnPoId = $sql_returnJob[0][csf('po_break_down_id')];
						$returnBooking = "'" . implode("','", array_unique(explode(",", $sql_returnJob[0][csf('booking_no')]))) . "'";

						$returnReqQty = $sql_returnJob[0][csf('fabric_qty')];

						unset($sql_returnJob);

						$all_requ_no = "";
						if ($dataArray[0][csf('issue_purpose')] != 8) {
							//echo "select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no";
							$all_booking_sql = sql_select("select $reqs_no as requisition_no from ppl_planning_info_entry_dtls a, ppl_yarn_requisition_entry b, ppl_planning_info_entry_mst c where a.mst_id= c.id and a.id=b.knit_id and c.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and b.is_deleted=0 group by c.booking_no");

							$all_requ_no = $all_booking_sql[0][csf('requisition_no')];
							unset($all_booking_sql);
						}

						if ($dataArray[0][csf('issue_purpose')] == 8) {
							$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3", "total_issue_qty");    //
							$total_return_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", " inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1", "total_issue_qty");
						} else if ($dataArray[0][csf('issue_purpose')] == 2) {
							/*if($all_requ_no!="" || $all_requ_no!=0)
					{
						//$req_cond="or a.requisition_no in ($all_requ_no)";
						//$reqRet_cond="or b.booking_no in ($all_requ_no)";
					}
					else
					{
						//$req_cond="or a.requisition_no in (0)";
						$reqRet_cond="or b.booking_no in (0)";
					}*/
					if ($dataArray[0][csf('buyer_job_no')] != "") {
						$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and b.booking_no in ($returnBooking) and b.buyer_job_no='" . $dataArray[0][csf('buyer_job_no')] . "'  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
						$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and b.booking_no in ($returnBooking) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
					} else {
								//echo "select sum(a.cons_quantity) as total_issue_qty from inv_transaction a, inv_issue_master b where b.id=a.mst_id and b.booking_no='".$dataArray[0][csf('booking_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.buyer_job_no<>'' and b.issue_purpose=2";
						$total_issue_qty = return_field_value("sum(a.cons_quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and b.issue_purpose=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2";
						$total_return_qty = return_field_value("sum(a.cons_quantity) as total_return_qty", "inv_transaction a, inv_receive_master b", "b.id=a.mst_id and b.booking_no='" . $dataArray[0][csf('booking_no')] . "' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose=2", "total_return_qty");
					}
				} else {
					if ($dataArray[0][csf('buyer_job_no')] != "") {
						if ($all_requ_no != "" || $all_requ_no != 0) {
							$req_cond = "or a.requisition_no in ($all_requ_no)";
							$reqRet_cond = "or b.booking_no in ($all_requ_no)";
						} else {
									$req_cond = "";//or a.requisition_no in (0)
									$reqRet_cond = "";//or b.booking_no in (0)
								}
								$total_issue_qty = 0;
								//echo "select sum(c.quantity) as total_issue_qty from inv_transaction a, inv_issue_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id and (b.booking_no in ($returnBooking) $req_cond)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and b.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2";
								$total_issue_qty = return_field_value("sum(c.quantity) as total_issue_qty", "inv_transaction a, inv_issue_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id and ( b.booking_no in ($returnBooking) $req_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=2 and a.item_category=1 and b.entry_form=3 and c.entry_form=3 and b.issue_purpose!=2", "total_issue_qty");
								//echo "SELECT sum(c.quantity) as total_return_qty from inv_transaction a, inv_receive_master b, order_wise_pro_details c where b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and b.buyer_job_no='".$dataArray[0][csf('buyer_job_no')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2";
								$total_return_qty = return_field_value("sum(c.quantity) as total_return_qty", "inv_transaction a, inv_receive_master b, order_wise_pro_details c", "b.id=a.mst_id and a.id=c.trans_id  and (b.booking_no in ($returnBooking) $reqRet_cond) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.transaction_type=4 and a.item_category=1 and b.entry_form=9 and c.entry_form=9 and c.issue_purpose!=2", "total_return_qty");

								//$total_issue_qty=return_field_value("sum(quantity) as total_issue_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=2 and entry_form=3","total_issue_qty");
								//$total_return_qty=return_field_value("sum(quantity) as total_return_qty","order_wise_pro_details","po_breakdown_id in ($returnPo) and status_active=1 and is_deleted=0 and trans_type=4 and entry_form=8","total_return_qty");
							}
						}
						?>
						<tbody>
							<tr>
								<td align="center">
									<?
									if ($dataArray[0][csf('issue_purpose')] == 8)
									{
										echo $buyer_arr[$sql_returnJob[0][csf('buyer_id')]];
									}
									else
									{
										if($job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']!="")
										{
											echo $buyer_arr[$job_array[$dataArray[0][csf('buyer_job_no')]]['buyer']];
										}
										else
										{
											echo $buyer_arr[$dataArray[0][csf('buyer_id')]];
										}
									}
									?>
								</td>
								<td align="center">
									<? echo $job_array[$dataArray[0][csf('buyer_job_no')]]['job']; ?>&nbsp;
								</td>
								<td align="center">
									<? echo number_format($returnReqQty, 3); ?>
								</td>
								<td align="center">

									<? $cumulative_qty = 0;
									$cumulative_qty = $total_issue_qty - $total_return_qty;
									echo number_format($cumulative_qty, 3); ?>
								</td>
								<td align="center">
									<? $balance_qty = $returnReqQty - $cumulative_qty;
									echo number_format($balance_qty, 3); ?>
								</td>
								<td align="center">
									<? if ($returnReqQty > $cumulative_qty) echo "Less"; else if ($result[0][csf('fabric_qty')] < $cumulative_qty) echo "Over"; else echo ""; ?>
								</td>
							</tr>
						</tbody>
					</table>
					<?
				}
			}
			?>
			<br>
			<?
				$user_lib_name=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");
				echo signature_table(49,$data[0],"1030px",$template_id,10,$user_lib_name[$inserted_by]);
			?>
		</div>
	</div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		function generateBarcode(valuess) {
				var value = valuess;//$("#barcodeValue").val();
				var btype = 'code39';//$("input[name=btype]:checked").val();
				var renderer = 'bmp';// $("input[name=renderer]:checked").val();
				var settings = {
					output: renderer,
					bgColor: '#FFFFFF',
					color: '#000000',
					barWidth: 1,
					barHeight: 30,
					moduleSize: 5,
					posX: 10,
					posY: 20,
					addQuietZone: 1
				};
				$("#barcode_img_id").html('11');
				value = {code: value, rect: false};
				$("#barcode_img_id").show().barcode(value, btype, settings);
			}
			generateBarcode('<? echo $data[1]; ?>');
		</script>
		<?
		exit();
}

if($action=="find_requisition_data")
{
	$dataArr = explode("**",$data);
	$requisition_no = $dataArr[0];
	$company_id = $dataArr[1];
	$buery_id = $dataArr[2];

	$cond = "";
	if ($buery_id != "" && $buery_id != 0) $cond .= " and a.buyer_id=$buery_id";
	if ($requisition_no != "" && $requisition_no != 0) $cond .= " and c.requisition_no=$requisition_no";
	if ($company_id != "" && $company_id != 0) $cond .= " and a.company_id=$company_id";

    $sql = sql_select("SELECT a.buyer_id, c.knit_id as knit_id,b.knitting_source,b.knitting_party,b.location_id from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_yarn_requisition_entry c
		where a.id=b.mst_id and b.id=c.knit_id and c.status_active=1 and c.is_deleted=0 $cond
		group by a.company_id, a.buyer_id,c.knit_id,b.knitting_source,b.knitting_party,b.location_id");

	$return_data="";
    if(count($sql)>0)
	{
		$return_data=$sql[0][csf('buyer_id')]."**".$sql[0][csf('knit_id')]."**".$sql[0][csf('knitting_source')]."**".$sql[0][csf('knitting_party')]."**".$sql[0][csf('location_id')];
	}

	echo $return_data;

	die;
}

if ($action =="find_smnbooking_required_qnty_ajax_responds")
{
	list($smn_booking_no,$yarn_count,$yarn_composition,$issue_trans_id)=explode('**',$data);

	if($smn_booking_no != '')
	{
		$yarn_dtls_result = sql_select("SELECT sum(cons_qnty) as REQUIRED_QNTY FROM sample_development_yarn_dtls WHERE is_deleted = 0 AND status_active = 1 AND booking_no = '".$smn_booking_no."' AND count_id=$yarn_count AND copm_one_id=$yarn_composition");
		$required_qnty = ($yarn_dtls_result[0]['REQUIRED_QNTY']>0)?$yarn_dtls_result[0]['REQUIRED_QNTY']:0;

		$issue_trans_id_cond = ($issue_trans_id!="")? " and b.id != $issue_trans_id ": "";

		$issue_result = sql_select("select sum(b.cons_quantity) as ISSUE_QNTY from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and b.prod_id=c.id and a.booking_no='".$smn_booking_no."' and b.item_category=1 and b.transaction_type=2 and c.yarn_count_id=$yarn_count and c.yarn_comp_type1st=$yarn_composition  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $issue_trans_id_cond");

		$issue_qnty = ($issue_result[0]['ISSUE_QNTY']>0)?$issue_result[0]['ISSUE_QNTY']:0;

		$issue_return_result = sql_select("select sum(b.cons_quantity) as ISSUE_RETURN_QNTY from inv_receive_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and b.prod_id=c.id and a.booking_no='".$smn_booking_no."' and b.item_category=1 and b.transaction_type=4 and c.yarn_count_id=$yarn_count and c.yarn_comp_type1st=$yarn_composition  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

		$issue_return_qnty = ($issue_return_result[0]['ISSUE_RETURN_QNTY']>0)?$issue_return_result[0]['ISSUE_RETURN_QNTY']:0;

	}

	echo $responds_string = $required_qnty."***".$issue_qnty."***".$issue_return_qnty;
	exit();
}
?>