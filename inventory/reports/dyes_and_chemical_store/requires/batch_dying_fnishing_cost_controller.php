<?
header('Content-type:text/html; charset=utf-8');
session_start();
include('../../../../includes/common.php');

$user_id = $_SESSION['logic_erp']["user_id"];
if( $_SESSION['logic_erp']['user_id'] == "" ) { header("location:login.php"); die; }
$permission=$_SESSION['page_permission'];
$data=$_REQUEST['data'];
$action=$_REQUEST['action'];

if ($action=="load_drop_down_buyer")
{
	echo create_drop_down( "cbo_buyer_name", 100, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$data' and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90))  $buyer_cond order by buyer_name","id,buyer_name", 1, "- All Buyer -", $selected, "load_drop_down( 'requires/batch_dying_fnishing_cost_controller', this.value, 'load_drop_down_season', 'season_td');" );     	 
	exit();
}
if ($action=="load_drop_down_location")
{
	
	echo create_drop_down( "location_id", 100, "select id,location_name from lib_location where company_id='$data' and status_active =1 and is_deleted=0 order by location_name","id,location_name", 1, "-- Select Location --", $selected, "load_drop_down( 'requires/batch_dying_fnishing_cost_controller', this.value+'_'+document.getElementById('cbo_working_name').value, 'load_drop_down_floor', 'floor_td' )" );		
	exit(); 
}
if($action=="load_drop_down_floor")
{
	$data=explode("_", $data);
	$company_id=$data[1];
	$location_id=$data[0];
	$sql="select id,floor_name from lib_prod_floor where company_id=$company_id and location_id=$location_id and status_active =1  and is_deleted=0 and production_process=3 order by floor_name";
	echo create_drop_down("floor_id", 100, $sql,"id,floor_name", 1, "-- Select Location --", $selected, "" );		
	exit(); 
}
if ($action=="load_drop_down_season")
{
	echo create_drop_down( "cbo_season_id", 80, "select id, season_name from lib_buyer_season where buyer_id='$data' and status_active =1 and is_deleted=0 order by season_name ASC","id,season_name", 1, "-- Select Season--", "", "" );
	exit();
}

if($action=="company_wise_report_button_setting")
{
	extract($_REQUEST);
	$print_report_format=return_field_value("format_id"," lib_report_template","template_name ='".$data."'  and module_id=6 and report_id=162 and is_deleted=0 and status_active=1");
	//echo $print_report_format;
	$print_report_format_arr=explode(",",$print_report_format);

	echo "$('#show').hide();\n";
	echo "$('#show2').hide();\n";
	echo "$('#report').hide();\n";
	echo "$('#batch-wise').hide();\n";
	echo "$('#batch-wise2').hide();\n";
	echo "$('#batch-wise3').hide();\n";
	echo "$('#batch-wise4').hide();\n";
	echo "$('#excel_show').hide();\n";

	if($print_report_format != "")
	{
		foreach($print_report_format_arr as $id)
		{
			if($id==108){echo "$('#show').show();\n";}
			if($id==195){echo "$('#show2').show();\n";}
			if($id==107){echo "$('#report').show();\n";}
			if($id==710){echo "$('#batch-wise').show();\n";}
			if($id==750){echo "$('#batch-wise2').show();\n";}
			if($id==855){echo "$('#batch-wise3').show();\n";}
			if($id==854){echo "$('#batch-wise4').show();\n";}
			if($id==293){echo "$('#excel_show').show();\n";}
		}
	}

	exit();
}

if ($action=="batch_popup")
{
	echo load_html_head_contents("Popup Info","../../../../", 1, 1, $unicode);
	extract($_REQUEST);
	$data=explode('_',$data);
	//print_r ($data);  
	?>	
    <script>
		
		var selected_id = new Array;
		var selected_name = new Array;
		
    	function check_all_data() {
			var tbl_row_count = document.getElementById( 'tbl_list_search' ).rows.length;
			tbl_row_count = tbl_row_count - 0;
			for( var i = 1; i <= tbl_row_count; i++ ) {
				var onclickString = $('#tr_' + i).attr('onclick');
				var paramArr = onclickString.split("'");
				var functionParam = paramArr[1];
				js_set_value( functionParam );
			}
		}
		
		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) { 
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}
		
		function js_set_value( strCon ) 
		{
			//alert(strCon); //return;

				var splitSTR = strCon.split("_");
				var str = splitSTR[0];
				var selectID = splitSTR[1];
				var selectDESC = splitSTR[2];
				//$('#txt_individual_id' + str).val(splitSTR[1]);
				//$('#txt_individual' + str).val('"'+splitSTR[2]+'"');
				
				toggle( document.getElementById( 'tr_' + str ), '#FFFFCC' );
				
				if( jQuery.inArray( selectID, selected_id ) == -1 ) {
					selected_id.push( selectID );
					selected_name.push( selectDESC );					
				}
				else {
					for( var i = 0; i < selected_id.length; i++ ) {
						if( selected_id[i] == selectID ) break;
					}
					selected_id.splice( i, 1 );
					selected_name.splice( i, 1 ); 
				}
				var id = ''; var name = ''; var job = '';
				for( var i = 0; i < selected_id.length; i++ ) {
					id += selected_id[i] + ',';
					name += selected_name[i] + ','; 
				}
				id 		= id.substr( 0, id.length - 1 );
				name 	= name.substr( 0, name.length - 1 ); 
				//alert(id+'_'+name);
				$('#txt_selected_id').val( id );
				$('#txt_selected').val( name ); 
		
	} 
	</script>

	</head>

	<body>
	<div align="center">
		<fieldset style="width:870px;margin-left:4px;">
	        <form name="searchorderfrm_1"  id="searchorderfrm_1" autocomplete="off">
	            <table cellpadding="0" cellspacing="0" width="850" class="rpt_table">
	                <thead>
	                    <th>Batch Type</th>
	                    <th>Buyer</th>
	                    <th>Search By</th>
	                    <th>Search</th>
	                    <th>Booking Date</th>
	                    <th>
	                        <input type="reset" name="reset" id="reset" value="Reset" style="width:100px" class="formbutton" />
	                        <input type="hidden" name="hidden_batch_id" id="hidden_batch_id" value="">
	                    </th> 
	                </thead>
	                <tr class="general">
	                <td align="center">	
								<?
	                                echo create_drop_down( "cbo_batch_type", 150, $order_source,"",1, "--Select--",$data[1],"",1 );
	                            ?>
	                            </td>
	                            <td id="buyer_td">
	                            <? 
	                                //echo create_drop_down( "cbo_buyer_name", 100, $blank_array,"", 1, "- All Buyer -", $selected, "",0,"" );
									if($data[0]) $comp_con="and b.tag_company='$data[0]'";else  $comp_con="";
									echo create_drop_down( "cbo_buyer_name", 100, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id  and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90))  $comp_con $buyer_cond order by buyer_name","id,buyer_name", 1, "- All Buyer -", $selected, "" );  
	                            ?>
	                       		</td>
	                            
	                   		 <td align="center">	
	                        <?
	                            if($data[2]==2)
								{
									$show_con="2";
								}
								else
								{
									$show_con="1,2";
								}
								//echo $show_con;
								$search_by_arr=array(1=>"Batch No",2=>"Booking No");
	                            echo create_drop_down( "cbo_search_by", 150, $search_by_arr,"",0, "--Select--", $show_con,$dd,0);
	                        ?>
	                    </td>                 
	                    <td align="center">				
	                        <input type="text" style="width:110px" class="text_boxes"  name="txt_search_common" id="txt_search_common" />	
	                    </td> 	
	                    <td align="center">	
							<input type="text" style="width:50px" class="datepicker" name="txt_date_from" id="txt_date_from" /> To
							<input type="text" style="width:50px" class="datepicker" name="txt_date_to" id="txt_date_to" />
						</td>     
						
	                    <td align="center">
	                        <input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('txt_search_common').value+'_'+document.getElementById('cbo_search_by').value+'_'+<? echo $data[0]; ?>+'_'+<? echo $data[1]; ?>+'_'+<? echo $data[2]; ?>+'_'+document.getElementById('cbo_year_selection').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value, 'create_batch_search_list_view', 'search_div', 'batch_dying_fnishing_cost_controller', 'setFilterGrid(\'tbl_list_search\',-1);')" style="width:100px;" />
	                    </td>
	                </tr>
	                <tr>
	 					<td colspan="6" align="center" width="95%"><? echo load_month_buttons(1); ?></td>              
					</tr>
	            </table>
	            <div id="search_div" style="margin-top:10px"></div>   
	        </form>
	    </fieldset>
	   
	</div>    
	</body>           
	<script src="../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
}

if($action=="create_batch_search_list_view")
{
	$data=explode('_',$data);
	
	$search_string="%".trim($data[0])."%";
	$search_by =$data[1];
	$company_id =$data[2];
	$batch_type=$data[3];
	$booking_batch_type=$data[4];
	$year_id=$data[5];
	$fromDate=$data[6];
	$toDate=$data[7];
	//	echo $year_id.'DX';
	if($batch_type==0)
		$search_field_cond_batch=" and b.entry_form in (0,36)";
	else if($batch_type==1)
		$search_field_cond_batch=" and b.entry_form=0";
	else if($batch_type==2)
		$search_field_cond_batch=" and b.entry_form=36";
	else if($batch_type==3)
		$search_field_cond_batch=" and b.batch_against=2";
	if($search_by==1)
		$search_field='b.batch_no';
	else
		$search_field='b.booking_no';
		
	if($db_type==0)
	{
	if($year_id!=0) $year_cond=" and year(a.insert_date)=$year_id"; else $year_cond="";	
	}
	else if($db_type==2)
	{
	$year_field_con=" and to_char(a.insert_date,'YYYY')";
	if($year_id!=0) $year_cond="$year_field_con=$year_id"; else $year_cond="";	
	}
		
	if($booking_batch_type==2)
	{
		$book_batch_cond="booking_no";	
	}
	else
	{
		$book_batch_cond="batch_no";		
	}
	
	if($db_type==0)
	{
		if ($fromDate!="" &&  $toDate!="") $batch_date  = "and b.batch_date  between '".change_date_format($fromDate, "yyyy-mm-dd", "-")."' and '".change_date_format($toDate, "yyyy-mm-dd", "-")."'"; else $batch_date ="";
	}
	if($db_type==2)
	{
		if ($fromDate!="" &&  $toDate!="") $batch_date  = "and b.batch_date  between '".change_date_format($fromDate, "yyyy-mm-dd", "-",1)."' and '".change_date_format($toDate, "yyyy-mm-dd", "-",1)."'"; else $batch_date ="";
	}
	
	$color_arr=return_library_array( "select id,color_name  from  lib_color", "id", "color_name"  );	
	$supplier_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');
	$arr=array(5=>$batch_against,6=>$batch_for,8=>$color_arr);
	// $sql = "select id, batch_no, extention_no, batch_weight, total_trims_weight, batch_date, batch_against, batch_for, booking_no, color_id from pro_batch_create_mst where company_id=$company_id and $search_field like '$search_string' and status_active=1 and is_deleted=0 and batch_against<>0 $search_field_cond_batch $year_cond $batch_date"; 
	if($batch_type==2)
	{
		$year_field_con=" and to_char(b.insert_date,'YYYY')";
		if($year_id!=0) $year_cond="$year_field_con=$year_id"; else $year_cond="";
		 $sql= "(select b.id as id, b.batch_no, b.extention_no, b.batch_weight, b.total_trims_weight, b.batch_date, b.batch_against, b.batch_for, b.booking_no, b.color_id from pro_batch_create_mst b left join wo_booking_mst a   on  a.booking_no=b.booking_no and a.status_active=1  where   b.is_deleted=0 and b.batch_against<>0 and b.status_active=1 and b.company_id=$company_id and $search_field like '$search_string'   $search_field_cond_batch $year_cond $batch_date 
		union all
	 select b.id as id, b.batch_no, b.extention_no, b.batch_weight, b.total_trims_weight, b.batch_date, b.batch_against, b.batch_for, b.booking_no, b.color_id from wo_non_ord_samp_booking_mst a ,pro_batch_create_mst b where  a.booking_no=b.booking_no and b.company_id=$company_id and $search_field like '$search_string' and b.status_active=1 and b.is_deleted=0 and b.batch_against<>0 $search_field_cond_batch $year_cond $batch_date) order by id Desc
	";
	}
	else
	{
		$sql= "(select b.id as id, b.batch_no, b.extention_no, b.batch_weight, b.total_trims_weight, b.batch_date, b.batch_against, b.batch_for, b.booking_no, b.color_id from wo_booking_mst a,pro_batch_create_mst b where  a.booking_no=b.booking_no and b.company_id=$company_id and $search_field like '$search_string' and b.status_active=1 and b.is_deleted=0 and b.batch_against<>0 $search_field_cond_batch $year_cond $batch_date 
		union all
	 select b.id as id, b.batch_no, b.extention_no, b.batch_weight, b.total_trims_weight, b.batch_date, b.batch_against, b.batch_for, b.booking_no, b.color_id from wo_non_ord_samp_booking_mst a ,pro_batch_create_mst b where  a.booking_no=b.booking_no and b.company_id=$company_id and $search_field like '$search_string' and b.status_active=1 and b.is_deleted=0 and b.batch_against<>0 $search_field_cond_batch $year_cond $batch_date) order by id Desc
	";
	}
	
		 
	echo  create_list_view("tbl_list_search", "Batch No,Ext. No,Batch Weight,Total Trims Weight, Batch Date,Batch Against,Batch For, Booking No, Color", "100,70,80,80,80,80,85,105,80","860","250",0, $sql, "js_set_value", "id,$book_batch_cond", "", 1, "0,0,0,0,0,batch_against,batch_for,0,color_id", $arr, "batch_no,extention_no,batch_weight,total_trims_weight,batch_date,batch_against,batch_for,booking_no,color_id", "","setFilterGrid('tbl_list_search',-1)",'0,0,2,2,3,0,0,0,0',"",1);
    echo "<input type='hidden' id='txt_selected_id' />";
	echo "<input type='hidden' id='txt_selected' />";
	exit();	
}

if($action=="generate_report_backup") // Show
{ 
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if ($cbo_company_name==0) $company_id=""; else $company_id=" and a.company_id='$cbo_company_name'";
	if ($cbo_company_name==0) $company_idcond =""; else $company_idcond =" and b.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond .=""; else $company_idcond .=" and b.working_company_id='$cbo_working_name'";

	if ($cbo_company_name==0) $company_idcnd .=""; else $company_idcnd .=" and a.COMPANY_ID='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcnd .=""; else $company_idcnd .=" and a.SERVICE_COMPANY='$cbo_working_name'";

	// echo $company_idcnd;

	$from_date=str_replace("'","",$from_date);
	$to_date=str_replace("'","",$to_date);
	//echo $from_date;
	$txt_ref_no=str_replace("'","",$txt_ref_no);
	$txt_file_no=str_replace("'","",$txt_file_no);
	$txt_booking_no=str_replace("'","",$txt_booking_no);
	$txt_po_no=str_replace("'","",$txt_po_no);
	$txt_job=str_replace("'","",$txt_job);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$cbo_season_id=str_replace("'","",$cbo_season_id);
	$txt_samp_ref_no=str_replace("'","",$txt_samp_ref_no);
	$location_id=str_replace("'","",$location_id);
	$floor_id=str_replace("'","",$floor_id);
	$report_type=str_replace("'","",$report_type);
	$batch_type=str_replace("'","",$batch_type);

	// echo $batch_type

	$floor_cond_arr=array();

	if(!empty($location_id))
	{
		if(!empty($floor_id))
		{
			
			
			$sql="select  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 and b.company_id=$cbo_working_name and b.location_id=$location_id and b.production_process=3 and b.id=$floor_id";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) {
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}else{
			$sql="select  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 and b.company_id=$cbo_working_name and b.location_id=$location_id and b.production_process=3";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) {
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		$floor_cond_arr=array_unique($floor_cond_arr);
	}
	//print_r($floor_cond_arr);
	
	if(str_replace("'","",$cbo_buyer_name)==0)
	{
		if ($_SESSION['logic_erp']["data_level_secured"]==1)
		{
			if($_SESSION['logic_erp']["buyer_id"]!="") $buyer_id_cond=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")"; else $buyer_id_cond="";
		}
		else
		{
			$buyer_id_cond="";
		}
	}
	else
	{
		$buyer_id_cond=" and a.buyer_name in (".str_replace("'","",$cbo_buyer_name).")";
	}
	
	if($txt_booking_no!='') $booking_no_cond="and b.booking_no like '%$txt_booking_no%' ";else $booking_no_cond="";
	
	if($txt_file_no!='') $file_cond="and b.file_no='$txt_file_no'";else $file_cond="";
	if($txt_job!='') $job_cond="and a.job_no_prefix_num=$txt_job";else $job_cond="";
	if($txt_po_no!='') $po_cond="and b.po_number='$txt_po_no'";else $po_cond="";
	
	if($cbo_season_id!=0) $season_cond="and a.season_buyer_wise in($cbo_season_id)";else $season_cond="";
	
	if($txt_ref_no!='') $ref_cond="and b.grouping='$txt_ref_no'";else $ref_cond="";
	if($txt_samp_ref_no!='') $samp_ref_cond="and a.grouping='$txt_samp_ref_no'";else $samp_ref_cond="";
	//echo $ref_cond;
	$companyArr = return_library_array("select id,company_name from lib_company where status_active=1 and is_deleted=0","id","company_name"); 
	$supplierArr = return_library_array("select id,supplier_name from lib_supplier where status_active=1 and is_deleted=0","id","supplier_name"); 
	$color_arr=return_library_array( "select id,color_name  from  lib_color", "id", "color_name"  );
	$season_name_arr=return_library_array( "select id,season_name  from  lib_buyer_season", "id", "season_name"  );// id, season_name from lib_buyer_season
	//$batch_arr=return_library_array( "select id, batch_no from  pro_batch_create_mst", "id", "batch_no");
   // $po_number_arr=return_library_array(" select  id ,po_number from   wo_po_break_down", "id", "po_number" );
	//$job_no_arr=return_library_array(" select  id ,job_no_mst from   wo_po_break_down", "id", "job_no_mst" );
	//$po_break_down_id_arr=return_library_array( "select booking_no,po_break_down_id from  wo_booking_mst ", "booking_no", "po_break_down_id" );
 //   $floor_arr=return_library_array("select  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0", "batch_id", "floor_name" );


    //$unload_result_arr=return_library_array("select a.batch_id, a.result from  pro_fab_subprocess a where a.entry_form=35 and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0", "batch_id", "result" );

	//$machine_name_arr=return_library_array("select  a.batch_id ,b.machine_no from   pro_fab_subprocess a, lib_machine_name b  where a.machine_id=b.id and a.entry_form in(38,35) and  b.status_active=1 and b.is_deleted=0", "batch_id", "machine_no" );

	//$buyer_name_arr=return_library_array( "select a.booking_no,b.buyer_name from  wo_booking_mst a, lib_buyer b where a.buyer_id=b.id", "booking_no", "buyer_name" );
	//$non_buyer_name_arr=return_library_array( "select a.booking_no,b.buyer_name from  wo_non_ord_samp_booking_mst a, lib_buyer b where a.buyer_id=b.id", "booking_no", "buyer_name" );
	/*$sql_book=sql_select("select a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b where a.buyer_id=b.id");
	foreach($sql_book as $row)
	{
		$buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$po_break_down_id_arr[$row[csf('booking_no')]]=$row[csf('po_break_down_id')];
	}*/
	
    $buyer_library=return_library_array( "select id,buyer_name from   lib_buyer", "id","buyer_name" );
   // $style_library=return_library_array( "select job_no,style_ref_no from   wo_po_details_master", "job_no","style_ref_no" );
	/*$po_data_subcon=sql_select("select a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0  ");
	
	$sub_con_arr=array();
	foreach($po_data_subcon as $row)
	{
		if($sub_con_arr[$row[csf('mst_id')]][cust_style_ref]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref].=",".$row[csf('cust_style_ref')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref]=$row[csf('cust_style_ref')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][order_no]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no].=",".$row[csf('order_no')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no]=$row[csf('order_no')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][subcon_job]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job].=",".$row[csf('subcon_job')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job]=$row[csf('subcon_job')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][party_id]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id].=",".$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id].=",".$row[csf('party_id')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id]=$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id]=$row[csf('party_id')];	
		}
	}*/
	//print_r($sub_con_arr[646]);die;
	
	if($db_type==0) 
	{
	$from_date=change_date_format($from_date,'yyyy-mm-dd'); $to_date=change_date_format($to_date,'yyyy-mm-dd');
	}
    if($db_type==2) 
	{
	$from_date=change_date_format($from_date,'','',1);  $to_date=change_date_format($to_date,'','',1);
	}
	//echo $from_date;
	
	
	$batch_description_arr=array();
	/* 
	if(str_replace("'","",$batch_id)!="") $batch_cond=" and b.id in(".str_replace("'","",$batch_id).")";
    else  */
	
	
	//echo $batch_cond; //die;
	//echo $batch_no; //die;
    	//echo $batch_no;
	$batch_no=implode("','",array_unique(explode(",",$batch_no)));
	
	if(str_replace("'","",$batch_no)!="") $batch_cond=" and b.batch_no in('".$batch_no."') "; 
	else $batch_cond="";
	//echo $batch_cond."shakil"; die;
	
	//
	/* and b.re_dyeing_from=0 13-11-16 according to siddique sir dicission when search buyer order or subcontract all batch appear */
	if($batch_type==0)
	$search_field_cond_batch="and b.entry_form in (0,36) and b.re_dyeing_from=0";
	else if($batch_type==1)
	$search_field_cond_batch="and b.entry_form=0 ";
	else if($batch_type==2)
	$search_field_cond_batch="and b.entry_form=36";
	else 
	$search_field_cond_batch="and b.entry_form in(0,36) and b.batch_against in(2) and  b.re_dyeing_from!=0 ";
	//$redyeing="and b.batch_against in(2)";
	//echo  $search_field_cond_batch;die;
	if($from_date!="" && $to_date!="")
	{
		$date_cond_samp="";$date_cond_po="";
		if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond_samp=" and b.batch_date between '".$from_date."' and '".$to_date."'";
			$date_cond_po=" and d.batch_date between '".$from_date."' and '".$to_date."'";
		}
	}
	
	 $sql_po=("select a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b,pro_batch_create_dtls c,pro_batch_create_mst d  where a.id=b.job_id and b.id=c.po_id and d.id=c.mst_id and   b.status_active=1 and b.is_deleted=0 and  c.status_active=1 and c.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond $date_cond_po");
	 
	$res_po=sql_select($sql_po);
	$all_po_id='';
	foreach($res_po as $row) //$job_no_arr
	{
		$po_number_arr[$row[csf('id')]]['po_no']=$row[csf('po_number')];
		$po_number_arr[$row[csf('id')]]['ref_no']=$row[csf('ref_no')];
		$po_number_arr[$row[csf('id')]]['file_no']=$row[csf('file_no')]; 
		$po_number_arr[$row[csf('id')]]['season']=$row[csf('season_buyer_wise')]; 
		$po_number_arr[$row[csf('id')]]['job']=$row[csf('job_no_mst')];
		$job_no_arr[$row[csf('id')]]=$row[csf('job_no_mst')];
		$style_library[$row[csf('job_no_mst')]]=$row[csf('style_ref_no')];
		if($all_po_id=="") $all_po_id=$row[csf('id')]; else $all_po_id.=",".$row[csf('id')]; //echo $all_po_id;

		$po_idArr[$row[csf('id')]]=$row[csf('id')];
	}
	$con = connect();
	execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id." and ref_from in (1,2,3) and ENTRY_FORM=48");
	oci_commit($con);
	disconnect($con);
	//echo $all_po_id;
	if($txt_file_no!='' || $txt_ref_no!='' ||  $txt_po_no!='' || $txt_job!='' || $cbo_buyer_name>0)
	{
		if($all_po_id!="") $po_idd="and po_id in($all_po_id)";else $po_idd="and po_id in(0)";
		//echo $po_idd;
		//echo "select LISTAGG(CAST( mst_id  AS VARCHAR(4000)), ',') WITHIN GROUP (ORDER BY mst_id) as batch_id from pro_batch_create_dtls where status_active=1 and is_deleted=0 $po_idd";
		/*if($db_type==0) $group_con="group_concat(mst_id) as batch_id";
		else  $group_con="LISTAGG(CAST( mst_id  AS VARCHAR(4000)), ',') WITHIN GROUP (ORDER BY mst_id) as batch_id";
		$batch_ids=return_field_value("$group_con","pro_batch_create_dtls","status_active=1 and is_deleted=0 $po_idd","batch_id");
		if($batch_ids!="") $batch_id_cond="and b.id in($batch_ids)"; else $batch_id_cond="";	*/	
		$poIds=chop($all_po_id,','); $po_cond_for_in="";
		$po_ids=count(array_unique(explode(",",$all_po_id)));
		if($db_type==2 && $po_ids>1000)
		{
			$po_cond_for_in=" and (";
			$poIdsArr=array_chunk(explode(",",$poIds),999);
			foreach($poIdsArr as $ids)
			{
				$ids=implode(",",$ids);
				$po_cond_for_in.=" po_id in($ids) or"; 
			}
			$po_cond_for_in=chop($po_cond_for_in,'or ');
			$po_cond_for_in.=")";
		}
		else
		{
			$po_cond_for_in=" and po_id in($poIds)";
			
		}
		
		fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 1, $po_idArr, $empty_arr);//PO ID Ref from=1
		//fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 2, $trim_batch_idArr, $empty_arr);//Batch ID Ref from=2

		//echo "select mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in";die;
		//$sql_batch=sql_select("select mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in");
		$sql_batch=sql_select("SELECT b.mst_id as batch_id from pro_batch_trims_dtls b,gbl_temp_engine g   where  b.mst_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=1 and g.entry_form=48 and b.status_active=1 and b.is_deleted=0 ");
		 $all_batch_id='';
		foreach($sql_batch as $row) 
		{
			if($all_batch_id=="") $all_batch_id=$row[csf('batch_id')]; else $all_batch_id.=",".$row[csf('batch_id')];
		}
			$all_batch_ids=implode(",",array_unique(explode(",",$all_batch_id)));
		//echo $all_batch_ids; 
		$batch_ids_cond="";
		if($all_batch_ids!="") 
		{
			//echo $po_id=substr($po_id,0,-1);
			if($db_type==0) { $batch_ids_cond="and b.id in(".$all_batch_ids.")"; }
			else
			{
				$bat_id=array_unique(explode(",",$all_batch_ids));
				if(count($bat_id)>1000)
				{
					$batch_ids_cond="and (";
					$bat_id=array_chunk($bat_id,1000);
					$z=0;
					foreach($bat_id as $id)
					{
						$id=implode(",",$id);
						if($z==0) $batch_ids_cond.=" b.id in(".$id.")";
						else $batch_ids_cond.=" or b.id in(".$id.")";
						$z++;
					}
					$batch_ids_cond.=")";
				}
				else { 
				
				$batch_ids_cond=" and b.id in(".$all_batch_ids.")"; }
			}
		}
	}
	//print_r($batch_ids);die;
	 
	$samp_non_booking=sql_select("select b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no_id=a.id and a.booking_type=4  $company_idcond $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

	//echo "select b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.buyer_name from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";die;
	$all_batch_id_samp="";
	foreach($samp_non_booking as $row)
	{
		$non_buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$non_buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$sample_booking_ref_no_arr[$row[csf('booking_no')]]=$row[csf('grouping')];
		if($txt_samp_ref_no!='')
		{
		if($all_batch_id_samp=="") $all_batch_id_samp=$row[csf('batch_id')]; else $all_batch_id_samp.=",".$row[csf('batch_id')];
		}
	}
	if($all_batch_id_samp!="") $all_batch_id_samp_cond="and b.id in($all_batch_id_samp)";else $all_batch_id_samp_cond="";
	//echo $all_batch_id_samp_cond.'X';
	
    if($from_date!="")
    {
		if(str_replace("'","",$cbo_value_with)==1)
		{
			$date_cond=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";

			$sql=sql_select("SELECT b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
			and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");

			if($batch_type==2){

			$sql=sql_select("SELECT b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
			and a.entry_form in (38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0  $company_idcnd $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");

			}
		
		}
		else if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond=" and b.batch_date between '".$from_date."' and '".$to_date."'";
			$sql=sql_select("select b.id,b.batch_no,b.booking_without_order,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
			from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
			//echo "select b.id,b.batch_no,b.booking_without_order,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";die;
		}
   	}
   	else
   	{
		$sql=sql_select("select b.id,b.booking_without_order,b.batch_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
		from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0 $company_idcond $batch_cond $batch_ids_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
   	}
	/*echo "select b.id,b.booking_without_order,b.batch_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
	from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0 $company_idcond $batch_cond $batch_ids_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";die;*/
  	//echo $sql;die;
  	$reding_batch_id=$non_reding_batch_id=array();
    foreach($sql as $row)
	{
		if($row[csf("batch_against")]==2)
		{
			$reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
		else
		{
			$non_reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
		 
		$batch_id_arr[]=$row[csf("id")]; 
		$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
		$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
		$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
		$batch_description_arr[$row[csf("id")]]['batch_weight']=$row[csf("batch_weight")];
		$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
		$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
		$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
		$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
		$batch_no_arr[]="'".$row[csf("batch_no")]."'";
		$batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
	}
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 2, $batch_id_arr, $empty_arr);//Batch ID Ref from=2
	//print_r($batch_id_arr);
	//$batchIdCond=where_con_using_array($batch_id_arr,0,'a.batch_id');
	//$batchIdCond_subcon=where_con_using_array($batch_id_arr,0,'a.mst_id');
	$po_data_subcon=sql_select("select a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	subcon_ord_mst c,gbl_temp_engine g where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.mst_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0 ");
	 
	
	$sub_con_arr=array();
	foreach($po_data_subcon as $row)
	{
		if($sub_con_arr[$row[csf('mst_id')]][cust_style_ref]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref].=",".$row[csf('cust_style_ref')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref]=$row[csf('cust_style_ref')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][order_no]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no].=",".$row[csf('order_no')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no]=$row[csf('order_no')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][subcon_job]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job].=",".$row[csf('subcon_job')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job]=$row[csf('subcon_job')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][party_id]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id].=",".$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id].=",".$row[csf('party_id')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id]=$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id]=$row[csf('party_id')];	
		}
	}
	
	 
	$date_cond2=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";
	$fabric_sql=sql_select("select b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
	from pro_fab_subprocess  a,pro_batch_create_mst b,gbl_temp_engine g  where  a.batch_id=b.id and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48
	and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 $company_idcond ");
 	
  	$fabric_type_arr=array();
    foreach($fabric_sql as $row)
	{
	 	$fabric_type_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
	}
	unset($fabric_sql);
	/* echo "<pre>";
	print_r($reding_batch_id);
	echo "<pre>";
	print_r($non_reding_batch_id);die;*/
	//	***************************************************************************************************************************************************
     $batch_id_sql=implode(",",$batch_id_arr);
    if($batch_id_sql=="") $batch_id_sql=0;
	//echo  $batch_id_sql;
  	if($batch_type==3)
	{
		//$re_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond2=chop($re_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond2.=")";
		}
	}
	else
	{
		//$re_dying_cond=" and b.re_dyeing_from in(".$batch_id_sql.")";	
		//$pord_ids = explode(",",$txt_product_id);
		//echo count($pord_ids);die;
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond=chop($re_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond.=")";
		}
	}
	if($db_type==0)
	{
		if($batch_type==3)
		{
		 $sql_redying=sql_select("select b.id as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0 group by  b.id");
		}
		else
		{
			 $sql_redying=sql_select("select group_concat(b.id) as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0  $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0 group by  b.re_dyeing_from");	
		}
	}
	else
	{
	
		if($batch_type==3)
		{	
			//  $sql_redying=sql_select("select b.id as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no
			//   from  pro_batch_create_mst  b 
			//   where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0  group by  b.id");
			$sql_redying=sql_select("SELECT b.id as id, b.batch_date as batch_date, b.extention_no as extention_no
			   from  pro_batch_create_mst  b ,gbl_temp_engine g
			   where  b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and b.re_dyeing_from!=0 $company_idcond  and b.status_active=1 and b.is_deleted=0  ");
		}
		else
		{
			//  $sql_redying=sql_select("select listagg((b.id),',') within group (order by b.id) as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no,b.re_dyeing_from 
			//  from  pro_batch_create_mst b 
			//  where b.re_dyeing_from!=0   $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0  group by  b.re_dyeing_from");
			$sql_redying=sql_select("SELECT  b.id as id, b.batch_date as batch_date, b.extention_no as extention_no,b.re_dyeing_from 
			from  pro_batch_create_mst b ,gbl_temp_engine g
			where  b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and b.re_dyeing_from!=0   $company_idcond  and b.status_active=1 and b.is_deleted=0  ");
		}
	}
	
   	//and b.batch_against=2
    $redying_details_arr=array();
    foreach($sql_redying as $re_row)
    {
		if($batch_type==3)
		{
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['id']=$re_row[csf("id")];
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['batch_date']=$re_row[csf("batch_date")];
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['extention_no']=$re_row[csf("extention_no")];
		}
		else
		{
			
			
			$redying_details_arr[$re_row[csf("id")]]['id']=$re_row[csf("id")];
			$redying_details_arr[$re_row[csf("id")]]['batch_date']=$re_row[csf("batch_date")];
			$redying_details_arr[$re_row[csf("id")]]['extention_no']=$re_row[csf("extention_no")];
		}
    }
	
	//echo "<pre>"; print_r($redying_details_arr);die;
	if($batch_type==3)
	{
		//$all_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$all_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$all_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$all_dying_cond2=chop($all_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$all_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$all_dying_cond2.=")";
		}
	}
	else
	{
		if(count($batch_id_arr)>0)
		{
			$all_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$all_dying_cond.=" b.id in(".implode(",",$batch_id).") or";
				}
				$all_dying_cond=chop($all_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$all_dying_cond.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$all_dying_cond.=")";
		}
	}
	
	if($batch_type==3)
	{
		// $result_sql=sql_select("select a.result,a.batch_id 
		// from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2   $company_idcond $all_dying_cond2 and a.status_active=1 and a.is_deleted=0");	
		$result_sql=sql_select("SELECT a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b,gbl_temp_engine g where b.id=a.batch_id and b.id=g.ref_val and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48  and a.entry_form in (35,38) and a.load_unload_id=2   $company_idcond  and a.status_active=1 and a.is_deleted=0");	
	}
	else
	{
		// $result_sql=sql_select("select a.result,a.batch_id 
		// from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2  $company_idcond $all_dying_cond and a.status_active=1 and a.is_deleted=0");
		$result_sql=sql_select("SELECT a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b,gbl_temp_engine g where b.id=a.batch_id and b.id=g.ref_val and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and a.entry_form in (35,38) and a.load_unload_id=2  $company_idcond  and a.status_active=1 and a.is_deleted=0");
	}
	
	/*$sql_result=sql_select("select a.result,a.batch_id from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2  and a.company_id=$cbo_company_name and b.re_dyeing_from in (".$batch_id_sql.") and a.status_active=1 and a.is_deleted=0");*/
	
	$result_arr=array();
	foreach($result_sql as $value)
	{
		$result_arr[$value[csf('batch_id')]]=$value[csf('result')];	
	}
	 unset($result_sql);
	//$batchIdCond=where_con_using_array($batch_id_arr,0,'a.batch_id');
	$batchIdCond_mst=where_con_using_array($batch_id_arr,0,'c.id');
	
	// $floor_arr=return_library_array("select  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 $batchIdCond", "batch_id", "floor_name" );
	// $machine_name_arr=return_library_array("select  a.batch_id ,b.machine_no from   pro_fab_subprocess a, lib_machine_name b  where a.machine_id=b.id and a.entry_form=35 and  b.status_active=1 and b.is_deleted=0 $batchIdCond", "batch_id", "machine_no" );
	$floor_arr=return_library_array("SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b,gbl_temp_engine g  where a.floor_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0 ", "batch_id", "floor_name" );
	$machine_name_arr=return_library_array("SELECT  a.batch_id ,b.machine_no from   pro_fab_subprocess a, lib_machine_name b,gbl_temp_engine g  where a.machine_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and a.entry_form in(38,35) and  b.status_active=1 and b.is_deleted=0  ", "batch_id", "machine_no" );
	
	// $sql_book=sql_select("select a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c where a.booking_type in(1,4) and a.buyer_id=b.id and a.id=c.booking_no_id and a.status_active=1 and c.status_active=1 $batchIdCond_mst");
	$sql_book=sql_select("SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c,gbl_temp_engine g where a.buyer_id=b.id and a.id=c.booking_no_id and c.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 ");
	foreach($sql_book as $row)
	{
		$buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$po_break_down_id_arr[$row[csf('booking_no')]]=$row[csf('po_break_down_id')];
	}
	unset($sql_book);
	
	 if ($cbo_working_name==0) $company_issue_idcnd =""; else $company_issue_idcnd =" and a.KNIT_DYE_COMPANY='$cbo_working_name'";
	  if ($cbo_company_name==0) $company_id_issue=""; else $company_id_issue=" and a.company_id='$cbo_company_name'";
    $sql_dyes_cost =sql_select("select a.batch_no as BATCH_NO,b.item_category as ITEM_CAT,(b.cons_amount) as COST
    from inv_issue_master a, inv_transaction b
    where a.id=b.mst_id and b.transaction_type=2 and a.entry_form=5 and a.batch_no  is not null  and   b.item_category in (5,6,7) $company_id_issue $company_issue_idcnd");
	$dyes_chemical_arr=array();

	foreach($sql_dyes_cost as $val)
	{
		$dyes_chemical_arr[$val["BATCH_NO"]][$val["ITEM_CAT"]]['chemical_cost']+=$val["COST"];
		$batch_wise_no_arr[$val["BATCH_NO"]]=$val["BATCH_NO"];
	}
	 
	//**************************************************************************************************
	if($db_type==0)
	{
		//$sql_dtls =sql_select("select batch_no from inv_issue_master  where  entry_form=5 and status_active=1 and is_deleted=0 and batch_no<>''");
	}
	else
	{
		//$sql_dtls =sql_select("select batch_no from inv_issue_master  where  entry_form=5 and status_active=1 and is_deleted=0 and batch_no is not null");
	}
	
	//echo "select batch_no from inv_issue_master  where  entry_form=5 and status_active=1 and is_deleted=0 and batch_no is not null"; die;

	$multi_single_batch=array(); $issue_single_batch_arr=array();
	foreach($batch_wise_no_arr as $batchNos=>$inf)
	{
		if(strpos($batchNos, ",")==true)
		{
			//echo "=";
			$multi_batch_id=explode(",",$batchNos);
			$total_batch_id=count($multi_batch_id);
			$batch_match=0;
			foreach($multi_batch_id as $m_batch)
			{ 
				if(in_array($m_batch,$batch_id_arr)) {$issue_multi_batch_temp_arr[]=$m_batch;  $batch_match+=1;  }
				//$issue_single_batch_arr[$m_batch]=$m_batch;
			}
			if($batch_match==$total_batch_id) 
			{
				//echo "+";
				$issue_multi_batch_arr[]=$batchNos; 
				$multi_single_batch=array_merge($multi_single_batch, $issue_multi_batch_temp_arr); 
			}
		}
		else
		{
			//echo "||";
			if(in_array($batchNos,$batch_id_arr)) { $issue_single_batch_arr[$batchNos]=$batchNos;  } 
		}
	}
	/*foreach($sql_dtls as $inf)
	{
		if(strpos($inf[csf("batch_no")], ",")==true)
		{
			//echo "=";
			$multi_batch_id=explode(",",$inf[csf("batch_no")]);
			$total_batch_id=count($multi_batch_id);
			$batch_match=0;
			foreach($multi_batch_id as $m_batch)
			{ 
				if(in_array($m_batch,$batch_id_arr)) {$issue_multi_batch_temp_arr[]=$m_batch;  $batch_match+=1;  }
				//$issue_single_batch_arr[$m_batch]=$m_batch;
			}
			if($batch_match==$total_batch_id) 
			{
				//echo "+";
				$issue_multi_batch_arr[]=$inf[csf("batch_no")]; 
				$multi_single_batch=array_merge($multi_single_batch, $issue_multi_batch_temp_arr); 
			}
		}
		else
		{
			//echo "||";
			if(in_array($inf[csf("batch_no")],$batch_id_arr)) { $issue_single_batch_arr[$inf[csf("batch_no")]]=$inf[csf("batch_no")];  } 
		}
	}*/
	//print_r($multi_single_batch); echo "Test";die;
	$con = connect();
	execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id." and ref_from in (1,2,3) and ENTRY_FORM=48");
	oci_commit($con);
	disconnect($con);

	$i=1;$j=1;
	ob_start();	
	?>
	<div id="" align="center" style="height:auto; width:auto; margin:0 auto; padding:0;">
		<? $summaryHTML='<div id="summary_part" style="width:1460px;">
        <table width="2060px" cellpadding="0" cellspacing="0" id="caption" align="center">
            <thead>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:16px; font-weight:bold" >'.$report_title.'</td 
                ></tr>
                <tr style="border:none;">
                    <td colspan="24" class="form_caption" align="center" style="border:none; font-size:14px;">
                       <b>Company Name : '.$companyArr[$cbo_company_name].'</b>                               
                    </td>
                </tr>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:12px; font-weight:bold">
					'."Date: ". change_date_format($from_date).' To '. change_date_format($to_date).'
					</td>
                </tr>
            </thead>
        </table>
 		
        <div  align="left" style="font-size:25px">Summary Part</div>
        <table align="left" width="1440" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>

                    <th rowspan="2" width="100">Buyer</th>

                    <th rowspan="2" width="100">Batch Qty (Kg)</th>
                    <th colspan="4" width="">First Dying And Finishing Cost</th>
                    <th colspan="7" width="">Subsequent Dyeing and Finishing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per Kg Cost (Tk)</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>

                    <th width="100">Ttl Chem Cost(Tk)</th>
                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100"><p>Re-Dye Cost per kg (Tk)</th>
                </tr> 
            </thead>
        </table>
        <div style="width:1460px; max-height:400px;  overflow-y:scroll" id="scroll_body_summary">
	        <table align="left" width="1440" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="summary_table_body_id" >
	            <tbody>';
			       	
			       	$tot_main_batch_weight=0;
			       	foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
							if($batch_description_arr[$b_id][entry_form]==36)
			                {
			                	$buyerName=implode(", ",array_unique(explode(",",$sub_con_id_arr[$b_id][party_id])));
			                }
			                else
			                {
				                if($batch_description_arr[$b_id]["without_order"]==1) 
				                $buyerName=$non_buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
				                else $buyerName=$buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
			                }
			                $buyer_wise_summary_arr[$buyerName]["buyer"]=$buyerName;
			                $buyer_wise_summary_arr[$buyerName]["batch_qty"]+=$batch_description_arr[$b_id]["batch_weight"];
		
			                $first_chemi_cost=$first_dyeing_cost=0;
			                if($non_reding_batch_id[$b_id]!="")
			                {
			                    $first_chemi_cost=$dyes_chemical_arr[$b_id][5]["chemical_cost"]+$dyes_chemical_arr[$b_id][7]["chemical_cost"];
			                    $buyer_wise_summary_arr[$buyerName]["first_chemi_cost"]+=$first_chemi_cost;

			                    $first_dyeing_cost=$dyes_chemical_arr[$b_id][6]["chemical_cost"];
			                    $buyer_wise_summary_arr[$buyerName]["first_dyeing_cost"]+=$first_dyeing_cost;
								$tot_main_batch_weight=$tot_main_batch_weight+=$batch_description_arr[$b_id]["batch_weight"];
								$buyer_wise_summary_arr[$buyerName]["tot_main_batch_weight"]+=$tot_main_batch_weight;
			                }
			                $buyer_wise_summary_arr[$buyerName]["cost_per_kg"]+=($first_chemi_cost+$first_dyeing_cost)/$batch_description_arr[$b_id]["batch_weight"];

			                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
			                if($reding_batch_id[$b_id]!="")
			                {
			                    $re_dying_chemical_cost=$dyes_chemical_arr[$b_id][5]["chemical_cost"]+$dyes_chemical_arr[$b_id][7]["chemical_cost"];
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_chemical_cost"]+=$re_dying_chemical_cost;

			                    $re_dying_dyes_cost=$dyes_chemical_arr[$b_id][6]["chemical_cost"];	
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_dyes_cost"]+=$re_dying_dyes_cost;

			                    $re_dying_dyes_chemical_cost=$dyes_chemical_arr[$b_id][5]["chemical_cost"]+$dyes_chemical_arr[$b_id][6]["chemical_cost"]+$dyes_chemical_arr[$b_id][7]["chemical_cost"];
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_dyes_chemical_cost"]+=$re_dying_dyes_chemical_cost;
			                }
			                $buyer_wise_summary_arr[$buyerName]["re_dye_cost_per_kg"]+=$re_dying_dyes_chemical_cost/$batch_description_arr[$b_id]["batch_weight"];

			                $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
			                $buyer_wise_summary_arr[$buyerName]["total_per_kg_cost"]+=($re_dying_dyes_chemical_cost+$batch_chemical_price)/$batch_description_arr[$b_id]["batch_weight"];

			                //$buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price)/$buyer["batch_qty"]
						}	
					}

				    // echo "<pre>";print_r($buyer_wise_summary_arr);die;
					foreach($buyer_wise_summary_arr as $buyer_id=>$buyer)
					{
						if($j%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
						
			            $summaryHTML.='<tr bgcolor="'.$bgcolor.'">
			                <td width="30">'.$j.'</td>

				            <td width="100"><p>'.$buyer_library[$buyer_id].'</p></td>

			                <td width="100" align="right" align="right"><p>'.number_format($buyer["batch_qty"],4,".","").'</p></td>


			                <td width="100" align="right"><p>'.number_format($buyer["first_chemi_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.number_format($buyer["first_dyeing_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>';
			                $summary_batch_chemical_price=$buyer["first_chemi_cost"]+$buyer["first_dyeing_cost"];
			                $summaryHTML.=number_format($summary_batch_chemical_price,4,".","").'</p></td>
			                <td width="100" align="right"><p>
			                '.number_format(($summary_batch_chemical_price/$buyer["batch_qty"]),4,".","").' 
			                </p></td>


			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_chemical_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_dyes_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_dyes_chemical_cost"],4,".","").'</p></td>
			                <td width="100" align="right" title="Total Chemical And Dyes/BatchWeight">'.number_format($buyer["re_dye_cost_per_kg"],4,".","").'</td>


			                <td width="100" align="right">'.number_format($buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price,4,".","").'</td>
			                <td width="100" align="right" title="'."(".$buyer["re_dying_dyes_chemical_cost"]."+".$summary_batch_chemical_price.")/".$buyer["batch_qty"].'">
			                '.number_format((($buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price)/$buyer["batch_qty"]),4,".","").'
			                </td>
			            </tr>';
						$summary_total_batch_weight+=$buyer["batch_qty"];
						$summary_total_chemical_cost+=$buyer["first_chemi_cost"];
						$summary_total_dyes_cost+=$buyer["first_dyeing_cost"];
						$summary_total_batch_chemical_price+=$summary_batch_chemical_price;
						$summary_tot_total_receive+=$totalReceive;
						$summary_tot_re_dying_chemical_cost+=$buyer["re_dying_chemical_cost"];
						$summary_tot_re_dying_dyes_cost+=$buyer["re_dying_dyes_cost"];
						$summary_tot_re_dying_dyes_chemical_cost+=$buyer["re_dying_dyes_chemical_cost"];
						$summary_cost_per_kg+=$buyer["cost_per_kg"];
						$summary_total_per_kg_cost+=$buyer["total_per_kg_cost"];
						$j++;
					}
					?>
	            <? $summaryHTML.='</tbody>
	      	</table>
      	</div>
       	<table align="left" width="1440" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="summary_table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="100" align="right">&nbsp;Total</th>
                    <th width="100" id="value_total_batch_weight_summary">'.number_format($summary_total_batch_weight,4).'</th>
                	<th width="100" align="right" id="value_total_chemical_cost_summary">'.number_format($summary_total_chemical_cost,4).'</th>
                	<th width="100" align="right" id="value_total_dyeing_cost_summary">'.number_format($summary_total_dyes_cost,4).'</th>
                    <th width="100" align="right" id="value_total_chemical_price_summary">'.number_format($summary_total_batch_chemical_price,4).'</th>
                    <th width="100" align="right">'.number_format($summary_total_batch_chemical_price/$summary_total_batch_weight,4).'</th>
                    <th width="100" align="right" id="value_total_redying_chemic_oost_summary">'.number_format($summary_tot_re_dying_chemical_cost,4).'</th>
                    <th width="100" align="right" id="value_total_redying_dying_cost_summary"><p>'.number_format($summary_tot_re_dying_dyes_cost,4).'</p></th>
                    <th width="100" align="right" id="value_total_redying_all_cost_summary"><p>'.number_format($summary_tot_re_dying_dyes_chemical_cost,4).'</p></th>
                    <th width="100" align="right" id="value_total_redying_all_cost_summary_tk">'.number_format($summary_tot_re_dying_dyes_chemical_cost/$summary_total_batch_weight,4).'</th>
                    <th width="100" align="right" id="value_total_total_cost_summary">'.number_format($summary_total_batch_chemical_price+$summary_tot_re_dying_dyes_chemical_cost,4).'</th>
                    <th width="100" align="right" title="Main Batch Qty='.number_format($buyer["tot_main_batch_weight"],2).'">'.number_format((($summary_total_batch_chemical_price+$summary_tot_re_dying_dyes_chemical_cost)/$summary_total_batch_weight),4).'</th>
                </tr>
            </tfoot>
        </table>
    	</div>';?>
    <? echo $summaryHTML;?>

	<?
	if($batch_type!=2){

	
	?>
 	<div>
        <div  align="left" style="font-size:25px">Single Batch</div>
        <table width="3030" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>
                    <th rowspan="2" width="80">Date</th>
                    <th rowspan="2" width="100">Machine No</th>
                    <th rowspan="2" width="100">Batch No</th>
                    <th rowspan="2" width="80">File No</th>
                    <th rowspan="2" width="80">Ref. No</th>
                    <th rowspan="2" width="100">Floor Name</th>
                    <th rowspan="2" width="100">Buyer</th>
                    <th rowspan="2" width="100">Booking No</th>
                    <th rowspan="2" width="100">Job no</th>
                    <th rowspan="2" width="80">Season</th>                  
                    <th rowspan="2" width="">Style</th>
                    <th rowspan="2" width="100">Order No</th>
                    <th rowspan="2" width="100">Color Name</th>
                    <th rowspan="2" width="100">Color Range</th>
                    <th rowspan="2" width="100">Fabric Type </th>
                    <th rowspan="2" width="100">Batch Qty (Kg)</th>
                    <th colspan="4"  width="">First Dying And Finishing Cost</th>
                    <th colspan="7" width="">Subsequent Dyeing and Finishing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per Kg Cost (Tk)</th>
                    <th rowspan="2" width="100">Result</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>
                    <th width="100">Extention Batch Date</th>
                    <th width="70">Extention No</th>
                    <th width="100">Floor Name</th>
                    <th width="100">Ttl Chem Cost(Tk)</th>
                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100"><p>Re-Dye Cost per kg (Tk)</th>
                </tr> 
            </thead>
        </table>
        <div style="width:3050px; max-height:400px;  overflow-y:scroll" id="scroll_body_s">
	        <table width="3030" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_id_s" >
	            <tbody>
			       	<?
				    //echo "<pre>";
					//print_r($issue_single_batch_arr);die;
					$tot_main_batch_weight=0;
					foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
						
							if($i%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
							$all_po_id=explode(",",$po_break_down_id_arr[$batch_description_arr[$b_id]['booking_no']]);
							$po_number_data="";
							$job_no_data="";$file_no="";$ref_no="";
							foreach($all_po_id as $p_id) // $po_number_arr[$row[csf('id')]]['po_no']
							{
								if($po_number_data!="") $po_number_data.=",".$po_number_arr[$p_id]['po_no'];	 else $po_number_data=$po_number_arr[$p_id]['po_no'];
								if($job_no_data!="") $job_no_data.=",".$po_number_arr[$p_id]['job'];	 else $job_no_data=$po_number_arr[$p_id]['job'];
								if($season_data!="") $season_data.=",".$season_name_arr[$po_number_arr[$p_id]['season']];	 else $season_data=$season_name_arr[$po_number_arr[$p_id]['season']];
								if($file_no!="") $file_no.=",".$po_number_arr[$p_id]['file_no'];	 else $file_no=$po_number_arr[$p_id]['file_no'];
								if($ref_no!="") $ref_no.=",".$po_number_arr[$p_id]['ref_no'];	 else $ref_no=$po_number_arr[$p_id]['ref_no'];
							} 
							$color_range_id=$batch_description_arr[$b_id]['color_range'];
							$file_cond=implode(", ",array_unique(explode(",",$file_no)));
							$ref_cond=implode(", ",array_unique(explode(",",$ref_no)));
							if($batch_description_arr[$b_id]['without_order']==1 && $ref_cond=="")
							{
							$ref_cond=$sample_booking_ref_no_arr[$batch_description_arr[$b_id]['booking_no']];
							}
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="30"><? echo $i; ?></td>								
				                <td width="80"><? echo change_date_format($batch_description_arr[$b_id]['batch_date']); ?></td>
				                <td width="100"><p><? echo $machine_name_arr[$b_id]; ?></p></td>                                 
				                <td width="100"><p><A href="##"  onClick="subprocess_fabric_dtls('<? echo $b_id; ?>','<? echo $batch_arr[$b_id]; ?>','subprocess_fabrics_dtls_popup')"><p><? echo $batch_arr[$b_id]; ?></p></A><? //echo $batch_arr[$b_id]; ?></p></td>
				                <td width="80"><p><? echo $file_cond; ?></p></td>
				                <td width="80" title="PO/Sample Ref no"><p><? echo $ref_cond; ?></p></td>
				                <td width="100"><p><? echo $floor_arr[$b_id]; ?></p></td> 
				                <?
				                if($batch_description_arr[$b_id][entry_form]==36)
				                {
					                ?>
					                <td width="100"><p><? echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][party_id]))); ?></p></td> 
					                <td width="100"><p><? // echo $b_id; ?></p></td>
					                <td width="100" align="center"><p>
					                <? 
				                     echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                 <td width="80" align="center"><p>
					                <? 
				                     //echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                <td width="100" align="center"><p> <? echo   implode(",",array_unique(explode(",",$sub_con_arr[$b_id][cust_style_ref]))); ?></p></td>
					                <td width="100" align="center"><p> <? echo implode(",",array_unique(explode(",",$sub_con_arr[$b_id][order_no]))); ?></p></td>
				                	<?
				                }
				                else
				                {
					                ?>
					                <td width="100"><p><? 
					                if($batch_description_arr[$b_id]['without_order']==1) $buyerName=$non_buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];else $buyerName=$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
					                <td width="100"><p><? echo $batch_description_arr[$b_id]['booking_no']; ?></p></td>
					                <td width="100" align="center"><div style="word-break:break-all">
					                <?
					                echo implode(", ",array_unique(explode(",",$job_no_data)));
					                ?></div></td>
					                <td width="80" align="center"><div style="word-break:break-all">
					                <? 
					                
					                echo implode(", ",array_unique(explode(",",$season_data)));

					                ?></div></td>
					                <td width="" align="center"><div style="word-break:break-all"> 
					                <? 
					                $style_no=array();
					                foreach(array_unique(explode(",",$job_no_data)) as $j_no)
					                {
					                    if($style_no!="")  $style_no[]=$style_library[$j_no];
					                }
					                echo implode(", ",array_unique($style_no)); ?></div></td>
					                <td width="100" align="center"><div style="word-break:break-all"> <? echo implode(", ",array_unique(explode(",",$po_number_data))); ?></div></td>
					                <?	
				                }
				                ?>
				                <td width="100" align="center"><div style="word-break:break-all"><? echo $color_arr[$batch_description_arr[$b_id]['color_id']]; ?></div></td> 
				                <td width="100" align="center"><p><? echo $color_range[$color_range_id]; ?></p></td> 
				                <td width="100" align="center"><p><? echo $fabric_type_for_dyeing[$fabric_type_arr[$b_id]['fabric_type']]; //$fabric_type_for_dyeing?></p></td> 
				                <td width="100" align="right"><p>
				                <? echo $batch_description_arr[$b_id]['batch_weight']; $total_batch_weight+=$batch_description_arr[$b_id]['batch_weight'] ;?>
				                </p></td> 
				                <?
				                
				                $first_chemi_cost=$first_dyeing_cost=0;
				                if($non_reding_batch_id[$b_id]!="")
				                {
				                    $first_chemi_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                    $first_dyeing_cost=$dyes_chemical_arr[$b_id][6]['chemical_cost'];
									$tot_main_batch_weight+=$batch_description_arr[$b_id]['batch_weight'];
				                }
				                
				                ?>
				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($first_chemi_cost,4,".",""); 
				                 $total_chemical_cost+=$first_chemi_cost;
				                 ?>
				                </p></td>
				                <td width="100" align="right"><p>
				                <?  
				                    echo number_format($first_dyeing_cost,4,".",""); 
				                    $total_dyes_cost+=$first_dyeing_cost; 
				                ?>
				                </p></td>
				                <td width="100" align="right"><p><A href="##"  onClick="fn_1st_batch('<? echo $b_id; ?>','1st_batch_dtls_popup')">
				                <?
				                 $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
				                  echo number_format($batch_chemical_price,4,".","");
				                  $total_batch_chemical_price+=$batch_chemical_price;
				                ?>
				                </A></p></td>
				                <td width="100" align="right"><p><? echo number_format($batch_chemical_price/$batch_description_arr[$b_id]['batch_weight'],4,".",""); $tot_total_receive+=$totalReceive; ?></p></td>
				                <td width="100" align="right"><p>
				                <? 
				                $extension_no="";
				                $re_batch_date="";
				                $batch_date=explode(",", $redying_details_arr[$b_id]['batch_date']);	
				                foreach($batch_date as $ash_date)
				                {
				                 if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                }
				                echo $re_batch_date;
				                 ?></p></td>
				                <td width="70" align="right"><p>
				                <?		                
				                //echo $redying_details_arr[$b_id]['id'].jahid;
				                if(trim($redying_details_arr[$b_id]['id']))
				                {
				                    $re_dying_id_all=explode(",",$redying_details_arr[$b_id]['id']);
				                    //$re_dying_chemical_cost=0;
				                    //$re_dying_dyes_cost=0;
				                    //$re_dying_dyes_chemical_cost=0;
				                    
				                    $result_id="";
				                    $result_id_last='';
				                    
				                    foreach($re_dying_id_all as $ash_id)
				                    {
				                    //$re_dying_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                    //$re_dying_dyes_cost+=$dyes_chemical_arr[$ash_id][6]['chemical_cost']	;	
				                    //$re_dying_dyes_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][6]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                        
				                     if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                     //if($re_floor!="") $re_floor.=",".$floor_arr[$ash_id]; else $re_floor=$floor_arr[$ash_id];
				                    /* echo $ash_id.tipu;
				                     $result_id=$result_arr[$ash_id];
				                     if($result_id!="")  $result_id_last=$result_id;*/
				                    }
				                }
				                //echo $b_id;
				                //if($batch_type==3)
				                //{
				                echo $redying_details_arr[$b_id]['extention_no'];	 ?>
				                
				                
				                </p></td>
				                <td width="100" align="right"><p><?
				                $re_floors='';
				                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
				                //print_r($reding_batch_id);//echo $reding_batch_id[$b_id]."##".$b_id;
				                if($reding_batch_id[$b_id]!="")
				                {
				                    $re_floors=$floor_arr[$b_id];
				                    $re_dying_chemical_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                    $re_dying_dyes_cost=$dyes_chemical_arr[$b_id][6]['chemical_cost']	;	
				                    $re_dying_dyes_chemical_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][6]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                }
				                
				                echo $re_floors;
				                ?></p></td>
				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($re_dying_chemical_cost,4,".",""); 
				                 $tot_re_dying_chemical_cost+=$re_dying_chemical_cost;
				                 ?>
				                 </p></td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_dyes_cost,4,".",""); $tot_re_dying_dyes_cost+=$re_dying_dyes_cost;  ?></p></td>
				                <td width="100" align="right"><A href="##"  onClick="fn_total_batch('<? echo $b_id; ?>','total_batch_dtls_popup')"><p><? echo number_format($re_dying_dyes_chemical_cost,4,".",""); $tot_re_dying_dyes_chemical_cost+=$re_dying_dyes_chemical_cost; ?></p></A></td>
				                <td width="100" align="right" title="Total Chemical And Dyes/BatchWeight"><? echo number_format($re_dying_dyes_chemical_cost/$batch_description_arr[$b_id]['batch_weight'],4,".",""); ?></td>
				                

				                <td width="100" align="right"><? echo number_format($re_dying_dyes_chemical_cost+$batch_chemical_price,4,".",""); ?></td>
				                <td width="100" align="right" title="<? echo '('.$re_dying_dyes_chemical_cost.'+'.$batch_chemical_price.')/'.$batch_description_arr[$b_id]['batch_weight']; ?>"><? echo number_format(($re_dying_dyes_chemical_cost+$batch_chemical_price)/$batch_description_arr[$b_id]['batch_weight'],4,".","");  ?></td>
				                <td width="100" align="center" title="<? echo $b_id; ?>"><? //echo $unload_result_arr[$b_id]//echo  $dyeing_result[$result_id];//
				                //echo $b_id.tipu;
			                    $result_id=$result_arr[$b_id];
			                    if($result_id!="")  $result_id_last=$result_id;
				                echo $dyeing_result[$result_id];//$dyeing_result;//$daysOnHand; ?></td>
				            </tr>
							<? 												
								 $i++; 			
						}	
					}
					?>
	            </tbody>
	      	</table>
      	</div>
       	<table width="3030" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="80">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                   <th width="80">&nbsp;</th>
                    <th width="">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="100"><? //echo number_format($total_batch_chemical_price,4).'='.$total_dyes_cost; ?></th>
                	<th width="100">Total</th>
                    <th width="100" id="value_total_batch_weight_single"><? echo number_format($total_batch_weight,4); ?></th>
                	<th width="100" id="value_total_chemical_cost_single"><? echo number_format($total_chemical_cost,4); ?></th>
                	<th width="100" id="value_total_dyeing_cost_single"><? echo number_format($total_dyes_cost,4); ?></th>
                    <th width="100" id="value_total_chemical_price_single"><? echo number_format($total_batch_chemical_price,4); ?></th>
                    <th width="100" id="value_total_chemical_per_single"><? echo number_format(($total_batch_chemical_price/$total_batch_weight),4); ?></th>
                    <th width="100"><? //echo number_format($tot_re_dying_chemical_cost,3); ?></th>
                    <th width="70"><? //echo number_format($tot_rec_return,3); ?></th>
                    <th width="100"><? //echo number_format($tot_total_issue,3); ?></th>
                    <th width="100" id="value_total_redying_chemic_oost_single"><? echo number_format($tot_re_dying_chemical_cost,4); ?></th>
                    <th width="100" id="value_total_redying_dying_cost_single"><p><? echo number_format($tot_re_dying_dyes_cost,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single"><p><? echo number_format($tot_re_dying_dyes_chemical_cost,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single_tk"><? echo number_format($tot_re_dying_dyes_chemical_cost/$total_batch_weight,4); ?></th>
                    <th width="100" id="value_total_total_cost_single"><? echo number_format($total_batch_chemical_price+$tot_re_dying_dyes_chemical_cost,4); ?></th>
                    <th width="100" id="value_total_total_cost_per_single" title="Main Batch Qty=<? echo number_format($tot_main_batch_weight,2);?>"><? echo number_format(($total_batch_chemical_price/$total_batch_weight),4); ?></th>
                    <th width="100">&nbsp;</th>
                </tr>
            </tfoot>
        </table>
    </div>
	<?
	}
	?>
				
      
    <div>
       	<div  align="left" style="font-size:25px">Multiple Batch</div>
       
	        <table width="2970" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
	        	<thead>
	                <tr>
	                    <th rowspan="2" width="40">SL</th>
	                    <th rowspan="2" width="80">Date</th>
	                    <th rowspan="2" width="100">Machine No</th>
	                    <th rowspan="2" width="100">Batch No</th>
	                    <th rowspan="2" width="80">File No</th>
	                    <th rowspan="2" width="80">Ref. No</th>
	                    <th rowspan="2"width="100">Floor Name</th>
	                    <th rowspan="2" width="80">Buyer</th>
	                    <th rowspan="2" width="100">Booking No</th>
	                    <th rowspan="2" width="100">Job no</th>
	                    <th rowspan="2" width="80">Season</th>
	                    <th rowspan="2" width="100">Style</th>
	                    <th rowspan="2" width="100">Order No</th>
	                    <th rowspan="2" width="100">Color Name</th>
	                    <th rowspan="2" width="100">Color Range</th>
	                    <th rowspan="2" width="100">Fabric Type </th>
	                    <th rowspan="2" width="80">Batch Qty (Kg)</th>
	                    <th colspan="4"  width="430">First Dying And Finishing Cost</th>
	                    <th colspan="7" width="660">Subsequent Dyeing and Finishing Cost</th>
	                    <th rowspan="2" width="70">Total Cost (Tk)</th>
	                    <th rowspan="2" width="70">Total Per Kg Cost (Tk)</th>
	                    <th rowspan="2" width="">Result</th>
	                </tr> 
	                <tr>                         
	                    <th width="100">Ttl Chem Cost (Tk)</th>
	                    <th width="110">Ttl Dyes Cost (Tk)</th>
	                    <th width="110">Ttl Chem + Dyes Cost (Tk)</th>
	                    <th width="110">Cost Per Kg(Tk)</th>
	                    <th width="80">Extention Batch Date</th>
	                    <th width="70">Extention No</th>
	                    <th width="100">Floor Name</th>
	                    <th width="100">Ttl Chem Cost(Tk)</th>
	                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
	                    <th width="100">Ttl Chem + Dyes Cost (Tk)</th>
	                    <th width="110">Re-Dye Cost per kg (Tk)</th>
	                </tr> 
	            </thead>
	        </table>
	        <div style="width:2990px; max-height:400px; overflow-y:scroll" id="">
		        <table width="2970" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_multibatch_id">
			       	<?
					$multi_batch_qty_total=0;
					$j=1;
					foreach(array_unique($issue_multi_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
							if($j%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF"; 
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="40"><? echo $j; ?></td>								
				                <td width="80" style="word-break:break-all;">
				                <?
								$multiple_batch_id=explode(",",$b_id);
								$batch_id_all="";
								$muli_batch_floor_name="";$multi_batch_machine='';
								$multi_batch_buyer_name=array();
								$multi_batch_booking_no=array();
								$multi_batch_job_no=array();
								$multi_batch_style_no=array();
								$multi_batch_color=""; $multi_batch_color_range="";
								$mulib_batch_weight=0;
								$re_dying_dyes_multi_batch_cost=0;
								$re_dying_dyes_multi_batch_chemical_cost=0;
								$re_multi_batch_floor="";
								$mult_batch_chemical_cost=0;
								$mult_batch_dyes_cost=0;
								$mult_batch_dyes_chemical_cost=0;
								$multiBatch_extension="";
								$re_floor="";
								$p=0;
								$redying_batch_id=array();
								$po_number_data_all=array();
								$batch_date_arr=array();
								$re_dying_multi_batch_chemical_cost=0;
								$re_dying_multi_batch_dying_cost=0; 
								$re_dying_multi_batch_dyes_chemical_cost=0;
								$remulti_batch_date="";$batch_nos="";
								$new_redying_arr=array();
								$new_redying_arr1=array();
				                foreach($multiple_batch_id as $s_bid)
				                {
				                      
									// echo $s_bid."mahbub";
									    
				                  	//  $batch_button="<a href='##' onClick=\"subprocess_fabric_dtls('".$b_id."','".$batch_id_all."','subprocess_fabrics_dtls_popup')\"> ".$batch_id_all." </a>";
									  $p++;
				                      $batch_date_arr[]=$batch_description_arr[$s_bid]['batch_date'];
				                      if($batch_id_all!="") $batch_id_all.=",".$batch_arr[$s_bid]; else $batch_id_all=$batch_arr[$s_bid];
									  if($batch_nos=="") $batch_nos="<a href='##' onClick=\"subprocess_fabric_dtls('".$s_bid."','".$batch_arr[$s_bid]."','subprocess_fabrics_dtls_popup')\"> ".$batch_arr[$s_bid]." </a>";else $batch_nos.=", "."<a href='##' onClick=\"subprocess_fabric_dtls('".$s_bid."','".$batch_arr[$s_bid]."','subprocess_fabrics_dtls_popup')\"> ".$batch_arr[$s_bid]." </a>";
				                      if($muli_batch_floor_name!="") $muli_batch_floor_name.=",".$floor_arr[$s_bid]; else $muli_batch_floor_name=$floor_arr[$s_bid];
				                      
				                      // for buyer name job style po*************************************************************************************
				                      if($batch_description_arr[$s_bid][entry_form]==36)
				                      {
				                          $multi_batch_buyer_name[]=$sub_con_arr[$s_bid][party_id];
				                          $multi_batch_job_no[]=$sub_con_arr[$s_bid][subcon_job];
				                          $po_number_data_all[]=$sub_con_arr[$s_bid][order_no];
				                          $multi_batch_style_no[]=$sub_con_arr[$s_bid][cust_style_ref];
				                      }
				                      else
				                      {
				                          $all_po_ids=array_unique(explode(",",$po_break_down_id_arr[$batch_description_arr[$s_bid]['booking_no']])); //print_r(array_unique($batch_description_arr[$s_bid]['booking_no']));
				                           $ref_no='';   $file_no=''; $po_no='';$season_data='';
										   //print_r( $all_po_id);
										  foreach($all_po_ids as $p_id)
				                          {
				                            // echo $p_id.'<pre>';
											  $po_number_data_all[]=$po_number_arr[$p_id]['po_no'];
				                              $multi_batch_job_no[]=$job_no_arr[$p_id];
											  if($season_data!="") $season_data.=",".$season_name_arr[$po_number_arr[$p_id]['season']];	 else $season_data=$season_name_arr[$po_number_arr[$p_id]['season']];
											  if( $po_no=='') $po_no=$po_number_arr[$p_id]['po_no'];else $po_no.=",".$po_number_arr[$p_id]['po_no'];
											  if( $ref_no=='') $ref_no=$po_number_arr[$p_id]['ref_no'];else $ref_no.=",".$po_number_arr[$p_id]['ref_no'];
											  if( $file_no=='') $file_no=$po_number_arr[$p_id]['file_no'];else $file_no.=",".$po_number_arr[$p_id]['file_no'];
											 // echo $po_no;
						 					 
				                          }
										  if($batch_description_arr[$s_bid]['without_order']==1)
										  { 
										 	$multi_batch_buyer_name[]=$non_buyer_name_arr[$batch_description_arr[$s_bid]['booking_no']];
										  }
										  else 
										  { 
										    $multi_batch_buyer_name[]=$buyer_name_arr[$batch_description_arr[$s_bid]['booking_no']];
										  }
										  if($batch_description_arr[$s_bid]['without_order']==1 && $ref_no=="")
											{
											$ref_no=$sample_booking_ref_no_arr[$batch_description_arr[$s_bid]['booking_no']];
											}
							
									
				                         
										  
				                          $multi_batch_booking_no[]=$batch_description_arr[$s_bid]['booking_no'];
				                          $style_no=array();
				                          foreach(array_unique($multi_batch_job_no) as $j_no)
				                          {
				                             if($multi_batch_style_no!="")  $multi_batch_style_no[]=$style_library[$j_no];
				                          } 
				                      }
				                      $mulib_batch_weight+=$batch_description_arr[$s_bid]['batch_weight'];
				                      //****************************************** for color **********************************************************
				                      if($multi_batch_color!="") $multi_batch_color.=",".$color_arr[$batch_description_arr[$s_bid]['color_id']];
				                      else $multi_batch_color=$color_arr[$batch_description_arr[$s_bid]['color_id']];
									  
				                      if($multi_batch_color_range!="") $multi_batch_color_range.=",".$color_range[$batch_description_arr[$s_bid]['color_range']];
				                      else $multi_batch_color_range=$color_range[$batch_description_arr[$s_bid]['color_range']];
									  
									  if($multi_batch_machine!="") $multi_batch_machine.=",".$machine_name_arr[$s_bid];
				                      else $multi_batch_machine=$machine_name_arr[$s_bid];
									  
									  
									  //$color_range_id=$color_range[$batch_description_arr[$b_id]['color_range']];
				                      //******************************************** for redyeing **********************************************************
									  //echo $batch_description_arr[$s_bid]['color_range'];
									if($redying_details_arr[$s_bid]['id']!="")
									{
					                      if($multiBatch_extension!="") $multiBatch_extension.="*".$redying_details_arr[$s_bid]['extention_no'];
					                      else $multiBatch_extension=$redying_details_arr[$s_bid]['extention_no'];
					                      $sl=0;
										  
					                      foreach(explode(",",$redying_details_arr[$s_bid]['id']) as $rbs)
					                      {
					                        $new_redying_arr[$sl]=$new_redying_arr[$sl].",".$rbs;
					                        $new_redying_arr1[$sl]=$rbs.",".$new_redying_arr1[$sl];
					                        $sl++; 
					                        
					                        if($re_floor!="") $re_floor.=",".$floor_arr[$rbs];
					                        else $re_floor=$floor_arr[$rbs];
					                      }
					                      // for redyeing batch date *************************************************************************************************
					                      foreach(array_unique(explode(",",$redying_details_arr[$s_bid]['batch_date'])) as $r_date)
					                      {
					                      if($remulti_batch_date!="") $remulti_batch_date.=",".change_date_format($r_date); else $remulti_batch_date=change_date_format($r_date);
					                      }
					                }
									
					                // *****************************************redyeing dyes and chemical cost***************************************
					                 foreach($new_redying_arr as $l_id)
					                 {
					                     $re_dying_multi_id_all=ltrim($l_id,",");
					                     $re_dying_multi_batch_chemical_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][5]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][7]['chemical_cost'];
					                     $re_dying_multi_batch_dying_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][6]['chemical_cost'];	
					                     $re_dying_multi_batch_dyes_chemical_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][5]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][6]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][7]['chemical_cost'];
					                    
					                 }
					                 foreach($new_redying_arr1 as $l_id)
					                 {
					                     $re_dying_multi_id_all=rtrim($l_id,",");
					                     $re_dying_multi_batch_chemical_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][5]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][7]['chemical_cost'];
					                     $re_dying_multi_batch_dying_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][6]['chemical_cost']	;	
					                     $re_dying_multi_batch_dyes_chemical_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][5]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][6]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][7]['chemical_cost'];
					                 }
									 $re_dying_multi_batch_chemical_cost_total+=$re_dying_multi_batch_chemical_cost;
					                 $re_dying_multi_batch_dying_cost_total+=$re_dying_multi_batch_dying_cost;
					                 $re_dying_multi_batch_dyes_chemical_cost_total+=$re_dying_multi_batch_dyes_chemical_cost;
								}
								 
				                // dyes and chemical cost total  ************************************************************************************************
				                 $mult_batch_chemical_cost+=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                 $mult_batch_dyes_cost+=$dyes_chemical_arr[$b_id][6]['chemical_cost']; 
				                 $mult_batch_dyes_chemical_cost=$mult_batch_chemical_cost+$mult_batch_dyes_cost;
				                 $multi_batch_qty_total+=$mulib_batch_weight;
				                 $mult_batch_chemical_cost_total+=$mult_batch_chemical_cost;
				                 $mult_batch_dyes_cost_total+=$mult_batch_dyes_cost;
				                 $mult_batch_dyes_chemical_cost_total+=$mult_batch_dyes_chemical_cost;
				                 
				                 $multi_date="";
				                 foreach(array_unique($batch_date_arr) as $m_date)
				                 {
				                 if($multi_date!="") $multi_date.=",".change_date_format($m_date); else $multi_date=change_date_format($m_date);
				                 }
								//echo $ref_no.'='.$file_no;
								 
								 
				                ?><p><? echo $multi_date; ?></p></td>  
				                 <td width="100"><p><? echo implode(",",array_unique(explode(",",$multi_batch_machine))); ?></p> </td>                               
				                <td width="100" ><p> <?
									 echo $batch_nos;
									 ?>
				                    </p> </td>
				                <td width="80" align="center"><p><? echo $file_no; ?></p></td>
				                <td width="80" align="center" title="PO/Sample Ref no"><p><?  echo $ref_no; ?></p></td>
				                <td width="100"><p><? echo implode(",",array_unique(explode(",",$muli_batch_floor_name))); ?></p></td> 
				                <td width="80" align="center"><p><? echo implode(",",array_unique($multi_batch_buyer_name)); ?></p></td>  
				                <td width="100" align="center"><p><? echo implode(",",array_unique($multi_batch_booking_no)); ?></p></td> 
				                <td width="100" align="center"><p><? echo implode(",",array_unique($multi_batch_job_no)); ?></p></td> 
				                 <td width="80" align="center"><p><? echo implode(",",array_unique($season_data)); ?></p></td> 
				                <td width="100" align="center"><p><? echo implode(",",array_unique($multi_batch_style_no)); ?></p></td> 
				                <td width="100" align="center"><p><? echo  implode(",",array_unique(explode(",",$po_no)));//echo implode(",",array_unique(explode(",",$po_number_data_all)));//?></p></td>
				                <td width="100" align="center"><p><? echo implode(",",array_unique(explode(",",$multi_batch_color))); ?></p></td>
				                <td width="100" align="center"><p><? echo implode(",",array_unique(explode(",",$multi_batch_color_range))); ?></p></td> 
				                <td width="100"><p><?
								 $type_name="";
								$arra_type= array_unique($multiple_batch_id);
								//print_r($fabric_type_arr);
								foreach($arra_type as $v)
								{
									//echo $v;
									if($fabric_type_arr[$v]['fabric_type'])
									{
										if($type_name) $type_name.=",".$fabric_type_for_dyeing[$fabric_type_arr[$v]['fabric_type']];
										else $type_name.=$fabric_type_for_dyeing[$fabric_type_arr[$v]['fabric_type']];
									}
								}
								 echo $type_name; ?></p></td>  
				                <td width="80" align="right"><p><? echo $mulib_batch_weight; ?></p></td>
				                <td width="100" align="right"><p><? echo number_format($mult_batch_chemical_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_batch_dyes_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_batch_dyes_chemical_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_batch_dyes_chemical_cost/$mulib_batch_weight,4); ?></p></td>
				                <td width="80" align="right"><p><?  echo implode(",",array_unique(explode(",",$remulti_batch_date))); ?></p></td>
				                <td width="70" align="right"><p><?  echo $multiBatch_extension; ?></p></td>
				                <td width="100" align="right"><p><?  echo implode(",",array_unique(explode(",",$re_floor))); ?></p></td>
				                <td width="100" align="right"><p>
				                <? echo number_format($re_dying_multi_batch_chemical_cost,4); $tot_closing_stock+=$closingStock; ?></p>
				                </td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_multi_batch_dying_cost,4); ?></p></td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_multi_batch_dyes_chemical_cost,4);  ?></p></td>
				                <td width="110" align="right"><? echo number_format($re_dying_multi_batch_dyes_chemical_cost/$mulib_batch_weight,4); ?></td>
				                <td width="70" align="right"><? echo  number_format($re_dying_multi_batch_dyes_chemical_cost+$mult_batch_dyes_chemical_cost,4);  ?></td>
				                <td width="70" align="right"><? echo number_format(($re_dying_multi_batch_dyes_chemical_cost+$mult_batch_dyes_chemical_cost)/$mulib_batch_weight,4);; ?></td>
				                <td width="" align="center"><? 
				                if($dye_result!="") $result.=",".$dyeing_result[$result_arr[$s_bid]];
					            else $dye_result=$dyeing_result[$result_arr[$s_bid]];
					            echo implode(",",array_unique(explode(",",$dye_result)));
				                //echo $daysOnHand;//$daysOnHand; ?></td>
				            </tr>
							<? 
							unset($new_redying_arr);
							unset($new_redying_arr1);
																			
							$j++; 		
						}		
					}
					?>
		        </table>
	        </div>
	        <table width="2970" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer">
		        <tfoot>
	            	<tr>
	                	<th width="40">&nbsp;</th>
	                	<th width="80">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                    <th width="80">&nbsp;</th>
	                    <th width="80">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                	<th width="80">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                      <th width="80">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                    <th width="80" id="value_total_batch_weight_multiple"><? echo number_format($multi_batch_qty_total,4); ?></th>
	                	<th width="100" id="value_total_chemical_cost_multiple"><? echo number_format($mult_batch_chemical_cost_total,4); ?></th>
	                	<th width="110" id="value_total_dyeing_cost_multiple"><? echo number_format($mult_batch_dyes_cost_total,4); ?></th>
	                    <th width="110" id="value_total_chemical_price_multiple"><? echo number_format($mult_batch_dyes_chemical_cost_total,4); ?></th>
	                    <th width="110" id="value_total_cost_per_kg_multi"><? echo number_format($mult_batch_dyes_chemical_cost_total/$multi_batch_qty_total,3); ?></th>
	                    <th width="80"><? //echo number_format($mult_batch_dyes_chemical_cost_total/$multi_batch_qty_total,3); ?></th>
	                    <th width="70"><? //echo number_format($tot_rec_return,3); ?></th>
	                    <th width="100"><? //echo number_format($tot_total_issue,3); ?></th>
	                    <th width="100" id="value_total_chemical_cost_multi"><? echo number_format($re_dying_multi_batch_chemical_cost_total,4); ?></th>
	                    <th width="100" id="value_total_redying_dying_cost_multiple"><p><? echo number_format($re_dying_multi_batch_dying_cost_total,4); ?></p></th>
	                    <th width="100" id="value_total_redying_all_cost_multiple"><p><? echo number_format($re_dying_multi_batch_dyes_chemical_cost_total,4); ?></p></th>
	                    <th width="110" id="value_total_redye_cost_per_kg_multi"><? echo number_format(($re_dying_multi_batch_dyes_chemical_cost_total/$multi_batch_qty_total),4); ?></th>
	                    <th width="70" id="value_grand_total_cost_multiple"><? echo number_format($mult_batch_dyes_chemical_cost_total+$re_dying_multi_batch_dyes_chemical_cost_total,4); ?></th>
	                    <th width="70" id="value_total_total_per_kg_cost_multi"><? echo number_format(($mult_batch_dyes_chemical_cost_total+$re_dying_multi_batch_dyes_chemical_cost_total)/$multi_batch_qty_total,4); ?></th>
	                    <th width="">&nbsp;</th>
	                </tr>
	            </tfoot>
	        </table>
      	</div>
  	</div>
	  <div>
        <div  align="left" style="font-size:25px">Subcontract Order</div>
        <table width="3030" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>
                    <th rowspan="2" width="80">Date</th>
                    <th rowspan="2" width="100">Machine No</th>
                    <th rowspan="2" width="100">Batch No</th>
                    <th rowspan="2" width="80">File No</th>
                    <th rowspan="2" width="80">Ref. No</th>
                    <th rowspan="2" width="100">Floor Name</th>
                    <th rowspan="2" width="100">Buyer</th>
                    <th rowspan="2" width="100">Booking No</th>
                    <th rowspan="2" width="100">Job no</th>
                    <th rowspan="2" width="80">Season</th>                  
                    <th rowspan="2" width="">Style</th>
                    <th rowspan="2" width="100">Order No</th>
                    <th rowspan="2" width="100">Color Name</th>
                    <th rowspan="2" width="100">Color Range</th>
                    <th rowspan="2" width="100">Fabric Type </th>
                    <th rowspan="2" width="100">Batch Qty (Kg)</th>
                    <th colspan="4"  width="">First Dying And Finishing Cost</th>
                    <th colspan="7" width="">Subsequent Dyeing and Finishing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per Kg Cost (Tk)</th>
                    <th rowspan="2" width="100">Result</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>
                    <th width="100">Extention Batch Date</th>
                    <th width="70">Extention No</th>
                    <th width="100">Floor Name</th>
                    <th width="100">Ttl Chem Cost(Tk)</th>
                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100"><p>Re-Dye Cost per kg (Tk)</th>
                </tr> 
            </thead>
        </table>
        <div style="width:3050px; max-height:400px;  overflow-y:scroll" id="scroll_body">
	        <table width="3030" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_id" >
	            <tbody>
			       	<?
				    //echo "<pre>";
					//print_r($issue_single_batch_arr);die;
					$tot_main_batch_weight=0;
					foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
						
							if($i%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
							$all_po_id=explode(",",$po_break_down_id_arr[$batch_description_arr[$b_id]['booking_no']]);
							$po_number_data="";
							$job_no_data="";$file_no="";$ref_no="";
							foreach($all_po_id as $p_id) // $po_number_arr[$row[csf('id')]]['po_no']
							{
								if($po_number_data!="") $po_number_data.=",".$po_number_arr[$p_id]['po_no'];	 else $po_number_data=$po_number_arr[$p_id]['po_no'];
								if($job_no_data!="") $job_no_data.=",".$po_number_arr[$p_id]['job'];	 else $job_no_data=$po_number_arr[$p_id]['job'];
								if($season_data!="") $season_data.=",".$season_name_arr[$po_number_arr[$p_id]['season']];	 else $season_data=$season_name_arr[$po_number_arr[$p_id]['season']];
								if($file_no!="") $file_no.=",".$po_number_arr[$p_id]['file_no'];	 else $file_no=$po_number_arr[$p_id]['file_no'];
								if($ref_no!="") $ref_no.=",".$po_number_arr[$p_id]['ref_no'];	 else $ref_no=$po_number_arr[$p_id]['ref_no'];
							} 
							$color_range_id=$batch_description_arr[$b_id]['color_range'];
							$file_cond=implode(", ",array_unique(explode(",",$file_no)));
							$ref_cond=implode(", ",array_unique(explode(",",$ref_no)));
							if($batch_description_arr[$b_id]['without_order']==1 && $ref_cond=="")
							{
							$ref_cond=$sample_booking_ref_no_arr[$batch_description_arr[$b_id]['booking_no']];
							}
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="30"><? echo $i; ?></td>								
				                <td width="80"><? echo change_date_format($batch_description_arr[$b_id]['batch_date']); ?></td>
				                <td width="100"><p><? echo $machine_name_arr[$b_id]; ?></p></td>                                 
				                <td width="100"><p><A href="##"  onClick="subprocess_fabric_dtls('<? echo $b_id; ?>','<? echo $batch_arr[$b_id]; ?>','subprocess_fabrics_dtls_popup')"><p><? echo $batch_arr[$b_id]; ?></p></A><? //echo $batch_arr[$b_id]; ?></p></td>
				                <td width="80"><p><? echo $file_cond; ?></p></td>
				                <td width="80" title="PO/Sample Ref no"><p><? echo $ref_cond; ?></p></td>
				                <td width="100"><p><? echo $floor_arr[$b_id]; ?></p></td> 
				                <?
				                if($batch_description_arr[$b_id][entry_form]==36)
				                {
					                ?>
					                <td width="100"><p><? echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][party_id]))); ?></p></td> 
					                <td width="100"><p><? // echo $b_id; ?></p></td>
					                <td width="100" align="center"><p>
					                <? 
				                     echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                 <td width="80" align="center"><p>
					                <? 
				                     //echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                <td width="100" align="center"><p> <? echo   implode(",",array_unique(explode(",",$sub_con_arr[$b_id][cust_style_ref]))); ?></p></td>
					                <td width="100" align="center"><p> <? echo implode(",",array_unique(explode(",",$sub_con_arr[$b_id][order_no]))); ?></p></td>
				                	<?
				                }
				                else
				                {
					                ?>
					                <td width="100"><p><? 
					                if($batch_description_arr[$b_id]['without_order']==1) $buyerName=$non_buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];else $buyerName=$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
					                <td width="100"><p><? echo $batch_description_arr[$b_id]['booking_no']; ?></p></td>
					                <td width="100" align="center"><div style="word-break:break-all">
					                <?
					                echo implode(", ",array_unique(explode(",",$job_no_data)));
					                ?></div></td>
					                <td width="80" align="center"><div style="word-break:break-all">
					                <? 
					                
					                echo implode(", ",array_unique(explode(",",$season_data)));

					                ?></div></td>
					                <td width="" align="center"><div style="word-break:break-all"> 
					                <? 
					                $style_no=array();
					                foreach(array_unique(explode(",",$job_no_data)) as $j_no)
					                {
					                    if($style_no!="")  $style_no[]=$style_library[$j_no];
					                }
					                echo implode(", ",array_unique($style_no)); ?></div></td>
					                <td width="100" align="center"><div style="word-break:break-all"> <? echo implode(", ",array_unique(explode(",",$po_number_data))); ?></div></td>
					                <?	
				                }
				                ?>
				                <td width="100" align="center"><div style="word-break:break-all"><? echo $color_arr[$batch_description_arr[$b_id]['color_id']]; ?></div></td> 
				                <td width="100" align="center"><p><? echo $color_range[$color_range_id]; ?></p></td> 
				                <td width="100" align="center"><p><? echo $fabric_type_for_dyeing[$fabric_type_arr[$b_id]['fabric_type']]; //$fabric_type_for_dyeing?></p></td> 
				                <td width="100" align="right"><p>
				                <? echo $batch_description_arr[$b_id]['batch_weight']; $total_batch_weights+=$batch_description_arr[$b_id]['batch_weight'] ;?>
				                </p></td> 
				                <?
				                
				                $first_chemi_cost=$first_dyeing_cost=0;
				                if($non_reding_batch_id[$b_id]!="")
				                {
				                    $first_chemi_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                    $first_dyeing_cost=$dyes_chemical_arr[$b_id][6]['chemical_cost'];
									$tot_main_batch_weights+=$batch_description_arr[$b_id]['batch_weight'];
				                }
				                
				                ?>
				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($first_chemi_cost,4,".",""); 
				                 $total_chemical_costs+=$first_chemi_cost;
				                 ?>
				                </p></td>
				                <td width="100" align="right"><p>
				                <?  
				                    echo number_format($first_dyeing_cost,4,".",""); 
				                    $total_dyes_costs+=$first_dyeing_cost; 
				                ?>
				                </p></td>
				                <td width="100" align="right"><p><A href="##"  onClick="fn_1st_batch('<? echo $b_id; ?>','1st_batch_dtls_popup')">
				                <?
				                 $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
				                  echo number_format($batch_chemical_price,4,".","");
				                  $total_batch_chemical_prices+=$batch_chemical_price;
				                ?>
				                </A></p></td>
				                <td width="100" align="right"><p><? echo number_format($batch_chemical_price/$batch_description_arr[$b_id]['batch_weight'],4,".",""); $tot_total_receive+=$totalReceive; ?></p></td>
				                <td width="100" align="right"><p>
				                <? 
				                $extension_no="";
				                $re_batch_date="";
				                $batch_date=explode(",", $redying_details_arr[$b_id]['batch_date']);	
				                foreach($batch_date as $ash_date)
				                {
				                 if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                }
				                echo $re_batch_date;
				                 ?></p></td>
				                <td width="70" align="right"><p>
				                <?		                
				                //echo $redying_details_arr[$b_id]['id'].jahid;
				                if(trim($redying_details_arr[$b_id]['id']))
				                {
				                    $re_dying_id_all=explode(",",$redying_details_arr[$b_id]['id']);
				                    //$re_dying_chemical_cost=0;
				                    //$re_dying_dyes_cost=0;
				                    //$re_dying_dyes_chemical_cost=0;
				                    
				                    $result_id="";
				                    $result_id_last='';
				                    
				                    foreach($re_dying_id_all as $ash_id)
				                    {
				                    //$re_dying_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                    //$re_dying_dyes_cost+=$dyes_chemical_arr[$ash_id][6]['chemical_cost']	;	
				                    //$re_dying_dyes_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][6]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                        
				                     if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                     //if($re_floor!="") $re_floor.=",".$floor_arr[$ash_id]; else $re_floor=$floor_arr[$ash_id];
				                    /* echo $ash_id.tipu;
				                     $result_id=$result_arr[$ash_id];
				                     if($result_id!="")  $result_id_last=$result_id;*/
				                    }
				                }
				                //echo $b_id;
				                //if($batch_type==3)
				                //{
				                echo $redying_details_arr[$b_id]['extention_no'];	 ?>
				                
				                
				                </p></td>
				                <td width="100" align="right"><p><?
				                $re_floors='';
				                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
				                //print_r($reding_batch_id);//echo $reding_batch_id[$b_id]."##".$b_id;
				                if($reding_batch_id[$b_id]!="")
				                {
				                    $re_floors=$floor_arr[$b_id];
				                    $re_dying_chemical_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                    $re_dying_dyes_cost=$dyes_chemical_arr[$b_id][6]['chemical_cost']	;	
				                    $re_dying_dyes_chemical_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][6]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                }
				                
				                echo $re_floors;
				                ?></p></td>
				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($re_dying_chemical_cost,4,".",""); 
				                 $tot_re_dying_chemical_costs+=$re_dying_chemical_cost;
				                 ?>
				                 </p></td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_dyes_cost,4,".",""); $tot_re_dying_dyes_costs+=$re_dying_dyes_cost;  ?></p></td>
				                <td width="100" align="right"><A href="##"  onClick="fn_total_batch('<? echo $b_id; ?>','total_batch_dtls_popup')"><p><? echo number_format($re_dying_dyes_chemical_cost,4,".",""); $tot_re_dying_dyes_chemical_costs+=$re_dying_dyes_chemical_cost; ?></p></A></td>
				                <td width="100" align="right" title="Total Chemical And Dyes/BatchWeight"><? echo number_format($re_dying_dyes_chemical_cost/$batch_description_arr[$b_id]['batch_weight'],4,".",""); ?></td>
				                

				                <td width="100" align="right"><? echo number_format($re_dying_dyes_chemical_cost+$batch_chemical_price,4,".",""); ?></td>
				                <td width="100" align="right" title="<? echo '('.$re_dying_dyes_chemical_cost.'+'.$batch_chemical_price.')/'.$batch_description_arr[$b_id]['batch_weight']; ?>"><? echo number_format(($re_dying_dyes_chemical_cost+$batch_chemical_price)/$batch_description_arr[$b_id]['batch_weight'],4,".","");  ?></td>
				                <td width="100" align="center" title="<? echo $b_id; ?>"><? //echo $unload_result_arr[$b_id]//echo  $dyeing_result[$result_id];//
				                //echo $b_id.tipu;
			                    $result_id=$result_arr[$b_id];
			                    if($result_id!="")  $result_id_last=$result_id;
				                echo $dyeing_result[$result_id];//$dyeing_result;//$daysOnHand; ?></td>
				            </tr>
							<? 												
								 $i++; 			
						}	
					}
					?>
	            </tbody>
	      	</table>
      	</div>
       	<table width="3030" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="80">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                   <th width="80">&nbsp;</th>
                    <th width="">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="100"><? //echo number_format($total_batch_chemical_price,4).'='.$total_dyes_cost; ?></th>
                	<th width="100">Total</th>
                    <th width="100" id="value_total_batch_weight_single"><? echo number_format($total_batch_weights,4); ?></th>
                	<th width="100" id="value_total_chemical_cost_single"><? echo number_format($total_chemical_costs,4); ?></th>
                	<th width="100" id="value_total_dyeing_cost_single"><? echo number_format($total_dyes_costs,4); ?></th>
                    <th width="100" id="value_total_chemical_price_single"><? echo number_format($total_batch_chemical_prices,4); ?></th>
                    <th width="100"><? echo number_format(($total_batch_chemical_prices/$total_batch_weights),4); ?></th>
                    <th width="100"><? //echo number_format($tot_re_dying_chemical_cost,3); ?></th>
                    <th width="70"><? //echo number_format($tot_rec_return,3); ?></th>
                    <th width="100"><? //echo number_format($tot_total_issue,3); ?></th>
                    <th width="100" id="value_total_redying_chemic_oost_single"><? echo number_format($tot_re_dying_chemical_costs,4); ?></th>
                    <th width="100" id="value_total_redying_dying_cost_single"><p><? echo number_format($tot_re_dying_dyes_costs,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single"><p><? echo number_format($tot_re_dying_dyes_chemical_costs,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single_tk"><? echo number_format($tot_re_dying_dyes_chemical_costs/$total_batch_weights,4); ?></th>
                    <th width="100" id="value_total_total_cost_single"><? echo number_format($total_batch_chemical_prices+$tot_re_dying_dyes_chemical_costs,4); ?></th>
                    <th width="100" title="Main Batch Qty=<? echo number_format($tot_main_batch_weights,2);?>"><? echo number_format(($total_batch_chemical_prices/$total_batch_weights),4); ?></th>
                    <th width="100">&nbsp;</th>
                </tr>
            </tfoot>
        </table>
    </div>
    <?
    $html = ob_get_contents();
    ob_clean();
    //$new_link=create_delete_report_file( $html, 2, $delete, "../../../" );
    foreach (glob("*.xls") as $filename) {
    //if( @filemtime($filename) < (time()-$seconds_old) )
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');	
    $is_created = fwrite($create_new_doc, $html);


    $filename2=$user_id."_summary_".$name.".xls";
    $create_new_doc2 = fopen($filename2, 'w');	
    $is_created2 = fwrite($create_new_doc2, $summaryHTML);

    echo "$html****$filename****$filename2****$report_type"; 
    exit();
}

if($action=="generate_report") // Show
{ 
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if ($cbo_company_name==0) $company_id=""; else $company_id=" and a.company_id='$cbo_company_name'";
	if ($cbo_company_name==0) $company_idcond =""; else $company_idcond =" and b.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond .=""; else $company_idcond .=" and b.working_company_id='$cbo_working_name'";

	if ($cbo_company_name==0) $company_idcnd .=""; else $company_idcnd .=" and a.COMPANY_ID='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcnd .=""; else $company_idcnd .=" and a.SERVICE_COMPANY='$cbo_working_name'";

	// echo $company_idcnd;

	$from_date=str_replace("'","",$from_date);
	$to_date=str_replace("'","",$to_date);
	//echo $from_date;
	$txt_ref_no=str_replace("'","",$txt_ref_no);
	$txt_file_no=str_replace("'","",$txt_file_no);
	$txt_booking_no=str_replace("'","",$txt_booking_no);
	$txt_po_no=str_replace("'","",$txt_po_no);
	$txt_job=str_replace("'","",$txt_job);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$cbo_season_id=str_replace("'","",$cbo_season_id);
	$txt_samp_ref_no=str_replace("'","",$txt_samp_ref_no);
	$location_id=str_replace("'","",$location_id);
	$floor_id=str_replace("'","",$floor_id);
	$report_type=str_replace("'","",$report_type);
	$batch_type=str_replace("'","",$batch_type);

	// echo $batch_type

	$floor_cond_arr=array();

	if(!empty($location_id))
	{
		if(!empty($floor_id))
		{
			
			
			$sql="select  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 and b.company_id=$cbo_working_name and b.location_id=$location_id and b.production_process=3 and b.id=$floor_id";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) {
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}else{
			$sql="select  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 and b.company_id=$cbo_working_name and b.location_id=$location_id and b.production_process=3";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) {
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		$floor_cond_arr=array_unique($floor_cond_arr);
	}
	//print_r($floor_cond_arr);
	
	if(str_replace("'","",$cbo_buyer_name)==0)
	{
		if ($_SESSION['logic_erp']["data_level_secured"]==1)
		{
			if($_SESSION['logic_erp']["buyer_id"]!="") $buyer_id_cond=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")"; else $buyer_id_cond="";
		}
		else
		{
			$buyer_id_cond="";
		}
	}
	else
	{
		$buyer_id_cond=" and a.buyer_name in (".str_replace("'","",$cbo_buyer_name).")";
	}
	
	if($txt_booking_no!='') $booking_no_cond="and b.booking_no like '%$txt_booking_no%' ";else $booking_no_cond="";
	
	if($txt_file_no!='') $file_cond="and b.file_no='$txt_file_no'";else $file_cond="";
	if($txt_job!='') $job_cond="and a.job_no_prefix_num=$txt_job";else $job_cond="";
	if($txt_po_no!='') $po_cond="and b.po_number='$txt_po_no'";else $po_cond="";
	
	if($cbo_season_id!=0) $season_cond="and a.season_buyer_wise in($cbo_season_id)";else $season_cond="";
	
	if($txt_ref_no!='') $ref_cond="and b.grouping='$txt_ref_no'";else $ref_cond="";
	if($txt_samp_ref_no!='') $samp_ref_cond="and a.grouping='$txt_samp_ref_no'";else $samp_ref_cond="";
	//echo $ref_cond;
	$companyArr = return_library_array("select id,company_name from lib_company where status_active=1 and is_deleted=0","id","company_name"); 
	$supplierArr = return_library_array("select id,supplier_name from lib_supplier where status_active=1 and is_deleted=0","id","supplier_name"); 
	$color_arr=return_library_array( "select id,color_name  from  lib_color", "id", "color_name"  );
	$season_name_arr=return_library_array( "select id,season_name  from  lib_buyer_season", "id", "season_name"  );// id, season_name from lib_buyer_season
	//$batch_arr=return_library_array( "select id, batch_no from  pro_batch_create_mst", "id", "batch_no");
   // $po_number_arr=return_library_array(" select  id ,po_number from   wo_po_break_down", "id", "po_number" );
	//$job_no_arr=return_library_array(" select  id ,job_no_mst from   wo_po_break_down", "id", "job_no_mst" );
	//$po_break_down_id_arr=return_library_array( "select booking_no,po_break_down_id from  wo_booking_mst ", "booking_no", "po_break_down_id" );
 	//   $floor_arr=return_library_array("select  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0", "batch_id", "floor_name" );


    //$unload_result_arr=return_library_array("select a.batch_id, a.result from  pro_fab_subprocess a where a.entry_form=35 and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0", "batch_id", "result" );

	//$machine_name_arr=return_library_array("select  a.batch_id ,b.machine_no from   pro_fab_subprocess a, lib_machine_name b  where a.machine_id=b.id and a.entry_form in(38,35) and  b.status_active=1 and b.is_deleted=0", "batch_id", "machine_no" );

	//$buyer_name_arr=return_library_array( "select a.booking_no,b.buyer_name from  wo_booking_mst a, lib_buyer b where a.buyer_id=b.id", "booking_no", "buyer_name" );
	//$non_buyer_name_arr=return_library_array( "select a.booking_no,b.buyer_name from  wo_non_ord_samp_booking_mst a, lib_buyer b where a.buyer_id=b.id", "booking_no", "buyer_name" );
	/*$sql_book=sql_select("select a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b where a.buyer_id=b.id");
	foreach($sql_book as $row)
	{
		$buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$po_break_down_id_arr[$row[csf('booking_no')]]=$row[csf('po_break_down_id')];
	}*/
	
    $buyer_library=return_library_array( "select id,buyer_name from   lib_buyer", "id","buyer_name" );
   // $style_library=return_library_array( "select job_no,style_ref_no from   wo_po_details_master", "job_no","style_ref_no" );
	/*$po_data_subcon=sql_select("select a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0  ");
	
	$sub_con_arr=array();
	foreach($po_data_subcon as $row)
	{
		if($sub_con_arr[$row[csf('mst_id')]][cust_style_ref]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref].=",".$row[csf('cust_style_ref')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref]=$row[csf('cust_style_ref')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][order_no]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no].=",".$row[csf('order_no')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no]=$row[csf('order_no')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][subcon_job]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job].=",".$row[csf('subcon_job')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job]=$row[csf('subcon_job')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][party_id]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id].=",".$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id].=",".$row[csf('party_id')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id]=$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id]=$row[csf('party_id')];	
		}
	}*/
	//print_r($sub_con_arr[646]);die;
	
	if($db_type==0) 
	{
	$from_date=change_date_format($from_date,'yyyy-mm-dd'); $to_date=change_date_format($to_date,'yyyy-mm-dd');
	}
    if($db_type==2) 
	{
	$from_date=change_date_format($from_date,'','',1);  $to_date=change_date_format($to_date,'','',1);
	}
	//echo $from_date;
	
	
	$batch_description_arr=array();
	/* 
	if(str_replace("'","",$batch_id)!="") $batch_cond=" and b.id in(".str_replace("'","",$batch_id).")";
    else  */
	
	
	//echo $batch_cond; //die;
	//echo $batch_no; //die;
    	//echo $batch_no;
	$batch_no=implode("','",array_unique(explode(",",$batch_no)));
	
	if(str_replace("'","",$batch_no)!="") $batch_cond=" and b.batch_no in('".$batch_no."') "; 
	else $batch_cond="";
	//echo $batch_cond."shakil"; die;
	
	//
	/* and b.re_dyeing_from=0 13-11-16 according to siddique sir dicission when search buyer order or subcontract all batch appear */
	if($batch_type==0)
	$search_field_cond_batch="and b.entry_form in (0,36) and b.re_dyeing_from=0";
	else if($batch_type==1)
	$search_field_cond_batch="and b.entry_form=0 ";
	else if($batch_type==2)
	$search_field_cond_batch="and b.entry_form=36";
	else 
	$search_field_cond_batch="and b.entry_form in(0,36) and b.batch_against in(2) and  b.re_dyeing_from!=0 ";
	//$redyeing="and b.batch_against in(2)";
	//echo  $search_field_cond_batch;die;
	if($from_date!="" && $to_date!="")
	{
		$date_cond_samp="";$date_cond_po="";
		if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond_samp=" and b.batch_date between '".$from_date."' and '".$to_date."'";
			$date_cond_po=" and d.batch_date between '".$from_date."' and '".$to_date."'";
		}
	}
	
	 $sql_po=("select a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b,pro_batch_create_dtls c,pro_batch_create_mst d  where a.id=b.job_id and b.id=c.po_id and d.id=c.mst_id and   b.status_active=1 and b.is_deleted=0 and  c.status_active=1 and c.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond $date_cond_po");
	 
	$res_po=sql_select($sql_po);
	$all_po_id='';
	foreach($res_po as $row) //$job_no_arr
	{
		$po_number_arr[$row[csf('id')]]['po_no']=$row[csf('po_number')];
		$po_number_arr[$row[csf('id')]]['ref_no']=$row[csf('ref_no')];
		$po_number_arr[$row[csf('id')]]['file_no']=$row[csf('file_no')]; 
		$po_number_arr[$row[csf('id')]]['season']=$row[csf('season_buyer_wise')]; 
		$po_number_arr[$row[csf('id')]]['job']=$row[csf('job_no_mst')];
		$job_no_arr[$row[csf('id')]]=$row[csf('job_no_mst')];
		$style_library[$row[csf('job_no_mst')]]=$row[csf('style_ref_no')];
		if($all_po_id=="") $all_po_id=$row[csf('id')]; else $all_po_id.=",".$row[csf('id')]; //echo $all_po_id;

		$po_idArr[$row[csf('id')]]=$row[csf('id')];
	}
	$con = connect();
	//execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id." and ref_from in (1,2,3) and ENTRY_FORM=48");
	execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id." and ref_from in (1,2,3,4,5,6,7,8) and ENTRY_FORM=48");
	oci_commit($con);
	disconnect($con);
	//echo $all_po_id;
	if($txt_file_no!='' || $txt_ref_no!='' ||  $txt_po_no!='' || $txt_job!='' || $cbo_buyer_name>0)
	{
		if($all_po_id!="") $po_idd="and po_id in($all_po_id)";else $po_idd="and po_id in(0)";
		//echo $po_idd;
		//echo "select LISTAGG(CAST( mst_id  AS VARCHAR(4000)), ',') WITHIN GROUP (ORDER BY mst_id) as batch_id from pro_batch_create_dtls where status_active=1 and is_deleted=0 $po_idd";
		/*if($db_type==0) $group_con="group_concat(mst_id) as batch_id";
		else  $group_con="LISTAGG(CAST( mst_id  AS VARCHAR(4000)), ',') WITHIN GROUP (ORDER BY mst_id) as batch_id";
		$batch_ids=return_field_value("$group_con","pro_batch_create_dtls","status_active=1 and is_deleted=0 $po_idd","batch_id");
		if($batch_ids!="") $batch_id_cond="and b.id in($batch_ids)"; else $batch_id_cond="";	*/	
		$poIds=chop($all_po_id,','); $po_cond_for_in="";
		$po_ids=count(array_unique(explode(",",$all_po_id)));
		if($db_type==2 && $po_ids>1000)
		{
			$po_cond_for_in=" and (";
			$poIdsArr=array_chunk(explode(",",$poIds),999);
			foreach($poIdsArr as $ids)
			{
				$ids=implode(",",$ids);
				$po_cond_for_in.=" po_id in($ids) or"; 
			}
			$po_cond_for_in=chop($po_cond_for_in,'or ');
			$po_cond_for_in.=")";
		}
		else
		{
			$po_cond_for_in=" and po_id in($poIds)";
			
		}
		
		fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 1, $po_idArr, $empty_arr);//PO ID Ref from=1
		//fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 2, $trim_batch_idArr, $empty_arr);//Batch ID Ref from=2

		//echo "select mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in";die;
		//$sql_batch=sql_select("select mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in");
		$sql_batch=sql_select("SELECT b.mst_id as batch_id from pro_batch_trims_dtls b,gbl_temp_engine g   where  b.mst_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=1 and g.entry_form=48 and b.status_active=1 and b.is_deleted=0 ");
		 $all_batch_id='';
		foreach($sql_batch as $row) 
		{
			if($all_batch_id=="") $all_batch_id=$row[csf('batch_id')]; else $all_batch_id.=",".$row[csf('batch_id')];
		}
			$all_batch_ids=implode(",",array_unique(explode(",",$all_batch_id)));
		//echo $all_batch_ids; 
		$batch_ids_cond="";
		if($all_batch_ids!="") 
		{
			//echo $po_id=substr($po_id,0,-1);
			if($db_type==0) { $batch_ids_cond="and b.id in(".$all_batch_ids.")"; }
			else
			{
				$bat_id=array_unique(explode(",",$all_batch_ids));
				if(count($bat_id)>1000)
				{
					$batch_ids_cond="and (";
					$bat_id=array_chunk($bat_id,1000);
					$z=0;
					foreach($bat_id as $id)
					{
						$id=implode(",",$id);
						if($z==0) $batch_ids_cond.=" b.id in(".$id.")";
						else $batch_ids_cond.=" or b.id in(".$id.")";
						$z++;
					}
					$batch_ids_cond.=")";
				}
				else { 
				
				$batch_ids_cond=" and b.id in(".$all_batch_ids.")"; }
			}
		}
	}
	//print_r($batch_ids);die;
	 
	$samp_non_booking=sql_select("select b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no_id=a.id and a.booking_type=4  $company_idcond $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

	//echo "select b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.buyer_name from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";die;
	$all_batch_id_samp="";
	foreach($samp_non_booking as $row)
	{
		$non_buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$non_buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$sample_booking_ref_no_arr[$row[csf('booking_no')]]=$row[csf('grouping')];
		if($txt_samp_ref_no!='')
		{
		if($all_batch_id_samp=="") $all_batch_id_samp=$row[csf('batch_id')]; else $all_batch_id_samp.=",".$row[csf('batch_id')];
		}
	}
	if($all_batch_id_samp!="") $all_batch_id_samp_cond="and b.id in($all_batch_id_samp)";else $all_batch_id_samp_cond="";
	//echo $all_batch_id_samp_cond.'X';
	
    if($from_date!="")
    {
		if(str_replace("'","",$cbo_value_with)==1)
		{
			$date_cond=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";

			$sql=sql_select("SELECT b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
			and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");

			if($batch_type==2){

			$sql=sql_select("SELECT b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
			and a.entry_form in (38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0  $company_idcnd $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");

			}
		
		}
		else if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond=" and b.batch_date between '".$from_date."' and '".$to_date."'";
			$sql=sql_select("select b.id,b.batch_no,b.booking_without_order,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
			from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
			//echo "select b.id,b.batch_no,b.booking_without_order,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";die;
		}
   	}
   	else
   	{
		$sql=sql_select("select b.id,b.booking_without_order,b.batch_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
		from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0 $company_idcond $batch_cond $batch_ids_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
   	}
	/*echo "select b.id,b.booking_without_order,b.batch_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
	from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0 $company_idcond $batch_cond $batch_ids_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";die;*/
  	//echo $sql;die;
  	$reding_batch_id=$non_reding_batch_id=array();
    foreach($sql as $row)
	{
		if($row[csf("batch_against")]==2)
		{
			$reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
		else
		{
			$non_reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
		 
		$issue_single_batch_arr[$row[csf("id")]]=$row[csf("id")];  
		$batch_id_arr[]=$row[csf("id")]; 
		$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
		$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
		$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
		$batch_description_arr[$row[csf("id")]]['batch_weight']=$row[csf("batch_weight")];
		$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
		$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
		$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
		$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
		$batch_no_arr[]="'".$row[csf("batch_no")]."'";
		$batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
	}
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 2, $batch_id_arr, $empty_arr);//Batch ID Ref from=2
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 3, $issue_single_batch_arr, $empty_arr);//Batch ID Ref from=2
	//print_r($batch_id_arr);
	//$batchIdCond=where_con_using_array($batch_id_arr,0,'a.batch_id');
	//$batchIdCond_subcon=where_con_using_array($batch_id_arr,0,'a.mst_id');
	$po_data_subcon=sql_select("select a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	subcon_ord_mst c,gbl_temp_engine g where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.mst_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0 ");
	 
	
	$sub_con_arr=array();
	foreach($po_data_subcon as $row)
	{
		if($sub_con_arr[$row[csf('mst_id')]][cust_style_ref]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref].=",".$row[csf('cust_style_ref')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref]=$row[csf('cust_style_ref')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][order_no]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no].=",".$row[csf('order_no')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no]=$row[csf('order_no')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][subcon_job]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job].=",".$row[csf('subcon_job')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job]=$row[csf('subcon_job')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][party_id]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id].=",".$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id].=",".$row[csf('party_id')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id]=$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id]=$row[csf('party_id')];	
		}
	}
	
	 
	$date_cond2=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";
	$fabric_sql=sql_select("select b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
	from pro_fab_subprocess  a,pro_batch_create_mst b,gbl_temp_engine g  where  a.batch_id=b.id and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48
	and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 $company_idcond ");
 	
  	$fabric_type_arr=array();
    foreach($fabric_sql as $row)
	{
	 	$fabric_type_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
	}
	unset($fabric_sql);
	/* echo "<pre>";
	print_r($reding_batch_id);
	echo "<pre>";
	print_r($non_reding_batch_id);die;*/
	//	***************************************************************************************************************************************************
     $batch_id_sql=implode(",",$batch_id_arr);
    if($batch_id_sql=="") $batch_id_sql=0;
	//echo  $batch_id_sql;
  	if($batch_type==3)
	{
		//$re_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond2=chop($re_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond2.=")";
		}
	}
	else
	{
		//$re_dying_cond=" and b.re_dyeing_from in(".$batch_id_sql.")";	
		//$pord_ids = explode(",",$txt_product_id);
		//echo count($pord_ids);die;
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond=chop($re_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond.=")";
		}
	}
	if($db_type==0)
	{
		if($batch_type==3)
		{
		 $sql_redying=sql_select("select b.id as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0 group by  b.id");
		}
		else
		{
			 $sql_redying=sql_select("select group_concat(b.id) as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0  $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0 group by  b.re_dyeing_from");	
		}
	}
	else
	{
	
		if($batch_type==3)
		{	
			//  $sql_redying=sql_select("select b.id as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no
			//   from  pro_batch_create_mst  b 
			//   where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0  group by  b.id");
			$sql_redying=sql_select("SELECT b.id as id, b.batch_date as batch_date, b.extention_no as extention_no
			   from  pro_batch_create_mst  b ,gbl_temp_engine g
			   where  b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and b.re_dyeing_from!=0 $company_idcond  and b.status_active=1 and b.is_deleted=0  ");
		}
		else
		{
			//  $sql_redying=sql_select("select listagg((b.id),',') within group (order by b.id) as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no,b.re_dyeing_from 
			//  from  pro_batch_create_mst b 
			//  where b.re_dyeing_from!=0   $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0  group by  b.re_dyeing_from");
			$sql_redying=sql_select("SELECT  b.id as id, b.batch_date as batch_date, b.extention_no as extention_no,b.re_dyeing_from 
			from  pro_batch_create_mst b ,gbl_temp_engine g
			where  b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and b.re_dyeing_from!=0   $company_idcond  and b.status_active=1 and b.is_deleted=0  ");
		}
	}
	
   	//and b.batch_against=2
    $redying_details_arr=array();
    foreach($sql_redying as $re_row)
    {
		if($batch_type==3)
		{
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['id']=$re_row[csf("id")];
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['batch_date']=$re_row[csf("batch_date")];
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['extention_no']=$re_row[csf("extention_no")];
		}
		else
		{
			
			
			$redying_details_arr[$re_row[csf("id")]]['id']=$re_row[csf("id")];
			$redying_details_arr[$re_row[csf("id")]]['batch_date']=$re_row[csf("batch_date")];
			$redying_details_arr[$re_row[csf("id")]]['extention_no']=$re_row[csf("extention_no")];
		}
    }
	
	//echo "<pre>"; print_r($redying_details_arr);die;
	if($batch_type==3)
	{
		//$all_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$all_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$all_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$all_dying_cond2=chop($all_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$all_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$all_dying_cond2.=")";
		}
	}
	else
	{
		if(count($batch_id_arr)>0)
		{
			$all_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$all_dying_cond.=" b.id in(".implode(",",$batch_id).") or";
				}
				$all_dying_cond=chop($all_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$all_dying_cond.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$all_dying_cond.=")";
		}
	}
	
	if($batch_type==3)
	{
		// $result_sql=sql_select("select a.result,a.batch_id 
		// from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2   $company_idcond $all_dying_cond2 and a.status_active=1 and a.is_deleted=0");	
		$result_sql=sql_select("SELECT a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b,gbl_temp_engine g where b.id=a.batch_id and b.id=g.ref_val and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48  and a.entry_form in (35,38) and a.load_unload_id=2   $company_idcond  and a.status_active=1 and a.is_deleted=0");	
	}
	else
	{
		// $result_sql=sql_select("select a.result,a.batch_id 
		// from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2  $company_idcond $all_dying_cond and a.status_active=1 and a.is_deleted=0");
		$result_sql=sql_select("SELECT a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b,gbl_temp_engine g where b.id=a.batch_id and b.id=g.ref_val and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and a.entry_form in (35,38) and a.load_unload_id=2  $company_idcond  and a.status_active=1 and a.is_deleted=0");
	}
	
	/*$sql_result=sql_select("select a.result,a.batch_id from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2  and a.company_id=$cbo_company_name and b.re_dyeing_from in (".$batch_id_sql.") and a.status_active=1 and a.is_deleted=0");*/
	
	$result_arr=array();
	foreach($result_sql as $value)
	{
		$result_arr[$value[csf('batch_id')]]=$value[csf('result')];	
	}
	 unset($result_sql);
	//$batchIdCond=where_con_using_array($batch_id_arr,0,'a.batch_id');
	$batchIdCond_mst=where_con_using_array($batch_id_arr,0,'c.id');
	
	// $floor_arr=return_library_array("select  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 $batchIdCond", "batch_id", "floor_name" );
	// $machine_name_arr=return_library_array("select  a.batch_id ,b.machine_no from   pro_fab_subprocess a, lib_machine_name b  where a.machine_id=b.id and a.entry_form=35 and  b.status_active=1 and b.is_deleted=0 $batchIdCond", "batch_id", "machine_no" );
	$floor_arr=return_library_array("SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b,gbl_temp_engine g  where a.floor_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0 ", "batch_id", "floor_name" );
	$machine_name_arr=return_library_array("SELECT  a.batch_id ,b.machine_no from   pro_fab_subprocess a, lib_machine_name b,gbl_temp_engine g  where a.machine_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and a.entry_form in(38,35) and  b.status_active=1 and b.is_deleted=0  ", "batch_id", "machine_no" );
	
	// $sql_book=sql_select("select a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c where a.booking_type in(1,4) and a.buyer_id=b.id and a.id=c.booking_no_id and a.status_active=1 and c.status_active=1 $batchIdCond_mst");
	$sql_book=sql_select("SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c,gbl_temp_engine g where a.buyer_id=b.id and a.id=c.booking_no_id and c.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 ");
	foreach($sql_book as $row)
	{
		$buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$po_break_down_id_arr[$row[csf('booking_no')]]=$row[csf('po_break_down_id')];
	}
	unset($sql_book);
	
	if ($cbo_working_name==0) $company_issue_idcnd =""; else $company_issue_idcnd =" and a.KNIT_DYE_COMPANY='$cbo_working_name'";
	if ($cbo_company_name==0) $company_id_issue=""; else $company_id_issue=" and a.company_id='$cbo_company_name'";
    $sql_dyes_cost =sql_select("SELECT a.batch_no as BATCH_NO,b.item_category as ITEM_CAT,(b.cons_amount) as COST
    from inv_issue_master a, inv_transaction b
    where a.id=b.mst_id and b.transaction_type=2 and a.entry_form=5 and a.batch_no  is not null  and   b.item_category in (5,6,7) $company_id_issue $company_issue_idcnd");
	
	$dyes_chemical_arr=array();

	foreach($sql_dyes_cost as $val)
	{
		$dyes_chemical_arr[$val["BATCH_NO"]][$val["ITEM_CAT"]]['chemical_cost']+=$val["COST"];
		$batch_wise_no_arr[$val["BATCH_NO"]]=$val["BATCH_NO"];
		//$issue_id_arr[$val["ISSUE_ID"]]=$val["ISSUE_ID"];
	}
	 
	//**************************************************************************************************
	if($db_type==0)
	{
		//$sql_dtls =sql_select("select batch_no from inv_issue_master  where  entry_form=5 and status_active=1 and is_deleted=0 and batch_no<>''");
	}
	else
	{
		//$sql_dtls =sql_select("select batch_no from inv_issue_master  where  entry_form=5 and status_active=1 and is_deleted=0 and batch_no is not null");
	}
	
	//echo "select batch_no from inv_issue_master  where  entry_form=5 and status_active=1 and is_deleted=0 and batch_no is not null"; die;

	$multi_single_batch=array(); $issue_single_batch_arr=array();
	foreach($batch_wise_no_arr as $batchNos=>$inf)
	{
		if(strpos($batchNos, ",")==true)
		{
			//echo "=";
			$multi_batch_id=explode(",",$batchNos);
			$total_batch_id=count($multi_batch_id);
			$batch_match=0;
			foreach($multi_batch_id as $m_batch)
			{ 
				if(in_array($m_batch,$batch_id_arr)) {$issue_multi_batch_temp_arr[]=$m_batch;  $batch_match+=1;  }
				//$issue_single_batch_arr[$m_batch]=$m_batch;
			}
			if($batch_match==$total_batch_id) 
			{
				//echo "+";
				$issue_multi_batch_arr[]=$batchNos; 
				$multi_single_batch=array_merge($multi_single_batch, $issue_multi_batch_temp_arr); 
			}
		}
		else
		{
			//echo "||";
			if(in_array($batchNos,$batch_id_arr)) { $issue_single_batch_arr[$batchNos]=$batchNos;  } 
		}
	}
	
	$sql_req1 = "SELECT a.ID,b.mst_id as REQ_ID,a.batch_id as BATCH_ID,a.BATCH_QTY,a.BATCH_QTY,a.NEW_BATCH_WEIGHT,a.ENTRY_FORM,c.batch_id as RE_BATCH_ID from pro_recipe_entry_mst a, dyes_chem_requ_recipe_att b,dyes_chem_issue_requ_mst c,gbl_temp_engine g where b.recipe_id=a.id  and c.id=b.mst_id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 ";
	// echo $sql_req1;die; 
	$res_sql_req1 = sql_select($sql_req1);
	$req_id_array = array();
	foreach ($res_sql_req1 as $val) 
	{
		//$req_id_array2[$val['REQ_ID']] .= $val['REQ_ID'].',';
		$req_id_array[$val['REQ_ID']] = $val['REQ_ID'];
	}
	unset($res_sql_req1);
	// print_r($fin_recipe_from_array);
	
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 4, $req_id_array, $empty_arr);//Req ID Ref from=4

	$issue_sql1 = sql_select("SELECT a.MST_ID ,a.REQUISITION_NO,b.BATCH_NO,a.ITEM_CATEGORY,a.PROD_ID,a.CONS_QUANTITY,a.CONS_AMOUNT,c.SUB_PROCESS from inv_transaction a,inv_issue_master b,dyes_chem_issue_dtls c, gbl_temp_engine g where a.mst_id=b.id and c.mst_id=b.id and a.id=c.trans_id and a.REQUISITION_NO=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=4 and g.entry_form=48 and b.entry_form=5 and b.is_deleted=0 and b.status_active=1 and a.status_active=1 and a.transaction_type=2 and c.status_active=1   ");//$w_company_idcond2
	$issue_id_arr = array();$tot_issueQty=0;  
	foreach ($issue_sql1 as $val) 
	{
		 
		$batchArr=array_filter(array_unique(explode(",",$val['BATCH_NO'])));
		foreach($batchArr as $bid)
		{
			$sub_processId=$val['SUB_PROCESS']; //92 Finishing process

			$issue_item_cat_arr[$bid][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['ITEM_CATEGORY'];
			if($bid!='')
			{
			$batch_all_id_array[$bid]= $bid;
			$batch_req_id_array[$bid].= $val['REQUISITION_NO'].',';
			}
		}
		$fin_recipe_from=$fin_recipe_from_array[$val['REQUISITION_NO']];
		if($fin_recipe_from==468 || $fin_recipe_from==445 )
		{
			//$issue_item_cat_cost_fin_arr[$val['REQUISITION_NO']][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['CONS_QUANTITY'];
			//$issue_item_cat_cost_dtls_fin_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_QUANTITY'];
			$issue_item_cat_amt_dtls_fin_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_AMOUNT'];
		}
		else 
		{
			//$issue_item_cat_cost_arr[$val['REQUISITION_NO']][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['CONS_QUANTITY'];
			//$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_QUANTITY'];
			$issue_item_cat_amt_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_AMOUNT'];
		}
		$ReqBatch_id_arr[$val['REQUISITION_NO']] = $val['BATCH_NO'];
		$issue_id_arr[$val['MST_ID']] = $val['MST_ID'];
		$tot_issueQty+=$val['CONS_QUANTITY'];
		
	}

	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 5, $batch_all_id_array, $empty_arr);//Batch ID Ref from=5 
	

	$batch_fabric_sql1=sql_select("SELECT b.id,b.batch_no,b.batch_weight, b.batch_against
	from pro_recipe_entry_mst  a,pro_batch_create_mst b,gbl_temp_engine g where  a.batch_id=b.id and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=5 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0" );
	 
	$batch_wgt_arr=array();
	foreach ($batch_fabric_sql1 as $row) 
	{
		//$batch_req_id=$batch_req_id_array2[$row[csf("id")]];
		//echo $batch_req_id.'d';
		$batch_wgt_arr[$row[csf("id")]]['batchWgt']=$row[csf("batch_weight")];
	}
	

	$company_cond = str_replace("a.company_id", "c.company_id", $company_id);	
	if ($cbo_working_name==0) $wo_company_idcond =""; else $wo_company_idcond =" and p.working_company_id='$cbo_working_name'";
	//echo "#aaa";die;
	// $batchCond = implode(",", $batchIdArr);dose_base
	$sql = "(SELECT p.id as recipe_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,a.avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no,c.batch_against,c.double_dyeing, a.id, a.item_category_id, a.item_group_id, a.sub_group_name, a.item_description, a.item_size,a.current_stock, a.unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
	from pro_recipe_entry_mst p, product_details_master a, pro_recipe_entry_dtls b,pro_batch_create_mst c,gbl_temp_engine g 
	where p.id=b.mst_id and a.id=b.prod_id and p.batch_id=c.id  and c.id=g.ref_val  and p.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and b.ratio>0  and b.status_active=1 and b.is_deleted=0 $company_cond $wo_company_idcond and a.item_category_id in(5,6,7,23) and a.status_active=1 and a.is_deleted=0  and p.entry_form in(59,60)) 
	union 
	(
	SELECT p.id as recipe_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,0 as avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, c.batch_against,c.double_dyeing,b.prod_id as id, null as item_category_id, null as item_group_id, null as sub_group_name, null as item_description, null as item_size,null as current_stock, null as unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
	from pro_recipe_entry_mst p, pro_recipe_entry_dtls b,pro_batch_create_mst c,gbl_temp_engine g  
	where p.id=b.mst_id and p.batch_id=c.id and c.id=g.ref_val and p.batch_id=g.ref_val  and p.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and b.status_active=1 and b.is_deleted=0 $wo_company_idcond  and b.status_active=1 and b.is_deleted=0 and b.prod_id=0 and b.sub_process_id in(93,94,95,96,97,98) and p.status_active=1 and p.is_deleted=0  and p.entry_form in(59,60))  order by sub_seq,seq_no";
	  //echo $sql;die();
	$costDataArr = array();
	$res = sql_select($sql);
	$tot_recCost=0;$tot_issue_qty=0;
	foreach ($res as $row) 
	{
		$current_stock = $row[csf('current_stock')];
		$item_category_id = $row[csf('item_category_id')];
		$recipe_type = $row[csf('recipe_type')];
		$batch_againstId = $row[csf('batch_against')];
		$double_dyeingId = $row[csf('double_dyeing')];
		$dose_baseId = $row[csf('dose_base')];
		$surplus_solution = $row[csf('surplus_solution')];
		$pickup = $row[csf('pickup')];$entry_form = $row[csf('entry_form')];
		$batch_wgt = $row[csf('batch_qty')];//pickup,p.batch_qty
		$current_stock_check=number_format($current_stock,7,'.','');
		//(Batch weight*Pick Up/100)+Surplus Solution;
		$total_solution=($batch_wgt*$pickup/100)+$surplus_solution;
		
		$ratio = $row[csf('ratio')];
		 if($entry_form==59)
		 {
			$BatchRecipeNo_arr[$row[csf('batch_id')]]['main_recipe'].=$row[csf('recipe_id')].',';
		 }
		 if($entry_form==60)
		 {
			$BatchRecipeNo_arr[$row[csf('batch_id')]]['addTopping_recipe'].=$row[csf('recipe_id')].',';
		 }
		 if($item_category_id==6)
		 {
			$BatchRecipeNo_arr[$row[csf('batch_id')]]['ratio']+=$row[csf('ratio')];
		 }
		$batch_req_id=rtrim($batch_req_id_array[$row[csf('batch_id')]],',');
		$batch_req_idArr=array_unique(explode(",",$batch_req_id_array[$row[csf('batch_id')]]));
		//echo $batch_req_id.'D';
		$tot_batch_wgt=$batch_wgt_array[$row[csf('batch_id')]];
		//echo  $tot_batch_wgt.'D';
		$batch_qty=$row[csf('batch_qty')];
		if($issue_item_cat_arr[$row[csf('batch_id')]][$row[csf('prod_id')]][$row[csf('item_category_id')]])
		{
			//echo $recipe_qnty.'='.$row[csf('avg_rate_per_unit')].'<br>';
			//$issue_qty=0;
			foreach($batch_req_idArr as $req_id)
			{
				if($issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=='')
				{	
					$issue_qty+=$issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
					$reqIdArr[$req_id]=$req_id;
					$tot_issue_qty+=$issue_qty;
					$issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=111;
				}
				
			}
			
			$issue_perKg=($issue_qty/$tot_batch_wgt);
			$issue_wgt_per=$issue_perKg*$batch_qty;
		
			
		//$costDataArr[$row[csf('batch_id')]][$row[csf('item_category_id')]] +=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
		$ReqIdArr[$row[csf('batch_id')]].=$batch_req_id.','; 
	
		// $categryDataArr[$row[csf('batch_id')]].=$row[csf('item_category_id')].',';
		// $tot_recCost+=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
		}
	}

	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 6, $issue_id_arr, $empty_arr);//Batch ID Ref from=5  
	
	$rcv_sql =  "SELECT c.batch_no as BATCH_NO, b.prod_id as PROD_ID,b.item_category as ITEM_CATEGORY ,sum(b.cons_amount) as ISSUE_RETURN_AMNT,sum(b.cons_quantity) as ISSUE_RETURN_QTY FROM inv_receive_master a, inv_transaction b ,gbl_temp_engine g  ,INV_ISSUE_MASTER c
	WHERE a.id=b.mst_id and  b.issue_id=g.ref_val and  g.ref_val=c.id and g.user_id = ".$user_id." and g.ref_from=6 and g.entry_form=48  and b.item_category  in(5,6,7) and a.entry_form=29 and b.transaction_type=4 group by c.batch_no,b.prod_id,b.item_category";
    $rcv_result = sql_select($rcv_sql);
	//echo $rcv_sql;
	$return_qty_arr=array();
	foreach($rcv_result as $row)
	{
		$return_qty_arr[$row['BATCH_NO']][$row['ITEM_CATEGORY']]['qty'] = $row['ISSUE_RETURN_QTY'];
		$return_qty_arr[$row['BATCH_NO']][$row['ITEM_CATEGORY']]['amnt'] = $row['ISSUE_RETURN_AMNT'];
	}
	

	$con = connect();
	execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id." and ref_from in (1,2,3) and ENTRY_FORM=48");
	oci_commit($con);
	disconnect($con);

	$i=1;$j=1;
	ob_start();	
	?>
	<div id="" align="center" style="height:auto; width:auto; margin:0 auto; padding:0;">
		<? $summaryHTML='<div id="summary_part" style="width:1460px;">
        <table width="2060px" cellpadding="0" cellspacing="0" id="caption" align="center">
            <thead>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:16px; font-weight:bold" >'.$report_title.'</td 
                ></tr>
                <tr style="border:none;">
                    <td colspan="24" class="form_caption" align="center" style="border:none; font-size:14px;">
                       <b>Company Name : '.$companyArr[$cbo_company_name].'</b>                               
                    </td>
                </tr>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:12px; font-weight:bold">
					'."Date: ". change_date_format($from_date).' To '. change_date_format($to_date).'
					</td>
                </tr>
            </thead>
        </table>
 		
        <div  align="left" style="font-size:25px">Summary Part</div>
        <table align="left" width="1440" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>

                    <th rowspan="2" width="100">Buyer</th>

                    <th rowspan="2" width="100">Batch Qty (Kg)</th>
                    <th colspan="4" width="">First Dying And Finishing Cost</th>
                    <th colspan="7" width="">Subsequent Dyeing and Finishing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per Kg Cost (Tk)</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>

                    <th width="100">Ttl Chem Cost(Tk)</th>
                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100"><p>Re-Dye Cost per kg (Tk)</th>
                </tr> 
            </thead>
        </table>
        <div style="width:1460px; max-height:400px;  overflow-y:scroll" id="scroll_body_summary">
	        <table align="left" width="1440" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="summary_table_body_id" >
	            <tbody>';
			       	
			       	$tot_main_batch_weight=0;
			       	foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
							$ReqId=rtrim($ReqIdArr[$b_id],',');
							$ReqIds=implode(", ",array_unique(explode(",",$ReqId)));
							$ReqIdsArr=array_unique(explode(",",$ReqId));

							$tot_batch_weight=0;
							$tot_batch_weight=$batch_description_arr[$b_id]['batch_weight'];

							if($batch_description_arr[$b_id][entry_form]==36)
			                {
			                	$buyerName=implode(", ",array_unique(explode(",",$sub_con_id_arr[$b_id][party_id])));
			                }
			                else
			                {
				                if($batch_description_arr[$b_id]["without_order"]==1) 
				                $buyerName=$non_buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
				                else $buyerName=$buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
			                }
			                $buyer_wise_summary_arr[$buyerName]["buyer"]=$buyerName;
			                $buyer_wise_summary_arr[$buyerName]["batch_qty"]+=$batch_description_arr[$b_id]["batch_weight"];
		
							$batch_weight=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
							$first_chemi_cost=$first_dyeing_cost=0;$tot_chemicalCost_fin=$tot_dyesCost_fin=0;$tot_fin_cost=0;
							if($non_reding_batch_id[$b_id]!="")
							{
								
								$issue_amt_deys=0;$issue_amt_chemical=$totalcost=0;$issue_amt_chemical_fin=0;$issue_amt_deys_fin=0;
								$batchIdArr="";$tot_chemicalCost=$tot_dyesCost=0;$tot_chemical_Cost_fin=$tot_dyes_Cost_fin=0;
								foreach($ReqIdsArr as $reqId)
								{
									$chem_return_issue = $return_qty_arr[$b_id][5]['amnt']+$return_qty_arr[$b_id][7]['amnt'];
									$dys_return_issue = $return_qty_arr[$b_id][6]['amnt'];
									$issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
									$issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];

									$issue_amt_chemical_fin=$issue_item_cat_amt_dtls_fin_arr[$reqId][5]+$issue_item_cat_amt_dtls_fin_arr[$reqId][7];
									$issue_amt_deys_fin=$issue_item_cat_amt_dtls_fin_arr[$reqId][6];
								
									$batch_ids=$ReqBatch_id_arr[$reqId]; 
									$batIdArr=array_unique(explode(",",$batch_ids)); 
									$tot_batch_wgt=0;
									//print_r($batIdArr);
									foreach($batIdArr as $batchId)
									{
										$tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt'];
									}
								
									if($issue_amt_chemical>0)
									{
									$tot_chemicalCost+= (($issue_amt_chemical/$tot_batch_wgt)*$batch_weight);
									}
									if($issue_amt_deys>0)
									{
									$tot_dyesCost+= (($issue_amt_deys/$tot_batch_wgt)*$batch_weight);
									}

								}
								if($tot_chemicalCost)
								{
								$issue_amt_cal_chemical=$tot_chemicalCost-$chem_return_issue;//
								} 
								else 
								{ $issue_amt_cal_chemical=0;}
								
								if($tot_dyesCost)
								{
								$issue_amt_cal_dyes=$tot_dyesCost-$dys_return_issue;
								}
								else {$issue_amt_cal_dyes=0;}
								
								$first_chemi_cost=$issue_amt_cal_chemical;//$costDataArr[$b_id][5]+$costDataArr[$b_id][7];
								$first_dyeing_cost=$issue_amt_cal_dyes;//$costDataArr[$b_id][6];
								
							}
							


			                // $first_chemi_cost=$first_dyeing_cost=0;
			                if($non_reding_batch_id[$b_id]!="")
			                {
			                   // $first_chemi_cost=$dyes_chemical_arr[$b_id][5]["chemical_cost"]+$dyes_chemical_arr[$b_id][7]["chemical_cost"];
			                    $buyer_wise_summary_arr[$buyerName]["first_chemi_cost"]+=$first_chemi_cost;

			                    //$first_dyeing_cost=$dyes_chemical_arr[$b_id][6]["chemical_cost"];
			                    $buyer_wise_summary_arr[$buyerName]["first_dyeing_cost"]+=$first_dyeing_cost;
								$tot_main_batch_weight=$tot_main_batch_weight+=$batch_description_arr[$b_id]["batch_weight"];
								$buyer_wise_summary_arr[$buyerName]["tot_main_batch_weight"]+=$tot_main_batch_weight;
			                }
			                $buyer_wise_summary_arr[$buyerName]["cost_per_kg"]+=($first_chemi_cost+$first_dyeing_cost)/$batch_description_arr[$b_id]["batch_weight"];

			                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
			                if($reding_batch_id[$b_id]!="")
			                {
			                    $re_dying_chemical_cost=$dyes_chemical_arr[$b_id][5]["chemical_cost"]+$dyes_chemical_arr[$b_id][7]["chemical_cost"];
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_chemical_cost"]+=$re_dying_chemical_cost;

			                    $re_dying_dyes_cost=$dyes_chemical_arr[$b_id][6]["chemical_cost"];	
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_dyes_cost"]+=$re_dying_dyes_cost;

			                    $re_dying_dyes_chemical_cost=$dyes_chemical_arr[$b_id][5]["chemical_cost"]+$dyes_chemical_arr[$b_id][6]["chemical_cost"]+$dyes_chemical_arr[$b_id][7]["chemical_cost"];
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_dyes_chemical_cost"]+=$re_dying_dyes_chemical_cost;
			                }
			                $buyer_wise_summary_arr[$buyerName]["re_dye_cost_per_kg"]+=$re_dying_dyes_chemical_cost/$batch_description_arr[$b_id]["batch_weight"];

			                $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
			                $buyer_wise_summary_arr[$buyerName]["total_per_kg_cost"]+=($re_dying_dyes_chemical_cost+$batch_chemical_price)/$batch_description_arr[$b_id]["batch_weight"];

			                //$buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price)/$buyer["batch_qty"]
						}	
					}

				    // echo "<pre>";print_r($buyer_wise_summary_arr);die;
					foreach($buyer_wise_summary_arr as $buyer_id=>$buyer)
					{
						if($j%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
						
			            $summaryHTML.='<tr bgcolor="'.$bgcolor.'">
			                <td width="30">'.$j.'</td>

				            <td width="100"><p>'.$buyer_library[$buyer_id].'</p></td>

			                <td width="100" align="right" align="right"><p>'.number_format($buyer["batch_qty"],4,".","").'</p></td>


			                <td width="100" align="right"><p>'.number_format($buyer["first_chemi_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.number_format($buyer["first_dyeing_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>';
			                $summary_batch_chemical_price=$buyer["first_chemi_cost"]+$buyer["first_dyeing_cost"];
			                $summaryHTML.=number_format($summary_batch_chemical_price,4,".","").'</p></td>
			                <td width="100" align="right"><p>
			                '.number_format(($summary_batch_chemical_price/$buyer["batch_qty"]),4,".","").' 
			                </p></td>


			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_chemical_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_dyes_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_dyes_chemical_cost"],4,".","").'</p></td>
			                <td width="100" align="right" title="Total Chemical And Dyes/BatchWeight">'.number_format($buyer["re_dye_cost_per_kg"],4,".","").'</td>


			                <td width="100" align="right">'.number_format($buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price,4,".","").'</td>
			                <td width="100" align="right" title="'."(".$buyer["re_dying_dyes_chemical_cost"]."+".$summary_batch_chemical_price.")/".$buyer["batch_qty"].'">
			                '.number_format((($buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price)/$buyer["batch_qty"]),4,".","").'
			                </td>
			            </tr>';
						$summary_total_batch_weight+=$buyer["batch_qty"];
						$summary_total_chemical_cost+=$buyer["first_chemi_cost"];
						$summary_total_dyes_cost+=$buyer["first_dyeing_cost"];
						$summary_total_batch_chemical_price+=$summary_batch_chemical_price;
						$summary_tot_total_receive+=$totalReceive;
						$summary_tot_re_dying_chemical_cost+=$buyer["re_dying_chemical_cost"];
						$summary_tot_re_dying_dyes_cost+=$buyer["re_dying_dyes_cost"];
						$summary_tot_re_dying_dyes_chemical_cost+=$buyer["re_dying_dyes_chemical_cost"];
						$summary_cost_per_kg+=$buyer["cost_per_kg"];
						$summary_total_per_kg_cost+=$buyer["total_per_kg_cost"];
						$j++;
					}
					?>
	            <? $summaryHTML.='</tbody>
	      	</table>
      	</div>
       	<table align="left" width="1440" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="summary_table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="100" align="right">&nbsp;Total</th>
                    <th width="100" id="value_total_batch_weight_summary">'.number_format($summary_total_batch_weight,4).'</th>
                	<th width="100" align="right" id="value_total_chemical_cost_summary">'.number_format($summary_total_chemical_cost,4).'</th>
                	<th width="100" align="right" id="value_total_dyeing_cost_summary">'.number_format($summary_total_dyes_cost,4).'</th>
                    <th width="100" align="right" id="value_total_chemical_price_summary">'.number_format($summary_total_batch_chemical_price,4).'</th>
                    <th width="100" align="right">'.number_format($summary_total_batch_chemical_price/$summary_total_batch_weight,4).'</th>
                    <th width="100" align="right" id="value_total_redying_chemic_oost_summary">'.number_format($summary_tot_re_dying_chemical_cost,4).'</th>
                    <th width="100" align="right" id="value_total_redying_dying_cost_summary"><p>'.number_format($summary_tot_re_dying_dyes_cost,4).'</p></th>
                    <th width="100" align="right" id="value_total_redying_all_cost_summary"><p>'.number_format($summary_tot_re_dying_dyes_chemical_cost,4).'</p></th>
                    <th width="100" align="right" id="value_total_redying_all_cost_summary_tk">'.number_format($summary_tot_re_dying_dyes_chemical_cost/$summary_total_batch_weight,4).'</th>
                    <th width="100" align="right" id="value_total_total_cost_summary">'.number_format($summary_total_batch_chemical_price+$summary_tot_re_dying_dyes_chemical_cost,4).'</th>
                    <th width="100" align="right" title="Main Batch Qty='.number_format($buyer["tot_main_batch_weight"],2).'">'.number_format((($summary_total_batch_chemical_price+$summary_tot_re_dying_dyes_chemical_cost)/$summary_total_batch_weight),4).'</th>
                </tr>
            </tfoot>
        </table>
    	</div>';?>
    <? echo $summaryHTML;?>

	<?
	if($batch_type!=2){

	
	?>
 	<div>
        <div  align="left" style="font-size:25px">Single Batch</div>
        <table width="3030" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>
                    <th rowspan="2" width="80">Date</th>
                    <th rowspan="2" width="100">Machine No</th>
                    <th rowspan="2" width="100">Batch No</th>
                    <th rowspan="2" width="80">File No</th>
                    <th rowspan="2" width="80">Ref. No</th>
                    <th rowspan="2" width="100">Floor Name</th>
                    <th rowspan="2" width="100">Buyer</th>
                    <th rowspan="2" width="100">Booking No</th>
                    <th rowspan="2" width="100">Job no</th>
                    <th rowspan="2" width="80">Season</th>                  
                    <th rowspan="2" width="">Style</th>
                    <th rowspan="2" width="100">Order No</th>
                    <th rowspan="2" width="100">Color Name</th>
                    <th rowspan="2" width="100">Color Range</th>
                    <th rowspan="2" width="100">Fabric Type </th>
                    <th rowspan="2" width="100">Batch Qty (Kg)</th>
                    <th colspan="4"  width="">First Dying And Finishing Cost</th>
                    <th colspan="7" width="">Subsequent Dyeing and Finishing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per Kg Cost (Tk)</th>
                    <th rowspan="2" width="100">Result</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>
                    <th width="100">Extention Batch Date</th>
                    <th width="70">Extention No</th>
                    <th width="100">Floor Name</th>
                    <th width="100">Ttl Chem Cost(Tk)</th>
                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100"><p>Re-Dye Cost per kg (Tk)</th>
                </tr> 
            </thead>
        </table>
        <div style="width:3050px; max-height:400px;  overflow-y:scroll" id="scroll_body_s">
	        <table width="3030" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_id_s" >
	            <tbody>
			       	<?
				    //echo "<pre>";
					//print_r($issue_single_batch_arr);die;
					$tot_main_batch_weight=0;
					foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
						
							if($i%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
							$all_po_id=explode(",",$po_break_down_id_arr[$batch_description_arr[$b_id]['booking_no']]);

							$ReqId=rtrim($ReqIdArr[$b_id],',');
							$ReqIds=implode(", ",array_unique(explode(",",$ReqId)));
							$ReqIdsArr=array_unique(explode(",",$ReqId));

							$tot_batch_weight=0;
							$tot_batch_weight=$batch_description_arr[$b_id]['batch_weight'];

							$po_number_data="";
							$job_no_data="";$file_no="";$ref_no="";
							foreach($all_po_id as $p_id) // $po_number_arr[$row[csf('id')]]['po_no']
							{
								if($po_number_data!="") $po_number_data.=",".$po_number_arr[$p_id]['po_no'];	 else $po_number_data=$po_number_arr[$p_id]['po_no'];
								if($job_no_data!="") $job_no_data.=",".$po_number_arr[$p_id]['job'];	 else $job_no_data=$po_number_arr[$p_id]['job'];
								if($season_data!="") $season_data.=",".$season_name_arr[$po_number_arr[$p_id]['season']];	 else $season_data=$season_name_arr[$po_number_arr[$p_id]['season']];
								if($file_no!="") $file_no.=",".$po_number_arr[$p_id]['file_no'];	 else $file_no=$po_number_arr[$p_id]['file_no'];
								if($ref_no!="") $ref_no.=",".$po_number_arr[$p_id]['ref_no'];	 else $ref_no=$po_number_arr[$p_id]['ref_no'];
							} 
							$color_range_id=$batch_description_arr[$b_id]['color_range'];
							$file_cond=implode(", ",array_unique(explode(",",$file_no)));
							$ref_cond=implode(", ",array_unique(explode(",",$ref_no)));
							if($batch_description_arr[$b_id]['without_order']==1 && $ref_cond=="")
							{
							$ref_cond=$sample_booking_ref_no_arr[$batch_description_arr[$b_id]['booking_no']];
							}
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="30"><? echo $i; ?></td>								
				                <td width="80"><? echo change_date_format($batch_description_arr[$b_id]['batch_date']); ?></td>
				                <td width="100"><p><? echo $machine_name_arr[$b_id]; ?></p></td>                                 
				                <td width="100"><p><A href="##"  onClick="subprocess_fabric_dtls('<? echo $b_id; ?>','<? echo $batch_arr[$b_id]; ?>','subprocess_fabrics_dtls_popup')"><p><? echo $batch_arr[$b_id]; ?></p></A><? //echo $batch_arr[$b_id]; ?></p></td>
				                <td width="80"><p><? echo $file_cond; ?></p></td>
				                <td width="80" title="PO/Sample Ref no"><p><? echo $ref_cond; ?></p></td>
				                <td width="100"><p><? echo $floor_arr[$b_id]; ?></p></td> 
				                <?
				                if($batch_description_arr[$b_id][entry_form]==36)
				                {
					                ?>
					                <td width="100"><p><? echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][party_id]))); ?></p></td> 
					                <td width="100"><p><? // echo $b_id; ?></p></td>
					                <td width="100" align="center"><p>
					                <? 
				                     echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                 <td width="80" align="center"><p>
					                <? 
				                     //echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                <td width="100" align="center"><p> <? echo   implode(",",array_unique(explode(",",$sub_con_arr[$b_id][cust_style_ref]))); ?></p></td>
					                <td width="100" align="center"><p> <? echo implode(",",array_unique(explode(",",$sub_con_arr[$b_id][order_no]))); ?></p></td>
				                	<?
				                }
				                else
				                {
					                ?>
					                <td width="100"><p><? 
					                if($batch_description_arr[$b_id]['without_order']==1) $buyerName=$non_buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];else $buyerName=$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
					                <td width="100"><p><? echo $batch_description_arr[$b_id]['booking_no']; ?></p></td>
					                <td width="100" align="center"><div style="word-break:break-all">
					                <?
					                echo implode(", ",array_unique(explode(",",$job_no_data)));
					                ?></div></td>
					                <td width="80" align="center"><div style="word-break:break-all">
					                <? 
					                
					                echo implode(", ",array_unique(explode(",",$season_data)));

					                ?></div></td>
					                <td width="" align="center"><div style="word-break:break-all"> 
					                <? 
					                $style_no=array();
					                foreach(array_unique(explode(",",$job_no_data)) as $j_no)
					                {
					                    if($style_no!="")  $style_no[]=$style_library[$j_no];
					                }
					                echo implode(", ",array_unique($style_no)); ?></div></td>
					                <td width="100" align="center"><div style="word-break:break-all"> <? echo implode(", ",array_unique(explode(",",$po_number_data))); ?></div></td>
					                <?	
				                }
				                ?>
				                <td width="100" align="center"><div style="word-break:break-all"><? echo $color_arr[$batch_description_arr[$b_id]['color_id']]; ?></div></td> 
				                <td width="100" align="center"><p><? echo $color_range[$color_range_id]; ?></p></td> 
				                <td width="100" align="center"><p><? echo $fabric_type_for_dyeing[$fabric_type_arr[$b_id]['fabric_type']]; //$fabric_type_for_dyeing?></p></td> 
				                <td width="100" align="right"><p>
				                <? echo $batch_description_arr[$b_id]['batch_weight']; $total_batch_weight+=$batch_description_arr[$b_id]['batch_weight'] ;?>
				                </p></td> 
				                <?
				                
				                //$first_chemi_cost=$first_dyeing_cost=0;
				                // if($non_reding_batch_id[$b_id]!="")
				                // {
				                //     $first_chemi_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                //     $first_dyeing_cost=$dyes_chemical_arr[$b_id][6]['chemical_cost'];
								// 	$tot_main_batch_weight+=$batch_description_arr[$b_id]['batch_weight'];
				                // }
				                
				                ?>


								<?
				                $batch_weight=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
				                $first_chemi_cost=$first_dyeing_cost=0;$tot_chemicalCost_fin=$tot_dyesCost_fin=0;$tot_fin_cost=0;
				                if($non_reding_batch_id[$b_id]!="")
				                {
				                    
									$issue_amt_deys=0;$issue_amt_chemical=$totalcost=0;$issue_amt_chemical_fin=0;$issue_amt_deys_fin=0;
									$batchIdArr="";$tot_chemicalCost=$tot_dyesCost=0;$tot_chemical_Cost_fin=$tot_dyes_Cost_fin=0;
									foreach($ReqIdsArr as $reqId)
									{
										$chem_return_issue = $return_qty_arr[$b_id][5]['amnt']+$return_qty_arr[$b_id][7]['amnt'];
										$dys_return_issue = $return_qty_arr[$b_id][6]['amnt'];
										$issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										$issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];

										$issue_amt_chemical_fin=$issue_item_cat_amt_dtls_fin_arr[$reqId][5]+$issue_item_cat_amt_dtls_fin_arr[$reqId][7];
										$issue_amt_deys_fin=$issue_item_cat_amt_dtls_fin_arr[$reqId][6];
									
									    $batch_ids=$ReqBatch_id_arr[$reqId]; 
										$batIdArr=array_unique(explode(",",$batch_ids)); 
										$tot_batch_wgt=0;
									    //print_r($batIdArr);
										foreach($batIdArr as $batchId)
										{
											$tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt'];
										}
									
										if($issue_amt_chemical>0)
										{
										$tot_chemicalCost+= (($issue_amt_chemical/$tot_batch_wgt)*$batch_weight);
										}
										if($issue_amt_deys>0)
										{
										$tot_dyesCost+= (($issue_amt_deys/$tot_batch_wgt)*$batch_weight);
										}

									}
									if($tot_chemicalCost)
									{
									$issue_amt_cal_chemical=$tot_chemicalCost-$chem_return_issue;//
									} 
									else 
									{ $issue_amt_cal_chemical=0;}
									
									if($tot_dyesCost)
									{
									$issue_amt_cal_dyes=$tot_dyesCost-$dys_return_issue;
									}
									else {$issue_amt_cal_dyes=0;}
									
				                    $first_chemi_cost=$issue_amt_cal_chemical;//$costDataArr[$b_id][5]+$costDataArr[$b_id][7];
				                    $first_dyeing_cost=$issue_amt_cal_dyes;//$costDataArr[$b_id][6];
									
				                }
				                
				                ?>


				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($first_chemi_cost,4,".",""); 
				                 $total_chemical_cost+=$first_chemi_cost;
				                 ?>
				                </p></td>
				                <td width="100" align="right"><p>
				                <?  
				                    echo number_format($first_dyeing_cost,4,".",""); 
				                    $total_dyes_cost+=$first_dyeing_cost; 
				                ?>
				                </p></td>
				                <td width="100" align="right"><p><A href="##"  onClick="fn_1st_batch('<? echo $b_id; ?>','1st_batch_dtls_popup')">
				                <?
				                 $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
				                  echo number_format($batch_chemical_price,4,".","");
				                  $total_batch_chemical_price+=$batch_chemical_price;
				                ?>
				                </A></p></td>
				                <td width="100" align="right"><p><? echo number_format($batch_chemical_price/$batch_description_arr[$b_id]['batch_weight'],4,".",""); $tot_total_receive+=$totalReceive; ?></p></td>
				                <td width="100" align="right"><p>
				                <? 
				                $extension_no="";
				                $re_batch_date="";
				                $batch_date=explode(",", $redying_details_arr[$b_id]['batch_date']);	
				                foreach($batch_date as $ash_date)
				                {
				                 if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                }
				                echo $re_batch_date;
				                 ?></p></td>
				                <td width="70" align="right"><p>
				                <?		                
				                //echo $redying_details_arr[$b_id]['id'].jahid;
				                if(trim($redying_details_arr[$b_id]['id']))
				                {
				                    $re_dying_id_all=explode(",",$redying_details_arr[$b_id]['id']);
				                    //$re_dying_chemical_cost=0;
				                    //$re_dying_dyes_cost=0;
				                    //$re_dying_dyes_chemical_cost=0;
				                    
				                    $result_id="";
				                    $result_id_last='';
				                    
				                    foreach($re_dying_id_all as $ash_id)
				                    {
				                    //$re_dying_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                    //$re_dying_dyes_cost+=$dyes_chemical_arr[$ash_id][6]['chemical_cost']	;	
				                    //$re_dying_dyes_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][6]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                        
				                     if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                     //if($re_floor!="") $re_floor.=",".$floor_arr[$ash_id]; else $re_floor=$floor_arr[$ash_id];
				                    /* echo $ash_id.tipu;
				                     $result_id=$result_arr[$ash_id];
				                     if($result_id!="")  $result_id_last=$result_id;*/
				                    }
				                }
				                //echo $b_id;
				                //if($batch_type==3)
				                //{
				                echo $redying_details_arr[$b_id]['extention_no'];	 ?>
				                
				                
				                </p></td>
				                <td width="100" align="right"><p><?
				                $re_floors='';
				                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
				                //print_r($reding_batch_id);//echo $reding_batch_id[$b_id]."##".$b_id;
				                if($reding_batch_id[$b_id]!="")
				                {
				                    $re_floors=$floor_arr[$b_id];
				                    $re_dying_chemical_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                    $re_dying_dyes_cost=$dyes_chemical_arr[$b_id][6]['chemical_cost']	;	
				                    $re_dying_dyes_chemical_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][6]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                }
				                
				                echo $re_floors;
				                ?></p></td>
				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($re_dying_chemical_cost,4,".",""); 
				                 $tot_re_dying_chemical_cost+=$re_dying_chemical_cost;
				                 ?>
				                 </p></td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_dyes_cost,4,".",""); $tot_re_dying_dyes_cost+=$re_dying_dyes_cost;  ?></p></td>
				                <td width="100" align="right"><A href="##"  onClick="fn_total_batch('<? echo $b_id; ?>','total_batch_dtls_popup')"><p><? echo number_format($re_dying_dyes_chemical_cost,4,".",""); $tot_re_dying_dyes_chemical_cost+=$re_dying_dyes_chemical_cost; ?></p></A></td>
				                <td width="100" align="right" title="Total Chemical And Dyes/BatchWeight"><? echo number_format($re_dying_dyes_chemical_cost/$batch_description_arr[$b_id]['batch_weight'],4,".",""); ?></td>
				                

				                <td width="100" align="right"><? echo number_format($re_dying_dyes_chemical_cost+$batch_chemical_price,4,".",""); ?></td>
				                <td width="100" align="right" title="<? echo '('.$re_dying_dyes_chemical_cost.'+'.$batch_chemical_price.')/'.$batch_description_arr[$b_id]['batch_weight']; ?>"><? echo number_format(($re_dying_dyes_chemical_cost+$batch_chemical_price)/$batch_description_arr[$b_id]['batch_weight'],4,".","");  ?></td>
				                <td width="100" align="center" title="<? echo $b_id; ?>"><? //echo $unload_result_arr[$b_id]//echo  $dyeing_result[$result_id];//
				                //echo $b_id.tipu;
			                    $result_id=$result_arr[$b_id];
			                    if($result_id!="")  $result_id_last=$result_id;
				                echo $dyeing_result[$result_id];//$dyeing_result;//$daysOnHand; ?></td>
				            </tr>
							<? 												
								 $i++; 			
						}	
					}
					?>
	            </tbody>
	      	</table>
      	</div>
       	<table width="3030" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="80">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                   <th width="80">&nbsp;</th>
                    <th width="">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="100"><? //echo number_format($total_batch_chemical_price,4).'='.$total_dyes_cost; ?></th>
                	<th width="100">Total</th>
                    <th width="100" id="value_total_batch_weight_single"><? echo number_format($total_batch_weight,4); ?></th>
                	<th width="100" id="value_total_chemical_cost_single"><? echo number_format($total_chemical_cost,4); ?></th>
                	<th width="100" id="value_total_dyeing_cost_single"><? echo number_format($total_dyes_cost,4); ?></th>
                    <th width="100" id="value_total_chemical_price_single"><? echo number_format($total_batch_chemical_price,4); ?></th>
                    <th width="100" id="value_total_chemical_per_single"><? echo number_format(($total_batch_chemical_price/$total_batch_weight),4); ?></th>
                    <th width="100"><? //echo number_format($tot_re_dying_chemical_cost,3); ?></th>
                    <th width="70"><? //echo number_format($tot_rec_return,3); ?></th>
                    <th width="100"><? //echo number_format($tot_total_issue,3); ?></th>
                    <th width="100" id="value_total_redying_chemic_oost_single"><? echo number_format($tot_re_dying_chemical_cost,4); ?></th>
                    <th width="100" id="value_total_redying_dying_cost_single"><p><? echo number_format($tot_re_dying_dyes_cost,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single"><p><? echo number_format($tot_re_dying_dyes_chemical_cost,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single_tk"><? echo number_format($tot_re_dying_dyes_chemical_cost/$total_batch_weight,4); ?></th>
                    <th width="100" id="value_total_total_cost_single"><? echo number_format($total_batch_chemical_price+$tot_re_dying_dyes_chemical_cost,4); ?></th>
                    <th width="100" id="value_total_total_cost_per_single" title="Main Batch Qty=<? echo number_format($tot_main_batch_weight,2);?>"><? echo number_format(($total_batch_chemical_price/$total_batch_weight),4); ?></th>
                    <th width="100">&nbsp;</th>
                </tr>
            </tfoot>
        </table>
    </div>
	<?
	}
	?>
				
      
    <div>
       	<div  align="left" style="font-size:25px">Multiple Batch</div>
       
	        <table width="2970" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
	        	<thead>
	                <tr>
	                    <th rowspan="2" width="40">SL</th>
	                    <th rowspan="2" width="80">Date</th>
	                    <th rowspan="2" width="100">Machine No</th>
	                    <th rowspan="2" width="100">Batch No</th>
	                    <th rowspan="2" width="80">File No</th>
	                    <th rowspan="2" width="80">Ref. No</th>
	                    <th rowspan="2"width="100">Floor Name</th>
	                    <th rowspan="2" width="80">Buyer</th>
	                    <th rowspan="2" width="100">Booking No</th>
	                    <th rowspan="2" width="100">Job no</th>
	                    <th rowspan="2" width="80">Season</th>
	                    <th rowspan="2" width="100">Style</th>
	                    <th rowspan="2" width="100">Order No</th>
	                    <th rowspan="2" width="100">Color Name</th>
	                    <th rowspan="2" width="100">Color Range</th>
	                    <th rowspan="2" width="100">Fabric Type </th>
	                    <th rowspan="2" width="80">Batch Qty (Kg)</th>
	                    <th colspan="4"  width="430">First Dying And Finishing Cost</th>
	                    <th colspan="7" width="660">Subsequent Dyeing and Finishing Cost</th>
	                    <th rowspan="2" width="70">Total Cost (Tk)</th>
	                    <th rowspan="2" width="70">Total Per Kg Cost (Tk)</th>
	                    <th rowspan="2" width="">Result</th>
	                </tr> 
	                <tr>                         
	                    <th width="100">Ttl Chem Cost (Tk)</th>
	                    <th width="110">Ttl Dyes Cost (Tk)</th>
	                    <th width="110">Ttl Chem + Dyes Cost (Tk)</th>
	                    <th width="110">Cost Per Kg(Tk)</th>
	                    <th width="80">Extention Batch Date</th>
	                    <th width="70">Extention No</th>
	                    <th width="100">Floor Name</th>
	                    <th width="100">Ttl Chem Cost(Tk)</th>
	                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
	                    <th width="100">Ttl Chem + Dyes Cost (Tk)</th>
	                    <th width="110">Re-Dye Cost per kg (Tk)</th>
	                </tr> 
	            </thead>
	        </table>
	        <div style="width:2990px; max-height:400px; overflow-y:scroll" id="">
		        <table width="2970" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_multibatch_id">
			       	<?
					$multi_batch_qty_total=0;
					$j=1;
					foreach(array_unique($issue_multi_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{

							


							if($j%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF"; 
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="40"><? echo $j; ?></td>								
				                <td width="80" style="word-break:break-all;">
				                <?
								$multiple_batch_id=explode(",",$b_id);
								$batch_id_all="";
								$muli_batch_floor_name="";$multi_batch_machine='';
								$multi_batch_buyer_name=array();
								$multi_batch_booking_no=array();
								$multi_batch_job_no=array();
								$multi_batch_style_no=array();
								$multi_batch_color=""; $multi_batch_color_range="";
								$mulib_batch_weight=0;
								$re_dying_dyes_multi_batch_cost=0;
								$re_dying_dyes_multi_batch_chemical_cost=0;
								$re_multi_batch_floor="";
								$mult_batch_chemical_cost=0;
								$mult_batch_dyes_cost=0;
								$mult_batch_dyes_chemical_cost=0;
								$multiBatch_extension="";
								$re_floor="";
								$p=0;
								$redying_batch_id=array();
								$po_number_data_all=array();
								$batch_date_arr=array();
								$re_dying_multi_batch_chemical_cost=0;
								$re_dying_multi_batch_dying_cost=0; 
								$re_dying_multi_batch_dyes_chemical_cost=0;
								$remulti_batch_date="";$batch_nos="";
								$new_redying_arr=array();
								$new_redying_arr1=array();
				                foreach($multiple_batch_id as $s_bid)
				                {
									
									// echo $s_bid."mahbub";
									    
									$ReqId=rtrim($ReqIdArr[$s_bid],',');
									$ReqIds=implode(", ",array_unique(explode(",",$ReqId)));
									$ReqIdsArr=array_unique(explode(",",$ReqId));

									$tot_batch_weight=0;
									$tot_batch_weight=$batch_description_arr[$s_bid]['batch_weight'];



				                  	//  $batch_button="<a href='##' onClick=\"subprocess_fabric_dtls('".$b_id."','".$batch_id_all."','subprocess_fabrics_dtls_popup')\"> ".$batch_id_all." </a>";
									  $p++;
				                      $batch_date_arr[]=$batch_description_arr[$s_bid]['batch_date'];
				                      if($batch_id_all!="") $batch_id_all.=",".$batch_arr[$s_bid]; else $batch_id_all=$batch_arr[$s_bid];
									  if($batch_nos=="") $batch_nos="<a href='##' onClick=\"subprocess_fabric_dtls('".$s_bid."','".$batch_arr[$s_bid]."','subprocess_fabrics_dtls_popup')\"> ".$batch_arr[$s_bid]." </a>";else $batch_nos.=", "."<a href='##' onClick=\"subprocess_fabric_dtls('".$s_bid."','".$batch_arr[$s_bid]."','subprocess_fabrics_dtls_popup')\"> ".$batch_arr[$s_bid]." </a>";
				                      if($muli_batch_floor_name!="") $muli_batch_floor_name.=",".$floor_arr[$s_bid]; else $muli_batch_floor_name=$floor_arr[$s_bid];
				                      
				                      // for buyer name job style po*************************************************************************************
				                      if($batch_description_arr[$s_bid][entry_form]==36)
				                      {
				                          $multi_batch_buyer_name[]=$sub_con_arr[$s_bid][party_id];
				                          $multi_batch_job_no[]=$sub_con_arr[$s_bid][subcon_job];
				                          $po_number_data_all[]=$sub_con_arr[$s_bid][order_no];
				                          $multi_batch_style_no[]=$sub_con_arr[$s_bid][cust_style_ref];
				                      }
				                      else
				                      {
				                          $all_po_ids=array_unique(explode(",",$po_break_down_id_arr[$batch_description_arr[$s_bid]['booking_no']])); //print_r(array_unique($batch_description_arr[$s_bid]['booking_no']));
				                           $ref_no='';   $file_no=''; $po_no='';$season_data='';
										   //print_r( $all_po_id);
										  foreach($all_po_ids as $p_id)
				                          {
				                            // echo $p_id.'<pre>';
											  $po_number_data_all[]=$po_number_arr[$p_id]['po_no'];
				                              $multi_batch_job_no[]=$job_no_arr[$p_id];
											  if($season_data!="") $season_data.=",".$season_name_arr[$po_number_arr[$p_id]['season']];	 else $season_data=$season_name_arr[$po_number_arr[$p_id]['season']];
											  if( $po_no=='') $po_no=$po_number_arr[$p_id]['po_no'];else $po_no.=",".$po_number_arr[$p_id]['po_no'];
											  if( $ref_no=='') $ref_no=$po_number_arr[$p_id]['ref_no'];else $ref_no.=",".$po_number_arr[$p_id]['ref_no'];
											  if( $file_no=='') $file_no=$po_number_arr[$p_id]['file_no'];else $file_no.=",".$po_number_arr[$p_id]['file_no'];
											 // echo $po_no;
						 					 
				                          }
										  if($batch_description_arr[$s_bid]['without_order']==1)
										  { 
										 	$multi_batch_buyer_name[]=$non_buyer_name_arr[$batch_description_arr[$s_bid]['booking_no']];
										  }
										  else 
										  { 
										    $multi_batch_buyer_name[]=$buyer_name_arr[$batch_description_arr[$s_bid]['booking_no']];
										  }
										  if($batch_description_arr[$s_bid]['without_order']==1 && $ref_no=="")
											{
											$ref_no=$sample_booking_ref_no_arr[$batch_description_arr[$s_bid]['booking_no']];
											}
							
									
				                         
										  
				                          $multi_batch_booking_no[]=$batch_description_arr[$s_bid]['booking_no'];
				                          $style_no=array();
				                          foreach(array_unique($multi_batch_job_no) as $j_no)
				                          {
				                             if($multi_batch_style_no!="")  $multi_batch_style_no[]=$style_library[$j_no];
				                          } 
				                      }
				                      $mulib_batch_weight+=$batch_description_arr[$s_bid]['batch_weight'];
				                      //****************************************** for color **********************************************************
				                      if($multi_batch_color!="") $multi_batch_color.=",".$color_arr[$batch_description_arr[$s_bid]['color_id']];
				                      else $multi_batch_color=$color_arr[$batch_description_arr[$s_bid]['color_id']];
									  
				                      if($multi_batch_color_range!="") $multi_batch_color_range.=",".$color_range[$batch_description_arr[$s_bid]['color_range']];
				                      else $multi_batch_color_range=$color_range[$batch_description_arr[$s_bid]['color_range']];
									  
									  if($multi_batch_machine!="") $multi_batch_machine.=",".$machine_name_arr[$s_bid];
				                      else $multi_batch_machine=$machine_name_arr[$s_bid];
									  
									  
									  //$color_range_id=$color_range[$batch_description_arr[$b_id]['color_range']];
				                      //******************************************** for redyeing **********************************************************
									  //echo $batch_description_arr[$s_bid]['color_range'];
									if($redying_details_arr[$s_bid]['id']!="")
									{
					                      if($multiBatch_extension!="") $multiBatch_extension.="*".$redying_details_arr[$s_bid]['extention_no'];
					                      else $multiBatch_extension=$redying_details_arr[$s_bid]['extention_no'];
					                      $sl=0;
										  
					                      foreach(explode(",",$redying_details_arr[$s_bid]['id']) as $rbs)
					                      {
					                        $new_redying_arr[$sl]=$new_redying_arr[$sl].",".$rbs;
					                        $new_redying_arr1[$sl]=$rbs.",".$new_redying_arr1[$sl];
					                        $sl++; 
					                        
					                        if($re_floor!="") $re_floor.=",".$floor_arr[$rbs];
					                        else $re_floor=$floor_arr[$rbs];
					                      }
					                      // for redyeing batch date *************************************************************************************************
					                      foreach(array_unique(explode(",",$redying_details_arr[$s_bid]['batch_date'])) as $r_date)
					                      {
					                      if($remulti_batch_date!="") $remulti_batch_date.=",".change_date_format($r_date); else $remulti_batch_date=change_date_format($r_date);
					                      }
					                }
									
					                // *****************************************redyeing dyes and chemical cost***************************************
					                 foreach($new_redying_arr as $l_id)
					                 {
					                     $re_dying_multi_id_all=ltrim($l_id,",");
					                     $re_dying_multi_batch_chemical_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][5]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][7]['chemical_cost'];
					                     $re_dying_multi_batch_dying_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][6]['chemical_cost'];	
					                     $re_dying_multi_batch_dyes_chemical_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][5]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][6]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][7]['chemical_cost'];
					                    
					                 }
					                 foreach($new_redying_arr1 as $l_id)
					                 {
					                     $re_dying_multi_id_all=rtrim($l_id,",");
					                     $re_dying_multi_batch_chemical_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][5]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][7]['chemical_cost'];
					                     $re_dying_multi_batch_dying_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][6]['chemical_cost']	;	
					                     $re_dying_multi_batch_dyes_chemical_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][5]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][6]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][7]['chemical_cost'];
					                 }
									 $re_dying_multi_batch_chemical_cost_total+=$re_dying_multi_batch_chemical_cost;
					                 $re_dying_multi_batch_dying_cost_total+=$re_dying_multi_batch_dying_cost;
					                 $re_dying_multi_batch_dyes_chemical_cost_total+=$re_dying_multi_batch_dyes_chemical_cost;
								}
								 
				                // dyes and chemical cost total  ************************************************************************************************
				                 //$mult_batch_chemical_cost+=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                 //$mult_batch_dyes_cost+=$dyes_chemical_arr[$b_id][6]['chemical_cost']; 


								 $batch_weight=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
								 $first_chemi_cost=$first_dyeing_cost=0;$tot_chemicalCost_fin=$tot_dyesCost_fin=0;$tot_fin_cost=0;
								 if($non_reding_batch_id[$s_bid]!="")
								 {
									 
									 $issue_amt_deys=0;$issue_amt_chemical=$totalcost=0;$issue_amt_chemical_fin=0;$issue_amt_deys_fin=0;
									 $batchIdArr="";$tot_chemicalCost=$tot_dyesCost=0;$tot_chemical_Cost_fin=$tot_dyes_Cost_fin=0;
									 foreach($ReqIdsArr as $reqId)
									 {
										//print_r($ReqIdsArr);

										//print_r($reqId);

									     $chem_return_issue = $return_qty_arr[$b_id][5]['amnt']+$return_qty_arr[$b_id][7]['amnt'];
										 $dys_return_issue = $return_qty_arr[$b_id][6]['amnt'];
										 $issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										 $issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
 
										 $issue_amt_chemical_fin=$issue_item_cat_amt_dtls_fin_arr[$reqId][5]+$issue_item_cat_amt_dtls_fin_arr[$reqId][7];
										 $issue_amt_deys_fin=$issue_item_cat_amt_dtls_fin_arr[$reqId][6];
									 
										 $batch_ids=$ReqBatch_id_arr[$reqId]; 
										 $batIdArr=array_unique(explode(",",$batch_ids)); 
										 $tot_batch_wgt=0;
										 //print_r($batIdArr);
										 foreach($batIdArr as $batchId)
										 {
											 $tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt'];
										 }
									 
										 if($issue_amt_chemical>0)
										 {
										
										 $tot_chemicalCost+= (($issue_amt_chemical/$tot_batch_wgt)*$batch_weight);
										 }
										 if($issue_amt_deys>0)
										 {
										 $tot_dyesCost+= (($issue_amt_deys/$tot_batch_wgt)*$batch_weight);
										 }
 
									 }
									 if($tot_chemicalCost)
									 {
									 //$issue_amt_cal_chemical=$tot_chemicalCost-$chem_return_issue;//
									 $issue_amt_cal_chemical=$issue_amt_chemical-$chem_return_issue;//
									 } 
									 else 
									 { $issue_amt_cal_chemical=0;}
									 
									 if($tot_dyesCost)
									 {
									 //$issue_amt_cal_dyes=$tot_dyesCost-$dys_return_issue;
									 $issue_amt_cal_dyes=$issue_amt_deys-$dys_return_issue;
									 }
									 else {$issue_amt_cal_dyes=0;}
									 
									 $mult_batch_chemical_cost=$issue_amt_cal_chemical;//$costDataArr[$b_id][5]+$costDataArr[$b_id][7];
									 $mult_batch_dyes_cost=$issue_amt_cal_dyes;//$costDataArr[$b_id][6];
									 
								 }





				                 $mult_batch_dyes_chemical_cost=$mult_batch_chemical_cost+$mult_batch_dyes_cost;
				                 $multi_batch_qty_total+=$mulib_batch_weight;
				                 $mult_batch_chemical_cost_total+=$mult_batch_chemical_cost;
				                 $mult_batch_dyes_cost_total+=$mult_batch_dyes_cost;
				                 $mult_batch_dyes_chemical_cost_total+=$mult_batch_dyes_chemical_cost;
				                 
				                 $multi_date="";
				                 foreach(array_unique($batch_date_arr) as $m_date)
				                 {
				                 if($multi_date!="") $multi_date.=",".change_date_format($m_date); else $multi_date=change_date_format($m_date);
				                 }
								//echo $ref_no.'='.$file_no;
								 
								 
				                ?><p><? echo $multi_date; ?></p></td>  
				                 <td width="100"><p><? echo implode(",",array_unique(explode(",",$multi_batch_machine))); ?></p> </td>                               
				                <td width="100" ><p> <?
									 echo $batch_nos;
									 ?>
				                    </p> </td>
				                <td width="80" align="center"><p><? echo $file_no; ?></p></td>
				                <td width="80" align="center" title="PO/Sample Ref no"><p><?  echo $ref_no; ?></p></td>
				                <td width="100"><p><? echo implode(",",array_unique(explode(",",$muli_batch_floor_name))); ?></p></td> 
				                <td width="80" align="center"><p><? echo implode(",",array_unique($multi_batch_buyer_name)); ?></p></td>  
				                <td width="100" align="center"><p><? echo implode(",",array_unique($multi_batch_booking_no)); ?></p></td> 
				                <td width="100" align="center"><p><? echo implode(",",array_unique($multi_batch_job_no)); ?></p></td> 
				                 <td width="80" align="center"><p><? echo implode(",",array_unique($season_data)); ?></p></td> 
				                <td width="100" align="center"><p><? echo implode(",",array_unique($multi_batch_style_no)); ?></p></td> 
				                <td width="100" align="center"><p><? echo  implode(",",array_unique(explode(",",$po_no)));//echo implode(",",array_unique(explode(",",$po_number_data_all)));//?></p></td>
				                <td width="100" align="center"><p><? echo implode(",",array_unique(explode(",",$multi_batch_color))); ?></p></td>
				                <td width="100" align="center"><p><? echo implode(",",array_unique(explode(",",$multi_batch_color_range))); ?></p></td> 
				                <td width="100"><p><?
								 $type_name="";
								$arra_type= array_unique($multiple_batch_id);
								//print_r($fabric_type_arr);
								foreach($arra_type as $v)
								{
									//echo $v;
									if($fabric_type_arr[$v]['fabric_type'])
									{
										if($type_name) $type_name.=",".$fabric_type_for_dyeing[$fabric_type_arr[$v]['fabric_type']];
										else $type_name.=$fabric_type_for_dyeing[$fabric_type_arr[$v]['fabric_type']];
									}
								}
								 echo $type_name; ?></p></td>  
				                <td width="80" align="right"><p><? echo $mulib_batch_weight; ?></p></td>
				                <td width="100" align="right"><p><? echo number_format($mult_batch_chemical_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_batch_dyes_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_batch_dyes_chemical_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_batch_dyes_chemical_cost/$mulib_batch_weight,4); ?></p></td>
				                <td width="80" align="right"><p><?  echo implode(",",array_unique(explode(",",$remulti_batch_date))); ?></p></td>
				                <td width="70" align="right"><p><?  echo $multiBatch_extension; ?></p></td>
				                <td width="100" align="right"><p><?  echo implode(",",array_unique(explode(",",$re_floor))); ?></p></td>
				                <td width="100" align="right"><p>
				                <? echo number_format($re_dying_multi_batch_chemical_cost,4); $tot_closing_stock+=$closingStock; ?></p>
				                </td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_multi_batch_dying_cost,4); ?></p></td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_multi_batch_dyes_chemical_cost,4);  ?></p></td>
				                <td width="110" align="right"><? echo number_format($re_dying_multi_batch_dyes_chemical_cost/$mulib_batch_weight,4); ?></td>
				                <td width="70" align="right"><? echo  number_format($re_dying_multi_batch_dyes_chemical_cost+$mult_batch_dyes_chemical_cost,4);  ?></td>
				                <td width="70" align="right"><? echo number_format(($re_dying_multi_batch_dyes_chemical_cost+$mult_batch_dyes_chemical_cost)/$mulib_batch_weight,4);; ?></td>
				                <td width="" align="center"><? 
				                if($dye_result!="") $result.=",".$dyeing_result[$result_arr[$s_bid]];
					            else $dye_result=$dyeing_result[$result_arr[$s_bid]];
					            echo implode(",",array_unique(explode(",",$dye_result)));
				                //echo $daysOnHand;//$daysOnHand; ?></td>
				            </tr>
							<? 
							unset($new_redying_arr);
							unset($new_redying_arr1);
																			
							$j++; 		
						}		
					}
					?>
		        </table>
	        </div>
	        <table width="2970" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer">
		        <tfoot>
	            	<tr>
	                	<th width="40">&nbsp;</th>
	                	<th width="80">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                    <th width="80">&nbsp;</th>
	                    <th width="80">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                	<th width="80">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                      <th width="80">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                    <th width="80" id="value_total_batch_weight_multiple"><? echo number_format($multi_batch_qty_total,4); ?></th>
	                	<th width="100" id="value_total_chemical_cost_multiple"><? echo number_format($mult_batch_chemical_cost_total,4); ?></th>
	                	<th width="110" id="value_total_dyeing_cost_multiple"><? echo number_format($mult_batch_dyes_cost_total,4); ?></th>
	                    <th width="110" id="value_total_chemical_price_multiple"><? echo number_format($mult_batch_dyes_chemical_cost_total,4); ?></th>
	                    <th width="110" id="value_total_cost_per_kg_multi"><? echo number_format($mult_batch_dyes_chemical_cost_total/$multi_batch_qty_total,3); ?></th>
	                    <th width="80"><? //echo number_format($mult_batch_dyes_chemical_cost_total/$multi_batch_qty_total,3); ?></th>
	                    <th width="70"><? //echo number_format($tot_rec_return,3); ?></th>
	                    <th width="100"><? //echo number_format($tot_total_issue,3); ?></th>
	                    <th width="100" id="value_total_chemical_cost_multi"><? echo number_format($re_dying_multi_batch_chemical_cost_total,4); ?></th>
	                    <th width="100" id="value_total_redying_dying_cost_multiple"><p><? echo number_format($re_dying_multi_batch_dying_cost_total,4); ?></p></th>
	                    <th width="100" id="value_total_redying_all_cost_multiple"><p><? echo number_format($re_dying_multi_batch_dyes_chemical_cost_total,4); ?></p></th>
	                    <th width="110" id="value_total_redye_cost_per_kg_multi"><? echo number_format(($re_dying_multi_batch_dyes_chemical_cost_total/$multi_batch_qty_total),4); ?></th>
	                    <th width="70" id="value_grand_total_cost_multiple"><? echo number_format($mult_batch_dyes_chemical_cost_total+$re_dying_multi_batch_dyes_chemical_cost_total,4); ?></th>
	                    <th width="70" id="value_total_total_per_kg_cost_multi"><? echo number_format(($mult_batch_dyes_chemical_cost_total+$re_dying_multi_batch_dyes_chemical_cost_total)/$multi_batch_qty_total,4); ?></th>
	                    <th width="">&nbsp;</th>
	                </tr>
	            </tfoot>
	        </table>
      	</div>
  	</div>
	  <div>
        <div  align="left" style="font-size:25px">Subcontract Order</div>
        <table width="3030" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>
                    <th rowspan="2" width="80">Date</th>
                    <th rowspan="2" width="100">Machine No</th>
                    <th rowspan="2" width="100">Batch No</th>
                    <th rowspan="2" width="80">File No</th>
                    <th rowspan="2" width="80">Ref. No</th>
                    <th rowspan="2" width="100">Floor Name</th>
                    <th rowspan="2" width="100">Buyer</th>
                    <th rowspan="2" width="100">Booking No</th>
                    <th rowspan="2" width="100">Job no</th>
                    <th rowspan="2" width="80">Season</th>                  
                    <th rowspan="2" width="">Style</th>
                    <th rowspan="2" width="100">Order No</th>
                    <th rowspan="2" width="100">Color Name</th>
                    <th rowspan="2" width="100">Color Range</th>
                    <th rowspan="2" width="100">Fabric Type </th>
                    <th rowspan="2" width="100">Batch Qty (Kg)</th>
                    <th colspan="4"  width="">First Dying And Finishing Cost</th>
                    <th colspan="7" width="">Subsequent Dyeing and Finishing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per Kg Cost (Tk)</th>
                    <th rowspan="2" width="100">Result</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>
                    <th width="100">Extention Batch Date</th>
                    <th width="70">Extention No</th>
                    <th width="100">Floor Name</th>
                    <th width="100">Ttl Chem Cost(Tk)</th>
                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100"><p>Re-Dye Cost per kg (Tk)</th>
                </tr> 
            </thead>
        </table>
        <div style="width:3050px; max-height:400px;  overflow-y:scroll" id="scroll_body">
	        <table width="3030" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_id" >
	            <tbody>
			       	<?
				    //echo "<pre>";
					//print_r($issue_single_batch_arr);die;
					$tot_main_batch_weight=0;
					foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
						
							$ReqId=rtrim($ReqIdArr[$b_id],',');
							$ReqIds=implode(", ",array_unique(explode(",",$ReqId)));
							$ReqIdsArr=array_unique(explode(",",$ReqId));

							$tot_batch_weight=0;
							$tot_batch_weight=$batch_description_arr[$b_id]['batch_weight'];
							
							if($i%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
							$all_po_id=explode(",",$po_break_down_id_arr[$batch_description_arr[$b_id]['booking_no']]);
							$po_number_data="";
							$job_no_data="";$file_no="";$ref_no="";
							foreach($all_po_id as $p_id) // $po_number_arr[$row[csf('id')]]['po_no']
							{
								if($po_number_data!="") $po_number_data.=",".$po_number_arr[$p_id]['po_no'];	 else $po_number_data=$po_number_arr[$p_id]['po_no'];
								if($job_no_data!="") $job_no_data.=",".$po_number_arr[$p_id]['job'];	 else $job_no_data=$po_number_arr[$p_id]['job'];
								if($season_data!="") $season_data.=",".$season_name_arr[$po_number_arr[$p_id]['season']];	 else $season_data=$season_name_arr[$po_number_arr[$p_id]['season']];
								if($file_no!="") $file_no.=",".$po_number_arr[$p_id]['file_no'];	 else $file_no=$po_number_arr[$p_id]['file_no'];
								if($ref_no!="") $ref_no.=",".$po_number_arr[$p_id]['ref_no'];	 else $ref_no=$po_number_arr[$p_id]['ref_no'];
							} 
							$color_range_id=$batch_description_arr[$b_id]['color_range'];
							$file_cond=implode(", ",array_unique(explode(",",$file_no)));
							$ref_cond=implode(", ",array_unique(explode(",",$ref_no)));
							if($batch_description_arr[$b_id]['without_order']==1 && $ref_cond=="")
							{
							$ref_cond=$sample_booking_ref_no_arr[$batch_description_arr[$b_id]['booking_no']];
							}
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="30"><? echo $i; ?></td>								
				                <td width="80"><? echo change_date_format($batch_description_arr[$b_id]['batch_date']); ?></td>
				                <td width="100"><p><? echo $machine_name_arr[$b_id]; ?></p></td>                                 
				                <td width="100"><p><A href="##"  onClick="subprocess_fabric_dtls('<? echo $b_id; ?>','<? echo $batch_arr[$b_id]; ?>','subprocess_fabrics_dtls_popup')"><p><? echo $batch_arr[$b_id]; ?></p></A><? //echo $batch_arr[$b_id]; ?></p></td>
				                <td width="80"><p><? echo $file_cond; ?></p></td>
				                <td width="80" title="PO/Sample Ref no"><p><? echo $ref_cond; ?></p></td>
				                <td width="100"><p><? echo $floor_arr[$b_id]; ?></p></td> 
				                <?
				                if($batch_description_arr[$b_id][entry_form]==36)
				                {
					                ?>
					                <td width="100"><p><? echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][party_id]))); ?></p></td> 
					                <td width="100"><p><? // echo $b_id; ?></p></td>
					                <td width="100" align="center"><p>
					                <? 
				                     echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                 <td width="80" align="center"><p>
					                <? 
				                     //echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                <td width="100" align="center"><p> <? echo   implode(",",array_unique(explode(",",$sub_con_arr[$b_id][cust_style_ref]))); ?></p></td>
					                <td width="100" align="center"><p> <? echo implode(",",array_unique(explode(",",$sub_con_arr[$b_id][order_no]))); ?></p></td>
				                	<?
				                }
				                else
				                {
					                ?>
					                <td width="100"><p><? 
					                if($batch_description_arr[$b_id]['without_order']==1) $buyerName=$non_buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];else $buyerName=$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
					                <td width="100"><p><? echo $batch_description_arr[$b_id]['booking_no']; ?></p></td>
					                <td width="100" align="center"><div style="word-break:break-all">
					                <?
					                echo implode(", ",array_unique(explode(",",$job_no_data)));
					                ?></div></td>
					                <td width="80" align="center"><div style="word-break:break-all">
					                <? 
					                
					                echo implode(", ",array_unique(explode(",",$season_data)));

					                ?></div></td>
					                <td width="" align="center"><div style="word-break:break-all"> 
					                <? 
					                $style_no=array();
					                foreach(array_unique(explode(",",$job_no_data)) as $j_no)
					                {
					                    if($style_no!="")  $style_no[]=$style_library[$j_no];
					                }
					                echo implode(", ",array_unique($style_no)); ?></div></td>
					                <td width="100" align="center"><div style="word-break:break-all"> <? echo implode(", ",array_unique(explode(",",$po_number_data))); ?></div></td>
					                <?	
				                }
				                ?>
				                <td width="100" align="center"><div style="word-break:break-all"><? echo $color_arr[$batch_description_arr[$b_id]['color_id']]; ?></div></td> 
				                <td width="100" align="center"><p><? echo $color_range[$color_range_id]; ?></p></td> 
				                <td width="100" align="center"><p><? echo $fabric_type_for_dyeing[$fabric_type_arr[$b_id]['fabric_type']]; //$fabric_type_for_dyeing?></p></td> 
				                <td width="100" align="right"><p>
				                <? echo $batch_description_arr[$b_id]['batch_weight']; $total_batch_weights+=$batch_description_arr[$b_id]['batch_weight'] ;?>
				                </p></td> 
				                <?
				                
								$batch_weight=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
				                $first_chemi_cost=$first_dyeing_cost=0;$tot_chemicalCost_fin=$tot_dyesCost_fin=0;$tot_fin_cost=0;
				                if($non_reding_batch_id[$b_id]!="")
				                {
				                    
									$issue_amt_deys=0;$issue_amt_chemical=$totalcost=0;$issue_amt_chemical_fin=0;$issue_amt_deys_fin=0;
									$batchIdArr="";$tot_chemicalCost=$tot_dyesCost=0;$tot_chemical_Cost_fin=$tot_dyes_Cost_fin=0;
									foreach($ReqIdsArr as $reqId)
									{
										$chem_return_issue = $return_qty_arr[$b_id][5]['amnt']+$return_qty_arr[$b_id][7]['amnt'];
										$dys_return_issue = $return_qty_arr[$b_id][6]['amnt'];
										$issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										$issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];

										$issue_amt_chemical_fin=$issue_item_cat_amt_dtls_fin_arr[$reqId][5]+$issue_item_cat_amt_dtls_fin_arr[$reqId][7];
										$issue_amt_deys_fin=$issue_item_cat_amt_dtls_fin_arr[$reqId][6];
									
									    $batch_ids=$ReqBatch_id_arr[$reqId]; 
										$batIdArr=array_unique(explode(",",$batch_ids)); 
										$tot_batch_wgt=0;
									    //print_r($batIdArr);
										foreach($batIdArr as $batchId)
										{
											$tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt'];
										}
									
										if($issue_amt_chemical>0)
										{
										$tot_chemicalCost+= (($issue_amt_chemical/$tot_batch_wgt)*$batch_weight);
										}
										if($issue_amt_deys>0)
										{
										$tot_dyesCost+= (($issue_amt_deys/$tot_batch_wgt)*$batch_weight);
										}

									}
									if($tot_chemicalCost)
									{
									$issue_amt_cal_chemical=$tot_chemicalCost-$chem_return_issue;//
									} 
									else 
									{ $issue_amt_cal_chemical=0;}
									
									if($tot_dyesCost)
									{
									$issue_amt_cal_dyes=$tot_dyesCost-$dys_return_issue;
									}
									else {$issue_amt_cal_dyes=0;}
									
				                    $first_chemi_cost=$issue_amt_cal_chemical;//$costDataArr[$b_id][5]+$costDataArr[$b_id][7];
				                    $first_dyeing_cost=$issue_amt_cal_dyes;//$costDataArr[$b_id][6];
									
				                }

				               // $first_chemi_cost=$first_dyeing_cost=0;
				                if($non_reding_batch_id[$b_id]!="")
				                {
				                   // $first_chemi_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                    //$first_dyeing_cost=$dyes_chemical_arr[$b_id][6]['chemical_cost'];
									$tot_main_batch_weights+=$batch_description_arr[$b_id]['batch_weight'];
				                }
				                
				                ?>
				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($first_chemi_cost,4,".",""); 
				                 $total_chemical_costs+=$first_chemi_cost;
				                 ?>
				                </p></td>
				                <td width="100" align="right"><p>
				                <?  
				                    echo number_format($first_dyeing_cost,4,".",""); 
				                    $total_dyes_costs+=$first_dyeing_cost; 
				                ?>
				                </p></td>
				                <td width="100" align="right"><p><A href="##"  onClick="fn_1st_batch('<? echo $b_id; ?>','1st_batch_dtls_popup')">
				                <?
				                 $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
				                  echo number_format($batch_chemical_price,4,".","");
				                  $total_batch_chemical_prices+=$batch_chemical_price;
				                ?>
				                </A></p></td>
				                <td width="100" align="right"><p><? echo number_format($batch_chemical_price/$batch_description_arr[$b_id]['batch_weight'],4,".",""); $tot_total_receive+=$totalReceive; ?></p></td>
				                <td width="100" align="right"><p>
				                <? 
				                $extension_no="";
				                $re_batch_date="";
				                $batch_date=explode(",", $redying_details_arr[$b_id]['batch_date']);	
				                foreach($batch_date as $ash_date)
				                {
				                 if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                }
				                echo $re_batch_date;
				                 ?></p></td>
				                <td width="70" align="right"><p>
				                <?		                
				                //echo $redying_details_arr[$b_id]['id'].jahid;
				                if(trim($redying_details_arr[$b_id]['id']))
				                {
				                    $re_dying_id_all=explode(",",$redying_details_arr[$b_id]['id']);
				                    //$re_dying_chemical_cost=0;
				                    //$re_dying_dyes_cost=0;
				                    //$re_dying_dyes_chemical_cost=0;
				                    
				                    $result_id="";
				                    $result_id_last='';
				                    
				                    foreach($re_dying_id_all as $ash_id)
				                    {
				                    //$re_dying_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                    //$re_dying_dyes_cost+=$dyes_chemical_arr[$ash_id][6]['chemical_cost']	;	
				                    //$re_dying_dyes_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][6]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                        
				                     if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                     //if($re_floor!="") $re_floor.=",".$floor_arr[$ash_id]; else $re_floor=$floor_arr[$ash_id];
				                    /* echo $ash_id.tipu;
				                     $result_id=$result_arr[$ash_id];
				                     if($result_id!="")  $result_id_last=$result_id;*/
				                    }
				                }
				                //echo $b_id;
				                //if($batch_type==3)
				                //{
				                echo $redying_details_arr[$b_id]['extention_no'];	 ?>
				                
				                
				                </p></td>
				                <td width="100" align="right"><p><?
				                $re_floors='';
				                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
				                //print_r($reding_batch_id);//echo $reding_batch_id[$b_id]."##".$b_id;
				                if($reding_batch_id[$b_id]!="")
				                {
				                    $re_floors=$floor_arr[$b_id];
				                    $re_dying_chemical_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                    $re_dying_dyes_cost=$dyes_chemical_arr[$b_id][6]['chemical_cost']	;	
				                    $re_dying_dyes_chemical_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][6]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                }
				                
				                echo $re_floors;
				                ?></p></td>
				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($re_dying_chemical_cost,4,".",""); 
				                 $tot_re_dying_chemical_costs+=$re_dying_chemical_cost;
				                 ?>
				                 </p></td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_dyes_cost,4,".",""); $tot_re_dying_dyes_costs+=$re_dying_dyes_cost;  ?></p></td>
				                <td width="100" align="right"><A href="##"  onClick="fn_total_batch('<? echo $b_id; ?>','total_batch_dtls_popup')"><p><? echo number_format($re_dying_dyes_chemical_cost,4,".",""); $tot_re_dying_dyes_chemical_costs+=$re_dying_dyes_chemical_cost; ?></p></A></td>
				                <td width="100" align="right" title="Total Chemical And Dyes/BatchWeight"><? echo number_format($re_dying_dyes_chemical_cost/$batch_description_arr[$b_id]['batch_weight'],4,".",""); ?></td>
				                

				                <td width="100" align="right"><? echo number_format($re_dying_dyes_chemical_cost+$batch_chemical_price,4,".",""); ?></td>
				                <td width="100" align="right" title="<? echo '('.$re_dying_dyes_chemical_cost.'+'.$batch_chemical_price.')/'.$batch_description_arr[$b_id]['batch_weight']; ?>"><? echo number_format(($re_dying_dyes_chemical_cost+$batch_chemical_price)/$batch_description_arr[$b_id]['batch_weight'],4,".","");  ?></td>
				                <td width="100" align="center" title="<? echo $b_id; ?>"><? //echo $unload_result_arr[$b_id]//echo  $dyeing_result[$result_id];//
				                //echo $b_id.tipu;
			                    $result_id=$result_arr[$b_id];
			                    if($result_id!="")  $result_id_last=$result_id;
				                echo $dyeing_result[$result_id];//$dyeing_result;//$daysOnHand; ?></td>
				            </tr>
							<? 												
								 $i++; 			
						}	
					}
					?>
	            </tbody>
	      	</table>
      	</div>
       	<table width="3030" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="80">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                   <th width="80">&nbsp;</th>
                    <th width="">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="100"><? //echo number_format($total_batch_chemical_price,4).'='.$total_dyes_cost; ?></th>
                	<th width="100">Total</th>
                    <th width="100" id="value_total_batch_weight_single"><? echo number_format($total_batch_weights,4); ?></th>
                	<th width="100" id="value_total_chemical_cost_single"><? echo number_format($total_chemical_costs,4); ?></th>
                	<th width="100" id="value_total_dyeing_cost_single"><? echo number_format($total_dyes_costs,4); ?></th>
                    <th width="100" id="value_total_chemical_price_single"><? echo number_format($total_batch_chemical_prices,4); ?></th>
                    <th width="100"><? echo number_format(($total_batch_chemical_prices/$total_batch_weights),4); ?></th>
                    <th width="100"><? //echo number_format($tot_re_dying_chemical_cost,3); ?></th>
                    <th width="70"><? //echo number_format($tot_rec_return,3); ?></th>
                    <th width="100"><? //echo number_format($tot_total_issue,3); ?></th>
                    <th width="100" id="value_total_redying_chemic_oost_single"><? echo number_format($tot_re_dying_chemical_costs,4); ?></th>
                    <th width="100" id="value_total_redying_dying_cost_single"><p><? echo number_format($tot_re_dying_dyes_costs,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single"><p><? echo number_format($tot_re_dying_dyes_chemical_costs,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single_tk"><? echo number_format($tot_re_dying_dyes_chemical_costs/$total_batch_weights,4); ?></th>
                    <th width="100" id="value_total_total_cost_single"><? echo number_format($total_batch_chemical_prices+$tot_re_dying_dyes_chemical_costs,4); ?></th>
                    <th width="100" title="Main Batch Qty=<? echo number_format($tot_main_batch_weights,2);?>"><? echo number_format(($total_batch_chemical_prices/$total_batch_weights),4); ?></th>
                    <th width="100">&nbsp;</th>
                </tr>
            </tfoot>
        </table>
    </div>
    <?
    $html = ob_get_contents();
    ob_clean();
    //$new_link=create_delete_report_file( $html, 2, $delete, "../../../" );
    foreach (glob("*.xls") as $filename) {
    //if( @filemtime($filename) < (time()-$seconds_old) )
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');	
    $is_created = fwrite($create_new_doc, $html);


    $filename2=$user_id."_summary_".$name.".xls";
    $create_new_doc2 = fopen($filename2, 'w');	
    $is_created2 = fwrite($create_new_doc2, $summaryHTML);

    echo "$html****$filename****$filename2****$report_type"; 
    exit();
}

if($action=="generate_report7") // Show 2
{ 
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if ($cbo_company_name==0) $company_id=""; else $company_id=" and a.company_id='$cbo_company_name'";
	if ($cbo_company_name==0) $company_idcond =""; else $company_idcond =" and b.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond .=""; else $company_idcond .=" and b.working_company_id='$cbo_working_name'";
	$from_date=str_replace("'","",$from_date);
	$to_date=str_replace("'","",$to_date);
	//echo $from_date;
	$txt_ref_no=str_replace("'","",$txt_ref_no);
	$txt_file_no=str_replace("'","",$txt_file_no);
	$txt_booking_no=str_replace("'","",$txt_booking_no);
	$txt_po_no=str_replace("'","",$txt_po_no);
	$txt_job=str_replace("'","",$txt_job);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$cbo_season_id=str_replace("'","",$cbo_season_id);
	$txt_samp_ref_no=str_replace("'","",$txt_samp_ref_no);
	$location_id=str_replace("'","",$location_id);
	$floor_id=str_replace("'","",$floor_id);
	$report_type=str_replace("'","",$report_type);

	$floor_cond_arr=array();

	if(!empty($location_id))
	{
		if(!empty($floor_id))
		{
			
			
			$sql="select  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 and b.company_id=$cbo_working_name and b.location_id=$location_id and b.production_process=3 and b.id=$floor_id";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) {
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}else{
			$sql="select  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 and b.company_id=$cbo_working_name and b.location_id=$location_id and b.production_process=3";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) {
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		$floor_cond_arr=array_unique($floor_cond_arr);
	}
	//print_r($floor_cond_arr);
	
	if(str_replace("'","",$cbo_buyer_name)==0)
	{
		if ($_SESSION['logic_erp']["data_level_secured"]==1)
		{
			if($_SESSION['logic_erp']["buyer_id"]!="") $buyer_id_cond=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")"; else $buyer_id_cond="";
		}
		else
		{
			$buyer_id_cond="";
		}
	}
	else
	{
		$buyer_id_cond=" and a.buyer_name in (".str_replace("'","",$cbo_buyer_name).")";
	}
	
	if($txt_booking_no!='') $booking_no_cond="and b.booking_no like '%$txt_booking_no%' ";else $booking_no_cond="";
	
	if($txt_file_no!='') $file_cond="and b.file_no='$txt_file_no'";else $file_cond="";
	if($txt_job!='') $job_cond="and a.job_no_prefix_num=$txt_job";else $job_cond="";
	if($txt_po_no!='') $po_cond="and b.po_number='$txt_po_no'";else $po_cond="";
	
	if($cbo_season_id!=0) $season_cond="and a.season_buyer_wise in($cbo_season_id)";else $season_cond="";
	
	if($txt_ref_no!='') $ref_cond="and b.grouping='$txt_ref_no'";else $ref_cond="";
	if($txt_samp_ref_no!='') $samp_ref_cond="and a.grouping='$txt_samp_ref_no'";else $samp_ref_cond="";
	//echo $ref_cond;
	$companyArr = return_library_array("select id,company_name from lib_company where status_active=1 and is_deleted=0","id","company_name"); 
	$supplierArr = return_library_array("select id,supplier_name from lib_supplier where status_active=1 and is_deleted=0","id","supplier_name"); 
	$color_arr=return_library_array( "select id,color_name  from  lib_color", "id", "color_name"  );
	$season_name_arr=return_library_array( "select id,season_name  from  lib_buyer_season", "id", "season_name"  );// id, season_name from lib_buyer_season
	//$batch_arr=return_library_array( "select id, batch_no from  pro_batch_create_mst", "id", "batch_no");
   // $po_number_arr=return_library_array(" select  id ,po_number from   wo_po_break_down", "id", "po_number" );
	//$job_no_arr=return_library_array(" select  id ,job_no_mst from   wo_po_break_down", "id", "job_no_mst" );
	//$po_break_down_id_arr=return_library_array( "select booking_no,po_break_down_id from  wo_booking_mst ", "booking_no", "po_break_down_id" );
    $floor_arr=return_library_array("select  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0", "batch_id", "floor_name" );

    //$unload_result_arr=return_library_array("select a.batch_id, a.result from  pro_fab_subprocess a where a.entry_form=35 and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0", "batch_id", "result" );

	$machine_name_arr=return_library_array("select  a.batch_id ,b.machine_no from   pro_fab_subprocess a, lib_machine_name b  where a.machine_id=b.id and a.entry_form=35 and  b.status_active=1 and b.is_deleted=0", "batch_id", "machine_no" );
	//$buyer_name_arr=return_library_array( "select a.booking_no,b.buyer_name from  wo_booking_mst a, lib_buyer b where a.buyer_id=b.id", "booking_no", "buyer_name" );
	//$non_buyer_name_arr=return_library_array( "select a.booking_no,b.buyer_name from  wo_non_ord_samp_booking_mst a, lib_buyer b where a.buyer_id=b.id", "booking_no", "buyer_name" );
	$sql_book=sql_select("select a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b where a.buyer_id=b.id");
	foreach($sql_book as $row)
	{
		$buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$po_break_down_id_arr[$row[csf('booking_no')]]=$row[csf('po_break_down_id')];
	}
	
    $buyer_library=return_library_array( "select id,buyer_name from   lib_buyer", "id","buyer_name" );
   // $style_library=return_library_array( "select job_no,style_ref_no from   wo_po_details_master", "job_no","style_ref_no" );
	$po_data_subcon=sql_select("select a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0  ");
	
	$sub_con_arr=array();
	foreach($po_data_subcon as $row)
	{
		if($sub_con_arr[$row[csf('mst_id')]][cust_style_ref]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref].=",".$row[csf('cust_style_ref')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref]=$row[csf('cust_style_ref')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][order_no]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no].=",".$row[csf('order_no')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no]=$row[csf('order_no')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][subcon_job]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job].=",".$row[csf('subcon_job')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job]=$row[csf('subcon_job')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][party_id]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id].=",".$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id].=",".$row[csf('party_id')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id]=$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id]=$row[csf('party_id')];	
		}
	}
	//print_r($sub_con_arr[646]);die;
	
	if($db_type==0) 
	{
	$from_date=change_date_format($from_date,'yyyy-mm-dd'); $to_date=change_date_format($to_date,'yyyy-mm-dd');
	}
    if($db_type==2) 
	{
	$from_date=change_date_format($from_date,'','',1);  $to_date=change_date_format($to_date,'','',1);
	}
	//echo $from_date;
	
	
	$batch_description_arr=array();
	/* 
	if(str_replace("'","",$batch_id)!="") $batch_cond=" and b.id in(".str_replace("'","",$batch_id).")";
    else  */
	
	
	//echo $batch_cond; //die;
	//echo $batch_no; //die;
    	//echo $batch_no;
	$batch_no=implode("','",array_unique(explode(",",$batch_no)));
	
	if(str_replace("'","",$batch_no)!="") $batch_cond=" and b.batch_no in('".$batch_no."') "; 
	else $batch_cond="";
	//echo $batch_cond."shakil"; die;
	
	//
	/* and b.re_dyeing_from=0 13-11-16 according to siddique sir dicission when search buyer order or subcontract all batch appear */
	if($batch_type==0)
	$search_field_cond_batch="and b.entry_form in (0,36) and b.re_dyeing_from=0";
	else if($batch_type==1)
	$search_field_cond_batch="and b.entry_form=0 ";
	else if($batch_type==2)
	$search_field_cond_batch="and b.entry_form=36";
	else 
	$search_field_cond_batch="and b.entry_form in(0,36) and b.batch_against in(2) and  b.re_dyeing_from!=0 ";
	//$redyeing="and b.batch_against in(2)";
	//echo  $search_field_cond_batch;die;
	//$po_number_arr=return_library_array(" select  id ,po_number from   wo_po_break_down", "id", "po_number" );
	$sql_po=("select a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b  where a.job_no=b.job_no_mst and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond");
	 
	$res_po=sql_select($sql_po);
	$all_po_id='';
	foreach($res_po as $row) //$job_no_arr
	{
		$po_number_arr[$row[csf('id')]]['po_no']=$row[csf('po_number')];
		$po_number_arr[$row[csf('id')]]['ref_no']=$row[csf('ref_no')];
		$po_number_arr[$row[csf('id')]]['file_no']=$row[csf('file_no')]; 
		$po_number_arr[$row[csf('id')]]['season']=$row[csf('season_buyer_wise')]; 
		$po_number_arr[$row[csf('id')]]['job']=$row[csf('job_no_mst')];
		$job_no_arr[$row[csf('id')]]=$row[csf('job_no_mst')];
		$style_library[$row[csf('job_no_mst')]]=$row[csf('style_ref_no')];
		if($all_po_id=="") $all_po_id=$row[csf('id')]; else $all_po_id.=",".$row[csf('id')]; //echo $all_po_id;
	}
	//echo $all_po_id;
	if($txt_file_no!='' || $txt_ref_no!='' ||  $txt_po_no!='' || $txt_job!='' || $cbo_buyer_name>0)
	{
		if($all_po_id!="") $po_idd="and po_id in($all_po_id)";else $po_idd="and po_id in(0)";
		//echo $po_idd;
		//echo "select LISTAGG(CAST( mst_id  AS VARCHAR(4000)), ',') WITHIN GROUP (ORDER BY mst_id) as batch_id from pro_batch_create_dtls where status_active=1 and is_deleted=0 $po_idd";
		/*if($db_type==0) $group_con="group_concat(mst_id) as batch_id";
		else  $group_con="LISTAGG(CAST( mst_id  AS VARCHAR(4000)), ',') WITHIN GROUP (ORDER BY mst_id) as batch_id";
		$batch_ids=return_field_value("$group_con","pro_batch_create_dtls","status_active=1 and is_deleted=0 $po_idd","batch_id");
		if($batch_ids!="") $batch_id_cond="and b.id in($batch_ids)"; else $batch_id_cond="";	*/	
		$poIds=chop($all_po_id,','); $po_cond_for_in="";
		$po_ids=count(array_unique(explode(",",$all_po_id)));
		if($db_type==2 && $po_ids>1000)
		{
			$po_cond_for_in=" and (";
			$poIdsArr=array_chunk(explode(",",$poIds),999);
			foreach($poIdsArr as $ids)
			{
				$ids=implode(",",$ids);
				$po_cond_for_in.=" po_id in($ids) or"; 
			}
			$po_cond_for_in=chop($po_cond_for_in,'or ');
			$po_cond_for_in.=")";
		}
		else
		{
			$po_cond_for_in=" and po_id in($poIds)";
			
		}
		
		
		//echo "select mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in";die;
		$sql_batch=sql_select("select mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in");
		 $all_batch_id='';
		foreach($sql_batch as $row) 
		{
			if($all_batch_id=="") $all_batch_id=$row[csf('batch_id')]; else $all_batch_id.=",".$row[csf('batch_id')];
		}
			$all_batch_ids=implode(",",array_unique(explode(",",$all_batch_id)));
		//echo $all_batch_ids; 
		$batch_ids_cond="";
		if($all_batch_ids!="") 
		{
			//echo $po_id=substr($po_id,0,-1);
			if($db_type==0) { $batch_ids_cond="and b.id in(".$all_batch_ids.")"; }
			else
			{
				$bat_id=array_unique(explode(",",$all_batch_ids));
				if(count($bat_id)>1000)
				{
					$batch_ids_cond="and (";
					$bat_id=array_chunk($bat_id,1000);
					$z=0;
					foreach($bat_id as $id)
					{
						$id=implode(",",$id);
						if($z==0) $batch_ids_cond.=" b.id in(".$id.")";
						else $batch_ids_cond.=" or b.id in(".$id.")";
						$z++;
					}
					$batch_ids_cond.=")";
				}
				else { 
				
				$batch_ids_cond=" and b.id in(".$all_batch_ids.")"; }
			}
		}
	}
	//print_r($batch_ids);die;
	if($from_date!="" && $to_date!="")
	{
		$date_cond_samp="";
		if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond_samp=" and b.batch_date between '".$from_date."' and '".$to_date."'";
		}
	}
	$samp_non_booking=sql_select("select b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

	//echo "select b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.buyer_name from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";die;
	$all_batch_id_samp="";
	foreach($samp_non_booking as $row)
	{
		$non_buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$non_buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$sample_booking_ref_no_arr[$row[csf('booking_no')]]=$row[csf('grouping')];
		if($txt_samp_ref_no!='')
		{
		if($all_batch_id_samp=="") $all_batch_id_samp=$row[csf('batch_id')]; else $all_batch_id_samp.=",".$row[csf('batch_id')];
		}
	}
	if($all_batch_id_samp!="") $all_batch_id_samp_cond="and b.id in($all_batch_id_samp)";else $all_batch_id_samp_cond="";
	//echo $all_batch_id_samp_cond.'X';
	
    if($from_date!="")
    {
		if(str_replace("'","",$cbo_value_with)==1)
		{
			$date_cond=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";

			$sql=sql_select("SELECT b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
			and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
			//echo"select b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from  from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";die;
		}
		else if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond=" and b.batch_date between '".$from_date."' and '".$to_date."'";
			$sql=sql_select("select b.id,b.batch_no,b.booking_without_order,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
			from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
			//echo "select b.id,b.batch_no,b.booking_without_order,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";die;
		}
   	}
   	else
   	{
		$sql=sql_select("select b.id,b.booking_without_order,b.batch_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
		from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0 $company_idcond $batch_cond $batch_ids_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
   	}
	/*echo "select b.id,b.booking_without_order,b.batch_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
	from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0 $company_idcond $batch_cond $batch_ids_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";die;*/
  	//echo $sql;die;
  	$reding_batch_id=$non_reding_batch_id=array();
    foreach($sql as $row)
	{
		if($row[csf("batch_against")]==2)
		{
			/*if($row[csf("re_dyeing_from")]>0)
			{
				$reding_batch_id[$row[csf("re_dyeing_from")]]=$row[csf("re_dyeing_from")]; 
			}
			else
			{
				$reding_batch_id[$row[csf("id")]]=$row[csf("id")]; 
			}*/
			$reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
		else
		{
			$non_reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
		 
		$batch_id_arr[]=$row[csf("id")]; 
		$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
		$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
		$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
		$batch_description_arr[$row[csf("id")]]['batch_weight']=$row[csf("batch_weight")];
		$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
		$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
		$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
		$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
		$batch_no_arr[]="'".$row[csf("batch_no")]."'";
		$batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
	}
	 
	//print_r($batch_id_arr);
	 
	$date_cond2=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";
	$fabric_sql=sql_select("select b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
	from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
	and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 $company_idcond");
 	
  	$fabric_type_arr=array();
    foreach($fabric_sql as $row)
	{
	 	$fabric_type_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
	}

	/* echo "<pre>";
	print_r($reding_batch_id);
	echo "<pre>";
	print_r($non_reding_batch_id);die;*/
	//	***************************************************************************************************************************************************
     $batch_id_sql=implode(",",$batch_id_arr);
    if($batch_id_sql=="") $batch_id_sql=0;
	//echo  $batch_id_sql;
  	if($batch_type==3)
	{
		//$re_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond2=chop($re_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond2.=")";
		}
	}
	else
	{
		//$re_dying_cond=" and b.re_dyeing_from in(".$batch_id_sql.")";	
		//$pord_ids = explode(",",$txt_product_id);
		//echo count($pord_ids);die;
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond=chop($re_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond.=")";
		}
	}
	if($db_type==0)
	{
		if($batch_type==3)
		{
		 $sql_redying=sql_select("select b.id as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0 group by  b.id");
		}
		else
		{
			 $sql_redying=sql_select("select group_concat(b.id) as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0  $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0 group by  b.re_dyeing_from");	
		}
	}
	else
	{
	
		if($batch_type==3)
		{	
			 $sql_redying=sql_select("select b.id as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no
			  from  pro_batch_create_mst  b 
			  where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0  group by  b.id");
		}
		else
		{
			 $sql_redying=sql_select("select listagg((b.id),',') within group (order by b.id) as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no,b.re_dyeing_from 
			 from  pro_batch_create_mst b 
			 where b.re_dyeing_from!=0   $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0  group by  b.re_dyeing_from");
		}
	}
	
   	//and b.batch_against=2
    $redying_details_arr=array();
    foreach($sql_redying as $re_row)
    {
		if($batch_type==3)
		{
			$redying_details_arr[$re_row[csf("id")]]['id']=$re_row[csf("id")];
			$redying_details_arr[$re_row[csf("id")]]['batch_date']=$re_row[csf("batch_date")];
			$redying_details_arr[$re_row[csf("id")]]['extention_no']=$re_row[csf("extention_no")];
		}
		else
		{
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['id']=$re_row[csf("id")];
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['batch_date']=$re_row[csf("batch_date")];
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['extention_no']=$re_row[csf("extention_no")];
		}
    }
	
	//echo "<pre>"; print_r($redying_details_arr);die;
	if($batch_type==3)
	{
		//$all_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$all_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$all_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$all_dying_cond2=chop($all_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$all_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$all_dying_cond2.=")";
		}
	}
	else
	{
		if(count($batch_id_arr)>0)
		{
			$all_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$all_dying_cond.=" b.id in(".implode(",",$batch_id).") or";
				}
				$all_dying_cond=chop($all_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$all_dying_cond.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$all_dying_cond.=")";
		}
	}
	
	if($batch_type==3)
	{
		$result_sql=sql_select("select a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2   $company_idcond $all_dying_cond2 and a.status_active=1 and a.is_deleted=0");	
	}
	else
	{
		$result_sql=sql_select("select a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2  $company_idcond $all_dying_cond and a.status_active=1 and a.is_deleted=0");
	}
	
	/*$sql_result=sql_select("select a.result,a.batch_id from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2  and a.company_id=$cbo_company_name and b.re_dyeing_from in (".$batch_id_sql.") and a.status_active=1 and a.is_deleted=0");*/
	
	$result_arr=array();
	foreach($result_sql as $value)
	{
		$result_arr[$value[csf('batch_id')]]=$value[csf('result')];	
	}
	
    $sql_dyes_cost =sql_select("select a.id,a.batch_no,a.lap_dip_no as recipe_id,b.id as trans_id,b.prod_id,b.item_category,(b.cons_amount) as dyes_chemical_cost
    from inv_issue_master a, inv_transaction b
    where a.id=b.mst_id and b.transaction_type=2 and a.entry_form=5 and a.batch_no  is not null  and   b.item_category in (5,6,7) "); 
	$dyes_chemical_arr=array();

	/*
	foreach($sql_dyes_cost as $val)
	{
		$dyes_chemical_arr[$val[csf("batch_no")]][$val[csf("item_category")]]['chemical_cost']+=$val[csf("dyes_chemical_cost")];
		$recipe_id=$val[csf("recipe_id")];
		$dyes_chemical_arr2[$val[csf("batch_no")]][$recipe_id][$val[csf("item_category")]]['chemical_cost']+=$val[csf("dyes_chemical_cost")];
		
		$recipe_chk_arr[$val[csf("batch_no")]]=$val[csf("recipe_id")];
	}*/
	 
	//**************************************************************************************************
	if($db_type==0)
	{
		$sql_dtls =sql_select("select batch_no,id from inv_issue_master  where  entry_form=5 and status_active=1 and is_deleted=0 and batch_no<>''");
	}
	else
	{
		$sql_dtls =sql_select("select batch_no,id from inv_issue_master  where  entry_form=5 and status_active=1 and is_deleted=0 and batch_no is not null");
	}
	
	//echo "select batch_no from inv_issue_master  where  entry_form=5 and status_active=1 and is_deleted=0 and batch_no is not null"; die;

	$multi_single_batch=array(); $issue_single_batch_arr=array();
	foreach($sql_dtls as $inf)
	{
		if(strpos($inf[csf("batch_no")], ",")==true)
		{
			//echo "=";
			$multi_batch_id=explode(",",$inf[csf("batch_no")]);
			$total_batch_id=count($multi_batch_id);
			$batch_match=0;
			foreach($multi_batch_id as $m_batch)
			{ 
				if(in_array($m_batch,$batch_id_arr)) {$issue_multi_batch_temp_arr[]=$m_batch;  $batch_match+=1;  }
				//$issue_single_batch_arr[$m_batch]=$m_batch;
			}
			if($batch_match==$total_batch_id) 
			{
				//echo "+";
				$issue_multi_batch_arr[]=$inf[csf("batch_no")]; 
				$multi_single_batch=array_merge($multi_single_batch, $issue_multi_batch_temp_arr); 
			}
			$mst_arr[$inf[csf("batch_no")]].=$inf[csf("id")].',';
		}
		else
		{
			//echo "||";
			if(in_array($inf[csf("batch_no")],$batch_id_arr)) { $issue_single_batch_arr[$inf[csf("batch_no")]]=$inf[csf("batch_no")];
			$mst_arr[$inf[csf("batch_no")]].=$inf[csf("id")].',';
			  } 
		}
	}
	//print_r($multi_single_batch); echo "Test";die;
	//batch_id_arr
	// 1==Topping, 2==Adding,3==Strping
	$batch_idCond=where_con_using_array($batch_id_arr,0,'b.id');
	$result_recipe_sql=sql_select("select a.id as recipe_id,b.batch_against,b.id as batch_id ,b.batch_no,a.dyeing_re_process,a.entry_form,c.prod_id
		from pro_recipe_entry_mst a, pro_batch_create_mst b,pro_recipe_entry_dtls c where b.id=a.batch_id and c.mst_id=a.id and a.entry_form in (60,445) and a.status_active=1 and a.is_deleted=0  and b.status_active=1 and b.is_deleted=0 $batch_idCond order by b.id");
		 
		foreach($result_recipe_sql as $row)
		{
			$re_dyeing_batch_chk_arr[$row[csf("batch_id")]]=$row[csf("batch_against")];
			
			if($row[csf("entry_form")]==60 && $row[csf("dyeing_re_process")]==2) //add
			{
			$batch_add_recipe_chk[$row[csf("batch_id")]]=$row[csf("dyeing_re_process")];			
			$re_dyeing_batch_arr[$row[csf("batch_id")]]=$row[csf("batch_against")];
			//For Adding -----
			$batch_recipe_adding_chk[$row[csf("recipe_id")]][$row[csf("batch_id")]]=$row[csf("dyeing_re_process")];
			$adding_batch_entry_form_arr[$row[csf("recipe_id")]][$row[csf("batch_id")]][$row[csf("prod_id")]]=$row[csf("entry_form")];

			}
			if($row[csf("entry_form")]==60 && $row[csf("dyeing_re_process")]==1) //Topping
			{
				//$batch_recipe_chk[$row[csf("batch_id")]]=$row[csf("dyeing_re_process")];			
				//$re_dyeing_batch_arr[$row[csf("batch_id")]]=$row[csf("batch_against")];
				$batch_toping_recipe_chk[$row[csf("batch_id")]]=$row[csf("dyeing_re_process")];	
				$batch_recipe_topping_chk[$row[csf("recipe_id")]][$row[csf("batch_id")]]=$row[csf("dyeing_re_process")];
				$topping_batch_entry_form_arr[$row[csf("recipe_id")]][$row[csf("batch_id")]][$row[csf("prod_id")]]=$row[csf("entry_form")];
			}
			if($row[csf("entry_form")]==60 && $row[csf("dyeing_re_process")]==3) //Striping/Redying
			{
				//$batch_recipe_chk[$row[csf("batch_id")]]=$row[csf("dyeing_re_process")];			
				//$re_dyeing_batch_arr[$row[csf("batch_id")]]=$row[csf("batch_against")];
				$strip_batch_re_proc_chk[$row[csf("batch_id")]]=$row[csf("dyeing_re_process")];	
				$batch_recipe_strip_chk[$row[csf("recipe_id")]][$row[csf("batch_id")]]=$row[csf("dyeing_re_process")];
				$strip_batch_entry_form_arr[$row[csf("recipe_id")]][$row[csf("batch_id")]][$row[csf("prod_id")]]=$row[csf("entry_form")];
			}
			
			if($row[csf("entry_form")]==445) //Finishing Recipe
			{
		 		$finishing_dyeing_batch_arr[$row[csf("batch_id")]]=$row[csf("batch_id")];
				$finishing_batch_entry_form_arr[$row[csf("recipe_id")]][$row[csf("batch_id")]][$row[csf("prod_id")]]=$row[csf("entry_form")];
			}
		}
	 unset($result_recipe_sql);
	 
	 // =======================Dyes Chemical Cost====================
	foreach($sql_dyes_cost as $val)
	{
		$mst_id=rtrim($mst_arr[$val[csf("batch_no")]],',');
		$mst_idarr=array_unique(explode(",",$mst_id));
		$first_batch_issue=min($mst_idarr);
		
		$recipe_id=$val[csf("recipe_id")];
		if($first_batch_issue==$val[csf("id")]) //First Issue batch no //
		{
		$dyes_chemical_arr[$val[csf("batch_no")]][$val[csf("item_category")]]['chemical_cost']+=$val[csf("dyes_chemical_cost")];
		$mst_first_id_arr[$val[csf("batch_no")]].=$val[csf("id")].',';
		$prod_first_id_arr[$val[csf("batch_no")]].=$val[csf("prod_id")].',';
		}
		//Finishing Check
		$finishing_batch=$finishing_batch_entry_form_arr[$recipe_id][$val[csf("batch_no")]][$val[csf("prod_id")]];
		if($finishing_batch==445)
		{
			//echo $val[csf("trans_id")].',';
		$dyes_chemical_fin_arr[$val[csf("batch_no")]][$val[csf("item_category")]]['chemical_cost']+=$val[csf("dyes_chemical_cost")];
		$mst_fin_id_arr[$val[csf("batch_no")]].=$val[csf("id")].',';
		$prod_fin_id_arr[$val[csf("batch_no")]].=$val[csf("prod_id")].',';
		}
		// For Adding array
		$batch_re_proc_recipe_adding=0;
		$batch_re_proc_recipe_adding=$batch_recipe_adding_chk[$recipe_id][$val[csf("batch_no")]];
		$add_batch=$adding_batch_entry_form_arr[$recipe_id][$val[csf("batch_no")]][$val[csf("prod_id")]];
		if($batch_re_proc_recipe_adding==2 && $add_batch==60) //Adding
		{
			//echo $recipe_id.'D';
			//echo $batch_re_proc_recipe_adding;
			$dyes_chemical_adding_arr[$val[csf("batch_no")]][$val[csf("item_category")]]['chemical_cost']+=$val[csf("dyes_chemical_cost")];
			//echo $val[csf("batch_no")].'Add';
			$mst_add_id_arr[$val[csf("batch_no")]].=$val[csf("id")].',';
			$prod_add_id_arr[$val[csf("batch_no")]].=$val[csf("prod_id")].',';
		}
		$batch_re_proc_recipe_topping=$batch_recipe_topping_chk[$recipe_id][$val[csf("batch_no")]];
		$top_batch=$topping_batch_entry_form_arr[$recipe_id][$val[csf("batch_no")]][$val[csf("prod_id")]];
		if($batch_re_proc_recipe_topping==1 && $top_batch==60) //Topping
		{
			//echo $recipe_id.'D';
			//echo $batch_re_proc_recipe_adding;
			$dyes_chemical_topping_arr[$val[csf("batch_no")]][$val[csf("item_category")]]['chemical_cost']+=$val[csf("dyes_chemical_cost")];
			$mst_topping_id_arr[$val[csf("batch_no")]].=$val[csf("id")].',';
			$prod_topping_id_arr[$val[csf("batch_no")]].=$val[csf("prod_id")].',';
		}
		$batch_re_proc_recipe_strip=$batch_recipe_strip_chk[$recipe_id][$val[csf("batch_no")]];
		$strip_batch=$strip_batch_entry_form_arr[$recipe_id][$val[csf("batch_no")]][$val[csf("prod_id")]];
		$re_dyeing_batch=$re_dyeing_batch_chk_arr[$val[csf("batch_no")]];
		if($batch_re_proc_recipe_strip==3 && $strip_batch==60 && $re_dyeing_batch==2) //Striping
		{
			//echo $val[csf("dyes_chemical_cost")].'='.$recipe_id.'T';
			//echo $batch_re_proc_recipe_adding;
			$dyes_chemical_striping_arr[$val[csf("batch_no")]][$val[csf("item_category")]]['chemical_cost']+=$val[csf("dyes_chemical_cost")];
			$mst_strip_id_arr[$val[csf("batch_no")]].=$val[csf("id")].',';
			$prod_strip_id_arr[$val[csf("batch_no")]].=$val[csf("prod_id")].',';
		}
		
		//$recipe_chk_arr[$val[csf("batch_no")]]=$val[csf("recipe_id")];
	}
	//print_r($dyes_chemical_adding_arr);die;
	
		
		
	$i=1;$j=1;
	ob_start();	
	?>
	<div id="" align="center" style="height:auto; width:auto; margin:0 auto; padding:0;">
		
    <? //echo $summaryHTML;
	
	$dlts_width=4230;
	?>

 	<div>
        <div  align="left" style="font-size:25px">Single Batch</div>
        <table width="<? echo $dlts_width;?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>
                    <th rowspan="2" width="80">Date</th>
                    <th rowspan="2" width="100">Machine No</th>
                    <th rowspan="2" width="100">Batch No</th>
                    <th rowspan="2" width="80">File No</th>
                    <th rowspan="2" width="80">Ref. No</th>
                    <th rowspan="2" width="100">Floor Name</th>
                    <th rowspan="2" width="100">Buyer</th>
                    <th rowspan="2" width="100">Booking No</th>
                    <th rowspan="2" width="100">Job no</th>
                    <th rowspan="2" width="80">Season</th>                  
                    <th rowspan="2" width="">Style</th>
                    <th rowspan="2" width="100">Order No</th>
                    <th rowspan="2" width="100">Color Name</th>
                    <th rowspan="2" width="100">Color Range</th>
                    <th rowspan="2" width="100">Fabric Type </th>
                    <th rowspan="2" width="100">Batch Qty (Kg)</th>
                    <th colspan="4"  width="400">First Dying Cost</th>
                    
                    <th colspan="4"  width="400">Adding Cost</th>
                    <th colspan="4"  width="400">Topping Cost</th>
                    <th colspan="4"  width="400">Re-Dyeing Cost</th>
                    
                      
                    <th colspan="7" width="">Finishing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per Kg Cost (Tk)</th>
                    <th rowspan="2" width="100">Result</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>
                    
                    <th width="100" title="Adding">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>
                    
                    <th width="100" title="Topping">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>
                    
                    <th width="100" title="Striping">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>
                    
                    <th width="100">Extention Batch Date</th>
                    <th width="70">Extention No</th>
                    <th width="100">Floor Name</th>
                    <th width="100">Ttl Chem Cost(Tk)</th>
                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100"><p>Cost per kg (Tk)</th>
                </tr> 
            </thead>
        </table>
        <div style="width:<? echo $dlts_width+20;?>px; max-height:400px;  overflow-y:scroll" id="scroll_body">
	        <table width="<? echo $dlts_width;?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_id2" >
	            <tbody>
			       	<?
				    //echo "<pre>";
					//print_r($issue_single_batch_arr);die;
					$tot_main_batch_weight=0;
					$total_adding_chemical_cost=$total_adding_dyes_cost=$total_topping_batch_chemical_price=0;
$total_topping_chemical_cost=$total_adding_dyes_cost=$total_topping_batch_chemical_price=0;
$total_strip_batch_chemical_price=$strip_first_dyeing_cost=$strip_first_chemi_cost=0;
					foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
						
							if($i%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
							$all_po_id=explode(",",$po_break_down_id_arr[$batch_description_arr[$b_id]['booking_no']]);
							$po_number_data="";
							$job_no_data="";$file_no="";$ref_no="";
							foreach($all_po_id as $p_id) // $po_number_arr[$row[csf('id')]]['po_no']
							{
								if($po_number_data!="") $po_number_data.=",".$po_number_arr[$p_id]['po_no'];	 else $po_number_data=$po_number_arr[$p_id]['po_no'];
								if($job_no_data!="") $job_no_data.=",".$po_number_arr[$p_id]['job'];	 else $job_no_data=$po_number_arr[$p_id]['job'];
								if($season_data!="") $season_data.=",".$season_name_arr[$po_number_arr[$p_id]['season']];	 else $season_data=$season_name_arr[$po_number_arr[$p_id]['season']];
								if($file_no!="") $file_no.=",".$po_number_arr[$p_id]['file_no'];	 else $file_no=$po_number_arr[$p_id]['file_no'];
								if($ref_no!="") $ref_no.=",".$po_number_arr[$p_id]['ref_no'];	 else $ref_no=$po_number_arr[$p_id]['ref_no'];
							} 
							$color_range_id=$batch_description_arr[$b_id]['color_range'];
							$file_cond=implode(", ",array_unique(explode(",",$file_no)));
							$ref_cond=implode(", ",array_unique(explode(",",$ref_no)));
							if($batch_description_arr[$b_id]['without_order']==1 && $ref_cond=="")
							{
							$ref_cond=$sample_booking_ref_no_arr[$batch_description_arr[$b_id]['booking_no']];
							}
							
							$mst_first_id=rtrim($mst_first_id_arr[$b_id],',');
							$mst_first_ids=implode(",",array_unique(explode(",",$mst_first_id)));
							
							$prod_first_id=rtrim($prod_first_id_arr[$b_id],',');
							$prod_first_ids=implode(",",array_unique(explode(",",$prod_first_id)));
							
							
							$mst_fin_id=rtrim($mst_fin_id_arr[$b_id],',');
							$mst_fin_ids=implode(",",array_unique(explode(",",$mst_fin_id)));
							
							$prod_fin_id=rtrim($prod_fin_id_arr[$b_id],',');
							$prod_fin_ids=implode(",",array_unique(explode(",",$prod_fin_id)));
							 
							
							
							$mst_topping_id=rtrim($mst_topping_id_arr[$b_id],',');
							$mst_topping_ids=implode(",",array_unique(explode(",",$mst_topping_id)));
							$prod_topping_id=rtrim($prod_topping_id_arr[$b_id],',');
							$prod_topping_ids=implode(",",array_unique(explode(",",$prod_topping_id)));
							
							$mst_strip_id=rtrim($mst_strip_id_arr[$b_id],',');
							$mst_strip_ids=implode(",",array_unique(explode(",",$mst_strip_id)));
							$prod_strip_id=rtrim($prod_strip_id_arr[$b_id],',');
							$prod_strip_ids=implode(",",array_unique(explode(",",$prod_strip_id)));
							
							
							
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="30"><? echo $i; ?></td>								
				                <td width="80"><? echo change_date_format($batch_description_arr[$b_id]['batch_date']); ?></td>
				                <td width="100"><p><? echo $machine_name_arr[$b_id]; ?></p></td>                                 
				                <td width="100"><p><A href="##"  onClick="subprocess_fabric_dtls('<? echo $b_id; ?>','<? echo $batch_arr[$b_id]; ?>','subprocess_fabrics_dtls_popup')"><p><? echo $batch_arr[$b_id]; ?></p></A><? //echo $batch_arr[$b_id]; ?></p></td>
				                <td width="80"><p><? echo $file_cond; ?></p></td>
				                <td width="80" title="PO/Sample Ref no"><p><? echo $ref_cond; ?></p></td>
				                <td width="100"><p><? echo $floor_arr[$b_id]; ?></p></td> 
				                <?
				                if($batch_description_arr[$b_id][entry_form]==36)
				                {
					                ?>
					                <td width="100"><p><? echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][party_id]))); ?></p></td> 
					                <td width="100"><p><? // echo $b_id; ?></p></td>
					                <td width="100" align="center"><p>
					                <? 
				                     echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                 <td width="80" align="center"><p>
					                <? 
				                     //echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                <td width="100" align="center"><p> <? echo   implode(",",array_unique(explode(",",$sub_con_arr[$b_id][cust_style_ref]))); ?></p></td>
					                <td width="100" align="center"><p> <? echo implode(",",array_unique(explode(",",$sub_con_arr[$b_id][order_no]))); ?></p></td>
				                	<?
				                }
				                else
				                {
					                ?>
					                <td width="100"><p><? 
					                if($batch_description_arr[$b_id]['without_order']==1) $buyerName=$non_buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];else $buyerName=$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
					                <td width="100"><p><? echo $batch_description_arr[$b_id]['booking_no']; ?></p></td>
					                <td width="100" align="center"><div style="word-break:break-all">
					                <?
					                echo implode(", ",array_unique(explode(",",$job_no_data)));
					                ?></div></td>
					                <td width="80" align="center"><div style="word-break:break-all">
					                <? 
					                
					                echo implode(", ",array_unique(explode(",",$season_data)));

					                ?></div></td>
					                <td width="" align="center"><div style="word-break:break-all"> 
					                <? 
					                $style_no=array();
					                foreach(array_unique(explode(",",$job_no_data)) as $j_no)
					                {
					                    if($style_no!="")  $style_no[]=$style_library[$j_no];
					                }
					                echo implode(", ",array_unique($style_no)); ?></div></td>
					                <td width="100" align="center"><div style="word-break:break-all"> <? echo implode(", ",array_unique(explode(",",$po_number_data))); ?></div></td>
					                <?	
				                }
				                ?>
				                <td width="100" align="center"><div style="word-break:break-all"><? echo $color_arr[$batch_description_arr[$b_id]['color_id']]; ?></div></td> 
				                <td width="100" align="center"><p><? echo $color_range[$color_range_id]; ?></p></td> 
				                <td width="100" align="center"><p><? echo $fabric_type_for_dyeing[$fabric_type_arr[$b_id]['fabric_type']]; //$fabric_type_for_dyeing?></p></td> 
				                <td width="100" align="right"><p>
				                <? echo $batch_description_arr[$b_id]['batch_weight']; $total_batch_weight+=$batch_description_arr[$b_id]['batch_weight'] ;?>
				                </p></td> 
				                <?
								$dyeing_re_process=$batch_recipe_chk[$b_id];
								$strip_dyeing_re_process=$strip_batch_re_proc_chk[$b_id];
								$top_dyeing_re_process=$batch_toping_recipe_chk[$b_id];
								$add_dyeing_re_process=$batch_add_recipe_chk[$b_id];
								//batch_toping_recipe_chk
				                //$reding_batch_id[$row[csf("id")]]
								// 1==Topping, 2==Adding,3==Strping $re_dyeing_batch_arr[$row[csf("batch_id")]]
							
				                $first_chemi_cost=$first_dyeing_cost=0;$adding_first_chemi_cost=$adding_first_dyeing_cost=0;
				                if($non_reding_batch_id[$b_id]!="")
				                {	//echo $dyeing_re_process.'='.$b_id.'<br> ';
									
				                   //------First batch Issue -------
								   $first_chemi_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                   $first_dyeing_cost=$dyes_chemical_arr[$b_id][6]['chemical_cost'];
									
								   if($add_dyeing_re_process==2) //Adding
								   {
									    $adding_first_chemi_cost=$dyes_chemical_adding_arr[$b_id][5]['chemical_cost']+$dyes_chemical_adding_arr[$b_id][7]['chemical_cost'];
				                    	$adding_first_dyeing_cost=$dyes_chemical_adding_arr[$b_id][6]['chemical_cost'];
										//echo $add_dyeing_re_process.'='.$b_id.'<br>';
										$mst_add_id=rtrim($mst_add_id_arr[$b_id],',');
										$mst_add_ids=implode(",",array_unique(explode(",",$mst_add_id)));
										if($mst_add_ids) $mst_add_ids=$mst_add_ids;
							//echo $mst_add_id_arr[$b_id].',';
										$prod_add_id=rtrim($prod_add_id_arr[$b_id],',');
										$prod_add_ids=implode(",",array_unique(explode(",",$prod_add_id)));
								   }
								   /*else
								   {
								    $first_chemi_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                    $first_dyeing_cost=$dyes_chemical_arr[$b_id][6]['chemical_cost'];
								   }*/
									
									$tot_main_batch_weight+=$batch_description_arr[$b_id]['batch_weight'];
				                }
								$strip_first_chemi_cost=$strip_first_dyeing_cost=0;
								if($reding_batch_id[$b_id]) //ReDying batch
								{
									//echo $b_id.'D';
									
								 if($strip_dyeing_re_process==3) //Stripping
								   {
									    $strip_first_chemi_cost=$dyes_chemical_striping_arr[$b_id][5]['chemical_cost']+$dyes_chemical_striping_arr[$b_id][7]['chemical_cost'];
				                    	$strip_first_dyeing_cost=$dyes_chemical_striping_arr[$b_id][6]['chemical_cost'];
								   }
								   $tot_main_batch_weight+=$batch_description_arr[$b_id]['batch_weight'];
								}
								
								$topping_first_chemi_cost=$topping_first_dyeing_cost=0;
								 if($top_dyeing_re_process==1) //Topping
								   {
									    
									   //$topping_first_chemi_cost=$topping_first_dyeing_cost=0;
									    $topping_first_chemi_cost=$dyes_chemical_topping_arr[$b_id][5]['chemical_cost']+$dyes_chemical_topping_arr[$b_id][7]['chemical_cost'];
				                    	$topping_first_dyeing_cost=$dyes_chemical_topping_arr[$b_id][6]['chemical_cost'];
										 $tot_main_batch_weight+=$batch_description_arr[$b_id]['batch_weight'];
								   }
								    
								    
								   
				                
				                ?>
				                <td width="100" title="batch id=<? echo $b_id;?>" align="right"><p>
				                <?
				                 echo number_format($first_chemi_cost,4,".",""); 
				                 $total_chemical_cost+=$first_chemi_cost;
				                 ?>
				                </p></td>
				                <td width="100" align="right"><p>
				                <?  
				                    echo number_format($first_dyeing_cost,4,".",""); 
				                    $total_dyes_cost+=$first_dyeing_cost;
									
									 $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost; 
				                ?>
				                </p></td>
				                <td width="100" align="right"><p>
                                <?
                                if($batch_chemical_price>0)
								{
								?>
                                <A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','1st_batch_dtls_popup2','1','<? echo $mst_first_ids;?>','<? echo $prod_first_ids;?>')">
				                <?
				                
				                  echo number_format($batch_chemical_price,4,".","");
				                  $total_batch_chemical_price+=$batch_chemical_price;
				                ?>
				                </A>
                                <?
								} else echo "0";
								?>
                                </p></td>
				                <td width="100" title="Cost Per" align="right"><p><? echo number_format($batch_chemical_price/$batch_description_arr[$b_id]['batch_weight'],4,".",""); $tot_total_receive+=$totalReceive; ?></p>
                                </td>
                                
                                  <td width="100" align="right"><p>
				                <?
				                 echo number_format($adding_first_chemi_cost,4,".",""); 
				                 $total_adding_chemical_cost+=$adding_first_chemi_cost;
				                 ?>
				                </p></td>
				                <td width="100" title="<? echo $b_id;?>" align="right"><p>
				                <?  
				                    echo number_format($adding_first_dyeing_cost,4,".",""); 
				                    $total_adding_dyes_cost+=$adding_first_dyeing_cost; 
				                ?>
				                </p></td>
				                <td width="100" align="right"><p>
                                 <?
								  $adding_batch_chemical_price=$adding_first_chemi_cost+$adding_first_dyeing_cost;
                                if($adding_batch_chemical_price>0)
								{
								?>
                                <A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','1st_batch_dtls_popup2','2','<? echo $mst_add_ids;?>','<? echo $prod_add_ids;?>')">
				                <?
				                
				                  echo number_format($adding_batch_chemical_price,4,".","");
				                  $total_adding_batch_chemical_price+=$adding_batch_chemical_price;
				                ?>
				                </A>
                                <?
								}
								else echo "0";
								?>
                                </p></td>
				                <td width="100" title="Cost Per" align="right"><p><? echo number_format($adding_batch_chemical_price/$batch_description_arr[$b_id]['batch_weight'],4,".",""); //$tot_total_receive+=$totalReceive; ?></p>
                                </td>
                                  <td width="100" align="right"><p>
				                <?
				                 echo number_format($topping_first_chemi_cost,4,".",""); 
				                 $total_topping_chemical_cost+=$topping_first_chemi_cost;
				                 ?>
				                </p></td>
				                <td width="100" align="right"><p>
				                <?  
				                    echo number_format($topping_first_dyeing_cost,4,".",""); 
				                    $total_topping_dyes_cost+=$topping_first_dyeing_cost; 
				                ?>
				                </p></td>
				                <td width="100" align="right"><p>
                                 <?
								  $topping_batch_chemical_price=$topping_first_chemi_cost+$topping_first_dyeing_cost;
                                if($topping_batch_chemical_price>0)
								{
								?>
                                <A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','1st_batch_dtls_popup2','3','<? echo $mst_topping_ids;?>','<? echo $prod_topping_ids;?>')">
				                <?
				                
				                  echo number_format($topping_batch_chemical_price,4,".","");
				                  $total_topping_batch_chemical_price+=$topping_batch_chemical_price;
				                ?>
				                </A>
                                <?
								} 
								else echo "0";
								?>
                                </p></td>
				                <td width="100" title="Cost Per" align="right"><p><? echo number_format($total_topping_batch_chemical_price/$batch_description_arr[$b_id]['batch_weight'],4,".",""); //$tot_total_receive+=$totalReceive; ?></p>
                                </td>
                                  <td width="100" align="right"><p>
				                <?
				                 echo number_format($strip_first_chemi_cost,4,".",""); 
				                 $total_strip_chemical_cost+=$strip_first_chemi_cost;
				                 ?>
				                </p></td>
				                <td width="100" align="right"><p>
				                <?  
				                    echo number_format($strip_first_dyeing_cost,4,".",""); 
				                    $total_strip_dyes_cost+=$strip_first_dyeing_cost; 
				                ?>
				                </p></td>
				                <td width="100" align="right"><p>
                                <?
                                 
								 $strip_batch_chemical_price=$strip_first_chemi_cost+$strip_first_dyeing_cost;
                                if($strip_batch_chemical_price>0)
								{
								
								?>
                                <A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','1st_batch_dtls_popup2','4','<? echo $mst_strip_ids;?>','<? echo $prod_strip_ids;?>')">
				                <?
				                 
				                  echo number_format($strip_batch_chemical_price,4,".","");
				                  $total_strip_batch_chemical_price+=$strip_batch_chemical_price;
				                ?>
				                </A>
                                <?
								}
								else echo "0";
								?>
                                </p></td>
				                <td width="100" title="Re Dying Cost Per" align="right"><p><? echo number_format($strip_batch_chemical_price/$batch_description_arr[$b_id]['batch_weight'],4,".",""); //$tot_total_receive+=$totalReceive; ?></p>
                                </td>
                                
				                <td width="100" align="right"><p>
				                <? 
				                $extension_no="";
				                $re_batch_date="";
				                $batch_date=explode(",", $redying_details_arr[$b_id]['batch_date']);	
				                foreach($batch_date as $ash_date)
				                {
				                 if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                }
				                echo $re_batch_date;
				                 ?></p></td>
				                <td width="70" align="right"><p>
				                <?		                
				                //echo $redying_details_arr[$b_id]['id'].jahid;
				                if(trim($redying_details_arr[$b_id]['id']))
				                {
				                    $re_dying_id_all=explode(",",$redying_details_arr[$b_id]['id']);
				                    //$re_dying_chemical_cost=0;
				                    //$re_dying_dyes_cost=0;
				                    //$re_dying_dyes_chemical_cost=0;
				                    
				                    $result_id="";
				                    $result_id_last='';
				                    
				                    foreach($re_dying_id_all as $ash_id)
				                    {
				                    //$re_dying_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                    //$re_dying_dyes_cost+=$dyes_chemical_arr[$ash_id][6]['chemical_cost']	;	
				                    //$re_dying_dyes_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][6]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                        
				                     if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                     //if($re_floor!="") $re_floor.=",".$floor_arr[$ash_id]; else $re_floor=$floor_arr[$ash_id];
				                    /* echo $ash_id.tipu;
				                     $result_id=$result_arr[$ash_id];
				                     if($result_id!="")  $result_id_last=$result_id;*/
				                    }
				                }
				                //echo $b_id;
				                //if($batch_type==3)
				                //{
				                echo $redying_details_arr[$b_id]['extention_no'];	 ?>
				                
				                
				                </p></td>
				                <td width="100" align="right"><p><?
				                $re_floors='';
				                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
				                //print_r($reding_batch_id);//echo $reding_batch_id[$b_id]."##".$b_id;
								//$finishing_dyeing_batch_arr[$row[csf("batch_id")]];
				                if($finishing_dyeing_batch_arr[$b_id]!="")
				                {
				                    $re_floors=$floor_arr[$b_id];
				                    $re_dying_chemical_cost=$dyes_chemical_fin_arr[$b_id][5]['chemical_cost']+$dyes_chemical_fin_arr[$b_id][7]['chemical_cost'];
				                    $re_dying_dyes_cost=$dyes_chemical_fin_arr[$b_id][6]['chemical_cost']	;	
				                    $re_dying_dyes_chemical_cost=$dyes_chemical_fin_arr[$b_id][5]['chemical_cost']+$dyes_chemical_fin_arr[$b_id][6]['chemical_cost']+$dyes_chemical_fin_arr[$b_id][7]['chemical_cost'];
				                }
				                
				                echo $re_floors;
				                ?></p></td>
				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($re_dying_chemical_cost,4,".",""); 
				                 $tot_re_dying_chemical_cost+=$re_dying_chemical_cost;
				                 ?>
				                 </p></td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_dyes_cost,4,".",""); $tot_re_dying_dyes_cost+=$re_dying_dyes_cost;  ?></p></td>
				                <td width="100" align="right"><A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','1st_batch_dtls_popup2','5','<? echo $mst_fin_ids;?>','<? echo $prod_fin_ids;?>')"><p><? echo number_format($re_dying_dyes_chemical_cost,4,".",""); $tot_re_dying_dyes_chemical_cost+=$re_dying_dyes_chemical_cost; ?></p></A></td>
				                <td width="100" align="right" title="Total Chemical And Dyes/BatchWeight"><? echo number_format($re_dying_dyes_chemical_cost/$batch_description_arr[$b_id]['batch_weight'],4,".",""); ?></td>
				                

				                <td width="100" align="right"><? echo number_format($re_dying_dyes_chemical_cost+$batch_chemical_price,4,".",""); ?></td>
				                <td width="100" align="right" title="<? echo '('.$re_dying_dyes_chemical_cost.'+'.$batch_chemical_price.')/'.$batch_description_arr[$b_id]['batch_weight']; ?>"><? echo number_format(($re_dying_dyes_chemical_cost+$batch_chemical_price)/$batch_description_arr[$b_id]['batch_weight'],4,".","");  ?></td>
				                <td width="100" align="center" title="<? echo $b_id; ?>"><? //echo $unload_result_arr[$b_id]//echo  $dyeing_result[$result_id];//
				                //echo $b_id.tipu;
			                    $result_id=$result_arr[$b_id];
			                    if($result_id!="")  $result_id_last=$result_id;
				                echo $dyeing_result[$result_id];//$dyeing_result;//$daysOnHand; ?></td>
				            </tr>
							<? 												
								 $i++; 			
						}	
					}
					?>
	            </tbody>
	      	</table>
      	</div>
       	<table width="<? echo $dlts_width;?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="80">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                   <th width="80">&nbsp;</th>
                    <th width="">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="100"><? //echo number_format($total_batch_chemical_price,4).'='.$total_dyes_cost; ?></th>
                	<th width="100">Total</th>
                    <th width="100" id="value_total_batch_weight_single"><? echo number_format($total_batch_weight,4); ?></th>
                	<th width="100" id="value_total_chemical_cost_single"><? echo number_format($total_chemical_cost,4); ?></th>
                	<th width="100" id="value_total_dyeing_cost_single"><? echo number_format($total_dyes_cost,4); ?></th>
                    <th width="100" id="value_total_chemical_price_single"><? echo number_format($total_batch_chemical_price,4); ?></th>
                    <th width="100"><? echo number_format(($total_batch_chemical_price/$total_batch_weight),4); ?></th>
                    
                    <th width="100"><? echo number_format(($total_adding_chemical_cost),4); ?></th>
                    <th width="100"><? echo number_format(($total_adding_dyes_cost),4); ?></th>
                    <th width="100"><? echo number_format(($total_adding_batch_chemical_price),4); ?></th>
                    <th width="100"><? echo number_format(($total_adding_batch_chemical_price/$total_batch_weight),4); ?></th>
                    
                    <th width="100"><? echo number_format($total_topping_chemical_cost,4); ?></th>
                    <th width="100"><? echo number_format($total_topping_dyes_cost,4); ?></th>
                    <th width="100"><? echo number_format($total_topping_batch_chemical_price,4); ?></th>
                    <th width="100"><? echo number_format(($total_topping_batch_chemical_price/$total_batch_weight),4); ?></th>
                    
                    <th width="100"><? echo number_format($strip_first_chemi_cost,4); ?></th>
                    <th width="100"><? echo number_format($strip_first_dyeing_cost,4); ?></th>
                    <th width="100"><? echo number_format(($total_strip_batch_chemical_price),4); ?></th>
                    <th width="100"><? echo number_format(($total_strip_batch_chemical_price/$total_batch_weight),4); ?></th>
                    

                    
                    
                    <th width="100"><? //echo number_format($tot_re_dying_chemical_cost,3); ?></th>
                    <th width="70"><? //echo number_format($tot_rec_return,3); ?></th>
                    <th width="100"><? //echo number_format($tot_total_issue,3); ?></th>
                    <th width="100" id="value_total_redying_chemic_oost_single"><? echo number_format($tot_re_dying_chemical_cost,4); ?></th>
                    <th width="100" id="value_total_redying_dying_cost_single"><p><? echo number_format($tot_re_dying_dyes_cost,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single"><p><? echo number_format($tot_re_dying_dyes_chemical_cost,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single_tk"><? echo number_format($tot_re_dying_dyes_chemical_cost/$total_batch_weight,4); ?></th>
                    <th width="100" id="value_total_total_cost_single"><? echo number_format($total_batch_chemical_price+$tot_re_dying_dyes_chemical_cost,4); ?></th>
                    <th width="100" title="Main Batch Qty=<? echo number_format($tot_main_batch_weight,2);?>"><? echo number_format(($total_batch_chemical_price/$total_batch_weight),4); ?></th>
                    <th width="100">&nbsp;</th>
                </tr>
            </tfoot>
        </table>
    </div>
      
    <div>
    <?
    $multi_width=4260;
	?>
       	<div  align="left" style="font-size:25px">Multiple Batch</div>
       
	        <table width="<? echo $multi_width;?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
	        	<thead>
	                <tr>
	                    <th rowspan="2" width="40">SL</th>
	                    <th rowspan="2" width="80">Date</th>
	                    <th rowspan="2" width="100">Machine No</th>
	                    <th rowspan="2" width="100">Batch No</th>
	                    <th rowspan="2" width="80">File No</th>
	                    <th rowspan="2" width="80">Ref. No</th>
	                    <th rowspan="2"width="100">Floor Name</th>
	                    <th rowspan="2" width="80">Buyer</th>
	                    <th rowspan="2" width="100">Booking No</th>
	                    <th rowspan="2" width="100">Job no</th>
	                    <th rowspan="2" width="80">Season</th>
	                    <th rowspan="2" width="100">Style</th>
	                    <th rowspan="2" width="100">Order No</th>
	                    <th rowspan="2" width="100">Color Name</th>
	                    <th rowspan="2" width="100">Color Range</th>
	                    <th rowspan="2" width="100">Fabric Type </th>
	                    <th rowspan="2" width="80">Batch Qty (Kg)</th>
	                    <th colspan="4"  width="430">First Dying Cost</th>
                        
                        <th colspan="4"  width="400">Adding Cost</th>
                 	   	<th colspan="4"  width="400">Topping Cost</th>
                   		<th colspan="4"  width="400">Re-Dyeing Cost</th>
                         
	                    <th colspan="7" width="660"> Finishing Cost</th>
	                    <th rowspan="2" width="70">Total Cost (Tk)</th>
	                    <th rowspan="2" width="70">Total Per Kg Cost (Tk)</th>
	                    <th rowspan="2" width="">Result</th>
	                </tr> 
	                <tr>                         
	                    <th width="100">Ttl Chem Cost (Tk)</th>
	                    <th width="110">Ttl Dyes Cost (Tk)</th>
	                    <th width="110">Ttl Chem + Dyes Cost (Tk)</th>
	                    <th width="110">Cost Per Kg(Tk)</th>
                        
                         <th width="100" title="Adding">Ttl Chem Cost (Tk)</th>
                        <th width="110">Ttl Dyes Cost (Tk)</th>
                        <th width="110"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                        <th width="110">Cost Per Kg (Tk)</th>
                        
                        <th width="100" title="Topping">Ttl Chem Cost (Tk)</th>
                        <th width="110">Ttl Dyes Cost (Tk)</th>
                        <th width="110"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                        <th width="110">Cost Per Kg (Tk)</th>
                    
                        <th width="100" title="Striping">Ttl Chem Cost (Tk)</th>
                        <th width="110">Ttl Dyes Cost (Tk)</th>
                        <th width="110"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                        <th width="110">Cost Per Kg (Tk)</th>
                    
                        
	                    <th width="80">Extention Batch Date</th>
	                    <th width="70">Extention No</th>
	                    <th width="100">Floor Name</th>
	                    <th width="100">Ttl Chem Cost(Tk)</th>
	                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
	                    <th width="100">Ttl Chem + Dyes Cost (Tk)</th>
	                    <th width="110">Cost per kg (Tk)</th>
	                </tr> 
	            </thead>
	        </table>
	        <div style="width:<? echo $multi_width+20;?>px; max-height:400px; overflow-y:scroll" id="">
		        <table width="<? echo $multi_width;?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_multibatch_id2">
			       	<?
					$multi_batch_qty_total=0;
					$total_mult_adding_first_chemi_cost=$total_mult_adding_first_dyeing_cost=$total_mult_topping_batch_dyes_chemical_cost=$total_mult_topping_first_chemi_cost=$total_mult_topping_first_dyeing_cost=$total_mult_batch_topping_dyes_chemical_cost=$total_mult_strip_first_chemi_cost=$total_mult_strip_first_dyeing_cost=$total_mult_strip_batch_dyes_chemical_cost=0;
					$mult_adding_batch_dyes_cost_total=$multi_adding_batch_chemical_total=$mult_tot_adding_batch_dyes_cost_total=0;
					$j=1;
					foreach(array_unique($issue_multi_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
							if($j%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF"; 
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="40"><? echo $j; ?></td>								
				                <td width="80" style="word-break:break-all;">
				                <?
								$multiple_batch_id=explode(",",$b_id);
								$batch_id_all="";
								$muli_batch_floor_name="";$multi_batch_machine='';
								$multi_batch_buyer_name=array();
								$multi_batch_booking_no=array();
								$multi_batch_job_no=array();
								$multi_batch_style_no=array();
								$multi_batch_color=""; $multi_batch_color_range="";
								$mulib_batch_weight=0;
								$re_dying_dyes_multi_batch_cost=0;
								$re_dying_dyes_multi_batch_chemical_cost=0;
								$re_multi_batch_floor="";
								$mult_batch_chemical_cost=0;
								$mult_batch_dyes_cost=0;
								$mult_batch_dyes_chemical_cost=0;
								$adding_first_chemi_cost=$adding_first_dyeing_cost=$topping_first_chemi_cost=$topping_first_dyeing_cost=0;
								$multiBatch_extension="";
								$re_floor="";
								$p=0;
								$redying_batch_id=array();
								$po_number_data_all=array();
								$batch_date_arr=array();
								$re_dying_multi_batch_chemical_cost=0;
								$re_dying_multi_batch_dying_cost=0; 
								$re_dying_multi_batch_dyes_chemical_cost=0;
								$remulti_batch_date="";$batch_nos="";
								$new_redying_arr=array();
								$new_redying_arr1=array();
				                foreach($multiple_batch_id as $s_bid)
				                {
				                      
									// echo $s_bid."mahbub";
									    
				                  	//  $batch_button="<a href='##' onClick=\"subprocess_fabric_dtls('".$b_id."','".$batch_id_all."','subprocess_fabrics_dtls_popup')\"> ".$batch_id_all." </a>";
									  $p++;
				                      $batch_date_arr[]=$batch_description_arr[$s_bid]['batch_date'];
				                      if($batch_id_all!="") $batch_id_all.=",".$batch_arr[$s_bid]; else $batch_id_all=$batch_arr[$s_bid];
									  if($batch_nos=="") $batch_nos="<a href='##' onClick=\"subprocess_fabric_dtls('".$s_bid."','".$batch_arr[$s_bid]."','subprocess_fabrics_dtls_popup')\"> ".$batch_arr[$s_bid]." </a>";else $batch_nos.=", "."<a href='##' onClick=\"subprocess_fabric_dtls('".$s_bid."','".$batch_arr[$s_bid]."','subprocess_fabrics_dtls_popup')\"> ".$batch_arr[$s_bid]." </a>";
				                      if($muli_batch_floor_name!="") $muli_batch_floor_name.=",".$floor_arr[$s_bid]; else $muli_batch_floor_name=$floor_arr[$s_bid];
				                      
				                      // for buyer name job style po*************************************************************************************
				                      if($batch_description_arr[$s_bid][entry_form]==36)
				                      {
				                          $multi_batch_buyer_name[]=$sub_con_arr[$s_bid][party_id];
				                          $multi_batch_job_no[]=$sub_con_arr[$s_bid][subcon_job];
				                          $po_number_data_all[]=$sub_con_arr[$s_bid][order_no];
				                          $multi_batch_style_no[]=$sub_con_arr[$s_bid][cust_style_ref];
				                      }
				                      else
				                      {
				                          $all_po_ids=array_unique(explode(",",$po_break_down_id_arr[$batch_description_arr[$s_bid]['booking_no']])); //print_r(array_unique($batch_description_arr[$s_bid]['booking_no']));
				                           $ref_no='';   $file_no=''; $po_no='';$season_data='';
										   //print_r( $all_po_id);
										  foreach($all_po_ids as $p_id)
				                          {
				                            // echo $p_id.'<pre>';
											  $po_number_data_all[]=$po_number_arr[$p_id]['po_no'];
				                              $multi_batch_job_no[]=$job_no_arr[$p_id];
											  if($season_data!="") $season_data.=",".$season_name_arr[$po_number_arr[$p_id]['season']];	 else $season_data=$season_name_arr[$po_number_arr[$p_id]['season']];
											  if( $po_no=='') $po_no=$po_number_arr[$p_id]['po_no'];else $po_no.=",".$po_number_arr[$p_id]['po_no'];
											  if( $ref_no=='') $ref_no=$po_number_arr[$p_id]['ref_no'];else $ref_no.=",".$po_number_arr[$p_id]['ref_no'];
											  if( $file_no=='') $file_no=$po_number_arr[$p_id]['file_no'];else $file_no.=",".$po_number_arr[$p_id]['file_no'];
											 // echo $po_no;
						 					 
				                          }
										  if($batch_description_arr[$s_bid]['without_order']==1)
										  { 
										 	$multi_batch_buyer_name[]=$non_buyer_name_arr[$batch_description_arr[$s_bid]['booking_no']];
										  }
										  else 
										  { 
										    $multi_batch_buyer_name[]=$buyer_name_arr[$batch_description_arr[$s_bid]['booking_no']];
										  }
										  if($batch_description_arr[$s_bid]['without_order']==1 && $ref_no=="")
											{
											$ref_no=$sample_booking_ref_no_arr[$batch_description_arr[$s_bid]['booking_no']];
											}
							
									
				                         
										  
				                          $multi_batch_booking_no[]=$batch_description_arr[$s_bid]['booking_no'];
				                          $style_no=array();
				                          foreach(array_unique($multi_batch_job_no) as $j_no)
				                          {
				                             if($multi_batch_style_no!="")  $multi_batch_style_no[]=$style_library[$j_no];
				                          } 
				                      }
				                      $mulib_batch_weight+=$batch_description_arr[$s_bid]['batch_weight'];
				                      //****************************************** for color **********************************************************
				                      if($multi_batch_color!="") $multi_batch_color.=",".$color_arr[$batch_description_arr[$s_bid]['color_id']];
				                      else $multi_batch_color=$color_arr[$batch_description_arr[$s_bid]['color_id']];
									  
				                      if($multi_batch_color_range!="") $multi_batch_color_range.=",".$color_range[$batch_description_arr[$s_bid]['color_range']];
				                      else $multi_batch_color_range=$color_range[$batch_description_arr[$s_bid]['color_range']];
									  
									  if($multi_batch_machine!="") $multi_batch_machine.=",".$machine_name_arr[$s_bid];
				                      else $multi_batch_machine=$machine_name_arr[$s_bid];
									  
									  
									  //$color_range_id=$color_range[$batch_description_arr[$b_id]['color_range']];
				                      //******************************************** for redyeing **********************************************************
									  //echo $batch_description_arr[$s_bid]['color_range'];
									if($redying_details_arr[$s_bid]['id']!="")
									{
					                      if($multiBatch_extension!="") $multiBatch_extension.="*".$redying_details_arr[$s_bid]['extention_no'];
					                      else $multiBatch_extension=$redying_details_arr[$s_bid]['extention_no'];
					                      $sl=0;
										  
					                      foreach(explode(",",$redying_details_arr[$s_bid]['id']) as $rbs)
					                      {
					                        $new_redying_arr[$sl]=$new_redying_arr[$sl].",".$rbs;
					                        $new_redying_arr1[$sl]=$rbs.",".$new_redying_arr1[$sl];
					                        $sl++; 
					                        
					                        if($re_floor!="") $re_floor.=",".$floor_arr[$rbs];
					                        else $re_floor=$floor_arr[$rbs];
					                      }
					                      // for redyeing batch date *************************************************************************************************
					                      foreach(array_unique(explode(",",$redying_details_arr[$s_bid]['batch_date'])) as $r_date)
					                      {
					                      if($remulti_batch_date!="") $remulti_batch_date.=",".change_date_format($r_date); else $remulti_batch_date=change_date_format($r_date);
					                      }
					                }
									
					                // *****************************************redyeing dyes and chemical cost***************************************
									$dyeing_re_process=$batch_recipe_chk[$s_bid];
									$strip_dyeing_re_process=$strip_batch_re_proc_chk[$s_bid];
									$top_dyeing_re_process=$batch_toping_recipe_chk[$s_bid];
									$add_dyeing_re_process=$batch_add_recipe_chk[$s_bid];
									//==================mst and Prod ID-==================================
									$mst_first_id=rtrim($mst_first_id_arr[$b_id],',');
									$mst_first_ids=implode(",",array_unique(explode(",",$mst_first_id)));
									$prod_first_id=rtrim($prod_first_id_arr[$b_id],',');
									$prod_first_ids=implode(",",array_unique(explode(",",$prod_first_id)));
									
									$mst_fin_id=rtrim($mst_fin_id_arr[$b_id],',');
									$mst_fin_ids=implode(",",array_unique(explode(",",$mst_fin_id)));
									$prod_fin_id=rtrim($prod_fin_id_arr[$b_id],',');
									$prod_fin_ids=implode(",",array_unique(explode(",",$prod_fin_id)));
									
									$mst_topping_id=rtrim($mst_topping_id_arr[$b_id],',');
									$mst_topping_ids=implode(",",array_unique(explode(",",$mst_topping_id)));
									$prod_topping_id=rtrim($prod_topping_id_arr[$b_id],',');
									$prod_topping_ids=implode(",",array_unique(explode(",",$prod_topping_id)));
									
									$mst_strip_id=rtrim($mst_strip_id_arr[$b_id],',');
									$mst_strip_ids=implode(",",array_unique(explode(",",$mst_strip_id)));
									$prod_strip_id=rtrim($prod_strip_id_arr[$b_id],',');
									$prod_strip_ids=implode(",",array_unique(explode(",",$prod_strip_id)));
									//==================End-==================================
								
					                 foreach($new_redying_arr as $l_id)
					                 {
					                    /* $re_dying_multi_id_all=ltrim($l_id,",");
					                     $re_dying_multi_batch_chemical_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][5]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][7]['chemical_cost'];
					                     $re_dying_multi_batch_dying_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][6]['chemical_cost'];	
					                     $re_dying_multi_batch_dyes_chemical_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][5]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][6]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][7]['chemical_cost'];*/
					                    
					                 }
									 if($finishing_dyeing_batch_arr[$s_id]!="")
				               		 {
										 //foreach($new_redying_arr1 as $l_id)
										 //{
											// $re_dying_multi_id_all=rtrim($l_id,",");
											 $re_dying_multi_batch_chemical_cost=$dyes_chemical_fin_arr[$s_id][5]['chemical_cost']+$dyes_chemical_fin_arr[$s_id][7]['chemical_cost'];
											 $re_dying_multi_batch_dying_cost=$dyes_chemical_fin_arr[$s_id][6]['chemical_cost']	;	
											 $re_dying_multi_batch_dyes_chemical_cost=$dyes_chemical_fin_arr[$s_id][5]['chemical_cost']+$dyes_chemical_fin_arr[$s_id][6]['chemical_cost']+$dyes_chemical_fin_arr[$re_dying_multi_id_all][7]['chemical_cost'];
										// }
										 $re_dying_multi_batch_chemical_cost_total=$re_dying_multi_batch_chemical_cost;
										 $re_dying_multi_batch_dying_cost_total=$re_dying_multi_batch_dying_cost;
										 $re_dying_multi_batch_dyes_chemical_cost_total=$re_dying_multi_batch_dyes_chemical_cost;
									}
									 
									 $dyeing_re_process=$batch_recipe_chk[$s_bid];
									// echo $non_reding_batch_id[$s_bid].'X';
								if($non_reding_batch_id[$s_bid]!="")
				                {
									 $mult_batch_chemical_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                 	$mult_batch_dyes_cost=$dyes_chemical_arr[$b_id][6]['chemical_cost']; 
				                	$mult_batch_dyes_chemical_cost=$mult_batch_chemical_cost+$mult_batch_dyes_cost;
										 
									
								   if($add_dyeing_re_process==2) //Adding
								   {
									  	 $adding_first_chemi_cost=$dyes_chemical_adding_arr[$b_id][5]['chemical_cost']+$dyes_chemical_adding_arr[$b_id][7]['chemical_cost'];
				                    	$adding_first_dyeing_cost=$dyes_chemical_adding_arr[$b_id][6]['chemical_cost'];
											 $mult_batch_adding_dyes_chemical_cost=$adding_first_chemi_cost+$adding_first_dyeing_cost;
											
								   }
								   /*else
								   {
									    //  echo $dyeing_re_process.'SS';
										 $mult_batch_chemical_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                 		$mult_batch_dyes_cost=$dyes_chemical_arr[$b_id][6]['chemical_cost']; 
				                		 $mult_batch_dyes_chemical_cost=$mult_batch_chemical_cost+$mult_batch_dyes_cost;
										// echo $mult_batch_dyes_chemical_cost.'D';
								   }*/
								}
								if($reding_batch_id[$s_bid]) //ReDying batch
								{
								
								   
								    if($strip_dyeing_re_process==3) //Stripping
								   {
									    $strip_first_chemi_cost=$dyes_chemical_striping_arr[$b_id][5]['chemical_cost']+$dyes_chemical_striping_arr[$b_id][7]['chemical_cost'];
				                    	$strip_first_dyeing_cost=$dyes_chemical_striping_arr[$b_id][6]['chemical_cost'];
										$mult_strip_batch_dyes_chemical_cost=$strip_first_chemi_cost+$strip_first_dyeing_cost;
								   }
								  // $tot_main_batch_weight+=$batch_description_arr[$b_id]['batch_weight'];
								}
								 if($top_dyeing_re_process==1) //Topping
								   {
									    
									    $topping_first_chemi_cost=$dyes_chemical_topping_arr[$b_id][5]['chemical_cost']+$dyes_chemical_topping_arr[$b_id][7]['chemical_cost'];
				                    	$topping_first_dyeing_cost=$dyes_chemical_topping_arr[$b_id][6]['chemical_cost'];
										//echo $topping_first_chemi_cost.'='.$topping_first_dyeing_cost.'M';
										$mult_topping_batch_dyes_chemical_cost=$topping_first_chemi_cost+$topping_first_dyeing_cost;
								   }
				               
							   	
								} //End
								 
				                // dyes and chemical cost total  ************************************************************************************************
								
								//$total_mult_adding_first_chemi_cost+=$adding_first_chemi_cost;
								//$total_mult_adding_first_dyeing_cost+=$adding_first_dyeing_cost;
								//$total_mult_topping_batch_dyes_chemical_cost+=$mult_topping_batch_dyes_chemical_cost;
								
								$total_mult_topping_first_chemi_cost+=$topping_first_chemi_cost;
								$total_mult_topping_first_dyeing_cost+=$topping_first_dyeing_cost;
								$total_mult_batch_topping_dyes_chemical_cost+=$mult_strip_batch_dyes_chemical_cost;
								
								$total_mult_strip_first_chemi_cost+=$strip_first_chemi_cost;
								$total_mult_strip_first_dyeing_cost+=$strip_first_dyeing_cost;
								$total_mult_strip_batch_dyes_chemical_cost+=$mult_strip_batch_dyes_chemical_cost;
								
								//$total_mult_batch_strip_dyes_chemical_cost=$mult_batch_adding_dyes_chemical_cost;
								
				                 
				                 $multi_date="";
				                 foreach(array_unique($batch_date_arr) as $m_date)
				                 {
				                 if($multi_date!="") $multi_date.=",".change_date_format($m_date); else $multi_date=change_date_format($m_date);
				                 }
								//echo $ref_no.'='.$file_no;
							 $multi_batch_qty_total+=$mulib_batch_weight;	
							 $mult_batch_chemical_cost_total+=$mult_batch_chemical_cost; 
							 $mult_batch_dyes_cost_total+=$mult_batch_dyes_cost;
							 $mult_batch_dyes_chemical_cost_total+=$mult_batch_dyes_chemical_cost;
							 
							 $multi_adding_batch_chemical_total+=$adding_first_chemi_cost;	
							 $mult_adding_batch_dyes_cost_total+=$adding_first_dyeing_cost; 
							 $mult_tot_adding_batch_dyes_cost_total+=$adding_first_chemi_cost+$adding_first_dyeing_cost;
							 
							// $mult_batch_dyes_chemical_cost_total+=$mult_batch_dyes_chemical_cost;
							 
								 
				                ?><p><? echo $multi_date; ?></p></td>  
				                 <td width="100"><p><? echo implode(",",array_unique(explode(",",$multi_batch_machine))); ?></p> </td>                               
				                <td width="100" ><p> <?
									 echo $batch_nos;
									 ?>
				                    </p> </td>
				                <td width="80" align="center"><p><? echo $file_no; ?></p></td>
				                <td width="80" align="center" title="PO/Sample Ref no"><p><?  echo $ref_no; ?></p></td>
				                <td width="100"><p><? echo implode(",",array_unique(explode(",",$muli_batch_floor_name))); ?></p></td> 
				                <td width="80" align="center"><p><? echo implode(",",array_unique($multi_batch_buyer_name)); ?></p></td>  
				                <td width="100" align="center"><p><? echo implode(",",array_unique($multi_batch_booking_no)); ?></p></td> 
				                <td width="100" align="center"><p><? echo implode(",",array_unique($multi_batch_job_no)); ?></p></td> 
				                 <td width="80" align="center"><p><? echo implode(",",array_unique($season_data)); ?></p></td> 
				                <td width="100" align="center"><p><? echo implode(",",array_unique($multi_batch_style_no)); ?></p></td> 
				                <td width="100" align="center"><p><? echo  implode(",",array_unique(explode(",",$po_no)));//echo implode(",",array_unique(explode(",",$po_number_data_all)));//?></p></td>
				                <td width="100" align="center"><p><? echo implode(",",array_unique(explode(",",$multi_batch_color))); ?></p></td>
				                <td width="100" align="center"><p><? echo implode(",",array_unique(explode(",",$multi_batch_color_range))); ?></p></td> 
				                <td width="100"><p><?
								 $type_name="";
								$arra_type= array_unique($multiple_batch_id);
								//print_r($fabric_type_arr);
								foreach($arra_type as $v)
								{
									//echo $v;
									if($fabric_type_arr[$v]['fabric_type'])
									{
										if($type_name) $type_name.=",".$fabric_type_for_dyeing[$fabric_type_arr[$v]['fabric_type']];
										else $type_name.=$fabric_type_for_dyeing[$fabric_type_arr[$v]['fabric_type']];
									}
								}
								 echo $type_name; ?></p></td>  
				                <td width="80" align="right"><p><? echo $mulib_batch_weight; ?></p></td>
                                
				                <td width="100" align="right"><p><? echo number_format($mult_batch_chemical_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_batch_dyes_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_batch_dyes_chemical_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_batch_dyes_chemical_cost/$mulib_batch_weight,4); ?></p></td>
                                
                                <td width="100" align="right"><p><? echo number_format($adding_first_chemi_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($adding_first_dyeing_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_batch_adding_dyes_chemical_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_batch_adding_dyes_chemical_cost/$mulib_batch_weight,4); ?></p></td>
                                
                                <td width="100" align="right"><p><? echo number_format($topping_first_chemi_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($topping_first_dyeing_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_topping_batch_dyes_chemical_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_topping_batch_dyes_chemical_cost/$mulib_batch_weight,4); ?></p></td>
                                 
                                <td width="100" align="right"><p><? echo number_format($strip_first_chemi_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($strip_first_dyeing_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_strip_batch_dyes_chemical_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_strip_batch_dyes_chemical_cost/$mulib_batch_weight,4); ?></p></td>
                                
                                
				                <td width="80" align="right"><p><?  echo implode(",",array_unique(explode(",",$remulti_batch_date))); ?></p></td>
				                <td width="70" align="right"><p><?  echo $multiBatch_extension; ?></p></td>
				                <td width="100" align="right"><p><?  echo implode(",",array_unique(explode(",",$re_floor))); ?></p></td>
				                <td width="100" align="right"><p>
				                <? echo number_format($re_dying_multi_batch_chemical_cost,4); $tot_closing_stock+=$closingStock; ?></p>
				                </td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_multi_batch_dying_cost,4); ?></p></td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_multi_batch_dyes_chemical_cost,4);  ?></p></td>
				                <td width="110" align="right"><? echo number_format($re_dying_multi_batch_dyes_chemical_cost/$mulib_batch_weight,4); ?></td>
				                <td width="70" align="right"><? echo  number_format($re_dying_multi_batch_dyes_chemical_cost+$mult_batch_dyes_chemical_cost,4);  ?></td>
				                <td width="70" align="right"><? echo number_format(($re_dying_multi_batch_dyes_chemical_cost+$mult_batch_dyes_chemical_cost)/$mulib_batch_weight,4);; ?></td>
				                <td width="" align="center"><? 
				                if($dye_result!="") $result.=",".$dyeing_result[$result_arr[$s_bid]];
					            else $dye_result=$dyeing_result[$result_arr[$s_bid]];
					            echo implode(",",array_unique(explode(",",$dye_result)));
				                //echo $daysOnHand;//$daysOnHand; ?></td>
				            </tr>
							<? 
							unset($new_redying_arr);
							unset($new_redying_arr1);
																			
							$j++; 		
						}		
					}
					?>
		        </table>
	        </div>
	        <table width="<? echo $multi_width;?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer">
		        <tfoot>
	            	<tr>
	                	<th width="40">&nbsp;</th>
	                	<th width="80">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                    <th width="80">&nbsp;</th>
	                    <th width="80">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                	<th width="80">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                      <th width="80">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                    <th width="80" id="value_total_batch_weight_multiple"><? echo number_format($multi_batch_qty_total,0); ?></th>
                         
							 
	                	<th width="100" id="value_total_chemical_cost_multiple"><? echo number_format($mult_batch_chemical_cost_total,4); ?></th>
	                	<th width="110" id="value_total_dyeing_cost_multiple"><? echo number_format($mult_batch_dyes_cost_total,4); ?></th>
	                    <th width="110" id="value_total_chemical_price_multiple"><? echo number_format($mult_batch_dyes_chemical_cost_total,4); ?></th>
	                    <th width="110" id="value_total_cost_per_kg_multi"><? echo number_format($mult_batch_dyes_chemical_cost_total/$multi_batch_qty_total,3); ?></th>
                        
                        <th width="100" id="value_total_chemical_cost_multiple_add"><? echo number_format($multi_adding_batch_chemical_total,4); ?></th>
	                	<th width="110" id="value_total_dyeing_cost_multiple_add"><? echo number_format($mult_adding_batch_dyes_cost_total,4); ?></th>
	                    <th width="110" id="value_total_chemical_price_multiple_add"><?  echo number_format($mult_tot_adding_batch_dyes_cost_total,4); ?></th>
	                   <th width="110" id="value_total_cost_per_kg_multi_add"><? echo number_format($mult_tot_adding_batch_dyes_cost_total/$multi_batch_qty_total,3); ?></th>
                        
                        <th width="100" id="value_total_chemical_cost_multiple_top"><? echo number_format($total_mult_topping_first_chemi_cost,4); ?></th>
	                	<th width="110" id="value_total_dyeing_cost_multiple_top"><? echo number_format($total_mult_topping_first_dyeing_cost,4); ?></th>
	                    <th width="110" id="value_total_chemical_price_multiple_top"><? echo number_format($total_mult_batch_topping_dyes_chemical_cost,4); ?></th>
	                   <th width="110" id="value_total_cost_per_kg_multi_top"><? echo number_format($total_mult_batch_topping_dyes_chemical_cost/$multi_batch_qty_total,3); ?></th>
                       
                        <th width="100" id="value_total_chemical_cost_multiple_strip"><? echo number_format($total_mult_strip_first_chemi_cost,4); ?></th>
	                	<th width="110" id="value_total_dyeing_cost_multiple_strip"><? echo number_format($total_mult_strip_first_dyeing_cost,4); ?></th>
	                    <th width="110" id="value_total_chemical_price_multiple_strip"><?  echo number_format($total_mult_strip_batch_dyes_chemical_cost,4); ?></th>
	                   <th width="110" id="value_total_cost_per_kg_multi_strip"><? echo number_format($total_mult_strip_batch_dyes_chemical_cost/$multi_batch_qty_total,3); ?></th>
                        
                        
                        
                        
	                    <th width="80"><? //echo number_format($mult_batch_dyes_chemical_cost_total/$multi_batch_qty_total,3); ?></th>
	                    <th width="70"><? //echo number_format($tot_rec_return,3); ?></th>
	                    <th width="100"><? //echo number_format($tot_total_issue,3); ?></th>
	                    <th width="100" id="value_total_chemical_cost_multi"><? echo number_format($re_dying_multi_batch_chemical_cost_total,4); ?></th>
	                    <th width="100" id="value_total_redying_dying_cost_multiple"><p><? echo number_format($re_dying_multi_batch_dying_cost_total,4); ?></p></th>
	                    <th width="100" id="value_total_redying_all_cost_multiple"><p><? echo number_format($re_dying_multi_batch_dyes_chemical_cost_total,4); ?></p></th>
	                    <th width="110" id="value_total_redye_cost_per_kg_multi"><? echo number_format(($re_dying_multi_batch_dyes_chemical_cost_total/$multi_batch_qty_total),4); ?></th>
	                    <th width="70" id="value_grand_total_cost_multiple"><? echo number_format($mult_batch_dyes_chemical_cost_total+$re_dying_multi_batch_dyes_chemical_cost_total,4); ?></th>
	                    <th width="70" id="value_total_total_per_kg_cost_multi"><? echo number_format(($mult_batch_dyes_chemical_cost_total+$re_dying_multi_batch_dyes_chemical_cost_total)/$multi_batch_qty_total,4); ?></th>
	                    <th width="">&nbsp;</th>
	                </tr>
	            </tfoot>
	        </table>
      	</div>
  	</div>
    <?
    $html = ob_get_contents();
    ob_clean();
    //$new_link=create_delete_report_file( $html, 2, $delete, "../../../" );
    foreach (glob("*.xls") as $filename) {
    //if( @filemtime($filename) < (time()-$seconds_old) )
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');	
    $is_created = fwrite($create_new_doc, $html);


    $filename2=$user_id."_summary_".$name.".xls";
    $create_new_doc2 = fopen($filename2, 'w');	
    $is_created2 = fwrite($create_new_doc2, $summaryHTML);

    echo "$html****$filename****$filename2****$report_type"; 
    exit();
}
if($action=="generate_report2")
{ 
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if ($cbo_company_name==0) $company_id =""; else $company_id =" and a.company_id='$cbo_company_name'";
	if ($cbo_company_name==0) $company_idcond =""; else $company_idcond =" and b.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond .=""; else $company_idcond .=" and b.working_company_id='$cbo_working_name'";
	$from_date=str_replace("'","",$from_date);
	$to_date=str_replace("'","",$to_date);
	//echo $from_date;
	$txt_ref_no=str_replace("'","",$txt_ref_no);
	$txt_file_no=str_replace("'","",$txt_file_no);
	$txt_booking_no=str_replace("'","",$txt_booking_no);
	$txt_po_no=str_replace("'","",$txt_po_no);
	$txt_job=str_replace("'","",$txt_job);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$txt_samp_ref_no=str_replace("'","",$txt_samp_ref_no);
	$cbo_season_id=str_replace("'","",$cbo_season_id);
    if($cbo_season_id!=0) $season_cond="and a.season_buyer_wise in($cbo_season_id)";else $season_cond="";
	
	if(str_replace("'","",$cbo_buyer_name)==0)
	{
		if ($_SESSION['logic_erp']["data_level_secured"]==1)
		{
			if($_SESSION['logic_erp']["buyer_id"]!="") 
			{
			$buyer_id_cond=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")";
			$buyer_id_cond2=" and a.buyer_id in (".$_SESSION['logic_erp']["buyer_id"].")";
			}
			else 
			{
			$buyer_id_cond="";$buyer_id_cond2="";
			}
		}
		else
		{
			$buyer_id_cond="";$buyer_id_cond2="";
		}
	}
	else
	{
		$buyer_id_cond=" and a.buyer_name in (".str_replace("'","",$cbo_buyer_name).")";
		$buyer_id_cond2=" and a.buyer_id in (".str_replace("'","",$cbo_buyer_name).")";
	}
	
	if($txt_booking_no!='') $booking_no_cond="and b.booking_no like '%$txt_booking_no%' ";else $booking_no_cond="";
	
	if($txt_file_no!='') $file_cond="and b.file_no='$txt_file_no'";else $file_cond="";
	if($txt_job!='') $job_cond="and a.job_no_prefix_num=$txt_job";else $job_cond="";
	if($txt_po_no!='') $po_cond="and b.po_number='$txt_po_no'";else $po_cond="";
	
	if($txt_ref_no!='') $ref_cond="and b.grouping='$txt_ref_no'";else $ref_cond="";
	if($txt_samp_ref_no!='') $samp_ref_cond="and a.grouping='$txt_samp_ref_no'";else $samp_ref_cond="";
	//echo $ref_cond;
	$companyArr = return_library_array("select id,company_name from lib_company where status_active=1 and is_deleted=0","id","company_name"); 
	$supplierArr = return_library_array("select id,supplier_name from lib_supplier where status_active=1 and is_deleted=0","id","supplier_name"); 
	$color_arr=return_library_array( "select id,color_name  from  lib_color", "id", "color_name"  );
	$floor_arr=return_library_array("select b.id,b.floor_name from   lib_prod_floor b  where  b.status_active=1 and b.is_deleted=0", "id", "floor_name" );
    $buyer_library=return_library_array( "select id,buyer_name from   lib_buyer", "id","buyer_name" );
	$sql_mc="select  a.id ,a.machine_no,b.applicable_date,b.cpm from   lib_machine_name a left join lib_machine_cpm b on a.id=b.mst_id   where    a.status_active=1 and a.is_deleted=0 order by a.id asc";
	$mc_res=sql_select($sql_mc);
	foreach($mc_res as $row)
	{
		$machine_name_arr[$row[csf('id')]]=$row[csf('machine_no')];
		if($row[csf('cpm')]>0)
		{
		$machine_cpm_arr[$row[csf('id')]][$row[csf('applicable_date')]]=$row[csf('cpm')];//strtotime
		}
	}
	unset($mc_res);
	if($db_type==0) 
	{
	$from_date=change_date_format($from_date,'yyyy-mm-dd'); $to_date=change_date_format($to_date,'yyyy-mm-dd');
	}
    if($db_type==2) 
	{
	$from_date=change_date_format($from_date,'','',1);  $to_date=change_date_format($to_date,'','',1);
	}

	/* 
	if(str_replace("'","",$batch_id)!="") $batch_cond=" and b.id in(".str_replace("'","",$batch_id).")";
    else  */
	if(str_replace("'","",$batch_no)!="") $batch_cond=" and b.batch_no like '".$batch_no."' "; 
	else $batch_cond="";
	/* and b.re_dyeing_from=0 13-11-16 according to siddique sir dicission when search buyer order or subcontract all batch appear */
	if($batch_type==0)
	$search_field_cond_batch="and b.entry_form in (0,36) and b.re_dyeing_from=0";
	else if($batch_type==1)
	$search_field_cond_batch="and b.entry_form=0 ";
	else if($batch_type==2)
	$search_field_cond_batch="and b.entry_form=36";
	else 
	 $search_field_cond_batch="and b.entry_form in(0,36) and b.batch_against in(2) and  b.re_dyeing_from!=0 ";
	 
	$sql_po=("select a.buyer_name,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b  where a.id=b.job_no_id  and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $po_cond $season_cond $buyer_id_cond");
		$res_po=sql_select($sql_po);
		$all_po_id='';
		foreach($res_po as $row) //$job_no_arr
		{
			 $po_number_arr[$row[csf('id')]]['po_no']=$row[csf('po_number')];
			 $po_number_arr[$row[csf('id')]]['ref_no']=$row[csf('ref_no')];
			 $po_number_arr[$row[csf('id')]]['file_no']=$row[csf('file_no')]; 
			 $po_number_arr[$row[csf('id')]]['job']=$row[csf('job_no_mst')];
			 $po_number_arr[$row[csf('id')]]['buyer']=$row[csf('buyer_name')];
			 if($all_po_id=="") $all_po_id=$row[csf('id')]; else $all_po_id.=",".$row[csf('id')]; //echo $all_po_id;
			 $po_idArr[$row[csf('id')]]=$row[csf('id')];
		}
		$all_po=array_unique(explode(",",$all_po_id));
		$po_arr_cond=array_chunk($all_po,1000, true);
		$po_cond_for_in="";$po_cond_for_in2="";$po_cond_for_in3="";
		$pi=0;
		foreach($po_arr_cond as $key=>$value)
		{
		   if($pi==0)
		   {
			$po_cond_for_in=" and ( b.id  in(".implode(",",$value).")"; 
			//$po_cond_for_in2=" and ( d.po_break_down_id  in(".implode(",",$value).")"; 
			
		   }
		   else //po_break_down_id
		   {
			$po_cond_for_in.=" or b.id  in(".implode(",",$value).")";
			//$po_cond_for_in2.=" or d.po_break_down_id  in(".implode(",",$value).")";
			
		   }
		   $pi++;
		}	
		$po_cond_for_in.=" )";
		$po_cond_for_in2.=" )";
	
		$con = connect();
	execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id." and ref_from in (1,2,3) and ENTRY_FORM=48");
	oci_commit($con);
	disconnect($con);
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 1, $po_idArr, $empty_arr);//PO ID Ref from=1
		
	$sql_book=("select a.booking_no,a.buyer_id as buyer_name,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.file_no,b.job_no_mst from wo_booking_mst a,wo_booking_dtls c,wo_po_break_down b,gbl_temp_engine g  where  a.booking_no=c.booking_no and b.id=c.po_break_down_id and  c.po_break_down_id=g.ref_val and  b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=1 and g.entry_form=48 and  b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond  $po_cond $buyer_id_cond2 ");
	 $res_book=sql_select($sql_book);
	foreach($res_book as $row) //$job_no_arr
	{
		 $booking_no_arr[$row[csf('booking_no')]]['po_no']=$row[csf('buyer_name')];
		 $booking_no_arr[$row[csf('booking_no')]]['ref_no']=$row[csf('ref_no')];
		 $booking_no_arr[$row[csf('booking_no')]]['file_no']=$row[csf('file_no')];
		// if($all_po_id=="") $all_po_id=$row[csf('id')]; else $all_po_id.=",".$row[csf('id')]; //echo $all_po_id;
	}
	unset($res_book);
	
	//echo $all_po_id;
	if($txt_file_no!='' || $txt_ref_no!='' ||  $txt_po_no!='' || $txt_job!='' || $cbo_buyer_name>0)
	{
		if($all_po_id!="") $po_idd="and po_id in($all_po_id)";else $po_idd="and po_id in(0)";
		//echo $po_idd;
		//echo "select LISTAGG(CAST( mst_id  AS VARCHAR(4000)), ',') WITHIN GROUP (ORDER BY mst_id) as batch_id from pro_batch_create_dtls where status_active=1 and is_deleted=0 $po_idd";
		/*if($db_type==0) $group_con="group_concat(mst_id) as batch_id";
	else  $group_con="LISTAGG(CAST( mst_id  AS VARCHAR(4000)), ',') WITHIN GROUP (ORDER BY mst_id) as batch_id";
		$batch_ids=return_field_value("$group_con","pro_batch_create_dtls","status_active=1 and is_deleted=0 $po_idd","batch_id");
		if($batch_ids!="") $batch_id_cond="and b.id in($batch_ids)"; else $batch_id_cond="";	*/	
		$poIds=chop($all_po_id,','); $po_cond_for_in="";
		$po_ids=count(array_unique(explode(",",$all_po_id)));
		if($db_type==2 && $po_ids>1000)
		{
			$po_cond_for_in=" and (";
			$poIdsArr=array_chunk(explode(",",$poIds),999);
			foreach($poIdsArr as $ids)
			{
				$ids=implode(",",$ids);
				$po_cond_for_in.=" c.po_id in($ids) or"; 
			}
			$po_cond_for_in=chop($po_cond_for_in,'or ');
			$po_cond_for_in.=")";
		}
		else
		{
			$po_cond_for_in=" and c.po_id in($poIds)";
		}
		//pro_grey_prod_delivery_dtls
	//	$sql_batch=sql_select("select mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in");
	$sql_batch=sql_select("SELECT b.mst_id as batch_id from pro_batch_create_dtls b,gbl_temp_engine g  where   b.po_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=1 and g.entry_form=48  and b.status_active=1 and b.is_deleted=0  ");
		 $all_batch_id='';
		foreach($sql_batch as $row) 
		{
			if($all_batch_id=="") $all_batch_id=$row[csf('batch_id')]; else $all_batch_id.=",".$row[csf('batch_id')];
		}
			$all_batch_ids=implode(",",array_unique(explode(",",$all_batch_id)));
		//echo $all_batch_ids; 
		$batch_ids_cond="";
		if($all_batch_ids!="") 
		{
			//echo $po_id=substr($po_id,0,-1);
			if($db_type==0) { $batch_ids_cond="and b.id in(".$all_batch_ids.")"; }
			else
			{
				$bat_id=array_unique(explode(",",$all_batch_ids));
				if(count($bat_id)>1000)
				{
					$batch_ids_cond="and (";
					$bat_id=array_chunk($bat_id,1000);
					$z=0;
					foreach($bat_id as $id)
					{
						$id=implode(",",$id);
						if($z==0) $batch_ids_cond.=" b.id in(".$id.")";
						else $batch_ids_cond.=" or b.id in(".$id.")";
						$z++;
					}
					$batch_ids_cond.=")";
				}
				else { 
				
				$batch_ids_cond=" and b.id in(".$all_batch_ids.")"; }
			}
		}
	}
	
		
	if($from_date!="" && $to_date!="")
	{
		$date_cond_samp="";
		if(str_replace("'","",$cbo_value_with)==2)
		{
		 $date_cond_samp=" and b.batch_date between '".$from_date."' and '".$to_date."'";
		}
	}
	$samp_non_booking=sql_select("select b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,a.buyer_id from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond  $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
	$all_batch_id_samp="";
	foreach($samp_non_booking as $row)
	{
		$non_buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$sample_booking_ref_no_arr[$row[csf('booking_no')]]=$row[csf('grouping')];
		if($txt_samp_ref_no!='')
		{
		if($all_batch_id_samp=="") $all_batch_id_samp=$row[csf('batch_id')]; else $all_batch_id_samp.=",".$row[csf('batch_id')];
		}
	}
	unset($samp_non_booking);
	if($all_batch_id_samp!="") $all_batch_id_samp_cond="and b.id in($all_batch_id_samp)";else $all_batch_id_samp_cond="";
	//echo $all_batch_id_samp_cond.'X';
	$date_cond="";
    if($from_date!="")
    {
		if(str_replace("'","",$cbo_value_with)==1)
		{
			 $date_cond=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";
		}
		else
		{
			 $date_cond=" and b.batch_date between '".$from_date."' and '".$to_date."'";
		}
   }
  
   if(str_replace("'","",$cbo_value_with)==2)
		{
		 
   		  $sql_data="select b.id,b.extention_no,b.batch_no,b.booking_without_order,b.entry_form,b.batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from,c.po_id
		 from pro_batch_create_mst b,pro_batch_create_dtls c  where  b.id=c.mst_id and c.status_active=1 and b.status_active=1  $company_idcond  $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";
		}
		else
		{
			 $sql_data="select b.id,b.extention_no,b.batch_no,b.booking_without_order,b.entry_form,b.batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from,c.po_id
		 from pro_fab_subprocess a, pro_batch_create_mst b,pro_batch_create_dtls c  where  a.batch_id=b.id and b.id=c.mst_id  and a.load_unload_id=2 and a.status_active=1 and b.status_active=1 and c.status_active=1   $company_idcond  $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";
		}
		
	$sql_result=sql_select($sql_data); //a.process_end_date,a.production_date,a.end_hours,a.end_minutes,a.fabric_type,a.floor_id,a.machine_id
	$all_batch_id_unload="";
    foreach($sql_result as $row)
	 {
		 $batch_id_arr[]=$row[csf("id")]; 
		 $batch_wise_arr[$row[csf("id")]]['batch_no']=$row[csf("batch_no")];
		 $batch_wise_arr[$row[csf("id")]]['extention_no']=$row[csf("extention_no")];
		 $batch_wise_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
		 $batch_wise_arr[$row[csf("id")]]['end_date']=$row[csf("production_date")];
		 $batch_wise_arr[$row[csf("id")]]['prod_date']=$row[csf("process_end_date")];
		 $batch_wise_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
		 $batch_wise_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
		 $batch_wise_arr[$row[csf("id")]]['batch_weight']=$row[csf("batch_weight")];
		 $batch_wise_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
		 $batch_wise_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
		 $batch_wise_arr[$row[csf("id")]]['color_range_id']=$row[csf("color_range_id")];
		 $batch_wise_arr[$row[csf("id")]]['po_id'].=$row[csf("po_id")].',';
		// $batch_wise_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
		 $batch_wise_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
		
		 $buyer= $po_number_arr[$row[csf('po_id')]]['buyer'];
		 $batch_wise_arr[$row[csf("id")]]['buyer']=$buyer;
		 
		 if($all_batch_id_unload=="") $all_batch_id_unload=$row[csf('id')]; else $all_batch_id_unload.=",".$row[csf('id')];
		 
		// $batch_no_arr[]="'".$row[csf("batch_no")]."'";
	 }
	 fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 2, $batch_id_arr, $empty_arr);//Batch ID Ref from=2

	 $jobIds=chop($all_batch_id_unload,',');
	//echo $jobIds;die;
	$job_cond_for_in="";
	$job_ids=count(array_unique(explode(",",$all_batch_id_unload)));
		if($db_type==2 && $job_ids>1000)
		{
			$job_cond_for_in=" and (";
			$job_cond_for_in2=" and (";
			$jobIdsArr=array_chunk(explode(",",$jobIds),999);
			foreach($jobIdsArr as $ids)
			{
				$ids=implode(",",$ids);
				$job_cond_for_in.=" b.id in($ids) or"; 
				$job_cond_for_in2.=" a.batch_id in($ids) or"; 
			}
			$job_cond_for_in=chop($job_cond_for_in,'or ');
			$job_cond_for_in.=")";
			$job_cond_for_in2=chop($job_cond_for_in2,'or ');
			$job_cond_for_in2.=")";
		}
		else
		{
			$jobIds=implode(",",array_unique(explode(",",$all_batch_id_unload)));
			$job_cond_for_in=" and b.id in($jobIds)";
			$job_cond_for_in2=" and a.batch_id in($jobIds)";
		}
		//print_r($batch_ids);die;
	$sql_fin_prod_batch=sql_select("select a.batch_id as batch_id,a.current_delivery from pro_grey_prod_delivery_dtls a,pro_grey_prod_delivery_mst b,gbl_temp_engine g   where  b.id=a.mst_id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.entry_form=54 $job_cond_for_in2");
	//echo "select a.batch_id as batch_id,a.current_delivery from pro_grey_prod_delivery_dtls a  where   a.status_active=1 and a.is_deleted=0 $job_cond_for_in2";

	foreach($sql_fin_prod_batch as $row) 
	{
	  $fin_prod_qty_arr[$row[csf('batch_id')]]+=$row[csf('current_delivery')]; 
	}
	
	//$date_cond2=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";
	
  $prod_sql="select b.id,a.batch_no,a.load_unload_id,a.entry_form,a.end_hours,a.end_minutes,a.start_hours,a.start_minutes,a.process_end_date,a.production_date,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,a.end_hours,a.end_minutes,a.fabric_type,a.floor_id,a.machine_id,b.color_range_id,b.booking_no,b.batch_weight,b.color_id, b.batch_against, b.re_dyeing_from
	from pro_fab_subprocess  a,pro_batch_create_mst b,gbl_temp_engine g  where  a.batch_id=b.id and a.batch_id=g.ref_val and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 
	   and a.status_active=1 and a.is_deleted=0 $company_idcond";
  	 $load_hr_min_arr=array();
	 $result_prod=sql_select($prod_sql);
     foreach($result_prod as $row)
	 {
		
		//echo $row[csf('entry_form')].'X';
		if($row[csf('load_unload_id')]==1)
		{
		$load_hr_min_arr[$row[csf('id')]]=$row[csf('end_hours')].':'.$row[csf('end_minutes')];
		$load_date_arr[$row[csf('id')]]=$row[csf('process_end_date')];
		//echo $row[csf('process_end_date')]."=";
		}
		
		//33=Compacting,30=Sliting,47=Singing,,32=Heatset,48=Stentering
		
		if($row[csf('entry_form')]==32 || $row[csf('entry_form')]==30 || $row[csf('entry_form')]==47 || $row[csf('entry_form')]==48 || $row[csf('entry_form')]==33 ) //Heat Set
		{
			//echo $row[csf('entry_form')].'='.$row[csf('load_unload_id')].',  ';
		$end_time=$row[csf('end_hours')].':'.$row[csf('end_minutes')];
		$start_time=$row[csf('start_hours')].':'.$row[csf('start_minutes')];
		$start_date=$row[csf('process_end_date')];
		$end_date=$row[csf('production_date')];
		$new_date_time_start=($end_date.' '.$end_time.':'.'00');
		$new_date_time_end=($start_date.' '.$start_time.':'.'00');
		$heatset_total_time=datediff(n,$new_date_time_end,$new_date_time_start);
	    //$heat_applicable_cpm=$machine_cpm_arr[$row[csf("machine_id")]][$row[csf('process_end_date')]]['cmp'];
		//$machine_cpm_arr[$row[csf('id')]][$row[csf('applicable_date')]]['date'];
		$heat_applicable_cpm=$heat_applicable_time=0;
		$i=1;
		foreach($machine_cpm_arr[$row[csf("machine_id")]] as $date_time=>$val)
		{
			if($date_time<=$row[csf('process_end_date')])
			{
				$prod_time=strtotime($row[csf('process_end_date')]);
				$lib_time=strtotime($date_time);
				$time_dev=$prod_time-$lib_time;
				if($i==1) 
				{
					$heat_applicable_time=$time_dev;
					$heat_applicable_cpm=$val;
				}
				
				if($time_dev<$heat_applicable_time)
				{
					$heat_applicable_time=$time_dev;
					$heat_applicable_cpm=$val;
				}
			}
		
			$i++;
		}
		//echo $row[csf('entry_form')].'='.$heat_applicable_cpm.'='.$start_date.'m';
		$heat_time_used=floor($heatset_total_time/60).":".$heatset_total_time%60;
		$heat_time_used_cal=explode(":",$heat_time_used);
		$tot_time_used_cal_min=$heat_time_used_cal[0]*60+$heat_time_used_cal[1];
		 $prod_heatset_arr[$row[csf("id")]]['end_hr_min']=$row[csf('end_hours')].':'.$row[csf('end_minutes')];
		 $prod_heatset_arr[$row[csf("id")]]['start_hr_min']=$row[csf('start_hours')].':'.$row[csf('start_minutes')];
		 $prod_heatset_arr[$row[csf("id")]]['end_date']=$row[csf('process_end_date')];
		 $prod_cmp_arr[$row[csf("id")]]['heat_time_min']+=$heat_applicable_cpm*$tot_time_used_cal_min;
		}
		
	 }
	 
	 $unload_prod_sql="select b.id,a.batch_no,a.load_unload_id,a.entry_form,a.end_hours,a.end_minutes,a.start_hours,a.start_minutes,a.process_end_date,a.production_date,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,a.end_hours,a.end_minutes,a.fabric_type,a.floor_id,a.machine_id,b.color_range_id,b.booking_no,b.batch_weight,b.color_id, b.batch_against, b.re_dyeing_from
	from pro_fab_subprocess  a,pro_batch_create_mst b,gbl_temp_engine g  where  a.batch_id=b.id  and a.batch_id=g.ref_val and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48  
	   and a.status_active=1 and a.is_deleted=0 and a.load_unload_id=2 $company_idcond ";
	 $result_prod_unload=sql_select($unload_prod_sql);
     foreach($result_prod_unload as $row)
	 {
		
		//echo $row[csf('entry_form')].'X';
		if($row[csf('load_unload_id')]==1)
		{
	//	$load_hr_min_arr[$row[csf('id')]]=$row[csf('end_hours')].':'.$row[csf('end_minutes')];
		//$load_date_arr[$row[csf('id')]]=$row[csf('process_end_date')];
		//echo $row[csf('process_end_date')]."=";
		}
		if($row[csf('load_unload_id')]==2)
		{
		$unload_hr_min_arr[$row[csf('id')]]=$row[csf('end_hours')].':'.$row[csf('end_minutes')];
		$prod_wise_arr[$row[csf("id")]]['end_hours']=$row[csf("end_hours")];
		$prod_wise_arr[$row[csf("id")]]['end_minutes']=$row[csf("end_minutes")];
		$prod_wise_arr[$row[csf("id")]]['prod_date']=$row[csf("production_date")];
		$prod_wise_arr[$row[csf("id")]]['machine_id']=$row[csf("machine_id")];
		//echo $row[csf("machine_id")].'M';
		$prod_wise_arr[$row[csf("id")]]['floor_id']=$row[csf("floor_id")];
		}
		//33=Compacting,30=Sliting,47=Singing,,32=Heatset,48=Stentering
		
		
		if($row[csf('load_unload_id')]==2)
		{
		$load_hr_min=$load_hr_min_arr[$row[csf("id")]];
		$new_date_time_load=($load_date_arr[$row[csf("id")]].' '.$load_hr_min.':'.'00');
		$end_time=$row[csf('end_hours')].':'.$row[csf('end_minutes')];
		$start_time=$row[csf('start_hours')].':'.$row[csf('start_minutes')];
		$start_date=$row[csf('process_end_date')];
		$end_date=$row[csf('production_date')];
		$new_date_time_start_unload=($end_date.' '.$end_time.':'.'00');
		//echo $new_date_time_load.'='.$new_date_time_start_unload;
		$unload_total_time=datediff(n,$new_date_time_load,$new_date_time_start_unload);
		$unload_applicable_cpm=$unload_applicable_time=0;
		$k=1;
		foreach($machine_cpm_arr[$row[csf("machine_id")]] as $date_time=>$val)
		{
			if($date_time<=$row[csf('process_end_date')])
			{
				$prod_time_dye=strtotime($row[csf('process_end_date')]);
				$lib_time_dye=strtotime($date_time);
				$unload_time_dev=$prod_time_dye-$lib_time_dye;
				if($k==1) 
				{
					$unload_applicable_time=$unload_time_dev;
					$unload_applicable_cpm=$val;
				}
				
				if($unload_time_dev<$unload_applicable_time)
				{
					$unload_applicable_time=$unload_time_dev;
					$unload_applicable_cpm=$val;
				}
			}
			$k++;
		}
			$unload_time_used=floor($unload_total_time/60).":".$unload_total_time%60;
			$unload_time_used_cal=explode(":",$unload_time_used);
			$unload_time_used_cal_min=$unload_time_used_cal[0]*60+$unload_time_used_cal[1];
		//	echo $unload_applicable_cpm.'='.$unload_time_used_cal_min.'m';
			$prod_cmp_arr[$row[csf("id")]]['dying_time_min']+=$unload_applicable_cpm*$unload_time_used_cal_min;
			}
	 }
	// print_r($prod_cmp_arr);
	 unset($result_prod_unload);
	 
    $sql_dyes_cost =sql_select("select a.batch_no,b.item_category,(b.cons_amount) as dyes_chemical_cost,b.cons_quantity as qty,b.cons_rate,b.prod_id
    from inv_issue_master a, inv_transaction b
    where a.id=b.mst_id and b.transaction_type=2 and a.entry_form=5  and a.batch_no  is not null  and   b.item_category in (5,6,7) and b.cons_quantity>0 "); 
	$dyes_chemical_arr=array();
	foreach($sql_dyes_cost as $val)
	{
		$batch_nos=array_unique(explode(",",$val[csf("batch_no")]));
		foreach($batch_nos as $baID)
		{
		 $dyes_chemical_arr[$baID][$val[csf("prod_id")]][$val[csf("item_category")]]['cons_qty']+=$val[csf("qty")];
		 $dyes_chemical_rate_arr[$baID][$val[csf("prod_id")]][$val[csf("item_category")]]['cons_rate']=$val[csf("cons_rate")];
		}
		
		// $dyes_chemical_cost_arr[$val[csf("batch_no")]][$val[csf("prod_id")]]['dyes_chemical_cost']+=$val[csf("dyes_chemical_cost")];
	}
	unset($sql_dyes_cost);
	$sql_recipe =sql_select("SELECT a.id,a.batch_qty,a.batch_id,b.prod_id,b.sub_process_id,b.dose_base,b.ratio,b.total_liquor,c.item_category_id as cat_id,c.avg_rate_per_unit
    from pro_recipe_entry_mst a,pro_recipe_entry_dtls b,product_details_master c,gbl_temp_engine g 
    where a.id=b.mst_id and c.id=b.prod_id and a.batch_id=g.ref_val   and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48  and  b.ratio>0 and c.item_category_id in (5,6,7) and b.status_active=1  and a.status_active=1  and c.status_active=1  ");  
	
	$recipe_arr=array();
	$total_liquor=0;$tot_chemical_qty=0;
	foreach($sql_recipe as $val)
	{
		if($subpro_recipe_arr_chk[$val[csf("id")]][$val[csf("sub_process_id")]]=="")
		{
			$total_liquor=$val[csf("total_liquor")];
		}
		//echo $total_liquor.'m';
		if($val[csf("dose_base")]==1) //GPLL
		{
			$tot_req_qty=($total_liquor/1000)*$val[csf("ratio")];
		}
		else if($val[csf("dose_base")]==2) //% on BW
		{
			$tot_req_qty=($val[csf("batch_qty")]*$val[csf("ratio")])/100;
		}
		if($val[csf("cat_id")]==5 || $val[csf("cat_id")]==7)
		{
			//$chemical_qty=0;$chemi_cons_rate=0;
		$chemi_cons_rate=$dyes_chemical_rate_arr[$val[csf("batch_id")]][$val[csf("prod_id")]][$val[csf("cat_id")]]['cons_rate'];
		$chemical_qty=$dyes_chemical_arr[$val[csf("batch_id")]][$val[csf("prod_id")]][$val[csf("cat_id")]]['cons_qty']+$dyes_chemical_arr[$val[csf("batch_id")]][$val[csf("prod_id")]][$val[csf("cat_id")]]['cons_qty'];
		//echo $chemical_qty.'m'.$chemi_cons_rate.',';
		$tot_chemical_qty+=$dyes_chemical_arr[$val[csf("batch_id")]][$val[csf("prod_id")]][5]['cons_qty']+$dyes_chemical_arr[$val[csf("batch_id")]][$val[csf("prod_id")]][7]['cons_qty'];
		}
		else
		{
		$dyes_cons_rate=$dyes_chemical_rate_arr[$val[csf("batch_id")]][$val[csf("prod_id")]][$val[csf("cat_id")]]['cons_rate'];
		$dyes_qty=$dyes_chemical_arr[$val[csf("batch_id")]][$val[csf("prod_id")]][$val[csf("cat_id")]]['cons_qty'];
		}
		if($chemical_qty>0)
		{
		$tot_req_qty_cal_chemi=($tot_req_qty*100)/$chemical_qty;
		$tot_req_qty_cal_chemi_cal=$tot_req_qty_cal_chemi*$chemical_qty/100;
		}
		if($dyes_qty>0)
		{
		$tot_req_qty_cal_dyes=($tot_req_qty*100)/$dyes_qty;
		$tot_req_qty_cal_dyes_cal=$tot_req_qty_cal_dyes*$dyes_qty/100;
		}
		//$dyes_qty=$dyes_chemical_arr[$baID][6]['cons_qty'];
		if($val[csf("cat_id")]==5 || $val[csf("cat_id")]==7)
		{
			if($chemi_cons_rate>0)
			{
			 $dyes_chemical_cost_arr[$val[csf("batch_id")]]['chemical_cost']+=$tot_req_qty_cal_chemi_cal*$chemi_cons_rate;
			}
		}
		if($val[csf("cat_id")]==6)
		{
			if($dyes_cons_rate>0)
			{
			 $dyes_chemical_cost_arr[$val[csf("batch_id")]]['dyes_cost']+=$tot_req_qty_cal_dyes_cal*$dyes_cons_rate;
			}
		}
		
	}
	//echo $tot_chemical_qty.'x';
	unset($sql_recipe);
	//print_r($dyes_chemical_cost_arr);
	$i=1;
	$con = connect();
	execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id." and ref_from in (1,2,3) and ENTRY_FORM=48");
	oci_commit($con);
	disconnect($con);

	ob_start();	
	?>
	<div id="" align="center" style="height:auto; width:auto; margin:0 auto; padding:0;">
        <table width="2050px" cellpadding="0" cellspacing="0" id="caption" align="center">
            <thead>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:16px; font-weight:bold" ><? echo $report_title; ?></td 
                ></tr>
                <tr style="border:none;">
                    <td colspan="24" class="form_caption" align="center" style="border:none; font-size:14px;">
                       <b>Company Name : <? echo $companyArr[$cbo_company_name]; ?></b>                               
                    </td>
                </tr>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:12px; font-weight:bold">
                        <? if($from_date!="" || $to_date!="")echo "From : ".change_date_format($from_date,'dd-mm-yyyy')." To : ".change_date_format($to_date,'dd-mm-yyyy')."" ;?>
                    </td>
                </tr>
            </thead>
        </table>
 <div>
 
        <div  align="left" style="font-size:25px"></div>
        <table width="2390" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>
                    <th rowspan="2" width="100">Batch No</th>
                    <th rowspan="2" width="100">Ext. No.</th>
                    <th rowspan="2" width="100">Batch Date</th>
                    <th rowspan="2" width="100">Buyer</th>
                    <th rowspan="2" width="70">File No</th>
                    <th rowspan="2" width="70">Int. Ref. No</th>
                    <th rowspan="2" width="">Booking No</th>
                    <th rowspan="2" width="100">Color Name</th>
                    <th rowspan="2" width="100">Color Range</th>
                    <th rowspan="2" width="100">Batch Wgt (Kg)</th>
                    <th rowspan="2" width="100">Finish delivery Qty</th>
                    
                    <th rowspan="2" width="100">Dyeing Date</th>
                    <th rowspan="2" width="100">Dyeing MC No</th>
                    <th rowspan="2" width="100">Floor Name</th>
                    <th colspan="10" width="1000">First Time Dying And Finishing Cost</th>
                </tr> 
                <tr>                         
                    <th width="100">Loading Time</th>
                    <th width="100">Un-Load Time</th>
                    <th width="100"><p>TTL Time</p></th>
                    <th width="100">TTL Chem Cost(Tk)</th>
                    <th width="100">TTL Dyes Cost(Tk)</th>
                    
                    <th width="100">TTL Raw Mat.Cost(Tk)</th>
                    <th width="100">Dyeing OH Cost(Tk)</th>
                    <th width="100">Finish OH Cost(Tk)</th>
                    <th width="100">Batch Cost (Tk)</th>
                    <th width="100">Cost Per Kg</th>
                    
                </tr> 
            </thead>
        </table>
        <?
        //die;
		?>
        <div style="width:2410px; max-height:400px;  overflow-y:scroll" id="scroll_body">
         <table width="2390" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_id" >
            <tbody>
       <?
	 
		$tot_material_cost=0;$tot_chemical_cost=0;$tot_dying_cost=$total_batch_cost=$total_tot_fin_oh_cost=$total_fin_prod_qty=$total_batch_weight=0;
		foreach($batch_wise_arr as $batch_id=>$val)
		{
			
			if($i%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
			$all_po_id=explode(",",$po_break_down_id_arr[$batch_description_arr[$batch_id]['booking_no']]);
			//$po_number_data="";
			$po_id=rtrim($val['po_id'],',');
			$all_po_id=array_unique(explode(",",$po_id));
			/*$job_no_data="";$file_no="";$ref_no="";
			foreach($all_po_id as $p_id) // $po_number_arr[$row[csf('id')]]['po_no']
			{
				if($po_number_data!="") $po_number_data.=",".$po_number_arr[$p_id]['po_no'];	 else $po_number_data=$po_number_arr[$p_id]['po_no'];
				if($job_no_data!="") $job_no_data.=",".$po_number_arr[$p_id]['job'];	 else $job_no_data=$po_number_arr[$p_id]['job'];
				if($file_no!="") $file_no.=",".$po_number_arr[$p_id]['file_no'];	 else $file_no=$po_number_arr[$p_id]['file_no'];
				if($ref_no!="") $ref_no.=",".$po_number_arr[$p_id]['ref_no'];	 else $ref_no=$po_number_arr[$p_id]['ref_no'];
			} */
			// $po_number_arr[$row[csf('id')]]['ref_no']=$row[csf('ref_no')];
			// $po_number_arr[$row[csf('id')]]['file_no']
			$file_no="";$ref_no="";
			foreach($all_po_id as $p_id) // $po_number_arr[$row[csf('id')]]['po_no']
			{
				if($file_no!="") $file_no.=",".$po_number_arr[$p_id]['file_no'];	 else $file_no=$po_number_arr[$p_id]['file_no'];
				if($ref_no!="") $ref_no.=",".$po_number_arr[$p_id]['ref_no'];	 else $ref_no=$po_number_arr[$p_id]['ref_no'];
			}
			$file_no=implode(",",array_unique(explode(",",$file_no)));
			$ref_no=implode(",",array_unique(explode(",",$ref_no)));
			
			$prod_date=$prod_wise_arr[$batch_id]['prod_date'];
			$machine_id= $prod_wise_arr[$batch_id]['machine_id'];
			//echo $machine_id.'D';
			$floor_id= $prod_wise_arr[$batch_id]['floor_id'];
			$without_order= $val['without_order'];
			//echo $without_order.'d';
			if($without_order==1)
			{
				$buyerName=$non_buyer_name_arr[$val[('booking_no')]];
			}
			else
			{
				$buyerName=$val[('buyer')];
			}
			
			$prod_heatset_arr[$row[csf("id")]]['end_date'];
			$unload_time=$unload_hr_min_arr[$batch_id];
			$load_hr_min=$load_hr_min_arr[$batch_id];
			$unload_date=$prod_wise_arr[$batch_id]['prod_date'];
			//echo $unload_date.'ddd'.$load_date_arr[$batch_id];
			$new_date_time_unload=($unload_date.' '.$unload_time.':'.'00');
			$new_date_time_load=($load_date_arr[$batch_id].' '.$load_hr_min.':'.'00');
			//echo $new_date_time_unload.'=='.$new_date_time_load;
			$total_time=datediff(n,$new_date_time_load,$new_date_time_unload);
			$heat_time_min_cpm=$prod_cmp_arr[$batch_id]['heat_time_min'];
			$tot_fin_oh_cost=$heat_time_min_cpm;
			
			$chemical_cost=	$dyes_chemical_cost_arr[$batch_id]['chemical_cost'];
			$dyes_cost=	$dyes_chemical_cost_arr[$batch_id]['dyes_cost'];
			$fin_prod_qty=$fin_prod_qty_arr[$batch_id];
			
		
			 
			?>
            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
                <td width="30"><? echo $i; ?></td>								
                <td width="100"><? echo $val['batch_no']; ?></td>
                <td width="100"><? echo $val['extention_no']; ?></td>
                <td width="100"><? echo change_date_format($val['batch_date']); ?></td>
                <td width="100"><p><? echo $buyer_library[$buyerName]; ?></p></td>  
                <td width="70"><? echo $file_no; ?></td>
                <td width="70"><? echo $ref_no; ?></td>                               
               
                <td width=""><p><? echo $val['booking_no'];// echo $floor_arr[$b_id]; ?></p></td> 
               
                <td width="100" align="center"><div style="word-break:break-all"><? echo $color_arr[$val['color_id']]; ?></div></td> 
                <td width="100" align="center"><p><? echo $color_range[$val['color_range_id']]; ?></p></td> 
                <td width="100" align="right"><p><? echo $val['batch_weight']; //$fabric_type_for_dyeing?></p></td> 
                <td width="100" align="right"><p><? echo $fin_prod_qty; //$fabric_type_for_dyeing?></p></td> 
                <td width="100" align="center"><p>
                <? echo change_date_format($prod_date);?>
                </p></td> 
               
                <td width="100" align="center"><p>
                <?
				echo $machine_name_arr[$machine_id];
                // echo number_format($first_chemi_cost,4,".",""); 
                // $total_chemical_cost+=$first_chemi_cost;
                 ?>
                </p></td>
                <td width="100" align="center"><p>
                <?  
                  echo $floor_arr[$floor_id];
                ?>
                </p></td>
                <td width="100" align="right"><p>
                <?
				
                // $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
                  echo  $load_hr_min;
                 // $total_batch_chemical_price+=$batch_chemical_price;
                ?>
                </p></td>
              
                <td width="100" align="right"><p>
               
                <? 
               echo $unload_time;
                 ?></p></td>
                <td width="100" align="right"><p>
                <? 
				if($unload_date!="")
				{
             	$tot_time_used=floor($total_time/60).":".$total_time%60;
              	 echo $tot_time_used;	
				}
				else echo "";
			  
			  // $tot_time_used_cal=explode(":",$tot_time_used);
			 //  $dying_applicable_cpm=$dyeing_machine_cpm_arr[$machine_id][$prod_date];
			  // $dying_time_used_cal_min=$tot_time_used_cal[0]*60+$tot_time_used_cal[1];
			  // $dying_oh_cost=$prod_cmp_arr[$batch_id]['dying_time_min'];
			   
			    ?>
                </p></td>
                <td width="100" align="right" title="<? echo $dying_time_used_cal_min;?>"><p><?
				
                    $ttl_chemi_cost=$chemical_cost;//$dyes_chemical_arr[$batch_id][5]['chemical_cost']+$dyes_chemical_arr[$batch_id][7]['chemical_cost'];
                   $ttl_dying_dyes_cost=$dyes_cost;//$dyes_chemical_arr[$batch_id][6]['chemical_cost'];	
                
               if($ttl_chemi_cost>0) echo number_format($ttl_chemi_cost,2);echo "";
                ?></p></td>
                <td width="100" align="right"><p>
                <?
				
				 if($ttl_dying_dyes_cost>0) echo number_format($ttl_dying_dyes_cost,2);echo "";
                 
                $tot_ttl_mat_cost=$ttl_dying_dyes_cost+$ttl_chemi_cost;
				 $tot_dying_chemical_cost+=$ttl_dying_dyes_cost;
				  $tot_chemical_cost+=$ttl_chemi_cost;
				  
				   $dying_oh_cost=($tot_ttl_mat_cost*120)/100;
                 ?>
                 </p></td>
                <td width="100" align="right"><p><? 
				if($tot_ttl_mat_cost>0) echo number_format($tot_ttl_mat_cost,2);echo "";
				  $tot_material_cost+=$tot_ttl_mat_cost;  ?></p></td>
                <td width="100" align="right" title="ttl Raw mat*120/100"><p><? if($dying_oh_cost>0) echo number_format($dying_oh_cost,2);echo "";   $tot_dying_oh_cost+=$dying_oh_cost; ?></p></td>
                <td width="100" align="right" title=""><? if($tot_fin_oh_cost>0) echo number_format($tot_fin_oh_cost,2);echo ""; ?></td>
                <td width="100" align="right" title="Material Cost+Dying Oh Cost+Fin OH Cost"><? $tot_batch_cost=$tot_ttl_mat_cost+$dying_oh_cost+$tot_fin_oh_cost;
				if($tot_batch_cost>0) echo number_format($tot_batch_cost,2);echo "";  ?></td>
                 <td width="100" align="right" title="BatchCost/Batch Weight"><? //$tot_batch_cost=$tot_ttl_mat_cost+$dying_oh_cost+$tot_fin_oh_cost;
				//if($tot_batch_cost>0) echo number_format($tot_batch_cost,2);echo ""; 
				echo number_format($tot_batch_cost/$val['batch_weight'],2);
				  ?></td>
               
            </tr>
			<? 												
				 $total_batch_cost+=$tot_batch_cost;
				  $total_tot_fin_oh_cost+=$tot_fin_oh_cost; $total_fin_prod_qty+=$fin_prod_qty;
				  $total_tot_cost_per+=$tot_batch_cost/$val['batch_weight'];
				   $total_batch_weight+=$val['batch_weight'];
				 $i++; 				
		}
		?>
            </tbody>
      </table>
       <table width="2390" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer" >
             <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                    <th width="100">&nbsp;</th> 
                    <th width="70">&nbsp;</th>
                    <th width="70">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="">Total</th>
                	<th width="100" id="value_total_batch_weight_single"><? echo $total_batch_weight;?></th>
                   	<th width="100" id="value_total_delivery_cost_single"><? echo $total_fin_prod_qty;?></th>
                	<th width="100">&nbsp;</th>
                
                	<th width="100">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    
                	<th width="100"></th>
                  
                    <th width="100" id=""></th>
                    <th width="100" id="value_total_chemical_cost"><p><? echo number_format($tot_chemical_cost,2); ?></p></th>
                    <th width="100" id="value_total_tot_dyes_cost"><p><? echo number_format($tot_dyeing_cost,2); ?></p></th>
                    <th width="100" id="value_total_material_cost"><? echo number_format($tot_material_cost,2); ?></th>
                    <th width="100" id="value_grand_tot_dying_oh_cost"><? echo number_format($tot_dying_oh_cost,2); ?></th>
                    <th width="100" id="value_grand_tot_fin_oh_cost" title="<? echo number_format($total_tot_fin_oh_cost,2);?>"><? echo number_format($total_tot_fin_oh_cost,2); ?></th>
                    <th width="100" id="value_grand_batch_cost"><? echo number_format($total_batch_cost,2);?></th>
                    <th width="100" id="value_total_cost_per_tk"><? echo number_format($total_tot_cost_per,2);?></th>
                </tr>
            </tfoot>
        </table>
      
        </div>
	</div>
      
       
  </div>
    <?
    $html = ob_get_contents();
    ob_clean();
    //$new_link=create_delete_report_file( $html, 2, $delete, "../../../" );
    foreach (glob("*.xls") as $filename) {
    //if( @filemtime($filename) < (time()-$seconds_old) )
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');	
    $is_created = fwrite($create_new_doc, $html);
    echo "$html****$filename****$report_type****$report_type"; 
    exit();
}
if($action=="generate_report5") // Batch  Wise
{ 
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if ($cbo_company_name==0) $company_id=""; else $company_id=" and a.company_id='$cbo_company_name'";
	if ($cbo_company_name==0) $company_idcond =""; else $company_idcond =" and b.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond .=""; else $company_idcond .=" and b.working_company_id='$cbo_working_name'";
	$from_date=str_replace("'","",$from_date);
	$to_date=str_replace("'","",$to_date);
	//echo $from_date;
	$txt_ref_no=str_replace("'","",$txt_ref_no);
	$txt_file_no=str_replace("'","",$txt_file_no);
	$txt_booking_no=str_replace("'","",$txt_booking_no);
	$txt_po_no=str_replace("'","",$txt_po_no);
	$txt_job=str_replace("'","",$txt_job);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$cbo_season_id=str_replace("'","",$cbo_season_id);
	$txt_samp_ref_no=str_replace("'","",$txt_samp_ref_no);
	$location_id=str_replace("'","",$location_id);
	$floor_id=str_replace("'","",$floor_id);
	$report_type=str_replace("'","",$report_type);

	$floor_cond_arr=array();

	if(!empty($location_id))
	{
		if(!empty($floor_id))
		{
			
			
			$sql="select  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 and b.company_id=$cbo_working_name and b.location_id=$location_id and b.production_process=3 and b.id=$floor_id";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) {
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}else{
			$sql="select  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 and b.company_id=$cbo_working_name and b.location_id=$location_id and b.production_process=3";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) {
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		$floor_cond_arr=array_unique($floor_cond_arr);
	}
	//print_r($floor_cond_arr);
	
	if(str_replace("'","",$cbo_buyer_name)==0)
	{
		if ($_SESSION['logic_erp']["data_level_secured"]==1)
		{
			if($_SESSION['logic_erp']["buyer_id"]!="") $buyer_id_cond=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")"; else $buyer_id_cond="";
		}
		else
		{
			$buyer_id_cond="";
		}
	}
	else
	{
		$buyer_id_cond=" and a.buyer_name in (".str_replace("'","",$cbo_buyer_name).")";
	}
	
	if($txt_booking_no!='') $booking_no_cond="and b.booking_no like '%$txt_booking_no%' ";else $booking_no_cond="";
	
	if($txt_file_no!='') $file_cond="and b.file_no='$txt_file_no'";else $file_cond="";
	if($txt_job!='') $job_cond="and a.job_no_prefix_num=$txt_job";else $job_cond="";
	if($txt_po_no!='') $po_cond="and b.po_number='$txt_po_no'";else $po_cond="";
	
	if($cbo_season_id!=0) $season_cond="and a.season_buyer_wise in($cbo_season_id)";else $season_cond="";
	
	if($txt_ref_no!='') $ref_cond="and b.grouping='$txt_ref_no'";else $ref_cond="";
	if($txt_samp_ref_no!='') $samp_ref_cond="and a.grouping='$txt_samp_ref_no'";else $samp_ref_cond="";
	//echo $ref_cond;
	$companyArr = return_library_array("select id,company_name from lib_company where status_active=1 and is_deleted=0","id","company_name"); 
	$supplierArr = return_library_array("select id,supplier_name from lib_supplier where status_active=1 and is_deleted=0","id","supplier_name"); 
	$color_arr=return_library_array( "select id,color_name  from  lib_color", "id", "color_name"  );
	$season_name_arr=return_library_array( "select id,season_name  from  lib_buyer_season", "id", "season_name"  );// id, season_name from lib_buyer_season
	//$batch_arr=return_library_array( "select id, batch_no from  pro_batch_create_mst", "id", "batch_no");
   // $po_number_arr=return_library_array(" select  id ,po_number from   wo_po_break_down", "id", "po_number" );
	//$job_no_arr=return_library_array(" select  id ,job_no_mst from   wo_po_break_down", "id", "job_no_mst" );
	//$po_break_down_id_arr=return_library_array( "select booking_no,po_break_down_id from  wo_booking_mst ", "booking_no", "po_break_down_id" );
   // $floor_arr=return_library_array("select  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0", "batch_id", "floor_name" );

    //$unload_result_arr=return_library_array("select a.batch_id, a.result from  pro_fab_subprocess a where a.entry_form=35 and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0", "batch_id", "result" );

	//$machine_name_arr=return_library_array("select  a.batch_id ,b.machine_no from   pro_fab_subprocess a, lib_machine_name b  where a.machine_id=b.id and a.entry_form=35 and  b.status_active=1 and b.is_deleted=0", "batch_id", "machine_no" );
	//$buyer_name_arr=return_library_array( "select a.booking_no,b.buyer_name from  wo_booking_mst a, lib_buyer b where a.buyer_id=b.id", "booking_no", "buyer_name" );
	//$non_buyer_name_arr=return_library_array( "select a.booking_no,b.buyer_name from  wo_non_ord_samp_booking_mst a, lib_buyer b where a.buyer_id=b.id", "booking_no", "buyer_name" );
	$sql_book=sql_select("select a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b where a.buyer_id=b.id");
	foreach($sql_book as $row)
	{
		$buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$po_break_down_id_arr[$row[csf('booking_no')]]=$row[csf('po_break_down_id')];
	}
	
    $buyer_library=return_library_array( "select id,buyer_name from   lib_buyer", "id","buyer_name" );
   // $style_library=return_library_array( "select job_no,style_ref_no from   wo_po_details_master", "job_no","style_ref_no" );
	/*$po_data_subcon=sql_select("select a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0  ");
	
	$sub_con_arr=array();
	foreach($po_data_subcon as $row)
	{
		if($sub_con_arr[$row[csf('mst_id')]][cust_style_ref]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref].=",".$row[csf('cust_style_ref')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref]=$row[csf('cust_style_ref')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][order_no]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no].=",".$row[csf('order_no')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no]=$row[csf('order_no')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][subcon_job]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job].=",".$row[csf('subcon_job')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job]=$row[csf('subcon_job')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][party_id]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id].=",".$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id].=",".$row[csf('party_id')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id]=$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id]=$row[csf('party_id')];	
		}
	}
	//print_r($sub_con_arr[646]);die;*/
	
	if($db_type==0) 
	{
	$from_date=change_date_format($from_date,'yyyy-mm-dd'); $to_date=change_date_format($to_date,'yyyy-mm-dd');
	}
    if($db_type==2) 
	{
	$from_date=change_date_format($from_date,'','',1);  $to_date=change_date_format($to_date,'','',1);
	}
	//echo $from_date;
	
	
	$batch_description_arr=array();
	/* 
	if(str_replace("'","",$batch_id)!="") $batch_cond=" and b.id in(".str_replace("'","",$batch_id).")";
    else  */
	
	
	//echo $batch_cond; //die;
	//echo $batch_no; //die;
    	//echo $batch_no;
	$batch_no=implode("','",array_unique(explode(",",$batch_no)));
	
	if(str_replace("'","",$batch_no)!="") $batch_cond=" and b.batch_no in('".$batch_no."') "; 
	else $batch_cond="";
	//echo $batch_cond."shakil"; die;
	
	//
	/* and b.re_dyeing_from=0 13-11-16 according to siddique sir dicission when search buyer order or subcontract all batch appear */
	if($batch_type==0)
	$search_field_cond_batch="and b.entry_form in (0,36) and b.re_dyeing_from=0";
	else if($batch_type==1)
	$search_field_cond_batch="and b.entry_form=0 ";
	else if($batch_type==2)
	$search_field_cond_batch="and b.entry_form=36";
	else 
	$search_field_cond_batch="and b.entry_form in(0,36) and b.batch_against in(2) and  b.re_dyeing_from!=0 ";
	//$redyeing="and b.batch_against in(2)";
	//echo  $search_field_cond_batch;die;
	//$po_number_arr=return_library_array(" select  id ,po_number from   wo_po_break_down", "id", "po_number" );
	$con = connect();
	 execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id." and ref_from in (1,2,3) and ENTRY_FORM=48");
	 oci_commit($con);
	 disconnect($con);

	$sql_po=("select a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b  where a.id=b.job_id and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond");
	 
	$res_po=sql_select($sql_po);
	$all_po_id='';
	foreach($res_po as $row) //$job_no_arr
	{
		$po_number_arr[$row[csf('id')]]['po_no']=$row[csf('po_number')];
		$po_number_arr[$row[csf('id')]]['ref_no']=$row[csf('ref_no')];
		$po_number_arr[$row[csf('id')]]['file_no']=$row[csf('file_no')]; 
		$po_number_arr[$row[csf('id')]]['season']=$row[csf('season_buyer_wise')]; 
		$po_number_arr[$row[csf('id')]]['job']=$row[csf('job_no_mst')];
		$job_no_arr[$row[csf('id')]]=$row[csf('job_no_mst')];
		$style_library[$row[csf('job_no_mst')]]=$row[csf('style_ref_no')];
		if($all_po_id=="") $all_po_id=$row[csf('id')]; else $all_po_id.=",".$row[csf('id')]; //echo $all_po_id;
		$poIdArr[$row[csf('id')]]=$row[csf('id')];
	}
	//echo $all_po_id;
	if($txt_file_no!='' || $txt_ref_no!='' ||  $txt_po_no!='' || $txt_job!='' || $cbo_buyer_name>0)
	{
		if($all_po_id!="") $po_idd="and po_id in($all_po_id)";else $po_idd="and po_id in(0)";
		//echo $po_idd;
		//echo "select LISTAGG(CAST( mst_id  AS VARCHAR(4000)), ',') WITHIN GROUP (ORDER BY mst_id) as batch_id from pro_batch_create_dtls where status_active=1 and is_deleted=0 $po_idd";
		/*if($db_type==0) $group_con="group_concat(mst_id) as batch_id";
		else  $group_con="LISTAGG(CAST( mst_id  AS VARCHAR(4000)), ',') WITHIN GROUP (ORDER BY mst_id) as batch_id";
		$batch_ids=return_field_value("$group_con","pro_batch_create_dtls","status_active=1 and is_deleted=0 $po_idd","batch_id");
		if($batch_ids!="") $batch_id_cond="and b.id in($batch_ids)"; else $batch_id_cond="";	*/	
		$poIds=chop($all_po_id,','); $po_cond_for_in="";
		$po_ids=count(array_unique(explode(",",$all_po_id)));
		if($db_type==2 && $po_ids>1000)
		{
			$po_cond_for_in=" and (";
			$poIdsArr=array_chunk(explode(",",$poIds),999);
			foreach($poIdsArr as $ids)
			{
				$ids=implode(",",$ids);
				$po_cond_for_in.=" po_id in($ids) or"; 
			}
			$po_cond_for_in=chop($po_cond_for_in,'or ');
			$po_cond_for_in.=")";
		}
		else
		{
			$po_cond_for_in=" and po_id in($poIds)";
			
		}
		fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 1, $poIdArr, $empty_arr);//PO ID Ref from=1
		
		//echo "select mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in";die;
		//$sql_batch=sql_select("select mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in");
		$sql_batch=sql_select("SELECT b.mst_id as batch_id from pro_batch_create_dtls b,gbl_temp_engine g  where   b.po_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=1 and g.entry_form=48  and b.status_active=1 and b.is_deleted=0  ");
		 $all_batch_id='';
		foreach($sql_batch as $row) 
		{
			if($all_batch_id=="") $all_batch_id=$row[csf('batch_id')]; else $all_batch_id.=",".$row[csf('batch_id')];
		}
			$all_batch_ids=implode(",",array_unique(explode(",",$all_batch_id)));
		//echo $all_batch_ids; 
		$batch_ids_cond="";
		if($all_batch_ids!="") 
		{
			//echo $po_id=substr($po_id,0,-1);
			if($db_type==0) { $batch_ids_cond="and b.id in(".$all_batch_ids.")"; }
			else
			{
				$bat_id=array_unique(explode(",",$all_batch_ids));
				if(count($bat_id)>1000)
				{
					$batch_ids_cond="and (";
					$bat_id=array_chunk($bat_id,1000);
					$z=0;
					foreach($bat_id as $id)
					{
						$id=implode(",",$id);
						if($z==0) $batch_ids_cond.=" b.id in(".$id.")";
						else $batch_ids_cond.=" or b.id in(".$id.")";
						$z++;
					}
					$batch_ids_cond.=")";
				}
				else { 
				
				$batch_ids_cond=" and b.id in(".$all_batch_ids.")"; }
			}
		}
	}
	//print_r($batch_ids);die;
	if($from_date!="" && $to_date!="")
	{
		$date_cond_samp="";
		if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond_samp=" and b.batch_date between '".$from_date."' and '".$to_date."'";
		}
	}
	$samp_non_booking=sql_select("select b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no_id=a.id and a.booking_type=4  $company_idcond $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

	//echo "select b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.buyer_name from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";die;
	$all_batch_id_samp="";
	foreach($samp_non_booking as $row)
	{
		$non_buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$non_buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$sample_booking_ref_no_arr[$row[csf('booking_no')]]=$row[csf('grouping')];
		if($txt_samp_ref_no!='')
		{
		if($all_batch_id_samp=="") $all_batch_id_samp=$row[csf('batch_id')]; else $all_batch_id_samp.=",".$row[csf('batch_id')];
		}
	}
	if($all_batch_id_samp!="") $all_batch_id_samp_cond="and b.id in($all_batch_id_samp)";else $all_batch_id_samp_cond="";
	//echo $all_batch_id_samp_cond.'X';
	
    if($from_date!="")
    {
		if(str_replace("'","",$cbo_value_with)==1)
		{
			$date_cond=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";

			$sql=sql_select("select b.id,a.batch_no,a.fabric_type,b.booking_without_order,b.extention_no,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id and b.batch_against in(1) and
			and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
			//echo"select b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from  from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";die;
		}
		else if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond=" and b.batch_date between '".$from_date."' and '".$to_date."'";
			$sql=sql_select("select b.id,b.batch_no,b.booking_without_order,b.extention_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
			from  pro_batch_create_mst b where   b.status_active=1 and b.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
			
		}
   	}
   	else
   	{
		$sql=sql_select("select b.id,b.booking_without_order,b.extention_no,b.batch_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
		from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0 $company_idcond $batch_cond $batch_ids_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
	//	echo "select b.id,b.booking_without_order,b.batch_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
		//from  pro_batch_create_mst b where b.batch_against in(1,3) and b.status_active=1 and b.is_deleted=0 $company_idcond $batch_cond $batch_ids_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";
   	}
	/*echo "select b.id,b.booking_without_order,b.batch_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
	from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0 $company_idcond $batch_cond $batch_ids_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";die;*/
  	//echo $sql;die;
  	$reding_batch_id=$non_reding_batch_id=array();
    foreach($sql as $row)
	{
		$batch_against_id=$row[csf("batch_against")];
		if($batch_against_id==1 || $batch_against_id==3)
		{
			
			 
			$batch_id_arr[]=$row[csf("id")]; 
			$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
			$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
			$batch_description_arr[$row[csf("id")]]['batch_weight']=$row[csf("batch_weight")];
			$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
			$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
			$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
			$batch_no_arr[]="'".$row[csf("batch_no")]."'";
			$batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
			
			$batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			$batch_wise_arr[$row[csf("batch_no")]]['batch_no']=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['extention_no'].=$row[csf("extention_no")].',';
		}
		if($batch_against_id==2)
		{
			$batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			$batch_wise_arr[$row[csf("batch_no")]]['batch_no']=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['extention_no'].=$row[csf("extention_no")].',';
			
			$re_batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			
		}
		if($row[csf("batch_against")]==2)
			{
				/*if($row[csf("re_dyeing_from")]>0)
				{
					$reding_batch_id[$row[csf("re_dyeing_from")]]=$row[csf("re_dyeing_from")]; 
				}
				else
				{
					$reding_batch_id[$row[csf("id")]]=$row[csf("id")]; 
				}*/
				$reding_batch_id[$row[csf("id")]]=$row[csf("id")];
			}
			else
			{
				$non_reding_batch_id[$row[csf("id")]]=$row[csf("id")];
			}
	}
	 
	//print_r($reding_batch_id); 

	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 2, $batch_id_arr, $empty_arr);//Batch ID Ref from=2
	 
	$date_cond2=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";
	$fabric_sql=sql_select("select b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
	from pro_fab_subprocess  a,pro_batch_create_mst b,gbl_temp_engine g  where  a.batch_id=b.id  and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48  
	and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 $company_idcond");
 	
  	$fabric_type_arr=array();
    foreach($fabric_sql as $row)
	{
	 	$fabric_type_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
	}

	$floor_arr=return_library_array("SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b,gbl_temp_engine g  where a.floor_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0 ", "batch_id", "floor_name" );

	$machine_name_arr=return_library_array("SELECT  a.batch_id ,b.machine_no from   pro_fab_subprocess a, lib_machine_name b,gbl_temp_engine g  where a.machine_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and a.entry_form in(38,35) and  b.status_active=1 and b.is_deleted=0  ", "batch_id", "machine_no" );

	/* echo "<pre>";
	print_r($reding_batch_id);
	echo "<pre>";
	print_r($non_reding_batch_id);die;*/
	//	***************************************************************************************************************************************************
     $batch_id_sql=implode(",",$batch_id_arr);
    if($batch_id_sql=="") $batch_id_sql=0;
	//echo  $batch_id_sql;
  	if($batch_type==3)
	{
		//$re_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond2=chop($re_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond2.=")";
		}
	}
	else
	{
		//$re_dying_cond=" and b.re_dyeing_from in(".$batch_id_sql.")";	
		//$pord_ids = explode(",",$txt_product_id);
		//echo count($pord_ids);die;
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond=chop($re_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond.=")";
		}
	}
	if($db_type==0)
	{
		if($batch_type==3)
		{
		 $sql_redying=sql_select("select b.id as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0 group by  b.id");
		}
		else
		{
			 $sql_redying=sql_select("select group_concat(b.id) as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0  $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0 group by  b.re_dyeing_from");	
		}
	}
	else
	{
	
		if($batch_type==3)
		{	
			//  $sql_redying=sql_select("select b.id as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no
			//   from  pro_batch_create_mst  b 
			//   where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0  group by  b.id");
				$sql_redying=sql_select("SELECT b.id as id, b.batch_date) as batch_date, b.extention_no as extention_no
				from  pro_batch_create_mst  b ,gbl_temp_engine g
				where  b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and b.re_dyeing_from!=0 $company_idcond  and b.status_active=1 and b.is_deleted=0  ");
		}
		else
		{
			//  $sql_redying=sql_select("select listagg((b.id),',') within group (order by b.id) as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no,b.re_dyeing_from 
			//  from  pro_batch_create_mst b 
			//  where b.re_dyeing_from!=0   $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0  group by  b.re_dyeing_from");
			$sql_redying=sql_select("SELECT  b.id as id, b.batch_date as batch_date, b.extention_no as extention_no,b.re_dyeing_from 
			from  pro_batch_create_mst b ,gbl_temp_engine g
			where  b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and b.re_dyeing_from!=0   $company_idcond  and b.status_active=1 and b.is_deleted=0  ");
		}
	}
	
   	//and b.batch_against=2
    $redying_details_arr=array();
    foreach($sql_redying as $re_row)
    {
		if($batch_type==3)
		{
			$redying_details_arr[$re_row[csf("id")]]['id'].=$re_row[csf("id")].",";
			$redying_details_arr[$re_row[csf("id")]]['batch_date'].=$re_row[csf("batch_date")].",";
			$redying_details_arr[$re_row[csf("id")]]['extention_no'].=$re_row[csf("extention_no")].",";
		}
		else
		{
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['id'].=$re_row[csf("id")].",";
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['batch_date'].=$re_row[csf("batch_date")].",";
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['extention_no'].=$re_row[csf("extention_no")].",";
		}
    }
	
	//echo "<pre>"; print_r($redying_details_arr);die;
	if($batch_type==3)
	{
		//$all_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$all_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$all_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$all_dying_cond2=chop($all_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$all_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$all_dying_cond2.=")";
		}
	}
	else
	{
		if(count($batch_id_arr)>0)
		{
			$all_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$all_dying_cond.=" b.id in(".implode(",",$batch_id).") or";
				}
				$all_dying_cond=chop($all_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$all_dying_cond.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$all_dying_cond.=")";
		}
	}
	
	if($batch_type==3)
	{
		$result_sql=sql_select("select a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b,gbl_temp_engine g where b.id=a.batch_id and a.batch_id=g.ref_val and b.id=g.ref_val and g.ref_from=2 and g.entry_form=48  and a.entry_form in (35,38) and a.load_unload_id=2   $company_idcond  and a.status_active=1 and a.is_deleted=0");	
	}
	else
	{
		$result_sql=sql_select("select a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b w,gbl_temp_engine g where b.id=a.batch_id and a.batch_id=g.ref_val and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48  and a.entry_form in (35,38) and a.load_unload_id=2  $company_idcond  and a.status_active=1 and a.is_deleted=0");
	}
	
	/*$sql_result=sql_select("select a.result,a.batch_id from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2  and a.company_id=$cbo_company_name and b.re_dyeing_from in (".$batch_id_sql.") and a.status_active=1 and a.is_deleted=0");*/
	
	$result_arr=array();
	foreach($result_sql as $value)
	{
		$result_arr[$value[csf('batch_id')]]=$value[csf('result')];	
	}
	
    $sql_dyes_cost =sql_select("select a.batch_no,b.item_category,(b.cons_amount) as dyes_chemical_cost
    from inv_issue_master a, inv_transaction b
    where a.id=b.mst_id and b.transaction_type=2 and a.entry_form=5 and a.batch_no  is not null  and   b.item_category in (5,6,7) "); 
	$dyes_chemical_arr=array();

	if(!empty($location_id))
	{

	}
	foreach($sql_dyes_cost as $val)
	{
		$dyes_chemical_arr[$val[csf("batch_no")]][$val[csf("item_category")]]['chemical_cost']+=$val[csf("dyes_chemical_cost")];
	}
	 
	//**************************************************************************************************
	if($db_type==0)
	{
		$sql_dtls =sql_select("select batch_no from inv_issue_master  where  entry_form=5 and status_active=1 and is_deleted=0 and batch_no<>''");
	}
	else
	{
		$sql_dtls =sql_select("select batch_no from inv_issue_master  where  entry_form=5 and status_active=1 and is_deleted=0 and batch_no is not null");
	}
	
	//echo "select batch_no from inv_issue_master  where  entry_form=5 and status_active=1 and is_deleted=0 and batch_no is not null"; die;

	$multi_single_batch=array(); $issue_single_batch_arr=array();
	foreach($sql_dtls as $inf)
	{
		if(strpos($inf[csf("batch_no")], ",")==true)
		{
			//echo "=";
			$multi_batch_id=explode(",",$inf[csf("batch_no")]);
			$total_batch_id=count($multi_batch_id);
			$batch_match=0;
			foreach($multi_batch_id as $m_batch)
			{ 
				if(in_array($m_batch,$batch_id_arr)) 
				{
					$issue_multi_batch_temp_arr[]=$m_batch;  $batch_match+=1;  
					$for_batch_cond_arr[$m_batch]=$m_batch;
				}
				//$issue_single_batch_arr[$m_batch]=$m_batch;
			}
			if($batch_match==$total_batch_id) 
			{
				//echo "+";
				$issue_multi_batch_arr[]=$inf[csf("batch_no")]; 
				$multi_single_batch=array_merge($multi_single_batch, $issue_multi_batch_temp_arr); 
			}
		}
		else
		{
			//echo "||";
			if(in_array($inf[csf("batch_no")],$batch_id_arr)) 
			{ 
				$issue_single_batch_arr[$inf[csf("batch_no")]]=$inf[csf("batch_no")]; 
				$for_batch_cond_arr[$inf[csf("batch_no")]]=$inf[csf("batch_no")]; 
			} 
		}
	}
	//print_r($multi_single_batch); echo "Test";die;

	$for_batch_cond_arr = array_filter($for_batch_cond_arr);
	$for_batch_cond_arr_cond="";
	$bCond="";
	if($db_type==2 && count($for_batch_cond_arr)>999)
	{
		$for_batch_cond_arr_chunk=array_chunk($for_batch_cond_arr,999) ;
		foreach($for_batch_cond_arr_chunk as $chunk_arr)
		{
			$chunk_arr_value=implode(",",$chunk_arr);
			$bCond.=" a.mst_id in($chunk_arr_value) or ";
		}

		$for_batch_cond_arr_cond.=" and (".chop($bCond,'or ').")";
	}
	else
	{
		$for_batch_cond_arr_cond=" and a.mst_id in (".implode(",",$for_batch_cond_arr).")";
	}

	$po_data_subcon=sql_select("select a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	subcon_ord_mst c,gbl_temp_engine g where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.mst_id=g.ref_val   and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0  ");
	
	$sub_con_arr=array();
	foreach($po_data_subcon as $row)
	{
		if($sub_con_arr[$row[csf('mst_id')]][cust_style_ref]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref].=",".$row[csf('cust_style_ref')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref]=$row[csf('cust_style_ref')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][order_no]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no].=",".$row[csf('order_no')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no]=$row[csf('order_no')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][subcon_job]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job].=",".$row[csf('subcon_job')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job]=$row[csf('subcon_job')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][party_id]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id].=",".$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id].=",".$row[csf('party_id')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id]=$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id]=$row[csf('party_id')];	
		}
	}
	//print_r($sub_con_arr[646]);die;

	$con = connect();
	execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id." and ref_from in (1,2,3,4) and ENTRY_FORM=48");
	oci_commit($con);
	disconnect($con);

	$i=1;$j=1;
	ob_start();	
	?>
	<div id="" align="center" style="height:auto; width:auto; margin:0 auto; padding:0;">
		<? $summaryHTML='<div id="summary_part" style="width:1460px;">
        <table width="2060px" cellpadding="0" cellspacing="0" id="caption" align="center">
            <thead>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:16px; font-weight:bold" >'.$report_title.'</td 
                ></tr>
                <tr style="border:none;">
                    <td colspan="24" class="form_caption" align="center" style="border:none; font-size:14px;">
                       <b>Company Name : '.$companyArr[$cbo_company_name].'</b>                               
                    </td>
                </tr>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:12px; font-weight:bold">
					'."Date: ". change_date_format($from_date).' To '. change_date_format($to_date).'
					</td>
                </tr>
            </thead>
        </table>
 		
        <div  align="left" style="font-size:25px">Summary Part</div>
        <table align="left" width="1440" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>

                    <th rowspan="2" width="100">Buyer</th>

                    <th rowspan="2" width="100">Batch Qty (Kg)</th>
                    <th colspan="4" width="">First Dying And Finishing Cost</th>
                    <th colspan="7" width="">Subsequent Dyeing and Finishing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per Kg Cost (Tk)</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>

                    <th width="100">Ttl Chem Cost(Tk)</th>
                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100"><p>Re-Dye Cost per kg (Tk)</th>
                </tr> 
            </thead>
        </table>
        <div style="width:1460px; max-height:400px;  overflow-y:scroll" id="scroll_body_summary">
	        <table align="left" width="1440" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="summary_table_body_id" >
	            <tbody>';
			       	
			       	$tot_main_batch_weight=0;
			       	foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
							if($batch_description_arr[$b_id][entry_form]==36)
			                {
			                	$buyerName=implode(", ",array_unique(explode(",",$sub_con_id_arr[$b_id][party_id])));
			                }
			                else
			                {
				                if($batch_description_arr[$b_id]["without_order"]==1) 
				                $buyerName=$non_buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
				                else $buyerName=$buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
			                }
			                $buyer_wise_summary_arr[$buyerName]["buyer"]=$buyerName;
			                $buyer_wise_summary_arr[$buyerName]["batch_qty"]+=$batch_description_arr[$b_id]["batch_weight"];
							$re_b_id=rtrim($re_batch_wise_arr[$batch_arr[$b_id]]['batch_id'],',');
							$re_b_idArr=array_unique(explode(",",$re_b_id));
							
		
			                $first_chemi_cost=$first_dyeing_cost=0;
			                if($non_reding_batch_id[$b_id]!="")
			                {
			                    $first_chemi_cost=$dyes_chemical_arr[$b_id][5]["chemical_cost"]+$dyes_chemical_arr[$b_id][7]["chemical_cost"];
			                    $buyer_wise_summary_arr[$buyerName]["first_chemi_cost"]+=$first_chemi_cost;

			                    $first_dyeing_cost=$dyes_chemical_arr[$b_id][6]["chemical_cost"];
			                    $buyer_wise_summary_arr[$buyerName]["first_dyeing_cost"]+=$first_dyeing_cost;
								$tot_main_batch_weight=$tot_main_batch_weight+=$batch_description_arr[$b_id]["batch_weight"];
								$buyer_wise_summary_arr[$buyerName]["tot_main_batch_weight"]+=$tot_main_batch_weight;
			                }
			                $buyer_wise_summary_arr[$buyerName]["cost_per_kg"]+=($first_chemi_cost+$first_dyeing_cost)/$batch_description_arr[$b_id]["batch_weight"];

			                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
			                //if($reding_batch_id[$b_id]!="")
							foreach($re_b_idArr as $re_b_id)
			                {
			                    $re_dying_chemical_cost=$dyes_chemical_arr[$re_b_id][5]["chemical_cost"]+$dyes_chemical_arr[$re_b_id][7]["chemical_cost"];
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_chemical_cost"]+=$re_dying_chemical_cost;

			                    $re_dying_dyes_cost=$dyes_chemical_arr[$re_b_id][6]["chemical_cost"];	
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_dyes_cost"]+=$re_dying_dyes_cost;

			                    $re_dying_dyes_chemical_cost=$dyes_chemical_arr[$re_b_id][5]["chemical_cost"]+$dyes_chemical_arr[$re_b_id][6]["chemical_cost"]+$dyes_chemical_arr[$re_b_id][7]["chemical_cost"];
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_dyes_chemical_cost"]+=$re_dying_dyes_chemical_cost;
			                }
			                $buyer_wise_summary_arr[$buyerName]["re_dye_cost_per_kg"]+=$re_dying_dyes_chemical_cost/$batch_description_arr[$re_b_id]["batch_weight"];

			                $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
			                $buyer_wise_summary_arr[$buyerName]["total_per_kg_cost"]+=($re_dying_dyes_chemical_cost+$batch_chemical_price)/$batch_description_arr[$re_b_id]["batch_weight"];

			                //$buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price)/$buyer["batch_qty"]
						}	
					}

				    // echo "<pre>";print_r($buyer_wise_summary_arr);die;
					foreach($buyer_wise_summary_arr as $buyer_id=>$buyer)
					{
						if($j%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
						
			            $summaryHTML.='<tr bgcolor="'.$bgcolor.'">
			                <td width="30">'.$j.'</td>

				            <td width="100"><p>'.$buyer_library[$buyer_id].'</p></td>

			                <td width="100" align="right" align="right"><p>'.number_format($buyer["batch_qty"],4,".","").'</p></td>


			                <td width="100" align="right"><p>'.number_format($buyer["first_chemi_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.number_format($buyer["first_dyeing_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>';
			                $summary_batch_chemical_price=$buyer["first_chemi_cost"]+$buyer["first_dyeing_cost"];
			                $summaryHTML.=number_format($summary_batch_chemical_price,4,".","").'</p></td>
			                <td width="100" align="right"><p>
			                '.number_format($buyer["cost_per_kg"],4,".","").' 
			                </p></td>


			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_chemical_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_dyes_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_dyes_chemical_cost"],4,".","").'</p></td>
			                <td width="100" align="right" title="Total Chemical And Dyes/BatchWeight">'.number_format($buyer["re_dye_cost_per_kg"],4,".","").'</td>


			                <td width="100" align="right">'.number_format($buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price,4,".","").'</td>
			                <td width="100" align="right" title="'."(".$buyer["re_dying_dyes_chemical_cost"]."+".$summary_batch_chemical_price.")/".$buyer["batch_qty"].'">
			                '.number_format(($buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price)/$buyer["batch_qty"],4,".","").'
			                </td>
			            </tr>';
						$summary_total_batch_weight+=$buyer["batch_qty"];
						$summary_total_chemical_cost+=$buyer["first_chemi_cost"];
						$summary_total_dyes_cost+=$buyer["first_dyeing_cost"];
						$summary_total_batch_chemical_price+=$summary_batch_chemical_price;
						$summary_tot_total_receive+=$totalReceive;
						$summary_tot_re_dying_chemical_cost+=$buyer["re_dying_chemical_cost"];
						$summary_tot_re_dying_dyes_cost+=$buyer["re_dying_dyes_cost"];
						$summary_tot_re_dying_dyes_chemical_cost+=$buyer["re_dying_dyes_chemical_cost"];
						$summary_cost_per_kg+=$buyer["cost_per_kg"];
						$summary_total_per_kg_cost+=($buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price)/$buyer["batch_qty"];
						$j++;
					}
					?>
	            <? $summaryHTML.='</tbody>
	      	</table>
      	</div>
       	<table align="left" width="1440" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="summary_table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="100" align="right">&nbsp;Total</th>
                    <th width="100" id="value_total_batch_weight_summary">'.number_format($summary_total_batch_weight,4).'</th>

                	<th width="100" align="right" id="value_total_chemical_cost_summary">'.number_format($summary_total_chemical_cost,4).'</th>
                	<th width="100" align="right" id="value_total_dyeing_cost_summary">'.number_format($summary_total_dyes_cost,4).'</th>
                    <th width="100" align="right" id="value_total_chemical_price_summary">'.number_format($summary_total_batch_chemical_price,4).'</th>
                    <th width="100" align="right" id="value_total_cost_per_kg_summary">'.number_format($summary_cost_per_kg,4).'</th>

                    <th width="100" align="right" id="value_total_redying_chemic_oost_summary">'.number_format($summary_tot_re_dying_chemical_cost,4).'</th>
                    <th width="100" align="right" id="value_total_redying_dying_cost_summary"><p>'.number_format($summary_tot_re_dying_dyes_cost,4).'</p></th>
                    <th width="100" align="right" id="value_total_redying_all_cost_summary"><p>'.number_format($summary_tot_re_dying_dyes_chemical_cost,4).'</p></th>
                    <th width="100" align="right" id="value_total_redying_all_cost_summary_tk">'.number_format($summary_tot_re_dying_dyes_chemical_cost/$summary_total_batch_weight,4).'</th>
                    
                    <th width="100" align="right" id="value_total_total_cost_summary">'.number_format($summary_total_batch_chemical_price+$summary_tot_re_dying_dyes_chemical_cost,4).'</th>
                    <th width="100" align="right" id="value_total_total_per_kg_cost_summary" title="Main Batch Qty='.number_format($buyer["tot_main_batch_weight"],2).'">'.number_format($summary_total_per_kg_cost,4).'</th>
                </tr>
            </tfoot>
        </table>
    	</div>';?>
    <? echo $summaryHTML;?>

 	<div>
        <div  align="left" style="font-size:25px">Single Batch</div>
        <table width="3030" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>
                    <th rowspan="2" width="80">Date</th>
                    <th rowspan="2" width="100">Machine No</th>
                    <th rowspan="2" width="100">Batch No</th>
                    <th rowspan="2" width="80">File No</th>
                    <th rowspan="2" width="80">Ref. No</th>
                    <th rowspan="2" width="100">Floor Name</th>
                    <th rowspan="2" width="100">Buyer</th>
                    <th rowspan="2" width="100">Booking No</th>
                    <th rowspan="2" width="100">Job no</th>
                    <th rowspan="2" width="80">Season</th>                  
                    <th rowspan="2" width="">Style</th>
                    <th rowspan="2" width="100">Order No</th>
                    <th rowspan="2" width="100">Color Name</th>
                    <th rowspan="2" width="100">Color Range</th>
                    <th rowspan="2" width="100">Fabric Type </th>
                    <th rowspan="2" width="100">Batch Qty (Kg)</th>
                    <th colspan="4"  width="">First Dying And Finishing Cost</th>
                    <th colspan="7" width="">Subsequent Dyeing and Finishing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per Kg Cost (Tk)</th>
                    <th rowspan="2" width="100">Result</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>
                    <th width="100">Extention Batch Date</th>
                    <th width="70">Extention No</th>
                    <th width="100">Floor Name</th>
                    <th width="100">Ttl Chem Cost(Tk)</th>
                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100"><p>Re-Dye Cost per kg (Tk)</th>
                </tr> 
            </thead>
        </table>
        <div style="width:3050px; max-height:400px;  overflow-y:scroll" id="scroll_body">
	        <table width="3030" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_id" >
	            <tbody>
			       	<?
				    //echo "<pre>";
					//print_r($issue_single_batch_arr);die;
					$tot_main_batch_weight=0;
					foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
						
							if($i%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
							$all_po_id=explode(",",$po_break_down_id_arr[$batch_description_arr[$b_id]['booking_no']]);
							$po_number_data="";
							$job_no_data="";$file_no="";$ref_no="";
							foreach($all_po_id as $p_id) // $po_number_arr[$row[csf('id')]]['po_no']
							{
								if($po_number_data!="") $po_number_data.=",".$po_number_arr[$p_id]['po_no'];	 else $po_number_data=$po_number_arr[$p_id]['po_no'];
								if($job_no_data!="") $job_no_data.=",".$po_number_arr[$p_id]['job'];	 else $job_no_data=$po_number_arr[$p_id]['job'];
								if($season_data!="") $season_data.=",".$season_name_arr[$po_number_arr[$p_id]['season']];	 else $season_data=$season_name_arr[$po_number_arr[$p_id]['season']];
								if($file_no!="") $file_no.=",".$po_number_arr[$p_id]['file_no'];	 else $file_no=$po_number_arr[$p_id]['file_no'];
								if($ref_no!="") $ref_no.=",".$po_number_arr[$p_id]['ref_no'];	 else $ref_no=$po_number_arr[$p_id]['ref_no'];
							} 
							$color_range_id=$batch_description_arr[$b_id]['color_range'];
							$file_cond=implode(", ",array_unique(explode(",",$file_no)));
							$ref_cond=implode(", ",array_unique(explode(",",$ref_no)));
							if($batch_description_arr[$b_id]['without_order']==1 && $ref_cond=="")
							{
							$ref_cond=$sample_booking_ref_no_arr[$batch_description_arr[$b_id]['booking_no']];
							}
							
							$re_b_id=rtrim($re_batch_wise_arr[$batch_arr[$b_id]]['batch_id'],',');
							$re_b_idArr=array_unique(explode(",",$re_b_id));
							//echo $re_b_id.'======';
							$re_b_ids=implode(",",array_unique(explode(",",$re_b_id)));
							$extention_noData=rtrim($batch_wise_arr[$batch_arr[$b_id]]['extention_no'],',');
							$extention_noArr=array_unique(explode(",",$extention_noData));
							$extention_no=max($extention_noArr);
							if($re_b_ids) $re_b_idsCond.=",".$re_b_ids;else $re_b_idsCond="";
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="30"><? echo $i; ?></td>								
				                <td width="80"><? echo change_date_format($batch_description_arr[$b_id]['batch_date']); ?></td>
				                <td width="100"><p><? echo $machine_name_arr[$b_id]; ?></p></td>                                 
				                <td width="100" title="BatchId=<? echo $b_id;?>"><p><A href="##"  onClick="subprocess_fabric_dtls('<? echo $b_id; ?>','<? echo $batch_arr[$b_id]; ?>','batch_wise_subprocess_fabrics_dtls_popup')"><p><? echo $batch_arr[$b_id]; ?></p></A><? //echo $batch_arr[$b_id]; ?></p></td>
				                <td width="80"><p><? echo $file_cond; ?></p></td>
				                <td width="80" title="PO/Sample Ref no"><p><? echo $ref_cond; ?></p></td>
				                <td width="100"><p><? echo $floor_arr[$b_id]; ?></p></td> 
				                <?
				                if($batch_description_arr[$b_id][entry_form]==36)
				                {
					                ?>
					                <td width="100"><p><? echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][party_id]))); ?></p></td> 
					                <td width="100"><p><? // echo $b_id; ?></p></td>
					                <td width="100" align="center"><p>
					                <? 
				                     echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                 <td width="80" align="center"><p>
					                <? 
				                     //echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                <td width="100" align="center"><p> <? echo   implode(",",array_unique(explode(",",$sub_con_arr[$b_id][cust_style_ref]))); ?></p></td>
					                <td width="100" align="center"><p> <? echo implode(",",array_unique(explode(",",$sub_con_arr[$b_id][order_no]))); ?></p></td>
				                	<?
				                }
				                else
				                {
					                ?>
					                <td width="100"><p><? 
					                if($batch_description_arr[$b_id]['without_order']==1) $buyerName=$non_buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];else $buyerName=$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
					                <td width="100"><p><? echo $batch_description_arr[$b_id]['booking_no']; ?></p></td>
					                <td width="100" align="center"><div style="word-break:break-all">
					                <?
					                echo implode(", ",array_unique(explode(",",$job_no_data)));
					                ?></div></td>
					                <td width="80" align="center"><div style="word-break:break-all">
					                <? 
					                
					                echo implode(", ",array_unique(explode(",",$season_data)));

					                ?></div></td>
					                <td width="" align="center"><div style="word-break:break-all"> 
					                <? 
					                $style_no=array();
					                foreach(array_unique(explode(",",$job_no_data)) as $j_no)
					                {
					                    if($style_no!="")  $style_no[]=$style_library[$j_no];
					                }
					                echo implode(", ",array_unique($style_no)); ?></div></td>
					                <td width="100" align="center"><div style="word-break:break-all"> <? echo implode(", ",array_unique(explode(",",$po_number_data))); ?></div></td>
					                <?	
				                }
				                ?>
				                <td width="100" align="center"><div style="word-break:break-all"><? echo $color_arr[$batch_description_arr[$b_id]['color_id']]; ?></div></td> 
				                <td width="100" align="center"><p><? echo $color_range[$color_range_id]; ?></p></td> 
				                <td width="100" align="center"><p><? echo $fabric_type_for_dyeing[$fabric_type_arr[$b_id]['fabric_type']]; //$fabric_type_for_dyeing?></p></td> 
				                <td width="100" align="right"><p>
				                <? echo $batch_description_arr[$b_id]['batch_weight']; $total_batch_weight+=$batch_description_arr[$b_id]['batch_weight'] ;?>
				                </p></td> 
				                <?
				                
				                $first_chemi_cost=$first_dyeing_cost=0;
				                if($non_reding_batch_id[$b_id]!="")
				                {
				                    $first_chemi_cost=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                    $first_dyeing_cost=$dyes_chemical_arr[$b_id][6]['chemical_cost'];
									$tot_main_batch_weight+=$batch_description_arr[$b_id]['batch_weight'];
				                }
				                
				                ?>
				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($first_chemi_cost,4,".",""); 
				                 $total_chemical_cost+=$first_chemi_cost;
				                 ?>
				                </p></td>
				                <td width="100" align="right"><p>
				                <?  
				                    echo number_format($first_dyeing_cost,4,".",""); 
				                    $total_dyes_cost+=$first_dyeing_cost; 
				                ?>
				                </p></td>
				                <td width="100" align="right"><p><A href="##"  onClick="fn_1st_batch('<? echo $b_id; ?>','1st_batch_dtls_popup')">
				                <?
				                 $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
				                  echo number_format($batch_chemical_price,4,".","");
				                  $total_batch_chemical_price+=$batch_chemical_price;
				                ?>
				                </A></p></td>
				                <td width="100" align="right"><p><? echo number_format($batch_chemical_price/$batch_description_arr[$b_id]['batch_weight'],4,".",""); $tot_total_receive+=$totalReceive; ?></p></td>
				                <td width="100" align="right"><p>
				                <? 
				                $extension_no="";
				                $re_batch_date="";
				                $batch_date=explode(",", $redying_details_arr[$b_id]['batch_date']);	
				                foreach($batch_date as $ash_date)
				                {
				                 if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                }
				                echo $re_batch_date;
				                 ?></p></td>
				                <td width="70" align="right"><p>
				                <?		                
				                //echo $redying_details_arr[$b_id]['id'].jahid;
								
				                if(trim($redying_details_arr[$b_id]['id']))
				                {
				                    $re_dying_id_all=explode(",",$redying_details_arr[$b_id]['id']);
				                    //$re_dying_chemical_cost=0;
				                    //$re_dying_dyes_cost=0;
				                    //$re_dying_dyes_chemical_cost=0;
				                    
				                    $result_id="";
				                    $result_id_last='';
				                    
				                    foreach($re_dying_id_all as $ash_id)
				                    {
				                    //$re_dying_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                    //$re_dying_dyes_cost+=$dyes_chemical_arr[$ash_id][6]['chemical_cost']	;	
				                    //$re_dying_dyes_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][6]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                        
				                     if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                     //if($re_floor!="") $re_floor.=",".$floor_arr[$ash_id]; else $re_floor=$floor_arr[$ash_id];
				                    /* echo $ash_id.tipu;
				                     $result_id=$result_arr[$ash_id];
				                     if($result_id!="")  $result_id_last=$result_id;*/
				                    }
				                }
				                //echo $b_id;
				                //if($batch_type==3)
				                //{
				                echo $extention_no;	 ?>
				                
				                
				                </p></td>
				                <td width="100" align="right"><p><?
				                $re_floors='';
				                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
				                //print_r($reding_batch_id);//echo $reding_batch_id[$b_id]."##".$b_id;
				               // if($reding_batch_id[$b_id]!="")
							   	foreach($re_b_idArr as $re_bid)
				                {
				                    $re_floors=$floor_arr[$re_bid];
				                    $re_dying_chemical_cost+=$dyes_chemical_arr[$re_bid][5]['chemical_cost']+$dyes_chemical_arr[$re_bid][7]['chemical_cost'];
				                    $re_dying_dyes_cost+=$dyes_chemical_arr[$re_bid][6]['chemical_cost']	;	
				                    $re_dying_dyes_chemical_cost+=$dyes_chemical_arr[$re_bid][5]['chemical_cost']+$dyes_chemical_arr[$re_bid][6]['chemical_cost']+$dyes_chemical_arr[$re_bid][7]['chemical_cost'];
				                }
				                
				                echo $re_floors;
				                ?></p></td>
				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($re_dying_chemical_cost,4,".",""); 
				                 $tot_re_dying_chemical_cost+=$re_dying_chemical_cost;
				                 ?>
				                 </p></td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_dyes_cost,4,".",""); $tot_re_dying_dyes_cost+=$re_dying_dyes_cost;  ?></p></td>
				                <td width="100" align="right"><A href="##"  onClick="fn_total_batch('<? echo $re_b_ids; ?>','total_batch_dtls_popup')"><p><? echo number_format($re_dying_dyes_chemical_cost,4,".",""); $tot_re_dying_dyes_chemical_cost+=$re_dying_dyes_chemical_cost; ?></p></A></td>
				                <td width="100" align="right" title="Total Chemical And Dyes/BatchWeight"><? echo number_format($re_dying_dyes_chemical_cost/$batch_description_arr[$b_id]['batch_weight'],4,".",""); ?></td>
				                

				                <td width="100" align="right"><? echo number_format($re_dying_dyes_chemical_cost+$batch_chemical_price,4,".",""); ?></td>
				                <td width="100" align="right" title="<? echo '('.$re_dying_dyes_chemical_cost.'+'.$batch_chemical_price.')/'.$batch_description_arr[$b_id]['batch_weight']; ?>"><? echo number_format(($re_dying_dyes_chemical_cost+$batch_chemical_price)/$batch_description_arr[$b_id]['batch_weight'],4,".","");  ?></td>
				                <td width="100" align="center" title="<? echo $b_id; ?>"><? //echo $unload_result_arr[$b_id]//echo  $dyeing_result[$result_id];//
				                //echo $b_id.tipu;
			                    $result_id=$result_arr[$b_id];
			                    if($result_id!="")  $result_id_last=$result_id;
				                echo $dyeing_result[$result_id];//$dyeing_result;//$daysOnHand; ?></td>
				            </tr>
							<? 												
								 $i++; 			
						}	
					}
					?>
	            </tbody>
	      	</table>
      	</div>
       	<table width="3030" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="80">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                   <th width="80">&nbsp;</th>
                    <th width="">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="100"><? //echo number_format($total_batch_chemical_price,4).'='.$total_dyes_cost; ?></th>
                	<th width="100">Total</th>
                    <th width="100" id="value_total_batch_weight_single"><? echo number_format($total_batch_weight,4); ?></th>
                	<th width="100" id="value_total_chemical_cost_single"><? echo number_format($total_chemical_cost,4); ?></th>
                	<th width="100" id="value_total_dyeing_cost_single"><? echo number_format($total_dyes_cost,4); ?></th>
                    <th width="100" id="value_total_chemical_price_single"><? echo number_format($total_batch_chemical_price,4); ?></th>
                    <th width="100" id="value_total_cost_per_kg"><? echo number_format(($total_batch_chemical_price)/$total_batch_weight,4); ?></th>
                    <th width="100"><? //echo number_format($tot_re_dying_chemical_cost,3); ?></th>
                    <th width="70"><? //echo number_format($tot_rec_return,3); ?></th>
                    <th width="100"><? //echo number_format($tot_total_issue,3); ?></th>
                    <th width="100" id="value_total_redying_chemic_oost_single"><? echo number_format($tot_re_dying_chemical_cost,4); ?></th>
                    <th width="100" id="value_total_redying_dying_cost_single"><p><? echo number_format($tot_re_dying_dyes_cost,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single"><p><? echo number_format($tot_re_dying_dyes_chemical_cost,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single_tk"><? echo number_format($tot_re_dying_dyes_chemical_cost/$total_batch_weight,4); ?></th>
                    <th width="100" id="value_total_total_cost_single"><? echo number_format($total_batch_chemical_price+$tot_re_dying_dyes_chemical_cost,4); ?></th>
                    <th width="100" id="value_total_total_per_kg_cost" title="Main Batch Qty=<? echo number_format($tot_main_batch_weight,2);?>"><? echo number_format(($tot_re_dying_dyes_chemical_cost+$total_batch_chemical_price)/$tot_main_batch_weight,4); ?></th>
                    <th width="100">&nbsp;</th>
                </tr>
            </tfoot>
        </table>
    </div>
      
    <div>
       	<div  align="left" style="font-size:25px">Multiple Batch</div>
       
	        <table width="2970" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
	        	<thead>
	                <tr>
	                    <th rowspan="2" width="40">SL</th>
	                    <th rowspan="2" width="80">Date</th>
	                    <th rowspan="2" width="100">Machine No</th>
	                    <th rowspan="2" width="100">Batch No</th>
	                    <th rowspan="2" width="80">File No</th>
	                    <th rowspan="2" width="80">Ref. No</th>
	                    <th rowspan="2"width="100">Floor Name</th>
	                    <th rowspan="2" width="80">Buyer</th>
	                    <th rowspan="2" width="100">Booking No</th>
	                    <th rowspan="2" width="100">Job no</th>
	                    <th rowspan="2" width="80">Season</th>
	                    <th rowspan="2" width="100">Style</th>
	                    <th rowspan="2" width="100">Order No</th>
	                    <th rowspan="2" width="100">Color Name</th>
	                    <th rowspan="2" width="100">Color Range</th>
	                    <th rowspan="2" width="100">Fabric Type </th>
	                    <th rowspan="2" width="80">Batch Qty (Kg)</th>
	                    <th colspan="4"  width="430">First Dying And Finishing Cost</th>
	                    <th colspan="7" width="660">Subsequent Dyeing and Finishing Cost</th>
	                    <th rowspan="2" width="70">Total Cost (Tk)</th>
	                    <th rowspan="2" width="70">Total Per Kg Cost (Tk)</th>
	                    <th rowspan="2" width="">Result</th>
	                </tr> 
	                <tr>                         
	                    <th width="100">Ttl Chem Cost (Tk)</th>
	                    <th width="110">Ttl Dyes Cost (Tk)</th>
	                    <th width="110">Ttl Chem + Dyes Cost (Tk)</th>
	                    <th width="110">Cost Per Kg(Tk)</th>
	                    <th width="80">Extention Batch Date</th>
	                    <th width="70">Extention No</th>
	                    <th width="100">Floor Name</th>
	                    <th width="100">Ttl Chem Cost(Tk)</th>
	                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
	                    <th width="100">Ttl Chem + Dyes Cost (Tk)</th>
	                    <th width="110">Re-Dye Cost per kg (Tk)</th>
	                </tr> 
	            </thead>
	        </table>
	        <div style="width:2990px; max-height:400px; overflow-y:scroll" id="">
		        <table width="2970" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_multibatch_id">
			       	<?
					$multi_batch_qty_total=0;
					$j=1;
					foreach(array_unique($issue_multi_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
							if($j%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF"; 
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="40"><? echo $j; ?></td>								
				                <td width="80" style="word-break:break-all;">
				                <?
								$multiple_batch_id=explode(",",$b_id);
								$batch_id_all="";
								$muli_batch_floor_name="";$multi_batch_machine='';
								$multi_batch_buyer_name=array();
								$multi_batch_booking_no=array();
								$multi_batch_job_no=array();
								$multi_batch_style_no=array();
								$multi_batch_color=""; $multi_batch_color_range="";
								$mulib_batch_weight=0;
								$re_dying_dyes_multi_batch_cost=0;
								$re_dying_dyes_multi_batch_chemical_cost=0;
								$re_multi_batch_floor="";
								$mult_batch_chemical_cost=0;
								$mult_batch_dyes_cost=0;
								$mult_batch_dyes_chemical_cost=0;
								$multiBatch_extension="";
								$re_floor="";
								$p=0;
								$redying_batch_id=array();
								$po_number_data_all=array();
								$batch_date_arr=array();
								$re_dying_multi_batch_chemical_cost=0;
								$re_dying_multi_batch_dying_cost=0; 
								$re_dying_multi_batch_dyes_chemical_cost=0;
								$remulti_batch_date="";$batch_nos="";
								$new_redying_arr=array();
								$new_redying_arr1=array();
				                foreach($multiple_batch_id as $s_bid)
				                {
				                      
									// echo $s_bid."mahbub";
									    
				                  	//  $batch_button="<a href='##' onClick=\"subprocess_fabric_dtls('".$b_id."','".$batch_id_all."','subprocess_fabrics_dtls_popup')\"> ".$batch_id_all." </a>";
									
							
									  $batch_multi_arr[$s_bid].=$batch_arr[$s_bid].',';
									  $p++;
				                      $batch_date_arr[]=$batch_description_arr[$s_bid]['batch_date'];
				                      if($batch_id_all!="") $batch_id_all.=",".$batch_arr[$s_bid]; else $batch_id_all=$batch_arr[$s_bid];
									  if($batch_nos=="") $batch_nos="<a href='##' onClick=\"subprocess_fabric_dtls('".$s_bid."','".$batch_arr[$s_bid]."','batch_wise_subprocess_fabrics_dtls_popup')\"> ".$batch_arr[$s_bid]." </a>";else $batch_nos.=", "."<a href='##' onClick=\"subprocess_fabric_dtls('".$s_bid."','".$batch_arr[$s_bid]."','batch_wise_subprocess_fabrics_dtls_popup')\"> ".$batch_arr[$s_bid]." </a>";
				                      if($muli_batch_floor_name!="") $muli_batch_floor_name.=",".$floor_arr[$s_bid]; else $muli_batch_floor_name=$floor_arr[$s_bid];
				                      
				                      // for buyer name job style po*************************************************************************************
				                      if($batch_description_arr[$s_bid][entry_form]==36)
				                      {
				                          $multi_batch_buyer_name[]=$sub_con_arr[$s_bid][party_id];
				                          $multi_batch_job_no[]=$sub_con_arr[$s_bid][subcon_job];
				                          $po_number_data_all[]=$sub_con_arr[$s_bid][order_no];
				                          $multi_batch_style_no[]=$sub_con_arr[$s_bid][cust_style_ref];
				                      }
				                      else
				                      {
				                          $all_po_ids=array_unique(explode(",",$po_break_down_id_arr[$batch_description_arr[$s_bid]['booking_no']])); //print_r(array_unique($batch_description_arr[$s_bid]['booking_no']));
				                           $ref_no='';   $file_no=''; $po_no='';$season_data='';
										   //print_r( $all_po_id);
										  foreach($all_po_ids as $p_id)
				                          {
				                            // echo $p_id.'<pre>';
											  $po_number_data_all[]=$po_number_arr[$p_id]['po_no'];
				                              $multi_batch_job_no[]=$job_no_arr[$p_id];
											  if($season_data!="") $season_data.=",".$season_name_arr[$po_number_arr[$p_id]['season']];	 else $season_data=$season_name_arr[$po_number_arr[$p_id]['season']];
											  if( $po_no=='') $po_no=$po_number_arr[$p_id]['po_no'];else $po_no.=",".$po_number_arr[$p_id]['po_no'];
											  if( $ref_no=='') $ref_no=$po_number_arr[$p_id]['ref_no'];else $ref_no.=",".$po_number_arr[$p_id]['ref_no'];
											  if( $file_no=='') $file_no=$po_number_arr[$p_id]['file_no'];else $file_no.=",".$po_number_arr[$p_id]['file_no'];
											 // echo $po_no;
						 					 
				                          }
										  if($batch_description_arr[$s_bid]['without_order']==1)
										  { 
										 	$multi_batch_buyer_name[]=$non_buyer_name_arr[$batch_description_arr[$s_bid]['booking_no']];
										  }
										  else 
										  { 
										    $multi_batch_buyer_name[]=$buyer_name_arr[$batch_description_arr[$s_bid]['booking_no']];
										  }
										  if($batch_description_arr[$s_bid]['without_order']==1 && $ref_no=="")
											{
											$ref_no=$sample_booking_ref_no_arr[$batch_description_arr[$s_bid]['booking_no']];
											}
							
									
				                         
										  
				                          $multi_batch_booking_no[]=$batch_description_arr[$s_bid]['booking_no'];
				                          $style_no=array();
				                          foreach(array_unique($multi_batch_job_no) as $j_no)
				                          {
				                             if($multi_batch_style_no!="")  $multi_batch_style_no[]=$style_library[$j_no];
				                          } 
				                      }
				                      $mulib_batch_weight+=$batch_description_arr[$s_bid]['batch_weight'];
				                      //****************************************** for color **********************************************************
				                      if($multi_batch_color!="") $multi_batch_color.=",".$color_arr[$batch_description_arr[$s_bid]['color_id']];
				                      else $multi_batch_color=$color_arr[$batch_description_arr[$s_bid]['color_id']];
									  
				                      if($multi_batch_color_range!="") $multi_batch_color_range.=",".$color_range[$batch_description_arr[$s_bid]['color_range']];
				                      else $multi_batch_color_range=$color_range[$batch_description_arr[$s_bid]['color_range']];
									  
									  if($multi_batch_machine!="") $multi_batch_machine.=",".$machine_name_arr[$s_bid];
				                      else $multi_batch_machine=$machine_name_arr[$s_bid];
									  
									  
									  //$color_range_id=$color_range[$batch_description_arr[$b_id]['color_range']];
				                      //******************************************** for redyeing **********************************************************
									  //echo $batch_description_arr[$s_bid]['color_range'];
									if($redying_details_arr[$s_bid]['id']!="")
									{
					                      if($multiBatch_extension!="") $multiBatch_extension.="*".$redying_details_arr[$s_bid]['extention_no'];
					                      else $multiBatch_extension=$redying_details_arr[$s_bid]['extention_no'];
					                      $sl=0;
										  
					                      foreach(explode(",",$redying_details_arr[$s_bid]['id']) as $rbs)
					                      {
					                        $new_redying_arr[$sl]=$new_redying_arr[$sl].",".$rbs;
					                        $new_redying_arr1[$sl]=$rbs.",".$new_redying_arr1[$sl];
					                        $sl++; 
					                        
					                        if($re_floor!="") $re_floor.=",".$floor_arr[$rbs];
					                        else $re_floor=$floor_arr[$rbs];
					                      }
					                      // for redyeing batch date *************************************************************************************************
					                      foreach(array_unique(explode(",",$redying_details_arr[$s_bid]['batch_date'])) as $r_date)
					                      {
					                      if($remulti_batch_date!="") $remulti_batch_date.=",".change_date_format($r_date); else $remulti_batch_date=change_date_format($r_date);
					                      }
					                }
									
					                // *****************************************redyeing dyes and chemical cost***************************************
					                 foreach($new_redying_arr as $l_id)
					                 {
					                    /* $re_dying_multi_id_all=ltrim($l_id,",");
					                     $re_dying_multi_batch_chemical_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][5]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][7]['chemical_cost'];
					                     $re_dying_multi_batch_dying_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][6]['chemical_cost'];	
					                     $re_dying_multi_batch_dyes_chemical_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][5]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][6]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][7]['chemical_cost'];*/
					                    
					                 }
					                 foreach($new_redying_arr1 as $l_id)
					                 {
					                     $re_dying_multi_id_all=rtrim($l_id,",");
					                     $re_dying_multi_batch_chemical_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][5]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][7]['chemical_cost'];
					                     $re_dying_multi_batch_dying_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][6]['chemical_cost']	;	
					                     $re_dying_multi_batch_dyes_chemical_cost+=$dyes_chemical_arr[$re_dying_multi_id_all][5]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][6]['chemical_cost']+$dyes_chemical_arr[$re_dying_multi_id_all][7]['chemical_cost'];
					                 }
									/* $re_dying_multi_batch_chemical_cost_total+=$re_dying_multi_batch_chemical_cost;
					                 $re_dying_multi_batch_dying_cost_total+=$re_dying_multi_batch_dying_cost;
					                 $re_dying_multi_batch_dyes_chemical_cost_total+=$re_dying_multi_batch_dyes_chemical_cost;*/
								}
								 
				                // dyes and chemical cost total  ************************************************************************************************
				                 $mult_batch_chemical_cost+=$dyes_chemical_arr[$b_id][5]['chemical_cost']+$dyes_chemical_arr[$b_id][7]['chemical_cost'];
				                 $mult_batch_dyes_cost+=$dyes_chemical_arr[$b_id][6]['chemical_cost']; 
				                 $mult_batch_dyes_chemical_cost=$mult_batch_chemical_cost+$mult_batch_dyes_cost;
				                 $multi_batch_qty_total+=$mulib_batch_weight;
				                 $mult_batch_chemical_cost_total+=$mult_batch_chemical_cost;
				                 $mult_batch_dyes_cost_total+=$mult_batch_dyes_cost;
				                 $mult_batch_dyes_chemical_cost_total+=$mult_batch_dyes_chemical_cost;
				                 
				                 $multi_date="";
				                 foreach(array_unique($batch_date_arr) as $m_date)
				                 {
				                 if($multi_date!="") $multi_date.=",".change_date_format($m_date); else $multi_date=change_date_format($m_date);
				                 }
								//echo $ref_no.'='.$file_no;
								 
								 
				                ?><p><? echo $multi_date; ?></p></td>  
				                 <td width="100"><p><? echo implode(",",array_unique(explode(",",$multi_batch_machine))); ?></p> </td>                               
				                <td width="100" ><p> <?
								//$batch_nos=rtrim($batch_multi_arr[$s_bid],',');
								$batch_nosArr=array_unique(explode(",",$batch_id_all));
								$extention_no_multi="";
								foreach($batch_nosArr as $b_no)
								{
									$re_b_id=rtrim($re_batch_wise_arr[$b_no]['batch_id'],',');
									$re_b_idArr=array_unique(explode(",",$re_b_id));
									//echo $re_b_id.'======';
									$re_b_ids=implode(",",array_unique(explode(",",$re_b_id)));
									
									$extention_no_multi.=$batch_wise_arr[$b_no]['extention_no'].',';
									$re_dying_multi_batch_chemical_cost=$re_dying_multi_batch_chemical_cost=$re_dying_multi_batch_chemical_cost=$re_dying_multi_batch_chemical_cost=0;
									foreach($re_b_idArr as $re_bid)
									{
										// $re_dying_multi_id_all=ltrim($l_id,",");
					                     $re_dying_multi_batch_chemical_cost+=$dyes_chemical_arr[$re_bid][5]['chemical_cost']+$dyes_chemical_arr[$re_bid][7]['chemical_cost'];
					                     $re_dying_multi_batch_dying_cost+=$dyes_chemical_arr[$re_bid][6]['chemical_cost'];	
					                     $re_dying_multi_batch_dyes_chemical_cost+=$dyes_chemical_arr[$re_bid][5]['chemical_cost']+$dyes_chemical_arr[$re_bid][6]['chemical_cost']+$dyes_chemical_arr[$re_bid][7]['chemical_cost'];
									}
								}
								 $re_dying_multi_batch_chemical_cost_total+=$re_dying_multi_batch_chemical_cost;
					                 $re_dying_multi_batch_dying_cost_total+=$re_dying_multi_batch_dying_cost;
					                 $re_dying_multi_batch_dyes_chemical_cost_total+=$re_dying_multi_batch_dyes_chemical_cost;
									 
								
								$extention_noData=rtrim($extention_no_multi,',');
								$extention_noArr=array_unique(explode(",",$extention_noData));
								$multi_extention_batch_no=max($extention_noArr);
									 echo $batch_nos;
									 ?>
				                    </p> </td>
				                <td width="80" align="center"><p><? echo $file_no; ?></p></td>
				                <td width="80" align="center" title="PO/Sample Ref no"><p><?  echo $ref_no; ?></p></td>
				                <td width="100"><p><? echo implode(",",array_unique(explode(",",$muli_batch_floor_name))); ?></p></td> 
				                <td width="80" align="center"><p><? echo implode(",",array_unique($multi_batch_buyer_name)); ?></p></td>  
				                <td width="100" align="center"><p><? echo implode(",",array_unique($multi_batch_booking_no)); ?></p></td> 
				                <td width="100" align="center"><p><? echo implode(",",array_unique($multi_batch_job_no)); ?></p></td> 
				                 <td width="80" align="center"><p><? echo implode(",",array_unique($season_data)); ?></p></td> 
				                <td width="100" align="center"><p><? echo implode(",",array_unique($multi_batch_style_no)); ?></p></td> 
				                <td width="100" align="center"><p><? echo  implode(",",array_unique(explode(",",$po_no)));//echo implode(",",array_unique(explode(",",$po_number_data_all)));//?></p></td>
				                <td width="100" align="center"><p><? echo implode(",",array_unique(explode(",",$multi_batch_color))); ?></p></td>
				                <td width="100" align="center"><p><? echo implode(",",array_unique(explode(",",$multi_batch_color_range))); ?></p></td> 
				                <td width="100"><p><?
								 $type_name="";
								$arra_type= array_unique($multiple_batch_id);
								//print_r($fabric_type_arr);
								foreach($arra_type as $v)
								{
									//echo $v;
									if($fabric_type_arr[$v]['fabric_type'])
									{
										if($type_name) $type_name.=",".$fabric_type_for_dyeing[$fabric_type_arr[$v]['fabric_type']];
										else $type_name.=$fabric_type_for_dyeing[$fabric_type_arr[$v]['fabric_type']];
									}
								}
								 echo $type_name; ?></p></td>  
				                <td width="80" align="right"><p><? echo $mulib_batch_weight; ?></p></td>
				                <td width="100" align="right"><p><? echo number_format($mult_batch_chemical_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_batch_dyes_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_batch_dyes_chemical_cost,4);  ?></p></td>
				                <td width="110" align="right"><p><? echo number_format($mult_batch_dyes_chemical_cost/$mulib_batch_weight,4); ?></p></td>
				                <td width="80" align="right"><p><?  echo implode(",",array_unique(explode(",",$remulti_batch_date))); ?></p></td>
				                <td width="70" align="right"><p><?  echo $multi_extention_batch_no; ?></p></td>
				                <td width="100" align="right"><p><?  echo implode(",",array_unique(explode(",",$re_floor))); ?></p></td>
				                <td width="100" align="right"><p>
				                <? echo number_format($re_dying_multi_batch_chemical_cost,4); $tot_closing_stock+=$closingStock; ?></p>
				                </td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_multi_batch_dying_cost,4); ?></p></td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_multi_batch_dyes_chemical_cost,4);  ?></p></td>
				                <td width="110" align="right"><? echo number_format($re_dying_multi_batch_dyes_chemical_cost/$mulib_batch_weight,4); ?></td>
				                <td width="70" align="right"><? echo  number_format($re_dying_multi_batch_dyes_chemical_cost+$mult_batch_dyes_chemical_cost,4);  ?></td>
				                <td width="70" align="right"><? echo number_format(($re_dying_multi_batch_dyes_chemical_cost+$mult_batch_dyes_chemical_cost)/$mulib_batch_weight,4);; ?></td>
				                <td width="" align="center"><? 
				                if($dye_result!="") $result.=",".$dyeing_result[$result_arr[$s_bid]];
					            else $dye_result=$dyeing_result[$result_arr[$s_bid]];
					            echo implode(",",array_unique(explode(",",$dye_result)));
				                //echo $daysOnHand;//$daysOnHand; ?></td>
				            </tr>
							<? 
							unset($new_redying_arr);
							unset($new_redying_arr1);
																			
							$j++; 		
						}		
					}
					?>
		        </table>
	        </div>
	        <table width="2970" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer">
		        <tfoot>
	            	<tr>
	                	<th width="40">&nbsp;</th>
	                	<th width="80">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                    <th width="80">&nbsp;</th>
	                    <th width="80">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                	<th width="80">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                      <th width="80">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                	<th width="100">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                    <th width="100">&nbsp;</th>
	                    <th width="80" id="value_total_batch_weight_multiple"><? echo number_format($multi_batch_qty_total,4); ?></th>
	                	<th width="100" id="value_total_chemical_cost_multiple"><? echo number_format($mult_batch_chemical_cost_total,4); ?></th>
	                	<th width="110" id="value_total_dyeing_cost_multiple"><? echo number_format($mult_batch_dyes_cost_total,4); ?></th>
	                    <th width="110" id="value_total_chemical_price_multiple"><? echo number_format($mult_batch_dyes_chemical_cost_total,4); ?></th>
	                    <th width="110" id="value_total_cost_per_kg_multi"><? echo number_format($mult_batch_dyes_chemical_cost_total/$multi_batch_qty_total,3); ?></th>
	                    <th width="80"><? //echo number_format($mult_batch_dyes_chemical_cost_total/$multi_batch_qty_total,3); ?></th>
	                    <th width="70"><? //echo number_format($tot_rec_return,3); ?></th>
	                    <th width="100"><? //echo number_format($tot_total_issue,3); ?></th>
	                    <th width="100" id="value_total_chemical_cost_multi"><? echo number_format($re_dying_multi_batch_chemical_cost_total,4); ?></th>
	                    <th width="100" id="value_total_redying_dying_cost_multiple"><p><? echo number_format($re_dying_multi_batch_dying_cost_total,4); ?></p></th>
	                    <th width="100" id="value_total_redying_all_cost_multiple"><p><? echo number_format($re_dying_multi_batch_dyes_chemical_cost_total,4); ?></p></th>
	                    <th width="110" id="value_total_redye_cost_per_kg_multi"><? echo number_format(($re_dying_multi_batch_dyes_chemical_cost_total/$multi_batch_qty_total),4); ?></th>
	                    <th width="70" id="value_grand_total_cost_multiple"><? echo number_format($mult_batch_dyes_chemical_cost_total+$re_dying_multi_batch_dyes_chemical_cost_total,4); ?></th>
	                    <th width="70" id="value_total_total_per_kg_cost_multi"><? echo number_format(($mult_batch_dyes_chemical_cost_total+$re_dying_multi_batch_dyes_chemical_cost_total)/$multi_batch_qty_total,4); ?></th>
	                    <th width="">&nbsp;</th>
	                </tr>
	            </tfoot>
	        </table>
      	</div>
  	</div>
    <?
    $html = ob_get_contents();
    ob_clean();
    //$new_link=create_delete_report_file( $html, 2, $delete, "../../../" );
    foreach (glob("*.xls") as $filename) {
    //if( @filemtime($filename) < (time()-$seconds_old) )
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');	
    $is_created = fwrite($create_new_doc, $html);


    $filename2=$user_id."_summary_".$name.".xls";
    $create_new_doc2 = fopen($filename2, 'w');	
    $is_created2 = fwrite($create_new_doc2, $summaryHTML);

    echo "$html****$filename****$filename2****$report_type"; 
    exit();
}
if($action=="generate_report6") // Batch  Wise2 
{ 
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if ($cbo_company_name==0) $company_id=""; else $company_id=" and a.company_id='$cbo_company_name'";
	if ($cbo_company_name==0) $company_idcond =""; else $company_idcond =" and b.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond .=""; else $company_idcond .=" and b.working_company_id='$cbo_working_name'";
	//echo $cbo_company_name.'='.$cbo_working_name;die;
	if ($cbo_company_name==0 && $cbo_working_name==0) 
	{
	$w_company_idcond ="";$w_company_idcond2="";$w_company_idcond3="";$w_company_idcond4="";
	}
	 else  {
		 if ($cbo_company_name==0 && $cbo_working_name>0)
		 {
		  	$w_company_idcond =" and c.company_id='$cbo_working_name'";
			$w_company_idcond2 =" and b.knit_dye_company='$cbo_working_name'";
			$w_company_idcond3 =" and b.working_company_id='$cbo_working_name'";
			$w_company_idcond4 =" and a.service_company='$cbo_working_name'";
		 }
		 else  if ($cbo_company_name>0 && $cbo_working_name==0)
		 {
		  $w_company_idcond =" and c.company_id='$cbo_company_name'";
		  $w_company_idcond2 =" and b.knit_dye_company='$cbo_company_name'";
		  $w_company_idcond4 =" and a.company_id='$cbo_company_name'";
		  $w_company_idcond3 ="and b.company_id='$cbo_company_name'";
		 }
	 }
	 // echo  $w_company_idcond.'dd'.$company_idcond;die;
	
	$from_date=str_replace("'","",$from_date);
	$to_date=str_replace("'","",$to_date);
	//echo $from_date;
	$txt_ref_no=str_replace("'","",$txt_ref_no); 
	$txt_file_no=str_replace("'","",$txt_file_no);
	$txt_booking_no=str_replace("'","",$txt_booking_no);
	$txt_po_no=str_replace("'","",$txt_po_no);
	$txt_job=str_replace("'","",$txt_job);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$cbo_season_id=str_replace("'","",$cbo_season_id);
	$txt_samp_ref_no=str_replace("'","",$txt_samp_ref_no);
	$location_id=str_replace("'","",$location_id);
	$floor_id=str_replace("'","",$floor_id);
	$report_type=str_replace("'","",$report_type);
	$cbo_year=str_replace("'","",$cbo_year_selection);

	
	
	if(str_replace("'","",$cbo_buyer_name)==0)
	{
		if ($_SESSION['logic_erp']["data_level_secured"]==1)
		{
			if($_SESSION['logic_erp']["buyer_id"]!="") $buyer_id_cond=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")"; else $buyer_id_cond="";
		}
		else
		{
			$buyer_id_cond="";
		}
	}
	else
	{
		$buyer_id_cond=" and a.buyer_name in (".str_replace("'","",$cbo_buyer_name).")";
	}
	
	if($txt_booking_no!='') $booking_no_cond="and b.booking_no like '%$txt_booking_no%' ";else $booking_no_cond="";
	if($db_type==0)
		{
			$year_cond=" and SUBSTRING_INDEX(a.insert_date, '-', 1)=$cbo_year";
		}
		else if($db_type==2)
		{
			$year_cond=" and to_char(a.insert_date,'YYYY')=$cbo_year";
		}
		
	if($txt_file_no!='') $file_cond="and b.file_no=$txt_file_no";else $file_cond="";
	if($txt_job!='') $job_cond="and a.job_no_prefix_num=$txt_job  $year_cond";else $job_cond="";
	if($txt_po_no!='') $po_cond="and b.po_number='$txt_po_no'";else $po_cond="";
	
	if($cbo_season_id!=0) $season_cond="and a.season_buyer_wise in($cbo_season_id)";else $season_cond="";
	
	if($txt_ref_no!='') $ref_cond="and b.grouping='$txt_ref_no'";else $ref_cond="";
	if($txt_samp_ref_no!='') $samp_ref_cond="and a.grouping='$txt_samp_ref_no'";else $samp_ref_cond="";
	//echo $ref_cond;
	$companyArr = return_library_array("SELECT id,company_name from lib_company where status_active=1 and is_deleted=0","id","company_name"); 
	$supplierArr = return_library_array("SELECT id,supplier_name from lib_supplier where status_active=1 and is_deleted=0","id","supplier_name"); 
	$color_arr=return_library_array( "SELECT id,color_name  from  lib_color", "id", "color_name"  );
	$buyer_arr=return_library_array( "SELECT id,buyer_name  from  lib_buyer", "id", "buyer_name"  );
	$season_name_arr=return_library_array( "SELECT id,season_name  from  lib_buyer_season", "id", "season_name"  );
	
	if($db_type==0) 
	{
	$from_date=change_date_format($from_date,'yyyy-mm-dd'); $to_date=change_date_format($to_date,'yyyy-mm-dd');
	}
    if($db_type==2) 
	{
	$from_date=change_date_format($from_date,'','',1);  $to_date=change_date_format($to_date,'','',1);
	}
	//echo $from_date;
	$batch_description_arr=array();
	/* 
	if(str_replace("'","",$batch_id)!="") $batch_cond=" and b.id in(".str_replace("'","",$batch_id).")";
    else  */
	//echo $batch_cond; //die;
	//echo $batch_no; //die;
    	//echo $batch_no;
	$batch_no=implode("','",array_unique(explode(",",$batch_no)));
	if(str_replace("'","",$batch_no)!="") $batch_cond=" and b.batch_no in('".$batch_no."') "; 
	else $batch_cond="";
	//echo $batch_cond."shakil"; die;
	//
	/* and b.re_dyeing_from=0 13-11-16 according to siddique sir dicission when search buyer order or subcontract all batch appear */
	if($batch_type==0)
	$search_field_cond_batch="";
	else if($batch_type==1)
	$search_field_cond_batch="and b.entry_form=0 ";
	else if($batch_type==2)
	$search_field_cond_batch="and b.entry_form=36";
	else if($batch_type==4)
	$search_field_cond_batch="and b.entry_form=136";
	else if($batch_type==5)
	$search_field_cond_batch="and b.batch_against=3";// sample
	else 
	$search_field_cond_batch="and b.entry_form in(0,36) and b.batch_against in(2) and  b.re_dyeing_from!=0 ";
 //echo $search_field_cond_batch.'D';die;
	
 	$con = connect();
	 execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id." and ref_from in (1,2,3,4,5,6,7,8) and ENTRY_FORM=48");
	 oci_commit($con);
	 disconnect($con);

	if($txt_file_no!='' || $txt_ref_no!='' ||  $txt_po_no!='' || $txt_job!='' || $cbo_buyer_name>0)
	{
		
		if($batch_type==4) //Trim batch
		{
		 $sql_po="SELECT c.id as batch_id,a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b,pro_batch_create_mst c where a.id=b.job_id and b.job_no_mst=c.job_no  and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond";
		}
		else
		{
			$sql_po="SELECT a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b  where a.id=b.job_id and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond";
		}
		// echo $sql_po;die; 
		$res_po=sql_select($sql_po);
		$all_po_id='';
		foreach($res_po as $row) //$job_no_arr
		{			
			if($all_po_id=="") $all_po_id=$row[csf('id')]; else $all_po_id.=",".$row[csf('id')]; //echo $all_po_id;
			
			$trim_batch_idArr[$row[csf('batch_id')]]=$row[csf('batch_id')];
			$po_idArr[$row[csf('id')]]=$row[csf('id')];
		}
		//echo $all_po_id;
		
		
		fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 1, $po_idArr, $empty_arr);//PO ID Ref from=1
		fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 2, $trim_batch_idArr, $empty_arr);//Batch ID Ref from=2
		

		if($all_po_id!="") $po_idd="and po_id in($all_po_id)";else $po_idd="and po_id in(0)";
		
		$poIds=chop($all_po_id,','); $po_cond_for_in="";
		$po_ids=count(array_unique(explode(",",$all_po_id)));
		if($db_type==2 && $po_ids>1000)
		{
			$po_cond_for_in=" and (";
			$poIdsArr=array_chunk(explode(",",$poIds),999);
			foreach($poIdsArr as $ids)
			{
				$ids=implode(",",$ids);
				$po_cond_for_in.=" po_id in($ids) or"; 
			}
			$po_cond_for_in=chop($po_cond_for_in,'or ');
			$po_cond_for_in.=")";
		}
		else
		{
			$po_cond_for_in=" and po_id in($poIds)";
			
		}
		
		if($batch_type==4) //Trim batch
		{
		 	$po_cond_for_in='';
			$po_cond_for_in=where_con_using_array($trim_batch_idArr,0,"mst_id");
			//echo "SELECT b.mst_id as batch_id from pro_batch_trims_dtls b  where   b.status_active=1 and b.is_deleted=0 $po_cond_for_in";die;
			$sql_batch=sql_select("SELECT b.mst_id as batch_id from pro_batch_trims_dtls b,gbl_temp_engine g   where  b.mst_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and b.status_active=1 and b.is_deleted=0 ");
		}
		else
		{
			$sql_batch=sql_select("SELECT b.mst_id as batch_id from pro_batch_create_dtls b,gbl_temp_engine g  where   b.po_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=1 and g.entry_form=48  and b.status_active=1 and b.is_deleted=0  ");
		}
		//echo "SELECT mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in";die();
		 $all_batch_id='';
		foreach($sql_batch as $row) 
		{
			if($all_batch_id=="") $all_batch_id=$row[csf('batch_id')]; else $all_batch_id.=",".$row[csf('batch_id')];
		}
			$all_batch_ids=implode(",",array_unique(explode(",",$all_batch_id)));
		//echo $all_batch_ids; 
		$batch_ids_cond="";
		if($all_batch_ids!="") 
		{
			//echo $po_id=substr($po_id,0,-1);
			if($db_type==0) { $batch_ids_cond="and b.id in(".$all_batch_ids.")"; }
			else
			{
				$bat_id=array_unique(explode(",",$all_batch_ids));
				if(count($bat_id)>1000)
				{
					$batch_ids_cond="and (";
					$bat_id=array_chunk($bat_id,1000);
					$z=0;
					foreach($bat_id as $id)
					{
						$id=implode(",",$id);
						if($z==0) $batch_ids_cond.=" b.id in(".$id.")";
						else $batch_ids_cond.=" or b.id in(".$id.")";
						$z++;
					}
					$batch_ids_cond.=")";
				}
				else { 
				
				$batch_ids_cond=" and b.id in(".$all_batch_ids.")"; }
			}
		}
	}
	// print_r($batch_ids_cond);die;
	if($from_date!="" && $to_date!="")
	{
		$date_cond_samp="";
		if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond_samp=" and b.batch_date between '".$from_date."' and '".$to_date."'";
		}
	}


	/* ================================================================================ /
	/								Main query start here								/
	/ ================================================================================ */
	$samp_non_booking=sql_select("SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no_id=a.id and a.booking_type=4  $company_idcond $w_company_idcond3 $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
	/*echo "SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $w_company_idcond3 $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";die; */
	 

	// echo "SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";die; 
	$all_batch_id_samp="";
	foreach($samp_non_booking as $row)
	{
		$non_buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$non_buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$sample_booking_ref_no_arr[$row[csf('booking_no')]]=$row[csf('grouping')];
		if($txt_samp_ref_no!='')
		{
		if($all_batch_id_samp=="") $all_batch_id_samp=$row[csf('batch_id')]; else $all_batch_id_samp.=",".$row[csf('batch_id')];
		}
	}
	if($all_batch_id_samp!="") $all_batch_id_samp_cond="and b.id in($all_batch_id_samp)";else $all_batch_id_samp_cond="";
	//echo $all_batch_id_samp_cond.'X';
	$company_id_issue="";$company_idcond_issue="";
	if ($cbo_company_name==0) $company_id_issue=""; else $company_id_issue=" and b.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond_issue=""; else $company_idcond_issue =" and b.working_company_id='$cbo_working_name'";
	if ($cbo_working_name==0) $w_company_idcond_issue=""; else $w_company_idcond_issue =" and b.knit_dye_company='$cbo_working_name'";

	
    if($from_date!="")
    {
		if(str_replace("'","",$cbo_value_with)==1)
		{
			$date_cond=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";
		//and b.batch_against in(1,2,3)
			$sql=sql_select("SELECT b.id,b.sales_order_id,a.batch_no,a.fabric_type,b.booking_without_order,b.job_no,b.extention_no,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
			and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  $company_id_issue $company_idcond_issue $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
			 
			 
		}
		else if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond=" and b.batch_date between '".$from_date."' and '".$to_date."'";
			$sql=sql_select("SELECT b.id,b.sales_order_id,b.batch_no,b.booking_without_order,b.job_no,b.extention_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
			from  pro_batch_create_mst b where   b.status_active=1 and b.is_deleted=0  $company_id_issue $company_idcond_issue $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
			
		}
   	}
   	else
   	{
		 
		 
		$sql=sql_select("SELECT b.id,b.sales_order_id,b.booking_without_order,b.job_no,b.extention_no,b.batch_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
		from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0 $company_id_issue $company_idcond_issue $batch_cond $batch_ids_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
		
		//w_company_idcond
		
	}
	// echo $sql; 
	 //and e.party_id not in(426,439,444,458,425,427,428,443,392,564,565,563)
	if(count($sql)==0)
    {
        ?>
        <div style="font-size:20px;color:red;text-align:center">Data not found!</div>
        <?
        die;
    }
	/*$sub_batch_arr=array();
	foreach($sql as $row)
	{
			$entry_formId=$row[csf("entry_form")];
			if($entry_formId==36)
			{
				$sub_batch_arr[$row[csf("id")]]=$row[csf("id")];
			}
	}
	 $buyer_library=return_library_array( "SELECT id,buyer_name from   lib_buyer", "id","buyer_name" );
	if(count($sub_batch_arr))
	{
		$subBatch_id_cond=where_con_using_array($sub_batch_arr,0,"a.mst_id");
		 // $batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.mst_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.mst_id", $re_dying_cond);
	$po_data_subcon=sql_select("SELECT a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0  $subBatch_id_cond");
	//echo "SELECT a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	//subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0    $subBatch_id_cond";
	
	$sub_con_arr=array();$sub_party_arr=array(426,439,444,458,425,427,428,443,392,564,565,563); //Omit buyer ids
	$sub_batch_chk_arr=array();
	foreach($po_data_subcon as $row)
	{
		if($sub_con_arr[$row[csf('mst_id')]][cust_style_ref]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref].=",".$row[csf('cust_style_ref')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref]=$row[csf('cust_style_ref')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][order_no]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no].=",".$row[csf('order_no')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no]=$row[csf('order_no')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][subcon_job]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job].=",".$row[csf('subcon_job')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job]=$row[csf('subcon_job')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][party_id]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id].=",".$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id].=",".$row[csf('party_id')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id]=$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id]=$row[csf('party_id')];	
		}
		$party_id=$row[csf('party_id')];
		if(in_array($party_id,$sub_party_arr) && $row[csf("party_id")]>0)
		{
			$sub_batch_chk_arr[$row[csf("mst_id")]]=$row[csf("mst_id")];
		}
	  }
	}*/
  	   //echo $sql; 
	//die;
  	//  print_r($sub_batch_chk_arr);die();
	
  
	
  	$reding_batch_id=$non_reding_batch_id=$trim_batch_IdArr=array();
    foreach($sql as $row)
	{
	// $sub_party_id_not=$sub_batch_chk_arr[$row[csf("id")]];
	  if($row[csf("entry_form")]=='136') 
	  {
		 	$trim_batch_IdArr[$row[csf("id")]]=$row[csf("id")]; 
	  }	
		
		$batch_against_id=$row[csf("batch_against")];
		$batch_id_arr[]=$row[csf("id")];
		$batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
		if($row[csf("sales_order_id")]!='')
		{
		$sales_batch_arr[$row[csf("id")]]=$row[csf("sales_order_id")];
		$sales_id_arr[$row[csf("sales_order_id")]]=$row[csf("sales_order_id")];
		}
		
	//	echo $sub_party_id_not.', ';
		 $issue_single_batch_arr[$row[csf("id")]]=$row[csf("id")];  
		if($batch_against_id==1 || $batch_against_id==3)
		{		
			// $batch_id_arr[]=$row[csf("id")]; 
			//$sub_batch_chk_not=$sub_batch_chk_arr[$row[csf("id")]]
			//if($sub_party_id_not!=$row[csf("id")]) //426,439,444,458,425,427,428,443,392,564,565,563
	  		//{ 
			 $batch_description_arr[$row[csf("id")]]['batch_weight']=$row[csf("batch_weight")];
	 		//} //Subcon some buyer omit end
		
			$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
			$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
			
			$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
			$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_description_arr[$row[csf("id")]]['job_no']=$row[csf("job_no")];
			
			$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
			$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
			$batch_no_arr[]="'".$row[csf("batch_no")]."'";
			// $batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			$batch_wise_arr[$row[csf("batch_no")]]['batch_no']=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['extention_no'].=$row[csf("extention_no")].',';
			$batch_ext_wise_arr[$row[csf("id")]]['extention_no']=$row[csf("extention_no")];
			
		}
		if($batch_against_id==2)
		{
			 
			// if($sub_party_id_not!=$row[csf("id")]) //426,439,444,458,425,427,428,443,392,564,565,563
	  		 //{
			 $batch_description_arr[$row[csf("id")]]['batch_weight']=$row[csf("batch_weight")];
			 //} //Subcon some buyer omit end
			$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
			$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
			//$batch_description_arr[$row[csf("id")]]['batch_weight']+=$row[csf("batch_weight")];
			$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
			$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_description_arr[$row[csf("id")]]['job_no']=$row[csf("job_no")];
			
			$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
			$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
			$batch_no_arr[]="'".$row[csf("batch_no")]."'";
			// $batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
			
			$batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			$batch_wise_arr[$row[csf("batch_no")]]['batch_no']=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['extention_no'].=$row[csf("extention_no")].',';
			$batch_ext_wise_arr[$row[csf("id")]]['extention_no']=$row[csf("extention_no")];
			$batch_ext_wise_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$re_batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			
		}
		if($row[csf("batch_against")]==2)
		{
			/*if($row[csf("re_dyeing_from")]>0)
			{
				$reding_batch_id[$row[csf("re_dyeing_from")]]=$row[csf("re_dyeing_from")]; 
			}
			else
			{
				$reding_batch_id[$row[csf("id")]]=$row[csf("id")]; 
			}*/
			$reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
		else
		{
			$non_reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
		
	 
	}
	 
	 //echo "<pre>"; print_r($issue_single_batch_arr); die();

	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 3, $issue_single_batch_arr, $empty_arr);//Batch ID Ref from=3

	//	********************************************************************************************************************************
     $batch_id_sql=implode(",",$batch_id_arr);
    if($batch_id_sql=="") $batch_id_sql=0;
	//echo  $batch_id_sql;
  	if($batch_type==3)
	{
		//$re_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond2=chop($re_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond2.=")";
		}
	}
	else
	{
		//$re_dying_cond=" and b.re_dyeing_from in(".$batch_id_sql.")";	
		//$pord_ids = explode(",",$txt_product_id);
		//echo count($pord_ids);die;
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond=chop($re_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond.=")";
		}
	}

	$date_cond2=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";

	// =============================================================
	$batch_all_id_array=array();
//	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
	//   $sql = "SELECT a.ID,b.mst_id as REQ_ID,a.batch_id as BATCH_ID,a.BATCH_QTY,a.BATCH_QTY,a.NEW_BATCH_WEIGHT,a.ENTRY_FORM,c.batch_id as RE_BATCH_ID from pro_recipe_entry_mst a, dyes_chem_requ_recipe_att b,dyes_chem_issue_requ_mst c where b.recipe_id=a.id  and c.id=b.mst_id $batch_id_conds and a.status_active=1 and a.is_deleted=0 and b.status_active=1 ";
	  $sql = "SELECT a.ID,b.mst_id as REQ_ID,a.batch_id as BATCH_ID,a.BATCH_QTY,a.BATCH_QTY,a.NEW_BATCH_WEIGHT,a.ENTRY_FORM,c.batch_id as RE_BATCH_ID from pro_recipe_entry_mst a, dyes_chem_requ_recipe_att b,dyes_chem_issue_requ_mst c,gbl_temp_engine g where b.recipe_id=a.id  and c.id=b.mst_id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 ";
	 // echo $sql;die; 
	$res = sql_select($sql);
	$req_id_array = array();
	foreach ($res as $val) 
	{
		//$req_id_array2[$val['REQ_ID']] .= $val['REQ_ID'].',';
		$req_id_array[$val['REQ_ID']] = $val['REQ_ID'];
		//$batch_req_id_array[$val['BATCH_ID']].= $val['REQ_ID'].',';
		$batch_req_id_array2[$val['BATCH_ID']]= $val['REQ_ID'];
		$batch_all_id_array[$val['BATCH_ID']]= $val['BATCH_ID'];
		//if($batchWgtChkk[$val['REQ_ID']]=='')
		//{
			if($val['ENTRY_FORM']==60) //Adding Topping
			{
				$batch_wgt=$val['NEW_BATCH_WEIGHT'];
			}
			else
			{
				$batch_wgt=$val['BATCH_QTY'];
			}
		//$batch_wgt_array[$val['REQ_ID']] += $batch_wgt;
		$batch_wgt_array[$val['BATCH_ID']] = $batch_wgt;
		$batchWgtChkk[$val['REQ_ID']].=$val['BATCH_ID'].',';
		
		$batchIdChkkDtls[$val['REQ_ID']]=$val['BATCH_ID'];
		//}
		
	}
	unset($res);
	// print_r($req_id_array);die;
	// $requisition_ids = implode(",", $req_id_array);
	
	
	if(count($req_id_array))
	{
		//$requisition_id_cond=where_con_using_array($req_id_array,0,"a.requisition_no");
	}
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 4, $req_id_array, $empty_arr);//Req ID Ref from=4
	
	$issue_sql = sql_select("SELECT a.MST_ID ,a.REQUISITION_NO,b.BATCH_NO,a.ITEM_CATEGORY,a.PROD_ID,a.CONS_QUANTITY,a.CONS_AMOUNT from inv_transaction a,inv_issue_master b,gbl_temp_engine g where a.mst_id=b.id and a.REQUISITION_NO=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=4 and g.entry_form=48 and b.entry_form=5 and b.is_deleted=0 and b.status_active=1 and a.status_active=1 and a.transaction_type=2    ");//$w_company_idcond2
	 
	 
	$issue_id_arr = array();$tot_issueQty=0;  

	foreach ($issue_sql as $val) 
	{
		 
		$batchArr=array_filter(array_unique(explode(",",$val['BATCH_NO'])));
		foreach($batchArr as $bid)
		{
			$issue_item_cat_arr[$bid][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['ITEM_CATEGORY'];
			if($bid!='')
			{
			$batch_all_id_array[$bid]= $bid;
			$batch_req_id_array[$bid].= $val['REQUISITION_NO'].',';
			}
		}
			$issue_item_cat_cost_arr[$val['REQUISITION_NO']][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['CONS_QUANTITY'];
			$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_QUANTITY'];
			
			$issue_item_cat_amt_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_AMOUNT'];
		
		 $ReqBatch_id_arr[$val['REQUISITION_NO']] = $val['BATCH_NO'];
		$issue_id_arr[$val['MST_ID']] = $val['MST_ID'];
		$tot_issueQty+=$val['CONS_QUANTITY'];
		
	}
	// echo count($batch_all_id_array);die;
	if(count($batch_all_id_array))
	{
		//$batch_ids_cond=where_con_using_array($batch_all_id_array,0,"b.id");
	}
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 5, $batch_all_id_array, $empty_arr);//Batch ID Ref from=5

	$batch_fabric_sql=sql_select("SELECT b.id,b.batch_no,b.batch_weight, b.batch_against
	from pro_recipe_entry_mst  a,pro_batch_create_mst b,gbl_temp_engine g where  a.batch_id=b.id and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=5 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0" );
	 
	/* echo "SELECT b.id,b.batch_no,b.batch_weight, b.batch_against
	from pro_recipe_entry_mst  a,pro_batch_create_mst b  where  a.batch_id=b.id 
	 and a.status_active=1 and a.is_deleted=0 $batch_ids_cond group by  b.id,b.batch_no,b.batch_weight, b.batch_against";die;*/
	 $batch_wgt_arr=array();
	 foreach ($batch_fabric_sql as $row) 
	{
		//$batch_req_id=$batch_req_id_array2[$row[csf("id")]];
		//echo $batch_req_id.'d';
		$batch_wgt_arr[$row[csf("id")]]['batchWgt']=$row[csf("batch_weight")];
	}
	//========+++++=Re Calculation++++++++++++========
	//$issue_single_batch_arr  
	/*$tot_amt=0;
	foreach ($issue_sql as $val) 
	{
		$batchIdReq=array_unique(explode(',',$batchIdChkkDtls[$val['REQUISITION_NO']]));
		$batch_wgt_cal=0;
		foreach($batchIdReq as $Batchid)
		{
			$batch_wgt_cal+=$batch_wgt_arr[$Batchid]['batchWgt'];
		}
		$issue_item_cat_amt_dtls_arr2[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_AMOUNT']/$batch_wgt_cal;
		$tot_amt+=$val['CONS_AMOUNT'];
	}*/
	//echo $tot_amt.'T';
	 
	  
	//echo $tot_issueQty.'D';
	// echo "<pre>";print_r($batch_req_id_array);die;
	// =====================================================================================
	//$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "b.id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "b.id", $re_dying_cond);
	$fabric_sql=sql_select("SELECT b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
	from pro_fab_subprocess  a,pro_batch_create_mst b,gbl_temp_engine g  where  a.batch_id=b.id  and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 
	and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 $company_idcond");
	 	
  	$fabric_type_arr=array();
    foreach($fabric_sql as $row)
	{
	 	$fabric_type_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
	}
	//=========****============Fab Sales Order=========================
	//sales_order_id
	//$sales_id_arr
	if(count($sales_id_arr))
	{
		//$sales_order_id_cond=where_con_using_array($sales_id_arr,0,"c.id");
	}
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 6, $sales_id_arr, $empty_arr);//Sales ID Ref from=6
	$sales_fabric_sql=sql_select("SELECT c.id as sales_id,c.buyer_id,b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
	from pro_fab_subprocess  a,pro_batch_create_mst b,fabric_sales_order_mst c,gbl_temp_engine g  where  a.batch_id=b.id 
	and c.id=b.sales_order_id and c.id=g.ref_val and b.sales_order_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=6 and g.entry_form=48  and a.entry_form in (35) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $company_idcond ");
	 
	 	
  	$fabric_type_arr=array();
    foreach($sales_fabric_sql as $row)
	{
	 	$fabric_sales_arr[$row[csf("sales_id")]]['buyer_id']=$row[csf("buyer_id")];
		//$sales_batch_arr[$row[csf("id")]]=$row[csf("sales_order_id")];
	}
	unset($sales_fabric_sql);

	// ========================================================================================

	$floor_cond_arr=array();
	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
	//echo $location_id.'-0998';die; 
	if(!empty($location_id))
	{
		if(!empty($floor_id))
		{
			$sql="SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b,gbl_temp_engine g  where a.floor_id=b.id  and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0 and b.company_id=$cbo_working_name and b.location_id=$location_id and b.production_process=3 and b.id=$floor_id ";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) 
			{
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		else
		{
			 $sql="SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b,gbl_temp_engine g  where a.floor_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0  and b.location_id=$location_id and b.production_process=3 ";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) {
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		$floor_cond_arr=array_unique($floor_cond_arr);
	}
	 // print_r($floor_cond_arr);die();

	// ==========================================================================

	//$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
    $floor_arr=return_library_array("SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b,gbl_temp_engine g  where a.floor_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0 ", "batch_id", "floor_name" );

	$machine_name_arr=return_library_array("SELECT  a.batch_id ,b.machine_no from   pro_fab_subprocess a, lib_machine_name b,gbl_temp_engine g  where a.machine_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.entry_form in(38,35) and  b.status_active=1 and b.is_deleted=0  ", "batch_id", "machine_no" );

	//$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "c.id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "c.id", $re_dying_cond);
	$sql_book=sql_select("SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c,gbl_temp_engine g where a.buyer_id=b.id and a.id=c.booking_no_id and c.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 ");
	//echo "SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c where a.buyer_id=b.id and a.id=c.booking_no_id $batch_id_conds";die;
	//echo "SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c where a.buyer_id=b.id and a.id=c.booking_no_id $batch_id_conds";die;
	$po_id_arr = array();
	foreach($sql_book as $row)
	{
		$buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		
		if($row[csf('po_break_down_id')])
		{
		$po_id_arr[$row[csf('po_break_down_id')]]=$row[csf('po_break_down_id')];
		$po_break_down_id_arr[$row[csf('booking_no')]]=$row[csf('po_break_down_id')];
		}
	}

	// =========================================================
	// $poIdss = implode(",", $po_id_arr);
	if(count($po_id_arr))
	{
		$po_id_cond = where_con_using_array($po_id_arr,0,"b.id");
	}
	
	if(count($trim_batch_IdArr))
	{
		$trim_batchId_cond = where_con_using_array($trim_batch_IdArr,0,"c.id");
	}


	/*if($db_type==2 && count($po_id_arr)>1000)
	{
		$poIdCond=" and (";
		$poIdsArr=array_chunk($po_id_arr,999);
		foreach($poIdsArr as $ids)
		{
			$ids=implode(",",$ids);
			$poIdCond.=" b.id in($ids) or"; 
		}
		$poIdCond=chop($poIdCond,'or ');
		$poIdCond.=")";
	}
	else
	{
		$poIdCond=" and b.id in($poIdss)";
		
	}*/

	// echo $poIdCond;die();
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 7, $po_id_arr, $empty_arr);//Sales ID Ref from=7
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 8, $trim_batch_IdArr, $empty_arr);//T Batch ID Ref from=8
	 $sql_po="SELECT a.style_ref_no,a.buyer_name,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b ,gbl_temp_engine g  where a.id=b.job_id  and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=7 and g.entry_form=48 and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond ";
	// echo $sql_po;die(); 
	$res_po=sql_select($sql_po);
	$all_po_id='';
	foreach($res_po as $row) //$job_no_arr
	{
		$po_number_arr[$row[csf('id')]]['po_no']=$row[csf('po_number')];
		$po_number_arr[$row[csf('id')]]['ref_no']=$row[csf('ref_no')];
		$po_number_arr[$row[csf('id')]]['file_no']=$row[csf('file_no')]; 
		$po_number_arr[$row[csf('id')]]['season']=$row[csf('season_buyer_wise')]; 
		$po_number_arr[$row[csf('id')]]['job']=$row[csf('job_no_mst')];
		
		$job_no_arr[$row[csf('id')]]=$row[csf('job_no_mst')];
		$style_library[$row[csf('job_no_mst')]]=$row[csf('style_ref_no')];
		
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['buyer']=$row[csf('buyer_name')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['season']=$row[csf('season_buyer_wise')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['style']=$row[csf('style_ref_no')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['po_number'].=$row[csf('po_number')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['ref_no'].=$row[csf('ref_no')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['file_no'].=$row[csf('file_no')].',';
	}
	unset($res_po);
	 $sql_trim_job="SELECT a.style_ref_no,a.buyer_name,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b,pro_batch_create_mst c,gbl_temp_engine g  where a.id=b.job_id and a.job_no=c.job_no and b.job_no_mst=c.job_no  and c.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=8 and g.entry_form=48 and   b.status_active=1 and b.is_deleted=0  and   c.status_active=1 and c.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond   $buyer_id_cond ";
	// echo $sql_po;die(); 
	$res_trimJob=sql_select($sql_trim_job);
	 
	foreach($res_trimJob as $row) //$job_no_arr
	{
		$style_library[$row[csf('job_no_mst')]]=$row[csf('style_ref_no')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['buyer']=$row[csf('buyer_name')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['season']=$row[csf('season_buyer_wise')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['style']=$row[csf('style_ref_no')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['po_number'].=$row[csf('po_number')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['ref_no'].=$row[csf('ref_no')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['file_no'].=$row[csf('file_no')].',';
	}
	unset($res_trimJob);

   $buyer_library=return_library_array( "SELECT id,buyer_name from   lib_buyer", "id","buyer_name" );
   // $batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.mst_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.mst_id", $re_dying_cond);
	$po_data_subcon=sql_select("SELECT a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	subcon_ord_mst c,gbl_temp_engine g where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.mst_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0  ");
	
	$sub_con_arr=array();$sub_party_arr=array(426,439,444,458,425,427,428,443,392,564,565,563); //Omit buyer ids
	foreach($po_data_subcon as $row)
	{
		if($sub_con_arr[$row[csf('mst_id')]][cust_style_ref]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref].=",".$row[csf('cust_style_ref')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref]=$row[csf('cust_style_ref')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][order_no]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no].=",".$row[csf('order_no')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no]=$row[csf('order_no')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][subcon_job]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job].=",".$row[csf('subcon_job')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job]=$row[csf('subcon_job')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][party_id]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id].=",".$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id].=",".$row[csf('party_id')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id]=$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id]=$row[csf('party_id')];	
		}
		$party_id=$row[csf('party_id')];
		if(in_array($party_id,$sub_party_arr) && $row[csf("party_id")]>0)
		{
			$sub_batch_chk_arr[$row[csf("mst_id")]]=$row[csf("party_id")];
		}
	}
	//print_r($sub_con_arr[646]);die;
	// ==================================================================================

	if($db_type==0)
	{
		if($batch_type==3)
		{
		 $sql_redying=sql_select("SELECT b.id as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0 group by  b.id");
		}
		else
		{
			 $sql_redying=sql_select("SELECT group_concat(b.id) as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0  $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0 group by  b.re_dyeing_from");	
		}
	}
	else
	{
	
		if($batch_type==3)
		{	
			//  $sql_redying=sql_select("SELECT b.id as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no
			//   from  pro_batch_create_mst  b 
			//   where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0  group by  b.id");
			   $sql_redying=sql_select("SELECT b.id as id, b.batch_date as batch_date, b.extention_no as extention_no
			   from  pro_batch_create_mst  b ,gbl_temp_engine g
			   where  b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and b.re_dyeing_from!=0 $company_idcond  and b.status_active=1 and b.is_deleted=0  ");
		}
		else
		{
			//  $sql_redying=sql_select("SELECT listagg((b.id),',') within group (order by b.id) as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no,b.re_dyeing_from 
			//  from  pro_batch_create_mst b 
			//  where b.re_dyeing_from!=0   $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0  group by  b.re_dyeing_from");
			 
			 $sql_redying=sql_select("SELECT  b.id as id, b.batch_date as batch_date, b.extention_no as extention_no,b.re_dyeing_from 
			  from  pro_batch_create_mst b ,gbl_temp_engine g
			  where  b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and b.re_dyeing_from!=0   $company_idcond  and b.status_active=1 and b.is_deleted=0  ");
			// echo "select listagg((b.id),',') within group (order by b.id) as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no,b.re_dyeing_from 
			// from  pro_batch_create_mst b 
			// where b.re_dyeing_from!=0   $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0  group by  b.re_dyeing_from";
		}
	}
	
   	//and b.batch_against=2
    $redying_details_arr=array();
    foreach($sql_redying as $re_row)
    {
		if($batch_type==3)
		{
			$redying_details_arr[$re_row[csf("id")]]['id'].=$re_row[csf("id")].",";
			$redying_details_arr[$re_row[csf("id")]]['batch_date'].=$re_row[csf("batch_date")].",";
			$redying_details_arr[$re_row[csf("id")]]['extention_no'].=$re_row[csf("extention_no")].",";
		}
		else
		{
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['id'].=$re_row[csf("id")].",";
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['batch_date'].=$re_row[csf("batch_date")].",";
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['extention_no'].=$re_row[csf("extention_no")].",";
		}
    }
	
	//echo "<pre>"; print_r($redying_details_arr);die;
	// if($batch_type==3)
	// {
	// 	//$all_dying_cond2=" and b.id in(".$batch_id_sql.")";
	// 	if(count($batch_id_arr)>0)
	// 	{
	// 		$all_dying_cond2=" and (";
	// 		if(count($batch_id_arr)>999 && $db_type==2)
	// 		{
	// 			$prod_id_chank=array_chunk($batch_id_arr,999);
	// 			foreach($prod_id_chank as $batch_id)
	// 			{
	// 				$all_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
	// 			}
	// 			$all_dying_cond2=chop($all_dying_cond2,"or");
	// 		}
	// 		else
	// 		{
	// 			//die("with naz");
	// 			$all_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
	// 		}
	// 		$all_dying_cond2.=")";
	// 	}
	// }
	// else
	// {
	// 	if(count($batch_id_arr)>0)
	// 	{
	// 		$all_dying_cond=" and (";
	// 		if(count($batch_id_arr)>999 && $db_type==2)
	// 		{
	// 			$prod_id_chank=array_chunk($batch_id_arr,999);
	// 			foreach($prod_id_chank as $batch_id)
	// 			{
	// 				$all_dying_cond.=" b.id in(".implode(",",$batch_id).") or";
	// 			}
	// 			$all_dying_cond=chop($all_dying_cond,"or");
	// 		}
	// 		else
	// 		{
	// 			//die("with naz");
	// 			$all_dying_cond.=" b.id in(".implode(",",$batch_id_arr).")";
	// 		}
	// 		$all_dying_cond.=")";
	// 	}
	// }
	
	if($batch_type==3)
	{
		$result_sql=sql_select("SELECT a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b,gbl_temp_engine g where b.id=a.batch_id and b.id=g.ref_val and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48  and a.entry_form in (35,38) and a.load_unload_id=2   $company_idcond  and a.status_active=1 and a.is_deleted=0");	
	}
	else
	{
		$result_sql=sql_select("SELECT a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b,gbl_temp_engine g where b.id=a.batch_id and b.id=g.ref_val and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.entry_form in (35,38) and a.load_unload_id=2  $company_idcond  and a.status_active=1 and a.is_deleted=0");
	}
	
	/*$sql_result=sql_select("select a.result,a.batch_id from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2  and a.company_id=$cbo_company_name and b.re_dyeing_from in (".$batch_id_sql.") and a.status_active=1 and a.is_deleted=0");*/
	
	$result_arr=array();
	foreach($result_sql as $value)
	{
		$result_arr[$value[csf('batch_id')]]=$value[csf('result')];	
	}
	// print_r($issue_single_batch_arr); echo "Test";die;
	// ====================================== batch wise cost =====================================
	$batchIdArr = array();
	foreach(array_unique($issue_single_batch_arr) as $b_id)
	{
		$batchIdArr[$b_id] = $b_id;
	}
	// echo "<pre>";print_r($batchIdArr);
	/*$batch_id_list_arr=array_chunk($batchIdArr,999);

    $batchCond = " and ";
    $p=1;
    foreach($batch_id_list_arr as $po_process)
    {
        if($p==1) $batchCond .="  ( c.id in(".implode(',',$po_process).")"; 
        else  $batchCond .=" or c.id in(".implode(',',$po_process).")";        
        
        $p++;
    }
    $batchCond .=")";*/
	//$batchCond=where_con_using_array($batchIdArr,0,"c.id");

	// print_r($batchIdArr);die();
	// echo $company_id;die();
	$company_cond = str_replace("a.company_id", "c.company_id", $company_id);	
	if ($cbo_working_name==0) $wo_company_idcond =""; else $wo_company_idcond =" and p.working_company_id='$cbo_working_name'";
//echo "#aaa";die;
	// $batchCond = implode(",", $batchIdArr);
	   $sql = "(SELECT p.id as recipe_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,a.avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, a.id, a.item_category_id, a.item_group_id, a.sub_group_name, a.item_description, a.item_size,a.current_stock, a.unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
		from pro_recipe_entry_mst p, product_details_master a, pro_recipe_entry_dtls b,pro_batch_create_mst c,gbl_temp_engine g 
		where p.id=b.mst_id and a.id=b.prod_id and p.batch_id=c.id  and c.id=g.ref_val  and p.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and b.ratio>0  and b.status_active=1 and b.is_deleted=0 $company_cond $wo_company_idcond and a.item_category_id in(5,6,7,23) and a.status_active=1 and a.is_deleted=0  and p.entry_form in(59,60)) 
		union 
		(
		SELECT p.id as recipe_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,0 as avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, b.prod_id as id, null as item_category_id, null as item_group_id, null as sub_group_name, null as item_description, null as item_size,null as current_stock, null as unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
			from pro_recipe_entry_mst p, pro_recipe_entry_dtls b,pro_batch_create_mst c,gbl_temp_engine g  
			where p.id=b.mst_id and p.batch_id=c.id and c.id=g.ref_val and p.batch_id=g.ref_val  and p.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and b.status_active=1 and b.is_deleted=0 $wo_company_idcond  and b.status_active=1 and b.is_deleted=0 and b.prod_id=0 and b.sub_process_id in(93,94,95,96,97,98) and p.status_active=1 and p.is_deleted=0  and p.entry_form in(59,60))  order by sub_seq,seq_no";
	 //echo $sql;die();
	$costDataArr = array();
	$res = sql_select($sql);
	$tot_recCost=0;$tot_issue_qty=0;
	foreach ($res as $row) 
	{
		$current_stock = $row[csf('current_stock')];
		$recipe_type = $row[csf('recipe_type')];
		$surplus_solution = $row[csf('surplus_solution')];
		$pickup = $row[csf('pickup')];
		$batch_wgt = $row[csf('batch_qty')];//pickup,p.batch_qty
		$current_stock_check=number_format($current_stock,7,'.','');
		//(Batch weight*Pick Up/100)+Surplus Solution;
		$total_solution=($batch_wgt*$pickup/100)+$surplus_solution;
		
		$ratio = $row[csf('ratio')];
		if ($row[csf('dose_base')] == 1) 
		{
			if ($row[csf('entry_form')] == 60) 
			{ 
				$perc_calculate_qnty = $row[csf('total_liquor_dtls')];

			} 
			else 
			{
				$perc_calculate_qnty = $row[csf('total_liquor_dtls')];
			}

			if($recipe_type==2) //CBP
			{
				$recipe_qnty = ($total_solution * $ratio) / 1000;
			}
			else
			{
				$recipe_qnty = ($perc_calculate_qnty * $ratio) / 1000;
			}
		} 
		else if ($row[csf('dose_base')] == 2) 
		{
			if ($row[csf('entry_form')] == 60) 
			{
				$perc_calculate_qnty = $row[csf('new_batch_weight')];
			} 
			else if ($row[csf('entry_form')] == 59) {
				$perc_calculate_qnty = $row[csf('batch_qty')];
			} 
			else 
			{
				$perc_calculate_qnty = $row[csf('batch_no')];
			}
			if($recipe_type==2) //CBP
			{
				$recipe_qnty = ($total_solution * $ratio) / 1000;
			}
			else
			{
				$recipe_qnty = ($perc_calculate_qnty * $ratio) / 100;
			}
		}
		$batch_req_id=rtrim($batch_req_id_array[$row[csf('batch_id')]],',');
		$batch_req_idArr=array_unique(explode(",",$batch_req_id_array[$row[csf('batch_id')]]));
		//echo $batch_req_id.'D';
		$tot_batch_wgt=$batch_wgt_array[$row[csf('batch_id')]];
		//echo  $tot_batch_wgt.'D';
		$batch_qty=$row[csf('batch_qty')];
		if($issue_item_cat_arr[$row[csf('batch_id')]][$row[csf('prod_id')]][$row[csf('item_category_id')]])
		{
			//echo $recipe_qnty.'='.$row[csf('avg_rate_per_unit')].'<br>';
			//$issue_qty=0;
			foreach($batch_req_idArr as $req_id)
			{
				if($issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=='')
				{	
					$issue_qty+=$issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
					$reqIdArr[$req_id]=$req_id;
					$tot_issue_qty+=$issue_qty;
					$issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=111;
					
				}
				
			}
			//$issue_qty=$issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
			$issue_perKg=($issue_qty/$tot_batch_wgt);
			$issue_wgt_per=$issue_perKg*$batch_qty;
		//	echo $tot_batch_wgt.'='.$issue_qty.'='.$issue_wgt_per.'='.$issue_wgt_per*$row[csf('avg_rate_per_unit')].'<br>';
			
		$costDataArr[$row[csf('batch_id')]][$row[csf('item_category_id')]] +=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
		$ReqIdArr[$row[csf('batch_id')]].=$batch_req_id.','; 
		//$recipe_qnty*$row[csf('avg_rate_per_unit')];
		$categryDataArr[$row[csf('batch_id')]].=$row[csf('item_category_id')].',';
		$tot_recCost+=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
		}
	}
	//echo implode(",",$reqIdArr);die;
	//echo $tot_issue_qty.'Dx'.'='.$tot_recCost;
	// echo "<pre>";print_r($costDataArr);
	$con = connect();
	execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id." and ref_from in (1,2,3,4,5,6,7,8) and ENTRY_FORM=48");
	oci_commit($con);
	disconnect($con);
	$i=1;$j=1;
	ob_start();	
	?>
	<div id="" align="center" style="height:auto; width:auto; margin:0 auto; padding:0;">
		<? $summaryHTML='<div id="summary_part" style="width:1460px;">
        <table width="2060px" cellpadding="0" cellspacing="0" id="caption" align="center">
            <thead>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:16px; font-weight:bold" >'.$report_title.'</td 
                ></tr>
                <tr style="border:none;">
                    <td colspan="24" class="form_caption" align="center" style="border:none; font-size:14px;">
                       <b>Company Name : '.$companyArr[$cbo_company_name].'</b>                               
                    </td>
                </tr>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:12px; font-weight:bold">
					'."Date: ". change_date_format($from_date).' To '. change_date_format($to_date).'
					</td>
                </tr>
            </thead>
        </table>
 		
        <div  align="left" style="font-size:25px">Summary Part</div>
        <table align="left" width="1440" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>

                    <th rowspan="2" width="100">Buyer</th>

                    <th rowspan="2" width="100">Batch Qty (Kg)</th>
                    <th colspan="4" width="">First Dying And Finishing Cost</th>
                    <th colspan="3" width="">Subsequent Dyeing and Finishing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per Kg Cost (Tk)</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>

                    <th width="100">Ttl Chem Cost(Tk)</th>
                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    
                </tr> 
            </thead>
        </table>
        <div style="width:1460px; max-height:400px;  overflow-y:scroll" id="scroll_body_summary">
	        <table align="left" width="1440" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="summary_table_body_id" >
	            <tbody>';
			       	
			       	$tot_main_batch_weight=0;$qty_check_array_sum=array();$zz=1;$sub_buyer_summary_Qty_arr=array();
				//	echo count($issue_single_batch_arr).'=';
				$ttttt=0;
			       	foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						//$fabric_sales_arr[$row[csf("sales_id")]]['buyer_id']=$row[csf("buyer_id")];
						
						
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
							//batch_description_arr
							$sub_batch_buyer=="";
							if($batch_description_arr[$b_id][entry_form]==36)
			                {
			                	$buyerName=implode(", ",array_unique(explode(",",$sub_con_id_arr[$b_id][party_id])));
								
			                }
							else if($batch_description_arr[$b_id][entry_form]==136) //Trims batch
			                {
			                	$job_no=$batch_description_arr[$b_id][job_no];
								$buyerName=$trim_batch_job_arr[$job_no]['buyer'];
								//$po_number=$trim_batch_job_arr[$job_no]['po_number']; 
								//$buyerName=implode(", ",array_unique(explode(",",$sub_con_id_arr[$b_id][party_id])));
			                }
			                else
			                {
				                if($batch_description_arr[$b_id]["without_order"]==1) 
				                $buyerName=$non_buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
				                else $buyerName=$buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
			                }
							//$ttt++;
						
						$sales_order_id= $sales_batch_arr[$b_id];
						$buyer_id=$fabric_sales_arr[$sales_order_id]['buyer_id'];
							if($sales_order_id)
							{
								$buyerName=$buyer_id;	
							}
							else $buyerName=$buyerName;
							
							$sumbatch_noArr=$batch_arr[$b_id];
							if (!in_array($sumbatch_noArr,$qty_check_array_sum))
							{ 
								$zz++;
								$qty_check_array_sum[]=$sumbatch_noArr;
								$tot_batch_weightQty=$batch_description_arr[$b_id]['batch_weight'];
							}
							else
							{
								$tot_batch_weightQty=0;
							}
							
							if($batch_description_arr[$b_id][entry_form]==36)
			                {
								$sub_batch_buyer=$sub_batch_chk_arr[$b_id];
								if($sub_batch_buyer>0)//Subcon buyer Omitted //(426,439,444,458,425,427,428,443,392,564,565,563)
								{
									$sub_buyer_summary_Qty_arr[$buyerName]["sub_batch_qty"]+=$tot_batch_weightQty;
								}
							}
						
							
							//echo $ReqIdArr[$b_id].'FD';
							$ReqId=rtrim($ReqIdArr[$b_id],',');
							$sum_ReqIdsArr=array_unique(explode(",",$ReqId));
							//echo $ReqId.'DS';  
			                $buyer_wise_summary_arr[$buyerName]["buyer"]=$buyerName;
			                $buyer_wise_summary_arr[$buyerName]["batch_qty"]+=$tot_batch_weightQty;//$batch_description_arr[$b_id]["batch_weight"];
							$ttttt+=$tot_batch_weightQty;
			                // echo "$b_id <pre>";print_r($batch_arr);die();
							$re_b_id=rtrim($re_batch_wise_arr[$batch_arr[$b_id]]['batch_id'],',');
							$re_b_idArr=array_unique(explode(",",$re_b_id));
							
							// echo "<pre>";print_r($re_b_idArr);die();
			                $first_chemi_cost=$first_dyeing_cost=0;
			                if($non_reding_batch_id[$b_id]!="")
			                {
			                    $sum_issue_amt_deys=0;$sum_issue_amt_chemical=0;
								$batch_weight=$tot_batch_weightQty;//$batch_description_arr[$b_id]["batch_weight"];
								$sum_batchIdArr='';$tot_sum_chemical_cost=$tot_sum_deys_cost=0;
									foreach($sum_ReqIdsArr as $reqId)
									{
										//$issue_qty+=$issue_item_cat_cost_arr[$req_id][$row[csf('item_category_id')]];
										//$issue_qty+=$issue_item_cat_cost_dtls_arr[$reqId][5]+$issue_item_cat_cost_dtls_arr[$reqId][6]+$issue_item_cat_cost_dtls_arr[$reqId][7];
										//$issue_item_cat_amt_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]
										$sum_issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										$sum_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
										//$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']];
										//echo $reqId.'D=';
										
									   $batch_idsAll=$ReqBatch_id_arr[$reqId]; 
										//$sum_batchIdArr.=$batch_idsAll.',';
										
										$sum_batchIds=rtrim($batch_idsAll,',');
										$sumbatIdArr=array_unique(explode(",",$sum_batchIds)); 
										$sum_tot_batch_wgt=0;
										foreach($sumbatIdArr as $batchId)
										{
										//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
										//echo $batch_wgt_arr[$batchId]['batchWgt'].'p';
										$sum_tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt']; 
										}
										if($sum_issue_amt_chemical>0)
										{
										$tot_sum_chemical_cost+=($sum_issue_amt_chemical/$sum_tot_batch_wgt)*$batch_weight;
										}
										if($sum_issue_amt_deys>0)
										{
										$tot_sum_deys_cost+=($sum_issue_amt_deys/$sum_tot_batch_wgt)*$batch_weight;
										}
										
									}
									//echo  $sum_batchIdArr.'X=';
									    
									
									if($tot_sum_chemical_cost)
									{
									//$issue_amt_perKg_chemical=($sum_issue_amt_chemical/$sum_tot_batch_wgt);
									$summissue_amt_cal_chemical=$tot_sum_chemical_cost;
									}
									else
									 {$summissue_amt_cal_chemical=0;}
									//echo $sum_issue_amt_chemical.'='.$sum_tot_batch_wgt.'='.$batch_weight.',';
									if($tot_sum_deys_cost)
									{
									//$sum_issue_amt_perKg_dyes=($sum_issue_amt_deys/$sum_tot_batch_wgt);
									$sum_issue_amt_cal_dyes=$tot_sum_deys_cost;
									} 
									else
									{$sum_issue_amt_cal_dyes=0;}
									
								$first_chemi_cost=$summissue_amt_cal_chemical;//$costDataArr[$b_id][5]+$costDataArr[$b_id][7];
			                    $buyer_wise_summary_arr[$buyerName]["first_chemi_cost"]+=$first_chemi_cost;

			                    $first_dyeing_cost=$sum_issue_amt_cal_dyes;//$costDataArr[$b_id][6];
			                    $buyer_wise_summary_arr[$buyerName]["first_dyeing_cost"]+=$first_dyeing_cost;
								$tot_main_batch_weight=$tot_batch_weightQty;
								$buyer_wise_summary_arr[$buyerName]["tot_main_batch_weight"]+=$tot_main_batch_weight;
								// echo $first_dyeing_cost."<br>";
			                }
			                $buyer_wise_summary_arr[$buyerName]["cost_per_kg"]+=($tot_batch_weightQty>0) ? ($first_chemi_cost+$first_dyeing_cost)/$tot_batch_weightQty : 0;

			                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
			                //if($reding_batch_id[$b_id]!="")
						   $sum_extention_no=$batch_ext_wise_arr[$b_id]['extention_no'];
							if($sum_extention_no>0)
							{
								 //echo $b_id.",";
							//foreach($re_b_idArr as $re_b_id)
			                //{
								$re_batch_weight=$tot_batch_weightQty;//$batch_description_arr[$b_id]["batch_weight"];
			                   $tot_re_sum_issue_amt_chemical=$tot_re_sum_issue_amt_deys=0;$re_sum_batchIdArr='';
							   $re_sum_issue_amt_chemical=$re_sum_issue_amt_deys=0;
							    foreach($sum_ReqIdsArr as $reqId)
									{
									
										$re_sum_issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										//$re_sum_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
										$re_sum_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
										 
										 $batch_idsAll=$ReqBatch_id_arr[$reqId]; 
										//$re_sum_batchIdArr.=$batch_idsAll.',';
										
										 $re_sum_batchIds=rtrim($batch_idsAll,',');
										$ResumbatIdArr=array_unique(explode(",",$re_sum_batchIds)); 
										$Resum_tot_batch_wgt=0;
										foreach($ResumbatIdArr as $batchId)
										{
										//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
										//echo $batch_wgt_arr[$batchId]['batchWgt'].'p';
										$Resum_tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt']; 
										}
										
										if($re_sum_issue_amt_chemical)
										{	
										//$re_issue_amt_perKg_chemical=($re_sum_issue_amt_chemical/$Resum_tot_batch_wgt);
										//$re_issue_amt_cal_chemical+=$re_issue_amt_perKg_chemical*$re_batch_weight;
										$tot_re_sum_issue_amt_chemical+= (($re_sum_issue_amt_chemical/$Resum_tot_batch_wgt)*$re_batch_weight);
										
										}
										//else{$re_issue_amt_cal_chemical=0;}
										
										if($re_sum_issue_amt_deys)
										{
										//$re_issue_amt_perKg_dyes=($re_sum_issue_amt_deys/$Resum_tot_batch_wgt);
										//$re_issue_amt_cal_dyes=$re_issue_amt_perKg_dyes*$re_batch_weight;
										if($sum_extention_no==2)
										{
											// echo $re_sum_issue_amt_deys.'/'.$Resum_tot_batch_wgt.'*'.$re_batch_weight.'<br>';;
										}
										$tot_re_sum_issue_amt_deys+= (($re_sum_issue_amt_deys/$Resum_tot_batch_wgt)*$re_batch_weight);
										//echo $reqId.'d';
										// echo $re_sum_issue_amt_deys.'/'.$Resum_tot_batch_wgt.'*'.$re_batch_weight.'<br>';;
										}
										//else{$re_issue_amt_cal_dyes=0;}
										
									}
									
									$re_issue_amt_cal_chemical_tot=$tot_re_sum_issue_amt_chemical;
									$re_issue_amt_cal_dyes_tot=$tot_re_sum_issue_amt_deys;
									//echo $Resum_tot_batch_wgt.'='.$batch_weight.'='.$re_sum_issue_amt_chemical.',';;
									
									
								$re_dying_chemical_cost=$re_issue_amt_cal_chemical_tot;//$costDataArr[$re_b_id][5]+$costDataArr[$re_b_id][7];
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_chemical_cost"]+=$re_dying_chemical_cost;

			                    $re_dying_dyes_cost=$re_issue_amt_cal_dyes_tot;//$costDataArr[$re_b_id][6];	
								
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_dyes_cost"]+=$re_dying_dyes_cost;

			                    $re_dying_dyes_chemical_cost=$re_issue_amt_cal_chemical_tot+$re_issue_amt_cal_dyes_tot;
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_dyes_chemical_cost"]+=$re_dying_dyes_chemical_cost;
			                //}
						}
			                $buyer_wise_summary_arr[$buyerName]["re_dye_cost_per_kg"]+=($tot_batch_weightQty>0) ? $re_dying_dyes_chemical_cost/$tot_batch_weightQty: 0;

			                $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
			                $buyer_wise_summary_arr[$buyerName]["total_per_kg_cost"]+=($tot_batch_weightQty>0) ? ($first_chemi_cost+$first_dyeing_cost)/$tot_batch_weightQty : 0;

			                //$buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price)/$buyer["batch_qty"]
						}	
					}
				 //	echo $ttttt.'========';
					
				    // echo "<pre>";print_r($sub_buyer_summary_Qty_arr);
					$tot_sub_buyer_qty_omit=0;
					foreach($buyer_wise_summary_arr as $buyer_id=>$buyer) 
					{
						if($j%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
						$sub_buyer_qty_omit=0;
						$sub_buyer_qty_omit=$sub_buyer_summary_Qty_arr[$buyer_id]["sub_batch_qty"];
						$tot_sub_buyer_qty_omit+=$sub_buyer_qty_omit; 
						
			            $summaryHTML.='<tr bgcolor="'.$bgcolor.'">
			                <td width="30">'.$j.'</td>

				            <td width="100"><p>'.$buyer_library[$buyer_id].'</p></td>

			                <td width="100" align="right" align="right" title='.$sub_buyer_qty_omit.'><p>'.fn_number_format($buyer["batch_qty"],4,".","").'</p></td>


			                <td width="100" align="right"><p>'.fn_number_format($buyer["first_chemi_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.fn_number_format($buyer["first_dyeing_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>';
			                $summary_batch_chemical_price=$buyer["first_chemi_cost"]+$buyer["first_dyeing_cost"];
							$tot_summ_cost=$buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price;
			                $summaryHTML.=fn_number_format($summary_batch_chemical_price,4,".","").'</p></td>
			                <td width="100" align="right"><p>
			                '.fn_number_format($summary_batch_chemical_price/$buyer["batch_qty"],4,".","").' 
			                </p></td>

								
			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_chemical_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_dyes_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_dyes_chemical_cost"],4,".","").'</p></td>
			               


			                <td width="100" align="right">'.number_format($buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price,4,".","").'</td>
			                <td width="100" align="right">
			                '.fn_number_format($tot_summ_cost/$buyer["batch_qty"],4,".","").'
			                </td>
			            </tr>';
						$summary_total_batch_weight+=$buyer["batch_qty"];
						$summary_total_chemical_cost+=$buyer["first_chemi_cost"];
						$summary_total_dyes_cost+=$buyer["first_dyeing_cost"];
						$summary_total_batch_chemical_price+=$summary_batch_chemical_price;
						$summary_tot_total_receive+=$totalReceive;
						$summary_tot_re_dying_chemical_cost+=$buyer["re_dying_chemical_cost"];
						$summary_tot_re_dying_dyes_cost+=$buyer["re_dying_dyes_cost"];
						$summary_tot_re_dying_dyes_chemical_cost+=$buyer["re_dying_dyes_chemical_cost"];
						$summary_cost_per_kg+=$buyer["cost_per_kg"];
						$summary_total_per_kg_cost+=$buyer["total_per_kg_cost"];
						$j++;
					}
					?>
	            <? $summaryHTML.='</tbody>
	      	</table>
      	</div>
       	<table align="left" width="1440" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="summary_table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="100" align="right">&nbsp;Total</th>
                    <th width="100" id="value_total_batch_weight_summary" title='.$tot_sub_buyer_qty_omit.'>'.number_format($summary_total_batch_weight-$tot_sub_buyer_qty_omit,4).'</th>

                	<th width="100" align="right" id="value_total_chemical_cost_summary">'.number_format($summary_total_chemical_cost,4).'</th>
                	<th width="100" align="right" id="value_total_dyeing_cost_summary">'.number_format($summary_total_dyes_cost,4).'</th>
                    <th width="100" align="right" id="value_total_chemical_price_summary">'.number_format($summary_total_batch_chemical_price,4).'</th>
                    <th width="100" align="right" id="value_total_cost_per_kg_summary">'.fn_number_format($summary_total_batch_chemical_price/$summary_total_batch_weight,4).'</th>

                    <th width="100" align="right" id="value_total_redying_chemic_oost_summary">'.number_format($summary_tot_re_dying_chemical_cost,4).'</th>
                    <th width="100" align="right" id="value_total_redying_dying_cost_summary"><p>'.number_format($summary_tot_re_dying_dyes_cost,4).'</p></th>
                    <th width="100" align="right" id="value_total_redying_all_cost_summary"><p>'.number_format($summary_tot_re_dying_dyes_chemical_cost,4).'</p></th>
                    
                    
                    <th width="100" align="right" id="value_total_total_cost_summary">'.number_format($summary_total_batch_chemical_price+$summary_tot_re_dying_dyes_chemical_cost,4).'</th>
                    <th width="100" align="right" id="value_total_total_per_kg_cost_summary" title="">'.fn_number_format(($summary_total_batch_chemical_price+$summary_tot_re_dying_dyes_chemical_cost)/$summary_total_batch_weight,4).'</th>
                </tr>
            </tfoot>
        </table>
    	</div>';?>
    <? echo $summaryHTML;?>

 	<div>
        <div  align="left" style="font-size:20px">Details</div>
        <table width="2880" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>
                    <th rowspan="2" width="80">Date</th>
                    <th rowspan="2" width="100">Machine No</th>
                    <th rowspan="2" width="100">Batch No</th>
                    <th rowspan="2" width="80">File No</th>
                    <th rowspan="2" width="80">Ref. No</th>
                    <th rowspan="2" width="100">Floor Name</th>
                    <th rowspan="2" width="100">Buyer</th>
                    <th rowspan="2" width="100">Booking No</th>
                    <th rowspan="2" width="100">Job no</th>
                    <th rowspan="2" width="80">Season</th>                  
                    <th rowspan="2" width="100">Style</th>
                   
                    <th rowspan="2" width="100">Color Name</th>
                    <th rowspan="2" width="100">Color Range</th>
                    <th rowspan="2" width="100">Fabric Type </th>
                    <th rowspan="2" width="100">Batch Qty (Kg)</th>
                    <th colspan="4"  width="">First Dying And Finishing Cost</th>
                    <th colspan="6" width="">Subsequent Dyeing and Finishing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per Kg Cost (Tk)</th>
                    <th rowspan="2" width="">Result</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>
                    <th width="100">Extention Batch Date</th>
                    <th width="70">Extention No</th>
                    <th width="100">Floor Name</th>
                    <th width="100">Ttl Chem Cost(Tk)</th>
                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    
                </tr> 
            </thead>
        </table>
        <div style="width:2900px; max-height:400px;  overflow-y:scroll" id="scroll_body">
	        <table width="2880" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_id" >
	            <tbody>
			       	<?
				    // echo "<pre>";print_r($issue_single_batch_arr);die;
					$tot_main_batch_weight=0;$qty_check_array=array();$z=1;$total_tot_batch_weight=$sub_buyer_grnd_tot_batchQty=0;
					foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
						
							if($i%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
							$all_po_id=explode(",",$po_break_down_id_arr[$batch_description_arr[$b_id]['booking_no']]); 
							//print_r($all_po_id);
							$ReqId=rtrim($ReqIdArr[$b_id],',');
							$ReqIds=implode(", ",array_unique(explode(",",$ReqId)));
							$ReqIdsArr=array_unique(explode(",",$ReqId));
							
							
							
							if($batch_description_arr[$b_id][entry_form]!=136)
							{
							$po_number_data="";
							$job_no_data="";$file_no="";$ref_no="";
							foreach($all_po_id as $p_id) // $po_number_arr[$row[csf('id')]]['po_no']
							{
								//echo $p_id.'d';
								if($po_number_data!="") $po_number_data.=",".$po_number_arr[$p_id]['po_no'];	 else $po_number_data=$po_number_arr[$p_id]['po_no'];
								if($job_no_data!="") $job_no_data.=",".$po_number_arr[$p_id]['job'];	
								 else $job_no_data=$po_number_arr[$p_id]['job'];
								if($season_data!="") $season_data.=",".$season_name_arr[$po_number_arr[$p_id]['season']];	 else $season_data=$season_name_arr[$po_number_arr[$p_id]['season']];
								if($file_no!="") $file_no.=",".$po_number_arr[$p_id]['file_no'];	 else $file_no=$po_number_arr[$p_id]['file_no'];
								if($ref_no!="") $ref_no.=",".$po_number_arr[$p_id]['ref_no'];	 else $ref_no=$po_number_arr[$p_id]['ref_no'];
							}
							$file_cond=implode(", ",array_unique(explode(",",$file_no)));
							$ref_cond=implode(", ",array_unique(explode(",",$ref_no))); 
							}
							//$categrybatch=rtrim($categryDataArr[$b_id][$row[csf('item_category_id')]],',');
						//$categryId=implode(", ",array_unique(explode(",",$categrybatch)));
							//echo $po_number_data.'XX';;
							$color_range_id=$batch_description_arr[$b_id]['color_range'];
							
							if($batch_description_arr[$b_id]['without_order']==1 && $ref_cond=="")
							{
							$ref_cond=$sample_booking_ref_no_arr[$batch_description_arr[$b_id]['booking_no']];
							}
							
							$re_b_id=rtrim($re_batch_wise_arr[$batch_arr[$b_id]]['batch_id'],',');
							$re_b_idArr=array_unique(explode(",",$re_b_id));
							//echo $re_b_id.'======';
							$re_b_ids=implode(",",array_unique(explode(",",$re_b_id)));
							$extention_noData=rtrim($batch_wise_arr[$batch_arr[$b_id]]['extention_no'],',');
							$extention_noArr=array_unique(explode(",",$extention_noData));
							$extention_no=$batch_ext_wise_arr[$b_id]['extention_no'];
							$ext_batch_date=$batch_ext_wise_arr[$b_id]['batch_date'];;
							if($re_b_ids) $re_b_idsCond.=",".$re_b_ids;else $re_b_idsCond="";
							if($batch_description_arr[$b_id][entry_form]==136)
							{
								 $job_no=$batch_description_arr[$b_id][job_no];
								 $ref_noArr=rtrim($trim_batch_job_arr[$job_no]['ref_no'],','); 
								 $file_noArr=rtrim($trim_batch_job_arr[$job_no]['file_no'],',');
								  $ref_cond=implode(",",array_unique(explode(",",$ref_noArr))); 
								  $file_cond=implode(",",array_unique(explode(",",$file_noArr))); 
									 
								//$file_cond=$file_cond;
								//$ref_cond=$ref_cond;
							}
							else
							{
								$file_cond=$file_cond;$ref_cond=$ref_cond;
							}
							
							$batch_noArr=$batch_arr[$b_id];
							if (!in_array($batch_noArr,$qty_check_array))
							{ 
								$z++;
								$qty_check_array[]=$batch_noArr;
								$tot_batch_weight=$batch_description_arr[$b_id]['batch_weight'];
							}
							else
							{
								$tot_batch_weight=0;
							}
							
							 
							
							
							//echo $batch_weight.'='.$issue_amt.'='.$issue_qty;
			
							
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="30"><? echo $i; ?></td>								
				                <td width="80"><? echo change_date_format($batch_description_arr[$b_id]['batch_date']); ?></td>
				                <td width="100"><p><? echo $machine_name_arr[$b_id]; ?></p></td>                                 
				                <td width="100" title="BatchId=<? echo $b_id;?>"><p>
                                <A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','batch_wise_subprocess_fabrics_dtls_popup2','<? echo $ReqIds; ?>',1)"> <? echo $batch_arr[$b_id]; ?> </A>
                               <? //echo $batch_arr[$b_id]; ?></p></td>
				                <td width="80"><p><? echo $file_cond; ?></p></td>
				                <td width="80" title="PO/Sample Ref no"><p><? echo $ref_cond; ?></p></td>
				                <td width="100"><p><? echo $floor_arr[$b_id]; ?></p></td> 
				                <?
								$sub_batch_buyer="";
				                if($batch_description_arr[$b_id][entry_form]==36)
				                {
									
									 $sub_batch_buyer=$sub_batch_chk_arr[$b_id];
									if($sub_batch_buyer>0)//Subcon buyer Omitted //(426,439,444,458,425,427,428,443,392,564,565,563)
									{
										$sub_buyer_grnd_tot_batchQty+=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
									}
					              
									?>
					                <td width="100"><p style="word-break:break-all"><? echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][party_id]))); ?></p></td> 
					                <td width="100"><p><? // echo $b_id; ?></p></td>
					                <td width="100" align="center"><p style="word-break:break-all">
					                <? 
				                     echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                 <td width="80" align="center"><p>
					                <? 
				                     //echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                <td width="100" align="center"><p style="word-break:break-all"> <? echo   implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][cust_style_ref]))); ?></p></td>
					                
				                	<?
				                }
								else if($batch_description_arr[$b_id][entry_form]==136)
				                {
					               $job_no=$batch_description_arr[$b_id][job_no]; 
								   $season_data=$season_name_arr[$trim_batch_job_arr[$job_no]['season']];//season_name_arr
								   $buyerName=$buyer_library[$trim_batch_job_arr[$job_no]['buyer']]; 
								//   $trim_batch_job_arr[$row[csf('job_no_mst')]]['buyer'];
								   $po_number_data=rtrim($trim_batch_job_arr[$job_no]['po_number'],','); 
								    $ref_noArr=rtrim($trim_batch_job_arr[$job_no]['ref_no'],','); 
									 $file_noArr=rtrim($trim_batch_job_arr[$job_no]['file_no'],','); 
									?>
					               <td width="100" title="BuyerID=<?=$trim_batch_job_arr[$job_no]['buyer'];?>"><p><? 
					                 
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
					                <td width="100"><p><? //echo $batch_description_arr[$b_id]['booking_no']; ?></p></td>
					                <td width="100" align="center"><div style="word-break:break-all">
					                <?
					                echo $job_no;
					                ?></div></td>
					                <td width="80" align="center"><div style="word-break:break-all">
					                <? 
					                
					                echo $season_data;

					                ?></div></td>
					                <td width="100" align="center"><div style="word-break:break-all"> 
					                <? 
					                $style_no=$style_library[$job_no];
					                echo $style_no; ?></div></td>
					                
				                	<?
				                }
				                else
				                {
					                ?>
					                <td width="100"><p style="word-break:break-all"><? 
					                if($batch_description_arr[$b_id]['without_order']==1) $buyerName=$non_buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];else $buyerName=$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];
									$sales_order_id= $sales_batch_arr[$b_id];
									$buyer_id=$fabric_sales_arr[$sales_order_id]['buyer_id'];
										if($sales_order_id && $buyerName=='')
										{
											$buyerName='';//buyer_arr
											$buyerName=$buyer_library[$buyer_id];
											//echo "DDDD";	
										}
										else $buyerName=$buyerName;
							
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
					                <td width="100"><p style="word-break:break-all"><? echo $batch_description_arr[$b_id]['booking_no']; ?></p></td>
					                <td width="100" align="center"><div style="word-break:break-all">
					                <?
					                echo implode(", ",array_unique(explode(",",$job_no_data)));
					                ?></div></td>
					                <td width="80" align="center"><div style="word-break:break-all">
					                <? 
					                
					                echo implode(", ",array_unique(explode(",",$season_data)));

					                ?></div></td>
					                <td width="100" align="center"><div style="word-break:break-all"> 
					                <? 
					                $style_no=array();
					                foreach(array_unique(explode(",",$job_no_data)) as $j_no)
					                {
					                    if($style_no!="")  $style_no[]=$style_library[$j_no];
					                }
					                echo implode(", ",array_unique($style_no)); ?></div></td>
					                
                                   
					                <?	
				                }
				                ?>
				                <td width="100" align="center"><div style="word-break:break-all"><? echo $color_arr[$batch_description_arr[$b_id]['color_id']]; ?></div></td> 
				                <td width="100" align="center"><p style="word-break:break-all"><? echo $color_range[$color_range_id]; ?></p></td> 
				                <td width="100" align="center"><p style="word-break:break-all"><? echo $fabric_type_for_dyeing[$fabric_type_arr[$b_id]['fabric_type']]; //$fabric_type_for_dyeing?></p></td> 
				                <td width="100" align="right"><p>
				                <? echo number_format($tot_batch_weight,4); 
								
								//$total_batch_weight+=$batch_description_arr[$b_id]['batch_weight'];
								$total_batch_weight+=$tot_batch_weight;//tot_batch_weight
								
								?>
				                </p></td> 
				                <?
				                $batch_weight=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
				                $first_chemi_cost=$first_dyeing_cost=0;
				                if($non_reding_batch_id[$b_id]!="")
				                {
				                    
									$issue_amt_deys=0;$issue_amt_chemical=$totalcost=0;
									$batchIdArr="";$tot_chemicalCost=$tot_dyesCost=0;
									foreach($ReqIdsArr as $reqId)
									{
										//$batch_id=rtrim($batchWgtChkk[$reqId],',');
										//$issue_item_cat_amt_dtls_arr2[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']];
										
										//$val['CONS_AMOUNT']/$batch_wgt_cal;
										
										$issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										$issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
									
									    $batch_ids=$ReqBatch_id_arr[$reqId]; 
										$batIdArr=array_unique(explode(",",$batch_ids)); 
										$tot_batch_wgt=0;
									    //print_r($batIdArr);
										foreach($batIdArr as $batchId)
										{
											$tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt'];
										}
										// echo $reqId.'='.$totalcost = ((($issue_amt_chemical+$issue_amt_deys)/$tot_batch_wgt)*$batch_weight)."<br />";
										 //$ref_cond=implode(",",array_unique(explode(",",$ref_noArr))); 
										//$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']];;
										if($issue_amt_chemical>0)
										{
										$tot_chemicalCost+= (($issue_amt_chemical/$tot_batch_wgt)*$batch_weight);
										}
										if($issue_amt_deys>0)
										{
										$tot_dyesCost+= (($issue_amt_deys/$tot_batch_wgt)*$batch_weight);
										}
									}
									
									
									
									//echo $totalcost.'D';									
								 
										
										//echo $issue_amt_chemical.'='.$batch_weight.'='.$tot_batch_wgt.',';
									
									 // echo $tot_batch_wgt.','; 
									if($tot_chemicalCost)
									{
									//$issue_amt_perKg_chemical=($issue_amt_chemical/$tot_batch_wgt);
									$issue_amt_cal_chemical=$tot_chemicalCost;//$issue_amt_perKg_chemical*$batch_weight;
									//echo $issue_amt_cal_chemical.'D'; 
									} 
									else 
									{ $issue_amt_cal_chemical=0;}
									
									if($tot_dyesCost)
									{
									//$issue_amt_perKg_dyes=($issue_amt_deys/$tot_batch_wgt);
									$issue_amt_cal_dyes=$tot_dyesCost;
									}
									else {$issue_amt_cal_dyes=0;}
									
				                    $first_chemi_cost=$issue_amt_cal_chemical;//$costDataArr[$b_id][5]+$costDataArr[$b_id][7];
				                    $first_dyeing_cost=$issue_amt_cal_dyes;//$costDataArr[$b_id][6];
									
									$tot_main_batch_weight+=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
				                }
				                
				                ?>
				                <td width="100" align="right" title="BatchId=<? echo $b_id;?>"><p>
				                <?
				                 echo number_format($first_chemi_cost,4,".",""); 
				                 $total_chemical_cost+=$first_chemi_cost;
				                 ?>
				                </p></td>
				                <td width="100" align="right"><p>
				                <?  
				                    echo number_format($first_dyeing_cost,4,".",""); 
				                    $total_dyes_cost+=$first_dyeing_cost; 
				                ?>
				                </p></td>
				                <td width="100" align="right"  title="ReqId=<? echo $ReqIds;?>"><p><A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','1st_chemi_dyes_batch_dtls_popup','<? echo $ReqIds; ?>',2)">
				                <?
				                 $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
				                  echo number_format($batch_chemical_price,4,".","");
				                  $total_batch_chemical_price+=$batch_chemical_price;
				                ?>
				                </A></p></td>
				                <td width="100" align="right"><p><? echo number_format(($tot_batch_weight>0) ? $batch_chemical_price/$tot_batch_weight : 0,4,".",""); $tot_total_receive+=$totalReceive; ?></p></td>
				                <td width="100" align="right"><p>
				                <? 
				                $extension_no="";
				                $re_batch_date="";
				                $batch_date=explode(",", $redying_details_arr[$b_id]['batch_date']);	
				               
				                echo change_date_format($ext_batch_date);
				                 ?></p></td>
				                <td width="70" title="BatchId=<? echo $b_id;?>" align="right"><p>
				                <?		                
				                //echo $redying_details_arr[$b_id]['id'].jahid;
								
				                if(trim($redying_details_arr[$b_id]['id']))
				                {
				                    $re_dying_id_all=array_unique(explode(",",$redying_details_arr[$b_id]['id']));
				                    //$re_dying_chemical_cost=0;
				                    //$re_dying_dyes_cost=0;
				                    //$re_dying_dyes_chemical_cost=0;
				                    
				                    $result_id="";
				                    $result_id_last='';
				                    
				                    foreach($re_dying_id_all as $ash_id)
				                    {
				                    //$re_dying_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                    //$re_dying_dyes_cost+=$dyes_chemical_arr[$ash_id][6]['chemical_cost']	;	
				                    //$re_dying_dyes_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][6]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                        
				                     if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                     //if($re_floor!="") $re_floor.=",".$floor_arr[$ash_id]; else $re_floor=$floor_arr[$ash_id];
				                    /* echo $ash_id.tipu;
				                     $result_id=$result_arr[$ash_id];
				                     if($result_id!="")  $result_id_last=$result_id;*/
				                    }
				                }
				                //echo $b_id;
				                //if($batch_type==3)
				                //{
				                echo $extention_no;	 ?>
				                
				                
				                </p></td>
				                <td width="100" align="right"><p><?
				                $re_floors='';
				                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
				                //print_r($reding_batch_id);//echo $reding_batch_id[$b_id]."##".$b_id;
				               // if($reding_batch_id[$b_id]!="")
							   	foreach($re_b_idArr as $re_bid)
				                {
				                    $re_floors=$floor_arr[$re_bid];
				                    /*$re_dying_chemical_cost+=$costDataArr[$re_bid][5]+$costDataArr[$re_bid][7];
				                    $re_dying_dyes_cost+=$costDataArr[$re_bid][6]	;	
				                    $re_dying_dyes_chemical_cost+=$costDataArr[$re_bid][5]+$costDataArr[$re_bid][6]+$costDataArr[$re_bid][7];*/
				                }
								//echo $extention_no.'D=';
								$re_tot_chemicalCost=0; 
								if($extention_no>0)
								{
									$re_batch_weight=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
									
									$re_issue_amt_deys=0;$re_issue_amt_chemical=0;$re_tot_dyesCost=0;
									$rebatchIdArr="";
									foreach($ReqIdsArr as $reqId)
									{
										//$issue_qty+=$issue_item_cat_cost_arr[$req_id][$row[csf('item_category_id')]];
										//$issue_qty+=$issue_item_cat_cost_dtls_arr[$reqId][5]+$issue_item_cat_cost_dtls_arr[$reqId][6]+$issue_item_cat_cost_dtls_arr[$reqId][7];
										//$issue_item_cat_amt_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]
										$re_issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										$re_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
										
										 $batch_ids=$ReqBatch_id_arr[$reqId]; 
										//$rebatchIdArr.=$batch_ids.',';
										//echo $batch_ids.'DSSSSSSSSS';
										//$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']];
										
										
										$batchIds=rtrim($batch_ids,',');
										$rebatchIdArr=array_unique(explode(",",$batchIds)); 
										$re_tot_batch_wgt=0;
										foreach($rebatchIdArr as $rebatchId)
										{
											//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
												$re_tot_batch_wgt+=$batch_wgt_arr[$rebatchId]['batchWgt']; 
										}
										if($re_issue_amt_chemical>0)
										{
										$re_tot_chemicalCost+= (($re_issue_amt_chemical/$re_tot_batch_wgt)*$re_batch_weight);
										}
										if($re_issue_amt_deys>0)
										{
											//echo $b_id.'='.($re_issue_amt_deys/$re_tot_batch_wgt)*$batch_weight.'<br>';
										$re_tot_dyesCost+= (($re_issue_amt_deys/$re_tot_batch_wgt)*$re_batch_weight);
										}
										
									}
									
									
									
										//echo $re_issue_amt_chemical.'='.$re_tot_batch_wgt.'='.$batch_weight.',';
										
									if($re_tot_chemicalCost)
									{
									//$re_issue_amt_perKg_chemical=($re_issue_amt_chemical/$re_tot_batch_wgt);
									$re_issue_amt_cal_chemical=$re_tot_chemicalCost;
									}
									else 
									{$re_issue_amt_cal_chemical=0;}
									
									if($re_tot_dyesCost)
									{
									//$re_issue_amt_perKg_dyes=($re_issue_amt_deys/$re_tot_batch_wgt);
									$re_issue_amt_cal_dyes=$re_tot_dyesCost;
									}
									else
									{
										$re_issue_amt_cal_dyes=0;
									}
									
									$re_dying_chemical_cost=$re_issue_amt_cal_chemical;//$costDataArr[$re_bid][5]+$costDataArr[$re_bid][7];
				                    $re_dying_dyes_cost=$re_issue_amt_cal_dyes;//$costDataArr[$re_bid][6]	;	
				                    $re_dying_dyes_chemical_cost=$re_dying_chemical_cost+$re_issue_amt_cal_dyes;//$costDataArr[$re_bid][5]+$costDataArr[$re_bid][6]+$costDataArr[$re_bid][7];
								}
				                
				                echo $re_floors;
				                ?></p></td>
				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($re_dying_chemical_cost,4,".",""); 
				                 $tot_re_dying_chemical_cost+=$re_dying_chemical_cost;
				                 ?>
				                 </p></td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_dyes_cost,4,".",""); $tot_re_dying_dyes_cost+=$re_dying_dyes_cost;  ?></p></td>
				                <td width="100" align="right" title="ReqId=<? echo $ReqIds;?>"><A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','1st_chemi_dyes_batch_dtls_popup','<? echo $ReqIds; ?>',2)"><p><? echo number_format($re_dying_dyes_chemical_cost,4,".",""); $tot_re_dying_dyes_chemical_cost+=$re_dying_dyes_chemical_cost; ?></p></A></td>
				                 
				                

				                <td width="100" align="right"><? echo number_format($re_dying_dyes_chemical_cost+$batch_chemical_price,4,".",""); ?></td>
				                <td width="100" align="right" title="<? echo '('.$re_dying_dyes_chemical_cost.'+'.$batch_chemical_price.')/'.$tot_batch_weight; ?>"><?
				                 echo number_format( ($tot_batch_weight) ? ($re_dying_dyes_chemical_cost+$batch_chemical_price)/$tot_batch_weight : 0,4,".","");  ?></td>
				                <td width="" align="center" title="<? echo $b_id; ?>"><? //echo $unload_result_arr[$b_id]//echo  $dyeing_result[$result_id];//
				                //echo $b_id.tipu;
			                    $result_id=$result_arr[$b_id];
			                    if($result_id!="")  $result_id_last=$result_id;
				                echo $dyeing_result[$result_id];//$dyeing_result;//$daysOnHand; ?></td>
				            </tr>
							<? 	
						//	$total_tot_batch_weight+=$tot_batch_weight;											
							$i++; 			
						}	
					}
					?>
	            </tbody>
	      	</table>
      	</div>
       	<table width="2880" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="80">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                     <th width="80">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                  
                    <th width="100">&nbsp;</th>
                    <th width="100"><? //echo number_format($total_batch_chemical_price,4).'='.$total_dyes_cost; ?></th>
                	<th width="100">Total</th>
                    <th width="100"  title="<? echo $sub_buyer_grnd_tot_batchQty.'='.$total_tot_batch_weight;?>">
					<? echo number_format($total_batch_weight-$sub_buyer_grnd_tot_batchQty,4); ?></th>
                	<th width="100" id="value_total_chemical_cost_single"><? echo number_format($total_chemical_cost,4); ?></th>
                	<th width="100" id="value_total_dyeing_cost_single"><? echo number_format($total_dyes_cost,4); ?></th>
                    <th width="100" id="value_total_chemical_price_single"><? echo number_format($total_batch_chemical_price,4); ?></th>
                    <th width="100" id=""><? echo number_format(($total_batch_chemical_price)/$total_batch_weight,4); ?></th>
                    <th width="100"><? //echo number_format($tot_re_dying_chemical_cost,3); ?></th>
                    <th width="70"><? //echo number_format($tot_rec_return,3); ?></th>
                    <th width="100"><? //echo number_format($tot_total_issue,3); ?></th>
                    <th width="100" id="value_total_redying_chemic_oost_single"><? echo number_format($tot_re_dying_chemical_cost,4); ?></th>
                    <th width="100" id="value_total_redying_dying_cost_single"><p><? echo number_format($tot_re_dying_dyes_cost,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single"><p><? echo number_format($tot_re_dying_dyes_chemical_cost,4); ?></p></th>
                    <!--<th width="100" id=""><? //echo number_format($tot_re_dying_dyes_chemical_cost/$total_batch_weight,4); ?></th>-->
                    <th width="100" id="value_total_total_cost_single"><? echo number_format($total_batch_chemical_price+$tot_re_dying_dyes_chemical_cost,4); ?></th>
                    <th width="100" id="" title="Main Batch Qty=<? echo number_format($tot_main_batch_weight,2);?>"><? echo number_format(($total_batch_chemical_price+$tot_re_dying_dyes_chemical_cost)/$total_batch_weight,4); ?></th>
                    <th width="">&nbsp;</th>
                </tr>
            </tfoot>
        </table>
    </div>
    <?
    $html = ob_get_contents();
    ob_clean();
    //$new_link=create_delete_report_file( $html, 2, $delete, "../../../" );
    foreach (glob("*.xls") as $filename) {
    //if( @filemtime($filename) < (time()-$seconds_old) )
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');	
    $is_created = fwrite($create_new_doc, $html);


    $filename2=$user_id."_summary_".$name.".xls";
    $create_new_doc2 = fopen($filename2, 'w');	
    $is_created2 = fwrite($create_new_doc2, $summaryHTML);

    echo "$html****$filename****$filename2****$report_type"; 
    exit();
}
if($action=="generate_report9") // Batch  Wise2 
{ 
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if ($cbo_company_name==0) $company_id=""; else $company_id=" and a.company_id='$cbo_company_name'";
	if ($cbo_company_name==0) $company_idcond =""; else $company_idcond =" and b.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond .=""; else $company_idcond .=" and b.working_company_id='$cbo_working_name'";
	//echo $cbo_company_name.'='.$cbo_working_name;die;
	if ($cbo_company_name==0 && $cbo_working_name==0) 
	{
		$w_company_idcond ="";$w_company_idcond2="";$w_company_idcond3="";$w_company_idcond4="";
	}
	 else  {
		 if ($cbo_company_name==0 && $cbo_working_name>0)
		 {
		  	$w_company_idcond =" and c.company_id='$cbo_working_name'";
			$w_company_idcond2 =" and b.knit_dye_company='$cbo_working_name'";
			$w_company_idcond3 =" and b.working_company_id='$cbo_working_name'";
			$w_company_idcond4 =" and a.service_company='$cbo_working_name'";
		 }
		 else  if ($cbo_company_name>0 && $cbo_working_name==0)
		 {
		  $w_company_idcond =" and c.company_id='$cbo_company_name'";
		  $w_company_idcond2 =" and b.knit_dye_company='$cbo_company_name'";
		  $w_company_idcond4 =" and a.company_id='$cbo_company_name'";
		  $w_company_idcond3 ="and b.company_id='$cbo_company_name'";
		 }
	 }
	 // echo  $w_company_idcond.'dd'.$company_idcond;die;
	
	$from_date=str_replace("'","",$from_date);
	$to_date=str_replace("'","",$to_date);
	//echo $from_date;
	$txt_ref_no=str_replace("'","",$txt_ref_no); 
	$txt_file_no=str_replace("'","",$txt_file_no);
	$txt_booking_no=str_replace("'","",$txt_booking_no);
	$txt_po_no=str_replace("'","",$txt_po_no);
	$txt_job=str_replace("'","",$txt_job);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$cbo_season_id=str_replace("'","",$cbo_season_id);
	$txt_samp_ref_no=str_replace("'","",$txt_samp_ref_no);
	$location_id=str_replace("'","",$location_id);
	$floor_id=str_replace("'","",$floor_id);
	$report_type=str_replace("'","",$report_type);
	$cbo_year=str_replace("'","",$cbo_year_selection);

	
	
	if(str_replace("'","",$cbo_buyer_name)==0)
	{
		if ($_SESSION['logic_erp']["data_level_secured"]==1)
		{
			if($_SESSION['logic_erp']["buyer_id"]!="") $buyer_id_cond=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")"; else $buyer_id_cond="";
		}
		else
		{
			$buyer_id_cond="";
		}
	}
	else
	{
		$buyer_id_cond=" and a.buyer_name in (".str_replace("'","",$cbo_buyer_name).")";
	}
	
	if($txt_booking_no!='') $booking_no_cond="and b.booking_no like '%$txt_booking_no%' ";else $booking_no_cond="";
	if($db_type==0)
		{
			$year_cond=" and SUBSTRING_INDEX(a.insert_date, '-', 1)=$cbo_year";
		}
		else if($db_type==2)
		{
			$year_cond=" and to_char(a.insert_date,'YYYY')=$cbo_year";
		}
		
	if($txt_file_no!='') $file_cond="and b.file_no=$txt_file_no";else $file_cond="";
	if($txt_job!='') $job_cond="and a.job_no_prefix_num=$txt_job  $year_cond";else $job_cond="";
	if($txt_po_no!='') $po_cond="and b.po_number='$txt_po_no'";else $po_cond="";
	
	if($cbo_season_id!=0) $season_cond="and a.season_buyer_wise in($cbo_season_id)";else $season_cond="";
	
	if($txt_ref_no!='') $ref_cond="and b.grouping='$txt_ref_no'";else $ref_cond="";
	if($txt_samp_ref_no!='') $samp_ref_cond="and a.grouping='$txt_samp_ref_no'";else $samp_ref_cond="";
	//echo $ref_cond;
	$companyArr = return_library_array("SELECT id,company_name from lib_company where status_active=1 and is_deleted=0","id","company_name"); 
	$supplierArr = return_library_array("SELECT id,supplier_name from lib_supplier where status_active=1 and is_deleted=0","id","supplier_name"); 
	$color_arr=return_library_array( "SELECT id,color_name  from  lib_color where status_active=1", "id", "color_name"  );
	$buyer_arr=return_library_array( "SELECT id,buyer_name  from  lib_buyer", "id", "buyer_name"  );
	$season_name_arr=return_library_array( "SELECT id,season_name  from  lib_buyer_season", "id", "season_name"  );
	
	if($db_type==0) 
	{
	$from_date=change_date_format($from_date,'yyyy-mm-dd'); $to_date=change_date_format($to_date,'yyyy-mm-dd');
	}
    if($db_type==2) 
	{
	$from_date=change_date_format($from_date,'','',1);  $to_date=change_date_format($to_date,'','',1);
	}
	//echo $from_date;
	$batch_description_arr=array();
	/* 
	if(str_replace("'","",$batch_id)!="") $batch_cond=" and b.id in(".str_replace("'","",$batch_id).")";
    else  */
	//echo $batch_cond; //die;
	//echo $batch_no; //die;
    	//echo $batch_no;
	$batch_no=implode("','",array_unique(explode(",",$batch_no)));
	if(str_replace("'","",$batch_no)!="") $batch_cond=" and b.batch_no in('".$batch_no."') "; 
	else $batch_cond="";
	//echo $batch_cond."shakil"; die;
	//
	/* and b.re_dyeing_from=0 13-11-16 according to siddique sir dicission when search buyer order or subcontract all batch appear */
	if($batch_type==0)
	$search_field_cond_batch="";
	else if($batch_type==1)
	$search_field_cond_batch="and b.entry_form=0 ";
	else if($batch_type==2)
	$search_field_cond_batch="and b.entry_form=36";
	else if($batch_type==4)
	$search_field_cond_batch="and b.entry_form=136";
	else if($batch_type==5)
	$search_field_cond_batch="and b.batch_against=3";// sample
	else 
	$search_field_cond_batch="and b.entry_form in(0,36) and b.batch_against in(2) and  b.re_dyeing_from!=0 ";
 //echo $search_field_cond_batch.'D';die;
	
 	$con = connect();
	 execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id."   and ENTRY_FORM=48");
	 oci_commit($con);
	 disconnect($con);

	if($txt_file_no!='' || $txt_ref_no!='' ||  $txt_po_no!='' || $txt_job!='' || $cbo_buyer_name>0)
	{
		
		if($batch_type==4) //Trim batch
		{
		 $sql_po="SELECT c.id as batch_id,a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b,pro_batch_create_mst c where a.id=b.job_id and b.job_no_mst=c.job_no  and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond";
		}
		else
		{
			$sql_po="SELECT a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b  where a.id=b.job_id and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond";
		}
		// echo $sql_po;die; 
		$res_po=sql_select($sql_po);
		$all_po_id='';
		foreach($res_po as $row) //$job_no_arr
		{			
			if($all_po_id=="") $all_po_id=$row[csf('id')]; else $all_po_id.=",".$row[csf('id')]; //echo $all_po_id;
			
			$trim_batch_idArr[$row[csf('batch_id')]]=$row[csf('batch_id')];
			$po_idArr[$row[csf('id')]]=$row[csf('id')];
		}
		//echo $all_po_id;
		
		
		fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 1, $po_idArr, $empty_arr);//PO ID Ref from=1
		fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 2, $trim_batch_idArr, $empty_arr);//Batch ID Ref from=2
		

		if($all_po_id!="") $po_idd="and po_id in($all_po_id)";else $po_idd="and po_id in(0)";
		
		$poIds=chop($all_po_id,','); $po_cond_for_in="";
		$po_ids=count(array_unique(explode(",",$all_po_id)));
		if($db_type==2 && $po_ids>1000)
		{
			$po_cond_for_in=" and (";
			$poIdsArr=array_chunk(explode(",",$poIds),999);
			foreach($poIdsArr as $ids)
			{
				$ids=implode(",",$ids);
				$po_cond_for_in.=" po_id in($ids) or"; 
			}
			$po_cond_for_in=chop($po_cond_for_in,'or ');
			$po_cond_for_in.=")";
		}
		else
		{
			$po_cond_for_in=" and po_id in($poIds)";
			
		}
		
		if($batch_type==4) //Trim batch
		{
		 	$po_cond_for_in='';
			$po_cond_for_in=where_con_using_array($trim_batch_idArr,0,"mst_id");
			//echo "SELECT b.mst_id as batch_id from pro_batch_trims_dtls b  where   b.status_active=1 and b.is_deleted=0 $po_cond_for_in";die;
			$sql_batch=sql_select("SELECT b.mst_id as batch_id from pro_batch_trims_dtls b,gbl_temp_engine g   where  b.mst_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and b.status_active=1 and b.is_deleted=0 ");
		}
		else
		{
			$sql_batch=sql_select("SELECT b.mst_id as batch_id from pro_batch_create_dtls b,gbl_temp_engine g  where   b.po_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=1 and g.entry_form=48  and b.status_active=1 and b.is_deleted=0  ");
		}
		//echo "SELECT mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in";die();
		 $all_batch_id='';
		foreach($sql_batch as $row) 
		{
			if($all_batch_id=="") $all_batch_id=$row[csf('batch_id')]; else $all_batch_id.=",".$row[csf('batch_id')];
		}
			$all_batch_ids=implode(",",array_unique(explode(",",$all_batch_id)));
		//echo $all_batch_ids; 
		$batch_ids_cond="";
		if($all_batch_ids!="") 
		{
			//echo $po_id=substr($po_id,0,-1);
			if($db_type==0) { $batch_ids_cond="and b.id in(".$all_batch_ids.")"; }
			else
			{
				$bat_id=array_unique(explode(",",$all_batch_ids));
				if(count($bat_id)>1000)
				{
					$batch_ids_cond="and (";
					$bat_id=array_chunk($bat_id,1000);
					$z=0;
					foreach($bat_id as $id)
					{
						$id=implode(",",$id);
						if($z==0) $batch_ids_cond.=" b.id in(".$id.")";
						else $batch_ids_cond.=" or b.id in(".$id.")";
						$z++;
					}
					$batch_ids_cond.=")";
				}
				else { 
				
				$batch_ids_cond=" and b.id in(".$all_batch_ids.")"; }
			}
		}
	}
	// print_r($batch_ids_cond);die;
	if($from_date!="" && $to_date!="")
	{
		$date_cond_samp="";
		if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond_samp=" and b.batch_date between '".$from_date."' and '".$to_date."'";
		}
	}


	/* ================================================================================ /
	/								Main query start here								/
	/ ================================================================================ */
	$samp_non_booking=sql_select("SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no_id=a.id and a.booking_type=4  $company_idcond $w_company_idcond3 $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
	/*echo "SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $w_company_idcond3 $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";die; */
	 

	// echo "SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";die; 
	$all_batch_id_samp="";
	foreach($samp_non_booking as $row)
	{
		$non_buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$non_buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$sample_booking_ref_no_arr[$row[csf('booking_no')]]=$row[csf('grouping')];
		if($txt_samp_ref_no!='')
		{
		if($all_batch_id_samp=="") $all_batch_id_samp=$row[csf('batch_id')]; else $all_batch_id_samp.=",".$row[csf('batch_id')];
		}
	}
	if($all_batch_id_samp!="") $all_batch_id_samp_cond="and b.id in($all_batch_id_samp)";else $all_batch_id_samp_cond="";
	//echo $all_batch_id_samp_cond.'X';
	$company_id_issue="";$company_idcond_issue="";
	if ($cbo_company_name==0) $company_id_issue=""; else $company_id_issue=" and b.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond_issue=""; else $company_idcond_issue =" and b.working_company_id='$cbo_working_name'";
	if ($cbo_working_name==0) $w_company_idcond_issue=""; else $w_company_idcond_issue =" and b.knit_dye_company='$cbo_working_name'";

	
    if($from_date!="")
    {
		if(str_replace("'","",$cbo_value_with)==1)
		{
			$date_cond=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";
		//and b.batch_against in(1,2,3)
			$sql=sql_select("SELECT b.id,b.sales_order_id,a.batch_no,a.fabric_type,b.booking_without_order,b.job_no,b.extention_no,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
			and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  $company_id_issue $company_idcond_issue $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
			 
			 
		}
		else if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond=" and b.batch_date between '".$from_date."' and '".$to_date."'";
			$sql=sql_select("SELECT b.id,b.sales_order_id,b.batch_no,b.booking_without_order,b.job_no,b.extention_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
			from  pro_batch_create_mst b where   b.status_active=1 and b.is_deleted=0  $company_id_issue $company_idcond_issue $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
			
		}
   	}
   	else
   	{
		 
		 
		// $sql=sql_select("SELECT b.id,b.sales_order_id,b.booking_without_order,b.job_no,b.extention_no,b.batch_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
		// from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0 $company_id_issue $company_idcond_issue $batch_cond $batch_ids_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
		if(str_replace("'","",$cbo_value_with)==1)
		{
			//$date_cond=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";
		//and b.batch_against in(1,2,3)
			$sql=sql_select("SELECT b.id,b.sales_order_id,a.batch_no,a.fabric_type,b.booking_without_order,b.job_no,b.extention_no,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
			and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  $company_id_issue $company_idcond_issue $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
			 
			 
		}
		else if(str_replace("'","",$cbo_value_with)==2)
		{
			//$date_cond=" and b.batch_date between '".$from_date."' and '".$to_date."'";
			$sql=sql_select("SELECT b.id,b.sales_order_id,b.batch_no,b.booking_without_order,b.job_no,b.extention_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
			from  pro_batch_create_mst b where   b.status_active=1 and b.is_deleted=0  $company_id_issue $company_idcond_issue $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
			
		}
		
		//w_company_idcond
		
	}
	  //echo $sql; 
	 //and e.party_id not in(426,439,444,458,425,427,428,443,392,564,565,563)
	if(count($sql)==0)
    {
        ?>
        <div style="font-size:20px;color:red;text-align:center">Data not found!</div>
        <?
        die;
    }
	
  	$reding_batch_id=$non_reding_batch_id=$trim_batch_IdArr=array();
    foreach($sql as $row)
	{
	// $sub_party_id_not=$sub_batch_chk_arr[$row[csf("id")]];
	  if($row[csf("entry_form")]=='136') 
	  {
		 	$trim_batch_IdArr[$row[csf("id")]]=$row[csf("id")]; 
	  }	
		
		$batch_against_id=$row[csf("batch_against")];
		$batch_id_arr[]=$row[csf("id")];
		$batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
		if($row[csf("sales_order_id")]!='')
		{
		$sales_batch_arr[$row[csf("id")]]=$row[csf("sales_order_id")];
		$sales_id_arr[$row[csf("sales_order_id")]]=$row[csf("sales_order_id")];
		}
		
	//	echo $sub_party_id_not.', ';
		 $issue_single_batch_arr[$row[csf("id")]]=$row[csf("id")];  
		if($batch_against_id==1 || $batch_against_id==3)
		{		
			// $batch_id_arr[]=$row[csf("id")]; 
			//$sub_batch_chk_not=$sub_batch_chk_arr[$row[csf("id")]]
			//if($sub_party_id_not!=$row[csf("id")]) //426,439,444,458,425,427,428,443,392,564,565,563
	  		//{ 
			 $batch_description_arr[$row[csf("id")]]['batch_weight']=$row[csf("batch_weight")];
	 		//} //Subcon some buyer omit end
		
			$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
			$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
			
			$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
			$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_description_arr[$row[csf("id")]]['job_no']=$row[csf("job_no")];
			
			$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
			$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
			$batch_no_arr[]="'".$row[csf("batch_no")]."'";
			// $batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			$batch_wise_arr[$row[csf("batch_no")]]['batch_no']=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['extention_no'].=$row[csf("extention_no")].',';
			$batch_ext_wise_arr[$row[csf("id")]]['extention_no']=$row[csf("extention_no")];
			
		}
		if($batch_against_id==2)
		{
			 
			// if($sub_party_id_not!=$row[csf("id")]) //426,439,444,458,425,427,428,443,392,564,565,563
	  		 //{
			 $batch_description_arr[$row[csf("id")]]['batch_weight']=$row[csf("batch_weight")];
			 //} //Subcon some buyer omit end
			$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
			$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
			//$batch_description_arr[$row[csf("id")]]['batch_weight']+=$row[csf("batch_weight")];
			$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
			$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_description_arr[$row[csf("id")]]['job_no']=$row[csf("job_no")];
			
			$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
			$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
			$batch_description_arr[$row[csf("id")]]['extention_no']=$row[csf("extention_no")];
			$batch_no_arr[]="'".$row[csf("batch_no")]."'";
			// $batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
			
			$batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			$batch_wise_arr[$row[csf("batch_no")]]['batch_no']=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['extention_no'].=$row[csf("extention_no")].',';
			$batch_ext_wise_arr[$row[csf("id")]]['extention_no']=$row[csf("extention_no")];
			$batch_ext_wise_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$re_batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			
		}
		if($row[csf("batch_against")]==2)
		{
			 
			$reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
		else
		{
			$non_reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
		
	 
	}
	 
	 //echo "<pre>"; print_r($issue_single_batch_arr); die();

	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 3, $issue_single_batch_arr, $empty_arr);//Batch ID Ref from=3

	//	********************************************************************************************************************************
     $batch_id_sql=implode(",",$batch_id_arr);
    if($batch_id_sql=="") $batch_id_sql=0;
	//echo  $batch_id_sql;
  	if($batch_type==3)
	{
		//$re_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond2=chop($re_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond2.=")";
		}
	}
	else
	{
		//$re_dying_cond=" and b.re_dyeing_from in(".$batch_id_sql.")";	
		//$pord_ids = explode(",",$txt_product_id);
		//echo count($pord_ids);die;
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond=chop($re_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond.=")";
		}
	}

	$date_cond2=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";

	// =============================================================
	$batch_all_id_array=array();$fin_recipe_from_array=array();
//	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
	//   $sql = "SELECT a.ID,b.mst_id as REQ_ID,a.batch_id as BATCH_ID,a.BATCH_QTY,a.BATCH_QTY,a.NEW_BATCH_WEIGHT,a.ENTRY_FORM,c.batch_id as RE_BATCH_ID from pro_recipe_entry_mst a, dyes_chem_requ_recipe_att b,dyes_chem_issue_requ_mst c where b.recipe_id=a.id  and c.id=b.mst_id $batch_id_conds and a.status_active=1 and a.is_deleted=0 and b.status_active=1 ";
	  $sql = "SELECT a.ID,b.mst_id as REQ_ID,a.batch_id as BATCH_ID,a.BATCH_QTY,a.BATCH_QTY,a.NEW_BATCH_WEIGHT,a.ENTRY_FORM,c.batch_id as RE_BATCH_ID from pro_recipe_entry_mst a, dyes_chem_requ_recipe_att b,dyes_chem_issue_requ_mst c,gbl_temp_engine g where b.recipe_id=a.id  and c.id=b.mst_id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 ";
	 // echo $sql;die; 
	$res = sql_select($sql);
	$req_id_array = array();
	foreach ($res as $val) 
	{
		//$req_id_array2[$val['REQ_ID']] .= $val['REQ_ID'].',';
		$req_id_array[$val['REQ_ID']] = $val['REQ_ID'];
		//$batch_req_id_array[$val['BATCH_ID']].= $val['REQ_ID'].',';
		$batch_req_id_array2[$val['BATCH_ID']]= $val['REQ_ID'];
		$batch_all_id_array[$val['BATCH_ID']]= $val['BATCH_ID'];
		$fin_recipe_from_array[$val['REQ_ID']]= $val['ENTRY_FORM'];
	 
			if($val['ENTRY_FORM']==60) //Adding Topping
			{
				$batch_wgt=$val['NEW_BATCH_WEIGHT'];
			}
			else
			{
				$batch_wgt=$val['BATCH_QTY'];
			}
		//$batch_wgt_array[$val['REQ_ID']] += $batch_wgt;
		$batch_wgt_array[$val['BATCH_ID']] = $batch_wgt;
		$batchWgtChkk[$val['REQ_ID']].=$val['BATCH_ID'].',';
		$batchIdChkkDtls[$val['REQ_ID']]=$val['BATCH_ID'];
		
	}
	unset($res);
 	// print_r($fin_recipe_from_array);
	if(count($req_id_array))
	{
		//$requisition_id_cond=where_con_using_array($req_id_array,0,"a.requisition_no");
	}
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 4, $req_id_array, $empty_arr);//Req ID Ref from=4

	$issue_sql = sql_select("SELECT a.MST_ID ,a.REQUISITION_NO,b.BATCH_NO,a.ITEM_CATEGORY,a.PROD_ID,a.CONS_QUANTITY,a.CONS_AMOUNT,c.SUB_PROCESS from inv_transaction a,inv_issue_master b,dyes_chem_issue_dtls c, gbl_temp_engine g where a.mst_id=b.id and c.mst_id=b.id and a.id=c.trans_id and a.REQUISITION_NO=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=4 and g.entry_form=48 and b.entry_form=5 and b.is_deleted=0 and b.status_active=1 and a.status_active=1 and a.transaction_type=2 and c.status_active=1   ");//$w_company_idcond2
	$issue_id_arr = array();$tot_issueQty=0;  
	foreach ($issue_sql as $val) 
	{
		$batchArr=array_filter(array_unique(explode(",",$val['BATCH_NO'])));
		foreach($batchArr as $bid)
		{
			$sub_processId=$val['SUB_PROCESS']; //92 Finishing process

			$issue_item_cat_arr[$bid][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['ITEM_CATEGORY'];
			if($bid!='')
			{
			$batch_all_id_array[$bid]= $bid;
			$batch_req_id_array[$bid].= $val['REQUISITION_NO'].',';
			}
		}
		$fin_recipe_from=$fin_recipe_from_array[$val['REQUISITION_NO']];
		if($fin_recipe_from==468 || $fin_recipe_from==445 )
		{
			//$issue_item_cat_cost_fin_arr[$val['REQUISITION_NO']][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['CONS_QUANTITY'];
			//$issue_item_cat_cost_dtls_fin_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_QUANTITY'];
			$issue_item_cat_amt_dtls_fin_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_AMOUNT'];
		}
		else 
		{
			//$issue_item_cat_cost_arr[$val['REQUISITION_NO']][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['CONS_QUANTITY'];
			//$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_QUANTITY'];
			$issue_item_cat_amt_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_AMOUNT'];
			
		}
		 $ReqBatch_id_arr[$val['REQUISITION_NO']] = $val['BATCH_NO'];
		$issue_id_arr[$val['MST_ID']] = $val['MST_ID'];
		$tot_issueQty+=$val['CONS_QUANTITY'];
		
	}
	 
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 5, $batch_all_id_array, $empty_arr);//Batch ID Ref from=5

	$batch_fabric_sql=sql_select("SELECT b.id,b.batch_no,b.batch_weight, b.batch_against
	from pro_recipe_entry_mst  a,pro_batch_create_mst b,gbl_temp_engine g where  a.batch_id=b.id and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=5 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0" );
	 
	 $batch_wgt_arr=array();
	 foreach ($batch_fabric_sql as $row) 
	{
		//$batch_req_id=$batch_req_id_array2[$row[csf("id")]];
		//echo $batch_req_id.'d';
		$batch_wgt_arr[$row[csf("id")]]['batchWgt']=$row[csf("batch_weight")];
	}
	unset($batch_fabric_sql);
	 
	// =====================================================================================
	//$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "b.id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "b.id", $re_dying_cond);
	$fabric_sql=sql_select("SELECT b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
	from pro_fab_subprocess  a,pro_batch_create_mst b,gbl_temp_engine g  where  a.batch_id=b.id  and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 
	and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 $company_idcond");
	 	
  	$fabric_type_arr=array();
    foreach($fabric_sql as $row)
	{
	 	$fabric_type_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
	}
	unset($fabric_sql);
	//=========****============Fab Sales Order=========================
	 
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 6, $sales_id_arr, $empty_arr);//Sales ID Ref from=6
	$sales_fabric_sql=sql_select("SELECT c.id as sales_id,c.within_group,c.po_buyer as po_buyer,c.buyer_id,b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
	from pro_fab_subprocess  a,pro_batch_create_mst b,fabric_sales_order_mst c,gbl_temp_engine g  where  a.batch_id=b.id 
	and c.id=b.sales_order_id and c.id=g.ref_val and b.sales_order_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=6 and g.entry_form=48  and a.entry_form in (35) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $company_idcond ");
  	 
    foreach($sales_fabric_sql as $row)
	{
	 	if($row[csf("within_group")]==2)
		{
			$fabric_sales_arr[$row[csf("sales_id")]]['buyer_id']=$row[csf("buyer_id")];
		}
		else{
			$fabric_sales_arr[$row[csf("sales_id")]]['buyer_id']=$row[csf("po_buyer")];
		}
	}
	unset($sales_fabric_sql);

	// ========================================================================================

	$floor_cond_arr=array();
	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
	//echo $location_id.'-0998';die; 
	if(!empty($location_id))
	{
		if(!empty($floor_id))
		{
			$sql="SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b,gbl_temp_engine g  where a.floor_id=b.id  and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0 and b.company_id=$cbo_working_name and b.location_id=$location_id and b.production_process=3 and b.id=$floor_id ";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) 
			{
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		else
		{
			 $sql="SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b,gbl_temp_engine g  where a.floor_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0  and b.location_id=$location_id and b.production_process=3 ";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) {
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		$floor_cond_arr=array_unique($floor_cond_arr);
	}
	 // print_r($floor_cond_arr);die();

	// ==========================================================================

	//$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
    $floor_arr=return_library_array("SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b,gbl_temp_engine g  where a.floor_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0 ", "batch_id", "floor_name" );

	$machine_name_arr=return_library_array("SELECT  a.batch_id ,b.machine_no from   pro_fab_subprocess a, lib_machine_name b,gbl_temp_engine g  where a.machine_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.entry_form in(38,35) and  b.status_active=1 and b.is_deleted=0  ", "batch_id", "machine_no" );

	//$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "c.id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "c.id", $re_dying_cond);
	$sql_book=sql_select("SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c,gbl_temp_engine g where a.buyer_id=b.id and a.id=c.booking_no_id and c.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 ");
	 
	$po_id_arr = array();
	foreach($sql_book as $row)
	{
		$buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		
		if($row[csf('po_break_down_id')])
		{
		$po_id_arr[$row[csf('po_break_down_id')]]=$row[csf('po_break_down_id')];
		$po_break_down_id_arr[$row[csf('booking_no')]]=$row[csf('po_break_down_id')];
		}
	}

	// =========================================================
	// $poIdss = implode(",", $po_id_arr);
	if(count($po_id_arr))
	{
		$po_id_cond = where_con_using_array($po_id_arr,0,"b.id");
	}
	
	if(count($trim_batch_IdArr))
	{
		$trim_batchId_cond = where_con_using_array($trim_batch_IdArr,0,"c.id");
	}

	// echo $poIdCond;die();
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 7, $po_id_arr, $empty_arr);//Sales ID Ref from=7
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 8, $trim_batch_IdArr, $empty_arr);//T Batch ID Ref from=8
	 $sql_po="SELECT a.style_ref_no,a.buyer_name,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b ,gbl_temp_engine g  where a.id=b.job_id  and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=7 and g.entry_form=48 and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond ";
	// echo $sql_po;die(); 
	$res_po=sql_select($sql_po);
	$all_po_id='';
	foreach($res_po as $row) //$job_no_arr
	{
		$po_number_arr[$row[csf('id')]]['po_no']=$row[csf('po_number')];
		$po_number_arr[$row[csf('id')]]['ref_no']=$row[csf('ref_no')];
		$po_number_arr[$row[csf('id')]]['file_no']=$row[csf('file_no')]; 
		$po_number_arr[$row[csf('id')]]['season']=$row[csf('season_buyer_wise')]; 
		$po_number_arr[$row[csf('id')]]['job']=$row[csf('job_no_mst')];
		
		$job_no_arr[$row[csf('id')]]=$row[csf('job_no_mst')];
		$style_library[$row[csf('job_no_mst')]]=$row[csf('style_ref_no')];
		
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['buyer']=$row[csf('buyer_name')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['season']=$row[csf('season_buyer_wise')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['style']=$row[csf('style_ref_no')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['po_number'].=$row[csf('po_number')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['ref_no'].=$row[csf('ref_no')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['file_no'].=$row[csf('file_no')].',';
	}
	unset($res_po);
	 $sql_trim_job="SELECT a.style_ref_no,a.buyer_name,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b,pro_batch_create_mst c,gbl_temp_engine g  where a.id=b.job_id and a.job_no=c.job_no and b.job_no_mst=c.job_no  and c.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=8 and g.entry_form=48 and   b.status_active=1 and b.is_deleted=0  and   c.status_active=1 and c.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond   $buyer_id_cond ";
	// echo $sql_po;die(); 
	$res_trimJob=sql_select($sql_trim_job);
	 
	foreach($res_trimJob as $row) //$job_no_arr
	{
		$style_library[$row[csf('job_no_mst')]]=$row[csf('style_ref_no')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['buyer']=$row[csf('buyer_name')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['season']=$row[csf('season_buyer_wise')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['style']=$row[csf('style_ref_no')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['po_number'].=$row[csf('po_number')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['ref_no'].=$row[csf('ref_no')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['file_no'].=$row[csf('file_no')].',';
	}
	unset($res_trimJob);

   $buyer_library=return_library_array( "SELECT id,buyer_name from   lib_buyer", "id","buyer_name" );
   // $batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.mst_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.mst_id", $re_dying_cond);
	$po_data_subcon=sql_select("SELECT a.mst_id,a.item_description,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	subcon_ord_mst c,gbl_temp_engine g where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.mst_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0  ");
	
	$sub_con_arr=array();$sub_party_arr=array(426,439,444,458,425,427,428,443,392,564,565,563); //Omit buyer ids
	foreach($po_data_subcon as $row)
	{
		if($sub_con_arr[$row[csf('mst_id')]][cust_style_ref]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref].=",".$row[csf('cust_style_ref')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref]=$row[csf('cust_style_ref')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][order_no]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no].=",".$row[csf('order_no')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no]=$row[csf('order_no')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][subcon_job]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job].=",".$row[csf('subcon_job')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job]=$row[csf('subcon_job')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][party_id]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id].=",".$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id].=",".$row[csf('party_id')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id]=$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id]=$row[csf('party_id')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][item_description]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][item_description].=",".$row[csf('item_description')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][item_description]=$row[csf('item_description')];	
		}
		$party_id=$row[csf('party_id')];
		if(in_array($party_id,$sub_party_arr) && $row[csf("party_id")]>0)
		{
			$sub_batch_chk_arr[$row[csf("mst_id")]]=$row[csf("party_id")];
		}
	}
	//echo "<pre>";print_r($sub_con_arr);die;
	// ==================================================================================

	if($db_type==0)
	{
		if($batch_type==3)
		{
		 $sql_redying=sql_select("SELECT b.id as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0 group by  b.id");
		}
		else
		{
			 $sql_redying=sql_select("SELECT group_concat(b.id) as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0  $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0 group by  b.re_dyeing_from");	
		}
	}
	else
	{
	
		if($batch_type==3)
		{	
			 
			   $sql_redying=sql_select("SELECT b.id as id, b.batch_date as batch_date, b.extention_no as extention_no
			   from  pro_batch_create_mst  b ,gbl_temp_engine g
			   where  b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and b.re_dyeing_from!=0 $company_idcond  and b.status_active=1 and b.is_deleted=0  ");
		}
		else
		{
			 $sql_redying=sql_select("SELECT  b.id as id, b.batch_date as batch_date, b.extention_no as extention_no,b.re_dyeing_from 
			  from  pro_batch_create_mst b ,gbl_temp_engine g
			  where  b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and b.re_dyeing_from!=0   $company_idcond  and b.status_active=1 and b.is_deleted=0  ");
			 
		}
	}
	
   	//and b.batch_against=2
    $redying_details_arr=array();
    foreach($sql_redying as $re_row)
    {
		if($batch_type==3)
		{
			$redying_details_arr[$re_row[csf("id")]]['id'].=$re_row[csf("id")].",";
			$redying_details_arr[$re_row[csf("id")]]['batch_date'].=$re_row[csf("batch_date")].",";
			$redying_details_arr[$re_row[csf("id")]]['extention_no'].=$re_row[csf("extention_no")].",";
		}
		else
		{
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['id'].=$re_row[csf("id")].",";
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['batch_date'].=$re_row[csf("batch_date")].",";
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['extention_no'].=$re_row[csf("extention_no")].",";
		}
    }
	
	if($batch_type==3)
	{
		$result_sql=sql_select("SELECT a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b,gbl_temp_engine g where b.id=a.batch_id and b.id=g.ref_val and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48  and a.entry_form in (35,38) and a.load_unload_id=2   $company_idcond  and a.status_active=1 and a.is_deleted=0");	
	}
	else
	{
		$result_sql=sql_select("SELECT a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b,gbl_temp_engine g where b.id=a.batch_id and b.id=g.ref_val and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.entry_form in (35,38) and a.load_unload_id=2  $company_idcond  and a.status_active=1 and a.is_deleted=0");
	}
	
	$result_arr=array();
	foreach($result_sql as $value)
	{
		$result_arr[$value[csf('batch_id')]]=$value[csf('result')];	
	}
	// print_r($issue_single_batch_arr); echo "Test";die;
	// ====================================== batch wise cost =====================================
	$batchIdArr = array();
	foreach(array_unique($issue_single_batch_arr) as $b_id)
	{
		$batchIdArr[$b_id] = $b_id;
	}

	// print_r($batchIdArr);die();
	// echo $company_id;die();
	$company_cond = str_replace("a.company_id", "c.company_id", $company_id);	
	if ($cbo_working_name==0) $wo_company_idcond =""; else $wo_company_idcond =" and p.working_company_id='$cbo_working_name'";
//echo "#aaa";die;
	// $batchCond = implode(",", $batchIdArr);dose_base
	   $sql = "(SELECT p.id as recipe_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,a.avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no,c.batch_against,c.double_dyeing, a.id, a.item_category_id, a.item_group_id, a.sub_group_name, a.item_description, a.item_size,a.current_stock, a.unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
		from pro_recipe_entry_mst p, product_details_master a, pro_recipe_entry_dtls b,pro_batch_create_mst c,gbl_temp_engine g 
		where p.id=b.mst_id and a.id=b.prod_id and p.batch_id=c.id  and c.id=g.ref_val  and p.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and b.ratio>0  and b.status_active=1 and b.is_deleted=0 $company_cond $wo_company_idcond and a.item_category_id in(5,6,7,23) and a.status_active=1 and a.is_deleted=0  and p.entry_form in(59,60)) 
		union 
		(
		SELECT p.id as recipe_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,0 as avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, c.batch_against,c.double_dyeing,b.prod_id as id, null as item_category_id, null as item_group_id, null as sub_group_name, null as item_description, null as item_size,null as current_stock, null as unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
			from pro_recipe_entry_mst p, pro_recipe_entry_dtls b,pro_batch_create_mst c,gbl_temp_engine g  
			where p.id=b.mst_id and p.batch_id=c.id and c.id=g.ref_val and p.batch_id=g.ref_val  and p.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and b.status_active=1 and b.is_deleted=0 $wo_company_idcond  and b.status_active=1 and b.is_deleted=0 and b.prod_id=0 and b.sub_process_id in(93,94,95,96,97,98) and p.status_active=1 and p.is_deleted=0  and p.entry_form in(59,60))  order by sub_seq,seq_no";
	  //echo $sql;die();
	$costDataArr = array();
	$res = sql_select($sql);
	$tot_recCost=0;$tot_issue_qty=0;
	foreach ($res as $row) 
	{
		$current_stock = $row[csf('current_stock')];
		$item_category_id = $row[csf('item_category_id')];
		$recipe_type = $row[csf('recipe_type')];
		$batch_againstId = $row[csf('batch_against')];
		$double_dyeingId = $row[csf('double_dyeing')];
		$dose_baseId = $row[csf('dose_base')];
		$surplus_solution = $row[csf('surplus_solution')];
		$pickup = $row[csf('pickup')];$entry_form = $row[csf('entry_form')];
		$batch_wgt = $row[csf('batch_qty')];//pickup,p.batch_qty
		$current_stock_check=number_format($current_stock,7,'.','');
		//(Batch weight*Pick Up/100)+Surplus Solution;
		$total_solution=($batch_wgt*$pickup/100)+$surplus_solution;
		
		$ratio = $row[csf('ratio')];
		 if($entry_form==59)
		 {
			$BatchRecipeNo_arr[$row[csf('batch_id')]]['main_recipe'].=$row[csf('recipe_id')].',';
		 }
		 if($entry_form==60)
		 {
			$BatchRecipeNo_arr[$row[csf('batch_id')]]['addTopping_recipe'].=$row[csf('recipe_id')].',';
		 }
		 if($item_category_id==6)
		 {
			$BatchRecipeNo_arr[$row[csf('batch_id')]]['ratio']+=$row[csf('ratio')];
		 }
		$batch_req_id=rtrim($batch_req_id_array[$row[csf('batch_id')]],',');
		$batch_req_idArr=array_unique(explode(",",$batch_req_id_array[$row[csf('batch_id')]]));
		//echo $batch_req_id.'D';
		$tot_batch_wgt=$batch_wgt_array[$row[csf('batch_id')]];
		//echo  $tot_batch_wgt.'D';
		$batch_qty=$row[csf('batch_qty')];
		if($issue_item_cat_arr[$row[csf('batch_id')]][$row[csf('prod_id')]][$row[csf('item_category_id')]])
		{
			//echo $recipe_qnty.'='.$row[csf('avg_rate_per_unit')].'<br>';
			//$issue_qty=0;
			foreach($batch_req_idArr as $req_id)
			{
				if($issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=='')
				{	
					$issue_qty+=$issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
					$reqIdArr[$req_id]=$req_id;
					$tot_issue_qty+=$issue_qty;
					$issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=111;
				}
				
			}
			//$issue_qty=$issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
			$issue_perKg=($issue_qty/$tot_batch_wgt);
			$issue_wgt_per=$issue_perKg*$batch_qty;
		//	echo $tot_batch_wgt.'='.$issue_qty.'='.$issue_wgt_per.'='.$issue_wgt_per*$row[csf('avg_rate_per_unit')].'<br>';
			
		$costDataArr[$row[csf('batch_id')]][$row[csf('item_category_id')]] +=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
		$ReqIdArr[$row[csf('batch_id')]].=$batch_req_id.','; 
		//$recipe_qnty*$row[csf('avg_rate_per_unit')];
		$categryDataArr[$row[csf('batch_id')]].=$row[csf('item_category_id')].',';
		$tot_recCost+=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
		}
	}
	//echo implode(",",$reqIdArr);die;
	//echo $tot_issue_qty.'Dx'.'='.$tot_recCost;
	// echo "<pre>";print_r($costDataArr);
	$con = connect();
	execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id." and ref_from in (1,2,3,4,5,6,7,8) and ENTRY_FORM=48");
	oci_commit($con);
	disconnect($con);
	$i=1;$j=1;
	ob_start();	
	?>
	<div id="" align="center" style="height:auto; width:auto; margin:0 auto; padding:0;">
		<? $summaryHTML='<div id="summary_part" style="width:1460px;">
        <table width="2060px" cellpadding="0" cellspacing="0" id="caption" align="center">
            <thead>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:16px; font-weight:bold" >'.$report_title.'</td 
                ></tr>
                <tr style="border:none;">
                    <td colspan="24" class="form_caption" align="center" style="border:none; font-size:14px;">
                       <b>Company Name : '.$companyArr[$cbo_company_name].'</b>                               
                    </td>
                </tr>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:12px; font-weight:bold">
					'."Date: ". change_date_format($from_date).' To '. change_date_format($to_date).'
					</td>
                </tr>
            </thead>
        </table>
 		
        
        
    	</div>';?>
    <?  echo $summaryHTML;?>

 	<div>
        <div  align="left" style="font-size:20px">Details</div>
        <table width="3020" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>
                    <th rowspan="2" width="80">Un-Load Date</th>
					<th rowspan="2" width="80">Main Recipe<br> No.</th>
                    <th rowspan="2" width="100">Machine No</th>
                    <th rowspan="2" width="100">Adding/<br>Topping<br>Recipe No</th>
                    
                    <th rowspan="2" width="100">Buyer</th>
                    <th rowspan="2" width="100">Batch Color</th>
					<th rowspan="2" width="100">Construction & Composition </th>
					<th rowspan="2" width="100">Batch Qty (Kg)</th>
					<th rowspan="2" width="100">Batch No</th>
                    <th rowspan="2" width="100">Shade %</th>
                   
                  
                    <th colspan="9"  width="">First Dying  And Finishing Cost</th>
                    <th colspan="9" width="">Re-Process Dyeing & Finishing Cost</th>
                    <th rowspan="2" width="100">Total Batch<br>Cost (Tk)</th>
                    <th rowspan="2" width="">Total Per<br> Kg Cost (Tk)</th>
                     
                </tr> 
                <tr>                         
                    <th width="100">Chemical<br> Cost (Tk)</th>
					<th width="100">Chemical Cost <br>Per Kg(Tk)</th>

                    <th width="100">Dyes<br> Cost (Tk)</th>
					<th width="100">Dyes Cost<br>Per Kg(Tk)</th>
                    <th width="100"><p>Dyes & Chemical<br>Cost(Tk)</p></th>
                    <th width="100">Dyes & Chemical<br>Cost/KG(Tk)</th> 
					<th width="100">Finishing Cost(Tk)</th>
					<th width="100">Fini. Cost/KG</th>
					<th width="100">Total Dye. & Fini.<br> Cost/Kg</th>

                    <th width="100">Chemical<br> Cost (Tk)</th>
					<th width="100">Chemical Cost <br>Per Kg(Tk)</th>
                    <th width="100">Dyes<br> Cost (Tk)</th>
					<th width="100">Dyes Cost<br>Per Kg(Tk)</th>
                    <th width="100"><p>Dyes & Chemical<br>Cost(Tk)</p></th>
                    <th width="100">Dyes & Chemical<br>Cost/KG(Tk)</th> 
					<th width="100">Finishing Cost(Tk)</th>
					<th width="100">Fini. Cost/KG</th>
					<th width="100">Total Dye. & Fini.<br> Cost/Kg</th>
                    
                </tr> 
            </thead>
        </table>
        <div style="width:3040px; max-height:400px;  overflow-y:scroll" id="scroll_body">
	        <table width="3020" border="1" cellpadding="0" cellspacing="0" rules="all" align="left" class="rpt_table" id="table_body_batch" >
	            <tbody>
			       	<?
				    // echo "<pre>";print_r($issue_single_batch_arr);die;
					$tot_main_batch_weight=0;$qty_check_array=array();$z=1;$total_tot_batch_weight=$sub_buyer_grnd_tot_batchQty=0;
					foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
						
							if($i%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
							$all_po_id=explode(",",$po_break_down_id_arr[$batch_description_arr[$b_id]['booking_no']]); 
							$all_item_description=explode(",",$sub_con_arr[$b_id][item_description]); 
							  
							
							//print_r($all_po_id);
							$ReqId=rtrim($ReqIdArr[$b_id],',');
							$ReqIds=implode(", ",array_unique(explode(",",$ReqId)));
							$ReqIdsArr=array_unique(explode(",",$ReqId));
			
							if($batch_description_arr[$b_id][entry_form]!=136)
							{
							$po_number_data="";
							$job_no_data="";$file_no="";$ref_no="";
							foreach($all_po_id as $p_id) // $po_number_arr[$row[csf('id')]]['po_no']
							{
								//echo $p_id.'d';
								if($po_number_data!="") $po_number_data.=",".$po_number_arr[$p_id]['po_no'];	 else $po_number_data=$po_number_arr[$p_id]['po_no'];
								if($job_no_data!="") $job_no_data.=",".$po_number_arr[$p_id]['job'];	
								 else $job_no_data=$po_number_arr[$p_id]['job'];
								if($season_data!="") $season_data.=",".$season_name_arr[$po_number_arr[$p_id]['season']];	 else $season_data=$season_name_arr[$po_number_arr[$p_id]['season']];
								if($file_no!="") $file_no.=",".$po_number_arr[$p_id]['file_no'];	 else $file_no=$po_number_arr[$p_id]['file_no'];
								if($ref_no!="") $ref_no.=",".$po_number_arr[$p_id]['ref_no'];	 else $ref_no=$po_number_arr[$p_id]['ref_no'];
							}
							$file_cond=implode(", ",array_unique(explode(",",$file_no)));
							$ref_cond=implode(", ",array_unique(explode(",",$ref_no))); 
							}
							//$categrybatch=rtrim($categryDataArr[$b_id][$row[csf('item_category_id')]],',');
							//$categryId=implode(", ",array_unique(explode(",",$categrybatch)));
							//echo $po_number_data.'XX';;
							$color_range_id=$batch_description_arr[$b_id]['color_range'];
							if($batch_description_arr[$b_id]['without_order']==1 && $ref_cond=="")
							{
							$ref_cond=$sample_booking_ref_no_arr[$batch_description_arr[$b_id]['booking_no']];
							}
							$re_b_id=rtrim($re_batch_wise_arr[$batch_arr[$b_id]]['batch_id'],',');
							$re_b_idArr=array_unique(explode(",",$re_b_id));
							//echo $re_b_id.'======';
							$re_b_ids=implode(",",array_unique(explode(",",$re_b_id)));
							$extention_noData=rtrim($batch_wise_arr[$batch_arr[$b_id]]['extention_no'],',');
							$extention_noArr=array_unique(explode(",",$extention_noData));
							$extention_no=$batch_ext_wise_arr[$b_id]['extention_no']; 
							//echo $extention_no.'<br>';
							$ext_batch_date=$batch_ext_wise_arr[$b_id]['batch_date'];;
							if($re_b_ids) $re_b_idsCond.=",".$re_b_ids;else $re_b_idsCond="";
							if($batch_description_arr[$b_id][entry_form]==136)
							{
								 $job_no=$batch_description_arr[$b_id][job_no];
								 $ref_noArr=rtrim($trim_batch_job_arr[$job_no]['ref_no'],','); 
								 $file_noArr=rtrim($trim_batch_job_arr[$job_no]['file_no'],',');
								  $ref_cond=implode(",",array_unique(explode(",",$ref_noArr))); 
								  $file_cond=implode(",",array_unique(explode(",",$file_noArr))); 
								//$file_cond=$file_cond;
								//$ref_cond=$ref_cond;
							}
							else
							{
								$file_cond=$file_cond;$ref_cond=$ref_cond;
							}
							
							// $batch_noArr=$batch_arr[$b_id];
							// if (!in_array($batch_noArr,$qty_check_array))
							// { 
							// 	$z++;
							// 	$qty_check_array[]=$batch_noArr;
							// 	$tot_batch_weight=$batch_description_arr[$b_id]['batch_weight'];
							// }
							// else
							// {
							// 	$tot_batch_weight=0;
							// }
							$tot_batch_weight=0;
							  $tot_batch_weight=$batch_description_arr[$b_id]['batch_weight'];
							$addTopping_recipe=rtrim($BatchRecipeNo_arr[$b_id]['addTopping_recipe'],',');
							$addTopping_recipe=implode(", ",array_unique(explode(',',$addTopping_recipe)));
						 
							$main_recipe=rtrim($BatchRecipeNo_arr[$b_id]['main_recipe'],',');
						
							$main_recipe=implode(", ",array_unique(explode(',',$main_recipe)));
							$shade_per=$BatchRecipeNo_arr[$b_id]['ratio'];
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="30"><? echo $i; ?></td>								
				                <td width="80"><? echo change_date_format($batch_description_arr[$b_id]['batch_date']); ?></td>
								<td width="80"><p><? echo $main_recipe; ?></p></td>
				                <td width="100"><p><? echo $machine_name_arr[$b_id]; ?></p></td>                                 
				                <td width="100" title="Add Topping"><p><?  echo $addTopping_recipe; ?></p></td>
				                
				                <?
								$sub_batch_buyer="";
				                if($batch_description_arr[$b_id][entry_form]==36)
				                {
									 $sub_batch_buyer=$sub_batch_chk_arr[$b_id];
									if($sub_batch_buyer>0)//Subcon buyer Omitted //(426,439,444,458,425,427,428,443,392,564,565,563)
									{
										$sub_buyer_grnd_tot_batchQty+=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
									}
									?>
					                <td width="100"><p style="word-break:break-all"><? echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][party_id]))); ?></p></td> 
				                	<?
				                }
								else if($batch_description_arr[$b_id][entry_form]==136)
				                {
					               $job_no=$batch_description_arr[$b_id][job_no]; 
								   $season_data=$season_name_arr[$trim_batch_job_arr[$job_no]['season']];//season_name_arr
								   $buyerName=$buyer_library[$trim_batch_job_arr[$job_no]['buyer']]; 
								//   $trim_batch_job_arr[$row[csf('job_no_mst')]]['buyer'];
								   $po_number_data=rtrim($trim_batch_job_arr[$job_no]['po_number'],','); 
								    $ref_noArr=rtrim($trim_batch_job_arr[$job_no]['ref_no'],','); 
									 $file_noArr=rtrim($trim_batch_job_arr[$job_no]['file_no'],','); 
									?>
					               <td width="100" title="BuyerID=<?=$trim_batch_job_arr[$job_no]['buyer'];?>"><p><? 
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
				                	<?
				                }
				                else
				                {
					                ?>
					                <td width="100"><p style="word-break:break-all"><? 
					                if($batch_description_arr[$b_id]['without_order']==1) $buyerName=$non_buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];else $buyerName=$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];
									$sales_order_id= $sales_batch_arr[$b_id];
									$buyer_id=$fabric_sales_arr[$sales_order_id]['buyer_id'];
										if($sales_order_id)
										{
											$buyerName='';//buyer_arr
											$buyerName=$buyer_library[$buyer_id];
											//echo "DDDD";	
										}
										else $buyerName=$buyerName;
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
					                <?	
				                }
				                ?>
				                <td width="100" align="center"><div style="word-break:break-all;"><? echo $color_arr[$batch_description_arr[$b_id]['color_id']]; ?></div></td> 
								<td width="100" align="center"><p style="word-break:break-all"><?if($sub_con_arr[$b_id][item_description]!=""){echo $all_item_description[0].",". $all_item_description[1];}else echo "";   //echo $fabric_type_for_dyeing[$fabric_type_arr[$b_id]['fabric_type']]; //$fabric_type_for_dyeing?></p></td> 
								<td width="100" align="right"><p>
				                <? echo number_format($tot_batch_weight,4); 
								
								//$total_batch_weight+=$batch_description_arr[$b_id]['batch_weight'];
								$total_batch_weight+=$tot_batch_weight;//tot_batch_weight
								?>
				                </p></td> 
								<td width="100" title="BatchId=<? echo $b_id.',Ext. No='.$extention_no;?>"><p>
                                <A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','batch_wise_subprocess_fabrics_dtls_popup2','<? echo $ReqIds; ?>',1)"> <? //echo $batch_arr[$b_id]; ?> </A>
                               <?  echo $batch_arr[$b_id]; ?></p></td>

				                <td width="100" title="Dyes Ratio" align="center"><p style="word-break:break-all"><?  echo number_format($shade_per,2); ?></p></td> 
				                <?
				                $batch_weight=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
				                $first_chemi_cost=$first_dyeing_cost=0;$tot_chemicalCost_fin=$tot_dyesCost_fin=0;$tot_fin_cost=0;
				                if($non_reding_batch_id[$b_id]!="")
				                {
				                    
									$issue_amt_deys=0;$issue_amt_chemical=$totalcost=0;$issue_amt_chemical_fin=0;$issue_amt_deys_fin=0;
									$batchIdArr="";$tot_chemicalCost=$tot_dyesCost=0;$tot_chemical_Cost_fin=$tot_dyes_Cost_fin=0;
									foreach($ReqIdsArr as $reqId)
									{
										
										$issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										$issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];

										$issue_amt_chemical_fin=$issue_item_cat_amt_dtls_fin_arr[$reqId][5]+$issue_item_cat_amt_dtls_fin_arr[$reqId][7];
										$issue_amt_deys_fin=$issue_item_cat_amt_dtls_fin_arr[$reqId][6];
									
									    $batch_ids=$ReqBatch_id_arr[$reqId]; 
										$batIdArr=array_unique(explode(",",$batch_ids)); 
										$tot_batch_wgt=0;
									    //print_r($batIdArr);
										foreach($batIdArr as $batchId)
										{
											$tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt'];
										}
										// echo $reqId.'='.$totalcost = ((($issue_amt_chemical+$issue_amt_deys)/$tot_batch_wgt)*$batch_weight)."<br />";
										 //$ref_cond=implode(",",array_unique(explode(",",$ref_noArr))); 
										//$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']];;
										if($issue_amt_chemical>0)
										{
										$tot_chemicalCost+= (($issue_amt_chemical/$tot_batch_wgt)*$batch_weight);
										}
										if($issue_amt_deys>0)
										{
										$tot_dyesCost+= (($issue_amt_deys/$tot_batch_wgt)*$batch_weight);
										}

										if($issue_amt_chemical_fin>0)
										{
										$tot_chemical_Cost_fin+= (($issue_amt_chemical_fin/$tot_batch_wgt)*$batch_weight);
										}
										if($issue_amt_deys_fin>0)
										{
										$tot_dyes_Cost_fin+= (($issue_amt_deys_fin/$tot_batch_wgt)*$batch_weight);
										}
									}

										//echo $issue_amt_chemical.'='.$batch_weight.'='.$tot_batch_wgt.',';
									 // echo $tot_batch_wgt.','; 
									if($tot_chemicalCost)
									{
									//$issue_amt_perKg_chemical=($issue_amt_chemical/$tot_batch_wgt);
									$issue_amt_cal_chemical=$tot_chemicalCost;//$issue_amt_perKg_chemical*$batch_weight;
									//echo $issue_amt_cal_chemical.'D'; 
									} 
									else 
									{ $issue_amt_cal_chemical=0;}
									
									if($tot_dyesCost)
									{
									//$issue_amt_perKg_dyes=($issue_amt_deys/$tot_batch_wgt);
									$issue_amt_cal_dyes=$tot_dyesCost;
									}
									else {$issue_amt_cal_dyes=0;}
									
				                    $first_chemi_cost=$issue_amt_cal_chemical;//$costDataArr[$b_id][5]+$costDataArr[$b_id][7];
				                    $first_dyeing_cost=$issue_amt_cal_dyes;//$costDataArr[$b_id][6];
									
									$tot_main_batch_weight+=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];

									if($tot_chemical_Cost_fin)
									{
										$tot_chemicalCost_fin=$tot_chemical_Cost_fin;
									}
									else $tot_chemicalCost_fin=0;
									if($tot_dyes_Cost_fin)
									{
										$tot_dyesCost_fin=$tot_dyes_Cost_fin;
									}
									else $tot_dyesCost_fin=0;

									$tot_fin_cost=$tot_chemicalCost_fin+$tot_dyesCost_fin;
				                }
				                
				                ?>
				                <td width="100" align="right" title="BatchId=<? echo $b_id;?>"><p>
				                <?
				                 echo fn_number_format($first_chemi_cost,4,".",""); 
				                 $total_chemical_cost+=$first_chemi_cost;
				                 ?>
				                </p></td>
				                <td width="100" title='Cost/batchQty' align="right"><p>
				                  <?  
				                    echo fn_number_format($first_chemi_cost/$tot_batch_weight,4,".",""); 
				                    
				                ?>
				                </p></td>
				                <td width="100" align="right"  title="ReqId=<? echo $ReqIds;?>"><p><A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','1st_chemi_dyes_batch_dtls_popup','<? echo $ReqIds; ?>',2)">
				                <?
								
				                
				                 // echo number_format($first_dyeing_cost,4,".","");
								  $total_dyes_cost+=$first_dyeing_cost; 
								  $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
				                  $total_batch_chemical_price+=$batch_chemical_price;
								  $total_batch_tot_fin_cost+=$tot_fin_cost;
				                ?>
				                </A> <?   echo number_format($first_dyeing_cost,4,".","");?></p></td>
								<td width="100" align="right"><p><?     echo fn_number_format($first_dyeing_cost/$tot_batch_weight,4,".","");  ?>  </p></td>
								<td width="100" align="right"><p>  <?  echo number_format($batch_chemical_price,4,".","");  ?>  </p></td>
								<td width="100" align="right"><p><?
								$sum_of_chemical_and_dyes_cost=$first_chemi_cost+ $first_dyeing_cost; 
								echo fn_number_format($sum_of_chemical_and_dyes_cost,4,".",""); 
								//echo fn_number_format($batch_chemical_price/$tot_batch_weight,4,".","");   ?> </p></td>
								<td width="100" align="right"><p> <?   echo number_format($tot_fin_cost,4,".","");  ?> </p></td>

				                <td width="100" align="right"><p><?  echo number_format(($tot_batch_weight>0) ? $tot_fin_cost/$tot_batch_weight : 0,4,".",""); ?></p></td>
				                <td width="100" title="Tot Dye+Chemical+Fin Cost Per" align="right"><p>
				                <? 
								$tot_dye_chemi_fin_cost_per=($batch_chemical_price/$tot_batch_weight)+($tot_fin_cost/$tot_batch_weight);
				                $extension_no="";
				                //$re_batch_date="";
				             //   $batch_date=explode(",", $redying_details_arr[$b_id]['batch_date']);	
				               
				                echo fn_number_format($tot_dye_chemi_fin_cost_per,4,".","");
				                 ?></p></td>
				                <td width="100" title="BatchId=<? echo $b_id;?>" align="right"><p>
				                <?		                
				                //echo $redying_details_arr[$b_id]['id'].jahid;
								
				                if(trim($redying_details_arr[$b_id]['id']))
				                {
				                    $re_dying_id_all=array_unique(explode(",",$redying_details_arr[$b_id]['id']));
				                   
				                    $result_id="";
				                    $result_id_last='';
				                    foreach($re_dying_id_all as $ash_id)
				                    {
				                   
				                     if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                    
				                    }
				                }
				                //echo $b_id;
								$re_floors='';
				                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
				                //print_r($reding_batch_id);//echo $reding_batch_id[$b_id]."##".$b_id;
				                
								//echo $extention_no.'D=';
								$re_tot_chemicalCost=$re_tot_chemicalCost_fin=$re_tot_dyesCost_fin=0; $tot_fin_cost_redying=0;
								if($extention_no>0)
								{
									$re_batch_weight=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
									
									$re_issue_amt_deys=0;$re_issue_amt_chemical=0;$re_tot_dyesCost=0;
									$rebatchIdArr="";
									foreach($ReqIdsArr as $reqId)
									{
										 
										$re_issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										$re_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
									//	echo $re_issue_amt_chemical.'='.$re_issue_amt_deys.'='.$re_batch_weight.'<br>';

										$re_issue_amt_chemical_fin=$issue_item_cat_amt_dtls_fin_arr[$reqId][5]+$issue_item_cat_amt_dtls_fin_arr[$reqId][7];
										$re_issue_amt_deys_fin=$issue_item_cat_amt_dtls_fin_arr[$reqId][6];
										 $batch_ids=$ReqBatch_id_arr[$reqId]; 
									 
										$batchIds=rtrim($batch_ids,',');
										$rebatchIdArr=array_unique(explode(",",$batchIds)); 
										$re_tot_batch_wgt=0;
										foreach($rebatchIdArr as $rebatchId)
										{
											//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
												$re_tot_batch_wgt+=$batch_wgt_arr[$rebatchId]['batchWgt']; 
										}
										if($re_issue_amt_chemical>0)
										{
										$re_tot_chemicalCost+= (($re_issue_amt_chemical/$re_tot_batch_wgt)*$re_batch_weight);
										}
										if($re_issue_amt_deys>0)
										{
											//echo $b_id.'='.($re_issue_amt_deys/$re_tot_batch_wgt)*$batch_weight.'<br>';
										$re_tot_dyesCost+= (($re_issue_amt_deys/$re_tot_batch_wgt)*$re_batch_weight);
										}

										if($re_issue_amt_chemical_fin>0)
										{
										$re_tot_chemicalCost_fin+= (($re_issue_amt_chemical_fin/$re_tot_batch_wgt)*$re_batch_weight);
										}
										if($re_issue_amt_deys_fin>0)
										{
											//echo $b_id.'='.($re_issue_amt_deys/$re_tot_batch_wgt)*$batch_weight.'<br>';
										$re_tot_dyesCost_fin+= (($re_issue_amt_deys_fin/$re_tot_batch_wgt)*$re_batch_weight);
										}
										
									}

										$tot_fin_cost_redying=$re_tot_dyesCost_fin+$re_tot_chemicalCost_fin;
									if($re_tot_chemicalCost)
									{
									//$re_issue_amt_perKg_chemical=($re_issue_amt_chemical/$re_tot_batch_wgt);
									$re_issue_amt_cal_chemical=$re_tot_chemicalCost;
									}
									else 
									{$re_issue_amt_cal_chemical=0;}
									
									if($re_tot_dyesCost)
									{
									//$re_issue_amt_perKg_dyes=($re_issue_amt_deys/$re_tot_batch_wgt);
									$re_issue_amt_cal_dyes=$re_tot_dyesCost;
									}
									else
									{
										$re_issue_amt_cal_dyes=0;
									}
									
									$re_dying_chemical_cost=$re_issue_amt_cal_chemical;//$costDataArr[$re_bid][5]+$costDataArr[$re_bid][7];
				                    $re_dying_dyes_cost=$re_issue_amt_cal_dyes;//$costDataArr[$re_bid][6]	;	
				                   // $re_dying_dyes_chemical_cost=$re_dying_chemical_cost+$re_issue_amt_cal_dyes;//$costDataArr[$re_bid][5]+$costDataArr[$re_bid][6]+$costDataArr[$re_bid][7];
								}

								echo fn_number_format($re_issue_amt_cal_chemical,4);
								$tot_re_chemical_cost+=$re_issue_amt_cal_chemical;
				                	 ?>
				                
				                
				                </p></td>
				                <td width="100"  title="Tot Chamical Cost/BatchWgt" align="right"><p><?
				              
							  echo fn_number_format($re_issue_amt_cal_chemical/$tot_batch_weight,4);
				              
				                ?></p></td>
				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($re_issue_amt_cal_dyes,4,".",""); 
				                 $tot_re_dying_chemical_cost+=$re_issue_amt_cal_chemical+$re_issue_amt_cal_dyes;
				                 ?>
				                 </p></td>
				                <td width="100" title="Dyes cost/batchWgt" align="right"><p><? echo number_format($re_issue_amt_cal_dyes/$tot_batch_weight,4,".",""); $tot_re_dying_dyes_cost+=$re_issue_amt_cal_dyes;  ?></p></td>

				                <td width="100" align="right" title="ReqId=<? echo $ReqIds;?>"><A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','1st_chemi_dyes_batch_dtls_popup','<? echo $ReqIds; ?>',2)"><p><? //echo number_format($re_issue_amt_cal_chemical+$re_issue_amt_cal_dyes,4,".",""); $tot_re_dying_dyes_chemical_cost+=$re_issue_amt_cal_chemical+$re_issue_amt_cal_dyes; ?></p></A><?  echo fn_number_format($re_issue_amt_cal_chemical,4);
								$tot_re_issue_amt_chemical_cost+=$re_issue_amt_cal_chemical;
								?></td>

								<td width="100" align="right"><p> <?  $re_dye_chemi_cost_per_re=($re_issue_amt_cal_chemical+$re_issue_amt_cal_dyes)/$tot_batch_weight;
								$tot_re_dye_chemi_cost_per_re+=$re_dye_chemi_cost_per_re;
								echo number_format($re_dye_chemi_cost_per_re,4,".",""); ?> </p></td>

								<td width="100" align="right"><p> <?   echo number_format($tot_fin_cost_redying,4,".","");
								$tot_re_fin_cost+=$tot_fin_cost_redying; ?> </p></td>
								<td width="100" align="right" title="Fin Cost/BatchWgt"><p> <?   echo fn_number_format($tot_fin_cost_redying/$tot_batch_weight,4,".","");//$tot_re_dying_chemical_cost+=$re_dying_chemical_cost; ?> </p></td>
								<td width="100" align="right"><p> <?   echo fn_number_format($re_dye_chemi_cost_per_re+($tot_fin_cost_redying/$tot_batch_weight),4,".","");
								 $tot_re_fin_dying_chemical_cost+=$re_dye_chemi_cost_per_re+($tot_fin_cost_redying/$tot_batch_weight); ?> </p></td>
				                 

				                <td width="100" align="right"><?
								$tot_batch_costing=$tot_fin_cost_redying+$re_issue_amt_cal_chemical+$re_issue_amt_cal_dyes+$batch_chemical_price+$tot_fin_cost;
								echo fn_number_format($tot_batch_costing,4,".",""); ?></td>
				                <td width="" title="Tot Batch Cost/BatchWgt" align="right" title="Tot batch Cost/BatchWgt"><?
				                 echo  fn_number_format($tot_batch_costing/$tot_batch_weight,4);  ?></td>
				              
				            </tr>
							<? 	
						 	$total_tot_batch_cost+=$tot_batch_costing;											
							$i++; 			
						}	
					}
					?>
	            </tbody>
	      	</table>
      	</div>
       	<table width="3020" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="80">&nbsp;</th>
					<th width="80">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                 
                  
                    <th width="100">&nbsp;</th>
                    <th width="100">Total</th>
                	<th width="100"><? echo number_format($total_batch_weight,4); ?></th>
					<th width="100">&nbsp;</th>
					<th width="100">&nbsp;</th>
                    <th width="100"  title="<? echo $sub_buyer_grnd_tot_batchQty.'='.$total_tot_batch_weight;?>">
					<?  echo number_format($total_chemical_cost,4); ?></th>
					<th width="100"><? echo number_format(($total_chemical_cost)/$total_batch_weight,4); ?></th>

                	<th width="100" id="value_total_chemical_cost_single"><? echo number_format($total_dyes_cost,4); ?></th>
                	<th width="100" id="value_total_dyeing_cost_single"><? echo number_format($total_dyes_cost/$total_batch_weight,4);; ?></th>
                    <th width="100" id="value_total_chemical_price_single"><? echo number_format($total_batch_chemical_price,4); ?></th>
                    <th width="100" id=""><? echo number_format($total_batch_chemical_price/$total_batch_weight,4); ?></th>

                    <th width="100"><?  echo number_format($total_batch_tot_fin_cost,4); ?></th>
					<th width="100"><?  echo fn_number_format($total_batch_tot_fin_cost/$total_batch_weight,4);; ?></th>
					<th width="100"><?  echo fn_number_format(($total_dyes_cost/$total_batch_weight)+($total_batch_tot_fin_cost/$total_batch_weight),4); ?></th>
					<?
					$total_main_costing_per=($total_dyes_cost/$total_batch_weight)+($total_batch_tot_fin_cost/$total_batch_weight);
					?>
					<th width="100"><?  echo fn_number_format($tot_re_chemical_cost,4); ?></th>
					<th width="100"><?  echo number_format($tot_re_chemical_cost/$total_batch_weight,4); ?></th>
					<th width="100"><?  echo number_format($tot_re_dying_dyes_cost,3); ?></th>
					<th width="100"><?  echo number_format($tot_re_dying_dyes_cost/$total_batch_weight,4); ?></th>

                    <th width="100" id="value_total_redying_dying_cost_single"><p><? echo number_format($tot_re_chemical_cost+$tot_re_dying_dyes_cost,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single"><p><? echo number_format($tot_re_dye_chemi_cost_per_re,4); ?></p></th>
					<th width="100"><?   echo number_format($tot_re_fin_cost,4); ?></th>
					<?
					$total_redying_costing_per=($tot_re_dying_dyes_cost/$total_batch_weight)+($tot_re_fin_cost/$total_batch_weight);
					?>

					<th width="100"><?   echo fn_number_format($tot_re_fin_cost/$total_batch_weight,4); ?></th>
					<th width="100"><?  echo number_format($tot_re_fin_dying_chemical_cost,4); ?></th>
                    
                    <th width="100" id="value_total_total_cost_single"><? echo number_format($total_tot_batch_cost,4); ?></th>
                    <th width="" id="" title=" Batch Costing/Batch Qty=<? //echo number_format($tot_main_batch_weight,2);?>">
					<? echo number_format($total_tot_batch_cost/$total_batch_weight,4); ?></th>
                     
                </tr>
            </tfoot>
        </table>
    </div>
    <?
    $html = ob_get_contents();
    ob_clean();
    //$new_link=create_delete_report_file( $html, 2, $delete, "../../../" );
    foreach (glob("*.xls") as $filename) {
    //if( @filemtime($filename) < (time()-$seconds_old) )
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');	
    $is_created = fwrite($create_new_doc, $html);


    $filename2=$user_id."_summary_".$name.".xls";
    $create_new_doc2 = fopen($filename2, 'w');	
    $is_created2 = fwrite($create_new_doc2, $summaryHTML);

    echo "$html****$filename****$filename2****$report_type"; 
    exit();
}
if($action=="generate_report3") // All Dyeing Cost 
{ 
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if ($cbo_company_name==0) $company_id=""; else $company_id=" and a.company_id='$cbo_company_name'";
	if ($cbo_company_name==0) $company_idcond =""; else $company_idcond =" and b.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond .=""; else $company_idcond .=" and b.working_company_id='$cbo_working_name'";
	//echo $cbo_company_name.'='.$cbo_working_name;die;
	

	if ($cbo_company_name==0 && $cbo_working_name==0) 
	{
	$w_company_idcond ="";$w_company_idcond2="";$w_company_idcond3="";$w_company_idcond4="";
	}
	 else  {
		 if ($cbo_company_name==0 && $cbo_working_name>0)
		 {
		  	$w_company_idcond =" and c.company_id='$cbo_working_name'";
			$w_company_idcond2 =" and b.knit_dye_company='$cbo_working_name'";
			$w_company_idcond3 =" and b.working_company_id='$cbo_working_name'";
			$w_company_idcond4 =" and a.service_company='$cbo_working_name'";
		 }
		 else  if ($cbo_company_name>0 && $cbo_working_name==0)
		 {
		  $w_company_idcond =" and c.company_id='$cbo_company_name'";
		  $w_company_idcond2 =" and b.knit_dye_company='$cbo_company_name'";
		  $w_company_idcond4 =" and a.company_id='$cbo_company_name'";
		  $w_company_idcond3 ="and b.company_id='$cbo_company_name'";
		 }
	 }
	 // echo  $w_company_idcond.'dd'.$company_idcond;die;
	
	$from_date=str_replace("'","",$from_date);
	$to_date=str_replace("'","",$to_date);
	//echo $from_date;
	$txt_ref_no=str_replace("'","",$txt_ref_no); 
	$txt_file_no=str_replace("'","",$txt_file_no);
	$txt_booking_no=str_replace("'","",$txt_booking_no);
	$txt_po_no=str_replace("'","",$txt_po_no);
	$txt_job=str_replace("'","",$txt_job);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$cbo_season_id=str_replace("'","",$cbo_season_id);
	$txt_samp_ref_no=str_replace("'","",$txt_samp_ref_no);
	$location_id=str_replace("'","",$location_id);
	$floor_id=str_replace("'","",$floor_id);
	$report_type=str_replace("'","",$report_type);
	$cbo_year=str_replace("'","",$cbo_year_selection);

	
	
	if(str_replace("'","",$cbo_buyer_name)==0)
	{
		if ($_SESSION['logic_erp']["data_level_secured"]==1)
		{
			if($_SESSION['logic_erp']["buyer_id"]!="") $buyer_id_cond=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")"; else $buyer_id_cond="";
		}
		else
		{
			$buyer_id_cond="";
		}
	}
	else
	{
		$buyer_id_cond=" and a.buyer_name in (".str_replace("'","",$cbo_buyer_name).")";
	}
	
	if($txt_booking_no!='') $booking_no_cond="and b.booking_no like '%$txt_booking_no%' ";else $booking_no_cond="";
	if($db_type==0)
		{
			$year_cond=" and SUBSTRING_INDEX(a.insert_date, '-', 1)=$cbo_year";
		}
		else if($db_type==2)
		{
			$year_cond=" and to_char(a.insert_date,'YYYY')=$cbo_year";
		}
		
	if($txt_file_no!='') $file_cond="and b.file_no=$txt_file_no";else $file_cond="";
	if($txt_job!='') $job_cond="and a.job_no_prefix_num=$txt_job  $year_cond";else $job_cond="";
	if($txt_po_no!='') $po_cond="and b.po_number='$txt_po_no'";else $po_cond="";
	
	if($cbo_season_id!=0) $season_cond="and a.season_buyer_wise in($cbo_season_id)";else $season_cond="";
	
	if($txt_ref_no!='') $ref_cond="and b.grouping='$txt_ref_no'";else $ref_cond="";
	if($txt_samp_ref_no!='') $samp_ref_cond="and a.grouping='$txt_samp_ref_no'";else $samp_ref_cond="";
	//echo $ref_cond;
	$companyArr = return_library_array("SELECT id,company_name from lib_company where status_active=1 and is_deleted=0","id","company_name"); 
	$supplierArr = return_library_array("SELECT id,supplier_name from lib_supplier where status_active=1 and is_deleted=0","id","supplier_name"); 
	$color_arr=return_library_array( "SELECT id,color_name  from  lib_color", "id", "color_name"  );
	$buyer_arr=return_library_array( "SELECT id,buyer_name  from  lib_buyer", "id", "buyer_name"  );
	$season_name_arr=return_library_array( "SELECT id,season_name  from  lib_buyer_season", "id", "season_name"  );
	
	if($db_type==0) 
	{
	$from_date=change_date_format($from_date,'yyyy-mm-dd'); $to_date=change_date_format($to_date,'yyyy-mm-dd');
	}
    if($db_type==2) 
	{
	$from_date=change_date_format($from_date,'','',1);  $to_date=change_date_format($to_date,'','',1);
	}
	//echo $from_date;
	$batch_description_arr=array();
	/* 
	if(str_replace("'","",$batch_id)!="") $batch_cond=" and b.id in(".str_replace("'","",$batch_id).")";
    else  */
	//echo $batch_cond; //die;
	//echo $batch_no; //die;
    	//echo $batch_no;
	$batch_no=implode("','",array_unique(explode(",",$batch_no)));
	if(str_replace("'","",$batch_no)!="") $batch_cond=" and b.batch_no in('".$batch_no."') "; 
	else $batch_cond="";
	//echo $batch_cond."shakil"; die;
	//
	/* and b.re_dyeing_from=0 13-11-16 according to siddique sir dicission when search buyer order or subcontract all batch appear */
	if($batch_type==0)
	$search_field_cond_batch="";
	else if($batch_type==1)
	$search_field_cond_batch="and b.entry_form=0 ";
	else if($batch_type==2)
	$search_field_cond_batch="and b.entry_form=36";
	else if($batch_type==4)
	$search_field_cond_batch="and b.entry_form=136";
	else if($batch_type==5)
	$search_field_cond_batch="and b.batch_against=3";// sample
	else 
	$search_field_cond_batch="and b.entry_form in(0,36) and b.batch_against in(2) and  b.re_dyeing_from!=0 ";
 //echo $search_field_cond_batch.'D';die;
	
 	$con = connect();
	 execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id."   and ENTRY_FORM=48");
	// oci_commit($con);
	// disconnect($con);

	if($txt_file_no!='' || $txt_ref_no!='' ||  $txt_po_no!='' || $txt_job!='' || $cbo_buyer_name>0)
	{
		
		if($batch_type==4) //Trim batch
		{
		 $sql_po="SELECT c.id as batch_id,a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b,pro_batch_create_mst c where a.id=b.job_id and b.job_no_mst=c.job_no  and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond";
		}
		else
		{
			$sql_po="SELECT a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b  where a.id=b.job_id and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond";
		}
		// echo $sql_po;die; 
		$res_po=sql_select($sql_po);
		$all_po_id='';
		foreach($res_po as $row) //$job_no_arr
		{			
			if($all_po_id=="") $all_po_id=$row[csf('id')]; else $all_po_id.=",".$row[csf('id')]; //echo $all_po_id;
			
			$trim_batch_idArr[$row[csf('batch_id')]]=$row[csf('batch_id')];
			$po_idArr[$row[csf('id')]]=$row[csf('id')];
		}
		//echo $all_po_id;
		
		
		fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 1, $po_idArr, $empty_arr);//PO ID Ref from=1
		fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 2, $trim_batch_idArr, $empty_arr);//Batch ID Ref from=2
		if($all_po_id!="") $po_idd="and po_id in($all_po_id)";else $po_idd="and po_id in(0)";
		
		$poIds=chop($all_po_id,','); $po_cond_for_in="";
		$po_ids=count(array_unique(explode(",",$all_po_id)));
		if($db_type==2 && $po_ids>1000)
		{
			$po_cond_for_in=" and (";
			$poIdsArr=array_chunk(explode(",",$poIds),999);
			foreach($poIdsArr as $ids)
			{
				$ids=implode(",",$ids);
				$po_cond_for_in.=" po_id in($ids) or"; 
			}
			$po_cond_for_in=chop($po_cond_for_in,'or ');
			$po_cond_for_in.=")";
		}
		else
		{
			$po_cond_for_in=" and po_id in($poIds)";
			
		}
		
		if($batch_type==4) //Trim batch
		{
		 	$po_cond_for_in='';
			$po_cond_for_in=where_con_using_array($trim_batch_idArr,0,"mst_id");
			//echo "SELECT b.mst_id as batch_id from pro_batch_trims_dtls b  where   b.status_active=1 and b.is_deleted=0 $po_cond_for_in";die;
			$sql_batch=sql_select("SELECT b.mst_id as batch_id from pro_batch_trims_dtls b,gbl_temp_engine g   where  b.mst_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and b.status_active=1 and b.is_deleted=0 ");
		}
		else
		{
			$sql_batch=sql_select("SELECT b.mst_id as batch_id from pro_batch_create_dtls b,gbl_temp_engine g  where   b.po_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=1 and g.entry_form=48  and b.status_active=1 and b.is_deleted=0  ");
		}
		//echo "SELECT mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in";die();
		 $all_batch_id='';
		foreach($sql_batch as $row) 
		{
			if($all_batch_id=="") $all_batch_id=$row[csf('batch_id')]; else $all_batch_id.=",".$row[csf('batch_id')];
		}
			$all_batch_ids=implode(",",array_unique(explode(",",$all_batch_id)));
		//echo $all_batch_ids; 
		$batch_ids_cond="";
		if($all_batch_ids!="") 
		{
			//echo $po_id=substr($po_id,0,-1);
			if($db_type==0) { $batch_ids_cond="and b.id in(".$all_batch_ids.")"; }
			else
			{
				$bat_id=array_unique(explode(",",$all_batch_ids));
				if(count($bat_id)>1000)
				{
					$batch_ids_cond="and (";
					$bat_id=array_chunk($bat_id,1000);
					$z=0;
					foreach($bat_id as $id)
					{
						$id=implode(",",$id);
						if($z==0) $batch_ids_cond.=" b.id in(".$id.")";
						else $batch_ids_cond.=" or b.id in(".$id.")";
						$z++;
					}
					$batch_ids_cond.=")";
				}
				else { 
				
				$batch_ids_cond=" and b.id in(".$all_batch_ids.")"; }
			}
		}
	}
	// print_r($batch_ids_cond);die;
	if($from_date!="" && $to_date!="")
	{
		$date_cond_samp="";
		if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond_samp=" and b.batch_date between '".$from_date."' and '".$to_date."'";
		}
	}


	/* ================================================================================ /
	/								Main query start here								/
	/ ================================================================================ */
	  $samp_non_booking=sql_select("SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no_id=a.id and a.booking_type=4  $company_idcond $w_company_idcond3 $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
	//  echo "SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	// from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $w_company_idcond3 $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";  
	 

	$all_batch_id_samp="";
	foreach($samp_non_booking as $row)
	{
		$non_buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$non_buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$sample_booking_ref_no_arr[$row[csf('booking_no')]]=$row[csf('grouping')];
		if($txt_samp_ref_no!='')
		{
		if($all_batch_id_samp=="") $all_batch_id_samp=$row[csf('batch_id')]; else $all_batch_id_samp.=",".$row[csf('batch_id')];
		}
	}
	if($all_batch_id_samp!="") $all_batch_id_samp_cond="and b.id in($all_batch_id_samp)";else $all_batch_id_samp_cond="";
	//echo $all_batch_id_samp_cond.'X';
	$company_id_issue="";$company_idcond_issue="";
	if ($cbo_company_name==0) $company_id_issue=""; else $company_id_issue=" and b.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond_issue=""; else $company_idcond_issue =" and b.working_company_id='$cbo_working_name'";
	if ($cbo_working_name==0) $w_company_idcond_issue=""; else $w_company_idcond_issue =" and b.knit_dye_company='$cbo_working_name'";

	
    if($from_date!="")
    {
		if(str_replace("'","",$cbo_value_with)==1)
		{
			$date_cond=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";
			$trans_date_cond=" and a.transaction_date between '".$from_date."' and '".$to_date."' ";

		//and b.batch_against in(1,2,3)
			 $sql="SELECT b.id,b.sales_order_id,a.batch_no,a.fabric_type,b.booking_without_order,b.job_no,b.extention_no,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from,a.result
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
			and a.entry_form in (35,38) and a.load_unload_id=2   and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  $company_id_issue  $company_idcond_issue $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";
			
 
			  $sql_load="SELECT b.id,b.sales_order_id,a.batch_no,a.fabric_type,b.booking_without_order,b.job_no,b.extention_no,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
			and a.entry_form in (35,38) and a.load_unload_id=1  and a.batch_ext_no is not null  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  $w_company_idcond4 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";

			  $issue_sql_main= "SELECT a.MST_ID ,a.REQUISITION_NO,b.BATCH_NO,a.ITEM_CATEGORY,a.PROD_ID,a.CONS_QUANTITY,a.CONS_AMOUNT from inv_transaction a,inv_issue_master b where a.mst_id=b.id  and b.is_deleted=0 and b.status_active=1 and a.status_active=1 and a.transaction_type=2 and b.entry_form=5 and b.batch_no is not null  $trans_date_cond $company_id_issue $w_company_idcond_issue";		 
			 
		}
		else if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond=" and b.batch_date between '".$from_date."' and '".$to_date."'";
			$sql="SELECT b.id,b.sales_order_id,b.batch_no,b.booking_without_order,b.job_no,b.extention_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from  
			from  pro_batch_create_mst b where   b.status_active=1 and b.is_deleted=0     $company_id_issue  $company_idcond_issue $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";

			$sql_load="SELECT b.id,b.sales_order_id,a.batch_no,a.fabric_type,b.booking_without_order,b.job_no,b.extention_no,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
			and a.entry_form in (35,38) and a.load_unload_id=1  and a.batch_ext_no is not null  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  $w_company_idcond4 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";

			$issue_sql_main= "SELECT a.MST_ID ,a.REQUISITION_NO,b.BATCH_NO,a.ITEM_CATEGORY,a.PROD_ID,a.CONS_QUANTITY,a.CONS_AMOUNT from inv_transaction a,inv_issue_master b where a.mst_id=b.id  and b.is_deleted=0 and b.status_active=1 and a.status_active=1 and a.transaction_type=2 and b.entry_form=5 and b.batch_no is not null  $trans_date_cond $company_id_issue $w_company_idcond_issue";	
			 
			
		}
   	}
   	else
   	{
		 
		$sql="SELECT b.id,b.sales_order_id,b.booking_without_order,b.job_no,b.extention_no,b.batch_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
		from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0    $company_id_issue  $company_idcond_issue $batch_cond $batch_ids_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";

		  $sql_load="SELECT b.id,b.sales_order_id,a.batch_no,a.fabric_type,b.booking_without_order,b.job_no,b.extention_no,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
		from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
		and a.entry_form in (35,38) and a.load_unload_id=1  and a.batch_ext_no is not null  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  $w_company_idcond4 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";

		$issue_sql_main= "SELECT a.MST_ID ,a.REQUISITION_NO,b.BATCH_NO,a.ITEM_CATEGORY,a.PROD_ID,a.CONS_QUANTITY,a.CONS_AMOUNT from inv_transaction a,inv_issue_master b where a.mst_id=b.id  and b.is_deleted=0 and b.status_active=1 and a.status_active=1 and a.transaction_type=2 and b.entry_form=5 and b.batch_no is not null  $trans_date_cond $company_id_issue $w_company_idcond_issue";	
		
	}
	   //echo $issue_sql_main; 
	$sql_res=sql_select($sql);
	$sql_res_load=sql_select($sql_load);
	 $sql_res_issue=sql_select($issue_sql_main);
	 
	if(count($sql_res)==0 && count($sql_res_load)==0  && count($sql_res_issue)==0)
    {
        ?>
        <div style="font-size:20px;color:red;text-align:center">Data not found!</div>
        <?
        die;
    }
	foreach($sql_res_load as $row)
	{
		 
		$load_batch_arr[$row[csf("id")]]=$row[csf("id")];

	//==================Re Dying==================
		$re_batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
		$re_batch_description_arr[$row[csf("id")]]['batch_weight']=$row[csf("batch_weight")];
				
		$re_batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
		$re_batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
		$re_batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
	
		$re_batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
		$re_batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
		$re_batch_description_arr[$row[csf("id")]]['job_no']=$row[csf("job_no")];
		
		$re_batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
		$re_batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
		$re_batch_no_arr[]="'".$row[csf("batch_no")]."'";
		// $batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
		
		$re_batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
		$re_batch_wise_arr[$row[csf("batch_no")]]['batch_no']=$row[csf("batch_no")];
		$re_batch_wise_arr[$row[csf("batch_no")]]['extention_no'].=$row[csf("extention_no")].',';
		$re_batch_wise_arr[$row[csf("id")]]['extention_no']=$row[csf("extention_no")];
		$re_batch_wise_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
	
		$re_batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';

		if($row[csf("sales_order_id")]!='')
		{
		$sales_batch_arr[$row[csf("id")]]=$row[csf("sales_order_id")];
	//echo $row[("SALES_ORDER_ID")].', ';
		$sales_id_arr[$row[csf("sales_order_id")]]=$row[csf("sales_order_id")];
		}

	}
	foreach($sql_res_issue as $row)
	{
		if($row["BATCH_NO"]!="")
		{
			$withoutLoadbatchNoArr=explode(",",$row["BATCH_NO"]);
			foreach($withoutLoadbatchNoArr as $bid)
			{
				if($bid>0)
				{
					//$re_issue_single_batch_arr[$bid]=$bid;
					$issue_batch_all_arr[$bid]=$bid;
				}
				
			}
		}
	}
	
//	print_r($re_issue_single_batch_arr);
	 
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 9, $load_batch_arr, $empty_arr);//Batch ID Ref from=9
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 10, $issue_batch_all_arr, $empty_arr);//Batch ID Ref from=10
	//print_r($issue_batch_all_arr);

  $sql_batch_arr_unload = "SELECT a.batch_id as BATCH_ID,a.ENTRY_FORM,a.BATCH_EXT_NO from pro_fab_subprocess a,gbl_temp_engine g where a.batch_id=g.ref_val  and g.user_id = ".$user_id." and a.load_unload_id=2 and g.ref_from=9 and g.entry_form=48 and a.batch_ext_no is not null and a.status_active=1 and a.is_deleted=0 ";
  $sql_res_unloadChk=sql_select($sql_batch_arr_unload);
  foreach($sql_res_unloadChk as $row)
  {
		$unload_batch_chk_arr[$row["BATCH_ID"]]=$row["BATCH_ID"];
  }
if(count($unload_batch_chk_arr)>0)
{
	$withoutUnload_diffArr=array_diff($load_batch_arr,$unload_batch_chk_arr); //Only Load batch Found
}
else $withoutUnload_diffArr=$load_batch_arr;//array_diff($load_batch_arr,$unload_batch_chk_arr); //Only Load batch Found
  

  $sql_batch_arr_issue_load = "SELECT a.batch_id as BATCH_ID,a.ENTRY_FORM,a.BATCH_EXT_NO from pro_fab_subprocess a,gbl_temp_engine g where a.batch_id=g.ref_val  and g.user_id = ".$user_id." and a.load_unload_id=1 and g.ref_from=10 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0 and a.batch_ext_no is not null ";
  $sql_res_loadChk=sql_select($sql_batch_arr_issue_load);
  foreach($sql_res_loadChk as $row)
  {
	$load_batch_chk_arr[$row["BATCH_ID"]]=$row["BATCH_ID"];
  }
  $sql_batch_arr_issue_ext = "SELECT a.id as BATCH_ID,a.BATCH_NO,a.ENTRY_FORM,a.EXTENTION_NO,a.COLOR_RANGE_ID,a.SALES_ORDER_ID,a.BATCH_WEIGHT,a.JOB_NO,a.ENTRY_FORM,a.BATCH_DATE,a.BOOKING_NO,a.BOOKING_WITHOUT_ORDER,a.COLOR_ID from pro_batch_create_mst a,gbl_temp_engine g where a.id=g.ref_val  and g.user_id = ".$user_id."  and g.ref_from=10 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0 and a.extention_no is not null ";
  $sql_res_ext_chk=sql_select($sql_batch_arr_issue_ext);
  foreach($sql_res_ext_chk as $row)
  {
	$batch_chk_arr[$row["BATCH_ID"]]=$row["BATCH_ID"];

		$re_batch_arr[$row[("BATCH_ID")]]=$row[("BATCH_NO")];
		$re_batch_description_arr[$row[("BATCH_ID")]]['batch_weight']=$row[("BATCH_WEIGHT")];
		
				
		$re_batch_description_arr[$row[("BATCH_ID")]]['batch_date']=$row[("BATCH_DATE")];
		$re_batch_description_arr[$row[("BATCH_ID")]]['booking_no']=$row[("BOOKING_NO")];
		$re_batch_description_arr[$row[("BATCH_ID")]]['without_order']=$row[("BOOKING_WITHOUT_ORDER")];

		$re_batch_description_arr[$row[("BATCH_ID")]]['color_id']=$row[("COLOR_ID")];
		$re_batch_description_arr[$row[("BATCH_ID")]]['entry_form']=$row[("ENTRY_FORM")];
		$re_batch_description_arr[$row[("BATCH_ID")]]['job_no']=$row[("JOB_NO")];
		$re_batch_description_arr[$row[("BATCH_ID")]]['color_range']=$row[("COLOR_RANGE_ID")];
		$re_batch_no_arr[]="'".$row[("BATCH_NO")]."'";

		$re_batch_wise_arr[$row[("BATCH_ID")]]['batch_id'].=$row[("BATCH_ID")].',';
		$re_batch_wise_arr[$row[("BATCH_ID")]]['batch_no']=$row[("BATCH_NO")];
		$re_batch_wise_arr[$row[("BATCH_ID")]]['extention_no'].=$row[("EXTENTION_NO")].',';
		$re_batch_wise_arr[$row[("BATCH_ID")]]['batch_id'].=$row[("BATCH_ID")].',';

		if($row[("SALES_ORDER_ID")]!='')
		{
		$sales_batch_arr[$row[("BATCH_ID")]]=$row[("SALES_ORDER_ID")];
	//echo $row[("SALES_ORDER_ID")].', ';
		$sales_id_arr[$row[("SALES_ORDER_ID")]]=$row[("SALES_ORDER_ID")];
		}
  }
if(count($load_batch_chk_arr)>0)
{
	$withoutloadIssue_diffArr=array_diff($batch_chk_arr,$load_batch_chk_arr);//Only Issue batch Found, not load/unload 
}
else{
	$withoutloadIssue_diffArr=$batch_chk_arr;//Only Issue batch Found, not load/unload
}
 

if(count($withoutUnload_diffArr)>0)
{
	
  $re_issue_single_batch_arr=array_merge($withoutloadIssue_diffArr,$withoutUnload_diffArr);
}
else
{
	$re_issue_single_batch_arr=$withoutloadIssue_diffArr;//array_merge($withoutloadIssue_diffArr,$withoutUnload_diffArr);
}
//   echo "<pre>";
//   print_r($re_issue_single_batch_arr);
  // print_r($withoutUnload_diffArr);
 // echo "<pre>";

  fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 11, $re_issue_single_batch_arr, $empty_arr);//Batch ID Ref from=11

  //===============Redying Batch===========================//batch_no,a.fabric_type,b.booking_without_order,b.job_no,b.extention_no,a.process_end_date as batch_date
  $reding_batch_id=$non_reding_batch_id=$trim_batch_IdArr=array();

  $sql_batch_arr_re = "SELECT a.id as BATCH_ID,a.BATCH_NO,a.BOOKING_WITHOUT_ORDER,a.JOB_NO,a.EXTENTION_NO,A.BATCH_DATE AS BATCH_DATE,a.ENTRY_FORM,a.EXTENTION_NO from pro_batch_create_mst a,gbl_temp_engine g where a.id=g.ref_val  and g.user_id = ".$user_id."  and g.ref_from=11 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0 and a.extention_no is not null ";
  $sql_res_ext_chk=sql_select($sql_batch_arr_re);
  foreach($sql_res_ext_chk as $row)
  {
	$batch_chk_arr[$row["BATCH_ID"]]=$row["BATCH_ID"];
	$reding_batch_id[$row[("BATCH_ID")]]=$row[("BATCH_ID")];

	if($row[("ENTRY_FORM")]=='136') 
	  {
		 	$trim_batch_IdArr[$row[("BATCH_ID")]]=$row[("BATCH_ID")]; 
	  }	
  }

   
//   echo "<pre>";
//   print_r($issue_load_batchArr);
//  // print_r($withoutloadIssue_diffArr);
//   echo "<pre>";
  

	 //=======================Re Dyring==================end=============

  	
    foreach($sql_res as $row)
	{
	// $sub_party_id_not=$sub_batch_chk_arr[$row[csf("id")]];
	  if($row[csf("entry_form")]=='136') 
	  {
		 	$trim_batch_IdArr[$row[csf("id")]]=$row[csf("id")]; 
	  }	
		
		$batch_against_id=$row[csf("batch_against")];
		$batch_id_arr[]=$row[csf("id")];
		$batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
		if($row[csf("sales_order_id")]!='')
		{
		$sales_batch_arr[$row[csf("id")]]=$row[csf("sales_order_id")];
		$sales_id_arr[$row[csf("sales_order_id")]]=$row[csf("sales_order_id")];
		}
		
	//	echo $sub_party_id_not.', ';
		 $issue_single_batch_arr[$row[csf("id")]]=$row[csf("id")];  
		if($batch_against_id==1 || $batch_against_id==3)
		{		
		 
			 $batch_description_arr[$row[csf("id")]]['batch_weight']=$row[csf("batch_weight")];
	 		 
		
			$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
			$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
			
			$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
			$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_description_arr[$row[csf("id")]]['job_no']=$row[csf("job_no")];
			
			$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
			$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
			$batch_no_arr[]="'".$row[csf("batch_no")]."'";
			// $batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			$batch_wise_arr[$row[csf("batch_no")]]['batch_no']=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['extention_no'].=$row[csf("extention_no")].',';
			$batch_ext_wise_arr[$row[csf("id")]]['extention_no']=$row[csf("extention_no")];
			$batch_description_arr[$row[csf("id")]]['result']=$row[csf("result")];
			
		}
		if($batch_against_id==2)
		{
			 
			 
			 $batch_description_arr[$row[csf("id")]]['batch_weight']=$row[csf("batch_weight")];
			 $batch_description_arr[$row[csf("id")]]['re_batch_weight']=$row[csf("batch_weight")];
			 $batch_description_arr[$row[csf("id")]]['result']=$row[csf("result")];
			 
			$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
			$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
			//$batch_description_arr[$row[csf("id")]]['batch_weight']+=$row[csf("batch_weight")];
			$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
			$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_description_arr[$row[csf("id")]]['job_no']=$row[csf("job_no")];
			
			$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
			$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
			$batch_no_arr[]="'".$row[csf("batch_no")]."'";
			// $batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
			
			$batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			$batch_wise_arr[$row[csf("batch_no")]]['batch_no']=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['extention_no'].=$row[csf("extention_no")].',';
			$batch_ext_wise_arr[$row[csf("id")]]['extention_no']=$row[csf("extention_no")];
			$batch_ext_wise_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$re_all_batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			
		}
		if($row[csf("batch_against")]==2)
		{
			$reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
		else
		{
			$non_reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
		
	 
	}
	 
	// echo "<pre>"; print_r($re_Dbatch_description_arr); die();

	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 3, $issue_single_batch_arr, $empty_arr);//Batch ID Ref from=3

	//	********************************************************************************************************************************
     $batch_id_sql=implode(",",$batch_id_arr);
    if($batch_id_sql=="") $batch_id_sql=0;
	//echo  $batch_id_sql;
  	// if($batch_type==3)
	// {
	// 	//$re_dying_cond2=" and b.id in(".$batch_id_sql.")";
	// 	if(count($batch_id_arr)>0)
	// 	{
	// 		$re_dying_cond2=" and (";
	// 		if(count($batch_id_arr)>999 && $db_type==2)
	// 		{
	// 			$prod_id_chank=array_chunk($batch_id_arr,999);
	// 			foreach($prod_id_chank as $batch_id)
	// 			{
	// 				$re_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
	// 			}
	// 			$re_dying_cond2=chop($re_dying_cond2,"or");
	// 		}
	// 		else
	// 		{
	// 			//die("with naz");
	// 			$re_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
	// 		}
	// 		$re_dying_cond2.=")";
	// 	}
	// }
	// else
	// {
	// 	//$re_dying_cond=" and b.re_dyeing_from in(".$batch_id_sql.")";	
	// 	//$pord_ids = explode(",",$txt_product_id);
	// 	//echo count($pord_ids);die;
	// 	if(count($batch_id_arr)>0)
	// 	{
	// 		$re_dying_cond=" and (";
	// 		if(count($batch_id_arr)>999 && $db_type==2)
	// 		{
	// 			$prod_id_chank=array_chunk($batch_id_arr,999);
	// 			foreach($prod_id_chank as $batch_id)
	// 			{
	// 				$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id).") or";
	// 			}
	// 			$re_dying_cond=chop($re_dying_cond,"or");
	// 		}
	// 		else
	// 		{
	// 			//die("with naz");
	// 			$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id_arr).")";
	// 		}
	// 		$re_dying_cond.=")";
	// 	}
	// }

	//$date_cond2=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";

	// =============================================================
	$batch_all_id_array=array();
//	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
	//   $sql = "SELECT a.ID,b.mst_id as REQ_ID,a.batch_id as BATCH_ID,a.BATCH_QTY,a.BATCH_QTY,a.NEW_BATCH_WEIGHT,a.ENTRY_FORM,c.batch_id as RE_BATCH_ID from pro_recipe_entry_mst a, dyes_chem_requ_recipe_att b,dyes_chem_issue_requ_mst c where b.recipe_id=a.id  and c.id=b.mst_id $batch_id_conds and a.status_active=1 and a.is_deleted=0 and b.status_active=1 ";
	  $sql_req = "SELECT a.ID,b.mst_id as REQ_ID,a.batch_id as BATCH_ID,a.BATCH_QTY,a.BATCH_QTY,a.NEW_BATCH_WEIGHT,a.ENTRY_FORM,c.batch_id as RE_BATCH_ID,g.ref_from as REF_FROM from pro_recipe_entry_mst a, dyes_chem_requ_recipe_att b,dyes_chem_issue_requ_mst c,gbl_temp_engine g where b.recipe_id=a.id  and c.id=b.mst_id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from in(11,3) and g.entry_form=48 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 ";
	 // echo $sql;die; 
	$req_res = sql_select($sql_req);
	$req_id_array = array();	$re_req_id_array = array();
	foreach ($req_res as $val) 
	{
		 
		if($val['REF_FROM']==3) //Ist Part
		{ 
			$req_id_array[$val['REQ_ID']] = $val['REQ_ID'];
			$batch_req_id_array2[$val['BATCH_ID']]= $val['REQ_ID'];
			$batch_all_id_array[$val['BATCH_ID']]= $val['BATCH_ID'];
			if($val['ENTRY_FORM']==60) //Adding Topping
			{
				$batch_wgt=$val['NEW_BATCH_WEIGHT'];
			}
			else
			{
				$batch_wgt=$val['BATCH_QTY'];
			}
			$batch_wgt_array[$val['BATCH_ID']] = $batch_wgt;
			$batchWgtChkk[$val['REQ_ID']].=$val['BATCH_ID'].',';
			$batchIdChkkDtls[$val['REQ_ID']]=$val['BATCH_ID'];
		}
		else //For Re dying part
		{
			$re_req_id_array[$val['REQ_ID']] = $val['REQ_ID'];
			$re_batch_req_id_array2[$val['BATCH_ID']]= $val['REQ_ID'];
			$re_batch_all_id_array[$val['BATCH_ID']]= $val['BATCH_ID'];
			if($val['ENTRY_FORM']==60) //Adding Topping
			{
				$batch_wgt=$val['NEW_BATCH_WEIGHT'];
			}
			else
			{
				$batch_wgt=$val['BATCH_QTY'];
			}
			$re_batch_wgt_array[$val['BATCH_ID']] = $batch_wgt;
			$re_batchWgtChkk[$val['REQ_ID']].=$val['BATCH_ID'].',';
			$re_batchIdChkkDtls[$val['REQ_ID']]=$val['BATCH_ID'];
		}
		
		 
		
	}
	unset($res);
	//  print_r($re_req_id_array);die;

	
	if(count($req_id_array))
	{
		//$requisition_id_cond=where_con_using_array($req_id_array,0,"a.requisition_no");
	}
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 4, $req_id_array, $empty_arr);//Req ID Ref from=4
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 12, $re_req_id_array, $empty_arr);//Re Req ID Ref from=12
	
	$issue_sql = sql_select("SELECT a.MST_ID ,a.REQUISITION_NO,b.BATCH_NO,a.ITEM_CATEGORY,a.PROD_ID,a.CONS_QUANTITY,a.CONS_AMOUNT,g.ref_from as REF_FROM from inv_transaction a,inv_issue_master b,gbl_temp_engine g where a.mst_id=b.id and a.REQUISITION_NO=g.ref_val  and g.user_id = ".$user_id." and g.ref_from in(4,12) and g.entry_form=48 and b.entry_form=5 and b.is_deleted=0 and b.status_active=1 and a.status_active=1 and a.transaction_type=2    ");//$w_company_idcond2
	$issue_id_arr = array();$tot_issueQty=0;  
	foreach ($issue_sql as $val) 
	{
		if($val['REF_FROM']==4) //Ist Part
		{  
			$batchArr=array_filter(array_unique(explode(",",$val['BATCH_NO'])));
			foreach($batchArr as $bid)
			{
				$issue_item_cat_arr[$bid][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['ITEM_CATEGORY'];
				if($bid!='')
				{
				$batch_all_id_array[$bid]= $bid;
				$batch_req_id_array[$bid].= $val['REQUISITION_NO'].',';
				}
			}
				$issue_item_cat_cost_arr[$val['REQUISITION_NO']][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['CONS_QUANTITY'];
				$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_QUANTITY'];
				
				$issue_item_cat_amt_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_AMOUNT'];
			
			$ReqBatch_id_arr[$val['REQUISITION_NO']] = $val['BATCH_NO'];
			$issue_id_arr[$val['MST_ID']] = $val['MST_ID'];
			$tot_issueQty+=$val['CONS_QUANTITY'];
		}
		else //========Redying Part
		{
			$batchArr=array_filter(array_unique(explode(",",$val['BATCH_NO'])));
			foreach($batchArr as $bid)
			{
				$re_issue_item_cat_arr[$bid][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['ITEM_CATEGORY'];
				if($bid!='')
				{
				$re_batch_all_id_array[$bid]= $bid;
				$re_batch_req_id_array[$bid].= $val['REQUISITION_NO'].',';
				}
			}
				$re_issue_item_cat_cost_arr[$val['REQUISITION_NO']][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['CONS_QUANTITY'];
				$re_issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_QUANTITY'];
				
				$re_issue_item_cat_amt_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_AMOUNT'];
			
			$re_ReqBatch_id_arr[$val['REQUISITION_NO']] = $val['BATCH_NO'];
			$re_issue_id_arr[$val['MST_ID']] = $val['MST_ID'];
			//$tot_issueQty+=$val['CONS_QUANTITY'];
		}
		
	}
	// print_r($re_issue_item_cat_amt_dtls_arr);
	// die;
	
	if(count($batch_all_id_array))
	{
		//$batch_ids_cond=where_con_using_array($batch_all_id_array,0,"b.id");
	}
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 5, $batch_all_id_array, $empty_arr);//Batch ID Ref from=5
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 13, $re_batch_all_id_array, $empty_arr);//Re Batch ID Ref from=13

	$batch_fabric_sql=sql_select("SELECT b.id,b.batch_no,b.batch_weight, b.batch_against,g.ref_from as ref_from 
	from pro_recipe_entry_mst  a,pro_batch_create_mst b,gbl_temp_engine g where  a.batch_id=b.id and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from in(13,5) and g.entry_form=48 and a.status_active=1 and a.is_deleted=0" );
	 
	 $batch_wgt_arr=array(); $re_batch_wgt_arr=array();
	 foreach ($batch_fabric_sql as $row) 
	{
		if($row[csf('ref_from')]==5) //Ist Part
		{
			$batch_wgt_arr[$row[csf("id")]]['batchWgt']=$row[csf("batch_weight")];
		}
		else //Redying part
		{
			$re_batch_wgt_arr[$row[csf("id")]]['batchWgt']=$row[csf("batch_weight")];
		}
		
	}
	// =====================================================================================
	//$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "b.id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "b.id", $re_dying_cond);
	$fabric_sql=sql_select("SELECT b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
	from pro_fab_subprocess  a,pro_batch_create_mst b,gbl_temp_engine g  where  a.batch_id=b.id  and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from in(11,3) and g.entry_form=48 
	and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 $company_idcond");
	 	
  	$fabric_type_arr=array();
    foreach($fabric_sql as $row)
	{
	 	$fabric_type_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
	}
	//=========****============Fab Sales Order=========================
	//sales_order_id
	//$sales_id_arr
	
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 6, $sales_id_arr, $empty_arr);//Sales ID Ref from=6
	$sales_fabric_sql=sql_select("SELECT c.id as sales_id,c.buyer_id,b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from,c.po_buyer
	from pro_fab_subprocess  a,pro_batch_create_mst b,fabric_sales_order_mst c,gbl_temp_engine g  where  a.batch_id=b.id 
	and c.id=b.sales_order_id and c.id=g.ref_val and b.sales_order_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=6 and g.entry_form=48  and a.entry_form in (35) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $company_idcond ");
	 
	 	
  	 
    foreach($sales_fabric_sql as $row)
	{
	 	$fabric_sales_arr[$row[csf("sales_id")]]['buyer_id']=$row[csf("buyer_id")];
		$fabric_sales_arr[$row[csf("sales_id")]]['po_buyer']=$row[csf("po_buyer")];
		// $re_batch_wise_arr[$row[("BATCH_ID")]]['po_buyer']=$row[("PO_BUYER")];
		//$sales_batch_arr[$row[csf("id")]]=$row[csf("sales_order_id")];
	}
	unset($sales_fabric_sql);

	// ========================================================================================

	$floor_cond_arr=array();
	//$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
	//echo $location_id.'-0998';die; 
	if(!empty($location_id))
	{
		if(!empty($floor_id))
		{
			$sql="SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b,gbl_temp_engine g  where a.floor_id=b.id  and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0 and b.company_id=$cbo_working_name and b.location_id=$location_id and b.production_process=3 and b.id=$floor_id ";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) 
			{
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		else
		{
			 $sql="SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b,gbl_temp_engine g  where a.floor_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0  and b.location_id=$location_id and b.production_process=3 ";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) {
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		$floor_cond_arr=array_unique($floor_cond_arr);
	}
	 // print_r($floor_cond_arr);die();

	// ==========================================================================

	//$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
    $floor_arr=return_library_array("SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b,gbl_temp_engine g  where a.floor_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from in(3,11) and g.entry_form=48 and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0 ", "batch_id", "floor_name" );
	 

	$machine_name_arr=return_library_array("SELECT  a.batch_id ,b.machine_no from   pro_fab_subprocess a, lib_machine_name b,gbl_temp_engine g  where a.machine_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from in(3,11) and g.entry_form=48 and a.entry_form in(38,35) and  b.status_active=1 and b.is_deleted=0  ", "batch_id", "machine_no" );

	//$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "c.id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "c.id", $re_dying_cond);
	$sql_book=sql_select("SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c,gbl_temp_engine g where a.buyer_id=b.id and a.id=c.booking_no_id and c.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from in(3,11) and g.entry_form=48 ");
	//echo "SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c where a.buyer_id=b.id and a.id=c.booking_no_id $batch_id_conds";die;
	//echo "SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c where a.buyer_id=b.id and a.id=c.booking_no_id $batch_id_conds";die;
	$po_id_arr = array();
	foreach($sql_book as $row)
	{
		$buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		
		if($row[csf('po_break_down_id')])
		{
		$po_id_arr[$row[csf('po_break_down_id')]]=$row[csf('po_break_down_id')];
		$po_break_down_id_arr[$row[csf('booking_no')]]=$row[csf('po_break_down_id')];
		}
	}

	// =========================================================
	// $poIdss = implode(",", $po_id_arr);
	if(count($po_id_arr))
	{
		$po_id_cond = where_con_using_array($po_id_arr,0,"b.id");
	}
	
	if(count($trim_batch_IdArr))
	{
		$trim_batchId_cond = where_con_using_array($trim_batch_IdArr,0,"c.id");
	}


	/*if($db_type==2 && count($po_id_arr)>1000)
	{
		$poIdCond=" and (";
		$poIdsArr=array_chunk($po_id_arr,999);
		foreach($poIdsArr as $ids)
		{
			$ids=implode(",",$ids);
			$poIdCond.=" b.id in($ids) or"; 
		}
		$poIdCond=chop($poIdCond,'or ');
		$poIdCond.=")";
	}
	else
	{
		$poIdCond=" and b.id in($poIdss)";
		
	}*/

	// echo $poIdCond;die();
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 7, $po_id_arr, $empty_arr);//Sales ID Ref from=7
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 8, $trim_batch_IdArr, $empty_arr);//T Batch ID Ref from=8
	 $sql_po="SELECT a.style_ref_no,a.buyer_name,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b ,gbl_temp_engine g  where a.id=b.job_id  and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=7 and g.entry_form=48 and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond ";
	// echo $sql_po;die(); 
	$res_po=sql_select($sql_po);
	$all_po_id='';
	foreach($res_po as $row) //$job_no_arr
	{
		$po_number_arr[$row[csf('id')]]['po_no']=$row[csf('po_number')];
		$po_number_arr[$row[csf('id')]]['ref_no']=$row[csf('ref_no')];
		$po_number_arr[$row[csf('id')]]['file_no']=$row[csf('file_no')]; 
		$po_number_arr[$row[csf('id')]]['season']=$row[csf('season_buyer_wise')]; 
		$po_number_arr[$row[csf('id')]]['job']=$row[csf('job_no_mst')];
		
		$job_no_arr[$row[csf('id')]]=$row[csf('job_no_mst')];
		$style_library[$row[csf('job_no_mst')]]=$row[csf('style_ref_no')];
		
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['buyer']=$row[csf('buyer_name')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['season']=$row[csf('season_buyer_wise')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['style']=$row[csf('style_ref_no')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['po_number'].=$row[csf('po_number')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['ref_no'].=$row[csf('ref_no')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['file_no'].=$row[csf('file_no')].',';
	}
	unset($res_po);
	 $sql_trim_job="SELECT a.style_ref_no,a.buyer_name,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b,pro_batch_create_mst c,gbl_temp_engine g  where a.id=b.job_id and a.job_no=c.job_no and b.job_no_mst=c.job_no  and c.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=8 and g.entry_form=48 and   b.status_active=1 and b.is_deleted=0  and   c.status_active=1 and c.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond   $buyer_id_cond ";
	// echo $sql_po;die(); 
	$res_trimJob=sql_select($sql_trim_job);
	 
	foreach($res_trimJob as $row) //$job_no_arr
	{
		$style_library[$row[csf('job_no_mst')]]=$row[csf('style_ref_no')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['buyer']=$row[csf('buyer_name')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['season']=$row[csf('season_buyer_wise')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['style']=$row[csf('style_ref_no')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['po_number'].=$row[csf('po_number')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['ref_no'].=$row[csf('ref_no')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['file_no'].=$row[csf('file_no')].',';
	}
	unset($res_trimJob);

   $buyer_library=return_library_array( "SELECT id,buyer_name from   lib_buyer", "id","buyer_name" );
   // $batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.mst_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.mst_id", $re_dying_cond);
	$po_data_subcon=sql_select("SELECT a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	subcon_ord_mst c,gbl_temp_engine g where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.mst_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from in(11,3) and g.entry_form=48 and a.status_active=1 and a.is_deleted=0  ");
	
	$sub_con_arr=array(); 
	foreach($po_data_subcon as $row)
	{
		if($sub_con_arr[$row[csf('mst_id')]][cust_style_ref]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref].=",".$row[csf('cust_style_ref')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref]=$row[csf('cust_style_ref')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][order_no]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no].=",".$row[csf('order_no')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no]=$row[csf('order_no')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][subcon_job]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job].=",".$row[csf('subcon_job')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job]=$row[csf('subcon_job')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][party_id]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id].=",".$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id].=",".$row[csf('party_id')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id]=$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id]=$row[csf('party_id')];	
		}
		$party_id=$row[csf('party_id')];
		if(in_array($party_id,$sub_party_arr) && $row[csf("party_id")]>0)
		{
			$sub_batch_chk_arr[$row[csf("mst_id")]]=$row[csf("party_id")];
		}
	}
	//print_r($sub_con_arr[646]);die;
	// ==================================================================================

	if($db_type==0)
	{
		if($batch_type==3)
		{
		 $sql_redying=sql_select("SELECT b.id as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0 group by  b.id");
		}
		else
		{
			 $sql_redying=sql_select("SELECT group_concat(b.id) as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0  $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0 group by  b.re_dyeing_from");	
		}
	}
	else
	{
		if($batch_type==3)
		{	
			   $sql_redying=sql_select("SELECT b.id as id, b.batch_date as batch_date, b.extention_no as extention_no
			   from  pro_batch_create_mst  b ,gbl_temp_engine g
			   where  b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from in(11,3) and g.entry_form=48 and b.re_dyeing_from!=0 $company_idcond  and b.status_active=1 and b.is_deleted=0  ");
		}
		else
		{
			 
			 $sql_redying=sql_select("SELECT  b.id as id, b.batch_date as batch_date, b.extention_no as extention_no,b.re_dyeing_from ,g.ref_from
			  from  pro_batch_create_mst b ,gbl_temp_engine g
			  where  b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from in(11,3) and g.entry_form=48 and b.re_dyeing_from!=0   $company_idcond  and b.status_active=1 and b.is_deleted=0  ");
			  
			 
		}
	}
	
   	//and b.batch_against=2
    $redying_details_arr=array();
    foreach($sql_redying as $re_row)
    {
		if($re_row[csf("ref_from")]==3)
		{
			if($batch_type==3)
			{
				$redying_details_arr[$re_row[csf("id")]]['id'].=$re_row[csf("id")].",";
				$redying_details_arr[$re_row[csf("id")]]['batch_date'].=$re_row[csf("batch_date")].",";
				$redying_details_arr[$re_row[csf("id")]]['extention_no'].=$re_row[csf("extention_no")].",";
			}
			else
			{
				$redying_details_arr[$re_row[csf("re_dyeing_from")]]['id'].=$re_row[csf("id")].",";
				$redying_details_arr[$re_row[csf("re_dyeing_from")]]['batch_date'].=$re_row[csf("batch_date")].",";
				$redying_details_arr[$re_row[csf("re_dyeing_from")]]['extention_no'].=$re_row[csf("extention_no")].",";
			}
		}
		else
		{
			if($batch_type==3)
			{
				$redying_details_arr[$re_row[csf("id")]]['id'].=$re_row[csf("id")].",";
				$redying_details_arr[$re_row[csf("id")]]['batch_date'].=$re_row[csf("batch_date")].",";
				$redying_details_arr[$re_row[csf("id")]]['extention_no'].=$re_row[csf("extention_no")].",";
			}
			else
			{
				$redying_details_arr[$re_row[csf("id")]]['id'].=$re_row[csf("id")].",";
				$redying_details_arr[$re_row[csf("id")]]['batch_date'].=$re_row[csf("batch_date")].",";
				$redying_details_arr[$re_row[csf("id")]]['extention_no'].=$re_row[csf("extention_no")].",";
			}
		}
		
    }
	//print_r($redying_details_arr);
	//die;
	if($batch_type==3)
	{
		$result_sql=sql_select("SELECT a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b,gbl_temp_engine g where b.id=a.batch_id and b.id=g.ref_val and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48  and a.entry_form in (35,38) and a.load_unload_id=2   $company_idcond  and a.status_active=1 and a.is_deleted=0");	
	}
	else
	{
		$result_sql=sql_select("SELECT a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b,gbl_temp_engine g where b.id=a.batch_id and b.id=g.ref_val and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.entry_form in (35,38) and a.load_unload_id=2  $company_idcond  and a.status_active=1 and a.is_deleted=0");
	}
	
	/*$sql_result=sql_select("select a.result,a.batch_id from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2  and a.company_id=$cbo_company_name and b.re_dyeing_from in (".$batch_id_sql.") and a.status_active=1 and a.is_deleted=0");*/
	
	$result_arr=array();
	foreach($result_sql as $value)
	{
		$result_arr[$value[csf('batch_id')]]=$value[csf('result')];	
	}
	// print_r($issue_single_batch_arr); echo "Test";die;
	// ====================================== batch wise cost =====================================
	$batchIdArr = array();
	foreach(array_unique($issue_single_batch_arr) as $b_id)
	{
		$batchIdArr[$b_id] = $b_id;
	}
	
	$company_cond = str_replace("a.company_id", "c.company_id", $company_id);	
	if ($cbo_working_name==0) $wo_company_idcond =""; else $wo_company_idcond =" and p.working_company_id='$cbo_working_name'";
//echo "#aaa";die;
	// $batchCond = implode(",", $batchIdArr);
	   $sql = "(SELECT p.id as recipe_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,a.avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, a.id, a.item_category_id, a.item_group_id, a.sub_group_name, a.item_description, a.item_size,a.current_stock, a.unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments,g.ref_from
		from pro_recipe_entry_mst p, product_details_master a, pro_recipe_entry_dtls b,pro_batch_create_mst c,gbl_temp_engine g 
		where p.id=b.mst_id and a.id=b.prod_id and p.batch_id=c.id  and c.id=g.ref_val  and p.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from in(11,3) and g.entry_form=48 and b.ratio>0  and b.status_active=1 and b.is_deleted=0 $company_cond $wo_company_idcond and a.item_category_id in(5,6,7,23) and a.status_active=1 and a.is_deleted=0  and p.entry_form in(59,60)) 
		union 
		(
		SELECT p.id as recipe_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,0 as avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, b.prod_id as id, null as item_category_id, null as item_group_id, null as sub_group_name, null as item_description, null as item_size,null as current_stock, null as unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments,g.ref_from
			from pro_recipe_entry_mst p, pro_recipe_entry_dtls b,pro_batch_create_mst c,gbl_temp_engine g  
			where p.id=b.mst_id and p.batch_id=c.id and c.id=g.ref_val and p.batch_id=g.ref_val  and p.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from in(11,3) and g.entry_form=48 and b.status_active=1 and b.is_deleted=0 $wo_company_idcond  and b.status_active=1 and b.is_deleted=0 and b.prod_id=0 and b.sub_process_id in(93,94,95,96,97,98) and p.status_active=1 and p.is_deleted=0  and p.entry_form in(59,60))  order by sub_seq,seq_no";
	//echo $sql;die();
	$costDataArr = array();
	$res = sql_select($sql);
	$tot_recCost=0;$tot_issue_qty=0;
	foreach ($res as $row) 
	{
		 
		if($row[csf('ref_from')]==3) //Ist and Summary part
		{
			$batch_req_id=rtrim($batch_req_id_array[$row[csf('batch_id')]],',');
			$batch_req_idArr=array_unique(explode(",",$batch_req_id_array[$row[csf('batch_id')]]));
			//echo $batch_req_id.'D';
			$tot_batch_wgt=$batch_wgt_array[$row[csf('batch_id')]];
			//echo  $tot_batch_wgt.'D';
			$batch_qty=$row[csf('batch_qty')];
			if($issue_item_cat_arr[$row[csf('batch_id')]][$row[csf('prod_id')]][$row[csf('item_category_id')]])
			{
				//echo $recipe_qnty.'='.$row[csf('avg_rate_per_unit')].'<br>';
				//$issue_qty=0;
				foreach($batch_req_idArr as $req_id)
				{
					if($issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=='')
					{	
						$issue_qty+=$issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
						//$reqIdArr[$req_id]=$req_id;
						$tot_issue_qty+=$issue_qty;
						$issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=111;
						//echo $req_id.'='.$issue_qty.'='.$issue_wgt_per.'='.$issue_wgt_per*$row[csf('avg_rate_per_unit')].'<br>';
						
					}
					
				}
				//$issue_qty=$issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
				$issue_perKg=($issue_qty/$tot_batch_wgt);
				$issue_wgt_per=$issue_perKg*$batch_qty;
			//	echo $tot_batch_wgt.'='.$issue_qty.'='.$issue_wgt_per.'='.$issue_wgt_per*$row[csf('avg_rate_per_unit')].'<br>';
				
			$costDataArr[$row[csf('batch_id')]][$row[csf('item_category_id')]] +=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
			$ReqIdArr[$row[csf('batch_id')]].=$batch_req_id.','; 
			//$recipe_qnty*$row[csf('avg_rate_per_unit')];
			$categryDataArr[$row[csf('batch_id')]].=$row[csf('item_category_id')].',';
			$tot_recCost+=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
			}
		}
		else{
			$batch_req_id=rtrim($re_batch_req_id_array[$row[csf('batch_id')]],',');
			$re_batch_req_idArr=array_unique(explode(",",$re_batch_req_id_array[$row[csf('batch_id')]]));
			//echo $batch_req_id.'D';
			$tot_batch_wgt=$re_batch_wgt_array[$row[csf('batch_id')]];
			//echo  $tot_batch_wgt.'D';
			$batch_qty=$row[csf('batch_qty')];
			if($re_issue_item_cat_arr[$row[csf('batch_id')]][$row[csf('prod_id')]][$row[csf('item_category_id')]])
			{
				// echo $batch_qty.'='.$row[csf('avg_rate_per_unit')].'<br>';
				//$issue_qty=0;
				foreach($re_batch_req_idArr as $req_id)
				{
					if($re_issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=='')
					{	
						$issue_qty+=$re_issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
						//$reqIdArr[$req_id]=$req_id;
						$tot_issue_qty+=$issue_qty;
						$re_issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=111;
						//echo $req_id.'='.$issue_qty.'='.$issue_wgt_per.'='.$issue_wgt_per*$row[csf('avg_rate_per_unit')].'<br>';
						
					}
					
				}
				//$issue_qty=$issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
				$issue_perKg=($issue_qty/$tot_batch_wgt);
				$issue_wgt_per=$issue_perKg*$batch_qty;
			//	echo $tot_batch_wgt.'='.$issue_qty.'='.$issue_wgt_per.'='.$issue_wgt_per*$row[csf('avg_rate_per_unit')].'<br>';
				
			$re_costDataArr[$row[csf('batch_id')]][$row[csf('item_category_id')]] +=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
			$re_ReqIdArr[$row[csf('batch_id')]].=$batch_req_id.','; 
			//$recipe_qnty*$row[csf('avg_rate_per_unit')];
			$re_categryDataArr[$row[csf('batch_id')]].=$row[csf('item_category_id')].',';
			$tot_recCost+=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
			}
		}
		
	}
	 //echo implode(",",$ReqIdArr);die;
	//echo $tot_issue_qty.'Dx'.'='.$tot_recCost;
	// echo "<pre>";print_r($ReqIdArr);

	//=========Load batch and Issue date wise batch but redyeing batch==================================
	

	// ======end=======================================

	$con = connect();
	execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id."   and ENTRY_FORM=48");
	oci_commit($con);
	disconnect($con);
	$i=1;$j=1;
	ob_start();	
	?>
	<div id="" align="center" style="height:auto; width:auto; margin:0 auto; padding:0;">
		<? $summaryHTML='<div id="summary_part" style="width:1560px;">
        <table width="2060px" cellpadding="0" cellspacing="0" id="caption" align="center">
            <thead>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:16px; font-weight:bold" >'.$report_title.'</td 
                ></tr>
                <tr style="border:none;">
                    <td colspan="24" class="form_caption" align="center" style="border:none; font-size:14px;">
                       <b>Company Name : '.$companyArr[$cbo_company_name].'</b>                               
                    </td>
                </tr>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:12px; font-weight:bold">
					'."Date: ". change_date_format($from_date).' To '. change_date_format($to_date).'
					</td>
                </tr>
            </thead>
        </table>
 		
        <div  align="left" style="font-size:18px">Summary Part</div>
        <table align="left" width="1540" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>

                    <th rowspan="2" width="100">Buyer</th>

                    <th rowspan="2" width="100">Batch Qty (Kg)</th>
                    <th colspan="4" width="">First Dying And Finishing Cost</th>
					<th rowspan="2" width="100">Re Process<br> BatchQty</th>
                    <th colspan="3" width="">Subsequent Dyeing and Finishing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per Kg Cost (Tk)</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>

                    <th width="100">Ttl Chem Cost(Tk)</th>
                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    
                </tr> 
            </thead>
        </table>
        <div style="width:1560px; max-height:400px;  overflow-y:scroll" id="scroll_body_summary">
	        <table align="left" width="1540" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="summary_table_body_id" >
	            <tbody>';
			 
			       	
			       	$tot_main_batch_weight=0;$qty_check_array_sum=array();$zzz=1;$sub_buyer_summary_Qty_arr=array();
				 	//echo print_r($re_issue_single_batch_arr);
					foreach(array_unique($re_issue_single_batch_arr) as $b_id)
					{
						
							$sub_batch_buyer=="";
							if($re_batch_description_arr[$b_id][entry_form]==36)
			                {
			                	$buyerName=implode(", ",array_unique(explode(",",$sub_con_id_arr[$b_id][party_id])));
								
			                }
							else if($re_batch_description_arr[$b_id][entry_form]==136) //Trims batch
			                {
			                	$job_no=$re_batch_description_arr[$b_id][job_no];
								$buyerName=$trim_batch_job_arr[$job_no]['buyer'];
								//$po_number=$trim_batch_job_arr[$job_no]['po_number']; 
								//$buyerName=implode(", ",array_unique(explode(",",$sub_con_id_arr[$b_id][party_id])));
			                }
			                else
			                {
				                if($re_batch_description_arr[$b_id]["without_order"]==1)
								{
									$buyerName=$non_buyer_id_arr[$re_batch_description_arr[$b_id]["booking_no"]];
								}
				                else { 
									$buyerName=$buyer_id_arr[$re_batch_description_arr[$b_id]["booking_no"]];}

			                }
							//$ttt++;
						
						$sales_order_id= $sales_batch_arr[$b_id];
						
						if($buyerName=='')
						{
							$buyerName= $fabric_sales_arr[$sales_order_id]['po_buyer'];
							$buyerNameS= $fabric_sales_arr[$sales_order_id]['po_buyer'];
						}
						//echo $re_batch_description_arr[$b_id][entry_form].'='.$b_id.'='.$buyerName.'='.$sales_order_id.'<br>';
						
						$buyer_id=$fabric_sales_arr[$sales_order_id]['buyer_id'];
							if($sales_order_id && $buyerName=='')
							{
								$buyerName=$buyer_id;	
							}
							else $buyerName=$buyerName;
						
							
							$re_sumbatch_noArr=$re_batch_arr[$b_id];
							if (!in_array($re_sumbatch_noArr,$re_qty_check_array_sum))
							{ 
								$zzz++;
								$re_qty_check_array_sum[]=$re_sumbatch_noArr;
								$tot_batch_weightQty=$re_batch_description_arr[$b_id]['batch_weight'];
							}
							else
							{
								$tot_batch_weightQty=0;
							}
							

							
							if($re_batch_description_arr[$b_id][entry_form]==36)
			                {
								$sub_batch_buyer=$sub_batch_chk_arr[$b_id];
								if($sub_batch_buyer>0)//Subcon buyer Omitted //(426,439,444,458,425,427,428,443,392,564,565,563)
								{
									$sub_buyer_summary_Qty_arr[$buyerName]["sub_batch_qty"]+=$tot_batch_weightQty;
								}
							}
						
							
							//echo $ReqIdArr[$b_id].'FD';
							$ReqId=rtrim($re_ReqIdArr[$b_id],',');
							$re_sum_ReqIdsArr=array_unique(explode(",",$ReqId));
							//echo $ReqId.'DS';  
			                $buyer_wise_summary_arr[$buyerName]["buyer"]=$buyerName;
			                $buyer_wise_summary_arr[$buyerName]["re_batch_qty"]+=$tot_batch_weightQty;//$batch_description_arr[$b_id]["batch_weight"];
							$ttttt+=$tot_batch_weightQty;
			                // echo "$b_id <pre>";print_r($batch_arr);die();
							$re_b_id=rtrim($re_batch_wise_arr[$batch_arr[$b_id]]['batch_id'],',');
							$re_b_idArr=array_unique(explode(",",$re_b_id));
							
							// echo "<pre>";print_r($re_b_idArr);die();
			                $first_chemi_cost=$first_dyeing_cost=0;
							//echo $non_reding_batch_id[$b_id].'=SSSSSSSS';
			                if($non_reding_batch_id[$b_id]!="")
			                {
			                    $sum_issue_amt_deys=0;$sum_issue_amt_chemical=0;
								$batch_weight=$tot_batch_weightQty;//$batch_description_arr[$b_id]["batch_weight"];
								$sum_batchIdArr='';$tot_sum_chemical_cost=$tot_sum_deys_cost=0;
									foreach($re_sum_ReqIdsArr as $reqId)
									{
										//$issue_qty+=$issue_item_cat_cost_arr[$req_id][$row[csf('item_category_id')]];
										//$issue_qty+=$issue_item_cat_cost_dtls_arr[$reqId][5]+$issue_item_cat_cost_dtls_arr[$reqId][6]+$issue_item_cat_cost_dtls_arr[$reqId][7];
										//$issue_item_cat_amt_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]
										$sum_issue_amt_chemical=$re_issue_item_cat_amt_dtls_arr[$reqId][5]+$re_issue_item_cat_amt_dtls_arr[$reqId][7];
										$sum_issue_amt_deys=$re_issue_item_cat_amt_dtls_arr[$reqId][6];
										//$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']];
										//echo $reqId.'D=';
										
									   $batch_idsAll=$re_ReqBatch_id_arr[$reqId]; 
										//$sum_batchIdArr.=$batch_idsAll.',';
										
										$sum_batchIds=rtrim($batch_idsAll,',');
										$sumbatIdArr=array_unique(explode(",",$sum_batchIds)); 
										$sum_tot_batch_wgt=0;
										foreach($sumbatIdArr as $batchId)
										{
										//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
										//echo $batch_wgt_arr[$batchId]['batchWgt'].'p';
										$sum_tot_batch_wgt+=$re_batch_wgt_arr[$batchId]['batchWgt']; 
										}
										if($sum_issue_amt_chemical>0)
										{
										$tot_sum_chemical_cost+=($sum_issue_amt_chemical/$sum_tot_batch_wgt)*$batch_weight;
										}
										if($sum_issue_amt_deys>0)
										{
										$tot_sum_deys_cost+=($sum_issue_amt_deys/$sum_tot_batch_wgt)*$batch_weight;
										}
										
									}
									//echo  $sum_batchIdArr.'X=';
									    
									
									if($tot_sum_chemical_cost)
									{
									//$issue_amt_perKg_chemical=($sum_issue_amt_chemical/$sum_tot_batch_wgt);
									$summissue_amt_cal_chemical=$tot_sum_chemical_cost;
									}
									else
									 {$summissue_amt_cal_chemical=0;}
									//echo $sum_issue_amt_chemical.'='.$sum_tot_batch_wgt.'='.$batch_weight.',';
									if($tot_sum_deys_cost)
									{
									//$sum_issue_amt_perKg_dyes=($sum_issue_amt_deys/$sum_tot_batch_wgt);
									$sum_issue_amt_cal_dyes=$tot_sum_deys_cost;
									} 
									else
									{$sum_issue_amt_cal_dyes=0;}
									
								$first_chemi_cost=$summissue_amt_cal_chemical;//$costDataArr[$b_id][5]+$costDataArr[$b_id][7];
			                    $buyer_wise_summary_arr[$buyerName]["first_chemi_cost"]+=$first_chemi_cost;

			                    $first_dyeing_cost=$sum_issue_amt_cal_dyes;//$costDataArr[$b_id][6];
			                    $buyer_wise_summary_arr[$buyerName]["first_dyeing_cost"]+=$first_dyeing_cost;
								$tot_main_batch_weight=$tot_batch_weightQty;
								$buyer_wise_summary_arr[$buyerName]["tot_main_batch_weight"]+=$tot_main_batch_weight;
								// echo $first_dyeing_cost."<br>";
			                }
			                $buyer_wise_summary_arr[$buyerName]["cost_per_kg"]+=($tot_batch_weightQty>0) ? ($first_chemi_cost+$first_dyeing_cost)/$tot_batch_weightQty : 0;

			                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
			                //if($reding_batch_id[$b_id]!="")
						 //  $sum_extention_no=$re_batch_description_arr[$b_id]['extention_no'];
						   $sum_extention_no=rtrim($re_batch_wise_arr[$b_id]['extention_no'],',');
						  // echo $sum_extention_no.'DS';
							if($sum_extention_no>0)
							{
								 //echo $b_id.",";
							//foreach($re_b_idArr as $re_b_id)
			                //{
								$re_batch_weight=$tot_batch_weightQty;//$batch_description_arr[$b_id]["batch_weight"];
			                   $tot_re_sum_issue_amt_chemical=$tot_re_sum_issue_amt_deys=0;$re_sum_batchIdArr='';
							   $re_sum_issue_amt_chemical=$re_sum_issue_amt_deys=0;
							    foreach($re_sum_ReqIdsArr as $reqId)
									{
									
										$re_sum_issue_amt_chemical=$re_issue_item_cat_amt_dtls_arr[$reqId][5]+$re_issue_item_cat_amt_dtls_arr[$reqId][7];
										//$re_sum_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
										$re_sum_issue_amt_deys=$re_issue_item_cat_amt_dtls_arr[$reqId][6];
										 
										 $batch_idsAll=$re_ReqBatch_id_arr[$reqId]; 
										//$re_sum_batchIdArr.=$batch_idsAll.',';
										
										 $re_sum_batchIds=rtrim($batch_idsAll,',');
										$re_ResumbatIdArr=array_unique(explode(",",$re_sum_batchIds)); 
										$Resum_tot_batch_wgt=0;
										foreach($re_ResumbatIdArr as $batchId)
										{
										//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
										//echo $batch_wgt_arr[$batchId]['batchWgt'].'p';
										$Resum_tot_batch_wgt+=$re_batch_wgt_arr[$batchId]['batchWgt']; 
										}
										
										if($re_sum_issue_amt_chemical)
										{	
										//$re_issue_amt_perKg_chemical=($re_sum_issue_amt_chemical/$Resum_tot_batch_wgt);
										//$re_issue_amt_cal_chemical+=$re_issue_amt_perKg_chemical*$re_batch_weight;
										$tot_re_sum_issue_amt_chemical+= (($re_sum_issue_amt_chemical/$Resum_tot_batch_wgt)*$re_batch_weight);
									//	echo $re_sum_issue_amt_chemical.'='.$Resum_tot_batch_wgt.'='.$re_batch_weight.'<br>';
										
										}
										//else{$re_issue_amt_cal_chemical=0;}
										
										if($re_sum_issue_amt_deys)
										{
										//$re_issue_amt_perKg_dyes=($re_sum_issue_amt_deys/$Resum_tot_batch_wgt);
										//$re_issue_amt_cal_dyes=$re_issue_amt_perKg_dyes*$re_batch_weight;
										if($sum_extention_no==2)
										{
											// echo $re_sum_issue_amt_deys.'/'.$Resum_tot_batch_wgt.'*'.$re_batch_weight.'<br>';;
										}
										$tot_re_sum_issue_amt_deys+= (($re_sum_issue_amt_deys/$Resum_tot_batch_wgt)*$re_batch_weight);
										//echo $reqId.'d';
										// echo $re_sum_issue_amt_deys.'/'.$Resum_tot_batch_wgt.'*'.$re_batch_weight.'<br>';;
										}
										//else{$re_issue_amt_cal_dyes=0;}
										
									}
									
									$re_issue_amt_cal_chemical_tot=$tot_re_sum_issue_amt_chemical;
									$re_issue_amt_cal_dyes_tot=$tot_re_sum_issue_amt_deys;
									//echo $Resum_tot_batch_wgt.'='.$batch_weight.'='.$re_sum_issue_amt_chemical.',';;
									
									
								$re_dying_chemical_cost=$re_issue_amt_cal_chemical_tot;//$costDataArr[$re_b_id][5]+$costDataArr[$re_b_id][7];
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_chemical_cost"]+=$re_dying_chemical_cost;

			                    $re_dying_dyes_cost=$re_issue_amt_cal_dyes_tot;//$costDataArr[$re_b_id][6];	
								
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_dyes_cost"]+=$re_dying_dyes_cost;

			                    $re_dying_dyes_chemical_cost=$re_issue_amt_cal_chemical_tot+$re_issue_amt_cal_dyes_tot;
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_dyes_chemical_cost"]+=$re_dying_dyes_chemical_cost;
			                //}
						}
			                $buyer_wise_summary_arr[$buyerName]["re_dye_cost_per_kg"]+=($tot_batch_weightQty>0) ? $re_dying_dyes_chemical_cost/$tot_batch_weightQty: 0;

			                $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
			                $buyer_wise_summary_arr[$buyerName]["total_per_kg_cost"]+=($tot_batch_weightQty>0) ? ($first_chemi_cost+$first_dyeing_cost)/$tot_batch_weightQty : 0;

			                //$buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price)/$buyer["batch_qty"]
						
					}
					//====================Re Dying Part End=============
				 
			       	foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						//$fabric_sales_arr[$row[csf("sales_id")]]['buyer_id']=$row[csf("buyer_id")];
						
						
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
							//batch_description_arr
							$sub_batch_buyer=="";
							if($batch_description_arr[$b_id][entry_form]==36)
			                {
			                	$buyerName=implode(", ",array_unique(explode(",",$sub_con_id_arr[$b_id][party_id])));
								
			                }
							else if($batch_description_arr[$b_id][entry_form]==136) //Trims batch
			                {
			                	$job_no=$batch_description_arr[$b_id][job_no];
								$buyerName=$trim_batch_job_arr[$job_no]['buyer'];
								//$po_number=$trim_batch_job_arr[$job_no]['po_number']; 
								//$buyerName=implode(", ",array_unique(explode(",",$sub_con_id_arr[$b_id][party_id])));
			                }
			                else
			                {
				                if($batch_description_arr[$b_id]["without_order"]==1) 
				                $buyerName=$non_buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
				                else $buyerName=$buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
			                }
							//$ttt++;
						
						$sales_order_id= $sales_batch_arr[$b_id];
						$buyer_id=$fabric_sales_arr[$sales_order_id]['buyer_id'];
						if($buyerName=='')
						{
							$buyerName= $fabric_sales_arr[$sales_order_id]['po_buyer'];
						}
						
							if($sales_order_id && $buyerName=='')
							{
								$buyerName=$buyer_id;	
							}
							else $buyerName=$buyerName;
							
							$sumbatch_noArr=$batch_arr[$b_id];
							if (!in_array($sumbatch_noArr,$qty_check_array_sum))
							{ 
								$zz++;
								$qty_check_array_sum[]=$sumbatch_noArr;
								$tot_batch_weightQty=$batch_description_arr[$b_id]['batch_weight'];
							}
							else
							{
								$tot_batch_weightQty=0;
							}
							if($sum_extention_no)
							{
								//$tot_batch_weightQty=$batch_description_arr[$b_id]['re_batch_weight'];
							}
							  $re_batch_weight=$batch_description_arr[$b_id]['re_batch_weight'];
							  if($re_batch_weight)
							  {
								$tot_batch_weightQty=$re_batch_weight;
							  }
							
							
							if($batch_description_arr[$b_id][entry_form]==36)
			                {
								$sub_batch_buyer=$sub_batch_chk_arr[$b_id];
								if($sub_batch_buyer>0)//Subcon buyer Omitted //(426,439,444,458,425,427,428,443,392,564,565,563)
								{
									$sub_buyer_summary_Qty_arr[$buyerName]["sub_batch_qty"]+=$tot_batch_weightQty;
								}
							}
						
							
							//echo $ReqIdArr[$b_id].'FD';
							$ReqId=rtrim($ReqIdArr[$b_id],',');
							$sum_ReqIdsArr=array_unique(explode(",",$ReqId));
							//echo $ReqId.'DS';  
			                $buyer_wise_summary_arr[$buyerName]["buyer"]=$buyerName;
			                $buyer_wise_summary_arr[$buyerName]["batch_qty"]+=$tot_batch_weightQty;//$batch_description_arr[$b_id]["batch_weight"];
							$ttttt+=$tot_batch_weightQty;
			                // echo "$b_id <pre>";print_r($batch_arr);die();
							$re_b_id=rtrim($re_batch_wise_arr[$batch_arr[$b_id]]['batch_id'],',');
							$re_b_idArr=array_unique(explode(",",$re_b_id));
							
							// echo "<pre>";print_r($re_b_idArr);die();
			                $first_chemi_cost=$first_dyeing_cost=0;
			                if($non_reding_batch_id[$b_id]!="")
			                {
			                    $sum_issue_amt_deys=0;$sum_issue_amt_chemical=0;
								$batch_weight=$tot_batch_weightQty;//$batch_description_arr[$b_id]["batch_weight"];
								$sum_batchIdArr='';$tot_sum_chemical_cost=$tot_sum_deys_cost=0;
									foreach($sum_ReqIdsArr as $reqId)
									{
										//$issue_qty+=$issue_item_cat_cost_arr[$req_id][$row[csf('item_category_id')]];
										//$issue_qty+=$issue_item_cat_cost_dtls_arr[$reqId][5]+$issue_item_cat_cost_dtls_arr[$reqId][6]+$issue_item_cat_cost_dtls_arr[$reqId][7];
										//$issue_item_cat_amt_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]
										$sum_issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										$sum_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
										//$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']];
										//echo $reqId.'D=';
										
									   $batch_idsAll=$ReqBatch_id_arr[$reqId]; 
										//$sum_batchIdArr.=$batch_idsAll.',';
										
										$sum_batchIds=rtrim($batch_idsAll,',');
										$sumbatIdArr=array_unique(explode(",",$sum_batchIds)); 
										$sum_tot_batch_wgt=0;
										foreach($sumbatIdArr as $batchId)
										{
										//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
										//echo $batch_wgt_arr[$batchId]['batchWgt'].'p';
										$sum_tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt']; 
										}
										if($sum_issue_amt_chemical>0)
										{
										$tot_sum_chemical_cost+=($sum_issue_amt_chemical/$sum_tot_batch_wgt)*$batch_weight;
										}
										if($sum_issue_amt_deys>0)
										{
										$tot_sum_deys_cost+=($sum_issue_amt_deys/$sum_tot_batch_wgt)*$batch_weight;
										}
										
									}
									//echo  $sum_batchIdArr.'X=';
									    
									
									if($tot_sum_chemical_cost)
									{
									//$issue_amt_perKg_chemical=($sum_issue_amt_chemical/$sum_tot_batch_wgt);
									$summissue_amt_cal_chemical=$tot_sum_chemical_cost;
									}
									else
									 {$summissue_amt_cal_chemical=0;}
									//echo $sum_issue_amt_chemical.'='.$sum_tot_batch_wgt.'='.$batch_weight.',';
									if($tot_sum_deys_cost)
									{
									//$sum_issue_amt_perKg_dyes=($sum_issue_amt_deys/$sum_tot_batch_wgt);
									$sum_issue_amt_cal_dyes=$tot_sum_deys_cost;
									} 
									else
									{$sum_issue_amt_cal_dyes=0;}
									
								$first_chemi_cost=$summissue_amt_cal_chemical;//$costDataArr[$b_id][5]+$costDataArr[$b_id][7];
			                    $buyer_wise_summary_arr[$buyerName]["first_chemi_cost"]+=$first_chemi_cost;

			                    $first_dyeing_cost=$sum_issue_amt_cal_dyes;//$costDataArr[$b_id][6];
			                    $buyer_wise_summary_arr[$buyerName]["first_dyeing_cost"]+=$first_dyeing_cost;
								$tot_main_batch_weight=$tot_batch_weightQty;
								$buyer_wise_summary_arr[$buyerName]["tot_main_batch_weight"]+=$tot_main_batch_weight;
								// echo $first_dyeing_cost."<br>";
			                }
			                $buyer_wise_summary_arr[$buyerName]["cost_per_kg"]+=($tot_batch_weightQty>0) ? ($first_chemi_cost+$first_dyeing_cost)/$tot_batch_weightQty : 0;

			                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
			                //if($reding_batch_id[$b_id]!="")
						   $sum_extention_no=$batch_ext_wise_arr[$b_id]['extention_no'];
							if($sum_extention_no>0)
							{
								 //echo $b_id.",";
							//foreach($re_b_idArr as $re_b_id)
			                //{
								$re_batch_weight=$tot_batch_weightQty;//$batch_description_arr[$b_id]["batch_weight"];
			                   $tot_re_sum_issue_amt_chemical=$tot_re_sum_issue_amt_deys=0;$re_sum_batchIdArr='';
							   $re_sum_issue_amt_chemical=$re_sum_issue_amt_deys=0;
							    foreach($sum_ReqIdsArr as $reqId)
									{
									
										$re_sum_issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										//$re_sum_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
										$re_sum_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
										 
										 $batch_idsAll=$ReqBatch_id_arr[$reqId]; 
										//$re_sum_batchIdArr.=$batch_idsAll.',';
										
										 $re_sum_batchIds=rtrim($batch_idsAll,',');
										$ResumbatIdArr=array_unique(explode(",",$re_sum_batchIds)); 
										$Resum_tot_batch_wgt=0;
										foreach($ResumbatIdArr as $batchId)
										{
										//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
										//echo $batch_wgt_arr[$batchId]['batchWgt'].'p';
										$Resum_tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt']; 
										}
										
										if($re_sum_issue_amt_chemical)
										{	
										//$re_issue_amt_perKg_chemical=($re_sum_issue_amt_chemical/$Resum_tot_batch_wgt);
										//$re_issue_amt_cal_chemical+=$re_issue_amt_perKg_chemical*$re_batch_weight;
										$tot_re_sum_issue_amt_chemical+= (($re_sum_issue_amt_chemical/$Resum_tot_batch_wgt)*$re_batch_weight);
										
										}
										//else{$re_issue_amt_cal_chemical=0;}
										
										if($re_sum_issue_amt_deys)
										{
										//$re_issue_amt_perKg_dyes=($re_sum_issue_amt_deys/$Resum_tot_batch_wgt);
										//$re_issue_amt_cal_dyes=$re_issue_amt_perKg_dyes*$re_batch_weight;
										if($sum_extention_no==2)
										{
											// echo $re_sum_issue_amt_deys.'/'.$Resum_tot_batch_wgt.'*'.$re_batch_weight.'<br>';;
										}
										$tot_re_sum_issue_amt_deys+= (($re_sum_issue_amt_deys/$Resum_tot_batch_wgt)*$re_batch_weight);
										//echo $reqId.'d';
										// echo $re_sum_issue_amt_deys.'/'.$Resum_tot_batch_wgt.'*'.$re_batch_weight.'<br>';;
										}
										//else{$re_issue_amt_cal_dyes=0;}
										
									}
									
									$re_issue_amt_cal_chemical_tot=$tot_re_sum_issue_amt_chemical;
									$re_issue_amt_cal_dyes_tot=$tot_re_sum_issue_amt_deys;
									//echo $Resum_tot_batch_wgt.'='.$batch_weight.'='.$re_sum_issue_amt_chemical.',';;
									
									
								$re_dying_chemical_cost=$re_issue_amt_cal_chemical_tot;//$costDataArr[$re_b_id][5]+$costDataArr[$re_b_id][7];
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_chemical_cost"]+=$re_dying_chemical_cost;

			                    $re_dying_dyes_cost=$re_issue_amt_cal_dyes_tot;//$costDataArr[$re_b_id][6];	
								
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_dyes_cost"]+=$re_dying_dyes_cost;

			                    $re_dying_dyes_chemical_cost=$re_issue_amt_cal_chemical_tot+$re_issue_amt_cal_dyes_tot;
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_dyes_chemical_cost"]+=$re_dying_dyes_chemical_cost;
			                //}
						}
			                $buyer_wise_summary_arr[$buyerName]["re_dye_cost_per_kg"]+=($tot_batch_weightQty>0) ? $re_dying_dyes_chemical_cost/$tot_batch_weightQty: 0;

			                $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
			                $buyer_wise_summary_arr[$buyerName]["total_per_kg_cost"]+=($tot_batch_weightQty>0) ? ($first_chemi_cost+$first_dyeing_cost)/$tot_batch_weightQty : 0;

			                //$buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price)/$buyer["batch_qty"]
						}	
					}
				 //	echo $ttttt.'========';
					
				    // echo "<pre>";print_r($sub_buyer_summary_Qty_arr);
					$tot_sub_buyer_qty_omit=$summary_total_re_batch_weight=0;
					foreach($buyer_wise_summary_arr as $buyer_id=>$buyer) 
					{
						if($j%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
						$sub_buyer_qty_omit=0;
						$sub_buyer_qty_omit=$sub_buyer_summary_Qty_arr[$buyer_id]["sub_batch_qty"];
						$tot_sub_buyer_qty_omit+=$sub_buyer_qty_omit; 
						
			            $summaryHTML.='<tr bgcolor="'.$bgcolor.'">
			                <td width="30">'.$j.'</td>
				            <td width="100" title='.$buyer_id.'><p>'.$buyer_library[$buyer_id].'</p></td>
			                <td width="100" align="right"><p>'.fn_number_format($buyer["batch_qty"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.fn_number_format($buyer["first_chemi_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.fn_number_format($buyer["first_dyeing_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>';
			                $summary_batch_chemical_price=$buyer["first_chemi_cost"]+$buyer["first_dyeing_cost"];
							$tot_summ_cost=$buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price;
			                $summaryHTML.=fn_number_format($summary_batch_chemical_price,4,".","").'</p></td>
			                <td width="100" align="right"><p>'.fn_number_format($summary_batch_chemical_price/$buyer["batch_qty"],4,".","").' 
 </p></td>
							<td width="100" align="right" ><p>'.fn_number_format($buyer["re_batch_qty"],4,".","").'</p></td>	
			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_chemical_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_dyes_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_dyes_chemical_cost"],4,".","").'</p></td>
			                <td width="100" align="right">'.number_format($buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price,4,".","").'</td>
			                <td width="100" align="right">
			                '.fn_number_format($tot_summ_cost/$buyer["batch_qty"],4,".","").'
			                </td>
			            </tr>';
						$summary_total_batch_weight+=$buyer["batch_qty"];
						$summary_total_re_batch_weight+=$buyer["re_batch_qty"];
						$summary_total_chemical_cost+=$buyer["first_chemi_cost"];
						$summary_total_dyes_cost+=$buyer["first_dyeing_cost"];
						$summary_total_batch_chemical_price+=$summary_batch_chemical_price;
						$summary_tot_total_receive+=$totalReceive;
						$summary_tot_re_dying_chemical_cost+=$buyer["re_dying_chemical_cost"];
						$summary_tot_re_dying_dyes_cost+=$buyer["re_dying_dyes_cost"];
						$summary_tot_re_dying_dyes_chemical_cost+=$buyer["re_dying_dyes_chemical_cost"];
						$summary_cost_per_kg+=$buyer["cost_per_kg"];
						$summary_total_per_kg_cost+=$buyer["total_per_kg_cost"];
						$j++;
					}
					?>
	            <? $summaryHTML.='</tbody>
	      	</table>
      	</div>
       	<table align="left" width="1540" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="summary_table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="100" align="right">&nbsp;Total</th>
                    <th width="100" id="value_total_batch_weight_summary" title='.$tot_sub_buyer_qty_omit.'>'.number_format($summary_total_batch_weight-$tot_sub_buyer_qty_omit,4).'</th>
                	<th width="100" align="right" id="value_total_chemical_cost_summary">'.number_format($summary_total_chemical_cost,4).'</th>
                	<th width="100" align="right" id="value_total_dyeing_cost_summary">'.number_format($summary_total_dyes_cost,4).'</th>
                    <th width="100" align="right" id="value_total_chemical_price_summary">'.number_format($summary_total_batch_chemical_price,4).'</th>
                    <th width="100" align="right" id="value_total_cost_per_kg_summary">'.fn_number_format($summary_total_batch_chemical_price/$summary_total_batch_weight,4).'</th>
					<th width="100" align="right" id="value_total_redying_chemic_oost_summary">'.number_format($summary_total_re_batch_weight,4).'</th>
                    <th width="100" align="right" id="value_total_redying_chemic_oost_summary">'.number_format($summary_tot_re_dying_chemical_cost,4).'</th>
                    <th width="100" align="right" id="value_total_redying_dying_cost_summary"><p>'.number_format($summary_tot_re_dying_dyes_cost,4).'</p></th>
                    <th width="100" align="right" id="value_total_redying_all_cost_summary"><p>'.number_format($summary_tot_re_dying_dyes_chemical_cost,4).'</p></th>
                    <th width="100" align="right" id="value_total_total_cost_summary">'.number_format($summary_total_batch_chemical_price+$summary_tot_re_dying_dyes_chemical_cost,4).'</th>
                    <th width="100" align="right" id="value_total_total_per_kg_cost_summary" title="">'.fn_number_format(($summary_total_batch_chemical_price+$summary_tot_re_dying_dyes_chemical_cost)/$summary_total_batch_weight,4).'</th>
                </tr>
            </tfoot>
        </table>
    	</div>';?>
    <? echo $summaryHTML;?>

 	 
        <div   style="font-size:18px">Details</div>
       	 <table width="2880" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" align="left" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>
                    <th rowspan="2" width="80">Date</th>
                    <th rowspan="2" width="100">Machine No</th>
                    <th rowspan="2" width="100">Batch No</th>
                    <th rowspan="2" width="80">File No</th>
                    <th rowspan="2" width="80">Ref. No</th>
                    <th rowspan="2" width="100">Floor Name</th>
                    <th rowspan="2" width="100">Buyer</th>
                    <th rowspan="2" width="100">Booking No</th>
                    <th rowspan="2" width="100">Job no</th>
                    <th rowspan="2" width="80">Season</th>                  
                    <th rowspan="2" width="100">Style</th>
                   
                    <th rowspan="2" width="100">Color Name</th>
                    <th rowspan="2" width="100">Color Range</th>
                    <th rowspan="2" width="100">Fabric Type </th>
                    <th rowspan="2" width="100">Batch Qty(Kg)</th>
                    <th colspan="4"  width="">First Dying And<br> Finishing Cost</th>
                    <th colspan="6" width="">Subsequent<br> Dyeing and <br>Fisnihing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per<br> Kg Cost (Tk)</th>
                    <th rowspan="2" width="">Result</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem<br> Cost (Tk)</th>
                    <th width="100">Ttl Dyes<br> Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes<br> Cost (Tk)</p></th>
                    <th width="100">Cost Per<br> Kg (Tk)</th>
                    <th width="100">Extention<br> Batch Date</th>
                    <th width="70">Ext. No</th>
                    <th width="100">Floor Name</th>
                    <th width="100">Ttl Chem <br>Cost(Tk)</th>
                    <th width="100"> Ttl Dyes<br> Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes<br> Cost (Tk)</p></th>
                    
                </tr> 
            </thead>
        </table>
        <div style="width:2900px; max-height:400px;  overflow-y:scroll" id="scroll_body">
	        <table width="2880" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_id" align="left" >
	          
			       	<?
				    // echo "<pre>";print_r($issue_single_batch_arr);die;
					$tot_main_batch_weight=0;$qty_check_array=array();$z=1;$total_tot_batch_weight=$sub_buyer_grnd_tot_batchQty=0;
					$total_chemical_cost=0;
					foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
						
							if($i%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
							$all_po_id=explode(",",$po_break_down_id_arr[$batch_description_arr[$b_id]['booking_no']]); 
							//print_r($all_po_id);
							$ReqId=rtrim($ReqIdArr[$b_id],',');
							$ReqIds=implode(", ",array_unique(explode(",",$ReqId)));
							$ReqIdsArr=array_unique(explode(",",$ReqId));
							
							
							
							if($batch_description_arr[$b_id][entry_form]!=136)
							{
							$po_number_data="";
							$job_no_data="";$file_no="";$ref_no="";
							foreach($all_po_id as $p_id) // $po_number_arr[$row[csf('id')]]['po_no']
							{
								//echo $p_id.'d';
								if($po_number_data!="") $po_number_data.=",".$po_number_arr[$p_id]['po_no'];	 else $po_number_data=$po_number_arr[$p_id]['po_no'];
								if($job_no_data!="") $job_no_data.=",".$po_number_arr[$p_id]['job'];	
								 else $job_no_data=$po_number_arr[$p_id]['job'];
								if($season_data!="") $season_data.=",".$season_name_arr[$po_number_arr[$p_id]['season']];	 else $season_data=$season_name_arr[$po_number_arr[$p_id]['season']];
								if($file_no!="") $file_no.=",".$po_number_arr[$p_id]['file_no'];	 else $file_no=$po_number_arr[$p_id]['file_no'];
								if($ref_no!="") $ref_no.=",".$po_number_arr[$p_id]['ref_no'];	 else $ref_no=$po_number_arr[$p_id]['ref_no'];
							}
							$file_cond=implode(", ",array_unique(explode(",",$file_no)));
							$ref_cond=implode(", ",array_unique(explode(",",$ref_no))); 
							}
							//$categrybatch=rtrim($categryDataArr[$b_id][$row[csf('item_category_id')]],',');
						//$categryId=implode(", ",array_unique(explode(",",$categrybatch)));
							//echo $po_number_data.'XX';;
							$color_range_id=$batch_description_arr[$b_id]['color_range'];
							
							if($batch_description_arr[$b_id]['without_order']==1 && $ref_cond=="")
							{
							$ref_cond=$sample_booking_ref_no_arr[$batch_description_arr[$b_id]['booking_no']];
							}
							
							$re_b_id=rtrim($re_all_batch_wise_arr[$batch_arr[$b_id]]['batch_id'],',');
							$re_b_idArr=array_unique(explode(",",$re_b_id));
							//echo $re_b_id.'======';
							$re_b_ids=implode(",",array_unique(explode(",",$re_b_id)));
							$extention_noData=rtrim($batch_wise_arr[$batch_arr[$b_id]]['extention_no'],',');
							$extention_noArr=array_unique(explode(",",$extention_noData));
							$extention_no=$batch_ext_wise_arr[$b_id]['extention_no'];
							$ext_batch_date=$batch_ext_wise_arr[$b_id]['batch_date'];;
							if($re_b_ids) $re_b_idsCond.=",".$re_b_ids;else $re_b_idsCond="";
							if($batch_description_arr[$b_id][entry_form]==136)
							{
								 $job_no=$batch_description_arr[$b_id][job_no];
								 $ref_noArr=rtrim($trim_batch_job_arr[$job_no]['ref_no'],','); 
								 $file_noArr=rtrim($trim_batch_job_arr[$job_no]['file_no'],',');
								  $ref_cond=implode(",",array_unique(explode(",",$ref_noArr))); 
								  $file_cond=implode(",",array_unique(explode(",",$file_noArr))); 
									 
								//$file_cond=$file_cond;
								//$ref_cond=$ref_cond;
							}
							else
							{
								$file_cond=$file_cond;$ref_cond=$ref_cond;
							}
							
							$batch_noArr=$batch_arr[$b_id];
							if (!in_array($batch_noArr,$qty_check_array))
							{ 
								$z++;
								$qty_check_array[]=$batch_noArr;
								$tot_batch_weight=$batch_description_arr[$b_id]['batch_weight'];
							}
							else
							{
								$tot_batch_weight=0;//result
							}
							if($extention_no)
							{
								$tot_batch_weight=$batch_description_arr[$b_id]['re_batch_weight'];
							}
							 //echo $b_id.'='.$batch_description_arr[$b_id]['re_batch_weight'].'='.$tot_batch_weight.'<br>';
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="30"><? echo $i; ?></td>								
				                <td width="80"><? echo change_date_format($batch_description_arr[$b_id]['batch_date']); ?></td>
				                <td width="100"><p><? echo $machine_name_arr[$b_id]; ?></p></td>                                 
				                <td width="100" title="BatchId=<? echo $b_id;?>"><p>
                                <A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','batch_wise_subprocess_fabrics_dtls_popup2','<? echo $ReqIds; ?>',1)"> <? echo $batch_arr[$b_id]; ?> </A>
                               <? //echo $batch_arr[$b_id]; ?></p></td>
				                <td width="80"><p><? echo $file_cond; ?></p></td>
				                <td width="80" title="PO/Sample Ref no"><p><? echo $ref_cond; ?></p></td>
				                <td width="100"><p  style="word-break:break-all"><? echo $floor_arr[$b_id]; ?></p></td> 
				                <?
								$sub_batch_buyer="";
				                if($batch_description_arr[$b_id][entry_form]==36)
				                {
									
									 $sub_batch_buyer=$sub_batch_chk_arr[$b_id];
									if($sub_batch_buyer>0)//Subcon buyer Omitted //(426,439,444,458,425,427,428,443,392,564,565,563)
									{
										$sub_buyer_grnd_tot_batchQty+=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
									}
					              
									?>
					                <td width="100"><p style="word-break:break-all"><? echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][party_id]))); ?></p></td> 
					                <td width="100"><p><? // echo $b_id; ?></p></td>
					                <td width="100" align="center"><p style="word-break:break-all">
					                <? 
				                     echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                 <td width="80" align="center"><p>
					                <? 
				                     //echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                <td width="100" align="center"><p style="word-break:break-all"> <? echo   implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][cust_style_ref]))); ?></p></td>
					                
				                	<?
				                }
								else if($batch_description_arr[$b_id][entry_form]==136)
				                {
					               $job_no=$batch_description_arr[$b_id][job_no]; 
								   $season_dataArr=rtrim($season_name_arr[$trim_batch_job_arr[$job_no]['season']],',');//season_name_arr
								   $season_data=implode("",array_unique(explode(",",$season_dataArr)));
								   $buyerName=$buyer_library[$trim_batch_job_arr[$job_no]['buyer']]; 
								//   $trim_batch_job_arr[$row[csf('job_no_mst')]]['buyer'];
								   $po_number_data=rtrim($trim_batch_job_arr[$job_no]['po_number'],','); 
								    $ref_noArr=rtrim($trim_batch_job_arr[$job_no]['ref_no'],','); 
									 $file_noArr=rtrim($trim_batch_job_arr[$job_no]['file_no'],','); 

									// $po_number_data=rtrim($trim_batch_job_arr[$job_no]['po_number'],','); 
									?>
					               <td width="100" title="BuyerID=<?=$trim_batch_job_arr[$job_no]['buyer'];?>"><p><? 
					                 
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
					                <td width="100"><p><? //echo $batch_description_arr[$b_id]['booking_no']; ?></p></td>
					                <td width="100" align="center"><div style="word-break:break-all">
					                <?
					                echo $job_no;
					                ?></div></td>
					                <td width="80" align="center"><div style="word-break:break-all">
					                <? 
					                
					                echo $season_data;

					                ?></div></td>
					                <td width="100" align="center"><div style="word-break:break-all"> 
					                <? 
					                $style_no=$style_library[$job_no];
					                echo $style_no; ?></div></td>
					                
				                	<?
				                }
				                else
				                {
					                ?>
					                <td width="100"><p style="word-break:break-all"><? 
					                if($batch_description_arr[$b_id]['without_order']==1) $buyerName=$non_buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];else $buyerName=$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];
									//echo $buyerName.',A';
									$sales_order_id= $sales_batch_arr[$b_id];
									if($buyerName=='')
									{
										$buyerName= $buyer_library[$fabric_sales_arr[$sales_order_id]['po_buyer']];
									}
									
									//echo $buyerName.',B';
									$buyer_id=$fabric_sales_arr[$sales_order_id]['buyer_id'];
										if($sales_order_id && $buyerName=='')
										{
											$buyerName='';//buyer_arr
											$buyerName=$buyer_library[$buyer_id];
											//echo "DDDD";	
										}
										else $buyerName=$buyerName;
							
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
					                <td width="100"><p style="word-break:break-all"><? echo $batch_description_arr[$b_id]['booking_no']; ?></p></td>
					                <td width="100" align="center"><div style="word-break:break-all">
					                <?
					                echo implode(", ",array_unique(explode(",",$job_no_data)));
					                ?></div></td>
					                <td width="80" align="center"><div style="word-break:break-all">
					                <? 
					                
					                echo implode(", ",array_unique(explode(",",$season_data)));

					                ?></div></td>
					                <td width="100" align="center"><div style="word-break:break-all"> 
					                <? 
					                $style_no=array();
					                foreach(array_unique(explode(",",$job_no_data)) as $j_no)
					                {
					                    if($style_no!="")  $style_no[]=$style_library[$j_no];
					                }
					                echo implode(", ",array_unique($style_no)); ?></div></td>
					                
                                   
					                <?	
				                }
				                ?>
				                <td width="100" align="center"><div style="word-break:break-all"><? echo $color_arr[$batch_description_arr[$b_id]['color_id']]; ?></div></td> 
				                <td width="100" align="center"><p style="word-break:break-all"><? echo $color_range[$color_range_id]; ?></p></td> 
				                <td width="100" align="center"><p style="word-break:break-all"><? echo $fabric_type_for_dyeing[$fabric_type_arr[$b_id]['fabric_type']]; //$fabric_type_for_dyeing?></p></td> 
				                <td width="100" align="right"><p>
				               <? echo fn_number_format($tot_batch_weight,4); 
								
								//$total_batch_weight+=$batch_description_arr[$b_id]['batch_weight'];
								$total_batch_weight+=$tot_batch_weight;//tot_batch_weight
								
								?>
				                </p></td> 
				                <?
				                $batch_weight=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
				                $first_chemi_cost=$first_dyeing_cost=0;
				                if($non_reding_batch_id[$b_id]!="")
				                {
				                    
									$issue_amt_deys=0;$issue_amt_chemical=$totalcost=0;
									$batchIdArr="";$tot_chemicalCost=$tot_dyesCost=0;
									foreach($ReqIdsArr as $reqId)
									{
										
										$issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										$issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
									
									    $batch_ids=$ReqBatch_id_arr[$reqId]; 
										$batIdArr=array_unique(explode(",",$batch_ids)); 
										$tot_batch_wgt=0;
									    //print_r($batIdArr);
										foreach($batIdArr as $batchId)
										{
											$tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt'];
										}
										 // echo $issue_amt_chemical.'='.$tot_batch_wgt.'='.$batch_weight."<br />";
										 //$ref_cond=implode(",",array_unique(explode(",",$ref_noArr))); 
										//$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']];;
										if($issue_amt_chemical>0)
										{
										$tot_chemicalCost+= (($issue_amt_chemical/$tot_batch_wgt)*$batch_weight);
										}
										if($issue_amt_deys>0)
										{
										$tot_dyesCost+= (($issue_amt_deys/$tot_batch_wgt)*$batch_weight);
										}
									}
									
									
									if($tot_chemicalCost)
									{
									//$issue_amt_perKg_chemical=($issue_amt_chemical/$tot_batch_wgt);
									$issue_amt_cal_chemical=$tot_chemicalCost;//$issue_amt_perKg_chemical*$batch_weight;
									//echo $issue_amt_cal_chemical.'D'; 
									} 
									else 
									{ $issue_amt_cal_chemical=0;}
									
									if($tot_dyesCost)
									{
									//$issue_amt_perKg_dyes=($issue_amt_deys/$tot_batch_wgt);
									$issue_amt_cal_dyes=$tot_dyesCost;
									}
									else {$issue_amt_cal_dyes=0;}
									
				                    $first_chemi_cost=$issue_amt_cal_chemical;//$costDataArr[$b_id][5]+$costDataArr[$b_id][7];
				                    $first_dyeing_cost=$issue_amt_cal_dyes;//$costDataArr[$b_id][6];
									
									$tot_main_batch_weight+=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
				                }
				                
				                ?>
				                <td width="100" align="right" title="BatchId=<? echo $b_id;?>"><p>
				                <?
				                 echo number_format($first_chemi_cost,4,".",""); 
				                 $total_chemical_cost+=$first_chemi_cost;
				                 ?>
				                </p></td>
				                <td width="100" align="right"><p>
				                <?  
				                    echo number_format($first_dyeing_cost,4,".",""); 
				                    $total_dyes_cost+=$first_dyeing_cost+$first_chemi_cost; 
				                ?>
				                </p></td>
				                <td width="100" align="right"  title="ReqId=<? echo $ReqIds;?>">
								<p>
								<?
								 $batch_chemical_price=0;
								if($first_chemi_cost+$first_dyeing_cost>0)
								{
								?>	
								<A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','1st_chemi_dyes_batch_dtls_popup','<? echo $ReqIds; ?>',2)">
				                <?
								 
				                 $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
				                  echo number_format($first_chemi_cost+$first_dyeing_cost,4,".","");
				                  $total_batch_chemical_price+=$batch_chemical_price;
				                ?>
				                </A>
									<?
								}
									?>
								</p></td>
				                <td width="100" align="right"><p><? if($batch_chemical_price) echo fn_number_format($batch_chemical_price/$tot_batch_weight,4,".","");
								 $tot_total_receive+=$totalReceive; ?></p>
							 
							</td>
				                <td width="100" align="right"><p>
				                <? 
				                $extension_no="";
				                $re_batch_date="";
				                $batch_date=explode(",", $redying_details_arr[$b_id]['batch_date']);	
				               
				                echo change_date_format($ext_batch_date);
				                 ?></p></td>
				                <td width="70" title="BatchId=<? echo $b_id;?>" align="right"><p>
				                <?		                
				                //echo $redying_details_arr[$b_id]['id'].jahid;
								
				                if(trim($redying_details_arr[$b_id]['id']))
				                {
				                    $re_dying_id_all=array_unique(explode(",",$redying_details_arr[$b_id]['id']));
				                    
				                    
				                    $result_id="";
				                    $result_id_last='';
				                    
				                    foreach($re_dying_id_all as $ash_id)
				                    {
				                    
				                        
				                     if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                   
				                    }
				                }
				                //echo $b_id;
				                //if($batch_type==3)
				                //{
				                echo $extention_no;	 ?>
				                
				                
				                </p></td>
				                <td width="100" align="right"><p><?
				                $re_floors='';
				                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
				               
							   	// foreach($re_b_idArr as $re_bid)
				                // {
				                //     $re_floors=$floor_arr[$re_bid];
								// 	 echo $re_bid.'=DDD';
				                     
				                // }
								$re_floors=$floor_arr[$b_id];
								//echo $extention_no.'D=';
								$re_tot_chemicalCost=0; 
								if($extention_no>0)
								{
									$re_batch_weight=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
									
									$re_issue_amt_deys=0;$re_issue_amt_chemical=0;$re_tot_dyesCost=0;
									$rebatchIdArr="";
									foreach($ReqIdsArr as $reqId)
									{
										 
										$re_issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										$re_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
										
										 $batch_ids=$ReqBatch_id_arr[$reqId]; 
										// echo $batch_ids.'=SSS';
										
										$batchIds=rtrim($batch_ids,',');
										$rebatchIdArr=array_unique(explode(",",$batchIds)); 
										$re_tot_batch_wgt=0;
										foreach($rebatchIdArr as $rebatchId)
										{
											//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
												$re_tot_batch_wgt+=$batch_wgt_arr[$rebatchId]['batchWgt']; 
										}
										if($re_issue_amt_chemical>0)
										{
										$re_tot_chemicalCost+= (($re_issue_amt_chemical/$re_tot_batch_wgt)*$re_batch_weight);
										}
										if($re_issue_amt_deys>0)
										{
											// echo $b_id.'='.$re_issue_amt_deys.'='.$re_tot_batch_wgt.'='.$re_batch_weight.'<br>';
										$re_tot_dyesCost+= (($re_issue_amt_deys/$re_tot_batch_wgt)*$re_batch_weight);
										}
										
									}
									
									//echo $re_issue_amt_chemical.'='.$re_tot_batch_wgt.'='.$batch_weight.',';
										
									if($re_tot_chemicalCost)
									{
									//$re_issue_amt_perKg_chemical=($re_issue_amt_chemical/$re_tot_batch_wgt);
									$re_issue_amt_cal_chemical=$re_tot_chemicalCost;
									}
									else 
									{$re_issue_amt_cal_chemical=0;}
									
									if($re_tot_dyesCost)
									{
									//$re_issue_amt_perKg_dyes=($re_issue_amt_deys/$re_tot_batch_wgt);
									$re_issue_amt_cal_dyes=$re_tot_dyesCost;
									}
									else
									{
										$re_issue_amt_cal_dyes=0;
									}
									
									$re_dying_chemical_cost=$re_issue_amt_cal_chemical;//$costDataArr[$re_bid][5]+$costDataArr[$re_bid][7];
				                    $re_dying_dyes_cost=$re_issue_amt_cal_dyes;//$costDataArr[$re_bid][6]	;	
				                    $re_dying_dyes_chemical_cost=$re_dying_chemical_cost+$re_issue_amt_cal_dyes;//$costDataArr[$re_bid][5]+$costDataArr[$re_bid][6]+$costDataArr[$re_bid][7];
								}
				                
				                echo $re_floors;
				                ?></p></td>
				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($re_dying_chemical_cost,4,".",""); 
				                 $tot_re_dying_chemical_cost+=$re_dying_chemical_cost;

								 
				                 ?>
				                 </p></td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_dyes_cost,4,".",""); $tot_re_dying_dyes_cost+=$re_dying_dyes_cost;  ?></p></td>
				                <td width="100" align="right" title="ReqId=<? echo $ReqIds;?>">
								<?
								//echo $re_dying_dyes_chemical_cost.'===AD';
								 if($re_dying_dyes_chemical_cost)
								 {
								?>
								<A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','1st_chemi_dyes_batch_dtls_popup','<? echo $ReqIds; ?>',2)"><p><? echo number_format($re_dying_dyes_chemical_cost,4,".",""); $tot_re_dying_dyes_chemical_cost+=$re_dying_dyes_chemical_cost; ?></p></A>
								<?
								 

								}
								?>
								</td>
				                 
				               

				                <td width="100" align="right"><? echo fn_number_format($re_dying_dyes_chemical_cost+$batch_chemical_price,4,".",""); ?></td>
				                <td width="100" align="right" title="<? echo '('.$re_dying_dyes_chemical_cost.'+'.$batch_chemical_price.')/'.$tot_batch_weight; ?>"><?
				                 echo  fn_number_format(($re_dying_dyes_chemical_cost+$batch_chemical_price)/$tot_batch_weight,4,".","");  ?></td>
				                <td width="" align="center" title="<? echo $b_id; ?>"><? //echo $unload_result_arr[$b_id]//echo  $dyeing_result[$result_id];//
				                //echo $b_id.tipu;
			                    $result_id=$result_arr[$b_id];
			                    if($result_id!="")  $result_id_last=$result_id;

								if($result_id_last=='') $result_id=$batch_description_arr[$b_id]['result'];

				                echo $dyeing_result[$result_id];//$dyeing_result;//$daysOnHand; ?></td>
				            </tr>
							<? 	
						//	$total_tot_batch_weight+=$tot_batch_weight;											
							$i++; 			
						}	
					}
					?>
	          
	      	</table>
      	</div>
       	<table width="2880" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="80">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                     <th width="80">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                  
                    <th width="100">&nbsp;</th>
                    <th width="100"><? //echo number_format($total_batch_chemical_price,4).'='.$total_dyes_cost; ?></th>
                	<th width="100">Total</th>
                    <th width="100"  title="<? echo $sub_buyer_grnd_tot_batchQty.'='.$total_tot_batch_weight;?>">
					<? echo number_format($total_batch_weight,4); ?></th>
                	<th width="100" id="value_total_chemical_cost_single"><? echo number_format($total_chemical_cost,4); ?></th>
                	<th width="100" id="value_total_dyeing_cost_single"><? echo number_format($total_dyes_cost,4); ?></th>
                    <th width="100" id="value_total_chemical_price_single"><? echo number_format($total_batch_chemical_price,4); ?></th>
                    <th width="100" id=""><? echo number_format(($total_batch_chemical_price)/$total_batch_weight,4); ?></th>
                    <th width="100"><? //echo number_format($tot_re_dying_chemical_cost,3); ?></th>
                    <th width="70"><? //echo number_format($tot_rec_return,3); ?></th>
                    <th width="100"><? //echo number_format($tot_total_issue,3); ?></th>
                    <th width="100" id="value_total_redying_chemic_oost_single"><? echo number_format($tot_re_dying_chemical_cost,4); ?></th>
                    <th width="100" id="value_total_redying_dying_cost_single"><p><? echo number_format($tot_re_dying_dyes_cost,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single"><p><? echo number_format($tot_re_dying_dyes_chemical_cost,4); ?></p></th>
                    <!--<th width="100" id=""><? //echo number_format($tot_re_dying_dyes_chemical_cost/$total_batch_weight,4); ?></th>-->
                    <th width="100" id="value_total_total_cost_single"><? echo number_format($total_batch_chemical_price+$tot_re_dying_dyes_chemical_cost,4); ?></th>
                    <th width="100" id="" title="Main Batch Qty=<? echo number_format($tot_main_batch_weight,2);?>"><? echo number_format(($total_batch_chemical_price+$tot_re_dying_dyes_chemical_cost)/$total_batch_weight,4); ?></th>
                    <th width="">&nbsp;</th>
                </tr>
            </tfoot>
        </table>
		<?
		$total_batch_weight=$total_chemical_cost=0;$total_dyes_cost=$total_batch_chemical_price=$tot_re_dying_chemical_cost=$tot_re_dying_dyes_cost=$tot_re_dying_dyes_chemical_cost=$tot_main_batch_weight=0;
		//$buyer_library=return_library_array( "select id,buyer_name from   lib_buyer", "id","buyer_name" );
		?>
     
	<div>
        <div   style="font-size:18px">Reprocess Batch</div>
       	 <table width="2880" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" align="left">
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>
                    <th rowspan="2" width="80">Date</th>
                    <th rowspan="2" width="100">Machine No</th>
                    <th rowspan="2" width="100">Batch No</th>
                    <th rowspan="2" width="80">File No</th>
                    <th rowspan="2" width="80">Ref. No</th>
                    <th rowspan="2" width="100">Floor Name</th>
                    <th rowspan="2" width="100">Buyer</th>
                    <th rowspan="2" width="100">Booking No</th>
                    <th rowspan="2" width="100">Job no</th>
                    <th rowspan="2" width="80">Season</th>                  
                    <th rowspan="2" width="100">Style</th>
                   
                    <th rowspan="2" width="100">Color Name</th>
                    <th rowspan="2" width="100">Color Range</th>
                    <th rowspan="2" width="100">Fabric Type </th>
                    <th rowspan="2" width="100">Batch Qty (Kg)</th>
                    <th colspan="4"  width="">First Dying And Finishing Cost</th>
                    <th colspan="6" width="">Subsequent Dyeing and Finishing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per Kg Cost (Tk)</th>
                    <th rowspan="2" width="">Result</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem<br> Cost (Tk)</th>
                    <th width="100">Ttl Dyes<br> Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes<br> Cost (Tk)</p></th>
                    <th width="100">Cost Per<br> Kg (Tk)</th>
                    <th width="100">Extention<br> Batch Date</th>
                    <th width="70">Ext. No</th>
                    <th width="100">Floor Name</th>
                    <th width="100">Ttl Chem <br>Cost(Tk)</th>
                    <th width="100"> Ttl Dyes<br> Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes<br> Cost (Tk)</p></th>
                    
                </tr> 
            </thead>
        </table>
        <div style="width:2900px; max-height:400px;  overflow-y:scroll" id="re_scroll_body">
	        <table width="2880" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="re_table_body_id" align="left" >
	            <tbody>
			       	<?
				    // echo "<pre>";print_r($re_issue_single_batch_arr);die;
					$i=1;
					$tot_main_batch_weight=0;$qty_check_array=array();$z=1;$total_tot_batch_weight=$sub_buyer_grnd_tot_batchQty=0;
					foreach(array_unique($re_issue_single_batch_arr) as $b_id) //re_batch_wise_arr
					{
						
						
							if($i%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
							$all_po_id=explode(",",$po_break_down_id_arr[$re_batch_description_arr[$b_id]['booking_no']]); 
							//print_r($all_po_id);
							$ReqId=rtrim($re_ReqIdArr[$b_id],',');
							$ReqIds=implode(", ",array_unique(explode(",",$ReqId)));
							$ReqIdsArr=array_unique(explode(",",$ReqId));
							
							
							
							if($re_batch_description_arr[$b_id][entry_form]!=136)
							{
							$po_number_data="";
							$job_no_data="";$file_no="";$ref_no="";
							foreach($all_po_id as $p_id) // $po_number_arr[$row[csf('id')]]['po_no']
							{
								//echo $p_id.'d';
								if($po_number_data!="") $po_number_data.=",".$po_number_arr[$p_id]['po_no'];	 else $po_number_data=$po_number_arr[$p_id]['po_no'];
								if($job_no_data!="") $job_no_data.=",".$po_number_arr[$p_id]['job'];	
								 else $job_no_data=$po_number_arr[$p_id]['job'];
								if($season_data!="") $season_data.=",".$season_name_arr[$po_number_arr[$p_id]['season']];	 else $season_data=$season_name_arr[$po_number_arr[$p_id]['season']];
								if($file_no!="") $file_no.=",".$po_number_arr[$p_id]['file_no'];	 else $file_no=$po_number_arr[$p_id]['file_no'];
								if($ref_no!="") $ref_no.=",".$po_number_arr[$p_id]['ref_no'];	 else $ref_no=$po_number_arr[$p_id]['ref_no'];
							}
							$file_cond=implode(", ",array_unique(explode(",",$file_no)));
							$ref_cond=implode(", ",array_unique(explode(",",$ref_no))); 
							}
							//$categrybatch=rtrim($categryDataArr[$b_id][$row[csf('item_category_id')]],',');
						//$categryId=implode(", ",array_unique(explode(",",$categrybatch)));
							//echo $po_number_data.'XX';;
							$color_range_id=$re_batch_description_arr[$b_id]['color_range'];
							
							if($re_batch_description_arr[$b_id]['without_order']==1 && $ref_cond=="")
							{
							$ref_cond=$sample_booking_ref_no_arr[$re_batch_description_arr[$b_id]['booking_no']];
							}
							
							$re_b_id=rtrim($re_batch_wise_arr[$re_batch_arr[$b_id]]['batch_id'],',');
							$re_b_idArr=array_unique(explode(",",$re_b_id));
							//echo $re_b_id.'======';
							$re_b_ids=implode(",",array_unique(explode(",",$re_b_id)));
							//echo $re_batch_wise_arr[$b_id]['extention_no'].'AAAAAAAA';

							$extention_noData=rtrim($re_batch_wise_arr[$re_batch_arr[$b_id]]['extention_no'],',');
							$extention_noArr=array_unique(explode(",",$extention_noData));
							$extention_no=rtrim($re_batch_wise_arr[$b_id]['extention_no'],',');//$re_batch_ext_wise_arr[$b_id]['extention_no'];
							$ext_batch_date=$re_batch_wise_arr[$b_id]['batch_date'];;
							if($re_b_ids) $re_b_idsCond.=",".$re_b_ids;else $re_b_idsCond="";
							if($re_batch_description_arr[$b_id][entry_form]==136)
							{
								 $job_no=$re_batch_description_arr[$b_id][job_no];
								 $ref_noArr=rtrim($trim_batch_job_arr[$job_no]['ref_no'],','); 
								 $file_noArr=rtrim($trim_batch_job_arr[$job_no]['file_no'],',');
								  $ref_cond=implode(",",array_unique(explode(",",$ref_noArr))); 
								  $file_cond=implode(",",array_unique(explode(",",$file_noArr))); 
									 
								//$file_cond=$file_cond;
								//$ref_cond=$ref_cond;
							}
							else
							{
								$file_cond=$file_cond;$ref_cond=$ref_cond;
							}
							
							$batch_noArr=$re_batch_arr[$b_id];
							if (!in_array($batch_noArr,$qty_check_array))
							{ 
								$z++;
								$qty_check_array[]=$batch_noArr;
								$tot_batch_weight=$re_batch_description_arr[$b_id]['batch_weight'];
							}
							else
							{
								$tot_batch_weight=0;
							}
						
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('trRe_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trRe_<? echo $i; ?>">
				                <td width="30"><? echo $i; ?></td>								
				                <td width="80"><? echo change_date_format($re_batch_description_arr[$b_id]['batch_date']); ?></td>
				                <td width="100"><p><? echo $machine_name_arr[$b_id]; ?></p></td>                                 
				                <td width="100" title="BatchId=<? echo $b_id;?>"><p>
                                <A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','batch_wise_subprocess_fabrics_dtls_popup2','<? echo $ReqIds; ?>',1)"> <? echo $re_batch_arr[$b_id]; ?> </A>
                               <? //echo $batch_arr[$b_id]; ?></p></td>
				                <td width="80"><p><? echo $file_cond; ?></p></td>
				                <td width="80" title="PO/Sample Ref no"><p><? echo $ref_cond; ?></p></td>
				                <td width="100"><p  style="word-break:break-all"><? echo $floor_arr[$b_id]; ?></p></td> 
				                <?
								$sub_batch_buyer="";
				                if($re_batch_description_arr[$b_id][entry_form]==36)
				                {
									
									 $sub_batch_buyer=$sub_batch_chk_arr[$b_id];
									if($sub_batch_buyer>0)//Subcon buyer Omitted //(426,439,444,458,425,427,428,443,392,564,565,563)
									{
										$sub_buyer_grnd_tot_batchQty+=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
									}
					              
									?>
					                <td width="100"><p style="word-break:break-all"><? echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][party_id]))); ?></p></td> 
					                <td width="100"><p><? // echo $b_id; ?></p></td>
					                <td width="100" align="center"><p style="word-break:break-all">
					                <? 
				                     echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                 <td width="80" align="center"><p>
					                <? 
				                     //echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                <td width="100" align="center"><p style="word-break:break-all"> <? echo   implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][cust_style_ref]))); ?></p></td>
					                
				                	<?
				                }
								else if($re_batch_description_arr[$b_id][entry_form]==136)
				                {
					               $job_no=$batch_description_arr[$b_id][job_no]; 
								   $season_data=$season_name_arr[$trim_batch_job_arr[$job_no]['season']];//season_name_arr
								   $buyerName=$buyer_library[$trim_batch_job_arr[$job_no]['buyer']]; 
								//   $trim_batch_job_arr[$row[csf('job_no_mst')]]['buyer'];
								   $po_number_data=rtrim($trim_batch_job_arr[$job_no]['po_number'],','); 
								    $ref_noArr=rtrim($trim_batch_job_arr[$job_no]['ref_no'],','); 
									 $file_noArr=rtrim($trim_batch_job_arr[$job_no]['file_no'],','); 
									?>
					               <td width="100" title="BuyerID=<?=$trim_batch_job_arr[$job_no]['buyer'];?>"><p><? 
					                 
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
					                <td width="100"><p><? //echo $batch_description_arr[$b_id]['booking_no']; ?></p></td>
					                <td width="100" align="center"><div style="word-break:break-all">
					                <?
					                echo $job_no;
					                ?></div></td>
					                <td width="80" align="center"><div style="word-break:break-all">
					                <? 
					                
					                echo $season_data;

					                ?></div></td>
					                <td width="100" align="center"><div style="word-break:break-all"> 
					                <? 
					                $style_no=$style_library[$job_no];
					                echo $style_no; ?></div></td>
					                
				                	<?
				                }
				                else
				                {
					                ?>
					                <td width="100"><p style="word-break:break-all"><? 
					                if($re_batch_description_arr[$b_id]['without_order']==1) $buyerName=$non_buyer_name_arr[$re_batch_description_arr[$b_id]['booking_no']];else $buyerName=$buyer_name_arr[$re_batch_description_arr[$b_id]['booking_no']];
									
									$sales_order_id= $sales_batch_arr[$b_id];
									if($buyerName=='')
									{
										$buyerName=$buyer_library[$fabric_sales_arr[$sales_order_id]['po_buyer']];
									}
								
									$buyer_id=$fabric_sales_arr[$sales_order_id]['buyer_id'];
									//echo $sales_order_id.'='.$buyer_id.'<br>';
										if($sales_order_id && $buyerName=='')
										{
											$buyerName='';//buyer_arr
											$buyerName=$buyer_library[$buyer_id];
											//echo "DDDD";	
										}
										else $buyerName=$buyerName;
							
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
					                <td width="100"><p style="word-break:break-all"><? echo $re_batch_description_arr[$b_id]['booking_no']; ?></p></td>
					                <td width="100" align="center"><div style="word-break:break-all">
					                <?
					                echo implode(", ",array_unique(explode(",",$job_no_data)));
					                ?></div></td>
					                <td width="80" align="center"><div style="word-break:break-all">
					                <? 
					                
					                echo implode(", ",array_unique(explode(",",$season_data)));

					                ?></div></td>
					                <td width="100" align="center"><div style="word-break:break-all"> 
					                <? 
					                $style_no=array();
					                foreach(array_unique(explode(",",$job_no_data)) as $j_no)
					                {
					                    if($style_no!="")  $style_no[]=$style_library[$j_no];
					                }
					                echo implode(", ",array_unique($style_no)); ?></div></td>
					                
                                   
					                <?	
				                }
				                ?>
				                <td width="100" align="center"><div style="word-break:break-all"><? echo $color_arr[$re_batch_description_arr[$b_id]['color_id']]; ?></div></td> 
				                <td width="100" align="center"><p style="word-break:break-all"><? echo $color_range[$color_range_id]; ?></p></td> 
				                <td width="100" align="center"><p style="word-break:break-all"><? echo $fabric_type_for_dyeing[$fabric_type_arr[$b_id]['fabric_type']]; //$fabric_type_for_dyeing?></p></td> 
				                <td width="100" align="right"><p>
				                <? echo number_format($tot_batch_weight,4); 
								
								//$total_batch_weight+=$batch_description_arr[$b_id]['batch_weight'];
								$total_batch_weight+=$tot_batch_weight;//tot_batch_weight
								
								?>
				                </p></td> 
				                <?
				                $batch_weight=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
				                $first_chemi_cost=$first_dyeing_cost=0;
				                if($non_reding_batch_id[$b_id]!="")
				                {
				                    
									$issue_amt_deys=0;$issue_amt_chemical=$totalcost=0;
									$batchIdArr="";$tot_chemicalCost=$tot_dyesCost=0;
									foreach($ReqIdsArr as $reqId)
									{
										//$batch_id=rtrim($batchWgtChkk[$reqId],',');
										//$issue_item_cat_amt_dtls_arr2[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']];
										
										//$val['CONS_AMOUNT']/$batch_wgt_cal;
										
										$issue_amt_chemical=$re_issue_item_cat_amt_dtls_arr[$reqId][5]+$re_issue_item_cat_amt_dtls_arr[$reqId][7];
										$issue_amt_deys=$re_issue_item_cat_amt_dtls_arr[$reqId][6];
									
									    $batch_ids=$ReqBatch_id_arr[$reqId]; 
										$batIdArr=array_unique(explode(",",$batch_ids)); 
										$tot_batch_wgt=0;
									    //print_r($batIdArr);
										foreach($batIdArr as $batchId)
										{
											$tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt'];
										}
										 //echo $issue_amt_chemical.'='.$tot_batch_wgt.'='.$batch_weight."<br />";
										 //$ref_cond=implode(",",array_unique(explode(",",$ref_noArr))); 
										//$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']];;
										if($issue_amt_chemical>0)
										{
										$tot_chemicalCost+= (($issue_amt_chemical/$tot_batch_wgt)*$batch_weight);
										}
										if($issue_amt_deys>0)
										{
										$tot_dyesCost+= (($issue_amt_deys/$tot_batch_wgt)*$batch_weight);
										}
									}
																
									if($tot_chemicalCost)
									{
									//$issue_amt_perKg_chemical=($issue_amt_chemical/$tot_batch_wgt);
									$issue_amt_cal_chemical=$tot_chemicalCost;//$issue_amt_perKg_chemical*$batch_weight;
									//echo $issue_amt_cal_chemical.'D'; 
									} 
									else 
									{ $issue_amt_cal_chemical=0;}
									
									if($tot_dyesCost)
									{
									//$issue_amt_perKg_dyes=($issue_amt_deys/$tot_batch_wgt);
									$issue_amt_cal_dyes=$tot_dyesCost;
									}
									else {$issue_amt_cal_dyes=0;}
									
				                    $first_chemi_cost=$issue_amt_cal_chemical;//$costDataArr[$b_id][5]+$costDataArr[$b_id][7];
				                    $first_dyeing_cost=$issue_amt_cal_dyes;//$costDataArr[$b_id][6];
									
									$tot_main_batch_weight+=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
				                }
				                
				                ?>
				                <td width="100" align="right" title="BatchId=<? echo $b_id;?>"><p>
				                <?
				                 echo number_format($first_chemi_cost,4,".",""); 
				                 $total_chemical_cost+=$first_chemi_cost;
				                 ?>
				                </p></td>
				                <td width="100" align="right"><p>
				                <?  
				                    echo number_format($first_dyeing_cost,4,".",""); 
				                    $total_dyes_cost+=$first_dyeing_cost; 
				                ?>
				                </p></td>
				                <td width="100" align="right"  title="ReqId=<? echo $ReqIds;?>"><p>
				                <?
				                 $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
				                  echo number_format($batch_chemical_price,4,".","");
				                  $total_batch_chemical_price+=$batch_chemical_price;
				                ?>
				                 </p></td>
				                <td width="100" align="right"><p><? echo fn_number_format($batch_chemical_price/$tot_batch_weight,4,".",""); $tot_total_receive+=$totalReceive; ?></p></td>
				                <td width="100" align="right"><p>
				                <? 
				                $extension_no="";
				                $re_batch_date="";
				                $batch_date=explode(",", $redying_details_arr[$b_id]['batch_date']);	
				               
				                echo change_date_format($ext_batch_date);
				                 ?></p></td>
				                <td width="70" title="BatchId=<? echo $b_id;?>" align="right"><p>
				                <?		                
				               // echo $redying_details_arr[$b_id]['id'].'A<br>';
								
				                if(trim($redying_details_arr[$b_id]['id']))
				                {
				                    $re_dying_id_all=array_unique(explode(",",$redying_details_arr[$b_id]['id']));
				                    //$re_dying_chemical_cost=0;
				                    //$re_dying_dyes_cost=0;
				                    //$re_dying_dyes_chemical_cost=0;
				                    
				                    $result_id="";
				                    $result_id_last='';
				                    
				                    foreach($re_dying_id_all as $ash_id)
				                    {
				                    //$re_dying_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                    //$re_dying_dyes_cost+=$dyes_chemical_arr[$ash_id][6]['chemical_cost']	;	
				                    //$re_dying_dyes_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][6]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                        
				                     if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                     //if($re_floor!="") $re_floor.=",".$floor_arr[$ash_id]; else $re_floor=$floor_arr[$ash_id];
				                    /* echo $ash_id.tipu;
				                     $result_id=$result_arr[$ash_id];
				                     if($result_id!="")  $result_id_last=$result_id;*/
				                    }
				                }
				                //echo $b_id;
				                //if($batch_type==3)
				                //{
				                echo $extention_no;	 ?>
				                
				                
				                </p></td>
				                <td width="100" align="right"><p><?
				                $re_floors='';
				                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
				                //print_r($reding_batch_id);//echo $reding_batch_id[$b_id]."##".$b_id;
				               // if($reding_batch_id[$b_id]!="")
							   	foreach($re_b_idArr as $re_bid)
				                {
				                  //  $re_floors=$floor_arr[$re_bid];
				                    /*$re_dying_chemical_cost+=$costDataArr[$re_bid][5]+$costDataArr[$re_bid][7];
				                    $re_dying_dyes_cost+=$costDataArr[$re_bid][6]	;	
				                    $re_dying_dyes_chemical_cost+=$costDataArr[$re_bid][5]+$costDataArr[$re_bid][6]+$costDataArr[$re_bid][7];*/
				                }
								// echo $extention_no.'D=';
								$re_floors=$floor_arr[$b_id];
								$re_tot_chemicalCost=0; 
								if($extention_no>0)
								{
									$re_batch_weight=$tot_batch_weight;//$batch_description_arr[$b_id]['batch_weight'];
									
									$re_issue_amt_deys=0;$re_issue_amt_chemical=0;$re_tot_dyesCost=0;
									$rebatchIdArr="";
									foreach($ReqIdsArr as $reqId)
									{
										//$issue_qty+=$issue_item_cat_cost_arr[$req_id][$row[csf('item_category_id')]];
										//$issue_qty+=$issue_item_cat_cost_dtls_arr[$reqId][5]+$issue_item_cat_cost_dtls_arr[$reqId][6]+$issue_item_cat_cost_dtls_arr[$reqId][7];
										//$issue_item_cat_amt_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]
										$re_issue_amt_chemical=$re_issue_item_cat_amt_dtls_arr[$reqId][5]+$re_issue_item_cat_amt_dtls_arr[$reqId][7];
										$re_issue_amt_deys=$re_issue_item_cat_amt_dtls_arr[$reqId][6];
										
										 $batch_ids=$re_ReqBatch_id_arr[$reqId]; 
										//$rebatchIdArr.=$batch_ids.',';
										//echo $batch_ids.'DSSSSSSSSS';
										//$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']];
										
										
										$batchIds=rtrim($batch_ids,',');
										$rebatchIdArr=array_unique(explode(",",$batchIds)); 
										$re_tot_batch_wgt=0;
										foreach($rebatchIdArr as $rebatchId)
										{
											//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
												$re_tot_batch_wgt+=$re_batch_wgt_arr[$rebatchId]['batchWgt']; 
												//echo $re_issue_amt_chemical.'='.$re_tot_batch_wgt.'='.$re_batch_weight.'=A<br>';
										}
										if($re_issue_amt_chemical>0)
										{
										$re_tot_chemicalCost+= (($re_issue_amt_chemical/$re_tot_batch_wgt)*$re_batch_weight);
										}
										if($re_issue_amt_deys>0)
										{
											//echo $b_id.'='.($re_issue_amt_deys/$re_tot_batch_wgt)*$batch_weight.'<br>';
										$re_tot_dyesCost+= (($re_issue_amt_deys/$re_tot_batch_wgt)*$re_batch_weight);
										}
										
									}
									
									if($re_tot_chemicalCost)
									{
									//$re_issue_amt_perKg_chemical=($re_issue_amt_chemical/$re_tot_batch_wgt);
									$re_issue_amt_cal_chemical=$re_tot_chemicalCost;
									}
									else 
									{$re_issue_amt_cal_chemical=0;}
									
									if($re_tot_dyesCost)
									{
									//$re_issue_amt_perKg_dyes=($re_issue_amt_deys/$re_tot_batch_wgt);
									$re_issue_amt_cal_dyes=$re_tot_dyesCost;
									}
									else
									{
										$re_issue_amt_cal_dyes=0;
									}
									
									$re_dying_chemical_cost=$re_issue_amt_cal_chemical;//$costDataArr[$re_bid][5]+$costDataArr[$re_bid][7];
				                    $re_dying_dyes_cost=$re_issue_amt_cal_dyes;//$costDataArr[$re_bid][6]	;	
				                    $re_dying_dyes_chemical_cost=$re_dying_chemical_cost+$re_issue_amt_cal_dyes;//$costDataArr[$re_bid][5]+$costDataArr[$re_bid][6]+$costDataArr[$re_bid][7];
								}
				                
				                echo $re_floors;
				                ?></p></td>
				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($re_dying_chemical_cost,4,".",""); 
				                 $tot_re_dying_chemical_cost+=$re_dying_chemical_cost;
				                 ?>
				                 </p></td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_dyes_cost,4,".",""); $tot_re_dying_dyes_cost+=$re_dying_dyes_cost;  ?></p></td>
				                <td width="100" align="right" title="ReqId=<? echo $ReqIds;?>">
								<?
								if($re_dying_dyes_chemical_cost)
								{

								 
								?>
								<A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','1st_chemi_dyes_batch_dtls_popup','<? echo $ReqIds; ?>',2)"><p><? echo number_format($re_dying_dyes_chemical_cost,4,".",""); $tot_re_dying_dyes_chemical_cost+=$re_dying_dyes_chemical_cost; ?></p></A>
								<?
								}
								?>
							</td>
				                 
				                

				                <td width="100" align="right"><? echo fn_number_format($re_dying_dyes_chemical_cost+$batch_chemical_price,4,".",""); ?></td>
				                <td width="100" align="right" title="<? echo '('.$re_dying_dyes_chemical_cost.'+'.$batch_chemical_price.')/'.$tot_batch_weight; ?>"><?
				                 echo fn_number_format(($re_dying_dyes_chemical_cost+$batch_chemical_price)/$tot_batch_weight,4,".","");  ?></td>
				                <td width="" align="center" title="<? echo $b_id; ?>"><? //echo $unload_result_arr[$b_id]//echo  $dyeing_result[$result_id];//
				                //echo $b_id.tipu;
			                    $result_id=$result_arr[$b_id];
			                    if($result_id!="")  $result_id_last=$result_id;
				                echo $dyeing_result[$result_id];//$dyeing_result;//$daysOnHand; ?></td>
				            </tr>
							<? 	
						//	$total_tot_batch_weight+=$tot_batch_weight;											
							$i++; 			
						
					}
					?>
	            </tbody>
	      	</table>
      	</div>
       	<table width="2880" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="80">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                     <th width="80">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                  
                    <th width="100">&nbsp;</th>
                    <th width="100"><? //echo number_format($total_batch_chemical_price,4).'='.$total_dyes_cost; ?></th>
                	<th width="100">Total</th>
                    <th width="100"  title="<? echo $sub_buyer_grnd_tot_batchQty.'='.$total_tot_batch_weight;?>">
					<? echo number_format($total_batch_weight-$sub_buyer_grnd_tot_batchQty,4); ?></th>
                	<th width="100" id="value_total_chemical_cost_single"><? echo number_format($total_chemical_cost,4); ?></th>
                	<th width="100" id="value_total_dyeing_cost_single"><? echo number_format($total_dyes_cost,4); ?></th>
                    <th width="100" id="value_total_chemical_price_single"><? echo number_format($total_batch_chemical_price,4); ?></th>
                    <th width="100" id=""><? echo number_format(($total_batch_chemical_price)/$total_batch_weight,4); ?></th>
                    <th width="100"><? //echo number_format($tot_re_dying_chemical_cost,3); ?></th>
                    <th width="70"><? //echo number_format($tot_rec_return,3); ?></th>
                    <th width="100"><? //echo number_format($tot_total_issue,3); ?></th>
                    <th width="100" id="value_total_redying_chemic_oost_single"><? echo number_format($tot_re_dying_chemical_cost,4); ?></th>
                    <th width="100" id="value_total_redying_dying_cost_single"><p><? echo number_format($tot_re_dying_dyes_cost,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single"><p><? echo number_format($tot_re_dying_dyes_chemical_cost,4); ?></p></th>
                    <!--<th width="100" id=""><? //echo number_format($tot_re_dying_dyes_chemical_cost/$total_batch_weight,4); ?></th>-->
                    <th width="100" id="value_total_total_cost_single"><? echo number_format($total_batch_chemical_price+$tot_re_dying_dyes_chemical_cost,4); ?></th>
                    <th width="100" id="" title="Main Batch Qty=<? echo number_format($tot_main_batch_weight,2);?>"><? echo number_format(($total_batch_chemical_price+$tot_re_dying_dyes_chemical_cost)/$total_batch_weight,4); ?></th>
                    <th width="">&nbsp;</th>
                </tr>
            </tfoot>
        </table>
    </div>
    <?
    $html = ob_get_contents();
    ob_clean();
    //$new_link=create_delete_report_file( $html, 2, $delete, "../../../" );
    foreach (glob("*.xls") as $filename) {
    //if( @filemtime($filename) < (time()-$seconds_old) )
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');	
    $is_created = fwrite($create_new_doc, $html);


    $filename2=$user_id."_summary_".$name.".xls";
    $create_new_doc2 = fopen($filename2, 'w');	
    $is_created2 = fwrite($create_new_doc2, $summaryHTML);

    echo "$html****$filename****$filename2****$report_type"; 
    exit();
}

if($action=="generate_report6_bk_14-6-23") // Batch  Wise2 
{ 
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if ($cbo_company_name==0) $company_id=""; else $company_id=" and a.company_id='$cbo_company_name'";
	if ($cbo_company_name==0) $company_idcond =""; else $company_idcond =" and b.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond .=""; else $company_idcond .=" and b.working_company_id='$cbo_working_name'";
	//echo $cbo_company_name.'='.$cbo_working_name;die;
	if ($cbo_company_name==0 && $cbo_working_name==0) 
	{
	$w_company_idcond ="";$w_company_idcond2="";$w_company_idcond3="";$w_company_idcond4="";
	}
	 else  {
		 if ($cbo_company_name==0 && $cbo_working_name>0)
		 {
		  	$w_company_idcond =" and c.company_id='$cbo_working_name'";
			$w_company_idcond2 =" and b.knit_dye_company='$cbo_working_name'";
			$w_company_idcond3 =" and b.working_company_id='$cbo_working_name'";
			$w_company_idcond4 =" and a.service_company='$cbo_working_name'";
		 }
		 else  if ($cbo_company_name>0 && $cbo_working_name==0)
		 {
		  $w_company_idcond =" and c.company_id='$cbo_company_name'";
		  $w_company_idcond2 =" and b.knit_dye_company='$cbo_company_name'";
		  $w_company_idcond4 =" and a.company_id='$cbo_company_name'";
		  $w_company_idcond3 ="and b.company_id='$cbo_company_name'";
		 }
	 }
	 // echo  $w_company_idcond.'dd'.$company_idcond;die;
	
	$from_date=str_replace("'","",$from_date);
	$to_date=str_replace("'","",$to_date);
	//echo $from_date;
	$txt_ref_no=str_replace("'","",$txt_ref_no); 
	$txt_file_no=str_replace("'","",$txt_file_no);
	$txt_booking_no=str_replace("'","",$txt_booking_no);
	$txt_po_no=str_replace("'","",$txt_po_no);
	$txt_job=str_replace("'","",$txt_job);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$cbo_season_id=str_replace("'","",$cbo_season_id);
	$txt_samp_ref_no=str_replace("'","",$txt_samp_ref_no);
	$location_id=str_replace("'","",$location_id);
	$floor_id=str_replace("'","",$floor_id);
	$report_type=str_replace("'","",$report_type);
	$cbo_year=str_replace("'","",$cbo_year_selection);

	
	
	if(str_replace("'","",$cbo_buyer_name)==0)
	{
		if ($_SESSION['logic_erp']["data_level_secured"]==1)
		{
			if($_SESSION['logic_erp']["buyer_id"]!="") $buyer_id_cond=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")"; else $buyer_id_cond="";
		}
		else
		{
			$buyer_id_cond="";
		}
	}
	else
	{
		$buyer_id_cond=" and a.buyer_name in (".str_replace("'","",$cbo_buyer_name).")";
	}
	
	if($txt_booking_no!='') $booking_no_cond="and b.booking_no like '%$txt_booking_no%' ";else $booking_no_cond="";
	if($db_type==0)
		{
			$year_cond=" and SUBSTRING_INDEX(a.insert_date, '-', 1)=$cbo_year";
		}
		else if($db_type==2)
		{
			$year_cond=" and to_char(a.insert_date,'YYYY')=$cbo_year";
		}
		
	if($txt_file_no!='') $file_cond="and b.file_no='$txt_file_no'";else $file_cond="";
	if($txt_job!='') $job_cond="and a.job_no_prefix_num=$txt_job  $year_cond";else $job_cond="";
	if($txt_po_no!='') $po_cond="and b.po_number='$txt_po_no'";else $po_cond="";
	
	if($cbo_season_id!=0) $season_cond="and a.season_buyer_wise in($cbo_season_id)";else $season_cond="";
	
	if($txt_ref_no!='') $ref_cond="and b.grouping='$txt_ref_no'";else $ref_cond="";
	if($txt_samp_ref_no!='') $samp_ref_cond="and a.grouping='$txt_samp_ref_no'";else $samp_ref_cond="";
	//echo $ref_cond;
	$companyArr = return_library_array("SELECT id,company_name from lib_company where status_active=1 and is_deleted=0","id","company_name"); 
	$supplierArr = return_library_array("SELECT id,supplier_name from lib_supplier where status_active=1 and is_deleted=0","id","supplier_name"); 
	$color_arr=return_library_array( "SELECT id,color_name  from  lib_color", "id", "color_name"  );
	$buyer_arr=return_library_array( "SELECT id,buyer_name  from  lib_buyer", "id", "buyer_name"  );
	$season_name_arr=return_library_array( "SELECT id,season_name  from  lib_buyer_season", "id", "season_name"  );
	
	if($db_type==0) 
	{
	$from_date=change_date_format($from_date,'yyyy-mm-dd'); $to_date=change_date_format($to_date,'yyyy-mm-dd');
	}
    if($db_type==2) 
	{
	$from_date=change_date_format($from_date,'','',1);  $to_date=change_date_format($to_date,'','',1);
	}
	//echo $from_date;
	
	
	$batch_description_arr=array();
	/* 
	if(str_replace("'","",$batch_id)!="") $batch_cond=" and b.id in(".str_replace("'","",$batch_id).")";
    else  */
	
	
	//echo $batch_cond; //die;
	//echo $batch_no; //die;
    	//echo $batch_no;
	$batch_no=implode("','",array_unique(explode(",",$batch_no)));
	
	if(str_replace("'","",$batch_no)!="") $batch_cond=" and b.batch_no in('".$batch_no."') "; 
	else $batch_cond="";
	//echo $batch_cond."shakil"; die;
	
	//
	/* and b.re_dyeing_from=0 13-11-16 according to siddique sir dicission when search buyer order or subcontract all batch appear */
	if($batch_type==0)
	$search_field_cond_batch="";
	else if($batch_type==1)
	$search_field_cond_batch="and b.entry_form=0 ";
	else if($batch_type==2)
	$search_field_cond_batch="and b.entry_form=36";
	else if($batch_type==4)
	$search_field_cond_batch="and b.entry_form=136";
	else if($batch_type==5)
	$search_field_cond_batch="and b.batch_against=3";// sample
	else 
	$search_field_cond_batch="and b.entry_form in(0,36) and b.batch_against in(2) and  b.re_dyeing_from!=0 ";
 //echo $search_field_cond_batch.'D';die;
	
	if($txt_file_no!='' || $txt_ref_no!='' ||  $txt_po_no!='' || $txt_job!='' || $cbo_buyer_name>0)
	{
		
		if($batch_type==4) //Trim batch
		{
		 $sql_po="SELECT c.id as batch_id,a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b,pro_batch_create_mst c where a.id=b.job_id and b.job_no_mst=c.job_no  and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond";
		}
		else
		{
			$sql_po="SELECT a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b  where a.id=b.job_id and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond";
		}
		// echo $sql_po;die; 
		$res_po=sql_select($sql_po);
		$all_po_id='';
		foreach($res_po as $row) //$job_no_arr
		{			
			if($all_po_id=="") $all_po_id=$row[csf('id')]; else $all_po_id.=",".$row[csf('id')]; //echo $all_po_id;
			
			$trim_batch_idArr[$row[csf('batch_id')]]=$row[csf('batch_id')];
		}
		//echo $all_po_id;
		
		//
		

		if($all_po_id!="") $po_idd="and po_id in($all_po_id)";else $po_idd="and po_id in(0)";
		
		$poIds=chop($all_po_id,','); $po_cond_for_in="";
		$po_ids=count(array_unique(explode(",",$all_po_id)));
		if($db_type==2 && $po_ids>1000)
		{
			$po_cond_for_in=" and (";
			$poIdsArr=array_chunk(explode(",",$poIds),999);
			foreach($poIdsArr as $ids)
			{
				$ids=implode(",",$ids);
				$po_cond_for_in.=" po_id in($ids) or"; 
			}
			$po_cond_for_in=chop($po_cond_for_in,'or ');
			$po_cond_for_in.=")";
		}
		else
		{
			$po_cond_for_in=" and po_id in($poIds)";
			
		}
		
		if($batch_type==4) //Trim batch
		{
		 	$po_cond_for_in='';
			$po_cond_for_in=where_con_using_array($trim_batch_idArr,0,"mst_id");
			//echo "SELECT mst_id as batch_id from pro_batch_trims_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in";die;
			$sql_batch=sql_select("SELECT mst_id as batch_id from pro_batch_trims_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in");
		}
		else
		{
			$sql_batch=sql_select("SELECT mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in");
		}
		//echo "SELECT mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in";die();
		 $all_batch_id='';
		foreach($sql_batch as $row) 
		{
			if($all_batch_id=="") $all_batch_id=$row[csf('batch_id')]; else $all_batch_id.=",".$row[csf('batch_id')];
		}
			$all_batch_ids=implode(",",array_unique(explode(",",$all_batch_id)));
		//echo $all_batch_ids; 
		$batch_ids_cond="";
		if($all_batch_ids!="") 
		{
			//echo $po_id=substr($po_id,0,-1);
			if($db_type==0) { $batch_ids_cond="and b.id in(".$all_batch_ids.")"; }
			else
			{
				$bat_id=array_unique(explode(",",$all_batch_ids));
				if(count($bat_id)>1000)
				{
					$batch_ids_cond="and (";
					$bat_id=array_chunk($bat_id,1000);
					$z=0;
					foreach($bat_id as $id)
					{
						$id=implode(",",$id);
						if($z==0) $batch_ids_cond.=" b.id in(".$id.")";
						else $batch_ids_cond.=" or b.id in(".$id.")";
						$z++;
					}
					$batch_ids_cond.=")";
				}
				else { 
				
				$batch_ids_cond=" and b.id in(".$all_batch_ids.")"; }
			}
		}
	}
	// print_r($batch_ids_cond);die;
	if($from_date!="" && $to_date!="")
	{
		$date_cond_samp="";
		if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond_samp=" and b.batch_date between '".$from_date."' and '".$to_date."'";
		}
	}


	/* ================================================================================ /
	/								Main query start here								/
	/ ================================================================================ */
	$samp_non_booking=sql_select("SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $w_company_idcond3 $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
	/*echo "SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $w_company_idcond3 $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";die; */
	 

	// echo "SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";die; 
	$all_batch_id_samp="";
	foreach($samp_non_booking as $row)
	{
		$non_buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$non_buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$sample_booking_ref_no_arr[$row[csf('booking_no')]]=$row[csf('grouping')];
		if($txt_samp_ref_no!='')
		{
		if($all_batch_id_samp=="") $all_batch_id_samp=$row[csf('batch_id')]; else $all_batch_id_samp.=",".$row[csf('batch_id')];
		}
	}
	if($all_batch_id_samp!="") $all_batch_id_samp_cond="and b.id in($all_batch_id_samp)";else $all_batch_id_samp_cond="";
	//echo $all_batch_id_samp_cond.'X';
	
    if($from_date!="")
    {
		if(str_replace("'","",$cbo_value_with)==1)
		{
			$date_cond=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";
		//and b.batch_against in(1,2,3)
			$sql=sql_select("SELECT b.id,b.sales_order_id,a.batch_no,a.fabric_type,b.booking_without_order,b.job_no,b.extention_no,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
			and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0  $w_company_idcond4 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
			
			 
			 /* echo "SELECT b.id,a.batch_no,a.fabric_type,b.booking_without_order,b.job_no,b.extention_no,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
			and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond";die; */
		}
		else if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond=" and b.batch_date between '".$from_date."' and '".$to_date."'";
			$sql=sql_select("SELECT b.id,b.sales_order_id,b.batch_no,b.booking_without_order,b.job_no,b.extention_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
			from  pro_batch_create_mst b where   b.status_active=1 and b.is_deleted=0  $w_company_idcond4 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
			
		}
   	}
   	else
   	{
		 
		 
		$sql=sql_select("SELECT b.id,b.sales_order_id,b.booking_without_order,b.job_no,b.extention_no,b.batch_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
		from  pro_batch_create_mst b where  b.status_active=1 and b.is_deleted=0 $w_company_idcond3 $batch_cond $batch_ids_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond");
		
		//w_company_idcond
		
	}
	 
	if(count($sql)==0)
    {
        ?>
        <div style="font-size:20px;color:red;text-align:center">Data not found!</div>
        <?
        die;
    }
  	//  echo $sql;die;
	//die;
  	// print_r($sql);die();
  	$reding_batch_id=$non_reding_batch_id=$trim_batch_IdArr=array();
    foreach($sql as $row)
	{
		 if($row[csf("entry_form")]=='136') 
		  {
				$trim_batch_IdArr[$row[csf("id")]]=$row[csf("id")]; 
		  }	
		$batch_against_id=$row[csf("batch_against")];
		$batch_id_arr[]=$row[csf("id")];
		$batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
		if($row[csf("sales_order_id")]!='')
		{
		$sales_batch_arr[$row[csf("id")]]=$row[csf("sales_order_id")];
		$sales_id_arr[$row[csf("sales_order_id")]]=$row[csf("sales_order_id")];
		}
		
		$issue_single_batch_arr[$row[csf("id")]]=$row[csf("id")];  
		if($batch_against_id==1 || $batch_against_id==3)
		{		
			  
			// $batch_id_arr[]=$row[csf("id")]; 
			$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
			$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
			$batch_description_arr[$row[csf("id")]]['batch_weight']+=$row[csf("batch_weight")];
			$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
			$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_description_arr[$row[csf("id")]]['job_no']=$row[csf("job_no")];
			
			$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
			$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
			$batch_no_arr[]="'".$row[csf("batch_no")]."'";
			// $batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
			
			$batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			$batch_wise_arr[$row[csf("batch_no")]]['batch_no']=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['extention_no'].=$row[csf("extention_no")].',';
			$batch_ext_wise_arr[$row[csf("id")]]['extention_no']=$row[csf("extention_no")];
			
		}
		if($batch_against_id==2)
		{
			$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
			$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
			$batch_description_arr[$row[csf("id")]]['batch_weight']+=$row[csf("batch_weight")];
			$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
			$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_description_arr[$row[csf("id")]]['job_no']=$row[csf("job_no")];
			
			$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
			$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
			$batch_no_arr[]="'".$row[csf("batch_no")]."'";
			// $batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
			
			$batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			$batch_wise_arr[$row[csf("batch_no")]]['batch_no']=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['extention_no'].=$row[csf("extention_no")].',';
			$batch_ext_wise_arr[$row[csf("id")]]['extention_no']=$row[csf("extention_no")];
			$batch_ext_wise_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			
			
			
			$re_batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			
		}
		if($row[csf("batch_against")]==2)
		{
			/*if($row[csf("re_dyeing_from")]>0)
			{
				$reding_batch_id[$row[csf("re_dyeing_from")]]=$row[csf("re_dyeing_from")]; 
			}
			else
			{
				$reding_batch_id[$row[csf("id")]]=$row[csf("id")]; 
			}*/
			$reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
		else
		{
			$non_reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
	}
	 
	// echo "<pre>"; print_r($batch_wise_arr); die();



	//	********************************************************************************************************************************
     $batch_id_sql=implode(",",$batch_id_arr);
    if($batch_id_sql=="") $batch_id_sql=0;
	//echo  $batch_id_sql;
  	if($batch_type==3)
	{
		//$re_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond2=chop($re_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond2.=")";
		}
	}
	else
	{
		//$re_dying_cond=" and b.re_dyeing_from in(".$batch_id_sql.")";	
		//$pord_ids = explode(",",$txt_product_id);
		//echo count($pord_ids);die;
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond=chop($re_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond.=")";
		}
	}

	$date_cond2=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";

	// =============================================================
	$batch_all_id_array=array();
	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
	  $sql = "SELECT a.ID,b.mst_id as REQ_ID,a.batch_id as BATCH_ID,a.BATCH_QTY,a.BATCH_QTY,a.NEW_BATCH_WEIGHT,a.ENTRY_FORM,c.batch_id as RE_BATCH_ID from pro_recipe_entry_mst a, dyes_chem_requ_recipe_att b,dyes_chem_issue_requ_mst c where b.recipe_id=a.id  and c.id=b.mst_id $batch_id_conds and a.status_active=1 and a.is_deleted=0 and b.status_active=1 ";
	 // echo $sql;die; 
	$res = sql_select($sql);
	$req_id_array = array();
	foreach ($res as $val) 
	{
		//$req_id_array2[$val['REQ_ID']] .= $val['REQ_ID'].',';
		$req_id_array[$val['REQ_ID']] = $val['REQ_ID'];
		//$batch_req_id_array[$val['BATCH_ID']].= $val['REQ_ID'].',';
		$batch_req_id_array2[$val['BATCH_ID']]= $val['REQ_ID'];
		$batch_all_id_array[$val['BATCH_ID']]= $val['BATCH_ID'];
		//if($batchWgtChkk[$val['REQ_ID']]=='')
		//{
			if($val['ENTRY_FORM']==60) //Adding Topping
			{
				$batch_wgt=$val['NEW_BATCH_WEIGHT'];
			}
			else
			{
				$batch_wgt=$val['BATCH_QTY'];
			}
		//$batch_wgt_array[$val['REQ_ID']] += $batch_wgt;
		$batch_wgt_array[$val['BATCH_ID']] = $batch_wgt;
		$batchWgtChkk[$val['REQ_ID']].=$val['BATCH_ID'].',';
		
		$batchIdChkkDtls[$val['REQ_ID']]=$val['BATCH_ID'];
		//}
		
	}
	unset($res);
	// print_r($req_id_array2);die;
	// $requisition_ids = implode(",", $req_id_array);
	
	
	if(count($req_id_array))
	{
		$requisition_id_cond=where_con_using_array($req_id_array,0,"a.requisition_no");
	}

	$issue_sql = sql_select("SELECT a.MST_ID ,a.REQUISITION_NO,b.BATCH_NO,a.ITEM_CATEGORY,a.PROD_ID,a.CONS_QUANTITY,a.CONS_AMOUNT from inv_transaction a,inv_issue_master b where a.mst_id=b.id and b.entry_form=5 and b.is_deleted=0 and b.status_active=1 and a.status_active=1 and a.transaction_type=2 $requisition_id_cond   ");//$w_company_idcond2
	    //echo "SELECT a.MST_ID ,a.REQUISITION_NO,b.BATCH_NO,a.ITEM_CATEGORY,a.PROD_ID,a.CONS_QUANTITY,a.CONS_AMOUNT from inv_transaction a,inv_issue_master b where a.mst_id=b.id and b.entry_form=5 and b.is_deleted=0 and b.status_active=1 and a.status_active=1 and a.transaction_type=2 $requisition_id_cond  $w_company_idcond2 ";
	 
	$issue_id_arr = array();$tot_issueQty=0;  

	foreach ($issue_sql as $val) 
	{
		 
		$batchArr=array_filter(array_unique(explode(",",$val['BATCH_NO'])));
		foreach($batchArr as $bid)
		{
			$issue_item_cat_arr[$bid][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['ITEM_CATEGORY'];
			if($bid!='')
			{
			$batch_all_id_array[$bid]= $bid;
			$batch_req_id_array[$bid].= $val['REQUISITION_NO'].',';
			}
		}
			$issue_item_cat_cost_arr[$val['REQUISITION_NO']][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['CONS_QUANTITY'];
			$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_QUANTITY'];
			
			$issue_item_cat_amt_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_AMOUNT'];
		
		 $ReqBatch_id_arr[$val['REQUISITION_NO']] = $val['BATCH_NO'];
		$issue_id_arr[$val['MST_ID']] = $val['MST_ID'];
		$tot_issueQty+=$val['CONS_QUANTITY'];
		
	}
	// echo count($batch_all_id_array);die;
	if(count($batch_all_id_array))
	{
		$batch_ids_cond=where_con_using_array($batch_all_id_array,0,"b.id");
	}
	
	$batch_fabric_sql=sql_select("SELECT b.id,b.batch_no,b.batch_weight, b.batch_against
	from pro_recipe_entry_mst  a,pro_batch_create_mst b  where  a.batch_id=b.id 
	 and a.status_active=1 and a.is_deleted=0 $batch_ids_cond group by  b.id,b.batch_no,b.batch_weight, b.batch_against" );
	/* echo "SELECT b.id,b.batch_no,b.batch_weight, b.batch_against
	from pro_recipe_entry_mst  a,pro_batch_create_mst b  where  a.batch_id=b.id 
	 and a.status_active=1 and a.is_deleted=0 $batch_ids_cond group by  b.id,b.batch_no,b.batch_weight, b.batch_against";die;*/
	 foreach ($batch_fabric_sql as $row) 
	{
		//$batch_req_id=$batch_req_id_array2[$row[csf("id")]];
		//echo $batch_req_id.'d';
		$batch_wgt_arr[$row[csf("id")]]['batchWgt']=$row[csf("batch_weight")];
	}
	//========+++++=Re Calculation++++++++++++========
	//$issue_single_batch_arr  
	/*$tot_amt=0;
	foreach ($issue_sql as $val) 
	{
		$batchIdReq=array_unique(explode(',',$batchIdChkkDtls[$val['REQUISITION_NO']]));
		$batch_wgt_cal=0;
		foreach($batchIdReq as $Batchid)
		{
			$batch_wgt_cal+=$batch_wgt_arr[$Batchid]['batchWgt'];
		}
		$issue_item_cat_amt_dtls_arr2[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_AMOUNT']/$batch_wgt_cal;
		$tot_amt+=$val['CONS_AMOUNT'];
	}*/
	//echo $tot_amt.'T';
	 
	 
	//echo $tot_issueQty.'D';
	// echo "<pre>";print_r($batch_req_id_array);die;
	// =====================================================================================
	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "b.id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "b.id", $re_dying_cond);
	$fabric_sql=sql_select("SELECT b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
	from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
	and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 $company_idcond $batch_id_conds");
	 	
  	$fabric_type_arr=array();
    foreach($fabric_sql as $row)
	{
	 	$fabric_type_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
	}
	//=========****============Fab Sales Order=========================
	//sales_order_id
	//$sales_id_arr
	if(count($sales_id_arr))
	{
		$sales_order_id_cond=where_con_using_array($sales_id_arr,0,"c.id");
	}
	
	$sales_fabric_sql=sql_select("SELECT c.id as sales_id,c.buyer_id,b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
	from pro_fab_subprocess  a,pro_batch_create_mst b,fabric_sales_order_mst c  where  a.batch_id=b.id 
	and c.id=sales_order_id and a.entry_form in (35) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $company_idcond $sales_order_id_cond");
	 
	 	
  	$fabric_type_arr=array();
    foreach($sales_fabric_sql as $row)
	{
	 	$fabric_sales_arr[$row[csf("sales_id")]]['buyer_id']=$row[csf("buyer_id")];
		//$sales_batch_arr[$row[csf("id")]]=$row[csf("sales_order_id")];
	}
	unset($sales_fabric_sql);

	// ========================================================================================

	$floor_cond_arr=array();
	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
	//echo $location_id.'-0998';die; 
	if(!empty($location_id))
	{
		if(!empty($floor_id))
		{
			$sql="SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0 and b.company_id=$cbo_working_name and b.location_id=$location_id and b.production_process=3 and b.id=$floor_id $batch_id_conds";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) 
			{
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		else
		{
			 $sql="SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0  and b.location_id=$location_id and b.production_process=3 $batch_id_conds";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) {
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		$floor_cond_arr=array_unique($floor_cond_arr);
	}
	 // print_r($floor_cond_arr);die();

	// ==========================================================================

	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
    $floor_arr=return_library_array("SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0 $batch_id_conds", "batch_id", "floor_name" );

	$machine_name_arr=return_library_array("SELECT  a.batch_id ,b.machine_no from   pro_fab_subprocess a, lib_machine_name b  where a.machine_id=b.id and a.entry_form in(38,35) and  b.status_active=1 and b.is_deleted=0 $batch_id_conds ", "batch_id", "machine_no" );

	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "c.id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "c.id", $re_dying_cond);
	$sql_book=sql_select("SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c where a.buyer_id=b.id and a.id=c.booking_no_id $batch_id_conds");
	//echo "SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c where a.buyer_id=b.id and a.id=c.booking_no_id $batch_id_conds";die;
	//echo "SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c where a.buyer_id=b.id and a.id=c.booking_no_id $batch_id_conds";die;
	$po_id_arr = array();
	foreach($sql_book as $row)
	{
		$buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		
		if($row[csf('po_break_down_id')])
		{
		$po_id_arr[$row[csf('po_break_down_id')]]=$row[csf('po_break_down_id')];
		$po_break_down_id_arr[$row[csf('booking_no')]]=$row[csf('po_break_down_id')];
		}
	}

	// =========================================================
	// $poIdss = implode(",", $po_id_arr);
	if(count($po_id_arr))
	{
		$po_id_cond = where_con_using_array($po_id_arr,0,"b.id");
	}
	if(count($trim_batch_IdArr))
	{
		$trim_batchId_cond = where_con_using_array($trim_batch_IdArr,0,"c.id");
	}

	/*if($db_type==2 && count($po_id_arr)>1000)
	{
		$poIdCond=" and (";
		$poIdsArr=array_chunk($po_id_arr,999);
		foreach($poIdsArr as $ids)
		{
			$ids=implode(",",$ids);
			$poIdCond.=" b.id in($ids) or"; 
		}
		$poIdCond=chop($poIdCond,'or ');
		$poIdCond.=")";
	}
	else
	{
		$poIdCond=" and b.id in($poIdss)";
		
	}*/

	// echo $poIdCond;die();
	$sql_po="SELECT a.style_ref_no,a.buyer_name,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b  where a.id=b.job_id and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond $po_id_cond";
	// echo $sql_po;die(); 
	$res_po=sql_select($sql_po);
	$all_po_id='';
	foreach($res_po as $row) //$job_no_arr
	{
		$po_number_arr[$row[csf('id')]]['po_no']=$row[csf('po_number')];
		$po_number_arr[$row[csf('id')]]['ref_no']=$row[csf('ref_no')];
		$po_number_arr[$row[csf('id')]]['file_no']=$row[csf('file_no')]; 
		$po_number_arr[$row[csf('id')]]['season']=$row[csf('season_buyer_wise')]; 
		$po_number_arr[$row[csf('id')]]['job']=$row[csf('job_no_mst')];
		
		$job_no_arr[$row[csf('id')]]=$row[csf('job_no_mst')];
		$style_library[$row[csf('job_no_mst')]]=$row[csf('style_ref_no')];
		
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['buyer']=$row[csf('buyer_name')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['season']=$row[csf('season_buyer_wise')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['style']=$row[csf('style_ref_no')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['po_number'].=$row[csf('po_number')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['ref_no'].=$row[csf('ref_no')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['file_no'].=$row[csf('file_no')].',';
	}
	unset($res_po);
 $sql_trim_job="SELECT a.style_ref_no,a.buyer_name,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b,pro_batch_create_mst c  where a.id=b.job_id and a.job_no=c.job_no and b.job_no_mst=c.job_no and   b.status_active=1 and b.is_deleted=0  and   c.status_active=1 and c.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond   $buyer_id_cond $trim_batchId_cond";
	// echo $sql_po;die(); 
	$res_trimJob=sql_select($sql_trim_job);
	 
	foreach($res_trimJob as $row) //$job_no_arr
	{
		
		//$job_no_arr[$row[csf('id')]]=$row[csf('job_no_mst')];
		$style_library[$row[csf('job_no_mst')]]=$row[csf('style_ref_no')];
		
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['buyer']=$row[csf('buyer_name')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['season']=$row[csf('season_buyer_wise')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['style']=$row[csf('style_ref_no')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['po_number'].=$row[csf('po_number')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['ref_no'].=$row[csf('ref_no')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['file_no'].=$row[csf('file_no')].',';
	}
	unset($res_trimJob);

	
    $buyer_library=return_library_array( "SELECT id,buyer_name from   lib_buyer", "id","buyer_name" );
   // $style_library=return_library_array( "SELECT job_no,style_ref_no from   wo_po_details_master", "job_no","style_ref_no" );


    $batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.mst_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.mst_id", $re_dying_cond);
	$po_data_subcon=sql_select("SELECT a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0  $batch_id_conds");
	
	$sub_con_arr=array();$sub_party_arr=array(426,439,444,458,425,427,428,443,392,564,565,563); //Omit buyer ids
	foreach($po_data_subcon as $row)
	{
		if($sub_con_arr[$row[csf('mst_id')]][cust_style_ref]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref].=",".$row[csf('cust_style_ref')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref]=$row[csf('cust_style_ref')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][order_no]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no].=",".$row[csf('order_no')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no]=$row[csf('order_no')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][subcon_job]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job].=",".$row[csf('subcon_job')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job]=$row[csf('subcon_job')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][party_id]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id].=",".$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id].=",".$row[csf('party_id')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id]=$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id]=$row[csf('party_id')];	
		}
		$party_id=$row[csf('party_id')];
		if(in_array($party_id,$sub_party_arr) && $row[csf("party_id")]>0)
		{
			$sub_batch_chk_arr[$row[csf("mst_id")]]=$row[csf("party_id")];
		}
	}
	//print_r($sub_con_arr[646]);die;
	// ==================================================================================

	if($db_type==0)
	{
		if($batch_type==3)
		{
		 $sql_redying=sql_select("SELECT b.id as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0 group by  b.id");
		}
		else
		{
			 $sql_redying=sql_select("SELECT group_concat(b.id) as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0  $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0 group by  b.re_dyeing_from");	
		}
	}
	else
	{
	
		if($batch_type==3)
		{	
			 $sql_redying=sql_select("SELECT b.id as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no
			  from  pro_batch_create_mst  b 
			  where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0  group by  b.id");
		}
		else
		{
			 $sql_redying=sql_select("SELECT listagg((b.id),',') within group (order by b.id) as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no,b.re_dyeing_from 
			 from  pro_batch_create_mst b 
			 where b.re_dyeing_from!=0   $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0  group by  b.re_dyeing_from");
			// echo "select listagg((b.id),',') within group (order by b.id) as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no,b.re_dyeing_from 
			// from  pro_batch_create_mst b 
			// where b.re_dyeing_from!=0   $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0  group by  b.re_dyeing_from";
		}
	}
	
   	//and b.batch_against=2
    $redying_details_arr=array();
    foreach($sql_redying as $re_row)
    {
		if($batch_type==3)
		{
			$redying_details_arr[$re_row[csf("id")]]['id']=$re_row[csf("id")];
			$redying_details_arr[$re_row[csf("id")]]['batch_date']=$re_row[csf("batch_date")];
			$redying_details_arr[$re_row[csf("id")]]['extention_no']=$re_row[csf("extention_no")];
		}
		else
		{
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['id']=$re_row[csf("id")];
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['batch_date']=$re_row[csf("batch_date")];
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['extention_no']=$re_row[csf("extention_no")];
		}
    }
	
	//echo "<pre>"; print_r($redying_details_arr);die;
	if($batch_type==3)
	{
		//$all_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$all_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$all_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$all_dying_cond2=chop($all_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$all_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$all_dying_cond2.=")";
		}
	}
	else
	{
		if(count($batch_id_arr)>0)
		{
			$all_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$all_dying_cond.=" b.id in(".implode(",",$batch_id).") or";
				}
				$all_dying_cond=chop($all_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$all_dying_cond.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$all_dying_cond.=")";
		}
	}
	
	if($batch_type==3)
	{
		$result_sql=sql_select("SELECT a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2   $company_idcond $all_dying_cond2 and a.status_active=1 and a.is_deleted=0");	
	}
	else
	{
		$result_sql=sql_select("SELECT a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2  $company_idcond $all_dying_cond and a.status_active=1 and a.is_deleted=0");
	}
	
	/*$sql_result=sql_select("select a.result,a.batch_id from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2  and a.company_id=$cbo_company_name and b.re_dyeing_from in (".$batch_id_sql.") and a.status_active=1 and a.is_deleted=0");*/
	
	$result_arr=array();
	foreach($result_sql as $value)
	{
		$result_arr[$value[csf('batch_id')]]=$value[csf('result')];	
	}

	

	
	// print_r($issue_single_batch_arr); echo "Test";die;
	
	// ====================================== batch wise cost =====================================
	$batchIdArr = array();
	foreach(array_unique($issue_single_batch_arr) as $b_id)
	{
		$batchIdArr[$b_id] = $b_id;
	}
	// echo "<pre>";print_r($batchIdArr);
	/*$batch_id_list_arr=array_chunk($batchIdArr,999);

    $batchCond = " and ";
    $p=1;
    foreach($batch_id_list_arr as $po_process)
    {
        if($p==1) $batchCond .="  ( c.id in(".implode(',',$po_process).")"; 
        else  $batchCond .=" or c.id in(".implode(',',$po_process).")";        
        
        $p++;
    }
    $batchCond .=")";*/
	$batchCond=where_con_using_array($batchIdArr,0,"c.id");

	// print_r($batchIdArr);die();
	// echo $company_id;die();
	$company_cond = str_replace("a.company_id", "c.company_id", $company_id);	
	if ($cbo_working_name==0) $wo_company_idcond =""; else $wo_company_idcond =" and p.working_company_id='$cbo_working_name'";

	// $batchCond = implode(",", $batchIdArr);
	   $sql = "(SELECT p.id as recipe_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,a.avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, a.id, a.item_category_id, a.item_group_id, a.sub_group_name, a.item_description, a.item_size,a.current_stock, a.unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
		from pro_recipe_entry_mst p, product_details_master a, pro_recipe_entry_dtls b,pro_batch_create_mst c  
		where p.id=b.mst_id and a.id=b.prod_id and p.batch_id=c.id and b.ratio>0  and b.status_active=1 and b.is_deleted=0 $company_cond $wo_company_idcond and a.item_category_id in(5,6,7,23) and a.status_active=1 and a.is_deleted=0 $batchCond and p.entry_form in(59,60)) 
		union 
		(
		SELECT p.id as recipe_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,0 as avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, b.prod_id as id, null as item_category_id, null as item_group_id, null as sub_group_name, null as item_description, null as item_size,null as current_stock, null as unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
			from pro_recipe_entry_mst p, pro_recipe_entry_dtls b,pro_batch_create_mst c  
			where p.id=b.mst_id and p.batch_id=c.id and b.status_active=1 and b.is_deleted=0 $wo_company_idcond  and b.status_active=1 and b.is_deleted=0 and b.prod_id=0 and b.sub_process_id in(93,94,95,96,97,98) and p.status_active=1 and p.is_deleted=0 $batchCond and p.entry_form in(59,60))  order by sub_seq,seq_no";
	// echo $sql;//die();
	$costDataArr = array();
	$res = sql_select($sql);
	$tot_recCost=0;$tot_issue_qty=0;
	foreach ($res as $row) 
	{
		$current_stock = $row[csf('current_stock')];
		$recipe_type = $row[csf('recipe_type')];
		$surplus_solution = $row[csf('surplus_solution')];
		$pickup = $row[csf('pickup')];
		$batch_wgt = $row[csf('batch_qty')];//pickup,p.batch_qty
		$current_stock_check=number_format($current_stock,7,'.','');
		//(Batch weight*Pick Up/100)+Surplus Solution;
		$total_solution=($batch_wgt*$pickup/100)+$surplus_solution;
		
		$ratio = $row[csf('ratio')];
		if ($row[csf('dose_base')] == 1) 
		{
			if ($row[csf('entry_form')] == 60) 
			{ 
				$perc_calculate_qnty = $row[csf('total_liquor_dtls')];

			} 
			else 
			{
				$perc_calculate_qnty = $row[csf('total_liquor_dtls')];
			}

			if($recipe_type==2) //CBP
			{
				$recipe_qnty = ($total_solution * $ratio) / 1000;
			}
			else
			{
				$recipe_qnty = ($perc_calculate_qnty * $ratio) / 1000;
			}
		} 
		else if ($row[csf('dose_base')] == 2) 
		{
			if ($row[csf('entry_form')] == 60) 
			{
				$perc_calculate_qnty = $row[csf('new_batch_weight')];
			} 
			else if ($row[csf('entry_form')] == 59) {
				$perc_calculate_qnty = $row[csf('batch_qty')];
			} 
			else 
			{
				$perc_calculate_qnty = $row[csf('batch_no')];
			}
			if($recipe_type==2) //CBP
			{
				$recipe_qnty = ($total_solution * $ratio) / 1000;
			}
			else
			{
				$recipe_qnty = ($perc_calculate_qnty * $ratio) / 100;
			}
		}
		$batch_req_id=rtrim($batch_req_id_array[$row[csf('batch_id')]],',');
		$batch_req_idArr=array_unique(explode(",",$batch_req_id_array[$row[csf('batch_id')]]));
		//echo $batch_req_id.'D';
		$tot_batch_wgt=$batch_wgt_array[$row[csf('batch_id')]];
		//echo  $tot_batch_wgt.'D';
		$batch_qty=$row[csf('batch_qty')];
		if($issue_item_cat_arr[$row[csf('batch_id')]][$row[csf('prod_id')]][$row[csf('item_category_id')]])
		{
			//echo $recipe_qnty.'='.$row[csf('avg_rate_per_unit')].'<br>';
			//$issue_qty=0;
			foreach($batch_req_idArr as $req_id)
			{
				if($issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=='')
				{	
					$issue_qty+=$issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
					$reqIdArr[$req_id]=$req_id;
					$tot_issue_qty+=$issue_qty;
					$issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=111;
					
				}
				
			}
			//$issue_qty=$issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
			$issue_perKg=($issue_qty/$tot_batch_wgt);
			$issue_wgt_per=$issue_perKg*$batch_qty;
		//	echo $tot_batch_wgt.'='.$issue_qty.'='.$issue_wgt_per.'='.$issue_wgt_per*$row[csf('avg_rate_per_unit')].'<br>';
			
		$costDataArr[$row[csf('batch_id')]][$row[csf('item_category_id')]] +=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
		$ReqIdArr[$row[csf('batch_id')]].=$batch_req_id.','; 
		//$recipe_qnty*$row[csf('avg_rate_per_unit')];
		$categryDataArr[$row[csf('batch_id')]].=$row[csf('item_category_id')].',';
		$tot_recCost+=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
		}
	}
	//echo implode(",",$reqIdArr);die;
	//echo $tot_issue_qty.'Dx'.'='.$tot_recCost;
	// echo "<pre>";print_r($costDataArr);

	$i=1;$j=1;
	ob_start();	
	?>
	<div id="" align="center" style="height:auto; width:auto; margin:0 auto; padding:0;">
		<? $summaryHTML='<div id="summary_part" style="width:1460px;">
        <table width="2060px" cellpadding="0" cellspacing="0" id="caption" align="center">
            <thead>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:16px; font-weight:bold" >'.$report_title.'</td 
                ></tr>
                <tr style="border:none;">
                    <td colspan="24" class="form_caption" align="center" style="border:none; font-size:14px;">
                       <b>Company Name : '.$companyArr[$cbo_company_name].'</b>                               
                    </td>
                </tr>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:12px; font-weight:bold">
					'."Date: ". change_date_format($from_date).' To '. change_date_format($to_date).'
					</td>
                </tr>
            </thead>
        </table>
 		
        <div  align="left" style="font-size:25px">Summary Part</div>
        <table align="left" width="1440" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>

                    <th rowspan="2" width="100">Buyer</th>

                    <th rowspan="2" width="100">Batch Qty (Kg)</th>
                    <th colspan="4" width="">First Dying And Finishing Cost</th>
                    <th colspan="3" width="">Subsequent Dyeing and Finishing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per Kg Cost (Tk)</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>

                    <th width="100">Ttl Chem Cost(Tk)</th>
                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    
                </tr> 
            </thead>
        </table>
        <div style="width:1460px; max-height:400px;  overflow-y:scroll" id="scroll_body_summary">
	        <table align="left" width="1440" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="summary_table_body_id" >
	            <tbody>';
			       	
			       	$tot_main_batch_weight=0;$qty_check_array_sum=array();$zz=1;$sub_buyer_summary_Qty_arr=array();
			       	foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						//$fabric_sales_arr[$row[csf("sales_id")]]['buyer_id']=$row[csf("buyer_id")];
						
						
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
							//batch_description_arr
							if($batch_description_arr[$b_id][entry_form]==36)
			                {
			                	$buyerName=implode(", ",array_unique(explode(",",$sub_con_id_arr[$b_id][party_id])));
			                }
							else if($batch_description_arr[$b_id][entry_form]==136) //Trims batch
			                {
			                	$job_no=$batch_description_arr[$b_id][job_no];
								$buyerName=$trim_batch_job_arr[$job_no]['buyer'];
								//$po_number=$trim_batch_job_arr[$job_no]['po_number']; 
								//$buyerName=implode(", ",array_unique(explode(",",$sub_con_id_arr[$b_id][party_id])));
			                }
			                else
			                {
				                if($batch_description_arr[$b_id]["without_order"]==1) 
				                $buyerName=$non_buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
				                else $buyerName=$buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
			                }
						
						$sales_order_id= $sales_batch_arr[$b_id];
						$buyer_id=$fabric_sales_arr[$sales_order_id]['buyer_id'];
							if($sales_order_id)
							{
								$buyerName=$buyer_id;	
							}
							else $buyerName=$buyerName;
							
							$sumbatch_noArr=$batch_arr[$b_id];
							if (!in_array($sumbatch_noArr,$qty_check_array_sum))
							{ 
								$zz++;
								$qty_check_array_sum[]=$sumbatch_noArr;
								$tot_batch_weightQty=$batch_description_arr[$b_id]['batch_weight'];
							}
							else
							{
								$tot_batch_weightQty=0;
							}
							if($batch_description_arr[$b_id][entry_form]==36)
			                {
								$sub_batch_buyer=$sub_batch_chk_arr[$b_id];
								if($sub_batch_buyer>0)//Subcon buyer Omitted //(426,439,444,458,425,427,428,443,392,564,565,563)
								{
									$sub_buyer_summary_Qty_arr[$buyerName]["sub_batch_qty"]+=$tot_batch_weightQty;
								}
							}
							
							//echo $ReqIdArr[$b_id].'FD';
							$ReqId=rtrim($ReqIdArr[$b_id],',');
							$sum_ReqIdsArr=array_unique(explode(",",$ReqId));
							//echo $ReqId.'DS';  
			                $buyer_wise_summary_arr[$buyerName]["buyer"]=$buyerName;
			                $buyer_wise_summary_arr[$buyerName]["batch_qty"]+=$tot_batch_weightQty;//$batch_description_arr[$b_id]["batch_weight"];
			                // echo "$b_id <pre>";print_r($batch_arr);die();
							$re_b_id=rtrim($re_batch_wise_arr[$batch_arr[$b_id]]['batch_id'],',');
							$re_b_idArr=array_unique(explode(",",$re_b_id));
							
							// echo "<pre>";print_r($re_b_idArr);die();
			                $first_chemi_cost=$first_dyeing_cost=0;
			                if($non_reding_batch_id[$b_id]!="")
			                {
			                    $sum_issue_amt_deys=0;$sum_issue_amt_chemical=0;
								$batch_weight=$tot_batch_weightQty;
								$sum_batchIdArr='';$tot_sum_chemical_cost=$tot_sum_deys_cost=0;
									foreach($sum_ReqIdsArr as $reqId)
									{
										//$issue_qty+=$issue_item_cat_cost_arr[$req_id][$row[csf('item_category_id')]];
										//$issue_qty+=$issue_item_cat_cost_dtls_arr[$reqId][5]+$issue_item_cat_cost_dtls_arr[$reqId][6]+$issue_item_cat_cost_dtls_arr[$reqId][7];
										//$issue_item_cat_amt_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]
										$sum_issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										$sum_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
										//$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']];
										//echo $reqId.'D=';
										
									   $batch_idsAll=$ReqBatch_id_arr[$reqId]; 
										//$sum_batchIdArr.=$batch_idsAll.',';
										
										$sum_batchIds=rtrim($batch_idsAll,',');
										$sumbatIdArr=array_unique(explode(",",$sum_batchIds)); 
										$sum_tot_batch_wgt=0;
										foreach($sumbatIdArr as $batchId)
										{
										//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
										//echo $batch_wgt_arr[$batchId]['batchWgt'].'p';
										$sum_tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt']; 
										}
										if($sum_issue_amt_chemical>0)
										{
										$tot_sum_chemical_cost+=($sum_issue_amt_chemical/$sum_tot_batch_wgt)*$batch_weight;
										}
										if($sum_issue_amt_deys>0)
										{
										$tot_sum_deys_cost+=($sum_issue_amt_deys/$sum_tot_batch_wgt)*$batch_weight;
										}
										
									}
									//echo  $sum_batchIdArr.'X=';
									    
									
									if($tot_sum_chemical_cost)
									{
									//$issue_amt_perKg_chemical=($sum_issue_amt_chemical/$sum_tot_batch_wgt);
									$summissue_amt_cal_chemical=$tot_sum_chemical_cost;
									}
									else
									 {$summissue_amt_cal_chemical=0;}
									//echo $sum_issue_amt_chemical.'='.$sum_tot_batch_wgt.'='.$batch_weight.',';
									if($tot_sum_deys_cost)
									{
									//$sum_issue_amt_perKg_dyes=($sum_issue_amt_deys/$sum_tot_batch_wgt);
									$sum_issue_amt_cal_dyes=$tot_sum_deys_cost;
									} 
									else
									{$sum_issue_amt_cal_dyes=0;}
									
								$first_chemi_cost=$summissue_amt_cal_chemical;//$costDataArr[$b_id][5]+$costDataArr[$b_id][7];
			                    $buyer_wise_summary_arr[$buyerName]["first_chemi_cost"]+=$first_chemi_cost;

			                    $first_dyeing_cost=$sum_issue_amt_cal_dyes;//$costDataArr[$b_id][6];
			                    $buyer_wise_summary_arr[$buyerName]["first_dyeing_cost"]+=$first_dyeing_cost;
								$tot_main_batch_weight=$tot_batch_weightQty;
								$buyer_wise_summary_arr[$buyerName]["tot_main_batch_weight"]+=$tot_main_batch_weight;
								// echo $first_dyeing_cost."<br>";
			                }
			                $buyer_wise_summary_arr[$buyerName]["cost_per_kg"]+=($tot_batch_weightQty>0) ? ($first_chemi_cost+$first_dyeing_cost)/$tot_batch_weightQty : 0;

			                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
			                //if($reding_batch_id[$b_id]!="")
						$sum_extention_no=$batch_ext_wise_arr[$b_id]['extention_no'];
							if($sum_extention_no>0)
							{
								 //echo $b_id.",";
							//foreach($re_b_idArr as $re_b_id)
			                //{
								$re_batch_weight=$tot_batch_weightQty;
			                   $tot_re_sum_issue_amt_chemical=$tot_re_sum_issue_amt_deys=0;$re_sum_batchIdArr='';
							   $re_sum_issue_amt_chemical=$re_sum_issue_amt_deys=0;
							    foreach($sum_ReqIdsArr as $reqId)
									{
									
										$re_sum_issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										//$re_sum_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
										$re_sum_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
										 
										 $batch_idsAll=$ReqBatch_id_arr[$reqId]; 
										//$re_sum_batchIdArr.=$batch_idsAll.',';
										
										 $re_sum_batchIds=rtrim($batch_idsAll,',');
										$ResumbatIdArr=array_unique(explode(",",$re_sum_batchIds)); 
										$Resum_tot_batch_wgt=0;
										foreach($ResumbatIdArr as $batchId)
										{
										//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
										//echo $batch_wgt_arr[$batchId]['batchWgt'].'p';
										$Resum_tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt']; 
										}
										
										if($re_sum_issue_amt_chemical)
										{	
										//$re_issue_amt_perKg_chemical=($re_sum_issue_amt_chemical/$Resum_tot_batch_wgt);
										//$re_issue_amt_cal_chemical+=$re_issue_amt_perKg_chemical*$re_batch_weight;
										$tot_re_sum_issue_amt_chemical+= (($re_sum_issue_amt_chemical/$Resum_tot_batch_wgt)*$re_batch_weight);
										
										}
										//else{$re_issue_amt_cal_chemical=0;}
										
										if($re_sum_issue_amt_deys)
										{
										//$re_issue_amt_perKg_dyes=($re_sum_issue_amt_deys/$Resum_tot_batch_wgt);
										//$re_issue_amt_cal_dyes=$re_issue_amt_perKg_dyes*$re_batch_weight;
										if($sum_extention_no==2)
										{
											// echo $re_sum_issue_amt_deys.'/'.$Resum_tot_batch_wgt.'*'.$re_batch_weight.'<br>';;
										}
										$tot_re_sum_issue_amt_deys+= (($re_sum_issue_amt_deys/$Resum_tot_batch_wgt)*$re_batch_weight);
										//echo $reqId.'d';
										// echo $re_sum_issue_amt_deys.'/'.$Resum_tot_batch_wgt.'*'.$re_batch_weight.'<br>';;
										}
										//else{$re_issue_amt_cal_dyes=0;}
										
									}
									
									$re_issue_amt_cal_chemical_tot=$tot_re_sum_issue_amt_chemical;
									$re_issue_amt_cal_dyes_tot=$tot_re_sum_issue_amt_deys;
									//echo $Resum_tot_batch_wgt.'='.$batch_weight.'='.$re_sum_issue_amt_chemical.',';;
									
									
								$re_dying_chemical_cost=$re_issue_amt_cal_chemical_tot;//$costDataArr[$re_b_id][5]+$costDataArr[$re_b_id][7];
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_chemical_cost"]+=$re_dying_chemical_cost;

			                    $re_dying_dyes_cost=$re_issue_amt_cal_dyes_tot;//$costDataArr[$re_b_id][6];	
								
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_dyes_cost"]+=$re_dying_dyes_cost;

			                    $re_dying_dyes_chemical_cost=$re_issue_amt_cal_chemical_tot+$re_issue_amt_cal_dyes_tot;
			                    $buyer_wise_summary_arr[$buyerName]["re_dying_dyes_chemical_cost"]+=$re_dying_dyes_chemical_cost;
			                //}
						}
			                $buyer_wise_summary_arr[$buyerName]["re_dye_cost_per_kg"]+=($tot_batch_weightQty>0) ? $re_dying_dyes_chemical_cost/$tot_batch_weightQty : 0;

			                $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
			                $buyer_wise_summary_arr[$buyerName]["total_per_kg_cost"]+=($tot_batch_weightQty>0) ? ($first_chemi_cost+$first_dyeing_cost)/$tot_batch_weightQty : 0;

			                //$buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price)/$buyer["batch_qty"]
						}	
					}
					
				    // echo "<pre>";print_r($buyer_wise_summary_arr);die;
					$tot_sub_buyer_qty_omit=0;
					foreach($buyer_wise_summary_arr as $buyer_id=>$buyer) 
					{
						if($j%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
						
						$sub_buyer_qty_omit=0;
						$sub_buyer_qty_omit=$sub_buyer_summary_Qty_arr[$buyer_id]["sub_batch_qty"];
						$tot_sub_buyer_qty_omit+=$sub_buyer_qty_omit; 
						
			            $summaryHTML.='<tr bgcolor="'.$bgcolor.'">
			                <td width="30">'.$j.'</td>

				            <td width="100"><p>'.$buyer_library[$buyer_id].'</p></td>

			                <td width="100" align="right" align="right"><p>'.number_format($buyer["batch_qty"],4,".","").'</p></td>


			                <td width="100" align="right"><p>'.fn_number_format($buyer["first_chemi_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.fn_number_format($buyer["first_dyeing_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>';
			                $summary_batch_chemical_price=$buyer["first_chemi_cost"]+$buyer["first_dyeing_cost"];
							$tot_summ_cost=$buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price;
			                $summaryHTML.=fn_number_format($summary_batch_chemical_price,4,".","").'</p></td>
			                <td width="100" align="right"><p>
			                '.fn_number_format($summary_batch_chemical_price/$buyer["batch_qty"],4,".","").' 
			                </p></td>

								
			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_chemical_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_dyes_cost"],4,".","").'</p></td>
			                <td width="100" align="right"><p>'.number_format($buyer["re_dying_dyes_chemical_cost"],4,".","").'</p></td>
			               


			                <td width="100" align="right">'.fn_number_format($buyer["re_dying_dyes_chemical_cost"]+$summary_batch_chemical_price,4,".","").'</td>
			                <td width="100" align="right">
			                '.fn_number_format($tot_summ_cost/$buyer["batch_qty"],4,".","").'
			                </td>
			            </tr>';
						$summary_total_batch_weight+=$buyer["batch_qty"];
						$summary_total_chemical_cost+=$buyer["first_chemi_cost"];
						$summary_total_dyes_cost+=$buyer["first_dyeing_cost"];
						$summary_total_batch_chemical_price+=$summary_batch_chemical_price;
						$summary_tot_total_receive+=$totalReceive;
						$summary_tot_re_dying_chemical_cost+=$buyer["re_dying_chemical_cost"];
						$summary_tot_re_dying_dyes_cost+=$buyer["re_dying_dyes_cost"];
						$summary_tot_re_dying_dyes_chemical_cost+=$buyer["re_dying_dyes_chemical_cost"];
						$summary_cost_per_kg+=$buyer["cost_per_kg"];
						$summary_total_per_kg_cost+=$buyer["total_per_kg_cost"];
						$j++;
					}
					?>
	            <? $summaryHTML.='</tbody>
	      	</table>
      	</div>
       	<table align="left" width="1440" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="summary_table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="100" align="right">&nbsp;Total</th>
                     <th width="100"  title='.$tot_sub_buyer_qty_omit.'>'.number_format($summary_total_batch_weight-$tot_sub_buyer_qty_omit,4).'</th>

                	<th width="100" align="right" id="value_total_chemical_cost_summary">'.number_format($summary_total_chemical_cost,4).'</th>
                	<th width="100" align="right" id="value_total_dyeing_cost_summary">'.number_format($summary_total_dyes_cost,4).'</th>
                    <th width="100" align="right" id="value_total_chemical_price_summary">'.number_format($summary_total_batch_chemical_price,4).'</th>
                    <th width="100" align="right" id="value_total_cost_per_kg_summary">'.fn_number_format($summary_total_batch_chemical_price/$summary_total_batch_weight,4).'</th>

                    <th width="100" align="right" id="value_total_redying_chemic_oost_summary">'.number_format($summary_tot_re_dying_chemical_cost,4).'</th>
                    <th width="100" align="right" id="value_total_redying_dying_cost_summary"><p>'.number_format($summary_tot_re_dying_dyes_cost,4).'</p></th>
                    <th width="100" align="right" id="value_total_redying_all_cost_summary"><p>'.number_format($summary_tot_re_dying_dyes_chemical_cost,4).'</p></th>
                    
                    
                    <th width="100" align="right" id="value_total_total_cost_summary">'.number_format($summary_total_batch_chemical_price+$summary_tot_re_dying_dyes_chemical_cost,4).'</th>
                    <th width="100" align="right" id="value_total_total_per_kg_cost_summary" title="">'.number_format(($summary_total_batch_chemical_price+$summary_tot_re_dying_dyes_chemical_cost)/$summary_total_batch_weight,4).'</th>
                </tr>
            </tfoot>
        </table>
    	</div>';?>
    <? echo $summaryHTML;?>

 	<div>
        <div  align="left" style="font-size:20px">Details</div>
        <table width="2880" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        	<thead>
                <tr>
                    <th rowspan="2" width="30">SL</th>
                    <th rowspan="2" width="80">Date</th>
                    <th rowspan="2" width="100">Machine No</th>
                    <th rowspan="2" width="100">Batch No</th>
                    <th rowspan="2" width="80">File No</th>
                    <th rowspan="2" width="80">Ref. No</th>
                    <th rowspan="2" width="100">Floor Name</th>
                    <th rowspan="2" width="100">Buyer</th>
                    <th rowspan="2" width="100">Booking No</th>
                    <th rowspan="2" width="100">Job no</th>
                    <th rowspan="2" width="80">Season</th>                  
                    <th rowspan="2" width="100">Style</th>
                   
                    <th rowspan="2" width="100">Color Name</th>
                    <th rowspan="2" width="100">Color Range</th>
                    <th rowspan="2" width="100">Fabric Type </th>
                    <th rowspan="2" width="100">Batch Qty (Kg)</th>
                    <th colspan="4"  width="">First Dying And Finishing Cost</th>
                    <th colspan="6" width="">Subsequent Dyeing and Finishing Cost</th>
                    <th rowspan="2" width="100">Total Cost (Tk)</th>
                    <th rowspan="2" width="100">Total Per Kg Cost (Tk)</th>
                    <th rowspan="2" width="">Result</th>
                </tr> 
                <tr>                         
                    <th width="100">Ttl Chem Cost (Tk)</th>
                    <th width="100">Ttl Dyes Cost (Tk)</th>
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    <th width="100">Cost Per Kg (Tk)</th>
                    <th width="100">Extention Batch Date</th>
                    <th width="70">Extention No</th>
                    <th width="100">Floor Name</th>
                    <th width="100">Ttl Chem Cost(Tk)</th>
                    <th width="100"> Ttl Dyes Cost(Tk)</th> 
                    <th width="100"><p>Ttl Chem + Dyes Cost (Tk)</p></th>
                    
                </tr> 
            </thead>
        </table>
        <div style="width:2900px; max-height:400px;  overflow-y:scroll" id="scroll_body">
	        <table width="2880" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_id" >
	            <tbody>
			       	<?
				    // echo "<pre>";print_r($issue_single_batch_arr);die;
					$tot_main_batch_weight=0;$qty_check_array=array();$z=1;$total_tot_batch_weight=$sub_buyer_grnd_tot_batchQty=0;
					foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						{
						
							if($i%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
							$all_po_id=explode(",",$po_break_down_id_arr[$batch_description_arr[$b_id]['booking_no']]); 
							//print_r($all_po_id);
							$ReqId=rtrim($ReqIdArr[$b_id],',');
							$ReqIds=implode(", ",array_unique(explode(",",$ReqId)));
							$ReqIdsArr=array_unique(explode(",",$ReqId));
							
							
							
							if($batch_description_arr[$b_id][entry_form]!=136)
							{
							$po_number_data="";
							$job_no_data="";$file_no="";$ref_no="";
							foreach($all_po_id as $p_id) // $po_number_arr[$row[csf('id')]]['po_no']
							{
								//echo $p_id.'d';
								if($po_number_data!="") $po_number_data.=",".$po_number_arr[$p_id]['po_no'];	 else $po_number_data=$po_number_arr[$p_id]['po_no'];
								if($job_no_data!="") $job_no_data.=",".$po_number_arr[$p_id]['job'];	
								 else $job_no_data=$po_number_arr[$p_id]['job'];
								if($season_data!="") $season_data.=",".$season_name_arr[$po_number_arr[$p_id]['season']];	 else $season_data=$season_name_arr[$po_number_arr[$p_id]['season']];
								if($file_no!="") $file_no.=",".$po_number_arr[$p_id]['file_no'];	 else $file_no=$po_number_arr[$p_id]['file_no'];
								if($ref_no!="") $ref_no.=",".$po_number_arr[$p_id]['ref_no'];	 else $ref_no=$po_number_arr[$p_id]['ref_no'];
							}
							$file_cond=implode(", ",array_unique(explode(",",$file_no)));
							$ref_cond=implode(", ",array_unique(explode(",",$ref_no))); 
							}
							//$categrybatch=rtrim($categryDataArr[$b_id][$row[csf('item_category_id')]],',');
						//$categryId=implode(", ",array_unique(explode(",",$categrybatch)));
							//echo $po_number_data.'XX';;
							$color_range_id=$batch_description_arr[$b_id]['color_range'];
							
							if($batch_description_arr[$b_id]['without_order']==1 && $ref_cond=="")
							{
							$ref_cond=$sample_booking_ref_no_arr[$batch_description_arr[$b_id]['booking_no']];
							}
							
							$re_b_id=rtrim($re_batch_wise_arr[$batch_arr[$b_id]]['batch_id'],',');
							$re_b_idArr=array_unique(explode(",",$re_b_id));
							//echo $re_b_id.'======';
							$re_b_ids=implode(",",array_unique(explode(",",$re_b_id)));
							$extention_noData=rtrim($batch_wise_arr[$batch_arr[$b_id]]['extention_no'],',');
							$extention_noArr=array_unique(explode(",",$extention_noData));
							$extention_no=$batch_ext_wise_arr[$b_id]['extention_no'];
							$ext_batch_date=$batch_ext_wise_arr[$b_id]['batch_date'];;
							if($re_b_ids) $re_b_idsCond.=",".$re_b_ids;else $re_b_idsCond="";
							if($batch_description_arr[$b_id][entry_form]==136)
							{
								 $job_no=$batch_description_arr[$b_id][job_no];
								 	 $ref_noArr=rtrim($trim_batch_job_arr[$job_no]['ref_no'],','); 
									 $file_noArr=rtrim($trim_batch_job_arr[$job_no]['file_no'],',');
									  $ref_cond=implode(",",array_unique(explode(",",$ref_noArr))); 
									  $file_cond=implode(",",array_unique(explode(",",$file_noArr))); 
									 
								//$file_cond=$file_cond;
								//$ref_cond=$ref_cond;
							}
							else
							{
								$file_cond=$file_cond;$ref_cond=$ref_cond;
							}
							
							$batch_noArr=$batch_arr[$b_id];
							if (!in_array($batch_noArr,$qty_check_array))
							{ 
								$z++;
								$qty_check_array[]=$batch_noArr;
								$tot_batch_weight=$batch_description_arr[$b_id]['batch_weight'];
							}
							else
							{
								$tot_batch_weight=0;
							}
							
							 
							
							
							//echo $batch_weight.'='.$issue_amt.'='.$issue_qty;
			
							
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="30"><? echo $i; ?></td>								
				                <td width="80"><? echo change_date_format($batch_description_arr[$b_id]['batch_date']); ?></td>
				                <td width="100"><p><? echo $machine_name_arr[$b_id]; ?></p></td>                                 
				                <td width="100" title="BatchId=<? echo $b_id;?>"><p>
                                <A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','batch_wise_subprocess_fabrics_dtls_popup2','<? echo $ReqIds; ?>',1)"> <? echo $batch_arr[$b_id]; ?> </A>
                               <? //echo $batch_arr[$b_id]; ?></p></td>
				                <td width="80"><p><? echo $file_cond; ?></p></td>
				                <td width="80" title="PO/Sample Ref no"><p><? echo $ref_cond; ?></p></td>
				                <td width="100"><p><? echo $floor_arr[$b_id]; ?></p></td> 
				                <?
								$sub_batch_buyer="";
				                if($batch_description_arr[$b_id][entry_form]==36)
				                {
					               $sub_batch_buyer=$sub_batch_chk_arr[$b_id];
									if($sub_batch_buyer>0)//Subcon buyer Omitted //(426,439,444,458,425,427,428,443,392,564,565,563)
									{
										$sub_buyer_grnd_tot_batchQty+=$batch_description_arr[$b_id]['batch_weight'];
									}
									?>
					                <td width="100"><p style="word-break:break-all"><? echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][party_id]))); ?></p></td> 
					                <td width="100"><p><? // echo $b_id; ?></p></td>
					                <td width="100" align="center"><p style="word-break:break-all">
					                <? 
				                     echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                 <td width="80" align="center"><p>
					                <? 
				                     //echo implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][subcon_job])));
					                ?></p></td>
					                <td width="100" align="center"><p style="word-break:break-all"> <? echo   implode(", ",array_unique(explode(",",$sub_con_arr[$b_id][cust_style_ref]))); ?></p></td>
					                
				                	<?
				                }
								else if($batch_description_arr[$b_id][entry_form]==136)
				                {
					               $job_no=$batch_description_arr[$b_id][job_no]; 
								   $season_data=$season_name_arr[$trim_batch_job_arr[$job_no]['season']];//season_name_arr
								   $buyerName=$buyer_library[$trim_batch_job_arr[$job_no]['buyer']]; 
								   $po_number_data=rtrim($trim_batch_job_arr[$job_no]['po_number'],','); 
								    $ref_noArr=rtrim($trim_batch_job_arr[$job_no]['ref_no'],','); 
									 $file_noArr=rtrim($trim_batch_job_arr[$job_no]['file_no'],','); 
									?>
					               <td width="100"><p><? 
					                 
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
					                <td width="100"><p><? //echo $batch_description_arr[$b_id]['booking_no']; ?></p></td>
					                <td width="100" align="center"><div style="word-break:break-all">
					                <?
					                echo $job_no;
					                ?></div></td>
					                <td width="80" align="center"><div style="word-break:break-all">
					                <? 
					                
					                echo $season_data;

					                ?></div></td>
					                <td width="100" align="center"><div style="word-break:break-all"> 
					                <? 
					                $style_no=$style_library[$job_no];
					                echo $style_no; ?></div></td>
					                
				                	<?
				                }
				                else
				                {
					                ?>
					                <td width="100"><p style="word-break:break-all"><? 
					                if($batch_description_arr[$b_id]['without_order']==1) $buyerName=$non_buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];else $buyerName=$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']];
									$sales_order_id= $sales_batch_arr[$b_id];
									$buyer_id=$fabric_sales_arr[$sales_order_id]['buyer_id'];
										if($sales_order_id && $buyerName=='')
										{
											$buyerName='';//buyer_arr
											$buyerName=$buyer_library[$buyer_id];
											//echo "DDDD";	
										}
										else $buyerName=$buyerName;
							
					                echo $buyerName;//$buyer_name_arr[$batch_description_arr[$b_id]['booking_no']]; ?></p></td> 
					                <td width="100"><p style="word-break:break-all"><? echo $batch_description_arr[$b_id]['booking_no']; ?></p></td>
					                <td width="100" align="center"><div style="word-break:break-all">
					                <?
					                echo implode(", ",array_unique(explode(",",$job_no_data)));
					                ?></div></td>
					                <td width="80" align="center"><div style="word-break:break-all">
					                <? 
					                
					                echo implode(", ",array_unique(explode(",",$season_data)));

					                ?></div></td>
					                <td width="100" align="center"><div style="word-break:break-all"> 
					                <? 
					                $style_no=array();
					                foreach(array_unique(explode(",",$job_no_data)) as $j_no)
					                {
					                    if($style_no!="")  $style_no[]=$style_library[$j_no];
					                }
					                echo implode(", ",array_unique($style_no)); ?></div></td>
					                
                                   
					                <?	
				                }
				                ?>
				                <td width="100" align="center"><div style="word-break:break-all"><? echo $color_arr[$batch_description_arr[$b_id]['color_id']]; ?></div></td> 
				                <td width="100" align="center"><p style="word-break:break-all"><? echo $color_range[$color_range_id]; ?></p></td> 
				                <td width="100" align="center"><p style="word-break:break-all"><? echo $fabric_type_for_dyeing[$fabric_type_arr[$b_id]['fabric_type']]; //$fabric_type_for_dyeing?></p></td> 
				                <td width="100" align="right"><p>
				                <? echo number_format($tot_batch_weight,4); 
								
								//$total_batch_weight+=$batch_description_arr[$b_id]['batch_weight'];
								$total_batch_weight+=$tot_batch_weight;
								
								?>
				                </p></td> 
				                <?
				                $batch_weight=$tot_batch_weight;
				                $first_chemi_cost=$first_dyeing_cost=0;
				                if($non_reding_batch_id[$b_id]!="")
				                {
				                    
									$issue_amt_deys=0;$issue_amt_chemical=$totalcost=0;
									$batchIdArr="";$tot_chemicalCost=$tot_dyesCost=0;
									foreach($ReqIdsArr as $reqId)
									{
										//$batch_id=rtrim($batchWgtChkk[$reqId],',');
										//$issue_item_cat_amt_dtls_arr2[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']];
										
										//$val['CONS_AMOUNT']/$batch_wgt_cal;
										
										$issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										$issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
									
									    $batch_ids=$ReqBatch_id_arr[$reqId]; 
										$batIdArr=array_unique(explode(",",$batch_ids)); 
										$tot_batch_wgt=0;
									    //print_r($batIdArr);
										foreach($batIdArr as $batchId)
										{
											$tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt'];
										}
										// echo $reqId.'='.$totalcost = ((($issue_amt_chemical+$issue_amt_deys)/$tot_batch_wgt)*$batch_weight)."<br />";
										 //$ref_cond=implode(",",array_unique(explode(",",$ref_noArr))); 
										//$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']];;
										if($issue_amt_chemical>0)
										{
										$tot_chemicalCost+= (($issue_amt_chemical/$tot_batch_wgt)*$batch_weight);
										}
										if($issue_amt_deys>0)
										{
										$tot_dyesCost+= (($issue_amt_deys/$tot_batch_wgt)*$batch_weight);
										}
									}
									
									
									
									//echo $totalcost.'D';									
								 
										
										//echo $issue_amt_chemical.'='.$batch_weight.'='.$tot_batch_wgt.',';
									
									 // echo $tot_batch_wgt.','; 
									if($tot_chemicalCost)
									{
									//$issue_amt_perKg_chemical=($issue_amt_chemical/$tot_batch_wgt);
									$issue_amt_cal_chemical=$tot_chemicalCost;//$issue_amt_perKg_chemical*$batch_weight;
									//echo $issue_amt_cal_chemical.'D'; 
									} 
									else 
									{ $issue_amt_cal_chemical=0;}
									
									if($tot_dyesCost)
									{
									//$issue_amt_perKg_dyes=($issue_amt_deys/$tot_batch_wgt);
									$issue_amt_cal_dyes=$tot_dyesCost;
									}
									else {$issue_amt_cal_dyes=0;}
									
				                    $first_chemi_cost=$issue_amt_cal_chemical;//$costDataArr[$b_id][5]+$costDataArr[$b_id][7];
				                    $first_dyeing_cost=$issue_amt_cal_dyes;//$costDataArr[$b_id][6];
									
									$tot_main_batch_weight+=$tot_batch_weight;
				                }
				                
				                ?>
				                <td width="100" align="right" title="BatchId=<? echo $b_id;?>"><p>
				                <?
				                 echo number_format($first_chemi_cost,4,".",""); 
				                 $total_chemical_cost+=$first_chemi_cost;
				                 ?>
				                </p></td>
				                <td width="100" align="right"><p>
				                <?  
				                    echo number_format($first_dyeing_cost,4,".",""); 
				                    $total_dyes_cost+=$first_dyeing_cost; 
				                ?>
				                </p></td>
				                <td width="100" align="right"  title="ReqId=<? echo $ReqIds;?>"><p><A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','1st_chemi_dyes_batch_dtls_popup','<? echo $ReqIds; ?>',2)">
				                <?
				                 $batch_chemical_price=$first_chemi_cost+$first_dyeing_cost;
				                  echo number_format($batch_chemical_price,4,".","");
				                  $total_batch_chemical_price+=$batch_chemical_price;
				                ?>
				                </A></p></td>
				                <td width="100" align="right"><p><? echo number_format(($tot_batch_weight>0) ? $batch_chemical_price/$tot_batch_weight : 0,4,".",""); $tot_total_receive+=$totalReceive; ?></p></td>
				                <td width="100" align="right"><p>
				                <? 
				                $extension_no="";
				                $re_batch_date="";
				                $batch_date=explode(",", $redying_details_arr[$b_id]['batch_date']);	
				               
				                echo change_date_format($ext_batch_date);
				                 ?></p></td>
				                <td width="70" title="BatchId=<? echo $b_id;?>" align="right"><p>
				                <?		                
				                //echo $redying_details_arr[$b_id]['id'].jahid;
								
				                if(trim($redying_details_arr[$b_id]['id']))
				                {
				                    $re_dying_id_all=array_unique(explode(",",$redying_details_arr[$b_id]['id']));
				                    //$re_dying_chemical_cost=0;
				                    //$re_dying_dyes_cost=0;
				                    //$re_dying_dyes_chemical_cost=0;
				                    
				                    $result_id="";
				                    $result_id_last='';
				                    
				                    foreach($re_dying_id_all as $ash_id)
				                    {
				                    //$re_dying_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                    //$re_dying_dyes_cost+=$dyes_chemical_arr[$ash_id][6]['chemical_cost']	;	
				                    //$re_dying_dyes_chemical_cost+=$dyes_chemical_arr[$ash_id][5]['chemical_cost']+$dyes_chemical_arr[$ash_id][6]['chemical_cost']+$dyes_chemical_arr[$ash_id][7]['chemical_cost'];
				                        
				                     if($re_batch_date!="") $re_batch_date.=",".change_date_format($ash_date); else $re_batch_date=change_date_format($ash_date);
				                     //if($re_floor!="") $re_floor.=",".$floor_arr[$ash_id]; else $re_floor=$floor_arr[$ash_id];
				                    /* echo $ash_id.tipu;
				                     $result_id=$result_arr[$ash_id];
				                     if($result_id!="")  $result_id_last=$result_id;*/
				                    }
				                }
				                //echo $b_id;
				                //if($batch_type==3)
				                //{
				                echo $extention_no;	 ?>
				                
				                
				                </p></td>
				                <td width="100" align="right"><p><?
				                $re_floors='';
				                $re_dying_chemical_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_cost=0;$re_dying_dyes_chemical_cost=0;
				                //print_r($reding_batch_id);//echo $reding_batch_id[$b_id]."##".$b_id;
				               // if($reding_batch_id[$b_id]!="")
							   	foreach($re_b_idArr as $re_bid)
				                {
				                    $re_floors=$floor_arr[$re_bid];
				                    /*$re_dying_chemical_cost+=$costDataArr[$re_bid][5]+$costDataArr[$re_bid][7];
				                    $re_dying_dyes_cost+=$costDataArr[$re_bid][6]	;	
				                    $re_dying_dyes_chemical_cost+=$costDataArr[$re_bid][5]+$costDataArr[$re_bid][6]+$costDataArr[$re_bid][7];*/
				                }
								//echo $extention_no.'D=';
								$re_tot_chemicalCost=0; 
								if($extention_no>0)
								{
									$re_batch_weight=$tot_batch_weight;
									
									$re_issue_amt_deys=0;$re_issue_amt_chemical=0;$re_tot_dyesCost=0;
									$rebatchIdArr="";
									foreach($ReqIdsArr as $reqId)
									{
										//$issue_qty+=$issue_item_cat_cost_arr[$req_id][$row[csf('item_category_id')]];
										//$issue_qty+=$issue_item_cat_cost_dtls_arr[$reqId][5]+$issue_item_cat_cost_dtls_arr[$reqId][6]+$issue_item_cat_cost_dtls_arr[$reqId][7];
										//$issue_item_cat_amt_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]
										$re_issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										$re_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
										
										 $batch_ids=$ReqBatch_id_arr[$reqId]; 
										//$rebatchIdArr.=$batch_ids.',';
										//echo $batch_ids.'DSSSSSSSSS';
										//$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']];
										
										
										$batchIds=rtrim($batch_ids,',');
										$rebatchIdArr=array_unique(explode(",",$batchIds)); 
										$re_tot_batch_wgt=0;
										foreach($rebatchIdArr as $rebatchId)
										{
											//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
												$re_tot_batch_wgt+=$batch_wgt_arr[$rebatchId]['batchWgt']; 
										}
										if($re_issue_amt_chemical>0)
										{
										$re_tot_chemicalCost+= (($re_issue_amt_chemical/$re_tot_batch_wgt)*$re_batch_weight);
										}
										if($re_issue_amt_deys>0)
										{
											//echo $b_id.'='.($re_issue_amt_deys/$re_tot_batch_wgt)*$batch_weight.'<br>';
										$re_tot_dyesCost+= (($re_issue_amt_deys/$re_tot_batch_wgt)*$re_batch_weight);
										}
										
									}
									
									
									
										//echo $re_issue_amt_chemical.'='.$re_tot_batch_wgt.'='.$batch_weight.',';
										
									if($re_tot_chemicalCost)
									{
									//$re_issue_amt_perKg_chemical=($re_issue_amt_chemical/$re_tot_batch_wgt);
									$re_issue_amt_cal_chemical=$re_tot_chemicalCost;
									}
									else 
									{$re_issue_amt_cal_chemical=0;}
									
									if($re_tot_dyesCost)
									{
									//$re_issue_amt_perKg_dyes=($re_issue_amt_deys/$re_tot_batch_wgt);
									$re_issue_amt_cal_dyes=$re_tot_dyesCost;
									}
									else
									{
										$re_issue_amt_cal_dyes=0;
									}
									
									$re_dying_chemical_cost=$re_issue_amt_cal_chemical;//$costDataArr[$re_bid][5]+$costDataArr[$re_bid][7];
				                    $re_dying_dyes_cost=$re_issue_amt_cal_dyes;//$costDataArr[$re_bid][6]	;	
				                    $re_dying_dyes_chemical_cost=$re_dying_chemical_cost+$re_issue_amt_cal_dyes;//$costDataArr[$re_bid][5]+$costDataArr[$re_bid][6]+$costDataArr[$re_bid][7];
								}
				                
				                echo $re_floors;
				                ?></p></td>
				                <td width="100" align="right"><p>
				                <?
				                 echo number_format($re_dying_chemical_cost,4,".",""); 
				                 $tot_re_dying_chemical_cost+=$re_dying_chemical_cost;
				                 ?>
				                 </p></td>
				                <td width="100" align="right"><p><? echo number_format($re_dying_dyes_cost,4,".",""); $tot_re_dying_dyes_cost+=$re_dying_dyes_cost;  ?></p></td>
				                <td width="100" align="right" title="ReqId=<? echo $ReqIds;?>"><A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','1st_chemi_dyes_batch_dtls_popup','<? echo $ReqIds; ?>',2)"><p><? echo number_format($re_dying_dyes_chemical_cost,4,".",""); $tot_re_dying_dyes_chemical_cost+=$re_dying_dyes_chemical_cost; ?></p></A></td>
				                 
				                

				                <td width="100" align="right"><? echo number_format($re_dying_dyes_chemical_cost+$batch_chemical_price,4,".",""); ?></td>
				                <td width="100" align="right" title="<? echo '('.$re_dying_dyes_chemical_cost.'+'.$batch_chemical_price.')/'.$tot_batch_weight; ?>"><?
				                 echo number_format( ($tot_batch_weight) ? ($re_dying_dyes_chemical_cost+$batch_chemical_price)/$tot_batch_weight : 0,4,".","");  ?></td>
				                <td width="" align="center" title="<? echo $b_id; ?>"><? //echo $unload_result_arr[$b_id]//echo  $dyeing_result[$result_id];//
				                //echo $b_id.tipu;
			                    $result_id=$result_arr[$b_id];
			                    if($result_id!="")  $result_id_last=$result_id;
				                echo $dyeing_result[$result_id];//$dyeing_result;//$daysOnHand; ?></td>
				            </tr>
							<? 	
						//	$total_tot_batch_weight+=$tot_batch_weight;											
							$i++; 			
						}	
					}
					?>
	            </tbody>
	      	</table>
      	</div>
       	<table width="2880" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="80">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                	<th width="100">&nbsp;</th>
                     <th width="80">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                  
                    <th width="100">&nbsp;</th>
                    <th width="100"><? //echo number_format($total_batch_chemical_price,4).'='.$total_dyes_cost; ?></th>
                	<th width="100">Total</th>
                    <th width="100" id="" title="<? echo $sub_buyer_grnd_tot_batchQty.'='.$total_tot_batch_weight;?>"><? echo number_format($total_batch_weight-$sub_buyer_grnd_tot_batchQty,4); ?></th>
                	<th width="100" id="value_total_chemical_cost_single"><? echo number_format($total_chemical_cost,4); ?></th>
                	<th width="100" id="value_total_dyeing_cost_single"><? echo number_format($total_dyes_cost,4); ?></th>
                    <th width="100" id="value_total_chemical_price_single"><? echo number_format($total_batch_chemical_price,4); ?></th>
                    <th width="100" id=""><? echo number_format(($total_batch_chemical_price)/$total_batch_weight,4); ?></th>
                    <th width="100"><? //echo number_format($tot_re_dying_chemical_cost,3); ?></th>
                    <th width="70"><? //echo number_format($tot_rec_return,3); ?></th>
                    <th width="100"><? //echo number_format($tot_total_issue,3); ?></th>
                    <th width="100" id="value_total_redying_chemic_oost_single"><? echo number_format($tot_re_dying_chemical_cost,4); ?></th>
                    <th width="100" id="value_total_redying_dying_cost_single"><p><? echo number_format($tot_re_dying_dyes_cost,4); ?></p></th>
                    <th width="100" id="value_total_redying_all_cost_single"><p><? echo number_format($tot_re_dying_dyes_chemical_cost,4); ?></p></th>
                    <!--<th width="100" id=""><? //echo number_format($tot_re_dying_dyes_chemical_cost/$total_batch_weight,4); ?></th>-->
                    <th width="100" id="value_total_total_cost_single"><? echo number_format($total_batch_chemical_price+$tot_re_dying_dyes_chemical_cost,4); ?></th>
                    <th width="100" id="" title="Main Batch Qty=<? echo number_format($tot_main_batch_weight,2);?>"><? echo number_format(($total_batch_chemical_price+$tot_re_dying_dyes_chemical_cost)/$total_batch_weight,4); ?></th>
                    <th width="">&nbsp;</th>
                </tr>
            </tfoot>
        </table>
    </div>
    <?
    $html = ob_get_contents();
    ob_clean();
    //$new_link=create_delete_report_file( $html, 2, $delete, "../../../" );
    foreach (glob("*.xls") as $filename) {
    //if( @filemtime($filename) < (time()-$seconds_old) )
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');	
    $is_created = fwrite($create_new_doc, $html);


    $filename2=$user_id."_summary_".$name.".xls";
    $create_new_doc2 = fopen($filename2, 'w');	
    $is_created2 = fwrite($create_new_doc2, $summaryHTML);

    echo "$html****$filename****$filename2****$report_type"; 
    exit();
}
if($action=="generate_report_floor") // Floor  Wise 
{ 
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if ($cbo_company_name==0) $company_id=""; else $company_id=" and a.company_id='$cbo_company_name'";
	if ($cbo_company_name==0) $company_idcond =""; else $company_idcond =" and b.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond .=""; else $company_idcond .=" and b.working_company_id='$cbo_working_name'";
	
	if ($cbo_company_name==0) $company_idcond2 =""; else $company_idcond2 =" and a.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond2 .=""; else $company_idcond2 .=" and a.service_company='$cbo_working_name'";
	
	//
	//echo $cbo_company_name.'='.$cbo_working_name;die;
	if($cbo_company_name) $company_ids=$cbo_company_name;
	else if($cbo_working_name) $company_ids=$cbo_working_name;
	
	if ($cbo_company_name==0 && $cbo_working_name==0) 
	{
	$w_company_idcond ="";$w_company_idcond2="";$w_company_idcond3="";
	}
	 else  {
		 if ($cbo_company_name==0 && $cbo_working_name>0)
		 {
		  	$w_company_idcond =" and c.company_id='$cbo_working_name'";
			$w_company_idcond2 =" and b.knit_dye_company='$cbo_working_name'";
			$w_company_idcond3 =" and b.working_company_id='$cbo_working_name'";
		 }
		 else  if ($cbo_company_name>0 && $cbo_working_name==0)
		 {
		  $w_company_idcond =" and c.company_id='$cbo_company_name'";
		  $w_company_idcond2 =" and b.knit_dye_company='$cbo_company_name'";
		  $w_company_idcond3 ="";
		 }
	 }
	 // echo  $w_company_idcond.'dd'.$company_idcond;die;
	
	$from_date=str_replace("'","",$from_date);
	$to_date=str_replace("'","",$to_date);
	//echo $from_date;
	$txt_ref_no=str_replace("'","",$txt_ref_no); 
	$txt_file_no=str_replace("'","",$txt_file_no);
	$txt_booking_no=str_replace("'","",$txt_booking_no);
	$txt_po_no=str_replace("'","",$txt_po_no);
	$txt_job=str_replace("'","",$txt_job);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$cbo_season_id=str_replace("'","",$cbo_season_id);
	$txt_samp_ref_no=str_replace("'","",$txt_samp_ref_no);
	$location_id=str_replace("'","",$location_id);
	$floor_id=str_replace("'","",$floor_id);
	$report_type=str_replace("'","",$report_type);
	$cbo_year=str_replace("'","",$cbo_year_selection);

	
	
	if(str_replace("'","",$cbo_buyer_name)==0)
	{
		if ($_SESSION['logic_erp']["data_level_secured"]==1)
		{
			if($_SESSION['logic_erp']["buyer_id"]!="") $buyer_id_cond=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")"; else $buyer_id_cond="";
		}
		else
		{
			$buyer_id_cond="";
		}
	}
	else
	{
		$buyer_id_cond=" and a.buyer_name in (".str_replace("'","",$cbo_buyer_name).")";
	}
	
	if($txt_booking_no!='') $booking_no_cond="and b.booking_no like '%$txt_booking_no%' ";else $booking_no_cond="";
	if($db_type==0)
		{
			$year_cond=" and SUBSTRING_INDEX(a.insert_date, '-', 1)=$cbo_year";
		}
		else if($db_type==2)
		{
			$year_cond=" and to_char(a.insert_date,'YYYY')=$cbo_year";
		}
		
	if($txt_file_no!='') $file_cond="and b.file_no=$txt_file_no";else $file_cond="";
	if($txt_job!='') $job_cond="and a.job_no_prefix_num=$txt_job  $year_cond";else $job_cond="";
	if($txt_po_no!='') $po_cond="and b.po_number='$txt_po_no'";else $po_cond="";
	
	if($cbo_season_id!=0) $season_cond="and a.season_buyer_wise in($cbo_season_id)";else $season_cond="";
	if($floor_id!=0) $floor_id_cond="and a.floor_id in($floor_id)";else $floor_id_cond="";
	
	if($txt_ref_no!='') $ref_cond="and b.grouping='$txt_ref_no'";else $ref_cond="";
	if($txt_samp_ref_no!='') $samp_ref_cond="and a.grouping='$txt_samp_ref_no'";else $samp_ref_cond="";
	//echo $ref_cond;
	$companyArr = return_library_array("SELECT id,company_name from lib_company where status_active=1 and is_deleted=0","id","company_name"); 
	$supplierArr = return_library_array("SELECT id,supplier_name from lib_supplier where status_active=1 and is_deleted=0","id","supplier_name"); 
	$color_arr=return_library_array( "SELECT id,color_name  from  lib_color", "id", "color_name"  );
	$season_name_arr=return_library_array( "SELECT id,season_name  from  lib_buyer_season", "id", "season_name"  );
	
	if($db_type==0) 
	{
	$from_date=change_date_format($from_date,'yyyy-mm-dd'); $to_date=change_date_format($to_date,'yyyy-mm-dd');
	}
    if($db_type==2) 
	{
	$from_date=change_date_format($from_date,'','',1);  $to_date=change_date_format($to_date,'','',1);
	}
	//echo $from_date;
	
	
	$batch_description_arr=array();
	/* 
	if(str_replace("'","",$batch_id)!="") $batch_cond=" and b.id in(".str_replace("'","",$batch_id).")";
    else  */
	
	
	//echo $batch_cond; //die;
	//echo $batch_no; //die;
    	//echo $batch_no;
	$batch_no=implode("','",array_unique(explode(",",$batch_no)));
	
	if(str_replace("'","",$batch_no)!="") $batch_cond=" and b.batch_no in('".$batch_no."') "; 
	else $batch_cond="";
	//echo $batch_cond."shakil"; die;
	
	//
	/* and b.re_dyeing_from=0 13-11-16 according to siddique sir dicission when search buyer order or subcontract all batch appear */
	if($batch_type==0)
	$search_field_cond_batch="and b.entry_form in (0,36)";
	else if($batch_type==1)
	$search_field_cond_batch="and b.entry_form=0 ";
	else if($batch_type==2)
	$search_field_cond_batch="and b.entry_form=36";
	else if($batch_type==4)
	$search_field_cond_batch="and b.entry_form=136";
	else if($batch_type==5)
	$search_field_cond_batch="and b.batch_against=3";// sample
	else 
	$search_field_cond_batch="and b.entry_form in(0,36) and b.batch_against in(2) and  b.re_dyeing_from!=0 ";
	
	$search_field_cond_batch="";
	$con = connect();
	execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id." and ref_from in (1,2,3,4,5,6,7,8) and ENTRY_FORM=48");
	oci_commit($con);
	disconnect($con);
	
	if($txt_file_no!='' || $txt_ref_no!='' ||  $txt_po_no!='' || $txt_job!='' || $cbo_buyer_name>0)
	{
		
		if($batch_type==4) //Trim batch
		{
		 $sql_po="SELECT c.id as batch_id,a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b,pro_batch_create_mst c where a.id=b.job_id and b.job_no_mst=c.job_no  and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond";
		}
		else
		{
			$sql_po="SELECT a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b  where a.id=b.job_id and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond";
		}
		// echo $sql_po;die; 
		$res_po=sql_select($sql_po);
		$all_po_id='';
		foreach($res_po as $row) //$job_no_arr
		{			
			if($all_po_id=="") $all_po_id=$row[csf('id')]; else $all_po_id.=",".$row[csf('id')]; //echo $all_po_id;

			$po_idArr[$row[csf('id')]]=$row[csf('id')];
			$trim_batch_idArr[$row[csf('batch_id')]]=$row[csf('batch_id')];
		}
		//echo $all_po_id;
		
		//
		

		if($all_po_id!="") $po_idd="and po_id in($all_po_id)";else $po_idd="and po_id in(0)";
		
		$poIds=chop($all_po_id,','); $po_cond_for_in="";
		$po_ids=count(array_unique(explode(",",$all_po_id)));
		if($db_type==2 && $po_ids>1000)
		{
			$po_cond_for_in=" and (";
			$poIdsArr=array_chunk(explode(",",$poIds),999);
			foreach($poIdsArr as $ids)
			{
				$ids=implode(",",$ids);
				$po_cond_for_in.=" po_id in($ids) or"; 
			}
			$po_cond_for_in=chop($po_cond_for_in,'or ');
			$po_cond_for_in.=")";
		}
		else
		{
			$po_cond_for_in=" and po_id in($poIds)";
			
		}
		 fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 1, $po_idArr, $empty_arr);//PO ID Ref from=1
	    fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 2, $trim_batch_idArr, $empty_arr);//Batch ID Ref from=2
		
		if($batch_type==4) //Trim batch
		{
		 	//$po_cond_for_in='';
			//$po_cond_for_in=where_con_using_array($trim_batch_idArr,0,"mst_id");
			//echo "SELECT mst_id as batch_id from pro_batch_trims_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in";die;
		//	$sql_batch=sql_select("SELECT mst_id as batch_id from pro_batch_trims_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in");
		$sql_batch=sql_select("SELECT b.mst_id as batch_id from pro_batch_trims_dtls b,gbl_temp_engine g   where  b.mst_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=2 and g.entry_form=48 and b.status_active=1 and b.is_deleted=0 ");
		}
		else
		{
			//$sql_batch=sql_select("SELECT mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in");
			$sql_batch=sql_select("SELECT b.mst_id as batch_id from pro_batch_create_dtls b,gbl_temp_engine g  where   b.po_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=1 and g.entry_form=48  and b.status_active=1 and b.is_deleted=0  ");
		}
		//echo "SELECT mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in";die();
		 $all_batch_id='';
		foreach($sql_batch as $row) 
		{
			if($all_batch_id=="") $all_batch_id=$row[csf('batch_id')]; else $all_batch_id.=",".$row[csf('batch_id')];
		}
			$all_batch_ids=implode(",",array_unique(explode(",",$all_batch_id)));
		//echo $all_batch_ids; 
		$batch_ids_cond="";
		if($all_batch_ids!="") 
		{
			//echo $po_id=substr($po_id,0,-1);
			if($db_type==0) { $batch_ids_cond="and b.id in(".$all_batch_ids.")"; }
			else
			{
				$bat_id=array_unique(explode(",",$all_batch_ids));
				if(count($bat_id)>1000)
				{
					$batch_ids_cond="and (";
					$bat_id=array_chunk($bat_id,1000);
					$z=0;
					foreach($bat_id as $id)
					{
						$id=implode(",",$id);
						if($z==0) $batch_ids_cond.=" b.id in(".$id.")";
						else $batch_ids_cond.=" or b.id in(".$id.")";
						$z++;
					}
					$batch_ids_cond.=")";
				}
				else { 
				
				$batch_ids_cond=" and b.id in(".$all_batch_ids.")"; }
			}
		}
	}
	// print_r($batch_ids_cond);die;
	if($from_date!="" && $to_date!="")
	{
		$date_cond_samp="";
		if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond_samp=" and b.batch_date between '".$from_date."' and '".$to_date."'";
		}
	}


	/* ================================================================================ /
	/								Main query start here								/
	/ ================================================================================ */
	// $samp_non_booking=sql_select("SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	// from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $w_company_idcond3 $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
	$samp_non_booking=sql_select("SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no_id=a.id and a.booking_type=4  $company_idcond $w_company_idcond3 $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
	// echo "SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	// from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no_id=a.id and a.booking_type=4  $company_idcond $w_company_idcond3 $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";die;
	 
	 
 
	$all_batch_id_samp="";
	foreach($samp_non_booking as $row)
	{
		$non_buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$non_buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$sample_booking_ref_no_arr[$row[csf('booking_no')]]=$row[csf('grouping')];
		if($txt_samp_ref_no!='')
		{
		if($all_batch_id_samp=="") $all_batch_id_samp=$row[csf('batch_id')]; else $all_batch_id_samp.=",".$row[csf('batch_id')];
		}
	}
	if($all_batch_id_samp!="") $all_batch_id_samp_cond="and b.id in($all_batch_id_samp)";else $all_batch_id_samp_cond="";
	//echo $all_batch_id_samp_cond.'X';
	
    if($from_date!="")
    {
		if(str_replace("'","",$cbo_value_with)==1)
		{
			$date_cond=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";
		//and b.batch_against in(1,2,3)
			$sql=sql_select("SELECT b.id,a.batch_no,a.fabric_type,a.floor_id,b.booking_without_order,b.job_no,b.extention_no,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
			and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0  $company_idcond2 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond $floor_id_cond");
			 
			 
			
		}
		else if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond=" and b.batch_date between '".$from_date."' and '".$to_date."'";
			$sql=sql_select("SELECT b.id,b.batch_no,b.booking_without_order,b.job_no,b.extention_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
			from  pro_batch_create_mst b where   b.status_active=1 and b.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond ");
			
		}
   	}
   	else
   	{
		 
		 
		$sql=sql_select("SELECT a.floor_id,a.process_end_date as batch_date,b.id,b.booking_without_order,b.job_no,b.extention_no,b.batch_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
		from  pro_batch_create_mst b,pro_fab_subprocess a where  a.batch_id=b.id  and a.entry_form in (35,38) and a.load_unload_id=2 and b.status_active=1 and b.is_deleted=0 $company_idcond2 $batch_cond $batch_ids_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond $floor_id_cond");
		
		
	}
	 
	if(count($sql)==0)
    {
        ?>
        <div style="font-size:20px;color:red;text-align:center">Data not found!</div>
        <?
        die;
    }
  	// echo $sql;
  	// print_r($sql);die();
	/*$sub_batch_arr=array();$sub_party_arr=array(426,439,444,458,425,427,428,443,392,564,565,563); //Omit buyer ids
	foreach($sql as $row)
	{
			$entry_formId=$row[csf("entry_form")];
			if($entry_formId==36)
			{
				$sub_batch_arr[$row[csf("id")]]=$row[csf("id")];
			}
	}*/
	
	
//$buyer_library=return_library_array( "SELECT id,buyer_name from   lib_buyer", "id","buyer_name" );
  //  $batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.mst_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.mst_id", $re_dying_cond);
	/*if(count($sub_batch_arr))
	{
		$subBatch_id_cond=where_con_using_array($sub_batch_arr,0,"a.mst_id");
	$po_data_subcon=sql_select("SELECT a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0  $subBatch_id_cond");
	
	$sub_con_arr=array();
	foreach($po_data_subcon as $row)
	{
		if($sub_con_arr[$row[csf('mst_id')]][cust_style_ref]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref].=",".$row[csf('cust_style_ref')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref]=$row[csf('cust_style_ref')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][order_no]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no].=",".$row[csf('order_no')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no]=$row[csf('order_no')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][subcon_job]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job].=",".$row[csf('subcon_job')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job]=$row[csf('subcon_job')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][party_id]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id].=",".$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id].=",".$row[csf('party_id')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id]=$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id]=$row[csf('party_id')];	
		}
			$party_id=$row[csf('party_id')];
			if(in_array($party_id,$sub_party_arr) && $row[csf("party_id")]>0)
			{
				$sub_batch_chk_arr[$row[csf("mst_id")]]=$row[csf("mst_id")];
			}
	  }
	}*/
	
  	$reding_batch_id=$non_reding_batch_id=array();
    foreach($sql as $row)
	{
		//$sub_party_id_not=$sub_batch_chk_arr[$row[csf("id")]];
		
		$floor_id=$row[csf("floor_id")];
		$entry_formId=$row[csf("entry_form")];
		$batch_against_id=$row[csf("batch_against")];
		$batch_id_arr[]=$row[csf("id")];
		$batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
	
		
		//$batch_dying_floor_arr[$row[csf("floor_id")]]=$row[csf("floor_id")];
		//$prod_date_arr[$row[csf("batch_date")]]=$row[csf("batch_date")];
		
		
		  
		if($batch_against_id==1 || $batch_against_id==3)
		{		
			 
			// $batch_id_arr[]=$row[csf("id")]; 
			$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
			$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
			
			$batch_description_arr[$row[csf("id")]]['batch_weight']+=$row[csf("batch_weight")];
			
			$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
			$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_description_arr[$row[csf("id")]]['job_no']=$row[csf("job_no")];
			
			$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
			$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
			$batch_no_arr[]="'".$row[csf("batch_no")]."'";
			// $batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
			
			$batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			$batch_wise_arr[$row[csf("batch_no")]]['batch_no']=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['extention_no'].=$row[csf("extention_no")].',';
			$batch_ext_wise_arr[$row[csf("id")]]['extention_no']=$row[csf("extention_no")];
			
		}
		if($batch_against_id==2)
		{
			$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
			$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
			
			$batch_description_arr[$row[csf("id")]]['batch_weight']+=$row[csf("batch_weight")];
			
			$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
			$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_description_arr[$row[csf("id")]]['job_no']=$row[csf("job_no")];
			
			$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
			$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
			$batch_no_arr[]="'".$row[csf("batch_no")]."'";
			// $batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
			
			$batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			$batch_wise_arr[$row[csf("batch_no")]]['batch_no']=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['extention_no'].=$row[csf("extention_no")].',';
			$batch_ext_wise_arr[$row[csf("id")]]['extention_no']=$row[csf("extention_no")];
			$batch_ext_wise_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			
			
			
			$re_batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			
		}
		if($row[csf("batch_against")]==2)
		{
			/*if($row[csf("re_dyeing_from")]>0)
			{
				$reding_batch_id[$row[csf("re_dyeing_from")]]=$row[csf("re_dyeing_from")]; 
			}
			else
			{
				$reding_batch_id[$row[csf("id")]]=$row[csf("id")]; 
			}*/
			$reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
		else
		{
			$non_reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
	}
	
	
		//========**************Temp**************======================//
		fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 3, $batch_id_arr, $empty_arr);//Batch ID Ref from=3
	 
	   $sql_product=("SELECT a.floor_id,a.result,a.process_end_date as batch_date,b.id,b.booking_without_order,b.job_no,b.extention_no,b.batch_no,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from,b.total_trims_weight,c.batch_qnty
		from  pro_batch_create_mst b,pro_fab_subprocess a,pro_batch_create_dtls c where  a.batch_id=b.id and b.id=c.mst_id and a.batch_id=c.mst_id   and a.entry_form in (35,38)  and b.status_active=1 and a.load_unload_id=2 and b.is_deleted=0 and c.is_deleted=0 and a.is_deleted=0 $company_idcond2 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond 
		union
		SELECT a.floor_id,a.result,a.process_end_date as batch_date,b.id,b.booking_without_order,
		b.job_no,b.extention_no,b.batch_no,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,
		b.entry_form, b.batch_against, b.re_dyeing_from,b.total_trims_weight,c.trims_wgt_qnty as batch_qnty 
		from pro_batch_create_mst b,pro_fab_subprocess a,pro_batch_trims_dtls c 
		where a.batch_id=b.id and b.id=c.mst_id and a.batch_id=c.mst_id 
		and a.entry_form in (35,38)  and b.status_active=1 and a.load_unload_id=2
		and b.is_deleted=0 and c.is_deleted=0 and a.is_deleted=0  $company_idcond2 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch  $all_batch_id_samp_cond ");
		
		$sql_prod=sql_select($sql_product);$tot_self_trim_qty=0;$tot_self_trimqty=0;
		$production_qty=0;$sub_trims_wgt_check_array=array();$jj=1;$self_trims_wgt_check_array=array();$jk=1;
		 foreach($sql_prod as $row)
		 {
			//$prod_arr[$row[csf("batch_date")]][$row[csf("floor_id")]]['qty']+=$row[csf("production_qty")];
			//
			$issue_single_batch_arr[$row[csf("id")]]=$row[csf("id")]; 
			$batch_data_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_data_arr[$row[csf("id")]]['batch_against']=$row[csf("batch_against")];
		
			$batch_dying_floor_arr[$row[csf("floor_id")]]=$row[csf("floor_id")];
			//$prod_date_arr[$row[csf("batch_date")]]=$row[csf("batch_date")];
		 if($row[csf("entry_form")]==36 && $row[csf("batch_against")]==1 && $row[csf("result")]==1)
		 {
			
			 
			 $batch_noSub=$row[csf('id')];
			if (!in_array($batch_noSub,$sub_trims_wgt_check_array))
			{ $jj++;

				 $sub_trims_wgt_check_array[]=$batch_noSub;
				 $tot_trim_qty=$row[csf('total_trims_weight')];
			}
			else
			{
				 $tot_trim_qty=0;
			}
			
			//$total_trims_weight_qty+=$tot_trim_qty;
			
			// $subcon_prod_arr[$row[csf("id")]]['production_qty_subcontact']+=$row[csf("batch_qnty")];
			 if($total_trims_weight_qty>0)
			 {
			// $subcon_prod_arr[$row[csf("id")]]['subcon_trimsWgt']=$tot_trim_qty;
			 }
		 }
		 
		 if($row[csf("entry_form")]==0 && $row[csf("batch_against")]==1 && $row[csf("result")]==1)
		 {
			
			 
			 $batch_noSelf=$row[csf('id')];
			if (!in_array($batch_noSelf,$self_trims_wgt_check_array))
			{ $jk++;

				 $sub_trims_wgt_check_array[]=$batch_noSelf;
				 $tot_self_trim_qty=$row[csf('total_trims_weight')];
			}
			else
			{
				 $tot_self_trim_qty=0;
			}
			
			//$total_trims_weight_qty+=$tot_trim_qty;
			
			// $subcon_prod_arr[$row[csf("id")]]['production_qty_subcontact']+=$row[csf("batch_qnty")];
			 if($tot_self_trim_qty>0)
			 {
			 $selfTrim_prod_arr[$row[csf("id")]]['subcon_trimsWgt']=$tot_self_trim_qty;
			  $tot_self_trimqty+=$tot_self_trim_qty;
			 }
		 }
		 
			$prod_arr[$row[csf("id")]]['prod_qty']+=$row[csf("batch_qnty")];
			$prod_arr[$row[csf("id")]]['batch_qty']+=$row[csf("batch_qnty")];
		 
			$prod_arr[$row[csf("id")]]['floor_id']=$row[csf("floor_id")];
			$prod_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$prod_result_arr[$row[csf("id")]]['result']=$row[csf("result")];
			 
			$production_qty+=$row[csf("batch_qnty")]; 
			 
		 }
		// echo $tot_self_trimqty.'T';
		// $batch_cond_for_in=where_con_using_array($issue_single_batch_arr,0,"b.id");
		 
		 
		 
	    $sql_sub_product=("SELECT a.floor_id,a.result,a.process_end_date as batch_date,b.id,b.booking_without_order,b.job_no,b.extention_no,b.batch_no,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from,b.total_trims_weight,c.batch_qnty
		from  pro_batch_create_mst b,pro_fab_subprocess a,pro_batch_create_dtls c,subcon_ord_dtls d,subcon_ord_mst e where  a.batch_id=b.id and b.id=c.mst_id and a.batch_id=c.mst_id and c.po_id=d.id and  d.job_no_mst=e.subcon_job and a.entry_form in (38) and e.party_id not in(426,439,444,458,425,427,428,443,392,564,565,563) and b.status_active=1 and a.load_unload_id=2 and b.is_deleted=0 and c.is_deleted=0 and a.is_deleted=0 and d.status_active=1 and e.status_active=1 $company_idcond2 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond $floor_id_cond");//die;
		
		$sql_sub_prod=sql_select($sql_sub_product);//$tot_self_trim_qty=0;$tot_self_trimqty=0;
		$subcon_trims_wgt_check_array=array();$jjj=1;$jkk=1;
		 foreach($sql_sub_prod as $row)
		 {
			//$prod_arr[$row[csf("batch_date")]][$row[csf("floor_id")]]['qty']+=$row[csf("production_qty")];
			//
			$issue_single_batch_arr[$row[csf("id")]]=$row[csf("id")]; 
			$batch_data_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_data_arr[$row[csf("id")]]['batch_against']=$row[csf("batch_against")];
		
			$batch_dying_floor_arr[$row[csf("floor_id")]]=$row[csf("floor_id")];
			//$prod_date_arr[$row[csf("batch_date")]]=$row[csf("batch_date")];
		 if($row[csf("entry_form")]==36 && $row[csf("batch_against")]==1 && $row[csf("result")]==1)
		 {
			 $batch_noSubcon=$row[csf('id')];
			if (!in_array($batch_noSub,$subcon_trims_wgt_check_array))
			{ $jjj++;

				 $subcon_trims_wgt_check_array[]=$batch_noSubcon;
				 $tot_trim_qty=$row[csf('total_trims_weight')];
			}
			else
			{
				 $tot_trim_qty=0;
			}
			//$total_trims_weight_qty+=$tot_trim_qty;
			 $subcon_prod_arr[$row[csf("id")]]['production_qty_subcontact']+=$row[csf("batch_qnty")];
			 if($total_trims_weight_qty>0)
			 {
			 $subcon_prod_arr[$row[csf("id")]]['subcon_trimsWgt']=$tot_trim_qty;
			 }
		 }
		 unset($sql_sub_prod);
		 
		   $prod_arr[$row[csf("id")]]['prod_qty']+=$row[csf("batch_qnty")];
			$prod_arr[$row[csf("id")]]['batch_qty']+=$row[csf("batch_qnty")];
		 
			$prod_arr[$row[csf("id")]]['floor_id']=$row[csf("floor_id")];
			$prod_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$prod_result_arr[$row[csf("id")]]['result']=$row[csf("result")];
			 
			$production_qty+=$row[csf("batch_qnty")];
			 
		 }
		// echo $tot_self_trimqty.'T';
		// $batch_cond_for_in=where_con_using_array($issue_single_batch_arr,0,"b.id");
		  
		 
			$sql_qty = " (select b.working_company_id,b.company_id,b.id,b.batch_no,b.total_trims_weight,
			sum(case when a.service_source=1 then  b.batch_weight end) as batch_weight,
			SUM(case when a.service_source=1 and b.batch_against!=3 and c.is_sales!=1 then c.batch_qnty end) AS production_qty_inhouse,
			SUM(case when a.service_source=3 then c.batch_qnty end) AS production_qty_outbound,
			SUM(case WHEN b.batch_against=3 and b.booking_without_order=1 and b.is_sales!=1  then c.batch_qnty end) AS prod_qty_sample_without_order,
			SUM(case WHEN b.batch_against=3 and b.booking_without_order=0 and c.is_sales!=1  then c.batch_qnty end) AS prod_qty_sample_with_order,
			SUM(case WHEN c.is_sales=1 then c.batch_qnty end) AS fabric_sales_order_qty
			from pro_batch_create_dtls c, wo_po_break_down e, wo_po_details_master d, pro_fab_subprocess a,
			 lib_machine_name g, pro_batch_create_mst b 
			where a.batch_id=b.id and b.entry_form=0 and g.id=a.machine_id and b.id=c.mst_id and a.batch_id=c.mst_id and a.entry_form=35 and a.load_unload_id=2 and b.batch_against in(1)  and c.po_id=e.id and d.job_no=e.job_no_mst and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and  c.status_active=1 and c.is_deleted=0  and a.result=1  $company_idcond2 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond $floor_id_cond
			group by b.working_company_id,b.company_id,b.id,b.batch_no,b.total_trims_weight)
			union  
			( select b.working_company_id,b.company_id,b.id,b.batch_no,b.total_trims_weight,
			sum(case when a.service_source=1 then  b.batch_weight end) as batch_weight,
			SUM(case when a.service_source=1 and b.batch_against in(1) and c.is_sales!=1  then c.batch_qnty end) AS production_qty_inhouse,
			SUM(case when a.service_source=3 then c.batch_qnty end) AS production_qty_outbound,
			SUM(case WHEN b.batch_against=3 and b.booking_without_order=1 and c.is_sales!=1 then c.batch_qnty end) AS prod_qty_sample_without_order,
			SUM(case WHEN b.batch_against=3 and b.booking_without_order=0 and c.is_sales!=1 then c.batch_qnty end) AS prod_qty_sample_with_order,
			SUM(case WHEN c.is_sales=1 then c.batch_qnty end) AS fabric_sales_order_qty
			from pro_batch_create_dtls c, pro_batch_create_mst b, pro_fab_subprocess a, lib_machine_name g,wo_non_ord_samp_booking_mst h
			where  h.booking_no=b.booking_no and a.batch_id=b.id and a.batch_id=c.mst_id and b.entry_form=0 and g.id=a.machine_id and b.id=c.mst_id and a.entry_form=35 and a.load_unload_id=2  and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0  and  c.status_active=1 and c.is_deleted=0  and a.result=1  $company_idcond2 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond $floor_id_cond
			group by b.id,b.working_company_id,b.company_id,b.batch_no,b.total_trims_weight ) 
			union
			(select b.working_company_id,b.company_id,b.id,b.batch_no, SUM(c.trims_wgt_qnty) AS total_trims_weight, 0 as batch_weight, 0 AS production_qty_inhouse, 0 AS production_qty_outbound, 0 AS prod_qty_sample_without_order, 0 AS prod_qty_sample_with_order, 0 AS fabric_sales_order_qty
			from pro_batch_create_mst b,pro_batch_trims_dtls c, wo_po_details_master d, pro_fab_subprocess a, lib_machine_name g 
			where a.batch_id=b.id and b.id=c.mst_id and a.batch_id=c.mst_id and g.id=a.machine_id and d.job_no=b.job_no and b.entry_form=136 and a.entry_form=35 and a.load_unload_id=2 and b.batch_against in(1) and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and a.result=1 and c.status_active=1 and c.is_deleted=0  $company_idcond2 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond $floor_id_cond 
			GROUP BY b.working_company_id,b.company_id,b.id,b.batch_no) ";

			//echo $sql_qty;
			$sql_result=sql_select( $sql_qty);

		//$fabric_sales_order_qty=0;
		$total_trims_weight_qty=0;
		$j=1;$self_trims_wgt_check_array=array();
		foreach($sql_result as $row)
		{
			//$production_qty_inhouse+=$row[csf('production_qty_inhouse')];
			//$production_qty_outbound+=$row[csf('production_qty_outbound')];
			//$prod_qty_sample_without_order+=$row[csf('prod_qty_sample_without_order')];
			//$prod_qty_sample_with_order+=$row[csf('prod_qty_sample_with_order')];
			//$fabric_sales_order_qty+=$row[csf('fabric_sales_order_qty')];
			$batch_noSelf=$row[csf('id')];
			if (!in_array($batch_noSelf,$self_trims_wgt_check_array))
			{ 
				$j++;

				$self_trims_wgt_check_array[]=$batch_noSelf;
				$tot_trim_qty=$row[csf('total_trims_weight')];
			}
			else
			{
				$tot_trim_qty=0;
			}
			$issue_single_batch_arr[$row[csf("id")]]=$row[csf("id")]; 
			
			// $prod_arr[$row[csf("id")]]['batch_date']=$row[csf("process_end_date")];
			
			$total_trims_weight_qty+=$tot_trim_qty;
			$tot_sample=$row[csf("prod_qty_sample_without_order")]+$row[csf('prod_qty_sample_with_order')];
			$prod_arr2[$row[csf("id")]]['self_batch_qty']+=$row[csf("production_qty_inhouse")]+$row[csf('production_qty_outbound')];
			if($tot_sample>0)
			{
				// echo $tot_sample.',';
			$prod_arr2[$row[csf("id")]]['sample_batch_qty']+=$tot_sample;
			}
			$prod_arr2[$row[csf("id")]]['fabric_sales_order_qty']+=$row[csf("fabric_sales_order_qty")];
			$prod_arr2[$row[csf("id")]]['tot_trim_qty']+=$tot_trim_qty;
			$prod_TrimsArr[$row[csf("id")]]=$tot_trim_qty;
			
		}
	//	echo array_sum($prod_arr3);
		
	       //echo $total_trims_weight_qty.'D'; 
	  //  echo "<pre>"; print_r($prod_arr3);   

//die;

	//	********************************************************************************************************************************
     $batch_id_sql=implode(",",$batch_id_arr);
    if($batch_id_sql=="") $batch_id_sql=0;
	//echo  $batch_id_sql;
  	if($batch_type==3)
	{
		//$re_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond2=chop($re_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond2.=")";
		}
	}
	else
	{
		//$re_dying_cond=" and b.re_dyeing_from in(".$batch_id_sql.")";	
		//$pord_ids = explode(",",$txt_product_id);
		//echo count($pord_ids);die;
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond=chop($re_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond.=")";
		}
	}

	$date_cond2=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";

	// =============================================================
	$batch_all_id_array=array();
	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
	//   $sql = "SELECT a.ID,b.mst_id as REQ_ID,a.batch_id as BATCH_ID,a.BATCH_QTY,a.BATCH_QTY,a.NEW_BATCH_WEIGHT,a.ENTRY_FORM,c.batch_id as RE_BATCH_ID from pro_recipe_entry_mst a, dyes_chem_requ_recipe_att b,dyes_chem_issue_requ_mst c where b.recipe_id=a.id  and c.id=b.mst_id $batch_id_conds and a.status_active=1 and a.is_deleted=0 and b.status_active=1 ";
	$sql = "SELECT a.ID,b.mst_id as REQ_ID,a.batch_id as BATCH_ID,a.BATCH_QTY,a.BATCH_QTY,a.NEW_BATCH_WEIGHT,a.ENTRY_FORM,c.batch_id as RE_BATCH_ID from pro_recipe_entry_mst a, dyes_chem_requ_recipe_att b,dyes_chem_issue_requ_mst c,gbl_temp_engine g where b.recipe_id=a.id  and c.id=b.mst_id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 ";
	 // echo $sql;die; 
	$res = sql_select($sql);
	$req_id_array = array();
	foreach ($res as $val) 
	{
		//$req_id_array2[$val['REQ_ID']] .= $val['REQ_ID'].',';
		$req_id_array[$val['REQ_ID']] = $val['REQ_ID'];
		//$batch_req_id_array[$val['BATCH_ID']].= $val['REQ_ID'].',';
		$batch_req_id_array2[$val['BATCH_ID']]= $val['REQ_ID'];
		$batch_all_id_array[$val['BATCH_ID']]= $val['BATCH_ID'];
		//if($batchWgtChkk[$val['REQ_ID']]=='')
		//{
			if($val['ENTRY_FORM']==60) //Adding Topping
			{
				$batch_wgt=$val['NEW_BATCH_WEIGHT'];
			}
			else
			{
				$batch_wgt=$val['BATCH_QTY'];
			}
		//$batch_wgt_array[$val['REQ_ID']] += $batch_wgt;
		$batch_wgt_array[$val['BATCH_ID']] = $batch_wgt;
		$batchWgtChkk[$val['REQ_ID']].=$val['BATCH_ID'].',';
		
		$batchIdChkkDtls[$val['REQ_ID']]=$val['BATCH_ID'];
		//}
		
	}
	unset($res);
	// print_r($req_id_array2);die;
	// $requisition_ids = implode(",", $req_id_array);
	
	 
	if(count($req_id_array))
	{
		//$requisition_id_cond=where_con_using_array($req_id_array,0,"a.requisition_no");
	}
	 fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 4, $req_id_array, $empty_arr);//Req ID Ref from=4

	// $issue_sql = sql_select("SELECT a.MST_ID ,a.REQUISITION_NO,b.BATCH_NO,a.ITEM_CATEGORY,a.PROD_ID,a.CONS_QUANTITY,a.CONS_AMOUNT from inv_transaction a,inv_issue_master b where a.mst_id=b.id and b.entry_form=5 and b.is_deleted=0 and b.status_active=1 and a.status_active=1 and a.transaction_type=2 $requisition_id_cond   ");//$w_company_idcond2
	$issue_sql = sql_select("SELECT a.MST_ID ,a.REQUISITION_NO,b.BATCH_NO,a.ITEM_CATEGORY,a.PROD_ID,a.CONS_QUANTITY,a.CONS_AMOUNT from inv_transaction a,inv_issue_master b,gbl_temp_engine g where a.mst_id=b.id and a.REQUISITION_NO=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=4 and g.entry_form=48 and b.entry_form=5 and b.is_deleted=0 and b.status_active=1 and a.status_active=1 and a.transaction_type=2    ");
	   
	 
	$issue_id_arr = array();$tot_issueQty=0;  

	foreach ($issue_sql as $val) 
	{
		 
		$batchArr=array_filter(array_unique(explode(",",$val['BATCH_NO'])));
		foreach($batchArr as $bid)
		{
			$issue_item_cat_arr[$bid][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['ITEM_CATEGORY'];
			if($bid!='')
			{
			$batch_all_id_array[$bid]= $bid;
			$batch_req_id_array[$bid].= $val['REQUISITION_NO'].',';
			}
		}
			$issue_item_cat_cost_arr[$val['REQUISITION_NO']][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['CONS_QUANTITY'];
			$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_QUANTITY'];
			
			$issue_item_cat_amt_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_AMOUNT'];
		
		 $ReqBatch_id_arr[$val['REQUISITION_NO']] = $val['BATCH_NO'];
		$issue_id_arr[$val['MST_ID']] = $val['MST_ID'];
		$tot_issueQty+=$val['CONS_QUANTITY'];
		
	}
	// echo count($batch_all_id_array);die;
	if(count($batch_all_id_array))
	{
		//$batch_ids_cond=where_con_using_array($batch_all_id_array,0,"b.id");
	}
	fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 5, $batch_all_id_array, $empty_arr);//Batch ID Ref from=5
	$batch_fabric_sql=sql_select("SELECT b.id,b.batch_no,b.batch_weight,b.total_trims_weight, b.batch_against
	from pro_recipe_entry_mst  a,pro_batch_create_mst b,gbl_temp_engine g where  a.batch_id=b.id and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=5 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0" );
	// $batch_fabric_sql=sql_select("SELECT b.id,b.batch_no,b.batch_weight,b.total_trims_weight, b.batch_against
	// from pro_recipe_entry_mst  a,pro_batch_create_mst b  where  a.batch_id=b.id 
	//  and a.status_active=1 and a.is_deleted=0 $batch_ids_cond group by  b.id,b.batch_no,b.batch_weight,b.total_trims_weight, b.batch_against" );
	
	 foreach ($batch_fabric_sql as $row) 
	{
		//$batch_req_id=$batch_req_id_array2[$row[csf("id")]];
		//echo $batch_req_id.'d';
		$batch_wgt_arr[$row[csf("id")]]['batchWgt']=$row[csf("batch_weight")];
		if($row[csf("total_trims_weight")]>0)
		{
			$batch_wgt_arr[$row[csf("id")]]['trims_weight']=$row[csf("total_trims_weight")]; 
			
			//echo $row[csf("total_trims_weight")].','; 
		}
	}
	//========+++++=Re Calculation++++++++++++========
	//echo $tot_issueQty.'D';
	// echo "<pre>";print_r($batch_req_id_array);die;
	// =====================================================================================
	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "b.id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "b.id", $re_dying_cond);
	// $fabric_sql=sql_select("SELECT b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
	// from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
	// and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 $company_idcond $batch_id_conds");
	// $fabric_sql=sql_select("SELECT b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
	// from pro_fab_subprocess  a,pro_batch_create_mst b,gbl_temp_engine g  where  a.batch_id=b.id  and b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 
	// and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 $company_idcond");
	 	
  	// $fabric_type_arr=array();
    // foreach($fabric_sql as $row)
	// {
	//  	$fabric_type_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
	// }
	// ========================================================================================
//$issue_single_batch_arr[$row[csf("id")]]
//$batch_idCond1 = where_con_using_array($issue_single_batch_arr,0,"a.batch_id");
fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 48, 6, $issue_single_batch_arr, $empty_arr);//S Batch ID Ref from=6
	$floor_cond_arr=array();
	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
	if(!empty($location_id))
	{
		if(!empty($floor_id))
		{
			$sql="SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b,gbl_temp_engine g   where a.floor_id=b.id  and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=6 and g.entry_form=48 and a.entry_form in(35,38) and b.status_active=1 and b.is_deleted=0  and b.location_id=$location_id and b.production_process=3 and b.id=$floor_id ";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) 
			{
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		else
		{
			// $sql="SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form in(35,38) and b.status_active=1 and b.is_deleted=0  and b.location_id=$location_id and b.production_process=3 $batch_idCond1";
			$sql="SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b,gbl_temp_engine g  where a.floor_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=6 and g.entry_form=48 and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0  and b.location_id=$location_id and b.production_process=3 ";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) {
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		$floor_cond_arr=array_unique($floor_cond_arr);
	}
	 // print_r($floor_cond_arr);die();
	// ==========================================================================
	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
	// $floor_arr=return_library_array("SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 $batch_id_conds", "batch_id", "floor_name" );
	$floor_arr=return_library_array("SELECT  b.id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b,gbl_temp_engine g  where a.floor_id=b.id and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.entry_form in(38,35) and b.status_active=1 and b.is_deleted=0 ", "id", "floor_name" );

	 
   
	//$floor_arr=return_library_array("SELECT  b.id ,b.floor_name from    lib_prod_floor b  where  b.status_active=1 and b.is_deleted=0 ", "id", "floor_name" );

	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "c.id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "c.id", $re_dying_cond);
	// $sql_book=sql_select("SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c where a.buyer_id=b.id and a.id=c.booking_no_id $batch_id_conds");
	$sql_book=sql_select("SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c,gbl_temp_engine g where a.buyer_id=b.id and a.id=c.booking_no_id and c.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 ");
	 
	$po_id_arr = array();
	foreach($sql_book as $row)
	{
		$buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		
		if($row[csf('po_break_down_id')])
		{
		$po_id_arr[$row[csf('po_break_down_id')]]=$row[csf('po_break_down_id')];
		$po_break_down_id_arr[$row[csf('booking_no')]]=$row[csf('po_break_down_id')];
		}
	}

	// =========================================================
	// $poIdss = implode(",", $po_id_arr);
	if(count($po_id_arr))
	{
		//$po_id_cond = where_con_using_array($po_id_arr,0,"b.id");
	}
	// echo $poIdCond;die();
	/*$sql_po="SELECT a.style_ref_no,a.buyer_name,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b  where a.id=b.job_id and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond $po_id_cond";
	// echo $sql_po;die(); 
	$res_po=sql_select($sql_po);
	$all_po_id='';
	foreach($res_po as $row) //$job_no_arr
	{
		$po_number_arr[$row[csf('id')]]['po_no']=$row[csf('po_number')];
		$po_number_arr[$row[csf('id')]]['ref_no']=$row[csf('ref_no')];
		$po_number_arr[$row[csf('id')]]['file_no']=$row[csf('file_no')]; 
		$po_number_arr[$row[csf('id')]]['season']=$row[csf('season_buyer_wise')]; 
		$po_number_arr[$row[csf('id')]]['job']=$row[csf('job_no_mst')];
		$job_no_arr[$row[csf('id')]]=$row[csf('job_no_mst')];
		$style_library[$row[csf('job_no_mst')]]=$row[csf('style_ref_no')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['buyer']=$row[csf('buyer_name')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['season']=$row[csf('season_buyer_wise')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['style']=$row[csf('style_ref_no')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['po_number'].=$row[csf('po_number')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['ref_no'].=$row[csf('ref_no')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['file_no'].=$row[csf('file_no')].',';
	}*/

	
    $buyer_library=return_library_array( "SELECT id,buyer_name from   lib_buyer", "id","buyer_name" );
   // $style_library=return_library_array( "SELECT job_no,style_ref_no from   wo_po_details_master", "job_no","style_ref_no" );
    $batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.mst_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.mst_id", $re_dying_cond);
	// $po_data_subcon=sql_select("SELECT a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	// subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0  $batch_id_conds");
	$po_data_subcon=sql_select("SELECT a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	subcon_ord_mst c,gbl_temp_engine g where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.mst_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.status_active=1 and a.is_deleted=0  ");
	
	$sub_con_arr=array();
	foreach($po_data_subcon as $row)
	{
		if($sub_con_arr[$row[csf('mst_id')]][cust_style_ref]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref].=",".$row[csf('cust_style_ref')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref]=$row[csf('cust_style_ref')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][order_no]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no].=",".$row[csf('order_no')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no]=$row[csf('order_no')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][subcon_job]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job].=",".$row[csf('subcon_job')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job]=$row[csf('subcon_job')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][party_id]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id].=",".$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id].=",".$row[csf('party_id')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id]=$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id]=$row[csf('party_id')];	
		}
	} 
	//print_r($sub_con_arr[646]);die;
	// ==================================================================================

	if($db_type==0)
	{
		if($batch_type==3)
		{
		 $sql_redying=sql_select("SELECT b.id as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0 group by  b.id");
		}
		else
		{
			 $sql_redying=sql_select("SELECT group_concat(b.id) as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0  $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0 group by  b.re_dyeing_from");	
		}
	}
	else
	{
	
		if($batch_type==3)
		{	
			//  $sql_redying=sql_select("SELECT b.id as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no
			//   from  pro_batch_create_mst  b 
			//   where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0  group by  b.id");
			$sql_redying=sql_select("SELECT b.id as id, b.batch_date as batch_date, b.extention_no as extention_no
			from  pro_batch_create_mst  b ,gbl_temp_engine g
			where  b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and b.re_dyeing_from!=0 $company_idcond  and b.status_active=1 and b.is_deleted=0  ");
		}
		else
		{
			//  $sql_redying=sql_select("SELECT listagg((b.id),',') within group (order by b.id) as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no,b.re_dyeing_from 
			//  from  pro_batch_create_mst b 
			//  where b.re_dyeing_from!=0   $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0  group by  b.re_dyeing_from");
			$sql_redying=sql_select("SELECT  b.id as id, b.batch_date as batch_date, b.extention_no as extention_no,b.re_dyeing_from 
			from  pro_batch_create_mst b ,gbl_temp_engine g
			where  b.id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and b.re_dyeing_from!=0   $company_idcond  and b.status_active=1 and b.is_deleted=0  ");
		}
	}
	
   	//and b.batch_against=2
    $redying_details_arr=array();
    foreach($sql_redying as $re_row)
    {
		if($batch_type==3)
		{
			$redying_details_arr[$re_row[csf("id")]]['id'].=$re_row[csf("id")].',';
			$redying_details_arr[$re_row[csf("id")]]['batch_date'].=$re_row[csf("batch_date")].',';
			$redying_details_arr[$re_row[csf("id")]]['extention_no'].=$re_row[csf("extention_no")].',';
		}
		else
		{
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['id'].=$re_row[csf("id")].',';
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['batch_date'].=$re_row[csf("batch_date")].',';
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['extention_no'].=$re_row[csf("extention_no")].',';
		}
    }
	
	//echo "<pre>"; print_r($redying_details_arr);die;
	if($batch_type==3)
	{
		//$all_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$all_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$all_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$all_dying_cond2=chop($all_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$all_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$all_dying_cond2.=")";
		}
	}
	else
	{
		if(count($batch_id_arr)>0)
		{
			$all_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$all_dying_cond.=" b.id in(".implode(",",$batch_id).") or";
				}
				$all_dying_cond=chop($all_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$all_dying_cond.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$all_dying_cond.=")";
		}
	}
	
	if($batch_type==3)
	{
		// $result_sql=sql_select("SELECT a.result,a.batch_id 
		// from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2   $company_idcond $all_dying_cond2 and a.status_active=1 and a.is_deleted=0");
		$result_sql=sql_select("SELECT a.result,a.batch_id,a.fabric_type
		from pro_fab_subprocess a, pro_batch_create_mst b,gbl_temp_engine g where b.id=a.batch_id and b.id=g.ref_val and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48  and a.entry_form in (35,38) and a.load_unload_id=2   $company_idcond  and a.status_active=1 and a.is_deleted=0");		
	}
	else
	{
		// $result_sql=sql_select("SELECT a.result,a.batch_id 
		// from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2  $company_idcond $all_dying_cond and a.status_active=1 and a.is_deleted=0");
		$result_sql=sql_select("SELECT a.result,a.batch_id,a.fabric_type
		from pro_fab_subprocess a, pro_batch_create_mst b,gbl_temp_engine g where b.id=a.batch_id and b.id=g.ref_val and a.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and a.entry_form in (35,38) and a.load_unload_id=2  $company_idcond  and a.status_active=1 and a.is_deleted=0");
	}
	
	/*$sql_result=sql_select("select a.result,a.batch_id from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2  and a.company_id=$cbo_company_name and b.re_dyeing_from in (".$batch_id_sql.") and a.status_active=1 and a.is_deleted=0");*/
	
	$result_arr=array();
	foreach($result_sql as $value)
	{
		$result_arr[$value[csf('batch_id')]]=$value[csf('result')];	
		$fabric_type_arr[$value[csf("batch_id")]]['fabric_type']=$value[csf("fabric_type")];
	}
	
	// print_r($issue_single_batch_arr); echo "Test";die;
	
	// ====================================== batch wise cost =====================================
	$batchIdArr = array();
	foreach(array_unique($issue_single_batch_arr) as $b_id)
	{
		$batchIdArr[$b_id] = $b_id;
	}
	
	//$batchCond=where_con_using_array($batchIdArr,0,"c.id");

	// print_r($batchIdArr);die();
	// echo $company_id;die();
	$company_cond = str_replace("a.company_id", "c.company_id", $company_id);	
	if ($cbo_working_name==0) $wo_company_idcond =""; else $wo_company_idcond =" and p.working_company_id='$cbo_working_name'";

	// $batchCond = implode(",", $batchIdArr);
	   $sql = "(SELECT p.id as recipe_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,a.avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, a.id, a.item_category_id, a.item_group_id, a.sub_group_name, a.item_description, a.item_size,a.current_stock, a.unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
		from pro_recipe_entry_mst p, product_details_master a, pro_recipe_entry_dtls b,pro_batch_create_mst c ,gbl_temp_engine g  
		where p.id=b.mst_id and a.id=b.prod_id and p.batch_id=c.id  and c.id=g.ref_val  and p.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48 and b.ratio>0  and b.status_active=1 and b.is_deleted=0 $company_cond $wo_company_idcond and a.item_category_id in(5,6,7,23) and a.status_active=1 and a.is_deleted=0  and p.entry_form in(59,60)) 
		union 
		(
		SELECT p.id as recipe_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,0 as avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, b.prod_id as id, null as item_category_id, null as item_group_id, null as sub_group_name, null as item_description, null as item_size,null as current_stock, null as unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
			from pro_recipe_entry_mst p, pro_recipe_entry_dtls b,pro_batch_create_mst c ,gbl_temp_engine g  
			where p.id=b.mst_id and p.batch_id=c.id and c.id=g.ref_val   and p.batch_id=g.ref_val  and g.user_id = ".$user_id." and g.ref_from=3 and g.entry_form=48  and b.status_active=1 and b.is_deleted=0 $wo_company_idcond  and b.status_active=1 and b.is_deleted=0 and b.prod_id=0 and b.sub_process_id in(93,94,95,96,97,98) and p.status_active=1 and p.is_deleted=0  and p.entry_form in(59,60))  order by sub_seq,seq_no";
	// echo $sql;//die();
	$costDataArr = array(); 
	$res = sql_select($sql);
	$tot_recCost=0;$tot_issue_qty=0;
	foreach ($res as $row) 
	{
		$current_stock = $row[csf('current_stock')];
		$recipe_type = $row[csf('recipe_type')];
		$surplus_solution = $row[csf('surplus_solution')];
		$pickup = $row[csf('pickup')];
		$batch_wgt = $row[csf('batch_qty')];//pickup,p.batch_qty
		 
		$batch_req_id=rtrim($batch_req_id_array[$row[csf('batch_id')]],',');
		$batch_req_idArr=array_unique(explode(",",$batch_req_id_array[$row[csf('batch_id')]]));
		//echo $batch_req_id.'D';
		$tot_batch_wgt=$batch_wgt_array[$row[csf('batch_id')]];
		//echo  $tot_batch_wgt.'D';
		$batch_qty=$row[csf('batch_qty')];
		if($issue_item_cat_arr[$row[csf('batch_id')]][$row[csf('prod_id')]][$row[csf('item_category_id')]])
		{
			//echo $recipe_qnty.'='.$row[csf('avg_rate_per_unit')].'<br>';
			//$issue_qty=0;
			foreach($batch_req_idArr as $req_id)
			{
				if($issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=='')
				{	
					$issue_qty+=$issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
					//$reqIdArr[$req_id]=$req_id;
				
					$tot_issue_qty+=$issue_qty;
					$issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=111;
				 	//	echo "SDDD";
				}
				
			}
			//$issue_qty=$issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
			$issue_perKg=($issue_qty/$tot_batch_wgt);
			$issue_wgt_per=$issue_perKg*$batch_qty;
		//	echo $tot_batch_wgt.'='.$issue_qty.'='.$issue_wgt_per.'='.$issue_wgt_per*$row[csf('avg_rate_per_unit')].'<br>';
		$costDataArr[$row[csf('batch_id')]][$row[csf('item_category_id')]] +=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
			//echo "AA";
		$ReqIdArr[$row[csf('batch_id')]].=$batch_req_id.',';
		//$recipe_qnty*$row[csf('avg_rate_per_unit')];
		$categryDataArr[$row[csf('batch_id')]].=$row[csf('item_category_id')].',';
		$tot_recCost+=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
		}
	}
	//echo implode(",",$reqIdArr);die;
	//echo $tot_issue_qty.'Dx'.'='.$tot_recCost;
	// echo "<pre>";print_r($costDataArr);
	$con = connect();
	execute_query("DELETE FROM GBL_TEMP_ENGINE WHERE USER_ID = ".$user_id." and ref_from in (1,2,3,4,5,6,7,8) and ENTRY_FORM=48");
	oci_commit($con);
	disconnect($con);
	$i=1;$j=1;
	ob_start();	
	?>
	<div id="" align="center" style="height:auto; width:auto; margin:0 auto; padding:0;">
		<? $summaryHTML='<div id="summary_part" style="width:1460px;">
        <table width="2060px" cellpadding="0" cellspacing="0" id="caption" align="center">
            <thead>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:16px; font-weight:bold" >'.$report_title.'</td 
                ></tr>
                <tr style="border:none;">
                    <td colspan="24" class="form_caption" align="center" style="border:none; font-size:14px;">
                       <b>Company Name : '.$companyArr[$company_ids].'</b>                               
                    </td>
                </tr>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:12px; font-weight:bold">
					'."Date: ". change_date_format($from_date).' To '. change_date_format($to_date).'
					</td>
                </tr>
            </thead>
        </table>
       	 
    	</div>';?>
    	<? echo $summaryHTML;
	
					 $batch_id_cond_for_in=where_con_using_array($issue_single_batch_arr,0,"b.id");
					$sales_data = sql_select("SELECT b.id as batch_id,a.id,a.job_no,a.sales_booking_no,a.within_group,b.batch_weight,a.buyer_id,a.style_ref_no, a.po_buyer from fabric_sales_order_mst a,pro_batch_create_mst b where a.id=b.sales_order_id and a.status_active=1  and b.status_active=1  $batch_id_cond_for_in");
					 
					foreach ($sales_data as $row)
					{
						$sales_batch_arr[$row[csf('batch_id')]]=$row[csf('job_no')];
						
						 
						$sales_batchQty_Arr[$row[csf('batch_id')]]['batch_weight']=$row[csf('batch_weight')];
						
					}
					unset($sales_data);
					
					$tot_main_batch_weight=0;$prod_dateCostArr=array();
					$prod_dateArr=array();$prod_date_arr=array();$totselfTrimQty=0;
			       	foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						//if(in_array($b_id, $floor_cond_arr) || empty($location_id)) 
						//{
							//batch_description_arr  
							if($batch_description_arr[$b_id][entry_form]==36)
			                {
			                	$buyerName=implode(", ",array_unique(explode(",",$sub_con_id_arr[$b_id][party_id])));
			                }
							else if($batch_description_arr[$b_id][entry_form]==136) //Trims batch
			                {
			                	$job_no=$batch_description_arr[$b_id][job_no];
								$buyerName=$trim_batch_job_arr[$job_no]['buyer'];
								//$po_number=$trim_batch_job_arr[$job_no]['po_number']; 
								//$buyerName=implode(", ",array_unique(explode(",",$sub_con_id_arr[$b_id][party_id])));
			                }
			                else
			                {
				                if($batch_description_arr[$b_id]["without_order"]==1) 
				                $buyerName=$non_buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
				                else $buyerName=$buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
			                }
							$result_id=$prod_result_arr[$b_id]['result'];
							if($result_id==1)
							{
							$prodQty=$batch_description_arr[$b_id]["batch_weight"];
							 
							$production_qty_subcontact= $subcon_prod_arr[$b_id]['production_qty_subcontact'];
							$subcon_trimsWgt= $subcon_prod_arr[$b_id]['subcon_trimsWgt'];//$subcon_prod_arr[$row[csf("id")]]['subcon_trimsWgt']
							 
							$batch_qty=$prod_arr[$b_id]['batch_qty'];//$prod_arr[$b_id]['prod_qty'];
							//echo $production_qty_subcontact.'<br>';
							}
							$floor_id=$prod_arr[$b_id]['floor_id'];
							$prodDate=$prod_arr[$b_id]['batch_date'];
							//echo $prodDate.'=='.$floor_id.'<br>';
							//echo strtotime($prodDate).', ';   
							if(strtotime($prodDate)>0)
							{
							$prod_date_arr[$prodDate]=$prodDate;
							$trims_weight=$batch_wgt_arr[$b_id]['trims_weight'];
							}
							
							$entry_formId=$batch_data_arr[$b_id]['entry_form'];
							$batch_againstId=$batch_data_arr[$b_id]['batch_against'];
						 // echo $entry_formId.', ';
						$sales_no=$sales_batch_arr[$b_id];
						//echo $sales_no.'ds';
						if($sales_no!="")
						{
							$sales_batch_weight=$sales_batchQty_Arr[$b_id]['batch_weight'];
						//	echo $sales_batch_weight;
							$prod_dateArr[$prodDate][$floor_id]['sales_batch_weight']+=$sales_batch_weight;
						}
						
							$prod_dateArr[$prodDate][$floor_id]['selfQty']+=$prodQty;
							
							
							 $prod_dateArr[$prodDate][$floor_id]['selfBatchQty']+=$prod_arr2[$b_id]['self_batch_qty'];//$batch_qty;	
							
								//$prod_dateArr[$prodDate][$floor_id]['subconQty']+=$prodQty;	
								if($production_qty_subcontact>0)
								{
									//echo $production_qty_subcontact.'<br>';
								$prod_dateArr[$prodDate][$floor_id]['subconBatchQty']+=$production_qty_subcontact;
								}
							
								$prod_dateArr[$prodDate][$floor_id]['sampleQty']+=$prodQty;//$prod_arr2[$row[csf("id")]]['sample_batch_qty']
								$prod_dateArr[$prodDate][$floor_id]['sampleBatchQty']+=$prod_arr2[$b_id]['sample_batch_qty'];;	
							
								 
								$prod_dateArr[$prodDate][$floor_id]['trimsQty']+=$prodQty;
								$prod_dateArr[$prodDate][$floor_id]['trimsBatchQty']+=$batch_qty+$trims_weight;	
							
							 //$prod_arr3[$row[csf("id")]]['tot_trim_batch_qty']
							 if($batch_againstId==1)
							 {
							$prod_dateTrimArr[$prodDate][$floor_id]['trimsBatchQty']+=$prod_TrimsArr[$b_id]+$subcon_trimsWgt;
							 }
							 
							
							
							
							$ReqId=rtrim($ReqIdArr[$b_id],',');
							$sum_ReqIdsArr=array_unique(explode(",",$ReqId));
			                $first_chemi_cost=$first_dyeing_cost=0;
			               
			                    $sum_issue_amt_deys=0;$sum_issue_amt_chemical=0;
								$batch_weight=$batch_description_arr[$b_id]["batch_weight"];
								$sum_batchIdArr='';$tot_sum_chemical_cost=$tot_sum_deys_cost=0;
									foreach($sum_ReqIdsArr as $reqId)
									{
										
										$sum_issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										$sum_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
									   $batch_idsAll=$ReqBatch_id_arr[$reqId]; 
										$sum_batchIds=rtrim($batch_idsAll,',');
										$sumbatIdArr=array_unique(explode(",",$sum_batchIds)); 
										$sum_tot_batch_wgt=0;
										foreach($sumbatIdArr as $batchId)
										{
										//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
										//echo $batch_wgt_arr[$batchId]['batchWgt'].'p';
										$sum_tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt']; 
										}
										//echo $sum_tot_batch_wgt.'='.$batch_weight.'='.$sum_issue_amt_chemical.'<br>';
										if($sum_issue_amt_chemical>0)
										{
										$tot_sum_chemical_cost+=($sum_issue_amt_chemical/$sum_tot_batch_wgt)*$batch_weight;
										}
										if($sum_issue_amt_deys>0)
										{
										$tot_sum_deys_cost+=($sum_issue_amt_deys/$sum_tot_batch_wgt)*$batch_weight;
										}
									}
									// echo  $tot_sum_chemical_cost.',';
									
									if($tot_sum_chemical_cost)
									{
									//$issue_amt_perKg_chemical=($sum_issue_amt_chemical/$sum_tot_batch_wgt);
									$summissue_amt_cal_chemical=$tot_sum_chemical_cost;
									}
									else
									 {$summissue_amt_cal_chemical=0;}
									//echo $sum_issue_amt_chemical.'='.$sum_tot_batch_wgt.'='.$batch_weight.',';
									if($tot_sum_deys_cost)
									{
									//$sum_issue_amt_perKg_dyes=($sum_issue_amt_deys/$sum_tot_batch_wgt);
									$sum_issue_amt_cal_dyes=$tot_sum_deys_cost;
									} 
									else
									{$sum_issue_amt_cal_dyes=0;}
									
									if($entry_formId==0)
									{
										$prod_dateCostArr[$prodDate][$floor_id]['self']+=$sum_issue_amt_cal_dyes+$summissue_amt_cal_chemical;	
									}
									else if($entry_formId==36)
									{
										$prod_dateCostArr[$prodDate][$floor_id]['subcon']+=$sum_issue_amt_cal_dyes+$summissue_amt_cal_chemical;	
									}
									else if($batch_againstId==3 && $entry_formId==0)
									{
										$prod_dateCostArr[$prodDate][$floor_id]['sample']+=$sum_issue_amt_cal_dyes+$summissue_amt_cal_chemical;	
									}
									else if($entry_formId==136)
									{
										$prod_dateCostArr[$prodDate][$floor_id]['trims']+=$sum_issue_amt_cal_dyes+$summissue_amt_cal_chemical;	
									}
									//echo $entry_formId.'='.$batch_againstId.'<br>';
								$first_chemi_cost=$summissue_amt_cal_chemical;//$costDataArr[$b_id][5]+$costDataArr[$b_id][7];
			                    $buyer_wise_summary_arr[$buyerName]["first_chemi_cost"]+=$first_chemi_cost;

			                    $first_dyeing_cost=$sum_issue_amt_cal_dyes;//$costDataArr[$b_id][6];
			                    $buyer_wise_summary_arr[$buyerName]["first_dyeing_cost"]+=$first_dyeing_cost;
								$tot_main_batch_weight=$tot_main_batch_weight+=$batch_description_arr[$b_id]["batch_weight"];
								$buyer_wise_summary_arr[$buyerName]["tot_main_batch_weight"]+=$tot_main_batch_weight;
								// echo $first_dyeing_cost."<br>";
			               
			        
						//}	//Location // Floor End
					}
					//print_r($prod_dateTrimArr);
					//echo $totselfTrimQty.'SD';
					
					$table_width =450+count($batch_dying_floor_arr)*800;
					//echo implode(",",$dattarr);
	?>

 	<div style="width:<? echo $table_width;?>px">
        <!--<div  align="left" style="font-size:20px">Floor Wise Dyeing & Finishing Cost Report</div>-->
        <table width="<? echo $table_width;?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        <caption><b style="float:left">Floor Wise Dyeing & Finishing Cost Report </b></caption>
        	<thead>
            <tr>
                    <th rowspan="2" width="30">SL</th>
                    <th rowspan="2" width="80">Prod. Date</th>
                    <?
					asort($batch_dying_floor_arr);
					//print_r($batch_dying_floor_arr);
                    foreach($batch_dying_floor_arr as $floorId=>$val)
					{
						?>
                        <th colspan="8" title="<?=$floorId ?>"><? echo $floor_arr[$floorId];?></th>
					<? }
					?>
                    <th colspan="3" width="">All Floor Total</th>
                   
           </tr> 
                
                <tr>                         
                    <?
                    foreach($batch_dying_floor_arr as $floorId=>$val)
					{?>
						
                        <th width="100">Inhouse <br>[Self]</th>
                        <th width="100">Sales Order</th>
                        <th width="100">SubCon Order</th>
                        <th width="100"><p>Sample</p></th>
                        <th width="100">Trims & <br>Drawstring</th>
                        <th width="100">Floor Total</th>
                        <th width="100">Total Dyes & <br>Chemical Cost</th>
                        <th width="100">Cost/Kg</th>	
				<? }
				?>
                    
                   
                    
                    <th  width="100">Floor Total</th>
                    <th  width="100">Total Dyes & <br>Chemical Cost</th>
                    <th  width="">Cost/Kg</th>
                    
                </tr> 
            </thead>
        </table>
        <?
       // die;
		?>
        <div style="width:<? echo $table_width+18;?>px; max-height:400px;  overflow-y:scroll" id="scroll_body">
	        <table width="<? echo $table_width;?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_id" >
	            <tbody>
			       	<?
				    // echo "<pre>";print_r($issue_single_batch_arr);die;
					$total_tot_floor_chemi_dyes_cost=0;
					asort($prod_date_arr);
					foreach($prod_date_arr as $prod_date)
					{
						//echo $prod_date.'DS';
						//if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						//{
						
							if($i%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
							$all_po_id=explode(",",$po_break_down_id_arr[$batch_description_arr[$b_id]['booking_no']]); 
							//print_r($all_po_id);
							$ReqId=rtrim($ReqIdArr[$b_id],',');
							$ReqIds=implode(", ",array_unique(explode(",",$ReqId)));
							$ReqIdsArr=array_unique(explode(",",$ReqId));
							
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="30"><? echo $i; ?></td>								
				                <td width="80"><? echo change_date_format($prod_date); ?></td>
                                <?
								$floor_sub_tot_qty=$floor_sub_tot_cost=0; 
                                foreach($batch_dying_floor_arr as $floorId=>$val)
								{
									 
										//$selfQty=$prod_dateArr[$prod_date][$floorId]['selfQty'];	
										//$subconQty=$prod_dateArr[$prod_date][$floorId]['subconQty'];	
										//$sampleQty=$prod_dateArr[$prod_date][$floorId]['sampleQty'];	
									 	//$trimsQty=$prod_dateArr[$prodDate][$floor_id]['trimsQty'];
										//$prod_dateArr[$prodDate][$floor_id]['sales_batch_weight']
										$sales_batch_weight=$prod_dateArr[$prod_date][$floorId]['sales_batch_weight'];
										//echo $sales_batch_weight.'X';
										
										$selfQty=$prod_dateArr[$prod_date][$floorId]['selfBatchQty'];	
										$subconQty=$prod_dateArr[$prod_date][$floorId]['subconBatchQty'];	
										$sampleQty=$prod_dateArr[$prod_date][$floorId]['sampleBatchQty'];
										//echo $prod_date.', ';
										//$prod_dateArr[$prodDate][$floor_id]['sampleBatchQty']
										$trimsBatchQty=$prod_dateTrimArr[$prod_date][$floorId]['trimsBatchQty'];
											
									 	$trimsQty=$trimsBatchQty;
										
										
										
										$self_cost=$prod_dateCostArr[$prod_date][$floorId]['self'];	
										$subcon_cost=$prod_dateCostArr[$prod_date][$floorId]['subcon'];	
										$sample_cost=$prod_dateCostArr[$prod_date][$floorId]['sample'];	
										$trims_cost=$prod_dateCostArr[$prod_date][$floorId]['trims'];
									 $tot_floor_chemi_dyes_cost=$self_cost+$subcon_cost+$sample_cost+$trims_cost;
									 $floor_tot_qty=$selfQty+$subconQty+$sampleQty+$trimsQty+$sales_batch_weight;
									
									$tot_floor_chemi_dyes_qtyArr[$floorId]+=$floor_tot_qty;
									$tot_floor_chemi_dyes_costArr[$floorId]+=$tot_floor_chemi_dyes_cost;
									//if($selfQty>0)
									//{
										//if($floorId==188) echo $selfQty.'A';else echo " B";
									$tot_floor_self_qtyArr[$floorId]+=$selfQty;
									//}
									$tot_floor_subcon_qtyArr[$floorId]+=$subconQty;
									$tot_floor_sample_qtyArr[$floorId]+=$sampleQty;
									$tot_floor_trims_qtyArr[$floorId]+=$trimsQty;
									$tot_floor_sales_qtyArr[$floorId]+=$sales_batch_weight;
									
									
									$floor_sub_tot_qty+=$floor_tot_qty;
									$floor_sub_tot_cost+=$tot_floor_chemi_dyes_cost;
									 
									 
								?>
				                <td width="100" align="right"><p><? echo number_format($selfQty,2); ?></p></td>  
                                <td width="100" align="right"><p><? echo number_format($sales_batch_weight,2); ?></p></td>                                 
				                <td width="100" title="BatchId=<? echo $b_id;?>" align="right"><p>
                                <A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','batch_wise_subprocess_fabrics_dtls_popup2','<? echo $ReqIds; ?>',1)"> <? //echo $batch_arr[$b_id]; ?> </A><? echo number_format($subconQty,2); ?>
                               <? //echo $batch_arr[$b_id]; ?></p></td>
				                <td width="100" align="right"><p><? echo number_format($sampleQty,2); ?></p></td>
				                <td width="100"align="right"><p><? echo number_format($trimsQty,2); ?></p></td>
				                <td width="100" align="right"><p><?  echo number_format($floor_tot_qty,2); ?></p></td> 
				                <td width="100" align="right"><div style="word-break:break-all">
								<?  echo number_format($tot_floor_chemi_dyes_cost,2); ?></div></td> 
				                <td width="100" align="right" title="Floor total/Chemical and Dyes Cost"><p style="word-break:break-all"><? 
								if($tot_floor_chemi_dyes_cost)  echo fn_number_format($tot_floor_chemi_dyes_cost/$floor_tot_qty,2);else " "; ?></p></td> 
                                <?
								 }
								?>
                                
                                <td width="100" align="right"><p style="word-break:break-all"><? echo number_format($floor_sub_tot_qty,2); //$fabric_type_for_dyeing?></p></td> 
				                <td width="100" align="right"><p>
				                <? echo fn_number_format($floor_sub_tot_cost,2); 
								$total_tot_floor_chemi_dyes_cost+=$tot_floor_chemi_dyes_cost ;?>
				                </p></td> 
				                
				                <td width="" align="right" title="Total Dyes & Chemical Cost/Floor Total"><p>
				                <?
				                  if($floor_sub_tot_cost>0) echo fn_number_format($floor_sub_tot_cost/$floor_sub_tot_qty,2,".",""); else echo " ";
				               
				                 ?>
				                </p></td>
                                 
				            </tr>
							<? 												
							$i++; 			
						//}	
					}
					?>
	            </tbody>
	      	</table>
      	</div>
       	<table width="<? echo $table_width;?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="80">&nbsp;</th>
                     <?
					// print_r($tot_floor_self_qtyArr);
					 $total_floor_chemi_dyes_cost=0;$total_floor_chemi_dyes_qty=0;
                    foreach($batch_dying_floor_arr as $floorId=>$val)
					{
									$tot_floor_self_qty=$tot_floor_self_qtyArr[$floorId];
									$tot_floor_subcon_qty=$tot_floor_subcon_qtyArr[$floorId];
									$tot_floor_sample_qty=$tot_floor_sample_qtyArr[$floorId];
									$tot_floor_trims_qty=$tot_floor_trims_qtyArr[$floorId];
										$tot_floor_sales_qty=$tot_floor_sales_qtyArr[$floorId];
									//$tot_floor_sales_qtyArr[$floorId]
									
								?>
                    <th width="100" title="<?=$floorId;?>"><? echo number_format($tot_floor_self_qty,2);?></th>
                     <th width="100" title="<?=$floorId;?>"><? echo number_format($tot_floor_sales_qty,2);?></th>
                	<th width="100"><? echo number_format($tot_floor_subcon_qty,2);?></th>
                    <th width="100"><? echo number_format($tot_floor_sample_qty,2);?></th>
                    <th width="100"><? echo number_format($tot_floor_trims_qty,2);?></th>
                	<th width="100" align="right"><? echo fn_number_format($tot_floor_chemi_dyes_qtyArr[$floorId],2);?></th>
                	<th width="100"><? echo fn_number_format($tot_floor_chemi_dyes_costArr[$floorId],2);?></th>
                	<th width="100"><? echo fn_number_format($tot_floor_chemi_dyes_costArr[$floorId]/$tot_floor_chemi_dyes_qtyArr[$floorId],2);?></th>
                    <?
					$total_floor_chemi_dyes_cost+=$tot_floor_chemi_dyes_costArr[$floorId];
					$total_floor_chemi_dyes_qty+=$tot_floor_chemi_dyes_qtyArr[$floorId];
					}
					?>
                    
                	<th width="100"><? echo fn_number_format($total_floor_chemi_dyes_qty,2);?></th>
                    <th width="100"><? echo fn_number_format($total_floor_chemi_dyes_cost,2);?></th>
                    <th width=""><? echo fn_number_format($total_floor_chemi_dyes_cost/$total_floor_chemi_dyes_qty,2);?></th>
                  
                     
                </tr>
            </tfoot>
        </table>
    </div>
    <?
    $html = ob_get_contents();
    ob_clean();
    //$new_link=create_delete_report_file( $html, 2, $delete, "../../../" );
    foreach (glob("*.xls") as $filename) {
    //if( @filemtime($filename) < (time()-$seconds_old) )
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');	
    $is_created = fwrite($create_new_doc, $html);


    $filename2=$user_id."_summary_".$name.".xls";
    $create_new_doc2 = fopen($filename2, 'w');	
    $is_created2 = fwrite($create_new_doc2, $summaryHTML);

    echo "$html****$filename****$filename2****$report_type"; 
    exit();
}

if($action=="generate_report_floor_backup_14-6-23") // Floor  Wise 
{ 
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if ($cbo_company_name==0) $company_id=""; else $company_id=" and a.company_id='$cbo_company_name'";
	if ($cbo_company_name==0) $company_idcond =""; else $company_idcond =" and b.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond .=""; else $company_idcond .=" and b.working_company_id='$cbo_working_name'";
	
	if ($cbo_company_name==0) $company_idcond2 =""; else $company_idcond2 =" and a.company_id='$cbo_company_name'";
	if ($cbo_working_name==0) $company_idcond2 .=""; else $company_idcond2 .=" and a.service_company='$cbo_working_name'";
	
	//
	//echo $cbo_company_name.'='.$cbo_working_name;die;
	if($cbo_company_name) $company_ids=$cbo_company_name;
	else if($cbo_working_name) $company_ids=$cbo_working_name;
	
	if ($cbo_company_name==0 && $cbo_working_name==0) 
	{
	$w_company_idcond ="";$w_company_idcond2="";$w_company_idcond3="";
	}
	 else  {
		 if ($cbo_company_name==0 && $cbo_working_name>0)
		 {
		  	$w_company_idcond =" and c.company_id='$cbo_working_name'";
			$w_company_idcond2 =" and b.knit_dye_company='$cbo_working_name'";
			$w_company_idcond3 =" and b.working_company_id='$cbo_working_name'";
		 }
		 else  if ($cbo_company_name>0 && $cbo_working_name==0)
		 {
		  $w_company_idcond =" and c.company_id='$cbo_company_name'";
		  $w_company_idcond2 =" and b.knit_dye_company='$cbo_company_name'";
		  $w_company_idcond3 ="";
		 }
	 }
	 // echo  $w_company_idcond.'dd'.$company_idcond;die;
	
	$from_date=str_replace("'","",$from_date);
	$to_date=str_replace("'","",$to_date);
	//echo $from_date;
	$txt_ref_no=str_replace("'","",$txt_ref_no); 
	$txt_file_no=str_replace("'","",$txt_file_no);
	$txt_booking_no=str_replace("'","",$txt_booking_no);
	$txt_po_no=str_replace("'","",$txt_po_no);
	$txt_job=str_replace("'","",$txt_job);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$cbo_season_id=str_replace("'","",$cbo_season_id);
	$txt_samp_ref_no=str_replace("'","",$txt_samp_ref_no);
	$location_id=str_replace("'","",$location_id);
	$floor_id=str_replace("'","",$floor_id);
	$report_type=str_replace("'","",$report_type);
	$cbo_year=str_replace("'","",$cbo_year_selection);

	
	
	if(str_replace("'","",$cbo_buyer_name)==0)
	{
		if ($_SESSION['logic_erp']["data_level_secured"]==1)
		{
			if($_SESSION['logic_erp']["buyer_id"]!="") $buyer_id_cond=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")"; else $buyer_id_cond="";
		}
		else
		{
			$buyer_id_cond="";
		}
	}
	else
	{
		$buyer_id_cond=" and a.buyer_name in (".str_replace("'","",$cbo_buyer_name).")";
	}
	
	if($txt_booking_no!='') $booking_no_cond="and b.booking_no like '%$txt_booking_no%' ";else $booking_no_cond="";
	if($db_type==0)
		{
			$year_cond=" and SUBSTRING_INDEX(a.insert_date, '-', 1)=$cbo_year";
		}
		else if($db_type==2)
		{
			$year_cond=" and to_char(a.insert_date,'YYYY')=$cbo_year";
		}
		
	if($txt_file_no!='') $file_cond="and b.file_no='$txt_file_no'";else $file_cond="";
	if($txt_job!='') $job_cond="and a.job_no_prefix_num=$txt_job  $year_cond";else $job_cond="";
	if($txt_po_no!='') $po_cond="and b.po_number='$txt_po_no'";else $po_cond="";
	
	if($cbo_season_id!=0) $season_cond="and a.season_buyer_wise in($cbo_season_id)";else $season_cond="";
	if($floor_id!=0) $floor_id_cond="and a.floor_id in($floor_id)";else $floor_id_cond="";
	
	if($txt_ref_no!='') $ref_cond="and b.grouping='$txt_ref_no'";else $ref_cond="";
	if($txt_samp_ref_no!='') $samp_ref_cond="and a.grouping='$txt_samp_ref_no'";else $samp_ref_cond="";
	//echo $ref_cond;
	$companyArr = return_library_array("SELECT id,company_name from lib_company where status_active=1 and is_deleted=0","id","company_name"); 
	$supplierArr = return_library_array("SELECT id,supplier_name from lib_supplier where status_active=1 and is_deleted=0","id","supplier_name"); 
	$color_arr=return_library_array( "SELECT id,color_name  from  lib_color", "id", "color_name"  );
	$season_name_arr=return_library_array( "SELECT id,season_name  from  lib_buyer_season", "id", "season_name"  );
	
	if($db_type==0) 
	{
	$from_date=change_date_format($from_date,'yyyy-mm-dd'); $to_date=change_date_format($to_date,'yyyy-mm-dd');
	}
    if($db_type==2) 
	{
	$from_date=change_date_format($from_date,'','',1);  $to_date=change_date_format($to_date,'','',1);
	}
	//echo $from_date;
	
	
	$batch_description_arr=array();
	/* 
	if(str_replace("'","",$batch_id)!="") $batch_cond=" and b.id in(".str_replace("'","",$batch_id).")";
    else  */
	
	
	//echo $batch_cond; //die;
	//echo $batch_no; //die;
    	//echo $batch_no;
	$batch_no=implode("','",array_unique(explode(",",$batch_no)));
	
	if(str_replace("'","",$batch_no)!="") $batch_cond=" and b.batch_no in('".$batch_no."') "; 
	else $batch_cond="";
	//echo $batch_cond."shakil"; die;
	
	//
	/* and b.re_dyeing_from=0 13-11-16 according to siddique sir dicission when search buyer order or subcontract all batch appear */
	if($batch_type==0)
	$search_field_cond_batch="and b.entry_form in (0,36)";
	else if($batch_type==1)
	$search_field_cond_batch="and b.entry_form=0 ";
	else if($batch_type==2)
	$search_field_cond_batch="and b.entry_form=36";
	else if($batch_type==4)
	$search_field_cond_batch="and b.entry_form=136";
	else if($batch_type==5)
	$search_field_cond_batch="and b.batch_against=3";// sample
	else 
	$search_field_cond_batch="and b.entry_form in(0,36) and b.batch_against in(2) and  b.re_dyeing_from!=0 ";
	
	$search_field_cond_batch="";
 
	
	if($txt_file_no!='' || $txt_ref_no!='' ||  $txt_po_no!='' || $txt_job!='' || $cbo_buyer_name>0)
	{
		
		if($batch_type==4) //Trim batch
		{
		 $sql_po="SELECT c.id as batch_id,a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b,pro_batch_create_mst c where a.id=b.job_id and b.job_no_mst=c.job_no  and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond";
		}
		else
		{
			$sql_po="SELECT a.style_ref_no,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b  where a.id=b.job_id and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond";
		}
		// echo $sql_po;die; 
		$res_po=sql_select($sql_po);
		$all_po_id='';
		foreach($res_po as $row) //$job_no_arr
		{			
			if($all_po_id=="") $all_po_id=$row[csf('id')]; else $all_po_id.=",".$row[csf('id')]; //echo $all_po_id;
			
			$trim_batch_idArr[$row[csf('batch_id')]]=$row[csf('batch_id')];
		}
		//echo $all_po_id;
		
		//
		

		if($all_po_id!="") $po_idd="and po_id in($all_po_id)";else $po_idd="and po_id in(0)";
		
		$poIds=chop($all_po_id,','); $po_cond_for_in="";
		$po_ids=count(array_unique(explode(",",$all_po_id)));
		if($db_type==2 && $po_ids>1000)
		{
			$po_cond_for_in=" and (";
			$poIdsArr=array_chunk(explode(",",$poIds),999);
			foreach($poIdsArr as $ids)
			{
				$ids=implode(",",$ids);
				$po_cond_for_in.=" po_id in($ids) or"; 
			}
			$po_cond_for_in=chop($po_cond_for_in,'or ');
			$po_cond_for_in.=")";
		}
		else
		{
			$po_cond_for_in=" and po_id in($poIds)";
			
		}
		
		if($batch_type==4) //Trim batch
		{
		 	$po_cond_for_in='';
			$po_cond_for_in=where_con_using_array($trim_batch_idArr,0,"mst_id");
			//echo "SELECT mst_id as batch_id from pro_batch_trims_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in";die;
			$sql_batch=sql_select("SELECT mst_id as batch_id from pro_batch_trims_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in");
		}
		else
		{
			$sql_batch=sql_select("SELECT mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in");
		}
		//echo "SELECT mst_id as batch_id from pro_batch_create_dtls  where   status_active=1 and is_deleted=0 $po_cond_for_in";die();
		 $all_batch_id='';
		foreach($sql_batch as $row) 
		{
			if($all_batch_id=="") $all_batch_id=$row[csf('batch_id')]; else $all_batch_id.=",".$row[csf('batch_id')];
		}
			$all_batch_ids=implode(",",array_unique(explode(",",$all_batch_id)));
		//echo $all_batch_ids; 
		$batch_ids_cond="";
		if($all_batch_ids!="") 
		{
			//echo $po_id=substr($po_id,0,-1);
			if($db_type==0) { $batch_ids_cond="and b.id in(".$all_batch_ids.")"; }
			else
			{
				$bat_id=array_unique(explode(",",$all_batch_ids));
				if(count($bat_id)>1000)
				{
					$batch_ids_cond="and (";
					$bat_id=array_chunk($bat_id,1000);
					$z=0;
					foreach($bat_id as $id)
					{
						$id=implode(",",$id);
						if($z==0) $batch_ids_cond.=" b.id in(".$id.")";
						else $batch_ids_cond.=" or b.id in(".$id.")";
						$z++;
					}
					$batch_ids_cond.=")";
				}
				else { 
				
				$batch_ids_cond=" and b.id in(".$all_batch_ids.")"; }
			}
		}
	}
	// print_r($batch_ids_cond);die;
	if($from_date!="" && $to_date!="")
	{
		$date_cond_samp="";
		if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond_samp=" and b.batch_date between '".$from_date."' and '".$to_date."'";
		}
	}


	/* ================================================================================ /
	/								Main query start here								/
	/ ================================================================================ */
	$samp_non_booking=sql_select("SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $w_company_idcond3 $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
	/*echo "SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name 
	from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $w_company_idcond3 $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";die; */
	 

	// echo "SELECT b.id as batch_id,a.booking_no,a.entry_form_id,a.grouping,c.id as buyer_id,c.buyer_name from  wo_non_ord_samp_booking_mst a, lib_buyer c,pro_batch_create_mst b where a.buyer_id=c.id and b.booking_no=a.booking_no and a.booking_type=4  $company_idcond $batch_cond  $date_cond $search_field_cond_batch $booking_no_cond $date_cond_samp $samp_ref_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";die; 
	$all_batch_id_samp="";
	foreach($samp_non_booking as $row)
	{
		$non_buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$non_buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		$sample_booking_ref_no_arr[$row[csf('booking_no')]]=$row[csf('grouping')];
		if($txt_samp_ref_no!='')
		{
		if($all_batch_id_samp=="") $all_batch_id_samp=$row[csf('batch_id')]; else $all_batch_id_samp.=",".$row[csf('batch_id')];
		}
	}
	if($all_batch_id_samp!="") $all_batch_id_samp_cond="and b.id in($all_batch_id_samp)";else $all_batch_id_samp_cond="";
	//echo $all_batch_id_samp_cond.'X';
	
    if($from_date!="")
    {
		if(str_replace("'","",$cbo_value_with)==1)
		{
			$date_cond=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";
		//and b.batch_against in(1,2,3)
			$sql=sql_select("SELECT b.id,a.batch_no,a.fabric_type,a.floor_id,b.booking_without_order,b.job_no,b.extention_no,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
			from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
			and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0  $company_idcond2 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond $floor_id_cond");
			 
			 
			
		}
		else if(str_replace("'","",$cbo_value_with)==2)
		{
			$date_cond=" and b.batch_date between '".$from_date."' and '".$to_date."'";
			$sql=sql_select("SELECT b.id,b.batch_no,b.booking_without_order,b.job_no,b.extention_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
			from  pro_batch_create_mst b where   b.status_active=1 and b.is_deleted=0  $company_idcond $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond ");
			
		}
   	}
   	else
   	{
		 
		 
		$sql=sql_select("SELECT a.floor_id,a.process_end_date as batch_date,b.id,b.booking_without_order,b.job_no,b.extention_no,b.batch_no,b.color_range_id,b.batch_date,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from 
		from  pro_batch_create_mst b,pro_fab_subprocess a where  a.batch_id=b.id  and a.entry_form in (35,38) and a.load_unload_id=2 and b.status_active=1 and b.is_deleted=0 $company_idcond2 $batch_cond $batch_ids_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond $floor_id_cond");
		
		
	}
	 
	if(count($sql)==0)
    {
        ?>
        <div style="font-size:20px;color:red;text-align:center">Data not found!</div>
        <?
        die;
    }
  	// echo $sql;
  	// print_r($sql);die();
	
		
  	$reding_batch_id=$non_reding_batch_id=array();
    foreach($sql as $row)
	{
		$floor_id=$row[csf("floor_id")];
		$entry_formId=$row[csf("entry_form")];
		$batch_against_id=$row[csf("batch_against")];
		$batch_id_arr[]=$row[csf("id")];
		$batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
	
		
		//$batch_dying_floor_arr[$row[csf("floor_id")]]=$row[csf("floor_id")];
		//$prod_date_arr[$row[csf("batch_date")]]=$row[csf("batch_date")];
		
		
		  
		if($batch_against_id==1 || $batch_against_id==3)
		{		
			 
			// $batch_id_arr[]=$row[csf("id")]; 
			$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
			$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
			$batch_description_arr[$row[csf("id")]]['batch_weight']+=$row[csf("batch_weight")];
			$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
			$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_description_arr[$row[csf("id")]]['job_no']=$row[csf("job_no")];
			
			$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
			$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
			$batch_no_arr[]="'".$row[csf("batch_no")]."'";
			// $batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
			
			$batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			$batch_wise_arr[$row[csf("batch_no")]]['batch_no']=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['extention_no'].=$row[csf("extention_no")].',';
			$batch_ext_wise_arr[$row[csf("id")]]['extention_no']=$row[csf("extention_no")];
			
		}
		if($batch_against_id==2)
		{
			$batch_description_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$batch_description_arr[$row[csf("id")]]['booking_no']=$row[csf("booking_no")];
			$batch_description_arr[$row[csf("id")]]['without_order']=$row[csf("booking_without_order")];
			$batch_description_arr[$row[csf("id")]]['batch_weight']+=$row[csf("batch_weight")];
			$batch_description_arr[$row[csf("id")]]['color_id']=$row[csf("color_id")];
			$batch_description_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_description_arr[$row[csf("id")]]['job_no']=$row[csf("job_no")];
			
			$batch_description_arr[$row[csf("id")]]['color_range']=$row[csf("color_range_id")];
			$batch_description_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
			$batch_no_arr[]="'".$row[csf("batch_no")]."'";
			// $batch_arr[$row[csf("id")]]=$row[csf("batch_no")];
			
			$batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			$batch_wise_arr[$row[csf("batch_no")]]['batch_no']=$row[csf("batch_no")];
			$batch_wise_arr[$row[csf("batch_no")]]['extention_no'].=$row[csf("extention_no")].',';
			$batch_ext_wise_arr[$row[csf("id")]]['extention_no']=$row[csf("extention_no")];
			$batch_ext_wise_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			
			
			
			$re_batch_wise_arr[$row[csf("batch_no")]]['batch_id'].=$row[csf("id")].',';
			
		}
		if($row[csf("batch_against")]==2)
		{
			/*if($row[csf("re_dyeing_from")]>0)
			{
				$reding_batch_id[$row[csf("re_dyeing_from")]]=$row[csf("re_dyeing_from")]; 
			}
			else
			{
				$reding_batch_id[$row[csf("id")]]=$row[csf("id")]; 
			}*/
			$reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
		else
		{
			$non_reding_batch_id[$row[csf("id")]]=$row[csf("id")];
		}
	}
	
	
		
	 
	   $sql_product=("SELECT a.floor_id,a.result,a.process_end_date as batch_date,b.id,b.booking_without_order,b.job_no,b.extention_no,b.batch_no,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from,b.total_trims_weight,c.batch_qnty
		from  pro_batch_create_mst b,pro_fab_subprocess a,pro_batch_create_dtls c where  a.batch_id=b.id and b.id=c.mst_id and a.batch_id=c.mst_id   and a.entry_form in (35,38)  and b.status_active=1 and a.load_unload_id=2 and b.is_deleted=0 and c.is_deleted=0 and a.is_deleted=0 $company_idcond2 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond 
		union
 SELECT a.floor_id,a.result,a.process_end_date as batch_date,b.id,b.booking_without_order,
b.job_no,b.extention_no,b.batch_no,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,
b.entry_form, b.batch_against, b.re_dyeing_from,b.total_trims_weight,c.trims_wgt_qnty as batch_qnty 
from pro_batch_create_mst b,pro_fab_subprocess a,pro_batch_trims_dtls c 
where a.batch_id=b.id and b.id=c.mst_id and a.batch_id=c.mst_id 
and a.entry_form in (35,38)  and b.status_active=1 and a.load_unload_id=2
and b.is_deleted=0 and c.is_deleted=0 and a.is_deleted=0  $company_idcond2 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch  $all_batch_id_samp_cond ");
		
		$sql_prod=sql_select($sql_product);$tot_self_trim_qty=0;$tot_self_trimqty=0;
		$production_qty=0;$sub_trims_wgt_check_array=array();$jj=1;$self_trims_wgt_check_array=array();$jk=1;
		 foreach($sql_prod as $row)
		 {
			//$prod_arr[$row[csf("batch_date")]][$row[csf("floor_id")]]['qty']+=$row[csf("production_qty")];
			//
			$issue_single_batch_arr[$row[csf("id")]]=$row[csf("id")]; 
			$batch_data_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_data_arr[$row[csf("id")]]['batch_against']=$row[csf("batch_against")];
		
			$batch_dying_floor_arr[$row[csf("floor_id")]]=$row[csf("floor_id")];
			//$prod_date_arr[$row[csf("batch_date")]]=$row[csf("batch_date")];
		 if($row[csf("entry_form")]==36 && $row[csf("batch_against")]==1 && $row[csf("result")]==1)
		 {
			
			 
			 $batch_noSub=$row[csf('id')];
			if (!in_array($batch_noSub,$sub_trims_wgt_check_array))
			{ $jj++;

				 $sub_trims_wgt_check_array[]=$batch_noSub;
				 $tot_trim_qty=$row[csf('total_trims_weight')];
			}
			else
			{
				 $tot_trim_qty=0;
			}
			
			//$total_trims_weight_qty+=$tot_trim_qty;
			
			// $subcon_prod_arr[$row[csf("id")]]['production_qty_subcontact']+=$row[csf("batch_qnty")];
			 if($total_trims_weight_qty>0)
			 {
			// $subcon_prod_arr[$row[csf("id")]]['subcon_trimsWgt']=$tot_trim_qty;
			 }
		 }
		 
		 if($row[csf("entry_form")]==0 && $row[csf("batch_against")]==1 && $row[csf("result")]==1)
		 {
			
			 
			 $batch_noSelf=$row[csf('id')];
			if (!in_array($batch_noSelf,$self_trims_wgt_check_array))
			{ $jk++;

				 $sub_trims_wgt_check_array[]=$batch_noSelf;
				 $tot_self_trim_qty=$row[csf('total_trims_weight')];
			}
			else
			{
				 $tot_self_trim_qty=0;
			}
			
			//$total_trims_weight_qty+=$tot_trim_qty;
			
			// $subcon_prod_arr[$row[csf("id")]]['production_qty_subcontact']+=$row[csf("batch_qnty")];
			 if($tot_self_trim_qty>0)
			 {
			 $selfTrim_prod_arr[$row[csf("id")]]['subcon_trimsWgt']=$tot_self_trim_qty;
			  $tot_self_trimqty+=$tot_self_trim_qty;
			 }
		 }
		 
			$prod_arr[$row[csf("id")]]['prod_qty']+=$row[csf("batch_qnty")];
			$prod_arr[$row[csf("id")]]['batch_qty']+=$row[csf("batch_qnty")];
		 
			$prod_arr[$row[csf("id")]]['floor_id']=$row[csf("floor_id")];
			$prod_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$prod_result_arr[$row[csf("id")]]['result']=$row[csf("result")];
			 
			$production_qty+=$row[csf("batch_qnty")];
			 
		 }
		// echo $tot_self_trimqty.'T';
		 $batch_cond_for_in=where_con_using_array($issue_single_batch_arr,0,"b.id");
		 
		 //$po_data_subcon=sql_select("SELECT a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	//subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0  $batch_id_conds");
		 
	    $sql_sub_product=("SELECT a.floor_id,a.result,a.process_end_date as batch_date,b.id,b.booking_without_order,b.job_no,b.extention_no,b.batch_no,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from,b.total_trims_weight,c.batch_qnty
		from  pro_batch_create_mst b,pro_fab_subprocess a,pro_batch_create_dtls c,subcon_ord_dtls d,subcon_ord_mst e where  a.batch_id=b.id and b.id=c.mst_id and a.batch_id=c.mst_id and c.po_id=d.id and  d.job_no_mst=e.subcon_job and a.entry_form in (38) and e.party_id not in(426,439,444,458,425,427,428,443,392,564,565,563) and b.status_active=1 and a.load_unload_id=2 and b.is_deleted=0 and c.is_deleted=0 and a.is_deleted=0 and d.status_active=1 and e.status_active=1 $company_idcond2 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond $floor_id_cond");//die;
		
		$sql_sub_prod=sql_select($sql_sub_product);//$tot_self_trim_qty=0;$tot_self_trimqty=0;
		$subcon_trims_wgt_check_array=array();$jjj=1;$jkk=1;
		 foreach($sql_sub_prod as $row)
		 {
			//$prod_arr[$row[csf("batch_date")]][$row[csf("floor_id")]]['qty']+=$row[csf("production_qty")];
			//
			$issue_single_batch_arr[$row[csf("id")]]=$row[csf("id")]; 
			$batch_data_arr[$row[csf("id")]]['entry_form']=$row[csf("entry_form")];
			$batch_data_arr[$row[csf("id")]]['batch_against']=$row[csf("batch_against")];
		
			$batch_dying_floor_arr[$row[csf("floor_id")]]=$row[csf("floor_id")];
			//$prod_date_arr[$row[csf("batch_date")]]=$row[csf("batch_date")];
		 if($row[csf("entry_form")]==36 && $row[csf("batch_against")]==1 && $row[csf("result")]==1)
		 {
			 $batch_noSubcon=$row[csf('id')];
			if (!in_array($batch_noSub,$subcon_trims_wgt_check_array))
			{ $jjj++;

				 $subcon_trims_wgt_check_array[]=$batch_noSubcon;
				 $tot_trim_qty=$row[csf('total_trims_weight')];
			}
			else
			{
				 $tot_trim_qty=0;
			}
			//$total_trims_weight_qty+=$tot_trim_qty;
			 $subcon_prod_arr[$row[csf("id")]]['production_qty_subcontact']+=$row[csf("batch_qnty")];
			 if($total_trims_weight_qty>0)
			 {
			 $subcon_prod_arr[$row[csf("id")]]['subcon_trimsWgt']=$tot_trim_qty;
			 }
		 }
		 unset($sql_sub_prod);
		 
		   $prod_arr[$row[csf("id")]]['prod_qty']+=$row[csf("batch_qnty")];
			$prod_arr[$row[csf("id")]]['batch_qty']+=$row[csf("batch_qnty")];
		 
			$prod_arr[$row[csf("id")]]['floor_id']=$row[csf("floor_id")];
			$prod_arr[$row[csf("id")]]['batch_date']=$row[csf("batch_date")];
			$prod_result_arr[$row[csf("id")]]['result']=$row[csf("result")];
			 
			$production_qty+=$row[csf("batch_qnty")];
			 
		 }
		// echo $tot_self_trimqty.'T';
		 $batch_cond_for_in=where_con_using_array($issue_single_batch_arr,0,"b.id");
		  
		 
			$sql_qty = " (select b.working_company_id,b.company_id,b.id,b.batch_no,b.total_trims_weight,
			sum(case when a.service_source=1 then  b.batch_weight end) as batch_weight,
			SUM(case when a.service_source=1 and b.batch_against!=3 and c.is_sales!=1 then c.batch_qnty end) AS production_qty_inhouse,
			SUM(case when a.service_source=3 then c.batch_qnty end) AS production_qty_outbound,
			SUM(case WHEN b.batch_against=3 and b.booking_without_order=1 and b.is_sales!=1  then c.batch_qnty end) AS prod_qty_sample_without_order,
			SUM(case WHEN b.batch_against=3 and b.booking_without_order=0 and c.is_sales!=1  then c.batch_qnty end) AS prod_qty_sample_with_order,
			SUM(case WHEN c.is_sales=1 then c.batch_qnty end) AS fabric_sales_order_qty
			from pro_batch_create_dtls c, wo_po_break_down e, wo_po_details_master d, pro_fab_subprocess a,
			 lib_machine_name g, pro_batch_create_mst b 
			where a.batch_id=b.id and b.entry_form=0 and g.id=a.machine_id and b.id=c.mst_id and a.batch_id=c.mst_id and a.entry_form=35 and a.load_unload_id=2 and b.batch_against in(1)  and c.po_id=e.id and d.job_no=e.job_no_mst and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and  c.status_active=1 and c.is_deleted=0  and a.result=1  $company_idcond2 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond $floor_id_cond
			group by b.working_company_id,b.company_id,b.id,b.batch_no,b.total_trims_weight)
			union  
			( select b.working_company_id,b.company_id,b.id,b.batch_no,b.total_trims_weight,
			sum(case when a.service_source=1 then  b.batch_weight end) as batch_weight,
			SUM(case when a.service_source=1 and b.batch_against in(1) and c.is_sales!=1  then c.batch_qnty end) AS production_qty_inhouse,
			SUM(case when a.service_source=3 then c.batch_qnty end) AS production_qty_outbound,
			SUM(case WHEN b.batch_against=3 and b.booking_without_order=1 and c.is_sales!=1 then c.batch_qnty end) AS prod_qty_sample_without_order,
			SUM(case WHEN b.batch_against=3 and b.booking_without_order=0 and c.is_sales!=1 then c.batch_qnty end) AS prod_qty_sample_with_order,
			SUM(case WHEN c.is_sales=1 then c.batch_qnty end) AS fabric_sales_order_qty
			from pro_batch_create_dtls c, pro_batch_create_mst b, pro_fab_subprocess a, lib_machine_name g,wo_non_ord_samp_booking_mst h
			where  h.booking_no=b.booking_no and a.batch_id=b.id and a.batch_id=c.mst_id and b.entry_form=0 and g.id=a.machine_id and b.id=c.mst_id and a.entry_form=35 and a.load_unload_id=2  and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0  and  c.status_active=1 and c.is_deleted=0  and a.result=1  $company_idcond2 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond $floor_id_cond
			group by b.id,b.working_company_id,b.company_id,b.batch_no,b.total_trims_weight ) 
			union
			(select b.working_company_id,b.company_id,b.id,b.batch_no, SUM(c.trims_wgt_qnty) AS total_trims_weight, 0 as batch_weight, 0 AS production_qty_inhouse, 0 AS production_qty_outbound, 0 AS prod_qty_sample_without_order, 0 AS prod_qty_sample_with_order, 0 AS fabric_sales_order_qty
			from pro_batch_create_mst b,pro_batch_trims_dtls c, wo_po_details_master d, pro_fab_subprocess a, lib_machine_name g 
			where a.batch_id=b.id and b.id=c.mst_id and a.batch_id=c.mst_id and g.id=a.machine_id and d.job_no=b.job_no and b.entry_form=136 and a.entry_form=35 and a.load_unload_id=2 and b.batch_against in(1) and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and a.result=1 and c.status_active=1 and c.is_deleted=0  $company_idcond2 $batch_cond $batch_ids_cond $date_cond $search_field_cond_batch $booking_no_cond $all_batch_id_samp_cond $floor_id_cond 
			GROUP BY b.working_company_id,b.company_id,b.id,b.batch_no) ";

			//echo $sql_qty;
			$sql_result=sql_select( $sql_qty);

		//$fabric_sales_order_qty=0;
		$total_trims_weight_qty=0;
		$j=1;$self_trims_wgt_check_array=array();
		foreach($sql_result as $row)
		{
			//$production_qty_inhouse+=$row[csf('production_qty_inhouse')];
			//$production_qty_outbound+=$row[csf('production_qty_outbound')];
			//$prod_qty_sample_without_order+=$row[csf('prod_qty_sample_without_order')];
			//$prod_qty_sample_with_order+=$row[csf('prod_qty_sample_with_order')];
			//$fabric_sales_order_qty+=$row[csf('fabric_sales_order_qty')];
			$batch_noSelf=$row[csf('id')];
			if (!in_array($batch_noSelf,$self_trims_wgt_check_array))
			{ 
				$j++;

				$self_trims_wgt_check_array[]=$batch_noSelf;
				$tot_trim_qty=$row[csf('total_trims_weight')];
			}
			else
			{
				$tot_trim_qty=0;
			}
			$issue_single_batch_arr[$row[csf("id")]]=$row[csf("id")]; 
			
			// $prod_arr[$row[csf("id")]]['batch_date']=$row[csf("process_end_date")];
			
			$total_trims_weight_qty+=$tot_trim_qty;
			$tot_sample=$row[csf("prod_qty_sample_without_order")]+$row[csf('prod_qty_sample_with_order')];
			$prod_arr2[$row[csf("id")]]['self_batch_qty']+=$row[csf("production_qty_inhouse")]+$row[csf('production_qty_outbound')];
			if($tot_sample>0)
			{
				// echo $tot_sample.',';
			$prod_arr2[$row[csf("id")]]['sample_batch_qty']+=$tot_sample;
			}
			$prod_arr2[$row[csf("id")]]['fabric_sales_order_qty']+=$row[csf("fabric_sales_order_qty")];
			$prod_arr2[$row[csf("id")]]['tot_trim_qty']+=$tot_trim_qty;
			$prod_TrimsArr[$row[csf("id")]]=$tot_trim_qty;
			
		}
	//	echo array_sum($prod_arr3);
		
	       //echo $total_trims_weight_qty.'D'; 
	  //  echo "<pre>"; print_r($prod_arr3);   

//die;

	//	********************************************************************************************************************************
     $batch_id_sql=implode(",",$batch_id_arr);
    if($batch_id_sql=="") $batch_id_sql=0;
	//echo  $batch_id_sql;
  	if($batch_type==3)
	{
		//$re_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond2=chop($re_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond2.=")";
		}
	}
	else
	{
		//$re_dying_cond=" and b.re_dyeing_from in(".$batch_id_sql.")";	
		//$pord_ids = explode(",",$txt_product_id);
		//echo count($pord_ids);die;
		if(count($batch_id_arr)>0)
		{
			$re_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id).") or";
				}
				$re_dying_cond=chop($re_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$re_dying_cond.=" b.re_dyeing_from in(".implode(",",$batch_id_arr).")";
			}
			$re_dying_cond.=")";
		}
	}

	$date_cond2=" and a.process_end_date between '".$from_date."' and '".$to_date."' ";

	// =============================================================
	$batch_all_id_array=array();
	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
	  $sql = "SELECT a.ID,b.mst_id as REQ_ID,a.batch_id as BATCH_ID,a.BATCH_QTY,a.BATCH_QTY,a.NEW_BATCH_WEIGHT,a.ENTRY_FORM,c.batch_id as RE_BATCH_ID from pro_recipe_entry_mst a, dyes_chem_requ_recipe_att b,dyes_chem_issue_requ_mst c where b.recipe_id=a.id  and c.id=b.mst_id $batch_id_conds and a.status_active=1 and a.is_deleted=0 and b.status_active=1 ";
	 // echo $sql;die; 
	$res = sql_select($sql);
	$req_id_array = array();
	foreach ($res as $val) 
	{
		//$req_id_array2[$val['REQ_ID']] .= $val['REQ_ID'].',';
		$req_id_array[$val['REQ_ID']] = $val['REQ_ID'];
		//$batch_req_id_array[$val['BATCH_ID']].= $val['REQ_ID'].',';
		$batch_req_id_array2[$val['BATCH_ID']]= $val['REQ_ID'];
		$batch_all_id_array[$val['BATCH_ID']]= $val['BATCH_ID'];
		//if($batchWgtChkk[$val['REQ_ID']]=='')
		//{
			if($val['ENTRY_FORM']==60) //Adding Topping
			{
				$batch_wgt=$val['NEW_BATCH_WEIGHT'];
			}
			else
			{
				$batch_wgt=$val['BATCH_QTY'];
			}
		//$batch_wgt_array[$val['REQ_ID']] += $batch_wgt;
		$batch_wgt_array[$val['BATCH_ID']] = $batch_wgt;
		$batchWgtChkk[$val['REQ_ID']].=$val['BATCH_ID'].',';
		
		$batchIdChkkDtls[$val['REQ_ID']]=$val['BATCH_ID'];
		//}
		
	}
	unset($res);
	// print_r($req_id_array2);die;
	// $requisition_ids = implode(",", $req_id_array);
	
	
	if(count($req_id_array))
	{
		$requisition_id_cond=where_con_using_array($req_id_array,0,"a.requisition_no");
	}

	$issue_sql = sql_select("SELECT a.MST_ID ,a.REQUISITION_NO,b.BATCH_NO,a.ITEM_CATEGORY,a.PROD_ID,a.CONS_QUANTITY,a.CONS_AMOUNT from inv_transaction a,inv_issue_master b where a.mst_id=b.id and b.entry_form=5 and b.is_deleted=0 and b.status_active=1 and a.status_active=1 and a.transaction_type=2 $requisition_id_cond   ");//$w_company_idcond2
	//echo "SELECT a.MST_ID ,a.REQUISITION_NO,b.BATCH_NO,a.ITEM_CATEGORY,a.PROD_ID,a.CONS_QUANTITY,a.CONS_AMOUNT from inv_transaction a,inv_issue_master b where a.mst_id=b.id and b.entry_form=5 and b.is_deleted=0 and b.status_active=1 and a.status_active=1 and a.transaction_type=2 $requisition_id_cond   ";die;
	   
	 
	$issue_id_arr = array();$tot_issueQty=0;  

	foreach ($issue_sql as $val) 
	{
		 
		$batchArr=array_filter(array_unique(explode(",",$val['BATCH_NO'])));
		foreach($batchArr as $bid)
		{
			$issue_item_cat_arr[$bid][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['ITEM_CATEGORY'];
			if($bid!='')
			{
			$batch_all_id_array[$bid]= $bid;
			$batch_req_id_array[$bid].= $val['REQUISITION_NO'].',';
			}
		}
			$issue_item_cat_cost_arr[$val['REQUISITION_NO']][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['CONS_QUANTITY'];
			$issue_item_cat_cost_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_QUANTITY'];
			
			$issue_item_cat_amt_dtls_arr[$val['REQUISITION_NO']][$val['ITEM_CATEGORY']]+=$val['CONS_AMOUNT'];
		
		 $ReqBatch_id_arr[$val['REQUISITION_NO']] = $val['BATCH_NO'];
		$issue_id_arr[$val['MST_ID']] = $val['MST_ID'];
		$tot_issueQty+=$val['CONS_QUANTITY'];
		
	}
	// echo count($batch_all_id_array);die;
	if(count($batch_all_id_array))
	{
		$batch_ids_cond=where_con_using_array($batch_all_id_array,0,"b.id");
	}
	
	$batch_fabric_sql=sql_select("SELECT b.id,b.batch_no,b.batch_weight,b.total_trims_weight, b.batch_against
	from pro_recipe_entry_mst  a,pro_batch_create_mst b  where  a.batch_id=b.id 
	 and a.status_active=1 and a.is_deleted=0 $batch_ids_cond group by  b.id,b.batch_no,b.batch_weight,b.total_trims_weight, b.batch_against" );
	
	 foreach ($batch_fabric_sql as $row) 
	{
		//$batch_req_id=$batch_req_id_array2[$row[csf("id")]];
		//echo $batch_req_id.'d';
		$batch_wgt_arr[$row[csf("id")]]['batchWgt']=$row[csf("batch_weight")];
		if($row[csf("total_trims_weight")]>0)
		{
			$batch_wgt_arr[$row[csf("id")]]['trims_weight']=$row[csf("total_trims_weight")]; 
			
			//echo $row[csf("total_trims_weight")].','; 
		}
	}
	//========+++++=Re Calculation++++++++++++========
	//echo $tot_issueQty.'D';
	// echo "<pre>";print_r($batch_req_id_array);die;
	// =====================================================================================
	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "b.id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "b.id", $re_dying_cond);
	$fabric_sql=sql_select("SELECT b.id,a.batch_no,a.fabric_type,b.booking_without_order,a.process_end_date as batch_date,b.color_range_id,b.booking_no,b.batch_weight,b.color_id,b.entry_form, b.batch_against, b.re_dyeing_from
	from pro_fab_subprocess  a,pro_batch_create_mst b  where  a.batch_id=b.id 
	and a.entry_form in (35,38) and a.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 $company_idcond $batch_id_conds");
	 	
  	$fabric_type_arr=array();
    foreach($fabric_sql as $row)
	{
	 	$fabric_type_arr[$row[csf("id")]]['fabric_type']=$row[csf("fabric_type")];
	}
	// ========================================================================================
//$issue_single_batch_arr[$row[csf("id")]]
$batch_idCond1 = where_con_using_array($issue_single_batch_arr,0,"a.batch_id");
	$floor_cond_arr=array();
	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
	if(!empty($location_id))
	{
		if(!empty($floor_id))
		{
			$sql="SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form in(35,38) and b.status_active=1 and b.is_deleted=0  and b.location_id=$location_id and b.production_process=3 and b.id=$floor_id $batch_idCond1";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) 
			{
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		else
		{
			$sql="SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form in(35,38) and b.status_active=1 and b.is_deleted=0  and b.location_id=$location_id and b.production_process=3 $batch_idCond1";
			
			$sql_floor=sql_select($sql);
			foreach ($sql_floor as $row) {
				
				array_push($floor_cond_arr, $row[csf('batch_id')]);
			}
		}
		$floor_cond_arr=array_unique($floor_cond_arr);
	}
	 // print_r($floor_cond_arr);die();
	// ==========================================================================
	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
	$floor_arr=return_library_array("SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 $batch_id_conds", "batch_id", "floor_name" );
  //  $floor_arr=return_library_array("SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 $batch_id_conds", "batch_id", "floor_name" );
	//echo "SELECT  a.batch_id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 $batch_id_conds";die;
	//$floor_arr=return_library_array("SELECT  b.id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 $batch_id_conds", "id", "floor_name" );
	//$floor_arr=return_library_array("SELECT  b.id ,b.floor_name from    lib_prod_floor b  where  b.status_active=1 and b.is_deleted=0 ", "id", "floor_name" );
	//echo "SELECT  b.id ,b.floor_name from   pro_fab_subprocess a, lib_prod_floor b  where a.floor_id=b.id and a.entry_form=35 and b.status_active=1 and b.is_deleted=0 $batch_id_conds";

	//$machine_name_arr=return_library_array("SELECT  a.batch_id ,b.machine_no from   pro_fab_subprocess a, lib_machine_name b  where a.machine_id=b.id and a.entry_form=35 and  b.status_active=1 and b.is_deleted=0 $batch_id_conds ", "batch_id", "machine_no" );
	$floor_arr=return_library_array("SELECT  b.id ,b.floor_name from    lib_prod_floor b  where  b.status_active=1 and b.is_deleted=0 ", "id", "floor_name" );

	$batch_id_conds = ($batch_type==3) ? str_replace("b.id", "c.id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "c.id", $re_dying_cond);
	$sql_book=sql_select("SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c where a.buyer_id=b.id and a.id=c.booking_no_id $batch_id_conds");
	//echo "SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c where a.buyer_id=b.id and a.id=c.booking_no_id $batch_id_conds";die;
	//echo "SELECT a.booking_no,a.po_break_down_id,b.id as buyer_id, b.buyer_name from  wo_booking_mst a, lib_buyer b,pro_batch_create_mst c where a.buyer_id=b.id and a.id=c.booking_no_id $batch_id_conds";die;
	$po_id_arr = array();
	foreach($sql_book as $row)
	{
		$buyer_name_arr[$row[csf('booking_no')]]=$row[csf('buyer_name')];
		$buyer_id_arr[$row[csf('booking_no')]]=$row[csf('buyer_id')];
		
		if($row[csf('po_break_down_id')])
		{
		$po_id_arr[$row[csf('po_break_down_id')]]=$row[csf('po_break_down_id')];
		$po_break_down_id_arr[$row[csf('booking_no')]]=$row[csf('po_break_down_id')];
		}
	}

	// =========================================================
	// $poIdss = implode(",", $po_id_arr);
	if(count($po_id_arr))
	{
		$po_id_cond = where_con_using_array($po_id_arr,0,"b.id");
	}
	// echo $poIdCond;die();
	/*$sql_po="SELECT a.style_ref_no,a.buyer_name,a.season_buyer_wise,b.id,b.po_number,b.file_no,b.grouping as ref_no,b.job_no_mst from wo_po_details_master a,wo_po_break_down b  where a.id=b.job_id and   b.status_active=1 and b.is_deleted=0 $file_cond $ref_cond $job_cond $season_cond $po_cond $buyer_id_cond $po_id_cond";
	// echo $sql_po;die(); 
	$res_po=sql_select($sql_po);
	$all_po_id='';
	foreach($res_po as $row) //$job_no_arr
	{
		$po_number_arr[$row[csf('id')]]['po_no']=$row[csf('po_number')];
		$po_number_arr[$row[csf('id')]]['ref_no']=$row[csf('ref_no')];
		$po_number_arr[$row[csf('id')]]['file_no']=$row[csf('file_no')]; 
		$po_number_arr[$row[csf('id')]]['season']=$row[csf('season_buyer_wise')]; 
		$po_number_arr[$row[csf('id')]]['job']=$row[csf('job_no_mst')];
		$job_no_arr[$row[csf('id')]]=$row[csf('job_no_mst')];
		$style_library[$row[csf('job_no_mst')]]=$row[csf('style_ref_no')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['buyer']=$row[csf('buyer_name')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['season']=$row[csf('season_buyer_wise')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['style']=$row[csf('style_ref_no')];
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['po_number'].=$row[csf('po_number')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['ref_no'].=$row[csf('ref_no')].',';
		$trim_batch_job_arr[$row[csf('job_no_mst')]]['file_no'].=$row[csf('file_no')].',';
	}*/

	
    $buyer_library=return_library_array( "SELECT id,buyer_name from   lib_buyer", "id","buyer_name" );
   // $style_library=return_library_array( "SELECT job_no,style_ref_no from   wo_po_details_master", "job_no","style_ref_no" );

    $batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.mst_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.mst_id", $re_dying_cond);
	$po_data_subcon=sql_select("SELECT a.mst_id,b.order_no,c.subcon_job, c.party_id,b.cust_style_ref from pro_batch_create_dtls a, subcon_ord_dtls b,
	subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0  $batch_id_conds");
	
	$sub_con_arr=array();
	foreach($po_data_subcon as $row)
	{
		if($sub_con_arr[$row[csf('mst_id')]][cust_style_ref]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref].=",".$row[csf('cust_style_ref')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][cust_style_ref]=$row[csf('cust_style_ref')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][order_no]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no].=",".$row[csf('order_no')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][order_no]=$row[csf('order_no')];	
		}
		
		if($sub_con_arr[$row[csf('mst_id')]][subcon_job]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job].=",".$row[csf('subcon_job')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][subcon_job]=$row[csf('subcon_job')];	
		}
		if($sub_con_arr[$row[csf('mst_id')]][party_id]!="")
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id].=",".$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id].=",".$row[csf('party_id')];
		}
		else
		{
			$sub_con_arr[$row[csf('mst_id')]][party_id]=$buyer_library[$row[csf('party_id')]];
			$sub_con_id_arr[$row[csf('mst_id')]][party_id]=$row[csf('party_id')];	
		}
	}
	//print_r($sub_con_arr[646]);die;
	// ==================================================================================

	if($db_type==0)
	{
		if($batch_type==3)
		{
		 $sql_redying=sql_select("SELECT b.id as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0 group by  b.id");
		}
		else
		{
			 $sql_redying=sql_select("SELECT group_concat(b.id) as id,group_concat(b.batch_date)  as batch_date,group_concat(b.extention_no)  as extention_no,b.re_dyeing_from from  pro_batch_create_mst b where b.re_dyeing_from!=0  $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0 group by  b.re_dyeing_from");	
		}
	}
	else
	{
	
		if($batch_type==3)
		{	
			 $sql_redying=sql_select("SELECT b.id as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no
			  from  pro_batch_create_mst  b 
			  where b.re_dyeing_from!=0 $company_idcond $re_dying_cond2 and b.status_active=1 and b.is_deleted=0  group by  b.id");
		}
		else
		{
			 $sql_redying=sql_select("SELECT listagg((b.id),',') within group (order by b.id) as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no,b.re_dyeing_from 
			 from  pro_batch_create_mst b 
			 where b.re_dyeing_from!=0   $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0  group by  b.re_dyeing_from");
			// echo "select listagg((b.id),',') within group (order by b.id) as id,listagg((b.batch_date),',') within group (order by b.batch_date) as batch_date,listagg((b.extention_no),',') within group (order by b.extention_no) as extention_no,b.re_dyeing_from 
			// from  pro_batch_create_mst b 
			// where b.re_dyeing_from!=0   $company_idcond $re_dying_cond and b.status_active=1 and b.is_deleted=0  group by  b.re_dyeing_from";
		}
	}
	
   	//and b.batch_against=2
    $redying_details_arr=array();
    foreach($sql_redying as $re_row)
    {
		if($batch_type==3)
		{
			$redying_details_arr[$re_row[csf("id")]]['id']=$re_row[csf("id")];
			$redying_details_arr[$re_row[csf("id")]]['batch_date']=$re_row[csf("batch_date")];
			$redying_details_arr[$re_row[csf("id")]]['extention_no']=$re_row[csf("extention_no")];
		}
		else
		{
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['id']=$re_row[csf("id")];
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['batch_date']=$re_row[csf("batch_date")];
			$redying_details_arr[$re_row[csf("re_dyeing_from")]]['extention_no']=$re_row[csf("extention_no")];
		}
    }
	
	//echo "<pre>"; print_r($redying_details_arr);die;
	if($batch_type==3)
	{
		//$all_dying_cond2=" and b.id in(".$batch_id_sql.")";
		if(count($batch_id_arr)>0)
		{
			$all_dying_cond2=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$all_dying_cond2.=" b.id in(".implode(",",$batch_id).") or";
				}
				$all_dying_cond2=chop($all_dying_cond2,"or");
			}
			else
			{
				//die("with naz");
				$all_dying_cond2.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$all_dying_cond2.=")";
		}
	}
	else
	{
		if(count($batch_id_arr)>0)
		{
			$all_dying_cond=" and (";
			if(count($batch_id_arr)>999 && $db_type==2)
			{
				$prod_id_chank=array_chunk($batch_id_arr,999);
				foreach($prod_id_chank as $batch_id)
				{
					$all_dying_cond.=" b.id in(".implode(",",$batch_id).") or";
				}
				$all_dying_cond=chop($all_dying_cond,"or");
			}
			else
			{
				//die("with naz");
				$all_dying_cond.=" b.id in(".implode(",",$batch_id_arr).")";
			}
			$all_dying_cond.=")";
		}
	}
	
	if($batch_type==3)
	{
		$result_sql=sql_select("SELECT a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2   $company_idcond $all_dying_cond2 and a.status_active=1 and a.is_deleted=0");	
	}
	else
	{
		$result_sql=sql_select("SELECT a.result,a.batch_id 
		from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2  $company_idcond $all_dying_cond and a.status_active=1 and a.is_deleted=0");
	}
	
	/*$sql_result=sql_select("select a.result,a.batch_id from pro_fab_subprocess a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (35,38) and a.load_unload_id=2  and a.company_id=$cbo_company_name and b.re_dyeing_from in (".$batch_id_sql.") and a.status_active=1 and a.is_deleted=0");*/
	
	$result_arr=array();
	foreach($result_sql as $value)
	{
		$result_arr[$value[csf('batch_id')]]=$value[csf('result')];	
	}
	
	// print_r($issue_single_batch_arr); echo "Test";die;
	
	// ====================================== batch wise cost =====================================
	$batchIdArr = array();
	foreach(array_unique($issue_single_batch_arr) as $b_id)
	{
		$batchIdArr[$b_id] = $b_id;
	}
	
	$batchCond=where_con_using_array($batchIdArr,0,"c.id");

	// print_r($batchIdArr);die();
	// echo $company_id;die();
	$company_cond = str_replace("a.company_id", "c.company_id", $company_id);	
	if ($cbo_working_name==0) $wo_company_idcond =""; else $wo_company_idcond =" and p.working_company_id='$cbo_working_name'";

	// $batchCond = implode(",", $batchIdArr);
	   $sql = "(SELECT p.id as recipe_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,a.avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, a.id, a.item_category_id, a.item_group_id, a.sub_group_name, a.item_description, a.item_size,a.current_stock, a.unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
		from pro_recipe_entry_mst p, product_details_master a, pro_recipe_entry_dtls b,pro_batch_create_mst c  
		where p.id=b.mst_id and a.id=b.prod_id and p.batch_id=c.id and b.ratio>0  and b.status_active=1 and b.is_deleted=0 $company_cond $wo_company_idcond and a.item_category_id in(5,6,7,23) and a.status_active=1 and a.is_deleted=0 $batchCond and p.entry_form in(59,60)) 
		union 
		(
		SELECT p.id as recipe_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,0 as avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, b.prod_id as id, null as item_category_id, null as item_group_id, null as sub_group_name, null as item_description, null as item_size,null as current_stock, null as unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
			from pro_recipe_entry_mst p, pro_recipe_entry_dtls b,pro_batch_create_mst c  
			where p.id=b.mst_id and p.batch_id=c.id and b.status_active=1 and b.is_deleted=0 $wo_company_idcond  and b.status_active=1 and b.is_deleted=0 and b.prod_id=0 and b.sub_process_id in(93,94,95,96,97,98) and p.status_active=1 and p.is_deleted=0 $batchCond and p.entry_form in(59,60))  order by sub_seq,seq_no";
	// echo $sql;//die();
	$costDataArr = array(); 
	$res = sql_select($sql);
	$tot_recCost=0;$tot_issue_qty=0;
	foreach ($res as $row) 
	{
		$current_stock = $row[csf('current_stock')];
		$recipe_type = $row[csf('recipe_type')];
		$surplus_solution = $row[csf('surplus_solution')];
		$pickup = $row[csf('pickup')];
		$batch_wgt = $row[csf('batch_qty')];//pickup,p.batch_qty
		 
		$batch_req_id=rtrim($batch_req_id_array[$row[csf('batch_id')]],',');
		$batch_req_idArr=array_unique(explode(",",$batch_req_id_array[$row[csf('batch_id')]]));
		//echo $batch_req_id.'D';
		$tot_batch_wgt=$batch_wgt_array[$row[csf('batch_id')]];
		//echo  $tot_batch_wgt.'D';
		$batch_qty=$row[csf('batch_qty')];
		if($issue_item_cat_arr[$row[csf('batch_id')]][$row[csf('prod_id')]][$row[csf('item_category_id')]])
		{
			//echo $recipe_qnty.'='.$row[csf('avg_rate_per_unit')].'<br>';
			//$issue_qty=0;
			foreach($batch_req_idArr as $req_id)
			{
				if($issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=='')
				{	
					$issue_qty+=$issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
					//$reqIdArr[$req_id]=$req_id;
				
					$tot_issue_qty+=$issue_qty;
					$issue_reqId_chk_arr[$row[csf('batch_id')]][$row[csf('recipe_id')]][$row[csf('prod_id')]]=111;
				 	//	echo "SDDD";
				}
				
			}
			//$issue_qty=$issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
			$issue_perKg=($issue_qty/$tot_batch_wgt);
			$issue_wgt_per=$issue_perKg*$batch_qty;
		//	echo $tot_batch_wgt.'='.$issue_qty.'='.$issue_wgt_per.'='.$issue_wgt_per*$row[csf('avg_rate_per_unit')].'<br>';
		$costDataArr[$row[csf('batch_id')]][$row[csf('item_category_id')]] +=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
			//echo "AA";
		$ReqIdArr[$row[csf('batch_id')]].=$batch_req_id.',';
		//$recipe_qnty*$row[csf('avg_rate_per_unit')];
		$categryDataArr[$row[csf('batch_id')]].=$row[csf('item_category_id')].',';
		$tot_recCost+=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
		}
	}
	//echo implode(",",$reqIdArr);die;
	//echo $tot_issue_qty.'Dx'.'='.$tot_recCost;
	// echo "<pre>";print_r($costDataArr);

	$i=1;$j=1;
	ob_start();	
	?>
	<div id="" align="center" style="height:auto; width:auto; margin:0 auto; padding:0;">
		<? $summaryHTML='<div id="summary_part" style="width:1460px;">
        <table width="2060px" cellpadding="0" cellspacing="0" id="caption" align="center">
            <thead>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:16px; font-weight:bold" >'.$report_title.'</td 
                ></tr>
                <tr style="border:none;">
                    <td colspan="24" class="form_caption" align="center" style="border:none; font-size:14px;">
                       <b>Company Name : '.$companyArr[$company_ids].'</b>                               
                    </td>
                </tr>
                <tr style="border:none;">
                    <td colspan="24" align="center" class="form_caption" style="border:none;font-size:12px; font-weight:bold">
					'."Date: ". change_date_format($from_date).' To '. change_date_format($to_date).'
					</td>
                </tr>
            </thead>
        </table>
       	 
    	</div>';?>
    	<? echo $summaryHTML;
	
					 $batch_id_cond_for_in=where_con_using_array($issue_single_batch_arr,0,"b.id");
					$sales_data = sql_select("SELECT b.id as batch_id,a.id,a.job_no,a.sales_booking_no,a.within_group,b.batch_weight,a.buyer_id,a.style_ref_no, a.po_buyer from fabric_sales_order_mst a,pro_batch_create_mst b where a.id=b.sales_order_id and a.status_active=1  and b.status_active=1  $batch_id_cond_for_in");
					 
					foreach ($sales_data as $row)
					{
						$sales_batch_arr[$row[csf('batch_id')]]=$row[csf('job_no')];
						
						 
						$sales_batchQty_Arr[$row[csf('batch_id')]]['batch_weight']=$row[csf('batch_weight')];
						
					}
					unset($sales_data);
					
					$tot_main_batch_weight=0;$prod_dateCostArr=array();
					$prod_dateArr=array();$prod_date_arr=array();$totselfTrimQty=0;
			       	foreach(array_unique($issue_single_batch_arr) as $b_id)
					{
						//if(in_array($b_id, $floor_cond_arr) || empty($location_id)) 
						//{
							//batch_description_arr  
							if($batch_description_arr[$b_id][entry_form]==36)
			                {
			                	$buyerName=implode(", ",array_unique(explode(",",$sub_con_id_arr[$b_id][party_id])));
			                }
							else if($batch_description_arr[$b_id][entry_form]==136) //Trims batch
			                {
			                	$job_no=$batch_description_arr[$b_id][job_no];
								$buyerName=$trim_batch_job_arr[$job_no]['buyer'];
								//$po_number=$trim_batch_job_arr[$job_no]['po_number']; 
								//$buyerName=implode(", ",array_unique(explode(",",$sub_con_id_arr[$b_id][party_id])));
			                }
			                else
			                {
				                if($batch_description_arr[$b_id]["without_order"]==1) 
				                $buyerName=$non_buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
				                else $buyerName=$buyer_id_arr[$batch_description_arr[$b_id]["booking_no"]];
			                }
							$result_id=$prod_result_arr[$b_id]['result'];
							if($result_id==1)
							{
							$prodQty=$batch_description_arr[$b_id]["batch_weight"];
							$production_qty_subcontact= $subcon_prod_arr[$b_id]['production_qty_subcontact'];
							$subcon_trimsWgt= $subcon_prod_arr[$b_id]['subcon_trimsWgt'];//$subcon_prod_arr[$row[csf("id")]]['subcon_trimsWgt']
							$batch_qty=$prod_arr[$b_id]['batch_qty'];//$prod_arr[$b_id]['prod_qty'];
							//echo $subcon_trimsWgt.'d';
							}
							$floor_id=$prod_arr[$b_id]['floor_id'];
							$prodDate=$prod_arr[$b_id]['batch_date'];
							//echo $prodDate.'=='.$floor_id.'<br>';
							//echo strtotime($prodDate).', ';   
							if(strtotime($prodDate)>0)
							{
							$prod_date_arr[$prodDate]=$prodDate;
							$trims_weight=$batch_wgt_arr[$b_id]['trims_weight'];
							}
							
							$entry_formId=$batch_data_arr[$b_id]['entry_form'];
							$batch_againstId=$batch_data_arr[$b_id]['batch_against'];
						 // echo $entry_formId.', ';
						$sales_no=$sales_batch_arr[$b_id];
						//echo $sales_no.'ds';
						if($sales_no!="")
						{
							$sales_batch_weight=$sales_batchQty_Arr[$b_id]['batch_weight'];
						//	echo $sales_batch_weight;
							$prod_dateArr[$prodDate][$floor_id]['sales_batch_weight']+=$sales_batch_weight;
						}
						
							$prod_dateArr[$prodDate][$floor_id]['selfQty']+=$prodQty;
							
							
							 $prod_dateArr[$prodDate][$floor_id]['selfBatchQty']+=$prod_arr2[$b_id]['self_batch_qty'];//$batch_qty;	
							
								//$prod_dateArr[$prodDate][$floor_id]['subconQty']+=$prodQty;	
								$prod_dateArr[$prodDate][$floor_id]['subconBatchQty']+=$production_qty_subcontact;
							
								$prod_dateArr[$prodDate][$floor_id]['sampleQty']+=$prodQty;//$prod_arr2[$row[csf("id")]]['sample_batch_qty']
								$prod_dateArr[$prodDate][$floor_id]['sampleBatchQty']+=$prod_arr2[$b_id]['sample_batch_qty'];;	
							
								 
								$prod_dateArr[$prodDate][$floor_id]['trimsQty']+=$prodQty;
								$prod_dateArr[$prodDate][$floor_id]['trimsBatchQty']+=$batch_qty+$trims_weight;	
							
							 //$prod_arr3[$row[csf("id")]]['tot_trim_batch_qty']
							 if($batch_againstId==1)
							 {
							$prod_dateTrimArr[$prodDate][$floor_id]['trimsBatchQty']+=$prod_TrimsArr[$b_id]+$subcon_trimsWgt;
							 }
							 
							
							
							
							$ReqId=rtrim($ReqIdArr[$b_id],',');
							$sum_ReqIdsArr=array_unique(explode(",",$ReqId));
			                $first_chemi_cost=$first_dyeing_cost=0;
			               
			                    $sum_issue_amt_deys=0;$sum_issue_amt_chemical=0;
								$batch_weight=$batch_description_arr[$b_id]["batch_weight"];
								$sum_batchIdArr='';$tot_sum_chemical_cost=$tot_sum_deys_cost=0;
									foreach($sum_ReqIdsArr as $reqId)
									{
										
										$sum_issue_amt_chemical=$issue_item_cat_amt_dtls_arr[$reqId][5]+$issue_item_cat_amt_dtls_arr[$reqId][7];
										$sum_issue_amt_deys=$issue_item_cat_amt_dtls_arr[$reqId][6];
									   $batch_idsAll=$ReqBatch_id_arr[$reqId]; 
										$sum_batchIds=rtrim($batch_idsAll,',');
										$sumbatIdArr=array_unique(explode(",",$sum_batchIds)); 
										$sum_tot_batch_wgt=0;
										foreach($sumbatIdArr as $batchId)
										{
										//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
										//echo $batch_wgt_arr[$batchId]['batchWgt'].'p';
										$sum_tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt']; 
										}
										//echo $sum_tot_batch_wgt.'='.$batch_weight.'='.$sum_issue_amt_chemical.'<br>';
										if($sum_issue_amt_chemical>0)
										{
										$tot_sum_chemical_cost+=($sum_issue_amt_chemical/$sum_tot_batch_wgt)*$batch_weight;
										}
										if($sum_issue_amt_deys>0)
										{
										$tot_sum_deys_cost+=($sum_issue_amt_deys/$sum_tot_batch_wgt)*$batch_weight;
										}
									}
									// echo  $tot_sum_chemical_cost.',';
									
									if($tot_sum_chemical_cost)
									{
									//$issue_amt_perKg_chemical=($sum_issue_amt_chemical/$sum_tot_batch_wgt);
									$summissue_amt_cal_chemical=$tot_sum_chemical_cost;
									}
									else
									 {$summissue_amt_cal_chemical=0;}
									//echo $sum_issue_amt_chemical.'='.$sum_tot_batch_wgt.'='.$batch_weight.',';
									if($tot_sum_deys_cost)
									{
									//$sum_issue_amt_perKg_dyes=($sum_issue_amt_deys/$sum_tot_batch_wgt);
									$sum_issue_amt_cal_dyes=$tot_sum_deys_cost;
									} 
									else
									{$sum_issue_amt_cal_dyes=0;}
									
									if($entry_formId==0)
									{
										$prod_dateCostArr[$prodDate][$floor_id]['self']+=$sum_issue_amt_cal_dyes+$summissue_amt_cal_chemical;	
									}
									else if($entry_formId==36)
									{
										$prod_dateCostArr[$prodDate][$floor_id]['subcon']+=$sum_issue_amt_cal_dyes+$summissue_amt_cal_chemical;	
									}
									else if($batch_againstId==3 && $entry_formId==0)
									{
										$prod_dateCostArr[$prodDate][$floor_id]['sample']+=$sum_issue_amt_cal_dyes+$summissue_amt_cal_chemical;	
									}
									else if($entry_formId==136)
									{
										$prod_dateCostArr[$prodDate][$floor_id]['trims']+=$sum_issue_amt_cal_dyes+$summissue_amt_cal_chemical;	
									}
									//echo $entry_formId.'='.$batch_againstId.'<br>';
								$first_chemi_cost=$summissue_amt_cal_chemical;//$costDataArr[$b_id][5]+$costDataArr[$b_id][7];
			                    $buyer_wise_summary_arr[$buyerName]["first_chemi_cost"]+=$first_chemi_cost;

			                    $first_dyeing_cost=$sum_issue_amt_cal_dyes;//$costDataArr[$b_id][6];
			                    $buyer_wise_summary_arr[$buyerName]["first_dyeing_cost"]+=$first_dyeing_cost;
								$tot_main_batch_weight=$tot_main_batch_weight+=$batch_description_arr[$b_id]["batch_weight"];
								$buyer_wise_summary_arr[$buyerName]["tot_main_batch_weight"]+=$tot_main_batch_weight;
								// echo $first_dyeing_cost."<br>";
			               
			        
						//}	//Location // Floor End
					}
					//print_r($prod_dateTrimArr);
					//echo $totselfTrimQty.'SD';
					
					$table_width =420+count($batch_dying_floor_arr)*800;
					//echo implode(",",$dattarr);
	?>

 	<div style="width:<? echo $table_width;?>px">
        <!--<div  align="left" style="font-size:20px">Floor Wise Dyeing & Finishing Cost Report</div>-->
        <table width="<? echo $table_width;?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="caption" >
        <caption><b style="float:left">Floor Wise Dyeing & Finishing Cost Report </b></caption>
        	<thead>
            <tr>
                    <th rowspan="2" width="30">SL</th>
                    <th rowspan="2" width="80">Prod. Date</th>
                    <?
					asort($batch_dying_floor_arr);
					//print_r($batch_dying_floor_arr);
                    foreach($batch_dying_floor_arr as $floorId=>$val)
					{
						?>
                        <th colspan="8" title="<?=$floorId ?>"><? echo $floor_arr[$floorId];?></th>
					<? }
					?>
                    <th colspan="3" width="">All Floor Total</th>
                   
           </tr> 
                
                <tr>                         
                    <?
                    foreach($batch_dying_floor_arr as $floorId=>$val)
					{?>
						
                        <th width="100">Inhouse <br>[Self]</th>
                        <th width="100">Sales Order</th>
                        <th width="100">SubCon Order</th>
                        <th width="100"><p>Sample</p></th>
                        <th width="100">Trims & <br>Drawstring</th>
                        <th width="100">Floor Total</th>
                        <th width="100">Total Dyes & <br>Chemical Cost</th>
                        <th width="100">Cost/Kg</th>	
				<? }
				?>
                    
                   
                    
                    <th  width="100">Floor Total</th>
                    <th  width="100">Total Dyes & <br>Chemical Cost</th>
                    <th  width="">Cost/Kg</th>
                    
                </tr> 
            </thead>
        </table>
        <?
       // die;
		?>
        <div style="width:<? echo $table_width+18;?>px; max-height:400px;  overflow-y:scroll" id="scroll_body">
	        <table width="<? echo $table_width;?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_id" >
	            <tbody>
			       	<?
				    // echo "<pre>";print_r($issue_single_batch_arr);die;
					$total_tot_floor_chemi_dyes_cost=0;
					asort($prod_date_arr);
					foreach($prod_date_arr as $prod_date)
					{
						//echo $prod_date.'DS';
						//if(in_array($b_id, $floor_cond_arr) || empty($location_id))
						//{
						
							if($i%2==0)$bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
							$all_po_id=explode(",",$po_break_down_id_arr[$batch_description_arr[$b_id]['booking_no']]); 
							//print_r($all_po_id);
							$ReqId=rtrim($ReqIdArr[$b_id],',');
							$ReqIds=implode(", ",array_unique(explode(",",$ReqId)));
							$ReqIdsArr=array_unique(explode(",",$ReqId));
							
							?>
				            <tr bgcolor="<? echo $bgcolor; ?>" <? echo $stylecolor; ?> onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
				                <td width="30"><? echo $i; ?></td>								
				                <td width="80"><? echo change_date_format($prod_date); ?></td>
                                <?
								$floor_sub_tot_qty=$floor_sub_tot_cost=0; 
                                foreach($batch_dying_floor_arr as $floorId=>$val)
								{
									 
										//$selfQty=$prod_dateArr[$prod_date][$floorId]['selfQty'];	
										//$subconQty=$prod_dateArr[$prod_date][$floorId]['subconQty'];	
										//$sampleQty=$prod_dateArr[$prod_date][$floorId]['sampleQty'];	
									 	//$trimsQty=$prod_dateArr[$prodDate][$floor_id]['trimsQty'];
										//$prod_dateArr[$prodDate][$floor_id]['sales_batch_weight']
										$sales_batch_weight=$prod_dateArr[$prod_date][$floorId]['sales_batch_weight'];
										//echo $sales_batch_weight.'X';
										
										$selfQty=$prod_dateArr[$prod_date][$floorId]['selfBatchQty'];	
										$subconQty=$prod_dateArr[$prod_date][$floorId]['subconBatchQty'];	
										$sampleQty=$prod_dateArr[$prod_date][$floorId]['sampleBatchQty'];
										//echo $prod_date.', ';
										//$prod_dateArr[$prodDate][$floor_id]['sampleBatchQty']
										$trimsBatchQty=$prod_dateTrimArr[$prod_date][$floorId]['trimsBatchQty'];
											
									 	$trimsQty=$trimsBatchQty;
										
										
										
										$self_cost=$prod_dateCostArr[$prod_date][$floorId]['self'];	
										$subcon_cost=$prod_dateCostArr[$prod_date][$floorId]['subcon'];	
										$sample_cost=$prod_dateCostArr[$prod_date][$floorId]['sample'];	
										$trims_cost=$prod_dateCostArr[$prod_date][$floorId]['trims'];
									 $tot_floor_chemi_dyes_cost=$self_cost+$subcon_cost+$sample_cost+$trims_cost;
									 $floor_tot_qty=$selfQty+$subconQty+$sampleQty+$trimsQty+$sales_batch_weight;
									
									$tot_floor_chemi_dyes_qtyArr[$floorId]+=$floor_tot_qty;
									$tot_floor_chemi_dyes_costArr[$floorId]+=$tot_floor_chemi_dyes_cost;
									//if($selfQty>0)
									//{
										//if($floorId==188) echo $selfQty.'A';else echo " B";
									$tot_floor_self_qtyArr[$floorId]+=$selfQty;
									//}
									$tot_floor_subcon_qtyArr[$floorId]+=$subconQty;
									$tot_floor_sample_qtyArr[$floorId]+=$sampleQty;
									$tot_floor_trims_qtyArr[$floorId]+=$trimsQty;
									$tot_floor_sales_qtyArr[$floorId]+=$sales_batch_weight;
									
									
									$floor_sub_tot_qty+=$floor_tot_qty;
									$floor_sub_tot_cost+=$tot_floor_chemi_dyes_cost;
									 
									 
								?>
				                <td width="100" align="right"><p><? echo number_format($selfQty,2); ?></p></td>  
                                <td width="100" align="right"><p><? echo number_format($sales_batch_weight,2); ?></p></td>                                 
				                <td width="100" title="BatchId=<? echo $b_id;?>" align="right"><p>
                                <A href="##"  onClick="fn_1st_batch2('<? echo $b_id; ?>','batch_wise_subprocess_fabrics_dtls_popup2','<? echo $ReqIds; ?>',1)"> <? //echo $batch_arr[$b_id]; ?> </A><? echo number_format($subconQty,2); ?>
                               <? //echo $batch_arr[$b_id]; ?></p></td>
				                <td width="100" align="right"><p><? echo number_format($sampleQty,2); ?></p></td>
				                <td width="100"align="right"><p><? echo number_format($trimsQty,2); ?></p></td>
				                <td width="100" align="right"><p><?  echo number_format($floor_tot_qty,2); ?></p></td> 
				                <td width="100" align="right"><div style="word-break:break-all">
								<?  echo number_format($tot_floor_chemi_dyes_cost,2); ?></div></td> 
				                <td width="100" align="right" title="Floor total/Chemical and Dyes Cost"><p style="word-break:break-all"><? 
								if($tot_floor_chemi_dyes_cost)  echo number_format($tot_floor_chemi_dyes_cost/$floor_tot_qty,2);else " "; ?></p></td> 
                                <?
								 }
								?>
                                
                                <td width="100" align="right"><p style="word-break:break-all"><? echo number_format($floor_sub_tot_qty,2); //$fabric_type_for_dyeing?></p></td> 
				                <td width="100" align="right"><p>
				                <? echo number_format($floor_sub_tot_cost,2); 
								$total_tot_floor_chemi_dyes_cost+=$tot_floor_chemi_dyes_cost ;?>
				                </p></td> 
				                
				                <td width="" align="right" title="Total Dyes & Chemical Cost/Floor Total"><p>
				                <?
				                  if($floor_sub_tot_cost>0) echo number_format($floor_sub_tot_cost/$floor_sub_tot_qty,2,".",""); else echo " ";
				               
				                 ?>
				                </p></td>
                                 
				            </tr>
							<? 												
							$i++; 			
						//}	
					}
					?>
	            </tbody>
	      	</table>
      	</div>
       	<table width="<? echo $table_width;?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="rpt_table" id="table_body_footer" >
            <tfoot>
            	<tr>
                	<th width="30">&nbsp;</th>
                	<th width="80">&nbsp;</th>
                     <?
					// print_r($tot_floor_self_qtyArr);
					 $total_floor_chemi_dyes_cost=0;$total_floor_chemi_dyes_qty=0;
                    foreach($batch_dying_floor_arr as $floorId=>$val)
					{
									$tot_floor_self_qty=$tot_floor_self_qtyArr[$floorId];
									$tot_floor_subcon_qty=$tot_floor_subcon_qtyArr[$floorId];
									$tot_floor_sample_qty=$tot_floor_sample_qtyArr[$floorId];
									$tot_floor_trims_qty=$tot_floor_trims_qtyArr[$floorId];
										$tot_floor_sales_qty=$tot_floor_sales_qtyArr[$floorId];
									//$tot_floor_sales_qtyArr[$floorId]
									
								?>
                    <th width="100" title="<?=$floorId;?>"><? echo number_format($tot_floor_self_qty,2);?></th>
                     <th width="100" title="<?=$floorId;?>"><? echo number_format($tot_floor_sales_qty,2);?></th>
                	<th width="100"><? echo number_format($tot_floor_subcon_qty,2);?></th>
                    <th width="100"><? echo number_format($tot_floor_sample_qty,2);?></th>
                    <th width="100"><? echo number_format($tot_floor_trims_qty,2);?></th>
                	<th width="100" align="right"><? echo number_format($tot_floor_chemi_dyes_qtyArr[$floorId],2);?></th>
                	<th width="100"><? echo number_format($tot_floor_chemi_dyes_costArr[$floorId],2);?></th>
                	<th width="100"><? echo number_format($tot_floor_chemi_dyes_costArr[$floorId]/$tot_floor_chemi_dyes_qtyArr[$floorId],2);?></th>
                    <?
					$total_floor_chemi_dyes_cost+=$tot_floor_chemi_dyes_costArr[$floorId];
					$total_floor_chemi_dyes_qty+=$tot_floor_chemi_dyes_qtyArr[$floorId];
					}
					?>
                    
                	<th width="100"><? echo number_format($total_floor_chemi_dyes_qty,2);?></th>
                    <th width="100"><? echo number_format($total_floor_chemi_dyes_cost,2);?></th>
                    <th width=""><? echo number_format($total_floor_chemi_dyes_cost/$total_floor_chemi_dyes_qty,2);?></th>
                  
                     
                </tr>
            </tfoot>
        </table>
    </div>
    <?
    $html = ob_get_contents();
    ob_clean();
    //$new_link=create_delete_report_file( $html, 2, $delete, "../../../" );
    foreach (glob("*.xls") as $filename) {
    //if( @filemtime($filename) < (time()-$seconds_old) )
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');	
    $is_created = fwrite($create_new_doc, $html);


    $filename2=$user_id."_summary_".$name.".xls";
    $create_new_doc2 = fopen($filename2, 'w');	
    $is_created2 = fwrite($create_new_doc2, $summaryHTML);

    echo "$html****$filename****$filename2****$report_type"; 
    exit();
}

if($action=="1st_batch_dtls_popup") //
{
	echo load_html_head_contents("Batch Details", "../../../../", 1, 1,$unicode,'','');
	extract($_REQUEST);
	//echo $batch_id;die;
	$batch_non_redyeing_id=return_field_value("id","pro_batch_create_mst","batch_against<>2 and status_active=1 and id in($batch_id)","id");
	if($batch_non_redyeing_id=="")die;
	
	if($batch_non_redyeing_id!="") $batch_cond=" and a.batch_no like '$batch_non_redyeing_id'";
	if($batch_non_redyeing_id!="") $batch_cond2=" and c.batch_no like '$batch_non_redyeing_id'";
	
	$sql_dtls_dyes = "select c.id as PROD_ID, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit, sum(b.cons_quantity) as qnty,sum(b.cons_amount) as cons_amount,b.ITEM_CATEGORY
	from inv_issue_master a,inv_transaction b, product_details_master c
	where a.id=b.mst_id and b.prod_id=c.id and b.transaction_type=2 and a.entry_form=5 and a.batch_no  is not null and b.item_category in (6) and b.status_active=1 $batch_cond group by c.id, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit,b.ISSUE_ID,b.ITEM_CATEGORY"; 
	// echo $sql_dtls_dyes;die;
	$sql_result_dyes= sql_select($sql_dtls_dyes);
	
	$sql_dtls_chemical = "select c.id as PROD_ID, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit, sum(b.cons_quantity) as qnty,sum(b.cons_amount) as cons_amount,b.ITEM_CATEGORY
	from inv_issue_master a,inv_transaction b, product_details_master c
	where a.id=b.mst_id and b.prod_id=c.id and b.transaction_type=2 and a.entry_form=5 and a.batch_no  is not null  and b.item_category in (5,7)  and b.status_active=1 $batch_cond group by c.id, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit,b.ISSUE_ID,b.ITEM_CATEGORY"; 
	//echo $sql_dtls_chemical;die;
	$sql_result_chemical= sql_select($sql_dtls_chemical);


	$rcv_sql =  "SELECT b.prod_id as PROD_ID,b.item_category as ITEM_CATEGORY ,sum(b.cons_amount) as ISSUE_RETURN_AMNT,sum(b.cons_quantity) as ISSUE_RETURN_QTY FROM inv_receive_master a, inv_transaction b, INV_ISSUE_MASTER c
	WHERE a.id=b.mst_id and  b.issue_id = c.id $batch_cond2  and b.item_category  in(5,6,7) and a.entry_form=29 and b.transaction_type=4 and c.status_active=1 group by c.batch_no,b.prod_id,b.item_category";
    $rcv_result = sql_select($rcv_sql);
	//echo $rcv_sql;
	$return_qty_arr=array();
	foreach($rcv_result as $row)
	{
		$return_qty_arr[$row['PROD_ID']][$row['ITEM_CATEGORY']]['qty'] = $row['ISSUE_RETURN_QTY'];
		$return_qty_arr[$row['PROD_ID']][$row['ITEM_CATEGORY']]['amnt'] = $row['ISSUE_RETURN_AMNT'];
	}


	?>
    <script>
		function print_window()
		{
			var w = window.open("Surprise", "#");
			var d = w.document.open();
			d.write ('<!DOCTYPE HTML PUBLIC "-//W3C//DTsD HTML 4.01//EN""http://www.w3.org/TR/html4/strict.dtd">'+
			'<html><head><link rel="stylesheet" href="../../../../css/style_common.css" type="text/css" media="print"/><title></title></head><body>'+document.getElementById('report_div').innerHTML+'</body</html>');
			d.close();
		}	
	</script>	
	<div style="width:770px; margin-left:30px" id="report_div">
     <!--<div style="width:870px;" align="center"><input  type="button" value="Print Preview" onClick="print_window()" style="width:100px"  class="formbutton"/></div>-->
    <div style="width:770px; font-family:'Arial Narrow'; font-size:14px;">Dyes</div>
    <table align="center" cellspacing="0" width="770" border="1" rules="all" class="rpt_table" >
        <thead align="center">
    	   <tr>
                <th width="50">SL</th>
                <th width="50">Product Id</th>
                <th width="250">Item Description</th>
                <th width="100">UOM</th>
                <th width="100">Quantity</th>
                <th width="100">Avg. Rate</th> 
                <th>Amount(BDT)</th>
           </tr>
		</thead>
		<?  
		$i=1;
		foreach($sql_result_dyes as $row)
		{
			if ($i%2==0)  
				$bgcolor="#E9F3FF";
			else
				$bgcolor="#FFFFFF";

				//echo "sas--".$return_qty_arr[$row['ISSUE_ID']][$row['PROD_ID']][$row['ITEM_CATEGORY']]['qty'];
			$bal_qty = $row[csf("qnty")]-$return_qty_arr[$row['PROD_ID']][$row['ITEM_CATEGORY']]['qty'];
			$bal_amnt = $row[csf("cons_amount")]- $return_qty_arr[$row['PROD_ID']][$row['ITEM_CATEGORY']]['amnt'];
			if($bal_qty>0)
			{

			?>

			<tbody>
				<tr bgcolor="<? echo $bgcolor; ?>">
					<td align="center"><? echo $i; ?></td>
					<td align="center"><? echo $row[csf("prod_id")]; ?></td>
					<td><? echo $row[csf("product_name_details")]; ?></td>
					<td align="center"><? echo $unit_of_measurement[$row[csf("unit_of_measure")]]; ?></td>
					<td align="right"><? echo number_format($row[csf("qnty")],4,'.',''); $total_dyeing_qnty+=$row[csf("qnty")]; ?></td>
					<td align="right"><? echo number_format($row[csf("avg_rate_per_unit")],4,'.',''); ?></td>
					<td align="right"><? $amount=0; $amount=$bal_amnt; echo  number_format($amount,6,'.',''); $total_dyeing_amount+=$amount; ?></td>
				</tr>
			</tbody>
			<? 
			$i++;
			}
		}
		?>
        <tfoot>
        	<tr>
                <th colspan="4" align="right">Total:</th>
                <th align="right"><? echo number_format($total_dyeing_qnty,2,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_dyeing_amount,2,'.',''); ?></th>
            </tr>
        </tfoot>
      </table>
      
      <div style="width:770px; font-family:'Arial Narrow'; font-size:14px;">Chemical</div>
    <table align="center" cellspacing="0" width="770" border="1" rules="all" class="rpt_table" >
        <thead align="center">
    	   <tr>
                <th width="50">SL</th>
                <th width="50">Product Id</th>
                <th width="250">Item Description</th>
                <th width="100">UOM</th>
                <th width="100">Quantity</th>
                <th width="100">Avg. Rate</th> 
                <th>Amount(BDT)</th>
           </tr>
		</thead>
		<?  
		foreach($sql_result_chemical as $row)
		{
			if ($i%2==0)  
				$bgcolor="#E9F3FF";
			else
				$bgcolor="#FFFFFF";
		
			$bal_qty = $row[csf("qnty")]-$return_qty_arr[$row['PROD_ID']][$row['ITEM_CATEGORY']]['qty'];
			$bal_amnt = $row[csf("cons_amount")]- $return_qty_arr[$row['PROD_ID']][$row['ITEM_CATEGORY']]['amnt'];
			if($bal_qty>0)
			{
			?>
			<tbody>
				<tr bgcolor="<? echo $bgcolor; ?>">
					<td align="center"><? echo $i; ?></td>
					<td align="center"><? echo $row[csf("prod_id")]; ?></td>
					<td><? echo $row[csf("product_name_details")]; ?></td>
					<td align="center"><? echo $unit_of_measurement[$row[csf("unit_of_measure")]]; ?></td>
					<td align="right"><? echo number_format($row[csf("qnty")],4,'.',''); $total_chemical_qnty+=$row[csf("qnty")]; ?></td>
					<td align="right"><? echo number_format($row[csf("avg_rate_per_unit")],4,'.',''); ?></td>
					<td align="right"><? $amount=0; $amount=$bal_amnt; echo  number_format($amount,6,'.',''); $total_chemical_amount+=$amount; ?></td>
				</tr>
			</tbody>
			<? 
			$i++;
			}
		}
		?>
        <tfoot>
        	<tr>
                <th colspan="4" align="right">Total:</th>
                <th align="right"><? echo number_format($total_chemical_qnty,2,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_chemical_amount,2,'.',''); ?></th>
            </tr>
        </tfoot>
      </table>
    </div>
    <?         
	exit();
}
if($action=="1st_chemi_dyes_batch_dtls_popup_old") // batch Wise 2
{
	echo load_html_head_contents("Batch Details", "../../../../", 1, 1,$unicode,'','');
	extract($_REQUEST);
	//echo $batch_id;die;
	//$batch_non_redyeing_id=return_field_value("id","pro_batch_create_mst","batch_against<>2 and status_active=1 and id in($batch_id)","id");
	//if($batch_non_redyeing_id=="")die;
	
	 
	 $sql = "(SELECT a.id as prod_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,a.avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, a.id, a.item_category_id, a.item_group_id, a.sub_group_name, a.item_description, a.item_size,a.current_stock, a.unit_of_measure, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
		from pro_recipe_entry_mst p, product_details_master a, pro_recipe_entry_dtls b,pro_batch_create_mst c  
		where p.id=b.mst_id and a.id=b.prod_id and p.batch_id=c.id and b.ratio>0  and b.status_active=1 and b.is_deleted=0 $company_cond $wo_company_idcond and a.status_active=1 and a.is_deleted=0 $batchCond and p.entry_form in(59,60) and a.item_category_id in (5,7) and c.id in($batch_id) ) 
		union 
		(
		SELECT 0 as prod_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,0 as avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, b.prod_id as id, null as item_category_id, null as item_group_id, null as sub_group_name, null as item_description, null as item_size,null as current_stock, null as unit_of_measure, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
			from pro_recipe_entry_mst p, pro_recipe_entry_dtls b,pro_batch_create_mst c  
			where p.id=b.mst_id and p.batch_id=c.id and b.status_active=1 and b.is_deleted=0 $wo_company_idcond  and b.status_active=1 and b.is_deleted=0 and b.prod_id=0 and b.sub_process_id in(93,94,95,96,97,98) and p.status_active=1 and p.is_deleted=0 $batchCond and p.entry_form in(59,60)  and c.id in($batch_id) )  order by sub_seq,seq_no";
	// echo $sql;die();
	$costDataArr = array();
	$res_chemical = sql_select($sql);
	$tot_recCost=0;
	foreach ($res_chemical as $row) 
	{
		$current_stock = $row[csf('current_stock')];
		$recipe_type = $row[csf('recipe_type')];
		$surplus_solution = $row[csf('surplus_solution')];
		$pickup = $row[csf('pickup')];
		$batch_wgt = $row[csf('batch_qty')];//pickup,p.batch_qty
		$current_stock_check=number_format($current_stock,7,'.','');
		//(Batch weight*Pick Up/100)+Surplus Solution;
		$total_solution=($batch_wgt*$pickup/100)+$surplus_solution;
		
		$ratio = $row[csf('ratio')];
		if ($row[csf('dose_base')] == 1) 
		{
			if ($row[csf('entry_form')] == 60) 
			{ 
				$perc_calculate_qnty = $row[csf('total_liquor_dtls')];

			} 
			else 
			{
				$perc_calculate_qnty = $row[csf('total_liquor_dtls')];
			}

			if($recipe_type==2) //CBP
			{
				$recipe_qnty = ($total_solution * $ratio) / 1000;
			}
			else
			{
				$recipe_qnty = ($perc_calculate_qnty * $ratio) / 1000;
			}
		} 
		else if ($row[csf('dose_base')] == 2) 
		{
			if ($row[csf('entry_form')] == 60) 
			{
				$perc_calculate_qnty = $row[csf('new_batch_weight')];
			} 
			else if ($row[csf('entry_form')] == 59) {
				$perc_calculate_qnty = $row[csf('batch_qty')];
			} 
			else 
			{
				$perc_calculate_qnty = $row[csf('batch_no')];
			}
			if($recipe_type==2) //CBP
			{
				$recipe_qnty = ($total_solution * $ratio) / 1000;
			}
			else
			{
				$recipe_qnty = ($perc_calculate_qnty * $ratio) / 100;
			}
		}
		//if($row[csf('item_category_id')]==5)
		//{
			//echo $recipe_qnty.'='.$row[csf('avg_rate_per_unit')].'<br>';
		$chmecal_costDataArr[$row[csf('prod_id')]]['cost'] += $recipe_qnty*$row[csf('avg_rate_per_unit')];
		$chmecal_costDataArr[$row[csf('prod_id')]]['qnty'] += $recipe_qnty;
		$chmecal_costDataArr[$row[csf('prod_id')]]['desc'] = $row[csf('item_description')];
		$chmecal_costDataArr[$row[csf('prod_id')]]['uom'] = $row[csf('unit_of_measure')];
		
		$tot_recCost+=$recipe_qnty*$row[csf('avg_rate_per_unit')];
		//}
	}
	
	// echo $tot_recCost;die;
	  $sql_dyes = "(SELECT a.id as prod_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,a.avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, a.id, a.item_category_id, a.item_group_id, a.sub_group_name, a.item_description, a.item_size,a.current_stock, a.unit_of_measure, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
		from pro_recipe_entry_mst p, product_details_master a, pro_recipe_entry_dtls b,pro_batch_create_mst c  
		where p.id=b.mst_id and a.id=b.prod_id and p.batch_id=c.id and b.ratio>0  and b.status_active=1 and b.is_deleted=0 $company_cond $wo_company_idcond and a.status_active=1 and a.is_deleted=0 $batchCond and p.entry_form in(59,60) and a.item_category_id in (6) and c.id in($batch_id) ) 
		union 
		(
		SELECT 0 as prod_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,0 as avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, b.prod_id as id, null as item_category_id, null as item_group_id, null as sub_group_name, null as item_description, null as item_size,null as current_stock, null as unit_of_measure, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments
			from pro_recipe_entry_mst p, pro_recipe_entry_dtls b,pro_batch_create_mst c  
			where p.id=b.mst_id and p.batch_id=c.id and b.status_active=1 and b.is_deleted=0 $wo_company_idcond  and b.status_active=1 and b.is_deleted=0 and b.prod_id=0 and b.sub_process_id in(93,94,95,96,97,98) and p.status_active=1 and p.is_deleted=0 $batchCond and p.entry_form in(59,60)  and c.id in($batch_id) )  order by sub_seq,seq_no";
	// echo $sql;die();
	$dyes_costDataArr = array();
	$res_chemical = sql_select($sql_dyes);
	$tot_recCost=0;
	foreach ($res_chemical as $row) 
	{
		$current_stock = $row[csf('current_stock')];
		$recipe_type = $row[csf('recipe_type')];
		$surplus_solution = $row[csf('surplus_solution')];
		$pickup = $row[csf('pickup')];
		$batch_wgt = $row[csf('batch_qty')];//pickup,p.batch_qty
		$current_stock_check=number_format($current_stock,7,'.','');
		//(Batch weight*Pick Up/100)+Surplus Solution;
		$total_solution=($batch_wgt*$pickup/100)+$surplus_solution;
		
		$ratio = $row[csf('ratio')];
		if ($row[csf('dose_base')] == 1) 
		{
			if ($row[csf('entry_form')] == 60) 
			{ 
				$perc_calculate_qnty = $row[csf('total_liquor_dtls')];

			} 
			else 
			{
				$perc_calculate_qnty = $row[csf('total_liquor_dtls')];
			}

			if($recipe_type==2) //CBP
			{
				$recipe_qnty = ($total_solution * $ratio) / 1000;
			}
			else
			{
				$recipe_qnty = ($perc_calculate_qnty * $ratio) / 1000;
			}
		} 
		else if ($row[csf('dose_base')] == 2) 
		{
			if ($row[csf('entry_form')] == 60) 
			{
				$perc_calculate_qnty = $row[csf('new_batch_weight')];
			} 
			else if ($row[csf('entry_form')] == 59) {
				$perc_calculate_qnty = $row[csf('batch_qty')];
			} 
			else 
			{
				$perc_calculate_qnty = $row[csf('batch_no')];
			}
			if($recipe_type==2) //CBP
			{
				$recipe_qnty = ($total_solution * $ratio) / 1000;
			}
			else
			{
				$recipe_qnty = ($perc_calculate_qnty * $ratio) / 100;
			}
		}
		//if($row[csf('item_category_id')]==5)
		//{
			//echo $recipe_qnty.'='.$row[csf('avg_rate_per_unit')].'<br>';
		$dyes_costDataArr[$row[csf('prod_id')]]['cost'] += $recipe_qnty*$row[csf('avg_rate_per_unit')];
		$dyes_costDataArr[$row[csf('prod_id')]]['qnty'] += $recipe_qnty;
		$dyes_costDataArr[$row[csf('prod_id')]]['desc'] = $row[csf('item_description')];
		$dyes_costDataArr[$row[csf('prod_id')]]['uom'] = $row[csf('unit_of_measure')];
		
		//$tot_recCost+=$recipe_qnty*$row[csf('avg_rate_per_unit')];
		//}
	}
	?>
    <script>
		function print_window()
		{
			var w = window.open("Surprise", "#");
			var d = w.document.open();
			d.write ('<!DOCTYPE HTML PUBLIC "-//W3C//DTsD HTML 4.01//EN""http://www.w3.org/TR/html4/strict.dtd">'+
			'<html><head><link rel="stylesheet" href="../../../../css/style_common.css" type="text/css" media="print"/><title></title></head><body>'+document.getElementById('report_div').innerHTML+'</body</html>');
			d.close();
		}	
	</script>	
	<div style="width:770px; margin-left:30px" id="report_div">
     <!--<div style="width:870px;" align="center"><input  type="button" value="Print Preview" onClick="print_window()" style="width:100px"  class="formbutton"/></div>-->
    <div style="width:770px; font-family:'Arial Narrow'; font-size:14px;">Dyes</div>
    <table align="center" cellspacing="0" width="770" border="1" rules="all" class="rpt_table" >
        <thead align="center">
    	   <tr>
                <th width="50">SL</th>
                <th width="50">Product Id</th>
                <th width="250">Item Description</th>
                <th width="100">UOM</th>
                <th width="100">Quantity</th>
                <th width="100">Avg. Rate</th> 
                <th>Amount(BDT)</th>
           </tr>
		</thead>
		<?  
		$i=1;
		foreach($dyes_costDataArr as $prod_id=>$row)
		{
			if ($i%2==0)  
				$bgcolor="#E9F3FF";
			else
				$bgcolor="#FFFFFF";
			?>
			<tbody>
				<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('trDys_<? echo $i; ?>','<? echo $bgcolor;?>')" id="trDys_<? echo $i; ?>">
					<td align="center"><? echo $i; ?></td>
					<td align="center"><? echo $prod_id; ?></td>
					<td><? echo $row[("desc")]; ?></td>
					<td align="center"><? echo $unit_of_measurement[$row[("unit_of_measure")]]; ?></td>
					<td align="right"><? echo number_format($row[("qnty")],4,'.',''); $total_dyeing_qnty+=$row[("qnty")]; ?></td>
					<td align="right"><? echo number_format($row[("cost")]/$row[("qnty")],4,'.',''); ?></td>
					<td align="right"><? $amount=0; $amount=$row[("cost")]; echo  number_format($amount,6,'.',''); $total_dyeing_amount+=$amount; ?></td>
				</tr>
			</tbody>
			<? 
			$i++;
		}
		?>
        <tfoot>
        	<tr>
                <th colspan="4" align="right">Total:</th>
                <th align="right"><? echo number_format($total_dyeing_qnty,2,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_dyeing_amount,2,'.',''); ?></th>
            </tr>
        </tfoot>
      </table>
      
      <div style="width:770px; font-family:'Arial Narrow'; font-size:14px;">Chemical</div>
    <table align="center" cellspacing="0" width="770" border="1" rules="all" class="rpt_table" >
        <thead align="center">
    	   <tr>
                <th width="50">SL</th>
                <th width="50">Product Id</th>
                <th width="250">Item Description</th>
                <th width="100">UOM</th>
                <th width="100">Quantity</th>
                <th width="100">Avg. Rate</th> 
                <th>Amount(BDT)</th>
           </tr>
		</thead>
		<?  
		foreach($chmecal_costDataArr as $prod_id=>$row)
		{
			if ($i%2==0)  
				$bgcolor="#E9F3FF";
			else
				$bgcolor="#FFFFFF";
			?>
			<tbody>
				<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('trChemi_<? echo $i; ?>','<? echo $bgcolor;?>')" id="trChemi_<? echo $i; ?>">
					<td align="center"><? echo $i; ?></td>
					<td align="center"><? echo $prod_id; ?></td>
					<td><? echo $row[("desc")]; ?></td>
					<td align="center"><? echo $unit_of_measurement[$row[("unit_of_measure")]]; ?></td>
					<td align="right"><? echo number_format($row[("qnty")],4,'.',''); $total_chemical_qnty+=$row[("qnty")]; ?></td>
					<td align="right"><? echo number_format($row[("cost")]/$row[("qnty")],4,'.',''); ?></td>
					<td align="right"><? $amount=0; $amount=$row[("cost")]; echo  number_format($amount,6,'.',''); $total_chemical_amount+=$amount; ?></td>
				</tr>
			</tbody>
			<? 
			$i++;
		}
		?>
        <tfoot>
        	<tr>
                <th colspan="4" align="right">Total:</th>
                <th align="right"><? echo number_format($total_chemical_qnty,2,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_chemical_amount,2,'.',''); ?></th>
            </tr>
        </tfoot>
      </table>
    </div>
    <?         
	exit();
}
if($action=="1st_chemi_dyes_batch_dtls_popup") // batch Wise 2
{
	echo load_html_head_contents("Batch Details", "../../../../", 1, 1,$unicode,'','');
	extract($_REQUEST);
	//echo $batch_id;die;
	//$batch_non_redyeing_id=return_field_value("id","pro_batch_create_mst","batch_against<>2 and status_active=1 and id in($batch_id)","id");
	//if($batch_non_redyeing_id=="")die;
	
	// $batch_id_conds = ($batch_type==3) ? str_replace("b.id", "a.batch_id", $re_dying_cond2) : str_replace("b.re_dyeing_from", "a.batch_id", $re_dying_cond);
	// echo $req_id.'SS';die;
	$req_idArr=array_unique(explode(",",$req_id));
	//print_r($req_idArr);die;
	$req_idCond="and b.mst_id in($req_id)";
	$batch_idCond="and a.batch_id in($batch_id)";
	  $sql_req = "SELECT a.ID,b.mst_id as REQ_ID,a.batch_id as BATCH_ID,a.BATCH_QTY,a.NEW_BATCH_WEIGHT,a.ENTRY_FORM,c.batch_id as RE_BATCH_ID from pro_recipe_entry_mst a, dyes_chem_requ_recipe_att b,dyes_chem_issue_requ_mst c where b.recipe_id=a.id  and c.id=b.mst_id  $batch_idCond  and a.status_active=1 and a.is_deleted=0 and b.status_active=1";
	 // echo $sql_req;//die;
	$req_res = sql_select($sql_req);
	if(count($req_res)<=0)
	{
		//echo "<di> No Data Found</div"; 
	}
	$req_id_array = array();
	foreach ($req_res as $val) 
	{
		$recipe_id_array[$val['ID']] = $val['ID'];
		$req_id_array[$val['REQ_ID']] = $val['REQ_ID'];
		$batch_req_id_array[$val['BATCH_ID']].= $val['REQ_ID'].',';
		$batch_req_id_array2[$val['BATCH_ID']]= $val['REQ_ID'];
		$batch_all_id_array[$val['BATCH_ID']]= $val['BATCH_ID'];
		
		//if($batchWgtChkk[$val['REQ_ID']]=='')
		//{
			if($val['ENTRY_FORM']==60) //Adding Topping
			{
				$batch_wgt=$val['NEW_BATCH_WEIGHT'];
			}
			else
			{
				$batch_wgt=$val['BATCH_QTY'];
			}
			//echo $batch_wgt.',';
		$batch_wgt_array[$val['BATCH_ID']] = $batch_wgt;
		$batchWgtChkk[$val['REQ_ID']].=$val['BATCH_ID'].',';
		//}
	}
	unset($req_res);
	
	
	
	/*$batch_fabric_sql=sql_select("SELECT b.id,b.batch_no,b.batch_weight, b.batch_against
	from pro_recipe_entry_mst  a,pro_batch_create_mst b  where  a.batch_id=b.id 
	 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  $batch_ids_cond");
	 
	 
	 foreach ($batch_fabric_sql as $row) 
	{
		//$batch_req_id=$batch_req_id_array2[$row[csf("id")]];
		//echo $batch_req_id.'d';
		//$batch_wgt_arr[$batch_req_id]['batchWgt']+=$row[csf("batch_weight")];
	//$batch_weight=$row[csf("batch_weight")];
	}*/
	 
	 

	if(count($req_id_array))
	{
		$requisition_id_cond=where_con_using_array($req_id_array,0,"a.requisition_no");
	}

	$issue_sql = sql_select("SELECT a.MST_ID ,a.REQUISITION_NO,b.BATCH_NO,a.ITEM_CATEGORY,a.PROD_ID,a.CONS_QUANTITY,a.CONS_AMOUNT from inv_transaction a,inv_issue_master b where a.mst_id=b.id and b.entry_form=5 and b.is_deleted=0 and b.status_active=1 and a.status_active=1 and a.transaction_type=2   $requisition_id_cond ");
  

	$issue_id_arr = array();$tot_amt=0;$tot_deys_issue_amt_popA=0;
	foreach ($issue_sql as $val) 
	{
		$batchArr=explode(",",$val['BATCH_NO']);
		foreach($batchArr as $bid)
		{
			$issue_item_cat_arr[$bid][$val['PROD_ID']][$val['ITEM_CATEGORY']]=$val['ITEM_CATEGORY'];
			$batch_all_id_array[$bid]=$bid;
			$batch_Req_id_array[$val['REQUISITION_NO']]=$val['BATCH_NO'];
		}
		$issue_item_cat_qty_arr[$val['PROD_ID']][$val['ITEM_CATEGORY']]+=$val['CONS_QUANTITY'];
		$issue_item_cat_amt_arr[$val['PROD_ID']][$val['ITEM_CATEGORY']]+=$val['CONS_AMOUNT'];
		
		$issue_item_cat_amt_arr2[$val['REQUISITION_NO']][$val['PROD_ID']][$val['ITEM_CATEGORY']]+=$val['CONS_AMOUNT'];
		
		//$issue_id_arr[$val['MST_ID']] = $val['MST_ID'];
		$issue_id_arr[$val['MST_ID']] = $val['MST_ID'];
		$tot_amt+=$val['CONS_AMOUNT'];
		
					
					
	}
	
	//print_r($batch_Req_id_array);
	if(count($batch_all_id_array))
	{
		$batch_ids_cond=where_con_using_array($batch_all_id_array,0,"b.id");
	}
	 
	
	$batch_fabric_sql=sql_select("SELECT b.id,b.batch_no,b.batch_weight, b.batch_against
	from pro_recipe_entry_mst  a,pro_batch_create_mst b  where  a.batch_id=b.id 
	 and a.status_active=1 and a.is_deleted=0 $batch_ids_cond group by  b.id,b.batch_no,b.batch_weight, b.batch_against" );
	 
	 foreach ($batch_fabric_sql as $row) 
	{
		//$batch_req_id=$batch_req_id_array2[$row[csf("id")]];
		//echo $batch_req_id.'d';
		$batch_wgt_arr[$row[csf("id")]]['batchWgt']=$row[csf("batch_weight")];
	}
	 $batch_weight=$batch_wgt_arr[$batch_id]['batchWgt'];
	 
	 foreach ($issue_sql as $val) 
	{
		$item_cat= $val['ITEM_CATEGORY'];
		
		//$all_batchIds=rtrim($batch_Req_id,',');
					$batIdArr=array_unique(explode(",",$val['BATCH_NO'])); 
					$tot_batch_wgt=0;
					foreach($batIdArr as $batchId)
					{
						//$tot_batch_wgt+=$batch_description_arr[$batchId]['batch_weight'];
							$tot_batch_wgt+=$batch_wgt_arr[$batchId]['batchWgt']; 
					}
					$issue_item_cat_dyes=$val['CONS_AMOUNT'];
					$issue_dyesQty=$val['CONS_QUANTITY'];
				//	 echo $tot_batch_wgt.'='.$issue_item_cat_dyes.'='.$batch_weight.'<br> ';
					if($issue_item_cat_dyes>0)
					{
						if($item_cat==6)
						{
							$tot_deys_amt=($issue_item_cat_dyes/$tot_batch_wgt)*$batch_weight;
							$dyes_issue_item_cat_amt_arr[$val['PROD_ID']]['cost']+=$tot_deys_amt;
							
							$tot_deys_qty=($issue_dyesQty/$tot_batch_wgt)*$batch_weight;
							$dyes_issue_item_cat_amt_arr[$val['PROD_ID']]['qty']+=$tot_deys_qty;
							
							//$tot_deys_issue_amt_popA+=($issue_item_cat_dyes/$tot_batch_wgt)*$batch_weight;
					
						}
						else if($item_cat==5 || $item_cat==7)
						{
							$tot_chekical_amt=($issue_item_cat_dyes/$tot_batch_wgt)*$batch_weight;
							$chemical_issue_item_cat_amt_arr[$val['PROD_ID']]['cost']+=$tot_chekical_amt;
						//	echo $item_cat.'='.$tot_chekical_amt.'<br>';
							
							$tot_chemical_qty=($issue_dyesQty/$tot_batch_wgt)*$batch_weight;
							$chemical_issue_item_cat_amt_arr[$val['PROD_ID']]['qty']+=$tot_chemical_qty;
							
						//$tot_deys_issue_amt_popA+=($issue_item_cat_dyes/$tot_batch_wgt)*$batch_weight;
					
						}
					}
		
	}
	
	// echo $tot_deys_issue_amt_popA.'DD';die;
	
    $sql_dtls_dyes = "select a.batch_no,b.item_category,c.id as prod_id, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit, (b.cons_quantity) as qnty,(b.cons_amount) as cons_amount
	from inv_issue_master a,inv_transaction b, product_details_master c
	where a.id=b.mst_id and b.prod_id=c.id and b.transaction_type=2 and a.entry_form=5 and a.batch_no  is not null and b.status_active=1 and b.requisition_no in($req_id)    "; 
	$res_dyes_chemical = sql_select($sql_dtls_dyes);
	foreach ($res_dyes_chemical as $row) 
	{
		$batchArr=explode(",",$row[csf('batch_no')]);
		foreach($batchArr as $bid)
		{
			//$surplus_solution = $row[csf('surplus_solution')];
			$issue_item_cat_arr[$bid][$row[csf('prod_id')]][$row[csf('item_category')]]=$row[csf('item_category')];
		}
		$batch_desc_arr[$row[csf("prod_id")]]['desc']=$row[csf("product_name_details")];
		$batch_desc_arr[$row[csf("prod_id")]]['unit_of_measure']=$row[csf("unit_of_measure")];
		
	}
	
	//and a.item_category_id in(5,6,7,23)  and p.id in(".implode(",",$recipe_id_array).")
	/*  $sql = "(SELECT a.id as prod_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,a.avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, a.id, a.item_category_id, a.item_group_id, a.sub_group_name, a.item_description, a.item_size,a.current_stock, a.unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments,c.batch_weight
		from pro_recipe_entry_mst p, product_details_master a, pro_recipe_entry_dtls b,pro_batch_create_mst c  
		where p.id=b.mst_id and a.id=b.prod_id and p.batch_id=c.id and b.ratio>0 and p.batch_qty>0   and b.status_active=1 and b.is_deleted=0 $company_cond $wo_company_idcond and a.status_active=1 and a.is_deleted=0 $batchCond and p.entry_form in(59,60) and a.item_category_id in (5,7,6)  and p.batch_id in($batch_id) ) 
		union 
		(
		SELECT 0 as prod_id,p.total_liquor,p.recipe_type,p.surplus_solution,p.pickup,0 as avg_rate_per_unit, p.batch_id, p.entry_form,p.batch_qty,c.batch_no, b.prod_id as id, null as item_category_id, null as item_group_id, null as sub_group_name, null as item_description, null as item_size,null as current_stock, null as unit_of_measure,b.prod_id, b.sub_process_id, b.dose_base, b.ratio, b.seq_no,b.sub_seq, b.new_batch_weight, b.new_total_liquor,b.liquor_ratio as liquor_ratio_dtls,b.total_liquor as total_liquor_dtls, b.item_lot, b.store_id ,b.comments,c.batch_weight
			from pro_recipe_entry_mst p, pro_recipe_entry_dtls b,pro_batch_create_mst c  
			where p.id=b.mst_id and p.batch_id=c.id and b.status_active=1 and b.is_deleted=0 $wo_company_idcond  and b.status_active=1 and b.is_deleted=0 and b.prod_id=0 and b.sub_process_id in(93,94,95,96,97,98) and p.status_active=1 and p.is_deleted=0 $batchCond and p.entry_form in(59,60)    and p.batch_id in($batch_id) )  order by sub_seq,seq_no";
	// echo $sql;die(); //and  p.id in(".implode(",",$recipe_id_array).")
	$costDataArr = array();
	$res_chemical = sql_select($sql);
	$tot_recCost=0;
	foreach ($res_chemical as $row) 
	{
		$current_stock = $row[csf('current_stock')];
		$recipe_type = $row[csf('recipe_type')];
		$surplus_solution = $row[csf('surplus_solution')];
		$pickup = $row[csf('pickup')];
		$batch_wgt = $row[csf('batch_qty')];//pickup,p.batch_qty
		$current_stock_check=number_format($current_stock,7,'.','');
		//(Batch weight*Pick Up/100)+Surplus Solution;
		$total_solution=($batch_wgt*$pickup/100)+$surplus_solution;
		
		$ratio = $row[csf('ratio')];
		if ($row[csf('dose_base')] == 1) 
		{
			if ($row[csf('entry_form')] == 60) 
			{ 
				$perc_calculate_qnty = $row[csf('total_liquor_dtls')];

			} 
			else  
			{
				$perc_calculate_qnty = $row[csf('total_liquor_dtls')];
			}

			if($recipe_type==2) //CBP
			{
				$recipe_qnty = ($total_solution * $ratio) / 1000;
			}
			else
			{
				$recipe_qnty = ($perc_calculate_qnty * $ratio) / 1000;
			}
		} 
		else if ($row[csf('dose_base')] == 2) 
		{
			if ($row[csf('entry_form')] == 60) 
			{
				$perc_calculate_qnty = $row[csf('new_batch_weight')];
			} 
			else if ($row[csf('entry_form')] == 59) {
				$perc_calculate_qnty = $row[csf('batch_qty')];
			} 
			else 
			{
				$perc_calculate_qnty = $row[csf('batch_no')];
			}
			if($recipe_type==2) //CBP
			{
				$recipe_qnty = ($total_solution * $ratio) / 1000;
			}
			else
			{
				$recipe_qnty = ($perc_calculate_qnty * $ratio) / 100;
			}
		}
		//if($issue_item_cat_arr[$row[csf('batch_id')]][$row[csf('prod_id')]][$row[csf('item_category_id')]])
		//{
		$batch_req_id=rtrim($batch_req_id_array[$row[csf('batch_id')]],',');
		$batch_req_idArr=array_unique(explode(",",$batch_req_id_array[$row[csf('batch_id')]]));
		$tot_batch_wgt=$batch_wgt_array[$row[csf('batch_id')]];
		$batch_qty=$row[csf('batch_weight')];
		if($issue_item_cat_arr[$row[csf('batch_id')]][$row[csf('prod_id')]][$row[csf('item_category_id')]])
		{
		 	$issue_qty=0;
			foreach($batch_req_idArr as $req_id)
			{
			$issue_qty+=$issue_item_cat_cost_arr[$req_id][$row[csf('prod_id')]][$row[csf('item_category_id')]];
			// echo $issue_qty.'='. $tot_batch_wgt.'='.$batch_qty.'<br>';
			}
			$issue_perKg=($issue_qty/$tot_batch_wgt);
			$issue_wgt_per=$issue_perKg*$batch_qty;
		//echo $batch_qty.'=Ch='.$tot_batch_wgt.'<br>';
			//echo $issue_qty.'='.$tot_batch_wgt.'='.$row[csf('avg_rate_per_unit')].'<br>';
		$dyes_chmecal_costDataArr[$row[csf('prod_id')]][$row[csf('item_category_id')]]['cost'] += $issue_wgt_per*$row[csf('avg_rate_per_unit')];
		
		$chmecal_costDataArr[$row[csf('prod_id')]]['cost'] += $issue_wgt_per*$row[csf('avg_rate_per_unit')];
		$chmecal_costDataArr[$row[csf('prod_id')]]['qnty'] += $batch_qty*$issue_perKg;
		$chmecal_costDataArr[$row[csf('prod_id')]]['desc'] = $row[csf('item_description')];
		$chmecal_costDataArr[$row[csf('prod_id')]]['unit_of_measure'] = $row[csf('unit_of_measure')];
		$chmecal_costDataArr[$row[csf('prod_id')]]['req_id'] = $batch_req_id;
		
		$tot_recCost+=$recipe_qnty*$row[csf('avg_rate_per_unit')];
		}
	}
	*/
	 
		 
	?>
    <script>
		function print_window()
		{
			var w = window.open("Surprise", "#");
			var d = w.document.open();
			d.write ('<!DOCTYPE HTML PUBLIC "-//W3C//DTsD HTML 4.01//EN""http://www.w3.org/TR/html4/strict.dtd">'+
			'<html><head><link rel="stylesheet" href="../../../../css/style_common.css" type="text/css" media="print"/><title></title></head><body>'+document.getElementById('report_div').innerHTML+'</body</html>');
			d.close();
		}	
	</script>	
	<div style="width:770px; margin-left:30px" id="report_div">
     <!--<div style="width:870px;" align="center"><input  type="button" value="Print Preview" onClick="print_window()" style="width:100px"  class="formbutton"/></div>-->
    <div style="width:770px; font-family:'Arial Narrow'; font-size:14px;">Dyes</div>
      <table align="center" cellspacing="0" width="770" border="1" rules="all" class="rpt_table" >
        <thead align="center">
    	   <tr>
                <th width="50">SL</th>
                <th width="50">Product Id</th>
                <th width="250">Item Description</th>
                <th width="100">UOM</th>
                <th width="100">Quantity</th>
                <th width="100">Avg. Rate</th> 
                <th>Amount(BDT)</th>
           </tr>
		</thead>
		<?  
		//echo $req_id.'D';
		//$req_idArr=array_unique(explode(",",$req_id));
		//print_r($req_idArr);
		$i=1;$total_dyeing_qnty=0;
		if(count($dyes_issue_item_cat_amt_arr)<=0)
		{
			echo "<di> No Data Found</div"; 
		}

		foreach($dyes_issue_item_cat_amt_arr as $prod_id=>$row)
		{
			 
			if ($i%2==0)  
				$bgcolor="#E9F3FF";
			else
				$bgcolor="#FFFFFF";
					
				$desc=$batch_desc_arr[$prod_id]['desc'];//$chmecal_costDataArr[$prod_id]['desc'];;
				$unit_of_measure=$batch_desc_arr[$prod_id]['unit_of_measure'];
				$dyes_issue_wgt_perAmt=$row['cost']; $issue_wgt_perQty=$row['qty'];
			?>
			<tbody>
				<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('trDys_<? echo $i; ?>','<? echo $bgcolor;?>')" id="trDys_<? echo $i; ?>">
					<td align="center"><? echo $i; ?></td>
					<td align="center"><? echo $prod_id; ?></td>
					<td><? echo $desc; ?></td>
					<td align="center"><? echo $unit_of_measurement[$unit_of_measure]; ?></td>
					<td align="right"><? echo number_format($issue_wgt_perQty,4,'.',''); $total_dyeing_qnty+=$issue_wgt_perQty; ?></td>
					<td align="right"><? echo number_format($dyes_issue_wgt_perAmt/$issue_wgt_perQty,4,'.',''); ?></td>
					<td align="right"><?  echo  number_format($dyes_issue_wgt_perAmt,6,'.',''); $total_dyeing_amount+=$dyes_issue_wgt_perAmt; ?></td>
				</tr>
			</tbody>
			<? 
			$i++;
				 
		}
		?>
        <tfoot>
        	<tr>
                <th colspan="4" align="right">Total:</th>
                <th align="right"><? echo number_format($total_dyeing_qnty,4,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_dyeing_amount,2,'.',''); ?></th>
            </tr>
        </tfoot>
      </table>
      
      <div style="width:770px; font-family:'Arial Narrow'; font-size:14px;">Chemical</div>
    <table align="center" cellspacing="0" width="770" border="1" rules="all" class="rpt_table" >
        <thead align="center">
    	   <tr>
                <th width="50">SL</th>
                <th width="50">Product Id</th>
                <th width="250">Item Description</th>
                <th width="100">UOM</th>
                <th width="100">Quantity</th>
                <th width="100">Avg. Rate</th> 
                <th>Amount(BDT)</th>
           </tr>
		</thead>
		<?  
		//print_r($chemical_issue_item_cat_amt_arr);
		foreach($chemical_issue_item_cat_amt_arr as $prod_id=>$row) 
		{
			if ($i%2==0)  
				$bgcolor="#E9F3FF";
			else
				$bgcolor="#FFFFFF";
				//$chemical_issue_amt=0;
				//$chemi_batch_Req_id='';
				
				 $che_desc=$batch_desc_arr[$prod_id]['desc'];//$chmecal_costDataArr[$prod_id]['desc'];;
				$che_unit_of_measure=$batch_desc_arr[$prod_id]['unit_of_measure'];
			
				//$dyes_issue_wgt_perAmt=$row['cost']; 
				//$issue_wgt_perQty=$row['qty'];
				
				  
			//$che_issue_perKg=($tot_chemical_issue_amt/$chemi_tot_batch_wgt);
			$che_issue_wgt_perAmt=$row['cost'];//$che_issue_perKg*$batch_weight;
			
			//$chemical_issue_qty=$issue_item_cat_qty_arr[$prod_id][5]+$issue_item_cat_qty_arr[$prod_id][7];
			//$che_issue_perKgQty=($chemical_issue_qty/$chemi_tot_batch_wgt);
			$che_issue_wgt_perQty=$row['qty'];//$che_issue_perKgQty*$batch_weight;
			
			?>
			<tbody>
				<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('trChemi_<? echo $i; ?>','<? echo $bgcolor;?>')" id="trChemi_<? echo $i; ?>">
					<td align="center"><? echo $i; ?></td>
					<td align="center"><? echo $prod_id; ?></td>
					<td><? echo $che_desc; ?></td>
					<td align="center"><? echo $unit_of_measurement[$che_unit_of_measure]; ?></td>
					<td align="right"><? echo number_format($che_issue_wgt_perQty,4,'.',''); $total_chemical_qnty+=$che_issue_wgt_perQty; ?></td>
					<td align="right"><? echo number_format($che_issue_wgt_perAmt/$che_issue_wgt_perQty,4,'.',''); ?></td>
					<td align="right"><? $amount=0; $amount=$che_issue_wgt_perAmt; echo  number_format($amount,6,'.',''); $total_chemical_amount+=$amount; ?></td>
				</tr>
			</tbody>
			<? 
			$i++;
		}
		?>
        <tfoot>
        	<tr>
                <th colspan="4" align="right">Total:</th>
                <th align="right"><? echo number_format($total_chemical_qnty,4,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_chemical_amount,2,'.',''); ?></th>
            </tr>
        </tfoot>
      </table>
    </div>
    <?         
	exit();
}

if($action=="1st_batch_dtls_popup2")
{
	echo load_html_head_contents("Batch Details", "../../../../", 1, 1,$unicode,'','');
	extract($_REQUEST);
	
	$batch_non_redyeing_id=return_field_value("id","pro_batch_create_mst","batch_against<>2 and status_active=1 and id in($batch_id)","id");
	//if($batch_non_redyeing_id=="")die;
	//$batch_idCond=where_con_using_array($batch_id_arr,0,'b.id');
	 $batchAgainst="";
	 if($type==1) 
	 { 
	 $typeCond="First Dying Cost";
	 $batchAgainst="and b.batch_against in(1)";
	 }
	 else if($type==2)
	 { 
	 $typeCond="Adding Cost";
	 }
	 else if($type==3) 
	 { 
	 $typeCond="Topping Cost";
	 }
	 else if($type==4) 
	 { 
	  $typeCond="Redying  Cost";
	 }
	 else if($type==5) 
	 { 
	  $typeCond="Finishing  Cost";
	 }
	  
	$result_recipe_sql=sql_select("select b.batch_against,b.id as batch_id ,b.batch_no,a.dyeing_re_process,a.entry_form
		from pro_recipe_entry_mst a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (60,445) and a.status_active=1 and a.is_deleted=0  and b.status_active=1 and b.is_deleted=0 and b.id in($batch_id) $batchAgainst order by b.id");
		 
		foreach($result_recipe_sql as $row)
		{
			if($row[csf("entry_form")]==60)
			{
			$batch_recipe_chk[$row[csf("batch_id")]]=$row[csf("dyeing_re_process")];
			$re_dyeing_batch_arr[$row[csf("batch_id")]]=$row[csf("batch_against")];
			}
			
			if($row[csf("entry_form")]==445) //Finishing Recipe
			{
		 		$finishing_dyeing_batch_arr[$row[csf("batch_id")]]=$row[csf("batch_id")];
				
				$re_dyeing_batch_arr[$row[csf("batch_id")]]=$row[csf("batch_against")];
			}
		}
	 unset($result_recipe_sql);
	 
	//if($batch_non_redyeing_id!="") $batch_cond=" and a.batch_no like '$batch_non_redyeing_id'";
	$batch_cond="and a.batch_no like '$batch_id'";
	$mst_id_cond="and a.id in($mst_id)";
	$prod_id_cond="and b.prod_id in($prod_id)";
	
	 $sql_dtls_dyes = "select c.id as prod_id, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit, sum(b.cons_quantity) as qnty,sum(b.cons_amount) as cons_amount
	from inv_issue_master a,inv_transaction b, product_details_master c
	where a.id=b.mst_id and b.prod_id=c.id and b.transaction_type=2 and a.entry_form=5 and a.batch_no  is not null and b.item_category in (6) and b.status_active=1 $mst_id_cond $prod_id_cond  $batch_cond group by c.id, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit";
	// echo $sql_dtls_dyes;die;
	$sql_result_dyes= sql_select($sql_dtls_dyes);
	foreach($sql_result_dyes as $row)
	{
		
		
		$dyes_batch_wise_arr[$row[csf("prod_id")]]['prod_id']=$row[csf("prod_id")];	
		$dyes_batch_wise_arr[$row[csf("prod_id")]]['product_name_details']=$row[csf("product_name_details")];	
		$dyes_batch_wise_arr[$row[csf("prod_id")]]['unit_of_measure']=$row[csf("unit_of_measure")];
		$dyes_batch_wise_arr[$row[csf("prod_id")]]['qnty']+=$row[csf("qnty")];
		$dyes_batch_wise_arr[$row[csf("prod_id")]]['avg_rate_per_unit']=$row[csf("avg_rate_per_unit")];
		$dyes_batch_wise_arr[$row[csf("prod_id")]]['cons_amount']+=$row[csf("cons_amount")];
	}
	
	
	$sql_dtls_chemical = "select c.id as prod_id, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit, (b.cons_quantity) as qnty,(b.cons_amount) as cons_amount
	from inv_issue_master a,inv_transaction b, product_details_master c
	where a.id=b.mst_id and b.prod_id=c.id and b.transaction_type=2 and a.entry_form=5 and a.batch_no  is not null  and b.item_category in (5,7)  and b.status_active=1 $mst_id_cond $prod_id_cond  $batch_cond"; 
	//echo $sql_dtls;die;  group by c.id, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit
	$sql_result_chemical= sql_select($sql_dtls_chemical);
	
	foreach($sql_result_chemical as $row)
	{
		$chemi_batch_wise_arr[$row[csf("prod_id")]]['prod_id']=$row[csf("prod_id")];	
		$chemi_batch_wise_arr[$row[csf("prod_id")]]['product_name_details']=$row[csf("product_name_details")];	
		$chemi_batch_wise_arr[$row[csf("prod_id")]]['unit_of_measure']=$row[csf("unit_of_measure")];
		$chemi_batch_wise_arr[$row[csf("prod_id")]]['qnty']+=$row[csf("qnty")];
		$chemi_batch_wise_arr[$row[csf("prod_id")]]['avg_rate_per_unit']=$row[csf("avg_rate_per_unit")];
		$chemi_batch_wise_arr[$row[csf("prod_id")]]['cons_amount']+=$row[csf("cons_amount")];
	}
	?>
    <script>
		function print_window()
		{
			var w = window.open("Surprise", "#");
			var d = w.document.open();
			d.write ('<!DOCTYPE HTML PUBLIC "-//W3C//DTsD HTML 4.01//EN""http://www.w3.org/TR/html4/strict.dtd">'+
			'<html><head><link rel="stylesheet" href="../../../../css/style_common.css" type="text/css" media="print"/><title></title></head><body>'+document.getElementById('report_div').innerHTML+'</body</html>');
			d.close();
		}	
	</script>	
    <?
	
	 ?>
	<div style="width:770px; margin-left:30px" id="report_div">
     <!--<div style="width:870px;" align="center"><input  type="button" value="Print Preview" onClick="print_window()" style="width:100px"  class="formbutton"/></div>-->
    <div style="width:770px; font-family:'Arial Narrow'; font-size:14px;">Dyes <?  echo $typeCond; ?></div>
    <table align="center" cellspacing="0" width="770" border="1" rules="all" class="rpt_table" >
        <thead align="center">
    	   <tr>
                <th width="50">SL</th>
                <th width="50">Product Id</th>
                <th width="250">Item Description</th>
                <th width="100">UOM</th>
                <th width="100">Quantity</th>
                <th width="100">Avg. Rate</th> 
                <th>Amount(BDT)</th>
           </tr>
		</thead>
		<?  
		$i=1;
		foreach($dyes_batch_wise_arr as $prod_key=>$row)
		{
			if ($i%2==0)  
				$bgcolor="#E9F3FF";
			else
				$bgcolor="#FFFFFF";
			?>
			<tbody>
				<tr bgcolor="<? echo $bgcolor; ?>">
					<td align="center"><? echo $i; ?></td>
					<td align="center"><? echo $prod_key; ?></td>
					<td><? echo $row[("product_name_details")]; ?></td>
					<td align="center"><? echo $unit_of_measurement[$row[("unit_of_measure")]]; ?></td>
					<td align="right"><? echo number_format($row[("qnty")],4,'.',''); $total_dyeing_qnty+=$row[("qnty")]; ?></td>
					<td align="right"><? echo number_format($row[("avg_rate_per_unit")],4,'.',''); ?></td>
					<td align="right"><? $amount=0; $amount=$row[("cons_amount")]; echo  number_format($amount,6,'.',''); $total_dyeing_amount+=$amount; ?></td>
				</tr>
			</tbody>
			<? 
			$i++;
		}
		?>
        <tfoot>
        	<tr>
                <th colspan="4" align="right">Total:</th>
                <th align="right"><? echo number_format($total_dyeing_qnty,2,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_dyeing_amount,2,'.',''); ?></th>
            </tr>
        </tfoot>
      </table>
      
      <div style="width:770px; font-family:'Arial Narrow'; font-size:14px;">Chemical</div>
    <table align="center" cellspacing="0" width="770" border="1" rules="all" class="rpt_table" >
        <thead align="center">
    	   <tr>
                <th width="50">SL</th>
                <th width="50">Product Id</th>
                <th width="250">Item Description</th>
                <th width="100">UOM</th>
                <th width="100">Quantity</th>
                <th width="100">Avg. Rate</th> 
                <th>Amount(BDT)</th>
           </tr>
		</thead>
		<?  
		foreach($chemi_batch_wise_arr as $prod_id=>$row)
		{
			if ($i%2==0)  
				$bgcolor="#E9F3FF";
			else
				$bgcolor="#FFFFFF";
			?>
			<tbody>
				<tr bgcolor="<? echo $bgcolor; ?>">
					<td align="center"><? echo $i; ?></td>
					<td align="center"><? echo $prod_id; ?></td>
					<td><? echo $row[("product_name_details")]; ?></td>
					<td align="center"><? echo $unit_of_measurement[$row[("unit_of_measure")]]; ?></td>
					<td align="right"><? echo number_format($row[("qnty")],4,'.',''); $total_chemical_qnty+=$row[("qnty")]; ?></td>
					<td align="right"><? echo number_format($row[("avg_rate_per_unit")],4,'.',''); ?></td>
					<td align="right"><? $amount=0; $amount=$row[("cons_amount")]; echo  number_format($amount,6,'.',''); $total_chemical_amount+=$amount; ?></td>
				</tr>
			</tbody>
			<? 
			$i++;
		}
		?>
        <tfoot>
        	<tr>
                <th colspan="4" align="right">Total:</th>
                <th align="right"><? echo number_format($total_chemical_qnty,2,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_chemical_amount,2,'.',''); ?></th>
            </tr>
        </tfoot>
      </table>
    </div>
    <?         
	exit();
}
if($action=="total_batch_dtls_popup2") //For Show 2
{
	echo load_html_head_contents("Batch Details", "../../../../", 1, 1,$unicode,'','');
	extract($_REQUEST);
	//echo $batch_id;die;
	$batch_non_redyeing_id=return_field_value("id","pro_batch_create_mst","batch_against<>2 and status_active=1 and id in($batch_id)","id");
	$batch_redyeing_id=return_field_value("id","pro_batch_create_mst","batch_against=2 and status_active=1 and id in($batch_id)","id");
	$batch_from_redyeing_id=return_field_value("id","pro_batch_create_mst","batch_against=2 and status_active=1 and re_dyeing_from in($batch_id)","id");
	
	$result_recipe_sql=sql_select("select b.batch_against,b.id as batch_id ,b.batch_no,a.dyeing_re_process,a.entry_form
		from pro_recipe_entry_mst a, pro_batch_create_mst b where b.id=a.batch_id and a.entry_form in (60,445) and a.status_active=1 and a.is_deleted=0  and b.status_active=1 and b.is_deleted=0 and b.id in($batch_id)  order by b.id");
		 
		foreach($result_recipe_sql as $row)
		{
			if($row[csf("entry_form")]==60)
			{
			$batch_recipe_chk[$row[csf("batch_id")]]=$row[csf("dyeing_re_process")];
			$re_dyeing_batch_arr[$row[csf("batch_id")]]=$row[csf("batch_against")];
			}
			
			if($row[csf("entry_form")]==445) //Finishing Recipe
			{
		 		$finishing_dyeing_batch_arr[$row[csf("batch_id")]]=$row[csf("batch_id")];
				
				$re_dyeing_batch_arr[$row[csf("batch_id")]]=$row[csf("batch_against")];
			}
		}
	 unset($result_recipe_sql);
	 
	$batch_cond="";$first_batch_cond=""; $reding_batch_cond="";$reding_batch_cond="";
	//echo $batch_non_redyeing_id."##".$batch_redyeing_id."##".$batch_redyeing_id;die;
	if($batch_non_redyeing_id=="" && $batch_redyeing_id=="" && $batch_redyeing_id=="")
	{
		echo "No Data Found";
		die;
	}
	else
	{
		$batch_prefix=" and( ";
		if($batch_non_redyeing_id!="") $batch_cond=" batch_id like '$batch_non_redyeing_id'";
		if($batch_cond!="")  $batch_cond.="or";
		if($batch_redyeing_id!="") $batch_cond.=" batch_id like '$batch_redyeing_id'";
		if($batch_cond!="")  $batch_cond.="or";
		if($batch_from_redyeing_id!="") $batch_cond.=" batch_id like '$batch_from_redyeing_id'";
		$batch_cond=chop($batch_cond,"or");
		$batch_sufix=" )";
		if($batch_redyeing_id!="") $reding_batch_cond=" batch_id like '$batch_redyeing_id'";
		if($reding_batch_cond!="")  $reding_batch_cond.="or";
		if($batch_from_redyeing_id!="") $reding_batch_cond.=" batch_id like '$batch_from_redyeing_id'";
		$reding_batch_cond=chop($reding_batch_cond,"or");
		
	}
	
	
	if($batch_non_redyeing_id!="")
	{
		$first_dyes_qnty_sql=sql_select("select c.id as prod_id, sum(b.cons_quantity) as qnty, sum(b.cons_amount) as amt
		from inv_transaction b, product_details_master c
		where b.prod_id=c.id and b.transaction_type=2 and b.item_category in (6) and b.status_active=1 and batch_id like '$batch_non_redyeing_id'
		group by c.id");
		$first_dyes_data=array();
		foreach($first_dyes_qnty_sql as $row)
		{
			$first_dyes_data[$row[csf("prod_id")]]["qnty"]=$row[csf("qnty")];
			$first_dyes_data[$row[csf("prod_id")]]["amt"]=$row[csf("amt")];
		}
	}
	
	if($batch_redyeing_id!="" || $batch_from_redyeing_id!="") 
	{
		$reding_dyes_qnty_sql=sql_select("select c.id as prod_id, sum(b.cons_quantity) as qnty, sum(b.cons_amount) as amt
		from inv_transaction b, product_details_master c
		where b.prod_id=c.id and b.transaction_type=2 and b.item_category in (6) and b.status_active=1 $batch_prefix $reding_batch_cond  $batch_sufix
		group by c.id");
		$reding_dyes_data=array();
		foreach($reding_dyes_qnty_sql as $row)
		{
			$reding_dyes_data[$row[csf("prod_id")]]["qnty"]=$row[csf("qnty")];
			$reding_dyes_data[$row[csf("prod_id")]]["amt"]=$row[csf("amt")];
		}
	}
	//echo "<pre>";print_r($reding_dyes_data);die;
	
	if($batch_non_redyeing_id!="")
	{
		$first_chemical_qnty_sql=sql_select("select c.id as prod_id, sum(b.cons_quantity) as qnty, sum(b.cons_amount) as amt
		from inv_transaction b, product_details_master c
		where b.prod_id=c.id and b.transaction_type=2 and b.item_category in in (5,7) and b.status_active=1 and batch_id like '$batch_non_redyeing_id'
		group by c.id");
		$first_chemical_data=array();
		foreach($first_chemical_qnty_sql as $row)
		{
			$first_chemical_data[$row[csf("prod_id")]]["qnty"]=$row[csf("qnty")];
			$first_chemical_data[$row[csf("prod_id")]]["amt"]=$row[csf("amt")];
		}
	}
	
	if($batch_redyeing_id!="" || $batch_from_redyeing_id!="") 
	{
		$reding_chemical_qnty_sql=sql_select("select c.id as prod_id, sum(b.cons_quantity) as qnty, sum(b.cons_amount) as amt
		from inv_transaction b, product_details_master c
		where b.prod_id=c.id and b.transaction_type=2 and b.item_category in (5,7) and b.status_active=1 $batch_prefix $reding_batch_cond  $batch_sufix
		group by c.id");
		$reding_chemical_data=array();
		foreach($reding_chemical_qnty_sql as $row)
		{
			$reding_chemical_data[$row[csf("prod_id")]]["qnty"]=$row[csf("qnty")];
			$reding_chemical_data[$row[csf("prod_id")]]["amt"]=$row[csf("amt")];
		}
	}
	
	
	$sql_dtls_dyes = "select c.id as prod_id, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit, sum(b.cons_quantity) as qnty
	from inv_transaction b, product_details_master c
	where b.prod_id=c.id and b.transaction_type=2 and b.item_category in (6) and b.status_active=1 $batch_prefix $batch_cond  $batch_sufix
	group by c.id, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit"; 
	//echo $sql_dtls_dyes;die;
	$sql_result_dyes= sql_select($sql_dtls_dyes);
	
	$sql_dtls_chemical = "select c.id as prod_id, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit, sum(b.cons_quantity) as qnty
	from inv_transaction b, product_details_master c
	where b.prod_id=c.id and b.transaction_type=2 and b.item_category in (5,7) and b.status_active=1 $batch_prefix $batch_cond  $batch_sufix 
	group by c.id, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit"; 
	//echo $sql_dtls_chemical;die;
	$sql_result_chemical= sql_select($sql_dtls_chemical);
	?>
    <script>
		function print_window()
		{
			var w = window.open("Surprise", "#");
			var d = w.document.open();
			d.write ('<!DOCTYPE HTML PUBLIC "-//W3C//DTsD HTML 4.01//EN""http://www.w3.org/TR/html4/strict.dtd">'+
			'<html><head><link rel="stylesheet" href="../../../../css/style_common.css" type="text/css" media="print"/><title></title></head><body>'+document.getElementById('report_div').innerHTML+'</body</html>');
			d.close();
		}	
	</script>	
	<div style="width:870px; margin-left:10px" id="report_div">
     <!--<div style="width:870px;" align="center"><input  type="button" value="Print Preview" onClick="print_window()" style="width:100px"  class="formbutton"/></div>-->
    <div style="width:870px; font-family:'Arial Narrow'; font-size:14px;">Dyes</div>
    <table align="center" cellspacing="0" width="870" border="1" rules="all" class="rpt_table" >
        <thead align="center">
    	   <tr>
                <th width="50" rowspan="2">SL</th>
                <th width="50" rowspan="2">Product Id</th>
                <th width="200" rowspan="2">Item Description</th>
                <th width="80" rowspan="2">UOM</th>
                <th colspan="3">First Dying</th>
                <th colspan="3">Subsequent Dyeing</th>
               
           </tr>
           <tr>
                <th width="80">Quantity</th>
                <th width="80">Avg. Rate</th> 
                <th width="80">Amount(BDT)</th>
                <th width="80">Quantity</th>
                <th width="80">Avg. Rate</th> 
                <th>Amount(BDT)</th>
           </tr>
		</thead>
		<?  
		foreach($sql_result_dyes as $row)
		{
			if ($i%2==0)  
				$bgcolor="#E9F3FF";
			else
				$bgcolor="#FFFFFF";
			$first_dyes_qnty=$first_dyes_data[$row[csf("prod_id")]]["qnty"];
			$first_dyes_amt=$first_dyes_data[$row[csf("prod_id")]]["amt"];
			$first_dyes_rate=$first_dyes_amt/$first_dyes_qnty;
			$reding_dyes_qnty=$reding_dyes_data[$row[csf("prod_id")]]["qnty"];
			$reding_dyes_amt=$reding_dyes_data[$row[csf("prod_id")]]["amt"];
			$reding_dyes_rate=$reding_dyes_amt/$reding_dyes_qnty;
			?>
			<tbody>
				<tr bgcolor="<? echo $bgcolor; ?>">
					<td align="center"><? echo $i; ?></td>
					<td align="center"><? echo $row[csf("prod_id")]; ?></td>
					<td><? echo $row[csf("product_name_details")]; ?></td>
					<td align="center"><? echo $unit_of_measurement[$row[csf("unit_of_measure")]]; ?></td>
					<td align="right"><? echo number_format($first_dyes_qnty,4,'.',''); $total_first_dyes_qnty+=$first_dyes_qnty; ?></td>
					<td align="right"><? echo number_format($first_dyes_rate,4,'.',''); ?></td>
					<td align="right"><? echo  number_format($first_dyes_amt,6,'.',''); $total_first_dyes_amt+=$first_dyes_amt; ?></td>
                    <td align="right"><? echo number_format($reding_dyes_qnty,4,'.',''); $total_reding_dyes_qnty+=$reding_dyes_qnty; ?></td>
					<td align="right"><? echo number_format($reding_dyes_rate,4,'.',''); ?></td>
					<td align="right"><? echo  number_format($reding_dyes_amt,6,'.',''); $total_reding_dyes_amt+=$reding_dyes_amt; ?></td>
				</tr>
			</tbody>
			<? 
			$i++;
			$first_dyes_qnty=0;
			$first_dyes_amt=0;
			$reding_dyes_qnty=0;
			$reding_dyes_amt=0;
		}
		?>
        <tfoot>
        	<tr>
                <th colspan="4" align="right">Total:</th>
                <th align="right"><? echo number_format($total_first_dyes_qnty,2,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_first_dyes_amt,2,'.',''); ?></th>
                <th align="right"><? echo number_format($total_reding_dyes_qnty,2,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_reding_dyes_amt,2,'.',''); ?></th>
            </tr>
        </tfoot>
      </table>
      
      <div style="width:870px; font-family:'Arial Narrow'; font-size:14px;">Chemical</div>
    <table align="center" cellspacing="0" width="870" border="1" rules="all" class="rpt_table" >
        <thead align="center">
    	   <tr>
                <th width="50" rowspan="2">SL</th>
                <th width="50" rowspan="2">Product Id</th>
                <th width="200" rowspan="2">Item Description</th>
                <th width="80" rowspan="2">UOM</th>
                <th colspan="3">First Dying</th>
                <th colspan="3">Subsequent Dyeing</th>
               
           </tr>
           <tr>
                <th width="80">Quantity</th>
                <th width="80">Avg. Rate</th> 
                <th width="80">Amount(BDT)</th>
                <th width="80">Quantity</th>
                <th width="80">Avg. Rate</th> 
                <th>Amount(BDT)</th>
           </tr>
		</thead>
		<?  
		foreach($sql_result_chemical as $row)
		{
			if ($i%2==0)  
				$bgcolor="#E9F3FF";
			else
				$bgcolor="#FFFFFF";
			$first_chemi_qnty=$first_chemical_data[$row[csf("prod_id")]]["qnty"];
			$first_chemi_amt=$first_chemical_data[$row[csf("prod_id")]]["amt"];
			$first_chemi_rate=$first_chemi_amt/$first_chemi_qnty;
			$reding_chemi_qnty=$reding_chemical_data[$row[csf("prod_id")]]["qnty"];
			$reding_chemi_amt=$reding_chemical_data[$row[csf("prod_id")]]["amt"];
			$reding_chemi_rate=$reding_chemi_amt/$reding_chemi_qnty;
			?>
			<tbody>
				<tr bgcolor="<? echo $bgcolor; ?>">
					<td align="center"><? echo $i; ?></td>
					<td align="center"><? echo $row[csf("prod_id")]; ?></td>
					<td><? echo $row[csf("product_name_details")]; ?></td>
					<td align="center"><? echo $unit_of_measurement[$row[csf("unit_of_measure")]]; ?></td>
					<td align="right"><? echo number_format($first_chemi_qnty,4,'.',''); $total_first_chemi_qnty+=$first_chemi_qnty; ?></td>
					<td align="right"><? echo number_format($first_chemi_rate,4,'.',''); ?></td>
					<td align="right"><? echo  number_format($first_chemi_amt,6,'.',''); $total_first_chemi_amt+=$first_chemi_amt; ?></td>
                    <td align="right"><? echo number_format($reding_chemi_qnty,4,'.',''); $total_reding_chemi_qnty+=$reding_chemi_qnty; ?></td>
					<td align="right"><? echo number_format($reding_chemi_rate,4,'.',''); ?></td>
					<td align="right"><? echo  number_format($reding_chemi_amt,6,'.',''); $total_reding_chemi_amt+=$reding_chemi_amt; ?></td>
				</tr>
			</tbody>
			<? 
			$i++;
		}
		?>
        <tfoot>
        	<tr>
                <th colspan="4" align="right">Total:</th>
                <th align="right"><? echo number_format($total_first_chemi_qnty,2,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_first_chemi_amt,2,'.',''); ?></th>
                <th align="right"><? echo number_format($total_reding_chemi_qnty,2,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_reding_chemi_amt,2,'.',''); ?></th>
            </tr>
        </tfoot>
      </table>
    </div>
    <?         
	exit();
}
if($action=="total_batch_dtls_popup")
{
	echo load_html_head_contents("Batch Details", "../../../../", 1, 1,$unicode,'','');
	extract($_REQUEST);
	//echo $batch_id;die;
	$batch_non_redyeing_id=return_field_value("id","pro_batch_create_mst","batch_against<>2 and status_active=1 and id in($batch_id)","id");
	$batch_redyeing_id=return_field_value("id","pro_batch_create_mst","batch_against=2 and status_active=1 and id in($batch_id)","id");
	$batch_from_redyeing_id=return_field_value("id","pro_batch_create_mst","batch_against=2 and status_active=1 and re_dyeing_from in($batch_id)","id");
	$batch_cond="";$first_batch_cond=""; $reding_batch_cond="";$reding_batch_cond="";
	//echo $batch_non_redyeing_id."##".$batch_redyeing_id."##".$batch_redyeing_id;die;
	if($batch_non_redyeing_id=="" && $batch_redyeing_id=="" && $batch_redyeing_id=="")
	{
		echo "No Data Found";
		die;
	}
	else
	{
		$batch_prefix=" and( ";
		if($batch_non_redyeing_id!="") $batch_cond=" batch_id like '$batch_non_redyeing_id'";
		if($batch_cond!="")  $batch_cond.="or";
		if($batch_redyeing_id!="") $batch_cond.=" batch_id like '$batch_redyeing_id'";
		if($batch_cond!="")  $batch_cond.="or";
		if($batch_from_redyeing_id!="") $batch_cond.=" batch_id like '$batch_from_redyeing_id'";
		$batch_cond=chop($batch_cond,"or");
		$batch_sufix=" )";
		if($batch_redyeing_id!="") $reding_batch_cond=" batch_id like '$batch_redyeing_id'";
		if($reding_batch_cond!="")  $reding_batch_cond.="or";
		if($batch_from_redyeing_id!="") $reding_batch_cond.=" batch_id like '$batch_from_redyeing_id'";
		$reding_batch_cond=chop($reding_batch_cond,"or");
		
	}
	
	
	if($batch_non_redyeing_id!="")
	{
		$first_dyes_qnty_sql=sql_select("select c.id as prod_id, sum(b.cons_quantity) as qnty, sum(b.cons_amount) as amt
		from inv_transaction b, product_details_master c
		where b.prod_id=c.id and b.transaction_type=2 and b.item_category in (6) and b.status_active=1 and batch_id like '$batch_non_redyeing_id'
		group by c.id");
		$first_dyes_data=array();
		foreach($first_dyes_qnty_sql as $row)
		{
			$first_dyes_data[$row[csf("prod_id")]]["qnty"]=$row[csf("qnty")];
			$first_dyes_data[$row[csf("prod_id")]]["amt"]=$row[csf("amt")];
		}
	}
	
	if($batch_redyeing_id!="" || $batch_from_redyeing_id!="") 
	{
		$reding_dyes_qnty_sql=sql_select("select c.id as prod_id, sum(b.cons_quantity) as qnty, sum(b.cons_amount) as amt
		from inv_transaction b, product_details_master c
		where b.prod_id=c.id and b.transaction_type=2 and b.item_category in (6) and b.status_active=1 $batch_prefix $reding_batch_cond  $batch_sufix
		group by c.id");
		$reding_dyes_data=array();
		foreach($reding_dyes_qnty_sql as $row)
		{
			$reding_dyes_data[$row[csf("prod_id")]]["qnty"]=$row[csf("qnty")];
			$reding_dyes_data[$row[csf("prod_id")]]["amt"]=$row[csf("amt")];
		}
	}
	//echo "<pre>";print_r($reding_dyes_data);die;
	
	if($batch_non_redyeing_id!="")
	{
		$first_chemical_qnty_sql=sql_select("select c.id as prod_id, sum(b.cons_quantity) as qnty, sum(b.cons_amount) as amt
		from inv_transaction b, product_details_master c
		where b.prod_id=c.id and b.transaction_type=2 and b.item_category in in (5,7) and b.status_active=1 and batch_id like '$batch_non_redyeing_id'
		group by c.id");
		$first_chemical_data=array();
		foreach($first_chemical_qnty_sql as $row)
		{
			$first_chemical_data[$row[csf("prod_id")]]["qnty"]=$row[csf("qnty")];
			$first_chemical_data[$row[csf("prod_id")]]["amt"]=$row[csf("amt")];
		}
	}
	
	if($batch_redyeing_id!="" || $batch_from_redyeing_id!="") 
	{
		$reding_chemical_qnty_sql=sql_select("select c.id as prod_id, sum(b.cons_quantity) as qnty, sum(b.cons_amount) as amt
		from inv_transaction b, product_details_master c
		where b.prod_id=c.id and b.transaction_type=2 and b.item_category in (5,7) and b.status_active=1 $batch_prefix $reding_batch_cond  $batch_sufix
		group by c.id");
		$reding_chemical_data=array();
		foreach($reding_chemical_qnty_sql as $row)
		{
			$reding_chemical_data[$row[csf("prod_id")]]["qnty"]=$row[csf("qnty")];
			$reding_chemical_data[$row[csf("prod_id")]]["amt"]=$row[csf("amt")];
		}
	}
	
	
	$sql_dtls_dyes = "select c.id as prod_id, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit, sum(b.cons_quantity) as qnty
	from inv_transaction b, product_details_master c
	where b.prod_id=c.id and b.transaction_type=2 and b.item_category in (6) and b.status_active=1 $batch_prefix $batch_cond  $batch_sufix
	group by c.id, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit"; 
	//echo $sql_dtls_dyes;die;
	$sql_result_dyes= sql_select($sql_dtls_dyes);
	
	$sql_dtls_chemical = "select c.id as prod_id, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit, sum(b.cons_quantity) as qnty
	from inv_transaction b, product_details_master c
	where b.prod_id=c.id and b.transaction_type=2 and b.item_category in (5,7) and b.status_active=1 $batch_prefix $batch_cond  $batch_sufix 
	group by c.id, c.product_name_details, c.unit_of_measure, c.avg_rate_per_unit"; 
	//echo $sql_dtls_chemical;die;
	$sql_result_chemical= sql_select($sql_dtls_chemical);
	?>
    <script>
		function print_window()
		{
			var w = window.open("Surprise", "#");
			var d = w.document.open();
			d.write ('<!DOCTYPE HTML PUBLIC "-//W3C//DTsD HTML 4.01//EN""http://www.w3.org/TR/html4/strict.dtd">'+
			'<html><head><link rel="stylesheet" href="../../../../css/style_common.css" type="text/css" media="print"/><title></title></head><body>'+document.getElementById('report_div').innerHTML+'</body</html>');
			d.close();
		}	
	</script>	
	<div style="width:870px; margin-left:10px" id="report_div">
     <!--<div style="width:870px;" align="center"><input  type="button" value="Print Preview" onClick="print_window()" style="width:100px"  class="formbutton"/></div>-->
    <div style="width:870px; font-family:'Arial Narrow'; font-size:14px;">Dyes</div>
    <table align="center" cellspacing="0" width="870" border="1" rules="all" class="rpt_table" >
        <thead align="center">
    	   <tr>
                <th width="50" rowspan="2">SL</th>
                <th width="50" rowspan="2">Product Id</th>
                <th width="200" rowspan="2">Item Description</th>
                <th width="80" rowspan="2">UOM</th>
                <th colspan="3">First Dying</th>
                <th colspan="3">Subsequent Dyeing</th>
               
           </tr>
           <tr>
                <th width="80">Quantity</th>
                <th width="80">Avg. Rate</th> 
                <th width="80">Amount(BDT)</th>
                <th width="80">Quantity</th>
                <th width="80">Avg. Rate</th> 
                <th>Amount(BDT)</th>
           </tr>
		</thead>
		<?  
		foreach($sql_result_dyes as $row)
		{
			if ($i%2==0)  
				$bgcolor="#E9F3FF";
			else
				$bgcolor="#FFFFFF";
			$first_dyes_qnty=$first_dyes_data[$row[csf("prod_id")]]["qnty"];
			$first_dyes_amt=$first_dyes_data[$row[csf("prod_id")]]["amt"];
			$first_dyes_rate=$first_dyes_amt/$first_dyes_qnty;
			$reding_dyes_qnty=$reding_dyes_data[$row[csf("prod_id")]]["qnty"];
			$reding_dyes_amt=$reding_dyes_data[$row[csf("prod_id")]]["amt"];
			$reding_dyes_rate=$reding_dyes_amt/$reding_dyes_qnty;
			?>
			<tbody>
				<tr bgcolor="<? echo $bgcolor; ?>">
					<td align="center"><? echo $i; ?></td>
					<td align="center"><? echo $row[csf("prod_id")]; ?></td>
					<td><? echo $row[csf("product_name_details")]; ?></td>
					<td align="center"><? echo $unit_of_measurement[$row[csf("unit_of_measure")]]; ?></td>
					<td align="right"><? echo number_format($first_dyes_qnty,4,'.',''); $total_first_dyes_qnty+=$first_dyes_qnty; ?></td>
					<td align="right"><? echo number_format($first_dyes_rate,4,'.',''); ?></td>
					<td align="right"><? echo  number_format($first_dyes_amt,6,'.',''); $total_first_dyes_amt+=$first_dyes_amt; ?></td>
                    <td align="right"><? echo number_format($reding_dyes_qnty,4,'.',''); $total_reding_dyes_qnty+=$reding_dyes_qnty; ?></td>
					<td align="right"><? echo number_format($reding_dyes_rate,4,'.',''); ?></td>
					<td align="right"><? echo  number_format($reding_dyes_amt,6,'.',''); $total_reding_dyes_amt+=$reding_dyes_amt; ?></td>
				</tr>
			</tbody>
			<? 
			$i++;
			$first_dyes_qnty=0;
			$first_dyes_amt=0;
			$reding_dyes_qnty=0;
			$reding_dyes_amt=0;
		}
		?>
        <tfoot>
        	<tr>
                <th colspan="4" align="right">Total:</th>
                <th align="right"><? echo number_format($total_first_dyes_qnty,2,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_first_dyes_amt,2,'.',''); ?></th>
                <th align="right"><? echo number_format($total_reding_dyes_qnty,2,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_reding_dyes_amt,2,'.',''); ?></th>
            </tr>
        </tfoot>
      </table>
      
      <div style="width:870px; font-family:'Arial Narrow'; font-size:14px;">Chemical</div>
    <table align="center" cellspacing="0" width="870" border="1" rules="all" class="rpt_table" >
        <thead align="center">
    	   <tr>
                <th width="50" rowspan="2">SL</th>
                <th width="50" rowspan="2">Product Id</th>
                <th width="200" rowspan="2">Item Description</th>
                <th width="80" rowspan="2">UOM</th>
                <th colspan="3">First Dying</th>
                <th colspan="3">Subsequent Dyeing</th>
               
           </tr>
           <tr>
                <th width="80">Quantity</th>
                <th width="80">Avg. Rate</th> 
                <th width="80">Amount(BDT)</th>
                <th width="80">Quantity</th>
                <th width="80">Avg. Rate</th> 
                <th>Amount(BDT)</th>
           </tr>
		</thead>
		<?  
		foreach($sql_result_chemical as $row)
		{
			if ($i%2==0)  
				$bgcolor="#E9F3FF";
			else
				$bgcolor="#FFFFFF";
			$first_chemi_qnty=$first_chemical_data[$row[csf("prod_id")]]["qnty"];
			$first_chemi_amt=$first_chemical_data[$row[csf("prod_id")]]["amt"];
			$first_chemi_rate=$first_chemi_amt/$first_chemi_qnty;
			$reding_chemi_qnty=$reding_chemical_data[$row[csf("prod_id")]]["qnty"];
			$reding_chemi_amt=$reding_chemical_data[$row[csf("prod_id")]]["amt"];
			$reding_chemi_rate=$reding_chemi_amt/$reding_chemi_qnty;
			?>
			<tbody>
				<tr bgcolor="<? echo $bgcolor; ?>">
					<td align="center"><? echo $i; ?></td>
					<td align="center"><? echo $row[csf("prod_id")]; ?></td>
					<td><? echo $row[csf("product_name_details")]; ?></td>
					<td align="center"><? echo $unit_of_measurement[$row[csf("unit_of_measure")]]; ?></td>
					<td align="right"><? echo number_format($first_chemi_qnty,4,'.',''); $total_first_chemi_qnty+=$first_chemi_qnty; ?></td>
					<td align="right"><? echo number_format($first_chemi_rate,4,'.',''); ?></td>
					<td align="right"><? echo  number_format($first_chemi_amt,6,'.',''); $total_first_chemi_amt+=$first_chemi_amt; ?></td>
                    <td align="right"><? echo number_format($reding_chemi_qnty,4,'.',''); $total_reding_chemi_qnty+=$reding_chemi_qnty; ?></td>
					<td align="right"><? echo number_format($reding_chemi_rate,4,'.',''); ?></td>
					<td align="right"><? echo  number_format($reding_chemi_amt,6,'.',''); $total_reding_chemi_amt+=$reding_chemi_amt; ?></td>
				</tr>
			</tbody>
			<? 
			$i++;
		}
		?>
        <tfoot>
        	<tr>
                <th colspan="4" align="right">Total:</th>
                <th align="right"><? echo number_format($total_first_chemi_qnty,2,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_first_chemi_amt,2,'.',''); ?></th>
                <th align="right"><? echo number_format($total_reding_chemi_qnty,2,'.',''); ?></th>
                <th></th>
                <th align="right"><? echo number_format($total_reding_chemi_amt,2,'.',''); ?></th>
            </tr>
        </tfoot>
      </table>
    </div>
    <?         
	exit();
}
if($action=="batch_wise_subprocess_fabrics_dtls_popup")
{
	echo load_html_head_contents("Subprocess Details", "../../../../", 1, 1,$unicode,'','');
	extract($_REQUEST);
	//echo $batch_id;
	//if($batch_id!='') $batch_con=" and LIKE a.batch_id";
	
	$color_arr=return_library_array( "select id, color_name from lib_color where status_active=1", "id", "color_name");
	
	//$re_dyeing_batch_id=return_field_value("id","pro_batch_create_mst","batch_no='".$batch_no."' and batch_against=2 and extention_no!=0");
	//	$entry_form_arr = return_library_array("select id, entry_form from pro_batch_create_mst", "id", "entry_form");
	//$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", 'id', 'yarn_count');
	
	$sql_batch=sql_select("select id,batch_no,entry_form ,batch_against from pro_batch_create_mst where batch_no='".$batch_no."'  and status_active=1");
	//echo "select id,batch_no,entry_form ,batch_against from pro_batch_create_mst where batch_no='".$batch_no."'  and status_active=1";die;
	foreach($sql_batch as $bid)
	{
		if($bid[csf('batch_against')]==2)
		{
		$re_dyeing_batch_id.=$bid[csf('id')].',';
		}
		$entry_form_arr[$bid[csf('id')]]=$bid[csf('entry_form')];//re_dyeing_batch_id
		$all_dyeing_batch_id.=$bid[csf('id')].',';
	}
	$re_dyeing_batch_id=rtrim($re_dyeing_batch_id,',');
	$all_dyeing_batch_id=rtrim($all_dyeing_batch_id,',');

	if ($batch_id!='') $batch_con=" and a.batch_id like '%$batch_id%'"; else $batch_con="and a.batch_id='0'";
	if ($batch_id!='') $issue_batch_con=" and d.batch_id like '%$batch_id%'"; else $issue_batch_con="and d.batch_id='0'";

	if ($re_dyeing_batch_id!='') { 
	$redyeing_batch_id=" and d.batch_id in($re_dyeing_batch_id)";
	$redyeing_batch_id2=" and batch_id in($re_dyeing_batch_id)";
	$redyeing_batch_id3="  batch_id in($re_dyeing_batch_id)";
	}
 else { 
 $redyeing_batch_id="and d.batch_id in(0)";
 $redyeing_batch_id2="and batch_id in(0)";
 $redyeing_batch_id3="  batch_id in(0)";
 }

  
	$batch_weight=0;
	if($db_type==0) 
	{
		$data_array=sql_select("select group_concat(buyer_id) as buyer_id,group_concat(id) as recipe_id, group_concat(batch_id) as batch_id, sum(total_liquor) as total_liquor, group_concat(concat_ws(':',batch_ratio,liquor_ratio) order by id) as ratio, sum(case when entry_form=60 then new_batch_weight end) as batch_weight, group_concat(case when entry_form<>60 then batch_id end) as batch_id_rec_main from pro_recipe_entry_mst where batch_id in($all_dyeing_batch_id)");
		
	}
	else
	{
		$data_array=sql_select("select listagg(buyer_id,',') within group (order by buyer_id) as buyer_id,listagg(id,',') within group (order by id) as recipe_id, listagg(batch_id,',') within group (order by batch_id) as batch_id, sum(total_liquor) as total_liquor, listagg(batch_ratio || ':' || liquor_ratio,',') within group (order by id) as ratio, sum(case when entry_form=60 then new_batch_weight end) as batch_weight, listagg(case when entry_form<>60 then batch_id end,',') within group (order by batch_id) as batch_id_rec_main from pro_recipe_entry_mst where  batch_id in($all_dyeing_batch_id)");
		// echo "select listagg(buyer_id,',') within group (order by buyer_id) as buyer_id,listagg(id,',') within group (order by id) as recipe_id, listagg(batch_id,',') within group (order by batch_id) as batch_id, sum(total_liquor) as total_liquor, listagg(batch_ratio || ':' || liquor_ratio,',') within group (order by id) as ratio, sum(case when entry_form=60 then new_batch_weight end) as batch_weight, listagg(case when entry_form<>60 then batch_id end,',') within group (order by batch_id) as batch_id_rec_main from pro_recipe_entry_mst where  batch_id in($all_dyeing_batch_id)";
		
	}
	 $recipe_id=$data_array[0][csf('recipe_id')];
	 $recipe_ids=implode(",",array_unique(explode(",",$recipe_id)));
	//$batch_weight=$data_array[0][csf("batch_weight")];

	$batch_id=implode(",",array_unique(explode(",",$data_array[0][csf("batch_id")])));
	
	$batch_id_rec_main=implode(",",array_unique(explode(",",$data_array[0][csf("batch_id_rec_main")])));
	if($batch_id_rec_main=="") $batch_id_rec_main=0;

	if($db_type==0) 
	{
		if(!$batch_id) $batch_id=0;
		//echo "select group_concat(batch_no) as batch_no, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight, group_concat(distinct color_id) as color_id,group_concat(distinct color_range_id) as color_range_id from pro_batch_create_mst where id in($batch_id)";die;

		$batchdata_array=sql_select("select group_concat(batch_no) as batch_no,group_concat(double_dyeing) as double_dyeing, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight, group_concat(distinct color_id) as color_id,group_concat(distinct color_range_id) as color_range_id from pro_batch_create_mst where id in($batch_id)");
	}
	else //color_range_id
	{
		$batchdata_array=sql_select("select listagg(CAST(batch_no AS VARCHAR2(4000)),',') within group (order by id) as batch_no, listagg(double_dyeing ,',') within group (order by id) as double_dyeing, listagg(color_id ,',') within group (order by id) as color_id,listagg(color_range_id ,',') within group (order by id) as color_range_id, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight from pro_batch_create_mst where id in($batch_id)");
		//echo "select listagg(CAST(batch_no AS VARCHAR2(4000)),',') within group (order by id) as batch_no, listagg(double_dyeing ,',') within group (order by id) as double_dyeing, listagg(color_id ,',') within group (order by id) as color_id,listagg(color_range_id ,',') within group (order by id) as color_range_id, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight from pro_batch_create_mst where id in($batch_id)";	
	}
	//unset($batchdata_array);
	$sql="select a.id, a.requ_no, a.location_id, a.requisition_date,a.method, a.requisition_basis, a.batch_id, b.recipe_id, a.machine_id from dyes_chem_issue_requ_mst a , dyes_chem_requ_recipe_att b where a.id=b.mst_id and a.status_active=1 and b.recipe_id in($recipe_ids)";

	$dataArray=sql_select($sql);
	foreach($dataArray as $row)
	{
		$req_no_arr[$row[csf('requ_no')]]=$row[csf('requ_no')];
		$req_id_arr[$row[csf('id')]]=$row[csf('id')];
	}
	//unset($dataArray);
	  $requ_nos=implode(",",$req_no_arr);
	  $req_ids=implode(",",$req_id_arr);
		$po_no=''; $job_no='';$file_no='';$ref_no=''; $buyer_name='';
		if($batch_type==2)
		{
			$po_data=sql_select("select distinct b.order_no, c.subcon_job, c.party_id from pro_batch_create_dtls a, subcon_ord_dtls b, subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0 and a.mst_id in(".$batch_id.") ");
			foreach($po_data as $row)
			{
				$po_no.=$row[csf('order_no')].","; 
				$job_no.=$row[csf('subcon_job')].",";
				$buyer_name.=$buyer_library[$row[csf('party_id')]].",";
			}
		}
		else
		{
			$po_data=sql_select("select distinct b.po_number,b.file_no,b.grouping as ref, c.job_no, c.buyer_name from pro_batch_create_dtls a, wo_po_break_down b, wo_po_details_master c where a.po_id=b.id and b.job_no_mst=c.job_no and a.status_active=1 and a.is_deleted=0 and a.mst_id in(".$batch_id.") ");
			foreach($po_data as $row)
			{
				$po_no.=$row[csf('po_number')].","; 
				$job_no.=$row[csf('job_no')].",";
				$file_no.=$row[csf('file_no')].","; 
				$ref_no.=$row[csf('ref')].","; 
				//$buyer_name.=$buyer_library[$row[csf('buyer_name')]].",";
			}
			$file_no=rtrim($file_no,',');
			$file_nos=implode(",",array_unique(explode(",",$file_no)));
			$ref_no=rtrim($ref_no,',');
			$ref_nos=implode(",",array_unique(explode(",",$ref_no)));
			$batch_nos=implode(",",array_unique(explode(",",$batchdata_array[0][csf('batch_no')])));
			
			foreach(explode(",",$data_array[0][csf("buyer_id")]) as $buyer_id)
			{
				$buyer_name.=$buyer_library[$buyer_id].",";
			}
				
		}
		$color_id=array_unique(explode(",",$batchdata_array[0][csf('color_id')]));
		//echo '<pre>';print_r($color_id);
		$color_name='';
		foreach($color_id as $color)
		{
		$color_name.=$color_arr[$color].",";
		}
		$color_range_id=array_unique(explode(",",$batchdata_array[0][csf('color_range_id')]));
		$color_ranges='';
		foreach($color_range_id as $rang_id)
		{
		$color_ranges.=$color_range[$rang_id].",";
		}
		
		$color_range=substr($color_ranges,0,-1);
		//echo $batchdata_array[0][csf('double_dyeing')].', ';
		$double_dyeing=array_unique(explode(",",$batchdata_array[0][csf('double_dyeing')]));
		$double_dyeing_name='';
		foreach($double_dyeing as $dd_id)
		{
		$double_dyeing_name.=$yes_no[$dd_id].",";
		}
		
		$double_dyeingArr=substr($double_dyeing_name,0,-1);
		
	//$issue_batch_con 
	   /*$sql_isue_dtls = "select d.recipe_id,a.batch_no,
	 avg(b.cons_rate) as cons_rate, sum(b.cons_quantity) as cons_quantity,sum(b.cons_amount) as cons_amount, d.product_id as prod_id,
	   c.item_group_id, d.sub_process
	  from inv_issue_master a, inv_transaction b, product_details_master c, dyes_chem_issue_dtls d
	  where a.id=b.mst_id and b.id =d.trans_id and d.product_id=c.id and b.prod_id=c.id and b.transaction_type=2 and a.entry_form=5 and b.item_category in (5,6,7,23)   group by d.recipe_id,a.batch_no,d.product_id, c.item_group_id, d.sub_process order by d.sub_process "; 
	 // echo $sql_dtls; 
	  $sql_result_issue= sql_select($sql_isue_dtls);
	  $issue_data_arr=array();
	  foreach($sql_result_issue as $row)
	  {
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['issue_qty']+=$row[csf('cons_quantity')]; 
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_amount']+=$row[csf('cons_amount')]; 
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_rate']=$row[csf('cons_rate')]; 
	  }
	  unset($sql_result_issue);*/
	  ob_start();
	?>
    <script>
		function print_window()
		{
			var w = window.open("Surprise", "#");
			var d = w.document.open();
			d.write ('<!DOCTYPE HTML PUBLIC "-//W3C//DTsD HTML 4.01//EN""http://www.w3.org/TR/html4/strict.dtd">'+
			'<html><head><link rel="stylesheet" href="../../../../css/style_common.css" type="text/css" media="print"/><title></title></head><body>'+document.getElementById('report_div').innerHTML+'</body</html>');
			d.close();
		}	
		
		
		  
	</script>	
      <div> 
	<div style="width:870px; margin-left:30px" id="report_div">
     <div style="width:870px;" align="center">
    		 
        	<input  type="button" value="Print Preview" onClick="print_window()" style="width:90px"  class="formbutton"/> &nbsp;
             <div id="report_container"> </div>
        </div>
        <?
         ob_start();
		?>
     <table width="870" cellspacing="0" align="center"  >
        <tr>
        	<td width="100"><strong>Issue Date:</strong></td><td width="160px"><? echo change_date_format($dataArray[0][csf('requisition_date')]); ?></td>
            <td width="90"><strong>Issue Basis</strong></td> <td><? echo $receive_basis_arr[$dataArray[0][csf('requisition_basis')]]; ?></td>
            
            <td width="90"><strong></strong></td><td width="160px"><? //echo implode(",",array_unique(explode(",",$buyer_name))); ?></td>
       </tr>
        <tr>
            <td><strong>Buyer Order:</strong></td> <td><? echo rtrim($po_no,','); ?></td>
           <td><strong>Batch No</strong></td><td><? echo $batch_nos; ?></td>
           <td><strong>Batch Weight</strong></td><td><? echo $batch_weight+$batchdata_array[0][csf('batch_weight')]; ?></td>
        </tr>
        <tr>
            <td><strong>File No</strong></td><td><? echo $file_nos; ?></td>
            <td><strong>Ref. No:</strong></td><td><? echo $ref_nos; ?></td>
            <td><strong>Batch Color:</strong></td><td><? echo rtrim($color_name,','); ?></td>
        </tr>
        <tr>
            <td><strong>Color Range/Group</strong></td><td><? echo $color_range; ?></td>
            <td><strong>Multi Dyeing</strong></td><td><? echo $double_dyeingArr; ?></td>
            <td><strong>Recipe no</strong></td><td><? echo $recipe_ids; ?></td>
        </tr> 
        <tr>
            <td><strong>Req. No</strong></td><td><? echo $requ_nos; ?></td>
           
        </tr>
       
    </table>
     <br>
    <?
	$recipe_arr=array_unique(explode(",",$recipe_ids));
	$recipe_min_id=min($recipe_arr);
	$sql_yarn_dtls = "select  e.knitting_company,e.knitting_source,c.po_breakdown_id as po_id,d.yarn_lot as yarn_lot,d.yarn_count as yarn_count,d.brand_id as brand_id,d.prod_id
	from pro_batch_create_mst a,pro_batch_create_dtls b, pro_roll_details c, pro_grey_prod_entry_dtls d,  inv_receive_master e 
	where a.id=b.mst_id and b.roll_id=c.id and c.dtls_id=d.id and d.mst_id=e.id  
 	and a.id in($batch_id) and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and e.entry_form in(2,22) group by  c.po_breakdown_id,d.yarn_lot,d.yarn_count,d.brand_id,d.prod_id,e.knitting_company,e.knitting_source";
	//echo $sql_yarn_dtls;
	$yarn_dtls_array = array();
	$result_sql_yarn_dtls = sql_select($sql_yarn_dtls);
	foreach ($result_sql_yarn_dtls as $row) {
		$yarn_count = array_unique(explode(",", $row[csf('yarn_count')]));
		$count_name = "";$prod_ids = "";
		foreach ($yarn_count as $val) {
			if ($count_name == "") $count_name = $count_arr[$val]; else $count_name .= ", " . $count_arr[$val];
		}
			//echo $yarn_lot.'DD';
			$yarn_dtls_array[$row[csf('prod_id')]]['yarn_lot'] .=$row[csf('yarn_lot')].',';
			$yarn_dtls_array[$row[csf('prod_id')]]['brand_name'] .= $brand_arr[$row[csf('brand_id')]].',';
			$yarn_dtls_array[$row[csf('prod_id')]]['count_name'] .= $count_name.',';
			if($row[csf('knitting_source')]==3)
			{
				$yarn_dtls_array[$row[csf('prod_id')]]['knitting_company']=$row[csf('knitting_company')];
			} 
			if($prod_ids=="") $prod_ids=$row[csf('prod_id')];else $prod_ids.=",".$row[csf('prod_id')];
	}
	 unset($result_sql_yarn_dtls);
	//array_unique(explode(",",$data_array[0][csf("batch_id")]))
    $batch_id_qry = explode(",", $dataArray[0][csf('batch_id')]);
    $j = 1;
    $entryForm = $entry_form_arr[$batch_id_qry[0]];
	//echo $recipe_min_id.'ddddddddd';
    ?>
    <table width="1070" cellspacing="0" align="center" class="rpt_table" border="1" rules="all">
    	<thead bgcolor="#dddddd" align="center">
    		<?
				//echo $entryForm.'A';
    		if ($entryForm == 0) {
    			?>
    			<tr bgcolor="#CCCCFF">
    				<th colspan="9" align="center"><strong>Fabrication</strong></th>
    			</tr>
    			<tr>
    				<th width="30">SL</th>
    				<th width="100">Dia/ W. Type</th>
    				<th width="100">Yarn Lot</th>
    				<th width="100">Supplier</th>
    				<th width="100">Count</th>
    				<th width="300">Constrution & Composition</th>
    				<th width="70">Gsm</th>
    				<th width="70">Dia</th>
    			</tr>
    			<?
    		} else {
    			?>
    			<tr bgcolor="#CCCCFF">
    				<th colspan="5" align="center"><strong>Fabrication</strong></th>
    			</tr>
    			<tr>
    				<th width="50">SL</th>
    				<th width="350">Gmts. Item</th>
    				<th width="110">Gmts. Qty</th>
    				<th>Batch Qty.</th>
    			</tr>
    			<?
    		}
    		?>
    	</thead>
    	<tbody>
    		<?
    		foreach ($batch_id_qry as $b_id) {
    			 $batch_query = "Select   prod_id, item_description, width_dia_type, count(roll_no) as gmts_qty, sum(batch_qnty) batch_qnty from pro_batch_create_dtls where mst_id in($b_id) and status_active=1 and is_deleted=0 group by   prod_id, item_description, width_dia_type";
    			$result_batch_query = sql_select($batch_query);
    			foreach ($result_batch_query as $rows) {
    				if ($j % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
    				$fabrication_full = $rows[csf("item_description")];
					$yarn_lot=$yarn_dtls_array[$rows[csf('prod_id')]]['yarn_lot'];
					$brand_name=$yarn_dtls_array[$rows[csf('prod_id')]]['brand_name'];
					$count_name=$yarn_dtls_array[$rows[csf('prod_id')]]['count_name'];
					$yarn_lots = implode(", ", array_unique(explode(",", substr($yarn_lot, 0, -1))));
					$brand_names = implode(", ", array_unique(explode(",", substr($brand_name, 0, -1))));
					$count_names = implode(", ", array_unique(explode(",", substr($count_name, 0, -1))));
			
			
    				$fabrication = explode(',', $fabrication_full);
					//echo $entry_form_arr[$b_id].'B';
    				if ($entry_form_arr[$b_id] == 0) {
    					?>
    					<tr bgcolor="<? echo $bgcolor; ?>">
    						<td align="center"><? echo $j; ?></td>
    						<td align="center"><? echo $fabric_typee[$rows[csf("width_dia_type")]]; ?></td>
                            <td align="center"><? echo $yarn_lots;
                            	?></td>
                            <td align="center"><? echo $supplier_library[$knitting_company];
                            	?></td>
                            <td align="center"><? echo $count_names;
                            	?></td>
                            	<td align="left"><? echo $fabrication[0].','.$fabrication[1]; ?></td>
                            	<td align="center"><? echo $fabrication[2]; ?></td>
                            	<td align="center"><? echo $fabrication[3]; ?></td>
                            </tr>
                            <?
                        } else if ($entry_form_arr[$b_id] == 74 || $entry_form_arr[$b_id] == 36) {
                        	?>
                        	<tr bgcolor="<? echo $bgcolor; ?>">
                        		<td align="center"><? echo $j; ?></td>
                        		<td align="left"><? echo $garments_item[$rows[csf('prod_id')]]; ?></td>
                        		<td align="right"><? echo $rows[csf('gmts_qty')]; ?></td>
                        		<td align="right"><? echo number_format($rows[csf('batch_qnty')], 2); ?></td>
                        	</tr>
                        	<?
                        } else {
                        	?>
                        	<tr bgcolor="<? echo $bgcolor; ?>">
                        		<td align="center"><? echo $j; ?></td>
                        		<td align="center"><? echo $fabric_typee[$rows[csf("width_dia_type")]]; ?></td>
                        		<td width="100" align="left"><p style="word-wrap:break-word;"><? echo $yarn_lots; ?></td>
                        		<td align="left"><? echo $supplier_library[$supliID_arr[$rows[csf('prod_id')]]['supplier_id']];//$yarn_dtls_array[$rows[csf('po_id')]][$rows[csf('prod_id')]]['brand_name']; ?></td>
                        		<td align="left"><? echo $count_names; ?></td>
                        		<td align="left"><? echo $fabrication[0] . ", " . $fabrication[1]; ?></td>
                        		<td align="center"><? echo $fabrication[2]; ?></td>
                        		<td align="center"><? echo $fabrication[3]; ?></td>
                        	</tr>
                        	<?
                        }
                        $j++;
                    }
                }
                ?>
            </tbody>
        </table>
        
    <table align="center" cellspacing="0" width="1180" border="1" rules="all" class="rpt_table" >
        <thead bgcolor="#dddddd" align="center">
    	   <tr bgcolor="#EFEFEF">   
                <th width="30">SL</th>
                <th width="80" >Item Cat.</th>
                <th width="100" >Item Group</th>
                <th width="100" >Sub Group</th>
                <th width="150">Item Description</th>
              
                <th width="50" >UOM</th>
                <th width="100" >Dose Base</th> 
                <th width="70" >Main Recipe Dosing</th>
                <th width="60" >Recipe Qty.</th>
                <th width="50" >Adj%</th>
                <th width="60" >Adj Type</th> 
                 
                <th width="60" >Adding Qty.(Kgs.)</th> 
                <th width="60" >Topping Qty.(Kgs.)</th>
                    
               
                <th width="80" >Iss. Qty.</th>
              
                <th width="70" >Unit Price</th>
                <th width="" >Amount(BDT)</th>
                </tr>
		</thead>
	<?  
 	$group_arr=return_library_array( "select id,item_name from lib_item_group where item_category in (5,6,7,23) and status_active=1 and is_deleted=0",'id','item_name');
	
 
  
		/*
		 $sql_dtls_adding = "select  a.dyeing_re_process,a.batch_id, a.id as recipe_id, b.sub_seq,
		b.sub_process_id,b.dose_base, b.ratio, b.adj_qnty as recipe_qnty,c.item_group_id as item_id,
	  	b.prod_id
	    from pro_recipe_entry_mst a,  pro_recipe_entry_dtls b,product_details_master c
	    where a.id=b.mst_id and  c.id=b.prod_id and  a.entry_form=60 and b.status_active=1 and a.batch_id in($all_dyeing_batch_id) and a.id in($recipe_ids)
		and adj_qnty>0 order by b.sub_process_id, b.sub_seq asc";
		$sql_result_adding= sql_select($sql_dtls_adding);
			foreach($sql_result_adding as $row)
			{
				if($row[csf("dyeing_re_process")]==2) //Adding
				{
				$topping_adding_array[$row[csf("recipe_id")]][$row[csf("item_id")]][$row[csf("prod_id")]][$row[csf("sub_process_id")]]['adding_recipe_qnty']+=$row[csf("recipe_qnty")];
				$topping_adding_array[$row[csf("recipe_id")]][$row[csf("item_id")]][$row[csf("prod_id")]][$row[csf("sub_process_id")]]['adding_ratio']=$row[csf("ratio")];
				}
				if($row[csf("dyeing_re_process")]==1) //Topping
				{
				$topping_adding_array[$row[csf("recipe_id")]][$row[csf("item_id")]][$row[csf("prod_id")]][$row[csf("sub_process_id")]]['topping_recipe_qnty']+=$row[csf("recipe_qnty")];
				$topping_adding_array[$row[csf("recipe_id")]][$row[csf("item_id")]][$row[csf("prod_id")]][$row[csf("sub_process_id")]]['topping_ratio']=$row[csf("ratio")];
				}
				//$sub_process_tot_req_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")];
				//$sub_process_tot_value_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")]*$row[csf("avg_rate_per_unit")];
			}*/
	
	 // echo $sql_dtls;//die;
	/* $sql_dtls = "(select a.batch_id, a.requ_no, a.recipe_id, b.id,
		b.sub_process, b.item_category, b.dose_base, b.ratio, b.recipe_qnty, b.adjust_percent, b.adjust_type,b.sub_seq, b.required_qnty, b.req_qny_edit,
	  	c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id,0 as dyeing_re_process
	    from dyes_chem_issue_requ_mst a,  dyes_chem_issue_requ_dtls b, product_details_master c
	    where a.id=b.mst_id and b.product_id=c.id and b.item_category in (5,6,7) and b.req_qny_edit!=0 and b.status_active=1 and c.item_category_id in (5,6,7)  $batch_con)
		union
		( select  to_char(a.batch_id) as batch_id, null as requ_no,to_char(a.id) as recipe_id,0 as id,b.sub_process_id as  sub_process,c.item_category_id as item_category,b.dose_base, b.ratio,b.adj_qnty as  recipe_qnty,b.adj_perc as adjust_percent,b.adj_type as adjust_type,b.sub_seq,0 as required_qnty, 0 as req_qny_edit,c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id,a.dyeing_re_process
	    from pro_recipe_entry_mst a,  pro_recipe_entry_dtls b,product_details_master c
	    where a.id=b.mst_id and  c.id=b.prod_id and  a.entry_form=60 and b.status_active=1 and a.batch_id in($all_dyeing_batch_id) and a.id in($recipe_ids)
		and b.adj_qnty>0) order by   sub_seq asc"; */
		/*echo $sql_dtls_main= "select  a.batch_id as batch_id, null as requ_no,a.id as recipe_id,0 as id,b.sub_process_id as  sub_process,c.item_category_id as item_category,b.dose_base, b.ratio,b.adj_qnty as  recipe_qnty,b.adj_perc as adjust_percent,b.adj_type as adjust_type,b.sub_seq,0 as required_qnty, 0 as req_qny_edit,c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id,a.dyeing_re_process
	    from pro_recipe_entry_mst a,  pro_recipe_entry_dtls b,product_details_master c
	    where a.id=b.mst_id and  c.id=b.prod_id and  a.entry_form=59 and b.status_active=1   and a.id in($recipe_min_id)
		and  b.ratio>0  order by b.sub_seq";
		 $sql_result_main= sql_select($sql_dtls_main);
			 foreach($sql_result_top as $row)
			{
				$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['batch_id']=$row[csf('batch_id')];
			}*/
		 //recipe_ids
		 $sql_main_recipe="select a.batch_against,b.id,c.sub_process_id,c.prod_id,c.ratio,d.item_group_id from pro_recipe_entry_mst b,pro_batch_create_mst a,pro_recipe_entry_dtls c,product_details_master d where a.id=b.batch_id and c.mst_id=b.id and d.id=c.prod_id  and b.entry_form=59 and b.status_active=1 and  b.id in($recipe_ids)  and d.item_category_id in (5,6,7,23) and b.status_active=1 and a.status_active=1  and c.status_active=1 order by c.sub_seq ,c.sub_process_id";
		 $sql_main_recipe_res= sql_select($sql_main_recipe);
		$main_recipe_id="";$re_dying_recipe_id="";
		foreach($sql_main_recipe_res as $row)
		{
			if($row[csf("batch_against")]==2)
			{
				$re_dying_recipe_id.=$row[csf("id")].',';
			}
			$main_recipe_id.=$row[csf("id")].',';
			if($row[csf("batch_against")]==1)
			{
			//if($recipe_min_id==$row[csf("id")])
			//{
				//echo $row[csf('ratio')].',';
				if($row[csf('ratio')]>0)
				{
				$main_req_data_arr[$row[csf("sub_process_id")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['main_ratio']=$row[csf('ratio')];
				}
			//}
			}
		}
		unset($sql_main_recipe_res);
		
		
		//batch_no
		$re_dying_recipe_id=rtrim($re_dying_recipe_id,',');
		//echo $re_dying_recipe_id.'DD';
		$main_recipe_ids=rtrim($main_recipe_id,',');
		 $main_recipe_idsArr=array_unique(explode(",",$main_recipe_ids));
		$sql_batch=sql_select("select id,batch_against from pro_batch_create_mst where id in($all_dyeing_batch_id) and status_active=1");
		
		foreach($sql_batch as $row)
		{
			$batch_chk_arr[$row[csf("id")]]=$row[csf("batch_against")];
		}
		unset($sql_batch);
		
	//$re_dying_batch_id=implode(",",$re_dying_batch_arr);
	//echo $re_dying_batch_id.',';
	
		//print_r($batch_chk_arr);
		
		
		
	   $sql_dtls = "select a.batch_id, a.requ_no, a.recipe_id, b.id,
		b.sub_process, b.item_category, b.dose_base, b.ratio, b.recipe_qnty, b.adjust_percent, b.adjust_type,b.sub_seq, b.required_qnty, b.req_qny_edit,
	  	c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id
	    from dyes_chem_issue_requ_mst a,  dyes_chem_issue_requ_dtls b, product_details_master c
	    where a.id=b.mst_id and b.product_id=c.id and b.item_category in (5,6,7,23) and b.req_qny_edit!=0 and b.status_active=1 and c.item_category_id in (5,6,7,23)  $batch_con order by b.sub_seq"; 
		
	$sql_result= sql_select($sql_dtls);
	
	$sub_process_array=array();
	$sub_process_tot_rec_array=array();
	$sub_process_tot_req_array=array();
	$sub_process_tot_value_array=array();
	
	foreach($sql_result as $row)
	{
		$sub_process_tot_rec_array[$row[csf("sub_process")]]+=$row[csf("recipe_qnty")];
		 //$recipe_min_id 
		 $recipe_id_idArr=array_unique(explode(",",$row[csf("recipe_id")]));
		// echo $batch_id.'='.$row[csf("batch_id")].'<br> ';
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id'].=$row[csf('recipe_id')].',';
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['batch_id']=$row[csf('batch_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['requ_no']=$row[csf('requ_no')];
		//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id']=$row[csf('recipe_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['id']=$row[csf('id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_process']=$row[csf('sub_process')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_category']=$row[csf('item_category')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['dose_base']=$row[csf('dose_base')];
		//if(in_array($batch_id,$batch_idArr))
		//{
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['ratio']=$row[csf('ratio')];
		//}
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_percent']=$row[csf('adjust_percent')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_type']=$row[csf('adjust_type')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_seq']=$row[csf('sub_seq')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['required_qnty']=$row[csf('required_qnty')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['req_qny_edit']=$row[csf('req_qny_edit')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_description']=$row[csf('item_description')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_group_id']=$row[csf('item_group_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_group_name']=$row[csf('sub_group_name')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_size']=$row[csf('item_size')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['unit_of_measure']=$row[csf('unit_of_measure')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['prod_id']=$row[csf('prod_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adding']='Issue Req';
		//$main_recipe_chk_arr[$row[csf("id")]];
		$all_product_arr[$row[csf('prod_id')]] = $row[csf('prod_id')];
		$ckh=1;
		foreach($main_recipe_idsArr as $rec_id)
		{
			$rec_id_chk=$rec_id;
			if($ckh==1)
			{
			if(in_array($rec_id_chk,$recipe_id_idArr))
			{
				//echo $row[csf('prod_id')].'='.$recipe_min_id.'='.$row[csf('recipe_qnty')].'<br>';
				$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['main_recipe_qnty']+=$row[csf('recipe_qnty')];
			}
			$chk++;
		  }
		}
		//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
	}
	unset($sql_result);
	 if ($re_dying_recipe_id!='')
	 {
	 if ($re_dying_recipe_id!='') $re_batch_con=" and d.recipe_id in($re_dying_recipe_id)"; else $re_batch_con="and d.recipe_id in(0)";
	    $sql_dtls_re = "select a.batch_id, a.requ_no, a.recipe_id, b.id,
		b.sub_process, b.item_category, b.dose_base, b.ratio, b.recipe_qnty, b.adjust_percent, b.adjust_type,b.sub_seq, b.required_qnty, b.req_qny_edit,
	  	c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id
	    from dyes_chem_issue_requ_mst a,  dyes_chem_issue_requ_dtls b, product_details_master c,dyes_chem_requ_recipe_att d
	    where a.id=b.mst_id and b.product_id=c.id  and a.id=d.mst_id and b.item_category in (5,6,7,23) and b.req_qny_edit!=0 and b.status_active=1 and c.item_category_id in (5,6,7,23)  $re_batch_con order by b.sub_seq ,b.sub_process"; 
		$sql_result_re= sql_select($sql_dtls_re);
		 
	foreach($sql_result_re as $row)
	{
		$sub_process_tot_rec_array[$row[csf("sub_process")]]+=$row[csf("recipe_qnty")];
		 //$recipe_min_id 
		 $recipe_id_idArr=array_unique(explode(",",$row[csf("recipe_id")]));
		// echo $batch_id.'='.$row[csf("batch_id")].'<br> ';
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id'].=$row[csf('recipe_id')].',';
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['batch_id']=$row[csf('batch_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['requ_no']=$row[csf('requ_no')];
		//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id']=$row[csf('recipe_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['id']=$row[csf('id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_process']=$row[csf('sub_process')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_category']=$row[csf('item_category')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['dose_base']=$row[csf('dose_base')];
		//if(in_array($batch_id,$batch_idArr))
		//{
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['ratio']=$row[csf('ratio')];
		//}
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_percent']=$row[csf('adjust_percent')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_type']=$row[csf('adjust_type')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_seq']=$row[csf('sub_seq')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['required_qnty']=$row[csf('required_qnty')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['req_qny_edit']=$row[csf('req_qny_edit')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_description']=$row[csf('item_description')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_group_id']=$row[csf('item_group_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_group_name']=$row[csf('sub_group_name')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_size']=$row[csf('item_size')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['unit_of_measure']=$row[csf('unit_of_measure')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['prod_id']=$row[csf('prod_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adding']='Issue Req';
		//$main_recipe_chk_arr[$row[csf("id")]];

		$ckh=1;
		foreach($main_recipe_idsArr as $rec_id)
		{
			$rec_id_chk=$rec_id;
			if($ckh==1)
			{
			if(in_array($rec_id_chk,$recipe_id_idArr))
			{
				//echo $row[csf('prod_id')].'='.$recipe_min_id.'='.$row[csf('recipe_qnty')].'<br>';
				//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['main_recipe_qnty']+=$row[csf('req_qny_edit')];
				$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['topping_recipe_qnty']+=$row[csf('recipe_qnty')];
			}
			$chk++;
		  }
		}
		//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
		$all_product_arr[$row[csf('prod_id')]] = $row[csf('prod_id')];
	}
	unset($sql_result_re);
	 }
	//echo $recipe_ids;die;
	
	if($recipe_ids!="")
	{
		   $sql_dtls_top= "select  a.batch_id as batch_id, null as requ_no,a.id as recipe_id,0 as id,b.sub_process_id as  sub_process,c.item_category_id as item_category,b.dose_base, b.ratio,b.adj_qnty as  recipe_qnty,b.adj_perc as adjust_percent,b.adj_type as adjust_type,b.sub_seq,0 as required_qnty, 0 as req_qny_edit,c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id,a.dyeing_re_process
	    from pro_recipe_entry_mst a,  pro_recipe_entry_dtls b,product_details_master c
	    where a.id=b.mst_id and  c.id=b.prod_id and  a.entry_form=60 and b.status_active=1 and a.batch_id in($all_dyeing_batch_id) and a.id in($recipe_ids)
		and b.adj_qnty>0 order by b.sub_seq,b.sub_process_id"; 
		 $sql_result_top= sql_select($sql_dtls_top);
		foreach($sql_result_top as $row)
		{
			$sub_process_tot_rec_array[$row[csf("sub_process")]]+=$row[csf("recipe_qnty")];
			 
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['batch_id']=$row[csf('batch_id')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id'].=$row[csf('recipe_id')].',';
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['requ_no']=$row[csf('requ_no')];
			//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id']=$row[csf('recipe_id')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['id']=$row[csf('id')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_process']=$row[csf('sub_process')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_category']=$row[csf('item_category')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['dose_base']=$row[csf('dose_base')];
			//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['ratio']=$row[csf('ratio')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_percent']=$row[csf('adjust_percent')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_type']=$row[csf('adjust_type')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_seq']=$row[csf('sub_seq')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['required_qnty']=$row[csf('required_qnty')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['req_qny_edit']=$row[csf('req_qny_edit')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_description']=$row[csf('item_description')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_group_id']=$row[csf('item_group_id')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_group_name']=$row[csf('sub_group_name')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_size']=$row[csf('item_size')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['unit_of_measure']=$row[csf('unit_of_measure')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['prod_id']=$row[csf('prod_id')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['dyeing_re_process']=$row[csf('dyeing_re_process')];
			$batch_againstId=$batch_chk_arr[$row[csf("batch_id")]];
			//if($batch_againstId==2)   echo $row[csf('batch_id')].'='.$batch_againstId.'<br>';|| $batch_againstId==2
			if($row[csf('dyeing_re_process')]==1) //Topping
			{	
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['topping_recipe_qnty']+=$row[csf('recipe_qnty')];
			}
			if($row[csf('dyeing_re_process')]==2 ) //Adding
			{	
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adding_recipe_qnty']+=$row[csf('recipe_qnty')];
			}
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adding']='Adding Topping';
			//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];

			$all_product_arr[$row[csf('prod_id')]] = $row[csf('prod_id')];
		}
		unset($sql_result_top);
	}
	?>
                
	<?

	$all_product_arr = array_filter($all_product_arr);
    $all_prod_id_cond="";
	$prodCond="";
    if($db_type==2 && count($all_product_arr)>999)
    {
    	$all_product_arr_chunk=array_chunk($all_product_arr,999) ;
    	foreach($all_product_arr_chunk as $chunk_arr)
    	{
    		$chunk_arr_value=implode(",",$chunk_arr);
    		$prodCond.="  c.id in($chunk_arr_value) or ";
    	}

    	$all_prod_id_cond.=" and (".chop($prodCond,'or ').")";
    }
    else
    {
    	$all_prod_id_cond=" and c.id in(".implode(',', $all_product_arr).")";
    }

    $sql_isue_dtls = "SELECT d.recipe_id,a.batch_no, avg(b.cons_rate) as cons_rate, sum(b.cons_quantity) as cons_quantity,sum(b.cons_amount) as cons_amount, d.product_id as prod_id, c.item_group_id, d.sub_process from inv_issue_master a, inv_transaction b, product_details_master c, dyes_chem_issue_dtls d 	  where a.id=b.mst_id and b.id =d.trans_id and d.product_id=c.id and b.prod_id=c.id and b.transaction_type=2 and a.entry_form=5 and b.item_category in (5,6,7,23) $all_prod_id_cond group by d.recipe_id,a.batch_no,d.product_id, c.item_group_id, d.sub_process order by d.sub_process "; 
	 // echo $sql_dtls; 
	  $sql_result_issue= sql_select($sql_isue_dtls);
	  $issue_data_arr=array();
	  foreach($sql_result_issue as $row)
	  {
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['issue_qty']+=$row[csf('cons_quantity')]; 
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_amount']+=$row[csf('cons_amount')]; 
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_rate']=$row[csf('cons_rate')]; 
	  }
	  unset($sql_result_issue);

	//var_dump($sub_process_tot_req_array);
	$i=1; $k=1; $recipe_qnty_sum=0; $req_qny_edit_sum=0; $recipe_qnty=0; $req_qny_edit=0; $req_value_sum=0;
	$req_value_grand=0; $recipe_qnty_grand=0; $req_qny_edit_grand=0;
	$total_adding_recipe_qnty=$total_topping_recipe_qnty=0;
	foreach($req_data_arr as $sub_process=>$sub_data)
	{
	foreach($sub_data as $prod_id=>$prod_data)
	{
		foreach($prod_data as $item_id=>$row)
		{
		 
		
		if ($i%2==0)  
			$bgcolor="#E9F3FF";
		else
			$bgcolor="#FFFFFF";
			if (!in_array($sub_process,$sub_process_array) )
			{
				$sub_process_array[]=$sub_process;
				if($k!=1)
				{
					?>
                    <tr>
                        <td colspan="8" align="right"><strong>Total :</strong></td>
                        <td align="right"><strong><?php  echo number_format($recipe_qnty_sum,6,'.',''); ?></strong></td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                		 
                         
                        
                        
                        <td align="right"><strong><?php  echo number_format($adding_recipe_qnty_sum,6,'.',''); ?></strong></td> 
                        <td align="right"><strong><?php  echo number_format($topping_recipe_qnty_sum,6,'.',''); ?></strong></td>
                        
                        <td align="right"><strong><?php  echo number_format($req_qny_issue_sum,6,'.',''); ?></strong></td>
                        
                        <td>&nbsp;</td>
                	
                        <td align="right"><strong><?php  echo number_format($amount_req_value_sum,6,'.',''); ?></strong></td>
                    </tr> 
			 <? 
			} 
			$recipe_qnty_sum=0;$adding_recipe_qnty_sum=0;$topping_recipe_qnty_sum=0;
			$req_qny_issue_sum=0;
			$amount_req_value_sum=0;
			$k++; 
			?>
            <tr bgcolor="#CCCCCC">
                <th colspan="17"><strong><? echo $dyeing_sub_process[$sub_process]; ?></strong></th>
            </tr> 
            
        <? 
		}
		
		$recipe_id=rtrim($row[('recipe_id')],',');
		$recipe_ids=array_unique(explode(",",$recipe_id));
		$recipe_idsArr=implode(",",array_unique(explode(",",$recipe_id)));
		$issue_qty=$cons_amount=0;
		foreach($recipe_ids as $rid)
		{
		$issue_qty+=$issue_data_arr[$sub_process][$prod_id][$item_id][$rid]['issue_qty'];
		$cons_amount+=$issue_data_arr[$sub_process][$prod_id][$item_id][$rid]['cons_amount'];
		$issue_cons_rate=$issue_data_arr[$sub_process][$prod_id][$item_id][$rid]['cons_rate'];
		}
		//echo $row[csf('recipe_id')].',mmmm';
		$recipe_idArr=array_unique(explode(",",$recipe_id));
		$adding_recipe_qnty=$topping_recipe_qnty=0;
		foreach($recipe_idArr as $rid)
		{
		//$adding_recipe_qnty+=$topping_adding_array[$rid][$row[csf('item_group_id')]][$row[csf("prod_id")]][$row[csf("sub_process")]]['adding_recipe_qnty'];
		//$topping_recipe_qnty+=$topping_adding_array[$rid][$row[csf('item_group_id')]][$row[csf("prod_id")]][$row[csf("sub_process")]]['topping_recipe_qnty'];
		}
		 
		$adding_recipe_qnty=$row[('adding_recipe_qnty')];
		$topping_recipe_qnty=$row[('topping_recipe_qnty')];
		
		$total_adding_recipe_qnty+=$row[('adding_recipe_qnty')];
		$total_topping_recipe_qnty+=$row[('topping_recipe_qnty')];
		//$adding_recipe_qnty=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['adding_recipe_qnty'];
		//$topping_recipe_qnty=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['topping_recipe_qnty'];
		
	//	$adding_ratio=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['adding_ratio'];
	//	$topping_ratio=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['topping_ratio'];
	//$row[("recipe_id")]=$row[("recipe_id")];
	$main_ratio=$main_req_data_arr[$sub_process][$prod_id][$item_id]['main_ratio'];
		?>
        <tbody>
			<tr bgcolor="<? echo $bgcolor; ?>">
                <td align="center"><? echo $i; ?></td>
                <td><? echo $item_category[$row[("item_category")]];  //echo $row[csf("sub_process")]; ?></td>
                <td title="<? echo $row[("adding")];?>"><? echo $group_arr[$row[("item_group_id")]] ?></td>
                <td><? echo $row[("sub_group_name")]; ?></td>
              
                <td><? echo $row[("item_description")].' '.$row[("item_size")]; ?></td>
                
                <td align="center"><? echo $unit_of_measurement[$row[("unit_of_measure")]]; ?></td>
                <td><? echo $dose_base[$row[("dose_base")]]; ?></td>
                <td align="right"><? echo number_format($main_ratio,6,'.',''); ?></td>
                <td align="right" title="<? echo $recipe_idsArr;?>"> <? echo number_format($row[("main_recipe_qnty")],6,'.',''); ?></td>
                <td align="center"><? echo $row[("adjust_percent")]; ?></td>
                <td><? echo $increase_decrease[$row[("adjust_type")]]; ?></td>
                
                 <td align="right"><? echo number_format($adding_recipe_qnty,6); ?></td>
                
                 <td align="right"><? echo number_format($topping_recipe_qnty,6); ?></td>
                    
              
                <td align="right" title="Issue_qty=<? echo $issue_qty;?>"><? 
				$tot_issue_qty=$issue_qty+$adding_recipe_qnty+$topping_recipe_qnty;
				echo number_format($issue_qty,6,'.',''); ?></td>
                
                <td align="right"><? echo  number_format($cons_amount/$issue_qty,6,'.',''); ?></td>
                <td align="right"><? $amount_req_value=$cons_amount;//$issue_qty*$issue_cons_rate; 
				echo number_format($amount_req_value,6,'.',''); ?></td>
			</tr>
        </tbody>
		<? $i++;
        $recipe_qnty_sum +=$row[('main_recipe_qnty')];
        $req_qny_issue_sum +=$issue_qty; 
		
		$adding_recipe_qnty_sum +=$adding_recipe_qnty; 
		$topping_recipe_qnty_sum +=$topping_recipe_qnty;
		
		$amount_req_value_sum +=$amount_req_value;
		
		$recipe_qnty_grand +=$row[('main_recipe_qnty')];
        $req_qny_issue_grand +=$issue_qty;
		$amount_req_value_grand +=$amount_req_value;
         
		}
		
	  }
	} //End
		foreach ($sub_process_tot_rec_array as $val_rec)
		{
			 $totval_rec=$val_rec;
		}
		/*foreach ($sub_process_tot_req_array as $val_req)
		{
			 $totval_req=$val_req;
		}
		foreach ($sub_process_tot_value_array as $req_value)
		{
			 $tot_req_value=$req_value;
		}*/
		
		//$recipe_qnty_grand +=$val_rec;
        //$req_qny_edit_grand +=$val_req;
		//$req_value_grand +=$req_value;
		?>
           <tr>
                <td colspan="8" align="right"><strong>Total :</strong></td>
                <td align="right"><strong><?php echo number_format($totval_rec,6,'.',''); ?></strong></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                
                 <td align="right"><strong><?php  echo number_format($adding_recipe_qnty_sum,6,'.',''); ?></strong></td> 
                 <td align="right"><strong><?php  echo number_format($topping_recipe_qnty_sum,6,'.',''); ?></strong></td>
                
                
                
                <td align="right"><strong><?php echo number_format($req_qny_issue_sum,6,'.',''); ?></strong></td>
               
                <td>&nbsp;</td>
                <td align="right"><strong><?php echo number_format($amount_req_value_sum,6,'.',''); ?></strong></td>
            </tr> 
             <tr>
                <td colspan="8" align="right"><strong> Grand Total :</strong></td>
                <td align="right"><strong><?php echo number_format($recipe_qnty_grand,6,'.',''); ?></strong></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                 <td  align="right"><strong><?php echo number_format($total_adding_recipe_qnty,6,'.',''); ?></strong></td>
                <td  align="right"><strong><?php echo number_format($total_topping_recipe_qnty,6,'.',''); ?></strong></td>
                
               
                <td align="right"><strong><?php echo number_format($req_qny_issue_grand,6,'.',''); ?></strong></td>
                <td>&nbsp;</td>
                
                <td align="right"><strong><?php echo number_format($amount_req_value_grand,6,'.',''); ?></strong></td>
            </tr> 
               <tr>
                <td colspan="14" align="right"><strong> Cost Per Kg :</strong></td>
                <td colspan="2" align="right"><strong><?php echo number_format($amount_req_value_grand/($batch_weight+$batchdata_array[0][csf('batch_weight')]),6,'.',''); ?></strong></td>
            </tr>                          
      </table>
        <br>
      	<?  	
	 
	 
    $html=ob_get_contents();
			ob_flush();
			
			foreach (glob(""."*.xls") as $filename) 
			{
			   @unlink($filename);
			}
			
			//html to xls convert
			$name=time();
			$name=$user_id."_".$name.".xls";
			$create_new_excel = fopen(''.$name, 'w');	
			$is_created = fwrite($create_new_excel,$html);
	
	?>
      <input type="hidden" id="txt_excl_link" value="<? echo 'requires/'.$name; ?>" />
    <script>
	$(document).ready(function(e) {
				document.getElementById('report_container').innerHTML='<a href="<? echo $name?>" style="text-decoration:none"><input type="button" value="Excel Download" name="excel" id="excel" class="formbutton" style="width:90px;font-size:11px"/></a>&nbsp;&nbsp;';
		});	
	</script>
      </div> 
    <?
	exit();
}
if($action=="batch_wise_subprocess_fabrics_dtls_popup2") // batch Wise 2
{
	echo load_html_head_contents("Subprocess Details", "../../../../", 1, 1,$unicode,'','');
	extract($_REQUEST);
	//echo $req_id;
	//if($batch_id!='') $batch_con=" and LIKE a.batch_id";
	
	$color_arr=return_library_array( "select id, color_name from lib_color where status_active=1", "id", "color_name");
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", 'id', 'yarn_count');
	$req_idCond="and b.mst_id in($req_id)";
	$batch_idCond="and a.batch_id in($batch_id)";
	/* $sql_req = "SELECT a.ID,b.mst_id as REQ_ID,a.batch_id as BATCH_ID,a.BATCH_QTY,a.NEW_BATCH_WEIGHT,a.ENTRY_FORM,c.batch_id as RE_BATCH_ID from pro_recipe_entry_mst a, dyes_chem_requ_recipe_att b,dyes_chem_issue_requ_mst c where b.recipe_id=a.id  and c.id=b.mst_id $req_idCond and a.status_active=1 and a.is_deleted=0 and b.status_active=1";
	 echo $sql_req;
	$req_res = sql_select($sql_req);
	$req_id_array = array();
	foreach ($req_res as $val) 
	{
		$recipe_id_array[$val['ID']] = $val['ID'];
		$req_id_array[$val['REQ_ID']] = $val['REQ_ID'];
		$batch_req_id_array[$val['BATCH_ID']]= $val['REQ_ID'];
		$batch_req_id_array2[$val['BATCH_ID']]= $val['REQ_ID'];
		$batch_all_id_array[$val['RE_BATCH_ID']]= $val['RE_BATCH_ID'];
		//if($batchWgtChkk[$val['REQ_ID']]=='')
		//{
			if($val['ENTRY_FORM']==60) //Adding Topping
			{
				$batch_wgt=$val['NEW_BATCH_WEIGHT'];
			}
			else
			{
				$batch_wgt=$val['BATCH_QTY'];
			}
			//echo $batch_wgt.',';
		$batch_wgt_array[$val['REQ_ID']] += $batch_wgt;
		$batchWgtChkk[$val['REQ_ID']].=$val['BATCH_ID'].',';
		//}
	}
	unset($req_res);*/
	
	
	$sql_batch=sql_select("select id,batch_no,entry_form ,batch_weight,batch_against from pro_batch_create_mst where id=$batch_id  and status_active=1");
	//echo"select id,batch_no,entry_form ,batch_weight,batch_against from pro_batch_create_mst where id=$batch_id   and status_active=1";die;
	foreach($sql_batch as $bid)
	{
		if($bid[csf('batch_against')]==2)
		{
		$re_dyeing_batch_id.=$bid[csf('id')].',';
		}
		$entry_form_arr[$bid[csf('id')]]=$bid[csf('entry_form')];//re_dyeing_batch_id
		$all_dyeing_batch_id.=$bid[csf('id')].',';
		$main_batch_weight=$bid[csf('batch_weight')];
		 $batch_no=$bid[csf('batch_no')];
		//echo $batch_weight.'dsds';;
	}
	$re_dyeing_batch_id=rtrim($re_dyeing_batch_id,',');
	$all_dyeing_batch_id=rtrim($all_dyeing_batch_id,',');

	if ($batch_id!='') $batch_con=" and a.batch_id like '%$batch_id%'"; else $batch_con="and a.batch_id='0'";
	if ($batch_id!='') $issue_batch_con=" and d.batch_id like '%$batch_id%'"; else $issue_batch_con="and d.batch_id='0'";

	if ($re_dyeing_batch_id!='') { 
	$redyeing_batch_id=" and d.batch_id in($re_dyeing_batch_id)";
	$redyeing_batch_id2=" and batch_id in($re_dyeing_batch_id)";
	$redyeing_batch_id3="  batch_id in($re_dyeing_batch_id)";
	}
 else { 
 $redyeing_batch_id="and d.batch_id in(0)";
 $redyeing_batch_id2="and batch_id in(0)";
 $redyeing_batch_id3="  batch_id in(0)";
 }

  
	$batch_weight=0;
	if($db_type==0) 
	{
		$data_array=sql_select("select group_concat(buyer_id) as buyer_id,group_concat(id) as recipe_id, group_concat(batch_id) as batch_id, sum(total_liquor) as total_liquor, group_concat(concat_ws(':',batch_ratio,liquor_ratio) order by id) as ratio, sum(case when entry_form=60 then new_batch_weight end) as batch_weight, group_concat(case when entry_form<>60 then batch_id end) as batch_id_rec_main from pro_recipe_entry_mst where batch_id in($all_dyeing_batch_id)");
		
	}
	else
	{
		$data_array=sql_select("select listagg(buyer_id,',') within group (order by buyer_id) as buyer_id,listagg(id,',') within group (order by id) as recipe_id, listagg(batch_id,',') within group (order by batch_id) as batch_id, sum(total_liquor) as total_liquor, listagg(batch_ratio || ':' || liquor_ratio,',') within group (order by id) as ratio, sum(case when entry_form=60 then new_batch_weight end) as batch_weight, listagg(case when entry_form<>60 then batch_id end,',') within group (order by batch_id) as batch_id_rec_main from pro_recipe_entry_mst where  batch_id in($all_dyeing_batch_id)");
		// echo "select listagg(buyer_id,',') within group (order by buyer_id) as buyer_id,listagg(id,',') within group (order by id) as recipe_id, listagg(batch_id,',') within group (order by batch_id) as batch_id, sum(total_liquor) as total_liquor, listagg(batch_ratio || ':' || liquor_ratio,',') within group (order by id) as ratio, sum(case when entry_form=60 then new_batch_weight end) as batch_weight, listagg(case when entry_form<>60 then batch_id end,',') within group (order by batch_id) as batch_id_rec_main from pro_recipe_entry_mst where  batch_id in($all_dyeing_batch_id)";
		
	}
	 $recipe_id=$data_array[0][csf('recipe_id')];
	 $recipe_ids=implode(",",array_unique(explode(",",$recipe_id)));
	//$batch_weight=$data_array[0][csf("batch_weight")];

	$batch_id=implode(",",array_unique(explode(",",$data_array[0][csf("batch_id")])));
	
	$batch_id_rec_main=implode(",",array_unique(explode(",",$data_array[0][csf("batch_id_rec_main")])));
	if($batch_id_rec_main=="") $batch_id_rec_main=0;

	if($db_type==0) 
	{
		if(!$batch_id) $batch_id=0;
		//echo "select group_concat(batch_no) as batch_no, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight, group_concat(distinct color_id) as color_id,group_concat(distinct color_range_id) as color_range_id from pro_batch_create_mst where id in($batch_id)";die;

		$batchdata_array=sql_select("select group_concat(batch_no) as batch_no,group_concat(double_dyeing) as double_dyeing, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight, group_concat(distinct color_id) as color_id,group_concat(distinct color_range_id) as color_range_id from pro_batch_create_mst where id in($batch_id)");
	}
	else //color_range_id
	{
		$batchdata_array=sql_select("select listagg(CAST(batch_no AS VARCHAR2(4000)),',') within group (order by id) as batch_no, listagg(double_dyeing ,',') within group (order by id) as double_dyeing, listagg(color_id ,',') within group (order by id) as color_id,listagg(color_range_id ,',') within group (order by id) as color_range_id, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight from pro_batch_create_mst where id in($batch_id)");
		//echo "select listagg(CAST(batch_no AS VARCHAR2(4000)),',') within group (order by id) as batch_no, listagg(double_dyeing ,',') within group (order by id) as double_dyeing, listagg(color_id ,',') within group (order by id) as color_id,listagg(color_range_id ,',') within group (order by id) as color_range_id, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight from pro_batch_create_mst where id in($batch_id)";	
	}
	//unset($batchdata_array);
	$sql="select a.id, a.requ_no, a.location_id, a.requisition_date,a.method, a.requisition_basis, a.batch_id, b.recipe_id, a.machine_id from dyes_chem_issue_requ_mst a , dyes_chem_requ_recipe_att b where a.id=b.mst_id and a.status_active=1 and b.recipe_id in($recipe_ids)";

	$dataArray=sql_select($sql);
	foreach($dataArray as $row)
	{
		$req_no_arr[$row[csf('requ_no')]]=$row[csf('requ_no')];
		$req_id_arr[$row[csf('id')]]=$row[csf('id')];
	}
	//unset($dataArray);
	  $requ_nos=implode(",",$req_no_arr);
	  $req_ids=implode(",",$req_id_arr);
		$po_no=''; $job_no='';$file_no='';$ref_no=''; $buyer_name='';
		if($batch_type==2)
		{
			$po_data=sql_select("select distinct b.order_no, c.subcon_job, c.party_id from pro_batch_create_dtls a, subcon_ord_dtls b, subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0 and a.mst_id in(".$batch_id.") ");
			foreach($po_data as $row)
			{
				$po_no.=$row[csf('order_no')].","; 
				$job_no.=$row[csf('subcon_job')].",";
				$buyer_name.=$buyer_library[$row[csf('party_id')]].",";
			}
		}
		else
		{
			$po_data=sql_select("select distinct b.po_number,b.file_no,b.grouping as ref, c.job_no, c.buyer_name from pro_batch_create_dtls a, wo_po_break_down b, wo_po_details_master c where a.po_id=b.id and b.job_no_mst=c.job_no and a.status_active=1 and a.is_deleted=0 and a.mst_id in(".$batch_id.") ");
			foreach($po_data as $row)
			{
				$po_no.=$row[csf('po_number')].","; 
				$job_no.=$row[csf('job_no')].",";
				$file_no.=$row[csf('file_no')].","; 
				$ref_no.=$row[csf('ref')].","; 
				//$buyer_name.=$buyer_library[$row[csf('buyer_name')]].",";
			}
			$file_no=rtrim($file_no,',');
			$file_nos=implode(",",array_unique(explode(",",$file_no)));
			$ref_no=rtrim($ref_no,',');
			$ref_nos=implode(",",array_unique(explode(",",$ref_no)));
			$batch_nos=$$batch_no;//implode(",",array_unique(explode(",",$batchdata_array[0][csf('batch_no')])));
			
			foreach(explode(",",$data_array[0][csf("buyer_id")]) as $buyer_id)
			{
				$buyer_name.=$buyer_library[$buyer_id].",";
			}
				
		}
		$color_id=array_unique(explode(",",$batchdata_array[0][csf('color_id')]));
		//echo '<pre>';print_r($color_id);
		$color_name='';
		foreach($color_id as $color)
		{
		$color_name.=$color_arr[$color].",";
		}
		$color_range_id=array_unique(explode(",",$batchdata_array[0][csf('color_range_id')]));
		$color_ranges='';
		foreach($color_range_id as $rang_id)
		{
		$color_ranges.=$color_range[$rang_id].",";
		}
		
		$color_range=substr($color_ranges,0,-1);
		//echo $batchdata_array[0][csf('double_dyeing')].', ';
		$double_dyeing=array_unique(explode(",",$batchdata_array[0][csf('double_dyeing')]));
		$double_dyeing_name='';
		foreach($double_dyeing as $dd_id)
		{
		$double_dyeing_name.=$yes_no[$dd_id].",";
		}
		
		$double_dyeingArr=substr($double_dyeing_name,0,-1);
		
	//$issue_batch_con 
	   /*$sql_isue_dtls = "select d.recipe_id,a.batch_no,
	 avg(b.cons_rate) as cons_rate, sum(b.cons_quantity) as cons_quantity,sum(b.cons_amount) as cons_amount, d.product_id as prod_id,
	   c.item_group_id, d.sub_process
	  from inv_issue_master a, inv_transaction b, product_details_master c, dyes_chem_issue_dtls d
	  where a.id=b.mst_id and b.id =d.trans_id and d.product_id=c.id and b.prod_id=c.id and b.transaction_type=2 and a.entry_form=5 and b.item_category in (5,6,7,23)   group by d.recipe_id,a.batch_no,d.product_id, c.item_group_id, d.sub_process order by d.sub_process "; 
	 // echo $sql_dtls; 
	  $sql_result_issue= sql_select($sql_isue_dtls);
	  $issue_data_arr=array();
	  foreach($sql_result_issue as $row)
	  {
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['issue_qty']+=$row[csf('cons_quantity')]; 
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_amount']+=$row[csf('cons_amount')]; 
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_rate']=$row[csf('cons_rate')]; 
	  }
	  unset($sql_result_issue);*/
	  ob_start();
	?>
    <script>
		function print_window()
		{
			var w = window.open("Surprise", "#");
			var d = w.document.open();
			d.write ('<!DOCTYPE HTML PUBLIC "-//W3C//DTsD HTML 4.01//EN""http://www.w3.org/TR/html4/strict.dtd">'+
			'<html><head><link rel="stylesheet" href="../../../../css/style_common.css" type="text/css" media="print"/><title></title></head><body>'+document.getElementById('report_div').innerHTML+'</body</html>');
			d.close();
		}	
		
		
		  
	</script>	
      <div> 
	<div style="width:870px; margin-left:30px" id="report_div">
     <div style="width:870px;" align="center">
    		 
        	<input  type="button" value="Print Preview" onClick="print_window()" style="width:90px"  class="formbutton"/> &nbsp;
             <div id="report_container"> </div>
        </div>
        <?
         ob_start();
		?>
     <table width="870" cellspacing="0" align="center"  >
        <tr>
        	<td width="100"><strong>Issue Date:</strong></td><td width="160px"><? echo change_date_format($dataArray[0][csf('requisition_date')]); ?></td>
            <td width="90"><strong>Issue Basis</strong></td> <td><? echo $receive_basis_arr[$dataArray[0][csf('requisition_basis')]]; ?></td>
            
            <td width="90"><strong></strong></td><td width="160px"><? //echo implode(",",array_unique(explode(",",$buyer_name))); ?></td>
       </tr>
        <tr>
            <td><strong>Buyer Order:</strong></td> <td><? echo rtrim($po_no,','); ?></td>
           <td><strong>Batch No</strong></td><td><? echo $batch_no; ?></td>
           <td><strong>Batch Weight</strong></td><td><? echo $main_batch_weight;//$batch_weight+$batchdata_array[0][csf('batch_weight')]; ?></td>
        </tr>
        <tr>
            <td><strong>File No</strong></td><td><? echo $file_nos; ?></td>
            <td><strong>Ref. No:</strong></td><td><? echo $ref_nos; ?></td>
            <td><strong>Batch Color:</strong></td><td><? echo rtrim($color_name,','); ?></td>
        </tr>
        <tr>
            <td><strong>Color Range/Group</strong></td><td><? echo $color_range; ?></td>
            <td><strong>Multi Dyeing</strong></td><td><? echo $double_dyeingArr; ?></td>
            <td><strong>Recipe no</strong></td><td><? echo $recipe_ids; ?></td>
        </tr> 
        <tr>
            <td><strong>Req. No</strong></td><td><? echo $requ_nos; ?></td>
           
        </tr>
       
    </table>
     <br>
    <?
	$recipe_arr=array_unique(explode(",",$recipe_ids));
	$recipe_min_id=min($recipe_arr);
	$sql_yarn_dtls = "select  e.knitting_company,e.knitting_source,c.po_breakdown_id as po_id,d.yarn_lot as yarn_lot,d.yarn_count as yarn_count,d.brand_id as brand_id,d.prod_id
	from pro_batch_create_mst a,pro_batch_create_dtls b, pro_roll_details c, pro_grey_prod_entry_dtls d,  inv_receive_master e 
	where a.id=b.mst_id and b.roll_id=c.id and c.dtls_id=d.id and d.mst_id=e.id  
 	and a.id in($batch_id) and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and e.entry_form in(2,22) group by  c.po_breakdown_id,d.yarn_lot,d.yarn_count,d.brand_id,d.prod_id,e.knitting_company,e.knitting_source";
	//echo $sql_yarn_dtls;
	$yarn_dtls_array = array();
	$result_sql_yarn_dtls = sql_select($sql_yarn_dtls);
	foreach ($result_sql_yarn_dtls as $row) {
		$yarn_count = array_unique(explode(",", $row[csf('yarn_count')]));
		$count_name = "";$prod_ids = "";
		foreach ($yarn_count as $val) {
			if ($count_name == "") $count_name = $count_arr[$val]; else $count_name .= ", " . $count_arr[$val];
		}
			//echo $yarn_lot.'DD';
			$yarn_dtls_array[$row[csf('prod_id')]]['yarn_lot'] .=$row[csf('yarn_lot')].',';
			$yarn_dtls_array[$row[csf('prod_id')]]['brand_name'] .= $brand_arr[$row[csf('brand_id')]].',';
			$yarn_dtls_array[$row[csf('prod_id')]]['count_name'] .= $count_name.',';
			if($row[csf('knitting_source')]==3)
			{
				$yarn_dtls_array[$row[csf('prod_id')]]['knitting_company']=$row[csf('knitting_company')];
			} 
			if($prod_ids=="") $prod_ids=$row[csf('prod_id')];else $prod_ids.=",".$row[csf('prod_id')];
	}
	 unset($result_sql_yarn_dtls);
	//array_unique(explode(",",$data_array[0][csf("batch_id")]))
    $batch_id_qry = explode(",", $dataArray[0][csf('batch_id')]);
    $j = 1;
    $entryForm = $entry_form_arr[$batch_id_qry[0]];
	//echo $recipe_min_id.'ddddddddd';
    ?>
    <table width="1070" cellspacing="0" align="center" class="rpt_table" border="1" rules="all">
    	<thead bgcolor="#dddddd" align="center">
    		<?
				//echo $entryForm.'A';
    		if ($entryForm == 0) {
    			?>
    			<tr bgcolor="#CCCCFF">
    				<th colspan="9" align="center"><strong>Fabrication</strong></th>
    			</tr>
    			<tr>
    				<th width="30">SL</th>
    				<th width="100">Dia/ W. Type</th>
    				<th width="100">Yarn Lot</th>
    				<th width="100">Supplier</th>
    				<th width="100">Count</th>
    				<th width="300">Constrution & Composition</th>
    				<th width="70">Gsm</th>
    				<th width="70">Dia</th>
    			</tr>
    			<?
    		} else {
    			?>
    			<tr bgcolor="#CCCCFF">
    				<th colspan="5" align="center"><strong>Fabrication</strong></th>
    			</tr>
    			<tr>
    				<th width="50">SL</th>
    				<th width="350">Gmts. Item</th>
    				<th width="110">Gmts. Qty</th>
    				<th>Batch Qty.</th>
    			</tr>
    			<?
    		}
    		?>
    	</thead>
    	<tbody>
    		<?
    		foreach ($batch_id_qry as $b_id) {
    			 $batch_query = "Select   prod_id, item_description, width_dia_type, count(roll_no) as gmts_qty, sum(batch_qnty) batch_qnty from pro_batch_create_dtls where mst_id in($b_id) and status_active=1 and is_deleted=0 group by   prod_id, item_description, width_dia_type";
    			$result_batch_query = sql_select($batch_query);
    			foreach ($result_batch_query as $rows) {
    				if ($j % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
    				$fabrication_full = $rows[csf("item_description")];
					$yarn_lot=$yarn_dtls_array[$rows[csf('prod_id')]]['yarn_lot'];
					$brand_name=$yarn_dtls_array[$rows[csf('prod_id')]]['brand_name'];
					$count_name=$yarn_dtls_array[$rows[csf('prod_id')]]['count_name'];
					$yarn_lots = implode(", ", array_unique(explode(",", substr($yarn_lot, 0, -1))));
					$brand_names = implode(", ", array_unique(explode(",", substr($brand_name, 0, -1))));
					$count_names = implode(", ", array_unique(explode(",", substr($count_name, 0, -1))));
			
			
    				$fabrication = explode(',', $fabrication_full);
					//echo $entry_form_arr[$b_id].'B';
    				if ($entry_form_arr[$b_id] == 0) {
    					?>
    					<tr bgcolor="<? echo $bgcolor; ?>">
    						<td align="center"><? echo $j; ?></td>
    						<td align="center"><? echo $fabric_typee[$rows[csf("width_dia_type")]]; ?></td>
                            <td align="center"><? echo $yarn_lots;
                            	?></td>
                            <td align="center"><? echo $supplier_library[$knitting_company];
                            	?></td>
                            <td align="center"><? echo $count_names;
                            	?></td>
                            	<td align="left"><? echo $fabrication[0].','.$fabrication[1]; ?></td>
                            	<td align="center"><? echo $fabrication[2]; ?></td>
                            	<td align="center"><? echo $fabrication[3]; ?></td>
                            </tr>
                            <?
                        } else if ($entry_form_arr[$b_id] == 74 || $entry_form_arr[$b_id] == 36) {
                        	?>
                        	<tr bgcolor="<? echo $bgcolor; ?>">
                        		<td align="center"><? echo $j; ?></td>
                        		<td align="left"><? echo $garments_item[$rows[csf('prod_id')]]; ?></td>
                        		<td align="right"><? echo $rows[csf('gmts_qty')]; ?></td>
                        		<td align="right"><? echo number_format($rows[csf('batch_qnty')], 2); ?></td>
                        	</tr>
                        	<?
                        } else {
                        	?>
                        	<tr bgcolor="<? echo $bgcolor; ?>">
                        		<td align="center"><? echo $j; ?></td>
                        		<td align="center"><? echo $fabric_typee[$rows[csf("width_dia_type")]]; ?></td>
                        		<td width="100" align="left"><p style="word-wrap:break-word;"><? echo $yarn_lots; ?></td>
                        		<td align="left"><? echo $supplier_library[$supliID_arr[$rows[csf('prod_id')]]['supplier_id']];//$yarn_dtls_array[$rows[csf('po_id')]][$rows[csf('prod_id')]]['brand_name']; ?></td>
                        		<td align="left"><? echo $count_names; ?></td>
                        		<td align="left"><? echo $fabrication[0] . ", " . $fabrication[1]; ?></td>
                        		<td align="center"><? echo $fabrication[2]; ?></td>
                        		<td align="center"><? echo $fabrication[3]; ?></td>
                        	</tr>
                        	<?
                        }
                        $j++;
                    }
                }
                ?>
            </tbody>
        </table>
        
    <table align="center" cellspacing="0" width="1180" border="1" rules="all" class="rpt_table" >
        <thead bgcolor="#dddddd" align="center">
    	   <tr bgcolor="#EFEFEF">   
                <th width="30">SL</th>
                <th width="80" >Item Cat.</th>
                <th width="100" >Item Group</th>
                <th width="100" >Sub Group</th>
                <th width="150">Item Description</th>
              
                <th width="50" >UOM</th>
                <th width="100" >Dose Base</th> 
                <th width="70" >Main Recipe Dosing</th>
                <th width="60" >Recipe Qty.</th>
                <th width="50" >Adj%</th>
                <th width="60" >Adj Type</th> 
                 
                <th width="60" >Adding Qty.(Kgs.)</th> 
                <th width="60" >Topping Qty.(Kgs.)</th>
                    
               
                <th width="80" >Iss. Qty.</th>
              
                <th width="70" >Unit Price</th>
                <th width="" >Amount(BDT)</th>
                </tr>
		</thead>
	<?  
 	$group_arr=return_library_array( "select id,item_name from lib_item_group where item_category in (5,6,7,23) and status_active=1 and is_deleted=0",'id','item_name');
	
 
  
		/*
		 $sql_dtls_adding = "select  a.dyeing_re_process,a.batch_id, a.id as recipe_id, b.sub_seq,
		b.sub_process_id,b.dose_base, b.ratio, b.adj_qnty as recipe_qnty,c.item_group_id as item_id,
	  	b.prod_id
	    from pro_recipe_entry_mst a,  pro_recipe_entry_dtls b,product_details_master c
	    where a.id=b.mst_id and  c.id=b.prod_id and  a.entry_form=60 and b.status_active=1 and a.batch_id in($all_dyeing_batch_id) and a.id in($recipe_ids)
		and adj_qnty>0 order by b.sub_process_id, b.sub_seq asc";
		$sql_result_adding= sql_select($sql_dtls_adding);
			foreach($sql_result_adding as $row)
			{
				if($row[csf("dyeing_re_process")]==2) //Adding
				{
				$topping_adding_array[$row[csf("recipe_id")]][$row[csf("item_id")]][$row[csf("prod_id")]][$row[csf("sub_process_id")]]['adding_recipe_qnty']+=$row[csf("recipe_qnty")];
				$topping_adding_array[$row[csf("recipe_id")]][$row[csf("item_id")]][$row[csf("prod_id")]][$row[csf("sub_process_id")]]['adding_ratio']=$row[csf("ratio")];
				}
				if($row[csf("dyeing_re_process")]==1) //Topping
				{
				$topping_adding_array[$row[csf("recipe_id")]][$row[csf("item_id")]][$row[csf("prod_id")]][$row[csf("sub_process_id")]]['topping_recipe_qnty']+=$row[csf("recipe_qnty")];
				$topping_adding_array[$row[csf("recipe_id")]][$row[csf("item_id")]][$row[csf("prod_id")]][$row[csf("sub_process_id")]]['topping_ratio']=$row[csf("ratio")];
				}
				//$sub_process_tot_req_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")];
				//$sub_process_tot_value_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")]*$row[csf("avg_rate_per_unit")];
			}*/
	
	 // echo $sql_dtls;//die;
	/* $sql_dtls = "(select a.batch_id, a.requ_no, a.recipe_id, b.id,
		b.sub_process, b.item_category, b.dose_base, b.ratio, b.recipe_qnty, b.adjust_percent, b.adjust_type,b.sub_seq, b.required_qnty, b.req_qny_edit,
	  	c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id,0 as dyeing_re_process
	    from dyes_chem_issue_requ_mst a,  dyes_chem_issue_requ_dtls b, product_details_master c
	    where a.id=b.mst_id and b.product_id=c.id and b.item_category in (5,6,7) and b.req_qny_edit!=0 and b.status_active=1 and c.item_category_id in (5,6,7)  $batch_con)
		union
		( select  to_char(a.batch_id) as batch_id, null as requ_no,to_char(a.id) as recipe_id,0 as id,b.sub_process_id as  sub_process,c.item_category_id as item_category,b.dose_base, b.ratio,b.adj_qnty as  recipe_qnty,b.adj_perc as adjust_percent,b.adj_type as adjust_type,b.sub_seq,0 as required_qnty, 0 as req_qny_edit,c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id,a.dyeing_re_process
	    from pro_recipe_entry_mst a,  pro_recipe_entry_dtls b,product_details_master c
	    where a.id=b.mst_id and  c.id=b.prod_id and  a.entry_form=60 and b.status_active=1 and a.batch_id in($all_dyeing_batch_id) and a.id in($recipe_ids)
		and b.adj_qnty>0) order by   sub_seq asc"; */
		/*echo $sql_dtls_main= "select  a.batch_id as batch_id, null as requ_no,a.id as recipe_id,0 as id,b.sub_process_id as  sub_process,c.item_category_id as item_category,b.dose_base, b.ratio,b.adj_qnty as  recipe_qnty,b.adj_perc as adjust_percent,b.adj_type as adjust_type,b.sub_seq,0 as required_qnty, 0 as req_qny_edit,c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id,a.dyeing_re_process
	    from pro_recipe_entry_mst a,  pro_recipe_entry_dtls b,product_details_master c
	    where a.id=b.mst_id and  c.id=b.prod_id and  a.entry_form=59 and b.status_active=1   and a.id in($recipe_min_id)
		and  b.ratio>0  order by b.sub_seq";
		 $sql_result_main= sql_select($sql_dtls_main);
			 foreach($sql_result_top as $row)
			{
				$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['batch_id']=$row[csf('batch_id')];
			}*/
		 //recipe_ids
		 $sql_main_recipe="select a.batch_against,b.id,c.sub_process_id,c.prod_id,c.ratio,d.item_group_id from pro_recipe_entry_mst b,pro_batch_create_mst a,pro_recipe_entry_dtls c,product_details_master d where a.id=b.batch_id and c.mst_id=b.id and d.id=c.prod_id  and b.entry_form=59 and b.status_active=1 and  b.id in($recipe_ids)  and d.item_category_id in (5,6,7,23) and b.status_active=1 and a.status_active=1  and c.status_active=1 order by c.sub_seq ,c.sub_process_id";
		 $sql_main_recipe_res= sql_select($sql_main_recipe);
		$main_recipe_id="";$re_dying_recipe_id="";
		foreach($sql_main_recipe_res as $row)
		{
			if($row[csf("batch_against")]==2)
			{
				$re_dying_recipe_id.=$row[csf("id")].',';
			}
			$main_recipe_id.=$row[csf("id")].',';
			if($row[csf("batch_against")]==1)
			{
			//if($recipe_min_id==$row[csf("id")])
			//{
				//echo $row[csf('ratio')].',';
				if($row[csf('ratio')]>0)
				{
				$main_req_data_arr[$row[csf("sub_process_id")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['main_ratio']=$row[csf('ratio')];
				}
			//}
			}
		}
		unset($sql_main_recipe_res);
		
		
		//batch_no
		$re_dying_recipe_id=rtrim($re_dying_recipe_id,',');
		//echo $re_dying_recipe_id.'DD';
		$main_recipe_ids=rtrim($main_recipe_id,',');
		 $main_recipe_idsArr=array_unique(explode(",",$main_recipe_ids));
		$sql_batch=sql_select("select id,batch_against from pro_batch_create_mst where id in($all_dyeing_batch_id) and status_active=1");
		
		foreach($sql_batch as $row)
		{
			$batch_chk_arr[$row[csf("id")]]=$row[csf("batch_against")];
		}
		unset($sql_batch);
		
	//$re_dying_batch_id=implode(",",$re_dying_batch_arr);
	//echo $re_dying_batch_id.',';
	
		//print_r($batch_chk_arr);
		
		
		
	     $sql_dtls = "select a.batch_id, a.requ_no, a.recipe_id, b.id,
		b.sub_process, b.item_category, b.dose_base, b.ratio, b.recipe_qnty, b.adjust_percent, b.adjust_type,b.sub_seq, b.required_qnty, b.req_qny_edit,
	  	c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id
	    from dyes_chem_issue_requ_mst a,  dyes_chem_issue_requ_dtls b, product_details_master c
	    where a.id=b.mst_id and b.product_id=c.id and a.id in($req_id) and b.item_category in (5,6,7,23) and b.req_qny_edit!=0 and b.status_active=1 and c.item_category_id in (5,6,7,23)  $batch_con order by b.sub_seq"; 
		
	$sql_result= sql_select($sql_dtls);
	
	$sub_process_array=array();
	$sub_process_tot_rec_array=array();
	$sub_process_tot_req_array=array();
	$sub_process_tot_value_array=array();
	
	foreach($sql_result as $row)
	{
		$sub_process_tot_rec_array[$row[csf("sub_process")]]+=$row[csf("recipe_qnty")];
		 //$recipe_min_id 
		 $recipe_id_idArr=array_unique(explode(",",$row[csf("recipe_id")]));
		// echo $batch_id.'='.$row[csf("batch_id")].'<br> ';
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id'].=$row[csf('recipe_id')].',';
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['batch_id']=$row[csf('batch_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['requ_no']=$row[csf('requ_no')];
		//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id']=$row[csf('recipe_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['id']=$row[csf('id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_process']=$row[csf('sub_process')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_category']=$row[csf('item_category')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['dose_base']=$row[csf('dose_base')];
		//if(in_array($batch_id,$batch_idArr))
		//{
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['ratio']=$row[csf('ratio')];
		//}
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_percent']=$row[csf('adjust_percent')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_type']=$row[csf('adjust_type')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_seq']=$row[csf('sub_seq')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['required_qnty']=$row[csf('required_qnty')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['req_qny_edit']=$row[csf('req_qny_edit')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_description']=$row[csf('item_description')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_group_id']=$row[csf('item_group_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_group_name']=$row[csf('sub_group_name')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_size']=$row[csf('item_size')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['unit_of_measure']=$row[csf('unit_of_measure')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['prod_id']=$row[csf('prod_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adding']='Issue Req';
		//$main_recipe_chk_arr[$row[csf("id")]];
		$all_product_arr[$row[csf('prod_id')]] = $row[csf('prod_id')];
		$ckh=1;
		foreach($main_recipe_idsArr as $rec_id)
		{
			$rec_id_chk=$rec_id;
			if($ckh==1)
			{
			if(in_array($rec_id_chk,$recipe_id_idArr))
			{
				//echo $row[csf('prod_id')].'='.$recipe_min_id.'='.$row[csf('recipe_qnty')].'<br>';
				$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['main_recipe_qnty']+=$row[csf('recipe_qnty')];
			}
			$chk++;
		  }
		}
		//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
	}
	unset($sql_result);
	 if ($re_dying_recipe_id!='')
	 {
	 if ($re_dying_recipe_id!='') $re_batch_con=" and d.recipe_id in($re_dying_recipe_id)"; else $re_batch_con="and d.recipe_id in(0)";
	     $sql_dtls_re = "select a.batch_id, a.requ_no, a.recipe_id, b.id,
		b.sub_process, b.item_category, b.dose_base, b.ratio, b.recipe_qnty, b.adjust_percent, b.adjust_type,b.sub_seq, b.required_qnty, b.req_qny_edit,
	  	c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id
	    from dyes_chem_issue_requ_mst a,  dyes_chem_issue_requ_dtls b, product_details_master c,dyes_chem_requ_recipe_att d
	    where a.id=b.mst_id and b.product_id=c.id  and a.id=d.mst_id and b.item_category in (5,6,7,23)  and a.id in($req_id)  and b.req_qny_edit!=0 and b.status_active=1 and c.item_category_id in (5,6,7,23)  $re_batch_con order by b.sub_seq ,b.sub_process"; 
		$sql_result_re= sql_select($sql_dtls_re);
		 
	foreach($sql_result_re as $row)
	{
		$sub_process_tot_rec_array[$row[csf("sub_process")]]+=$row[csf("recipe_qnty")];
		 //$recipe_min_id 
		 $recipe_id_idArr=array_unique(explode(",",$row[csf("recipe_id")]));
		// echo $batch_id.'='.$row[csf("batch_id")].'<br> ';
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id'].=$row[csf('recipe_id')].',';
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['batch_id']=$row[csf('batch_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['requ_no']=$row[csf('requ_no')];
		//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id']=$row[csf('recipe_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['id']=$row[csf('id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_process']=$row[csf('sub_process')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_category']=$row[csf('item_category')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['dose_base']=$row[csf('dose_base')];
		//if(in_array($batch_id,$batch_idArr))
		//{
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['ratio']=$row[csf('ratio')];
		//}
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_percent']=$row[csf('adjust_percent')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_type']=$row[csf('adjust_type')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_seq']=$row[csf('sub_seq')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['required_qnty']=$row[csf('required_qnty')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['req_qny_edit']=$row[csf('req_qny_edit')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_description']=$row[csf('item_description')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_group_id']=$row[csf('item_group_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_group_name']=$row[csf('sub_group_name')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_size']=$row[csf('item_size')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['unit_of_measure']=$row[csf('unit_of_measure')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['prod_id']=$row[csf('prod_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adding']='Issue Req';
		//$main_recipe_chk_arr[$row[csf("id")]];

		$ckh=1;
		foreach($main_recipe_idsArr as $rec_id)
		{
			$rec_id_chk=$rec_id;
			if($ckh==1)
			{
			if(in_array($rec_id_chk,$recipe_id_idArr))
			{
				//echo $row[csf('prod_id')].'='.$recipe_min_id.'='.$row[csf('recipe_qnty')].'<br>';
				//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['main_recipe_qnty']+=$row[csf('req_qny_edit')];
				$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['topping_recipe_qnty']+=$row[csf('recipe_qnty')];
			}
			$chk++;
		  }
		}
		//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
		$all_product_arr[$row[csf('prod_id')]] = $row[csf('prod_id')];
	}
	unset($sql_result_re);
	 }
	//echo $recipe_ids;die;
	
	if($recipe_ids!="")
	{
		    $sql_dtls_top= "select  a.batch_id as batch_id, null as requ_no,a.id as recipe_id,0 as id,b.sub_process_id as  sub_process,c.item_category_id as item_category,b.dose_base, b.ratio,b.adj_qnty as  recipe_qnty,b.adj_perc as adjust_percent,b.adj_type as adjust_type,b.sub_seq,0 as required_qnty, 0 as req_qny_edit,c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id,a.dyeing_re_process
	    from pro_recipe_entry_mst a,  pro_recipe_entry_dtls b,product_details_master c
	    where a.id=b.mst_id and  c.id=b.prod_id and  a.entry_form=60 and b.status_active=1 and a.batch_id in($all_dyeing_batch_id) and a.id in($recipe_ids)
		and b.adj_qnty>0 order by b.sub_seq,b.sub_process_id"; 
		 $sql_result_top= sql_select($sql_dtls_top);
		foreach($sql_result_top as $row)
		{
			$sub_process_tot_rec_array[$row[csf("sub_process")]]+=$row[csf("recipe_qnty")];
			 
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['batch_id']=$row[csf('batch_id')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id'].=$row[csf('recipe_id')].',';
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['requ_no']=$row[csf('requ_no')];
			//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id']=$row[csf('recipe_id')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['id']=$row[csf('id')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_process']=$row[csf('sub_process')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_category']=$row[csf('item_category')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['dose_base']=$row[csf('dose_base')];
			//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['ratio']=$row[csf('ratio')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_percent']=$row[csf('adjust_percent')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_type']=$row[csf('adjust_type')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_seq']=$row[csf('sub_seq')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['required_qnty']=$row[csf('required_qnty')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['req_qny_edit']=$row[csf('req_qny_edit')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_description']=$row[csf('item_description')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_group_id']=$row[csf('item_group_id')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_group_name']=$row[csf('sub_group_name')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_size']=$row[csf('item_size')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['unit_of_measure']=$row[csf('unit_of_measure')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['prod_id']=$row[csf('prod_id')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['dyeing_re_process']=$row[csf('dyeing_re_process')];
			$batch_againstId=$batch_chk_arr[$row[csf("batch_id")]];
			//if($batch_againstId==2)   echo $row[csf('batch_id')].'='.$batch_againstId.'<br>';|| $batch_againstId==2
			if($row[csf('dyeing_re_process')]==1) //Topping
			{	
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['topping_recipe_qnty']+=$row[csf('recipe_qnty')];
			}
			if($row[csf('dyeing_re_process')]==2 ) //Adding
			{	
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adding_recipe_qnty']+=$row[csf('recipe_qnty')];
			}
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adding']='Adding Topping';
			//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];

			$all_product_arr[$row[csf('prod_id')]] = $row[csf('prod_id')];
		}
		unset($sql_result_top);
	}
	?>
                
	<? 

	$all_product_arr = array_filter($all_product_arr);
    $all_prod_id_cond="";
	$prodCond="";
    if($db_type==2 && count($all_product_arr)>999)
    {
    	$all_product_arr_chunk=array_chunk($all_product_arr,999) ;
    	foreach($all_product_arr_chunk as $chunk_arr)
    	{
    		$chunk_arr_value=implode(",",$chunk_arr);
    		$prodCond.="  c.id in($chunk_arr_value) or ";
    	}

    	$all_prod_id_cond.=" and (".chop($prodCond,'or ').")";
    }
    else
    {
    	$all_prod_id_cond=" and c.id in(".implode(',', $all_product_arr).")";
    }
//REQUISITION_NO 

    $sql_isue_dtls = "SELECT d.recipe_id,a.batch_no, (b.cons_rate) as cons_rate, (b.cons_quantity) as cons_quantity,(b.cons_amount) as cons_amount, d.product_id as prod_id, c.item_group_id,c.avg_rate_per_unit, d.sub_process from inv_issue_master a, inv_transaction b, product_details_master c, dyes_chem_issue_dtls d  where a.id=b.mst_id and b.id =d.trans_id and d.product_id=c.id and b.prod_id=c.id and b.transaction_type=2 and a.entry_form=5 and b.item_category in (5,6,7,23)  and b.requisition_no in($req_id)  $all_prod_id_cond  "; 
	// echo $sql_isue_dtls; //die;
	  $sql_result_issue= sql_select($sql_isue_dtls);
	  $issue_data_arr=array();$tot_issueamt=0;
	  foreach($sql_result_issue as $row)
	  {
		 $issue_qty=$row[csf('cons_quantity')];
		// $row[csf('cons_quantity')]
		 $issue_perKg=($issue_qty/$main_batch_weight);
			$issue_wgt_per=$issue_perKg*$main_batch_weight;
			
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['issue_qty']+=$row[csf('cons_quantity')]; 
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['cons_amount']+=$row[csf('cons_amount')];//$issue_wgt_per*$row[csf('avg_rate_per_unit')]; 
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['cons_rate']=$row[csf('cons_amount')]/$row[csf('cons_quantity')]; 
		  $tot_issueamt+=$issue_wgt_per*$row[csf('avg_rate_per_unit')];
	  }
	  unset($sql_result_issue);
	 // echo $tot_issueamt.'DDDDDD';

	//var_dump($sub_process_tot_req_array);
	$i=1; $k=1; $recipe_qnty_sum=0; $req_qny_edit_sum=0; $recipe_qnty=0; $req_qny_edit=0; $req_value_sum=0;
	$req_value_grand=0; $recipe_qnty_grand=0; $req_qny_edit_grand=0;
	$total_adding_recipe_qnty=$total_topping_recipe_qnty=0;
	foreach($req_data_arr as $sub_process=>$sub_data)
	{
	foreach($sub_data as $prod_id=>$prod_data)
	{
		foreach($prod_data as $item_id=>$row)
		{
		 
		
		if ($i%2==0)  
			$bgcolor="#E9F3FF";
		else
			$bgcolor="#FFFFFF";
			if (!in_array($sub_process,$sub_process_array) )
			{
				$sub_process_array[]=$sub_process;
				if($k!=1)
				{
					?>
                    <tr>
                        <td colspan="8" align="right"><strong>Total :</strong></td>
                        <td align="right"><strong><?php  echo number_format($recipe_qnty_sum,6,'.',''); ?></strong></td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                		 
                         
                        
                        
                        <td align="right"><strong><?php  echo number_format($adding_recipe_qnty_sum,6,'.',''); ?></strong></td> 
                        <td align="right"><strong><?php  echo number_format($topping_recipe_qnty_sum,6,'.',''); ?></strong></td>
                        
                        <td align="right"><strong><?php  echo number_format($req_qny_issue_sum,6,'.',''); ?></strong></td>
                        
                        <td>&nbsp;</td>
                	
                        <td align="right"><strong><?php  echo number_format($amount_req_value_sum,6,'.',''); ?></strong></td>
                    </tr> 
			 <? 
			} 
			$recipe_qnty_sum=0;$adding_recipe_qnty_sum=0;$topping_recipe_qnty_sum=0;
			$req_qny_issue_sum=0;
			$amount_req_value_sum=0;
			$k++; 
			?>
            <tr bgcolor="#CCCCCC">
                <th colspan="17"><strong><? echo $dyeing_sub_process[$sub_process]; ?></strong></th>
            </tr> 
            
        <? 
		}
		
		 $recipe_id=rtrim($row[('recipe_id')],',');
		$recipe_ids=array_unique(explode(",",$recipe_id));
		$recipe_idsArr=implode(",",array_unique(explode(",",$recipe_id)));
		$issue_qty=$cons_amount=0;
		/*foreach($recipe_ids as $rid)
		{
		
		}*/
		$issue_qty=$issue_data_arr[$sub_process][$prod_id][$item_id]['issue_qty'];
		$cons_amount=$issue_data_arr[$sub_process][$prod_id][$item_id]['cons_amount'];
		$issue_cons_rate=$issue_data_arr[$sub_process][$prod_id][$item_id]['cons_rate'];
		//echo $row[csf('recipe_id')].',mmmm';
		$recipe_idArr=array_unique(explode(",",$recipe_id));
		$adding_recipe_qnty=$topping_recipe_qnty=0;
		foreach($recipe_idArr as $rid)
		{
		//$adding_recipe_qnty+=$topping_adding_array[$rid][$row[csf('item_group_id')]][$row[csf("prod_id")]][$row[csf("sub_process")]]['adding_recipe_qnty'];
		//$topping_recipe_qnty+=$topping_adding_array[$rid][$row[csf('item_group_id')]][$row[csf("prod_id")]][$row[csf("sub_process")]]['topping_recipe_qnty'];
		}
		 
		$adding_recipe_qnty=$row[('adding_recipe_qnty')];
		$topping_recipe_qnty=$row[('topping_recipe_qnty')];
		
		$total_adding_recipe_qnty+=$row[('adding_recipe_qnty')];
		$total_topping_recipe_qnty+=$row[('topping_recipe_qnty')];
		//$adding_recipe_qnty=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['adding_recipe_qnty'];
		//$topping_recipe_qnty=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['topping_recipe_qnty'];
		
	//	$adding_ratio=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['adding_ratio'];
	//	$topping_ratio=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['topping_ratio'];
	//$row[("recipe_id")]=$row[("recipe_id")];
	$main_ratio=$main_req_data_arr[$sub_process][$prod_id][$item_id]['main_ratio'];
		?>
        <tbody>
			<tr bgcolor="<? echo $bgcolor; ?>">
                <td align="center"><? echo $i; ?></td>
                <td><? echo $item_category[$row[("item_category")]];  //echo $row[csf("sub_process")]; ?></td>
                <td title="<? echo $row[("adding")];?>"><? echo $group_arr[$row[("item_group_id")]] ?></td>
                <td><? echo $row[("sub_group_name")]; ?></td>
              
                <td><? echo $row[("item_description")].' '.$row[("item_size")]; ?></td>
                
                <td align="center"><? echo $unit_of_measurement[$row[("unit_of_measure")]]; ?></td>
                <td><? echo $dose_base[$row[("dose_base")]]; ?></td>
                <td align="right"><? echo number_format($main_ratio,6,'.',''); ?></td>
                <td align="right" title="<? echo $recipe_idsArr;?>"> <? echo number_format($row[("main_recipe_qnty")],6,'.',''); ?></td>
                <td align="center"><? echo $row[("adjust_percent")]; ?></td>
                <td><? echo $increase_decrease[$row[("adjust_type")]]; ?></td>
                
                 <td align="right"><? echo number_format($adding_recipe_qnty,6); ?></td>
                
                 <td align="right"><? echo number_format($topping_recipe_qnty,6); ?></td>
                    
              
                <td align="right" title="Issue_qty=<? echo $issue_qty.'='.$row[('recipe_id')];?>"><? 
				$tot_issue_qty=$issue_qty+$adding_recipe_qnty+$topping_recipe_qnty;
				echo number_format($issue_qty,6,'.',''); ?></td>
                
                <td align="right"><? if($cons_amount) echo  number_format($cons_amount/$issue_qty,6,'.','');else echo "0"; ?></td>
                <td align="right"><? $amount_req_value=$cons_amount;//$issue_qty*$issue_cons_rate; 
				echo number_format($amount_req_value,6,'.',''); ?></td>
			</tr>
        </tbody>
		<? $i++;
        $recipe_qnty_sum +=$row[('main_recipe_qnty')];
        $req_qny_issue_sum +=$issue_qty; 
		
		$adding_recipe_qnty_sum +=$adding_recipe_qnty; 
		$topping_recipe_qnty_sum +=$topping_recipe_qnty;
		
		$amount_req_value_sum +=$amount_req_value;
		
		$recipe_qnty_grand +=$row[('main_recipe_qnty')];
        $req_qny_issue_grand +=$issue_qty;
		$amount_req_value_grand +=$amount_req_value;
         
		}
		
	  }
	} //End
		foreach ($sub_process_tot_rec_array as $val_rec)
		{
			 $totval_rec=$val_rec;
		}
		/*foreach ($sub_process_tot_req_array as $val_req)
		{
			 $totval_req=$val_req;
		}
		foreach ($sub_process_tot_value_array as $req_value)
		{
			 $tot_req_value=$req_value;
		}*/
		
		//$recipe_qnty_grand +=$val_rec;
        //$req_qny_edit_grand +=$val_req;
		//$req_value_grand +=$req_value;
		?>
           <tr>
                <td colspan="8" align="right"><strong>Total :</strong></td>
                <td align="right"><strong><?php echo number_format($totval_rec,6,'.',''); ?></strong></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                
                 <td align="right"><strong><?php  echo number_format($adding_recipe_qnty_sum,6,'.',''); ?></strong></td> 
                 <td align="right"><strong><?php  echo number_format($topping_recipe_qnty_sum,6,'.',''); ?></strong></td>
                
                
                
                <td align="right"><strong><?php echo number_format($req_qny_issue_sum,6,'.',''); ?></strong></td>
               
                <td>&nbsp;</td>
                <td align="right"><strong><?php echo number_format($amount_req_value_sum,6,'.',''); ?></strong></td>
            </tr> 
             <tr>
                <td colspan="8" align="right"><strong> Grand Total :</strong></td>
                <td align="right"><strong><?php echo number_format($recipe_qnty_grand,6,'.',''); ?></strong></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                 <td  align="right"><strong><?php echo number_format($total_adding_recipe_qnty,6,'.',''); ?></strong></td>
                <td  align="right"><strong><?php echo number_format($total_topping_recipe_qnty,6,'.',''); ?></strong></td>
                
               
                <td align="right"><strong><?php echo number_format($req_qny_issue_grand,6,'.',''); ?></strong></td>
                <td>&nbsp;</td>
                
                <td align="right"><strong><?php echo number_format($amount_req_value_grand,6,'.',''); ?></strong></td>
            </tr> 
               <tr>
                <td colspan="14" align="right"><strong> Cost Per Kg :</strong></td>
                <td colspan="2" align="right"><strong><?php echo number_format($amount_req_value_grand/($batch_weight+$batchdata_array[0][csf('batch_weight')]),6,'.',''); ?></strong></td>
            </tr>                          
      </table>
        <br>
      	<?  	
	 
	 
    $html=ob_get_contents();
			ob_flush();
			
			foreach (glob(""."*.xls") as $filename) 
			{
			   @unlink($filename);
			}
			
			//html to xls convert
			$name=time();
			$name=$user_id."_".$name.".xls";
			$create_new_excel = fopen(''.$name, 'w');	
			$is_created = fwrite($create_new_excel,$html);
	
	?>
      <input type="hidden" id="txt_excl_link" value="<? echo 'requires/'.$name; ?>" />
    <script>
	$(document).ready(function(e) {
				document.getElementById('report_container').innerHTML='<a href="<? echo $name?>" style="text-decoration:none"><input type="button" value="Excel Download" name="excel" id="excel" class="formbutton" style="width:90px;font-size:11px"/></a>&nbsp;&nbsp;';
		});	
	</script>
      </div> 
    <?
	exit();
}
if($action=="batch_wise_subprocess_fabrics_dtls_popup_not_used")
{
	echo load_html_head_contents("Subprocess Details", "../../../../", 1, 1,$unicode,'','');
	extract($_REQUEST);
	//echo $batch_id;
	//if($batch_id!='') $batch_con=" and LIKE a.batch_id";
	$color_arr=return_library_array( "select id, color_name from lib_color", "id", "color_name");
	//$re_dyeing_batch_id=return_field_value("id","pro_batch_create_mst","batch_no='".$batch_no."' and batch_against=2 and extention_no!=0");
	//	$entry_form_arr = return_library_array("select id, entry_form from pro_batch_create_mst", "id", "entry_form");
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", 'id', 'yarn_count');
	$sql_batch=sql_select("select id,batch_no,entry_form ,batch_against from pro_batch_create_mst where batch_no='".$batch_no."'  and status_active=1");
	foreach($sql_batch as $bid)
	{
		if($bid[csf('batch_against')]==2)
		{
		$re_dyeing_batch_id.=$bid[csf('id')].',';
		}
		$entry_form_arr[$bid[csf('id')]]=$bid[csf('entry_form')];//re_dyeing_batch_id
		$all_dyeing_batch_id.=$bid[csf('id')].',';
	}
	$re_dyeing_batch_id=rtrim($re_dyeing_batch_id,',');
	$all_dyeing_batch_id=rtrim($all_dyeing_batch_id,',');

	if ($batch_id!='') $batch_con=" and a.batch_id like '%$batch_id%'"; else $batch_con="and a.batch_id='0'";
	if ($batch_id!='') $issue_batch_con=" and d.batch_id like '%$batch_id%'"; else $issue_batch_con="and d.batch_id='0'";

	if ($re_dyeing_batch_id!='') { 
	$redyeing_batch_id=" and d.batch_id in($re_dyeing_batch_id)";
	$redyeing_batch_id2=" and batch_id in($re_dyeing_batch_id)";
	$redyeing_batch_id3="  batch_id in($re_dyeing_batch_id)";
	}
 else { 
 $redyeing_batch_id="and d.batch_id in(0)";
 $redyeing_batch_id2="and batch_id in(0)";
 $redyeing_batch_id3="  batch_id in(0)";
 }

  
	$batch_weight=0;
	if($db_type==0) 
	{
		$data_array=sql_select("select group_concat(buyer_id) as buyer_id,group_concat(id) as recipe_id, group_concat(batch_id) as batch_id, sum(total_liquor) as total_liquor, group_concat(concat_ws(':',batch_ratio,liquor_ratio) order by id) as ratio, sum(case when entry_form=60 then new_batch_weight end) as batch_weight, group_concat(case when entry_form<>60 then batch_id end) as batch_id_rec_main from pro_recipe_entry_mst where batch_id in($all_dyeing_batch_id)");
		
	}
	else
	{
		$data_array=sql_select("select listagg(buyer_id,',') within group (order by buyer_id) as buyer_id,listagg(id,',') within group (order by id) as recipe_id, listagg(batch_id,',') within group (order by batch_id) as batch_id, sum(total_liquor) as total_liquor, listagg(batch_ratio || ':' || liquor_ratio,',') within group (order by id) as ratio, sum(case when entry_form=60 then new_batch_weight end) as batch_weight, listagg(case when entry_form<>60 then batch_id end,',') within group (order by batch_id) as batch_id_rec_main from pro_recipe_entry_mst where  batch_id in($all_dyeing_batch_id)");
		// echo "select listagg(buyer_id,',') within group (order by buyer_id) as buyer_id,listagg(id,',') within group (order by id) as recipe_id, listagg(batch_id,',') within group (order by batch_id) as batch_id, sum(total_liquor) as total_liquor, listagg(batch_ratio || ':' || liquor_ratio,',') within group (order by id) as ratio, sum(case when entry_form=60 then new_batch_weight end) as batch_weight, listagg(case when entry_form<>60 then batch_id end,',') within group (order by batch_id) as batch_id_rec_main from pro_recipe_entry_mst where  batch_id in($all_dyeing_batch_id)";
		
	}
	 $recipe_id=$data_array[0][csf('recipe_id')];
	 $recipe_ids=implode(",",array_unique(explode(",",$recipe_id)));
	//$batch_weight=$data_array[0][csf("batch_weight")];

	$batch_id=implode(",",array_unique(explode(",",$data_array[0][csf("batch_id")])));
	
	$batch_id_rec_main=implode(",",array_unique(explode(",",$data_array[0][csf("batch_id_rec_main")])));
	if($batch_id_rec_main=="") $batch_id_rec_main=0;

	if($db_type==0) 
	{
		if(!$batch_id) $batch_id=0;
		//echo "select group_concat(batch_no) as batch_no, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight, group_concat(distinct color_id) as color_id,group_concat(distinct color_range_id) as color_range_id from pro_batch_create_mst where id in($batch_id)";die;

		$batchdata_array=sql_select("select group_concat(batch_no) as batch_no,group_concat(double_dyeing) as double_dyeing, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight, group_concat(distinct color_id) as color_id,group_concat(distinct color_range_id) as color_range_id from pro_batch_create_mst where id in($batch_id)");
	}
	else //color_range_id
	{
		$batchdata_array=sql_select("select listagg(CAST(batch_no AS VARCHAR2(4000)),',') within group (order by id) as batch_no, listagg(double_dyeing ,',') within group (order by id) as double_dyeing, listagg(color_id ,',') within group (order by id) as color_id,listagg(color_range_id ,',') within group (order by id) as color_range_id, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight from pro_batch_create_mst where id in($batch_id)");
		//echo "select listagg(CAST(batch_no AS VARCHAR2(4000)),',') within group (order by id) as batch_no, listagg(double_dyeing ,',') within group (order by id) as double_dyeing, listagg(color_id ,',') within group (order by id) as color_id,listagg(color_range_id ,',') within group (order by id) as color_range_id, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight from pro_batch_create_mst where id in($batch_id)";	
	}
	
	$sql="select a.id, a.requ_no, a.location_id, a.requisition_date,a.method, a.requisition_basis, a.batch_id, b.recipe_id, a.machine_id from dyes_chem_issue_requ_mst a , dyes_chem_requ_recipe_att b where a.id=b.mst_id and a.status_active=1 and b.recipe_id in($recipe_ids)";

	$dataArray=sql_select($sql);
	foreach($dataArray as $row)
	{
		$req_no_arr[$row[csf('requ_no')]]=$row[csf('requ_no')];
		$req_id_arr[$row[csf('id')]]=$row[csf('id')];
	}
	
	  $requ_nos=implode(",",$req_no_arr);
	  $req_ids=implode(",",$req_id_arr);
	$po_no=''; $job_no='';$file_no='';$ref_no=''; $buyer_name='';
		if($batch_type==2)
		{
			$po_data=sql_select("select distinct b.order_no, c.subcon_job, c.party_id from pro_batch_create_dtls a, subcon_ord_dtls b, subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0 and a.mst_id in(".$batch_id.") ");
			foreach($po_data as $row)
			{
				$po_no.=$row[csf('order_no')].","; 
				$job_no.=$row[csf('subcon_job')].",";
				$buyer_name.=$buyer_library[$row[csf('party_id')]].",";
			}
		}
		else
		{
			$po_data=sql_select("select distinct b.po_number,b.file_no,b.grouping as ref, c.job_no, c.buyer_name from pro_batch_create_dtls a, wo_po_break_down b, wo_po_details_master c where a.po_id=b.id and b.job_no_mst=c.job_no and a.status_active=1 and a.is_deleted=0 and a.mst_id in(".$batch_id.") ");
			foreach($po_data as $row)
			{
				$po_no.=$row[csf('po_number')].","; 
				$job_no.=$row[csf('job_no')].",";
				$file_no.=$row[csf('file_no')].","; 
				$ref_no.=$row[csf('ref')].","; 
				//$buyer_name.=$buyer_library[$row[csf('buyer_name')]].",";
			}
			$file_no=rtrim($file_no,',');
			$file_nos=implode(",",array_unique(explode(",",$file_no)));
			$ref_no=rtrim($ref_no,',');
			$ref_nos=implode(",",array_unique(explode(",",$ref_no)));
			$batch_nos=implode(",",array_unique(explode(",",$batchdata_array[0][csf('batch_no')])));
			
			foreach(explode(",",$data_array[0][csf("buyer_id")]) as $buyer_id)
			{
				$buyer_name.=$buyer_library[$buyer_id].",";
			}
				
		}
		$color_id=array_unique(explode(",",$batchdata_array[0][csf('color_id')]));
		$color_name='';
		foreach($color_id as $color)
		{
		$color_name.=$color_arr[$color].",";
		}
		$color_range_id=array_unique(explode(",",$batchdata_array[0][csf('color_range_id')]));
		$color_ranges='';
		foreach($color_range_id as $rang_id)
		{
		$color_ranges.=$color_range[$rang_id].",";
		}
		
		$color_range=substr($color_ranges,0,-1);
		//echo $batchdata_array[0][csf('double_dyeing')].', ';
		$double_dyeing=array_unique(explode(",",$batchdata_array[0][csf('double_dyeing')]));
		$double_dyeing_name='';
		foreach($double_dyeing as $dd_id)
		{
		$double_dyeing_name.=$yes_no[$dd_id].",";
		}
		
		$double_dyeingArr=substr($double_dyeing_name,0,-1);
		
	//$issue_batch_con 
	   $sql_isue_dtls = "select d.recipe_id,a.batch_no,
	 avg(b.cons_rate) as cons_rate, sum(b.cons_quantity) as cons_quantity,sum(b.cons_amount) as cons_amount, d.product_id as prod_id,
	   c.item_group_id, d.sub_process
	  from inv_issue_master a, inv_transaction b, product_details_master c, dyes_chem_issue_dtls d
	  where a.id=b.mst_id and b.id =d.trans_id and d.product_id=c.id and b.prod_id=c.id and b.transaction_type=2 and a.entry_form=5 and b.item_category in (5,6,7,23)   group by d.recipe_id,a.batch_no,d.product_id, c.item_group_id, d.sub_process order by d.sub_process "; 
	 // echo $sql_dtls; 
	  $sql_result_issue= sql_select($sql_isue_dtls);
	  $issue_data_arr=array();
	  foreach($sql_result_issue as $row)
	  {
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['issue_qty']+=$row[csf('cons_quantity')]; 
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_amount']+=$row[csf('cons_amount')]; 
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_rate']=$row[csf('cons_rate')]; 
	  }
	  ob_start();
	?>
    <script>
		function print_window()
		{
			var w = window.open("Surprise", "#");
			var d = w.document.open();
			d.write ('<!DOCTYPE HTML PUBLIC "-//W3C//DTsD HTML 4.01//EN""http://www.w3.org/TR/html4/strict.dtd">'+
			'<html><head><link rel="stylesheet" href="../../../../css/style_common.css" type="text/css" media="print"/><title></title></head><body>'+document.getElementById('report_div').innerHTML+'</body</html>');
			d.close();
		}	
		
		
		  
	</script>	
      <div> 
	<div style="width:870px; margin-left:30px" id="report_div">
     <div style="width:870px;" align="center">
    		 
        	<input  type="button" value="Print Preview" onClick="print_window()" style="width:90px"  class="formbutton"/> &nbsp;
             <div id="report_container"> </div>
        </div>
        <?
         ob_start();
		?>
     <table width="870" cellspacing="0" align="center"  >
        <tr>
        	<td width="100"><strong>Issue Date:</strong></td><td width="160px"><? echo change_date_format($dataArray[0][csf('requisition_date')]); ?></td>
            <td width="90"><strong>Issue Basis</strong></td> <td><? echo $receive_basis_arr[$dataArray[0][csf('requisition_basis')]]; ?></td>
            
            <td width="90"><strong></strong></td><td width="160px"><? //echo implode(",",array_unique(explode(",",$buyer_name))); ?></td>
       </tr>
        <tr>
            <td><strong>Buyer Order:</strong></td> <td><? echo $po_no; ?></td>
           <td><strong>Batch No</strong></td><td><? echo $batch_nos; ?></td>
           <td><strong>Batch Weight</strong></td><td><? echo $batch_weight+$batchdata_array[0][csf('batch_weight')]; ?></td>
        </tr>
        <tr>
            <td><strong>File No</strong></td><td><? echo $file_nos; ?></td>
            <td><strong>Ref. No:</strong></td><td><? echo $ref_nos; ?></td>
            <td><strong>Batch Color:</strong></td><td><? echo $color_name; ?></td>
        </tr>
        <tr>
            <td><strong>Color Range/Group</strong></td><td><? echo $color_range; ?></td>
            <td><strong>Multi Dyeing</strong></td><td><? echo $double_dyeingArr; ?></td>
            <td><strong>Recipe no</strong></td><td><? echo $recipe_ids; ?></td>
        </tr> 
        <tr>
            <td><strong>Req. No</strong></td><td><? echo $requ_nos; ?></td>
           
        </tr>
       
    </table>
     <br>
    <?
	$recipe_arr=array_unique(explode(",",$recipe_ids));
	$recipe_min_id=min($recipe_arr);
	$sql_yarn_dtls = "select  e.knitting_company,e.knitting_source,c.po_breakdown_id as po_id,d.yarn_lot as yarn_lot,d.yarn_count as yarn_count,d.brand_id as brand_id,d.prod_id
	from pro_batch_create_mst a,pro_batch_create_dtls b, pro_roll_details c, pro_grey_prod_entry_dtls d,  inv_receive_master e 
	where a.id=b.mst_id and b.roll_id=c.id and c.dtls_id=d.id and d.mst_id=e.id  
 	and a.id in($batch_id) and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and e.entry_form in(2,22) group by  c.po_breakdown_id,d.yarn_lot,d.yarn_count,d.brand_id,d.prod_id,e.knitting_company,e.knitting_source";
	//echo $sql_yarn_dtls;
	$yarn_dtls_array = array();
	$result_sql_yarn_dtls = sql_select($sql_yarn_dtls);
	foreach ($result_sql_yarn_dtls as $row) {
		$yarn_count = array_unique(explode(",", $row[csf('yarn_count')]));
		$count_name = "";$prod_ids = "";
		foreach ($yarn_count as $val) {
			if ($count_name == "") $count_name = $count_arr[$val]; else $count_name .= ", " . $count_arr[$val];
		}
			//echo $yarn_lot.'DD';
			$yarn_dtls_array[$row[csf('prod_id')]]['yarn_lot'] .=$row[csf('yarn_lot')].',';
			$yarn_dtls_array[$row[csf('prod_id')]]['brand_name'] .= $brand_arr[$row[csf('brand_id')]].',';
			$yarn_dtls_array[$row[csf('prod_id')]]['count_name'] .= $count_name.',';
			if($row[csf('knitting_source')]==3)
			{
				$yarn_dtls_array[$row[csf('prod_id')]]['knitting_company']=$row[csf('knitting_company')];
			} 
			if($prod_ids=="") $prod_ids=$row[csf('prod_id')];else $prod_ids.=",".$row[csf('prod_id')];
	}
	
	//array_unique(explode(",",$data_array[0][csf("batch_id")]))
    $batch_id_qry = explode(",", $dataArray[0][csf('batch_id')]);
    $j = 1;
    $entryForm = $entry_form_arr[$batch_id_qry[0]];
    ?>
    <table width="1000" cellspacing="0" align="center" class="rpt_table" border="1" rules="all">
    	<thead bgcolor="#dddddd" align="center">
    		<?
				//echo $entryForm.'A';
    		if ($entryForm == 0) {
    			?>
    			<tr bgcolor="#CCCCFF">
    				<th colspan="8" align="center"><strong>Fabrication</strong></th>
    			</tr>
    			<tr>
    				<th width="30">SL</th>
    				<th width="100">Dia/ W. Type</th>
    				<th width="100">Yarn Lot</th>
    				<th width="100">Supplier</th>
    				<th width="100">Count</th>
    				<th width="300">Constrution & Composition</th>
    				<th width="70">Gsm</th>
    				<th width="70">Dia</th>
    			</tr>
    			<?
    		} else {
    			?>
    			<tr bgcolor="#CCCCFF">
    				<th colspan="4" align="center"><strong>Fabrication</strong></th>
    			</tr>
    			<tr>
    				<th width="50">SL</th>
    				<th width="350">Gmts. Item</th>
    				<th width="110">Gmts. Qty</th>
    				<th>Batch Qty.</th>
    			</tr>
    			<?
    		}
    		?>
    	</thead>
    	<tbody>
    		<?
    		foreach ($batch_id_qry as $b_id) {
    			 $batch_query = "Select   prod_id, item_description, width_dia_type, count(roll_no) as gmts_qty, sum(batch_qnty) batch_qnty from pro_batch_create_dtls where mst_id in($b_id) and status_active=1 and is_deleted=0 group by   prod_id, item_description, width_dia_type";
    			$result_batch_query = sql_select($batch_query);
    			foreach ($result_batch_query as $rows) {
    				if ($j % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
    				$fabrication_full = $rows[csf("item_description")];
					$yarn_lot=$yarn_dtls_array[$rows[csf('prod_id')]]['yarn_lot'];
					$brand_name=$yarn_dtls_array[$rows[csf('prod_id')]]['brand_name'];
					$count_name=$yarn_dtls_array[$rows[csf('prod_id')]]['count_name'];
					$yarn_lots = implode(", ", array_unique(explode(",", substr($yarn_lot, 0, -1))));
					$brand_names = implode(", ", array_unique(explode(",", substr($brand_name, 0, -1))));
					$count_names = implode(", ", array_unique(explode(",", substr($count_name, 0, -1))));
			
			
    				$fabrication = explode(',', $fabrication_full);
					//echo $entry_form_arr[$b_id].'B';
    				if ($entry_form_arr[$b_id] == 0) {
    					?>
    					<tr bgcolor="<? echo $bgcolor; ?>">
    						<td align="center"><? echo $j; ?></td>
    						<td align="center"><? echo $fabric_typee[$rows[csf("width_dia_type")]]; ?></td>
                            <td align="center"><? echo $yarn_lots;
                            	?></td>
                            <td align="center"><? echo $supplier_library[$knitting_company];
                            	?></td>
                            <td align="center"><? echo $count_names;
                            	?></td>
                            	<td align="left"><? echo $fabrication[0].','.$fabrication[1]; ?></td>
                            	<td align="center"><? echo $fabrication[2]; ?></td>
                            	<td align="center"><? echo $fabrication[3]; ?></td>
                            </tr>
                            <?
                        } else if ($entry_form_arr[$b_id] == 74 || $entry_form_arr[$b_id] == 36) {
                        	?>
                        	<tr bgcolor="<? echo $bgcolor; ?>">
                        		<td align="center"><? echo $j; ?></td>
                        		<td align="left"><? echo $garments_item[$rows[csf('prod_id')]]; ?></td>
                        		<td align="right"><? echo $rows[csf('gmts_qty')]; ?></td>
                        		<td align="right"><? echo number_format($rows[csf('batch_qnty')], 2); ?></td>
                        	</tr>
                        	<?
                        } else {
                        	?>
                        	<tr bgcolor="<? echo $bgcolor; ?>">
                        		<td align="center"><? echo $j; ?></td>
                        		<td align="center"><? echo $fabric_typee[$rows[csf("width_dia_type")]]; ?></td>
                        		<td width="100" align="left"><p style="word-wrap:break-word;"><? echo $yarn_lots; ?></td>
                        		<td align="left"><? echo $supplier_library[$supliID_arr[$rows[csf('prod_id')]]['supplier_id']];//$yarn_dtls_array[$rows[csf('po_id')]][$rows[csf('prod_id')]]['brand_name']; ?></td>
                        		<td align="left"><? echo $count_names; ?></td>
                        		<td align="left"><? echo $fabrication[0] . ", " . $fabrication[1]; ?></td>
                        		<td align="center"><? echo $fabrication[2]; ?></td>
                        		<td align="center"><? echo $fabrication[3]; ?></td>
                        	</tr>
                        	<?
                        }
                        $j++;
                    }
                }
                ?>
            </tbody>
        </table>
        
    <table align="center" cellspacing="0" width="1110" border="1" rules="all" class="rpt_table" >
        <thead bgcolor="#dddddd" align="center">
    	   <tr bgcolor="#EFEFEF">   
                <th width="30">SL</th>
                <th width="80" >Item Cat.</th>
                <th width="100" >Item Group</th>
                <th width="100" >Sub Group</th>
                <th width="150">Item Description</th>
              
                <th width="50" >UOM</th>
                <th width="100" >Dose Base</th> 
                <!--<th width="40" >Ratio</th>-->
                <th width="60" >Recipe Qty.</th>
                <th width="50" >Adj%</th>
                <th width="60" >Adj Type</th> 
                 
                <th width="60" >Adding Qty.(Kgs.)</th> 
                <th width="60" >Topping Qty.(Kgs.)</th>
                    
               
                <th width="80" >Iss. Qty.</th>
              
                <th width="70" >Unit Price</th>
                <th width="" >Amount(BDT)</th>
                </tr>
		</thead>
	<?  
 	$group_arr=return_library_array( "select id,item_name from lib_item_group where item_category in (5,6,7) and status_active=1 and is_deleted=0",'id','item_name');
	
 
  
		/*
		 $sql_dtls_adding = "select  a.dyeing_re_process,a.batch_id, a.id as recipe_id, b.sub_seq,
		b.sub_process_id,b.dose_base, b.ratio, b.adj_qnty as recipe_qnty,c.item_group_id as item_id,
	  	b.prod_id
	    from pro_recipe_entry_mst a,  pro_recipe_entry_dtls b,product_details_master c
	    where a.id=b.mst_id and  c.id=b.prod_id and  a.entry_form=60 and b.status_active=1 and a.batch_id in($all_dyeing_batch_id) and a.id in($recipe_ids)
		and adj_qnty>0 order by b.sub_process_id, b.sub_seq asc";
		$sql_result_adding= sql_select($sql_dtls_adding);
			foreach($sql_result_adding as $row)
			{
				if($row[csf("dyeing_re_process")]==2) //Adding
				{
				$topping_adding_array[$row[csf("recipe_id")]][$row[csf("item_id")]][$row[csf("prod_id")]][$row[csf("sub_process_id")]]['adding_recipe_qnty']+=$row[csf("recipe_qnty")];
				$topping_adding_array[$row[csf("recipe_id")]][$row[csf("item_id")]][$row[csf("prod_id")]][$row[csf("sub_process_id")]]['adding_ratio']=$row[csf("ratio")];
				}
				if($row[csf("dyeing_re_process")]==1) //Topping
				{
				$topping_adding_array[$row[csf("recipe_id")]][$row[csf("item_id")]][$row[csf("prod_id")]][$row[csf("sub_process_id")]]['topping_recipe_qnty']+=$row[csf("recipe_qnty")];
				$topping_adding_array[$row[csf("recipe_id")]][$row[csf("item_id")]][$row[csf("prod_id")]][$row[csf("sub_process_id")]]['topping_ratio']=$row[csf("ratio")];
				}
				//$sub_process_tot_req_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")];
				//$sub_process_tot_value_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")]*$row[csf("avg_rate_per_unit")];
			}*/
	
	 // echo $sql_dtls;//die;
	/* $sql_dtls = "(select a.batch_id, a.requ_no, a.recipe_id, b.id,
		b.sub_process, b.item_category, b.dose_base, b.ratio, b.recipe_qnty, b.adjust_percent, b.adjust_type,b.sub_seq, b.required_qnty, b.req_qny_edit,
	  	c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id,0 as dyeing_re_process
	    from dyes_chem_issue_requ_mst a,  dyes_chem_issue_requ_dtls b, product_details_master c
	    where a.id=b.mst_id and b.product_id=c.id and b.item_category in (5,6,7) and b.req_qny_edit!=0 and b.status_active=1 and c.item_category_id in (5,6,7)  $batch_con)
		union
		( select  to_char(a.batch_id) as batch_id, null as requ_no,to_char(a.id) as recipe_id,0 as id,b.sub_process_id as  sub_process,c.item_category_id as item_category,b.dose_base, b.ratio,b.adj_qnty as  recipe_qnty,b.adj_perc as adjust_percent,b.adj_type as adjust_type,b.sub_seq,0 as required_qnty, 0 as req_qny_edit,c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id,a.dyeing_re_process
	    from pro_recipe_entry_mst a,  pro_recipe_entry_dtls b,product_details_master c
	    where a.id=b.mst_id and  c.id=b.prod_id and  a.entry_form=60 and b.status_active=1 and a.batch_id in($all_dyeing_batch_id) and a.id in($recipe_ids)
		and b.adj_qnty>0) order by   sub_seq asc"; */
		/*echo $sql_dtls_main= "select  a.batch_id as batch_id, null as requ_no,a.id as recipe_id,0 as id,b.sub_process_id as  sub_process,c.item_category_id as item_category,b.dose_base, b.ratio,b.adj_qnty as  recipe_qnty,b.adj_perc as adjust_percent,b.adj_type as adjust_type,b.sub_seq,0 as required_qnty, 0 as req_qny_edit,c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id,a.dyeing_re_process
	    from pro_recipe_entry_mst a,  pro_recipe_entry_dtls b,product_details_master c
	    where a.id=b.mst_id and  c.id=b.prod_id and  a.entry_form=59 and b.status_active=1   and a.id in($recipe_min_id)
		and  b.ratio>0  order by b.sub_seq";
		 $sql_result_main= sql_select($sql_dtls_main);
			 foreach($sql_result_top as $row)
			{
				$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['batch_id']=$row[csf('batch_id')];
			}*/
		 //recipe_ids
		 $sql_main_recipe="select a.batch_against,b.id from pro_recipe_entry_mst b,pro_batch_create_mst a where a.id=b.batch_id and b.entry_form=59 and b.status_active=1 and  b.id in($recipe_ids) ";
		 $sql_main_recipe_res= sql_select($sql_main_recipe);
		$main_recipe_id="";$re_dying_recipe_id="";
		foreach($sql_main_recipe_res as $row)
		{
			if($row[csf("batch_against")]==2)
			{
				$re_dying_recipe_id.=$row[csf("id")].',';
			}
			$main_recipe_id.=$row[csf("id")].',';
		}
		$re_dying_recipe_id=rtrim($re_dying_recipe_id,',');
		//echo $re_dying_recipe_id.'DD';
		$main_recipe_ids=rtrim($main_recipe_id,',');
		 $main_recipe_idsArr=array_unique(explode(",",$main_recipe_ids));
		$sql_batch=sql_select("select id,batch_against from pro_batch_create_mst where id in($all_dyeing_batch_id) and status_active=1");
		
		foreach($sql_batch as $row)
		{
			$batch_chk_arr[$row[csf("id")]]=$row[csf("batch_against")];
		}
		
	//$re_dying_batch_id=implode(",",$re_dying_batch_arr);
	//echo $re_dying_batch_id.',';
	
		//print_r($batch_chk_arr);
		
		
		
	  $sql_dtls = "select a.batch_id, a.requ_no, a.recipe_id, b.id,
		b.sub_process, b.item_category, b.dose_base, b.ratio, b.recipe_qnty, b.adjust_percent, b.adjust_type,b.sub_seq, b.required_qnty, b.req_qny_edit,
	  	c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id
	    from dyes_chem_issue_requ_mst a,  dyes_chem_issue_requ_dtls b, product_details_master c
	    where a.id=b.mst_id and b.product_id=c.id and b.item_category in (5,6,7,23) and b.req_qny_edit!=0 and b.status_active=1 and c.item_category_id in (5,6,7,23)  $batch_con order by b.sub_seq"; 
		
	$sql_result= sql_select($sql_dtls);
	
	$sub_process_array=array();
	$sub_process_tot_rec_array=array();
	$sub_process_tot_req_array=array();
	$sub_process_tot_value_array=array();
	
	foreach($sql_result as $row)
	{
		$sub_process_tot_rec_array[$row[csf("sub_process")]]+=$row[csf("recipe_qnty")];
		 //$recipe_min_id 
		 $recipe_id_idArr=array_unique(explode(",",$row[csf("recipe_id")]));
		// echo $batch_id.'='.$row[csf("batch_id")].'<br> ';
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id'].=$row[csf('recipe_id')].',';
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['batch_id']=$row[csf('batch_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['requ_no']=$row[csf('requ_no')];
		//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id']=$row[csf('recipe_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['id']=$row[csf('id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_process']=$row[csf('sub_process')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_category']=$row[csf('item_category')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['dose_base']=$row[csf('dose_base')];
		//if(in_array($batch_id,$batch_idArr))
		//{
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['ratio']=$row[csf('ratio')];
		//}
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_percent']=$row[csf('adjust_percent')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_type']=$row[csf('adjust_type')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_seq']=$row[csf('sub_seq')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['required_qnty']=$row[csf('required_qnty')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['req_qny_edit']=$row[csf('req_qny_edit')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_description']=$row[csf('item_description')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_group_id']=$row[csf('item_group_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_group_name']=$row[csf('sub_group_name')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_size']=$row[csf('item_size')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['unit_of_measure']=$row[csf('unit_of_measure')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['prod_id']=$row[csf('prod_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adding']='Issue Req';
		//$main_recipe_chk_arr[$row[csf("id")]];
		$ckh=1;
		foreach($main_recipe_idsArr as $rec_id)
		{
			$rec_id_chk=$rec_id;
			if($ckh==1)
			{
			if(in_array($rec_id_chk,$recipe_id_idArr))
			{
				//echo $row[csf('prod_id')].'='.$recipe_min_id.'='.$row[csf('recipe_qnty')].'<br>';
				$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['main_recipe_qnty']+=$row[csf('recipe_qnty')];
			}
			$chk++;
		  }
		}
		//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
	}
	 if ($re_dying_recipe_id!='') $re_batch_con=" and d.recipe_id in($re_dying_recipe_id)"; else $re_batch_con="";
	    $sql_dtls_re = "select a.batch_id, a.requ_no, a.recipe_id, b.id,
		b.sub_process, b.item_category, b.dose_base, b.ratio, b.recipe_qnty, b.adjust_percent, b.adjust_type,b.sub_seq, b.required_qnty, b.req_qny_edit,
	  	c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id
	    from dyes_chem_issue_requ_mst a,  dyes_chem_issue_requ_dtls b, product_details_master c,dyes_chem_requ_recipe_att d
	    where a.id=b.mst_id and b.product_id=c.id  and a.id=d.mst_id and b.item_category in (5,6,7,23) and b.req_qny_edit!=0 and b.status_active=1 and c.item_category_id in (5,6,7,23)  $re_batch_con order by b.sub_seq ,b.sub_process";
		$sql_result_re= sql_select($sql_dtls_re);
		 
	foreach($sql_result_re as $row)
	{
		$sub_process_tot_rec_array[$row[csf("sub_process")]]+=$row[csf("recipe_qnty")];
		 //$recipe_min_id 
		 $recipe_id_idArr=array_unique(explode(",",$row[csf("recipe_id")]));
		// echo $batch_id.'='.$row[csf("batch_id")].'<br> ';
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id'].=$row[csf('recipe_id')].',';
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['batch_id']=$row[csf('batch_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['requ_no']=$row[csf('requ_no')];
		//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id']=$row[csf('recipe_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['id']=$row[csf('id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_process']=$row[csf('sub_process')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_category']=$row[csf('item_category')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['dose_base']=$row[csf('dose_base')];
		//if(in_array($batch_id,$batch_idArr))
		//{
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['ratio']=$row[csf('ratio')];
		//}
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_percent']=$row[csf('adjust_percent')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_type']=$row[csf('adjust_type')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_seq']=$row[csf('sub_seq')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['required_qnty']=$row[csf('required_qnty')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['req_qny_edit']=$row[csf('req_qny_edit')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_description']=$row[csf('item_description')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_group_id']=$row[csf('item_group_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_group_name']=$row[csf('sub_group_name')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_size']=$row[csf('item_size')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['unit_of_measure']=$row[csf('unit_of_measure')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['prod_id']=$row[csf('prod_id')];
		$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adding']='Issue Req';
		//$main_recipe_chk_arr[$row[csf("id")]];
		
		
		
			
			
		$ckh=1;
		foreach($main_recipe_idsArr as $rec_id)
		{
			$rec_id_chk=$rec_id;
			if($ckh==1)
			{
			if(in_array($rec_id_chk,$recipe_id_idArr))
			{
				//echo $row[csf('prod_id')].'='.$recipe_min_id.'='.$row[csf('recipe_qnty')].'<br>';
				//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['main_recipe_qnty']+=$row[csf('req_qny_edit')];
				$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['topping_recipe_qnty']+=$row[csf('recipe_qnty')];
			}
			$chk++;
		  }
		}
		//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
	}
	
		 $sql_dtls_top= "select  a.batch_id as batch_id, null as requ_no,a.id as recipe_id,0 as id,b.sub_process_id as  sub_process,c.item_category_id as item_category,b.dose_base, b.ratio,b.adj_qnty as  recipe_qnty,b.adj_perc as adjust_percent,b.adj_type as adjust_type,b.sub_seq,0 as required_qnty, 0 as req_qny_edit,c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id,a.dyeing_re_process
	    from pro_recipe_entry_mst a,  pro_recipe_entry_dtls b,product_details_master c
	    where a.id=b.mst_id and  c.id=b.prod_id and  a.entry_form=60 and b.status_active=1 and a.batch_id in($all_dyeing_batch_id) and a.id in($recipe_ids)
		and b.adj_qnty>0 order by b.sub_seq,b.sub_process_id";
		 $sql_result_top= sql_select($sql_dtls_top);
		foreach($sql_result_top as $row)
		{
			$sub_process_tot_rec_array[$row[csf("sub_process")]]+=$row[csf("recipe_qnty")];
			 
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['batch_id']=$row[csf('batch_id')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id'].=$row[csf('recipe_id')].',';
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['requ_no']=$row[csf('requ_no')];
			//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['recipe_id']=$row[csf('recipe_id')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['id']=$row[csf('id')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_process']=$row[csf('sub_process')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_category']=$row[csf('item_category')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['dose_base']=$row[csf('dose_base')];
			//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['ratio']=$row[csf('ratio')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_percent']=$row[csf('adjust_percent')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adjust_type']=$row[csf('adjust_type')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_seq']=$row[csf('sub_seq')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['required_qnty']=$row[csf('required_qnty')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['req_qny_edit']=$row[csf('req_qny_edit')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_description']=$row[csf('item_description')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_group_id']=$row[csf('item_group_id')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['sub_group_name']=$row[csf('sub_group_name')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['item_size']=$row[csf('item_size')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['unit_of_measure']=$row[csf('unit_of_measure')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['prod_id']=$row[csf('prod_id')];
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['dyeing_re_process']=$row[csf('dyeing_re_process')];
			$batch_againstId=$batch_chk_arr[$row[csf("batch_id")]];
			//if($batch_againstId==2)   echo $row[csf('batch_id')].'='.$batch_againstId.'<br>';|| $batch_againstId==2
			if($row[csf('dyeing_re_process')]==1) //Topping
			{	
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['topping_recipe_qnty']+=$row[csf('recipe_qnty')];
			}
			if($row[csf('dyeing_re_process')]==2 ) //Adding
			{	
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adding_recipe_qnty']+=$row[csf('recipe_qnty')];
			}
			$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]]['adding']='Adding Topping';
			//$req_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['avg_rate_per_unit']=$row[csf('avg_rate_per_unit')];
		}
		
	?>
                
	<?
	//var_dump($sub_process_tot_req_array);
	$i=1; $k=1; $recipe_qnty_sum=0; $req_qny_edit_sum=0; $recipe_qnty=0; $req_qny_edit=0; $req_value_sum=0;
	$req_value_grand=0; $recipe_qnty_grand=0; $req_qny_edit_grand=0;
	$total_adding_recipe_qnty=$total_topping_recipe_qnty=0;
	foreach($req_data_arr as $sub_process=>$sub_data)
	{
	foreach($sub_data as $prod_id=>$prod_data)
	{
		foreach($prod_data as $item_id=>$row)
		{
		 
		
		if ($i%2==0)  
			$bgcolor="#E9F3FF";
		else
			$bgcolor="#FFFFFF";
			if (!in_array($sub_process,$sub_process_array) )
			{
				$sub_process_array[]=$sub_process;
				if($k!=1)
				{
					?>
                    <tr>
                        <td colspan="7" align="right"><strong>Total :</strong></td>
                        <td align="right"><strong><?php  echo number_format($recipe_qnty_sum,6,'.',''); ?></strong></td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                		 
                         
                        
                        
                        <td align="right"><strong><?php  echo number_format($adding_recipe_qnty_sum,6,'.',''); ?></strong></td> 
                        <td align="right"><strong><?php  echo number_format($topping_recipe_qnty_sum,6,'.',''); ?></strong></td>
                        
                        <td align="right"><strong><?php  echo number_format($req_qny_issue_sum,6,'.',''); ?></strong></td>
                        
                        <td>&nbsp;</td>
                	
                        <td align="right"><strong><?php  echo number_format($amount_req_value_sum,6,'.',''); ?></strong></td>
                    </tr> 
			 <? 
			} 
			$recipe_qnty_sum=0;$adding_recipe_qnty_sum=0;$topping_recipe_qnty_sum=0;
			$req_qny_issue_sum=0;
			$amount_req_value_sum=0;
			$k++; 
			?>
            <tr bgcolor="#CCCCCC">
                <th colspan="16"><strong><? echo $dyeing_sub_process[$sub_process]; ?></strong></th>
            </tr> 
            
        <? 
		}
		
		$recipe_id=rtrim($row[('recipe_id')],',');
		$recipe_ids=array_unique(explode(",",$recipe_id));
		$recipe_idsArr=implode(",",array_unique(explode(",",$recipe_id)));
		$issue_qty=$cons_amount=0;
		foreach($recipe_ids as $rid)
		{
		$issue_qty+=$issue_data_arr[$sub_process][$prod_id][$item_id][$rid]['issue_qty'];
		$cons_amount+=$issue_data_arr[$sub_process][$prod_id][$item_id][$rid]['cons_amount'];
		$issue_cons_rate=$issue_data_arr[$sub_process][$prod_id][$item_id][$rid]['cons_rate'];
		}
		//echo $row[csf('recipe_id')].',mmmm';
		$recipe_idArr=array_unique(explode(",",$recipe_id));
		$adding_recipe_qnty=$topping_recipe_qnty=0;
		foreach($recipe_idArr as $rid)
		{
		//$adding_recipe_qnty+=$topping_adding_array[$rid][$row[csf('item_group_id')]][$row[csf("prod_id")]][$row[csf("sub_process")]]['adding_recipe_qnty'];
		//$topping_recipe_qnty+=$topping_adding_array[$rid][$row[csf('item_group_id')]][$row[csf("prod_id")]][$row[csf("sub_process")]]['topping_recipe_qnty'];
		}
		 
		$adding_recipe_qnty=$row[('adding_recipe_qnty')];
		$topping_recipe_qnty=$row[('topping_recipe_qnty')];
		
		$total_adding_recipe_qnty+=$row[('adding_recipe_qnty')];
		$total_topping_recipe_qnty+=$row[('topping_recipe_qnty')];
		//$adding_recipe_qnty=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['adding_recipe_qnty'];
		//$topping_recipe_qnty=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['topping_recipe_qnty'];
		
	//	$adding_ratio=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['adding_ratio'];
	//	$topping_ratio=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['topping_ratio'];
	//$row[("recipe_id")]=$row[("recipe_id")];
		?>
        <tbody>
			<tr bgcolor="<? echo $bgcolor; ?>">
                <td align="center"><? echo $i; ?></td>
                <td><? echo $item_category[$row[("item_category")]];  //echo $row[csf("sub_process")]; ?></td>
                <td title="<? echo $row[("adding")];?>"><? echo $group_arr[$row[("item_group_id")]] ?></td>
                <td><? echo $row[("sub_group_name")]; ?></td>
              
                <td><? echo $row[("item_description")].' '.$row[("item_size")]; ?></td>
                
                <td align="center"><? echo $unit_of_measurement[$row[("unit_of_measure")]]; ?></td>
                <td><? echo $dose_base[$row[("dose_base")]]; ?></td>
                <!--<td align="center"><? //echo number_format($row[("ratio")],6,'.',''); ?></td>-->
                <td align="right" title="<? echo $recipe_idsArr;?>"> <? echo number_format($row[("main_recipe_qnty")],6,'.',''); ?></td>
                <td align="center"><? echo $row[("adjust_percent")]; ?></td>
                <td><? echo $increase_decrease[$row[("adjust_type")]]; ?></td>
                
                 <td align="right"><? echo number_format($adding_recipe_qnty,6); ?></td>
                
                 <td align="right"><? echo number_format($topping_recipe_qnty,6); ?></td>
                    
              
                <td align="right" title="Issue_qty=<? echo $issue_qty;?>"><? 
				$tot_issue_qty=$issue_qty+$adding_recipe_qnty+$topping_recipe_qnty;
				echo number_format($issue_qty,6,'.',''); ?></td>
                
                <td align="right"><? echo  number_format($cons_amount/$issue_qty,6,'.',''); ?></td>
                <td align="right"><? $amount_req_value=$cons_amount;//$issue_qty*$issue_cons_rate; 
				echo number_format($amount_req_value,6,'.',''); ?></td>
			</tr>
        </tbody>
		<? $i++;
        $recipe_qnty_sum +=$row[('main_recipe_qnty')];
        $req_qny_issue_sum +=$issue_qty; 
		
		$adding_recipe_qnty_sum +=$adding_recipe_qnty; 
		$topping_recipe_qnty_sum +=$topping_recipe_qnty;
		
		$amount_req_value_sum +=$amount_req_value;
		
		$recipe_qnty_grand +=$row[('main_recipe_qnty')];
        $req_qny_issue_grand +=$issue_qty;
		$amount_req_value_grand +=$amount_req_value;
         
		}
		
	  }
	} //End
		foreach ($sub_process_tot_rec_array as $val_rec)
		{
			 $totval_rec=$val_rec;
		}
		/*foreach ($sub_process_tot_req_array as $val_req)
		{
			 $totval_req=$val_req;
		}
		foreach ($sub_process_tot_value_array as $req_value)
		{
			 $tot_req_value=$req_value;
		}*/
		
		//$recipe_qnty_grand +=$val_rec;
        //$req_qny_edit_grand +=$val_req;
		//$req_value_grand +=$req_value;
		?>
           <tr>
                <td colspan="7" align="right"><strong>Total :</strong></td>
                <td align="right"><strong><?php echo number_format($totval_rec,6,'.',''); ?></strong></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                
                 <td align="right"><strong><?php  echo number_format($adding_recipe_qnty_sum,6,'.',''); ?></strong></td> 
                 <td align="right"><strong><?php  echo number_format($topping_recipe_qnty_sum,6,'.',''); ?></strong></td>
                
                
                
                <td align="right"><strong><?php echo number_format($req_qny_issue_sum,6,'.',''); ?></strong></td>
               
                <td>&nbsp;</td>
                <td align="right"><strong><?php echo number_format($amount_req_value_sum,6,'.',''); ?></strong></td>
            </tr> 
             <tr>
                <td colspan="7" align="right"><strong> Grand Total :</strong></td>
                <td align="right"><strong><?php echo number_format($recipe_qnty_grand,6,'.',''); ?></strong></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                 <td  align="right"><strong><?php echo number_format($total_adding_recipe_qnty,6,'.',''); ?></strong></td>
                <td  align="right"><strong><?php echo number_format($total_topping_recipe_qnty,6,'.',''); ?></strong></td>
                
               
                <td align="right"><strong><?php echo number_format($req_qny_issue_grand,6,'.',''); ?></strong></td>
                <td>&nbsp;</td>
                
                <td align="right"><strong><?php echo number_format($amount_req_value_grand,6,'.',''); ?></strong></td>
            </tr> 
               <tr>
                <td colspan="13" align="right"><strong> Cost Per Kg :</strong></td>
                <td colspan="2" align="right"><strong><?php echo number_format($amount_req_value_grand/($batch_weight+$batchdata_array[0][csf('batch_weight')]),6,'.',''); ?></strong></td>
            </tr>                          
      </table>
        <br>
      	<?  	
	 
	 
    $html=ob_get_contents();
			ob_flush();
			
			foreach (glob(""."*.xls") as $filename) 
			{
			   @unlink($filename);
			}
			
			//html to xls convert
			$name=time();
			$name=$user_id."_".$name.".xls";
			$create_new_excel = fopen(''.$name, 'w');	
			$is_created = fwrite($create_new_excel,$html);
	
	?>
      <input type="hidden" id="txt_excl_link" value="<? echo 'requires/'.$name; ?>" />
    <script>
	$(document).ready(function(e) {
				document.getElementById('report_container').innerHTML='<a href="<? echo $name?>" style="text-decoration:none"><input type="button" value="Excel Download" name="excel" id="excel" class="formbutton" style="width:90px;font-size:11px"/></a>&nbsp;&nbsp;';
		});	
	</script>
      </div> 
    <?
	exit();
}
if($action=="subprocess_fabrics_dtls_popup")
{
	echo load_html_head_contents("Subprocess Details", "../../../../", 1, 1,$unicode,'','');
	extract($_REQUEST);
	//echo $batch_id;
	//if($batch_id!='') $batch_con=" and LIKE a.batch_id";
	$color_arr=return_library_array( "select id, color_name from lib_color", "id", "color_name");
	$re_dyeing_batch_id=return_field_value("id","pro_batch_create_mst","batch_no='".$batch_no."' and batch_against=2 and extention_no!=0");
	$entry_form_arr = return_library_array("select id, entry_form from pro_batch_create_mst", "id", "entry_form");
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", 'id', 'yarn_count');

	if ($batch_id!='') $batch_con=" and a.batch_id like '%$batch_id%'"; else $batch_con="and a.batch_id='0'";
	if ($batch_id!='') $issue_batch_con=" and d.batch_id like '%$batch_id%'"; else $issue_batch_con="and d.batch_id='0'";

	if ($re_dyeing_batch_id!='') { 
	$redyeing_batch_id=" and d.batch_id in($re_dyeing_batch_id)";
	$redyeing_batch_id2=" and batch_id in($re_dyeing_batch_id)";
	$redyeing_batch_id3="  batch_id in($re_dyeing_batch_id)";
	}
 else { 
 $redyeing_batch_id="and d.batch_id in(0)";
 $redyeing_batch_id2="and batch_id in(0)";
 $redyeing_batch_id3="  batch_id in(0)";
 }

  
	$batch_weight=0;
	if($db_type==0) 
	{
		$data_array=sql_select("select group_concat(buyer_id) as buyer_id,group_concat(id) as recipe_id, group_concat(batch_id) as batch_id, sum(total_liquor) as total_liquor, group_concat(concat_ws(':',batch_ratio,liquor_ratio) order by id) as ratio, sum(case when entry_form=60 then new_batch_weight end) as batch_weight, group_concat(case when entry_form<>60 then batch_id end) as batch_id_rec_main from pro_recipe_entry_mst where batch_id in($batch_id)");
		
	}
	else
	{
		$data_array=sql_select("select listagg(buyer_id,',') within group (order by buyer_id) as buyer_id,listagg(id,',') within group (order by id) as recipe_id, listagg(batch_id,',') within group (order by batch_id) as batch_id, sum(total_liquor) as total_liquor, listagg(batch_ratio || ':' || liquor_ratio,',') within group (order by id) as ratio, sum(case when entry_form=60 then new_batch_weight end) as batch_weight, listagg(case when entry_form<>60 then batch_id end,',') within group (order by batch_id) as batch_id_rec_main from pro_recipe_entry_mst where  batch_id in($batch_id)");
		
	}
	//$batch_weight=$data_array[0][csf("batch_weight")];

	$batch_id=implode(",",array_unique(explode(",",$data_array[0][csf("batch_id")])));
	
	$batch_id_rec_main=implode(",",array_unique(explode(",",$data_array[0][csf("batch_id_rec_main")])));
	if($batch_id_rec_main=="") $batch_id_rec_main=0;

	if($db_type==0) 
	{
		if(!$batch_id) $batch_id=0;
		//echo "select group_concat(batch_no) as batch_no, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight, group_concat(distinct color_id) as color_id,group_concat(distinct color_range_id) as color_range_id from pro_batch_create_mst where id in($batch_id)";die;

		$batchdata_array=sql_select("select group_concat(batch_no) as batch_no,group_concat(double_dyeing) as double_dyeing, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight, group_concat(distinct color_id) as color_id,group_concat(distinct color_range_id) as color_range_id from pro_batch_create_mst where id in($batch_id)");
	}
	else //color_range_id
	{
		$batchdata_array=sql_select("select listagg(CAST(batch_no AS VARCHAR2(4000)),',') within group (order by id) as batch_no, listagg(double_dyeing ,',') within group (order by id) as double_dyeing, listagg(color_id ,',') within group (order by id) as color_id,listagg(color_range_id ,',') within group (order by id) as color_range_id, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight from pro_batch_create_mst where id in($batch_id)");
		//echo "select listagg(CAST(batch_no AS VARCHAR2(4000)),',') within group (order by id) as batch_no, listagg(double_dyeing ,',') within group (order by id) as double_dyeing, listagg(color_id ,',') within group (order by id) as color_id,listagg(color_range_id ,',') within group (order by id) as color_range_id, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight from pro_batch_create_mst where id in($batch_id)";	
	}
	
	 $sql="select a.id, a.requ_no, a.location_id, a.requisition_date,a.method, a.requisition_basis, a.batch_id, a.recipe_id, a.machine_id from dyes_chem_issue_requ_mst a where status_active=1 $batch_con";

	$dataArray=sql_select($sql);
	 $recipe_id=$dataArray[0][csf('recipe_id')];
	  $requ_nos=$dataArray[0][csf('requ_no')];
	$po_no=''; $job_no='';$file_no='';$ref_no=''; $buyer_name='';
		if($batch_type==2)
		{
			$po_data=sql_select("select distinct b.order_no, c.subcon_job, c.party_id from pro_batch_create_dtls a, subcon_ord_dtls b, subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0 and a.mst_id in(".$batch_id.") ");
			foreach($po_data as $row)
			{
				$po_no.=$row[csf('order_no')].","; 
				$job_no.=$row[csf('subcon_job')].",";
				$buyer_name.=$buyer_library[$row[csf('party_id')]].",";
			}
		}
		else
		{
			$po_data=sql_select("select distinct b.po_number,b.file_no,b.grouping as ref, c.job_no, c.buyer_name from pro_batch_create_dtls a, wo_po_break_down b, wo_po_details_master c where a.po_id=b.id and b.job_no_mst=c.job_no and a.status_active=1 and a.is_deleted=0 and a.mst_id in(".$batch_id.") ");
			foreach($po_data as $row)
			{
				$po_no.=$row[csf('po_number')].","; 
				$job_no.=$row[csf('job_no')].",";
				$file_no.=$row[csf('file_no')].","; 
				$ref_no.=$row[csf('ref')].","; 
				//$buyer_name.=$buyer_library[$row[csf('buyer_name')]].",";
			}
			foreach(explode(",",$data_array[0][csf("buyer_id")]) as $buyer_id)
			{
				$buyer_name.=$buyer_library[$buyer_id].",";
			}
				
		}
		$color_id=array_unique(explode(",",$batchdata_array[0][csf('color_id')]));
		$color_name='';
		foreach($color_id as $color)
		{
		$color_name.=$color_arr[$color].",";
		}
		$color_range_id=array_unique(explode(",",$batchdata_array[0][csf('color_range_id')]));
		$color_ranges='';
		foreach($color_range_id as $rang_id)
		{
		$color_ranges.=$color_range[$rang_id].",";
		}
		
		$color_range=substr($color_ranges,0,-1);
		//echo $batchdata_array[0][csf('double_dyeing')].', ';
		$double_dyeing=array_unique(explode(",",$batchdata_array[0][csf('double_dyeing')]));
		$double_dyeing_name='';
		foreach($double_dyeing as $dd_id)
		{
		$double_dyeing_name.=$yes_no[$dd_id].",";
		}
		
		$double_dyeingArr=substr($double_dyeing_name,0,-1);
		
	
	  /*$sql_isue_dtls = "select d.recipe_id,a.batch_no,
	 avg(b.cons_rate) as cons_rate, sum(b.cons_quantity) as cons_quantity,sum(b.cons_amount) as cons_amount, d.product_id as prod_id,
	   c.item_group_id, d.sub_process
	  from inv_issue_master a, inv_transaction b, product_details_master c, dyes_chem_issue_dtls d
	  where a.id=b.mst_id and b.id =d.trans_id and d.product_id=c.id and b.prod_id=c.id and b.transaction_type=2 and a.entry_form=5 and b.item_category in (5,6,7) $issue_batch_con  group by d.recipe_id,a.batch_no,d.product_id, c.item_group_id, d.sub_process order by d.sub_process "; */
	    $sql_isue_dtls = "select d.recipe_id,a.batch_no,b.requisition_no as req_no,
	 (b.cons_rate) as cons_rate, (b.cons_quantity) as cons_quantity,(b.cons_amount) as cons_amount, d.product_id as prod_id,
	   c.item_group_id, d.sub_process
	  from inv_issue_master a, inv_transaction b, product_details_master c, dyes_chem_issue_dtls d
	  where a.id=b.mst_id and b.id =d.trans_id and d.product_id=c.id and b.prod_id=c.id and b.transaction_type=2 and a.entry_form=5 and b.item_category in (5,6,7) $issue_batch_con  order by d.sub_process "; 
	 // echo $sql_dtls; 
	  $sql_result_issue= sql_select($sql_isue_dtls);
	  $issue_data_arr=array();
	  foreach($sql_result_issue as $row) //issue_data_topping_arr
	  {
		  $issue_data_arr[$row[csf('req_no')]][$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['issue_qty']+=$row[csf('cons_quantity')]; 
		  $issue_data_arr[$row[csf('req_no')]][$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_amount']+=$row[csf('cons_amount')]; 
		  $issue_data_arr[$row[csf('req_no')]][$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_rate']=$row[csf('cons_amount')]/$row[csf('cons_quantity')]; 
		  
		   $issue_data_topping_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['issue_qty']+=$row[csf('cons_quantity')]; 
		  $issue_data_topping_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_amount']+=$row[csf('cons_amount')]; 
		  $issue_data_topping_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_rate']=$row[csf('cons_amount')]/$row[csf('cons_quantity')]; 
	  }
	  ob_start();
	?>
    <script>
		function print_window()
		{
			var w = window.open("Surprise", "#");
			var d = w.document.open();
			d.write ('<!DOCTYPE HTML PUBLIC "-//W3C//DTsD HTML 4.01//EN""http://www.w3.org/TR/html4/strict.dtd">'+
			'<html><head><link rel="stylesheet" href="../../../../css/style_common.css" type="text/css" media="print"/><title></title></head><body>'+document.getElementById('report_div').innerHTML+'</body</html>');
			d.close();
		}	
		
		
		  
	</script>	
      <div> 
	<div style="width:870px; margin-left:30px" id="report_div">
     <div style="width:870px;" align="center">
    		 
        	<input  type="button" value="Print Preview" onClick="print_window()" style="width:90px"  class="formbutton"/> &nbsp;
             <div id="report_container"> </div>
        </div>
        <?
         ob_start();
		?>
     <table width="870" cellspacing="0" align="center"  >
        <tr>
        	<td width="100"><strong>Issue Date:</strong></td><td width="160px"><? echo change_date_format($dataArray[0][csf('requisition_date')]); ?></td>
            <td width="90"><strong>Issue Basis</strong></td> <td><? echo $receive_basis_arr[$dataArray[0][csf('requisition_basis')]]; ?></td>
            
            <td width="90"><strong></strong></td><td width="160px"><? //echo implode(",",array_unique(explode(",",$buyer_name))); ?></td>
       </tr>
        <tr>
            <td><strong>Buyer Order:</strong></td> <td><? echo $po_no; ?></td>
           <td><strong>Batch No</strong></td><td><? echo $batchdata_array[0][csf('batch_no')]; ?></td>
           <td><strong>Batch Weight</strong></td><td><? echo $batch_weight+$batchdata_array[0][csf('batch_weight')]; ?></td>
        </tr>
        <tr>
            <td><strong>File No</strong></td><td><? echo $file_no; ?></td>
            <td><strong>Ref. No:</strong></td><td><? echo $ref_no; ?></td>
            <td><strong>Batch Color:</strong></td><td><? echo $color_name; ?></td>
        </tr>
        <tr>
            <td><strong>Color Range/Group</strong></td><td><? echo $color_range; ?></td>
            <td><strong>Multi Dyeing</strong></td><td><? echo $double_dyeingArr; ?></td>
            <td><strong>Recipe no</strong></td><td><? echo $recipe_id; ?></td>
        </tr> 
        <tr>
            <td><strong>Req. No</strong></td><td><? echo $requ_nos; ?></td>
           
        </tr>
       
    </table>
     <br>
    <?
	$sql_yarn_dtls = "select  e.knitting_company,e.knitting_source,c.po_breakdown_id as po_id,d.yarn_lot as yarn_lot,d.yarn_count as yarn_count,d.brand_id as brand_id,d.prod_id
	from pro_batch_create_mst a,pro_batch_create_dtls b, pro_roll_details c, pro_grey_prod_entry_dtls d,  inv_receive_master e 
	where a.id=b.mst_id and b.roll_id=c.id and c.dtls_id=d.id and d.mst_id=e.id  
 	and a.id in($batch_id) and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and e.entry_form in(2,22) group by  c.po_breakdown_id,d.yarn_lot,d.yarn_count,d.brand_id,d.prod_id,e.knitting_company,e.knitting_source";
	//echo $sql_yarn_dtls;
	$yarn_dtls_array = array();
	$result_sql_yarn_dtls = sql_select($sql_yarn_dtls);
	foreach ($result_sql_yarn_dtls as $row) {
		$yarn_count = array_unique(explode(",", $row[csf('yarn_count')]));
		$count_name = "";$prod_ids = "";
		foreach ($yarn_count as $val) {
			if ($count_name == "") $count_name = $count_arr[$val]; else $count_name .= ", " . $count_arr[$val];
		}
			//echo $yarn_lot.'DD';
			$yarn_dtls_array[$row[csf('prod_id')]]['yarn_lot'] .=$row[csf('yarn_lot')].',';
			$yarn_dtls_array[$row[csf('prod_id')]]['brand_name'] .= $brand_arr[$row[csf('brand_id')]].',';
			$yarn_dtls_array[$row[csf('prod_id')]]['count_name'] .= $count_name.',';
			if($row[csf('knitting_source')]==3)
			{
				$yarn_dtls_array[$row[csf('prod_id')]]['knitting_company']=$row[csf('knitting_company')];
			} 
			if($prod_ids=="") $prod_ids=$row[csf('prod_id')];else $prod_ids.=",".$row[csf('prod_id')];
	}
	
	//array_unique(explode(",",$data_array[0][csf("batch_id")]))
    $batch_id_qry = explode(",", $dataArray[0][csf('batch_id')]);
    $j = 1;
    $entryForm = $entry_form_arr[$batch_id_qry[0]];
    ?>
    <table width="1000" cellspacing="0" align="center" class="rpt_table" border="1" rules="all">
    	<thead bgcolor="#dddddd" align="center">
    		<?
				//echo $entryForm.'A';
    		if ($entryForm == 0) {
    			?>
    			<tr bgcolor="#CCCCFF">
    				<th colspan="8" align="center"><strong>Fabrication</strong></th>
    			</tr>
    			<tr>
    				<th width="30">SL</th>
    				<th width="100">Dia/ W. Type</th>
    				<th width="100">Yarn Lot</th>
    				<th width="100">Supplier</th>
    				<th width="100">Count</th>
    				<th width="300">Constrution & Composition</th>
    				<th width="70">Gsm</th>
    				<th width="70">Dia</th>
    			</tr>
    			<?
    		} else {
    			?>
    			<tr bgcolor="#CCCCFF">
    				<th colspan="4" align="center"><strong>Fabrication</strong></th>
    			</tr>
    			<tr>
    				<th width="50">SL</th>
    				<th width="350">Gmts. Item</th>
    				<th width="110">Gmts. Qty</th>
    				<th>Batch Qty.</th>
    			</tr>
    			<?
    		}
    		?>
    	</thead>
    	<tbody>
    		<?
    		foreach ($batch_id_qry as $b_id) {
    			$batch_query = "Select  po_id, prod_id, item_description, width_dia_type, count(roll_no) as gmts_qty, sum(batch_qnty) batch_qnty from pro_batch_create_dtls where mst_id in($b_id) and status_active=1 and is_deleted=0 group by po_id, prod_id, item_description, width_dia_type";
    			$result_batch_query = sql_select($batch_query);
    			foreach ($result_batch_query as $rows) {
    				if ($j % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
    				$fabrication_full = $rows[csf("item_description")];
					$yarn_lot=$yarn_dtls_array[$rows[csf('prod_id')]]['yarn_lot'];
					$brand_name=$yarn_dtls_array[$rows[csf('prod_id')]]['brand_name'];
					$count_name=$yarn_dtls_array[$rows[csf('prod_id')]]['count_name'];
					$yarn_lots = implode(", ", array_unique(explode(",", substr($yarn_lot, 0, -1))));
					$brand_names = implode(", ", array_unique(explode(",", substr($brand_name, 0, -1))));
					$count_names = implode(", ", array_unique(explode(",", substr($count_name, 0, -1))));
			
			
    				$fabrication = explode(',', $fabrication_full);
					//echo $entry_form_arr[$b_id].'B';
    				if ($entry_form_arr[$b_id] == 0) {
    					?>
    					<tr bgcolor="<? echo $bgcolor; ?>">
    						<td align="center"><? echo $j; ?></td>
    						<td align="center"><? echo $fabric_typee[$rows[csf("width_dia_type")]]; ?></td>
                            <td align="center"><? echo $yarn_lots;
                            	?></td>
                            <td align="center"><? echo $supplier_library[$knitting_company];
                            	?></td>
                            <td align="center"><? echo $count_names;
                            	?></td>
                            	<td align="left"><? echo $fabrication[0] ?></td>
                            	<td align="center"><? echo $fabrication[2]; ?></td>
                            	<td align="center"><? echo $fabrication[3]; ?></td>
                            </tr>
                            <?
                        } else if ($entry_form_arr[$b_id] == 74 || $entry_form_arr[$b_id] == 36) {
                        	?>
                        	<tr bgcolor="<? echo $bgcolor; ?>">
                        		<td align="center"><? echo $j; ?></td>
                        		<td align="left"><? echo $garments_item[$rows[csf('prod_id')]]; ?></td>
                        		<td align="right"><? echo $rows[csf('gmts_qty')]; ?></td>
                        		<td align="right"><? echo number_format($rows[csf('batch_qnty')], 2); ?></td>
                        	</tr>
                        	<?
                        } else {
                        	?>
                        	<tr bgcolor="<? echo $bgcolor; ?>">
                        		<td align="center"><? echo $j; ?></td>
                        		<td align="center"><? echo $fabric_typee[$rows[csf("width_dia_type")]]; ?></td>
                        		<td width="100" align="left"><p style="word-wrap:break-word;"><? echo $yarn_lots; ?></td>
                        		<td align="left"><? echo $supplier_library[$supliID_arr[$rows[csf('prod_id')]]['supplier_id']];//$yarn_dtls_array[$rows[csf('po_id')]][$rows[csf('prod_id')]]['brand_name']; ?></td>
                        		<td align="left"><? echo $count_names; ?></td>
                        		<td align="left"><? echo $fabrication[0] . ", " . $fabrication[1]; ?></td>
                        		<td align="center"><? echo $fabrication[2]; ?></td>
                        		<td align="center"><? echo $fabrication[3]; ?></td>
                        	</tr>
                        	<?
                        }
                        $j++;
                    }
                }
                ?>
            </tbody>
        </table>
        
    <table align="center" cellspacing="0" width="1110" border="1" rules="all" class="rpt_table" >
        <thead bgcolor="#dddddd" align="center">
    	   <tr bgcolor="#EFEFEF">   
                <th width="30">SL</th>
                <th width="80" >Item Cat.</th>
                <th width="100" >Item Group</th>
                <th width="100" >Sub Group</th>
                <th width="150">Item Description</th>
              
                <th width="50" >UOM</th>
                <th width="100" >Dose Base</th> 
                <th width="40" >Ratio</th>
                <th width="60" >Recipe Qty.</th>
                <th width="50" >Adj%</th>
                <th width="60" >Adj Type</th> 
                 
                
                    
               
                <th width="80" >Iss. Qty.</th>
              
                <th width="70" >Unit Price</th>
                <th width="" >Amount(BDT)</th>
                </tr>
		</thead>
	<?  
 	$group_arr=return_library_array( "select id,item_name from lib_item_group where item_category in (5,6,7) and status_active=1 and is_deleted=0",'id','item_name');
	
 
  
		
		$sql_dtls_adding = "select  a.dyeing_re_process,a.batch_id, a.id as recipe_id, b.sub_seq,
		b.sub_process_id,b.dose_base, b.ratio, b.adj_qnty as recipe_qnty,
	  	b.prod_id
	    from pro_recipe_entry_mst a,  pro_recipe_entry_dtls b
	    where a.id=b.mst_id and  a.entry_form=60 and b.status_active=1 and a.batch_id in($batch_id) and a.id in($recipe_id) order by b.sub_process_id, b.sub_seq asc";
		$sql_result_adding= sql_select($sql_dtls_adding);
			foreach($sql_result_adding as $row)
			{
				if($row[csf("dyeing_re_process")]==2) //Adding
				{
				$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process_id")]]['adding_recipe_qnty']=$row[csf("adding_recipe_qnty")];
				$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process_id")]]['adding_ratio']=$row[csf("ratio")];
				}
				if($row[csf("batch_id")]==1) //Topping
				{
				$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process_id")]]['topping_recipe_qnty']=$row[csf("recipe_qnty")];
				$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process_id")]]['topping_ratio']=$row[csf("ratio")];
				}
				//$sub_process_tot_req_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")];
				//$sub_process_tot_value_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")]*$row[csf("avg_rate_per_unit")];
			}
	
	 // echo $sql_dtls;//die;
	 $sql_dtls = "select a.id as req_id,a.requ_no, a.batch_id, a.recipe_id, b.id,
		b.sub_process, b.item_category, b.dose_base, b.ratio, b.recipe_qnty, b.adjust_percent, b.adjust_type,b.sub_seq, b.required_qnty, b.req_qny_edit,
	  	c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id
	    from dyes_chem_issue_requ_mst a,  dyes_chem_issue_requ_dtls b, product_details_master c
	    where a.id=b.mst_id and b.product_id=c.id and b.item_category in (5,6,7) and b.req_qny_edit!=0 and b.status_active=1 and c.item_category_id in (5,6,7)  $batch_con order by  b.sub_seq asc"; 
	$sql_result= sql_select($sql_dtls);
	
	$sub_process_array=array();
	$sub_process_tot_rec_array=array();
	$sub_process_tot_req_array=array();
	$sub_process_tot_value_array=array();
	
	foreach($sql_result as $row)
	{
		$sub_process_tot_rec_array[$row[csf("sub_process")]]+=$row[csf("recipe_qnty")];
		//$sub_process_tot_req_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")];
		//$sub_process_tot_value_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")]*$row[csf("avg_rate_per_unit")];
	}
	?>
                
	<?
	//var_dump($sub_process_tot_req_array);
	$i=1; $k=1; $recipe_qnty_sum=0; $req_qny_edit_sum=0; $recipe_qnty=0; $req_qny_edit=0; $req_value_sum=0;
	$req_value_grand=0; $recipe_qnty_grand=0; $req_qny_edit_grand=0;
	
	foreach($sql_result as $row)
	{
		if ($i%2==0)  
			$bgcolor="#E9F3FF";
		else
			$bgcolor="#FFFFFF";
			if (!in_array($row[csf("sub_process")],$sub_process_array) )
			{
				$sub_process_array[]=$row[csf('sub_process')];
				if($k!=1)
				{
					?>
                    <tr>
                        <td colspan="8" align="right"><strong>Total :</strong></td>
                        <td align="right"><?php  echo number_format($recipe_qnty_sum,6,'.',''); ?></td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                		
                        
                        <td align="right"><?php  echo number_format($req_qny_issue_sum,6,'.',''); ?></td>
                        
                        <td>&nbsp;</td>
                	
                        <td align="right"><?php  echo number_format($amount_req_value_sum,6,'.',''); ?></td>
                    </tr> 
			 <? 
			} 
			$recipe_qnty_sum=0;
			$req_qny_issue_sum=0;
			$amount_req_value_sum=0;
			$k++; 
			?>
            <tr bgcolor="#CCCCCC">
                <th colspan="16"><strong><? echo $dyeing_sub_process[$row[csf("sub_process")]]; ?></strong></th>
            </tr> 
            
        <? 
		}
		
		
		$issue_qty=$issue_data_arr[$row[csf("req_id")]][$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['issue_qty'];
		$cons_amount=$issue_data_arr[$row[csf("req_id")]][$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_amount'];
		$issue_cons_rate=$issue_data_arr[$row[csf("req_id")]][$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_rate'];
		
		$tt_msg=$row[csf("sub_process")].',ProdId-'.$row[csf("prod_id")].',ItemId-'.$row[csf("item_group_id")].',RecipeId-'.$row[csf("recipe_id")].',ReqNo-'.$row[csf("requ_no")];
		
		//$adding_recipe_qnty=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['adding_recipe_qnty'];
		//$topping_recipe_qnty=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['topping_recipe_qnty'];
		
		//$adding_ratio=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['adding_ratio'];
		//$topping_ratio=$topping_adding_array[$row[csf("prod_id")]][$row[csf("sub_process")]]['topping_ratio'];
		?>
        <tbody>
			<tr bgcolor="<? echo $bgcolor; ?>">
                <td align="center"><? echo $i; ?></td>
                <td><? echo $item_category[$row[csf("item_category")]];  //echo $row[csf("sub_process")]; ?></td>
                <td><? echo $group_arr[$row[csf("item_group_id")]]; ?></td>
                <td><? echo $row[csf("sub_group_name")]; ?></td>
              
                <td><? echo $row[csf("item_description")].' '.$row[csf("item_size")]; ?></td>
                
                <td align="center"><? echo $unit_of_measurement[$row[csf("unit_of_measure")]]; ?></td>
                <td><? echo $dose_base[$row[csf("dose_base")]]; ?></td>
                <td align="center"><? echo number_format($row[csf("ratio")],6,'.',''); ?></td>
                <td align="right"><? echo number_format($row[csf("recipe_qnty")],6,'.',''); ?></td>
                <td align="center"><? echo $row[csf("adjust_percent")]; ?></td>
                <td><? echo $increase_decrease[$row[csf("adjust_type")]]; ?></td>
                
                
                    
              
                <td align="right" title="<?=$tt_msg;?>"><? echo number_format($issue_qty,6,'.',''); ?></td>
                
                <td align="right"><? echo  number_format($cons_amount/$issue_qty,6,'.',''); ?></td>
                <td align="right"><? $amount_req_value=$cons_amount;//$issue_qty*$issue_cons_rate; 
				echo number_format($amount_req_value,6,'.',''); ?></td>
			</tr>
        </tbody>
		<? $i++;
        $recipe_qnty_sum +=$row[csf('recipe_qnty')];
        $req_qny_issue_sum +=$issue_qty;
		$amount_req_value_sum +=$amount_req_value;
		
		$recipe_qnty_grand +=$row[csf('recipe_qnty')];
        $req_qny_issue_grand +=$issue_qty;
		$amount_req_value_grand +=$amount_req_value;
        }
		foreach ($sub_process_tot_rec_array as $val_rec)
		{
			 $totval_rec=$val_rec;
		}
		/*foreach ($sub_process_tot_req_array as $val_req)
		{
			 $totval_req=$val_req;
		}
		foreach ($sub_process_tot_value_array as $req_value)
		{
			 $tot_req_value=$req_value;
		}*/
		
		//$recipe_qnty_grand +=$val_rec;
        //$req_qny_edit_grand +=$val_req;
		//$req_value_grand +=$req_value;
		?>
           <tr>
                <td colspan="8" align="right"><strong>Total :</strong></td>
                <td align="right"><?php echo number_format($totval_rec,6,'.',''); ?></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                
                
                
                
                <td align="right"><?php echo number_format($req_qny_issue_sum,6,'.',''); ?></td>
               
                <td>&nbsp;</td>
                <td align="right"><?php echo number_format($amount_req_value_sum,6,'.',''); ?></td>
            </tr> 
             <tr>
                <td colspan="8" align="right"><strong> Grand Total :</strong></td>
                <td align="right"><?php echo number_format($recipe_qnty_grand,6,'.',''); ?></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                
               
                <td align="right"><?php echo number_format($req_qny_issue_grand,6,'.',''); ?></td>
                <td>&nbsp;</td>
                
                <td align="right"><?php echo number_format($amount_req_value_grand,6,'.',''); ?></td>
            </tr> 
               <tr>
                <td colspan="12" align="right"><strong> Cost Per Kg :</strong></td>
                <td colspan="2" align="right"><?php echo number_format($amount_req_value_grand/($batch_weight+$batchdata_array[0][csf('batch_weight')]),6,'.',''); ?></td>
            </tr>                          
      </table>
        <br>
      	<?  	
	  if($db_type==2) $rec_grp_con="listagg(id,',') within group (order by id) as id";
	  else  $rec_grp_con="group_concat(id)  as id";
	 // echo "select $rec_grp_con from pro_recipe_entry_mst where  dyeing_re_process=1  and entry_form=60 $redyeing_batch_id2";die;
	 $recipe_idss=return_field_value("$rec_grp_con","pro_recipe_entry_mst"," dyeing_re_process in(1,2)  and entry_form=60 $redyeing_batch_id2","id"); 
	// echo $recipe_idss.'DDDD';	die;
	if( $recipe_idss=="")  $recipe_idss_cond="and d.id in(0)";else  $recipe_idss_cond="and d.id in(".$recipe_idss.")";
	   $new_batch_weight=return_field_value("new_batch_weight","pro_recipe_entry_mst","$redyeing_batch_id3");
		$extention_no=return_field_value("max(extention_no) as extention_no","pro_batch_create_mst","batch_no='".$batch_no."' and batch_against=2 and extention_no!=0","extention_no");
		
		if($db_type==2)
			{
				 $sql_dtls="select a.id, a.item_category_id as item_category, a.item_group_id, a.sub_group_name, a.item_description, a.item_size, a.unit_of_measure, b.id as dtls_id, b.sub_process_id as sub_process, b.prod_id, b.item_lot, b.dose_base, b.ratio, b.adj_type, b.adj_perc, b.adj_qnty, b.new_item, b.new_batch_weight, b.new_total_liquor,b.mst_id as recipe_id from product_details_master a, pro_recipe_entry_dtls b,pro_recipe_entry_mst d where d.id=b.mst_id and a.id=b.prod_id  $redyeing_batch_id  $recipe_idss_cond and b.status_active=1 and b.is_deleted=0 and d.entry_form=60 and a.item_category_id in(5,6,7) and a.status_active=1 and a.is_deleted=0 and b.ratio>0 and d.dyeing_re_process in(1,2) order by b.sub_process_id, b.seq_no";
			}
			else if($db_type==0)
			{
			$sql_dtls="select a.id, a.item_category_id as item_category, a.item_group_id, a.sub_group_name, a.item_description, a.item_size, a.unit_of_measure,b.id as dtls_id, b.sub_process_id as sub_process, b.prod_id, b.item_lot, b.dose_base, b.ratio, b.adj_type, b.adj_perc, b.adj_qnty, b.new_item, b.new_batch_weight, b.new_total_liquor,b.mst_id as recipe_id from product_details_master a, pro_recipe_entry_dtls b,pro_recipe_entry_mst d where a.id=b.prod_id and  d.id=b.mst_id $redyeing_batch_id $recipe_idss_cond  and b.status_active=1 and b.is_deleted=0  and a.item_category_id in(5,6,7) and d.entry_form=60 and d.dyeing_re_process=1  and a.status_active=1 and a.is_deleted=0 and b.ratio>0 order by b.sub_process_id, b.seq_no DESC";
			}	
			$sql_result_top= sql_select($sql_dtls);

	if(count($sql_result_top)>0)
	{
		?>
        
     <table width="870" cellspacing="0" align="center"  >
        <tr>
        	<td width="100"><strong>Batch Ext. No:</strong></td><td width="160px"><? echo $extention_no; ?></td>
            <td width="200"><strong>Topping Batch Weight:
	</strong></td> <td><? echo $new_batch_weight; ?></td>
            
            <td width="90">&nbsp;</td><td width="160px"><? //echo implode(",",array_unique(explode(",",$buyer_name))); ?></td>
       </tr>
       </table>
       
        <table align="center" cellspacing="0" width="870" border="1" rules="all" class="rpt_table" >
        <thead bgcolor="#dddddd" align="center">
        <caption> Topping</caption>
    	   <tr bgcolor="#EFEFEF">   
                <th width="30">SL</th>
                <th width="80" >Item Cat.</th>
                <th width="100" >Item Group</th>
                <th width="100" >Sub Group</th>
                <th width="150">Item Description</th>
              
                <th width="50" >UOM</th>
                <th width="100" >Dose Base</th> 
                <th width="40" >Ratio</th>
                <th width="60" >Recipe Qty.</th>
                <th width="50" >Adj%</th>
                <th width="60" >Adj Type</th> 
                <th width="80" >Iss. Qty.</th>
                <th width="70" >Unit Price</th>
                <th width="" >Amount(BDT)</th>
                </tr>
		</thead>
	<?  
 	$group_arr=return_library_array( "select id,item_name from lib_item_group where item_category in (5,6,7) and status_active=1 and is_deleted=0",'id','item_name');
	
 
 $sql_dtls2 = "select a.requ_no, a.batch_id, a.recipe_id, b.id,
		b.sub_process, b.item_category, b.dose_base, b.ratio, b.recipe_qnty, b.adjust_percent, b.adjust_type, b.required_qnty, b.req_qny_edit,
	  	c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id
	    from dyes_chem_issue_requ_mst a,  dyes_chem_issue_requ_dtls b, product_details_master c
	    where a.id=b.mst_id and b.product_id=c.id and b.item_category in (5,6,7) and b.req_qny_edit!=0 and c.item_category_id in (5,6,7)  $batch_con order by b.sub_process, b.seq_no";
		
		
			
	 // echo $sql_dtls;//die;
	
	
	$sub_process_array=array();
	$sub_process_tot_rec_array=array();
	$sub_process_tot_req_array=array();
	$sub_process_tot_value_array=array();
	
	foreach($sql_result as $row)
	{
		$sub_process_tot_rec_array[$row[csf("sub_process")]]+=$row[csf("recipe_qnty")];
		//$sub_process_tot_req_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")];
		//$sub_process_tot_value_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")]*$row[csf("avg_rate_per_unit")];
	}
	$ratio_arr=array();
	$prevRatioData=sql_select( "select prod_id,mst_id as recipe_id,  sub_process_id, ratio from pro_recipe_entry_dtls where status_active=1 and is_deleted=0");
	foreach($prevRatioData as $prevRow)
	{
		$ratio_arr[$prevRow[csf('sub_process_id')]][$prevRow[csf('prod_id')]][$prevRow[csf('recipe_id')]]=$prevRow[csf('ratio')];
	}
	//var_dump($sub_process_tot_req_array);
	$i=1; $k=1; $recipe_qnty_sum=0; $req_qny_edit_sum=0; $recipe_qnty=0; $amount_req_value_grand_top=0; $req_value_sum=0;
	$req_value_grand=0; $recipe_qnty_grand=0; $req_qny_issue_grand_top=0;
	
	foreach($sql_result_top as $row)
	{
		if ($i%2==0)  
			$bgcolor="#E9F3FF";
		else
			$bgcolor="#FFFFFF";
			if (!in_array($row[csf("sub_process")],$sub_process_array) )
			{
				$sub_process_array[]=$row[csf('sub_process')];
				if($k!=1)
				{
					?>
                    <tr>
                        <td colspan="8" align="right"><strong>Total :</strong></td>
                        <td align="right">D<?php  echo number_format($recipe_qnty_sum,6,'.',''); ?></td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                		
                        <td align="right"><?php  echo number_format($req_qny_issue_sum,6,'.',''); ?></td>
                        <td>&nbsp;</td>
                	
                        <td align="right"><?php  echo number_format($amount_req_value_sum,6,'.',''); ?></td>
                    </tr> 
			 <? 
			} 
			$recipe_qnty_sum=0;
			$req_qny_issue_sum=0;
			$amount_req_value_sum=0;
			$k++; 
			?>
            <tr bgcolor="#CCCCCC">
                <th colspan="14"><strong><? echo $dyeing_sub_process[$row[csf("sub_process")]]; ?></strong></th>
            </tr> 
            
        <? 
		}
		
		
		$issue_qty=$issue_data_topping_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['issue_qty'];
		$issue_cons_rate=$issue_data_topping_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_rate'];
		$total_liquor=$row[csf("new_total_liquor")];
		$batch_weight=$row[csf("new_batch_weight")];
		$ratio=$row[csf("ratio")];
		$dose_base_id=$row[csf("dose_base")];
		$adj_type=$row[csf("adj_type")];
		$prod_id=$row[csf("prod_id")];
		if($row[csf("new_item")]==1) 
			{
				$prev_ratio='';
				$recipe_qty='';
				$adj_type='';
			}
			else 
			{
				//echo $row[csf("recipe_id")];
				$prev_ratio=$ratio_arr[$row[csf("sub_process")]][$prod_id][$row[csf("recipe_id")]];
				if($dose_base_id==1) $recipe_qty=number_format(($total_liquor*$prev_ratio)/1000,4);
				else if($dose_base_id==2) $recipe_qty=number_format(($new_batch_weight*$prev_ratio)/100,4);
				$adj_type=$increase_decrease[$adj_type];
				//$ratio=$adj_perc;
			}
		?>
        <tbody>
			<tr bgcolor="<? echo $bgcolor; ?>">
                <td align="center"><? echo $i; ?></td>
                <td><? echo $item_category[$row[csf("item_category")]];  //echo $row[csf("sub_process")]; ?></td>
                <td><? echo $group_arr[$row[csf("item_group_id")]]; ?></td>
                <td><? echo $row[csf("sub_group_name")]; ?></td>
              
                <td><? echo $row[csf("item_description")].' '.$row[csf("item_size")]; ?></td>
                
                <td align="center"><? echo $unit_of_measurement[$row[csf("unit_of_measure")]]; ?></td>
                <td><? echo $dose_base[$row[csf("dose_base")]]; ?></td>
                <td align="center"><? echo number_format($ratio,6,'.',''); ?></td>
                <td align="right"><? echo $recipe_qty; ?></td>
                <td align="center"><? echo $row[csf("adj_perc")]; ?></td>
                <td><? echo $adj_type; ?></td>
              
                <td align="right"><? echo number_format($issue_qty,6,'.',''); ?></td>
                
                <td align="right"><? echo  number_format($issue_cons_rate,6,'.',''); ?></td>
                <td align="right"><? $amount_req_value=$issue_qty*$issue_cons_rate; echo number_format($amount_req_value,6,'.',''); ?></td>
			</tr>
        </tbody>
		<? $i++;
        $recipe_qnty_sum +=$recipe_qty;
        $req_qny_issue_sum +=$issue_qty;
		$amount_req_value_sum +=$amount_req_value;
		
		$recipe_qnty_grand +=$recipe_qty;
        $req_qny_issue_grand_top +=$issue_qty;
		$amount_req_value_grand_top +=$amount_req_value;
        }
		
		?>
           <tr>
                <td colspan="8" align="right"><strong>Total :</strong></td>
                <td align="right"><?php echo number_format($recipe_qnty_sum,6,'.',''); ?></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                
                <td align="right"><?php echo number_format($req_qny_issue_sum,6,'.',''); ?></td>
               
                <td>&nbsp;</td>
                <td align="right"><?php echo number_format($amount_req_value_sum,6,'.',''); ?></td>
            </tr> 
             <tr>
                <td colspan="8" align="right"><strong> Grand Total :</strong></td>
                <td align="right"><?php echo number_format($recipe_qnty_grand,6,'.',''); ?></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
               
                <td align="right"><?php echo number_format($req_qny_issue_grand_top,6,'.',''); ?></td>
                <td>&nbsp;</td>
                
                <td align="right"><?php echo number_format($amount_req_value_grand_top,6,'.',''); ?></td>
            </tr> 
               <tr style="">
                <td colspan="12" align="right"><strong> Cost Per Kg :</strong></td>
                <td colspan="2" align="right"><?php echo number_format($amount_req_value_grand_top/($new_batch_weight),6,'.',''); ?></td>
            </tr>                          
      </table>
		 
      </div>
          
	<?
	}
	 
    $html=ob_get_contents();
			ob_flush();
			
			foreach (glob(""."*.xls") as $filename) 
			{
			   @unlink($filename);
			}
			
			//html to xls convert
			$name=time();
			$name=$user_id."_".$name.".xls";
			$create_new_excel = fopen(''.$name, 'w');	
			$is_created = fwrite($create_new_excel,$html);
	
	?>
      <input type="hidden" id="txt_excl_link" value="<? echo 'requires/'.$name; ?>" />
    <script>
	$(document).ready(function(e) {
				document.getElementById('report_container').innerHTML='<a href="<? echo $name?>" style="text-decoration:none"><input type="button" value="Excel Download" name="excel" id="excel" class="formbutton" style="width:90px;font-size:11px"/></a>&nbsp;&nbsp;';
		});	
	</script>
      </div> 
    <?
	exit();
}
if($action=="subprocess_fabrics_dtls_popup_old")
{
	echo load_html_head_contents("Subprocess Details", "../../../../", 1, 1,$unicode,'','');
	extract($_REQUEST);
	//echo $batch_id;
	//if($batch_id!='') $batch_con=" and LIKE a.batch_id";
	$color_arr=return_library_array( "select id, color_name from lib_color", "id", "color_name");
	$re_dyeing_batch_id=return_field_value("id","pro_batch_create_mst","batch_no='".$batch_no."' and batch_against=2 and extention_no!=0");


	if ($batch_id!='') $batch_con=" and a.batch_id like '%$batch_id%'"; else $batch_con="and a.batch_id='0'";
	if ($batch_id!='') $issue_batch_con=" and d.batch_id like '%$batch_id%'"; else $issue_batch_con="and d.batch_id='0'";

	if ($re_dyeing_batch_id!='') $redyeing_batch_id=" and d.batch_id in($re_dyeing_batch_id)"; else $redyeing_batch_id="and d.batch_id in('0')";

  
	$batch_weight=0;
	if($db_type==0) 
	{
		$data_array=sql_select("select group_concat(buyer_id) as buyer_id,group_concat(id) as recipe_id, group_concat(batch_id) as batch_id, sum(total_liquor) as total_liquor, group_concat(concat_ws(':',batch_ratio,liquor_ratio) order by id) as ratio, sum(case when entry_form=60 then new_batch_weight end) as batch_weight, group_concat(case when entry_form<>60 then batch_id end) as batch_id_rec_main from pro_recipe_entry_mst where batch_id in($batch_id)");
	}
	else
	{
		$data_array=sql_select("select listagg(buyer_id,',') within group (order by buyer_id) as buyer_id,listagg(id,',') within group (order by id) as recipe_id, listagg(batch_id,',') within group (order by batch_id) as batch_id, sum(total_liquor) as total_liquor, listagg(batch_ratio || ':' || liquor_ratio,',') within group (order by id) as ratio, sum(case when entry_form=60 then new_batch_weight end) as batch_weight, listagg(case when entry_form<>60 then batch_id end,',') within group (order by batch_id) as batch_id_rec_main from pro_recipe_entry_mst where  batch_id in($batch_id)");
	}
	//$batch_weight=$data_array[0][csf("batch_weight")];
	$batch_id=implode(",",array_unique(explode(",",$data_array[0][csf("batch_id")])));
	
	$batch_id_rec_main=implode(",",array_unique(explode(",",$data_array[0][csf("batch_id_rec_main")])));
	if($batch_id_rec_main=="") $batch_id_rec_main=0;

	if($db_type==0) 
	{
		$batchdata_array=sql_select("select group_concat(batch_no) as batch_no, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight, group_concat(distinct color_id) as color_id,group_concat(distinct color_range_id) as color_range_id from pro_batch_create_mst where id in($batch_id)");
	}
	else //color_range_id
	{
		$batchdata_array=sql_select("select listagg(CAST(batch_no AS VARCHAR2(4000)),',') within group (order by id) as batch_no, listagg(color_id ,',') within group (order by id) as color_id,listagg(color_range_id ,',') within group (order by id) as color_range_id, sum(case when id in($batch_id_rec_main) then batch_weight end) as batch_weight from pro_batch_create_mst where id in($batch_id)");	
	}
	
	 $sql="select a.id, a.requ_no, a.location_id, a.requisition_date,a.method, a.requisition_basis, a.batch_id, a.recipe_id, a.machine_id from dyes_chem_issue_requ_mst a where status_active=1 $batch_con";
	$dataArray=sql_select($sql);
	 $recipe_id=$dataArray[0][csf('recipe_id')];
	$po_no=''; $job_no='';$file_no='';$ref_no=''; $buyer_name='';
		if($batch_type==2)
		{
			$po_data=sql_select("select distinct b.order_no, c.subcon_job, c.party_id from pro_batch_create_dtls a, subcon_ord_dtls b, subcon_ord_mst c where a.po_id=b.id and b.job_no_mst=c.subcon_job and a.status_active=1 and a.is_deleted=0 and a.mst_id in(".$batch_id.") ");
			foreach($po_data as $row)
			{
				$po_no.=$row[csf('order_no')].","; 
				$job_no.=$row[csf('subcon_job')].",";
				$buyer_name.=$buyer_library[$row[csf('party_id')]].",";
			}
		}
		else
		{
			$po_data=sql_select("select distinct b.po_number,b.file_no,b.grouping as ref, c.job_no, c.buyer_name from pro_batch_create_dtls a, wo_po_break_down b, wo_po_details_master c where a.po_id=b.id and b.job_no_mst=c.job_no and a.status_active=1 and a.is_deleted=0 and a.mst_id in(".$batch_id.") ");
			foreach($po_data as $row)
			{
				$po_no.=$row[csf('po_number')].","; 
				$job_no.=$row[csf('job_no')].",";
				$file_no.=$row[csf('file_no')].","; 
				$ref_no.=$row[csf('ref')].","; 
				//$buyer_name.=$buyer_library[$row[csf('buyer_name')]].",";
			}
			foreach(explode(",",$data_array[0][csf("buyer_id")]) as $buyer_id)
			{
				$buyer_name.=$buyer_library[$buyer_id].",";
			}
				
		}
		$color_id=array_unique(explode(",",$batchdata_array[0][csf('color_id')]));
		$color_name='';
		foreach($color_id as $color)
		{
		$color_name.=$color_arr[$color].",";
		}
		$color_range_id=array_unique(explode(",",$batchdata_array[0][csf('color_range_id')]));
		$color_ranges='';
		foreach($color_range_id as $rang_id)
		{
		$color_ranges.=$color_range[$rang_id].",";
		}
		
		$color_range=substr($color_ranges,0,-1);
	
	  $sql_isue_dtls = "select d.recipe_id,a.batch_no,
	 avg(b.cons_rate) as cons_rate, sum(b.cons_quantity) as cons_quantity, d.product_id as prod_id,
	   c.item_group_id, d.sub_process
	  from inv_issue_master a, inv_transaction b, product_details_master c, dyes_chem_issue_dtls d
	  where a.id=b.mst_id and b.id =d.trans_id and d.product_id=c.id and b.prod_id=c.id and b.transaction_type=2 and a.entry_form=5 and b.item_category in (5,6,7) $issue_batch_con  group by d.recipe_id,a.batch_no,d.product_id, c.item_group_id, d.sub_process order by d.sub_process "; 
	 // echo $sql_dtls;die;
	  $sql_result_issue= sql_select($sql_isue_dtls);
	  $issue_data_arr=array();
	  foreach($sql_result_issue as $row)
	  {
		  $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['issue_qty']=$row[csf('cons_quantity')]; 
		   $issue_data_arr[$row[csf('sub_process')]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_rate']=$row[csf('cons_rate')]; 
	  }
	  ob_start();
	?>
    <script>
		function print_window()
		{
			var w = window.open("Surprise", "#");
			var d = w.document.open();
			d.write ('<!DOCTYPE HTML PUBLIC "-//W3C//DTsD HTML 4.01//EN""http://www.w3.org/TR/html4/strict.dtd">'+
			'<html><head><link rel="stylesheet" href="../../../../css/style_common.css" type="text/css" media="print"/><title></title></head><body>'+document.getElementById('report_div').innerHTML+'</body</html>');
			d.close();
		}	
		
		
		  
	</script>	
      <div> 
	<div style="width:870px; margin-left:30px" id="report_div">
     <div style="width:870px;" align="center">
    		 
        	<input  type="button" value="Print Preview" onClick="print_window()" style="width:90px"  class="formbutton"/> &nbsp;
             <div id="report_container"> </div>
        </div>
        <?
         ob_start();
		?>
     <table width="870" cellspacing="0" align="center"  >
        <tr>
        	<td width="100"><strong>Issue Date:</strong></td><td width="160px"><? echo change_date_format($dataArray[0][csf('requisition_date')]); ?></td>
            <td width="90"><strong>Issue Basis</strong></td> <td><? echo $receive_basis_arr[$dataArray[0][csf('requisition_basis')]]; ?></td>
            
            <td width="90"><strong></strong></td><td width="160px"><? //echo implode(",",array_unique(explode(",",$buyer_name))); ?></td>
       </tr>
        <tr>
            <td><strong>Buyer Order:</strong></td> <td><? echo $po_no; ?></td>
           <td><strong>Batch No</strong></td><td><? echo $batchdata_array[0][csf('batch_no')]; ?></td>
           <td><strong>Batch Weight</strong></td><td><? echo $batch_weight+$batchdata_array[0][csf('batch_weight')]; ?></td>
        </tr>
        <tr>
            <td><strong>File No</strong></td><td><? echo $file_no; ?></td>
            <td><strong>Ref. No:</strong></td><td><? echo $ref_no; ?></td>
            <td><strong>Batch Color:</strong></td><td><? echo $color_name; ?></td>
        </tr>
        <tr>
            <td><strong>Color Range</strong></td><td><? echo $color_range; ?></td>
            <td></td><td><? //echo $data_array[0][csf("total_liquor")]; ?></td>
            <td></td><td><? //echo $data_array[0][csf("ratio")]; ?></td>
        </tr>
       
    </table>
    
    <table align="center" cellspacing="0" width="870" border="1" rules="all" class="rpt_table" >
        <thead bgcolor="#dddddd" align="center">
    	   <tr bgcolor="#EFEFEF">   
                <th width="30">SL</th>
                <th width="80" >Item Cat.</th>
                <th width="100" >Item Group</th>
                <th width="150">Item Description</th>
              
                <th width="50" >UOM</th>
                <th width="100" >Dose Base</th> 
                <th width="40" >Ratio</th>
                <th width="60" >Recipe Qty.</th>
                <th width="50" >Adj%</th>
                <th width="60" >Adj Type</th> 
               
                <th width="80" >Iss. Qty.</th>
              
                <th width="70" >Unit Price</th>
                <th width="" >Amount(BDT)</th>
                </tr>
		</thead>
	<?  
 	$group_arr=return_library_array( "select id,item_name from lib_item_group where item_category in (5,6,7) and status_active=1 and is_deleted=0",'id','item_name');
	
 
 $sql_dtls = "select a.requ_no, a.batch_id, a.recipe_id, b.id,
		b.sub_process, b.item_category, b.dose_base, b.ratio, b.recipe_qnty, b.adjust_percent, b.adjust_type, b.required_qnty, b.req_qny_edit,
	  	c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id
	    from dyes_chem_issue_requ_mst a,  dyes_chem_issue_requ_dtls b, product_details_master c
	    where a.id=b.mst_id and b.product_id=c.id and b.item_category in (5,6,7) and b.req_qny_edit!=0 and c.item_category_id in (5,6,7)  $batch_con order by b.id, b.seq_no";
	 // echo $sql_dtls;//die;
	$sql_result= sql_select($sql_dtls);
	
	$sub_process_array=array();
	$sub_process_tot_rec_array=array();
	$sub_process_tot_req_array=array();
	$sub_process_tot_value_array=array();
	
	foreach($sql_result as $row)
	{
		$sub_process_tot_rec_array[$row[csf("sub_process")]]+=$row[csf("recipe_qnty")];
		//$sub_process_tot_req_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")];
		//$sub_process_tot_value_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")]*$row[csf("avg_rate_per_unit")];
	}
	?>
                
	<?
	//var_dump($sub_process_tot_req_array);
	$i=1; $k=1; $recipe_qnty_sum=0; $req_qny_edit_sum=0; $recipe_qnty=0; $req_qny_edit=0; $req_value_sum=0;
	$req_value_grand=0; $recipe_qnty_grand=0; $req_qny_edit_grand=0;
	
	foreach($sql_result as $row)
	{
		if ($i%2==0)  
			$bgcolor="#E9F3FF";
		else
			$bgcolor="#FFFFFF";
			if (!in_array($row[csf("sub_process")],$sub_process_array) )
			{
				$sub_process_array[]=$row[csf('sub_process')];
				if($k!=1)
				{
					?>
                    <tr>
                        <td colspan="7" align="right"><strong>Total :</strong></td>
                        <td align="right"><?php  echo number_format($recipe_qnty_sum,6,'.',''); ?></td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                		
                        <td align="right"><?php  echo number_format($req_qny_issue_sum,6,'.',''); ?></td>
                        <td>&nbsp;</td>
                	
                        <td align="right"><?php  echo number_format($amount_req_value_sum,6,'.',''); ?></td>
                    </tr> 
			 <? 
			} 
			$recipe_qnty_sum=0;
			$req_qny_issue_sum=0;
			$amount_req_value_sum=0;
			$k++; 
			?>
            <tr bgcolor="#CCCCCC">
                <th colspan="13"><strong><? echo $dyeing_sub_process[$row[csf("sub_process")]]; ?></strong></th>
            </tr> 
            
        <? 
		}
		
		
		$issue_qty=$issue_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['issue_qty'];
		$issue_cons_rate=$issue_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_rate'];
		?>
        <tbody>
			<tr bgcolor="<? echo $bgcolor; ?>">
                <td align="center"><? echo $i; ?></td>
                <td><? echo $item_category[$row[csf("item_category")]];  //echo $row[csf("sub_process")]; ?></td>
                <td><? echo $group_arr[$row[csf("item_group_id")]]; ?></td>
              
                <td><? echo $row[csf("item_description")].' '.$row[csf("item_size")]; ?></td>
                
                <td align="center"><? echo $unit_of_measurement[$row[csf("unit_of_measure")]]; ?></td>
                <td><? echo $dose_base[$row[csf("dose_base")]]; ?></td>
                <td align="center"><? echo number_format($row[csf("ratio")],6,'.',''); ?></td>
                <td align="right"><? echo number_format($row[csf("recipe_qnty")],6,'.',''); ?></td>
                <td align="center"><? echo $row[csf("adjust_percent")]; ?></td>
                <td><? echo $increase_decrease[$row[csf("adjust_type")]]; ?></td>
              
                <td align="right"><? echo number_format($issue_qty,6,'.',''); ?></td>
                
                <td align="right"><? echo  number_format($issue_cons_rate,6,'.',''); ?></td>
                <td align="right"><? $amount_req_value=$issue_qty*$issue_cons_rate; echo number_format($amount_req_value,6,'.',''); ?></td>
			</tr>
        </tbody>
		<? $i++;
        $recipe_qnty_sum +=$row[csf('recipe_qnty')];
        $req_qny_issue_sum +=$issue_qty;
		$amount_req_value_sum +=$amount_req_value;
		
		$recipe_qnty_grand +=$row[csf('recipe_qnty')];
        $req_qny_issue_grand +=$issue_qty;
		$amount_req_value_grand +=$amount_req_value;
        }
		foreach ($sub_process_tot_rec_array as $val_rec)
		{
			 $totval_rec=$val_rec;
		}
		/*foreach ($sub_process_tot_req_array as $val_req)
		{
			 $totval_req=$val_req;
		}
		foreach ($sub_process_tot_value_array as $req_value)
		{
			 $tot_req_value=$req_value;
		}*/
		
		//$recipe_qnty_grand +=$val_rec;
        //$req_qny_edit_grand +=$val_req;
		//$req_value_grand +=$req_value;
		?>
           <tr>
                <td colspan="7" align="right"><strong>Total :</strong></td>
                <td align="right"><?php echo number_format($totval_rec,6,'.',''); ?></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                
                <td align="right"><?php echo number_format($req_qny_issue_sum,6,'.',''); ?></td>
               
                <td>&nbsp;</td>
                <td align="right"><?php echo number_format($amount_req_value_sum,6,'.',''); ?></td>
            </tr> 
             <tr>
                <td colspan="7" align="right"><strong> Grand Total :</strong></td>
                <td align="right"><?php echo number_format($recipe_qnty_grand,6,'.',''); ?></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
               
                <td align="right"><?php echo number_format($req_qny_issue_grand,6,'.',''); ?></td>
                <td>&nbsp;</td>
                
                <td align="right"><?php echo number_format($amount_req_value_grand,6,'.',''); ?></td>
            </tr> 
               <tr>
                <td colspan="11" align="right"><strong> Cost Per Kg :</strong></td>
                <td colspan="2" align="right"><?php echo number_format($amount_req_value_grand/($batch_weight+$batchdata_array[0][csf('batch_weight')]),6,'.',''); ?></td>
            </tr>                          
      </table>
        <br>
      	<?  	
	  if($db_type==2) $rec_grp_con="listagg(id,',') within group (order by id) as id";
	  else  $rec_grp_con="group_concat(id)  as id";
	 $recipe_idss=return_field_value("$rec_grp_con","pro_recipe_entry_mst","batch_id='".$re_dyeing_batch_id."' and  dyeing_re_process=1  and entry_form=60 ","id"); 	
	   $new_batch_weight=return_field_value("new_batch_weight","pro_recipe_entry_mst","id='".$re_dyeing_batch_id."' ");
		$extention_no=return_field_value("max(extention_no) as extention_no","pro_batch_create_mst","batch_no='".$batch_no."' and batch_against=2 and extention_no!=0","extention_no");
		
		if($db_type==2)
			{
				 $sql_dtls="select a.id, a.item_category_id as item_category, a.item_group_id, a.sub_group_name, a.item_description, a.item_size, a.unit_of_measure, b.id as dtls_id, b.sub_process_id as sub_process, b.prod_id, b.item_lot, b.dose_base, b.ratio, b.adj_type, b.adj_perc, b.adj_qnty, b.new_item, b.new_batch_weight, b.new_total_liquor,b.mst_id as recipe_id from product_details_master a, pro_recipe_entry_dtls b,pro_recipe_entry_mst d where d.id=b.mst_id and a.id=b.prod_id  $redyeing_batch_id and d.id in($recipe_idss) and b.status_active=1 and b.is_deleted=0 and d.entry_form=60 and a.item_category_id in(5,6,7) and a.status_active=1 and a.is_deleted=0 and b.ratio>0 and d.dyeing_re_process=1 order by b.sub_process_id, b.seq_no";
			}
			else if($db_type==0)
			{
				$sql_dtls="select a.id, a.item_category_id as item_category, a.item_group_id, a.sub_group_name, a.item_description, a.item_size, a.unit_of_measure,b.id as dtls_id, b.sub_process_id as sub_process, b.prod_id, b.item_lot, b.dose_base, b.ratio, b.adj_type, b.adj_perc, b.adj_qnty, b.new_item, b.new_batch_weight, b.new_total_liquor,b.mst_id as recipe_id from product_details_master a, pro_recipe_entry_dtls b where a.id=b.prod_id  $redyeing_batch_id and d.id in($recipe_idss) and b.status_active=1 and b.is_deleted=0  and a.item_category_id in(5,6,7) and d.entry_form=60 and d.dyeing_re_process=1  and a.status_active=1 and a.is_deleted=0 and b.ratio>0 order by b.sub_process_id, b.seq_no DESC";
			}	
			$sql_result_top= sql_select($sql_dtls);

	if(count($sql_result_top)>0)
	{
		?>
        
     <table width="870" cellspacing="0" align="center"  >
        <tr>
        	<td width="100"><strong>Batch Ext. No:</strong></td><td width="160px"><? echo $extention_no; ?></td>
            <td width="200"><strong>Topping Batch Weight:
	</strong></td> <td><? echo $new_batch_weight; ?></td>
            
            <td width="90">&nbsp;</td><td width="160px"><? //echo implode(",",array_unique(explode(",",$buyer_name))); ?></td>
       </tr>
       </table>
       
        <table align="center" cellspacing="0" width="870" border="1" rules="all" class="rpt_table" >
        <thead bgcolor="#dddddd" align="center">
        <caption> Topping</caption>
    	   <tr bgcolor="#EFEFEF">   
                <th width="30">SL</th>
                <th width="80" >Item Cat.</th>
                <th width="100" >Item Group</th>
                <th width="150">Item Description</th>
              
                <th width="50" >UOM</th>
                <th width="100" >Dose Base</th> 
                <th width="40" >Ratio</th>
                <th width="60" >Recipe Qty.</th>
                <th width="50" >Adj%</th>
                <th width="60" >Adj Type</th> 
                <th width="80" >Iss. Qty.</th>
                <th width="70" >Unit Price</th>
                <th width="" >Amount(BDT)</th>
                </tr>
		</thead>
	<?  
 	$group_arr=return_library_array( "select id,item_name from lib_item_group where item_category in (5,6,7) and status_active=1 and is_deleted=0",'id','item_name');
	
 
 $sql_dtls2 = "select a.requ_no, a.batch_id, a.recipe_id, b.id,
		b.sub_process, b.item_category, b.dose_base, b.ratio, b.recipe_qnty, b.adjust_percent, b.adjust_type, b.required_qnty, b.req_qny_edit,
	  	c.item_description, c.item_group_id, c.sub_group_name, c.item_size, c.unit_of_measure,c.avg_rate_per_unit,c.id as prod_id
	    from dyes_chem_issue_requ_mst a,  dyes_chem_issue_requ_dtls b, product_details_master c
	    where a.id=b.mst_id and b.product_id=c.id and b.item_category in (5,6,7) and b.req_qny_edit!=0 and c.item_category_id in (5,6,7)  $batch_con order by b.id, b.seq_no";
		
		
			
	 // echo $sql_dtls;//die;
	
	
	$sub_process_array=array();
	$sub_process_tot_rec_array=array();
	$sub_process_tot_req_array=array();
	$sub_process_tot_value_array=array();
	
	foreach($sql_result as $row)
	{
		$sub_process_tot_rec_array[$row[csf("sub_process")]]+=$row[csf("recipe_qnty")];
		//$sub_process_tot_req_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")];
		//$sub_process_tot_value_array[$row[csf("sub_process")]]+=$row[csf("req_qny_edit")]*$row[csf("avg_rate_per_unit")];
	}
	$ratio_arr=array();
	$prevRatioData=sql_select( "select prod_id,mst_id as recipe_id,  sub_process_id, ratio from pro_recipe_entry_dtls where status_active=1 and is_deleted=0");
	foreach($prevRatioData as $prevRow)
	{
		$ratio_arr[$prevRow[csf('sub_process_id')]][$prevRow[csf('prod_id')]][$prevRow[csf('recipe_id')]]=$prevRow[csf('ratio')];
	}
	//var_dump($sub_process_tot_req_array);
	$i=1; $k=1; $recipe_qnty_sum=0; $req_qny_edit_sum=0; $recipe_qnty=0; $amount_req_value_grand_top=0; $req_value_sum=0;
	$req_value_grand=0; $recipe_qnty_grand=0; $req_qny_issue_grand_top=0;
	
	foreach($sql_result_top as $row)
	{
		if ($i%2==0)  
			$bgcolor="#E9F3FF";
		else
			$bgcolor="#FFFFFF";
			if (!in_array($row[csf("sub_process")],$sub_process_array) )
			{
				$sub_process_array[]=$row[csf('sub_process')];
				if($k!=1)
				{
					?>
                    <tr>
                        <td colspan="7" align="right"><strong>Total :</strong></td>
                        <td align="right">D<?php  echo number_format($recipe_qnty_sum,6,'.',''); ?></td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                		
                        <td align="right"><?php  echo number_format($req_qny_issue_sum,6,'.',''); ?></td>
                        <td>&nbsp;</td>
                	
                        <td align="right"><?php  echo number_format($amount_req_value_sum,6,'.',''); ?></td>
                    </tr> 
			 <? 
			} 
			$recipe_qnty_sum=0;
			$req_qny_issue_sum=0;
			$amount_req_value_sum=0;
			$k++; 
			?>
            <tr bgcolor="#CCCCCC">
                <th colspan="13"><strong><? echo $dyeing_sub_process[$row[csf("sub_process")]]; ?></strong></th>
            </tr> 
            
        <? 
		}
		
		
		$issue_qty=$issue_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['issue_qty'];
		$issue_cons_rate=$issue_data_arr[$row[csf("sub_process")]][$row[csf('prod_id')]][$row[csf('item_group_id')]][$row[csf('recipe_id')]]['cons_rate'];
		$total_liquor=$row[csf("new_total_liquor")];
		$batch_weight=$row[csf("new_batch_weight")];
		$ratio=$row[csf("ratio")];
		$dose_base_id=$row[csf("dose_base")];
		$adj_type=$row[csf("adj_type")];
		$prod_id=$row[csf("prod_id")];
		if($row[csf("new_item")]==1) 
			{
				$prev_ratio='';
				$recipe_qty='';
				$adj_type='';
			}
			else 
			{
				//echo $row[csf("recipe_id")];
				$prev_ratio=$ratio_arr[$row[csf("sub_process")]][$prod_id][$row[csf("recipe_id")]];
				if($dose_base_id==1) $recipe_qty=number_format(($total_liquor*$prev_ratio)/1000,4);
				else if($dose_base_id==2) $recipe_qty=number_format(($new_batch_weight*$prev_ratio)/100,4);
				$adj_type=$increase_decrease[$adj_type];
				//$ratio=$adj_perc;
			}
		?>
        <tbody>
			<tr bgcolor="<? echo $bgcolor; ?>">
                <td align="center"><? echo $i; ?></td>
                <td><? echo $item_category[$row[csf("item_category")]];  //echo $row[csf("sub_process")]; ?></td>
                <td><? echo $group_arr[$row[csf("item_group_id")]]; ?></td>
              
                <td><? echo $row[csf("item_description")].' '.$row[csf("item_size")]; ?></td>
                
                <td align="center"><? echo $unit_of_measurement[$row[csf("unit_of_measure")]]; ?></td>
                <td><? echo $dose_base[$row[csf("dose_base")]]; ?></td>
                <td align="center"><? echo number_format($ratio,6,'.',''); ?></td>
                <td align="right"><? echo $recipe_qty; ?></td>
                <td align="center"><? echo $row[csf("adj_perc")]; ?></td>
                <td><? echo $adj_type; ?></td>
              
                <td align="right"><? echo number_format($issue_qty,6,'.',''); ?></td>
                
                <td align="right"><? echo  number_format($issue_cons_rate,6,'.',''); ?></td>
                <td align="right"><? $amount_req_value=$issue_qty*$issue_cons_rate; echo number_format($amount_req_value,6,'.',''); ?></td>
			</tr>
        </tbody>
		<? $i++;
        $recipe_qnty_sum +=$recipe_qty;
        $req_qny_issue_sum +=$issue_qty;
		$amount_req_value_sum +=$amount_req_value;
		
		$recipe_qnty_grand +=$recipe_qty;
        $req_qny_issue_grand_top +=$issue_qty;
		$amount_req_value_grand_top +=$amount_req_value;
        }
		
		?>
           <tr>
                <td colspan="7" align="right"><strong>Total :</strong></td>
                <td align="right"><?php echo number_format($recipe_qnty_sum,6,'.',''); ?></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                
                <td align="right"><?php echo number_format($req_qny_issue_sum,6,'.',''); ?></td>
               
                <td>&nbsp;</td>
                <td align="right"><?php echo number_format($amount_req_value_sum,6,'.',''); ?></td>
            </tr> 
             <tr>
                <td colspan="7" align="right"><strong> Grand Total :</strong></td>
                <td align="right"><?php echo number_format($recipe_qnty_grand,6,'.',''); ?></td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
               
                <td align="right"><?php echo number_format($req_qny_issue_grand_top,6,'.',''); ?></td>
                <td>&nbsp;</td>
                
                <td align="right"><?php echo number_format($amount_req_value_grand_top,6,'.',''); ?></td>
            </tr> 
               <tr style="">
                <td colspan="11" align="right"><strong> Cost Per Kg :</strong></td>
                <td colspan="2" align="right"><?php echo number_format($amount_req_value_grand_top/($new_batch_weight),6,'.',''); ?></td>
            </tr>                          
      </table>
		 
      </div>
          
	<?
	}
	 
    $html=ob_get_contents();
			ob_flush();
			
			foreach (glob(""."*.xls") as $filename) 
			{
			   @unlink($filename);
			}
			
			//html to xls convert
			$name=time();
			$name=$user_id."_".$name.".xls";
			$create_new_excel = fopen(''.$name, 'w');	
			$is_created = fwrite($create_new_excel,$html);
	
	?>
      <input type="hidden" id="txt_excl_link" value="<? echo 'requires/'.$name; ?>" />
    <script>
	$(document).ready(function(e) {
				document.getElementById('report_container').innerHTML='<a href="<? echo $name?>" style="text-decoration:none"><input type="button" value="Excel Download" name="excel" id="excel" class="formbutton" style="width:90px;font-size:11px"/></a>&nbsp;&nbsp;';
		});	
	</script>
      </div> 
    <?
	exit();
}
?>