<?
header('Content-type:text/html; charset=utf-8');
session_start();
if( $_SESSION['logic_erp']['user_id'] == "" ) header("location:login.php");

include('../../../includes/common.php');

$data=$_REQUEST['data'];
$action=$_REQUEST['action'];

$user_id = $_SESSION['logic_erp']["user_id"];
$user_buyer_id = $_SESSION['logic_erp']["buyer_id"];

$item_category_without_general=array_diff($item_category,$general_item_category);
$genarel_item_arr=array(4=>"Accessories",8=>"General Item");
$item_category_with_gen=$item_category_without_general+$genarel_item_arr;
ksort($item_category_with_gen);

//echo $user_buyer_id.test;die;
//------------------------------------------Load Drop Down on Change---------------------------------------------//

if ($action=="load_drop_down_location")
{
	$data = explode("_",$data);
	$company_id = $data[0];
	$sql="select id, location_name from lib_location where company_id=$company_id and is_deleted=0 and status_active=1 $location_credential_cond";
	$sql_results=sql_select($sql);
	if(count($sql_results)==1)
	{
		$selected_id=$sql_results[0][csf("id")];
	}
	else
	{
		if($data[0]!=''){$selected_id=$data[1];}else{$selected_id=0;}
	}
	echo create_drop_down( "cbo_location_name", 151,$sql,"id,location_name", 1, "-- Select --", $selected_id, "" );
	die;
}

if ($action=="load_supplier_dropdown")
{
	$ex_data = explode('_',$data);
	$company=$ex_data[0];
	$item_category=$ex_data[1];
	$supplier=$ex_data[2];

	if($item_category==0)
	{
		echo create_drop_down( "cbo_supplier_id", 151, $blank_array,'', 1, '-- Select Supplier --',0,'',0);
	}
	else if($item_category==1)
	{
		echo create_drop_down( "cbo_supplier_id", 151,"select DISTINCT(c.supplier_name),c.id from  lib_supplier_tag_company a,lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$company' and b.party_type =2 and c.status_active=1 and c.is_deleted=0 order by c.supplier_name",'id,supplier_name', 1, '-- Select Supplier --',$supplier,'',0);
	}
	else if($item_category==2 || $item_category==3 || $item_category==13 || $item_category==14)
	{
		echo create_drop_down( "cbo_supplier_id", 151,"select DISTINCT(c.supplier_name),c.id from  lib_supplier_tag_company a,lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$company' and b.party_type =9 and c.status_active=1 and c.is_deleted=0 order by c.supplier_name",'id,supplier_name', 1, '-- Select Supplier --',$supplier,'',0);
	}
	else if($item_category==4)
	{
		echo create_drop_down( "cbo_supplier_id", 151,"select DISTINCT(c.supplier_name),c.id from  lib_supplier_tag_company a,lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$company' and b.party_type in(4,5) and c.status_active=1 and c.is_deleted=0 order by c.supplier_name",'id,supplier_name', 1, '-- Select Supplier --',$supplier,'',0);

	}
	else if($item_category==5 || $item_category==6 || $item_category==7)
	{
		echo create_drop_down( "cbo_supplier_id", 151,"select DISTINCT(c.supplier_name),c.id from  lib_supplier_tag_company a,lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$company' and b.party_type=3 and c.status_active=1 and c.is_deleted=0 order by c.supplier_name",'id,supplier_name', 1, '-- Select Supplier --',$supplier,'',0);
	}
	else if($item_category==9 || $item_category==10)
	{
		echo create_drop_down( "cbo_supplier_id", 151,"select DISTINCT(c.supplier_name),c.id from  lib_supplier_tag_company a,lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$company' and b.party_type = 6 and c.status_active=1 and c.is_deleted=0 order by c.supplier_name",'id,supplier_name', 1, '-- Select Supplier --',$supplier,'',0);
	}
	else if($item_category==11)
	{
		echo create_drop_down( "cbo_supplier_id", 151,"select DISTINCT(c.supplier_name),c.id from  lib_supplier_tag_company a,lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$company' and b.party_type = 8 and c.status_active=1 and c.is_deleted=0 order by c.supplier_name",'id,supplier_name', 1, '-- Select Supplier --',$supplier,'',0);
	}
	else if($item_category==12 || $item_category==24 || $item_category==25)
	{
		echo create_drop_down( "cbo_supplier_id", 151,"select DISTINCT(c.supplier_name),c.id from lib_supplier_tag_company a,lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$company' and b.party_type in(20,21,22,23,24,30,31,32,35,36,37,38,39) and c.status_active=1 and c.is_deleted=0 order by c.supplier_name",'id,supplier_name', 1, '-- Select Supplier --',0,'',0);
	}
	else if($item_category==31)
	{
		echo create_drop_down( "cbo_supplier_id", 151,"select DISTINCT(c.supplier_name),c.id from lib_supplier_tag_company a,lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$company' and b.party_type in(26) and c.status_active=1 and c.is_deleted=0 order by c.supplier_name",'id,supplier_name', 1, '-- Select Supplier --',$supplier,'',0);
	}
	else if($item_category==32)
	{
		echo create_drop_down( "cbo_supplier_id", 151,"select DISTINCT(c.supplier_name),c.id from lib_supplier_tag_company a,lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$company' and b.party_type in(92) and c.status_active=1 and c.is_deleted=0 order by c.supplier_name",'id,supplier_name', 1, '-- Select Supplier --',$supplier,'',0);
	}
	else
	{
		echo create_drop_down( "cbo_supplier_id", 151,"select DISTINCT(c.supplier_name),c.id from  lib_supplier_tag_company a,lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$company' and b.party_type = 7 and c.status_active=1 and c.is_deleted=0 order by c.supplier_name",'id,supplier_name', 1, '-- Select Supplier --',$supplier,'',0);
	}
	exit();
}

if ($action=="load_drop_down_buyer")
{
	if($data != 0)
	{
		echo create_drop_down( "cbo_buyer_name", 150, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 $buyer_cond and b.buyer_id=buy.id and b.tag_company='$data' and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90)) order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "load_drop_down( 'requires/pi_controller_urmi', this.value, 'load_drop_down_season', 'season_td');load_drop_down( 'requires/pi_controller_urmi', this.value, 'load_drop_down_brand', 'brand_td');" );
		exit();
	}
	else{
		echo create_drop_down( "cbo_buyer_name", 150, "select distinct buy.id, buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id $buyer_cond and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90)) order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "load_drop_down( 'requires/pi_controller_urmi', this.value, 'load_drop_down_season', 'season_td');load_drop_down( 'requires/pi_controller_urmi', this.value, 'load_drop_down_brand', 'brand_td');" );
		exit();
	}
}

if ($action=="load_drop_down_season")
{
	echo create_drop_down( "cbo_season_id", 150, "select id, season_name from lib_buyer_season where buyer_id='$data' and status_active =1 and is_deleted=0 order by season_name ASC","id,season_name", 1, "-- Select Season--", "", "" );
	exit();
}
if ($action=="load_drop_down_brand")
{
	 //echo "select id, brand_name from lib_buyer_brand brand where buyer_id='$data' and status_active =1 and is_deleted=0 $brand_id_cond order by brand_name ASC";
	echo create_drop_down( "cbo_brand_id", 150, "select id, brand_name from lib_buyer_brand brand where buyer_id='$data' and status_active =1 and is_deleted=0 $brand_cond order by brand_name ASC","id,brand_name", 1, "--Brand--", $selected, "" );
	exit();
}

if ($action=="save_update_delete")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$goods_rcv_status=str_replace("'","",$cbo_goods_rcv_status);
	$item_cat_id=str_replace("'","",$cbo_item_category_id);
	$cross_check_activity_status=chop($cross_check_activity_status,",");
	if($goods_rcv_status==2)
	{
		$goods_rcv_variable=1;
	}
	else
	{
		$goods_rcv_variable=return_field_value("export_invoice_qty_source as source","variable_settings_commercial","company_name=$cbo_importer_id and variable_list=23 and status_active=1","source");
		if($goods_rcv_variable!=1) $goods_rcv_variable=2;
	}

	if(str_replace("'","",$export_pi_id)!="") $is_sales=1; else $is_sales=0;
	if ($operation==0)  // Insert Here
	{
		$control_piEntryAfterLastShipDate_variable=return_field_value("pi_source_btb_lc as source","variable_settings_commercial","company_name=$cbo_importer_id and variable_list=31 and status_active=1","source");
		if ($control_piEntryAfterLastShipDate_variable==1){
			if (str_replace("'","",$is_lc_sc) != ''){
				if (str_replace("'","",$is_lc_sc)==1) $lastShipmentDate=return_field_value("last_shipment_date","com_export_lc","id=$lc_sc_id","last_shipment_date");
				else if (str_replace("'","",$is_lc_sc)==2) $lastShipmentDate=return_field_value("last_shipment_date","com_sales_contract","id=$lc_sc_id","last_shipment_date");

				$piDate = date("Y-m-d", strtotime(str_replace("'", "",  $pi_date)));
				$lastShipmentDate = date("Y-m-d", strtotime($lastShipmentDate));

				if ($piDate > $lastShipmentDate){
					echo "20**PI Date is less than or equal to LC Last shipment date"; die;
				}
			}
		}
		
		

		//if (is_duplicate_field( "pi_number", "com_pi_master_details", "pi_number=$pi_number and importer_id=$cbo_importer_id and supplier_id=$cbo_supplier_id and status_active=1 and is_deleted=0" ) == 1)
		if (is_duplicate_field( "pi_number", "com_pi_master_details", "pi_number=$pi_number and importer_id=$cbo_importer_id and status_active=1 and is_deleted=0" ) == 1)
		{
			echo "11**0"; die;
		}
		else
		{
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}

			$id=return_next_id( "id", "com_pi_master_details", 1 );


			if(str_replace("'", '', $export_pi_id)>0)
			{
				$field_array_dtls="id, pi_id, work_order_no, work_order_id, work_order_dtls_id, determination_id, fabric_construction, fabric_composition, buyer_style_ref, color_id, gsm, dia_width, uom, quantity, rate, amount, net_pi_rate, net_pi_amount, item_category_id, after_goods_source, inserted_by, insert_date, is_sales, booking_no, item_group, item_description, size_id, item_color, body_part_id, gmts_item_id, embell_name, embell_type";
				$idDtls=return_next_id( "id","com_pi_item_details", 1 ) ;

				$is_import_pi=1;$woDtlsTrsansId='';
				for($i=1;$i<=$total_row;$i++)
				{
					$workOrderNo="workOrderNo_".$i;
					$workOrderId="hideWoId_".$i;
					$workOrderDtlsId="hideWoDtlsId_".$i;
					$bookingNo="bookingNo_".$i;
					$styleRef="styleRef_".$i;
					$determinationId="hideDeterminationId_".$i;
					$itemgroupid="itemgroupid_".$i;
					$itemgroupidPlace="itemgroupidPlace_".$i;
					$gmtsItem="gmtsItem_".$i;
					$gmtsItemPlace="gmtsItemPlace_".$i;
					$construction="construction_".$i;
					$composition="composition_".$i;
					$itemdescription="itemdescription_".$i;
					$itemColor="itemColor_".$i;
					$aopColor="aopColor_".$i;
					$aopColorPlace="aopColorPlace_".$i;
					$itemSize="itemSize_".$i;
					$itemSizePlace="itemSizePlace_".$i;
					$bodyPart="bodyPart_".$i;
					$bodyPartPlace="bodyPartPlace_".$i;
					$embName="embName_".$i;
					$embNamePlace="embNamePlace_".$i;
					$embType="embType_".$i;
					$embTypePlace="embTypePlace_".$i;

					$gsm="gsm_".$i;
					$diawidth="diawidth_".$i;
					$quantity="quantity_".$i;
					$rate="rate_".$i;
					$ratePlace="ratePlace_".$i;
					$amount="amount_".$i;
					$amountPlace="amountPlace_".$i;
					$bookingWithoutOrder="bookingWithoutOrder_".$i;

					if($item_cat_id==2)
					{
						$colorId="colorId_".$i;
						$uom="uom_".$i;
						$perc=(str_replace("'","",$$amount)/str_replace("'","",$txt_total_amount))*100;
						$net_pi_amount=($perc*str_replace("'","",$txt_total_amount_net))/100;
						$net_pi_rate=$net_pi_amount/str_replace("'","",$$quantity);

						if(str_replace("'","",$cbo_currency_id)==1)
							$net_pi_amount=number_format($net_pi_amount,$dec_place[4],'.','');
						else
							$net_pi_amount=number_format($net_pi_amount,$dec_place[5],'.','');

						$net_pi_rate=number_format($net_pi_rate,$dec_place[3],'.','');
					}
					else if($item_cat_id==3)
					{
						$colorId="colorId_".$i;
						$uom="uom_".$i;
						$net_pi_amount=number_format(str_replace("'","",$$amount),$dec_place[5],'.','');
						$net_pi_rate=number_format(str_replace("'","",$$rate),$dec_place[3],'.','');
					}
					else
					{
						$colorId="itemColorPlace_".$i;
						$uom="uomPlace_".$i;
						$net_pi_rate=str_replace("'","",$$ratePlace);
						$net_pi_amount=str_replace("'","",$$amountPlace);
					}

					$wotransId=str_replace("'","",$$workOrderDtlsId);
					if($woDtlsTrsansId=='') $woDtlsTrsansId=$wotransId;else $woDtlsTrsansId.=','.$wotransId;

					//if($data_array_dtls!="") $data_array_dtls.=","; booking_no, item_group, item_description, size_id, item_color, body_part_id, gmts_item_id, embell_name, embell_type
					$data_array_dtls[$idDtls]="(".$idDtls.",".$id.",'".str_replace("'","",$$workOrderNo)."','".str_replace("'","",$$workOrderId)."','".str_replace("'","",$$workOrderDtlsId)."','".str_replace("'","",$$determinationId)."','".str_replace("'","",$$construction)."','".str_replace("'","",$$composition)."','".str_replace("'","",$$styleRef)."','".str_replace("'","",$$colorId)."','".str_replace("'","",$$gsm)."','".str_replace("'","",$$diawidth)."','".str_replace("'","",$$uom)."',".$$quantity.",".$$rate.",".$$amount.",".$net_pi_rate.",".$net_pi_amount.",".$cbo_item_category_id.",'".$goods_rcv_variable."',".$user_id.",'".$pc_date_time."','".$is_sales."','".str_replace("'","",$$bookingNo)."','".str_replace("'","",$$itemgroupidPlace)."','".str_replace("'","",$$itemdescription)."','".str_replace("'","",$$itemSizePlace)."','".str_replace("'","",$$aopColorPlace)."','".str_replace("'","",$$bodyPartPlace)."','".str_replace("'","",$$gmtsItemPlace)."','".str_replace("'","",$$embNamePlace)."','".str_replace("'","",$$embTypePlace)."')";

					$idDtls=$idDtls+1;

				}
			}
			else
			{
				$is_import_pi=0;
			}
			
			$entry_form =$category_wise_entry_form[str_replace("'", '',$cbo_item_category_id)];


			$field_array="id,item_category_id,importer_id,supplier_id,pi_number,pi_date,last_shipment_date,pi_validity_date,currency_id,source,hs_code,internal_file_no,is_lc_sc,lc_sc_id,lc_sc_no,file_year,intendor_name,pi_basis_id,remarks,goods_rcv_status,export_pi_id,within_group,total_amount,upcharge,discount,net_total_amount,import_pi,ready_to_approved,approval_user,inserted_by,insert_date,lc_group_no,entry_form,version,after_goods_source,beneficiary,priority_id,pay_term,tenor,pi_for,nagotiate_by,pi_notes,pi_inhand_date,location_id,buyer_id,brand_id,season_year_id,season_id,lc_req_date,order_file_no";

			$data_array="(".$id.",".$cbo_item_category_id.",".$cbo_importer_id.",".$cbo_supplier_id.",".$pi_number.",".$pi_date.",".$last_shipment_date.",".$pi_validity_date.",".$cbo_currency_id.",".$cbo_source_id.",".$hs_code.",".$txt_internal_file_no.",".$is_lc_sc.",".$lc_sc_id.",".$lc_sc_no.",".$lc_sc_file_year.",".$intendor_name.",".$cbo_pi_basis_id.",".$txt_remarks.",".$cbo_goods_rcv_status.",".$export_pi_id.",".$within_group.",'".str_replace("'", '', $txt_total_amount)."','".str_replace("'", '', $txt_upcharge)."','".str_replace("'", '', $txt_discount)."','".str_replace("'", '', $txt_total_amount_net)."',".$is_import_pi.",".$cbo_ready_to_approved.",".$hiddn_user_id.",".$user_id.",'".$pc_date_time."',".$txt_lc_group_no.",".$entry_form.",1,'".$goods_rcv_variable."',".$txt_beneficiary_name.",".$cbo_priority.",".$cbo_payterm_id.",".$txt_tenor.",".$cbo_pi_for.",".$cbo_nagotiate_by.",".$txt_notes.",".$pi_inhand_date.",".$cbo_location_name.",".$cbo_buyer_name.",".$cbo_brand_id.",".$cbo_season_year.",".$cbo_season_id.",".$lc_req_date.",".$txt_order_file_no.")";

			$activity_next_id=return_next_id( "id", "com_cross_check_activity", 1 );

			$field_array_check_activity="id,pi_id,pi_no,cross_check_activity_ids,item_category_id,importer_name,supplier_name, inserted_by,insert_date,entry_form";

			$data_array_check_activity="(".$activity_next_id.",".$id.",".$pi_number.",'".$cross_check_activity_status."',".$cbo_item_category_id.",".$cbo_importer_id.",".$cbo_supplier_id.",".$user_id.",'".$pc_date_time."',".$entry_form.")";

			//echo "5**insert into com_cross_check_activity (".$field_array_check_activity.") values ".$data_array_check_activity;die;
			//echo "10**$cbo_location_name";

			//echo "5**insert into com_pi_master_details (".$field_array.") values ".$data_array;oci_rollback($con);disconnect($con);die;
			$rID=sql_insert("com_pi_master_details",$field_array,$data_array,1);
			
			$rID3=sql_insert("com_cross_check_activity",$field_array_check_activity,$data_array_check_activity,1);

			$rID2=true;
			if($data_array_dtls!="")
			{
				//$rID2=sql_insert("com_pi_item_details",$field_array_dtls,$data_array_dtls,0);



				$data_set=array_chunk($data_array_dtls,200);
				foreach( $data_set as $setRows)
				{
					//echo "5** insert into com_pi_item_details ($field_array) values ".implode(",",$setRows);die;
					$rID2=sql_insert("com_pi_item_details",$field_array_dtls,implode(",",$setRows),0);

					//echo "5**".$rID;die;
					//$rID=sql_insert("com_pi_item_details",$field_array,$data_array,0);

					if($rID2==0)
					{
						break;
					}
				}


			}

			//oci_rollback($con);
		    //echo "10**".$rID."##".$rID2."##".$rID3;oci_rollback($con);disconnect($con);die;
		    //echo "5**insert into com_pi_item_details (".$field_array.") values ".$data_array;die;
			if($db_type==0)
			{
				if($rID && $rID2 && $rID3)
				{
					mysql_query("COMMIT");
					echo "0**".$id;
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "5**0";
				}
			}
			else if($db_type==2 || $db_type==1 )
			{
				if($rID && $rID2 && $rID3)
				{
					oci_commit($con);
					echo "0**".$id;
				}
				else
				{
					oci_rollback($con);
					echo "5**0";
				}
			}
			disconnect($con);
			die;
		}
	}
	else if ($operation==1)   // Update Here
	{
		$sql_app=sql_select("select approved from com_pi_master_details where id=$update_id and approved in(1,3)");
		if(count($sql_app)>0)
		{
			echo "16**1**1";
			die;
		}

		//###### Descuss with siddiq sir update facility consider ######///////
		/*$sql_attach=sql_select("select a.lc_number from com_btb_lc_master_details a, com_btb_lc_pi b where a.id=b.com_btb_lc_master_details_id and b.pi_id=$update_id and b.status_active=1 and b.is_deleted=0 group by a.id, a.lc_number");
		if(count($sql_attach)>0)
		{
			$lc_number=$sql_attach[0][csf('lc_number')];
			echo "14**This PI is Attached With BTB LC No- '".$lc_number."'. So You can not change it**1";
			die;
		}

		$sql_attach_mrr=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b where a.id=b.mst_id and b.pi_wo_batch_no=$update_id and b.receive_basis=1 and b.status_active=1 and b.is_deleted=0 group by a.id, a.recv_number");
		if(count($sql_attach_mrr)>0)
		{
			$recv_number='';
			foreach($sql_attach_mrr as $row)
			{
				$recv_number.=$row[csf('recv_number')].",";
			}

			echo "14**This PI is Attached With MRR No- '".chop($recv_number,',')."'. So You can not change it**1";
			die;
		}*/
		//echo "SELECT pi_number FROM com_pi_master_details WHERE pi_number=$pi_number and importer_id=$cbo_importer_id and supplier_id=$cbo_supplier_id and id!=$update_id and status_active=1 and is_deleted=0";die;

		$validate_piSentToApproval_variable=return_field_value("pi_source_btb_lc as source","variable_settings_commercial","company_name=$cbo_importer_id and item_category=$cbo_item_category_id and variable_list=30 and status_active=1","source");

		if ($validate_piSentToApproval_variable==1)
		{
			if (str_replace("'", '',$cbo_ready_to_approved)==1 && str_replace("'", '',$lc_sc_id)!='')
			{
				if (str_replace("'", '',$is_lc_sc)==1)
				{
					$sql_lc_order="select b.wo_po_break_down_id as order_attach, a.export_lc_no as lc_sc_no 
					from com_export_lc a, com_export_lc_order_info b where a.id=b.com_export_lc_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.id=$lc_sc_id 
					group by b.wo_po_break_down_id, a.export_lc_no";
				}
				else
				{
					$sql_lc_order="select b.wo_po_break_down_id as order_attach, a.contract_no as lc_sc_no 
					from com_sales_contract a, com_sales_contract_order_info b where a.id=b.com_sales_contract_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.id=$lc_sc_id 
					group by b.wo_po_break_down_id, a.contract_no";
				}
				//echo "15**".$sql_lc_order;die;
				$sql_lc_order_attach=sql_select($sql_lc_order);
				$order_attach_arr=array();
				foreach ($sql_lc_order_attach as $val) {
					$order_attach_arr[$val[csf('order_attach')]]=$val[csf('order_attach')];
					//$attach_lcSc_arr[$val[csf('order_attach')]]=$val[csf('lc_sc_no')];
				}			

				if(str_replace("'", '',$cbo_item_category_id)==1)  //Yarn
				{
					$sql_order=sql_select("select e.id as order_id, e.po_number, d.job_no, d.style_ref_no 
					from com_pi_item_details b, wo_non_order_info_dtls c, wo_po_details_master d, wo_po_break_down e 
					where b.work_order_dtls_id=c.id and c.job_no=d.job_no and d.job_no=e.job_no_mst and b.pi_id=$update_id and d.company_name=$cbo_importer_id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.item_category_id=$cbo_item_category_id and c.item_category_id=$cbo_item_category_id 
					group by e.id,e.po_number, d.job_no, d.style_ref_no
					order by d.job_no");
				}
				else if(str_replace("'", '',$cbo_item_category_id)==2 || str_replace("'", '',$cbo_item_category_id)==3) //Knit finish fabric,Woven finish fabric
				{
					$sql_order=sql_select("select e.id as order_id, e.po_number, d.job_no, d.style_ref_no 
					from com_pi_item_details b, wo_booking_dtls c, wo_po_details_master d, wo_po_break_down e 
					where b.work_order_no=c.booking_no and c.job_no=d.job_no and d.job_no=e.job_no_mst and c.po_break_down_id=e.id and b.pi_id=$update_id and d.company_name=$cbo_importer_id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.item_category_id in($cbo_item_category_id) 
					group by e.id, e.po_number, d.job_no, d.style_ref_no
					order by d.job_no");
				}
				else if(str_replace("'", '',$cbo_item_category_id)==4 || str_replace("'", '',$cbo_item_category_id)==12 || str_replace("'", '',$cbo_item_category_id)==25) //Accessories,Services - Fabric,Services - Embellishment
				{
					$sql_order=sql_select("select e.id as order_id, e.po_number, d.job_no, d.style_ref_no 
					from com_pi_item_details b, wo_booking_dtls c, wo_po_details_master d, wo_po_break_down e 
					where b.work_order_dtls_id=c.id and c.job_no=d.job_no and d.job_no=e.job_no_mst and c.po_break_down_id=e.id and b.pi_id=$update_id and d.company_name=$cbo_importer_id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.item_category_id=$cbo_item_category_id 
					group by e.id, e.po_number, d.job_no, d.style_ref_no
					order by d.job_no");
				}
				else if(str_replace("'", '',$cbo_item_category_id)==24) //Services - Yarn
				{
					$sql_order=sql_select("select e.id as order_id, e.po_number, d.job_no, d.style_ref_no 
					from com_pi_item_details b, wo_yarn_dyeing_dtls c, wo_po_details_master d, wo_po_break_down e 
					where b.work_order_dtls_id=c.id and c.job_no=d.job_no and d.job_no=e.job_no_mst and b.pi_id=$update_id and d.company_name=$cbo_importer_id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.item_category_id=$cbo_item_category_id 
					group by e.id, e.po_number, d.job_no, d.style_ref_no
					order by d.job_no");
				}
				else if(str_replace("'", '',$cbo_item_category_id)==31) //Services Lab Test 
				{
					$sql_order=sql_select("select e.id as order_id, e.po_number, d.job_no, d.style_ref_no 
					from com_pi_item_details b, wo_labtest_dtls c, wo_po_details_master d, wo_po_break_down e 
					where b.work_order_id=c.mst_id and c.job_no=d.job_no and d.job_no=e.job_no_mst and b.pi_id=$update_id and d.company_name=$cbo_importer_id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.item_category_id=$cbo_item_category_id 
					group by e.id, e.po_number, d.job_no, d.style_ref_no
					order by d.job_no");
				}

				$order_id_arr=array();
				$order_no_arr=array();
				foreach ($sql_order as $val) {
					$order_id_arr[$val[csf('order_id')]]=$val[csf('order_id')];
					$order_no_arr[$val[csf('order_id')]]['po_number']=$val[csf('po_number')];
					$order_no_arr[$val[csf('order_id')]]['job_no']=$val[csf('job_no')];
					$order_no_arr[$val[csf('order_id')]]['style_ref_no']=$val[csf('style_ref_no')];
				}

				$oder_diff_arr=array_diff($order_id_arr,$order_attach_arr);
				$msg_lc_sc="";
				$selected_lc=return_field_value("lc_sc_no", "com_pi_master_details","id=$update_id","lc_sc_no");
				if (!empty($oder_diff_arr))
				{
					foreach ($oder_diff_arr as $order_id) 
					{
						$order_NOs=$order_no_arr[$order_id].', ';
						$msg_lc_sc.="Following Job : ".$order_no_arr[$order_id]['job_no'].", Style : ".$order_no_arr[$order_id]['style_ref_no'].", Order : ".$order_no_arr[$order_id]['po_number']." are not found in selected LC/SC : ".$selected_lc."\n";
					}
					//$order_NOs=rtrim($order_NOs, ', ');
					
					echo "15** $msg_lc_sc";disconnect($con);die;
				}
				
				//15**
			}
		}	
		
		if(is_duplicate_field("pi_number", "com_pi_master_details","pi_number=$pi_number and importer_id=$cbo_importer_id and supplier_id=$cbo_supplier_id and id!=$update_id and status_active=1 and is_deleted=0")==1)
		{
			echo "11**0"; die;
		}
		else
		{
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}


			$field_array="pi_number*pi_date*last_shipment_date*pi_validity_date*currency_id*source*hs_code*internal_file_no*is_lc_sc*lc_sc_id*lc_sc_no*file_year*intendor_name*pi_basis_id*remarks*goods_rcv_status*total_amount*upcharge*discount*net_total_amount*ready_to_approved*approval_user*updated_by*update_date*lc_group_no*beneficiary*priority_id*pay_term*tenor*pi_for*nagotiate_by*pi_notes*pi_inhand_date*location_id*buyer_id*brand_id*season_year_id*season_id*lc_req_date*order_file_no";
			
			$data_array=$pi_number."*".$pi_date."*".$last_shipment_date."*".$pi_validity_date."*".$cbo_currency_id."*".$cbo_source_id."*".$hs_code."*".$txt_internal_file_no."*".$is_lc_sc."*".$lc_sc_id."*".$lc_sc_no."*".$lc_sc_file_year."*".$intendor_name."*".$cbo_pi_basis_id."*".$txt_remarks."*".$cbo_goods_rcv_status."*".$txt_total_amount."*".$txt_upcharge."*".$txt_discount."*".$txt_total_amount_net."*".$cbo_ready_to_approved."*".$hiddn_user_id."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*".$txt_lc_group_no."*".$txt_beneficiary_name."*".$cbo_priority."*".$cbo_payterm_id."*".$txt_tenor."*".$cbo_pi_for."*".$cbo_nagotiate_by."*".$txt_notes."*".$pi_inhand_date."*".$cbo_location_name."*".$cbo_buyer_name."*".$cbo_brand_id."*".$cbo_season_year."*".$cbo_season_id."*".$lc_req_date."*".$txt_order_file_no."";

			//echo "5**".$data_array; die;

			if(str_replace("'", '', $export_pi_id)>0)
			{
				$field_array_update="work_order_no*work_order_id*work_order_dtls_id*determination_id*fabric_construction*fabric_composition*buyer_style_ref*color_id*gsm*dia_width*uom*quantity*rate*amount*net_pi_rate*net_pi_amount*item_category_id*updated_by*update_date*booking_no*item_group*item_description*size_id*item_color*body_part_id*gmts_item_id*embell_name*embell_type";
				$field_array_dtls="id,pi_id,work_order_no,work_order_id,work_order_dtls_id,determination_id,fabric_construction,fabric_composition,buyer_style_ref,color_id,gsm,dia_width,uom,quantity,rate,amount,net_pi_rate,net_pi_amount,item_category_id,inserted_by,insert_date, is_sales, booking_no, item_group, item_description, size_id, item_color, body_part_id, gmts_item_id, embell_name, embell_type";
				$idDtls=return_next_id( "id","com_pi_item_details", 1 ) ;

				$data_array_dtls='';
				for($i=1;$i<=$total_row;$i++)
				{
					$updateIdDtls="updateIdDtls_".$i;
					$workOrderNo="workOrderNo_".$i;
					$workOrderId="hideWoId_".$i;
					$workOrderDtlsId="hideWoDtlsId_".$i;
					$bookingNo="bookingNo_".$i;
					$styleRef="styleRef_".$i;
					$determinationId="hideDeterminationId_".$i;
					$itemgroupid="itemgroupid_".$i;
					$itemgroupidPlace="itemgroupidPlace_".$i;
					$gmtsItem="gmtsItem_".$i;
					$gmtsItemPlace="gmtsItemPlace_".$i;
					$construction="construction_".$i;
					$composition="composition_".$i;
					$itemdescription="itemdescription_".$i;
					$itemColor="itemColor_".$i;
					$aopColor="aopColor_".$i;
					$aopColorPlace="aopColorPlace_".$i;
					$itemSize="itemSize_".$i;
					$itemSizePlace="itemSizePlace_".$i;
					$bodyPart="bodyPart_".$i;
					$bodyPartPlace="bodyPartPlace_".$i;
					$embName="embName_".$i;
					$embNamePlace="embNamePlace_".$i;
					$embType="embType_".$i;
					$embTypePlace="embTypePlace_".$i;

					$gsm="gsm_".$i;
					$diawidth="diawidth_".$i;
					$quantity="quantity_".$i;
					$rate="rate_".$i;
					$ratePlace="ratePlace_".$i;
					$amount="amount_".$i;
					$amountPlace="amountPlace_".$i;
					$bookingWithoutOrder="bookingWithoutOrder_".$i;

					if($item_cat_id==2)
					{
						$colorId="colorId_".$i;
						$uom="uom_".$i;
						$perc=(str_replace("'","",$$amount)/str_replace("'","",$txt_total_amount))*100;
						$net_pi_amount=($perc*str_replace("'","",$txt_total_amount_net))/100;
						$net_pi_rate=$net_pi_amount/str_replace("'","",$$quantity);

						if(str_replace("'","",$cbo_currency_id)==1)
							$net_pi_amount=number_format($net_pi_amount,$dec_place[4],'.','');
						else
							$net_pi_amount=number_format($net_pi_amount,$dec_place[5],'.','');

						$net_pi_rate=number_format($net_pi_rate,$dec_place[3],'.','');
					}
					else
					{
						$colorId="itemColorPlace_".$i;
						$uom="uomPlace_".$i;
						$net_pi_rate=str_replace("'","",$$ratePlace);
						$net_pi_amount=str_replace("'","",$$amountPlace);
					}

					$wotransId=str_replace("'","",$$workOrderDtlsId);
					if($woDtlsTrsansId=='') $woDtlsTrsansId=$wotransId;else $woDtlsTrsansId.=','.$wotransId;

					/*$updateIdDtls="updateIdDtls_".$i;
					$workOrderNo="workOrderNo_".$i;
					$workOrderId="hideWoId_".$i;
					$workOrderDtlsId="hideWoDtlsId_".$i;
					$determinationId="hideDeterminationId_".$i;
					$construction="construction_".$i;
					$composition="composition_".$i;
					$colorId="colorId_".$i;
					$gsm="gsm_".$i;
					$diawidth="diawidth_".$i;
					$uom="uom_".$i;
					$quantity="quantity_".$i;
					$rate="rate_".$i;
					$amount="amount_".$i;

					$perc=(str_replace("'","",$$amount)/str_replace("'","",$txt_total_amount))*100;
					$net_pi_amount=($perc*str_replace("'","",$txt_total_amount_net))/100;
					$net_pi_rate=$net_pi_amount/str_replace("'","",$$quantity);

					if(str_replace("'","",$cbo_currency_id)==1)
						$net_pi_amount=number_format($net_pi_amount,$dec_place[4],'.','');
					else
						$net_pi_amount=number_format($net_pi_amount,$dec_place[5],'.','');

					$net_pi_rate=number_format($net_pi_rate,$dec_place[3],'.','');*/

					if(str_replace("'","",$$updateIdDtls)!="")
					{
						$id_arr[]=str_replace("'",'',$$updateIdDtls);
						$data_array_update[str_replace("'",'',$$updateIdDtls)] = explode("*",("'".str_replace("'","",$$workOrderNo)."'*'".str_replace("'","",$$workOrderId)."'*'".str_replace("'","",$$workOrderDtlsId)."'*'".str_replace("'","",$$determinationId)."'*'".str_replace("'","",$$construction)."'*'".str_replace("'","",$$composition)."'*'".str_replace("'","",$$styleRef)."'*'".str_replace("'","",$$colorId)."'*'".str_replace("'","",$$gsm)."'*'".str_replace("'","",$$diawidth)."'*'".str_replace("'","",$$uom)."'*".$$quantity."*".$$rate."*".$$amount."*".$net_pi_rate."*".$net_pi_amount."*".$cbo_item_category_id."*".$user_id."*'".$pc_date_time."'*'".str_replace("'","",$$bookingNo)."'*'".str_replace("'","",$$itemgroupidPlace)."'*'".str_replace("'","",$$itemdescription)."'*'".str_replace("'","",$$itemSizePlace)."'*'".str_replace("'","",$$aopColorPlace)."'*'".str_replace("'","",$$bodyPartPlace)."'*'".str_replace("'","",$$gmtsItemPlace)."'*'".str_replace("'","",$$embNamePlace)."'*'".str_replace("'","",$$embTypePlace)."'"));
					}
					else
					{
						if($data_array_dtls!="") $data_array_dtls.=",";
						$data_array_dtls.="(".$idDtls.",".$update_id.",'".str_replace("'","",$$workOrderNo)."','".str_replace("'","",$$workOrderId)."','".str_replace("'","",$$workOrderDtlsId)."','".str_replace("'","",$$determinationId)."','".str_replace("'","",$$construction)."','".str_replace("'","",$$composition)."','".str_replace("'","",$$styleRef)."','".str_replace("'","",$$colorId)."','".str_replace("'","",$$gsm)."','".str_replace("'","",$$diawidth)."','".str_replace("'","",$$uom)."',".$$quantity.",".$$rate.",".$$amount.",".$net_pi_rate.",".$net_pi_amount.",".$cbo_item_category_id.",".$user_id.",'".$pc_date_time."','".$is_sales."','".str_replace("'","",$$bookingNo)."','".str_replace("'","",$$itemgroupidPlace)."','".str_replace("'","",$$itemdescription)."','".str_replace("'","",$$itemSizePlace)."','".str_replace("'","",$$aopColorPlace)."','".str_replace("'","",$$bodyPartPlace)."','".str_replace("'","",$$gmtsItemPlace)."','".str_replace("'","",$$embNamePlace)."','".str_replace("'","",$$embTypePlace)."')";
						$idDtls=$idDtls+1;
					}
				}
			}

			$entry_form =$category_wise_entry_form[str_replace("'", '',$cbo_item_category_id)];
			//$cross_check_items = return_field_value("cross_check_activity_ids","com_cross_check_activity","pi_id=$pi_id and status_active=1","cross_check_activity_ids");
			//$update_activity_id=return_field_value( "id", "com_cross_check_activity", 1 );

			$field_array_check_activity="cross_check_activity_ids*pi_no*updated_by*update_date";

			$data_array_check_activity=$cross_check_activity_status."*".$pi_number."*".$user_id."*'".$pc_date_time."'";

			$update_activity_id = str_replace("'","",$update_activity_id);//die;

			$rID=sql_update("com_pi_master_details",$field_array,$data_array,"id",$update_id,1);


			//$rID4=sql_update("com_cross_check_activity",$field_array_check_activity,$data_array_check_activity,"id",$update_activity_id,1);
			$rID4=sql_update("com_cross_check_activity",$field_array_check_activity,$data_array_check_activity,"pi_id",$update_id,1);
			//$update_activity_id
			//echo "10**$rID4";die;
			$rID2=true; $rID3=true;
			if(count($data_array_update)>0)
			{
				$rID2=execute_query(bulk_update_sql_statement( "com_pi_item_details", "id", $field_array_update, $data_array_update, $id_arr ));
			}

			if($data_array_dtls!="")
			{
				$rID3=sql_insert("com_pi_item_details",$field_array_dtls,$data_array_dtls,0);
			}
			//echo "10**".$rID ."&&". $rID2 ."&&". $rID3."&&". $rID4."&&". $update_id;die;

			if($db_type==0)
			{
				if($rID && $rID2 && $rID3 && $rID4)
				{
					mysql_query("COMMIT");
					echo "1**".str_replace("'", '', $update_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "6**".str_replace("'", '', $update_id);
				}
			}
			else if($db_type==2 || $db_type==1 )
			{
				if($rID && $rID2 && $rID3 && $rID4)
				{
					oci_commit($con);
					echo "1**".str_replace("'", '', $update_id);
				}
				else
				{
					oci_rollback($con);
					echo "6**".str_replace("'", '', $update_id);
				}
			}

			disconnect($con);
			die;
		}
	}
	else if ($operation==2)   // Delete Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$sql_app=sql_select("select approved from com_pi_master_details where id=$update_id and approved in(1,3)");
		if(count($sql_app)>0)
		{
			echo "16**1**1";disconnect($con);die;
		}

		$pi_from_export=return_field_value("import_pi","com_pi_master_details","id = $update_id and status_active=1 and is_deleted=0","import_pi");
		if($pi_from_export !="1")
		{
			//$update_id
			$sql_pi_dtls=sql_select("select b.id from com_pi_item_details b where b.pi_id=$update_id and b.status_active=1 and b.is_deleted=0");
			if(count($sql_pi_dtls)>0)
			{
				echo "14**Please Details Part Delete First.**1";disconnect($con);die;
			}
		}

		$sql_attach=sql_select("select a.lc_number from com_btb_lc_master_details a, com_btb_lc_pi b where a.id=b.com_btb_lc_master_details_id and b.pi_id=$update_id and b.status_active=1 and b.is_deleted=0 group by a.id, a.lc_number");
		if(count($sql_attach)>0)
		{
			$lc_number=$sql_attach[0][csf('lc_number')];
			echo "14**This PI is Attached With BTB LC No- '".$lc_number."'. So You can not delete it**1";disconnect($con); die;
		}
		if(str_replace("'","",$cbo_goods_rcv_status)!=1)
		{
			$sql_attach_mrr=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b where a.id=b.mst_id and b.pi_wo_batch_no=$update_id and a.receive_basis=1 and b.receive_basis=1 and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and b.item_category=$cbo_item_category_id group by a.id, a.recv_number");
			if(count($sql_attach_mrr)>0)
			{
				$recv_number='';
				foreach($sql_attach_mrr as $row)
				{
					$recv_number.=$row[csf('recv_number')].",";
				}

				echo "14**This PI is Attached With MRR No- '".chop($recv_number,',')."'. So You can not delete it**1";disconnect($con);
				die;
			}
		}

		$field_array="status_active*is_deleted*updated_by*update_date";
		$data_array="0*1*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'";

		$rID=sql_update("com_pi_master_details",$field_array,$data_array,"id",$update_id,0);

		$field_array_dtls="status_active*is_deleted*updated_by*update_date";
		$data_array_dtls="0*1*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'";

		$rID2=sql_update("com_pi_item_details",$field_array_dtls,$data_array_dtls,"pi_id",$update_id,1);

		if($db_type==0)
		{
			if($rID && $rID2)
			{
				mysql_query("COMMIT");
				echo "2**0";
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "7**".str_replace("'", '', $update_id);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID && $rID2)
			{
				oci_commit($con);
				echo "2**0";
			}
			else
			{
				oci_rollback($con);
				echo "7**".str_replace("'", '', $update_id);
			}
		}

		disconnect($con);
		die;
	}
}


if($action=="load_drop_down_importer")
{
	if($data==1)
	{
		echo create_drop_down( "cbo_importer", 151, "select comp.id, comp.company_name from lib_company comp where comp.status_active=1 and comp.is_deleted=0 $company_cond order by comp.company_name","id,company_name",1, "-- Select Importer --", "0", "",0 );
	}
	else if($data==2)
	{
		echo create_drop_down( "cbo_importer", 151, "select buy.id, buy.buyer_name from lib_buyer buy where buy.status_active =1 and buy.is_deleted=0 $buyer_cond order by buy.buyer_name","id,buyer_name", 1, "-- Select Importer --", $selected, "",0 );
	}
	else
	{
		echo create_drop_down( "cbo_importer", 151, $blank_array,"",1, "-- Select Importer --", 0, "" );
	}
	exit();
}

if ($action=="load_drop_down_exporter")
{
	echo create_drop_down( "cbo_supplier_id", 151,"select DISTINCT(c.supplier_name),c.id from  lib_supplier_tag_company a,lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$data[0]' and b.party_type =2 and c.status_active=1 and c.is_deleted=0",'id,supplier_name', 1, '-- Select Supplier --',0,'',0);
	exit();
}

if ($action=="export_pi_popup")
{
	echo load_html_head_contents("PI Info", "../../../", 1, 1,'','','');
	extract($_REQUEST);
    ?>
	<script>

		function js_set_value(pi_id )
		{
			document.getElementById('txt_selected_data').value=pi_id;
			parent.emailwindow.hide();
		}

    </script>

	</head>

	<body>
	<div align="center" style="width:900px;">
	<form name="searchpifrm"  id="searchpifrm">
		<fieldset style="width:100%; margin-left:4px">
		<legend>Enter search words</legend>
            <table cellpadding="0" cellspacing="0" border="1" rules="all" width="800" class="rpt_table">
                <thead>
                    <th>Within Group</th>
                    <th>Importer</th>
                    <th>Export PI Number</th>
                    <th>Date Range</th>
                    <th>
                    	<input type="reset" name="reset" id="reset" value="Reset" style="width:100px" class="formbutton" />
                    	<input type="hidden" name="txt_selected_data" id="txt_selected_data" class="text_boxes" style="width:70px" value="">
                    </th>
                </thead>
                <tr class="general">
                    <td>
						<?php echo create_drop_down("cbo_within_group", 151, $yes_no, "", 1, "-- Select --", 0, "load_drop_down( 'pi_controller_urmi',this.value, 'load_drop_down_importer', 'importer_td' );"); ?>
                    </td>
                    <td id="importer_td">
						<?php echo create_drop_down("cbo_importer", 151, $blank_array, "", 1, "-- Select Importer --", 0, "", 0); ?>
                    </td>
                    <td>
                        <input type="text" name="txt_pi_no" id="txt_pi_no" class="text_boxes" style="width:120px">
                    </td>
                    <td align="center">
                      <input type="text" name="txt_date_from" id="txt_date_from" class="datepicker" style="width:70px">To
					  <input type="text" name="txt_date_to" id="txt_date_to" class="datepicker" style="width:70px">
					 </td>
            		 <td align="center">
                     	<input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('txt_pi_no').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('cbo_within_group').value+'_'+document.getElementById('cbo_importer').value+'_'+<? echo $item_category_id; ?>, 'create_export_pi_search_list_view', 'search_div', 'pi_controller_urmi', 'setFilterGrid(\'list_view\',-1)')" style="width:100px;" />
                     </td>
                </tr>
                <tr>
                	<td colspan="5" align="center" height="40" valign="middle"><? echo load_month_buttons(1); ?></td>
                </tr>
           </table>
           <div style="width:100%; margin-top:5px" id="search_div" align="left"></div>
		</fieldset>
	</form>
	</div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if($action=="create_export_pi_search_list_view")
{
	$data=explode('_',$data);
	$item_category_id=trim(str_replace("'","",$data[5]));
	//echo $item_category_id.test;die;

	if ($data[0]!="") $pi_number=" and pi_number like '%".trim($data[0])."%'"; else { $pi_number = ''; }
	if ($data[1]!="" &&  $data[2]!="")
	{
		if($db_type==0)
		{
			$pi_date = "and pi_date between '".change_date_format($data[1], "yyyy-mm-dd", "-")."' and '".change_date_format($data[2], "yyyy-mm-dd", "-")."'";
		}
		else
		{
			$pi_date = "and pi_date between '".change_date_format($data[1],'','',1)."' and '".change_date_format($data[2],'','',1)."'";
		}
	}
	else
	{
		$pi_date ="";
	}

	$cbo_within_group=$data[3];
	$cbo_importer=$data[4];
	if($cbo_within_group!=0) $within_group=" and within_group='".$cbo_within_group."'"; else { $within_group = ''; }
	if($cbo_importer!=0) $importer_cond=" and buyer_id='".$cbo_importer."'"; else { $importer_cond = ''; }

	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	//$arr=array (2=>$export_item_category,3=>$comp,4=>$yes_no);

	//echo create_list_view("list_view", "PI No,PI Date,Item Category,Exporter,Within Group,Last Shipment Date,HS Code", "150,80,80,150,80,120","880","270",0, $sql , "js_set_value", "id", "", 1, "0,0,item_category_id,exporter_id,within_group,0,0", $arr , "pi_number,pi_date,item_category_id,exporter_id,within_group,last_shipment_date,hs_code", "",'','0,3,0,0,0,3,0');

	$importPiArr=array();
	$importData=sql_select("select id,source,intendor_name,remarks,goods_rcv_status,export_pi_id,total_amount,upcharge,discount,net_total_amount,lc_group_no,ready_to_approved,location_id from com_pi_master_details where import_pi=1 and status_active=1 and is_deleted=0");
	foreach($importData as $rowI)
	{
		$importPiArr[$rowI[csf('export_pi_id')]]['id']=$rowI[csf('id')];
		$importPiArr[$rowI[csf('export_pi_id')]]['source']=$rowI[csf('source')];
		$importPiArr[$rowI[csf('export_pi_id')]]['intendor_name']=$rowI[csf('intendor_name')];
		$importPiArr[$rowI[csf('export_pi_id')]]['goods_rcv_status']=$rowI[csf('goods_rcv_status')];
		$importPiArr[$rowI[csf('export_pi_id')]]['remarks']=$rowI[csf('remarks')];
		$importPiArr[$rowI[csf('export_pi_id')]]['lc_group_no']=$rowI[csf('lc_group_no')];
		$importPiArr[$rowI[csf('export_pi_id')]]['ready_to_approved']=$rowI[csf('ready_to_approved')];
		$importPiArr[$rowI[csf('export_pi_id')]]['location_id']=$rowI[csf('location_id')];
		//$importPiArr[$rowI[csf('export_pi_id')]]['total_amount']=$rowI[csf('total_amount')];
		//$importPiArr[$rowI[csf('export_pi_id')]]['upcharge']=$rowI[csf('upcharge')];
		//$importPiArr[$rowI[csf('export_pi_id')]]['discount']=$rowI[csf('discount')];
		//$importPiArr[$rowI[csf('export_pi_id')]]['net_total_amount']=$rowI[csf('net_total_amount')];
	}

    $sql= "select id, pi_number, pi_date, item_category_id, exporter_id, buyer_id, within_group, last_shipment_date, hs_code, pi_validity_date, currency_id, upcharge, discount, internal_file_no, remarks, total_amount, net_total_amount
	from com_export_pi_mst
	where status_active=1 and is_deleted=0 and item_category_id in (".$maping_import_export_category[$item_category_id].") $within_group $importer_cond $pi_number $pi_date order by pi_number";
	//echo $sql.$item_category_id;
	?>
	<table width="895" cellpadding="0" cellspacing="0" border="1" class="rpt_table" rules="all">
        <thead>
            <th width="40">SL</th>
            <th width="90">PI No</th>
            <th width="80">PI Date</th>
            <th width="80">Item Category</th>
            <th width="75">Within Group</th>
            <th width="125">Importer</th>
            <th width="125">Exporter</th>
            <th width="105">Last Shipment Date</th>
            <th width="70">HS Code</th>
            <th>Import PI Id</th>
        </thead>
     </table>
     <div style="width:895px; overflow-y:scroll; max-height:280px">
     	<table width="875" cellpadding="0" cellspacing="0" border="1" class="rpt_table" rules="all" id="list_view">
		<?

			$data_array=sql_select($sql); $i = 1;
            foreach($data_array as $row)
            {
                if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";

				$importer='';
				if($row[csf('within_group')]==2)
				{
					$importer=$buyer_arr[$row[csf('buyer_id')]];
				}
				else
				{
					$importer=$comp[$row[csf('buyer_id')]];
				}

				$importPi_id=$importPiArr[$row[csf('id')]]['id'];
				$locationPi_id=$importPiArr[$row[csf('id')]]['location_id'];
				if($importPi_id>0) $remarks=$importPiArr[$row[csf('id')]]['remarks']; else $remarks=$row[csf('remarks')];

				$data=$row[csf('id')]."_".$row[csf('within_group')]."_".$row[csf('buyer_id')]."_".$row[csf('exporter_id')]."_".$row[csf('pi_number')]."_".change_date_format($row[csf('pi_date')])."_".change_date_format($row[csf('last_shipment_date')])."_".change_date_format($row[csf('pi_validity_date')])."_".$row[csf('currency_id')]."_".$row[csf('hs_code')]."_".$row[csf('internal_file_no')]."_".$remarks."_".$importer."_".$comp[$row[csf('exporter_id')]]."_".$row[csf('upcharge')]."_".$row[csf('discount')]."_".$row[csf('total_amount')]."_".$row[csf('net_total_amount')]."_".$importPi_id."_".$importPiArr[$row[csf('id')]]['source']."_".$importPiArr[$row[csf('id')]]['intendor_name']."_".$importPiArr[$row[csf('goods_rcv_status')]]['id']."_".$maping_export_import_category[$row[csf('item_category_id')]]."_".$export_item_category[$row[csf('item_category_id')]]."_".$importPiArr[$row[csf('id')]]['lc_group_no']."_".$importPiArr[$row[csf('id')]]['ready_to_approved']."_".$locationPi_id;
				?>
				<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer;" id="search<? echo $i;?>" onClick="js_set_value( '<? echo $data; ?>');">
                	<td width="40"><? echo $i; ?></td>
					<td width="90"><? echo $row[csf('pi_number')]; ?></td>
					<td width="80"><? echo change_date_format($row[csf('pi_date')]); ?></td>
                    <td width="80"><p><? echo $export_item_category[$row[csf('item_category_id')]]; ?></p></td>
					<td width="75" align="center"><? echo $yes_no[$row[csf('within_group')]]; ?></td>
                    <td width="125"><p><? echo $importer; ?></p></td>
                    <td width="125"><p><? echo $comp[$row[csf('exporter_id')]]; ?></p></td>
                    <td width="105" align="center"><? echo change_date_format($row[csf('last_shipment_date')]); ?>&nbsp;</td>
					<td width="70"><? echo $row[csf('hs_code')]; ?>&nbsp;</td>
                    <td><? echo $importPi_id; ?>&nbsp;</td>
				</tr>
            <?
				$i++;
            }
			?>
		</table>
    </div>
	<?
	exit();
}

$color_library=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name"  );
$size_library=return_library_array( "select id,size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name"  );

if( $action == 'export_pi_details' )
{
	$data=explode("**",$data);
	$export_id=$data[0];
	$upcharge=$data[1];
	$discount=$data[2];
	$total_amount=$data[3];
	$net_total_amount=$data[4];
	$item_catagory_id=$data[5];
	//echo $item_catagory_id.test;die;

	if($item_catagory_id==2) // Knit Finish Fabric
	{
		?>
        <table class="rpt_table" width="100%" cellspacing="0" cellpadding="0" border="1" rules="all" id="tbl_pi_item">
            <thead>
                <th>Job No</th>
                <th class="must_entry_caption">Construction</th>
                <th>Composition</th>
                <th class="must_entry_caption">Color</th>
                <th>GSM</th>
                <th class="must_entry_caption">Dia/Width</th>
                <th>UOM</th>
                <th class="must_entry_caption">Quantity</th>
                <th class="must_entry_caption">Rate</th>
                <th>Amount</th>
            </thead>
            <tbody id="pi_details_container">
            <?
                $tblRow=0;
                $sql = "select id, work_order_no, work_order_id, work_order_dtls_id, determination_id, color_id, construction, composition, gsm, dia_width, uom, quantity, rate, amount from com_export_pi_dtls where pi_id='$export_id' and quantity>0 and status_active=1 and is_deleted=0";
                $data_array=sql_select($sql);
                foreach($data_array as $row)
                {
                    $tblRow++;

                    if($tblRow%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" id="row_<? echo $tblRow; ?>" align="center">
                        <td>
                            <input type="text" name="workOrderNo_<? echo $tblRow; ?>" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" disabled="disabled" />
                            <input type="hidden" name="hideWoId_<? echo $tblRow; ?>" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_id')]; ?>" readonly />
                            <input type="hidden" name="hideWoDtlsId_<? echo $tblRow; ?>" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_dtls_id')]; ?>" readonly />
                        </td>
                        <td>
                            <input type="text" name="construction_<? echo $tblRow; ?>" id="construction_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('construction')]; ?>" style="width:110px" disabled="disabled"/>
                            <input type="hidden" name="hideDeterminationId_<? echo $tblRow; ?>" id="hideDeterminationId_<? echo $tblRow; ?>" value="<? echo $row[csf('determination_id')]; ?>" readonly />
                        </td>
                        <td>
                            <input type="text" name="composition_<? echo $tblRow; ?>" id="composition_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('composition')]; ?>" style="width:110px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="colorName_<? echo $tblRow; ?>" id="colorName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('color_id')]]; ?>" style="width:80px" disabled="disabled"/>
                            <input type="hidden" name="colorId_<? echo $tblRow; ?>" id="colorId_<? echo $tblRow; ?>" value="<? echo $row[csf('color_id')]; ?>"/>
                        </td>
                        <td>
                            <input type="text" name="gsm_<? echo $tblRow; ?>" id="gsm_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('gsm')]; ?>" style="width:60px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="diawidth_<? echo $tblRow; ?>" id="diawidth_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('dia_width')]; ?>" style="width:70px" disabled="disabled"/>
                        </td>
                         <td>
                            <? echo create_drop_down("uom_".$tblRow, 70, $unit_of_measurement,'', 1, ' Display ',$row[csf('uom')],'',1,''); ?>
                        </td>
                        <td>
                            <input type="text" name="quantity_<? echo $tblRow; ?>" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" disabled/>
                        </td>
                        <td>
                            <input type="text" name="rate_<? echo $tblRow; ?>" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:60px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" disabled/>
                        </td>
                        <td>
                            <input type="text" name="amount_<? echo $tblRow; ?>" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:75px;" disabled/>
                            <input type="hidden" name="updateIdDtls_<? echo $tblRow; ?>" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
                        </td>
                    </tr>
                <?
                }
            ?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo $upcharge; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo $discount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $net_total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
            </tfoot>
        </table>
        <?
	}
	else if($item_catagory_id==3) // Woven Fabric
	{
		?>
        <table class="rpt_table" width="100%" cellspacing="0" cellpadding="0" border="1" rules="all" id="tbl_pi_item">
            <thead>
                <th>WO</th>
                <th>Fab Ref</th>
                <th>RD No</th>
                <th>Fab. Description</th>
                <th>Color</th>
                <th>Weight</th>
                <th>Weight Type</th>
                <th>Dia/Width</th>
                <th>Width</th>
                <th>Cutable Width</th>
                <th>UOM</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Amount</th>
            </thead>
            <tbody id="pi_details_container">
            <?
                $tblRow=0;
                $sql = "select id, work_order_no,booking, work_order_id, work_order_dtls_id, determination_id, color_id, construction, composition, gsm, dia_width, uom, quantity, rate, amount from com_export_pi_dtls where pi_id='$export_id' and quantity>0 and status_active=1 and is_deleted=0";
                $data_array=sql_select($sql);
                
				$dtls_id_arr=array();
				$deter_id_arr=array();
				foreach($data_array as $row)
				{
					$dtls_id_arr[$row[csf('work_order_dtls_id')]]=$row[csf('work_order_dtls_id')];
					$deter_id_arr[$row[csf('determination_id')]]=$row[csf('determination_id')];
				}

				$wo_dtls_cond = where_con_using_array($dtls_id_arr,0,"id");
				$sql_wo = sql_select("select id,fabric_desc,cutable_width,body_part_id,width_dia_type,weight_type from fabric_sales_order_dtls where is_deleted = 0 $wo_dtls_cond");
				$wo_data = array();

				foreach($sql_wo as $row)
				{
					$wo_data[$row[csf('id')]]['des'] = $row[csf('fabric_desc')];
					$wo_data[$row[csf('id')]]['cutable_width'] = $row[csf('cutable_width')];
					$wo_data[$row[csf('id')]]['body_part_id'] = $row[csf('body_part_id')];
					$wo_data[$row[csf('id')]]['width_dia_type'] = $row[csf('width_dia_type')];
					$wo_data[$row[csf('id')]]['weight_type'] = $row[csf('weight_type')];
				}

				$deter_cond = where_con_using_array($deter_id_arr,0,"id");
				$sql_deter = sql_select("select id,fabric_ref,rd_no,cutable_width,design,weight_type,gsm_weight from lib_yarn_count_determina_mst where is_deleted = 0 $deter_cond");
				$wo_deter = array();

				foreach($sql_deter as $row)
				{
					$wo_deter[$row[csf('id')]]['fabric_ref'] = $row[csf('fabric_ref')];
					$wo_deter[$row[csf('id')]]['cutable_width'] = $row[csf('cutable_width')];
					$wo_deter[$row[csf('id')]]['design'] = $row[csf('design')];
					$wo_deter[$row[csf('id')]]['gsm_weight'] = $row[csf('gsm_weight')];
					$wo_deter[$row[csf('id')]]['weight_type'] = $row[csf('weight_type')];
					$wo_deter[$row[csf('id')]]['rd_no'] = $row[csf('rd_no')];
				}

                foreach($data_array as $row)
                {
                	$cutable_width=$wo_data[$row[csf('work_order_dtls_id')]]['cutable_width'];
					$des=$wo_data[$row[csf('work_order_dtls_id')]]['des'];
					$body_part_id=$wo_data[$row[csf('work_order_dtls_id')]]['body_part_id'];
					$width_dia_type=$wo_data[$row[csf('work_order_dtls_id')]]['width_dia_type'];
					$weight_type=$wo_data[$row[csf('work_order_dtls_id')]]['weight_type'];
					$rd_no=$wo_deter[$row[csf('determination_id')]]['rd_no'];
					$fabric_ref=$wo_deter[$row[csf('determination_id')]]['fabric_ref'];
                	$tblRow++;
                	?>
                	<tr>
                		
                        <td>
                        	<input type="text" name="salesbooking[]" id="salesbooking_<? echo $tblRow; ?>" value="<?=$row[csf('booking')];?>" class="text_boxes"  style="width:100px;" readonly>
                            <input type="hidden" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes"  style="width:110px;" value="<? echo $row[csf('work_order_no')]; ?>" readonly />
                            <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_id')]; ?>" readonly />
                            <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_dtls_id')]; ?>" readonly />
                        </td>
                        <td>
                        	<input type="text" value="<?=$fabric_ref;?>" name="fabricRef[]" id="fabricRef_<? echo $tblRow; ?>" class="text_boxes" style="width:60px" disabled="disabled"/>
                        </td>
                    	<td>
                    		<input type="text" name="rdNo[]" id="rdNo_<? echo $tblRow; ?>" class="text_boxes" style="width:60px" value="<?=$rd_no;?>" disabled="disabled"/>
                    	</td>
	                    <td>
	                    	<input type="text" name="fabDescription[]" id="fabDescription_<? echo $tblRow; ?>" class="text_boxes" onDblClick="openmypage_fabricDescription(<? echo $tblRow; ?>)" placeholder="Double Click To Search" value="<? echo $des; ?>" style="width:195px" readonly <? echo $disable; ?>/>
	                    	<input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_<? echo $tblRow; ?>" value="<? echo $row[csf('determination_id')]; ?>" readonly />                   
	                        <input type="hidden" name="construction[]" id="construction_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('construction')]; ?>"  disabled="disabled"/>
	                        <input type="hidden" name="composition[]" id="composition_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('composition')]; ?>"  disabled="disabled"/>
	                        <input type="hidden" name="bodyPart[]" id="bodyPart_<? echo $tblRow; ?>" class="text_boxes" value="<?=$body_part_id;?>"  disabled="disabled"/> 
	                        <input type="hidden" name="fabType[]" id="fabType_<? echo $tblRow; ?>" class="text_boxes" value=""  disabled="disabled"/>
	                        <input type="hidden" name="fabDesign[]" id="fabDesign_<? echo $tblRow; ?>" class="text_boxes" value="" disabled="disabled"/>
	                        
	                    </td>
	                    <td>
	                        <input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $tblRow; ?> )" value="<? echo $color_library[$row[csf('color_id')]]; ?>" style="width:50px" maxlength="50" <? echo $disable; ?>/>
	                        <input type="hidden" name="colorId_<? echo $tblRow; ?>" id="colorId_<? echo $tblRow; ?>" value="<? echo $row[csf('color_id')]; ?>"/>
	                    </td>
	                    <td>
	                        <input type="text" name="fabWeight[]" id="fabWeight_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('gsm')]; ?>" style="width:35px" <? echo $disable; ?>/>
	                    </td>
	                    <td>
	                    	<?
	                    	echo create_drop_down( "fabWeightType_".$tblRow, 55, $fabric_weight_type, '', 1, 'Select', $weight_type, '', $disable_status, '', '', '', '', '', '', 'fabWeightType[]');
	                    	?>
	                    </td>
	                    <td>
	                    	<input type="text" name="diawidthType[]" id="diawidthType_<? echo $tblRow; ?>" class="text_boxes" style="width:40px" readonly />
	                    </td>
	                    <td>
	                    	<input type="text" name="diawidth[]" id="diawidth_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('dia_width')]; ?>" style="width:35px" disabled="disabled">
	                    </td>
	                    <td>
	                    	<input type="text" name="cutableWidth[]" id="cutableWidth_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $cutable_width; ?>" style="width:60px" disabled="disabled">
	                    </td>
	                    <td>
	                    	
	                    	<? echo create_drop_down("uom_".$tblRow, 70, $unit_of_measurement,'', 1, ' Display ',$row[csf('uom')],'',1,''); ?>
	                    	
	                    </td>
	                    <td>
	                        <input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" />
	                    </td>
	                    <td>
	                        <input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:45px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" <? echo $disable; ?> />
	                    </td>
	                    <td>
	                        <input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:75px;" <? echo $disable; ?> readonly/>
	                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly/>
							<input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" readonly/>
	                    </td>
                    </tr>
                    <?
                }
            ?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo $upcharge; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo $discount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $net_total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
            </tfoot>
        </table>
        <?
	}
	else if($item_catagory_id==4) // Accessories
	{
		$item_group_arr=return_library_array( "select id, item_name from lib_item_group where status_active=1 and is_deleted=0", "id", "item_name"  );
		?>
        <table class="rpt_table" width="100%" cellspacing="0" cellpadding="0" border="1" rules="all" id="tbl_pi_item">
            <thead>
                <th>Job No</th>
                <th>WO No</th>
                <th class="must_entry_caption">Item Group</th>
                <th class="must_entry_caption">Item Description</th>
                <th>Item Color</th>
                <th>Item Size</th>
                <th>UOM</th>
                <th class="must_entry_caption">Quantity</th>
                <th class="must_entry_caption">Rate</th>
                <th>Amount</th>
            </thead>
            <tbody id="pi_details_container">
            <?
                $tblRow=0;
                $sql = "select id, work_order_no, work_order_id, work_order_dtls_id, booking as booking_no, gmts_item_id as item_group_id, item_desc, color_id as item_color_id, item_size, uom, quantity, rate, amount, net_pi_rate, net_pi_amount
				from com_export_pi_dtls
				where pi_id='$export_id' and quantity>0 and status_active=1 and is_deleted=0";
				//echo $sql;
                $data_array=sql_select($sql);
                foreach($data_array as $row)
                {
                    $tblRow++;

                    if($tblRow%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" id="row_<? echo $tblRow; ?>" align="center">
                        <td>
                            <input type="text" name="workOrderNo_<? echo $tblRow; ?>" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" disabled="disabled" />
                            <input type="hidden" name="hideWoId_<? echo $tblRow; ?>" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_id')]; ?>" readonly />
                            <input type="hidden" name="hideWoDtlsId_<? echo $tblRow; ?>" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_dtls_id')]; ?>" readonly />
                        </td>
                        <td>
                            <input type="text" name="bookingNo_<? echo $tblRow; ?>" id="bookingNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:110px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="itemgroupid_<? echo $tblRow; ?>" id="itemgroupid_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $item_group_arr[$row[csf('item_group_id')]]; ?>" placeholder="<? echo $row[csf('item_group_id')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="itemdescription_<? echo $tblRow; ?>" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('item_desc')]; ?>" style="width:110px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="itemColor_<? echo $tblRow; ?>" id="itemColor_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('item_color_id')]]; ?>" placeholder="<? echo $row[csf('item_color_id')]; ?>" style="width:70px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="itemSize_<? echo $tblRow; ?>" id="itemSize_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $size_library[$row[csf('item_size')]]; ?>" placeholder="<? echo $row[csf('item_size')]; ?>" style="width:70px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="uom_<? echo $tblRow; ?>" id="uom_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $unit_of_measurement[$row[csf('uom')]]; ?>" placeholder="<? echo $row[csf('uom')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="quantity_<? echo $tblRow; ?>" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:70px;" disabled="disabled" />
                        </td>
                        <td>
                        <input type="text" name="rate_<? echo $tblRow; ?>" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:70px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_rate')]; ?>" />
                        </td>
                        <td>
                            <input type="text" name="amount_<? echo $tblRow; ?>" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:80px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_amount')]; ?>" />
                            <input type="hidden" name="updateIdDtls_<? echo $tblRow; ?>" id="updateIdDtls_<? echo $tblRow; ?>" value=""/>
                            <input type="hidden" name="bookingWithoutOrder_<? echo $tblRow; ?>" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="0"/>
                        </td>
                    </tr>
                	<?
					$tot_amount+=$row[csf('amount')];
					//$net_total_amount+=$row[csf('net_pi_amount')];
                }
				$sql_mst=sql_select("select total_amount, upcharge, discount, net_total_amount from com_export_pi_mst where id =$export_id ");
				$upcharge=$sql_mst[0][csf("upcharge")];
				$discount=$sql_mst[0][csf("discount")];
				$net_total_amount=$sql_mst[0][csf("net_total_amount")];
            ?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo $upcharge; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo $discount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $net_total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
            </tfoot>

        </table>
        <?
	}
	else if($item_catagory_id==74) // AOP
	{
		?>
        <table class="rpt_table" width="100%" cellspacing="0" cellpadding="0" border="1" rules="all" id="tbl_pi_item">
            <thead>
                <th>Job No</th>
                <th>Booking No</th>
                <th class="must_entry_caption">Gmts Color</th>
                <th class="must_entry_caption">AOP Color</th>
                <th>GSM</th>
                <th>Body part</th>
                <th>UOM</th>
                <th class="must_entry_caption">Quantity</th>
                <th class="must_entry_caption">Rate</th>
                <th>Amount</th>
            </thead>
            <tbody id="pi_details_container">
            <?
                $tblRow=0;
                $sql = "select id, work_order_no, work_order_id, work_order_dtls_id, booking as booking_no, color_id as item_color_id, aop_color_id, gsm, body_part, uom, quantity, rate, amount, net_pi_rate, net_pi_amount
				from com_export_pi_dtls
				where pi_id='$export_id' and quantity>0 and status_active=1 and is_deleted=0";
				//echo $sql;
                $data_array=sql_select($sql);
                foreach($data_array as $row)
                {
                    $tblRow++;

                    if($tblRow%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" id="row_<? echo $tblRow; ?>" align="center">
                        <td>
                            <input type="text" name="workOrderNo_<? echo $tblRow; ?>" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" disabled="disabled" />
                            <input type="hidden" name="hideWoId_<? echo $tblRow; ?>" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_id')]; ?>" readonly />
                            <input type="hidden" name="hideWoDtlsId_<? echo $tblRow; ?>" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_dtls_id')]; ?>" readonly />
                        </td>
                        <td>
                            <input type="text" name="bookingNo_<? echo $tblRow; ?>" id="bookingNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:110px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="itemColor_<? echo $tblRow; ?>" id="itemColor_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('item_color_id')]]; ?>" placeholder="<? echo $row[csf('item_color_id')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="aopColor_<? echo $tblRow; ?>" id="aopColor_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('aop_color_id')]]; ?>" style="width:110px" placeholder="<? echo $row[csf('aop_color_id')]; ?>" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="gsm_<? echo $tblRow; ?>" id="gsm_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('gsm')]; ?>"  style="width:70px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="bodyPart_<? echo $tblRow; ?>" id="bodyPart_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $body_part[$row[csf('body_part')]]; ?>" placeholder="<? echo $row[csf('body_part')]; ?>" style="width:70px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="uom_<? echo $tblRow; ?>" id="uom_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $unit_of_measurement[$row[csf('uom')]]; ?>" placeholder="<? echo $row[csf('uom')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="quantity_<? echo $tblRow; ?>" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:70px;" disabled="disabled" />
                        </td>
                        <td>
                        <input type="text" name="rate_<? echo $tblRow; ?>" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:70px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_rate')]; ?>" />
                        </td>
                        <td>
                            <input type="text" name="amount_<? echo $tblRow; ?>" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:80px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_amount')]; ?>" />
                            <input type="hidden" name="updateIdDtls_<? echo $tblRow; ?>" id="updateIdDtls_<? echo $tblRow; ?>" value=""/>
                            <input type="hidden" name="bookingWithoutOrder_<? echo $tblRow; ?>" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="0"/>
                        </td>
                    </tr>
                	<?
					$tot_amount+=$row[csf('amount')];
					//$net_total_amount+=$row[csf('net_pi_amount')];
                }
				$sql_mst=sql_select("select total_amount, upcharge, discount, net_total_amount from com_export_pi_mst where id =$export_id ");
				$upcharge=$sql_mst[0][csf("upcharge")];
				$discount=$sql_mst[0][csf("discount")];
				$net_total_amount=$sql_mst[0][csf("net_total_amount")];
            	?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo $upcharge; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo $discount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $net_total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
            </tfoot>
        </table>
        <?
	}
	else if($item_catagory_id==104 || $item_catagory_id==102) // Printing & Embroidery
	{
		?>
        <table class="rpt_table" width="100%" cellspacing="0" cellpadding="0" border="1" rules="all" id="tbl_pi_item">
            <thead>
                <th>Job No</th>
                <th>Booking No</th>
                <th>Gmts. Item</th>
                <th>Body Part</th>
                <th>Process /Embl. Name</th>
                <th>Embl. Type</th>
                <th>Description</th>
                <th>GMTS Color</th>
                <th>GMTS Size</th>
                <th>UOM</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Amount</th>
            </thead>
            <tbody id="pi_details_container">
            <?
				//$emblishment_print_type


				//$emblishment_embroy_type
				if($item_catagory_id==104) $emb_type_arr=$emblishment_embroy_type; else $emb_type_arr=$emblishment_print_type;
                $tblRow=0;
                $sql = "select id, work_order_no, work_order_id, work_order_dtls_id, booking as booking_no, gmts_item_id, body_part, main_process_id as emb_name, embl_type as emb_type, item_desc, color_id as gmt_color_id, item_size as gmt_size, uom, quantity, rate, amount, net_pi_rate, net_pi_amount
				from com_export_pi_dtls
				where pi_id='$export_id' and quantity>0 and status_active=1 and is_deleted=0";
				//echo $sql;
                $data_array=sql_select($sql);
                foreach($data_array as $row)
                {
                    $tblRow++;

                    if($tblRow%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" id="row_<? echo $tblRow; ?>" align="center">
                        <td>
                            <input type="text" name="workOrderNo_<? echo $tblRow; ?>" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" disabled="disabled" />
                            <input type="hidden" name="hideWoId_<? echo $tblRow; ?>" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_id')]; ?>" readonly />
                            <input type="hidden" name="hideWoDtlsId_<? echo $tblRow; ?>" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_dtls_id')]; ?>" readonly />
                        </td>
                        <td>
                            <input type="text" name="bookingNo_<? echo $tblRow; ?>" id="bookingNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:110px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="gmtsItem_<? echo $tblRow; ?>" id="gmtsItem_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $garments_item[$row[csf('gmts_item_id')]]; ?>" placeholder="<? echo $row[csf('gmts_item_id')]; ?>" style="width:110px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="bodyPart_<? echo $tblRow; ?>" id="bodyPart_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $body_part[$row[csf('body_part')]]; ?>" placeholder="<? echo $row[csf('body_part')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="embName_<? echo $tblRow; ?>" id="embName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $emblishment_name_array[$row[csf('emb_name')]]; ?>" placeholder="<? echo $row[csf('emb_name')]; ?>" style="width:70px" disabled="disabled"/>
                        </td>
                        <td>

                            <input type="text" name="embType_<? echo $tblRow; ?>" id="embType_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $emb_type_arr[$row[csf('emb_type')]]; ?>" placeholder="<? echo $row[csf('emb_type')]; ?>" style="width:70px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="itemdescription_<? echo $tblRow; ?>" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('item_desc')]; ?>" style="width:110px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="itemColor_<? echo $tblRow; ?>" id="itemColor_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('gmt_color_id')]]; ?>" placeholder="<? echo $row[csf('gmt_color_id')]; ?>" style="width:70px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="itemSize_<? echo $tblRow; ?>" id="itemSize_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $size_library[$row[csf('gmt_size')]]; ?>" placeholder="<? echo $row[csf('gmt_size')]; ?>" style="width:60px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="uom_<? echo $tblRow; ?>" id="uom_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $unit_of_measurement[$row[csf('uom')]]; ?>" placeholder="<? echo $row[csf('uom')]; ?>" style="width:60px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="quantity_<? echo $tblRow; ?>" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:70px;" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="rate_<? echo $tblRow; ?>" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:70px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_rate')]; ?>" />
                        </td>
                        <td>
                            <input type="text" name="amount_<? echo $tblRow; ?>" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:80px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_amount')]; ?>" />
                            <input type="hidden" name="updateIdDtls_<? echo $tblRow; ?>" id="updateIdDtls_<? echo $tblRow; ?>" value=""/>
                            <input type="hidden" name="bookingWithoutOrder_<? echo $tblRow; ?>" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="0"/>
                        </td>
                    </tr>
                	<?
					$tot_amount+=$row[csf('amount')];
					//$net_total_amount+=$row[csf('net_pi_amount')];
                }
				$sql_mst=sql_select("select total_amount, upcharge, discount, net_total_amount from com_export_pi_mst where id =$export_id ");
				$upcharge=$sql_mst[0][csf("upcharge")];
				$discount=$sql_mst[0][csf("discount")];
				$net_total_amount=$sql_mst[0][csf("net_total_amount")];
            ?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo $upcharge; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo $discount; ?>" style="width:75px;" readonly/>
                    </td>

                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $net_total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
            </tfoot>
        </table>
        <?
	}
	else if($item_catagory_id==103) // Wash
	{
		?>
        <table class="rpt_table" width="100%" cellspacing="0" cellpadding="0" border="1" rules="all" id="tbl_pi_item">
            <thead>
                <th>Job No</th>
                <th>Booking No</th>
                <th>Gmts. Item</th>
                <th>Style No</th>
                <th>Color</th>
                <th>Wash Desc</th>
                <th>Process</th>
                <th>Wash Type</th>
                <th>UOM</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Amount</th>
            </thead>
            <tbody id="pi_details_container">
            <?
                $tblRow=0;
                $sql = "select id, work_order_no, work_order_id, work_order_dtls_id, booking as booking_no, gmts_item_id, color_id as color_id, item_desc, main_process_id as process_id, wash_type as wash_type,uom, quantity, rate, amount, net_pi_rate, net_pi_amount, buyer_style_ref
				from com_export_pi_dtls
				where pi_id='$export_id' and quantity>0 and status_active=1 and is_deleted=0";
				//echo $sql;
                $data_array=sql_select($sql);
                foreach($data_array as $row)
                {
                    $tblRow++;
					if($row[csf('process_id')]==1) $wash_process_type=$wash_wet_process;
					else if($row[csf('process_id')]==2) $wash_process_type=$wash_dry_process;
					else if($row[csf('process_id')]==3) $wash_process_type=$wash_laser_desing;

				    if($tblRow%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" id="row_<? echo $tblRow; ?>" align="center">
                        <td>
                            <input type="text" name="workOrderNo_<? echo $tblRow; ?>" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" disabled="disabled" />
                            <input type="hidden" name="hideWoId_<? echo $tblRow; ?>" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_id')]; ?>" readonly />
                            <input type="hidden" name="hideWoDtlsId_<? echo $tblRow; ?>" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_dtls_id')]; ?>" readonly />
                        </td>
                        <td>
                            <input type="text" name="bookingNo_<? echo $tblRow; ?>" id="bookingNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="gmtsItem_<? echo $tblRow; ?>" id="gmtsItem_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $garments_item[$row[csf('gmts_item_id')]]; ?>" placeholder="<? echo $row[csf('gmts_item_id')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="styleRef_<? echo $tblRow; ?>" id="styleRef_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('buyer_style_ref')]; ?>" placeholder="<? echo $row[csf('buyer_style_ref')]; ?>" style="width:80px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="itemColor_<? echo $tblRow; ?>" id="itemColor_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('color_id')]]; ?>" placeholder="<? echo $row[csf('color_id')]; ?>" style="width:70px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="itemdescription_<? echo $tblRow; ?>" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('item_desc')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="embName_<? echo $tblRow; ?>" id="embName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $wash_type[$row[csf('process_id')]]; ?>" placeholder="<? echo $row[csf('process_id')]; ?>" style="width:70px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="embType_<? echo $tblRow; ?>" id="embType_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $wash_process_type[$row[csf('wash_type')]]; ?>" placeholder="<? echo $row[csf('wash_type')]; ?>" style="width:70px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="uom_<? echo $tblRow; ?>" id="uom_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $unit_of_measurement[$row[csf('uom')]]; ?>" placeholder="<? echo $row[csf('uom')]; ?>" style="width:60px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="quantity_<? echo $tblRow; ?>" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:70px;" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="rate_<? echo $tblRow; ?>" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:70px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_rate')]; ?>" />
                        </td>
                        <td>
                            <input type="text" name="amount_<? echo $tblRow; ?>" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:80px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_amount')]; ?>" />
                            <input type="hidden" name="updateIdDtls_<? echo $tblRow; ?>" id="updateIdDtls_<? echo $tblRow; ?>" value=""/>
                            <input type="hidden" name="bookingWithoutOrder_<? echo $tblRow; ?>" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="0"/>
                        </td>
                    </tr>
                	<?
					$tot_amount+=$row[csf('amount')];
					//$net_total_amount+=$row[csf('net_pi_amount')];
                }
				$sql_mst=sql_select("select total_amount, upcharge, discount, net_total_amount from com_export_pi_mst where id =$export_id ");
				$upcharge=$sql_mst[0][csf("upcharge")];
				$discount=$sql_mst[0][csf("discount")];
				$net_total_amount=$sql_mst[0][csf("net_total_amount")];
            ?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo $upcharge; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo $discount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $net_total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
            </tfoot>
        </table>
        <?
	}
	exit();
}

if( $action == 'export_pi_details_update' )
{
	$data=explode("**",$data);
	$import_id=$data[0];
	$sql_prev=sql_select("select upcharge, discount, total_amount, net_total_amount, item_category_id,export_pi_id from com_pi_master_details where id=$import_id and status_active=1 and is_deleted=0");
	$upcharge=$sql_prev[0][csf("upcharge")];
	$discount=$sql_prev[0][csf("discount")];
	$total_amount=$sql_prev[0][csf("total_amount")];
	$net_total_amount=$sql_prev[0][csf("net_total_amount")];
	$item_catagory_id=$sql_prev[0][csf("item_category_id")];
	$export_pi_id=$sql_prev[0][csf("export_pi_id")];
	/*$upcharge=$data[1];
	$discount=$data[2];
	$total_amount=$data[3];
	$net_total_amount=$data[4];
	$item_catagory_id=$data[5];*/
	if($item_catagory_id==2)
	{
		?>
        <table class="rpt_table" width="100%" cellspacing="0" cellpadding="0" border="1" rules="all" id="tbl_pi_item">
            <thead>
                <th>Job No</th>
                <th class="must_entry_caption">Construction</th>
                <th>Composition</th>
                <th class="must_entry_caption">Color</th>
                <th>GSM</th>
                <th class="must_entry_caption">Dia/Width</th>
                <th>UOM</th>
                <th class="must_entry_caption">Quantity</th>
                <th class="must_entry_caption">Rate</th>
                <th>Amount</th>
            </thead>
            <tbody id="pi_details_container">
            <?
                $tblRow=0;
                $sql = "select id, work_order_no, work_order_id, work_order_dtls_id, determination_id, color_id, fabric_construction as construction, fabric_composition as composition, gsm, dia_width, uom, quantity, rate, amount from com_pi_item_details where pi_id='$import_id' and status_active=1 and is_deleted=0";
                $data_array=sql_select($sql);
                foreach($data_array as $row)
                {
                    $tblRow++;

                    if($tblRow%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" id="row_<? echo $tblRow; ?>" align="center">
                        <td>
                            <input type="text" name="workOrderNo_<? echo $tblRow; ?>" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" disabled="disabled" />
                            <input type="hidden" name="hideWoId_<? echo $tblRow; ?>" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_id')]; ?>" readonly />
                            <input type="hidden" name="hideWoDtlsId_<? echo $tblRow; ?>" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_dtls_id')]; ?>" readonly />
                        </td>
                        <td>
                            <input type="text" name="construction_<? echo $tblRow; ?>" id="construction_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('construction')]; ?>" style="width:110px" disabled="disabled"/>
                            <input type="hidden" name="hideDeterminationId_<? echo $tblRow; ?>" id="hideDeterminationId_<? echo $tblRow; ?>" value="<? echo $row[csf('determination_id')]; ?>" readonly />
                        </td>
                        <td>
                            <input type="text" name="composition_<? echo $tblRow; ?>" id="composition_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('composition')]; ?>" style="width:110px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="colorName_<? echo $tblRow; ?>" id="colorName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('color_id')]]; ?>" style="width:80px" disabled="disabled"/>
                            <input type="hidden" name="colorId_<? echo $tblRow; ?>" id="colorId_<? echo $tblRow; ?>" value="<? echo $row[csf('color_id')]; ?>"/>
                        </td>
                        <td>
                            <input type="text" name="gsm_<? echo $tblRow; ?>" id="gsm_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('gsm')]; ?>" style="width:60px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="diawidth_<? echo $tblRow; ?>" id="diawidth_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('dia_width')]; ?>" style="width:70px" disabled="disabled"/>
                        </td>
                         <td>
                            <? echo create_drop_down("uom_".$tblRow, 70, $unit_of_measurement,'', 1, ' Display ',$row[csf('uom')],'',1,''); ?>
                        </td>
                        <td>
                            <input type="text" name="quantity_<? echo $tblRow; ?>" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" disabled/>
                        </td>
                        <td>
                            <input type="text" name="rate_<? echo $tblRow; ?>" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:60px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" disabled/>
                        </td>
                        <td>
                            <input type="text" name="amount_<? echo $tblRow; ?>" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:75px;" disabled/>
                            <input type="hidden" name="updateIdDtls_<? echo $tblRow; ?>" id="updateIdDtls_<? echo $tblRow; ?>" readonly value="<? echo $row[csf('id')]; ?>"/>
                        </td>
                    </tr>
                <?
                }
            ?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo $upcharge; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo $discount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $net_total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
            </tfoot>
        </table>
        <?
	}
	else if($item_catagory_id==3)
	{
		?>
        <table class="rpt_table" width="100%" cellspacing="0" cellpadding="0" border="1" rules="all" id="tbl_pi_item">
            <thead>
                <th>WO</th>
                <th>Fab Ref</th>
                <th>RD No</th>
                <th>Fab. Description</th>
                <th>Color</th>
                <th>Weight</th>
                <th>Weight Type</th>
                <th>Dia/Width</th>
                <th>Width</th>
                <th>Cutable Width</th>
                <th>UOM</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Amount</th>
            </thead>
            <tbody id="pi_details_container">
            <?
                $tblRow=0;
                $sql = "select id, work_order_no, work_order_id, work_order_dtls_id, determination_id, color_id, fabric_construction as construction, fabric_composition as composition, gsm, dia_width, uom, quantity, rate, amount from com_pi_item_details where pi_id='$import_id' and status_active=1 and is_deleted=0";
                $data_array=sql_select($sql);
                
				$dtls_id_arr=array();
				$deter_id_arr=array();
				foreach($data_array as $row)
				{
					$dtls_id_arr[$row[csf('work_order_dtls_id')]]=$row[csf('work_order_dtls_id')];
					$deter_id_arr[$row[csf('determination_id')]]=$row[csf('determination_id')];
				}

				$wo_dtls_cond = where_con_using_array($dtls_id_arr,0,"id");
				$sql_wo = sql_select("select id,fabric_desc,cutable_width,body_part_id,width_dia_type,weight_type from fabric_sales_order_dtls where is_deleted = 0 $wo_dtls_cond");
				$wo_data = array();

				foreach($sql_wo as $row)
				{
					$wo_data[$row[csf('id')]]['des'] = $row[csf('fabric_desc')];
					$wo_data[$row[csf('id')]]['cutable_width'] = $row[csf('cutable_width')];
					$wo_data[$row[csf('id')]]['body_part_id'] = $row[csf('body_part_id')];
					$wo_data[$row[csf('id')]]['width_dia_type'] = $row[csf('width_dia_type')];
					$wo_data[$row[csf('id')]]['weight_type'] = $row[csf('weight_type')];
				}
				$deter_cond = where_con_using_array($deter_id_arr,0,"id");
				$sql_deter = sql_select("select id,fabric_ref,rd_no,cutable_width,design,weight_type,gsm_weight from lib_yarn_count_determina_mst where is_deleted = 0 $deter_cond");
				$wo_deter = array();

				foreach($sql_deter as $row)
				{
					$wo_deter[$row[csf('id')]]['fabric_ref'] = $row[csf('fabric_ref')];
					$wo_deter[$row[csf('id')]]['cutable_width'] = $row[csf('cutable_width')];
					$wo_deter[$row[csf('id')]]['design'] = $row[csf('design')];
					$wo_deter[$row[csf('id')]]['gsm_weight'] = $row[csf('gsm_weight')];
					$wo_deter[$row[csf('id')]]['weight_type'] = $row[csf('weight_type')];
					$wo_deter[$row[csf('id')]]['rd_no'] = $row[csf('rd_no')];
				}

				$sql_exp = "select id, work_order_no,booking, work_order_id, work_order_dtls_id, determination_id, color_id, construction, composition, gsm, dia_width, uom, quantity, rate, amount from com_export_pi_dtls where pi_id='$export_pi_id' and quantity>0 and status_active=1 and is_deleted=0";
                $res_exp=sql_select($sql_exp);

                $data_exp = array();

                foreach($res_exp as $row)
                {
                	$data_exp[$row[csf('work_order_dtls_id')]]['booking'] = $row[csf('booking')];
                }

                foreach($data_array as $row)
                {
                	$cutable_width=$wo_data[$row[csf('work_order_dtls_id')]]['cutable_width'];
					$des=$wo_data[$row[csf('work_order_dtls_id')]]['des'];
					$body_part_id=$wo_data[$row[csf('work_order_dtls_id')]]['body_part_id'];
					$width_dia_type=$wo_data[$row[csf('work_order_dtls_id')]]['width_dia_type'];
					$weight_type=$wo_data[$row[csf('work_order_dtls_id')]]['weight_type'];
					$booking=$data_exp[$row[csf('work_order_dtls_id')]]['booking'];
					$rd_no=$wo_deter[$row[csf('determination_id')]]['rd_no'];
					$fabric_ref=$wo_deter[$row[csf('determination_id')]]['fabric_ref'];
                	$tblRow++;
                	?>
                	<tr>
                		
                        <td>
                        	<input type="text" name="salesbooking[]" id="salesbooking_<? echo $tblRow; ?>" value="<?=$booking;?>" class="text_boxes"  style="width:100px;" readonly>
                            <input type="hidden" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes"  style="width:110px;" value="<? echo $row[csf('work_order_no')]; ?>" readonly />
                            <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_id')]; ?>" readonly />
                            <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_dtls_id')]; ?>" readonly />
                        </td>
                        <td>
                        	<input type="text" name="fabricRef[]" id="fabricRef_<? echo $tblRow; ?>" class="text_boxes" value="<?=$fabric_ref;?>" style="width:60px" disabled="disabled"/>
                        </td>
                    	<td>
                    		<input type="text" name="rdNo[]" id="rdNo_<? echo $tblRow; ?>" class="text_boxes" style="width:60px" value="<?=$rd_no?>" disabled="disabled"/>
                    	</td>
	                    <td>
	                    	<input type="text" name="fabDescription[]" id="fabDescription_<? echo $tblRow; ?>" class="text_boxes" onDblClick="openmypage_fabricDescription(<? echo $tblRow; ?>)" placeholder="Double Click To Search" value="<? echo $des; ?>" style="width:195px" readonly <? echo $disable; ?>/>
	                    	<input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_<? echo $tblRow; ?>" value="<? echo $row[csf('determination_id')]; ?>" readonly />                   
	                        <input type="hidden" name="construction[]" id="construction_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('construction')]; ?>"  disabled="disabled"/>
	                        <input type="hidden" name="composition[]" id="composition_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('composition')]; ?>"  disabled="disabled"/>
	                        <input type="hidden" name="bodyPart[]" id="bodyPart_<? echo $tblRow; ?>" class="text_boxes" value="<?=$body_part_id;?>"  disabled="disabled"/> 
	                        <input type="hidden" name="fabType[]" id="fabType_<? echo $tblRow; ?>" class="text_boxes" value=""  disabled="disabled"/>
	                        <input type="hidden" name="fabDesign[]" id="fabDesign_<? echo $tblRow; ?>" class="text_boxes" value="" disabled="disabled"/>
	                        
	                    </td>
	                    <td>
	                        <input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $tblRow; ?> )" value="<? echo $color_library[$row[csf('color_id')]]; ?>" style="width:50px" maxlength="50" <? echo $disable; ?>/>
	                        <input type="hidden" name="colorId_<? echo $tblRow; ?>" id="colorId_<? echo $tblRow; ?>" value="<? echo $row[csf('color_id')]; ?>"/>
	                    </td>
	                    <td>
	                        <input type="text" name="fabWeight[]" id="fabWeight_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('gsm')]; ?>" style="width:35px" <? echo $disable; ?>/>
	                    </td>
	                    <td>
	                    	<?
	                    	echo create_drop_down( "fabWeightType_".$tblRow, 55, $fabric_weight_type, '', 1, 'Select', $weight_type, '', $disable_status, '', '', '', '', '', '', 'fabWeightType[]');
	                    	?>
	                    </td>
	                    <td>
	                    	<input type="text" name="diawidthType[]" id="diawidthType_<? echo $tblRow; ?>" class="text_boxes" style="width:40px" readonly />
	                    </td>
	                    <td>
	                    	<input type="text" name="diawidth[]" id="diawidth_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('dia_width')]; ?>" style="width:35px" disabled="disabled">
	                    </td>
	                    <td>
	                    	<input type="text" name="cutableWidth[]" id="cutableWidth_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $cutable_width; ?>" style="width:60px" disabled="disabled">
	                    </td>
	                    <td>
	                    	
	                    	<? echo create_drop_down("uom_".$tblRow, 70, $unit_of_measurement,'', 1, ' Display ',$row[csf('uom')],'',1,''); ?>
	                    	
	                    </td>
	                    <td>
	                        <input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" />
	                    </td>
	                    <td>
	                        <input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:45px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" <? echo $disable; ?> />
	                    </td>
	                    <td>
	                        <input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:75px;" <? echo $disable; ?> readonly/>
	                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly/>
							<input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" readonly/>
	                    </td>
                    </tr>
                    <?
                }
            ?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo $upcharge; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo $discount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $net_total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
            </tfoot>
        </table>
        <?
	} 
	else if($item_catagory_id==4)
	{
		$item_group_arr=return_library_array( "select id, item_name from lib_item_group where status_active=1 and is_deleted=0", "id", "item_name"  );
		?>
        <table class="rpt_table" width="100%" cellspacing="0" cellpadding="0" border="1" rules="all" id="tbl_pi_item">
            <thead>
                <th>Job No</th>
                <th>WO No</th>
                <th class="must_entry_caption">Item Group</th>
                <th class="must_entry_caption">Item Description</th>
                <th>Item Color</th>
                <th>Item Size</th>
                <th>UOM</th>
                <th class="must_entry_caption">Quantity</th>
                <th class="must_entry_caption">Rate</th>
                <th>Amount</th>
            </thead>
            <tbody id="pi_details_container">
            <?
                $tblRow=0;
				$sql = "select id, work_order_no, work_order_id, work_order_dtls_id, booking_no, item_group as item_group_id, item_description as item_desc, color_id as item_color_id, size_id as item_size, uom, quantity, rate, amount, net_pi_rate, net_pi_amount from com_pi_item_details where pi_id='$import_id' and status_active=1 and is_deleted=0";
				//echo $sql;
                $data_array=sql_select($sql);
                foreach($data_array as $row)
                {
                    $tblRow++;

                    if($tblRow%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" id="row_<? echo $tblRow; ?>" align="center">
                        <td>
                            <input type="text" name="workOrderNo_<? echo $tblRow; ?>" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" disabled="disabled" />
                            <input type="hidden" name="hideWoId_<? echo $tblRow; ?>" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_id')]; ?>" readonly />
                            <input type="hidden" name="hideWoDtlsId_<? echo $tblRow; ?>" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_dtls_id')]; ?>" readonly />
                        </td>
                        <td>
                            <input type="text" name="bookingNo_<? echo $tblRow; ?>" id="bookingNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:110px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="itemgroupid_<? echo $tblRow; ?>" id="itemgroupid_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $item_group_arr[$row[csf('item_group_id')]]; ?>" placeholder="<? echo $row[csf('item_group_id')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="itemdescription_<? echo $tblRow; ?>" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('item_desc')]; ?>" style="width:110px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="itemColor_<? echo $tblRow; ?>" id="itemColor_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('item_color_id')]]; ?>" placeholder="<? echo $row[csf('item_color_id')]; ?>" style="width:70px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="itemSize_<? echo $tblRow; ?>" id="itemSize_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $size_library[$row[csf('item_size')]]; ?>" placeholder="<? echo $row[csf('item_size')]; ?>" style="width:70px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="uom_<? echo $tblRow; ?>" id="uom_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $unit_of_measurement[$row[csf('uom')]]; ?>" placeholder="<? echo $row[csf('uom')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="quantity_<? echo $tblRow; ?>" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:70px;" disabled="disabled" />
                        </td>
                        <td>
                        <input type="text" name="rate_<? echo $tblRow; ?>" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:70px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_rate')]; ?>" />
                        </td>
                        <td>
                            <input type="text" name="amount_<? echo $tblRow; ?>" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:80px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_amount')]; ?>" />
                            <input type="hidden" name="updateIdDtls_<? echo $tblRow; ?>" id="updateIdDtls_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>"/>
                            <input type="hidden" name="bookingWithoutOrder_<? echo $tblRow; ?>" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="0"/>
                        </td>
                    </tr>
                	<?
					$tot_amount+=$row[csf('amount')];
					//$net_total_amount+=$row[csf('net_pi_amount')];
                }
				$sql_mst=sql_select("select total_amount, upcharge, discount, net_total_amount from com_pi_master_details where id =$import_id ");
				$upcharge=$sql_mst[0][csf("upcharge")];
				$discount=$sql_mst[0][csf("discount")];
				$net_total_amount=$sql_mst[0][csf("net_total_amount")];
            ?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo $upcharge; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo $discount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>

                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $net_total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
            </tfoot>
        </table>
        <?
	}
	else if($item_catagory_id==74)
	{
		?>
        <table class="rpt_table" width="100%" cellspacing="0" cellpadding="0" border="1" rules="all" id="tbl_pi_item">
            <thead>
                <th>Job No</th>
                <th>Booking No</th>
                <th class="must_entry_caption">Gmts Color</th>
                <th class="must_entry_caption">AOP Color</th>
                <th>GSM</th>
                <th>Body part</th>
                <th>UOM</th>
                <th class="must_entry_caption">Quantity</th>
                <th class="must_entry_caption">Rate</th>
                <th>Amount</th>
            </thead>

            <tbody id="pi_details_container">
            <?
                $tblRow=0;
				$sql = "select id, work_order_no, work_order_id, work_order_dtls_id, booking_no, color_id as item_color_id, item_color as aop_color_id, gsm, body_part_id as body_part, uom, quantity, rate, amount, net_pi_rate, net_pi_amount from com_pi_item_details where pi_id='$import_id' and status_active=1 and is_deleted=0";
                /*$sql = "select id, work_order_no, work_order_id, work_order_dtls_id, booking as booking_no, color_id as item_color_id, aop_color_id, gsm, body_part, uom, quantity, rate, amount, net_pi_rate, net_pi_amount
				from com_export_pi_dtls
				where pi_id='$export_id' and quantity>0 and status_active=1 and is_deleted=0";*/
				//echo $sql;
                $data_array=sql_select($sql);
                foreach($data_array as $row)
                {
                    $tblRow++;

                    if($tblRow%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" id="row_<? echo $tblRow; ?>" align="center">
                        <td>
                            <input type="text" name="workOrderNo_<? echo $tblRow; ?>" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" disabled="disabled" />
                            <input type="hidden" name="hideWoId_<? echo $tblRow; ?>" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_id')]; ?>" readonly />
                            <input type="hidden" name="hideWoDtlsId_<? echo $tblRow; ?>" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_dtls_id')]; ?>" readonly />
                        </td>
                        <td>
                            <input type="text" name="bookingNo_<? echo $tblRow; ?>" id="bookingNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:110px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="itemColor_<? echo $tblRow; ?>" id="itemColor_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('item_color_id')]]; ?>" placeholder="<? echo $row[csf('item_color_id')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="aopColor_<? echo $tblRow; ?>" id="aopColor_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('aop_color_id')]]; ?>" style="width:110px" placeholder="<? echo $row[csf('aop_color_id')]; ?>" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="gsm_<? echo $tblRow; ?>" id="gsm_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('gsm')]; ?>"  style="width:70px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="bodyPart_<? echo $tblRow; ?>" id="bodyPart_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $body_part[$row[csf('body_part')]]; ?>" placeholder="<? echo $row[csf('body_part')]; ?>" style="width:70px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="uom_<? echo $tblRow; ?>" id="uom_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $unit_of_measurement[$row[csf('uom')]]; ?>" placeholder="<? echo $row[csf('uom')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="quantity_<? echo $tblRow; ?>" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:70px;" disabled="disabled" />
                        </td>
                        <td>
                        <input type="text" name="rate_<? echo $tblRow; ?>" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:70px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_rate')]; ?>" />
                        </td>
                        <td>
                            <input type="text" name="amount_<? echo $tblRow; ?>" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:80px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_amount')]; ?>" />
                            <input type="hidden" name="updateIdDtls_<? echo $tblRow; ?>" id="updateIdDtls_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>"/>
                            <input type="hidden" name="bookingWithoutOrder_<? echo $tblRow; ?>" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="0"/>
                        </td>
                    </tr>
                	<?
					$tot_amount+=$row[csf('amount')];
					//$net_total_amount+=$row[csf('net_pi_amount')];
                }
				$sql_mst=sql_select("select total_amount, upcharge, discount, net_total_amount from com_pi_master_details where id =$import_id ");
				$upcharge=$sql_mst[0][csf("upcharge")];
				$discount=$sql_mst[0][csf("discount")];
				$net_total_amount=$sql_mst[0][csf("net_total_amount")];
            	?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo $upcharge; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>

                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo $discount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $net_total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
            </tfoot>
        </table>
        <?
	}
	else if($item_catagory_id==104 || $item_catagory_id==102)
	{
		?>
        <table class="rpt_table" width="100%" cellspacing="0" cellpadding="0" border="1" rules="all" id="tbl_pi_item">
            <thead>
                <th>Job No</th>
                <th>Booking No</th>
                <th>Gmts. Item</th>
                <th>Body Part</th>
                <th>Process /Embl. Name</th>
                <th>Embl. Type</th>
                <th>Description</th>
                <th>GMTS Color</th>
                <th>GMTS Size</th>
                <th>UOM</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Amount</th>
            </thead>
            <tbody id="pi_details_container">
            <?
				//$emblishment_print_type
				//$emblishment_embroy_type
				if($item_catagory_id==104) $emb_type_arr=$emblishment_embroy_type; else $emb_type_arr=$emblishment_print_type;
                $tblRow=0;
				$sql = "select id, work_order_no, work_order_id, work_order_dtls_id, booking_no, gmts_item_id, body_part_id as body_part, embell_name as emb_name, embell_type as emb_type, item_description as item_desc, color_id as gmt_color_id, size_id as gmt_size, uom, quantity, rate, amount, net_pi_rate, net_pi_amount from com_pi_item_details where pi_id='$import_id' and status_active=1 and is_deleted=0";

                /*$sql = "select id, work_order_no, work_order_id, work_order_dtls_id, booking as booking_no, gmts_item_id, body_part, main_process_id as emb_name, embl_type as emb_type, item_desc, color_id as gmt_color_id, item_size as gmt_size, uom, quantity, rate, amount, net_pi_rate, net_pi_amount
				from com_export_pi_dtls
				where pi_id='$export_id' and quantity>0 and status_active=1 and is_deleted=0";*/
				//echo $sql;
                $data_array=sql_select($sql);
                foreach($data_array as $row)
                {
                    $tblRow++;

                    if($tblRow%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" id="row_<? echo $tblRow; ?>" align="center">
                        <td>
                            <input type="text" name="workOrderNo_<? echo $tblRow; ?>" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" disabled="disabled" />
                            <input type="hidden" name="hideWoId_<? echo $tblRow; ?>" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_id')]; ?>" readonly />
                            <input type="hidden" name="hideWoDtlsId_<? echo $tblRow; ?>" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_dtls_id')]; ?>" readonly />
                        </td>
                        <td>
                            <input type="text" name="bookingNo_<? echo $tblRow; ?>" id="bookingNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:110px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="gmtsItem_<? echo $tblRow; ?>" id="gmtsItem_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $garments_item[$row[csf('gmts_item_id')]]; ?>" placeholder="<? echo $row[csf('gmts_item_id')]; ?>" style="width:110px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="bodyPart_<? echo $tblRow; ?>" id="bodyPart_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $body_part[$row[csf('body_part')]]; ?>" placeholder="<? echo $row[csf('body_part')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="embName_<? echo $tblRow; ?>" id="embName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $emblishment_name_array[$row[csf('emb_name')]]; ?>" placeholder="<? echo $row[csf('emb_name')]; ?>" style="width:70px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="embType_<? echo $tblRow; ?>" id="embType_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $emb_type_arr[$row[csf('emb_type')]]; ?>" placeholder="<? echo $row[csf('emb_type')]; ?>" style="width:70px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="itemdescription_<? echo $tblRow; ?>" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('item_desc')]; ?>" style="width:110px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="itemColor_<? echo $tblRow; ?>" id="itemColor_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('gmt_color_id')]]; ?>" placeholder="<? echo $row[csf('gmt_color_id')]; ?>" style="width:70px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="itemSize_<? echo $tblRow; ?>" id="itemSize_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $size_library[$row[csf('gmt_size')]]; ?>" placeholder="<? echo $row[csf('gmt_size')]; ?>" style="width:60px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="uom_<? echo $tblRow; ?>" id="uom_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $unit_of_measurement[$row[csf('uom')]]; ?>" placeholder="<? echo $row[csf('uom')]; ?>" style="width:60px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="quantity_<? echo $tblRow; ?>" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:70px;" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="rate_<? echo $tblRow; ?>" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:70px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_rate')]; ?>" />
                        </td>
                        <td>
                            <input type="text" name="amount_<? echo $tblRow; ?>" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:80px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_amount')]; ?>" />
                            <input type="hidden" name="updateIdDtls_<? echo $tblRow; ?>" id="updateIdDtls_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>"/>
                            <input type="hidden" name="bookingWithoutOrder_<? echo $tblRow; ?>" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="0"/>
                        </td>
                    </tr>
                	<?
					$tot_amount+=$row[csf('amount')];
					//$net_total_amount+=$row[csf('net_pi_amount')];
                }
				$sql_mst=sql_select("select total_amount, upcharge, discount, net_total_amount from com_pi_master_details where id =$import_id ");
				$upcharge=$sql_mst[0][csf("upcharge")];
				$discount=$sql_mst[0][csf("discount")];
				$net_total_amount=$sql_mst[0][csf("net_total_amount")];
            ?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo $upcharge; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo $discount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $net_total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
            </tfoot>
        </table>
        <?
	}
	else if($item_catagory_id==103)
	{
		?>
        <table class="rpt_table" width="100%" cellspacing="0" cellpadding="0" border="1" rules="all" id="tbl_pi_item">
            <thead>
                <th>Job No</th>
                <th>Booking No</th>
                <th>Gmts. Item</th>
                <th>Style No</th>
                <th>Color</th>
                <th>Wash Desc</th>
                <th>Process</th>
                <th>Wash Type</th>
                <th>UOM</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Amount</th>
            </thead>
            <tbody id="pi_details_container">
            <?
                $tblRow=0;
				$sql = "select id, work_order_no, work_order_id, work_order_dtls_id, booking_no, gmts_item_id, color_id as color_id, item_description as item_desc, embell_name as process_id, embell_type as wash_type, uom, quantity, rate, amount, net_pi_rate, net_pi_amount, buyer_style_ref 
				from com_pi_item_details where pi_id='$import_id' and status_active=1 and is_deleted=0";

                /*$sql = "select id, work_order_no, work_order_id, work_order_dtls_id, booking as booking_no, gmts_item_id, color_id as color_id, item_desc, main_process_id as process_id, wash_type as wash_type,uom, quantity, rate, amount, net_pi_rate, net_pi_amount
				from com_export_pi_dtls
				where pi_id='$export_id' and quantity>0 and status_active=1 and is_deleted=0";*/
				//echo $sql;
                $data_array=sql_select($sql);
                foreach($data_array as $row)
                {
                    $tblRow++;
					if($row[csf('process_id')]==1) $wash_process_type=$wash_wet_process;
					else if($row[csf('process_id')]==2) $wash_process_type=$wash_dry_process;
					else if($row[csf('process_id')]==3) $wash_process_type=$wash_laser_desing;

				    if($tblRow%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                    ?>
                    <tr bgcolor="<? echo $bgcolor; ?>" id="row_<? echo $tblRow; ?>" align="center">
                        <td>
                            <input type="text" name="workOrderNo_<? echo $tblRow; ?>" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" disabled="disabled" />
                            <input type="hidden" name="hideWoId_<? echo $tblRow; ?>" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_id')]; ?>" readonly />
                            <input type="hidden" name="hideWoDtlsId_<? echo $tblRow; ?>" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('work_order_dtls_id')]; ?>" readonly />
                        </td>
                        <td>
                            <input type="text" name="bookingNo_<? echo $tblRow; ?>" id="bookingNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="gmtsItem_<? echo $tblRow; ?>" id="gmtsItem_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $garments_item[$row[csf('gmts_item_id')]]; ?>" placeholder="<? echo $row[csf('gmts_item_id')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="styleRef_<? echo $tblRow; ?>" id="styleRef_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('buyer_style_ref')]; ?>" placeholder="<? echo $row[csf('buyer_style_ref')]; ?>" style="width:80px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="itemColor_<? echo $tblRow; ?>" id="itemColor_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('color_id')]]; ?>" placeholder="<? echo $row[csf('color_id')]; ?>" style="width:70px" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="itemdescription_<? echo $tblRow; ?>" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('item_desc')]; ?>" style="width:100px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="embName_<? echo $tblRow; ?>" id="embName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $wash_type[$row[csf('process_id')]]; ?>" placeholder="<? echo $row[csf('process_id')]; ?>" style="width:70px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="embType_<? echo $tblRow; ?>" id="embType_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $wash_process_type[$row[csf('wash_type')]]; ?>" placeholder="<? echo $row[csf('wash_type')]; ?>" style="width:70px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="uom_<? echo $tblRow; ?>" id="uom_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $unit_of_measurement[$row[csf('uom')]]; ?>" placeholder="<? echo $row[csf('uom')]; ?>" style="width:60px" disabled="disabled"/>
                        </td>
                        <td>
                            <input type="text" name="quantity_<? echo $tblRow; ?>" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:70px;" disabled="disabled" />
                        </td>
                        <td>
                            <input type="text" name="rate_<? echo $tblRow; ?>" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:70px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_rate')]; ?>" />
                        </td>
                        <td>
                            <input type="text" name="amount_<? echo $tblRow; ?>" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:80px;" disabled="disabled" placeholder="<? echo $row[csf('net_pi_amount')]; ?>" />
                            <input type="hidden" name="updateIdDtls_<? echo $tblRow; ?>" id="updateIdDtls_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>"/>
                            <input type="hidden" name="bookingWithoutOrder_<? echo $tblRow; ?>" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="0"/>
                        </td>
                    </tr>
                	<?
					$tot_amount+=$row[csf('amount')];
					//$net_total_amount+=$row[csf('net_pi_amount')];
                }
				$sql_mst=sql_select("select total_amount, upcharge, discount, net_total_amount from com_pi_master_details where id =$import_id ");
				$upcharge=$sql_mst[0][csf("upcharge")];
				$discount=$sql_mst[0][csf("discount")];
				$net_total_amount=$sql_mst[0][csf("net_total_amount")];
            ?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo $upcharge; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo $discount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>

                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $net_total_amount; ?>" style="width:75px;" readonly/>
                    </td>
                </tr>
            </tfoot>
        </table>
        <?
	}

	exit();
}

if ($action=="goods_rcv_variable_form_lib")
{
	$data_ref=explode("***",$data);
	$goods_rcv_status=$data_ref[0];
	$cbo_importer_id=$data_ref[1];
	$goods_rcv_variable="";
	if($goods_rcv_status==2)
	{
		$goods_rcv_variable=1;
	}
	else
	{
		$goods_rcv_variable=return_field_value("export_invoice_qty_source as source","variable_settings_commercial","company_name=$cbo_importer_id and variable_list=23 and status_active=1","source");
		if($goods_rcv_variable!=1) $goods_rcv_variable=2;
	}
	echo $goods_rcv_variable;die;
}

///Save Item Details Table

if ($action=="save_update_delete_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$con = connect();
	$cbo_item_category_id=str_replace("'","",$cbo_item_category_id);
	$master_category_id=str_replace("'","",$cbo_item_category_id);

	$conver_factor=return_library_array("select a.id, b.conversion_factor from product_details_master a, lib_item_group b where a.item_group_id=b.id and a.entry_form=24","id","conversion_factor");

	$goods_rcv_status=str_replace("'","",$cbo_goods_rcv_status);
	if($goods_rcv_status==2)
	{
		$goods_rcv_variable=1;
	}
	else
	{
		$goods_rcv_variable=return_field_value("export_invoice_qty_source as source","variable_settings_commercial","company_name=$cbo_importer_id and variable_list=23 and status_active=1","source");
		//echo "11**$goods_rcv_variable";die;
		if($goods_rcv_variable!=1) $goods_rcv_variable=2;
	}
	
	$variable_set_invent = sql_select("select category,over_rcv_status,over_rcv_percent,over_rcv_payment from variable_inv_ile_standard where company_name=$cbo_importer_id and variable_list=23 and category = 1 order by id");
	$over_receive_limit = !empty($variable_set_invent) ? $variable_set_invent[0][csf('over_rcv_percent')] : 0;

	//echo "10** WO Pay Mode Not Match $txt_deleted_id**1"; die;

	$current_unblock_amt=$current_unblock_update_amt=$current_unblock_delete_amt=0;
	$all_dtls_id="";$all_wo_no='';$tst=0;
	$all_wo_id_arr=array();
	for($i=1;$i<=$total_row;$i++)
	{
		$uom="uom_".$i;
		$updateIdDtls="updateIdDtls_".$i;
		$colorName="colorName_".$i;
		$countName="countName_".$i;
		$yarnCompositionItem1="yarnCompositionItem1_".$i;
		$yarnType="yarnType_".$i;
		$quantity="quantity_".$i;
		$amount="amount_".$i;
		$hideOrdeSource="hideOrdeSource_".$i;
		$hideWoId="hideWoId_".$i;
		$workOrderNo="workOrderNo_".$i;

		$updateIdDtls="updateIdDtls_".$i;
		$workOrderId="hideWoId_".$i;
		$workOrderDtlsId="hideWoDtlsId_".$i;
		$hideTransData="hideTransData_".$i;
		$bookingWithoutOrder_s="bookingWithoutOrder_".$i;
		$all_WoId.=str_replace("'","",$$workOrderId).",";
		
		$itemgroupid="itemgroupid_".$i;
		$itemdescription="itemdescription_".$i;
		$sizeName="sizeName_".$i;
		$itemColor="itemColor_".$i;
		$itemSize="itemSize_".$i;
		
		if(str_replace("'","",$$hideWoId)>0) $all_wo_id_arr[str_replace("'","",$$hideWoId)]=str_replace("'","",$$hideWoId);

		if(str_replace("'","",$$hideWoId)>0 && str_replace("'","",$$cbo_goods_rcv_status)==2)
		{
			$pay_mode=return_field_value("pay_mode","wo_non_order_info_mst","id=".str_replace("'","",$$hideWoId)." and status_active=1","pay_mode");
			if($pay_mode!=2)
			{
				echo "14** WO Pay Mode Not Match.**1"; disconnect($con);die;
			}
		}
		$test_dd.=str_replace("'","",$$hideOrdeSource)."=";
		if(str_replace("'","",$$hideOrdeSource)!=5)
		{

			$test_dds.=str_replace("'","",$$hideOrdeSource)."=";
			$tot_current_unblock_amt+=str_replace("'","",$$amount);
			if(str_replace("'","",$$updateIdDtls)=="")
			{
				$current_unblock_amt+=str_replace("'","",$$amount);
			}
			else
			{
				$current_unblock_update_amt+=str_replace("'","",$$amount);
			}
			//echo "11**test".$color_id = return_id1( str_replace("'","",$$colorName), "lib_color", "color_name",164,$con);die;
			
			if(str_replace("'","",$$colorName)!="")
			{
				if (!in_array(str_replace("'","",$$colorName),$new_array_color))
				{
					$color_id = return_id( str_replace("'","",$$colorName), $color_library, "lib_color", "id,color_name","405");
					$new_array_color[$color_id]=str_replace("'","",$$colorName);
				}
				else $color_id =  array_search(str_replace("'","",$$colorName), $new_array_color);
			}
			else
			{
				$color_id=0;
			}
			
			
			
			if(str_replace("'", '',$cbo_item_category_id)==4)
			{
				if(str_replace("'","",$$itemColor)!="")
				{
					if (!in_array(str_replace("'","",$$itemColor),$new_array_color))
					{
						$item_color_id = return_id( str_replace("'","",$$itemColor), $color_library, "lib_color", "id,color_name","405");
						$new_array_color[$item_color_id]=str_replace("'","",$$itemColor);
					}
					else $item_color_id =  array_search(str_replace("'","",$$itemColor), $new_array_color);
				}
				else
				{
					$item_color_id=0;
				}
				
				
				if(str_replace("'","",$$sizeName)!="")
				{
					if (!in_array(str_replace("'","",$$sizeName),$new_array_size))
					{
					  $size_id = return_id( str_replace("'","",$$sizeName), $size_library, "lib_size", "id,size_name","405");
					  $new_array_size[$size_id]=str_replace("'","",$$sizeName);
					}
					else $size_id =  array_search(str_replace("'","",$$sizeName), $new_array_size);
				}
				else
				{
					$size_id=0;
				}
			}
			
			
			$tst++;
			$pi_item_qnty=number_format(str_replace("'","",$$quantity),4,".","");
			$pi_prev_data[str_replace("'","",$update_id)][str_replace("'","",$color_id)][str_replace("'","",$$countName)][str_replace("'","",$$yarnCompositionItem1)][str_replace("'","",$$yarnType)]+=$pi_item_qnty;
			
			$pi_acc_prev_data[str_replace("'","",$update_id)][str_replace("'","",$$itemgroupid)][trim(str_replace("'","",$$itemdescription))][str_replace("'","",$color_id)][str_replace("'","",$size_id)][str_replace("'","",$item_color_id)][str_replace("'","",$$itemSize)]+=$pi_item_qnty;
		}
		
		$pi_item_qnty=number_format(str_replace("'","",$$quantity),2,".","");
		if(str_replace("'", '',$cbo_pi_basis_id)==1 && str_replace("'", '',$cbo_goods_rcv_status)==1 && $goods_rcv_variable != 1 && (str_replace("'", '',$cbo_item_category_id)!=12 && str_replace("'", '',$cbo_item_category_id)!=25 && str_replace("'", '',$cbo_item_category_id)!=102 && str_replace("'", '',$cbo_item_category_id)!=103 && str_replace("'", '',$cbo_item_category_id)!=104 && str_replace("'", '',$cbo_item_category_id)!=31))
		{
			$hideTransData_arr=explode("__",str_replace("'","",$$hideTransData));
			foreach($hideTransData_arr as $hide_trans_val)
			{
				$hide_trans_val_arr=explode("_",$hide_trans_val);
				if($hide_trans_val_arr[0]>0) $all_dtls_id.=$hide_trans_val_arr[0].",";
			}
		}
		else
		{
			$all_dtls_id.=str_replace("'","",$$workOrderDtlsId).",";
			$all_wo_no.=$$workOrderNo.",";
			$bookingWithoutOrder_ss.=str_replace("'","",$$bookingWithoutOrder_s).",";
		}
	}
	$all_wo_no=implode(",",array_unique(explode(",",chop($all_wo_no,','))));
	$bookingWithoutOrder_ss=implode(",",array_unique(explode(",",chop($bookingWithoutOrder_ss,','))));
	
	//echo "10**".$bookingWithoutOrder_ss;die;
	if($operation!=2)
	{
		$item_cat_not_validate_arr=array('12', '24', '25', '28', '30', '31', '42', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '86', '87', '88', '95', '96', '98', '100', '101', '102', '103', '104', '105', '108', '109', '112', '113', '114', '115', '116');
		
		if(!in_array($cbo_item_category_id,$item_cat_not_validate_arr))
		{
			$pi_com_id=return_field_value("importer_id as importer_id","com_pi_master_details","id=$update_id and status_active=1","importer_id");
			if($cbo_item_category_id !=2 && $cbo_item_category_id !=3 && $cbo_item_category_id !=4 && $cbo_item_category_id !=13 && $cbo_item_category_id !=14)
			{
				$book_com_id=return_field_value("max(company_name) as company_id","wo_non_order_info_mst","id in(".implode(",",$all_wo_id_arr).") and status_active=1","company_id");
				
			}
			else
			{
				if($bookingWithoutOrder_ss==1)
				{
					$book_com_id=return_field_value("max(company_id) as company_id","wo_non_ord_samp_booking_mst","id in(".implode(",",$all_wo_id_arr).") and status_active=1","company_id");
				}
				else
				{
					$book_com_id=return_field_value("max(company_id) as company_id","wo_booking_mst","id in(".implode(",",$all_wo_id_arr).") and status_active=1","company_id");
				}
			}
			
			if($pi_com_id!=$book_com_id && count($all_wo_id_arr)>0)
			{
				echo "14** PI Company And Booking Company Not Match. PI Com=$pi_com_id, Booking Com=$book_com_id, **1";disconnect($con);die;
			}
		}
	}
	
	
	$category_conds="";$category_conds2="";$category_conds3="";
	if($cbo_item_category_id==8)
	{
		$category_conds=" and b.item_category in(select category_id from lib_item_category_list where category_type=1)";
		$category_conds2=" and c.item_category_id in(select category_id from lib_item_category_list where category_type=1)";
		$category_conds3=" and a.item_category_id in(select category_id from lib_item_category_list where category_type=1)";
	}
	else
	{
		$category_conds=" and b.item_category=$cbo_item_category_id";
		$category_conds2=" and c.item_category_id=$cbo_item_category_id";
		$category_conds3=" and a.item_category_id=$cbo_item_category_id";
	}
	
	if($cbo_goods_rcv_status==2 && $operation!=0)
	{
		$sql_attach_mrr_query = "select a.id as mst_id, b.pi_wo_batch_no, b.cons_quantity as qnty, b.prod_id, c.color, c.yarn_count_id, c.yarn_comp_type1st, c.yarn_type, c.item_group_id, c.item_description, c.item_color, c.gmts_size, c.item_size
		from inv_receive_master a, inv_transaction b, product_details_master c
		where a.id=b.mst_id and b.prod_id=c.id and a.booking_id=$update_id and a.receive_basis=1 and b.transaction_type=1 $category_conds $category_conds2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0";
		//echo "14** PI Quantity Not Allow Less Then Mrr Quantity.**1".$sql_attach_mrr_query;die;
		$sql_attach_mrr=sql_select($sql_attach_mrr_query);
		if($cbo_item_category_id==1)
		{
			$prev_block_pi_data=sql_select("select a.work_order_id, b.supplier_order_quantity as quantity, b.amount from com_pi_item_details a, wo_non_order_info_dtls b
			where a.work_order_dtls_id=b.id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.order_source=5 and a.pi_id=$update_id");
			$prev_block_wo_amount=0;
			foreach($prev_block_pi_data as $row)
			{
				$prev_block_wo_amount+=$row[csf("amount")];
			}
			if($prev_block_wo_amount>0 && $tot_current_unblock_amt > $prev_block_wo_amount)
			{
				echo "14** PI Amount Not Allow Over Block WO Amount $prev_block_wo_amount $tot_current_unblock_amt  $test_dd $test_dds.**1";disconnect($con); die;
			}
			//echo "11**";print_r($prev_block_wo_amount_arr);die;

			if(count($sql_attach_mrr)>0)
			{
				$mrr_data=array();
				foreach($sql_attach_mrr as $row)
				{
					$all_mst_id.=$row[csf('mst_id')].",";
					$mrr_data[$row[csf('pi_wo_batch_no')]][$row[csf('color')]][$row[csf('yarn_count_id')]][$row[csf('yarn_comp_type1st')]][$row[csf('yarn_type')]]+=$row[csf('qnty')];
				}
				//echo "10**";print_r($mrr_data);die;
				$all_mst_id=chop($all_mst_id,",");

				$sql_attach_mrr_rtn=sql_select("select a.pi_id as pi_wo_batch_no, c.color, c.yarn_count_id, c.yarn_comp_type1st, c.yarn_type, b.cons_quantity as qnty
				from inv_issue_master a, inv_transaction b, product_details_master c
				where a.id=b.mst_id and b.prod_id=c.id and a.pi_id=$update_id and a.pi_id>0 and a.entry_form=8 and b.transaction_type=3 and b.item_category=$cbo_item_category_id and c.item_category_id=$cbo_item_category_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0");

				$mrr_rtn_data=array();
				foreach($sql_attach_mrr_rtn as $row)
				{
					$mrr_rtn_data[$row[csf('pi_wo_batch_no')]][$row[csf('color')]][$row[csf('yarn_count_id')]][$row[csf('yarn_comp_type1st')]][$row[csf('yarn_type')]]+=$row[csf('qnty')];
				}
				//echo "14** PI Quantity Not Allow Less Then Mrr Quantity.**1";print_r($mrr_data);die;
				foreach($mrr_data as $pi_up_id=>$color_data)
				{
					foreach($color_data as $pi_color_id=>$count_data)
					{
						foreach($count_data as $pi_count_id=>$composition_data)
						{
							foreach($composition_data as $pi_composition_id=>$type_data)
							{
								foreach($type_data as $pi_type_id=>$mrr_qnty)
								{
									$pi_qnty=$mrr_rtn_qnty=0;
									$pi_qnty=number_format($pi_prev_data[$pi_up_id][$pi_color_id][$pi_count_id][$pi_composition_id][$pi_type_id],2,".","");
									$mrr_rtn_qnty=number_format($mrr_rtn_data[$pi_up_id][$pi_color_id][$pi_count_id][$pi_composition_id][$pi_type_id],2,".","");
									$mrr_qnty=$mrr_qnty-$mrr_rtn_qnty;
									$over_receive_limit_qnty = ($over_receive_limit>0)?($over_receive_limit / 100) * $pi_qnty:0;
									$pi_qnty = number_format(($pi_qnty +$over_receive_limit_qnty),2,'.','');
									if(number_format($pi_qnty,2,".","") < number_format($mrr_qnty,2,".","") && $pi_prev_data[$pi_up_id][$pi_color_id][$pi_count_id][$pi_composition_id][$pi_type_id]>0)
									{
										echo "14** PI Quantity Not Allow Less Then Mrr Quantity. Pi Qnty = $pi_qnty , Mrr Qnty = $mrr_qnty , Return Qnty = $mrr_rtn_qnty**1";disconnect($con); die;
									}
								}
							}
						}
					}
				}
			}
		}
		else if($cbo_item_category_id !=1 && $cbo_item_category_id !=2 && $cbo_item_category_id !=3 && $cbo_item_category_id !=4 && $cbo_item_category_id !=13 && $cbo_item_category_id !=14)
		{
			
			foreach($sql_attach_mrr as $row)
			{
				$mrr_data[$row[csf("pi_wo_batch_no")]][$row[csf("prod_id")]]+=number_format($row[csf("qnty")],2,".","");;
			}

			for($i=1;$i<=$total_row;$i++)
			{
				$itemProdId="itemProdId_".$i;
				$quantity="quantity_".$i;
				$pi_item_qnty=number_format(str_replace("'","",$$quantity),2,".","");
				$pi_prev_data[str_replace("'","",$update_id)][str_replace("'","",$$itemProdId)]+=$pi_item_qnty;
			}

			foreach($mrr_data as $pi_up_id=>$prod_data)
			{
				foreach($prod_data as $prod_id=>$mrr_qnty)
				{
					$pi_qnty=number_format($pi_prev_data[$pi_up_id][$prod_id],2,".","");
					//$test_data.=$pi_up_id."=".$prod_id."=".$mrr_qnty."=".$pi_qnty."_";
					if($pi_qnty < $mrr_qnty)
					{
						echo "14** PI Quantity Not Allow Less Then Mrr Quantity.**1"; disconnect($con);die;
					}
				}
			}
		}
		else if($cbo_item_category_id==4)
		{
			if(count($sql_attach_mrr)>0)
			{
				$mrr_data=array();
				foreach($sql_attach_mrr as $row)
				{
					$all_mst_id.=$row[csf('mst_id')].",";
					$mrr_data[$row[csf('pi_wo_batch_no')]][$row[csf('item_group_id')]][trim($row[csf('item_description')])][$row[csf('color')]][$row[csf('gmts_size')]][$row[csf('item_color')]][$row[csf('item_size')]]+=$row[csf('qnty')];
				}
				//echo "10**";print_r($mrr_data);die;
				$all_mst_id=chop($all_mst_id,",");
				//echo "14** PI Quantity Not Allow Less Then Mrr Quantity.**1";print_r($mrr_data);die;
				foreach($mrr_data as $pi_up_id=>$pi_wo_data)
				{
					foreach($pi_wo_data as $item_group_id=>$group_data)
					{
						foreach($group_data as $item_description=>$description_data)
						{
							foreach($description_data as $gmts_color=>$gmts_color_data)
							{
								foreach($gmts_color_data as $gmts_size=>$gmts_size_data)
								{
									foreach($gmts_size_data as $item_color=>$item_color_data)
									{
										foreach($item_color_data as $item_size=>$mrr_qnty)
										{
											$pi_qnty=0;
											$pi_qnty=number_format($pi_acc_prev_data[$pi_up_id][$item_group_id][$item_description][$gmts_color][$gmts_size][$item_color][$item_size],4,".","");
											$org_pi_qnty=number_format($pi_acc_prev_data[$pi_up_id][$item_group_id][$item_description][$gmts_color][$gmts_size][$item_color][$item_size],4,".","");
											$over_receive_limit_qnty = ($over_receive_limit>0)?($over_receive_limit / 100) * $pi_qnty:0;
											$pi_qnty = number_format(($pi_qnty +$over_receive_limit_qnty),4,'.','');
											if(number_format($pi_qnty,4,".","") < number_format($mrr_qnty,4,".","") && number_format($pi_qnty,4,".","")>0)
											{
												echo "14** PI Quantity Not Allow Less Then Mrr Quantity. Pi Qnty = $pi_qnty , Mrr Qnty = $mrr_qnty , org pi qnty = $org_pi_qnty**1";disconnect($con); die;
											}
										}
									}
									
								}
							}
						}
					}
				}
			}
		}
		else
		{

			if(count($sql_attach_mrr)>0)
			{
				echo "14** MRR Found Update Not Allow.**1";disconnect($con);die;
			}
		}
	}

	if(str_replace("'","",$export_pi_id)!="") $is_sales=1; else $is_sales=0;
	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$id=return_next_id( "id","com_pi_item_details", 1 ) ;

		$field_array="id, pi_id, work_order_no, work_order_id, work_order_dtls_id, booking_without_order, determination_id, item_prod_id, item_group, item_description, hs_code, color_id, size_id, item_size, count_name, yarn_composition_item1, yarn_composition_percentage1, yarn_composition_item2, yarn_composition_percentage2, fabric_composition, fabric_construction, yarn_type, gsm, dia_width, weight, item_color, uom, quantity, rate, amount, net_pi_rate, net_pi_amount, service_type, brand_supplier, gmts_item_id, embell_name, embell_type, lot_no, yarn_color, color_range, test_for, test_item_id, remarks, body_part_id, fabric_ref, rd_no, fab_type, fab_design, fab_weight, fab_weight_type, cutable_width, width_dia_type, item_category_id, after_goods_source, inserted_by, insert_date, is_sales, order_source, order_id, order_no, buyer_style_ref, booking_article_no";

		$field_array_update="total_amount*upcharge*upcharge_breakdown*discount*discount_breakdown*net_total_amount";
		if($cbo_currency_id==1)
		{
			$txt_total_amount=number_format($txt_total_amount,$dec_place[4],'.','');
			$txt_total_amount_net=number_format($txt_total_amount_net,$dec_place[4],'.','');
		}
		else
		{
			$txt_total_amount=number_format($txt_total_amount,$dec_place[5],'.','');
			$txt_total_amount_net=number_format($txt_total_amount_net,$dec_place[5],'.','');
		}
		$data_array_update=$txt_total_amount."*'".$txt_upcharge."'*'".$up_charge_break_down."'*'".$txt_discount."'*'".$discount_break_down."'*".$txt_total_amount_net;
		$all_dtls_id=chop($all_dtls_id,",");
		$all_WoId=implode(",",array_unique(explode(",",chop($all_WoId,","))));

		$bookingWithoutOrder_s=implode(",",array_filter(array_unique(explode(",",chop($$bookingWithoutOrder_s,",")))));
		//echo "5**$cbo_goods_rcv_status = $goods_rcv_variable";die;
		if(str_replace("'", '',$cbo_goods_rcv_status) == 1 && $goods_rcv_variable !=1)
		{
			if($all_dtls_id=="") $all_dtls_id=0;
			if(str_replace("'", '',$cbo_item_category_id)==12)
			{
				if(str_replace("'", '',$txt_order_type)==1)
				{
					$wo_qnty_arr=return_library_array("select id, wo_qnty as qnty from wo_booking_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else if(str_replace("'", '',$txt_order_type)==4)
				{
					$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from knitting_work_order_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else if(str_replace("'", '',$txt_order_type)==5)
				{
					$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from dyeing_work_order_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else
				{
					$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from wo_non_ord_aop_booking_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
			}
			else if(str_replace("'", '',$cbo_item_category_id)==25 || str_replace("'", '',$cbo_item_category_id)==102 || str_replace("'", '',$cbo_item_category_id)==103 || str_replace("'", '',$cbo_item_category_id)==104)
			{
				$wo_qnty_arr=return_library_array("select id, wo_qnty as qnty from wo_booking_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
			}
			else if(str_replace("'", '',$cbo_item_category_id)==31 || str_replace("'", '',$cbo_item_category_id)==115)
			{
				if(str_replace("'", '',$cbo_item_category_id)==31)
				{
					$wo_amnt_arr=return_library_array("select id, wo_value as wo_value from wo_labtest_dtls where status_active=1 and id in($all_dtls_id)","id","wo_value");
				}
				else
				{
					$wo_amnt_arr=return_library_array("select id, amount as wo_value from wo_inspection_dtls where status_active=1 and id in($all_dtls_id)","id","wo_value");
				}
				
				$prev_pi_amnt_arr=return_library_array( "select b.work_order_dtls_id,sum(b.amount) as amnt from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$cbo_item_category_id and a.pi_basis_id=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($all_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "amnt");
			}
			else if(str_replace("'", '',$cbo_item_category_id)==4)
			{
				if(str_replace("'", '',$txt_order_type)==2)
				{
					$wo_qnty_arr=return_library_array("select id, cons_quantity as qnty from inv_transaction where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else
				{
					$ort_trans_sql=sql_select("select TRANS_ID, PO_BREAKDOWN_ID, QUANTITY from order_wise_pro_details where status_active=1 and TRANS_ID in($all_dtls_id)");
					foreach($ort_trans_sql as $val)
					{
						$wo_qnty_arr[$val["TRANS_ID"]][$val["PO_BREAKDOWN_ID"]]+=$val["QUANTITY"];
					}
					//$wo_qnty_arr=return_library_array("select trans_id, quantity as qnty from order_wise_pro_details where status_active=1 and id in($all_dtls_id)","id","qnty");
				}				
			}
			else if(str_replace("'", '',$cbo_item_category_id)==14)
			{
				$wo_qnty_arr=return_library_array("select id, cons_quantity as qnty from inv_transaction where status_active=1 and id in($all_dtls_id)","id","qnty");			
			}
			else
			{
				$wo_qnty_arr=return_library_array("select id, cons_quantity as qnty from inv_transaction where status_active=1 and id in($all_dtls_id)","id","qnty");
			}

			$previous_pi_qty=return_library_array("select b.work_order_dtls_id as id, sum(b.quantity) as qnty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id $category_conds3 and a.after_goods_source=2 and b.after_goods_source=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($all_dtls_id) group by b.work_order_dtls_id","id","qnty");


			if(str_replace("'","",$cbo_item_category_id)==4)
			{
				if(str_replace("'", '',$txt_order_type)==2)
				{
					$prev_retun_sql="select booking_id, prod_id, issue_qnty as qty, 0 as order_id from inv_trims_issue_dtls where booking_id>0 and booking_id in($all_WoId) and status_active=1 order by booking_id,prod_id";
				}
				else
				{
					$prev_retun_sql="select a.booking_id, a.prod_id, b.po_breakdown_id as order_id, b.quantity as qty from inv_trims_issue_dtls a, order_wise_pro_details b where a.trans_id=b.trans_id and a.booking_id>0 and a.booking_id in($all_WoId) and a.status_active=1 and b.entry_form=49 and b.trans_type=3 and b.status_active=1 order by a.booking_id,a.prod_id";
				}
				//echo "10**".$all_WoId;die;

				$prev_retun_sql_result=sql_select($prev_retun_sql);
				foreach($prev_retun_sql_result as $row)
				{
					$prev_retun_qnty[$row[csf("booking_id")]][$row[csf("prod_id")]][$row[csf("order_id")]]+=$row[csf("qty")];
				}
			}
			else
			{
				$prev_retun_qnty=return_library_array("select b.recv_trans_id, sum(b.issue_qnty) as qnty
				from inv_transaction a, inv_mrr_wise_issue_details b where a.id=b.issue_trans_id and a.transaction_type=3 and b.recv_trans_id in($all_dtls_id)and a.status_active=1 and b.status_active=1 group by recv_trans_id","recv_trans_id","qnty");
			}
		}
		else
		{
			if($all_dtls_id=="") $all_dtls_id=0;
			$booking_id_cond=""; $bokIds_cond=""; $all_dtls_arr=explode(",",$all_dtls_id);
			if($db_type==2 && count($all_dtls_arr)>999)
			{
				$booking_id_chunk_arr=array_chunk($all_dtls_arr,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" b.work_order_dtls_id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
			}
			else
			{
				$booking_id_cond=" and b.work_order_dtls_id in($all_dtls_id)";
			}

			$with_or_without_cond="";
			if ($bookingWithoutOrder_s)
			{
				$with_or_without_cond = " and b.booking_without_order in ($bookingWithoutOrder_s)";
			}

			$previous_pi_qty=return_library_array("select b.work_order_dtls_id as id, sum(b.quantity) as qnty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id $category_conds3 and a.after_goods_source=1 and b.after_goods_source=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.import_pi=0 $booking_id_cond $with_or_without_cond group by b.work_order_dtls_id","id","qnty");

			if(str_replace("'", '',$cbo_item_category_id)==1)
			{
				$wo_qnty_arr=return_library_array("select id, supplier_order_quantity as qnty from wo_non_order_info_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
			}


			else if(str_replace("'", '',$cbo_item_category_id)==2 || str_replace("'", '',$cbo_item_category_id)==13)
			{
				if(str_replace("'", '',$txt_order_type)==2)
				{
					$wo_qnty_arr=return_library_array("select b.id, b.finish_fabric as qnty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and b.status_active=1 and a.id in($all_WoId)","id","qnty");

					$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$cbo_item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_id in($all_WoId) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");

				}
				else
				{
					if(str_replace("'", '',$cbo_item_category_id)==13)
					{
						$wo_qnty_sql=sql_select("select a.id, a.booking_no, b.fabric_color_id, c.construction as construction, c.composition as copmposition, c.gsm_weight, b.dia_width, sum(b.grey_fab_qnty) as fin_fab_qnty, sum(b.grey_fab_qnty*b.rate) as amount, c.lib_yarn_count_deter_id, c.uom, 0 as dtls_id
						from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
						where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.id in($all_WoId) and a.status_active=1 and b.status_active=1
						group by a.id, a.booking_no, b.fabric_color_id, c.construction, c.composition, c.gsm_weight, b.dia_width,c.lib_yarn_count_deter_id,c.uom");
					}
					else
					{
						$wo_qnty_sql=sql_select("select a.id, a.booking_no, b.fabric_color_id, c.construction as construction, c.composition as copmposition, c.gsm_weight, b.dia_width, sum(b.fin_fab_qnty) as fin_fab_qnty, sum(b.fin_fab_qnty*b.rate) as amount, c.lib_yarn_count_deter_id, c.uom, 0 as dtls_id
						from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
						where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.id in($all_WoId) and a.status_active=1 and b.status_active=1
						group by a.id, a.booking_no, b.fabric_color_id, c.construction, c.composition, c.gsm_weight, b.dia_width,c.lib_yarn_count_deter_id,c.uom");
					}
					

					foreach($wo_qnty_sql as $row)
					{
						if($row[csf('fabric_color_id')]) $fab_color_id=$row[csf('fabric_color_id')]; else $fab_color_id=0;
						$wo_qnty_arr[$row[csf('booking_no')]][$row[csf('lib_yarn_count_deter_id')]][$fab_color_id][$row[csf('gsm_weight')]][strtoupper($row[csf('dia_width')])][$row[csf('uom')]]+=$row[csf('fin_fab_qnty')];
					}

					$sql_prev="select b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$cbo_item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_id in($all_WoId) group by b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom";// and b.work_order_dtls_id in($wo_dtls_id)
					$prevData=sql_select($sql_prev);
					foreach($prevData as $rowP)
					{
						$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('gsm')]][strtoupper($rowP[csf('dia_width')])][$rowP[csf('uom')]]=$rowP[csf('qty')];
					}
				}
			}

			else if(str_replace("'", '',$cbo_item_category_id)==3)
			{
				if(str_replace("'", '',$txt_order_type)==2)
				{
					$wo_qnty_sql=sql_select("SELECT a.id, a.booking_no, b.fabric_color as fabric_color_id, b.construction as construction, b.composition as copmposition, b.body_part as body_part_id, b.gsm_weight as weight, b.dia_width as dia_or_width, b.item_size as cutable_width, b.uom, sum(b.finish_fabric) as fin_fab_qnty, sum(b.finish_fabric*b.rate) as amount, b.lib_yarn_count_deter_id, 0 as dtls_id
					from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b 
					where a.booking_no=b.booking_no and a.id in($all_WoId) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0
					group by a.id, a.booking_no, b.fabric_color, b.construction, b.composition, b.body_part, b.gsm_weight, b.dia_width, b.item_size, b.uom, b.lib_yarn_count_deter_id
					order by a.booking_no, b.body_part");
					foreach($wo_qnty_sql as $row)
					{
						$wo_qnty_arr[$row[csf('booking_no')]][$row[csf('body_part_id')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('weight')]][$row[csf('dia_or_width')]][$row[csf('cutable_width')]][$row[csf('uom')]]=$row[csf('fin_fab_qnty')];
					}

					$sql_prev="SELECT b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.fab_weight_type, b.cutable_width, b.uom, sum(b.quantity) as qty 
                	from com_pi_master_details a, com_pi_item_details b 
                	where a.id=b.pi_id and a.item_category_id=$cbo_item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_id in($all_WoId) 
               		group by b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.fab_weight_type, b.cutable_width, b.uom";
					$prevData=sql_select($sql_prev);
					foreach($prevData as $rowP)
					{
						$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('body_part_id')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('fab_weight')]][$rowP[csf('fab_weight_type')]][$rowP[csf('cutable_width')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
					}
				}
				else
				{
					$wo_qnty_sql=sql_select("SELECT a.id, a.booking_no, b.fabric_color_id, c.construction as construction, c.composition as copmposition, b.gsm_weight as weight, c.gsm_weight_type as fab_weight_type, c.width_dia_type as dia_or_width, b.dia_width as width, b.item_size as cutable_width, sum(b.fin_fab_qnty) as fin_fab_qnty, sum(b.fin_fab_qnty*b.rate) as amount, c.lib_yarn_count_deter_id, c.body_part_id, c.uom, 0 as dtls_id
					from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c 
					where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.id in($all_WoId) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 
					group by a.id, a.booking_no, b.fabric_color_id, c.construction, c.composition, b.gsm_weight, c.gsm_weight_type, c.width_dia_type, b.dia_width, b.item_size, c.lib_yarn_count_deter_id, c.body_part_id, c.uom");

					foreach($wo_qnty_sql as $row)
					{
						if ($row[csf('fabric_color_id')]) $fab_color_id=$row[csf('fabric_color_id')]; else $fab_color_id=0;
						$wo_qnty_arr[$row[csf('booking_no')]][$row[csf('body_part_id')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('weight')]][$row[csf('fab_weight_type')]][$row[csf('dia_or_width')]][strtoupper($row[csf('width')])][$row[csf('cutable_width')]][$row[csf('uom')]]=$row[csf('fin_fab_qnty')];
					}
					//echo '<pre>';print_r($wo_qnty_arr);
					//$prev_pi_qty_arr=array();
					$sql_prev="SELECT b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.fab_weight_type, b.width_dia_type, b.dia_width, b.cutable_width, b.uom, sum(b.quantity) as qty 
                	from com_pi_master_details a, com_pi_item_details b 
                	where a.id=b.pi_id and a.item_category_id=$cbo_item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_id in($all_WoId) 
               		group by b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.fab_weight_type, b.width_dia_type, b.dia_width, b.cutable_width, b.uom";
					$prevData=sql_select($sql_prev);
					foreach($prevData as $rowP)
					{
						$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('body_part_id')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('fab_weight')]][$rowP[csf('fab_weight_type')]][$rowP[csf('width_dia_type')]][strtoupper($rowP[csf('dia_width')])][$rowP[csf('cutable_width')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
					}
					//echo '<pre>';print_r($prev_pi_qty_arr);
				}
			}
			else if(str_replace("'", '',$cbo_item_category_id)==14)
			{
				
				$wo_qnty_sql=sql_select("SELECT a.id, a.booking_no, b.fabric_color_id, b.construction as construction, b.copmposition as copmposition, sum(b.fin_fab_qnty) as fin_fab_qnty, sum(b.fin_fab_qnty*b.rate) as amount, c.determination_id as lib_yarn_count_deter_id, c.body_part_id, c.cons_uom as uom, b.id as dtls_id
				from wo_booking_mst a, wo_booking_dtls b, fabric_sales_order_dtls c 
				where a.booking_no=b.booking_no  and b.pre_cost_fabric_cost_dtls_id = c.mst_id and b.po_break_down_id = c.id and a.id in($all_WoId) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 
				group by a.id, a.booking_no, b.fabric_color_id, b.construction, b.copmposition, c.determination_id, c.body_part_id, c.cons_uom,b.id");

				foreach($wo_qnty_sql as $row)
				{
					if($row[csf('dia_or_width')] == 0 ) $row[csf('dia_or_width')] = "";
					if ($row[csf('fabric_color_id')]) $fab_color_id=$row[csf('fabric_color_id')]; else $fab_color_id=0;
					$wo_qnty_arr[$row[csf('booking_no')]][$row[csf('dtls_id')]][$row[csf('body_part_id')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('uom')]]=$row[csf('fin_fab_qnty')];
				}
				//echo '<pre>';print_r($wo_qnty_arr);
				//$prev_pi_qty_arr=array();
				$sql_prev="SELECT b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition,  b.uom, sum(b.quantity) as qty,b.work_order_dtls_id 
            	from com_pi_master_details a, com_pi_item_details b 
            	where a.id=b.pi_id and a.item_category_id=$cbo_item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_id in($all_WoId) 
           		group by b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition,  b.uom, b.work_order_dtls_id";
				$prevData=sql_select($sql_prev);
				foreach($prevData as $rowP)
				{
					$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('work_order_dtls_id')]][$rowP[csf('body_part_id')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
				}
				//echo '<pre>';print_r($prev_pi_qty_arr);
				
			}

			else if(str_replace("'", '',$cbo_item_category_id)==4)
			{

				if(str_replace("'", '',$txt_order_type)==2)
				{
					if($all_dtls_id=="") $all_dtls_id=0;
					$booking_id_cond=""; $bokIds_cond=""; $all_dtls_arr=explode(",",$all_dtls_id);
					if($db_type==2 && count($all_dtls_arr)>999)
					{
						$booking_id_chunk_arr=array_chunk($all_dtls_arr,999) ;
						foreach($booking_id_chunk_arr as $chunk_arr)
						{
							$chunk_arr_value=implode(",",$chunk_arr);
							$bokIds_cond.="  id in($chunk_arr_value) or ";
						}
						$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
					}
					else
					{
						$booking_id_cond=" and id in($all_dtls_id)";
					}

					$wo_qnty_arr=return_library_array("select id as wo_trim_booking_dtls_id, trim_qty as qnty from wo_non_ord_samp_booking_dtls where status_active=1 $booking_id_cond","wo_trim_booking_dtls_id","qnty");
				}
				else
				{
					if($all_dtls_id=="") $all_dtls_id=0;
					$booking_id_cond=""; $bokIds_cond=""; $all_dtls_arr=explode(",",$all_dtls_id);
					if($db_type==2 && count($all_dtls_arr)>999)
					{
						$booking_id_chunk_arr=array_chunk($all_dtls_arr,999) ;
						foreach($booking_id_chunk_arr as $chunk_arr)
						{
							$chunk_arr_value=implode(",",$chunk_arr);
							$bokIds_cond.="  wo_trim_booking_dtls_id in($chunk_arr_value) or ";
						}

						$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
					}
					else
					{
						$booking_id_cond=" and wo_trim_booking_dtls_id in($all_dtls_id)";
					}

					//echo "select wo_trim_booking_dtls_id, sum(cons) as qnty from wo_trim_book_con_dtls where status_active=1 $booking_id_cond and booking_no in ($all_wo_no) and cons>0 group by wo_trim_booking_dtls_id","wo_trim_booking_dtls_id";
					$wo_qnty_arr=return_library_array("select wo_trim_booking_dtls_id, sum(cons) as qnty from wo_trim_book_con_dtls where status_active=1 $booking_id_cond and booking_no in ($all_wo_no) and cons>0 group by wo_trim_booking_dtls_id","wo_trim_booking_dtls_id","qnty");
				}
			}

			else if(str_replace("'", '',$cbo_item_category_id)==12)
			{
				if(str_replace("'", '',$txt_order_type)==1)
				{
					$wo_qnty_arr=return_library_array("select id, wo_qnty as qnty from wo_booking_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else if(str_replace("'", '',$txt_order_type)==2)
				{
					$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from wo_non_ord_aop_booking_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else if(str_replace("'", '',$txt_order_type)==4)
				{
					$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from knitting_work_order_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else if(str_replace("'", '',$txt_order_type)==5)
				{
					$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from dyeing_work_order_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else
				{
					$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from wo_non_ord_knitdye_booking_dtl where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
			}

			else if(str_replace("'", '',$cbo_item_category_id)==24)
			{
				$wo_qnty_arr=return_library_array("select id, yarn_wo_qty as qnty from wo_yarn_dyeing_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
			}

			else if(str_replace("'", '',$cbo_item_category_id)==25 || str_replace("'", '',$cbo_item_category_id)==102 || str_replace("'", '',$cbo_item_category_id)==103 || str_replace("'", '',$cbo_item_category_id)==104)
			{
				$wo_qnty_arr=return_library_array("select id, wo_qnty as qnty from wo_booking_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
			}
			else if(str_replace("'", '',$cbo_item_category_id)==116)
			{
				$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from garments_service_wo_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
			}
			else if(str_replace("'", '',$cbo_item_category_id)==100)
			{
				$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from subcon_wo_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
			}
			else if(str_replace("'", '',$cbo_item_category_id)==31 || str_replace("'", '',$cbo_item_category_id)==115)
			{
				if(str_replace("'", '',$cbo_item_category_id)==31)
				{
					$wo_amnt_arr=return_library_array("select id, wo_value as wo_value from wo_labtest_dtls where status_active=1 and id in($all_dtls_id)","id","wo_value");
				}
				else
				{
					$wo_amnt_arr=return_library_array("select id, amount as wo_value from wo_inspection_dtls where status_active=1 and id in($all_dtls_id)","id","wo_value");
				}
				
				$prev_pi_amnt_arr=return_library_array( "select b.work_order_dtls_id,sum(b.amount) as amnt from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$cbo_item_category_id and a.pi_basis_id=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($all_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "amnt");
			}
			else
			{
				$wo_qnty_arr=return_library_array("select id, supplier_order_quantity as qnty from wo_non_order_info_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
			}
		}
		$woDtlsTrsansId='';$trans_qty_check_arr=array();

		for($i=1;$i<=$total_row;$i++)
		{
			$hsCode="hsCode_".$i;
			$colorName="colorName_".$i;
			$sizeName="sizeName_".$i;
			$countName="countName_".$i;
			$yarnCompositionItem1="yarnCompositionItem1_".$i;
			$yarnCompositionPercentage1="yarnCompositionPercentage1_".$i;
			$yarnCompositionItem2="yarnCompositionItem2_".$i;
			$yarnCompositionPercentage2="yarnCompositionPercentage2_".$i;
			$yarnType="yarnType_".$i;
			$uom="uom_".$i;
			$quantity="quantity_".$i;
			$rate="rate_".$i;
			$amount="amount_".$i;
			$workOrderNo="workOrderNo_".$i;
			$workOrderId="hideWoId_".$i;
			$workOrderDtlsId="hideWoDtlsId_".$i;
			$itemProdId="itemProdId_".$i;
			$determinationId="hideDeterminationId_".$i;
			$construction="construction_".$i;
			$composition="composition_".$i;
			$gsm="gsm_".$i;
			$diawidth="diawidth_".$i;
			$weight="weight_".$i;
			$itemgroupid="itemgroupid_".$i;
			$itemdescription="itemdescription_".$i;
			$servicetype="servicetype_".$i;
			$item_color="itemColor_".$i;
			$itemSize="itemSize_".$i;
			$brandSupRef="brandSupRef_".$i;
			$lot="lot_".$i;
			$yarnColor="yarnColor_".$i;
			$colorRange="colorRange_".$i;
			$gmtsitem="gmtsitem_".$i;
			$embellname="embellname_".$i;
			$embelltype="embelltype_".$i;
			$bookingWithoutOrder="bookingWithoutOrder_".$i;
			$cboTestFor="cboTestFor_".$i;
			$testItemId="testItemId_".$i;
			$remarks="remarks_".$i;
			$bodyPartId="bodyPart_".$i;
			$fabricRef="fabricRef_".$i;
			$rdNo="rdNo_".$i;
			$fabType="fabType_".$i;
			$fabDesign="fabDesign_".$i;
			$fabWeight="fabWeight_".$i;
			$fabWeightType="fabWeightType_".$i;
			$cutableWidth="cutableWidth_".$i;
			$diawidthType="diawidthType_".$i;
			$hideTransData="hideTransData_".$i;
			$hideOrdeSource="hideOrdeSource_".$i;
			//$bookingWithoutOrder="bookingWithoutOrder_".$i;
			$hidePoId="hidePoId_".$i;
			$poNo="poNo_".$i;
			$styleRef="styleRef_".$i;
			$poRef="poRef_".$i;
			$itemcategory="itemcategory_".$i;
			if($master_category_id==8) $cbo_item_category_id=str_replace("'","",$$itemcategory);
			
			
			if($cbo_item_category_id!=4)
			{
				$$hidePoId="";
				$$poNo="";
				$$styleRef="";
				$$poRef="";
			}

			if(str_replace("'","",$$hideOrdeSource)=="") $paySource=0; else $paySource=str_replace("'","",$$hideOrdeSource);
			if(str_replace("'","",$$bookingWithoutOrder)=="") $bookWithoutOrder=0; else $bookWithoutOrder=str_replace("'","",$$bookingWithoutOrder);
			
			
			
			if(str_replace("'","",$$testItemId)=="" || str_replace("'","",$$testItemId)=="undefined")
			{
				$$testItemId=0;
			}
			if(str_replace("'","",$$itemProdId)=='undefined' && str_replace("'", '',$cbo_item_category_id)!=116)
			{
				$$itemProdId=0;
			}
			
			//echo "11** PI Quantity ".str_replace("'","",$$testItemId);disconnect($con);die;

			if(str_replace("'", '',$cbo_pi_basis_id)==1 && str_replace("'", '',$cbo_goods_rcv_status)==1 && $goods_rcv_variable !=1 && (str_replace("'", '',$cbo_item_category_id)!=12 && str_replace("'", '',$cbo_item_category_id)!=25 && str_replace("'", '',$cbo_item_category_id)!=102 && str_replace("'", '',$cbo_item_category_id)!=103 && str_replace("'", '',$cbo_item_category_id)!=104 && str_replace("'", '',$cbo_item_category_id)!=31 && str_replace("'", '',$cbo_item_category_id)!=115 && str_replace("'", '',$cbo_item_category_id)!=116 && str_replace("'", '',$cbo_item_category_id)!=100))
			{
				//echo "5**".$$hideTransData.'system';
				$hideTransData_arr=explode("__",str_replace("'","",$$hideTransData));
				foreach($hideTransData_arr as $hide_trans_val)
				{
					$hide_trans_val_arr=explode("_",$hide_trans_val);
					$trans_id=$hide_trans_val_arr[0];
					$trans_qnty=$hide_trans_val_arr[1];
					$trans_amt=$hide_trans_val_arr[2];
					$prod_id=$hide_trans_val_arr[3];
					$propor_order_id=$hide_trans_val_arr[4]; //Only for accessories
					$allWoId.=str_replace("'","",$$workOrderId).",";
					$wotransId=str_replace("'","",$trans_id);
					$trans_qty_check_arr[$trans_id]=str_replace("'","",$trans_qnty);
					if($woDtlsTrsansId=='') $woDtlsTrsansId=$trans_id; else $woDtlsTrsansId.=','.$trans_id;

					$perc=(str_replace("'","",$trans_amt)/$txt_total_amount)*100;
					$net_pi_amount=($perc*$txt_total_amount_net)/100;

					if(str_replace("'", '',$cbo_item_category_id)==31 || str_replace("'", '',$cbo_item_category_id)==115)
					{
						$net_pi_rate=0;
					}
					else
					{
						if($net_pi_amount>0 && str_replace("'","",$trans_qnty)>0)
						{
							$net_pi_rate=$net_pi_amount/str_replace("'","",$trans_qnty);
							$net_pi_rate=number_format($net_pi_rate,$dec_place[3],'.','');
						}
						else
						{
							$net_pi_rate=0;
						}
					}
					//echo "10** $net_pi_rate = $net_pi_amount = $perc";die;
					if($cbo_currency_id==1)
						$net_pi_amount=number_format($net_pi_amount,$dec_place[4],'.','');
					else
						$net_pi_amount=number_format($net_pi_amount,$dec_place[5],'.','');

					if(str_replace("'","",$$colorName)!="")
					{
						if (!in_array(str_replace("'","",$$colorName),$new_array_color))
						{
							$color_id = return_id( str_replace("'","",$$colorName), $color_library, "lib_color", "id,color_name","405");
							$new_array_color[$color_id]=str_replace("'","",$$colorName);
						}
						else $color_id =  array_search(str_replace("'","",$$colorName), $new_array_color);
					}
					else
					{
						$color_id=0;
					}

					if($cbo_item_category_id==4 || $cbo_item_category_id==12)
					{
						if(str_replace("'","",$$sizeName)!="")
						{
							if (!in_array(str_replace("'","",$$sizeName),$new_array_size))
							{
							  $size_id = return_id( str_replace("'","",$$sizeName), $size_library, "lib_size", "id,size_name","405");
							  $new_array_size[$size_id]=str_replace("'","",$$sizeName);
							}
							else $size_id =  array_search(str_replace("'","",$$sizeName), $new_array_size);
						}
						else
						{
							$size_id=0;
						}

						if(str_replace("'","",$$item_color)!="")
						{
							if (!in_array(str_replace("'","",$$item_color),$new_array_color))
							{
								$item_color_id = return_id( str_replace("'","",$$item_color), $color_library, "lib_color", "id,color_name","405");
								$new_array_color[$item_color_id]=str_replace("'","",$$item_color);
							}
							else $item_color_id =  array_search(str_replace("'","",$$item_color), $new_array_color);
						}
						else
						{
							$item_color_id=0;
						}
					}
					else
					{
						$size_id=0;
						$item_color_id=0;
					}
					//echo "11**".$wo_qnty_arr[$trans_id]."==".$previous_pi_qty[$trans_id]."==".$prev_retun_qnty[$trans_id];die;
					if(str_replace("'", '',$cbo_pi_basis_id)==1)
					{
						if(str_replace("'", '',$cbo_item_category_id)==4)
						{
							//echo "11**".$wo_qnty_arr[$trans_id][$propor_order_id]."==".$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$propor_order_id]."==".$trans_id;die;
							if($wo_qnty_arr[$trans_id][$propor_order_id]>$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$propor_order_id])
							{
								$bal_wo_qnty=($wo_qnty_arr[$trans_id][$propor_order_id]-($previous_pi_qty[$trans_id]+$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$propor_order_id]));
								$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$propor_order_id]=0;
							}
							else
							{
								$bal_wo_qnty=($wo_qnty_arr[$trans_id][$propor_order_id]-($previous_pi_qty[$trans_id]+$wo_qnty_arr[$trans_id][$propor_order_id]));
								$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$propor_order_id]=$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$propor_order_id]-$wo_qnty_arr[$trans_id][$propor_order_id];
								$previous_pi_qty[$trans_id]+$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$propor_order_id]=$previous_pi_qty[$trans_id]+$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$propor_order_id]-$wo_qnty_arr[$trans_id][$propor_order_id];
							}					
							
						}
						else
						{
							$bal_wo_qnty=($wo_qnty_arr[$trans_id]-($previous_pi_qty[$trans_id]+$prev_retun_qnty[$trans_id]));

						}

						$bal_wo_qnty=number_format($bal_wo_qnty,2,'.','');

						if($trans_qnty>$bal_wo_qnty)
						{
							//echo "11**$trans_qnty==$bal_wo_qnty==$wo_qnty_arr[$trans_id]==$previous_pi_qty[$trans_id]==".$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$trans_id];die;
							echo "11**PI Quantity Not Allow Over Balance Quantity $trans_qnty = $bal_wo_qnty";disconnect($con);die;
						}
					}
					$data_array[$id]="(".$id.",".$update_id.",'".str_replace("'","",$$workOrderNo)."','".str_replace("'","",$$workOrderId)."','".str_replace("'","",$trans_id)."','".$bookWithoutOrder."','".str_replace("'","",$$determinationId)."','".str_replace("'","",$$itemProdId)."','".str_replace("'","",$$itemgroupid)."','".str_replace("'","",$$itemdescription)."','".str_replace("'","",$$hsCode)."','".str_replace("'","",$color_id)."','".str_replace("'","",$size_id)."','".str_replace("'","",$$itemSize)."','".str_replace("'","",$$countName)."','".str_replace("'","",$$yarnCompositionItem1)."','".str_replace("'","",$$yarnCompositionPercentage1)."','".str_replace("'","",$$yarnCompositionItem2)."','".str_replace("'","",$$yarnCompositionPercentage2)."','".str_replace("'","",$$composition)."','".str_replace("'","",$$construction)."','".str_replace("'","",$$yarnType)."','".str_replace("'","",$$gsm)."','".str_replace("'","",$$diawidth)."','".str_replace("'","",$$weight)."','".str_replace("'","",$item_color_id)."','".str_replace("'","",$$uom)."','".str_replace("'","",$trans_qnty)."','".str_replace("'","",$$rate)."','".$trans_amt."','".$net_pi_rate."','".$net_pi_amount."','".str_replace("'","",$$servicetype)."','".str_replace("'","",$$brandSupRef)."','".str_replace("'","",$$gmtsitem)."','".str_replace("'","",$$embellname)."','".str_replace("'","",$$embelltype)."','".str_replace("'","",$$lot)."','".str_replace("'","",$$yarnColor)."','".str_replace("'","",$$colorRange)."','".str_replace("'","",$$cboTestFor)."','".str_replace("'","",$$testItemId)."','".str_replace("'","",$$remarks)."','".str_replace("'","",$$bodyPartId)."','".str_replace("'","",$$fabricRef)."','".str_replace("'","",$$rdNo)."','".str_replace("'","",$$fabType)."','".str_replace("'","",$$fabDesign)."','".str_replace("'","",$$fabWeight)."','".str_replace("'","",$$fabWeightType)."','".str_replace("'","",$$cutableWidth)."','".str_replace("'","",$$diawidthType)."',".$cbo_item_category_id.",'".$goods_rcv_variable."',".$user_id.",'".$pc_date_time."','".$is_sales."','".$paySource."','".str_replace("'","",$$hidePoId)."','".str_replace("'","",$$poNo)."','".str_replace("'","",$$styleRef)."','".str_replace("'","",$$poRef)."')";

					$id=$id+1;
				}
			}
			else
			{
				/*echo "11**".str_replace("'","",$$workOrderNo)."=".str_replace("'","",$$determinationId)."=".str_replace("'","",$color_id)."=".str_replace("'","",$$construction)."=".str_replace("'","",$$composition)."=".str_replace("'","",$$gsm)."=".str_replace("'","",$$diawidth)."=".str_replace("'","",$$uom);die;*/
				//echo "10**".$$hideTransData.'systemsghggdhgfhgb';
				
				
				$allWoId.=str_replace("'","",$$workOrderId).",";
				$wotransId=str_replace("'","",$$workOrderDtlsId);
				$trans_qty_check_arr[$wotransId]=str_replace("'","",$$quantity);
				if($woDtlsTrsansId=='') $woDtlsTrsansId=$wotransId; else $woDtlsTrsansId.=','.$wotransId;

				$perc=(str_replace("'","",$$amount)/$txt_total_amount)*100;
				$net_pi_amount=($perc*$txt_total_amount_net)/100;

				if(str_replace("'", '',$cbo_item_category_id)==31 || str_replace("'", '',$cbo_item_category_id)==115)
				{
					$net_pi_rate=0;
				}
				else
				{
					$net_pi_rate=$net_pi_amount/str_replace("'","",$$quantity);
					$net_pi_rate=number_format($net_pi_rate,$dec_place[3],'.','');
				}
				
				if($cbo_currency_id==1)
					$net_pi_amount=number_format($net_pi_amount,$dec_place[4],'.','');
				else
					$net_pi_amount=number_format($net_pi_amount,$dec_place[5],'.','');

				if(str_replace("'","",$$colorName)!="")
				{
					if (!in_array(str_replace("'","",$$colorName),$new_array_color))
					{
						$color_id = return_id( str_replace("'","",$$colorName), $color_library, "lib_color", "id,color_name","405");
						$new_array_color[$color_id]=str_replace("'","",$$colorName);
					}
					else $color_id =  array_search(str_replace("'","",$$colorName), $new_array_color);
				}
				else
				{
					$color_id=0;
				}

				if($cbo_item_category_id==4 || $cbo_item_category_id==12)
				{
					if(str_replace("'","",$$sizeName)!="")
					{
						if (!in_array(str_replace("'","",$$sizeName),$new_array_size))
						{
						  $size_id = return_id( str_replace("'","",$$sizeName), $size_library, "lib_size", "id,size_name","405");
						  $new_array_size[$size_id]=str_replace("'","",$$sizeName);
						}
						else $size_id =  array_search(str_replace("'","",$$sizeName), $new_array_size);
					}
					else
					{
						$size_id=0;
					}

					if(str_replace("'","",$$item_color)!="")
					{
						if (!in_array(str_replace("'","",$$item_color),$new_array_color))
						{
							$item_color_id = return_id( str_replace("'","",$$item_color), $color_library, "lib_color", "id,color_name","405");
							$new_array_color[$item_color_id]=str_replace("'","",$$item_color);
						}
						else $item_color_id =  array_search(str_replace("'","",$$item_color), $new_array_color);
					}
					else
					{
						$item_color_id=0;
					}
				}
				else
				{
					$size_id=0;
					$item_color_id=0;
				}

				if(str_replace("'", '',$cbo_pi_basis_id)==1)
				{
					if(str_replace("'", '',$cbo_item_category_id)==31 || str_replace("'", '',$cbo_item_category_id)==115)
					{
						$bal_wo_amnt=$wo_amnt_arr[str_replace("'","",$$workOrderDtlsId)]-$prev_pi_amnt_arr[str_replace("'","",$$workOrderDtlsId)];
					}
					else
					{
						//echo "10**$cbo_item_category_id**$txt_order_type**$cbo_goods_rcv_status**$goods_rcv_variable";
						if(str_replace("'", '',$cbo_goods_rcv_status)==1 && $goods_rcv_variable !=1)
						{
							$bal_wo_qnty=($wo_qnty_arr[str_replace("'","",$$workOrderDtlsId)]-($previous_pi_qty[str_replace("'","",$$workOrderDtlsId)]+$prev_retun_qnty[str_replace("'","",$$workOrderDtlsId)]));

						}
						else
						{
							if((str_replace("'", '',$cbo_item_category_id)==2 || str_replace("'", '',$cbo_item_category_id)==13) && str_replace("'", '',$txt_order_type)==1)
							{
								$bal_wo_qnty=$wo_prev_qnty=$pi_prev_qnty=0;
								$wo_prev_qnty=$wo_qnty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$gsm)][strtoupper(str_replace("'","",$$diawidth))][str_replace("'","",$$uom)];
								$pi_prev_qnty=$prev_pi_qty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$gsm)][strtoupper(str_replace("'","",$$diawidth))][str_replace("'","",$$uom)];
								$bal_wo_qnty=($wo_prev_qnty-$pi_prev_qnty);
								$trans_qnty=str_replace("'","",$$quantity);
								//$bal_wo_qnty=number_format($bal_wo_qnty,2,'.','');
								//$trans_qnty=number_format($trans_qnty,2,'.','');
								/*if($trans_qnty<87)
								{
									echo "11**".str_replace("'","",$$workOrderNo)."=".str_replace("'","",$$determinationId)."=".str_replace("'","",$color_id)."=".str_replace("'","",$$construction)."=".str_replace("'","",$$composition)."=".str_replace("'","",$$gsm)."=".str_replace("'","",$$diawidth)."=".str_replace("'","",$$uom);die;
								}*/
								//echo "11**<pre>";print_r($wo_qnty_arr);die;

							}
							else if(str_replace("'", '',$cbo_item_category_id)==3)
							{
								//echo "10**$txt_order_type**system";
								$bal_wo_qnty=$wo_prev_qnty=$pi_prev_qnty=0;
								//echo str_replace("'","",$$workOrderNo).'*****'.str_replace("'","",$$bodyPartId).'*****'.str_replace("'","",$$determinationId).'*****'.str_replace("'","",$color_id).'*****'.str_replace("'","",$$construction).'*****'.str_replace("'","",$$composition).'*****'.str_replace("'","",$$fabWeight).'*****'.str_replace("'","",$$fabWeightType).'*****'.str_replace("'","",$$diawidthType).'*****'.str_replace("'","",$$diawidth).'*****'.str_replace("'","",$$cutableWidth).'*****'.str_replace("'","",$$uom);
								if (str_replace("'", '',$txt_order_type)==1)
								{
									$wo_prev_qnty=$wo_qnty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$bodyPartId)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$construction)][str_replace("'","",$$composition)][str_replace("'","",$$fabWeight)][str_replace("'","",$$fabWeightType)][str_replace("'","",$$diawidthType)][strtoupper(str_replace("'","",$$diawidth))][str_replace("'","",$$cutableWidth)][str_replace("'","",$$uom)];
									//echo '<pre>';print_r($wo_qnty_arr);
									//echo $wo_prev_qnty;
									$pi_prev_qnty=$prev_pi_qty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$bodyPartId)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$construction)][str_replace("'","",$$composition)][str_replace("'","",$$fabWeight)][str_replace("'","",$$fabWeightType)][str_replace("'","",$$diawidthType)][strtoupper(str_replace("'","",$$diawidth))][str_replace("'","",$$cutableWidth)][str_replace("'","",$$uom)];
								}
								else if (str_replace("'", '',$txt_order_type)==2)
								{
									$wo_prev_qnty=$wo_qnty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$bodyPartId)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$construction)][str_replace("'","",$$composition)][str_replace("'","",$$fabWeight)][str_replace("'","",$$diawidthType)][str_replace("'","",$$cutableWidth)][str_replace("'","",$$uom)];
									//echo '<pre>';print_r($wo_qnty_arr);
									//echo $wo_prev_qnty;
									$pi_prev_qnty=$prev_pi_qty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$bodyPartId)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$construction)][str_replace("'","",$$composition)][str_replace("'","",$$fabWeight)][str_replace("'","",$$diawidthType)][str_replace("'","",$$cutableWidth)][str_replace("'","",$$uom)];
								}

								$bal_wo_qnty=($wo_prev_qnty-$pi_prev_qnty);
								//echo "11** PI Not Allow Over Balance Quantity $pi_prev_qnty";disconnect($con);die;
								$trans_qnty=str_replace("'","",$$quantity);
								//$bal_wo_qnty=number_format($bal_wo_qnty,2,'.','');
								//$trans_qnty=number_format($trans_qnty,2,'.','');
								//echo $bal_wo_qnty.'system';
								/*if($trans_qnty<87)
								{
									echo "11**".str_replace("'","",$$workOrderNo)."=".str_replace("'","",$$determinationId)."=".str_replace("'","",$color_id)."=".str_replace("'","",$$construction)."=".str_replace("'","",$$composition)."=".str_replace("'","",$$gsm)."=".str_replace("'","",$$diawidth)."=".str_replace("'","",$$uom);die;
								}*/
								//echo "11**<pre>";print_r($wo_qnty_arr);die;
							}
							else if(str_replace("'", '',$cbo_item_category_id)==14)
							{
								//echo "10**$txt_order_type**system";
								$bal_wo_qnty=$wo_prev_qnty=$pi_prev_qnty=0;
								
								
								$wo_prev_qnty=$wo_qnty_arr[trim(str_replace("'","",$$workOrderNo))][str_replace("'", "", $$workOrderDtlsId)][str_replace("'","",$$bodyPartId)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][trim(str_replace("'","",$$construction))][trim(str_replace("'","",$$composition))][str_replace("'","",$$uom)];
								//echo '<pre>';print_r($wo_qnty_arr);
								//echo $wo_prev_qnty;
								$pi_prev_qnty=$prev_pi_qty_arr[trim(str_replace("'","",$$workOrderNo))][str_replace("'", "", $$workOrderDtlsId)][str_replace("'","",$$bodyPartId)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][trim(str_replace("'","",$$construction))][trim(str_replace("'","",$$composition))][str_replace("'","",$$uom)];
								
								

								$bal_wo_qnty=($wo_prev_qnty-$pi_prev_qnty);
								//echo "11** PI Not Allow Over Balance Quantity $pi_prev_qnty";disconnect($con);die;
								$trans_qnty=str_replace("'","",$$quantity);

								 //echo "11** PI Quantity Not Allow Over Balance Quantity $trans_qnty = $wo_prev_qnty-$pi_prev_qnty". str_replace("'","",$$workOrderNo)."=>".str_replace("'","",$$workOrderDtlsId)."=>".str_replace("'","",$$bodyPartId)."=>".str_replace("'","",$$determinationId)."=>".str_replace("'","",$color_id)."=>".str_replace("'","",$$construction)."=>".str_replace("'","",$$composition)."=>".str_replace("'","",$$uom);
								// echo '<pre>';print_r($wo_qnty_arr);
								// disconnect($con);die;
								
							}
							else
							{
								if(str_replace("'", '',$cbo_item_category_id)==2 || str_replace("'", '',$cbo_item_category_id)==3 || str_replace("'", '',$cbo_item_category_id)==13)
								{
									$bal_wo_qnty=($wo_qnty_arr[str_replace("'","",$$workOrderDtlsId)]-$prev_pi_qty_arr[str_replace("'","",$$workOrderDtlsId)]);
									$wo_prev_qnty=$wo_qnty_arr[str_replace("'","",$$workOrderDtlsId)];
									$pi_prev_qnty=$prev_pi_qty_arr[str_replace("'","",$$workOrderDtlsId)];
								}
								else
								{
									$bal_wo_qnty=($wo_qnty_arr[str_replace("'","",$$workOrderDtlsId)]-$previous_pi_qty[str_replace("'","",$$workOrderDtlsId)]);
									$wo_prev_qnty=$wo_qnty_arr[str_replace("'","",$$workOrderDtlsId)];
									$pi_prev_qnty=$previous_pi_qty[str_replace("'","",$$workOrderDtlsId)];
								}
							}
						}
					}
					//echo "10**".$trans_qnty."==".$bal_wo_qnty; die;
					$trans_qnty=str_replace("'","",$$quantity);
					$bal_wo_qnty=number_format($bal_wo_qnty,6,'.','');
					$trans_qnty=number_format($trans_qnty,6,'.','');

					//echo "11** $trans_qnty=$bal_wo_qnty=$wo_prev_qnty=$pi_prev_qnty";die;
					if(str_replace("'", '',$cbo_item_category_id)==31 || str_replace("'", '',$cbo_item_category_id)==115)
					{
						$trans_amount=str_replace("'","",$$amount);
						$bal_wo_amnt=number_format($bal_wo_amnt,2,'.','');
						$trans_amount=number_format($trans_amount,2,'.','');

						if($trans_amount>$bal_wo_amnt)
						{
							echo "11** PI Amount Not Allow Over Balance Amount";disconnect($con);die;
						}
					}
					else
					{
						if($trans_qnty>$bal_wo_qnty)
						{
							echo "11** PI Quantity Not Allow Over Balance Quantity $trans_qnty = $bal_wo_qnty";disconnect($con);die;
						}
					}
				}
				
				$data_array[$id]="(".$id.",".$update_id.",'".str_replace("'","",$$workOrderNo)."','".str_replace("'","",$$workOrderId)."','".str_replace("'","",$$workOrderDtlsId)."','".$bookWithoutOrder."','".str_replace("'","",$$determinationId)."','".str_replace("'","",$$itemProdId)."','".str_replace("'","",$$itemgroupid)."','".str_replace("'","",$$itemdescription)."','".str_replace("'","",$$hsCode)."','".str_replace("'","",$color_id)."','".str_replace("'","",$size_id)."','".str_replace("'","",$$itemSize)."','".str_replace("'","",$$countName)."','".str_replace("'","",$$yarnCompositionItem1)."','".str_replace("'","",$$yarnCompositionPercentage1)."','".str_replace("'","",$$yarnCompositionItem2)."','".str_replace("'","",$$yarnCompositionPercentage2)."','".str_replace("'","",$$composition)."','".str_replace("'","",$$construction)."','".str_replace("'","",$$yarnType)."','".str_replace("'","",$$gsm)."','".str_replace("'","",$$diawidth)."','".str_replace("'","",$$weight)."','".str_replace("'","",$item_color_id)."','".str_replace("'","",$$uom)."','".str_replace("'","",$$quantity)."','".str_replace("'","",$$rate)."',".$$amount.",'".$net_pi_rate."','".$net_pi_amount."','".str_replace("'","",$$servicetype)."','".str_replace("'","",$$brandSupRef)."','".str_replace("'","",$$gmtsitem)."','".str_replace("'","",$$embellname)."','".str_replace("'","",$$embelltype)."','".str_replace("'","",$$lot)."','".str_replace("'","",$$yarnColor)."','".str_replace("'","",$$colorRange)."','".str_replace("'","",$$cboTestFor)."','".str_replace("'","",$$testItemId)."','".str_replace("'","",$$remarks)."','".str_replace("'","",$$bodyPartId)."','".str_replace("'","",$$fabricRef)."','".str_replace("'","",$$rdNo)."','".str_replace("'","",$$fabType)."','".str_replace("'","",$$fabDesign)."','".str_replace("'","",$$fabWeight)."','".str_replace("'","",$$fabWeightType)."','".str_replace("'","",$$cutableWidth)."','".str_replace("'","",$$diawidthType)."',".$cbo_item_category_id.",'".$goods_rcv_variable."',".$user_id.",'".$pc_date_time."','".$is_sales."','".$paySource."','".str_replace("'","",$$hidePoId)."','".str_replace("'","",$$poNo)."','".str_replace("'","",$$styleRef)."','".str_replace("'","",$$poRef)."')";
				$id=$id+1;
			}
		}

		if(str_replace("'", '',$cbo_pi_basis_id)==1 && str_replace("'", '',$cbo_goods_rcv_status)==1 && $goods_rcv_variable !=1 && str_replace("'", '',$cbo_item_category_id)!=4 && str_replace("'", '',$cbo_item_category_id)!=12 && str_replace("'", '',$cbo_item_category_id)!=25 && str_replace("'", '',$cbo_item_category_id)!=102 && str_replace("'", '',$cbo_item_category_id)!=103 && str_replace("'", '',$cbo_item_category_id)!=104 && str_replace("'", '',$cbo_item_category_id)!=31 && str_replace("'", '',$cbo_item_category_id)!=115)
		{
			$allWoId=chop($allWoId,",");
			if($allWoId=="") $allWoId=0;

			$prev_pi_qnty=return_library_array("Select b.work_order_dtls_id, sum(b.quantity) as pi_qnty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.after_goods_source=2 and b.after_goods_source=2 $category_conds3 and b.work_order_dtls_id in ($woDtlsTrsansId) and b.status_active=1 group by b.work_order_dtls_id","work_order_dtls_id","pi_qnty");

			$prev_retun_qnty=return_library_array("select b.recv_trans_id, sum(b.issue_qnty) as qnty
			from inv_transaction a, inv_mrr_wise_issue_details b where a.id=b.issue_trans_id and a.transaction_type=3 and b.recv_trans_id in($all_dtls_id) and b.status_active=1 group by recv_trans_id","recv_trans_id","qnty");

			$field_array_trans_update="pi_is_lock*updated_by*update_date";
			$sql_trns="Select id, pi_wo_batch_no, prod_id, order_qnty as order_qnty from inv_transaction where id in ($woDtlsTrsansId) and status_active=1 order by id";

			$sql_trns_res = sql_select($sql_trns);
			foreach($sql_trns_res as $row)
			{
				$pi_trans_qty=number_format(($trans_qty_check_arr[$row[csf('id')]]),2,'.','');
				$order_trans_qty=number_format(($row[csf('order_qnty')]-($prev_retun_qnty[$row[csf('id')]]+$prev_pi_qnty[$row[csf('id')]])),2,'.','');
				if($pi_trans_qty>=$order_trans_qty) $is_lock=1; else $is_lock=0;
				$test_lock3.=$pi_trans_qty."=".$order_trans_qty."=".$is_lock."=".$prev_rtn.",";
				$test_lock2.=$row[csf('id')]."=".$trans_qty_check_arr[$row[csf('id')]]."=".$row[csf('order_qnty')]."=".$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]]."=".$prev_pi_qnty[$row[csf('id')]]."=".$is_lock.",";
				$test_lock.=$row[csf('id')]."= $order_trans_qty = $pi_trans_qty = ".$is_lock.",";
				$trans_id_arr[]=$row[csf('id')];
				$data_array_trans_update[$row[csf('id')]]=explode("*",($is_lock."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'"));
			}
		}


		if(str_replace("'", '',$cbo_pi_basis_id)==1 && str_replace("'", '',$cbo_goods_rcv_status)==1 && $goods_rcv_variable !=1 && str_replace("'", '',$cbo_item_category_id)==4)
		{
			$allWoId=chop($allWoId,",");
			if($allWoId=="") $allWoId=0;
			$prev_pi_qnty=return_library_array("Select b.work_order_dtls_id, sum(b.quantity) as pi_qnty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.after_goods_source=2 and b.after_goods_source=2 $category_conds3 and b.work_order_dtls_id in ($woDtlsTrsansId) and b.status_active=1 group by b.work_order_dtls_id","work_order_dtls_id","pi_qnty");

			if(str_replace("'", '',$txt_order_type)==2)
			{
				$prev_retun_sql="select booking_id, prod_id, 0 as order_id, issue_qnty as qty from inv_trims_issue_dtls where booking_id>0 and  booking_id in($all_WoId) and status_active=1 order by booking_id,prod_id";
				foreach($prev_retun_sql_result as $row)
				{
					$prev_retun_qnty[$row[csf("booking_id")]][$row[csf("prod_id")]][$row[csf("order_id")]]+=$row[csf("qty")];
				}

				$field_array_trans_update="pi_is_lock*updated_by*update_date";
				$sql_trns="Select id, pi_wo_batch_no, prod_id, order_qnty as order_qnty from inv_transaction where id in ($woDtlsTrsansId) and status_active=1 order by id";

				$sql_trns_res = sql_select($sql_trns);
				foreach($sql_trns_res as $row)
				{
					$pi_trans_qty=number_format(($trans_qty_check_arr[$row[csf('id')]]),2,'.','');

					if($row[csf('order_qnty')]>$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf("order_id")]])
					{
						$order_trans_qty=number_format(($row[csf('order_qnty')]-($prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf("order_id")]]+$prev_pi_qnty[$row[csf('id')]])),2,'.','');
						$prev_rtn+=$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf("order_id")]];
						$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf("order_id")]]=0;
					}
					else
					{
						$order_trans_qty=number_format(($row[csf('order_qnty')]-($row[csf('order_qnty')]+$prev_pi_qnty[$row[csf('id')]])),2,'.','');
						$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf("order_id")]]=$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf("order_id")]]-$row[csf('order_qnty')];
						$prev_rtn+=$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf("order_id")]];
					}

					if($pi_trans_qty>=$order_trans_qty) $is_lock=1; else $is_lock=0;
					$test_lock3.=$pi_trans_qty."=".$order_trans_qty."=".$is_lock."=".$prev_rtn.",";
					$test_lock2.=$row[csf('id')]."=".$trans_qty_check_arr[$row[csf('id')]]."=".$row[csf('order_qnty')]."=".$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]]."=".$prev_pi_qnty[$row[csf('id')]]."=".$is_lock.",";
					$test_lock.=$row[csf('id')]."= $order_trans_qty = $pi_trans_qty = ".$is_lock.",";
					$trans_id_arr[]=$row[csf('id')];
					$data_array_trans_update[$row[csf('id')]]=explode("*",($is_lock."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'"));
				}
			}
			else
			{
				$prev_retun_sql="select a.booking_id, a.prod_id, b.po_breakdown_id as order_id, b.quantity as qty from inv_trims_issue_dtls a, order_wise_pro_details b where a.trans_id=b.trans_id and a.booking_id>0 and a.booking_id in($all_WoId) and a.status_active=1 and b.entry_form=73 and b.trans_type=4 and b.status_active=1 order by a.booking_id,a.prod_id";
				foreach($prev_retun_sql_result as $row)
				{
					$prev_retun_qnty[$row[csf("booking_id")]][$row[csf("prod_id")]][$row[csf("order_id")]]+=$row[csf("qty")];
				}

				$field_array_propor_update="pi_is_lock*updated_by*update_date";
				$sql_propor="Select a.id as trans_id, a.pi_wo_batch_no, a.prod_id, b.id, b.po_breakdown_id as order_id, b.quantity as order_qnty from inv_transaction a, order_wise_pro_details b where a.id=b.trans_id and b.id in ($woDtlsTrsansId) and b.status_active=1 and a.status_active=1 order by b.id";

				$sql_propor_res = sql_select($sql_propor);
				foreach($sql_propor_res as $row)
				{
					$pi_propor_qty=number_format(($trans_qty_check_arr[$row[csf('id')]]),2,'.','');
					if($row[csf('order_qnty')]>$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf('order_id')]])
					{
						$order_propor_qty=number_format(($row[csf('order_qnty')]-($prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf('order_id')]]+$prev_pi_qnty[$row[csf('id')]])),2,'.','');
						$prev_rtn+=$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf('order_id')]];
						$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf('order_id')]]=0;
					}
					else
					{
						$order_propor_qty=number_format(($row[csf('order_qnty')]-($row[csf('order_qnty')]+$prev_pi_qnty[$row[csf('id')]])),2,'.','');
						$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf('order_id')]]=$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf('order_id')]]-$row[csf('order_qnty')];
						$prev_rtn+=$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf('order_id')]];
					}

					if($pi_propor_qty>=$order_propor_qty) $is_lock=1; else $is_lock=0;
					$test_lock3.=$pi_propor_qty."=".$order_propor_qty."=".$is_lock."=".$prev_rtn.",";
					$test_lock2.=$row[csf('id')]."=".$trans_qty_check_arr[$row[csf('id')]]."=".$row[csf('order_qnty')]."=".$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]]."=".$prev_pi_qnty[$row[csf('id')]]."=".$is_lock.",";
					$test_lock.=$row[csf('id')]."= $order_propor_qty = $pi_propor_qty = ".$is_lock.",";
					$proportion_id_arr[]=$row[csf('id')];
					$data_array_propor_update[$row[csf('id')]]=explode("*",($is_lock."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'"));
				}
			}	
		}	

		//echo "10**".$test_lock3;die;
		//echo "5**insert into com_pi_item_details (".$field_array.") Values ".$data_array."";die;
		//echo "10**".print_r($data_array);die;
		$data_set=array_chunk($data_array,200);
		foreach( $data_set as $setRows)
		{
			//echo "5**insert into com_pi_item_details ($field_array) values ".implode(",",$setRows);oci_rollback($con);die;
			$rID=sql_insert("com_pi_item_details",$field_array,implode(",",$setRows),0);

			//echo "5**".$rID;die;			
			//$rID=sql_insert("com_pi_item_details",$field_array,$data_array,0);
			if($rID==1) $flag=1; //else $flag=0;
			else if($rID==0)
			{
				$flag=0;
				oci_rollback($con);
				echo "10**"; die;
			}
		}


		$rID2=sql_update("com_pi_master_details",$field_array_update,$data_array_update,"id",$update_id,1);
		if($flag==1)
		{
			if($rID2) $flag=1; else $flag=0;
		}
		$rID3=true;
		if(count($data_array_trans_update)>0)
		{
			$rID3=execute_query(bulk_update_sql_statement("inv_transaction", "id",$field_array_trans_update,$data_array_trans_update,$trans_id_arr ));
			//echo "10**".$rID3;die;
			if($rID3) $flag=1; else $flag=20;
		}
		$rID4=true;
		if(count($data_array_propor_update)>0)
		{
			$rID4=execute_query(bulk_update_sql_statement("order_wise_pro_details", "id",$field_array_propor_update,$data_array_propor_update,$proportion_id_arr ));
			//echo "10**".$rID3;die;
			if($rID4) $flag=1; else $flag=20;
		}

		//echo "10**$rID=$rID2=$rID3=$rID4**0";oci_rollback($con);die;

		if($db_type==0)
		{
			if($flag==1)
			{
				mysql_query("COMMIT");
				echo "0**".str_replace("'", '', $update_id)."**1";
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "5**0**0";
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "0**".str_replace("'", '', $update_id)."**1";
			}
			else
			{
				oci_rollback($con);
				echo "5**0**0";
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==1)   // Update Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$sql_app=sql_select("select approved from com_pi_master_details where id='$update_id' and approved in(1,3)");
		if(count($sql_app)>0)
		{
			echo "16**1**1";disconnect($con);
			die;
		}


		$validate_piSentToApproval_variable=return_field_value("pi_source_btb_lc as source","variable_settings_commercial","company_name=$cbo_importer_id and item_category=$cbo_item_category_id and variable_list=30 and status_active=1","source");		

		if($validate_piSentToApproval_variable==1)
		{
			if (str_replace("'", '',$cbo_ready_to_approved)==1 && str_replace("'", '',$lc_sc_id)!='')
			{
				if (str_replace("'", '',$is_lc_sc)==1)
				{
					$sql_lc_order_attach=sql_select("select b.wo_po_break_down_id as order_attach from com_export_lc a, com_export_lc_order_info b where a.id=b.com_export_lc_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.id=$lc_sc_id group by b.wo_po_break_down_id");
				}
				else
				{
					$sql_lc_order_attach=sql_select("select b.wo_po_break_down_id as order_attach from com_sales_contract a, com_sales_contract_order_info b where a.id=b.com_sales_contract_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.id=$lc_sc_id group by b.wo_po_break_down_id");
				}
				$order_attach_arr=array();
				foreach ($sql_lc_order_attach as $val) {
					$order_attach_arr[$val[csf('order_attach')]]=$val[csf('order_attach')];
				}			

				if(str_replace("'", '',$cbo_item_category_id)==1)  //Yarn
				{
					$sql_order=sql_select("select e.id as order_id, e.po_number from com_pi_item_details b, wo_non_order_info_dtls c, wo_po_details_master d, wo_po_break_down e where b.work_order_dtls_id=c.id and c.job_no=d.job_no and d.job_no=e.job_no_mst and b.pi_id=$update_id and d.company_name=$cbo_importer_id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.item_category_id=$cbo_item_category_id and c.item_category_id=$cbo_item_category_id group by e.id,e.po_number");
				}
				else if(str_replace("'", '',$cbo_item_category_id)==2 || str_replace("'", '',$cbo_item_category_id)==3 || str_replace("'", '',$cbo_item_category_id)==13) //Knit finish fabric,Woven finish fabric
				{					
					$sql_order=sql_select("select e.id as order_id, e.po_number from com_pi_item_details b, wo_booking_dtls c, wo_po_details_master d, wo_po_break_down e where b.work_order_no=c.booking_no and c.job_no=d.job_no and d.job_no=e.job_no_mst and c.po_break_down_id=e.id and b.pi_id=$update_id and d.company_name=$cbo_importer_id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.item_category_id in($cbo_item_category_id) group by e.id, e.po_number");
				}
				else if(str_replace("'", '',$cbo_item_category_id)==4 || str_replace("'", '',$cbo_item_category_id)==12 || str_replace("'", '',$cbo_item_category_id)==25) //Accessories,Services - Fabric,Services - Embellishment
				{
					$sql_order=sql_select("select e.id as order_id, e.po_number from com_pi_item_details b, wo_booking_dtls c, wo_po_details_master d, wo_po_break_down e where b.work_order_dtls_id=c.id and c.job_no=d.job_no and d.job_no=e.job_no_mst and c.po_break_down_id=e.id and b.pi_id=$update_id and d.company_name=$cbo_importer_id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.item_category_id=$cbo_item_category_id group by e.id, e.po_number");
				}
				else if(str_replace("'", '',$cbo_item_category_id)==24) //Services - Yarn
				{
					$sql_order=sql_select("select e.id as order_id, e.po_number from com_pi_item_details b, wo_yarn_dyeing_dtls c, wo_po_details_master d, wo_po_break_down e where b.work_order_dtls_id=c.id and c.job_no=d.job_no and d.job_no=e.job_no_mst and b.pi_id=$update_id and d.company_name=$cbo_importer_id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.item_category_id=$cbo_item_category_id group by e.id, e.po_number");
				}
				else if(str_replace("'", '',$cbo_item_category_id)==31) //Services Lab Test 
				{
					$sql_order=sql_select("select e.id as order_id, e.po_number from com_pi_item_details b, wo_labtest_dtls c, wo_po_details_master d, wo_po_break_down e where b.work_order_id=c.mst_id and c.job_no=d.job_no and d.job_no=e.job_no_mst and b.pi_id=$update_id and d.company_name=$cbo_importer_id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.item_category_id=$cbo_item_category_id group by e.id, e.po_number");
				}

				$order_id_arr=array();
				$order_no_arr=array();
				foreach ($sql_order as $val) {
					$order_id_arr[$val[csf('order_id')]]=$val[csf('order_id')];
					$order_no_arr[$val[csf('order_id')]]=$val[csf('po_number')];
				}

				$oder_diff_arr=array_diff($order_id_arr,$order_attach_arr);
				if (!empty($oder_diff_arr)){
					foreach ($oder_diff_arr as $order_id) {
						$order_NOs=$order_no_arr[$order_id].', ';
					}
					$order_NOs=rtrim($order_NOs, ', ');
					echo "15**$order_NOs -following order no are not found in selected LC/SC";disconnect($con);die;
				}
			}
		}		


		$field_array_update="pi_id*work_order_no*work_order_id*work_order_dtls_id*booking_without_order*determination_id*item_prod_id*item_group*item_description*hs_code*color_id*size_id*item_size*count_name*yarn_composition_item1*yarn_composition_percentage1*yarn_composition_item2*yarn_composition_percentage2*fabric_composition*fabric_construction*yarn_type*gsm*dia_width*weight*item_color*uom*quantity*rate*amount*net_pi_rate*net_pi_amount*service_type*brand_supplier*gmts_item_id*embell_name*embell_type*lot_no*yarn_color*color_range*test_for*test_item_id*remarks*body_part_id*fabric_ref*rd_no*fab_type*fab_design*fab_weight*fab_weight_type*cutable_width*width_dia_type*updated_by*update_date*order_source*order_id*order_no*buyer_style_ref*booking_article_no";

		$field_array="id,pi_id,work_order_no,work_order_id,work_order_dtls_id,booking_without_order,determination_id,item_prod_id,item_group,item_description,hs_code,color_id,size_id,item_size,count_name,yarn_composition_item1,yarn_composition_percentage1,yarn_composition_item2,yarn_composition_percentage2,fabric_composition,fabric_construction,yarn_type,gsm,dia_width,weight,item_color,uom,quantity,rate,amount,net_pi_rate,net_pi_amount,service_type,brand_supplier,gmts_item_id,embell_name,embell_type,lot_no,yarn_color,color_range,test_for,test_item_id,remarks,body_part_id, fabric_ref, rd_no, fab_type, fab_design, fab_weight, fab_weight_type, cutable_width, width_dia_type, item_category_id,after_goods_source,inserted_by,insert_date,order_source,order_id,order_no,buyer_style_ref,booking_article_no";


		$all_dtls_id=implode(",",array_unique(explode(",",chop($all_dtls_id,","))));
		$all_WoId=implode(",",array_unique(explode(",",chop($all_WoId,","))));
		if($all_WoId=="") $all_WoId=0;
		$bookingWithoutOrder_ss=implode(",",array_filter(array_unique(explode(",",chop($bookingWithoutOrder_ss,",")))));

		if(str_replace("'", '',$cbo_goods_rcv_status)==1 && $goods_rcv_variable !=1)
		{
			if($all_dtls_id=="") $all_dtls_id=0;
			if(str_replace("'", '',$cbo_item_category_id)==12)
			{
				if(str_replace("'", '',$txt_order_type)==1)
				{
					$wo_qnty_arr=return_library_array("select id, wo_qnty as qnty from wo_booking_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else if(str_replace("'", '',$txt_order_type)==4)
				{
					$wo_qnty_arr=return_library_array("select id, wo_qnty as qnty from knitting_work_order_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else if(str_replace("'", '',$txt_order_type)==5)
				{
					$wo_qnty_arr=return_library_array("select id, wo_qnty as qnty from dyeing_work_order_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else
				{
					$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from wo_non_ord_aop_booking_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
			}
			else if(str_replace("'", '',$cbo_item_category_id)==25 || str_replace("'", '',$cbo_item_category_id)==102 || str_replace("'", '',$cbo_item_category_id)==103 || str_replace("'", '',$cbo_item_category_id)==104)
			{
				$wo_qnty_arr=return_library_array("select id, wo_qnty as qnty from wo_booking_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
			}
			else if(str_replace("'", '',$cbo_item_category_id)==31 || str_replace("'", '',$cbo_item_category_id)==115)
			{
				if(str_replace("'", '',$cbo_item_category_id)==31)
				{
					$wo_amnt_arr=return_library_array("select id, wo_value as wo_value from wo_labtest_dtls where status_active=1 and id in($all_dtls_id)","id","wo_value");
				}
				else
				{
					$wo_amnt_arr=return_library_array("select id, amount as wo_value from wo_inspection_dtls where status_active=1 and id in($all_dtls_id)","id","wo_value");
				}
				
				$prev_pi_amnt_arr=return_library_array( "select b.work_order_dtls_id,sum(b.amount) as amnt from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$cbo_item_category_id and a.pi_basis_id=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($all_dtls_id) and b.pi_id <>$update_id group by b.work_order_dtls_id", "work_order_dtls_id", "amnt");
			}
			else if(str_replace("'", '',$cbo_item_category_id)==4)
			{
				if(str_replace("'", '',$txt_order_type)==2)
				{
					$wo_qnty_arr=return_library_array("select id, cons_quantity as qnty from inv_transaction where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else
				{
					$ort_trans_sql=sql_select("select TRANS_ID, PO_BREAKDOWN_ID, QUANTITY from order_wise_pro_details where status_active=1 and TRANS_ID in($all_dtls_id)");
					foreach($ort_trans_sql as $val)
					{
						$wo_qnty_arr[$val["TRANS_ID"]][$val["PO_BREAKDOWN_ID"]]+=$val["QUANTITY"];
					}
					//$wo_qnty_arr=return_library_array("select id, quantity as qnty from order_wise_pro_details where status_active=1 and id in($all_dtls_id)","id","qnty");
				}				
			}
			else
			{
				$wo_qnty_arr=return_library_array("select id, cons_quantity as qnty from inv_transaction where status_active=1 and id in($all_dtls_id)","id","qnty");
			}

			$previous_pi_qty=return_library_array("select b.work_order_dtls_id as id, sum(b.quantity) as qnty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id $category_conds3 and a.after_goods_source=2 and b.after_goods_source=2 and b.status_active=1 and b.work_order_dtls_id in($all_dtls_id) and b.pi_id <>$update_id group by b.work_order_dtls_id","id","qnty");

			
			if(str_replace("'","",$cbo_item_category_id)==4)
			{
				if(str_replace("'", '',$txt_order_type)==2)
				{
					$prev_retun_sql="select booking_id, prod_id, issue_qnty as qty, 0 as order_id from inv_trims_issue_dtls where booking_id>0 and  booking_id in($all_WoId) and status_active=1 order by booking_id,prod_id";
				}
				else
				{
					$prev_retun_sql="select a.booking_id, a.prod_id, b.po_breakdown_id as order_id, b.quantity as qty from inv_trims_issue_dtls a, order_wise_pro_details b where a.trans_id=b.trans_id and a.booking_id>0 and a.booking_id in($all_WoId) and a.status_active=1 and b.entry_form=73 and b.trans_type=4 and b.status_active=1 order by a.booking_id,a.prod_id";
				}
				//echo "10**".$all_WoId;die;

				$prev_retun_sql_result=sql_select($prev_retun_sql);
				foreach($prev_retun_sql_result as $row)
				{
					$prev_retun_qnty[$row[csf("booking_id")]][$row[csf("prod_id")]][$row[csf("order_id")]]+=$row[csf("qty")];
				}
			}
			else
			{
				$prev_retun_qnty=return_library_array("select b.recv_trans_id, sum(b.issue_qnty) as qnty
				from inv_transaction a, inv_mrr_wise_issue_details b where a.id=b.issue_trans_id and a.transaction_type=3 and b.recv_trans_id in($all_dtls_id)and a.status_active=1 and b.status_active=1 group by recv_trans_id","recv_trans_id","qnty");
			}
		}
		else
		{
			if($all_dtls_id=="") $all_dtls_id=0;
			$booking_id_cond=""; $bokIds_cond=""; $all_dtls_arr=explode(",",$all_dtls_id);
			if($db_type==2 && count($all_dtls_arr)>999)
			{
				$booking_id_chunk_arr=array_chunk($all_dtls_arr,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" b.work_order_dtls_id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
			}
			else
			{
				$booking_id_cond=" and b.work_order_dtls_id in($all_dtls_id)";
			}

			$with_or_without_cond="";
			if ($bookingWithoutOrder_ss)
			{
				$with_or_without_cond = " and b.booking_without_order in ($bookingWithoutOrder_ss)";
			}

			$previous_pi_qty=return_library_array("select b.work_order_dtls_id as id, sum(b.quantity) as qnty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id $category_conds3 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and a.import_pi=0 and b.pi_id <>$update_id $booking_id_cond $with_or_without_cond group by b.work_order_dtls_id","id","qnty");

			if(str_replace("'", '',$cbo_item_category_id)==1)
			{
				$wo_qnty_arr=return_library_array("select id, supplier_order_quantity as qnty from wo_non_order_info_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");

			}
			else if(str_replace("'", '',$cbo_item_category_id)==2 || str_replace("'", '',$cbo_item_category_id)==13)  // knit finish fabric
			{
				//echo "11**$txt_order_type";die;
				if(str_replace("'", '',$txt_order_type)==2)
				{
					$wo_qnty_arr=return_library_array("select b.id, b.finish_fabric as qnty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and b.status_active=1 and a.id in($all_WoId)","id","qnty");
					$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$cbo_item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_id in($all_WoId) and pi_id <> $update_id group by b.work_order_dtls_id", "work_order_dtls_id", "qty");



				}
				else
				{
					if(str_replace("'", '',$cbo_item_category_id)==13)
					{
						$wo_qnty_sql=sql_select("select a.id, a.booking_no, b.fabric_color_id, c.construction as construction, c.composition as copmposition, c.gsm_weight, b.dia_width, sum(b.grey_fab_qnty) as fin_fab_qnty, sum(b.grey_fab_qnty*b.rate) as amount, c.lib_yarn_count_deter_id, c.uom, 0 as dtls_id
						from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
						where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.id in($all_WoId) and a.status_active=1 and b.status_active=1
						group by a.id, a.booking_no, b.fabric_color_id, c.construction, c.composition, c.gsm_weight, b.dia_width,c.lib_yarn_count_deter_id,c.uom");
					}
					else
					{
						$wo_qnty_sql=sql_select("select a.id, a.booking_no, b.fabric_color_id, c.construction as construction, c.composition as copmposition, c.gsm_weight, b.dia_width, sum(b.fin_fab_qnty) as fin_fab_qnty, sum(b.fin_fab_qnty*b.rate) as amount, c.lib_yarn_count_deter_id, c.uom, 0 as dtls_id
						from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
						where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.id in($all_WoId) and a.status_active=1 and b.status_active=1
						group by a.id, a.booking_no, b.fabric_color_id, c.construction, c.composition, c.gsm_weight, b.dia_width,c.lib_yarn_count_deter_id,c.uom");
					}
					

					foreach($wo_qnty_sql as $row)
					{
						if($row[csf('fabric_color_id')]) $fab_color_id=$row[csf('fabric_color_id')]; else $fab_color_id=0;
						$wo_qnty_arr[$row[csf('booking_no')]][$row[csf('lib_yarn_count_deter_id')]][$fab_color_id][$row[csf('gsm_weight')]][strtoupper($row[csf('dia_width')])][$row[csf('uom')]]=$row[csf('fin_fab_qnty')];
					}

					$sql_prev="select b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$cbo_item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_id in($all_WoId) and b.pi_id <>$update_id group by b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom";// and b.work_order_dtls_id in($wo_dtls_id)
					//echo "11** $sql_prev";die;
					$prevData=sql_select($sql_prev);
					foreach($prevData as $rowP)
					{
						$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('gsm')]][strtoupper($rowP[csf('dia_width')])][$rowP[csf('uom')]]=$rowP[csf('qty')];
					}
				}
			}
			else if(str_replace("'", '',$cbo_item_category_id)==3)  // Woven Fabrics
			{
				if(str_replace("'", '',$txt_order_type)==2)
				{
					$wo_qnty_sql=sql_select("SELECT a.id, a.booking_no, b.fabric_color as fabric_color_id, b.construction as construction, b.composition as copmposition, b.body_part as body_part_id, b.gsm_weight as weight, b.dia_width as dia_or_width, b.item_size as cutable_width, b.uom, sum(b.finish_fabric) as fin_fab_qnty, sum(b.finish_fabric*b.rate) as amount, b.lib_yarn_count_deter_id, 0 as dtls_id
					from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b 
					where a.booking_no=b.booking_no and a.id in($all_WoId) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0
					group by a.id, a.booking_no, b.fabric_color, b.construction, b.composition, b.body_part, b.gsm_weight, b.dia_width, b.item_size, b.uom, b.lib_yarn_count_deter_id
					order by a.booking_no, b.body_part");
					foreach($wo_qnty_sql as $row)
					{
						$wo_qnty_arr[$row[csf('booking_no')]][$row[csf('body_part_id')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('weight')]][$row[csf('dia_or_width')]][$row[csf('cutable_width')]][$row[csf('uom')]]=$row[csf('fin_fab_qnty')];
					}

					$sql_prev="SELECT b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.fab_weight_type, b.cutable_width, b.uom, sum(b.quantity) as qty 
                	from com_pi_master_details a, com_pi_item_details b 
                	where a.id=b.pi_id and a.item_category_id=$cbo_item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_id in($all_WoId) 
               		group by b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.fab_weight_type, b.cutable_width, b.uom";
					$prevData=sql_select($sql_prev);
					foreach($prevData as $rowP)
					{
						$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('body_part_id')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('fab_weight')]][$rowP[csf('fab_weight_type')]][$rowP[csf('cutable_width')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
					}

				}
				else
				{					

					$wo_qnty_sql=sql_select("SELECT a.id, a.booking_no, b.fabric_color_id, c.construction as construction, c.composition as copmposition, b.gsm_weight as weight, c.gsm_weight_type as fab_weight_type, c.width_dia_type as dia_or_width, b.dia_width as width, b.item_size as cutable_width, sum(b.fin_fab_qnty) as fin_fab_qnty, sum(b.fin_fab_qnty*b.rate) as amount, c.lib_yarn_count_deter_id, c.body_part_id, c.uom, 0 as dtls_id
                    from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c 
                    where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.id in($all_WoId) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 
                    group by a.id, a.booking_no, b.fabric_color_id, c.construction, c.composition, b.gsm_weight, c.gsm_weight_type, c.width_dia_type, b.dia_width, b.item_size, c.lib_yarn_count_deter_id, c.body_part_id, c.uom");

                    foreach($wo_qnty_sql as $row)
                    {
                        if ($row[csf('fabric_color_id')]) $fab_color_id=$row[csf('fabric_color_id')]; else $fab_color_id=0;
                        $wo_qnty_arr[$row[csf('booking_no')]][$row[csf('body_part_id')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('weight')]][$row[csf('fab_weight_type')]][$row[csf('dia_or_width')]][strtoupper($row[csf('width')])][$row[csf('cutable_width')]][$row[csf('uom')]]=$row[csf('fin_fab_qnty')];
                    }
                    //echo '<pre>';print_r($wo_qnty_arr);
                    
                    $sql_prev="SELECT b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.fab_weight_type, b.width_dia_type, b.dia_width, b.cutable_width, b.uom, sum(b.quantity) as qty 
                    from com_pi_master_details a, com_pi_item_details b 
                    where a.id=b.pi_id and a.item_category_id=$cbo_item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_id in($all_WoId) and b.pi_id <>$update_id
                    group by b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.fab_weight_type, b.width_dia_type, b.dia_width, b.cutable_width, b.uom";
                    $prevData=sql_select($sql_prev);
                    foreach($prevData as $rowP)
                    {
                        $prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('body_part_id')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('fab_weight')]][$rowP[csf('fab_weight_type')]][$rowP[csf('width_dia_type')]][strtoupper($rowP[csf('dia_width')])][$rowP[csf('cutable_width')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
                    }
				}
			}
			else if(str_replace("'", '',$cbo_item_category_id)==4)  // Accessories
			{
				if(str_replace("'", '',$txt_order_type)==2)
				{
					if($all_dtls_id=="") $all_dtls_id=0;
					$booking_id_cond=""; $bokIds_cond=""; $all_dtls_arr=explode(",",$all_dtls_id);
					if($db_type==2 && count($all_dtls_arr)>999)
					{
						$booking_id_chunk_arr=array_chunk($all_dtls_arr,999) ;
						foreach($booking_id_chunk_arr as $chunk_arr)
						{
							$chunk_arr_value=implode(",",$chunk_arr);
							$bokIds_cond.="  id in($chunk_arr_value) or ";
						}

						$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
						//echo $booking_id_cond;die;
					}
					else
					{
						$booking_id_cond=" and id in($all_dtls_id)";
					}

					$wo_qnty_arr=return_library_array("select id as wo_trim_booking_dtls_id, trim_qty as qnty from wo_non_ord_samp_booking_dtls where status_active=1 $booking_id_cond","wo_trim_booking_dtls_id","qnty");
				}
				else
				{
					if($all_dtls_id=="") $all_dtls_id=0;
					$booking_id_cond=""; $bokIds_cond=""; $all_dtls_arr=explode(",",$all_dtls_id);
					if($db_type==2 && count($all_dtls_arr)>999)
					{
						$booking_id_chunk_arr=array_chunk($all_dtls_arr,999) ;
						foreach($booking_id_chunk_arr as $chunk_arr)
						{
							$chunk_arr_value=implode(",",$chunk_arr);
							$bokIds_cond.="  wo_trim_booking_dtls_id in($chunk_arr_value) or ";
						}

						$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
						//echo $booking_id_cond;die;
					}
					else
					{
						$booking_id_cond=" and wo_trim_booking_dtls_id in($all_dtls_id)";
					}


					$wo_qnty_arr=return_library_array("select wo_trim_booking_dtls_id, sum(cons) as qnty from wo_trim_book_con_dtls where status_active=1 $booking_id_cond and booking_no in ($all_wo_no) and cons>0 group by wo_trim_booking_dtls_id","wo_trim_booking_dtls_id","qnty");
				}
			}
			else if(str_replace("'", '',$cbo_item_category_id)==12)
			{
				if(str_replace("'", '',$txt_order_type)==1)
				{
					$wo_qnty_arr=return_library_array("select id, wo_qnty as qnty from wo_booking_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else if(str_replace("'", '',$txt_order_type)==2)
				{
					$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from wo_non_ord_aop_booking_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else if(str_replace("'", '',$txt_order_type)==4)
				{
					$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from knitting_work_order_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else if(str_replace("'", '',$txt_order_type)==5)
				{
					$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from dyeing_work_order_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
				else
				{
					$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from wo_non_ord_knitdye_booking_dtl where status_active=1 and id in($all_dtls_id)","id","qnty");
				}
			}
			else if(str_replace("'", '',$cbo_item_category_id)==24)
			{
				$wo_qnty_arr=return_library_array("select id, yarn_wo_qty as qnty from wo_yarn_dyeing_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
			}
			else if(str_replace("'", '',$cbo_item_category_id)==25 || str_replace("'", '',$cbo_item_category_id)==102 || str_replace("'", '',$cbo_item_category_id)==103 || str_replace("'", '',$cbo_item_category_id)==104)
			{
				$wo_qnty_arr=return_library_array("select id, wo_qnty as qnty from wo_booking_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
			}
			else if(str_replace("'", '',$cbo_item_category_id)==116)
			{
				$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from garments_service_wo_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
			}
			else if(str_replace("'", '',$cbo_item_category_id)==100)
			{
				$wo_qnty_arr=return_library_array("select id, wo_qty as qnty from subcon_wo_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
			}
			else if(str_replace("'", '',$cbo_item_category_id)==31 || str_replace("'", '',$cbo_item_category_id)==115)
			{
				if(str_replace("'", '',$cbo_item_category_id)==31)
				{
					$wo_amnt_arr=return_library_array("select id, wo_value as wo_value from wo_labtest_dtls where status_active=1 and id in($all_dtls_id)","id","wo_value");
				}
				else
				{
					$wo_amnt_arr=return_library_array("select id, amount as wo_value from wo_inspection_dtls where status_active=1 and id in($all_dtls_id)","id","wo_value");
				}
				
				$prev_pi_amnt_arr=return_library_array( "select b.work_order_dtls_id,sum(b.amount) as amnt from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$cbo_item_category_id and a.pi_basis_id=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($all_dtls_id) and b.pi_id <>$update_id group by b.work_order_dtls_id", "work_order_dtls_id", "amnt");
			}
			else
			{
				$wo_qnty_arr=return_library_array("select id, supplier_order_quantity as qnty from wo_non_order_info_dtls where status_active=1 and id in($all_dtls_id)","id","qnty");
			}
		}

		//echo "11**<pre>";print_r($wo_qnty_arr);print_r($prev_pi_qty_arr);die;

		$id = return_next_id( "id","com_pi_item_details", 1 );
		$data_array=array(); $data_array_update=array();
		$woDtlsTrsansId='';$trans_qty_check_arr=array();
		$prev_gross_amt=$prev_net_amt=0;
		for($i=1;$i<=$total_row;$i++)
		{
			$updateIdDtls="updateIdDtls_".$i;
			$hsCode="hsCode_".$i;
			$colorName="colorName_".$i;
			$sizeName="sizeName_".$i;
			$countName="countName_".$i;
			$yarnCompositionItem1="yarnCompositionItem1_".$i;
			$yarnCompositionPercentage1="yarnCompositionPercentage1_".$i;
			$yarnCompositionItem2="yarnCompositionItem2_".$i;
			$yarnCompositionPercentage2="yarnCompositionPercentage2_".$i;
			$yarnType="yarnType_".$i;
			$uom="uom_".$i;
			$quantity="quantity_".$i;
			$rate="rate_".$i;
			$amount="amount_".$i;
			$workOrderNo="workOrderNo_".$i;
			$workOrderId="hideWoId_".$i;
			$workOrderDtlsId="hideWoDtlsId_".$i;
			$itemProdId="itemProdId_".$i;
			$determinationId="hideDeterminationId_".$i;
			$construction="construction_".$i;
			$composition="composition_".$i;
			$gsm="gsm_".$i;
			$diawidth="diawidth_".$i;
			$weight="weight_".$i;
			$itemgroupid="itemgroupid_".$i;
			$itemdescription="itemdescription_".$i;
			$servicetype="servicetype_".$i;
			$item_color="itemColor_".$i;
			$itemSize="itemSize_".$i;
			$brandSupRef="brandSupRef_".$i;
			$lot="lot_".$i;
			$yarnColor="yarnColor_".$i;
			$colorRange="colorRange_".$i;
			$gmtsitem="gmtsitem_".$i;
			$embellname="embellname_".$i;
			$embelltype="embelltype_".$i;
			$bookingWithoutOrder="bookingWithoutOrder_".$i;
			$cboTestFor="cboTestFor_".$i;
			$testItemId="testItemId_".$i;
			$remarks="remarks_".$i;
			$bodyPartId="bodyPart_".$i;
            $fabricRef="fabricRef_".$i;
            $rdNo="rdNo_".$i;
            $fabType="fabType_".$i;
            $fabDesign="fabDesign_".$i;
            $fabWeight="fabWeight_".$i;
            $fabWeightType="fabWeightType_".$i;
            $cutableWidth="cutableWidth_".$i;
            $diawidthType="diawidthType_".$i;
			$hideTransData="hideTransData_".$i;
			$hideOrdeSource="hideOrdeSource_".$i;			
			//$bookingWithoutOrder="bookingWithoutOrder_".$i;
			$hidePoId="hidePoId_".$i;
			$poNo="poNo_".$i;
			$styleRef="styleRef_".$i;
			$poRef="poRef_".$i;			
			$itemcategory="itemcategory_".$i;
			
			if($master_category_id==8) $cbo_item_category_id = str_replace("'","",$$itemcategory);
			
			if($cbo_item_category_id!=4)
			{
				$$hidePoId="";
				$$poNo="";
				$$styleRef="";
				$$poRef="";
			}
			
			if(str_replace("'","",$$hideOrdeSource)=="" || str_replace("'","",$$hideOrdeSource)=="undefined") $paySource=0; else $paySource=str_replace("'","",$$hideOrdeSource);
			if(str_replace("'","",$$bookingWithoutOrder)=="") $bookWithoutOrder=0; else $bookWithoutOrder=str_replace("'","",$$bookingWithoutOrder);
			//if(str_replace("'","",$$hideOrdeSource)=="") $paySource=0; else $paySource=str_replace("'","",$$hideOrdeSource);

			if(str_replace("'","",$$testItemId)=='undefined')
			{
				$$testItemId=0;
			}
			if(str_replace("'","",$$itemProdId)=='undefined')
			{
				$$itemProdId=0;
			}
			//echo "10** jahid".$$fabWeightType;die;

			if(str_replace("'","",$$updateIdDtls)!="")
			{
				$wotransId=str_replace("'","",$$workOrderDtlsId);
				$allWoId.=str_replace("'","",$$workOrderId).",";
				$trans_qty_check_arr[$wotransId]=str_replace("'","",$$quantity);
				if($woDtlsTrsansId=='') $woDtlsTrsansId=$wotransId;else $woDtlsTrsansId.=','.$wotransId;

				$perc=(str_replace("'","",$$amount)/$txt_total_amount)*100;
				$net_pi_amount=($perc*$txt_total_amount_net)/100;

				if(str_replace("'", '',$cbo_item_category_id)==31 || str_replace("'", '',$cbo_item_category_id)==115)
				{
					$net_pi_rate=0;
				}
				else
				{
					$net_pi_rate=$net_pi_amount/str_replace("'","",$$quantity);
					$net_pi_rate=number_format($net_pi_rate,$dec_place[3],'.','');
				}
				//echo "10** $net_pi_rate = $net_pi_amount = $perc";die;
				if($cbo_currency_id==1)
					$net_pi_amount=number_format($net_pi_amount,$dec_place[4],'.','');
				else
					$net_pi_amount=number_format($net_pi_amount,$dec_place[5],'.','');

				if(str_replace("'","",$$colorName)!="")
				{
					if (!in_array(str_replace("'","",$$colorName),$new_array_color))
					{
						$color_id = return_id( str_replace("'","",$$colorName), $color_library, "lib_color", "id,color_name","405");
						$new_array_color[$color_id]=str_replace("'","",$$colorName);
					}
					else $color_id =  array_search(str_replace("'","",$$colorName), $new_array_color);
				}
				else
				{
					$color_id=0;
				}

				if($cbo_item_category_id==4 || $cbo_item_category_id==12)
				{
					if(str_replace("'","",$$sizeName)!="")
					{
						if (!in_array(str_replace("'","",$$sizeName),$new_array_size))
						{
						  $size_id = return_id( str_replace("'","",$$sizeName), $size_library, "lib_size", "id,size_name","405");
						  $new_array_size[$size_id]=str_replace("'","",$$sizeName);
						}
						else $size_id =  array_search(str_replace("'","",$$sizeName), $new_array_size);
					}
					else
					{
						$size_id=0;
					}

					if(str_replace("'","",$$item_color)!="")
					{
						if (!in_array(str_replace("'","",$$item_color),$new_array_color))
						{
							$item_color_id = return_id( str_replace("'","",$$item_color), $color_library, "lib_color", "id,color_name","405");
							$new_array_color[$item_color_id]=str_replace("'","",$$item_color);
						}
						else $item_color_id =  array_search(str_replace("'","",$$item_color), $new_array_color);
					}
					else
					{
						$item_color_id=0;
					}
				}
				else
				{
					$size_id=0;
					$item_color_id=0;
				}

				if(str_replace("'", '',$cbo_goods_rcv_status)==2 && str_replace("'", '',$cbo_pi_basis_id)==1)
				{
					//echo  "11*".str_replace("'", '',$cbo_item_category_id).'**'.str_replace("'", '',$txt_order_type).'syst';disconnect($con);die;
					//3**syst
					if((str_replace("'", '',$cbo_item_category_id)==2 || str_replace("'", '',$cbo_item_category_id)==13) && str_replace("'", '',$txt_order_type)==1)	
					{
						$bal_wo_qnty=$wo_prev_qnty=$pi_prev_qnty=0;
						$wo_prev_qnty=$wo_qnty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$gsm)][strtoupper(str_replace("'","",$$diawidth))][str_replace("'","",$$uom)];
						$pi_prev_qnty=$prev_pi_qty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$construction)][str_replace("'","",$$composition)][str_replace("'","",$$gsm)][strtoupper(str_replace("'","",$$diawidth))][str_replace("'","",$$uom)];
						$bal_wo_qnty=($wo_prev_qnty-$pi_prev_qnty);
						//echo "11**".str_replace("'","",$$workOrderNo)."=".str_replace("'","",$$determinationId)."=".str_replace("'","",$color_id)."=".str_replace("'","",$$gsm)."=".str_replace("'","",$$diawidth)."=".str_replace("'","",$$uom);die; 

					}

					else if(str_replace("'", '',$cbo_item_category_id)==3)
					{
						//echo "11**PI Quantity Not Allow Over Balance Quantity $trans_qnty ==6 $txt_order_type";disconnect($con);die;
						//echo 'system1';
						$bal_wo_qnty=$wo_prev_qnty=$pi_prev_qnty=0;	
						// echo "11**".str_replace("'","",$$workOrderNo).'**'.str_replace("'","",$$bodyPartId).'**'.str_replace("'","",$$determinationId).'**'.str_replace("'","",$color_id).'**'.str_replace("'","",$$construction).'**'.str_replace("'","",$$composition).'**'.str_replace("'","",$$fabWeight).'**'.str_replace("'","",$$fabWeightType).'**'.str_replace("'","",$$diawidthType).'**'.str_replace("'","",$$diawidth).'**'.str_replace("'","",$$cutableWidth).'**'.str_replace("'","",$$uom).'system';		
						// echo "<pre>";print_r($wo_qnty_arr);die;
						if (str_replace("'", '',$txt_order_type)==1)
						{
							$wo_prev_qnty=$wo_qnty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$bodyPartId)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$construction)][str_replace("'","",$$composition)][str_replace("'","",$$fabWeight)][str_replace("'","",$$fabWeightType)][str_replace("'","",$$diawidthType)][strtoupper(str_replace("'","",$$diawidth))][str_replace("'","",$$cutableWidth)][str_replace("'","",$$uom)];
                        	$pi_prev_qnty=$prev_pi_qty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$bodyPartId)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$construction)][str_replace("'","",$$composition)][str_replace("'","",$$fabWeight)][str_replace("'","",$$fabWeightType)][str_replace("'","",$$diawidthType)][strtoupper(str_replace("'","",$$diawidth))][str_replace("'","",$$cutableWidth)][str_replace("'","",$$uom)];
						}
						else if (str_replace("'", '',$txt_order_type)==2)
						{
							$wo_prev_qnty=$wo_qnty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$bodyPartId)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$construction)][str_replace("'","",$$composition)][str_replace("'","",$$fabWeight)][str_replace("'","",$$diawidthType)][str_replace("'","",$$cutableWidth)][str_replace("'","",$$uom)];
							//echo '<pre>';print_r($wo_qnty_arr);
							//echo $wo_prev_qnty;
							$pi_prev_qnty=$prev_pi_qty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$bodyPartId)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$construction)][str_replace("'","",$$composition)][str_replace("'","",$$fabWeight)][str_replace("'","",$$diawidthType)][str_replace("'","",$$cutableWidth)][str_replace("'","",$$uom)];
						}                       

						$bal_wo_qnty=($wo_prev_qnty-$pi_prev_qnty);	
						//echo $wo_prev_qnty.'**'.$pi_prev_qnty.'**'.$bal_wo_qnty.'system';					

					}
					else
					{
						if(str_replace("'", '',$cbo_item_category_id)==31 || str_replace("'", '',$cbo_item_category_id)==115)
						{
							$bal_wo_amt=($wo_amnt_arr[str_replace("'","",$$workOrderDtlsId)]-$prev_pi_amnt_arr[str_replace("'","",$$workOrderDtlsId)]);
						}
						else if(str_replace("'", '',$cbo_item_category_id)==2 || str_replace("'", '',$cbo_item_category_id)==3 || str_replace("'", '',$cbo_item_category_id)==13)
						{
							$bal_wo_qnty=($wo_qnty_arr[str_replace("'","",$$workOrderDtlsId)]-$prev_pi_qty_arr[str_replace("'","",$$workOrderDtlsId)]);
						}
						else
						{
							$bal_wo_qnty=($wo_qnty_arr[str_replace("'","",$$workOrderDtlsId)]-$previous_pi_qty[str_replace("'","",$$workOrderDtlsId)]);
						}
					}

					$trans_qnty=str_replace("'","",$$quantity);
					$bal_wo_qnty=number_format($bal_wo_qnty,6,'.','');
					$trans_qnty=number_format($trans_qnty,6,'.','');

					if(str_replace("'", '',$cbo_item_category_id)==31 || str_replace("'", '',$cbo_item_category_id)==115)
					{
						$trans_amount=str_replace("'","",$$amount);
						$bal_wo_amt=number_format($bal_wo_amt,2,'.','');
						$trans_amount=number_format($trans_amount,2,'.','');
						if($trans_amount>$bal_wo_amt)
						{
							echo "11**PI Amount Not Allow Over Balance Amount";disconnect($con);die;
						}
					}
					else
					{
						if($trans_qnty>$bal_wo_qnty)
						{
							echo "11**PI Quantity Not Allow Over Balance Quantity $trans_qnty ==5 $bal_wo_qnty";disconnect($con);die;
						}
					}

				}

				if(str_replace("'","",$$hideOrdeSource)==5 && $cbo_item_category_id==1)
				{
					$ordeSource=str_replace("'","",$$hideOrdeSource);
					$prev_pi_amt=$prev_block_wo_amount-$tot_current_unblock_amt;
					if($prev_pi_amt>0) $prev_pi_qnty=$prev_pi_amt/str_replace("'","",$$rate);
					else $prev_pi_qnty=0;
					
					$net_pi_amount=$net_pi_rate*$prev_pi_qnty;

					/*if($current_unblock_amt>str_replace("'","",$$amount))
					{
						$prev_pi_amt=0;
						$prev_pi_qnty=0;
						$current_unblock_amt=$current_unblock_amt-str_replace("'","",$$amount);
					}
					else
					{
						$prev_pi_amt=str_replace("'","",$$amount)-$current_unblock_amt;
						$prev_pi_qnty=$prev_pi_amt/str_replace("'","",$$rate);
					}*/
				}
				else
				{
					$prev_pi_amt=str_replace("'","",$$amount);
					$prev_pi_qnty=str_replace("'","",$$quantity);
				}
				//echo "14** PI Quantity Not Allow Less Then Mrr Quantity $prev_pi_amt.**1"; die;
				$prev_gross_amt+=$prev_pi_amt;
				$prev_net_amt+=$prev_pi_amt;

				//$current_unblock_pi_data[str_replace("'","",$$hideWoId)]["amt"]

				$all_updateDtls_id.=str_replace("'",'',$$updateIdDtls).",";
				$id_arr[]=str_replace("'",'',$$updateIdDtls);
				$data_array_update[str_replace("'",'',$$updateIdDtls)] = explode("*",($update_id."*'".str_replace("'","",$$workOrderNo)."'*'".str_replace("'","",$$workOrderId)."'*'".str_replace("'","",$$workOrderDtlsId)."'*'".$bookWithoutOrder."'*'".str_replace("'","",$$determinationId)."'*'".str_replace("'","",$$itemProdId)."'*'".str_replace("'","",$$itemgroupid)."'*'".str_replace("'","",$$itemdescription)."'*'".str_replace("'","",$$hsCode)."'*'".str_replace("'","",$color_id)."'*'".str_replace("'","",$size_id)."'*'".str_replace("'","",$$itemSize)."'*'".str_replace("'","",$$countName)."'*'".str_replace("'","",$$yarnCompositionItem1)."'*'".str_replace("'","",$$yarnCompositionPercentage1)."'*'".str_replace("'","",$$yarnCompositionItem2)."'*'".str_replace("'","",$$yarnCompositionPercentage2)."'*'".str_replace("'","",$$composition)."'*'".str_replace("'","",$$construction)."'*'".str_replace("'","",$$yarnType)."'*'".str_replace("'","",$$gsm)."'*'".str_replace("'","",$$diawidth)."'*'".str_replace("'","",$$weight)."'*'".str_replace("'","",$item_color_id)."'*'".str_replace("'","",$$uom)."'*'".$prev_pi_qnty."'*'".str_replace("'","",$$rate)."'*".$prev_pi_amt."*'".$net_pi_rate."'*'".$net_pi_amount."'*'".str_replace("'","",$$servicetype)."'*'".str_replace("'","",$$brandSupRef)."'*'".str_replace("'","",$$gmtsitem)."'*'".str_replace("'","",$$embellname)."'*'".str_replace("'","",$$embelltype)."'*'".str_replace("'","",$$lot)."'*'".str_replace("'","",$$yarnColor)."'*'".str_replace("'","",$$colorRange)."'*'".str_replace("'","",$$cboTestFor)."'*'".str_replace("'","",$$testItemId)."'*'".str_replace("'","",$$remarks)."'*'".str_replace("'","",$$bodyPartId)."'*'".str_replace("'","",$$fabricRef)."'*'".str_replace("'","",$$rdNo)."'*'".str_replace("'","",$$fabType)."'*'".str_replace("'","",$$fabDesign)."'*'".str_replace("'","",$$fabWeight)."'*'".str_replace("'","",$$fabWeightType)."'*'".str_replace("'","",$$cutableWidth)."'*'".str_replace("'","",$$diawidthType)."'*".$user_id."*'".$pc_date_time."'*'".$paySource."'*'".str_replace("'","",$$hidePoId)."'*'".str_replace("'","",$$poNo)."'*'".str_replace("'","",$$styleRef)."'*'".str_replace("'","",$$poRef)."'"));
				//echo "11**";print_r($data_array_update);disconnect($con);die;
			}
			else
			{
				if(str_replace("'", '',$cbo_pi_basis_id)==1 && str_replace("'", '',$cbo_goods_rcv_status)==1 && $goods_rcv_variable !=1 && (str_replace("'", '',$cbo_item_category_id)!=12 && str_replace("'", '',$cbo_item_category_id)!=25 && str_replace("'", '',$cbo_item_category_id)!=102 && str_replace("'", '',$cbo_item_category_id)!=103 && str_replace("'", '',$cbo_item_category_id)!=104 && str_replace("'", '',$cbo_item_category_id)!=31))
				{
					//echo "10** jahid".$$hideTransData;die;
					$hideTransData_arr=explode("__",str_replace("'","",$$hideTransData));
					foreach($hideTransData_arr as $hide_trans_val)
					{
						$hide_trans_val_arr=explode("_",$hide_trans_val);
						$trans_id=$hide_trans_val_arr[0];
						$trans_qnty=$hide_trans_val_arr[1];
						$trans_amt=$hide_trans_val_arr[2];
						$prod_id=$hide_trans_val_arr[3];
						$propor_order_id=$hide_trans_val_arr[4];

						//echo "10**".$trans_id;die;

						$allWoId.=str_replace("'","",$$workOrderId).",";
						$wotransId=str_replace("'","",$trans_id);
						$trans_qty_check_arr[$trans_id]=str_replace("'","",$trans_qnty);
						if($woDtlsTrsansId=='') $woDtlsTrsansId=$trans_id; else $woDtlsTrsansId.=','.$trans_id;

						$perc=(str_replace("'","",$trans_amt)/$txt_total_amount)*100;
						$net_pi_amount=($perc*$txt_total_amount_net)/100;

						if(str_replace("'", '',$cbo_item_category_id)==31 || str_replace("'", '',$cbo_item_category_id)==115)
						{
							$net_pi_rate=0;
						}
						else
						{
							if($net_pi_amount>0 && str_replace("'","",$trans_qnty)>0)
							{
								$net_pi_rate=$net_pi_amount/str_replace("'","",$trans_qnty);
								$net_pi_rate=number_format($net_pi_rate,$dec_place[3],'.','');
							}
							else
							{
								$net_pi_rate=0;
							}

						}

						if($cbo_currency_id==1)
							$net_pi_amount=number_format($net_pi_amount,$dec_place[4],'.','');
						else
							$net_pi_amount=number_format($net_pi_amount,$dec_place[5],'.','');

						if(str_replace("'","",$$colorName)!="")
						{
							if (!in_array(str_replace("'","",$$colorName),$new_array_color))
							{
								$color_id = return_id( str_replace("'","",$$colorName), $color_library, "lib_color", "id,color_name","405");
								$new_array_color[$color_id]=str_replace("'","",$$colorName);
							}
							else $color_id =  array_search(str_replace("'","",$$colorName), $new_array_color);
						}
						else
						{
							$color_id=0;
						}

						if($cbo_item_category_id==4 || $cbo_item_category_id==12)
						{
							if(str_replace("'","",$$sizeName)!="")
							{
								if (!in_array(str_replace("'","",$$sizeName),$new_array_size))
								{
								  $size_id = return_id( str_replace("'","",$$sizeName), $size_library, "lib_size", "id,size_name","405");
								  $new_array_size[$size_id]=str_replace("'","",$$sizeName);
								}
								else $size_id =  array_search(str_replace("'","",$$sizeName), $new_array_size);
							}
							else
							{
								$size_id=0;
							}

							if(str_replace("'","",$$item_color)!="")
							{
								if (!in_array(str_replace("'","",$$item_color),$new_array_color))
								{
									$item_color_id = return_id( str_replace("'","",$$item_color), $color_library, "lib_color", "id,color_name","405");
									$new_array_color[$item_color_id]=str_replace("'","",$$item_color);
								}
								else $item_color_id =  array_search(str_replace("'","",$$item_color), $new_array_color);
							}
							else
							{
								$item_color_id=0;
							}
						}
						else
						{
							$size_id=0;
							$item_color_id=0;
						}

						//echo "11**".$wo_qnty_arr[$trans_id]."==".$previous_pi_qty[$trans_id]."==".$prev_retun_qnty[$trans_id];die;
						if(str_replace("'", '',$cbo_pi_basis_id)==1)
						{
							if(str_replace("'", '',$cbo_item_category_id)==4)
							{
								if($wo_qnty_arr[$trans_id][$propor_order_id]>$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$propor_order_id])
								{
									$bal_wo_qnty=($wo_qnty_arr[$trans_id][$propor_order_id]-($previous_pi_qty[$trans_id]+$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$propor_order_id]));
									$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$propor_order_id]=0;
								}
								else
								{
									$bal_wo_qnty=($wo_qnty_arr[$trans_id][$propor_order_id]-($previous_pi_qty[$trans_id]+$wo_qnty_arr[$trans_id][$propor_order_id]));
									$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$propor_order_id]=$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$propor_order_id]-$wo_qnty_arr[$trans_id][$propor_order_id];
									$previous_pi_qty[$trans_id]+$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$propor_order_id]=$previous_pi_qty[$trans_id]+$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id][$propor_order_id]-$wo_qnty_arr[$trans_id][$propor_order_id];
								}
							}
							else
							{
								$bal_wo_qnty=($wo_qnty_arr[$trans_id]-($previous_pi_qty[$trans_id]+$prev_retun_qnty[$trans_id]));
							}

							$bal_wo_qnty=number_format($bal_wo_qnty,2,'.','');

							if($trans_qnty>$bal_wo_qnty)
							{
								//echo "11**$trans_qnty==$bal_wo_qnty==".$wo_qnty_arr[$trans_id]."==".$previous_pi_qty[$trans_id]."==".$prev_retun_qnty[str_replace("'","",$$workOrderId)][$prod_id];die;
								echo "11**PI Quantity Not Allow Over Balance Quantity";disconnect($con);die;
							}
						}



						//if ($data_array!="") $data_array.=",";
						$prev_gross_amt+=str_replace("'","",$$amount);
						$prev_net_amt+=str_replace("'","",$net_pi_amount);
						$data_array[$id]="(".$id.",".$update_id.",'".str_replace("'","",$$workOrderNo)."','".str_replace("'","",$$workOrderId)."','".str_replace("'","",$trans_id)."','".$bookWithoutOrder."','".str_replace("'","",$$determinationId)."','".str_replace("'","",$$itemProdId)."','".str_replace("'","",$$itemgroupid)."','".str_replace("'","",$$itemdescription)."','".str_replace("'","",$$hsCode)."','".str_replace("'","",$color_id)."','".str_replace("'","",$size_id)."','".str_replace("'","",$$itemSize)."','".str_replace("'","",$$countName)."','".str_replace("'","",$$yarnCompositionItem1)."','".str_replace("'","",$$yarnCompositionPercentage1)."','".str_replace("'","",$$yarnCompositionItem2)."','".str_replace("'","",$$yarnCompositionPercentage2)."','".str_replace("'","",$$composition)."','".str_replace("'","",$$construction)."','".str_replace("'","",$$yarnType)."','".str_replace("'","",$$gsm)."','".str_replace("'","",$$diawidth)."','".str_replace("'","",$$weight)."','".str_replace("'","",$item_color_id)."','".str_replace("'","",$$uom)."','".str_replace("'","",$trans_qnty)."','".str_replace("'","",$$rate)."','".$trans_amt."','".$net_pi_rate."','".$net_pi_amount."','".str_replace("'","",$$servicetype)."','".str_replace("'","",$$brandSupRef)."','".str_replace("'","",$$gmtsitem)."','".str_replace("'","",$$embellname)."','".str_replace("'","",$$embelltype)."','".str_replace("'","",$$lot)."','".str_replace("'","",$$yarnColor)."','".str_replace("'","",$$colorRange)."','".str_replace("'","",$$cboTestFor)."','".str_replace("'","",$$testItemId)."','".str_replace("'","",$$remarks)."','".str_replace("'","",$$bodyPartId)."','".str_replace("'","",$$fabricRef)."','".str_replace("'","",$$rdNo)."','".str_replace("'","",$$fabType)."','".str_replace("'","",$$fabDesign)."','".str_replace("'","",$$fabWeight)."','".str_replace("'","",$$fabWeightType)."','".str_replace("'","",$$cutableWidth)."','".str_replace("'","",$$diawidthType)."',".$cbo_item_category_id.",'".$goods_rcv_variable."',".$user_id.",'".$pc_date_time."','".$paySource."','".str_replace("'","",$$hidePoId)."','".str_replace("'","",$$poNo)."','".str_replace("'","",$$styleRef)."','".str_replace("'","",$$poRef)."')";

						$id=$id+1;
						//str_replace("'","",$$bodyPartId)."'*'".str_replace("'","",$$)."'*'".str_replace("'","",$$)."'*'".str_replace("'","",$$)."'*'".str_replace("'","",$$)."'*'".str_replace("'","",$$)."'*'".str_replace("'","",$$)."'*'".str_replace("'","",$$)."'*'".str_replace("'","",$$)."'*"

					}
				}
				else
				{

					$allWoId.=str_replace("'","",$$workOrderId).",";
					$wotransId=str_replace("'","",$$workOrderDtlsId);
					$trans_qty_check_arr[$wotransId]=str_replace("'","",$$quantity);
					if($woDtlsTrsansId=='') $woDtlsTrsansId=$wotransId; else $woDtlsTrsansId.=','.$wotransId;

					$perc=(str_replace("'","",$$amount)/$txt_total_amount)*100;
					$net_pi_amount=($perc*$txt_total_amount_net)/100;

					if(str_replace("'", '',$cbo_item_category_id)==31 || str_replace("'", '',$cbo_item_category_id)==115)
					{
						$net_pi_rate=0;
					}
					else
					{
						$net_pi_rate=$net_pi_amount/str_replace("'","",$$quantity);
						$net_pi_rate=number_format($net_pi_rate,$dec_place[3],'.','');
					}

					if($cbo_currency_id==1)
						$net_pi_amount=number_format($net_pi_amount,$dec_place[4],'.','');
					else
						$net_pi_amount=number_format($net_pi_amount,$dec_place[5],'.','');

					if(str_replace("'","",$$colorName)!="")
					{
						if (!in_array(str_replace("'","",$$colorName),$new_array_color))
						{
							$color_id = return_id( str_replace("'","",$$colorName), $color_library, "lib_color", "id,color_name","405");
							$new_array_color[$color_id]=str_replace("'","",$$colorName);
						}
						else $color_id =  array_search(str_replace("'","",$$colorName), $new_array_color);
					}
					else
					{
						$color_id=0;
					}

					if($cbo_item_category_id==4 || $cbo_item_category_id==12)
					{
						if(str_replace("'","",$$sizeName)!="")
						{
							if (!in_array(str_replace("'","",$$sizeName),$new_array_size))
							{
							  $size_id = return_id( str_replace("'","",$$sizeName), $size_library, "lib_size", "id,size_name","405");
							  $new_array_size[$size_id]=str_replace("'","",$$sizeName);
							}
							else $size_id =  array_search(str_replace("'","",$$sizeName), $new_array_size);
						}
						else
						{
							$size_id=0;
						}

						if(str_replace("'","",$$item_color)!="")
						{
							if (!in_array(str_replace("'","",$$item_color),$new_array_color))
							{
								$item_color_id = return_id( str_replace("'","",$$item_color), $color_library, "lib_color", "id,color_name","405");
								$new_array_color[$item_color_id]=str_replace("'","",$$item_color);
							}
							else $item_color_id =  array_search(str_replace("'","",$$item_color), $new_array_color);
						}
						else
						{
							$item_color_id=0;
						}
					}
					else
					{
						$size_id=0;
						$item_color_id=0;
					}

					if(str_replace("'", '',$cbo_pi_basis_id)==1)
					{
						if(str_replace("'", '',$cbo_item_category_id)==31 || str_replace("'", '',$cbo_item_category_id)==115)
						{
							$bal_wo_amnt=$wo_amnt_arr[str_replace("'","",$$workOrderDtlsId)]-$prev_pi_amnt_arr[str_replace("'","",$$workOrderDtlsId)];
						}
						else
						{
							if(str_replace("'", '',$cbo_goods_rcv_status)==1 && $goods_rcv_variable !=1)
							{
								$bal_wo_qnty=($wo_qnty_arr[str_replace("'","",$$workOrderDtlsId)]-($previous_pi_qty[str_replace("'","",$$workOrderDtlsId)]+$prev_retun_qnty[str_replace("'","",$$workOrderDtlsId)]));

							}
							else
							{
								if((str_replace("'", '',$cbo_item_category_id)==2  || str_replace("'", '',$cbo_item_category_id)==13) && str_replace("'", '',$txt_order_type)==1)
								{
									$bal_wo_qnty=$wo_prev_qnty=$pi_prev_qnty=0;
									$wo_prev_qnty=$wo_qnty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$gsm)][strtoupper(str_replace("'","",$$diawidth))][str_replace("'","",$$uom)];
									$pi_prev_qnty=$prev_pi_qty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$gsm)][strtoupper(str_replace("'","",$$diawidth))][str_replace("'","",$$uom)];
									$bal_wo_qnty=($wo_prev_qnty-$pi_prev_qnty);
									// echo "11**$wo_prev_qnty";print_r($wo_qnty_arr);die;
									// echo "11**$wo_prev_qnty=".str_replace("'","",$$workOrderNo)."=".str_replace("'","",$$determinationId)."=".str_replace("'","",$color_id)."=".str_replace("'","",$$construction)."=".str_replace("'","",$$composition)."=".str_replace("'","",$$gsm)."=".strtoupper(str_replace("'","",$$diawidth))."=".str_replace("'","",$$uom);die;

								}
								else if(str_replace("'", '',$cbo_item_category_id)==3)
								{
									//echo "10**$txt_order_type**system";
									$bal_wo_qnty=$wo_prev_qnty=$pi_prev_qnty=0;
									if (str_replace("'", '',$txt_order_type)==1)
									{
										$wo_prev_qnty=$wo_qnty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$bodyPartId)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$construction)][str_replace("'","",$$composition)][str_replace("'","",$$fabWeight)][str_replace("'","",$$fabWeightType)][str_replace("'","",$$diawidthType)][strtoupper(str_replace("'","",$$diawidth))][str_replace("'","",$$cutableWidth)][str_replace("'","",$$uom)];
										//echo '<pre>';print_r($wo_qnty_arr);
										//echo $wo_prev_qnty;
										$pi_prev_qnty=$prev_pi_qty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$bodyPartId)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$construction)][str_replace("'","",$$composition)][str_replace("'","",$$fabWeight)][str_replace("'","",$$fabWeightType)][str_replace("'","",$$diawidthType)][strtoupper(str_replace("'","",$$diawidth))][str_replace("'","",$$cutableWidth)][str_replace("'","",$$uom)];
									}									
									else if (str_replace("'", '',$txt_order_type)==2)
									{
										$wo_prev_qnty=$wo_qnty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$bodyPartId)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$construction)][str_replace("'","",$$composition)][str_replace("'","",$$fabWeight)][str_replace("'","",$$diawidthType)][str_replace("'","",$$cutableWidth)][str_replace("'","",$$uom)];
										//echo '<pre>';print_r($wo_qnty_arr);
										//echo $wo_prev_qnty;
										$pi_prev_qnty=$prev_pi_qty_arr[str_replace("'","",$$workOrderNo)][str_replace("'","",$$bodyPartId)][str_replace("'","",$$determinationId)][str_replace("'","",$color_id)][str_replace("'","",$$construction)][str_replace("'","",$$composition)][str_replace("'","",$$fabWeight)][str_replace("'","",$$diawidthType)][str_replace("'","",$$cutableWidth)][str_replace("'","",$$uom)];
									}  

									$bal_wo_qnty=($wo_prev_qnty-$pi_prev_qnty);
								}
								else
								{
									$bal_wo_qnty=($wo_qnty_arr[str_replace("'","",$$workOrderDtlsId)]-$previous_pi_qty[str_replace("'","",$$workOrderDtlsId)]);
									$wo_prev_qnty=$wo_qnty_arr[str_replace("'","",$$workOrderDtlsId)];
									$pi_prev_qnty=$previous_pi_qty[str_replace("'","",$$workOrderDtlsId)];
								}

							}
						}
						//echo "10**".$trans_qnty."==".$bal_wo_qnty; die;
						$trans_qnty=str_replace("'","",$$quantity);
						$bal_wo_qnty=number_format($bal_wo_qnty,6,'.','');
						$trans_qnty=number_format($trans_qnty,6,'.','');

						//echo "11** $trans_qnty=$bal_wo_qnty=$wo_prev_qnty=$pi_prev_qnty#$txt_order_type";die;
						if(str_replace("'", '',$cbo_item_category_id)==31 || str_replace("'", '',$cbo_item_category_id)==115)
						{
							$trans_amount=str_replace("'","",$$amount);
							$bal_wo_amnt=number_format($bal_wo_amnt,2,'.','');
							$trans_amount=number_format($trans_amount,2,'.','');

							if($trans_amount>$bal_wo_amnt)
							{
								echo "11** PI Amount Not Allow Over Balance Amount";disconnect($con);die;
							}
						}
						else
						{
							if($trans_qnty>$bal_wo_qnty)
							{
								echo "11** PI Quantity Not Allow Over Balance Quantity".$trans_qnty."=".$bal_wo_qnty;disconnect($con);die;
							}
						}

					}
					$prev_gross_amt+=str_replace("'","",$$amount);
					$prev_net_amt+=str_replace("'","",$net_pi_amount);
					$data_array[$id]="(".$id.",".$update_id.",'".str_replace("'","",$$workOrderNo)."','".str_replace("'","",$$workOrderId)."','".str_replace("'","",$$workOrderDtlsId)."','".$bookWithoutOrder."','".str_replace("'","",$$determinationId)."','".str_replace("'","",$$itemProdId)."','".str_replace("'","",$$itemgroupid)."','".str_replace("'","",$$itemdescription)."','".str_replace("'","",$$hsCode)."','".str_replace("'","",$color_id)."','".str_replace("'","",$size_id)."','".str_replace("'","",$$itemSize)."','".str_replace("'","",$$countName)."','".str_replace("'","",$$yarnCompositionItem1)."','".str_replace("'","",$$yarnCompositionPercentage1)."','".str_replace("'","",$$yarnCompositionItem2)."','".str_replace("'","",$$yarnCompositionPercentage2)."','".str_replace("'","",$$composition)."','".str_replace("'","",$$construction)."','".str_replace("'","",$$yarnType)."','".str_replace("'","",$$gsm)."','".str_replace("'","",$$diawidth)."','".str_replace("'","",$$weight)."','".str_replace("'","",$item_color_id)."','".str_replace("'","",$$uom)."','".str_replace("'","",$$quantity)."','".str_replace("'","",$$rate)."',".$$amount.",'".$net_pi_rate."','".$net_pi_amount."','".str_replace("'","",$$servicetype)."','".str_replace("'","",$$brandSupRef)."','".str_replace("'","",$$gmtsitem)."','".str_replace("'","",$$embellname)."','".str_replace("'","",$$embelltype)."','".str_replace("'","",$$lot)."','".str_replace("'","",$$yarnColor)."','".str_replace("'","",$$colorRange)."','".str_replace("'","",$$cboTestFor)."','".str_replace("'","",$$testItemId)."','".str_replace("'","",$$remarks)."','".str_replace("'","",$$bodyPartId)."','".str_replace("'","",$$fabricRef)."','".str_replace("'","",$$rdNo)."','".str_replace("'","",$$fabType)."','".str_replace("'","",$$fabDesign)."','".str_replace("'","",$$fabWeight)."','".str_replace("'","",$$fabWeightType)."','".str_replace("'","",$$cutableWidth)."','".str_replace("'","",$$diawidthType)."',".$cbo_item_category_id.",'".$goods_rcv_variable."',".$user_id.",'".$pc_date_time."','".$paySource."','".str_replace("'","",$$hidePoId)."','".str_replace("'","",$$poNo)."','".str_replace("'","",$$styleRef)."','".str_replace("'","",$$poRef)."')";
					$id=$id+1;
				}
			}
		}

		//echo "10**".$prev_gross_amt."=". $prev_net_amt."=". $ordeSource."=". $cbo_item_category_id ."**1";die; //$ordeSource==5 && $cbo_item_category_id

		$allWoId=chop($allWoId,",");
		$all_updateDtls_id=chop($all_updateDtls_id,",");
		if(str_replace("'", '',$cbo_pi_basis_id)==1 && str_replace("'", '',$cbo_goods_rcv_status)==1 && $goods_rcv_variable !=1 && (str_replace("'", '',$cbo_item_category_id)!=4 && str_replace("'", '',$cbo_item_category_id)!=12 && str_replace("'", '',$cbo_item_category_id)!=25 && str_replace("'", '',$cbo_item_category_id)!=102 && str_replace("'", '',$cbo_item_category_id)!=103 && str_replace("'", '',$cbo_item_category_id)!=104 && str_replace("'", '',$cbo_item_category_id)!=31))
		{
			$prev_pi_qnty=return_library_array("Select b.work_order_dtls_id, sum(b.quantity) as pi_qnty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.goods_rcv_status=1 $category_conds3 and b.work_order_dtls_id in ($woDtlsTrsansId) and b.id not in($all_updateDtls_id) and b.status_active=1 group by b.work_order_dtls_id","work_order_dtls_id","pi_qnty");

			$prev_retun_qnty=return_library_array("select b.recv_trans_id, sum(b.issue_qnty) as qnty
			from inv_transaction a, inv_mrr_wise_issue_details b where a.id=b.issue_trans_id and a.transaction_type=3 and b.recv_trans_id in($woDtlsTrsansId) and b.status_active=1 group by recv_trans_id","recv_trans_id","qnty");

			$field_array_trans_update="pi_is_lock*updated_by*update_date";
			$sql_trns="Select id, pi_wo_batch_no, order_qnty as order_qnty from inv_transaction where id in ($woDtlsTrsansId) order by id";

			$sql_trns_res = sql_select($sql_trns);
			foreach($sql_trns_res as $row)
			{

				$pi_trans_qty=number_format(($trans_qty_check_arr[$row[csf('id')]]),2,'.','');
				$order_trans_qty=number_format(($row[csf('order_qnty')]-($prev_retun_qnty[$row[csf('id')]]+$prev_pi_qnty[$row[csf('id')]])),2,'.','');

				if($order_trans_qty>=$pi_trans_qty)
				{
					$is_lock=1;
					//echo $is_lock.'A';
				}
				else
				{
				   $is_lock=0;
				}

				$trans_id_arr[]=$row[csf('id')];
				$data_array_trans_update[$row[csf('id')]]=explode("*",($is_lock."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'"));
			}
		}

		if(str_replace("'", '',$cbo_pi_basis_id)==1 && str_replace("'", '',$cbo_goods_rcv_status)==1 && $goods_rcv_variable !=1 && str_replace("'", '',$cbo_item_category_id)==4)
        {
			$prev_pi_qnty=return_library_array("Select b.work_order_dtls_id, sum(b.quantity) as pi_qnty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.goods_rcv_status=1 and a.item_category_id=$cbo_item_category_id and b.work_order_dtls_id in ($woDtlsTrsansId) and b.id not in($all_updateDtls_id) and b.status_active=1 group by b.work_order_dtls_id","work_order_dtls_id","pi_qnty");
			if(str_replace("'", '',$txt_order_type)==2)
            {
				$prev_retun_sql="select booking_id, prod_id, trans_id, 0 as order_id, issue_qnty from inv_trims_issue_dtls where booking_id>0 and booking_id in($allWoId)";
				$prev_retun_sql_result=sql_select($prev_retun_sql);
				foreach($prev_retun_sql_result as $row)
				{
					$prev_retun_qnty[$row[csf("booking_id")]][$row[csf("prod_id")]][$row[csf("order_id")]]+=$row[csf("issue_qnty")]/$conver_factor[$row[csf("prod_id")]];
				}


				$field_array_trans_update="pi_is_lock*updated_by*update_date";
				$sql_trns="Select id, pi_wo_batch_no, 0 as order_id, order_qnty as order_qnty from inv_transaction where id in ($woDtlsTrsansId) and item_category=$cbo_item_category_id order by id";

				$sql_trns_res = sql_select($sql_trns);
				foreach($sql_trns_res as $row)
				{

					$pi_trans_qty=number_format(($trans_qty_check_arr[$row[csf('id')]]),2,'.','');
					if($row[csf('order_qnty')]>$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf("order_id")]])
					{
						$order_trans_qty=number_format(($row[csf('order_qnty')]-($prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf("order_id")]]+$prev_pi_qnty[$row[csf('id')]])),2,'.','');
						$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf("order_id")]]=0;
					}
					else
					{
						$order_trans_qty=number_format(($row[csf('order_qnty')]-($row[csf('order_qnty')]+$prev_pi_qnty[$row[csf('id')]])),2,'.','');
						$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf("order_id")]]=$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf("order_id")]]-$row[csf('order_qnty')];
					}					

					if($order_trans_qty>=$pi_trans_qty)
					{
						$is_lock=1;
						//echo $is_lock.'A';
					}
					else
					{
					   $is_lock=0;
					}

					$trans_id_arr[]=$row[csf('id')];
					$data_array_trans_update[$row[csf('id')]]=explode("*",($is_lock."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'"));
				}
            }
            else
            {

				$prev_retun_sql="select a.booking_id, a.prod_id, b.po_breakdown_id as order_id, b.quantity as qty from inv_trims_issue_dtls a, order_wise_pro_details b where a.trans_id=b.trans_id and a.booking_id>0 and a.booking_id in($allWoId) and a.status_active=1 and b.entry_form=73 and b.trans_type=4 and b.status_active=1 order by a.booking_id,a.prod_id";
				$prev_retun_sql_result=sql_select($prev_retun_sql);
				foreach($prev_retun_sql_result as $row)
				{
					$prev_retun_qnty[$row[csf("booking_id")]][$row[csf("prod_id")]][$row[csf("prod_id")]]+=$row[csf("qty")]/$conver_factor[$row[csf("prod_id")]];
				}

				$field_array_propor_update="pi_is_lock*updated_by*update_date";
				$sql_propor="Select a.id as trans_id, a.pi_wo_batch_no, a.prod_id, b.id, b.po_breakdown_id as order_id, b.quantity as order_qnty from inv_transaction a, order_wise_pro_details b where a.id=b.trans_id and b.id in ($woDtlsTrsansId) and b.status_active=1 and a.status_active=1 order by b.id";

				$sql_propor_res = sql_select($sql_propor);
				foreach($sql_propor_res as $row)
				{

					$pi_propor_qty=number_format(($trans_qty_check_arr[$row[csf('id')]]),2,'.','');
					if($row[csf('order_qnty')]>$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf('order_id')]])
					{
						$order_propor_qty=number_format(($row[csf('order_qnty')]-($prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf('order_id')]]+$prev_pi_qnty[$row[csf('id')]])),2,'.','');
						$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf('order_id')]]=0;
					}
					else
					{
						$order_propor_qty=number_format(($row[csf('order_qnty')]-($row[csf('order_qnty')]+$prev_pi_qnty[$row[csf('id')]])),2,'.','');
						$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf('order_id')]]=$prev_retun_qnty[$row[csf('pi_wo_batch_no')]][$row[csf('prod_id')]][$row[csf('order_id')]]-$row[csf('order_qnty')];
					}

					if($order_propor_qty>=$pi_propor_qty)
					{
						$is_lock=1;
						//echo $is_lock.'A';
					}
					else
					{
					   $is_lock=0;
					}

					$proportion_id_arr[]=$row[csf('id')];
					$data_array_propor_update[$row[csf('id')]]=explode("*",($is_lock."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'"));
				}
            }			
		}

	 	$flag=1;
		$rID=$rID2=$rID3=$rID5=$rID4=true;

		$cbo_item_category_id=str_replace("'", '',$cbo_item_category_id);
		$cbo_goods_rcv_status=str_replace("'", '',$cbo_goods_rcv_status);
		$sql_attach=sql_select("select a.id as btb_id, a.lc_number, a.lc_value from com_btb_lc_master_details a, com_btb_lc_pi b where a.id=b.com_btb_lc_master_details_id and b.pi_id='$update_id' and b.status_active=1 and b.is_deleted=0 group by a.id,a.lc_number, a.lc_value");
		if(count($sql_attach)>0)
		{
			$sql_btb_pi=sql_select("select sum(a.net_pi_amount) as tot_pi_amt from com_pi_item_details a, com_btb_lc_pi b where a.pi_id=b.pi_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.pi_id<>$update_id and b.com_btb_lc_master_details_id='".$sql_attach[0][csf('btb_id')]."'");
			if($sql_btb_pi[0][csf('tot_pi_amt')]) $rest_pi_amt=$sql_btb_pi[0][csf('tot_pi_amt')]*1; else $rest_pi_amt=0;
			$prev_net_amt=number_format(str_replace("'","",$prev_net_amt),2,".","");
			$all_pi_amt=number_format(($rest_pi_amt+$prev_net_amt),2,".","");
			$lc_number=$sql_attach[0][csf('lc_number')];
			$lc_value=number_format($sql_attach[0][csf('lc_value')],2,".","");
			if($all_pi_amt != $lc_value)
			{
				echo "14** PI Value Not Match With LC Value, $prev_net_amt = $rest_pi_amt  = $all_pi_amt = $lc_value LC Number : ".$lc_number."**1";disconnect($con);
				die;
			}
		}

		$field_array_update2="total_amount*upcharge*upcharge_breakdown*discount*discount_breakdown*net_total_amount";
		if($ordeSource==5 && $cbo_item_category_id==1)
		{
			$data_array_update2=$prev_gross_amt."*'".$txt_upcharge."'*'".$up_charge_break_down."'*'".$txt_discount."'*'".$discount_break_down."'*".$prev_net_amt;
		}
		else
		{
			if($cbo_currency_id==1)
			{
				$txt_total_amount=number_format($txt_total_amount,$dec_place[4],'.','');
				$txt_total_amount_net=number_format($txt_total_amount_net,$dec_place[4],'.','');
			}
			else
			{
				$txt_total_amount=number_format($txt_total_amount,$dec_place[5],'.','');
				$txt_total_amount_net=number_format($txt_total_amount_net,$dec_place[5],'.','');
			}
			$data_array_update2=$txt_total_amount."*'".$txt_upcharge."'*'".$up_charge_break_down."'*'".$txt_discount."'*'".$discount_break_down."'*".$txt_total_amount_net;
		}


		$rID4=sql_update("com_pi_master_details",$field_array_update2,$data_array_update2,"id",$update_id,1);
		if($flag==1)
		{
			if($rID4) $flag=1; else $flag=0;
		}

		//echo "11** MRR Found Update Not Allow $goods_rcv_variable == $txt_deleted_id = $goods_rcv_variable**1";die;
		if($goods_rcv_variable==1)
		{
			if(count($data_array_update)>0)
			{

				if($db_type==0)
				{
					$rID=execute_query(bulk_update_sql_statement( "com_pi_item_details", "id", $field_array_update, $data_array_update, $id_arr ));
				}
				else
				{

					$data_array_up=array_chunk($data_array_update,50,true);//print_r($data_array_tna_up[1]);die;

					$id_up_array=array_chunk($id_arr,50,true);

					$count_up=count($id_up_array);

					for ($i=0;$i<=$count_up;$i++)
				 	{

						$rID_up=execute_query(bulk_update_sql_statement( "com_pi_item_details", "id", $field_array_update, $data_array_up[$i], array_values($id_up_array[$i] )),1);

						if($rID != "1" )
						{
							oci_rollback($con);
							echo "6**0**1";
						}
					}
				}

				if($rID) $flag=1; else $flag=0;
			}

			if($txt_deleted_id!="")
			{
				$field_array_status="updated_by*update_date*status_active*is_deleted";
				$data_array_status=$user_id."*'".$pc_date_time."'*0*1";

				$rID3=sql_multirow_update("com_pi_item_details",$field_array_status,$data_array_status,"id",$txt_deleted_id,0);
				if($flag==1)
				{
					if($rID3) $flag=1; else $flag=0;
				}
			}
			if(count($data_array_trans_update)>0)
			{
				$rID5=execute_query(bulk_update_sql_statement("inv_transaction", "id",$field_array_trans_update,$data_array_trans_update,$trans_id_arr ));
				if($rID5) $flag=1; else $flag=0;
			}

			if(count($data_array_propor_update)>0)
			{
				$rID6=execute_query(bulk_update_sql_statement("order_wise_pro_details", "id",$field_array_propor_update,$data_array_propor_update,$proportion_id_arr ));
				if($rID6) $flag=1; else $flag=0;
			}
		}

		if(!empty($data_array))
		{

			$data_set=array_chunk($data_array,200);
			foreach( $data_set as $setRows)
			{
				//echo "10** insert into com_pi_item_details ($field_array) values ".implode(",",$setRows);oci_rollback($con);die;
				$rID2=sql_insert("com_pi_item_details",$field_array,implode(",",$setRows),0);

				//echo "5**".$rID;die;
				//$rID=sql_insert("com_pi_item_details",$field_array,$data_array,0);
				if($rID2==1) $flag=1; //else $flag=0;
				else if($rID2==0)
				{
					$flag=0;
					oci_rollback($con);
					echo "10**"; die;
				}
			}
		}
		//echo "11**";die;

		//echo "10**==$operation==jahid**1";die;
		//echo "6**=$rID=$rID2=$rID3=$rID5=$rID4=$flag**1";die;

		if($db_type==0)
		{
			if($flag==1)
			{
				mysql_query("COMMIT");
				echo "1**".str_replace("'", '', $update_id)."**1";
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "6**0**1";
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "1**".str_replace("'", '', $update_id)."**1";
			}
			else
			{

				oci_rollback($con);
				echo "6**0**1";
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==2)   // Delete Here
	{
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$sql_app=sql_select("select approved, total_amount, net_total_amount from com_pi_master_details where id='$update_id'");
		$prev_approved=$sql_app[0][csf("approved")];
		$total_amount=$sql_app[0][csf("total_amount")];
		$net_total_amount=$sql_app[0][csf("net_total_amount")];
		//if(count($sql_app)>0)
		if($prev_approved==1 || $prev_approved==3)
		{
			echo "16**1**1";
			disconnect($con);
			die;
		}
		$all_deleted_id=str_replace("'","",$txt_deleted_id);
		$sql_dtls=sql_select("select sum(amount) as amount from com_pi_item_details where pi_id=$update_id and status_active=1 and is_deleted=0 and order_source<>5 and id not in($all_deleted_id)");
		$tot_current_unblock_amt=$sql_dtls[0][csf("amount")];

		//echo "14**".$tot_current_unblock_amt."**1";die;

		$sql_attach=sql_select("select a.lc_number from com_btb_lc_master_details a, com_btb_lc_pi b where a.id=b.com_btb_lc_master_details_id and b.pi_id='$update_id' and b.status_active=1 and b.is_deleted=0 group by a.id, a.lc_number");
		if(count($sql_attach)>0)
		{
			$lc_number=$sql_attach[0][csf('lc_number')];
			echo "14**This PI is Attached With BTB LC No- '".$lc_number."'. So You can not delete it**1";
			disconnect($con);
			die;
		}

		if($cbo_item_category_id==1)
		{
			foreach($mrr_data as $pi_up_id=>$color_data)
			{
				foreach($color_data as $pi_color_id=>$count_data)
				{
					foreach($count_data as $pi_count_id=>$composition_data)
					{
						foreach($composition_data as $pi_composition_id=>$type_data)
						{
							foreach($type_data as $pi_type_id=>$mrr_qnty)
							{
								//echo "14**test**1= $pi_up_id = $pi_color_id = $pi_count_id = $pi_composition_id = $pi_type_id =";print_r($pi_prev_data); echo "=";die;
								//echo "14**This PI is Attached With MRR No- '".chop($recv_number,',')."'. So You can not delete it**1=";echo $pi_prev_data[$pi_up_id][$pi_color_id][$pi_count_id][$pi_composition_id][$pi_type_id]."=";die;
								//$pi_qnty=$mrr_rtn_qnty=0;
								//$pi_qnty=number_format($pi_prev_data[$pi_up_id][$pi_color_id][$pi_count_id][$pi_composition_id][$pi_type_id],2,".","");
								//$mrr_rtn_qnty=number_format($mrr_rtn_data[$pi_up_id][$pi_color_id][$pi_count_id][$pi_composition_id][$pi_type_id],2,".","");
								//$mrr_qnty=$mrr_qnty-$mrr_rtn_qnty;
								if($pi_prev_data[$pi_up_id][$pi_color_id][$pi_count_id][$pi_composition_id][$pi_type_id]>0)
								{
									echo "14**This PI is Attached With MRR No- '".chop($recv_number,',')."'. So You can not delete it**1";
									disconnect($con);
									die;
								}
							}
						}
					}
				}
			}
		}
		else if($cbo_item_category_id==2 || str_replace("'", '',$cbo_item_category_id)==13)
		{
			if(str_replace("'","",$cbo_goods_rcv_status)!=1)
			{
				$sql_attach_mrr=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b where a.id=b.mst_id and a.booking_id=$update_id and a.receive_basis=1 and b.receive_basis=1 and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and b.item_category=$cbo_item_category_id group by a.id, a.recv_number");				
				//$sql_attach_mrr=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b where a.id=b.mst_id and b.pi_wo_batch_no=$update_id and a.receive_basis=1 and b.receive_basis=1 and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and b.item_category=$cbo_item_category_id group by a.id, a.recv_number");
				if(count($sql_attach_mrr)>0)
				{
					$recv_number='';
					foreach($sql_attach_mrr as $row)
					{
						$recv_number.=$row[csf('recv_number')].",";
					}

					echo "14**This PI is Attached With MRR No- '".chop($recv_number,',')."'. So You can not delete it**1";
					disconnect($con);
					die;
				}
			}
		}
		else
		{
			if(str_replace("'","",$cbo_goods_rcv_status)!=1)
			{
				//$sql_attach_mrr=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b where a.id=b.mst_id and a.booking_id=$update_id and a.receive_basis=1 and b.receive_basis=1 and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and b.item_category=$cbo_item_category_id group by a.id, a.recv_number");
				$sql_attach_mrr=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b where a.id=b.mst_id and b.pi_wo_batch_no=$update_id and a.receive_basis=1 and b.receive_basis=1 and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 $category_conds group by a.id, a.recv_number");
				if(count($sql_attach_mrr)>0)
				{
					$recv_number='';
					foreach($sql_attach_mrr as $row)
					{
						$recv_number.=$row[csf('recv_number')].",";
					}

					echo "14**This PI is Attached With MRR No- '".chop($recv_number,',')."'. So You can not delete it**1";
					disconnect($con);
					die;
				}
			}
		}


		$field_array_update_dtls="quantity*rate*amount*net_pi_rate*net_pi_amount*updated_by*update_date";
		$woDtlsTrsansId='';$trans_qty_check_arr=array();

		for($i=1;$i<=$total_row;$i++)
		{
			$updateIdDtls="updateIdDtls_".$i;
			$quantity="quantity_".$i;
			$rate="rate_".$i;
			$amount="amount_".$i;
			$hideOrdeSource="hideOrdeSource_".$i;

			$workOrderDtlsId="hideWoDtlsId_".$i;
			$wotransId=str_replace("'","",$$workOrderDtlsId);
			$trans_qty_check_arr[$wotransId]['qty']=str_replace("'","",$$quantity);
			if($wotransId!="")
			{
				$woDtlsTrsansId.=$wotransId.",";
			}
			//echo "14**This PI is Attached With MRR No- $prev_pi_amt = $prev_pi_qnty =".str_replace("'",'',$$hideOrdeSource)." =".str_replace("'",'',$$updateIdDtls)." So You can not delete it**1";die;
			//if(str_replace("'","",$$hideOrdeSource)==5 && $cbo_item_category_id==1)
//			{
//				$ordeSource=str_replace("'","",$$hideOrdeSource);
//				$prev_pi_amt=($prev_block_wo_amount-$tot_current_unblock_amt);
//				if($prev_pi_amt>0) $prev_pi_qnty=$prev_pi_amt/str_replace("'","",$$rate);
//				else $prev_pi_qnty=0;
//
//				$id_dtls_arr[]=str_replace("'",'',$$updateIdDtls);
//				$data_array_update_dtls[str_replace("'",'',$$updateIdDtls)] = explode("*",($prev_pi_qnty."*'".str_replace("'","",$$rate)."'*'".$prev_pi_amt."'*'".str_replace("'","",$$rate)."'*'".$prev_pi_amt."'*".$user_id."*'".$pc_date_time."'"));
//
//			}

		}

		//echo "14**".bulk_update_sql_statement("com_pi_item_details", "id",$field_array_update_dtls,$data_array_update_dtls,$id_dtls_arr )."**1";die;

		$woDtlsTrsansId= chop($woDtlsTrsansId,",");
		//echo '10**'.$woDtlsTrsansId."=".str_replace("'", '',$cbo_pi_basis_id);die;
		if(str_replace("'", '',$cbo_pi_basis_id)==1)
		{
			if( $cbo_item_category_id==4 && str_replace("'", '',$cbo_goods_rcv_status)==1 && $goods_rcv_variable !=1 && str_replace("'", '',$txt_order_type)==1)
			{
				$field_array_propor_update="pi_is_lock*updated_by*update_date";
				$sql_propor="Select id, sum(quantity) as order_qnty from order_wise_pro_details where id in ($woDtlsTrsansId) group by id order by id";
				//echo "10**".$sql_trns; die;
				$sql_propor_res = sql_select($sql_propor);
				foreach($sql_propor_res as $row)
				{
					$pi_order_qty=$trans_qty_check_arr[$row[csf('id')]]['qty'];
					//echo $trans_qty_check_arr[$row[csf('id')]]['qty'];
					$order_propor_qty=$row[csf('order_qnty')];
					$is_lock=0;
					$propor_id_arr[]=$row[csf('id')];
					$data_array_propor_update[$row[csf('id')]]=explode("*",($is_lock."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'"));
					//echo "10**".$propor_id_arr[1].print_r($data_array_propor_update[$row[csf('id')]]); die;
				}
			}
			else
			{
				$field_array_trans_update="pi_is_lock*updated_by*update_date";
				$sql_trns="Select id, sum(order_qnty) as order_qnty from inv_transaction where id in ($woDtlsTrsansId)group by id order by id";
				//echo "10**".$sql_trns; die;
				$sql_trns_res = sql_select($sql_trns);
				foreach($sql_trns_res as $row)
				{
					$pi_trans_qty=$trans_qty_check_arr[$row[csf('id')]]['qty'];
					//echo $trans_qty_check_arr[$row[csf('id')]]['qty'];
					$order_trans_qty=$row[csf('order_qnty')];
					$is_lock=0;
					$trans_id_arr[]=$row[csf('id')];
					$data_array_trans_update[$row[csf('id')]]=explode("*",($is_lock."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'"));
					//echo "10**".$trans_id_arr[1].print_r($data_array_trans_update[$row[csf('id')]]); die;
				}
			}			
		}

		//
		//yes
		$flag=1;
		$field_array_update_mst="total_amount*upcharge*discount*net_total_amount";
		//$data_array_update_mst=$txt_total_amount."*'".$txt_upcharge."'*'".$txt_discount."'*".$txt_total_amount_net;
		if($ordeSource==5 && $cbo_item_category_id==1)
		{
			$total_amount=$tot_current_unblock_amt+$prev_pi_amt;
			$net_total_amount=$tot_current_unblock_amt+$prev_pi_amt;
			$data_array_update_mst=number_format($total_amount,$dec_place[4],'.','')."*'".$txt_upcharge."'*'".$txt_discount."'*".number_format($net_total_amount,$dec_place[4],'.','');
		}
		else
		{
			if($cbo_currency_id==1)
			{
				$txt_total_amount=number_format($txt_total_amount,$dec_place[4],'.','');
				$txt_total_amount_net=number_format($txt_total_amount_net,$dec_place[4],'.','');
			}
			else
			{
				$txt_total_amount=number_format($txt_total_amount,$dec_place[5],'.','');
				$txt_total_amount_net=number_format($txt_total_amount_net,$dec_place[5],'.','');
			}
			$data_array_update_mst=$txt_total_amount."*'".$txt_upcharge."'*'".$txt_discount."'*".$txt_total_amount_net;
		}
		//echo "14**".$data_array_update_mst."**1";die;
		$rID=sql_update("com_pi_master_details",$field_array_update_mst,$data_array_update_mst,"id",$update_id,1);
		if($flag==1)
		{
			if($rID) $flag=1; else $flag=0;
		}
		//echo "14**".$txt_deleted_id."**1";die;
		
		$rID5=true;
		if($txt_deleted_id!="" && $flag==1)
		{
			//echo $txt_deleted_id;die("__with deleted id");
			//$field_array_status="updated_by*update_date*status_active*is_deleted";
			//$data_array_status=$user_id."*'".$pc_date_time."'*0*1";
			//$delete=sql_multirow_update("com_pi_item_details",$field_array_status,$data_array_status,"id",$txt_deleted_id,0);
			//echo "11**update com_pi_item_details set updated_by=$user_id, update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id in($txt_deleted_id) and order_source<>5 **1";oci_rollback($con);die;
			//$delete=execute_query("update com_pi_item_details set updated_by=$user_id, update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id in($txt_deleted_id) and (order_source<>5 or order_source is null)");
			$delete=execute_query("update com_pi_item_details set updated_by=$user_id, update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id in($txt_deleted_id)");
			if($flag==1)
			{
				if($delete) $flag=1; else $flag=0;
			}
			
			//if($ordeSource==5 && $cbo_item_category_id==1)
//			{
//				$rID5=execute_query(bulk_update_sql_statement("com_pi_item_details", "id",$field_array_update_dtls,$data_array_update_dtls,$id_dtls_arr ));
//			}
			
			if($flag==1)
			{
				if($rID5) $flag=1; else $flag=0;
			}
		}
		//echo $flag."__";die;
		$button_status=1;
		if(str_replace("'", '',$cbo_item_category_id)!=31)
		{
	  		if(count($data_array_trans_update)>0)
	  		{
	  			$rID3=execute_query(bulk_update_sql_statement("inv_transaction", "id",$field_array_trans_update,$data_array_trans_update,$trans_id_arr ));
	  			if($rID3) $flag=1; else $flag=20;
	  		}

	  		if(count($data_array_propor_update)>0)
	  		{
	  			$rID3=execute_query(bulk_update_sql_statement("order_wise_pro_details", "id",$field_array_propor_update,$data_array_propor_update,$propor_id_arr ));
	  			if($rID3) $flag=1; else $flag=20;
	  		}
		}
		else
		{
			$flag=1;
		}
		//echo "33**".$rID."__".$rID5."__".$flag;die;
		if($db_type==0)
		{
			if($flag==1)
			{
				mysql_query("COMMIT");
				echo "2**".str_replace("'", '', $update_id)."**$button_status";
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "7**".str_replace("'", '', $update_id)."**1";
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "2**".str_replace("'", '', $update_id)."**$button_status";
			}
			else
			{
				oci_rollback($con);
				echo "7**".str_replace("'", '', $update_id)."**1";
			}
		}

		disconnect($con);
		die;
	}
}

//---------------------------------------------- Start Pi Details -----------------------------------------------------------------------//

if($action=="composition_popup")
{
	echo load_html_head_contents("Composition Info","../../../", 1, 1, '','1','');
	extract($_REQUEST);	
	
	?>
	<script>
		function js_set_value(id,name)
		{
			document.getElementById('hidcompid').value=id;
			document.getElementById('hidcompname').value=name;
			parent.emailwindow.hide();
		}
    </script>
	</head>
	<body>
		<fieldset style="width:430px;margin-left:10px">
	        <form name="searchorderfrm_1"  id="searchorderfrm_1" autocomplete="off">
	            <table cellpadding="0" cellspacing="0" border="1" rules="all" width="430" class="rpt_table">
	                <thead>
	                    <th width="30">SL</th>
	                    <th>Composition
                        	<input type="hidden" name="hidcompid" id="hidcompid" value="" style="width:50px">
                            <input type="hidden" name="hidcompname" id="hidcompname" value="" style="width:50px">
                        </th>
	                </thead>
                    </table>
                    <table cellpadding="0" cellspacing="0" border="1" rules="all" width="430" class="rpt_table" id="comp_tbl">
                    <tbody>

                    <? 
                    $i=1; foreach($composition as $id=>$comp_name) { if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF"; ?>
                    	<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="search<? echo $i;?>" onClick="js_set_value(<? echo $id; ?>,'<? echo $comp_name; ?>')">
                            <td width="30"><? echo $i; ?></td>
                            <td><? echo $comp_name; ?> </td> 						
                        </tr>
                    <? $i++; } ?>
                    </tbody>
	            </table>
	            <div id="search_div" style="margin-top:5px"></div>   
	        </form>
	    </fieldset>
	</body>           
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    <script>setFilterGrid('comp_tbl',-1);</script>
	</html>
	<?
	exit();
}

if( $action == 'pi_details' )
{
	$data = explode( '_', $data );
	$pi_basis_id=$data[0];
	$item_category_id=$data[1];
	$type=$data[2];
	$pi_id=$data[3];
	$goods_rcv_status=$data[4];
	$company_id=$data[5];

	if($goods_rcv_status==2)
	{
		$goods_rcv_variable=1;
	}
	else
	{
		if($company_id>0)
		{
			$goods_rcv_variable=return_field_value("export_invoice_qty_source as source","variable_settings_commercial","company_name=$company_id and variable_list=23 and status_active=1","source");
			if($goods_rcv_variable!=1) $goods_rcv_variable=2;
		}
	}

	if($item_category_id!=0)
	{
		?>
    	<table class="rpt_table" width="100%" cellspacing="0" cellpadding="0" border="1" rules="all" id="tbl_pi_item">
		<?
        if($item_category_id==1)  // Yarn
        {
			?>
        	<thead>
				<?
                if($pi_basis_id == 1)
                {
                	?>
                    <th>&nbsp;</th>
                    <th class="must_entry_caption">WO</th>
                	<?
                }
                ?>
                <th>HS Code</th>
                <th class="must_entry_caption">Color</th>
                <th class="must_entry_caption">Count</th>
                <th colspan="2" class="must_entry_caption">Composition</th>
                <th class="must_entry_caption">Yarn Type</th>
                <th>UOM</th>
                <th class="must_entry_caption">Quantity</th>
                <th class="must_entry_caption">Rate</th>
                <th>Amount</th>
                <?
                if( $pi_basis_id == 2 )
                {   
                	?>
                    <th></th>
                    <?
                }
                ?>
            </thead>
            <tbody>
       	    <?
            /*if($pi_basis_id==2)
            {
				$disable="";
                $disable_status=0;
            }
            else
            {
				$disable="disabled='disabled'";
                $disable_status=1;

            }*/
			if($goods_rcv_status==1) $disable_qty_field="disabled='disabled'"; else $disable_qty_field="";

			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
            {
                if($db_type==0)
				{
					$nameArray=sql_select( "select group_concat(id) as id, work_order_no, work_order_id, group_concat(work_order_dtls_id) as work_order_dtls_id, color_id, count_name, yarn_composition_item1, yarn_composition_percentage1, yarn_composition_item2, yarn_composition_percentage2, yarn_type, uom, sum(quantity) as quantity, avg(rate) as rate, sum(amount) as amount, hs_code
					from com_pi_item_details
					where pi_id='$pi_id' and status_active=1 and is_deleted=0
					group by work_order_no, work_order_id, color_id, count_name, yarn_composition_item1, yarn_composition_percentage1, yarn_composition_item2, yarn_composition_percentage2, yarn_type, uom, hs_code" );
				}
				else
				{

					$nameArray=sql_select( "select rtrim(xmlagg(xmlelement(e,id,',').extract('//text()') order by id).GetClobVal(),',') AS id , work_order_no, work_order_id,rtrim(xmlagg(xmlelement(e,work_order_dtls_id,',').extract('//text()') order by work_order_dtls_id).GetClobVal(),',') AS work_order_dtls_id, color_id, count_name, yarn_composition_item1, yarn_composition_percentage1, yarn_composition_item2, yarn_composition_percentage2, yarn_type, uom, sum(quantity) as quantity, avg(rate) as rate, sum(amount) as amount, hs_code
					from com_pi_item_details
					where pi_id='$pi_id' and status_active=1 and is_deleted=0
					group by work_order_no, work_order_id, color_id, count_name, yarn_composition_item1, yarn_composition_percentage1, yarn_composition_item2, yarn_composition_percentage2, yarn_type, uom, hs_code" );

				}

            }
            else
            {
				$nameArray=sql_select( "select id, work_order_no, work_order_id, work_order_dtls_id, color_id, count_name, yarn_composition_item1, yarn_composition_percentage1, yarn_composition_item2, yarn_composition_percentage2, yarn_type, uom, quantity, rate, amount, hs_code, order_source from com_pi_item_details where pi_id='$pi_id' and status_active=1 and is_deleted=0 order by id" );
            }

            if($type==1 || count($nameArray)<1)
            {
				$tot_amnt=''; $upcharge='';$upcharge_breakdown=''; 
				$discount=''; $tot_amnt_net=''; $txt_tot_row=0;
            	?>
                <tr class="general" id="row_1">
                    <?
                    if( $pi_basis_id == 1 )
                    {
                        ?>
                        <td>
                            <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_1" value="" />
                        </td>
                        <td>
                            <input type="text" name="workOrderNo[]" id="workOrderNo_1" class="text_boxes" value="" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(1);" readonly />
                            <input type="hidden" name="hideWoId[]" id="hideWoId_1" readonly />
                            <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_1" readonly />
                            <input type="hidden" name="hideOrdeSource[]" id="hideOrdeSource_1" value="" readonly />
                        </td>
                        <?
                    }
					$grey_color_name="";
					$grey_color_id="";
					if( $pi_basis_id == 2)
					{
						$sql_grey_color=sql_select("select id,color_name from lib_color where status_active=1 and grey_color=1");
						$grey_color_name=$sql_grey_color[0][csf("color_name")];
						$grey_color_id=$sql_grey_color[0][csf("id")];
					}
					
                    ?>
                    <td>
                        <input type="text" name="hsCode[]" id="hsCode_1" class="text_boxes" value="" style="width:40px;" />
                    </td>
                    <td>
                        <input type="text" name="colorName[]" id="colorName_1" class="text_boxes" onFocus="add_auto_complete( 1 )" style="width:<? if( $pi_basis_id== 1 ) echo "80px;"; else echo "100px;"; ?>" onBlur="fn_add_color_id(1)" value="<?=$grey_color_name;?>"  maxlength="50" <? echo $disable; ?>/>
                        <input type="hidden" name="colorId[]" id="colorId_1" class="text_boxes" value="<?=$grey_color_id;?>"/>
                    </td>
                    <td>
                    <?
                        echo create_drop_down( "countName_1", 85, "SELECT id,yarn_count FROM lib_yarn_count WHERE status_active = 1 AND is_deleted = 0 ORDER BY yarn_count ASC", "id,yarn_count", 1, "-Select-", 0, "", $disable_status, "", "", "", "", "", "", "countName[]");
                    ?>
                    </td>
                    <td colspan="2">
                        <?
                            if( $pi_basis_id == 1 ) $composition_item1_width = '170px'; else $composition_item1_width = '190px';
                           // echo create_drop_down( "yarnCompositionItem1_1",$composition_item1_width, $composition,'', 1, '-Select-',0,"control_composition(1,'comp_one')",$disable_status);
                        ?>
                        <input type="text" name="txtyarnCompositionItem1[]" id="txtyarnCompositionItem1_1" class="text_boxes" onClick="openmypage_comp(1);" placeholder="Browse" readonly style="width: <? echo $composition_item1_width; ?>; "     value="" />
                        <input type="hidden" name="yarnCompositionItem1[]" id="yarnCompositionItem1_1" class="text_boxes" value=""/>

                        <input type="text" name="yarnCompositionPercentage1[]" id="yarnCompositionPercentage1_1" class="text_boxes_numeric" value="100" onChange="control_composition(1,'percent_one')" style="width:25px;" disabled/>%
                        <input type="hidden" name="yarnCompositionItem2[]" id="yarnCompositionItem2_1" readonly />
                        <input type="hidden" name="yarnCompositionPercentage2[]" id="yarnCompositionPercentage2_1" readonly />
                    </td>
                    <td>
                        <?
                            if( $pi_basis_id == 1 ) $yarn_type_width = 70; else $yarn_type_width = 80;
                            echo create_drop_down( "yarnType_1", $yarn_type_width, $yarn_type, "", 1, "-Select-", 0, "", $disable_status, "", "", "", $ommitYarnType, "", "", "yarnType[]");
                        ?>
                    </td>
                    <td>
                        <?
                            if( $pi_basis_id == 1 ) $yarn_uom = 60; else $yarn_uom = 85;
                            echo create_drop_down( "uom_1", $yarn_uom, $unit_of_measurement, "", 0, "-Select-", "", "", 1, 12, "", "", "", "", "", "uom[]");
                        ?>

                    </td>
                    <td>
                        <input type="text" name="quantity[]" id="quantity_1" class="text_boxes_numeric" value="" style="width:61px;" onKeyUp="calculate_amount(1)" />
                    </td>
                    <td>
                        <input type="text" name="rate[]" id="rate_1" class="text_boxes_numeric" value="" style="width:45px;" onKeyUp="calculate_amount(1)" <? echo $disable; ?> />
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_1" class="text_boxes_numeric" value="" style="width:75px;" <? echo $disable; ?> readonly/>
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_1" readonly/>
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                    <td width="65">
                        <input type="button" name="increase[]" id="increase_1" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( 1 )" />
                        <input type="button" name="decrease[]" id="decrease_1" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(1);" />
                    </td>
                    <?
                    }
                    ?>
                </tr>
                <?
            }
			else
			{
				$data_array=sql_select("select item_category_id,goods_rcv_status,total_amount,upcharge,upcharge_breakdown,discount, discount_breakdown,net_total_amount from com_pi_master_details where id='$pi_id'");
				$tot_amnt=$data_array[0][csf('total_amount')];
				$upcharge=$data_array[0][csf('upcharge')];
				$upcharge_breakdown=$data_array[0][csf('upcharge_breakdown')];
				$discount=$data_array[0][csf('discount')];
				$discount_breakdown=$data_array[0][csf('discount_breakdown')];
				$tot_amnt_net=$data_array[0][csf('net_total_amount')];
				$item_category_id=$data_array[0][csf('item_category_id')];
				$goods_rcv_status=$data_array[0][csf('goods_rcv_status')];
				

				if( $pi_basis_id == 1 )
				{
					$wo_dtls_id='';
					foreach ($nameArray as $row)
					{
						if($db_type==2 && ($goods_rcv_status==1 && $goods_rcv_variable!=1)){
							$row[csf('id')] = $row[csf('id')]->load();
							$row[csf('work_order_dtls_id')] = $row[csf('work_order_dtls_id')]->load();
						} 
						$wo_dtls_id.=$row[csf('work_order_dtls_id')].',';
					}

					$wo_dtls_id=chop($wo_dtls_id,',');
					$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");

					if($goods_rcv_status==1 && $goods_rcv_variable!=1)
					{
						$wo_qty_arr=return_library_array("select id, order_qnty as qty from inv_transaction where id in($wo_dtls_id)", "id", "qty");

					}

					else
					{
						$wo_qty_arr=return_library_array("select id, supplier_order_quantity as qty from wo_non_order_info_dtls where id in($wo_dtls_id)", "id", "qty");
					}
				}
				else
				{
					$mrr_check=return_field_value("id", "inv_receive_master", "booking_id=$pi_id and entry_form=1 and receive_basis=1 and status_active=1","id");
					if($mrr_check!=""){ $disable_mrr_check="disabled='disabled'"; $disable_status=1;} else $disable_mrr_check="";
				}

				$count_arr=return_library_array("select id, yarn_count from lib_yarn_count WHERE status_active = 1 AND is_deleted = 0 ORDER BY yarn_count",'id','yarn_count');
				$disable_data=$checkBox_check=$disable_status="";
				$disable_flag=0;
				if($goods_rcv_variable==1 && $goods_rcv_status==1)
				{
					$disable_data="disabled='disabled'";
					$checkBox_check="checked";
					$is_disable="disabled='disabled'";
					$disable_flag=1;
				}
				else if($goods_rcv_variable!=1 && $goods_rcv_status==1)
				{
					$is_disable="disabled='disabled'";
					$disable_flag=1;
					$disable_data="";
					$checkBox_check="";
				}
				else if($goods_rcv_status==2)
				{
					$sql_attach_mrr=sql_select("select b.pi_wo_batch_no, c.color, c.yarn_count_id, c.yarn_comp_type1st, c.yarn_type, b.cons_quantity as qnty
					from inv_receive_master a, inv_transaction b, product_details_master c
					where a.id=b.mst_id and b.prod_id=c.id and b.pi_wo_batch_no=$pi_id and a.entry_form=1 and b.receive_basis=1 and b.transaction_type=1 and b.item_category=1 and c.item_category_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0");
					foreach($sql_attach_mrr as $row)
					{
						$mrr_data[$row[csf('pi_wo_batch_no')]][$row[csf('color')]][$row[csf('yarn_count_id')]][$row[csf('yarn_comp_type1st')]][$row[csf('yarn_type')]]+=$row[csf('qnty')];
					}
					$sql_attach_mrr_rtn=sql_select("select a.pi_id as pi_wo_batch_no, c.color, c.yarn_count_id, c.yarn_comp_type1st, c.yarn_type, b.cons_quantity as qnty
					from inv_issue_master a, inv_transaction b, product_details_master c
					where a.id=b.mst_id and b.prod_id=c.id and a.pi_id=$pi_id and a.pi_id>0 and a.entry_form=8 and b.transaction_type=3 and b.item_category=1 and c.item_category_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0");

					$mrr_rtn_data=array();
					foreach($sql_attach_mrr_rtn as $row)
					{
						$mrr_rtn_data[$row[csf('pi_wo_batch_no')]][$row[csf('color')]][$row[csf('yarn_count_id')]][$row[csf('yarn_comp_type1st')]][$row[csf('yarn_type')]]+=$row[csf('qnty')];
					}
				}
				$i=1;
				foreach ($nameArray as $row)
				{
					if($goods_rcv_status==2)
					{
						$cu_mrr_qnty=$mrr_data[$pi_id][$row[csf('color_id')]][$row[csf('count_name')]][$row[csf('yarn_composition_item1')]][$row[csf('yarn_type')]]-$mrr_rtn_data[$pi_id][$row[csf('color_id')]][$row[csf('count_name')]][$row[csf('yarn_composition_item1')]][$row[csf('yarn_type')]];

						if($row[csf('order_source')]==5)
						{
							$is_disable="disabled='disabled'";
							$disable_flag=1;
							$disable_data="disabled='disabled'";
							$checkBox_check="checked";
						}
						else
						{
							if($cu_mrr_qnty>0)
							{
								$is_disable="";
								$disable_flag=1;
								$disable_data="disabled='disabled'";
								$checkBox_check="";
							}
							elseif($row[csf('work_order_id')]>0)
							{
								$is_disable="";
								$disable_flag=1;
								$disable_data="disabled='disabled'";
								$checkBox_check="";
							}
							else
							{
								$is_disable="";
								$disable_flag=0;
								$disable_data="";
								$checkBox_check="";
							}
						}

					}
					
					if($db_type==2 && ($goods_rcv_status==1 && $goods_rcv_variable!=1)){
						$row[csf('id')] = $row[csf('id')]->load();
						$row[csf('work_order_dtls_id')] = $row[csf('work_order_dtls_id')]->load();
					}

					$bl_qty='';
					?>
                    <tr class="general" id="row_<? echo $i; ?>">
                        <?
                        if( $pi_basis_id == 1 )
                        {
                        	?>
                            <td>
                                <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $i; ?>" value="" <? echo $is_disable." ".$checkBox_check; ?> />
                            </td>
                            <td>
                                <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $i; ?>);" title="<? echo $row[csf('work_order_no')]; ?>" readonly />
                                <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $i; ?>" readonly value="<? echo $row[csf('work_order_id')]; ?>" />
                                <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $i;?>" readonly value="<? echo $row[csf('work_order_dtls_id')];?>"/>
                                <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $i; ?>" value="" readonly />
                                <input type="hidden" name="hideOrdeSource[]" id="hideOrdeSource_<? echo $i; ?>" value="<? echo $row[csf('order_source')]; ?>" readonly />
                            </td>
                        	<?
							$bl_qty=$wo_qty_arr[$row[csf('work_order_dtls_id')]]-$prev_pi_qty_arr[$row[csf('work_order_dtls_id')]]+$row[csf('quantity')];
                        }
                        ?>
                        <td>
                            <input type="text" name="hsCode[]" id="hsCode_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('hs_code')]; ?>" style="width:40px;" <? if($row[csf('work_order_id')]>0) echo "disabled='disabled'"; ?> />
                        </td>
                        <td>
                            <input type="text" name="colorName[]" id="colorName_<? echo $i; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $i; ?> )" style="width:<? if( $pi_basis_id == 1 ) echo "80px;"; else echo "100px;"; ?>" onBlur="fn_add_color_id(<? echo $i; ?>)"  maxlength="50" value="<? echo $color_library[$row[csf('color_id')]]; ?>" title="<? echo $color_library[$row[csf('color_id')]]; ?>"  <? if($row[csf('work_order_id')]>0) echo "disabled='disabled'"; echo $is_disable; echo $disable_data; ?> />
                            <input type="hidden" name="colorId[]" id="colorId_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('color_id')]; ?>"/>
                        </td>
                        <td title="<? echo $count_arr[$row[csf('count_name')]]; ?>">
							<?
                                echo create_drop_down( "countName_".$i, 85, $count_arr, "", 1, "-Select-", $row[csf('count_name')], "", $disable_flag, "", "", "", "", "", "", "countName[]");
                            ?>
                        </td>
                        <td colspan="2" title="<? echo $composition[$row[csf('yarn_composition_item1')]]; ?>">
                        <?
                            if( $pi_basis_id == 1 ) $composition_item1_width = '170px'; else $composition_item1_width = '190px';
                           // echo create_drop_down( "yarnCompositionItem1_1",$composition_item1_width, $composition,'', 1, '-Select-',0,"control_composition(1,'comp_one')",$disable_status);
                        	?>
	                        <input type="text" name="txtyarnCompositionItem1[]" id="txtyarnCompositionItem1_<? echo $i; ?>" class="text_boxes" onClick="openmypage_comp(<? echo $i; ?>);" placeholder="Browse" readonly style="width: <? echo $composition_item1_width; ?>; " value="<? echo $composition[$row[csf('yarn_composition_item1')]]; ?>" <? echo $disable_data; ?> />
	                        <input type="hidden" name="yarnCompositionItem1[]" id="yarnCompositionItem1_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('yarn_composition_item1')]; ?>" <? echo $disable_data; ?> />

	                        <input type="text" name="yarnCompositionPercentage1[]" id="yarnCompositionPercentage1_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('yarn_composition_percentage1')]; ?>" onChange="control_composition(<? echo $i; ?>,'percent_one')" style="width:25px;" disabled/>%
	                        <input type="hidden" name="yarnCompositionItem2[]" id="yarnCompositionItem2_<? echo $i; ?>" readonly value="<? echo $row[csf('yarn_composition_item2')]; ?>" />
	                        <input type="hidden" name="yarnCompositionPercentage2[]" id="yarnCompositionPercentage2_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('yarn_composition_percentage2')]; ?>" onChange="control_composition(<? echo $i; ?>,'percent_two')" style="width:25px;" disabled/>
                    	</td>
                        <td title="<? echo $yarn_type[$row[csf('yarn_type')]]; ?>">
                            <?
                                if( $pi_basis_id == 1 ) $yarn_type_width = 70; else $yarn_type_width = 80;
                                echo create_drop_down( "yarnType_".$i, $yarn_type_width, $yarn_type, "", 1, "-Select-", $row[csf('yarn_type')], "", $disable_flag, "", "", "", "", "", "", "yarnType[]");
                            ?>
                        </td>
                        <td>
                            <?
                                if( $pi_basis_id == 1 ) $yarn_uom = 60; else $yarn_uom = 85;
                                echo create_drop_down( "uom_".$i, $yarn_uom, $unit_of_measurement, "", 0, "", $row[csf('uom')], "", 1, "", "", "", "", "", "", "uom[]");
                            ?>
                        </td>
                        <td>
                            <input type="text" name="quantity[]" id="quantity_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $i; ?>)" placeholder="<? echo $bl_qty; ?>" <? echo $disable_qty_field." ".$is_disable; ?> />
                        </td>
                        <td>
                            <input type="text" name="rate[]" id="rate_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:45px;" onKeyUp="calculate_amount(<? echo $i; ?>)" <? echo $disable_qty_field." ".$disable_data." ".$is_disable; ?> />
                        </td>
                        <td>
                            <input type="text" name="amount[]" id="amount_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:75px;" <? echo $disable_qty_field; ?> readonly/>
                            <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $i; ?>" readonly value="<? echo $row[csf('id')]; ?>"/>
                        </td>
                        <?
                        if( $pi_basis_id == 2 )
                        {
                        ?>
                        <td width="65">
                            <input type="button" name="increase[]" id="increase_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( <? echo $i; ?> )" />
                            <input type="button" name="decrease[]" id="decrease_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(<? echo $i; ?>);" <? echo $is_disable." ".$disable_data; ?> />
                        </td>
                        <?
                        }
                        ?>
                    </tr>
            	<?
				$i++;
				}
				$txt_tot_row=$i-1;
			}
			?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td>
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amnt; ?>" style="width:75px;" readonly/>
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td align="center">
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo number_format($upcharge,4,'.','');//$upcharge; ?>" style="width:75px;" onDblClick="fn_upcharge(1)" onKeyUp="calculate_total_amount(2);fn_break_data_change(1);" placeholder="Browse or Write"/>
                    <input type="hidden" name="up_charge_break_down" id="up_charge_break_down" value="<? echo $upcharge_breakdown; ?>"/>
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td align="center">
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo number_format($discount,4,'.','');  //$discount; ?>" style="width:85px;" onDblClick="fn_upcharge(2)" onKeyUp="calculate_total_amount(2);fn_break_data_change(2);" placeholder="Browse or Write"/>
                    <input type="hidden" name="discount_break_down" id="discount_break_down" value="<? echo $discount_breakdown; ?>" />
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td align="center">
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $tot_amnt_net; ?>" style="width:75px;" readonly/>
                    </td>
                    <?
                    if($pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
            </tfoot>
            <?
        }
        // 2=Knit Finish Fabrics, 13=Grey Fabric(Knit), 14=Grey Fabric(woven)
		else if($item_category_id==2 || $item_category_id==13 )
		{
			if($pi_basis_id==2)
            {
               $disable="";
               $disable_status=0;
            }
            else
            {
				$disable="disabled='disabled'";
                $disable_status=1;
				if($goods_rcv_status==1) $disable_qty_field="disabled='disabled'"; else $disable_qty_field="";
            }

            $disable_GSM_cond="disabled='disabled'";
			if ($item_category_id==2 || $item_category_id==13 && $pi_basis_id == 2){
				$disable_GSM_cond="";
			}

			if($item_category_id==13)
            {
                $disable_status_uom=1;
				$selected=12;
            }
            else
            {
				if($pi_basis_id==1)
				{
					 $disable_status_uom=1;
				}
				else
				{
					 $disable_status_uom=0;
				}
				$selected=0;
            }
		    ?>
        	<thead>
				<?
                if($pi_basis_id == 1)
                {
                    ?>
                    <th>&nbsp;</th>
                    <th>WO</th>
                    <?
                }
                ?>
                <th>HS Code</th>
                <th class="must_entry_caption">Construction</th>
                <th>Composition</th>
                <th class="must_entry_caption">Color</th>
                <th><? if($item_category_id==2 || $item_category_id==13) echo "GSM"; else echo "Weight"; ?></th>
                <th class="must_entry_caption">Dia/Width</th>
                <th style="color:blue">UOM</th>
                <th class="must_entry_caption">Quantity</th>
                <th class="must_entry_caption">Rate</th>
                <th>Amount</th>
                <?
                if( $pi_basis_id == 2 )
                {
                    ?>
                    <th></th>
                    <?
                }
                ?>
            </thead>
            <tbody>
       		<?

			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
            {
				if($db_type==0)
				{
					$nameArray=sql_select( "select group_concat(id) as id, work_order_no, work_order_id, group_concat(work_order_dtls_id) as work_order_dtls_id, determination_id, color_id, fabric_construction, fabric_composition, gsm, dia_width, uom, booking_without_order, sum(quantity) as quantity, avg(rate) as rate, sum(amount) as amount, hs_code
					from com_pi_item_details
					where pi_id='$pi_id' and quantity>0 and status_active=1 and is_deleted=0
					group by work_order_no, work_order_id, determination_id, color_id, fabric_construction, fabric_composition, gsm, dia_width, uom, booking_without_order, hs_code" );
				}
				else
				{
					$nameArray=sql_select( "select rtrim(xmlagg(xmlelement(e,id,',').extract('//text()') order by id).GetClobVal(),',') AS id , rtrim(xmlagg(xmlelement(e,work_order_dtls_id,',').extract('//text()') order by work_order_dtls_id).GetClobVal(),',') AS work_order_dtls_id , determination_id, color_id, fabric_construction, fabric_composition, gsm, dia_width, uom, booking_without_order, sum(quantity) as quantity, avg(rate) as rate, sum(amount) as amount, hs_code
					from com_pi_item_details
					where pi_id='$pi_id' and quantity>0 and status_active=1 and is_deleted=0
					group by work_order_no, work_order_id, determination_id, color_id, fabric_construction, fabric_composition, gsm, dia_width, uom, booking_without_order, hs_code" );
					//listagg(cast(id as varchar(4000)), ',') within group(order by id) as id, work_order_no, work_order_id, listagg(cast(work_order_dtls_id as varchar(4000)), ',') within group(order by work_order_dtls_id) as work_order_dtls_id
				}

            }
            else
            {
				$nameArray=sql_select( "select id, work_order_no, work_order_id, work_order_dtls_id, determination_id, color_id, fabric_construction, fabric_composition, gsm, dia_width, uom, booking_without_order, quantity, rate, amount, hs_code from com_pi_item_details where pi_id='$pi_id' and quantity>0 and status_active=1 and is_deleted=0" );
            }


			if($type==1 || count($nameArray)<1)
            {
				$tot_amnt=''; $upcharge=''; $upcharge_breakdown=''; $discount=''; $tot_amnt_net=''; $txt_tot_row=0;
            	?>
                <tr class="general" id="row_1">
                    <?
                    if( $pi_basis_id == 1 )
                    {
                        ?>
                        <td>
                            <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_1" value="" />
                        </td>
                        <td>
                            <input type="text" name="workOrderNo[]" id="workOrderNo_1" class="text_boxes" value="" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(1);" readonly />
                            <input type="hidden" name="hideWoId[]" id="hideWoId_1" readonly />
                            <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_1" readonly />
                        </td>
                       <?
                    }
                    ?>
                    <td>
                        <input type="text" name="hsCode[]" id="hsCode_1" class="text_boxes" value="" style="width:40px;" />
                    </td>
                    <td>
                        <input type="text" name="construction[]" id="construction_1" class="text_boxes" style="width:110px" onDblClick="openmypage_fabricDescription(1)" placeholder="Double Click To Search" readonly <? echo $disable; ?>/> <!--onFocus="add_auto_complete( 1 );"-->
                        <input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_1" readonly />
                    </td>
                    <td>
                        <input type="text" name="composition[]" id="composition_1" class="text_boxes" value="" style="width:120px" disabled="disabled"/> <!--onFocus="add_auto_complete(1);"-->
                    </td>
                    <td>
                        <input type="text" name="colorName[]" id="colorName_1" class="text_boxes" onFocus="add_auto_complete( 1 )" value="" style="width:80px" maxlength="50" <? echo $disable; ?>/>
                    </td>
                    <td>
                        <input type="text" name="gsm[]" id="gsm_1" class="text_boxes_numeric" value="" style="width:60px" <? echo $disable_GSM_cond; ?>/>
                    </td>
                    <td>
                        <input type="text" name="diawidth[]" id="diawidth_1" class="text_boxes" onFocus="add_auto_complete( 1 )" value="" style="width:70px" <? echo $disable; ?>/>
                    </td>
                    <?
                    if( $pi_basis_id == 1 )
                    {
						?>
                        <td>
                        <input type="text" name="uom[]" id="uom_1" class="text_boxes" value="" style="width:50px;" placeholder="" readonly <? echo $disable; ?>/>
                        </td>
                        <?
					}
					else
					{
						if( $search[0] == 1 ) $yarn_uom = 60; else $yarn_uom = 85;
						?>
                        <td>
							<?
								//$disable_status_uom
                                echo create_drop_down( "uom_1", $yarn_uom, $unit_of_measurement, '', 1, 'Select', $selected, '', '', '', '', '', '', '', '', 'uom[]');
                            ?>
                        </td>
                        <?
					}
                    ?>

                    <td>
                        <input type="text" name="quantity[]" id="quantity_1" class="text_boxes_numeric" value="" style="width:61px;" onKeyUp="calculate_amount(1)" <? echo $disable_qty_field;?> />
                    </td>
                    <td>
                        <input type="text" name="rate[]" id="rate_1" class="text_boxes_numeric" value="" style="width:45px;" onKeyUp="calculate_amount(1)" <? echo $disable; ?> />
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_1" class="text_boxes_numeric" value="" style="width:75px;" <? echo $disable; ?> readonly/>
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_1" readonly/>
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                        ?>
	                    <td width="65">
	                        <input type="button" name="increase[]" id="increase_1" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( 1 )" />
	                        <input type="button" name="decrease[]" id="decrease_1" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(1);" />
	                    </td>
	                    <?
                    }
                    ?>
                </tr>
            	<?
            }
			else
			{
				$data_array=sql_select("select item_category_id,goods_rcv_status,total_amount, upcharge, upcharge_breakdown, discount, discount_breakdown, net_total_amount from com_pi_master_details where id='$pi_id'");
				$tot_amnt=$data_array[0][csf('total_amount')];
				$upcharge=$data_array[0][csf('upcharge')];
				$upcharge_breakdown=$data_array[0][csf('upcharge_breakdown')];
				$discount=$data_array[0][csf('discount')];
				$discount_breakdown=$data_array[0][csf('discount_breakdown')];
				$tot_amnt_net=$data_array[0][csf('net_total_amount')];
				$item_category_id=$data_array[0][csf('item_category_id')];
				$goods_rcv_status=$data_array[0][csf('goods_rcv_status')];
				if($db_type==2 && ($goods_rcv_status==1 && $goods_rcv_variable!=1)){
					$row[csf('id')] = $row[csf('id')]->load();
					$row[csf('work_order_dtls_id')] = $row[csf('work_order_dtls_id')]->load();
				} 

				if( $pi_basis_id == 1 )
				{
					if($goods_rcv_status==1 && $goods_rcv_variable!=1)
					{
						$wo_dtls_id='';
						foreach ($nameArray as $row)
						{
							$wo_dtls_id.=$row[csf('work_order_dtls_id')].',';
						}

						$wo_dtls_id=chop($wo_dtls_id,',');
						$wo_qty_arr=return_library_array("select id, order_qnty as qty from inv_transaction where id in($wo_dtls_id)", "id", "qty");

						$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");
					}
					else
					{
						$wo_dtls_id=''; $wo_ids='';
						foreach ($nameArray as $row)
						{
							if($row[csf('booking_without_order')]==1)
							{
								$wo_dtls_id.=$row[csf('work_order_dtls_id')].',';
							}
							else
							{
								$wo_ids.=$row[csf('work_order_id')].',';
							}
						}
						$wo_dtls_id=chop($wo_dtls_id,',');
						$wo_ids=chop($wo_ids,',');

						if($wo_ids!="")
						{
							//$wo_qty_arr=return_library_array("select id, fin_fab_qnty as qty from wo_booking_dtls where id in($wo_ids)", "id", "qty");
							$wo_qty_arr=array();
							$sql_prev="select a.booking_no, c.lib_yarn_count_deter_id, b.fabric_color_id, c.construction, c.composition, b.gsm_weight, b.dia_width, c.uom, sum(b.fin_fab_qnty) as fin_fab_qnty from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.id in($wo_ids) group by a.booking_no, b.fabric_color_id, c.construction, c.composition, b.gsm_weight, b.dia_width, c.lib_yarn_count_deter_id, c.uom";
							$prevData=sql_select($sql_prev);
							foreach($prevData as $rowP)
							{
								$wo_qty_arr[$rowP[csf('booking_no')]][$rowP[csf('lib_yarn_count_deter_id')]][$rowP[csf('fabric_color_id')]][$rowP[csf('construction')]][$rowP[csf('composition')]][$rowP[csf('gsm_weight')]][$rowP[csf('dia_width')]][$rowP[csf('uom')]]=$rowP[csf('fin_fab_qnty')];
							}

							$prev_pi_qty_arr=array();
							$sql_prev="select b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 and b.work_order_id in($wo_ids) group by b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom";
							$prevData=sql_select($sql_prev);
							foreach($prevData as $rowP)
							{
								$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('gsm')]][$rowP[csf('dia_width')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
							}
						}

						if($wo_dtls_id!="")
						{
							$wo_qty_arr2=return_library_array("select id, finish_fabric as qty from wo_non_ord_samp_booking_dtls where id in($wo_dtls_id)", "id", "qty");

							$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");
						}
					}

				}
				$disable_data=$checkBox_check="";
				if($goods_rcv_variable==1 && $goods_rcv_status==1)
				{
					$disable_data="disabled='disabled'";
					$checkBox_check="checked";
				}

				$disable_GSM_cond="disabled='disabled'";
				if ($item_category_id==2 || $item_category_id==13 && $pi_basis_id == 2){
					$disable_GSM_cond="";
				}

				$i=1;
				foreach ($nameArray as $row)
				{
					$bl_qty='';
					?>
                    <tr class="general" id="row_<? echo $i; ?>">
                        <?
                        if( $pi_basis_id == 1 )
                        {
                        	?>
                            <td>
                                <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $i; ?>" value="" <? echo $checkBox_check; ?> />
                            </td>
                            <td>
                                <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $i; ?>);" readonly <? //echo $disable_qty_field;?> />
                                <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $i; ?>" readonly value="<? echo $row[csf('work_order_id')]; ?>" />
                                <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $i;?>" readonly value="<? echo $row[csf('work_order_dtls_id')];?>"/>
                                <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $i; ?>" value="" readonly />
                            </td>
                        	<?
							if($goods_rcv_status==2 && $row[csf('booking_without_order')]!=1 && $goods_rcv_variable==1)
							{
								$bl_qty=$wo_qty_arr[$row[csf('work_order_no')]][$row[csf('determination_id')]][$row[csf('color_id')]][$row[csf('fabric_construction')]][$row[csf('fabric_composition')]][$row[csf('gsm')]][$row[csf('dia_width')]][$row[csf('uom')]]-$prev_pi_qty_arr[$row[csf('work_order_no')]][$row[csf('determination_id')]][$row[csf('color_id')]][$row[csf('fabric_construction')]][$row[csf('fabric_composition')]][$row[csf('gsm')]][$row[csf('dia_width')]][$row[csf('uom')]]+$row[csf('quantity')];
							}
							else
							{
								$bl_qty=$wo_qty_arr[$row[csf('work_order_dtls_id')]]-$prev_pi_qty_arr[$row[csf('work_order_dtls_id')]]+$row[csf('quantity')];
							}
                        }
                        ?>
                        <td>
                            <input type="text" name="hsCode[]" id="hsCode_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('hs_code')]; ?>" style="width:40px;" />
                        </td>
                        <td>
                            <input type="text" name="construction[]" id="construction_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('fabric_construction')]; ?>" style="width:110px" onDblClick="openmypage_fabricDescription(<? echo $i; ?>)" placeholder="Double Click To Search" readonly <? echo $disable; ?>/>
                            <input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_<? echo $i; ?>" value="<? echo $row[csf('determination_id')]; ?>" readonly />
                        </td>
                        <td>
                            <input type="text" name="composition[]" id="composition_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('fabric_composition')]; ?>" style="width:120px" disabled="disabled"/>
                        </td>
                        <td>
 							<input type="text" name="colorName[]" id="colorName_<? echo $i; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $i; ?> )" style="width:80px" maxlength="50" <? echo $disable; ?> value="<? echo $color_library[$row[csf('color_id')]]; ?>"/>
                        </td>
                        <td>
                            <input type="text" name="gsm[]" id="gsm_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('gsm')]; ?>" style="width:60px" <? echo $disable_GSM_cond; ?>/>
                        </td>
                        <td>
                            <input type="text" name="diawidth[]" id="diawidth_<? echo $i; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $i; ?> )" value="<? echo $row[csf('dia_width')]; ?>" style="width:70px" <? echo $disable; ?>/>
                        </td>
                        <?
                        if( $pi_basis_id == 1 )
                        {
                            ?>
                            <td>
                            <input type="text" name="uom[]" id="uom_<? echo $i; ?>" class="text_boxes" value="<? echo $unit_of_measurement[$row[csf('uom')]]; ?>" style="width:50px;" placeholder="<? echo $row[csf('uom')]; ?>" readonly <? echo $disable; ?>/>
                            </td>
                            <?
                        }
                        else
                        {
							if( $pi_basis_id == 1 ) $yarn_uom = 60; else $yarn_uom = 85;
                            ?>
                            <td>
                                <?
									//$disable_status_uom
									echo create_drop_down( "uom_".$i, $yarn_uom, $unit_of_measurement, '', 1, 'Select', $row[csf('uom')], '', '', '', '', '', '', '', '', 'uom[]');
								?>
                            </td>
                            <?
                        }
						?>
                        <td>
                            <input type="text" name="quantity[]" id="quantity_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $i; ?>)" placeholder="<? echo $bl_qty; ?>" />
                        </td>
                        <td>
                            <input type="text" name="rate[]" id="rate_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:45px;" onKeyUp="calculate_amount(<? echo $i; ?>)" <? echo $disable; ?> />
                        </td>
                        <td>
                            <input type="text" name="amount[]" id="amount_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:75px;" <? echo $disable; ?> readonly/>
                            <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $i; ?>" readonly value="<? echo $row[csf('id')]; ?>"/>
                            <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $i; ?>" value="<? echo $row[csf('booking_without_order')]; ?>"/>
                        </td>
                        <?
                        if( $pi_basis_id == 2 )
                        {
                        ?>
                        <td width="65">
                            <input type="button" name="increase[]" id="increase_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( <? echo $i; ?> )" />
                            <input type="button" name="decrease[]" id="decrease_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(<? echo $i; ?>);" />
                        </td>
                        <?
                        }
                        ?>
                    </tr>
            		<?
					$i++;
				}
				$txt_tot_row=$i-1;
			}
			?>
            </tbody>
            <tfoot class="tbl_bottom">
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Total</td>
                <td>
                    <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amnt; ?>" style="width:75px;" readonly/>
                </td>
                <?
                if( $pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Upcharge</td>
                <td>
                    <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo number_format($upcharge,4,'.',''); //$upcharge; ?>" style="width:75px;" onDblClick="fn_upcharge(1)" onKeyUp="calculate_total_amount(2);fn_break_data_change(1);" placeholder="Browse or Write" />
                    <input type="hidden" name="up_charge_break_down" id="up_charge_break_down" value="<? echo $upcharge_breakdown; ?>"/>
                </td>
                <?
                if( $pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {

                ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Discount</td>
                <td>
                    <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo number_format($discount,4,'.','');  //$discount; ?>" style="width:85px;" onDblClick="fn_upcharge(2)" onKeyUp="calculate_total_amount(2);fn_break_data_change(2);" placeholder="Browse or Write"/>
                    <input type="hidden" name="discount_break_down" id="discount_break_down" value="<? echo $discount_breakdown; ?>" />
                </td>
                <?
                if( $pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Net Total</td>
                <td>
                    <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $tot_amnt_net; ?>" style="width:75px;" readonly/>
                </td>
                <?
                if($pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            </tfoot>
            <?
		}
		else if( $item_category_id==14)
		{
			if($pi_basis_id==2)
            {
               $disable="";
               $disable_status=0;
            }
            else
            {
				$disable="disabled='disabled'";
                $disable_status=1;
				if($goods_rcv_status==1) $disable_qty_field="disabled='disabled'"; else $disable_qty_field="";
            }

            $disable_GSM_cond="disabled='disabled'";
			if ($item_category_id==2 || $item_category_id==13 && $pi_basis_id == 2){
				$disable_GSM_cond="";
			}

			if($item_category_id==13)
            {
                $disable_status_uom=1;
				$selected=12;
            }
            else
            {
				if($pi_basis_id==1)
				{
					 $disable_status_uom=1;
				}
				else
				{
					 $disable_status_uom=0;
				}
				$selected=0;
            }
		    ?>
        	<thead>
				<?
                if($pi_basis_id == 1)
                {
                    ?>
                    <th>&nbsp;</th>
                    <th>WO</th>
                    <?
                }
                ?>
                <th>HS Code</th>
                <th class="must_entry_caption">Construction</th>
                <th>Composition</th>
                <th class="must_entry_caption">Color</th>
                <th><? if($item_category_id==2 || $item_category_id==13) echo "GSM"; else echo "Weight"; ?></th>
                <th class="must_entry_caption">Dia/Width</th>
                <th style="color:blue">UOM</th>
                <th class="must_entry_caption">Quantity</th>
                <th class="must_entry_caption">Rate</th>
                <th>Amount</th>
                <?
                if( $pi_basis_id == 2 )
                {
                    ?>
                    <th></th>
                    <?
                }
                ?>
            </thead>
            <tbody>
       		<?

			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
            {
				if($db_type==0)
				{
					$nameArray=sql_select( "select group_concat(id) as id, work_order_no, work_order_id, group_concat(work_order_dtls_id) as work_order_dtls_id, determination_id, color_id, fabric_construction, fabric_composition, gsm, dia_width, uom, booking_without_order, sum(quantity) as quantity, avg(rate) as rate, sum(amount) as amount, hs_code
					from com_pi_item_details
					where pi_id='$pi_id' and quantity>0 and status_active=1 and is_deleted=0
					group by work_order_no, work_order_id, determination_id, color_id, fabric_construction, fabric_composition, gsm, dia_width, uom, booking_without_order, hs_code" );
				}
				else
				{
					$nameArray=sql_select( "select rtrim(xmlagg(xmlelement(e,id,',').extract('//text()') order by id).GetClobVal(),',') AS id , rtrim(xmlagg(xmlelement(e,work_order_dtls_id,',').extract('//text()') order by work_order_dtls_id).GetClobVal(),',') AS work_order_dtls_id , determination_id, color_id, fabric_construction, fabric_composition, gsm, dia_width, uom, booking_without_order, sum(quantity) as quantity, avg(rate) as rate, sum(amount) as amount, hs_code
					from com_pi_item_details
					where pi_id='$pi_id' and quantity>0 and status_active=1 and is_deleted=0
					group by work_order_no, work_order_id, determination_id, color_id, fabric_construction, fabric_composition, gsm, dia_width, uom, booking_without_order, hs_code" );
					//listagg(cast(id as varchar(4000)), ',') within group(order by id) as id, work_order_no, work_order_id, listagg(cast(work_order_dtls_id as varchar(4000)), ',') within group(order by work_order_dtls_id) as work_order_dtls_id
				}

            }
            else
            {
				$nameArray=sql_select( "select id, work_order_no, work_order_id, work_order_dtls_id, determination_id, color_id, fabric_construction, fabric_composition, gsm, dia_width, uom, booking_without_order, quantity, rate, amount, hs_code from com_pi_item_details where pi_id='$pi_id' and quantity>0 and status_active=1 and is_deleted=0" );
            }


			if($type==1 || count($nameArray)<1)
            {
				$tot_amnt=''; $upcharge=''; $upcharge_breakdown=''; $discount=''; $tot_amnt_net=''; $txt_tot_row=0;
            	?>
                <tr class="general" id="row_1">
                    <?
                    if( $pi_basis_id == 1 )
                    {
                        ?>
                        <td>
                            <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_1" value="" />
                        </td>
                        <td>
                            <input type="text" name="workOrderNo[]" id="workOrderNo_1" class="text_boxes" value="" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(1);" readonly />
                            <input type="hidden" name="hideWoId[]" id="hideWoId_1" readonly />
                            <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_1" readonly />
                        </td>
                       <?
                    }
                    ?>
                    <td>
                        <input type="text" name="hsCode[]" id="hsCode_1" class="text_boxes" value="" style="width:40px;" />
                    </td>
                    <td>
                        <input type="text" name="construction[]" id="construction_1" class="text_boxes" style="width:110px" onDblClick="openmypage_fabricDescription(1)" placeholder="Double Click To Search" readonly <? echo $disable; ?>/> <!--onFocus="add_auto_complete( 1 );"-->
                        <input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_1" readonly />
                    </td>
                    <td>
                        <input type="text" name="composition[]" id="composition_1" class="text_boxes" value="" style="width:120px" disabled="disabled"/> <!--onFocus="add_auto_complete(1);"-->
                    </td>
                    <td>
                        <input type="text" name="colorName[]" id="colorName_1" class="text_boxes" onFocus="add_auto_complete( 1 )" value="" style="width:80px" maxlength="50" <? echo $disable; ?>/>
                    </td>
                    <td>
                        <input type="text" name="gsm[]" id="gsm_1" class="text_boxes_numeric" value="" style="width:60px" <? echo $disable_GSM_cond; ?>/>
                    </td>
                    <td>
                        <input type="text" name="diawidth[]" id="diawidth_1" class="text_boxes" onFocus="add_auto_complete( 1 )" value="" style="width:70px" <? echo $disable; ?>/>
                    </td>
                    <?
                    if( $pi_basis_id == 1 )
                    {
						?>
                        <td>
                        <input type="text" name="uom[]" id="uom_1" class="text_boxes" value="" style="width:50px;" placeholder="" readonly <? echo $disable; ?>/>
                        </td>
                        <?
					}
					else
					{
						if( $search[0] == 1 ) $yarn_uom = 60; else $yarn_uom = 85;
						?>
                        <td>
							<?
								//$disable_status_uom
                                echo create_drop_down( "uom_1", $yarn_uom, $unit_of_measurement, '', 1, 'Select', $selected, '', '', '', '', '', '', '', '', 'uom[]');
                            ?>
                        </td>
                        <?
					}
                    ?>

                    <td>
                        <input type="text" name="quantity[]" id="quantity_1" class="text_boxes_numeric" value="" style="width:61px;" onKeyUp="calculate_amount(1)" <? echo $disable_qty_field;?> />
                    </td>
                    <td>
                        <input type="text" name="rate[]" id="rate_1" class="text_boxes_numeric" value="" style="width:45px;" onKeyUp="calculate_amount(1)" <? echo $disable; ?> />
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_1" class="text_boxes_numeric" value="" style="width:75px;" <? echo $disable; ?> readonly/>
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_1" readonly/>
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                        ?>
	                    <td width="65">
	                        <input type="button" name="increase[]" id="increase_1" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( 1 )" />
	                        <input type="button" name="decrease[]" id="decrease_1" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(1);" />
	                    </td>
	                    <?
                    }
                    ?>
                </tr>
            	<?
            }
			else
			{
				$data_array=sql_select("select item_category_id,goods_rcv_status,total_amount, upcharge, upcharge_breakdown, discount, discount_breakdown, net_total_amount from com_pi_master_details where id='$pi_id'");
				$tot_amnt=$data_array[0][csf('total_amount')];
				$upcharge=$data_array[0][csf('upcharge')];
				$upcharge_breakdown=$data_array[0][csf('upcharge_breakdown')];
				$discount=$data_array[0][csf('discount')];
				$discount_breakdown=$data_array[0][csf('discount_breakdown')];
				$tot_amnt_net=$data_array[0][csf('net_total_amount')];
				$item_category_id=$data_array[0][csf('item_category_id')];
				$goods_rcv_status=$data_array[0][csf('goods_rcv_status')];
				if($db_type==2 && ($goods_rcv_status==1 && $goods_rcv_variable!=1)){
					$row[csf('id')] = $row[csf('id')]->load();
					$row[csf('work_order_dtls_id')] = $row[csf('work_order_dtls_id')]->load();
				} 

				if( $pi_basis_id == 1 )
				{
					if($goods_rcv_status==1 && $goods_rcv_variable!=1)
					{
						$wo_dtls_id='';
						foreach ($nameArray as $row)
						{
							$wo_dtls_id.=$row[csf('work_order_dtls_id')].',';
						}


						$wo_dtls_id=chop($wo_dtls_id,',');
						$wo_qty_arr=return_library_array("select id, order_qnty as qty from inv_transaction where id in($wo_dtls_id)", "id", "qty");

						$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");
					}
					else
					{
						$wo_dtls_id=''; $wo_ids='';
						foreach ($nameArray as $row)
						{
							if($row[csf('booking_without_order')]==1)
							{
								$wo_dtls_id.=$row[csf('work_order_dtls_id')].',';
							}
							else
							{
								$wo_ids.=$row[csf('work_order_id')].',';
							}
						}
						$wo_dtls_id=chop($wo_dtls_id,',');
						$wo_ids=chop($wo_ids,',');

						if($wo_ids!="")
						{
							//$wo_qty_arr=return_library_array("select id, fin_fab_qnty as qty from wo_booking_dtls where id in($wo_ids)", "id", "qty");
							$wo_qty_arr=array();
							$sql_prev="select a.booking_no, c.lib_yarn_count_deter_id, b.fabric_color_id, c.construction, c.composition, b.gsm_weight, b.dia_width, c.uom, sum(b.fin_fab_qnty) as fin_fab_qnty from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.id in($wo_ids) group by a.booking_no, b.fabric_color_id, c.construction, c.composition, b.gsm_weight, b.dia_width, c.lib_yarn_count_deter_id, c.uom";
							$prevData=sql_select($sql_prev);
							foreach($prevData as $rowP)
							{
								$wo_qty_arr[$rowP[csf('booking_no')]][$rowP[csf('lib_yarn_count_deter_id')]][$rowP[csf('fabric_color_id')]][$rowP[csf('construction')]][$rowP[csf('composition')]][$rowP[csf('gsm_weight')]][$rowP[csf('dia_width')]][$rowP[csf('uom')]]=$rowP[csf('fin_fab_qnty')];
							}

							$prev_pi_qty_arr=array();
							$sql_prev="select b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 and b.work_order_id in($wo_ids) group by b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom";
							$prevData=sql_select($sql_prev);
							foreach($prevData as $rowP)
							{
								$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('gsm')]][$rowP[csf('dia_width')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
							}
						}

						if($wo_dtls_id!="")
						{
							$wo_qty_arr2=return_library_array("select id, finish_fabric as qty from wo_non_ord_samp_booking_dtls where id in($wo_dtls_id)", "id", "qty");

							$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");
						}
					}

				}
				$disable_data=$checkBox_check="";
				if($goods_rcv_variable==1 && $goods_rcv_status==1)
				{
					$disable_data="disabled='disabled'";
					$checkBox_check="checked";
				}

				$disable_GSM_cond="disabled='disabled'";
				if ($item_category_id==2 || $item_category_id==13 && $pi_basis_id == 2){
					$disable_GSM_cond="";
				}

				$i=1;
				foreach ($nameArray as $row)
				{
					$bl_qty='';
					?>
                    <tr class="general" id="row_<? echo $i; ?>">
                        <?
                        if( $pi_basis_id == 1 )
                        {
                        	?>
                            <td>
                                <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $i; ?>" value="" <? echo $checkBox_check; ?> />
                            </td>
                            <td>
                                <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $i; ?>);" readonly <? //echo $disable_qty_field;?> />
                                <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $i; ?>" readonly value="<? echo $row[csf('work_order_id')]; ?>" />
                                <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $i;?>" readonly value="<? echo $row[csf('work_order_dtls_id')];?>"/>
                                <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $i; ?>" value="" readonly />
                            </td>
                        	<?
							if($goods_rcv_status==2 && $row[csf('booking_without_order')]!=1 && $goods_rcv_variable==1)
							{
								$bl_qty=$wo_qty_arr[$row[csf('work_order_no')]][$row[csf('determination_id')]][$row[csf('color_id')]][$row[csf('fabric_construction')]][$row[csf('fabric_composition')]][$row[csf('gsm')]][$row[csf('dia_width')]][$row[csf('uom')]]-$prev_pi_qty_arr[$row[csf('work_order_no')]][$row[csf('determination_id')]][$row[csf('color_id')]][$row[csf('fabric_construction')]][$row[csf('fabric_composition')]][$row[csf('gsm')]][$row[csf('dia_width')]][$row[csf('uom')]]+$row[csf('quantity')];
							}
							else
							{
								$bl_qty=$wo_qty_arr[$row[csf('work_order_dtls_id')]]-$prev_pi_qty_arr[$row[csf('work_order_dtls_id')]]+$row[csf('quantity')];
							}
                        }
                        ?>
                        <td>
                            <input type="text" name="hsCode[]" id="hsCode_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('hs_code')]; ?>" style="width:40px;" />
                        </td>
                        <td>
                            <input type="text" name="construction[]" id="construction_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('fabric_construction')]; ?>" style="width:110px" onDblClick="openmypage_fabricDescription(<? echo $i; ?>)" placeholder="Double Click To Search" readonly <? echo $disable; ?>/>
                            <input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_<? echo $i; ?>" value="<? echo $row[csf('determination_id')]; ?>" readonly />
                        </td>
                        <td>
                            <input type="text" name="composition[]" id="composition_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('fabric_composition')]; ?>" style="width:120px" disabled="disabled"/>
                        </td>
                        <td>
 							<input type="text" name="colorName[]" id="colorName_<? echo $i; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $i; ?> )" style="width:80px" maxlength="50" <? echo $disable; ?> value="<? echo $color_library[$row[csf('color_id')]]; ?>"/>
                        </td>
                        <td>
                            <input type="text" name="gsm[]" id="gsm_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('gsm')]; ?>" style="width:60px" <? echo $disable_GSM_cond; ?>/>
                        </td>
                        <td>
                            <input type="text" name="diawidth[]" id="diawidth_<? echo $i; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $i; ?> )" value="<? echo $row[csf('dia_width')]; ?>" style="width:70px" <? echo $disable; ?>/>
                        </td>
                        <?
                        if( $pi_basis_id == 1 )
                        {
                            ?>
                            <td>
                            <input type="text" name="uom[]" id="uom_<? echo $i; ?>" class="text_boxes" value="<? echo $unit_of_measurement[$row[csf('uom')]]; ?>" style="width:50px;" placeholder="<? echo $row[csf('uom')]; ?>" readonly <? echo $disable; ?>/>
                            </td>
                            <?
                        }
                        else
                        {
							if( $pi_basis_id == 1 ) $yarn_uom = 60; else $yarn_uom = 85;
                            ?>
                            <td>
                                <?
									//$disable_status_uom
									echo create_drop_down( "uom_".$i, $yarn_uom, $unit_of_measurement, '', 1, 'Select', $row[csf('uom')], '', '', '', '', '', '', '', '', 'uom[]');
								?>
                            </td>
                            <?
                        }
						?>
                        <td>
                            <input type="text" name="quantity[]" id="quantity_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $i; ?>)" placeholder="<? echo $bl_qty; ?>" />
                        </td>
                        <td>
                            <input type="text" name="rate[]" id="rate_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:45px;" onKeyUp="calculate_amount(<? echo $i; ?>)" <? echo $disable; ?> />
                        </td>
                        <td>
                            <input type="text" name="amount[]" id="amount_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:75px;" <? echo $disable; ?> readonly/>
                            <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $i; ?>" readonly value="<? echo $row[csf('id')]; ?>"/>
                            <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $i; ?>" value="<? echo $row[csf('booking_without_order')]; ?>"/>
                        </td>
                        <?
                        if( $pi_basis_id == 2 )
                        {
                        ?>
                        <td width="65">
                            <input type="button" name="increase[]" id="increase_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( <? echo $i; ?> )" />
                            <input type="button" name="decrease[]" id="decrease_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(<? echo $i; ?>);" />
                        </td>
                        <?
                        }
                        ?>
                    </tr>
            		<?
					$i++;
				}
				$txt_tot_row=$i-1;
			}
			?>
            </tbody>
            <tfoot class="tbl_bottom">
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Total</td>
                <td>
                    <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amnt; ?>" style="width:75px;" readonly/>
                </td>
                <?
                if( $pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Upcharge</td>
                <td>
                    <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo number_format($upcharge,4,'.',''); //$upcharge; ?>" style="width:75px;" onDblClick="fn_upcharge(1)" onKeyUp="calculate_total_amount(2);fn_break_data_change(1);" placeholder="Browse or Write" />
                    <input type="hidden" name="up_charge_break_down" id="up_charge_break_down" value="<? echo $upcharge_breakdown; ?>"/>
                </td>
                <?
                if( $pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Discount</td>
                <td>
                    <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo number_format($discount,4,'.','');  //$discount; ?>" style="width:85px;" onDblClick="fn_upcharge(2)" onKeyUp="calculate_total_amount(2);fn_break_data_change(2);" placeholder="Browse or Write"/>
                    <input type="hidden" name="discount_break_down" id="discount_break_down" value="<? echo $discount_breakdown; ?>" />
                </td>
                <?
                if( $pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Net Total</td>
                <td>
                    <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $tot_amnt_net; ?>" style="width:75px;" readonly/>
                </td>
                <?
                if($pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            </tfoot>
            <?
		}
		else if($item_category_id==3)  // Woven Fabrics
		{
			?>
        	<thead>
				<?
                if($pi_basis_id == 1)
                {
                	?>
                    <th>&nbsp;</th>
                    <th>WO</th>
                	<?
                }
                ?>
                <th>Fab Ref</th>
                <th>RD No</th>
                <th>Fab. Description</th>
                <th>Color</th>
                <th>Weight</th>
                <th>Weight Type</th>
                <th>Dia/Width</th>
                <th>Width</th>
                <th>Cutable Width</th>
                <th>UOM</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Amount</th>
                <?
                if( $pi_basis_id == 2 )
                {
                	?>
                    <th>&nbsp;</th>
                	<?
                }
                ?>
            </thead>
            <tbody>
       		<?

			if($pi_basis_id==2)
            {
                $disable="";
                $disable_status=0;
            }
            else
            {
				$disable="disabled='disabled'";
                $disable_status=1;
				if($goods_rcv_status==1) $disable_qty_field="disabled='disabled'"; else $disable_qty_field="";
            }


			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
            {
            	if($db_type==0)
				{
					$nameArray=sql_select( "select group_concat(id) as id, work_order_no, work_order_id, group_concat(work_order_dtls_id) as work_order_dtls_id, determination_id, color_id, fabric_construction, fabric_composition, fab_weight, width_dia_type, dia_width, fab_weight_type, cutable_width, uom, fabric_ref, rd_no, fab_design, fab_type, body_part_id, booking_without_order, sum(quantity) as quantity, avg(rate) as rate, sum(amount) as amount
					from com_pi_item_details
					where pi_id='$pi_id' and quantity>0 and status_active=1 and is_deleted=0
					group by work_order_no, work_order_id, determination_id, color_id, fabric_construction, fabric_composition, fab_weight, width_dia_type, dia_width, fab_weight_type, cutable_width, uom, fabric_ref, rd_no, fab_design, fab_type, body_part_id, booking_without_order
					order by work_order_no, body_part_id");
				}
				else
				{
					$nameArray=sql_select( "select listagg(cast(id as varchar(4000)), ',') within group(order by id) as id, work_order_no, work_order_id, listagg(cast(work_order_dtls_id as varchar(4000)), ',') within group(order by work_order_dtls_id) as work_order_dtls_id, determination_id, color_id, fabric_construction, fabric_composition, fab_weight, width_dia_type, dia_width, fab_weight_type, cutable_width, uom, fabric_ref, rd_no, fab_design, fab_type, body_part_id, booking_without_order, sum(quantity) as quantity, avg(rate) as rate, sum(amount) as amount
					from com_pi_item_details
					where pi_id='$pi_id' and quantity>0 and status_active=1 and is_deleted=0
					group by work_order_no, work_order_id, determination_id, color_id, fabric_construction, fabric_composition, fab_weight, width_dia_type, dia_width, fab_weight_type, cutable_width, uom, fabric_ref, rd_no, fab_design, fab_type, body_part_id, booking_without_order
					order by work_order_no, body_part_id");
				}
            }
            else
            {			
				$nameArray=sql_select( "select id, work_order_no, work_order_id, work_order_dtls_id, determination_id, color_id, fabric_construction, fabric_composition, weight, dia_width, uom, quantity, rate, amount, body_part_id, fabric_ref, rd_no, fab_design, fab_weight, fab_weight_type, cutable_width, width_dia_type, fab_type, booking_without_order from com_pi_item_details where pi_id='$pi_id' and quantity>0 and status_active=1 and is_deleted=0" );
            }

			if($type==1 || count($nameArray)<1)
            {
				$tot_amnt=''; $upcharge=''; $discount=''; $tot_amnt_net=''; $txt_tot_row=0;
                ?>
                <tr class="general" id="row_1">
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    	?>
                        <td>
                            <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_1" value="" />
                        </td>
                        <td>
                            <input type="text" name="workOrderNo[]" id="workOrderNo_1" class="text_boxes" value="" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(1);" readonly />
                            <input type="hidden" name="hideWoId[]" id="hideWoId_1" readonly />
                            <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_1" readonly />
                        </td>
                    	<?
                    }
                    ?>
                    <td><input type="text" name="fabricRef[]" id="fabricRef_1" class="text_boxes" style="width:60px" disabled="disabled"/></td>
                    <td><input type="text" name="rdNo[]" id="rdNo_1" class="text_boxes" style="width:60px" disabled="disabled"/></td>
                    <td>
                    	<input type="text" name="fabDescription[]" id="fabDescription_1" class="text_boxes" onDblClick="openmypage_fabricDescription(1)" placeholder="Double Click To Search" value="" style="width:195px" readonly <? echo $disable; ?>/>
                    	<input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_1" readonly />                   
                        <input type="hidden" name="construction[]" id="construction_1" class="text_boxes" value=""  disabled="disabled"/>
                        <input type="hidden" name="composition[]" id="composition_1" class="text_boxes" value=""  disabled="disabled"/>
                        <input type="hidden" name="bodyPart[]" id="bodyPart_1" class="text_boxes" value=""  disabled="disabled"/> 
                        <input type="hidden" name="fabType[]" id="fabType_1" class="text_boxes" value=""  disabled="disabled"/>
                        <input type="hidden" name="fabDesign[]" id="fabDesign_1" class="text_boxes" value="" disabled="disabled"/>
                        
                    </td>
                    <td>
                        <input type="text" name="colorName[]" id="colorName_1" class="text_boxes" onFocus="add_auto_complete( 1 )" value="" style="width:50px" maxlength="50" <? echo $disable; ?>/>
                    </td>
                    <td>
                        <input type="text" name="fabWeight[]" id="fabWeight_1" class="text_boxes_numeric" value="" style="width:35px" <? echo $disable; ?>/>
                    </td>
                    <td>
						<?
						if($pi_basis_id == 1)
						{
							?>
							<input type="text" name="fabWeightType[]" id="fabWeightType_1" class="text_boxes" style="width:40px" readonly />
							<?
						}
						else
						{
							echo create_drop_down( "fabWeightType_1", 55, $fabric_weight_type, '', 1, 'Select', $selected, '', $disable_status, '', '', '', '', '', '', 'fabWeightType[]');
						}
						?>
                        <!-- <input type="text" name="weightType_1" id="weightType_1" class="text_boxes_numeric" value="" style="width:55px" disabled="disabled"/>
                        <input type="hidden" name="fabWeightType_1" id="fabWeightType_1" class="text_boxes" value=""  disabled="disabled"/> -->
                    </td>
                    <td>
						<?
						if($pi_basis_id == 1)
						{
							?>
							<input type="text" name="diawidthType[]" id="diawidthType_1" class="text_boxes" style="width:40px" readonly />
							<?
						}
						else
						{
							echo create_drop_down( "diawidthType_1", 55, $fabric_typee, '', 1, 'Select', $selected, '', $disable_status, '', '', '', '', '', '', 'diawidthType[]');
						}
						?>

                        <!-- <input type="text" name="diawidth_type_1" id="diawidth_type_1" class="text_boxes" onFocus="add_auto_complete( 1 )" value="" style="width:55px" disabled="disabled"/>
                        <input type="hidden" name="diawidthType_1" id="diawidthType_1" class="text_boxes" value=""  disabled="disabled"/> -->
                    </td>
                    <td>
                        <input type="text" name="diawidth[]" id="diawidth_1" class="text_boxes_numeric" value="" style="width:35px" <? echo $disable; ?>/>
                    </td>
                    <td>
                        <input type="text" name="cutableWidth[]" id="cutableWidth_1" class="text_boxes_numeric" value="" style="width:60px" <? echo $disable; ?>/>
                    </td>
                    <?
                    if( $pi_basis_id == 1 )
                    {
						?>
                        <td>
                        <input type="text" name="uom[]" id="uom_1" class="text_boxes" value="" style="width:50px;" placeholder="" readonly <? echo $disable; ?>/>
                        </td>
                        <?
					}
					else
					{
						if( $search[0] == 1 ) $yarn_uom = 40; else $yarn_uom = 40;
						?>
                        <td>
							<?
                                echo create_drop_down( "uom_1", $yarn_uom, $unit_of_measurement, '', 1, 'Select', $selected, '', $disable_status, '', '', '', '', '', '', 'uom[]');
                            ?>
                        </td>
                        <?
					}
                    ?>
                    <td>
                        <input type="text" name="quantity[]" id="quantity_1" class="text_boxes_numeric" value="" style="width:61px;" onKeyUp="calculate_amount(1)" />
                    </td>
                    <td>
                        <input type="text" name="rate[]" id="rate_1" class="text_boxes_numeric" value="" style="width:45px;" onKeyUp="calculate_amount(1)" <? echo $disable; ?> />
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_1" class="text_boxes_numeric" value="" style="width:75px;" <? echo $disable; ?> readonly/>
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_1" readonly/>
						<input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_1" readonly/>
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
	                    ?>
	                    <td width="65">
	                        <input type="button" name="increase[]" id="increase_1" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( 1 )" />
	                        <input type="button" name="decrease[]" id="decrease_1" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(1);" />
	                    </td>
	                    <?
                    }
                    ?>
                </tr>
                <?
            }
			else
			{
				$lib_body_part_arr=return_library_array("select id, body_part_full_name from lib_body_part", "id", "body_part_full_name");
				$data_array=sql_select("select item_category_id,goods_rcv_status,total_amount, upcharge, upcharge_breakdown, discount, discount_breakdown, net_total_amount from com_pi_master_details where id='$pi_id'");
				$tot_amnt=$data_array[0][csf('total_amount')];
				$upcharge=$data_array[0][csf('upcharge')];
				$upcharge_breakdown=$data_array[0][csf('upcharge_breakdown')];
				$discount=$data_array[0][csf('discount')];
				$discount_breakdown=$data_array[0][csf('discount_breakdown')];
				$tot_amnt_net=$data_array[0][csf('net_total_amount')];
				$item_category_id=$data_array[0][csf('item_category_id')];
				$goods_rcv_status=$data_array[0][csf('goods_rcv_status')];
				/*if($db_type==2 && ($goods_rcv_status==1 && $goods_rcv_variable!=1)){

					$row[csf('id')] = $row[csf('id')]->load();
					$row[csf('work_order_dtls_id')] = $row[csf('work_order_dtls_id')]->load();
				} */

				if( $pi_basis_id == 1 )
				{
					if($goods_rcv_status==1 && $goods_rcv_variable!=1)
					{
						$wo_dtls_id='';
						foreach ($nameArray as $row)
						{
							$wo_dtls_id.=$row[csf('work_order_dtls_id')].',';
						}

						$wo_dtls_id=chop($wo_dtls_id,',');
						$wo_qty_arr=return_library_array("select id, order_qnty as qty from inv_transaction where id in($wo_dtls_id)", "id", "qty");

						$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");
					}
					else
					{
						$wo_dtls_id=''; $wo_ids='';
						foreach ($nameArray as $row)
						{
							if($row[csf('booking_without_order')]==1)
							{
								$wo_dtls_id.=$row[csf('work_order_dtls_id')].',';
							}
							else
							{
								$wo_ids.=$row[csf('work_order_id')].',';
							}
						}
						$wo_dtls_id=chop($wo_dtls_id,',');
						$wo_ids=chop($wo_ids,',');

						if($wo_ids!="")
						{
							//$wo_qty_arr=return_library_array("select id, fin_fab_qnty as qty from wo_booking_dtls where id in($wo_ids)", "id", "qty");
							$wo_qty_arr=array();
							$sql_wo_qnty="SELECT a.id, a.booking_no, b.fabric_color_id, c.construction as construction, c.composition as copmposition, b.gsm_weight as weight, c.gsm_weight_type as fab_weight_type, c.width_dia_type as dia_or_width, b.dia_width as width, b.item_size as cutable_width, sum(b.fin_fab_qnty) as fin_fab_qnty, c.lib_yarn_count_deter_id, c.body_part_id, c.uom, 0 as dtls_id
                    		from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c 
                    		where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.id in($wo_ids) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 
                    		group by a.id, a.booking_no, b.fabric_color_id, c.construction, c.composition, b.gsm_weight, c.gsm_weight_type, c.width_dia_type, b.dia_width, b.item_size, c.lib_yarn_count_deter_id, c.body_part_id, c.uom";							
							$prevWoQtyData=sql_select($sql_wo_qnty);
							foreach($prevWoQtyData as $rowP)
							{
								$wo_qty_arr[$rowP[csf('booking_no')]][$rowP[csf('body_part_id')]][$rowP[csf('lib_yarn_count_deter_id')]][$rowP[csf('fabric_color_id')]][$rowP[csf('construction')]][$rowP[csf('copmposition')]][$rowP[csf('weight')]][$rowP[csf('fab_weight_type')]][$rowP[csf('dia_or_width')]][$rowP[csf('width')]][$rowP[csf('cutable_width')]][$rowP[csf('uom')]]=$rowP[csf('fin_fab_qnty')];
							}

							$prev_pi_qty_arr=array();
							$sql_prev="SELECT b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.fab_weight_type, b.width_dia_type, b.dia_width, b.cutable_width, b.uom, sum(b.quantity) as qty 
                    		from com_pi_master_details a, com_pi_item_details b 
                    		where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 and b.work_order_id in($wo_ids) 
                    		group by b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.fab_weight_type, b.width_dia_type, b.dia_width, b.cutable_width, b.uom";							
							$prevData=sql_select($sql_prev);
							foreach($prevData as $rowP)
							{
								$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('body_part_id')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('fab_weight')]][$rowP[csf('fab_weight_type')]][$rowP[csf('width_dia_type')]][$rowP[csf('dia_width')]][$rowP[csf('cutable_width')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
							}
						}

						if($wo_dtls_id!="")
						{
							$sql_wo_qnty=sql_select("SELECT a.id, a.booking_no, b.fabric_color as fabric_color_id, b.construction as construction, b.composition as copmposition, b.body_part as body_part_id, b.gsm_weight as weight, b.dia_width as dia_or_width, b.item_size as cutable_width, b.uom, sum(b.finish_fabric) as fin_fab_qnty, sum(b.finish_fabric*b.rate) as amount, b.lib_yarn_count_deter_id, 0 as dtls_id
							from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b 
							where a.booking_no=b.booking_no and b.id in($wo_dtls_id) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0
							group by a.id, a.booking_no, b.fabric_color, b.construction, b.composition, b.body_part, b.gsm_weight, b.dia_width, b.item_size, b.uom, b.lib_yarn_count_deter_id
							order by a.booking_no, b.body_part");
							foreach($sql_wo_qnty as $row)
							{
								$wo_qty_arr[$row[csf('booking_no')]][$row[csf('body_part_id')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('weight')]][$row[csf('dia_or_width')]][$row[csf('cutable_width')]][$row[csf('uom')]]=$row[csf('fin_fab_qnty')];
							}

							$sql_prev="SELECT b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.width_dia_type, b.cutable_width, b.uom, sum(b.quantity) as qty 
							from com_pi_master_details a, com_pi_item_details b 
							where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id)
							group by b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.width_dia_type, b.cutable_width, b.uom";// and b.work_order_dtls_id in($wo_dtls_id)
							$prevData=sql_select($sql_prev);
							foreach($prevData as $rowP)
							{
								$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('body_part_id')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('fab_weight')]][$rowP[csf('width_dia_type')]][$rowP[csf('cutable_width')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
							}
						}
					}

				}
				$disable_data=$checkBox_check="";
				if($goods_rcv_variable==1 && $goods_rcv_status==1)
				{
					$disable_data=" disabled='disabled' ";
					$checkBox_check="checked";
				}
				$i=1;
				//echo "<pre>";print_r($nameArray);die;
				foreach ($nameArray as $row)
				{
					$bl_qty='';
					$fab_description=$lib_body_part_arr[$row[csf('body_part_id')]]." ".$row[csf('fab_type')]." ".$row[csf('fabric_construction')]." ".$row[csf('fab_design')]." ".$row[csf('fabric_composition')];
				    ?>
                    <tr class="general" id="row_<? echo $i; ?>">
                        <?
                        if( $pi_basis_id == 1)
                        {
                        	?>
                            <td>
                                <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $i; ?>" value="" />
                            </td>
                            <td>
                                <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $i; ?>);" readonly <? if($goods_rcv_status==1 && $goods_rcv_variable!=1) echo " disabled='disabled' "; ?> />
                                <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $i; ?>" readonly value="<? echo $row[csf('work_order_id')]; ?>" />
                                <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $i;?>" readonly value="<? echo $row[csf('work_order_dtls_id')];?>"/>
                                <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $i; ?>" value="" readonly />
                            </td>
                            <?
							if($goods_rcv_status==2 && $row[csf('booking_without_order')]!=1 && $goods_rcv_variable==1)
							{
								$bl_qty=$wo_qty_arr[$row[csf('work_order_no')]][$row[csf('body_part_id')]][$row[csf('determination_id')]][$row[csf('color_id')]][$row[csf('fabric_construction')]][$row[csf('fabric_composition')]][$row[csf('fab_weight')]][$row[csf('fab_weight_type')]][$row[csf('width_dia_type')]][$row[csf('dia_width')]][$row[csf('cutable_width')]][$row[csf('uom')]]-$prev_pi_qty_arr[$row[csf('work_order_no')]][$row[csf('body_part_id')]][$row[csf('determination_id')]][$row[csf('color_id')]][$row[csf('fabric_construction')]][$row[csf('fabric_composition')]][$row[csf('fab_weight')]][$row[csf('fab_weight_type')]][$row[csf('width_dia_type')]][$row[csf('dia_width')]][$row[csf('cutable_width')]][$row[csf('uom')]]+$row[csf('quantity')];
							}
							else
							{
								$bl_qty=$wo_qty_arr[$row[csf('work_order_no')]][$row[csf('body_part_id')]][$row[csf('determination_id')]][$row[csf('color_id')]][$row[csf('fabric_construction')]][$row[csf('fabric_composition')]][$row[csf('fab_weight')]][$row[csf('dia_width')]][$row[csf('cutable_width')]][$row[csf('uom')]]-$prev_pi_qty_arr[$row[csf('work_order_no')]][$row[csf('body_part_id')]][$row[csf('determination_id')]][$row[csf('color_id')]][$row[csf('fabric_construction')]][$row[csf('fabric_composition')]][$row[csf('fab_weight')]][$row[csf('width_dia_type')]][$row[csf('cutable_width')]][$row[csf('uom')]]+$row[csf('quantity')];
							}
                        }
                        ?>
                        <td><input type="text" name="fabricRef[]" id="fabricRef_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('fabric_ref')]; ?>" style="width:60px" readonly <? echo $disable; ?>/></td>
                    	<td><input type="text" name="rdNo[]" id="rdNo_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('rd_no')]; ?>" style="width:60px" readonly <? echo $disable; ?> /></td>
                        <td>
                        	<input type="text" name="fabDescription[]" id="fabDescription_<? echo $i; ?>" class="text_boxes" onDblClick="openmypage_fabricDescription(1)" placeholder="Double Click To Search" value="<? echo $fab_description; ?>" style="width:195px" readonly <? echo $disable; ?>/>
	                    	<input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_<? echo $i; ?>" value="<? echo $row[csf('determination_id')]; ?>" readonly />                   
	                        <input type="hidden" name="construction[]" id="construction_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('fabric_construction')]; ?>" readonly/>
	                        <input type="hidden" name="composition[]" id="composition_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('fabric_composition')]; ?>" readonly/>
	                        <input type="hidden" name="bodyPart[]" id="bodyPart_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('body_part_id')]; ?>"  disabled="disabled"/> 
	                        <input type="hidden" name="fabType[]" id="fabType_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('fab_type')]; ?>"  disabled="disabled"/>
	                        <input type="hidden" name="fabDesign[]" id="fabDesign_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('fab_design')]; ?>" disabled="disabled"/>
                        </td>
                        <td>
 							<input type="text" name="colorName[]" id="colorName_<? echo $i; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $i; ?> )" style="width:50px" maxlength="50" <? echo $disable; ?> value="<? echo $color_library[$row[csf('color_id')]]; ?>"/>
                        </td>

                        <td>
                            <input type="text" name="fabWeight[]" id="fabWeight_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('fab_weight')]; ?>" style="width:35px" <? echo $disable; ?>/>
                        </td>
                        <td>
							<?
							if($pi_basis_id == 1)
							{
								?>
								<input type="text" name="fabWeightType[]" id="fabWeightType_<? echo $i; ?>" class="text_boxes" value="<? echo $fabric_weight_type[$row[csf('fab_weight_type')]]; ?>" placeholder="<? echo $row[csf('fab_weight_type')]; ?>" style="width:40px" readonly />
								<?
							}
							else
							{
								echo create_drop_down( "fabWeightType_".$i, 55, $fabric_weight_type, '', 1, 'Select', $row[csf('fab_weight_type')], '', $disable_status, '', '', '', '', '', '', 'fabWeightType[]');
							}
							?>

	                        <!-- <input type="text" name="weightType_<? //echo $i; ?>" id="weightType_<? //echo $i; ?>" class="text_boxes_numeric" value="<? //echo $fabric_weight_type[$row[csf('fab_weight_type')]]; ?>" style="width:55px" disabled="disabled"/>
	                        <input type="hidden" name="fabWeightType_<? //echo $i; ?>" id="fabWeightType_<? //echo $i; ?>" class="text_boxes" value="<? //echo $row[csf('fab_weight_type')]; ?>"  disabled="disabled"/> -->
	                    </td>
	                    <td>
							<?
							if($pi_basis_id == 1)
							{
								?>
								<input type="text" name="diawidthType[]" id="diawidthType_<? echo $i; ?>" class="text_boxes" value="<? echo $fabric_typee[$row[csf('width_dia_type')]]; ?>" placeholder="<? echo $row[csf('width_dia_type')]; ?>" style="width:40px" readonly />
								<?
							}
							else
							{
								echo create_drop_down( "diawidthType_".$i, 55, $fabric_typee, '', 1, 'Select', $row[csf('width_dia_type')], '', $disable_status, '', '', '', '', '', '', 'diawidthType[]');
							}
							?>

	                        <!-- <input type="text" name="diawidth_type_<? //echo $i; ?>" id="diawidth_type_<? //echo $i; ?>" class="text_boxes"  value="<? //echo $fabric_typee[$row[csf('width_dia_type')]]; ?>" style="width:55px" <? //echo $disable; ?>/>
	                        <input type="hidden" name="diawidthType_<? //echo $i; ?>" id="diawidthType_<? //echo $i; ?>" class="text_boxes" value="<? //echo $row[csf('width_dia_type')]; ?>"  disabled="disabled"/> -->
	                    </td>
                        <td>
                            <input type="text" name="diawidth[]" id="diawidth_<? echo $i; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $i; ?> )" value="<? echo $row[csf('dia_width')]; ?>" style="width:35px" <? echo $disable; ?>/>
                        </td>
                        <td>
	                        <input type="text" name="cutableWidth[]" id="cutableWidth_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('cutable_width')]; ?>" style="width:60px" <? echo $disable; ?>/>
	                    </td>
                        <?
                        if( $pi_basis_id == 1 )
                        {
                            ?>
                            <td>
                            <input type="text" name="uom[]" id="uom_<? echo $i; ?>" class="text_boxes" value="<? echo $unit_of_measurement[$row[csf('uom')]]; ?>" style="width:50px;" placeholder="<? echo $row[csf('uom')]; ?>" readonly <? echo $disable; ?>/>
                            </td>
                            <?
                        }
                        else
                        {
							if( $pi_basis_id == 1 ) $yarn_uom = 50; else $yarn_uom = 50;
                            ?>
                            <td>
                                <?
									echo create_drop_down( "uom_".$i, $yarn_uom, $unit_of_measurement, '', 1, 'Select', $row[csf('uom')], '', $disable_status_uom, '', '', '', '', '', '', 'uom[]');
								?>
                            </td>
                            <?
                        }
						?>
                        <td>
                            <input type="text" name="quantity[]" id="quantity_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo number_format($row[csf('quantity')],6,'.',''); ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $i; ?>)" placeholder="<? echo $bl_qty; ?>" />
                        </td>
                        <td>
                            <input type="text" name="rate[]" id="rate_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:45px;" onKeyUp="calculate_amount(<? echo $i; ?>)" <? echo $disable; ?> />
                        </td>
                        <td>
                            <input type="text" name="amount[]" id="amount_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:75px;" <? echo $disable; ?> readonly/>
                            <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $i; ?>" readonly value="<? echo $row[csf('id')]; ?>"/>
                            <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $i; ?>" value="<? echo $row[csf('booking_without_order')]; ?>"/>
                        </td>
                        <?
                        if( $pi_basis_id == 2 )
                        {
	                        ?>
	                        <td width="65">
	                            <input type="button" name="increase[]" id="increase_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( <? echo $i; ?> )" />
	                            <input type="button" name="decrease[]" id="decrease_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(<? echo $i; ?>);" />
	                        </td>
	                        <?
                        }
                        ?>
                    </tr>
            	    <?
				    $i++;
				}
				$txt_tot_row=$i-1;
			}

			?>
            </tbody>
			<tfoot class="tbl_bottom">
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Total</td>
                <td>
                    <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo number_format($tot_amnt,4,".",""); ?>" style="width:75px;" readonly/>
                </td>
                <?
                if( $pi_basis_id == 2 )
                {
                    ?>
                    <td width="65">&nbsp;</td>
                    <?
                }
                ?>
            </tr>
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Upcharge</td>
                <td>
                    <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo number_format($upcharge,4,'.','');// $upcharge; ?>" style="width:75px;" onDblClick="fn_upcharge(1)" onKeyUp="calculate_total_amount(2);fn_break_data_change(1);" placeholder="Browse or Write"/>
                    <input type="hidden" name="up_charge_break_down" id="up_charge_break_down" value="<? echo $upcharge_breakdown; ?>"/>
                </td>
                <?
                if( $pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Discount</td>
                <td>
                    <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo number_format($discount,4,'.','');  //$discount; ?>" style="width:85px;" onDblClick="fn_upcharge(2)" onKeyUp="calculate_total_amount(2);fn_break_data_change(2);" placeholder="Browse or Write"/>
                    <input type="hidden" name="discount_break_down" id="discount_break_down" value="<? echo $discount_breakdown; ?>" />
                </td>
                <?
                if( $pi_basis_id == 2 )
                {
                    ?>
                    <td width="65">&nbsp;</td>
                    <?
                }
                ?>
            </tr>
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Net Total</td>
                <td>
                    <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo number_format($tot_amnt_net,4,".",""); ?>" style="width:75px;" readonly/>
                </td>
                <?
                if($pi_basis_id == 2 )
                {
                    ?>
                    <td width="65">&nbsp;</td>
                    <?
                }
                ?>
                </tr>
            </tfoot>
            <? 
		}
		else if($item_category_id==4)  // Accessories
		{
		 	?>
        	<thead>
				<?
                if($pi_basis_id == 1)
                {
                	?>
                    <th>&nbsp;</th>
                    <th>WO</th>
                    <th>PO No</th>
                    <th>Style Ref</th>
                	<?
                }
                ?>                
                <th>HS Code</th>
                <th class="must_entry_caption">Item Group</th>
                <th class="must_entry_caption">Item Description</th>
                <th>Brand/ Supp. Ref</th>
                <th>Gmts Color</th>
                <th>Gmts Size</th>
                <th class="must_entry_caption">Item Color</th>
                <th>Item Size</th>
                <th>UOM</th>
                <th class="must_entry_caption">Quantity</th>
                <th class="must_entry_caption">Rate</th>
                <th>Amount</th>
                <?
                if( $pi_basis_id == 2 )
                {
                	?>
                    <th></th>
                	<?
                }
                ?>
            </thead>
            <tbody>
       		<?
            if($pi_basis_id==2)
            {
                $disable="";
                $disable_status=0;
            }
            else
            {
				$disable="disabled='disabled'";
                $disable_status=1;
				if($goods_rcv_status==1) $disable_field="disabled='disabled'"; else $disable_field="";

            }

			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
            {
               if($db_type==0)
				{
					$sql_pi="select id as id, work_order_no, work_order_id, group_concat(work_order_dtls_id) as work_order_dtls_id, color_id, item_group, item_description, size_id, item_color, item_size, uom, sum(quantity) as quantity, avg(rate) as rate, sum(amount) as amount, brand_supplier, booking_without_order, item_prod_id, hs_code, order_id, order_no, buyer_style_ref as style_ref_no
					from com_pi_item_details where pi_id='$pi_id' and status_active=1 and is_deleted=0
					group by id, work_order_no, work_order_id, color_id, item_group, item_description, size_id, item_color, item_size, uom, brand_supplier, booking_without_order, item_prod_id, hs_code, order_id, order_no, style_ref_no" ;

				}
				else
				{
					 //$sql_pi="select id AS id, listagg(cast(work_order_dtls_id as varchar(4000)),',') within group(order by work_order_dtls_id) AS work_order_dtls_id , work_order_no, work_order_id, color_id, item_group, item_description, size_id, item_color, item_size, uom, sum(quantity) as quantity, avg(rate) as rate, sum(amount) as amount, brand_supplier, booking_without_order, item_prod_id, hs_code, order_id, order_no, buyer_style_ref as style_ref_no
					//from com_pi_item_details where pi_id='$pi_id' and status_active=1 and is_deleted=0
					//group by id, work_order_no, work_order_id, color_id, item_group, item_description, size_id, item_color, item_size, uom, brand_supplier, booking_without_order, item_prod_id, hs_code, order_id,order_no" ;
					
					$sql_pi="select id AS id, work_order_dtls_id AS work_order_dtls_id , work_order_no, work_order_id, color_id, item_group, item_description, size_id, item_color, item_size, uom, quantity as quantity, rate as rate, amount as amount, brand_supplier, booking_without_order, item_prod_id, hs_code, order_id, order_no, buyer_style_ref as style_ref_no
					from com_pi_item_details where pi_id='$pi_id' and status_active=1 and is_deleted=0" ;
				}

            }
            else
            {
				$sql_pi="select id, work_order_no, work_order_id, work_order_dtls_id, order_id, order_no, buyer_style_ref as style_ref_no, booking_article_no as ref_no, color_id, item_group, item_description, size_id, item_color, item_size, uom, quantity, rate, amount, brand_supplier, booking_without_order, item_prod_id, hs_code from com_pi_item_details where pi_id='$pi_id' and status_active=1 and is_deleted=0";
            }
			
			//echo $sql_pi;
			
			$nameArray=sql_select($sql_pi);

			if($type==1 || count($nameArray)<1)
            {
				$tot_amnt=''; $upcharge=''; $upcharge_breakdown='';  $discount=''; $tot_amnt_net=''; $txt_tot_row=0;

				$bgcolor=($i%2==0)? "#E9F3FF":"#FFFFFF";
            	?>
                <tr id="row_1">
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    	?>
                        <td width="20">
                            <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_1" value="" />
                        </td>
                        <td width="80">
                            <input type="text" name="workOrderNo[]" id="workOrderNo_1" class="text_boxes" value="" style="width:80px;" placeholder="Dbl click" onDblClick="openmypage_wo(1);" readonly />
                            <input type="hidden" name="hideWoId[]" id="hideWoId_1" readonly />
                            <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_1" readonly />
                            <input type="hidden" name="hideTransData[]" id="hideTransData_1" value="" readonly />
                            <input type="hidden" name="hideProdId[]" id="hideProdId_1" value="" readonly />
                            <input type="hidden" name="hidePoId[]" id="hidePoId_1" value="" readonly />
                        </td>
                        <td width="70"></td>
                        <td width="70"></td>
                        <td width="50"><input type="text" name="hsCode[]" id="hsCode_1" class="text_boxes" value="" style="width:40px;" /></td>
                        <td width="120"></td>
                        <td width="120"></td>
                        <td width="70"></td>
                        <td width="70"></td>
                        <td width="70"></td>
                        <td width="70"></td>
                        <td width="70"></td>
                        <td width="60" id="uom_1"></td>
                        <td width="70">
                            <input type="text" name="quantity[]" id="quantity_1" class="text_boxes_numeric" value="" style="width:61px;" onKeyUp="calculate_amount(1)" />
                        </td>
                        <td width="50">
                            <input type="text" name="rate[]" id="rate_1" class="text_boxes_numeric" value="" style="width:45px;" onKeyUp="calculate_amount(1)" <? echo $disable; ?> />
                        </td>
                        <td>
                            <input type="text" name="amount[]" id="amount_1" class="text_boxes_numeric" value="" style="width:75px;" <? echo $disable; ?> readonly/>
                            <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_1" readonly/>
                            <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_1" readonly/>
                        </td>
                    	<?
                    }
					else
					{
						?>
                        <td><input type="text" name="hsCode[]" id="hsCode_1" class="text_boxes" value="" style="width:40px;" /></td>
                        <td>
							<?
                                echo create_drop_down( "itemgroupid_1", 70, "SELECT id,item_name FROM lib_item_group WHERE item_category =$item_category_id AND status_active = 1 AND is_deleted = 0 ORDER BY item_name ASC","id,item_name", 1, "-Select-", 0,"get_php_form_data( this.value+'**'+'uom_1', 'get_uom', 'requires/pi_controller_urmi' );", $disable_status, "", "", "", "", "", "", "itemgroupid[]");
                            ?>
                        </td>
                        <td>
                        <input type="text" name="itemdescription[]" id="itemdescription_1" class="text_boxes" value="" style="width:100px" maxlength="200" <? echo $disable; ?>/>
                        </td>
                        <td>
                            <input type="text" name="brandSupRef[]" id="brandSupRef_1" class="text_boxes" value="" maxlength="150" style="width:80px" <? echo $disable; ?>/>
                        </td>
                        <td>
                            <input type="text" name="colorName[]" id="colorName_1" class="text_boxes" onFocus="add_auto_complete( 1 )" value="" style="width:70px" maxlength="50" <? echo $disable; ?>/>
                        </td>
                        <td>
                            <input type="text" name="sizeName[]" id="sizeName_1" class="text_boxes" value="" onFocus="add_auto_complete( 1 )" style="width:60px;" maxlength="50" <? echo $disable; ?>/>
                        </td>
                        <td>
                            <input type="text" name="itemColor[]" id="itemColor_1" class="text_boxes" value="" onFocus="add_auto_complete( 1 )" style="width:70px" maxlength="50" <? echo $disable; ?>/>
                        </td>
                        <td>
                            <input type="text" name="itemSize[]" id="itemSize_1" class="text_boxes" value="" style="width:60px;" maxlength="50" <? echo $disable; ?>/>
                        </td>
                        <td><? echo create_drop_down( "uom_1", 60, $unit_of_measurement,"", 0, "-Select-", 0, "", 1, "", "", "", "", "", "", "uom[]");?></td>
                        <td><input type="text" name="quantity[]" id="quantity_1" class="text_boxes_numeric" value="" style="width:61px;" onKeyUp="calculate_amount(1)" /></td>
                        <td><input type="text" name="rate[]" id="rate_1" class="text_boxes_numeric" value="" style="width:45px;" onKeyUp="calculate_amount(1)" <? echo $disable; ?> /></td>
                        <td>
                            <input type="text" name="amount[]" id="amount_1" class="text_boxes_numeric" value="" style="width:75px;" <? echo $disable; ?> readonly/>
                            <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_1" readonly/>
                            <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_1" readonly/>
                        </td>
                        <?
					}
					
                    if( $pi_basis_id == 2 )
                    {
	                    ?>
	                    <td width="65">
	                        <input type="button" name="increase[]" id="increase_1" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( 1 )" />
	                        <input type="button" name="decrease[]" id="decrease_1" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(1);" />
	                    </td>
	                    <?
                    }
                    ?>
                </tr>
            	<?
            }
			else
			{
				$item_group_arr=return_library_array( "SELECT id,item_name FROM lib_item_group WHERE item_category =$item_category_id AND status_active = 1 AND is_deleted = 0 ORDER BY item_name ASC",'id','item_name');

				$data_array=sql_select("select item_category_id,goods_rcv_status,total_amount, upcharge, upcharge_breakdown, discount, discount_breakdown, net_total_amount from com_pi_master_details where id='$pi_id'");
				$tot_amnt=$data_array[0][csf('total_amount')];
				$upcharge=$data_array[0][csf('upcharge')];
				$upcharge_breakdown=$data_array[0][csf('upcharge_breakdown')];
				$discount=$data_array[0][csf('discount')];
				$discount_breakdown=$data_array[0][csf('discount_breakdown')];
				$tot_amnt_net=$data_array[0][csf('net_total_amount')];
				$item_category_id=$data_array[0][csf('item_category_id')];
				$goods_rcv_status=$data_array[0][csf('goods_rcv_status')];
				
				 
				if( $pi_basis_id == 1 )
				{
					$wo_dtls_id=''; $wo_dtls_id2=''; $wo_dtls_id_all='';
					foreach ($nameArray as $row)
					{
						if($row[csf('booking_without_order')]==1)
						{
							$wo_dtls_id2.=$row[csf('work_order_dtls_id')].',';
						}
						else
						{
							$wo_dtls_id.=$row[csf('work_order_dtls_id')].',';
						}

						$wo_dtls_id_all.=$row[csf('work_order_dtls_id')].',';
					}
					$wo_dtls_id=chop($wo_dtls_id,',');
					$wo_dtls_id2=chop($wo_dtls_id2,',');
					$wo_dtls_id_all=chop($wo_dtls_id_all,',');

					
					$is_sort_array=return_library_array( "SELECT id, is_short FROM wo_booking_dtls WHERE  status_active = 1 AND is_deleted = 0 and id in($wo_dtls_id_all) ",'id','is_short');

					if($goods_rcv_status==1 && $goods_rcv_variable!=1)
					{

						$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id_all) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");

						$wo_qty_arr=return_library_array("select id, quantity as qty from order_wise_pro_details where id in($wo_dtls_id) and entry_form=24 and trans_type=1", "id", "qty");
						//$wo_qty_arr=return_library_array("select id, order_qnty as qty from inv_transaction where id in($wo_dtls_id)", "id", "qty");

					}
					else
					{
						if($wo_dtls_id!="")
						{
							$wo_qty_arr=array();
							$sql_prev="SELECT a.booking_no, b.id, b.po_break_down_id as order_id, b.trim_group, b.uom, c.description, c.rate, c.color_number_id, c.item_color, c.gmts_sizes, c.item_size, c.brand_supplier, sum(c.cons) as qnty from wo_booking_mst a, wo_booking_dtls b, wo_trim_book_con_dtls c where a.booking_no=b.booking_no and b.booking_no=c.booking_no and b.id=c.wo_trim_booking_dtls_id and b.id in($wo_dtls_id) group by a.booking_no, b.id, b.po_break_down_id, b.trim_group, b.uom, c.description, c.rate, c.color_number_id, c.item_color, c.gmts_sizes, c.item_size, c.brand_supplier";
							$prevData=sql_select($sql_prev);
							foreach($prevData as $rowP)
							{
								$wo_qty_arr[$rowP[csf('booking_no')]][$rowP[csf('id')]][$rowP[csf('order_id')]][$rowP[csf('color_number_id')]][$rowP[csf('trim_group')]][$rowP[csf('description')]][$rowP[csf('gmts_sizes')]][$rowP[csf('item_color')]][$rowP[csf('item_size')]][$rowP[csf('brand_supplier')]][$rowP[csf('uom')]][number_format($rowP[csf('rate')],4,'.','')]=$rowP[csf('qnty')];
							}
							//echo "<pre>";print_r($wo_qty_arr);

							$prev_pi_qty_arr=array();
							$sql_prev="select b.work_order_no, b.work_order_dtls_id, b.order_id, b.color_id, b.item_group, b.item_description, b.size_id, b.item_color, b.item_size, b.uom, b.rate, b.brand_supplier, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id_all) group by b.work_order_no, b.work_order_dtls_id, b.order_id, b.color_id, b.item_group, b.item_description, b.size_id, b.item_color, b.item_size, b.uom, b.rate, b.brand_supplier";
							$prevData=sql_select($sql_prev);
							foreach($prevData as $rowP)
							{
								$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('work_order_dtls_id')]][$rowP[csf('order_id')]][$rowP[csf('color_id')]][$rowP[csf('item_group')]][$rowP[csf('item_description')]][$rowP[csf('size_id')]][$rowP[csf('item_color')]][$rowP[csf('item_size')]][$rowP[csf('brand_supplier')]][$rowP[csf('uom')]][$rowP[csf('rate')]]=$rowP[csf('qty')];
							}

							//$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id_all) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");

							//$wo_qty_arr=return_library_array("select wo_trim_booking_dtls_id as id, sum(cons) as qty from wo_trim_book_con_dtls where wo_trim_booking_dtls_id in($wo_dtls_id) group by wo_trim_booking_dtls_id", "id", "qty");
						}

						if($wo_dtls_id2!="")
						{
							$wo_qty_arr2=return_library_array("select id, trim_qty as qty from wo_non_ord_samp_booking_dtls where id in($wo_dtls_id2)", "id", "qty");
							$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id2) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");
						}
					}
				}
				$disable_data=$checkBox_check="";
				if($goods_rcv_variable==1 && $goods_rcv_status==1)
				{
					$disable_data="disabled='disabled'";
					$checkBox_check="checked";
				}
				$i=1; 
				foreach ($nameArray as $row)
				{
                         $wo_title="";
					if($is_sort_array[$row[csf('work_order_dtls_id')]]==1 ){
						$wo_title="Short";
					}
					if($is_sort_array[$row[csf('work_order_dtls_id')]]==2 ){
						$wo_title="Main Booking";
					}
					$bl_qty='';
					$bgcolor=($i%2==0)? "#E9F3FF":"#FFFFFF";
				    ?>
                    <tr  bgcolor="<?=$bgcolor; ?>" id="row_<? echo $i; ?>">
                        <?
                        if( $pi_basis_id == 1 )
                        {
							$trans_data.=$row[csf('work_order_id')]."_".$row[csf('quantity')]."_".$row[csf('amount')]."_".$row[csf('item_prod_id')]."_".$row[csf('order_id')]."__";
                        	?>
                            <td width="20">
                                <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $i; ?>" value="" <? //echo $checkBox_check;  ?> />
                            </td>
                            <td width="80" title="<? echo $wo_title;?>">
                                <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:80px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $i; ?>);" <? //echo $disable_field; ?>  readonly />
                                <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $i; ?>" readonly value="<? echo $row[csf('work_order_id')]; ?>" />
                                <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $i;?>" readonly value="<? echo $row[csf('work_order_dtls_id')];?>"/>
                                <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $i; ?>" value="<? echo $trans_data; ?>" readonly />
                                <input type="hidden" name="hidePoId[]" id="hidePoId_<? echo $i; ?>" value="<? echo $row[csf('order_id')]; ?>" readonly />
                            </td>
                            <td width="70" id="poNo_<? echo $i; ?>" title="<? echo $row[csf('ref_no')]; ?>"><? echo $row[csf('order_no')]; ?></td>
                            <td width="70" id="styleRef_<? echo $i; ?>"><? echo $row[csf('style_ref_no')]; ?></td>
                            <td width="50">
                                <input type="text" name="hsCode[]" id="hsCode_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('hs_code')]; ?>" style="width:40px;" />
                            </td>
                            <?
							if($goods_rcv_status==2 && $row[csf('booking_without_order')]==1 && $goods_rcv_variable==1)
							{
								$bl_qty=$wo_qty_arr2[$row[csf('work_order_dtls_id')]]-$prev_pi_qty_arr[$row[csf('work_order_dtls_id')]]+$row[csf('quantity')];
							}
							else if($goods_rcv_status==2 && $row[csf('booking_without_order')]!=1 && $goods_rcv_variable==1)
							{
								$bl_qty=$wo_qty_arr[$row[csf('work_order_no')]][$row[csf('work_order_dtls_id')]][$row[csf('order_id')]][$row[csf('color_id')]][$row[csf('item_group')]][$row[csf('item_description')]][$row[csf('size_id')]][$row[csf('item_color')]][$row[csf('item_size')]][$row[csf('brand_supplier')]][$row[csf('uom')]][number_format($row[csf('rate')],4,'.','')]-$prev_pi_qty_arr[$row[csf('work_order_no')]][$row[csf('work_order_dtls_id')]][$row[csf('order_id')]][$row[csf('color_id')]][$row[csf('item_group')]][$row[csf('item_description')]][$row[csf('size_id')]][$row[csf('item_color')]][$row[csf('item_size')]][$row[csf('brand_supplier')]][$row[csf('uom')]][$row[csf('rate')]]+$row[csf('quantity')];
							}
							else
							{
								$bl_qty=$wo_qty_arr[$row[csf('work_order_dtls_id')]]-$prev_pi_qty_arr[$row[csf('work_order_dtls_id')]]+$row[csf('quantity')];
							}
							?>
							<td width="120" id="itemgroupid_<? echo $i; ?>" title="<? echo $row[csf('item_group')]; ?>"><? echo $item_group_arr[$row[csf('item_group')]]; ?></td>
                            <td width="120" id="itemdescription_<? echo $i; ?>"><? echo $row[csf('item_description')]; ?></td>
                            <td width="70" id="brandSupRef_<? echo $i; ?>"><? echo $row[csf('brand_supplier')]; ?></td>
                            <td width="70" id="colorName_<? echo $i; ?>"><? echo $color_library[$row[csf('color_id')]]; ?></td>
                            <td width="70" id="sizeName_<? echo $i; ?>"><? echo $size_library[$row[csf('size_id')]]; ?></td>
                            <td width="70" id="itemColor_<? echo $i; ?>"><? echo $color_library[$row[csf('item_color')]]; ?></td>
                            <td width="70" id="itemSize_<? echo $i; ?>"><? echo $row[csf('item_size')]; ?></td>
                            <td width="60" id="uom_<? echo $i; ?>" title="<? echo $row[csf('uom')]; ?>"><? echo $unit_of_measurement[$row[csf('uom')]]; ?></td>
                            <td width="70">
                                <input type="text" name="quantity[]" id="quantity_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo number_format($row[csf('quantity')],6,'.',''); ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $i; ?>)" placeholder="<? echo $bl_qty; ?>" <? echo $disable_field; ?> <? //echo $disable_data;  ?> />
                            </td>
                            <td width="50">
                                <input type="text" name="rate[]" id="rate_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:45px;" onKeyUp="calculate_amount(<? echo $i; ?>)" <? echo $disable; ?> />
                            </td>
                            <td>
                                <input type="text" name="amount[]" id="amount_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:75px;" <? echo $disable; ?> readonly/>
                                <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $i; ?>" readonly value="<? echo $row[csf('id')]; ?>"/>
                                <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $i; ?>" value="<? echo $row[csf('booking_without_order')]; ?>"/>
                            </td>
                            <?
                        }
						else
						{
							?>
                            <td>
                                <input type="text" name="hsCode[]" id="hsCode_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('hs_code')]; ?>" style="width:40px;" />
                            </td>
							<td>
							 <?
								echo create_drop_down( "itemgroupid_".$i, 70, $item_group_arr, "", 1, "-Select-", $row[csf('item_group')], "get_php_form_data( this.value+'**'+'uom_$i', 'get_uom', 'requires/pi_controller_urmi' );", $disable_status, "", "", "", "", "", "", "itemgroupid[]");
							 ?>
							</td>
                            <td>
                            <input type="text" name="itemdescription[]" id="itemdescription_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('item_description')]; ?>" style="width:100px" maxlength="200" <? echo $disable; ?>/>
                            </td>
                            <td>
                                <input type="text" name="brandSupRef[]" id="brandSupRef_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('brand_supplier')]; ?>" style="width:80px" maxlength="150" <? echo $disable; ?>/>
                            </td>
                            <td>
                                <input type="text" name="colorName[]" id="colorName_<? echo $i; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $i; ?> )"  style="width:70px" maxlength="50" <? echo $disable; ?> value="<? echo $color_library[$row[csf('color_id')]]; ?>"/>
                            </td>
                            <td>
                                <input type="text" name="sizeName[]" id="sizeName_<? echo $i; ?>" class="text_boxes" value="<? echo $size_library[$row[csf('size_id')]]; ?>" onFocus="add_auto_complete( <? echo $i; ?> )" style="width:60px;" maxlength="50" <? echo $disable; ?>/>
                            </td>
                            <td>
                                <input type="text" name="itemColor[]" id="itemColor_<? echo $i; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $i; ?> )" value="<? echo $color_library[$row[csf('item_color')]]; ?>" style="width:70px" maxlength="50" <? echo $disable; ?>/>
                            </td>
                            <td>
                                <input type="text" name="itemSize[]" id="itemSize_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('item_size')]; ?>" style="width:60px;" maxlength="50" <? echo $disable; ?>/>
                            </td>
                            <td>
								<?
                                    echo create_drop_down( "uom_".$i, 60, $unit_of_measurement, "", 0, "", $row[csf('uom')], "", 1, "", "", "", "", "", "", "uom[]");
                                ?>
                            </td>
                            <td>
                                <input type="text" name="quantity[]" id="quantity_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo number_format($row[csf('quantity')],6,'.',''); ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $i; ?>)" placeholder="<? echo $bl_qty; ?>" <? echo $disable_field; ?> <? //echo $disable_data;  ?> />
                            </td>
                            <td>
                                <input type="text" name="rate[]" id="rate_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:45px;" onKeyUp="calculate_amount(<? echo $i; ?>)" <? echo $disable; ?> />
                            </td>
                            <td>
                                <input type="text" name="amount[]" id="amount_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:75px;" <? echo $disable; ?> readonly/>
                                <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $i; ?>" readonly value="<? echo $row[csf('id')]; ?>"/>
                                <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $i; ?>" value="<? echo $row[csf('booking_without_order')]; ?>"/>
                            </td>
                            <?
						}
						
                        if( $pi_basis_id == 2 )
                        {
                        	?>
                        	<td width="65">
                                <input type="button" name="increase[]" id="increase_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( <? echo $i; ?> )" />
                                <input type="button" name="decrease[]" id="decrease_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(<? echo $i; ?>);" />
                        	</td>
                        	<?
                        }
                        ?>
                    </tr>
            	<?
				$i++;
				}
				$txt_tot_row=$i-1;
			}
			?>
            </tbody>
            <tfoot class="tbl_bottom">
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                	?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                	<?
                }
                ?>                
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Total</td>
                <td>
                    <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo number_format($tot_amnt,4,'.',''); ?>" style="width:75px;" readonly/>
                </td>
                <?
                if( $pi_basis_id == 2 )
                {
                	?>
                    <td width="65">&nbsp;</td>
                	<?
                }
                ?>
            </tr>
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Upcharge</td>
                <td>
                    <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo number_format($upcharge,4,'.',''); //$upcharge; ?>" style="width:75px;" onDblClick="fn_upcharge(1)" onKeyUp="calculate_total_amount(2);fn_break_data_change(1);" placeholder="Browse or Write"/>
                    <input type="hidden" name="up_charge_break_down" id="up_charge_break_down" value="<? echo $upcharge_breakdown; ?>" />
                </td>
                <?
                if( $pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Discount</td>
                <td>
                    <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo number_format($discount,4,'.','');  //$discount; ?>" style="width:75px;" onDblClick="fn_upcharge(2)" onKeyUp="calculate_total_amount(2);fn_break_data_change(2);" placeholder="Browse or Write"/>
                    <input type="hidden" name="discount_break_down" id="discount_break_down" value="<? echo $discount_breakdown; ?>" />
                </td>
                <?
                if( $pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Net Total</td>
                <td>
                    <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo number_format($tot_amnt_net,4,'.',''); ?>" style="width:75px;" readonly/>
                </td>
                <?
                if($pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            </tfoot>
            <?
		}
		else if($item_category_id==12)  // Services - Fabric
		{
			?>
         	<thead>
				<?
                if($pi_basis_id == 1)
                {
                ?>
                    <th>&nbsp;</th>
                    <th>WO</th>
                <?
                }
                ?>
                <th class="must_entry_caption">Service Type</th>
                <th class="must_entry_caption">Description</th>
                <th>Gmts Color</th>
                <th>Gmts Size</th>
                <th>Item Color</th>
                <th>Item Size</th>
                <th>UOM</th>
                <th class="must_entry_caption">Quantity</th>
                <th class="must_entry_caption">Rate</th>
                <th>Amount</th>
                <?
                if( $pi_basis_id == 2 )
                {
                ?>
                    <th></th>
                <?
                }
                ?>
            </thead>
            <tbody>
       	    <?
            if($pi_basis_id==2)
            {
                $disable="";
                $disable_status=0;
            }
            else
            {

				$disable="disabled='disabled'";
                $disable_status=1;
            }

			$nameArray=sql_select( "select id, work_order_no, work_order_id, work_order_dtls_id, color_id, service_type, item_description, size_id, item_color, item_size, uom, quantity, rate, amount, booking_without_order from com_pi_item_details where pi_id='$pi_id' and status_active=1 and is_deleted=0" );

			if($type==1 || count($nameArray)<1)
            {
				$tot_amnt=''; $upcharge=''; $upcharge_breakdown=''; $discount=''; $tot_amnt_net=''; $txt_tot_row=0;
            ?>
                <tr class="general" id="row_1">
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>
                            <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_1" value="" />
                        </td>
                        <td>
                            <input type="text" name="workOrderNo[]" id="workOrderNo_1" class="text_boxes" value="" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(1);" readonly />
                            <input type="hidden" name="hideWoId[]" id="hideWoId_1" readonly />
                            <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_1" readonly />
                        </td>
                    <?
                    }
                    ?>
                    <td>
                    	<? echo create_drop_down( "servicetype_1", 110, $conversion_cost_head_array, '', 1, '-Select-', 0, "", $disable_status, '', '', '', '', '', '', 'servicetype[]'); ?>
                    </td>
                    <td>
                        <input type="text" name="itemdescription[]" id="itemdescription_1" class="text_boxes" value="" style="width:150px" maxlength="200" <? echo $disable; ?>/>
                    </td>
                    <td>
                        <input type="text" name="colorName[]" id="colorName_1" class="text_boxes" onFocus="add_auto_complete( 1 )" value="" style="width:80px" maxlength="50" <? echo $disable; ?>/>
                    </td>
                    <td>
                        <input type="text" name="sizeName[]" id="sizeName_1" class="text_boxes" value="" onFocus="add_auto_complete( 1 )" style="width:70px;" maxlength="50" <? echo $disable; ?>/>
                    </td>
                    <td>
                        <input type="text" name="itemColor[]" id="itemColor_1" class="text_boxes" value="" onFocus="add_auto_complete( 1 )" style="width:80px" maxlength="50" <? echo $disable; ?>/>
                    </td>
                    <td>
                        <input type="text" name="itemSize[]" id="itemSize_1" class="text_boxes" value="" style="width:70px;" maxlength="50" <? echo $disable; ?>/>
                    </td>
                    <td>
                        <?
                            echo create_drop_down( "uom_1", 60, $unit_of_measurement, '', 0, '', 0, '', 0, '', '', '', '', '', '', 'uom[]');
                        ?>
                    </td>
                    <td>
                        <input type="text" name="quantity[]" id="quantity_1" class="text_boxes_numeric" value="" style="width:61px;" onKeyUp="calculate_amount(1)" />
                    </td>
                    <td>
                        <input type="text" name="rate[]" id="rate_1" class="text_boxes_numeric" value="" style="width:45px;" onKeyUp="calculate_amount(1)" <? echo $disable; ?> />
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_1" class="text_boxes_numeric" value="" style="width:75px;" <? echo $disable; ?> readonly/>
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_1" readonly/>
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                    <td width="65">
                        <input type="button" name="increase[]" id="increase_1" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( 1 )" />
                        <input type="button" name="decrease[]" id="decrease_1" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(1);" />
                    </td>
                    <?
                    }
                    ?>
                </tr>
            <?
            }
			else
			{
				$data_array=sql_select("select total_amount, upcharge, upcharge_breakdown, discount, discount_breakdown, net_total_amount from com_pi_master_details where id='$pi_id'");
				$tot_amnt=$data_array[0][csf('total_amount')];
				$upcharge=$data_array[0][csf('upcharge')];
				$upcharge_breakdown=$data_array[0][csf('upcharge_breakdown')];
				$discount=$data_array[0][csf('discount')];
				$discount_breakdown=$data_array[0][csf('discount_breakdown')];
				$tot_amnt_net=$data_array[0][csf('net_total_amount')];

				if( $pi_basis_id == 1 )
				{
					$wo_dtls_id=''; $wo_dtls_id2=''; $wo_dtls_id_all='';
					foreach ($nameArray as $row)
					{
						if($row[csf('booking_without_order')]==1)
						{
							$wo_dtls_id2.=$row[csf('work_order_dtls_id')].',';
						}
						else
						{
							$wo_dtls_id.=$row[csf('work_order_dtls_id')].',';
						}

						$wo_dtls_id_all.=$row[csf('work_order_dtls_id')].',';
					}
					$wo_dtls_id=chop($wo_dtls_id,',');
					$wo_dtls_id2=chop($wo_dtls_id2,',');
					$wo_dtls_id_all=chop($wo_dtls_id_all,',');

					$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=12 and a.pi_basis_id=1 and a.status_active=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id_all) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");

					if($wo_dtls_id!="")
					{
						$wo_qty_arr=return_library_array("select id, wo_qnty as qty from wo_booking_dtls where id in($wo_dtls_id) and status_active=1 and is_deleted=0", "id", "qty");
					}

					if($wo_dtls_id2!="")
					{
						$wo_qty_arr2=return_library_array("select id, wo_qty as qty from wo_non_ord_aop_booking_dtls where id in($wo_dtls_id2) and status_active=1 and is_deleted=0", "id", "qty");
					}
				}

				$i=1;
				foreach ($nameArray as $row)
				{
					$bl_qty='';
				?>
                    <tr class="general" id="row_<? echo $i; ?>">
                        <?
                        if( $pi_basis_id == 1 )
                        {
                        ?>
                            <td>
                                <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $i; ?>" value="" />
                            </td>
                            <td>
                                <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $i; ?>);" readonly />
                                <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $i; ?>" readonly value="<? echo $row[csf('work_order_id')]; ?>" />
                                <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $i;?>" readonly value="<? echo $row[csf('work_order_dtls_id')];?>"/>
                            </td>
                        <?
							if($row[csf('booking_without_order')]==1)
							{
								$bl_qty=$wo_qty_arr2[$row[csf('work_order_dtls_id')]]-$prev_pi_qty_arr[$row[csf('work_order_dtls_id')]]+$row[csf('quantity')];
							}
							else
							{
								$bl_qty=$wo_qty_arr[$row[csf('work_order_dtls_id')]]-$prev_pi_qty_arr[$row[csf('work_order_dtls_id')]]+$row[csf('quantity')];
							}
                        }
                        ?>
                        <td>
							<? echo create_drop_down( "servicetype_".$i, 110, $conversion_cost_head_array, '', 1, '-Select-', $row[csf('service_type')], "", $disable_status, '', '', '', '', '', '', 'servicetype[]'); ?>
                        </td>
                        <td>
                            <input type="text" name="itemdescription[]" id="itemdescription_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('item_description')]; ?>" style="width:150px" maxlength="200" <? echo $disable; ?>/>
                        </td>
                        <td>
 							<input type="text" name="colorName[]" id="colorName_<? echo $i; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $i; ?> )" style="width:80px" maxlength="50" <? echo $disable; ?> value="<? echo $color_library[$row[csf('color_id')]]; ?>"/>
                        </td>
                        <td>
                            <input type="text" name="sizeName[]" id="sizeName_<? echo $i; ?>" class="text_boxes" value="<? echo $size_library[$row[csf('size_id')]]; ?>" onFocus="add_auto_complete( <? echo $i; ?> )" style="width:70px;" maxlength="50" <? echo $disable; ?>/>
                        </td>
                        <td>
                            <input type="text" name="itemColor[]" id="itemColor_<? echo $i; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $i; ?> )" value="<? echo $color_library[$row[csf('item_color')]]; ?>" style="width:80px" maxlength="50" <? echo $disable; ?>/>
                        </td>
                        <td>
                            <input type="text" name="itemSize[]" id="itemSize_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('item_size')]; ?>" style="width:70px;" maxlength="50" <? echo $disable; ?>/>
                        </td>
                        <td>
                            <?
                                echo create_drop_down( "uom_".$i, 60, $unit_of_measurement, '', 0, '', $row[csf('uom')], '', $disable_status, '', '', '', '', '', '', 'uom[]');
                            ?>
                        </td>
                        <td>
                            <input type="text" name="quantity[]" id="quantity_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $i; ?>)" placeholder="<? echo $bl_qty; ?>" />
                        </td>
                        <td>
                            <input type="text" name="rate[]" id="rate_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:45px;" onKeyUp="calculate_amount(<? echo $i; ?>)" <? echo $disable; ?> />
                        </td>
                        <td>
                            <input type="text" name="amount[]" id="amount_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:75px;" <? echo $disable; ?> readonly/>
                            <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $i; ?>" readonly value="<? echo $row[csf('id')]; ?>"/>
                            <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $i; ?>" value="<? echo $row[csf('booking_without_order')]; ?>"/>
                        </td>
                        <?
                        if( $pi_basis_id == 2 )
                        {
                        ?>
                        <td width="65">
                            <input type="button" name="increase[]" id="increase_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( <? echo $i; ?> )" />
                            <input type="button" name="decrease[]" id="decrease_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(<? echo $i; ?>);" />
                        </td>
                        <?
                        }
                        ?>
                    </tr>
            	<?
				$i++;
				}
				$txt_tot_row=$i-1;
			}
			?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td>
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amnt; ?>" style="width:75px;" readonly/>
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td>
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo number_format($upcharge,4,'.',''); //$upcharge; ?>" style="width:75px;" onDblClick="fn_upcharge(1)" onKeyUp="calculate_total_amount(2);fn_break_data_change(1);" placeholder="Browse or Write" />
                    <input type="hidden" name="up_charge_break_down" id="up_charge_break_down" value="<? echo $upcharge_breakdown; ?>" />
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td>
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo number_format($discount,4,'.','');  //$discount; ?>" style="width:85px;" onDblClick="fn_upcharge(2)" onKeyUp="calculate_total_amount(2);fn_break_data_change(2);" placeholder="Browse or Write"/>
                    <input type="hidden" name="discount_break_down" id="discount_break_down" value="<? echo $discount_breakdown; ?>" />
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>

                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td>
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $tot_amnt_net; ?>" style="width:75px;" readonly/>
                    </td>
                    <?
                    if($pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
        	</tfoot>
            <?
		}
		else if($item_category_id==24)  // Services - Yarn Dyeing
		{
			?>
         	<thead>
				<?
                if($pi_basis_id == 1)
                {
                ?>
                    <th>&nbsp;</th>
                    <th>WO</th>
                <?
                }
                ?>
                <th class="must_entry_caption">Lot</th>
                <th>Count</th>
                <th>Yarn Description</th>
                <th>Yarn Color</th>
                <th>Color Range</th>
                <th>UOM</th>
                <th class="must_entry_caption">Quantity</th>
                <th class="must_entry_caption">Rate</th>
                <th>Amount</th>
                <?
                if($pi_basis_id == 2 )
                {
                ?>
                    <th></th>
                <?
                }
                ?>
            </thead>
            <tbody>
       	    <?
            if($pi_basis_id==2)
            {
                 $disable="";
                $disable_status=0;
				$placeholder="Doublic Click";
            }
            else
            {
				$disable="disabled='disabled'";
                $disable_status=1;
				$placeholder="";
				if($goods_rcv_status==1) $disable_field="disabled='disabled'"; else $disable_field="";
            }

			$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count WHERE status_active = 1 AND is_deleted = 0 ORDER BY yarn_count",'id','yarn_count');

			$colorIds=array();



			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
            {
				if($db_type==0)
				{

					$nameArray=sql_select( "select group_concat(id) as id, work_order_no, work_order_id, group_concat(work_order_dtls_id) as work_order_dtls_id, lot_no, yarn_color, count_name, color_range, item_description, item_prod_id, uom, sum(quantity) as quantity, avg(rate) as rate, sum(amount) as amount
					from com_pi_item_details
					where pi_id='$pi_id' and status_active=1 and is_deleted=0
					group by work_order_no, work_order_id, lot_no, yarn_color, count_name, color_range, item_description, item_prod_id, uom" );


				}
				else
				{

					$nameArray=sql_select( "select rtrim(xmlagg(xmlelement(e,id,',').extract('//text()') order by id).GetClobVal(),',') AS id , rtrim(xmlagg(xmlelement(e,work_order_dtls_id,',').extract('//text()') order by work_order_dtls_id).GetClobVal(),',') AS work_order_dtls_id , work_order_no, work_order_id,  lot_no, yarn_color, count_name, color_range, item_description, item_prod_id, uom, booking_without_order, sum(quantity) as quantity, avg(rate) as rate, sum(amount) as amount
					from com_pi_item_details
					where pi_id='$pi_id' and status_active=1 and is_deleted=0
					group by work_order_no, work_order_id, lot_no, yarn_color, count_name, color_range, item_description, item_prod_id, uom, booking_without_order" );

				}

            }
            else
            {
				$nameArray=sql_select( "select id, work_order_no, work_order_id, work_order_dtls_id, lot_no, yarn_color, count_name, color_range, item_description, item_prod_id, uom, quantity, rate, amount, booking_without_order from com_pi_item_details where pi_id='$pi_id' and status_active=1 and is_deleted=0" );
            }

			if($type==1 || count($nameArray)<1)
            {
				$color_array=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
				$tot_amnt=''; $upcharge=''; $upcharge_breakdown=''; $discount=''; $tot_amnt_net=''; $txt_tot_row=0;
            	?>
                <tr class="general" id="row_1">
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>
                            <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_1" value="" />
                        </td>
                        <td>
                            <input type="text" name="workOrderNo[]" id="workOrderNo_1" class="text_boxes" value="" style="width:115px;" placeholder="Dbl click" onDblClick="openmypage_wo(1);" readonly />
                            <input type="hidden" name="hideWoId[]" id="hideWoId_1" readonly />
                            <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_1" readonly />
                            <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_1" readonly />
                        </td>
                    <?
                    }
                    ?>
                    <td>
                        <input type="text" name="lot[]" id="lot_1" class="text_boxes" value="" style="width:80px" maxlength="200" <? echo $disable; ?> onDblClick="openmypage_item_desc(1);" placeholder="<? echo $placeholder; ?>" readonly/>
                        <input type="hidden" name="itemProdId[]" id="itemProdId_1" readonly value=""/>
                    </td>
                    <td>
                    	<? echo create_drop_down( "countName_1", 90, $count_arr, '', 1, '-Select-', 0, "", 1, '', '', '', '', '', '', 'countName[]'); ?>
                    </td>
                    <td>
                        <input type="text" name="itemdescription[]" id="itemdescription_1" class="text_boxes" value="" style="width:200px" maxlength="200" disabled/>
                    </td>
                    <td>
                    	<? //echo create_drop_down( "yarnColor_1", 110, $color_array,'', 1, '-Select-', 0,"",$disable_status); ?>
                        <input type="text" name="colorName[]" id="colorName_1" class="text_boxes" onFocus="add_auto_complete( 1 )" style="width:100px" onBlur="fn_add_color_id(1)"  maxlength="50" <? echo $disable; ?>/>
                        <input type="hidden" name="colorId[]" id="colorId_1" class="text_boxes" value=""/>
                    </td>
                    <td>
                        <? echo create_drop_down( "colorRange_1", 110, $color_range, '', 1, '-Select-', 0, "", $disable_status, '', '', '', '', '', '', 'colorRange[]'); ?>
                    </td>
                    <td>
                        <?
							echo create_drop_down( "uom_1", 60, $unit_of_measurement, '', 0, '', $row[csf('uom')], '', 1, 12, '', '', '', '', '', 'uom[]');
                        ?>
                    </td>
                    <td>
                        <input type="text" name="quantity[]" id="quantity_1" class="text_boxes_numeric" value="" style="width:61px;" onKeyUp="calculate_amount(1)" />
                    </td>
                    <td>
                        <input type="text" name="rate[]" id="rate_1" class="text_boxes_numeric" value="" style="width:45px;" onKeyUp="calculate_amount(1)" <? echo $disable; ?> />
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_1" class="text_boxes_numeric" value="" style="width:75px;" <? echo $disable; ?> readonly/>
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_1" readonly/>
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                    <td width="65">
                        <input type="button" name="increase[]" id="increase_1" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( 1 )" />
                        <input type="button" name="decrease[]" id="decrease_1" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(1);" />
                    </td>
                    <?
                    }
                    ?>
                </tr>
            <?
            }
			else
			{
				foreach ($nameArray as $row)
				{
					$colorIds[$row[csf('yarn_color')]]=$row[csf('yarn_color')];
				}

				if(count($colorIds)>0)
				{
					$colorIds=implode(",",$colorIds);
				}
				else $colorIds=0;

				$color_array=return_library_array("select id,color_name from lib_color WHERE id in($colorIds) and status_active=1 and is_deleted=0",'id','color_name');

				$data_array=sql_select("select goods_rcv_status, total_amount, upcharge, upcharge_breakdown, discount, discount_breakdown, net_total_amount from com_pi_master_details where id='$pi_id'");
				$tot_amnt=$data_array[0][csf('total_amount')];
				$upcharge=$data_array[0][csf('upcharge')];
				$upcharge_breakdown=$data_array[0][csf('upcharge_breakdown')];
				$discount=$data_array[0][csf('discount')];
				$discount_breakdown=$data_array[0][csf('discount_breakdown')];
				$tot_amnt_net=$data_array[0][csf('net_total_amount')];
				$goods_rcv_status=$data_array[0][csf('goods_rcv_status')];
				if($db_type==2 && ($goods_rcv_status==1 && $goods_rcv_variable!=1)){
					$row[csf('id')] = $row[csf('id')]->load();
					$row[csf('work_order_dtls_id')] = $row[csf('work_order_dtls_id')]->load();
				} 
				if( $pi_basis_id == 1 )
				{
					$wo_dtls_id='';
					foreach ($nameArray as $row)
					{
						$wo_dtls_id.=$row[csf('work_order_dtls_id')].',';
					}
					$wo_dtls_id=chop($wo_dtls_id,',');

					$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=24 and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and a.status_active=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");

					if($goods_rcv_status==2 && $goods_rcv_variable==1)
					{
						$wo_qty_arr=return_library_array("select id, yarn_wo_qty as qty from wo_yarn_dyeing_dtls where id in($wo_dtls_id) and status_active=1 and is_deleted=0", "id", "qty");
					}
					else
					{
						$wo_qty_arr=return_library_array("select id, order_qnty as qty from inv_transaction where id in($wo_dtls_id) and status_active=1 and is_deleted=0", "id", "qty");
					}

				}else
				{
					$mrr_check=return_field_value("id", "inv_receive_master", "booking_id=$pi_id and entry_form=1 and receive_basis=1 and status_active=1","id");
					if($mrr_check!=""){ $disable_mrr_check="disabled='disabled'"; $disable_status=1;} else $disable_mrr_check="";
				}
				$disable_data=$checkBox_check="";
				if($goods_rcv_variable==1 && $goods_rcv_status==1)
				{
					$disable_data="disabled='disabled'";
					$checkBox_check="checked";
				}
				$i=1;
				foreach ($nameArray as $row)
				{
					$bl_qty='';
				?>
                    <tr class="general" id="row_<? echo $i; ?>">
                        <?
                        if( $pi_basis_id == 1 )
                        {
                        ?>
                            <td>
                                <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $i; ?>" value="" <? echo $disable_data." ".$checkBox_check; ?> />
                            </td>
                            <td>
                                <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:115px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $i; ?>);" <? echo $disable_mrr_check;?> readonly />
                                <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $i; ?>" readonly value="<? echo $row[csf('work_order_id')]; ?>" />
                                <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $i;?>" readonly value="<? echo $row[csf('work_order_dtls_id')];?>"/>
                                <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $i; ?>" value="" readonly />
                                <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $i; ?>" value="<? echo $row[csf('booking_without_order')]; ?>" readonly />
                            </td>
                        <?
							$bl_qty=$wo_qty_arr[$row[csf('work_order_dtls_id')]]-$prev_pi_qty_arr[$row[csf('work_order_dtls_id')]]+$row[csf('quantity')];
                        }
                        ?>
                        <td>
                            <input type="text" name="lot[]" id="lot_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('lot_no')];?>" style="width:80px" maxlength="200" <? echo $disable; ?> onDblClick="openmypage_item_desc(<? echo $i; ?>);" placeholder="<? echo $placeholder; ?>" readonly/>
                            <input type="hidden" name="itemProdId[]" id="itemProdId_<? echo $i; ?>" readonly value="<? echo $row[csf('item_prod_id')];?>"/>
                        </td>
                        <td>
                            <? echo create_drop_down( "countName_".$i, 90, $count_arr, '', 1, '-Select-', $row[csf('count_name')], "", 1, '', '', '', '', '', '', 'countName[]'); ?>
                        </td>
                        <td>
                            <input type="text" name="itemdescription[]" id="itemdescription_<? echo $i; ?>" class="text_boxes" style="width:200px" value="<? echo $row[csf('item_description')];?>" disabled/>
                        </td>
                        <td>
                            <? //echo create_drop_down( "yarnColor_".$i, 110, $color_array,'', 1, '-Select-', $row[csf('yarn_color')],"",$disable_status); ?>
                            <input type="text" name="colorName[]" id="colorName_<? echo $i; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $i; ?> )" style="width:100px;" onBlur="fn_add_color_id(<? echo $i; ?>)"  maxlength="50" value="<? echo $color_array[$row[csf('yarn_color')]]; ?>" title="<? echo $color_array[$row[csf('yarn_color')]]; ?>"  <? if($row[csf('work_order_id')]>0) echo "disabled='disabled'"; echo $is_disable; echo $disable_data; ?> />
                            <input type="hidden" name="colorId[]" id="colorId_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('yarn_color')]; ?>"/>
                        </td>
                        <td>
                            <? echo create_drop_down( "colorRange_".$i, 110, $color_range, '', 1, '-Select-', $row[csf('color_range')], "", $disable_status, '', '', '', '', '', '', 'colorRange[]'); ?>
                        </td>
                        <td>
                            <?
								echo create_drop_down( "uom_".$i, 60, $unit_of_measurement, '', 0, '', $row[csf('uom')], '', 1, 12, '', '', '', '', '', 'uom[]');
                            ?>
                        </td>
                        <td>
                            <input type="text" name="quantity[]" id="quantity_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $i; ?>)" placeholder="<? echo $bl_qty; ?>" <? echo $disable_field;?> <? echo $disable_data; ?> />
                        </td>
                        <td>
                            <input type="text" name="rate[]" id="rate_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:45px;" onKeyUp="calculate_amount(<? echo $i; ?>)" <? echo $disable; ?> />
                        </td>
                        <td>
                            <input type="text" name="amount[]" id="amount_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:75px;" <? echo $disable; ?> readonly/>
                            <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $i; ?>" readonly value="<? echo $row[csf('id')]; ?>"/>
                        </td>
                        <?
                        if( $pi_basis_id == 2 )
                        {
                        ?>
                        <td width="65">
                            <input type="button" name="increase[]" id="increase_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( <? echo $i; ?> )" />
                            <input type="button" name="decrease[]" id="decrease_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(<? echo $i; ?>);" />
                        </td>
                        <?
                        }
                        ?>
                    </tr>
            	<?
				$i++;
				}
				$txt_tot_row=$i-1;
			}
			?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td>
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amnt; ?>" style="width:75px;" readonly/>
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td>
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo number_format($upcharge,4,'.',''); //$upcharge; ?>" style="width:75px;" onDblClick="fn_upcharge(1)" onKeyUp="calculate_total_amount(2);fn_break_data_change(1);" placeholder="Browse or Write" />
                    <input type="hidden" name="up_charge_break_down" id="up_charge_break_down" value="<? echo $upcharge_breakdown; ?>" />
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td>
                         <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo number_format($discount,4,'.','');  //$discount; ?>" style="width:85px;" onDblClick="fn_upcharge(2)" onKeyUp="calculate_total_amount(2);fn_break_data_change(2);" placeholder="Browse or Write"/>
                    <input type="hidden" name="discount_break_down" id="discount_break_down" value="<? echo $discount_breakdown; ?>" />
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td>
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $tot_amnt_net; ?>" style="width:75px;" readonly/>
                    </td>
                    <?
                    if($pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
        	</tfoot>
            <?
		}
		// 25=Services - Embellishment, 102=Services - Printing, 103=Services - Wash, 104=Services - Embroidery
		else if($item_category_id==25 || $item_category_id==102 || $item_category_id==103 || $item_category_id==104)
		{
			?>
         	<thead>
				<?
                if($pi_basis_id == 1)
                {
                ?>
                    <th>&nbsp;</th>
                    <th>WO</th>
                <?
                }
                ?>
                <th class="must_entry_caption">Gmts Item</th>
                <th class="must_entry_caption">Embellishment Name</th>
                <th class="must_entry_caption">Embellishment Type</th>
                <th>Gmts Color</th>
                <th>UOM</th>
                <th class="must_entry_caption">Quantity</th>
                <th class="must_entry_caption">Rate</th>
                <th>Amount</th>
                <?
                if($pi_basis_id == 2 )
                {
                ?>
                    <th></th>
                <?
                }
                ?>
            </thead>
            <tbody>
       	    <?
            if($pi_basis_id==2)
            {
               $disable="";
               $disable_status=0;
            }
            else
            {
				$disable="disabled='disabled'";
                $disable_status=1;
            }

			$nameArray=sql_select( "select id, work_order_no, work_order_id, work_order_dtls_id, color_id, gmts_item_id, embell_name, embell_type, uom, quantity, rate, amount from com_pi_item_details where pi_id='$pi_id' and status_active=1 and is_deleted=0" );

			if($type==1 || count($nameArray)<1)
            {
				$tot_amnt=''; $upcharge=$upcharge_breakdown=''; $discount=''; $tot_amnt_net=''; $txt_tot_row=0;
            	?>
                <tr class="general" id="row_1">
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>
                            <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_1" value="" />
                        </td>
                        <td>
                            <input type="text" name="workOrderNo[]" id="workOrderNo_1" class="text_boxes" value="" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(1);" readonly />
                            <input type="hidden" name="hideWoId[]" id="hideWoId_1" readonly />
                            <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_1" readonly />
                        </td>
                    <?
                    }
                    ?>
                    <td>
                    	<? echo create_drop_down( "gmtsitem_1", 150, $garments_item, '', 1, '-Select-', 0, "", $disable_status, '', '', '', '', '', '', 'gmtsitem[]'); ?>
                    </td>
                    <td>
                    	<? echo create_drop_down( "embellname_1", 130, $emblishment_name_array, '', 1, '-Select-', 0, "load_drop_down( 'requires/pi_controller_urmi', this.value+'**'+".$disable_status."+'**'+'embelltype[]', 'load_drop_down_embelltype', 'embelltypeTd_1');", $disable_status, '', '', '', '', '', '', 'embellname[]'); ?>
                    </td>
                    <td id="embelltypeTd_1">
                    	<? echo create_drop_down( "embelltype_1", 130, $blank_array, '', 1, '-Select-', 0, "", $disable_status, '', '', '', '', '', '', 'embelltype[]'); ?>
                    </td>
                    <td>
                        <input type="text" name="colorName[]" id="colorName_1" class="text_boxes" value="" onFocus="add_auto_complete( 1 )" style="width:90px;" maxlength="50" <? echo $disable; ?>/>
                    </td>
                    <td>
                        <?
							echo create_drop_down( "uom_1", 70, $unit_of_measurement, '', 0, '', 0, '', 1, '', '', '', '', '', '', 'uom[]');
                        ?>
                    </td>
                    <td>
                        <input type="text" name="quantity[]" id="quantity_1" class="text_boxes_numeric" value="" style="width:81px;" onKeyUp="calculate_amount(1)" />
                    </td>
                    <td>
                        <input type="text" name="rate[]" id="rate_1" class="text_boxes_numeric" value="" style="width:50px;" onKeyUp="calculate_amount(1)" <? echo $disable; ?> />
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_1" class="text_boxes_numeric" value="" style="width:85px;" <? echo $disable; ?> readonly/>
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_1" readonly/>
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    	?>
	                    <td width="65">
	                        <input type="button" name="increase[]" id="increase_1" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( 1 )" />
	                        <input type="button" name="decrease[]" id="decrease_1" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(1);" />
	                    </td>
                    	<?
                    }
                    ?>
                </tr>
            <?
            }
			else
			{
				$data_array=sql_select("select total_amount, upcharge, upcharge_breakdown, discount, discount_breakdown, net_total_amount from com_pi_master_details where id='$pi_id'");
				$tot_amnt=$data_array[0][csf('total_amount')];
				$upcharge=$data_array[0][csf('upcharge')];
				$upcharge_breakdown=$data_array[0][csf('upcharge_breakdown')];
				$discount=$data_array[0][csf('discount')];
				$discount_breakdown=$data_array[0][csf('discount_breakdown')];
				$tot_amnt_net=$data_array[0][csf('net_total_amount')];

				if( $pi_basis_id == 1 )
				{
					$wo_dtls_id='';
					foreach ($nameArray as $row)
					{
						$wo_dtls_id.=$row[csf('work_order_dtls_id')].',';
					}
					$wo_dtls_id=chop($wo_dtls_id,',');

					$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=25 and a.pi_basis_id=1 and a.status_active=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");

					$wo_qty_arr=return_library_array("select id, wo_qnty as qty from wo_booking_dtls where id in($wo_dtls_id) and status_active=1 and is_deleted=0", "id", "qty");
				}

				$i=1;
				foreach ($nameArray as $row)
				{
					$bl_qty='';
				?>
                    <tr class="general" id="row_<? echo $i; ?>">
                        <?
                        if( $pi_basis_id == 1 )
                        {
                        ?>
                            <td>
                                <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $i; ?>" value="" />
                            </td>
                            <td>
                                <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $i; ?>);" readonly />
                                <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $i; ?>" readonly value="<? echo $row[csf('work_order_id')]; ?>" />
                                <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $i;?>" readonly value="<? echo $row[csf('work_order_dtls_id')];?>"/>
                            </td>
                        <?
							$bl_qty=$wo_qty_arr[$row[csf('work_order_dtls_id')]]-$prev_pi_qty_arr[$row[csf('work_order_dtls_id')]]+$row[csf('quantity')];
                        }
                        ?>
                        <td>
                        	<? echo create_drop_down( "gmtsitem_".$i, 150, $garments_item, '', 1, '-Select-', $row[csf('gmts_item_id')], "", $disable_status, '', '', '', '', '', '', 'gmtsitem[]'); ?>
                        </td>
                        <td>
                            <? echo create_drop_down( "embellname_".$i, 130, $emblishment_name_array, '', 1, '-Select-', $row[csf('embell_name')],"load_drop_down( 'requires/pi_controller_urmi', this.value+'**'+".$disable_status."+'**'+'embelltype[]', 'load_drop_down_embelltype', 'embelltypeTd_$i');", $disable_status, '', '', '', '', '', '', 'embellname[]'); ?>
                        </td>
                        <td id="embelltypeTd_<? echo $i; ?>">
                        	<?
								$emb_arr=array();
								if($row[csf('embell_name')]==1) $emb_arr=$emblishment_print_type;
								else if($row[csf('embell_name')]==2) $emb_arr=$emblishment_embroy_type;
								else if($row[csf('embell_name')]==3) $emb_arr=$emblishment_wash_type;
								else if($row[csf('embell_name')]==4) $emb_arr=$emblishment_spwork_type;
								else if($row[csf('embell_name')]==5) $emb_arr=$emblishment_gmts_type;
								else $emb_arr=$blank_array;

								echo create_drop_down( "embelltype_".$i, 130, $emb_arr, '', 1, '-Select-', $row[csf('embell_type')], "", $disable_status, '', '', '', '', '', '', 'embelltype[]');
							?>
                        </td>
                        <td>
                            <input type="text" name="colorName[]" id="colorName_<? echo $i; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $i; ?> )" style="width:90px" maxlength="50" <? echo $disable; ?> value="<? echo $color_library[$row[csf('color_id')]]; ?>"/>
                        </td>
                        <td>
                            <?
								echo create_drop_down( "uom_".$i, 70, $unit_of_measurement, '', 0, '', $row[csf('uom')], '', 1, '', '', '', '', '', '', 'uom[]');
                            ?>
                        </td>
                        <td>
                            <input type="text" name="quantity[]" id="quantity_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo number_format($row[csf('quantity')],6,'.',''); ?>" style="width:81px;" onKeyUp="calculate_amount(<? echo $i; ?>)" placeholder="<? echo $bl_qty; ?>" />
                        </td>
                        <td>
                            <input type="text" name="rate[]" id="rate_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:50px;" onKeyUp="calculate_amount(<? echo $i; ?>)" <? echo $disable; ?> />
                        </td>
                        <td>
                            <input type="text" name="amount[]" id="amount_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:85px;" <? echo $disable; ?> readonly/>
                            <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $i; ?>" readonly value="<? echo $row[csf('id')]; ?>"/>
                        </td>
                        <?
                        if( $pi_basis_id == 2 )
                        {
                        ?>
                        <td width="65">
                            <input type="button" name="increase[]" id="increase_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( <? echo $i; ?> )" />
                            <input type="button" name="decrease[]" id="decrease_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(<? echo $i; ?>);" />
                        </td>
                        <?
                        }
                        ?>
                    </tr>
            	<?
				$i++;
				}
				$txt_tot_row=$i-1;
			}
			?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo number_format($tot_amnt,4,'.',''); ?>" style="width:85px;" readonly/>
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo number_format($upcharge,4,'.',''); //$upcharge; ?>" style="width:75px;" onDblClick="fn_upcharge(1)" onKeyUp="calculate_total_amount(2);fn_break_data_change(1);" placeholder="Browse or Write" />
                    <input type="hidden" name="up_charge_break_down" id="up_charge_break_down" value="<? echo $upcharge_breakdown; ?>" />
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo number_format($discount,4,'.','');  //$discount; ?>" style="width:85px;" onDblClick="fn_upcharge(2)" onKeyUp="calculate_total_amount(2);fn_break_data_change(2);" placeholder="Browse or Write"/>
                    <input type="hidden" name="discount_break_down" id="discount_break_down" value="<? echo $discount_breakdown; ?>" />
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo number_format($tot_amnt_net,4,'.',''); ?>" style="width:85px;" readonly/>
                    </td>
                    <?
                    if($pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
        	</tfoot>
            <?
		}
		else if($item_category_id==31 || $item_category_id==115)  // Services Lab Test, Services Inspection
		{
			$test_item_arr=return_library_array( "SELECT id,test_item FROM lib_lab_test_rate_chart",'id','test_item');
		 	?>
        	<thead>
				<?
                if($pi_basis_id == 1)
                {
                ?>
                    <th>&nbsp;</th>
                    <th>WO</th>
                <?
                }
                ?>
                <th class="must_entry_caption" style="color:blue">Test For</th>
                <th>Remarks</th>
                <th>Color</th>
                <th>Test Item</th>
                <th>Amount</th>
                <?
                if( $pi_basis_id == 2 )
                {
                	?>
                    <th></th>
                	<?
                }
                ?>
            </thead>
            <tbody>
       	    <?
            if($pi_basis_id==2)
            {
                $disable="";
				$disableCombo=0;
				$placeholder="Doublic Click";
            }
            else
            {
				$disable="disabled='disabled'";
				$disableCombo=1;
				$placeholder="Display";
            }

			$nameArray=sql_select( "select id, work_order_no, work_order_id, work_order_dtls_id, test_for, test_item_id, remarks, color_id, amount from com_pi_item_details where pi_id='$pi_id' and status_active=1 and is_deleted=0" );

			if($type==1 || count($nameArray)<1)
            {
				$tot_amnt=''; $upcharge=$upcharge_breakdown=''; $discount=''; $tot_amnt_net=''; $txt_tot_row=0;
            ?>
                <tr class="general" id="row_1">
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>
                            <input type="checkbox" name="workOrderChkbox_1" id="workOrderChkbox_1" value="" />
                        </td>
                        <td>
                            <input type="text" name="workOrderNo[]" id="workOrderNo_1" class="text_boxes" value="" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(1);" readonly />
                            <input type="hidden" name="hideWoId[]" id="hideWoId_1" readonly />
                            <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_1" readonly />
                        </td>
                    <?
                    }
                    ?>
                    <td>
						 <?
                            echo create_drop_down( "cboTestFor_1", 140, $test_for, '', 1, '-Select-', 0, "", $disableCombo, '', '', '', '', '', '', 'cboTestFor[]');
                         ?>
                    </td>
                    <td>

                        <input type="text" name="remarks[]" id="remarks_1" class="text_boxes" value="" style="width:170px;" maxlength="250" <? echo $disable; ?>/>
                    </td>
                    <td>
                        <input type="text" name="colorName[]" id="colorName_1" class="text_boxes" value="" style="width:100px;" maxlength="100" <? echo $disable; ?> />
                    </td>
                    <td>
                        <input type="text" name="txtTestItem[]" id="txtTestItem_1" class="text_boxes" value="" style="width:200px" maxlength="200" <? echo $disable; ?> onDblClick="openmypage_test_item(1);" placeholder="<? echo $placeholder; ?>" readonly/>
                        <input type="hidden" name="testItemId[]" id="testItemId_1" readonly value=""/>
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_1" class="text_boxes_numeric" value="" style="width:85px;" onKeyUp="calculate_total_amount(1);" <? echo $disable; ?> />
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_1" readonly/>
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                    <td width="65">
                        <input type="button" name="increase[]" id="increase_1" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( 1 )" />
                        <input type="button" name="decrease[]" id="decrease_1" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(1);" />
                    </td>
                    <?
                    }
                    ?>
                </tr>
            <?
            }
			else
			{
				$data_array=sql_select("select total_amount, upcharge, upcharge_breakdown, discount, discount_breakdown, net_total_amount from com_pi_master_details where id='$pi_id'");
				$tot_amnt=$data_array[0][csf('total_amount')];
				$upcharge=$data_array[0][csf('upcharge')];
				$upcharge_breakdown=$data_array[0][csf('upcharge_breakdown')];
				$discount=$data_array[0][csf('discount')];
				$discount_breakdown=$data_array[0][csf('discount_breakdown')];
				$tot_amnt_net=$data_array[0][csf('net_total_amount')];

				if( $pi_basis_id == 1 )
				{
					$wo_dtls_id='';
					foreach ($nameArray as $row)
					{
						$wo_dtls_id.=$row[csf('work_order_dtls_id')].',';
					}
					$wo_dtls_id=chop($wo_dtls_id,',');

					$prev_pi_amnt_arr=return_library_array( "select b.work_order_dtls_id,sum(b.amount) as amount from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=31 and a.pi_basis_id=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "amount");

					$wo_amnt_arr=return_library_array("select id, wo_value as amnt from wo_labtest_dtls where id in($wo_dtls_id)", "id", "amnt");
				}

				$i=1;
				foreach ($nameArray as $row)
				{
				?>
                    <tr class="general" id="row_<? echo $i; ?>">
                        <?
                        if( $pi_basis_id == 1 )
                        {
                        ?>
                            <td>
                                <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $i; ?>" value="" />
                            </td>
                            <td>
                                <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $i; ?>);" readonly />
                                <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $i; ?>" readonly value="<? echo $row[csf('work_order_id')]; ?>" />
                                <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $i;?>" readonly value="<? echo $row[csf('work_order_dtls_id')];?>"/>
                            </td>
                        <?
							$bl_amnt=$wo_amnt_arr[$row[csf('work_order_dtls_id')]]-$prev_pi_amnt_arr[$row[csf('work_order_dtls_id')]]+$row[csf('amount')];
                        }
                        ?>
                        <td>
							 <?
                                echo create_drop_down( "cboTestFor_".$i, 140, $test_for, '', 1, '-Select-', $row[csf('test_for')], "", $disableCombo, '', '', '', '', '', '', 'cboTestFor[]');
                             ?>
                        </td>
                        <td>
                            <input type="text" name="remarks[]" id="remarks_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('remarks')]; ?>" style="width:170px;" maxlength="250" <? echo $disable; ?>/>
                        </td>
                        <td>
                            <input type="text" name="colorName[]" id="colorName_<? echo $i; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('color_id')]]; ?>" style="width:100px;" maxlength="100" <? echo $disable; ?> />
                        </td>
                        <td>
                        	<?
								$test_item='';
								$test_item_ids=array_unique(explode(",",$row[csf('test_item_id')]));
								foreach($test_item_ids as $test_item_id)
								{
									$test_item.=$test_item_arr[$test_item_id].",";
								}
								$test_item=chop($test_item,',');
							?>
                            <input type="text" name="txtTestItem[]" id="txtTestItem_<? echo $i; ?>" class="text_boxes" value="<? echo $test_item; ?>" style="width:200px" maxlength="200" <? echo $disable; ?> onDblClick="openmypage_test_item(<? echo $i; ?>);" placeholder="<? echo $placeholder; ?>" readonly/>
                            <input type="hidden" name="testItemId[]" id="testItemId_<? echo $i; ?>" readonly value="<? echo $row[csf('test_item_id')]; ?>"/>
                        </td>
                        <td>
                            <input type="text" name="amount[]" id="amount_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:85px;" onKeyUp="check_amount(<? echo $i; ?>);" placeholder="<? echo $bl_amnt; ?>" <? echo $disable; ?> />
                            <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $i; ?>" readonly value="<? echo $row[csf('id')]; ?>"/>
                        </td>
                        <?
                        if( $pi_basis_id == 2 )
                        {
                        ?>
                        <td width="65">
                            <input type="button" name="increase[]" id="increase_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( <? echo $i; ?> )" />
                            <input type="button" name="decrease[]" id="decrease_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(<? echo $i; ?>);" />
                        </td>
                        <?
                        }
                        ?>
                    </tr>
            	<?
				$i++;
				}
				$txt_tot_row=$i-1;
			}
			?>
            </tbody>
            <tfoot class="tbl_bottom">
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Total</td>
                <td style="text-align:center">
                    <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amnt; ?>" style="width:85px;" readonly/>
                </td>
                <?
                if( $pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Upcharge</td>
                <td style="text-align:center">
                    <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo number_format($upcharge,4,'.',''); //$upcharge; ?>" style="width:75px;" onDblClick="fn_upcharge(1)" onKeyUp="calculate_total_amount(2);fn_break_data_change(1);" placeholder="Browse or Write" />
                    <input type="hidden" name="up_charge_break_down" id="up_charge_break_down" value="<? echo $upcharge_breakdown; ?>" />
                </td>
                <?
                if( $pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Discount</td>
                <td style="text-align:center">
                    <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo number_format($discount,4,'.',''); ?>" style="width:85px;" onDblClick="fn_upcharge(2)" onKeyUp="calculate_total_amount(2);fn_break_data_change(2);" placeholder="Browse or Write" />
                    <input type="hidden" name="discount_break_down" id="discount_break_down" value="<? echo $discount_breakdown; ?>" />
                </td>
                <?
                if( $pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            <tr>
                <?
                if( $pi_basis_id == 1 )
                {
                ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <?
                }
                ?>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>Net Total</td>
                <td style="text-align:center">
                    <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $tot_amnt_net; ?>" style="width:85px;" readonly/>
                </td>
                <?
                if($pi_basis_id == 2 )
                {
                ?>
                    <td width="65">&nbsp;</td>
                <?
                }
                ?>
            </tr>
            </tfoot>
            <?
		}
		else if($item_category_id==116)  // Services - Garments
		{
			?>
         	<thead>
				<th>&nbsp;</th>
                <th>WO</th>
                <th>Item Name</th>
                <th>Process</th>
                <th>UOM</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Amount</th>
            </thead>
            <tbody>
       	    <?
            if($pi_basis_id==2)
            {
                $disable="";
                $disable_status=0;
            }
            else
            {

				$disable="disabled='disabled'";
                $disable_status=1;
            }

			$nameArray=sql_select( "select ID, WORK_ORDER_NO, WORK_ORDER_ID, WORK_ORDER_DTLS_ID, GMTS_ITEM_ID, TEST_ITEM_ID, UOM, QUANTITY, RATE, AMOUNT from com_pi_item_details where pi_id='$pi_id' and status_active=1 and is_deleted=0" );

			if($type==1 || count($nameArray)<1)
            {
				$tot_amnt=''; $upcharge=''; $upcharge_breakdown=''; $discount=''; $tot_amnt_net=''; $txt_tot_row=0;
            	?>
                <tr class="general" id="row_1">
                    <td>
                        <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_1" value="" />
                    </td>
                    <td>
                        <input type="text" name="workOrderNo[]" id="workOrderNo_1" class="text_boxes" value="" style="width:130px;" placeholder="Dbl click" onDblClick="openmypage_wo(1);" readonly />
                        <input type="hidden" name="hideWoId[]" id="hideWoId_1" readonly />
                        <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_1" readonly />
                    </td>
                    <td>
                        <input type="text" name="itemdescription[]" id="itemdescription_1" class="text_boxes" value="" style="width:200px" readonly />
                    </td>
                    <td>
                        <input type="text" name="processName[]" id="processName_1" class="text_boxes"  value="" style="width:200px" readonly />
                    </td>
                    <td>
                        <?
                            echo create_drop_down( "uom_1", 70, $unit_of_measurement, '', 0, '', 0, '', 0, '', '', '', '', '', '', 'uom[]');
                        ?>
                    </td>
                    <td>
                        <input type="text" name="quantity[]" id="quantity_1" class="text_boxes_numeric" value="" style="width:80px;" onKeyUp="calculate_amount(1)" />
                    </td>
                    <td>
                        <input type="text" name="rate[]" id="rate_1" class="text_boxes_numeric" value="" style="width:70px;" onKeyUp="calculate_amount(1)" <? echo $disable; ?> />
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_1" class="text_boxes_numeric" value="" style="width:90px;" <? echo $disable; ?> readonly/>
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_1" readonly/>
                    </td>
                </tr>
            	<?
            }
			else
			{
				$tot_amnt=''; $upcharge=''; $upcharge_breakdown=''; $discount=''; $tot_amnt_net=''; $txt_tot_row=0;
				$data_array=sql_select("select total_amount, upcharge, upcharge_breakdown, discount, discount_breakdown, net_total_amount from com_pi_master_details where id='$pi_id'");
				$tot_amnt=$data_array[0][csf('total_amount')];
				$upcharge=$data_array[0][csf('upcharge')];
				$upcharge_breakdown=$data_array[0][csf('upcharge_breakdown')];
				$discount=$data_array[0][csf('discount')];
				$discount_breakdown=$data_array[0][csf('discount_breakdown')];
				$tot_amnt_net=$data_array[0][csf('net_total_amount')];

				$wo_dtls_id=''; $wo_dtls_id2=''; $wo_dtls_id_all='';
				foreach ($nameArray as $row)
				{

					$wo_dtls_id_all.=$row[csf('work_order_dtls_id')].',';
				}
				$wo_dtls_id_all=chop($wo_dtls_id_all,',');

				$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.status_active=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id_all) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");

				$wo_qty_arr=return_library_array("select id, wo_qnty as qty from wo_booking_dtls where id in($wo_dtls_id) and status_active=1 and is_deleted=0", "id", "qty");

				$i=1;
				foreach ($nameArray as $row)
				{
					$tot_amnt=''; $upcharge=''; $upcharge_breakdown=''; $discount=''; $tot_amnt_net=''; $txt_tot_row=0;
					
					$bl_qty=$wo_qty_arr[$row[csf('work_order_dtls_id')]]-$prev_pi_qty_arr[$row[csf('work_order_dtls_id')]]+$row[csf('quantity')];
					$all_process_name="";
					$process_id_arr=explode(",",$row['TEST_ITEM_ID']);
					foreach($process_id_arr as $process_id)
					{
						$all_process_name.=$rate_for[$process_id].",";
					}
					?>
                    <tr class="general" id="row_<? echo $i; ?>">
                        <td>
                            <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $i; ?>" value="" />
                        </td>
                        <td>
                            <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $i; ?>" class="text_boxes" value="<? echo $row['WORK_ORDER_NO']; ?>" style="width:130px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $i; ?>);" readonly />
                            <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $i; ?>" readonly value="<? echo $row['WORK_ORDER_ID']; ?>" />
                            <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $i;?>" readonly value="<? echo $row['WORK_ORDER_DTLS_ID'];?>"/>
                        </td>    
                        <td>
                            <input type="text" name="itemdescription[]" id="itemdescription_<? echo $i; ?>" class="text_boxes" value="<? echo $garments_item[$row['GMTS_ITEM_ID']]; ?>" title="<?= $row['GMTS_ITEM_ID'];?>" style="width:200px" />
                        </td>
                        <td>
 							<input type="text" name="processName[]" id="processName_<? echo $i; ?>" class="text_boxes"   value="<? echo $all_process_name; ?>" title="<?= $row['TEST_ITEM_ID'];?>"  style="width:200px" readonly />
                        </td>
                        <td>
                            <?
                                echo create_drop_down( "uom_".$i, 80, $unit_of_measurement, '', 0, '', $row[csf('uom')], '', $disable_status, '', '', '', '', '', '', 'uom[]');
                            ?>
                        </td>
                        <td>
                            <input type="text" name="quantity[]" id="quantity_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:80px;" onKeyUp="calculate_amount(<? echo $i; ?>)" placeholder="<? echo $bl_qty; ?>" />
                        </td>
                        <td>
                            <input type="text" name="rate[]" id="rate_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:70px;" onKeyUp="calculate_amount(<? echo $i; ?>)" <? echo $disable; ?> />
                        </td>
                        <td>
                            <input type="text" name="amount[]" id="amount_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:90px;" <? echo $disable; ?> readonly/>
                            <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $i; ?>" readonly value="<? echo $row[csf('id')]; ?>"/>
                            <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $i; ?>" value="<? echo $row[csf('booking_without_order')]; ?>"/>
                        </td>
                    </tr>
					<?
                    $i++;
				}
				$txt_tot_row=$i-1;
			}
			?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td>
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amnt; ?>" style="width:90px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td>
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo number_format($upcharge,4,'.',''); //$upcharge; ?>" style="width:90px;" onDblClick="fn_upcharge(1)" onKeyUp="calculate_total_amount(2);fn_break_data_change(1);" placeholder="Browse or Write" />
                    <input type="hidden" name="up_charge_break_down" id="up_charge_break_down" value="<? echo $upcharge_breakdown; ?>" />
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td>
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo number_format($discount,4,'.','');  //$discount; ?>" style="width:90px;" onDblClick="fn_upcharge(2)" onKeyUp="calculate_total_amount(2);fn_break_data_change(2);" placeholder="Browse or Write"/>
                    <input type="hidden" name="discount_break_down" id="discount_break_down" value="<? echo $discount_breakdown; ?>" />
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td>
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $tot_amnt_net; ?>" style="width:90px;" readonly/>
                    </td>
                </tr>
        	</tfoot>
            <?
		}
		else if($item_category_id==100)  // Sweater Services - Garments
		{
			?>
         	<thead>
				<th>&nbsp;</th>
                <th>WO</th>
                <th>Item Name</th>
                <th>Process</th>
                <th>UOM</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Amount</th>
            </thead>
            <tbody>
       	    <?
            if($pi_basis_id==2)
            {
                $disable="";
                $disable_status=0;
            }
            else
            {

				$disable="disabled='disabled'";
                $disable_status=1;
            }

			$nameArray=sql_select( "select ID, WORK_ORDER_NO, WORK_ORDER_ID, WORK_ORDER_DTLS_ID, GMTS_ITEM_ID, ITEM_DESCRIPTION, TEST_ITEM_ID, UOM, QUANTITY, RATE, AMOUNT from com_pi_item_details where pi_id='$pi_id' and status_active=1 and is_deleted=0" );

			if($type==1 || count($nameArray)<1)
            {
				$tot_amnt=''; $upcharge=''; $upcharge_breakdown=''; $discount=''; $tot_amnt_net=''; $txt_tot_row=0;
            	?>
                <tr class="general" id="row_1">
                    <td>
                        <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_1" value="" />
                    </td>
                    <td>
                        <input type="text" name="workOrderNo[]" id="workOrderNo_1" class="text_boxes" value="" style="width:130px;" placeholder="Dbl click" onDblClick="openmypage_wo(1);" readonly />
                        <input type="hidden" name="hideWoId[]" id="hideWoId_1" readonly />
                        <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_1" readonly />
                    </td>
                    <td>
                        <input type="text" name="itemdescription[]" id="itemdescription_1" class="text_boxes" value="" style="width:200px" readonly />
                    </td>
                    <td>
                        <input type="text" name="processName[]" id="processName_1" class="text_boxes"  value="" style="width:200px" readonly />
                    </td>
                    <td>
                        <?
                            echo create_drop_down( "uom_1", 70, $unit_of_measurement, '', 0, '', 0, '', 0, '', '', '', '', '', '', 'uom[]');
                        ?>
                    </td>
                    <td>
                        <input type="text" name="quantity[]" id="quantity_1" class="text_boxes_numeric" value="" style="width:80px;" onKeyUp="calculate_amount(1)" />
                    </td>
                    <td>
                        <input type="text" name="rate[]" id="rate_1" class="text_boxes_numeric" value="" style="width:70px;" onKeyUp="calculate_amount(1)" <? echo $disable; ?> />
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_1" class="text_boxes_numeric" value="" style="width:90px;" <? echo $disable; ?> readonly/>
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_1" readonly/>
                    </td>
                </tr>
            	<?
            }
			else
			{
				$tot_amnt=''; $upcharge=''; $upcharge_breakdown=''; $discount=''; $tot_amnt_net=''; $txt_tot_row=0;
				$data_array=sql_select("select total_amount, upcharge, upcharge_breakdown, discount, discount_breakdown, net_total_amount from com_pi_master_details where id='$pi_id'");
				$tot_amnt=$data_array[0][csf('total_amount')];
				$upcharge=$data_array[0][csf('upcharge')];
				$upcharge_breakdown=$data_array[0][csf('upcharge_breakdown')];
				$discount=$data_array[0][csf('discount')];
				$discount_breakdown=$data_array[0][csf('discount_breakdown')];
				$tot_amnt_net=$data_array[0][csf('net_total_amount')];

				$wo_dtls_id=''; $wo_dtls_id2=''; $wo_dtls_id_all='';
				foreach ($nameArray as $row)
				{

					$wo_dtls_id_all.=$row[csf('work_order_dtls_id')].',';
				}
				$wo_dtls_id_all=chop($wo_dtls_id_all,',');

				$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.status_active=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id_all) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");

				$wo_qty_arr=return_library_array("select id, wo_qnty as qty from wo_booking_dtls where id in($wo_dtls_id) and status_active=1 and is_deleted=0", "id", "qty");

				$i=1;
				foreach ($nameArray as $row)
				{
					$tot_amnt=''; $upcharge=''; $upcharge_breakdown=''; $discount=''; $tot_amnt_net=''; $txt_tot_row=0;
					
					$bl_qty=$wo_qty_arr[$row[csf('work_order_dtls_id')]]-$prev_pi_qty_arr[$row[csf('work_order_dtls_id')]]+$row[csf('quantity')];
					$all_process_name="";
					$process_id_arr=explode(",",$row['TEST_ITEM_ID']);
					foreach($process_id_arr as $process_id)
					{
						$all_process_name.=$rate_for[$process_id].",";
					}
					?>
                    <tr class="general" id="row_<? echo $i; ?>">
                        <td>
                            <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $i; ?>" value="" />
                        </td>
                        <td>
                            <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $i; ?>" class="text_boxes" value="<? echo $row['WORK_ORDER_NO']; ?>" style="width:130px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $i; ?>);" readonly />
                            <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $i; ?>" readonly value="<? echo $row['WORK_ORDER_ID']; ?>" />
                            <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $i;?>" readonly value="<? echo $row['WORK_ORDER_DTLS_ID'];?>"/>
                        </td>    
                        <td>
                            <input type="text" name="itemdescription[]" id="itemdescription_<? echo $i; ?>" class="text_boxes" value="<? echo $row['ITEM_DESCRIPTION']; ?>" title="<?= $row['GMTS_ITEM_ID'];?>" style="width:200px" />
                        </td>
                        <td>
 							<input type="text" name="processName[]" id="processName_<? echo $i; ?>" class="text_boxes"   value="<? echo $all_process_name; ?>" title="<?= $row['TEST_ITEM_ID'];?>"  style="width:200px" readonly />
                        </td>
                        <td>
                            <?
                                echo create_drop_down( "uom_".$i, 80, $unit_of_measurement, '', 0, '', $row[csf('uom')], '', $disable_status, '', '', '', '', '', '', 'uom[]');
                            ?>
                        </td>
                        <td>
                            <input type="text" name="quantity[]" id="quantity_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('quantity')]; ?>" style="width:80px;" onKeyUp="calculate_amount(<? echo $i; ?>)" placeholder="<? echo $bl_qty; ?>" />
                        </td>
                        <td>
                            <input type="text" name="rate[]" id="rate_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:70px;" onKeyUp="calculate_amount(<? echo $i; ?>)" <? echo $disable; ?> />
                        </td>
                        <td>
                            <input type="text" name="amount[]" id="amount_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:90px;" <? echo $disable; ?> readonly/>
                            <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $i; ?>" readonly value="<? echo $row[csf('id')]; ?>"/>
                            <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $i; ?>" value="<? echo $row[csf('booking_without_order')]; ?>"/>
                        </td>
                    </tr>
					<?
                    $i++;
				}
				$txt_tot_row=$i-1;
			}
			?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td>
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo $tot_amnt; ?>" style="width:90px;" readonly/>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td>
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo number_format($upcharge,4,'.',''); //$upcharge; ?>" style="width:90px;" onDblClick="fn_upcharge(1)" onKeyUp="calculate_total_amount(2);fn_break_data_change(1);" placeholder="Browse or Write" />
                    <input type="hidden" name="up_charge_break_down" id="up_charge_break_down" value="<? echo $upcharge_breakdown; ?>" />
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td>
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo number_format($discount,4,'.','');  //$discount; ?>" style="width:90px;" onDblClick="fn_upcharge(2)" onKeyUp="calculate_total_amount(2);fn_break_data_change(2);" placeholder="Browse or Write"/>
                    <input type="hidden" name="discount_break_down" id="discount_break_down" value="<? echo $discount_breakdown; ?>" />
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td>
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo $tot_amnt_net; ?>" style="width:90px;" readonly/>
                    </td>
                </tr>
        	</tfoot>
            <?
		}
		else
		{
			$item_group_arr=return_library_array( "SELECT id,item_name FROM lib_item_group",'id','item_name');
		 	?>
        	<thead>
				<?
                if($pi_basis_id == 1)
                {
                ?>
                    <th>&nbsp;</th>
                    <th>WO</th>
                <?
                }
                ?>
                <th>Item Category</th>
                <th>HS Code</th>
                <th class="must_entry_caption">Item Group</th>
                <th class="must_entry_caption">Item Description</th>
                <th>Item Size</th>
                <th>UOM</th>
                <th class="must_entry_caption">Quantity</th>
                <th class="must_entry_caption">Rate</th>
                <th>Amount</th>
                <?
                if( $pi_basis_id == 2 )
                {
                ?>
                    <th></th>
                <?
                }
                ?>
            </thead>
            <tbody>
       	    <?
            if($pi_basis_id==2)
            {
                $disable="";
				$placeholder="Doublic Click";
            }
            else
            {
				$disable="disabled='disabled'";
				$placeholder="";
				if($goods_rcv_status==1) $disable_field="disabled='disabled'"; else $disable_field="";
            }

			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
            {
				if($db_type==0)
				{

					$nameArray=sql_select( "select group_concat(id) as id, work_order_no, work_order_id, group_concat(work_order_dtls_id) as work_order_dtls_id, item_prod_id, item_group, item_description, item_size, uom, sum(quantity) as quantity, avg(rate) as rate, sum(amount) as amount, hs_code, item_category_id
					from com_pi_item_details
					where pi_id='$pi_id' and status_active=1 and is_deleted=0
					group by work_order_no, work_order_id, item_prod_id, item_group, item_description, item_size, uom, hs_code, item_category_id" );


				}
				else
				{

					$nameArray=sql_select( "select rtrim(xmlagg(xmlelement(e,id,',').extract('//text()') order by id).GetClobVal(),',') AS id, rtrim(xmlagg(xmlelement(e,work_order_dtls_id,',').extract('//text()') order by work_order_dtls_id).GetClobVal(),',') AS work_order_dtls_id , work_order_no, work_order_id, item_prod_id, item_group, item_description, item_size, uom, sum(quantity) as quantity, avg(rate) as rate, sum(amount) as amount, hs_code, item_category_id
					from com_pi_item_details
					where pi_id='$pi_id' and status_active=1 and is_deleted=0
					group by work_order_no, work_order_id, item_prod_id, item_group, item_description, item_size, uom, hs_code, item_category_id" );

				}

            }
            else
            {
				$nameArray=sql_select( "select id, work_order_no, work_order_id, work_order_dtls_id, item_prod_id, item_group, item_description, item_size, uom, quantity, rate, amount, hs_code, item_category_id from com_pi_item_details where pi_id='$pi_id' and status_active=1 and is_deleted=0" );

            }


			if($type==1 || count($nameArray)<1)
            {
				$tot_amnt=''; $upcharge=$upcharge_breakdown=''; $discount=''; $tot_amnt_net=''; $txt_tot_row=0;
            	?>
                <tr class="general" id="row_1">
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>
                            <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_1" value="" />
                        </td>
                        <td>
                            <input type="text" name="workOrderNo[]" id="workOrderNo_1" class="text_boxes" value="" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(1);" readonly />
                            <input type="hidden" name="hideWoId[]" id="hideWoId_1" readonly />
                            <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_1" readonly />
                        </td>
                    <?
                    }
                    ?>
                    <td>
						 <?
						  if($item_category_id==101){
							echo create_drop_down( "itemcategory_$tblRow", 120, "SELECT CATEGORY_ID, SHORT_NAME FROM lib_item_category_list WHERE CATEGORY_ID=".$row[csf('item_category_id')]." AND status_active = 1 AND is_deleted = 0", 'item_category_id,SHORT_NAME', 0, '-Select-',"", "", 1, '', '', '', '', '', '', 'itemcategory[]');
						 }else{
                            echo create_drop_down( "itemcategory_1", 120, $general_item_category, '', 1, '-Select-', 0, "", 1, '', '', '', '', '', '', 'itemcategory[]');
						 }
                         ?>
                    </td>
                    <td>
                        <input type="text" name="hsCode[]" id="hsCode_1" class="text_boxes" value="" style="width:40px;" />
                    </td>
                    <td>
						 <?
                            echo create_drop_down( "itemgroupid_1", 120, $item_group_arr, '', 1, '-Select-', 0, "get_php_form_data( this.value+'**'+'uom_1', 'get_uom', 'requires/pi_controller_urmi' );", 1, '', '', '', '', '', '', 'itemgroupid[]');
                         ?>
                    </td>
                    <td>
                        <input type="text" name="itemdescription[]" id="itemdescription_1" class="text_boxes" value="" style="width:160px" maxlength="200" <? echo $disable; ?> onDblClick="openmypage_item_desc(1);" placeholder="<? echo $placeholder; ?>" readonly/>
                        <input type="hidden" name="itemProdId[]" id="itemProdId_1" readonly value=""/>
                    </td>
                    <td>
                        <input type="text" name="itemSize[]" id="itemSize_1" class="text_boxes" value="" style="width:60px;" maxlength="50" disabled="disabled"/>
                    </td>
                    <td>
                        <?
                            echo create_drop_down( "uom_1", 50, $unit_of_measurement, '', 0, '', 0,'', 1, '', '', '', '', '', '', 'uom[]');
                        ?>
                    </td>
                    <td>
                        <input type="text" name="quantity[]" id="quantity_1" class="text_boxes_numeric" value="" style="width:80px;" onKeyUp="calculate_amount(1)" />
                    </td>
                    <td>
                        <input type="text" name="rate[]" id="rate_1" class="text_boxes_numeric" value="" style="width:75px;" onKeyUp="calculate_amount(1)" <? echo $disable; ?> />
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_1" class="text_boxes_numeric" value="" style="width:85px;" <? echo $disable; ?> readonly/>
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_1" readonly/>
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                    <td width="65">
                        <input type="button" name="increase[]" id="increase_1" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( 1 )" />
                        <input type="button" name="decrease[]" id="decrease_1" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(1);" />
                    </td>
                    <?
                    }
                    ?>
                </tr>
            <?
            }
			else
			{
				//echo "select item_category_id,goods_rcv_status,total_amount, upcharge, upcharge_breakdown, discount, net_total_amount from com_pi_master_details where id='$pi_id'";
				$data_array=sql_select("select item_category_id,goods_rcv_status,total_amount, upcharge, upcharge_breakdown, discount, discount_breakdown, net_total_amount from com_pi_master_details where id='$pi_id'");
				$tot_amnt=$data_array[0][csf('total_amount')];
				$upcharge=$data_array[0][csf('upcharge')];
				$upcharge_breakdown=$data_array[0][csf('upcharge_breakdown')];
				$discount=$data_array[0][csf('discount')];
				$discount_breakdown=$data_array[0][csf('discount_breakdown')];
				$tot_amnt_net=$data_array[0][csf('net_total_amount')];
				$item_category_id=$data_array[0][csf('item_category_id')];
				$goods_rcv_status=$data_array[0][csf('goods_rcv_status')];
				if($db_type==2 && ($goods_rcv_status==1 && $goods_rcv_variable!=1)){
					$row[csf('id')] = $row[csf('id')]->load();
					$row[csf('work_order_dtls_id')] = $row[csf('work_order_dtls_id')]->load();
				} 
				if( $pi_basis_id == 1 )
				{
					$wo_dtls_id='';
					foreach ($nameArray as $row)
					{
						$wo_dtls_id.=$row[csf('work_order_dtls_id')].',';
					}

					$wo_dtls_id=chop($wo_dtls_id,',');
					$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id in(select category_id from lib_item_category_list where category_type=1) and a.pi_basis_id=1 and a.status_active=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");

					$wo_qty_arr=return_library_array("select id, supplier_order_quantity as qty from wo_non_order_info_dtls where id in($wo_dtls_id) and is_deleted=0 and status_active=1", "id", "qty");
					/*if($goods_rcv_status==2)
					{
						$wo_qty_arr=return_library_array("select id, supplier_order_quantity as qty from wo_non_order_info_dtls where id in($wo_dtls_id)", "id", "qty");
					}
					else
					{
						$wo_qty_arr=return_library_array("select id, order_qnty as qty from inv_transaction where id in($wo_dtls_id)", "id", "qty");
					} */
				}
				$disable_data=$checkBox_check="";
				if($goods_rcv_variable==1 && $goods_rcv_status==1)
				{
					$disable_data="disabled='disabled'";
					$checkBox_check="checked";
				}
				$i=1;
				foreach ($nameArray as $row)
				{
					$bl_qty='';
					?>
                    <tr class="general" id="row_<? echo $i; ?>">
                        <?
                        if( $pi_basis_id == 1 )
                        {
                        ?>
                            <td>
                                <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $i; ?>" value="" 
								<? if($item_category_id!=101){ echo $disable_data." ".$checkBox_check; }?> />
                            </td>
                            <td>
                                <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('work_order_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $i; ?>);" <? //echo $disable_field; ?> readonly />
                                <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $i; ?>" readonly value="<? echo $row[csf('work_order_id')]; ?>" />
                                <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $i;?>" readonly value="<? echo $row[csf('work_order_dtls_id')];?>"/>
                                <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $i; ?>" value="" readonly />
                            </td>
                        	<?
							$bl_qty=$wo_qty_arr[$row[csf('work_order_dtls_id')]]-$prev_pi_qty_arr[$row[csf('work_order_dtls_id')]]+$row[csf('quantity')];
                        }
                        ?>
                        <td>
						 <?
						 if($item_category_id==101){
							echo create_drop_down( "itemcategory_$tblRow", 120, "SELECT CATEGORY_ID, SHORT_NAME FROM lib_item_category_list WHERE CATEGORY_ID=".$row[csf('item_category_id')]." AND status_active = 1 AND is_deleted = 0", 'item_category_id,SHORT_NAME', 0, '-Select-',"", "", 1, '', '', '', '', '', '', 'itemcategory[]');
						 }else{
                            echo create_drop_down( "itemcategory_".$i, 120, $general_item_category, '', 1, '-Select-', $row[csf('item_category_id')], "", 1, '', '', '', '', '', '', 'itemcategory[]');
						 }
                         ?>
                    </td>
                        <td>
                            <input type="text" name="hsCode[]" id="hsCode_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('hs_code')]; ?>" style="width:40px;" />
                        </td>
                        <td>
						 <?
                            echo create_drop_down( "itemgroupid_".$i, 120, $item_group_arr, '', 1, '-Select-', $row[csf('item_group')], "get_php_form_data( this.value+'**'+'uom_$i', 'get_uom', 'requires/pi_controller_urmi' );", 1, '', '', '', '', '', '', 'itemgroupid[]');
                         ?>
                    	</td>
                        <td>
                            <input type="text" name="itemdescription[]" id="itemdescription_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('item_description')]; ?>" style="width:160px" maxlength="200" <? echo $disable; ?> onDblClick="openmypage_item_desc(<? echo $i; ?>);" readonly />
                            <input type="hidden" name="itemProdId[]" id="itemProdId_<? echo $i; ?>" readonly value="<? echo $row[csf('item_prod_id')]; ?>"/>
                        </td>
                        <td>
                            <input type="text" name="itemSize[]" id="itemSize_<? echo $i; ?>" class="text_boxes" value="<? echo $row[csf('item_size')]; ?>" style="width:60px;" maxlength="50"  disabled="disabled"/>
                        </td>
                        <td>
                            <?
                                echo create_drop_down( "uom_".$i, 50, $unit_of_measurement, '', 0, '', $row[csf('uom')], '', 1, '', '', '', '', '', '', 'uom[]');
                            ?>
                        </td>
                        <td>
                            <input type="text" name="quantity[]" id="quantity_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo number_format($row[csf('quantity')],4,'.',''); ?>" style="width:80px;" onKeyUp="calculate_amount(<? echo $i; ?>)" placeholder="<? echo $bl_qty; ?>" <? echo $disable_field; ?> <? echo $disable_data; ?> />
                        </td>
                        <td>
                            <input type="text" name="rate[]" id="rate_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:75px;" onKeyUp="calculate_amount(<? echo $i; ?>)" <? echo $disable; ?> />
                        </td>
                        <td>
                            <input type="text" name="amount[]" id="amount_<? echo $i; ?>" class="text_boxes_numeric" value="<? echo $row[csf('amount')]; ?>" style="width:85px;" <? echo $disable; ?> readonly/>
                            <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $i; ?>" readonly value="<? echo $row[csf('id')]; ?>"/>
                        </td>
                        <?
                        if( $pi_basis_id == 2 )
                        {
                        ?>
                        <td width="65">
                            <input type="button" name="increase[]" id="increase_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( <? echo $i; ?> )" />
                            <input type="button" name="decrease[]" id="decrease_<? echo $i; ?>" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(<? echo $i; ?>);" />
                        </td>
                        <?
                        }
                        ?>
                    </tr>
            	<?
				$i++;
				}
				$txt_tot_row=$i-1;
			}

			?>
            </tbody>
            <tfoot class="tbl_bottom">
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount" id="txt_total_amount" class="text_boxes_numeric" value="<? echo number_format($tot_amnt,$dec_place[2],'.',''); //$tot_amnt; ?>" style="width:85px;" readonly/>
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Upcharge</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_upcharge" id="txt_upcharge" class="text_boxes_numeric" value="<? echo number_format($upcharge,4,'.',''); //$upcharge; ?>" style="width:75px;" onDblClick="fn_upcharge(1)" onKeyUp="calculate_total_amount(2);fn_break_data_change(1);" placeholder="Browse or Write"/>
                    <input type="hidden" name="up_charge_break_down" id="up_charge_break_down" value="<? echo $upcharge_breakdown; ?>" />
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Discount</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_discount" id="txt_discount" class="text_boxes_numeric" value="<? echo number_format($discount,4,'.','');  //$discount; ?>" style="width:85px;" onDblClick="fn_upcharge(2)" onKeyUp="calculate_total_amount(2);fn_break_data_change(2);" placeholder="Browse or Write"/>
                    <input type="hidden" name="discount_break_down" id="discount_break_down" value="<? echo $discount_breakdown; ?>" />
                    </td>
                    <?
                    if( $pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
                <tr>
                    <?
                    if( $pi_basis_id == 1 )
                    {
                    ?>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    <?
                    }
                    ?>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>Net Total</td>
                    <td style="text-align:center">
                        <input type="text" name="txt_total_amount_net" id="txt_total_amount_net" class="text_boxes_numeric" value="<? echo number_format($tot_amnt_net,$dec_place[2],'.','');  //$tot_amnt_net; ?>" style="width:85px;" readonly/>
                    </td>
                    <?
                    if($pi_basis_id == 2 )
                    {
                    ?>
                        <td width="65">&nbsp;</td>
                    <?
                    }
                    ?>
                </tr>
       	 	</tfoot>
            <?
		}
        ?>
		</table>
		<table width="100%">
			<tr>
				<td class="button_container" colspan="2"></td>
			</tr>
			<tr>
				<td width="15%">
					<?
					if($pi_basis_id == 1)
					{
					?>
						<input form="form_all" type="checkbox" name="check_all" id="check_all" value=""  onclick="fnCheckUnCheckAll(this.checked)"/> Check / Uncheck All
					<?
					}
					?>
					&nbsp;&nbsp;&nbsp;&nbsp;
				</td>
				<td width="80%" align="center">
					<input type="hidden" name="txt_deleted_id" id="txt_deleted_id" readonly/>
					<input type="hidden" name="txt_tot_row" id="txt_tot_row" value="<? echo $txt_tot_row; ?>" readonly/>
				<? echo load_submit_buttons( $_SESSION['page_permission'], "fnc_pi_item_details", 0,0 ,"reset_form('pimasterform_2','','','txt_tot_row,0','$(\'#tbl_pi_item tbody tr:not(:first)\').remove();fn_reset_thead()')",2) ; ?>
				</td>
			</tr>
		</table>
		<?
	}
	exit();
}

if($action=="upcharge_details")
{
	extract($_REQUEST);
	echo load_html_head_contents("Popup Info","../../../", '', '', $unicode);
	$up_charge_break_down_ref=explode("_",$up_charge_break_down);
	?>
    <script>
		function frm_close()
		{
			parent.emailwindow.hide();
		}
    </script>
    <?
	if($str_type==1)
	{
		?>
        <div style="width:100%">
        <table width="480" cellpadding="0" cellspacing="0" class="rpt_table" border="1" rules="all" id="" align="left">
            <thead>
                <tr>
                    <th width="50">Sl</th>
                    <th width="200">Head</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr bgcolor="#E9F3FF">
                    <td align="center">1</td>
                    <td>Freight Cost</td>
                    <td><input type="text" id="txt_freight_cost" name="txt_freight_cost" class="text_boxes_numeric" style="width:180px;" value="<? echo $up_charge_break_down_ref[0]; ?>" /></td>
                </tr>
                <tr bgcolor="#FFFFFF">
                    <td align="center">2</td>
                    <td>Courier Cost</td>
                    <td><input type="text" id="txt_couried_cost" name="txt_couried_cost" class="text_boxes_numeric" style="width:180px;" value="<? echo $up_charge_break_down_ref[1]; ?>" /></td>
                </tr>
                <tr bgcolor="#E9F3FF">
                    <td align="center">3</td>
                    <td>Upcharge</td>
                    <td><input type="text" id="txt_upcharge" name="txt_upcharge" class="text_boxes_numeric" style="width:180px;" value="<? echo $up_charge_break_down_ref[2]; ?>" /></td>
                </tr>
                <tr bgcolor="#FFFFFF">
                    <td align="center">4</td>
                    <td>Transport Cost</td>
                    <td><input type="text" id="txt_transport_cost" name="txt_transport_cost" class="text_boxes_numeric" style="width:180px;" value="<? echo $up_charge_break_down_ref[3]; ?>" /></td>
                </tr>
                <tr bgcolor="#E9F3FF">
                    <td align="center">5</td>
                    <td>Bank Charge</td>
                    <td><input type="text" id="txt_bank_charge" name="txt_bank_charge" class="text_boxes_numeric" style="width:180px;" value="<? echo $up_charge_break_down_ref[4]; ?>" /></td>
                </tr>
                <tr bgcolor="#E9F3FF">
                    <td align="center">6</td>
                    <td>Vat</td>
                    <td><input type="text" id="txt_vat" name="txt_vat" class="text_boxes_numeric" style="width:180px;" value="<? echo $up_charge_break_down_ref[5]; ?>" /></td>
                </tr>
                <tr bgcolor="#E9F3FF">
                    <td align="center">7</td>
                    <td>Service Charge</td>
                    <td><input type="text" id="txt_service_charge" name="txt_service_charge" class="text_boxes_numeric" style="width:180px;" value="<? echo $up_charge_break_down_ref[6]; ?>" /></td>
                </tr>
                <tr bgcolor="#E9F3FF">
                    <td align="center">8</td>
                    <td>Adjustment</td>
                    <td><input type="text" id="txt_adjustment" name="txt_adjustment" class="text_boxes_numeric" style="width:180px;" value="<? echo $up_charge_break_down_ref[7]; ?>" /></td>
                </tr>
            </tbody>
        </table>
        <br>
        <div style="width:100%"><p align="center"><input type="button" id="btn_close" class="formbutton" style="width:100px;" value="Close" onClick="frm_close();" ></p></div>
        </div>
        <?
	}
	else
	{
		?>
        <div style="width:100%">
        <table width="480" cellpadding="0" cellspacing="0" class="rpt_table" border="1" rules="all" id="" align="left">
            <thead>
                <tr>
                    <th width="50">Sl</th>
                    <th width="200">Head</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr bgcolor="#E9F3FF">
                    <td align="center">3</td>
                    <td>Discount</td>
                    <td><input type="text" id="txt_discount" name="txt_discount" class="text_boxes_numeric" style="width:180px;" value="<? echo $up_charge_break_down_ref[0]; ?>" /></td>
                </tr>
                <tr bgcolor="#E9F3FF">
                    <td align="center">8</td>
                    <td>Adjustment</td>
                    <td><input type="text" id="txt_adjustment" name="txt_adjustment" class="text_boxes_numeric" style="width:180px;" value="<? echo $up_charge_break_down_ref[1]; ?>" /></td>
                </tr>
            </tbody>
        </table>
        <br>
        <div style="width:100%"><p align="center"><input type="button" id="btn_close" class="formbutton" style="width:100px;" value="Close" onClick="frm_close();" ></p></div>
        </div>
        <?
	}
	?>
    
    <?
	exit();
}

//---------------------------------------------End Pi Details------------------------------------------------------------------------//
if ($action=="get_uom")
{
	$data=explode("**",$data);
	$database_id=$data[0];
	$field_id=$data[1];
	$nameArray=sql_select( "select order_uom from lib_item_group where id='$database_id'" );
	foreach ($nameArray as $row)
	{
	 	echo "document.getElementById('$field_id').value = ".trim($row[csf("order_uom")]).";\n";
		die;
	}
	exit();
}

if($action=="load_drop_down_embelltype")
{
	$data=explode("**",$data);
	$embell_name=$data[0];
	$disable_status=$data[1];
	$field_id=$data[2];

	if($embell_name==1)
		echo create_drop_down( "$field_id", 130, $emblishment_print_type,'', 1, '-Select-', 0,"",$disable_status);
	else if($embell_name==2)
		echo create_drop_down( "$field_id", 130, $emblishment_embroy_type,'', 1, '-Select-', 0,"",$disable_status);
	else if($embell_name==3)
		echo create_drop_down( "$field_id", 130, $emblishment_wash_type,'', 1, '-Select-', 0,"",$disable_status);
	else if($embell_name==4)
		echo create_drop_down( "$field_id", 130, $emblishment_spwork_type,'', 1, '-Select-', 0,"",$disable_status);
	else
		echo create_drop_down( "$field_id", 130, $blank_array,'', 1, '-Select-', 0,"",$disable_status);

	exit();
}

//--------------------
if ($action=="fabricDescription_popup")
{
	echo load_html_head_contents("Fabric Description Info", "../../../", 1, 1,'','','');
	extract($_REQUEST);
	?>

	<script>

		$(document).ready(function(e) {
            setFilterGrid('tbl_list_search',-1);
        });

		var selected_id = new Array; var selected_name = new Array();

		function check_all_data() {
			var tbl_row_count = document.getElementById( 'tbl_list_search' ).rows.length;
			for( var i = 1; i <= tbl_row_count; i++ ) {
				js_set_value( i );
			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function js_set_value( str ) {
			toggle( document.getElementById( 'search' + str ), '#FFFFCC' );

			if( jQuery.inArray( $('#txt_individual_id' + str).val(), selected_id ) == -1 ) {
				selected_id.push( $('#txt_individual_id' + str).val() );
				selected_name.push( $('#txt_data' + str).val() );
			}
			else {
				for( var i = 0; i < selected_id.length; i++ ) {
					if( selected_id[i] == $('#txt_individual_id' + str).val() ) break;
				}
				selected_id.splice( i, 1 );
				selected_name.splice( i, 1 );
			}
			var id = ''; var name ='';
			for( var i = 0; i < selected_id.length; i++ ) {
				id += selected_id[i] + ',';
				name += selected_name[i] + ',';
			}
			id = id.substr( 0, id.length - 1 );
			name = name.substr( 0, name.length - 1 );

			$('#txt_selected_id').val( id );
			$('#txt_selected').val( name );
		}

    </script>

	</head>

	<body>
		<form name="searchdescfrm"  id="searchdescfrm">
			<fieldset style="width:720px;margin-left:10px">
				<?
					/*if($prev_attached_id=="")
						$id_cond="";
					else
						$id_cond="and id not in($prev_attached_id)";*/

					$composition_arr=array();
					$compositionData=sql_select("select mst_id, copmposition_id, percent from lib_yarn_count_determina_dtls where status_active=1 and is_deleted=0");
					foreach( $compositionData as $row )
					{
						$composition_arr[$row[csf('mst_id')]].=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ";
					}

					$data_array=sql_select("select id, construction, fab_nature_id, gsm_weight, fabric_ref, rd_no from lib_yarn_count_determina_mst where fab_nature_id=$fabricNature and status_active=1 and is_deleted=0 $id_cond");
				?>
				<input type="hidden" name="txt_selected_id" id="txt_selected_id" class="text_boxes" value="">
				<input type="hidden" name="txt_selected" id="txt_selected" class="text_boxes" value="">
				<div style="margin-left:10px; margin-top:10px">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="680">
						<thead>
							<th width="50">SL</th>
							<th width="100">Fabric Nature</th>
							<th width="150">Construction</th>
							<th width="80">GSM/Weight</th>
							<th>Composition</th>
							<?
								if($fabricNature==3)
								{
									?>
										<th width="70">Fabric Ref</th>
										<th width="50">RD NO</th>
									<?
								}
							?>
						</thead>
					</table>
					<div style="width:700px; max-height:280px; overflow-y:scroll" id="list_container" align="left">
						<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="680" id="tbl_list_search">
							<?
							$i=1;
							foreach($data_array as $row)
							{
								if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";

								$construction=$row[csf('construction')];
								$comp=$composition_arr[$row[csf('id')]];

								/*$determ_sql=sql_select("select copmposition_id, percent from lib_yarn_count_determina_dtls where mst_id=".$row[csf('id')]." and status_active=1 and is_deleted=0");
								foreach( $determ_sql as $d_row )
								{
									$comp.=$composition[$d_row[csf('copmposition_id')]]." ".$d_row[csf('percent')]."% ";
								}*/
							?>
								<tr bgcolor="<? echo $bgcolor; ?>" onClick="js_set_value(<? echo $i; ?>)" style="text-decoration:none; cursor:pointer" id="search<? echo $i; ?>">
									<td width="50"><? echo $i; ?>
										<input type="hidden" name="txt_individual_id" id="txt_individual_id<? echo $i ?>" value="<? echo $row[csf('id')]; ?>"/>
										<input type="hidden" name="txt_data" id="txt_data<? echo $i ?>" value="<? echo $construction."**".$comp."**". $row[csf('gsm_weight')]."**". $row[csf('fabric_ref')]."**". $row[csf('rd_no')]; ?>"/>
									</td>
									<td width="100"><? echo $item_category[$row[csf('fab_nature_id')]]; ?></td>
									<td width="150"><p><? echo $row[csf('construction')]; ?></p></td>
									<td width="80"><? echo $row[csf('gsm_weight')]; ?></td>
									<td><p><? echo $comp; ?></p></td>
									<?
									if($fabricNature==3)
									{
										?>
											<td width="70"><p><? echo $row[csf('fabric_ref')]; ?></p></td>
											<td width="50"><p><? echo $row[csf('rd_no')]; ?></p></td>
										<?
									}
									?>

								</tr>
							<?
							$i++;
							}
							?>
						</table>
					</div>
				</div>
				<table width="700" cellspacing="0" cellpadding="0" style="border:none" align="center">
					<tr>
						<td align="center" height="30" valign="bottom">
							<div style="width:100%">
								<div style="width:50%; float:left" align="left">
									<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
								</div>
								<div style="width:50%; float:left" align="left">
									<input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbuttonplasminus" value="Close" style="width:100px" />
								</div>
							</div>
						</td>
					</tr>
				</table>
			</fieldset>
		</form>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

//--------------------
if ($action=="testItem_popup")
{
	echo load_html_head_contents("Test Item Info", "../../../", 1, 1,'','','');
	extract($_REQUEST);
	?>

	<script>

		$(document).ready(function(e) {
            setFilterGrid('tbl_list_search',-1);
        });

		var selected_id = new Array; var selected_name = new Array();

		function check_all_data() {
			var tbl_row_count = document.getElementById( 'tbl_list_search' ).rows.length-1;
			for( var i = 1; i <= tbl_row_count; i++ ) {
				js_set_value( i );
			}
		}

		function set_all()
		{
			var old=document.getElementById('txt_item_row_id').value;
			if(old!="")
			{
				old=old.split(",");
				for(var i=0; i<old.length; i++)
				{
					js_set_value( old[i] )
				}
			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function js_set_value( str ) {
			toggle( document.getElementById( 'search' + str ), '#FFFFCC' );

			if( jQuery.inArray( $('#txt_individual_id' + str).val(), selected_id ) == -1 ) {
				selected_id.push( $('#txt_individual_id' + str).val() );
				selected_name.push( $('#txt_individual' + str).val() );
			}
			else {
				for( var i = 0; i < selected_id.length; i++ ) {
					if( selected_id[i] == $('#txt_individual_id' + str).val() ) break;
				}
				selected_id.splice( i, 1 );

				selected_name.splice( i, 1 );
			}
			var id = ''; var name ='';
			for( var i = 0; i < selected_id.length; i++ ) {
				id += selected_id[i] + ',';
				name += selected_name[i] + ',';
			}
			id = id.substr( 0, id.length - 1 );
			name = name.substr( 0, name.length - 1 );

			$('#txt_selected_id').val( id );
			$('#txt_selected').val( name );
		}

    </script>

	</head>

	<body onLoad="set_all();">
		<form name="searchdescfrm"  id="searchdescfrm">
			<fieldset style="width:510px;margin-left:10px">
				<input type="hidden" name="txt_selected_id" id="txt_selected_id" class="text_boxes" value="">
				<input type="hidden" name="txt_selected" id="txt_selected" class="text_boxes" value="">
				<div style="margin-left:10px; margin-top:10px">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="480">
						<thead>
							<th width="50">SL</th>
							<th width="150">Test Category</th>
							<th width="100">Test For</th>
							<th>Test Item</th>
						</thead>
					</table>
					<div style="width:500px; max-height:280px; overflow-y:scroll" id="list_container" align="left">
						<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="480" id="tbl_list_search">
							<?
							$i=1; $item_row_id=''; $prev_attached_id=explode(",",$prev_attached_id);
							$data_array=sql_select("select id, test_category,test_for,test_item from lib_lab_test_rate_chart where test_for=$cboTestFor and status_active=1 and is_deleted=0");
							foreach($data_array as $row)
							{
								if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";

								if(in_array($row[csf('id')],$prev_attached_id))
								{
									if($item_row_id=="") $item_row_id=$i; else $item_row_id.=",".$i;
								}
							?>
								<tr bgcolor="<? echo $bgcolor; ?>" onClick="js_set_value(<? echo $i; ?>)" style="text-decoration:none; cursor:pointer" id="search<? echo $i; ?>">
									<td width="50"><? echo $i; ?>
										<input type="hidden" name="txt_individual_id" id="txt_individual_id<? echo $i ?>" value="<? echo $row[csf('id')]; ?>"/>
										<input type="hidden" name="txt_individual" id="txt_individual<? echo $i ?>" value="<? echo $row[csf('test_item')]; ?>"/>
									</td>
									<td width="150"><? echo $testing_category[$row[csf('test_category')]]; ?></td>
									<td width="100"><p><? echo $test_for[$row[csf('test_for')]]; ?></p></td>
									<td><p><? echo $row[csf('test_item')]; ?></p></td>
								</tr>
							<?
							$i++;
							}
							?>
							<input type="hidden" name="txt_item_row_id" id="txt_item_row_id" value="<?php echo $item_row_id; ?>"/>
						</table>
					</div>
				</div>
				<table width="500" cellspacing="0" cellpadding="0" style="border:none" align="center">
					<tr>
						<td align="center" height="30" valign="bottom">
							<div style="width:100%">
								<div style="width:50%; float:left" align="left">
									<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
								</div>
								<div style="width:50%; float:left" align="left">
									<input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbuttonplasminus" value="Close" style="width:100px" />
								</div>
							</div>
						</td>
					</tr>
				</table>
			</fieldset>
		</form>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}


if ($action=="pi_popup")
{
	echo load_html_head_contents("PI Info", "../../../", 1, 1,'','','');
	extract($_REQUEST);
    ?>
	<script>

		$(document).ready(function(e)
 		{
            load_drop_down( 'pi_controller_urmi',<? echo $importer_id; ?>+'_'+<? echo $item_category_id; ?>+'_'+<? echo $supplier_id; ?>, 'load_supplier_dropdown', 'supplier_td' );
        });

		function js_set_value( pi_id )
		{
			document.getElementById('txt_selected_pi_id').value=pi_id;
			parent.emailwindow.hide();
		}
		

    </script>

	</head>

	<body>
	<div align="center" style="width:960px;">
	<form name="searchpifrm"  id="searchpifrm">
		<fieldset style="width:100%;">
		<legend>Enter search words</legend>
            <table cellpadding="0" cellspacing="0" width="950" border="1" rules="all" class="rpt_table">
                <thead>
                    <th>Company</th>
                    <th>Category</th>
                    <th>File No</th>
                    <th>Supplier</th>
                    <th>PI Number</th>
                    <th>System ID</th>
                    <th>Date Range</th>
                    <th>
                    	<input type="reset" name="reset" id="reset" value="Reset" style="width:70px" class="formbutton" />
                        <!--<input type="hidden" name="txt_item_category" id="txt_item_category" class="text_boxes" style="width:70px" value="">-->
                    	<input type="hidden" name="txt_selected_pi_id" id="txt_selected_pi_id" class="text_boxes" style="width:70px" value="">
                    </th>
                </thead>
                <tr class="general">
                    <td class="must_entry_caption">
						 <? echo create_drop_down( "cbo_importer_id", 151,"select comp.id, comp.company_name from lib_company comp where comp.status_active=1 and comp.is_deleted=0 $company_cond order by comp.company_name",'id,company_name', 1, '--Select--',$importer_id,"load_drop_down( 'pi_controller_urmi',this.value+'_'+document.getElementById('cbo_item_category_id').value+'_'+$supplier_id, 'load_supplier_dropdown', 'supplier_td' );",0); ?>
                    </td>
                    <td><? echo create_drop_down( "cbo_item_category_id", 151, $item_category_with_gen,'', 1, '--Select--',$item_category_id,"load_drop_down( 'pi_controller_urmi',document.getElementById('cbo_importer_id').value+'_'+this.value, 'load_supplier_dropdown', 'supplier_td' );",0,$item_category_credential_cond,'','','72,79,73,71,77,78,75,76'); ?>
                    </td>
					<td>
                        <input type="text" name="txt_file_no" id="txt_file_no" class="text_boxes" style="width:60px">
                    </td>
                    <td id="supplier_td">
                        <?
							echo create_drop_down( "cbo_supplier_id", 151, $blank_array,"", 1, "-- Select Supplier --", 0, "" );
						?>
                    </td>
                    <td>
                        <input type="text" name="txt_pi_no" id="txt_pi_no" class="text_boxes" style="width:100px">
                    </td>
                    <td>
                        <input type="text" name="txt_system_id" id="txt_system_id" class="text_boxes_numeric" style="width:50px">
                    </td>
                    <td align="center">
                      <input type="text" name="txt_date_from" id="txt_date_from" class="datepicker" style="width:50px">To
					  <input type="text" name="txt_date_to" id="txt_date_to" class="datepicker" style="width:50px">
					 </td>
            		 <td align="center">
                     	<input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('txt_pi_no').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('cbo_item_category_id').value+'_'+document.getElementById('cbo_importer_id').value+'_'+document.getElementById('cbo_supplier_id').value+'_'+document.getElementById('txt_system_id').value+'_'+document.getElementById('txt_file_no').value, 'create_pi_search_list_view', 'search_div', 'pi_controller_urmi', 'setFilterGrid(\'list_view\',-1)')" style="width:70px;" />
                     </td>
                </tr>
                <tr>
                	<td colspan="8" align="center" valign="middle"><? echo load_month_buttons(1); ?></td>
                </tr>
           </table>
           <div style="width:100%; margin-top:10px" id="search_div" align="left"></div>
		</fieldset>
	</form>
	</div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	<script>
		$('#cbo_supplier_id').val( "<? echo $supplier_id; ?>");
	</script>
	</html>
	<?
	exit();
}

if($action=="create_pi_search_list_view")
{
	$data=explode('_',$data);

	$pi_number=$pi_date='';
	if (trim($data[0]) !='') $pi_number=" and pi_number like '%".trim($data[0])."%'";
	if ($data[1] !='' &&  $data[2] !='')
	{
		if($db_type==0)
		{
			$pi_date = "and pi_date between '".change_date_format($data[1], "yyyy-mm-dd", "-")."' and '".change_date_format($data[2], "yyyy-mm-dd", "-")."'";
		}
		else
		{
			$pi_date = "and pi_date between '".change_date_format($data[1],'','',1)."' and '".change_date_format($data[2],'','',1)."'";
		}
	}	

	$item_category_id =$data[3];
	$importer_id =$data[4];
	$supplier_id=$data[5];
	$system_id=trim($data[6]);
	$file_no=trim($data[7]);
	
	//if(!in_array($row[csf('is_approved')], $approval_status_arr) )
	$supplier_id_cond=$system_id_cond='';
	if($supplier_id !=0) $supplier_id_cond=" and supplier_id=$supplier_id";
	if ($system_id !='') $system_id_cond=" and id=$system_id";
	if ($file_no !='') $file_no_cond=" and internal_file_no= '$file_no'";

	if($importer_id==0) { echo "Please Select Company First."; die; }

	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');

	//$arr=array(2=>$item_category,3=>$comp,4=>$supplier,7=>$pi_basis);
	$category_cond="";
	if($item_category_id==8)
	{
		$category_cond=" and item_category_id in(select category_id from lib_item_category_list where category_type=1)";
	}
	else
	{
		if($item_category_id) $category_cond=" and item_category_id=$item_category_id ";
	}
	
	$sql= "select id, pi_number, pi_date, (case when item_category_id in (select category_id from lib_item_category_list where category_type=1) and item_category_id<>4 then 8 else item_category_id end) as item_category_id, importer_id, supplier_id, last_shipment_date, hs_code, pi_basis_id, import_pi, export_pi_id, upcharge, discount, total_amount, net_total_amount 
	from com_pi_master_details 
	where importer_id=$importer_id $category_cond and version=1 and import_pi=0 and status_active=1 and is_deleted=0 $pi_number $pi_date $system_id_cond $supplier_id_cond $file_no_cond order by id desc";
	//echo $sql;
	//and entry_form=1

	$exportSuppFromPIArr = array();
	foreach (sql_select($sql) as $row)
	{
		if($row[csf("import_pi")] == 1)
		{
			$exportSuppFromPIArr[$row[csf("id")]] = $comp[$row[csf("supplier_id")]];
		}else{
			$exportSuppFromPIArr[$row[csf("id")]] = $supplier[$row[csf("supplier_id")]];
		}
	}
	$arr=array(2=>$item_category_with_gen,3=>$comp,4=>$exportSuppFromPIArr,7=>$pi_basis);

	// echo $sql;
	//echo create_list_view("list_view", "PI No,PI Date,Item Category,Importer,Supplier,Last Shipment Date,HS Code,PI Basis, System ID", "90,75,90,120,100,90,80,100","890","270",0, $sql , "js_set_value", "id", "", 1, "0,0,item_category_id,importer_id,supplier_id,0,0,pi_basis_id,0", $arr , "pi_number,pi_date,item_category_id,importer_id,supplier_id,last_shipment_date,hs_code,pi_basis_id,id", "",'','0,3,0,0,0,3,0,0,0');
	echo create_list_view("list_view", "PI No,PI Date,Item Category,Importer,Supplier,Last Shipment Date,HS Code,PI Basis, System ID", "90,75,90,120,100,90,80,100","890","270",0, $sql , "js_set_value", "id,export_pi_id,upcharge,discount,total_amount,net_total_amount,item_category_id", "", 1, "0,0,item_category_id,importer_id,id,0,0,pi_basis_id,0", $arr , "pi_number,pi_date,item_category_id,importer_id,id,last_shipment_date,hs_code,pi_basis_id,id", "",'','0,3,0,0,0,3,0,0,0');

	exit();
}
if ($action=="load_supplier_dropdown_company")
{
	echo create_drop_down( "cbo_supplier_id", 151,"select comp.id, comp.company_name from lib_company comp where comp.status_active=1 and comp.is_deleted=0 and comp.id = '$data' order by comp.company_name",'id,company_name', 0, '-- Select Supplier --',0,"",0);

	exit();
}


if ($action=="populate_data_from_search_popup")
{
	$userName_arr=return_library_array( "select id, user_name from user_passwd",'id','user_name');
	$data_array=sql_select("select id, (case when item_category_id in (select category_id from lib_item_category_list where category_type=1) and item_category_id<>4 then 8 else item_category_id end) as item_category_id, importer_id, supplier_id, pi_number, pi_date, last_shipment_date, pi_validity_date, currency_id, source, hs_code, internal_file_no, is_lc_sc, lc_sc_id, lc_sc_no, file_year, intendor_name, pi_basis_id, remarks, approved, ready_to_approved, lc_group_no, approval_user, goods_rcv_status, import_pi, beneficiary, priority_id, pay_term, tenor, pi_for, nagotiate_by, pi_notes, pi_inhand_date, location_id, buyer_id, brand_id, season_year_id, season_id, lc_req_date,order_file_no from com_pi_master_details where id='$data'");
	
	$book_type_sql=sql_select("select max(booking_without_order) as booking_without_order, max(service_type) as service_type, max(item_category_id) as item_category_id from com_pi_item_details where status_active=1 and pi_id=$data");
	$booking_without_order=$book_type_sql[0][csf("booking_without_order")];
	$service_type=$book_type_sql[0][csf("service_type")];
	$max_item_category_id=$book_type_sql[0][csf("item_category_id")];
	if($booking_without_order!="")
	{
		if($max_item_category_id==12)
		{
			if($booking_without_order==1) {if($service_type==31) $order_type=3; else $order_type=2;} else $order_type=1;
		}
		else
		{
			if($booking_without_order==1) $order_type=2; else $order_type=1;
		}
	}
	else
	{
		$order_type="";
	}


	foreach ($data_array as $row)
	{
		echo "document.getElementById('cbo_item_category_id').value = '".$row[csf("item_category_id")]."';\n";
		echo "document.getElementById('cbo_importer_id').value = '".$row[csf("importer_id")]."';\n";

		if($row[csf("import_pi")] == 1)
		{
			echo "load_drop_down('requires/pi_controller_urmi',".$row[csf("supplier_id")].", 'load_supplier_dropdown_company', 'supplier_td' );\n";
		}
		else
		{
			echo "load_drop_down('requires/pi_controller_urmi',".$row[csf("importer_id")]."+'_'+".$row[csf("item_category_id")].", 'load_supplier_dropdown', 'supplier_td' );\n";
		}
		
		echo "load_drop_down('requires/pi_controller_urmi',".$row[csf("importer_id")].", 'load_drop_down_location', 'location_td' );\n";
		echo "load_drop_down('requires/pi_controller_urmi',".$row[csf("importer_id")].", 'load_drop_down_buyer', 'buyer_td' );\n";
		if($row[csf("buyer_id")])
		{
			echo "load_drop_down('requires/pi_controller_urmi',".$row[csf("buyer_id")].", 'load_drop_down_season', 'season_td');\n";
			echo "load_drop_down('requires/pi_controller_urmi',".$row[csf("buyer_id")].", 'load_drop_down_brand', 'brand_td');\n";
		}
		//load_drop_down( 'requires/pi_controller_urmi', this.value, 'load_drop_down_location','location_td');

		if($row[csf("last_shipment_date")]=="0000-00-00" || $row[csf("last_shipment_date")]=="") $last_shipment_date=""; else $last_shipment_date=change_date_format($row[csf("last_shipment_date")]);
		if($row[csf("pi_validity_date")]=="0000-00-00" || $row[csf("pi_validity_date")]=="") $pi_validity_date=""; else $pi_validity_date=change_date_format($row[csf("pi_validity_date")]);
		echo "document.getElementById('cbo_supplier_id').value = '".$row[csf("supplier_id")]."';\n";


		$beneficiary_remarks = str_replace("\n", "\\n", $row[csf("beneficiary")]);
		if($beneficiary_remarks=="") $beneficiary_remarks=" ";
		echo "document.getElementById('txt_beneficiary_name').value = '".$beneficiary_remarks."';\n";
		echo "document.getElementById('pi_number').value = '".$row[csf("pi_number")]."';\n";
		echo "document.getElementById('cbo_location_name').value = '".$row[csf("location_id")]."';\n";
		echo "document.getElementById('cbo_buyer_name').value = '".$row[csf("buyer_id")]."';\n";
		echo "document.getElementById('cbo_brand_id').value = '".$row[csf("brand_id")]."';\n";
		echo "document.getElementById('cbo_season_year').value = '".$row[csf("season_year_id")]."';\n";
		echo "document.getElementById('cbo_season_id').value = '".$row[csf("season_id")]."';\n";
		
		echo "document.getElementById('pi_date').value = '".change_date_format($row[csf("pi_date")])."';\n";
		echo "document.getElementById('last_shipment_date').value = '".$last_shipment_date."';\n";
		echo "document.getElementById('pi_validity_date').value = '".$pi_validity_date."';\n";
		echo "document.getElementById('cbo_currency_id').value = '".$row[csf("currency_id")]."';\n";
		echo "document.getElementById('cbo_source_id').value = '".$row[csf("source")]."';\n";
		echo "document.getElementById('hs_code').value = '".$row[csf("hs_code")]."';\n";
		echo "document.getElementById('txt_internal_file_no').value = '".$row[csf("internal_file_no")]."';\n";
		echo "document.getElementById('txt_order_file_no').value = '".$row[csf("order_file_no")]."';\n";
		echo "document.getElementById('is_lc_sc').value = '".$row[csf("is_lc_sc")]."';\n";
		echo "document.getElementById('lc_sc_id').value = '".$row[csf("lc_sc_id")]."';\n";
		echo "document.getElementById('lc_sc_no').value = '".$row[csf("lc_sc_no")]."';\n";
		echo "document.getElementById('lc_sc_file_year').value = '".$row[csf("file_year")]."';\n";
		echo "document.getElementById('intendor_name').value = '".$row[csf("intendor_name")]."';\n";
		echo "document.getElementById('cbo_pi_basis_id').value = '".$row[csf("pi_basis_id")]."';\n";
		echo "document.getElementById('cbo_priority').value = '".$row[csf("priority_id")]."';\n";
		echo "document.getElementById('cbo_payterm_id').value = '".$row[csf("pay_term")]."';\n";
		echo "document.getElementById('txt_tenor').value = '".$row[csf("tenor")]."';\n";
		echo "document.getElementById('cbo_pi_for').value = '".$row[csf("pi_for")]."';\n";
		echo "document.getElementById('cbo_nagotiate_by').value = '".$row[csf("nagotiate_by")]."';\n";
		echo "document.getElementById('txt_notes').value = '".$row[csf("pi_notes")]."';\n";
		echo "document.getElementById('hdn_notes').value = '".$row[csf("pi_notes")]."';\n";
		echo "document.getElementById('pi_inhand_date').value = '".change_date_format($row[csf("pi_inhand_date")])."';\n";
		echo "document.getElementById('txt_remarks').value = '".($row[csf("remarks")])."';\n";
		echo "document.getElementById('hide_approved_status').value = '".$row[csf("approved")]."';\n";
		echo "document.getElementById('update_id').value = '".$row[csf("id")]."';\n";
		echo "document.getElementById('txt_user_name').value = '".$userName_arr[$row[csf("approval_user")]]."';\n";
		echo "document.getElementById('hiddn_user_id').value = '".$row[csf("approval_user")]."';\n";
		echo "document.getElementById('txt_system_id').value = '".$row[csf("id")]."';\n";
		echo "document.getElementById('cbo_goods_rcv_status').value = '".$row[csf("goods_rcv_status")]."';\n";
		echo "document.getElementById('cbo_ready_to_approved').value = '".$row[csf("ready_to_approved")]."';\n";
		echo "document.getElementById('txt_lc_group_no').value = '".$row[csf("lc_group_no")]."';\n";
		echo "document.getElementById('txt_order_type').value = '".$order_type."';\n";
		echo "document.getElementById('lc_req_date').value = '".change_date_format($row[csf("lc_req_date")])."';\n";

		echo "$('#cbo_item_category_id').attr('disabled','true')".";\n";
		echo "$('#cbo_pi_basis_id').attr('disabled','true')".";\n";
		echo "$('#cbo_goods_rcv_status').attr('disabled','false')".";\n";
		echo "$('#cbo_importer_id').attr('disabled','true')".";\n";
		echo "$('#cbo_supplier_id').attr('disabled','true')".";\n";
		echo "$('#cbo_currency_id').attr('disabled','true')".";\n";

		echo "set_button_status(1, '".$_SESSION['page_permission']."', 'fnc_pi_mst',1);\n";

		echo "document.getElementById('is_approved').value = '".$row[csf("approved")]."';\n";

		if($row[csf("approved")]==1)
	  	{
			echo "$('#approved').text('Approved');\n";
	  	}
		elseif($row[csf("approved")]==3)
	  	{
			echo "$('#approved').text('Partial Approved');\n";
	  	}
	  	else
	  	{
		 	echo "$('#approved').text('');\n";
	  	}
		
		$image_data=sql_select("select master_tble_id from common_photo_library where master_tble_id='".$row[csf("id")]."' and form_name='proforma_invoice' and file_type=2 and is_deleted=0");
		if($image_data[0][csf("master_tble_id")]){
			echo "document.getElementById('txt_file').value =1;\n";
		}
		else{
			echo "document.getElementById('txt_file').value ='';\n";
		}
	}
	
	exit();
}

if($action == "check_trims_approval_setting"){
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$data and b.page_id=9 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}
	echo $app_nessity;
	exit();
}

if ($action=="wo_popup")
{
	echo load_html_head_contents("WO Info", "../../../", 1, 1,'','','');
	extract($_REQUEST);
	//echo $goods_rcv_status;die;
	//echo '<pre>';print_r($_REQUEST);
	
	$pi_mst_id=str_replace("'","",$pi_mst_id);
	$prev_wo_ids=str_replace("'","",$prev_wo_ids);
	$mst_buyer_id=return_field_value("buyer_id","com_pi_master_details","id=$pi_mst_id","buyer_id");
	/*if($pi_mst_id)
	{
		$sql_pi_item="select work_order_dtls_id as WORK_ORDER_DTLS_ID from com_pi_item_details where status_active=1 and is_deleted=0 and pi_id=$pi_mst_id group by work_order_dtls_id";
		$sql_pi_item_result=sql_select($sql_pi_item);
		$prev_wo_dtls_ids="";
		foreach($sql_pi_item_result as $val)
		{
			$prev_wo_dtls_ids.=$val["WORK_ORDER_DTLS_ID"].",";
		}
		$prev_wo_dtls_ids=chop($prev_wo_dtls_ids,",");
		if($prev_wo_ids!="")
		{
			if($prev_wo_dtls_ids!="") $prev_wo_ids=$prev_wo_ids.",".$prev_wo_dtls_ids;
		}
		else
		{
			$prev_wo_ids=$prev_wo_dtls_ids;
		}
	}*/
	
	
	$previous_wo_ids=$prev_wo_nums=$prev_deters=$prev_colors=$prev_constructs=$prev_compositions=$prev_gsms=$prev_widths=$prev_uoms="";
	if($item_category_id==2 || $item_category_id==3)
	{
		$prev_wo_id_arr=$prev_wo_num_arr=$prev_deter_arr=$prev_color_arr=$prev_construct_arr=$prev_composition_arr=$prev_gsm_arr=$prev_width_arr=$prev_uom_arr=array();
		$prev_wo_feb_datas_ref=explode("__",$prev_wo_feb_datas);
		foreach($prev_wo_feb_datas_ref as $prev_data)
		{
			$prev_data_ref=explode("**",$prev_data);
			$prev_wo_id_arr[$prev_data_ref[0]]=$prev_data_ref[0];
			$prev_wo_num_arr[$prev_data_ref[1]]=$prev_data_ref[1];
			$prev_deter_arr[$prev_data_ref[2]]=$prev_data_ref[2];
			$prev_color_arr[$prev_data_ref[3]]=$prev_data_ref[3];
			$prev_construct_arr[$prev_data_ref[4]]=$prev_data_ref[4];
			$prev_composition_arr[$prev_data_ref[5]]=$prev_data_ref[5];
			$prev_gsm_arr[$prev_data_ref[6]]=$prev_data_ref[6];
			$prev_width_arr[$prev_data_ref[7]]=$prev_data_ref[7];
			$prev_uom_arr[$prev_data_ref[8]]=$prev_data_ref[8];
		}

		$color_name_array=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0",'color_name','id');
		$previous_wo_ids=implode(",",$prev_wo_id_arr);
		$prev_wo_nums=implode(",",$prev_wo_num_arr);
		$prev_deters=implode(",",$prev_deter_arr);
		foreach($prev_color_arr as $color_names)
		{
			$prev_colors.=$color_name_array[$color_names].",";
		}
		$prev_colors=chop($prev_colors,",");
		$prev_constructs=implode(",",$prev_construct_arr);
		$prev_compositions=implode(",",$prev_composition_arr);
		$prev_gsms=implode(",",$prev_gsm_arr);
		$prev_widths=implode(",",$prev_width_arr);
		$prev_uoms=implode(",",$prev_uom_arr);
	}
	
	//echo $previous_wo_ids;die;

	?>

	<script>

		var item_category_id=<? echo $item_category_id; ?>;
		/*$(document).ready(function(e) {
			load_drop_down( 'pi_controller_urmi',<?echo $importer_id; ?>+'_'+item_category, 'load_supplier_dropdown', 'supplier_td' );
			$('#cbo_supplier_id').val( <?echo $supplier_id; ?> );
		});*/

		var selected_id = new Array; var selected_id_check = new Array; selected_name = new Array();var order_type_arr = new Array; order_type = new Array;

		function check_all_data()
		{
			var tbl_row_count = document.getElementById( 'tbl_list_search' ).rows.length;
			tbl_row_count = tbl_row_count - 1;

			for( var i = 1; i <= tbl_row_count; i++ )
			{
				$('#tr_'+i).trigger('click');
			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function js_set_value( str )
		{

			//var selected_id = new Array;
			//alert(str);
			if (str!="") str=str.split("_");

			if(item_category_id==4)
			{
				//var approved_setting = return_global_ajax_value(str[6], 'check_trims_approval_setting', '', 'pi_controller_urmi');
				var approved_setting=str[7];
				if(str[5]==3 && approved_setting ==1)
				{
					alert("Work Order is Partial Approved. Please Approve it to select"); return;
				}
				else if(str[5]!=1 && str[5]!=3 && approved_setting ==1)
				{
					alert("Work Order is not Approved. Please Approve it to select"); return;
				}
				var id_sensitivity=str[1];
				var id_sensitivity_type=str[3];
			}

			else
			{
				if(item_category_id==1)
				{
					if(str[4]==1)
					{
						if(str[2]==3)
						{
							alert("Work Order is Partial Approved. Please Approve it to select"); return;
						}
						else if(str[2]!=1 && str[2]!=3)
						{
							alert("Work Order is not Approved. Please Approve it to select"); return;
						}
					}
				}
				if(item_category_id==2 || item_category_id==3)
				{
					//var approved_setting = return_global_ajax_value(str[6], 'check_trims_approval_setting', '', 'pi_controller_urmi');
					var approved_setting=str[4];
					if(str[2]==3 && approved_setting ==1)
					{
						alert("Work Order is Partial Approved. Please Approve it to select"); return;
					}
					else if(str[2]!=1 && str[2]!=3 && approved_setting ==1)
					{
						alert("Work Order is not Approved. Please Approve it to select"); return;
					}
					//var id_sensitivity=str[1];
					//var id_sensitivity_type=+str[3];
				}

				if(item_category_id==31)
				{
					var approved_setting=str[3];					
					if(str[2]==3 && approved_setting ==1)
					{
						alert("Work Order is Partial Approved. Please Approve it to select"); return;
					}
					else if(str[2]!=1 && str[2]!=3 && approved_setting ==1)
					{
						alert("Work Order is not Approved. Please Approve it to select"); return;
					}
				}
				

				var purchase_order_array=[5,6,7,8,9,10,11,15,16,17,18,19,20,21,22,32,34,36,35,37,38,39,23,33,40,41,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,69,70,89,90,91,92,93,94];
				if(jQuery.inArray(item_category_id, purchase_order_array) !== -1)
				{
					//alert(item_category_id+"_"+str[2]+"_"+str[3]+"_"+str[4]);
					if(str[2]==1)
					{
						if(str[4]==1)
						{
							if(str[3]!=1 && str[3]!=3)
							{
								alert("Work Order is not Approved. Please Approve it to select"); return;
							}
						}
						else {
							if(str[3]!=1)
							{
								alert("Work Order is not Approved. Please Approve it to select"); return;
							}
						}
					}
					//return;
				}
				//alert(str[1]);
				var id_sensitivity_ref=str[1].split("*");
				var id_sensitivity=id_sensitivity_ref[0];
				var id_sensitivity_type=id_sensitivity_ref[1];
			}

			/*if(item_category==4)
				var id_sensitivity=str[1]+"_"+str[2]+"_"+str[3];

			else

				var id_sensitivity_ref=str[1].split("*");
				var id_sensitivity=id_sensitivity_ref[0];
				var id_sensitivity_type=id_sensitivity_ref[1];*/

			if(order_type_arr.length==0)
			{
				order_type_arr.push( id_sensitivity_type );
			}
			else if( jQuery.inArray( id_sensitivity_type, order_type_arr )==-1 &&  order_type_arr.length>0)
			{
				alert("Order and Non Order Mixed is Not Allow");
				return;
			}

			toggle( document.getElementById( 'tr_' + str[0] ), '#FFFFCC' );

			var tot_wo_amt=$('#totWoAmt').val()*1;
			var wo_amt=$('#woAmt_'+str[0]).val()*1;

			if( jQuery.inArray( id_sensitivity, selected_id ) == -1 ) {
				selected_id.push( id_sensitivity );
				$('#totWoAmt').val(number_format_common((tot_wo_amt+wo_amt),5));
			}
			else
			{
				for( var i = 0; i < selected_id.length; i++ )
				{
					if( selected_id[i] == id_sensitivity ) break;
				}
				selected_id.splice( i, 1 );
				$('#totWoAmt').val(number_format_common((tot_wo_amt-wo_amt),5));
			}



			var id = ''; var ord_type= '';
			for( var i = 0; i < selected_id.length; i++ ) {
				id += selected_id[i] + ',';
			}
			id = id.substr( 0, id.length - 1 );
			ord_type = order_type_arr[0];
			//alert(ord_type);
			$('#txt_selected_wo_id').val( id );
			$('#order_non_order_type').val( ord_type );
		}

		function reset_hide_field()
		{
			$('#txt_selected_wo_id').val( '' );
			selected_id = new Array();
			selected_name = new Array();
		}

	</script>

	</head>

	<body>
	<div align="center" style="width:1200px;">
		<form name="searchwofrm"  id="searchwofrm">
			<fieldset style="width:100%;">
			<legend>Enter search words</legend>
				<table cellpadding="0" cellspacing="0" width="1080" border="1" rules="all" class="rpt_table">
					<thead>
						<th>Company</th>
						<th>Buyer</th>
						<th>Supplier</th>
						<th>Year</th>
						<th>WO Number</th>
						<th>WO Date Range</th>
						<th>Based on</th>
						<th>
							<input type="reset" name="reset" id="reset" value="Reset" style="width:100px" class="formbutton" onClick="reset_hide_field()" />
							<input type="hidden" name="txt_item_category" id="txt_item_category" class="text_boxes" style="width:70px" value="<? echo $item_category_id; ?>">
							<input type="hidden" name="txt_goods_rcv_status" id="txt_goods_rcv_status" class="text_boxes" style="width:70px" value="<? echo $goods_rcv_status; ?>">
							<input type="hidden" name="txt_selected_wo_id" id="txt_selected_wo_id" class="text_boxes" value="">
							<input type="hidden" name="order_non_order_type" id="order_non_order_type" class="text_boxes" value="">
						</th>
					</thead>
					<tr class="general">
						<td>
						<?
							//load_drop_down( 'pi_controller_urmi',this.value+'_'+$item_category_id, 'load_supplier_dropdown', 'supplier_td' );
							if($importer_id>0) $dis_ana=1; else $dis_ana=0;
							echo create_drop_down( "cbo_importer_id", 151,"select comp.id, comp.company_name from lib_company comp where comp.status_active=1 and comp.is_deleted=0 $company_cond order by comp.company_name",'id,company_name', 1, 'Select',$importer_id,"",$dis_ana);
						?>
						</td>
						<td id="buyer_td">
						<?
							if($mst_buyer_id>0) $dis_buyer=1; else $dis_buyer=0;
							$buyer_cond="";
							if($user_buyer_id!="") $buyer_cond=" and buy.id in($user_buyer_id)";
							echo create_drop_down( "cbo_buyer_name", 150,"select buy.id, buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$importer_id' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buy.buyer_name",'id,buyer_name', 1, '-- Select --',$mst_buyer_id, "",$dis_buyer);
						?>
						</td>
						<td id="supplier_td">
						<?
						if($importer_id>0 && $supplier_id>0)
						{
							echo create_drop_down( "cbo_supplier_id", 151,"select DISTINCT(c.supplier_name),c.id from  lib_supplier_tag_company a, lib_supplier c where c.id=a.supplier_id and a.tag_company=$importer_id and c.id=$supplier_id and c.status_active=1 and c.is_deleted=0 order by c.supplier_name",'id,supplier_name', 1, '-- Select Supplier --',$supplier_id,'',1);
						}
						else if($importer_id>0 && $supplier_id<1)
						{
							echo create_drop_down( "cbo_supplier_id", 151,"select DISTINCT(c.supplier_name),c.id from  lib_supplier_tag_company a, lib_supplier c where c.id=a.supplier_id and a.tag_company=$importer_id and c.status_active=1 and c.is_deleted=0 order by c.supplier_name",'id,supplier_name', 1, '-- Select Supplier --',0,'',0);
						}
						else
						{
							echo create_drop_down( "cbo_supplier_id", 151, $blank_array,"", 1, "-- Select Supplier --", 0, "" );
						}

						?>
						</td>
						<td align="center">
							<?
								echo create_drop_down( "cbo_year", 80, create_year_array(),"", 1,"-- All --", date("Y",time()), "",0,"" ); 
							?> 
                        </td>
						<td>
							<input type="text" name="txt_wo_no" id="txt_wo_no" class="text_boxes" style="width:120px">
						</td>
						<td align="center">
						<input type="text" name="txt_date_from" id="txt_date_from" class="datepicker" style="width:70px">To
						<input type="text" name="txt_date_to" id="txt_date_to" class="datepicker" style="width:70px">
						</td>
						<td>
						<?
							$wo_based_on=array(1=>"Work Orde Wise",2=>"Item Wise");
							/*if($item_category==2 || $item_category==4)
							{
								echo create_drop_down( "cbo_based_on", 100, $wo_based_on,"", 1, "Select", 1, "",0 );
							}
							else
							{
								echo create_drop_down( "cbo_based_on", 100, $wo_based_on,"", 1, "Select", 0, "",1 );
							}*/
							echo create_drop_down( "cbo_based_on", 100, $wo_based_on,"", 0, "", 1, "",0 );
						?>
						</td>

						<td align="center">
							<input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('txt_wo_no').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('txt_item_category').value+'_'+document.getElementById('cbo_importer_id').value+'_'+document.getElementById('cbo_supplier_id').value+'_'+document.getElementById('cbo_year_selection').value+'_'+document.getElementById('cbo_based_on').value+'_'+document.getElementById('txt_goods_rcv_status').value+'_'+'<? echo $prev_wo_ids; ?>'+'_'+'<? echo $previous_wo_ids; ?>'+'_'+'<? echo $prev_deters; ?>'+'_'+'<? echo $prev_colors; ?>'+'_'+'<? echo $prev_constructs; ?>'+'_'+'<? echo $prev_compositions; ?>'+'_'+'<? echo $prev_gsms; ?>'+'_'+'<? echo $prev_widths; ?>'+'_'+'<? echo $prev_uoms; ?>'+'_'+document.getElementById('cbo_buyer_name').value+'_'+'<? echo $pi_mst_id; ?>'+'_'+document.getElementById('cbo_year').value, 'create_wo_search_list_view', 'search_div', 'pi_controller_urmi', 'setFilterGrid(\'tbl_list_search\',-1);reset_hide_field();')" style="width:100px;" />
						</td>
					</tr>
					<tr>
						<td colspan="7" align="center" height="40" valign="middle"><? echo load_month_buttons(1); ?></td>
					</tr>
			</table>
			<table width="100%" style="margin-top:5px">
					<tr>
						<td colspan="6">
							<div style="width:100%; margin-top:10px; margin-left:10px" id="search_div" align="left"></div>
						</td>
					</tr>
				</table>
			</fieldset>
		</form>
	</div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	<script>
		$('#cbo_supplier_id').val( <? echo $supplier_id; ?> );
	</script>
	</html>
	<?
	exit();
}

if($action=="create_wo_search_list_view")
{
	$data = explode("_",$data);
	// print_r($data);
	$item_category_id =$data[3];
	$company_id =$data[4];
	$selected_based_on=$data[7];
	$goods_rcv_status=$data[8];
	$prev_wo_ids=$data[9];
	$buyer_id = $data[18];
	$pi_mst_id = $data[19];
	$wo_year = $data[20];
	//echo $buyer_id;die;
	$goods_rcv_variable=return_field_value("export_invoice_qty_source as source","variable_settings_commercial","company_name=$company_id and variable_list=23 and status_active=1","source");
	//echo $goods_rcv_status.'**'.$goods_rcv_variable;
	$sql=sql_select("select approval_need,b.page_id, a.setup_date from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$company_id and b.page_id in (5,6,7,8,9,10,11,12,33,50) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	foreach($sql as $row){
		$trims_approval_need_arr[$row[csf('page_id')]]=$row[csf('approval_need')];
		$test_data[$row[csf('page_id')]]=$row[csf('approval_need')]."=".$row[csf('setup_date')];
	}
	//echo $item_category_id; die;
	//echo "<pre>";print_r($test_data);die;
	$approval_needed=0;
	//echo $trims_approval_setting;die;
	if($item_category_id==2 || $item_category_id==3)
	{
		$prev_wo_mst_ids=$data[10];
		$prev_dtls_data_arr=array();
		if($selected_based_on==2 && $prev_wo_mst_ids!="")
		{
			$prev_deters=$data[11];
			$prev_colors=$data[12];
			$prev_constructs_data=$data[13];
			$prev_compositions_data=$data[14];
			$prev_gsms=$data[15];
			$prev_widths_data=$data[16];
			$prev_uoms=$data[17];

			$prev_construct_arr=explode(",",$prev_constructs_data);
			foreach($prev_construct_arr as $prev_construct)
			{
				$prev_constructs.="'".$prev_construct."',";
			}
			$prev_constructs=chop($prev_constructs,",");

			$prev_composition_arr=explode(",",$prev_compositions_data);
			foreach($prev_composition_arr as $prev_composition)
			{
				$prev_compositions.="'".$prev_composition."',";
			}
			$prev_compositions=chop($prev_compositions,",");
			$prev_width_arr=explode(",",$prev_widths_data);
			foreach($prev_width_arr as $prev_width)
			{
				$prev_widths.="'".$prev_width."',";
			}
			$prev_widths=chop($prev_widths,",");

			$sql_prev_cond="";
			if($prev_deters!="") $sql_prev_cond.=" and c.lib_yarn_count_deter_id in($prev_deters)";
			if($prev_colors!="") $sql_prev_cond.=" and b.fabric_color_id in($prev_colors)";
			if($prev_constructs!="") $sql_prev_cond.=" and c.construction in($prev_constructs)";
			if($prev_compositions!="") $sql_prev_cond.=" and c.composition in($prev_compositions)";
			if($prev_gsms!="") $sql_prev_cond.=" and c.gsm_weight in($prev_gsms)";
			if($prev_widths!="") $sql_prev_cond.=" and b.dia_width in($prev_widths)";
			if($prev_uoms!="") $sql_prev_cond.=" and c.uom in($prev_uoms)";


			$sql_prev_cond2="";
			if($prev_colors!="") $sql_prev_cond2.=" and b.fabric_color in($prev_colors)";
			if($prev_constructs!="") $sql_prev_cond2.=" and b.construction in($prev_constructs)";
			if($prev_compositions!="") $sql_prev_cond2.=" and b.composition in($prev_compositions)";

			if($prev_gsms!="") $sql_prev_cond2.=" and  b.gsm_weight in($prev_gsms)";
			if($prev_widths!="") $sql_prev_cond2.=" and b.dia_width in($prev_widths)";
			if($prev_uoms!="") $sql_prev_cond2.=" and b.uom in($prev_uoms)";


			if($db_type==0)
			{
				$sql_prev = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, group_concat(b.id) as dtls_id, b.fabric_color_id as  fabric_color_id, sum(b.fin_fab_qnty) as wo_qnty, c.lib_yarn_count_deter_id, c.construction as construction, c.composition as copmposition, c.gsm_weight as gsm_weight, b.dia_width, c.uom, 1 as type
				from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
				where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.id in($prev_wo_mst_ids) $sql_prev_cond
				group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, b.fabric_color_id, c.lib_yarn_count_deter_id, c.construction, c.composition, c.gsm_weight, b.dia_width, c.uom
				union all
				select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, group_concat(b.id) as dtls_id, b.fabric_color as  fabric_color_id, sum(b.grey_fabric) as wo_qnty, 0 as lib_yarn_count_deter_id, b.construction, b.composition as copmposition, b.gsm_weight, b.dia_width, b.uom, 2 as type
				from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.id in($prev_wo_mst_ids) $sql_prev_cond2
				group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, b.fabric_color, b.construction, b.composition, b.gsm_weight, b.dia_width, b.uom";

			}
			else
			{
				$sql_prev = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, b.fabric_color_id as  fabric_color_id, sum(b.fin_fab_qnty) as wo_qnty, c.lib_yarn_count_deter_id, c.construction as construction, c.composition as copmposition, c.gsm_weight as gsm_weight, b.dia_width, c.uom, 1 as type
				from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
				where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.id in($prev_wo_mst_ids) $sql_prev_cond
				group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, b.fabric_color_id, c.lib_yarn_count_deter_id, c.construction, c.composition, c.gsm_weight, b.dia_width, c.uom
				union all
				select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, b.fabric_color as  fabric_color_id, sum(b.grey_fabric) as wo_qnty, 0 as lib_yarn_count_deter_id, b.construction, b.composition as copmposition, b.gsm_weight, b.dia_width, b.uom, 2 as type
				from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.id in($prev_wo_mst_ids) $sql_prev_cond2
				group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, b.fabric_color, b.construction, b.composition, b.gsm_weight, b.dia_width, b.uom";
			}

			//echo $sql_prev;//die;
			$prev_wo_id_arr=$prev_wo_num_arr=$prev_deter_arr=$prev_color_arr=$prev_construct_arr=$prev_composition_arr=$prev_gsm_arr=$prev_width_arr=$prev_uom_arr=array();
			$sql_prev_result=sql_select($sql_prev);
			foreach($sql_prev_result as $row)
			{
				$prev_dtls_data_arr[$row[csf("booking_no")]][$row[csf("lib_yarn_count_deter_id")]][$row[csf("fabric_color_id")]][$row[csf("construction")]][$row[csf("copmposition")]][$row[csf("gsm_weight")]][$row[csf("dia_width")]][$row[csf("uom")]]=$row[csf("booking_no")];
			}
		}
	}

	$prev_wo_ids_cond=""; $prev_wo_ids_cond2=""; $prev_wo_ids_cond3=""; $prev_wo_ids_cond4="";
	if($prev_wo_ids!="")
	{
		
		$prev_wo_ids_cond=" and b.id not in($prev_wo_ids)";
		$prev_wo_ids_cond2=" and c.id not in($prev_wo_ids)";
		$prev_wo_ids_cond3=" and d.id not in($prev_wo_ids)";
		$prev_wo_ids_cond4=" and e.id not in($prev_wo_ids)";
		$prev_piwo_ids_cond=" and b.work_order_dtls_id not in($prev_wo_ids)";
	}
	
	$pi_dtls_count=return_field_value("count(work_order_dtls_id) as tot_row","com_pi_item_details","status_active=1 and is_deleted=0 and work_order_dtls_id>0 and pi_id=$pi_mst_id","tot_row");
	if($pi_dtls_count)
	{
		//echo $pi_dtls_count.test;die;
		$prev_wo_ids_cond=" and b.id not in(select work_order_dtls_id from com_pi_item_details where status_active=1 and is_deleted=0 and pi_id=$pi_mst_id group by work_order_dtls_id)";
		$prev_wo_ids_cond2=" and c.id not in(select work_order_dtls_id from com_pi_item_details where status_active=1 and is_deleted=0 and pi_id=$pi_mst_id group by work_order_dtls_id)";
		$prev_wo_ids_cond3=" and d.id not in(select work_order_dtls_id from com_pi_item_details where status_active=1 and is_deleted=0 and pi_id=$pi_mst_id group by work_order_dtls_id)";
		$prev_wo_ids_cond4=" and e.id not in(select work_order_dtls_id from com_pi_item_details where status_active=1 and is_deleted=0 and pi_id=$pi_mst_id group by work_order_dtls_id)";
		$prev_piwo_ids_cond=" and b.work_order_dtls_id not in(select work_order_dtls_id from com_pi_item_details where status_active=1 and is_deleted=0 and pi_id=$pi_mst_id group by work_order_dtls_id)";
	}

	if($company_id==0) { echo "Please Select Company First."; die; }
	if($data[5]==0) $supplier_id="%%"; else $supplier_id =$data[5];

	if($item_category_id==2 || $item_category_id==3 || $item_category_id==4 || $item_category_id==12 || $item_category_id==24 || $item_category_id==25 || $item_category_id==102 || $item_category_id==103 || $item_category_id==104 || $item_category_id==115  || $item_category_id==100)
	{
		if ($data[1]!="" &&  $data[2]!="")
		{
			if($db_type==0)
			{
				$wo_date_cond = "and a.booking_date between '".change_date_format($data[1], "yyyy-mm-dd", "-")."' and '".change_date_format($data[2], "yyyy-mm-dd", "-")."'";
				$wo_date_cond2 = "and c.booking_date between '".change_date_format($data[1], "yyyy-mm-dd", "-")."' and '".change_date_format($data[2], "yyyy-mm-dd", "-")."'";
				$sample_wo_date_cond = "and s.booking_date between '".change_date_format($data[1], "yyyy-mm-dd", "-")."' and '".change_date_format($data[2], "yyyy-mm-dd", "-")."'";
				$dyeing_wo_date_cond = "and a.wo_date between '".change_date_format($data[1], "yyyy-mm-dd", "-")."' and '".change_date_format($data[2], "yyyy-mm-dd", "-")."'";
			}
			else
			{
				$wo_date_cond = "and a.booking_date between '".change_date_format($data[1],'','',1)."' and '".change_date_format($data[2],'','',1)."'";
				$wo_date_cond2 = "and c.booking_date between '".change_date_format($data[1],'','',1)."' and '".change_date_format($data[2],'','',1)."'";
				$sample_wo_date_cond = "and s.booking_date between '".change_date_format($data[1],'','',1)."' and '".change_date_format($data[2],'','',1)."'";
				$dyeing_wo_date_cond = "and a.wo_date between '".change_date_format($data[1],'','',1)."' and '".change_date_format($data[2],'','',1)."'";
			}
		}
		else
		{
			$wo_date_cond ="";
			$wo_date_cond2 ="";
			$sample_wo_date_cond ="";
		}
	}
	else
	{
		if ($data[1]!="" &&  $data[2]!="")
		{
			if($db_type==0)
			{
				$wo_date_cond = "and a.wo_date between '".change_date_format($data[1], "yyyy-mm-dd", "-")."' and '".change_date_format($data[2], "yyyy-mm-dd", "-")."'";
			}
			else
			{
				$wo_date_cond = "and a.wo_date between '".change_date_format($data[1],'','',1)."' and '".change_date_format($data[2],'','',1)."'";
			}
		}
		else
		{
			$wo_date_cond ="";
		}
	}
	
	$pi_currency_id=return_field_value("currency_id","com_pi_master_details","id=$pi_mst_id","currency_id");
	
	if($item_category_id==1)  // Yarn
	{
		$aproval_necessity=0;
		if($db_type==0)
		{
			$necessity_sql=sql_select("select b.approval_need as approval_need, a.id as max_id from approval_setup_mst a, approval_setup_dtls b
			where a.id=b.mst_id and a.company_id = $company_id and b.page_id in (15,40) and a.status_active = 1 and a.is_deleted = 0 and b.status_active = 1 and b.is_deleted = 0
			order by a.id desc limit 1");
		}
		else
		{
			$necessity_sql=sql_select("select b.approval_need as approval_need, a.id as max_id from approval_setup_mst a, approval_setup_dtls b
			where a.id=b.mst_id and a.company_id = $company_id and b.page_id in (15,40) and a.status_active = 1 and a.is_deleted = 0 and b.status_active = 1 and b.is_deleted = 0 and a.setup_date=(select max(setup_date) as id from approval_setup_mst where company_id = $company_id and status_active=1)");
		}
		$aproval_necessity=$necessity_sql[0][csf("approval_need")];

		if($data[0]!="") $wo_number=" and a.wo_number like '%".trim($data[0])."'"; else { $wo_number = ''; }
		// $prev_wo_ids_cond
		if ($wo_year != 0){
			$wo_year_con = " and to_char(a.insert_date,'YYYY') ='$wo_year'";
			$wo_year_con_sample = " and to_char(s.insert_date,'YYYY') ='$wo_year'";
		}

		
		$approval_status="select approval_need, allow_partial from approval_setup_dtls where mst_id=(select id from approval_setup_mst where company_id='$company_id' and setup_date=(select max(setup_date) from approval_setup_mst where setup_date <= '".change_date_format(date('d-m-Y'), "", "",1)."' and company_id='$company_id')) and page_id=59 and status_active=1 and is_deleted=0";
		
		//echo $approval_status;//die;
		$approval_status=sql_select($approval_status);
		if($approval_status[0][csf('approval_need')]==1)
		{
			if($approval_status[0][csf('allow_partial')]==1)
			{
				$approval_status_cond= " and a.is_approved <> 0";
			}
			else
			{
				$approval_status_cond= " and a.is_approved = 1";
			}
		}
		

		if($selected_based_on==1)
		{
			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				if($db_type==0)
				{
					$sql = "select  a.id as mst_id, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.supplier_id, group_concat(c.id) as id, a.is_approved
					from wo_non_order_info_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form=1 and b.receive_purpose!=2 and c.item_category=1 and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id=1 and a.company_name=$company_id and c.pi_is_lock!=1 and a.pay_mode=1 and a.supplier_id and c.transaction_type=1  like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $prev_wo_ids_cond2 $approval_status_cond
					group by a.id, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.supplier_id, a.is_approved
					order by a.wo_number_prefix_num desc";
				}
				else
				{
					$sql = "select a.id as mst_id, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.supplier_id, rtrim(xmlagg(xmlelement(e,c.id,',').extract('//text()') order by c.id).GetClobVal(),',') AS id , a.is_approved
					from wo_non_order_info_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form=1 and b.receive_purpose!=2 and c.item_category=1 and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id=1 and a.company_name=$company_id and c.pi_is_lock!=1 and a.pay_mode=1 and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  and c.transaction_type=1  $wo_number $wo_date_cond $prev_wo_ids_cond2 $wo_year_con $approval_status_cond
					group by a.id, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.supplier_id , a.is_approved
					order by a.wo_number_prefix_num desc";
				}
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
				if($db_type==0)
				{
					$sql = "select a.id as mst_id, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.supplier_id, group_concat(b.id) as id, sum(b.supplier_order_quantity) as wo_qnty , a.is_approved
					from wo_non_order_info_mst a, wo_non_order_info_dtls b
					where a.id=b.mst_id and a.company_name=$company_id and b.item_category_id=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $pay_mode_cond $approval_status_cond
					group by  a.id, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.supplier_id, a.is_approved
					order by a.wo_number_prefix_num desc";
				}
				else
				{
					$sql = "select a.id as mst_id, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS id , sum(b.supplier_order_quantity) as wo_qnty, a.is_approved
					from wo_non_order_info_mst a, wo_non_order_info_dtls b
					where a.id=b.mst_id and a.company_name=$company_id and b.item_category_id=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $pay_mode_cond $wo_year_con $approval_status_cond
					group by  a.id, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.supplier_id, a.is_approved
					order by a.wo_number_prefix_num desc";
				}
			}
			$prev_pi_qnty_arr=return_library_array("select b.work_order_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_id",'work_order_id','quantity');
			//echo $prev_piwo_ids_cond;
		}
		else
		{
			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				$sql = "select a.wo_number_prefix_num, a.wo_number, a.wo_date, a.supplier_id, c.id, d.color as color_name, d.yarn_count_id as yarn_count, d.yarn_comp_type1st, d.yarn_comp_percent1st, d.yarn_comp_type2nd, d.yarn_comp_percent2nd, d.yarn_type, d.unit_of_measure as uom , a.is_approved
				from wo_non_order_info_mst a, inv_receive_master b, inv_transaction c, product_details_master d where a.id=b.booking_id and b.id=c.mst_id and b.entry_form=1 and b.receive_purpose!=2 and c.item_category=1 and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id=1 and a.company_name=$company_id and c.pi_is_lock!=1 and a.pay_mode=1 and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.transaction_type=1  $wo_number $wo_date_cond $prev_wo_ids_cond2 $wo_year_con $approval_status_cond order by a.wo_number_prefix_num desc";
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
				$sql = "select a.wo_number_prefix_num, a.wo_number, a.wo_date, a.supplier_id, b.id, b.color_name, b.yarn_count, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.uom, b.supplier_order_quantity as wo_qnty , a.is_approved
				from wo_non_order_info_mst a, wo_non_order_info_dtls b
				where a.id=b.mst_id and a.company_name=$company_id and b.item_category_id=$item_category_idand a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $pay_mode_cond $wo_year_con $approval_status_cond order by a.wo_number_prefix_num desc";
			}

			$prev_pi_qnty_arr=return_library_array("select b.work_order_dtls_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_dtls_id",'work_order_dtls_id','quantity');
			//$prev_piwo_ids_cond
		}

		// echo $sql;
		$supplier_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');
		$yarn_count = return_library_array('SELECT id,yarn_count FROM lib_yarn_count','id','yarn_count');

		$result = sql_select($sql);


		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{
			?>
			<table cellspacing="0" cellpadding="0" border="1" rules="all" width="880" class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="70">WO No</th>
					<th width="80">WO Date</th>
					<th width="130">Supplier</th>
					<th width="80">Color</th>
					<th width="60">Count</th>
					<th width="70">Item 1st</th>
					<th width="60">Perc. 1st</th>
					<th width="70">Item 2nd</th>
					<th width="60">Perc. 2nd</th>
					<th width="80">Yarn Type</th>
					<th>UOM</th>
				</thead>
			 </table>
			 <div style="width:880px; max-height:250px; overflow-y:scroll">
				 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="860" class="rpt_table" id="tbl_list_search">
				 <?
				 $i=1;
				 foreach ($result as $row)
				 {
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					if($db_type==2 && $selected_based_on==1 ) $row[csf('id')] = $row[csf('id')]->load();
					if($aproval_necessity==1)
					{
						if($row[csf('is_approved')]!=1) $bgcolor="#ffa38f";
					}
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$row[csf('id')]."_".$row[csf('is_approved')]."_".$company_id."_".$aproval_necessity;?>')">
						<td width="40"><? echo "$i"; ?></td>
						<td width="70"><p><? echo $row[csf('wo_number_prefix_num')];?></p></td>
						<td width="80" align="center"><p><? if($row[csf('wo_date')]!="" && $row[csf('wo_date')]!="0000-00-00") echo change_date_format($row[csf('wo_date')]);?></p></td>
						<td width="130"><p><? echo $supplier_arr[$row[csf('supplier_id')]]; ?>&nbsp;</p></td>
						<td width="80"><p><? echo $color_library[$row[csf('color_name')]]; ?>&nbsp;</p></td>
						<td width="60"><p><? echo $yarn_count[$row[csf('yarn_count')]]; ?>&nbsp;</p></td>
						<td width="70"><p><? echo $composition[$row[csf('yarn_comp_type1st')]]; ?></p></td>
						<td width="60"><p><? echo $row[csf('yarn_comp_percent1st')]; ?></p></td>
						<td width="70"><p><? echo $composition[$row[csf('yarn_comp_type2nd')]]; ?>&nbsp;</p></td>
						<td align="center" width="60"><p><? echo $row[csf('yarn_comp_percent2nd')]; ?>&nbsp;</p></td>
						<td width="80"><p><? echo $yarn_type[$row[csf('yarn_type')]]; ?>&nbsp;</p></td>
						<td><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?>&nbsp;</p></td>
					</tr>
					 <?
					 $i++;
				 }
				 ?>
				</table>
			</div>
			<?
		}
		else
		{
			?>
			<table cellspacing="0" cellpadding="0" border="1" rules="all" width="880" class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="70">WO No</th>
					<th width="80">WO Date</th>
					<th width="130">Supplier</th>
					<th width="80">Color</th>
					<th width="60">Count</th>
					<th width="70">Item 1st</th>
					<th width="60">Perc. 1st</th>
					<th width="70">Item 2nd</th>
					<th width="60">Perc. 2nd</th>
					<th width="80">Yarn Type</th>
					<th>UOM</th>
				</thead>
			 </table>
			 <div style="width:880px; max-height:250px; overflow-y:scroll">
				 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="860" class="rpt_table" id="tbl_list_search">
				 <?
				 $i=1;
				 foreach ($result as $row)
				 {
				 	if($db_type==2 && $selected_based_on==1 ) $row[csf('id')] = $row[csf('id')]->load();
				 	if($i%2==0) $bgcolor="#E9F3FF";  else $bgcolor="#FFFFFF";
					if($aproval_necessity==1)
					{
						if($row[csf('is_approved')]!=1) $bgcolor="#ffa38f";
					}

					//if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF"; //mst_id
					if($selected_based_on==1)
					{
						$balance_qnty=$row[csf('wo_qnty')]-$prev_pi_qnty_arr[$row[csf('mst_id')]];
					}
					else
					{
						$balance_qnty=$row[csf('wo_qnty')]-$prev_pi_qnty_arr[$row[csf('id')]];
					}
					if(number_format($balance_qnty,4,'.','')>0)
					{
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$row[csf('id')]."_".$row[csf('is_approved')]."_".$company_id."_".$aproval_necessity;?>')">
							<td width="40"><? echo "$i"; ?></td>
							<td width="70"><p><? echo $row[csf('wo_number_prefix_num')];?></p></td>
							<td width="80" align="center"><p><? if($row[csf('wo_date')]!="" && $row[csf('wo_date')]!="0000-00-00") echo change_date_format($row[csf('wo_date')]);?></p></td>
							<td width="130"><p><? echo $supplier_arr[$row[csf('supplier_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $color_library[$row[csf('color_name')]]; ?>&nbsp;</p></td>
							<td width="60"><p><? echo $yarn_count[$row[csf('yarn_count')]]; ?>&nbsp;</p></td>


							<td width="70"><p><? echo $composition[$row[csf('yarn_comp_type1st')]]; ?></p></td>
							<td width="60"><p><? echo $row[csf('yarn_comp_percent1st')]; ?></p></td>
							<td width="70"><p><? echo $composition[$row[csf('yarn_comp_type2nd')]]; ?>&nbsp;</p></td>
							<td align="center" width="60"><p><? echo $row[csf('yarn_comp_percent2nd')]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $yarn_type[$row[csf('yarn_type')]]; ?>&nbsp;</p></td>
							<td><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?>&nbsp;</p></td>
						</tr>
						<?
						$i++;
					}
				 }
				 ?>
				</table>
			</div>
			<?
		}
		?>
        <table width="880" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
        <?
	}

	else if($item_category_id==2)  // Knit Finish Fabric
	{
		//echo $user_buyer_id.tst;die;
		$buyer_id_cond='';
		if ($buyer_id != 0){
			$buyer_id_cond = " and a.buyer_id=$buyer_id";
		}
		if($user_buyer_id!="") $buyer_id_cond .= " and a.buyer_id in($user_buyer_id)";

		if ($data[0]!="")
		{
			$wo_number=" and a.booking_no like '%".trim($data[0])."'";
			$pi_wo_number=" and b.work_order_no like '%".trim($data[0])."'";
		}
		else
		{
			$wo_number = '';
			$pi_wo_number="";
		}
		if ($wo_year != 0){
			$wo_year_con = " and TO_CHAR(a.booking_date,'YYYY') ='$wo_year'";
		}
		//echo $selected_based_on."==".$goods_rcv_status."==".$goods_rcv_variable;die;
		if($selected_based_on==1)
		{
			//echo "$goods_rcv_status = $goods_rcv_variable";die;
			$prev_wo_mst_cond="";
			if($prev_wo_mst_ids!="") $prev_wo_mst_cond=" and a.id not in($prev_wo_mst_ids)";
			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				if($db_type==0)
				{
					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(c.id) as dtls_id, 1 as type
					from wo_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and a.ISGREYFAB_PURCHASE<>1 and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(c.id) as dtls_id, 2 as type
					from wo_non_ord_samp_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1  and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id
					order by booking_no_prefix_num desc";
				}
				else
				{
					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id,rtrim(xmlagg(xmlelement(e,c.id,',').extract('//text()') order by c.id).GetClobVal(),',') AS dtls_id , 1 as type
					from wo_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and a.ISGREYFAB_PURCHASE<>1 and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,c.id,',').extract('//text()') order by c.id).GetClobVal(),',') AS dtls_id, 2 as type
					from wo_non_ord_samp_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1  and c.transaction_type=1  $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id
					order by booking_no_prefix_num desc";
				}
				// and c.pi_is_lock!=1 and c.pi_is_lock!=1
				//echo $sql;//die;
				$construction_arr=array(); $composition_arr=array();
				$sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
				$data_array=sql_select($sql_deter);
				if(count($data_array)>0)
				{
					foreach( $data_array as $row )
					{
						$construction_arr[$row[csf('id')]]=$row[csf('construction')];

						if(array_key_exists($row[csf('id')],$composition_arr))
						{
							$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
						else
						{
							$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
					}
				}
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
				if($db_type==0)
				{
					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(b.id) as dtls_id, sum(b.fin_fab_qnty) as wo_qnty, 1 as type,a.is_approved
					from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
					where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.ISGREYFAB_PURCHASE<>1 and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond $pay_mode_cond
					group by a.id, a.booking_type, a.is_short,a.is_approved, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(b.id) as dtls_id, sum(b.grey_fabric) as wo_qnty, 2 as type,a.is_approved
					from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond $pay_mode_cond
					group by a.id, a.booking_type, a.is_short,a.is_approved, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id
					order by booking_no_prefix_num desc";
				}
				else
				{
					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date,  a.buyer_id, a.supplier_id,  rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') as dtls_id, sum(b.fin_fab_qnty) as wo_qnty, 1 as type,a.is_approved, max(b.fabric_color_id) as fabric_color_id, max(b.construction) as construction, max(b.copmposition) as copmposition, max(b.gsm_weight) as gsm_weight, max(b.dia_width) as dia_width, max(b.uom) as uom
					from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
					where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.ISGREYFAB_PURCHASE<>1 and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond $pay_mode_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short,a.is_approved, a.booking_no_prefix_num, a.booking_no, a.booking_date,  a.buyer_id, a.supplier_id
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date,  a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') as dtls_id, sum(b.grey_fabric) as wo_qnty, 2 as type,a.is_approved, 0 as fabric_color_id, null as construction, null as copmposition, null as gsm_weight, null as dia_width, null as uom
					from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond $pay_mode_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short,a.is_approved, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id
					order by booking_no_prefix_num desc";
				}

				//echo $sql;//die;
			}


			$prev_pi_qnty_arr=return_library_array("select b.work_order_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and a.pi_basis_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $pi_wo_number group by b.work_order_id",'work_order_id','quantity');
		}
		else
		{
			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				if($db_type==0)
				{
					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(c.id) as dtls_id, d.color as  fabric_color_id, d.detarmination_id, d.gsm as gsm_weight, d.dia_width, c.order_uom as uom, 1 as type
					from wo_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and a.ISGREYFAB_PURCHASE<>1 and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, d.color, d.detarmination_id, d.gsm, d.dia_width, c.order_uom
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(c.id) as dtls_id, d.color as  fabric_color_id, d.detarmination_id, d.gsm as gsm_weight, d.dia_width, c.order_uom as uom, 2 as type
					from wo_non_ord_samp_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, d.color, d.detarmination_id, d.gsm, d.dia_width, c.order_uom

					order by booking_no_prefix_num desc";
				}
				else
				{
					 $sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,c.id,',').extract('//text()') order by c.id).GetClobVal(),',') AS dtls_id , d.color as  fabric_color_id, d.detarmination_id, d.gsm as gsm_weight, d.dia_width, c.order_uom as uom, 1 as type
					from wo_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and a.ISGREYFAB_PURCHASE<>1 and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, d.color, d.detarmination_id, d.gsm, d.dia_width, c.order_uom
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,c.id,',').extract('//text()') order by c.id).GetClobVal(),',') AS dtls_id , d.color as  fabric_color_id, d.detarmination_id, d.gsm as gsm_weight, d.dia_width, c.order_uom as uom, 2 as type
					from wo_non_ord_samp_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, d.color, d.detarmination_id, d.gsm, d.dia_width, c.order_uom
					order by booking_no_prefix_num desc";
				}
				// and c.pi_is_lock!=1 and c.pi_is_lock!=1

				$construction_arr=array(); $composition_arr=array();
				$sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
				$data_array=sql_select($sql_deter);
				if(count($data_array)>0)
				{
					foreach( $data_array as $row )
					{
						$construction_arr[$row[csf('id')]]=$row[csf('construction')];

						if(array_key_exists($row[csf('id')],$composition_arr))
						{
							$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
						else
						{
							$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
					}
				}
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
				if($db_type==0)
				{

					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(b.id) as dtls_id, b.fabric_color_id as  fabric_color_id, sum(b.fin_fab_qnty) as wo_qnty, c.lib_yarn_count_deter_id, c.construction as construction, c.composition as copmposition, c.gsm_weight as gsm_weight, b.dia_width, c.uom, 1 as type
					from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
					where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.ISGREYFAB_PURCHASE<>1 and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.pay_mode=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, b.fabric_color_id, c.lib_yarn_count_deter_id, c.construction, c.composition, c.gsm_weight, b.dia_width, c.uom
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(b.id) as dtls_id, b.fabric_color as  fabric_color_id, sum(b.grey_fabric) as wo_qnty, 0 as lib_yarn_count_deter_id, b.construction, b.composition as copmposition, b.gsm_weight, b.dia_width, b.uom, 2 as type
					from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $pay_mode_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, b.fabric_color, b.construction, b.composition, b.gsm_weight, b.dia_width, b.uom
					order by booking_no_prefix_num desc";

				}
				else
				{
					 $sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, b.fabric_color_id as  fabric_color_id, sum(b.fin_fab_qnty) as wo_qnty, c.lib_yarn_count_deter_id, c.construction as construction, c.composition as copmposition, c.gsm_weight as gsm_weight, b.dia_width, c.uom, 1 as type
					from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
					where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.ISGREYFAB_PURCHASE<>1 and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.pay_mode=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, b.fabric_color_id, c.lib_yarn_count_deter_id, c.construction, c.composition, c.gsm_weight, b.dia_width, c.uom
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, b.fabric_color as  fabric_color_id, sum(b.grey_fabric) as wo_qnty, 0 as lib_yarn_count_deter_id, b.construction, b.composition as copmposition, b.gsm_weight, b.dia_width, b.uom, 2 as type
					from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $pay_mode_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, b.fabric_color, b.construction, b.composition, b.gsm_weight, b.dia_width, b.uom
					order by booking_no_prefix_num desc";
				}

				$prev_pi_qty_arr=array();
				$sql_prev="select b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 $pi_wo_number
				group by b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom";// and b.work_order_dtls_id in($wo_dtls_id)
				$prevData=sql_select($sql_prev);
				foreach($prevData as $rowP)
				{
					$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('gsm')]][$rowP[csf('dia_width')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
				}

			}
		}
		//echo $sql;
		//print_r($prev_pi_qnty_arr);die;

		//var_dump($prev_pi_qty_arr);die;
		//echo $sql; die;
		//$result = sql_select($sql);

		$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
		$supplier_arr=return_library_array( "select id, short_name from lib_supplier",'id','short_name');
		$arr=array (2=>$supplier_arr,3=>$color_library,8=>$unit_of_measurement);

		//echo  create_list_view("tbl_list_search", "WO Number, WO Date, Supplier, Color, Construction, Copmposition, GSM, Dia/Width, UOM", "105,80,100,80,120,120,60,70,60","880","250",0, $sql, "js_set_value", "id", "", 1, "0,0,supplier_id,fabric_color_id,0,0,0,0,uom", $arr , "booking_no_prefix_num,booking_date,supplier_id,fabric_color_id,construction,copmposition,gsm_weight,dia_width,uom", "",'','0,3,0,0,0,0,0,0,0','',1);

		//echo $goods_rcv_status." && ".$goods_rcv_variable;

		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{
			?>
			 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="980" class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="50">WO No</th>
					<th width="75">WO Date</th>
					<th width="100">Buyer</th>
					<th width="80">Supplier</th>
					<th width="80">Color</th>
					<th width="100">Construction</th>
					<th width="130">Copmposition</th>
					<th width="60">GSM</th>
					<th width="60">Dia/ Width</th>
					<th width="60">UOM</th>
					<th>Booking Type</th>
				</thead>
			 </table>
			 <div style="width:980px; max-height:250px; overflow-y:scroll">
				 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="960" class="rpt_table" id="tbl_list_search">
				 <?
				 $i=1;
				 $nameArray=sql_select( $sql );
				 foreach ($nameArray as $row)
				 {
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					if($db_type==2 ) $row[csf('dtls_id')] = $row[csf('dtls_id')]->load();

					$construction=''; $copmposition='';
					$construction=$construction_arr[$row[csf('detarmination_id')]];
					$copmposition=$composition_arr[$row[csf('detarmination_id')]];

					$prev_datas="";
					if($selected_based_on!=1)
					{
						$prev_datas=$prev_dtls_data_arr[$row[csf('booking_no')]][$row[csf('detarmination_id')]][$row[csf('fabric_color_id')]][$construction][$copmposition][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];
					}

					if($prev_datas=="")
					{
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$row[csf('dtls_id')]."*".$row[csf('type')];?>')">
							<td width="40"><? echo "$i"; ?></td>
							<td width="50"><p><? echo $row[csf('booking_no_prefix_num')];?></p></td>
							<td width="75" align="center"><p><? if($row[csf('booking_date')]!="" && $row[csf('booking_date')]!="0000-00-00") echo change_date_format($row[csf('booking_date')]);?></p></td>
							<td width="100"><p><? echo $buyer_arr[$row[csf('buyer_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $supplier_arr[$row[csf('supplier_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $color_library[$row[csf('fabric_color_id')]]; ?>&nbsp;</p></td>
							<td width="100"><p><? echo $construction; ?>&nbsp;</p></td>
							<td width="130"><p><? echo $copmposition; ?></p></td>
							<td width="60"><p><? echo $row[csf('gsm_weight')]; ?></p></td>
							<td width="60"><p><? echo $row[csf('dia_width')]; ?>&nbsp;</p></td>
							<td align="center" width="60"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?>&nbsp;</p></td>
							<td><p>
							<?
							$booking_type="";
							if($row[csf('type')]==1)
							{
								if($row[csf('booking_type')]==1 && $row[csf('is_short')]==1) $booking_type="Short Fab.";
								if($row[csf('booking_type')]==1 && $row[csf('is_short')]==2) $booking_type="Main Fab.";
								if($row[csf('booking_type')]==4 && $row[csf('is_short')]==2) $booking_type="Sample With Order";
							}
							else
							{
								$booking_type="Sample Without Order";
							}
							echo $booking_type;
							?>&nbsp;</p></td>
						</tr>
						 <?
						 $i++;
					}
				 }

				 ?>
				</table>
			</div>
			<?
		}
		else
		{
			?>
			 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="980" class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="50">WO No</th>
					<th width="75">WO Date</th>
					<th width="100">Buyer</th>
					<th width="80">Supplier</th>
					<th width="80">Color</th>
					<th width="100">Construction</th>
					<th width="130">Copmposition</th>
					<th width="60">GSM</th>
					<th width="60">Dia/ Width</th>
					<th width="60">UOM</th>
					<th>Booking Type</th>
				</thead>
			 </table>
			 <div style="width:980px; max-height:250px; overflow-y:scroll">
				 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="960" class="rpt_table" id="tbl_list_search">
				 <?

				/*$con_select22 = connect();

				//echo "<pre>";print_r($prev_dtls_data_arr);die;
				$result = oci_parse($con_select22, $sql);
				oci_execute($result);
				//echo $result[csf("dtls_id")]->load();
				//print_r($result);
				while($summ=oci_fetch_array($result))
				{
					echo $summ[csf("dtls_id")]->load();
				}
				die;*/
				 $i=1;
				 $nameArray = sql_select($sql);
				 foreach ($nameArray as $row)
				 {
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					// if($db_type==2 ) $row[csf('dtls_id')] = $row[csf('dtls_id')]->load();

					$construction=''; $copmposition='';
					if($goods_rcv_status==2)
					{
						$construction=$row[csf('construction')];
						$copmposition=$row[csf('copmposition')];
					}
					else
					{
						$construction=$construction_arr[$row[csf('detarmination_id')]];
						$copmposition=$composition_arr[$row[csf('detarmination_id')]];
					}
					$prev_datas="";
					if($selected_based_on==1)
					{
						$bal_qtny=$row[csf('wo_qnty')]-$prev_pi_qnty_arr[$row[csf('mst_id')]];
					}
					else
					{
						$bal_qtny=$row[csf('wo_qnty')]-$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];
						$prev_datas=$prev_dtls_data_arr[$row[csf('booking_no')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];
					}

					if($bal_qtny>0 && $prev_datas=="")
					{

						if($db_type==0)
						{
						  	$dtls_ids = $row[csf('dtls_id')];
						}else{
						  	$dtls_ids = $row[csf('dtls_id')]->load();
						}

						$booking_type="";
						if($row[csf('type')]==1)
						{
							if($row[csf('booking_type')]==1 && $row[csf('is_short')]==1)
							{
								$booking_type="Short Fab.";
								$fabric_approval_string=$trims_approval_need_arr[6];
							}
							if($row[csf('booking_type')]==1 && $row[csf('is_short')]==2)
							{
								$booking_type="Main Fab.";
								$fabric_approval_string=$trims_approval_need_arr[5];
							}
							if($row[csf('booking_type')]==4 && $row[csf('is_short')]==2)
							{
								$booking_type="Sample With Order";
								$fabric_approval_string=$trims_approval_need_arr[7];
							}
						}
						else
						{
							$booking_type="Sample Without Order";
							$fabric_approval_string=$trims_approval_need_arr[8];
						}
						//echo $row[csf('is_approved')]."**".$fabric_approval_string;die;
						//print_r($trims_approval_need_arr);die;
						//if($row[csf('is_approved')]!=1 && $fabric_approval_string ==1) $bgcolor="#ffa38f";
						$approval_status_arr = array(1,3);
						if(!in_array($row[csf('is_approved')], $approval_status_arr) ) $bgcolor="#ffa38f";
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$dtls_ids."*".$row[csf('type')]."_".$row[csf('is_approved')]."_".$company_id."_".$fabric_approval_string; ;?>')">
							<td width="40" align="center"><? echo "$i"; ?></td>
							<td width="50" align="center"><p><? echo $row[csf('booking_no_prefix_num')];?></p></td>
							<td width="75" align="center"><p><? if($row[csf('booking_date')]!="" && $row[csf('booking_date')]!="0000-00-00") echo change_date_format($row[csf('booking_date')]);?></p></td>
							<td width="100"><p><? echo $buyer_arr[$row[csf('buyer_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $supplier_arr[$row[csf('supplier_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $color_library[$row[csf('fabric_color_id')]]; ?>&nbsp;</p></td>
							<td width="100"><p><? echo $construction; ?>&nbsp;</p></td>
							<td width="130"><p><? echo $copmposition; ?></p></td>
							<td width="60" align="center"><p><? echo $row[csf('gsm_weight')]; ?></p></td>
							<td width="60" align="center"><p><? echo $row[csf('dia_width')]; ?>&nbsp;</p></td>
							<td align="center" width="60"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?>&nbsp;</p></td>
							<td><p>
							<?

							echo $booking_type;
							?>&nbsp;</p></td>
						</tr>
						 <?
						 $i++;
					}
				 }

				 ?>
				</table>
			</div>
			<?
		}

		?>
        <table width="980" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
        <?
	}
	
	else if($item_category_id==13)  // Knit Grey Fabric
	{
		//echo $user_buyer_id.tst;die;
		$buyer_id_cond='';
		if ($buyer_id != 0){
			$buyer_id_cond = " and a.buyer_id=$buyer_id";
		}
		if($user_buyer_id!="") $buyer_id_cond .= " and a.buyer_id in($user_buyer_id)";

		if ($data[0]!="")
		{
			$wo_number=" and a.booking_no like '%".trim($data[0])."'";
			$pi_wo_number=" and b.work_order_no like '%".trim($data[0])."'";
		}
		else
		{
			$wo_number = '';
			$pi_wo_number="";
		}
		if ($wo_year != 0){
			$wo_year_con = " and TO_CHAR(a.booking_date,'YYYY') ='$wo_year'";
		}
		//echo $selected_based_on."==".$goods_rcv_status."==".$goods_rcv_variable;die;
		if($selected_based_on==1)
		{
			//echo "$goods_rcv_status = $goods_rcv_variable";die;
			$prev_wo_mst_cond="";
			if($prev_wo_mst_ids!="") $prev_wo_mst_cond=" and a.id not in($prev_wo_mst_ids)";
			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				if($db_type==0)
				{
					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(c.id) as dtls_id, 1 as type
					from wo_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and a.ISGREYFAB_PURCHASE=1 and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(c.id) as dtls_id, 2 as type
					from wo_non_ord_samp_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1  and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id
					order by booking_no_prefix_num desc";
				}
				else
				{
					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id,rtrim(xmlagg(xmlelement(e,c.id,',').extract('//text()') order by c.id).GetClobVal(),',') AS dtls_id , 1 as type
					from wo_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and a.ISGREYFAB_PURCHASE=1 and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,c.id,',').extract('//text()') order by c.id).GetClobVal(),',') AS dtls_id, 2 as type
					from wo_non_ord_samp_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1  and c.transaction_type=1  $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id
					order by booking_no_prefix_num desc";
				}
				// and c.pi_is_lock!=1 and c.pi_is_lock!=1
				//echo $sql;//die;
				$construction_arr=array(); $composition_arr=array();
				$sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
				$data_array=sql_select($sql_deter);
				if(count($data_array)>0)
				{
					foreach( $data_array as $row )
					{
						$construction_arr[$row[csf('id')]]=$row[csf('construction')];

						if(array_key_exists($row[csf('id')],$composition_arr))
						{
							$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
						else
						{
							$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
					}
				}
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
				if($db_type==0)
				{
					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(b.id) as dtls_id, sum(b.fin_fab_qnty) as wo_qnty, 1 as type,a.is_approved
					from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
					where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.ISGREYFAB_PURCHASE=1 and a.company_id=$company_id and a.item_category=2 and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond $pay_mode_cond
					group by a.id, a.booking_type, a.is_short,a.is_approved, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(b.id) as dtls_id, sum(b.grey_fabric) as wo_qnty, 2 as type,a.is_approved
					from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=2 and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond $pay_mode_cond
					group by a.id, a.booking_type, a.is_short,a.is_approved, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id
					order by booking_no_prefix_num desc";
				}
				else
				{
					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date,  a.buyer_id, a.supplier_id,  rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') as dtls_id, sum(b.fin_fab_qnty) as wo_qnty, 1 as type,a.is_approved, max(b.fabric_color_id) as fabric_color_id, max(b.construction) as construction, max(b.copmposition) as copmposition, max(b.gsm_weight) as gsm_weight, max(b.dia_width) as dia_width, max(b.uom) as uom
					from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
					where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.ISGREYFAB_PURCHASE=1 and a.company_id=$company_id and a.item_category=2 and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond $pay_mode_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short,a.is_approved, a.booking_no_prefix_num, a.booking_no, a.booking_date,  a.buyer_id, a.supplier_id
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date,  a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') as dtls_id, sum(b.grey_fabric) as wo_qnty, 2 as type,a.is_approved, 0 as fabric_color_id, null as construction, null as copmposition, null as gsm_weight, null as dia_width, null as uom
					from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=2 and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond $pay_mode_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short,a.is_approved, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id
					order by booking_no_prefix_num desc";
				}

				//echo $sql;//die;
			}


			$prev_pi_qnty_arr=return_library_array("select b.work_order_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and a.pi_basis_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $pi_wo_number group by b.work_order_id",'work_order_id','quantity');
		}
		else
		{
			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				if($db_type==0)
				{
					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(c.id) as dtls_id, d.color as  fabric_color_id, d.detarmination_id, d.gsm as gsm_weight, d.dia_width, c.order_uom as uom, 1 as type
					from wo_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and a.ISGREYFAB_PURCHASE=1 and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, d.color, d.detarmination_id, d.gsm, d.dia_width, c.order_uom
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(c.id) as dtls_id, d.color as  fabric_color_id, d.detarmination_id, d.gsm as gsm_weight, d.dia_width, c.order_uom as uom, 2 as type
					from wo_non_ord_samp_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, d.color, d.detarmination_id, d.gsm, d.dia_width, c.order_uom
					order by booking_no_prefix_num desc";
				}
				else
				{
					 $sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,c.id,',').extract('//text()') order by c.id).GetClobVal(),',') AS dtls_id , d.color as  fabric_color_id, d.detarmination_id, d.gsm as gsm_weight, d.dia_width, c.order_uom as uom, 1 as type
					from wo_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and a.ISGREYFAB_PURCHASE=1 and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, d.color, d.detarmination_id, d.gsm, d.dia_width, c.order_uom
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,c.id,',').extract('//text()') order by c.id).GetClobVal(),',') AS dtls_id , d.color as  fabric_color_id, d.detarmination_id, d.gsm as gsm_weight, d.dia_width, c.order_uom as uom, 2 as type
					from wo_non_ord_samp_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, d.color, d.detarmination_id, d.gsm, d.dia_width, c.order_uom
					order by booking_no_prefix_num desc";
				}
				// and c.pi_is_lock!=1 and c.pi_is_lock!=1

				$construction_arr=array(); $composition_arr=array();
				$sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
				$data_array=sql_select($sql_deter);
				if(count($data_array)>0)
				{
					foreach( $data_array as $row )
					{
						$construction_arr[$row[csf('id')]]=$row[csf('construction')];

						if(array_key_exists($row[csf('id')],$composition_arr))
						{
							$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
						else
						{
							$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
					}
				}
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
				if($db_type==0)
				{

					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(b.id) as dtls_id, b.fabric_color_id as  fabric_color_id, sum(b.fin_fab_qnty) as wo_qnty, c.lib_yarn_count_deter_id, c.construction as construction, c.composition as copmposition, c.gsm_weight as gsm_weight, b.dia_width, c.uom, 1 as type
					from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
					where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.ISGREYFAB_PURCHASE=1 and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.pay_mode=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, b.fabric_color_id, c.lib_yarn_count_deter_id, c.construction, c.composition, c.gsm_weight, b.dia_width, c.uom
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(b.id) as dtls_id, b.fabric_color as  fabric_color_id, sum(b.grey_fabric) as wo_qnty, 0 as lib_yarn_count_deter_id, b.construction, b.composition as copmposition, b.gsm_weight, b.dia_width, b.uom, 2 as type
					from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $pay_mode_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, b.fabric_color, b.construction, b.composition, b.gsm_weight, b.dia_width, b.uom
					order by booking_no_prefix_num desc";

				}
				else
				{
					 $sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, b.fabric_color_id as  fabric_color_id, sum(b.fin_fab_qnty) as wo_qnty, c.lib_yarn_count_deter_id, c.construction as construction, c.composition as copmposition, c.gsm_weight as gsm_weight, b.dia_width, c.uom, 1 as type
					from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
					where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.ISGREYFAB_PURCHASE=1 and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.pay_mode=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, b.fabric_color_id, c.lib_yarn_count_deter_id, c.construction, c.composition, c.gsm_weight, b.dia_width, c.uom
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, b.fabric_color as  fabric_color_id, sum(b.grey_fabric) as wo_qnty, 0 as lib_yarn_count_deter_id, b.construction, b.composition as copmposition, b.gsm_weight, b.dia_width, b.uom, 2 as type
					from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $pay_mode_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, b.fabric_color, b.construction, b.composition, b.gsm_weight, b.dia_width, b.uom
					order by booking_no_prefix_num desc";
				}

				$prev_pi_qty_arr=array();
				$sql_prev="select b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 $pi_wo_number
				group by b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom";// and b.work_order_dtls_id in($wo_dtls_id)
				$prevData=sql_select($sql_prev);
				foreach($prevData as $rowP)
				{
					$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('gsm')]][$rowP[csf('dia_width')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
				}

			}
		}
		//echo $sql;
		//print_r($prev_pi_qnty_arr);die;

		//var_dump($prev_pi_qty_arr);die;
		//echo $sql; die;
		//$result = sql_select($sql);

		$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
		$supplier_arr=return_library_array( "select id, short_name from lib_supplier",'id','short_name');
		$arr=array (2=>$supplier_arr,3=>$color_library,8=>$unit_of_measurement);

		//echo  create_list_view("tbl_list_search", "WO Number, WO Date, Supplier, Color, Construction, Copmposition, GSM, Dia/Width, UOM", "105,80,100,80,120,120,60,70,60","880","250",0, $sql, "js_set_value", "id", "", 1, "0,0,supplier_id,fabric_color_id,0,0,0,0,uom", $arr , "booking_no_prefix_num,booking_date,supplier_id,fabric_color_id,construction,copmposition,gsm_weight,dia_width,uom", "",'','0,3,0,0,0,0,0,0,0','',1);

		//echo $goods_rcv_status." && ".$goods_rcv_variable;

		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{
			?>
			 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="980" class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="50">WO No</th>
					<th width="75">WO Date</th>
					<th width="100">Buyer</th>
					<th width="80">Supplier</th>
					<th width="80">Color</th>
					<th width="100">Construction</th>
					<th width="130">Copmposition</th>
					<th width="60">GSM</th>
					<th width="60">Dia/ Width</th>
					<th width="60">UOM</th>
					<th>Booking Type</th>
				</thead>
			 </table>
			 <div style="width:980px; max-height:250px; overflow-y:scroll">
				 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="960" class="rpt_table" id="tbl_list_search">
				 <?
				 $i=1;
				 $nameArray=sql_select( $sql );
				 foreach ($nameArray as $row)
				 {
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					if($db_type==2 ) $row[csf('dtls_id')] = $row[csf('dtls_id')]->load();

					$construction=''; $copmposition='';
					$construction=$construction_arr[$row[csf('detarmination_id')]];
					$copmposition=$composition_arr[$row[csf('detarmination_id')]];

					$prev_datas="";
					if($selected_based_on!=1)
					{
						$prev_datas=$prev_dtls_data_arr[$row[csf('booking_no')]][$row[csf('detarmination_id')]][$row[csf('fabric_color_id')]][$construction][$copmposition][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];
					}

					if($prev_datas=="")
					{
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$row[csf('dtls_id')]."*".$row[csf('type')];?>')">
							<td width="40"><? echo "$i"; ?></td>
							<td width="50"><p><? echo $row[csf('booking_no_prefix_num')];?></p></td>
							<td width="75" align="center"><p><? if($row[csf('booking_date')]!="" && $row[csf('booking_date')]!="0000-00-00") echo change_date_format($row[csf('booking_date')]);?></p></td>
							<td width="100"><p><? echo $buyer_arr[$row[csf('buyer_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $supplier_arr[$row[csf('supplier_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $color_library[$row[csf('fabric_color_id')]]; ?>&nbsp;</p></td>
							<td width="100"><p><? echo $construction; ?>&nbsp;</p></td>
							<td width="130"><p><? echo $copmposition; ?></p></td>
							<td width="60"><p><? echo $row[csf('gsm_weight')]; ?></p></td>
							<td width="60"><p><? echo $row[csf('dia_width')]; ?>&nbsp;</p></td>
							<td align="center" width="60"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?>&nbsp;</p></td>
							<td><p>
							<?
							$booking_type="";
							if($row[csf('type')]==1)
							{
								if($row[csf('booking_type')]==1 && $row[csf('is_short')]==1) $booking_type="Short Fab.";
								if($row[csf('booking_type')]==1 && $row[csf('is_short')]==2) $booking_type="Main Fab.";
								if($row[csf('booking_type')]==4 && $row[csf('is_short')]==2) $booking_type="Sample With Order";
							}
							else
							{
								$booking_type="Sample Without Order";
							}
							echo $booking_type;
							?>&nbsp;</p></td>
						</tr>
						 <?
						 $i++;
					}
				 }

				 ?>
				</table>
			</div>
			<?
		}
		else
		{
			?>
			 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="980" class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="50">WO No</th>
					<th width="75">WO Date</th>
					<th width="100">Buyer</th>
					<th width="80">Supplier</th>
					<th width="80">Color</th>
					<th width="100">Construction</th>
					<th width="130">Copmposition</th>
					<th width="60">GSM</th>
					<th width="60">Dia/ Width</th>
					<th width="60">UOM</th>
					<th>Booking Type</th>
				</thead>
			 </table>
			 <div style="width:980px; max-height:250px; overflow-y:scroll">
				 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="960" class="rpt_table" id="tbl_list_search">
				 <?

				/*$con_select22 = connect();

				//echo "<pre>";print_r($prev_dtls_data_arr);die;
				$result = oci_parse($con_select22, $sql);
				oci_execute($result);
				//echo $result[csf("dtls_id")]->load();
				//print_r($result);
				while($summ=oci_fetch_array($result))
				{
					echo $summ[csf("dtls_id")]->load();
				}
				die;*/
				 $i=1;
				 $nameArray = sql_select($sql);
				 foreach ($nameArray as $row)
				 {
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					// if($db_type==2 ) $row[csf('dtls_id')] = $row[csf('dtls_id')]->load();

					$construction=''; $copmposition='';
					if($goods_rcv_status==2)
					{
						$construction=$row[csf('construction')];
						$copmposition=$row[csf('copmposition')];
					}
					else
					{
						$construction=$construction_arr[$row[csf('detarmination_id')]];
						$copmposition=$composition_arr[$row[csf('detarmination_id')]];
					}
					$prev_datas="";
					if($selected_based_on==1)
					{
						$bal_qtny=$row[csf('wo_qnty')]-$prev_pi_qnty_arr[$row[csf('mst_id')]];
					}
					else
					{
						$bal_qtny=$row[csf('wo_qnty')]-$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];
						$prev_datas=$prev_dtls_data_arr[$row[csf('booking_no')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];
					}

					if($bal_qtny>0 && $prev_datas=="")
					{

						if($db_type==0)
						{
						  	$dtls_ids = $row[csf('dtls_id')];
						}else{
						  	$dtls_ids = $row[csf('dtls_id')]->load();
						}

						$booking_type="";
						if($row[csf('type')]==1)
						{
							if($row[csf('booking_type')]==1 && $row[csf('is_short')]==1)
							{
								$booking_type="Short Fab.";
								$fabric_approval_string=$trims_approval_need_arr[6];
							}
							if($row[csf('booking_type')]==1 && $row[csf('is_short')]==2)
							{
								$booking_type="Main Fab.";
								$fabric_approval_string=$trims_approval_need_arr[5];
							}
							if($row[csf('booking_type')]==4 && $row[csf('is_short')]==2)
							{
								$booking_type="Sample With Order";
								$fabric_approval_string=$trims_approval_need_arr[7];
							}
						}
						else
						{
							$booking_type="Sample Without Order";
							$fabric_approval_string=$trims_approval_need_arr[8];
						}
						//echo $row[csf('is_approved')]."**".$fabric_approval_string;die;
						//print_r($trims_approval_need_arr);die;
						if($row[csf('is_approved')]!=1 && $fabric_approval_string ==1) $bgcolor="#ffa38f";
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$dtls_ids."*".$row[csf('type')]."_".$row[csf('is_approved')]."_".$company_id."_".$fabric_approval_string; ;?>')">
							<td width="40" align="center"><? echo "$i"; ?></td>
							<td width="50" align="center"><p><? echo $row[csf('booking_no_prefix_num')];?></p></td>
							<td width="75" align="center"><p><? if($row[csf('booking_date')]!="" && $row[csf('booking_date')]!="0000-00-00") echo change_date_format($row[csf('booking_date')]);?></p></td>
							<td width="100"><p><? echo $buyer_arr[$row[csf('buyer_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $supplier_arr[$row[csf('supplier_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $color_library[$row[csf('fabric_color_id')]]; ?>&nbsp;</p></td>
							<td width="100"><p><? echo $construction; ?>&nbsp;</p></td>
							<td width="130"><p><? echo $copmposition; ?></p></td>
							<td width="60" align="center"><p><? echo $row[csf('gsm_weight')]; ?></p></td>
							<td width="60" align="center"><p><? echo $row[csf('dia_width')]; ?>&nbsp;</p></td>
							<td align="center" width="60"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?>&nbsp;</p></td>
							<td><p>
							<?

							echo $booking_type;
							?>&nbsp;</p></td>
						</tr>
						 <?
						 $i++;
					}
				 }

				 ?>
				</table>
			</div>
			<?
		}

		?>
        <table width="980" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
        <?
	}

	else if($item_category_id==3)  // Woven Fabrics
	{
		$buyer_id_cond=$buyer_id_cond2='';
		if ($buyer_id != 0){
			$buyer_id_cond = " and a.buyer_id=$buyer_id";
			$buyer_id_cond2 = " and c.buyer_id=$buyer_id";
		}
		if($user_buyer_id!="") $buyer_id_cond .= " and a.buyer_id in($user_buyer_id)";
		if($user_buyer_id!="") $buyer_id_cond2 .= " and c.buyer_id in($user_buyer_id)";
		
		$wo_number=$wo_number2=$pi_wo_number="";	

		if ($data[0]!="")
		{
			$wo_number=" and a.booking_no like '%".trim($data[0])."'";
			$wo_number2=" and c.booking_no like '%".trim($data[0])."'";
			$pi_wo_number=" and b.work_order_no like '%".trim($data[0])."'";
		}
		
		$pi_mst_sql=sql_select("select BUYER_ID, BRAND_ID, SEASON_YEAR_ID, SEASON_ID from com_pi_master_details where id=$pi_mst_id and status_active=1");
		$mst_buyer_id=$pi_mst_sql[0]["BUYER_ID"];
		$mst_brand_id=$pi_mst_sql[0]["BRAND_ID"];
		$mst_season_year_id=$pi_mst_sql[0]["SEASON_YEAR_ID"];
		$mst_season_id=$pi_mst_sql[0]["SEASON_ID"];
		$sql_book_cond=$sql_book_cond2="";
		if($mst_buyer_id>0)
		{
			$sql_book_cond.=" and a.BUYER_ID=$mst_buyer_id";
			$sql_book_cond2.=" and c.BUYER_ID=$mst_buyer_id";
		}
		
		if($mst_brand_id>0)
		{
			$sql_book_cond.=" and a.BRAND_ID=$mst_brand_id";
			$sql_book_cond2.=" and c.BRAND_ID=$mst_brand_id";
		}
		
		if($mst_season_year_id>0)
		{
			$sql_book_cond.=" and a.SEASON_YEAR=$mst_season_year_id";
			$sql_book_cond2.=" and c.SEASON_YEAR=$mst_season_year_id";
		}
		
		if($mst_season_id>0)
		{
			$sql_book_cond.=" and a.SEASON_ID=$mst_season_id";
			$sql_book_cond2.=" and c.SEASON_ID=$mst_season_id";
		}
		
		if ($wo_year != 0){
			$wo_year_con = " and to_char(a.insert_date,'YYYY') ='$wo_year'";
			$wo_year_con_sample = " and to_char(s.insert_date,'YYYY') ='$wo_year'";
		}
		//echo $selected_based_on."==".$goods_rcv_status."==".$goods_rcv_variable;die;
		if($selected_based_on==1)
		{
			//echo "$goods_rcv_status = $goods_rcv_variable";die;
			$prev_wo_mst_cond=$prev_wo_mst_cond2="";
			if($prev_wo_mst_ids!="") 
			{
				$prev_wo_mst_cond=" and a.id not in($prev_wo_mst_ids)";
				$prev_wo_mst_cond2=" and c.id not in($prev_wo_mst_ids)";
			}
			
			

			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				if($db_type==0)
				{
					$sql = "SELECT c.id as mst_id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id, group_concat(c.id) as dtls_id, max(a.color) as fabric_color_id, max(a.gsm) as gsm_weight, max(a.dia_width) as dia_width, max(b.order_uom) as uom, 1 as type
					from product_details_master a, inv_transaction b, wo_booking_mst c, wo_booking_dtls d,  wo_pre_cost_fabric_cost_dtls e
					where a.id=b.prod_id and b.pi_wo_batch_no=c.id and c.booking_no=d.booking_no and d.pre_cost_fabric_cost_dtls_id=e.id and a.item_category_id=3 and b.item_category=3 and b.transaction_type=1 and b.receive_basis=2 and a.item_category_id in($item_category_id) and c.company_id=$company_id and b.item_category in($item_category_id) and c.supplier_id like '$supplier_id' and c.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.pi_is_lock!=1 $buyer_id_cond2 $wo_number2 $wo_date_cond2 $prev_wo_mst_cond2 $sql_book_cond2
					group by c.id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id					
					order by c.booking_no_prefix_num desc";
					/*$sql = "
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(c.id) as dtls_id, 2 as type
					from wo_non_ord_samp_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1  and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id
					order by mst_id";*/

				}
				else
				{
					$sql = "SELECT c.id as mst_id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, max(a.color) as fabric_color_id, max(a.gsm) as gsm_weight, max(a.dia_width) as dia_width, max(b.order_uom) as uom, 1 as type
					from product_details_master a, inv_transaction b, wo_booking_mst c, wo_booking_dtls d,  wo_pre_cost_fabric_cost_dtls e
					where a.id=b.prod_id and b.pi_wo_batch_no=c.id and c.booking_no=d.booking_no and d.pre_cost_fabric_cost_dtls_id=e.id and a.item_category_id=3 and b.item_category=3 and b.transaction_type=1 
					and b.receive_basis=2 and a.item_category_id in($item_category_id) and c.company_id=$company_id and b.item_category in($item_category_id) and c.supplier_id like '$supplier_id' and c.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.pi_is_lock!=1 $buyer_id_cond2 $wo_number2 $wo_date_cond2 $prev_wo_mst_cond2 $sql_book_cond2 $wo_year_con
					group by c.id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id					
					order by c.booking_no_prefix_num desc";
				}
				/*union all
				select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,c.id,',').extract('//text()') order by c.id).GetClobVal(),',') AS dtls_id, 2 as type
				from wo_non_ord_samp_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
				where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1  and c.transaction_type=1  $buyer_id_cond $wo_number $wo_date_cond $prev_wo_mst_cond
				group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id*/
				// and c.pi_is_lock!=1 and c.pi_is_lock!=1
				//echo $sql;//die;
				$construction_arr=array(); $composition_arr=array();
				$sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
				$data_array=sql_select($sql_deter);
				if(count($data_array)>0)
				{
					foreach( $data_array as $row )
					{
						$construction_arr[$row[csf('id')]]=$row[csf('construction')];

						if(array_key_exists($row[csf('id')],$composition_arr))
						{
							$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
						else
						{
							$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
					}
				}
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; 
				else $pay_mode_cond=" and a.pay_mode=2";

				if($db_type==0)
				{
					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date  ,a.is_approved, a.buyer_id, a.supplier_id, group_concat(b.id) as dtls_id, max(b.fabric_color_id) as  fabric_color_id, sum(b.fin_fab_qnty) as wo_qnty, max(c.lib_yarn_count_deter_id) as lib_yarn_count_deter_id, max(c.construction) as construction, max(c.composition) as copmposition, max(c.gsm_weight) as gsm_weight, max(b.dia_width) as dia_width, max(c.uom) as uom, 1 as type
					from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
					where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $prev_wo_mst_cond $wo_date_cond $pay_mode_cond $sql_book_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date  ,a.is_approved, a.buyer_id, a.supplier_id
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date  ,a.is_approved, a.buyer_id, a.supplier_id, group_concat(b.id) as dtls_id, max(b.fabric_color) as  fabric_color_id, sum(b.finish_fabric) as wo_qnty, 0 as lib_yarn_count_deter_id, max(b.construction) as construction, max(b.composition) as copmposition, max(b.gsm_weight) as gsm_weight, max(b.dia_width) as dia_width, max(b.uom) as uom, 2 as type
					from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $prev_wo_mst_cond $wo_date_cond $pay_mode_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date  ,a.is_approved, a.buyer_id,  a.supplier_id
					order by booking_no_prefix_num desc";
				}
				else
				{
					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date  ,a.is_approved, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, max(b.fabric_color_id) as  fabric_color_id, sum(b.fin_fab_qnty) as wo_qnty, max(c.lib_yarn_count_deter_id) as lib_yarn_count_deter_id, max(c.construction) as construction, max(c.composition) as copmposition, max(c.gsm_weight) as gsm_weight, max(b.dia_width) as dia_width, max(c.uom) as uom, 1 as type
					from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
					where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $prev_wo_mst_cond $wo_date_cond $pay_mode_cond $sql_book_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date  ,a.is_approved, a.buyer_id, a.supplier_id
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date  ,a.is_approved, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, max(b.fabric_color) as  fabric_color_id, sum(b.finish_fabric) as wo_qnty, 0 as lib_yarn_count_deter_id, max(b.construction) as construction, max(b.composition) as copmposition, max(b.gsm_weight) as gsm_weight, max(b.dia_width) as dia_width, max(b.uom) as uom, 2 as type
					from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $prev_wo_mst_cond $wo_date_cond $pay_mode_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.is_approved, a.buyer_id,  a.supplier_id
					order by booking_no_prefix_num desc";
				}
				//echo $sql;//die;
			}


			//$prev_pi_qnty_arr=return_library_array("select b.work_order_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and a.pi_basis_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $pi_wo_number group by b.work_order_id",'work_order_id','quantity');
			//print_r($prev_pi_qnty_arr);

			$prev_pi="SELECT B.WORK_ORDER_ID,C.BOOKING_NO, sum(b.quantity) as quantity 
			from com_pi_master_details a, com_pi_item_details b ,wo_booking_mst c
			where a.id=b.pi_id and b.WORK_ORDER_ID=c.id and b.WORK_ORDER_NO = c.BOOKING_NO and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and a.pi_basis_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $pi_wo_numbe2 group by b.work_order_id,c.booking_no union all
			SELECT B.WORK_ORDER_ID,C.BOOKING_NO, sum(b.quantity) as quantity 
			from com_pi_master_details a, com_pi_item_details b ,wo_non_ord_samp_booking_mst c
			where a.id=b.pi_id and b.WORK_ORDER_ID=c.id and b.WORK_ORDER_NO = c.BOOKING_NO and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and a.pi_basis_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $pi_wo_numbe2 group by b.work_order_id,c.booking_no";

			$prevData1=sql_select($prev_pi);
			foreach($prevData1 as $rowP)
			{
				$prev_pi_qnty_arr[$rowP[csf('WORK_ORDER_ID')]][$rowP[csf('BOOKING_NO')]]=$rowP[csf('quantity')];
			}

		}
		else
		{
			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				if($db_type==0)
				{
					$sql = "SELECT c.id as mst_id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id, group_concat(c.id) as dtls_id, a.color as fabric_color_id, a.detarmination_id, a.gsm as gsm_weight, a.dia_width, b.order_uom as uom, 1 as type
					from product_details_master a, inv_transaction b, wo_booking_mst c, wo_booking_dtls d,  wo_pre_cost_fabric_cost_dtls e
					where a.id=b.prod_id and b.pi_wo_batch_no=c.id and c.booking_no=d.booking_no and d.pre_cost_fabric_cost_dtls_id=e.id and a.item_category_id=3 and b.item_category=3 and b.transaction_type=1 
					and b.receive_basis=2 and a.item_category_id in($item_category_id) and c.company_id=$company_id and b.item_category in($item_category_id) and c.supplier_id like '$supplier_id' and c.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.pi_is_lock!=1 $buyer_id_cond2 $wo_number2 $wo_date_cond2 $sql_book_cond2
					group by c.id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id, a.color, a.detarmination_id, a.gsm, a.dia_width, b.order_uom					
					order by c.booking_no_prefix_num desc";
					/*$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(c.id) as dtls_id, d.color as  fabric_color_id, d.detarmination_id, d.gsm as gsm_weight, d.dia_width, c.order_uom as uom, 1 as type
					from wo_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, d.color, d.detarmination_id, d.gsm, d.dia_width, c.order_uom
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(c.id) as dtls_id, d.color as  fabric_color_id, d.detarmination_id, d.gsm as gsm_weight, d.dia_width, c.order_uom as uom, 2 as type
					from wo_non_ord_samp_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, d.color, d.detarmination_id, d.gsm, d.dia_width, c.order_uom
					order by mst_id";*/
				}
				else
				{
					$sql = "SELECT c.id as mst_id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, a.color as fabric_color_id, a.detarmination_id, a.gsm as gsm_weight, a.dia_width, b.order_uom as uom, 1 as type
					from product_details_master a, inv_transaction b, wo_booking_mst c, wo_booking_dtls d,  wo_pre_cost_fabric_cost_dtls e
					where a.id=b.prod_id and b.pi_wo_batch_no=c.id and c.booking_no=d.booking_no and d.pre_cost_fabric_cost_dtls_id=e.id and a.item_category_id=3 and b.item_category=3 and b.transaction_type=1 
					and b.receive_basis=2 and a.item_category_id in($item_category_id) and c.company_id=$company_id and b.item_category in($item_category_id) and c.supplier_id like '$supplier_id' and c.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.pi_is_lock!=1 $buyer_id_cond2 $wo_number2 $wo_date_cond2 $sql_book_cond2 $wo_year_con
					group by c.id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id, a.color, a.detarmination_id, a.gsm, a.dia_width, b.order_uom					
					order by c.booking_no_prefix_num desc";
					/*$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,c.id,',').extract('//text()') order by c.id).GetClobVal(),',') AS dtls_id , d.color as  fabric_color_id, d.detarmination_id, d.gsm as gsm_weight, d.dia_width, c.order_uom as uom, 1 as type
					from wo_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, d.color, d.detarmination_id, d.gsm, d.dia_width, c.order_uom
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,c.id,',').extract('//text()') order by c.id).GetClobVal(),',') AS dtls_id , d.color as  fabric_color_id, d.detarmination_id, d.gsm as gsm_weight, d.dia_width, c.order_uom as uom, 2 as type
					from wo_non_ord_samp_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.company_id=$company_id and a.item_category in($item_category_id) and a.supplier_id like '$supplier_id' and a.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.pi_is_lock!=1 and c.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, d.color, d.detarmination_id, d.gsm, d.dia_width, c.order_uom
					order by mst_id";*/
				}
				// and c.pi_is_lock!=1 and c.pi_is_lock!=1

				$construction_arr=array(); $composition_arr=array();
				$sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
				$data_array=sql_select($sql_deter);
				if(count($data_array)>0)
				{
					foreach( $data_array as $row )
					{
						$construction_arr[$row[csf('id')]]=$row[csf('construction')];

						if(array_key_exists($row[csf('id')],$composition_arr))
						{
							$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
						else
						{
							$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
					}
				}
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
				if($db_type==0)
				{

					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(b.id) as dtls_id, b.fabric_color_id as  fabric_color_id, sum(b.fin_fab_qnty) as wo_qnty, c.lib_yarn_count_deter_id, c.construction as construction, c.composition as copmposition, c.gsm_weight as gsm_weight, b.dia_width, c.uom, 1 as type
					from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
					where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.pay_mode=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $sql_book_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, b.fabric_color_id, c.lib_yarn_count_deter_id, c.construction, c.composition, c.gsm_weight, b.dia_width, c.uom
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(b.id) as dtls_id, b.fabric_color as  fabric_color_id, sum(b.finish_fabric) as wo_qnty, 0 as lib_yarn_count_deter_id, b.construction, b.composition as copmposition, b.gsm_weight, b.dia_width, b.uom, 2 as type
					from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $pay_mode_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, b.fabric_color, b.construction, b.composition, b.gsm_weight, b.dia_width, b.uom
					order by booking_no_prefix_num desc";

				}
				else
				{
					$sql = "select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, b.fabric_color_id as  fabric_color_id, sum(b.fin_fab_qnty) as wo_qnty, c.lib_yarn_count_deter_id, c.construction as construction, c.composition as copmposition, c.gsm_weight as gsm_weight, b.dia_width, c.uom, 1 as type
					from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c
					where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.pay_mode=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $sql_book_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, b.fabric_color_id, c.lib_yarn_count_deter_id, c.construction, c.composition, c.gsm_weight, b.dia_width, c.uom
					union all
					select a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, b.fabric_color as  fabric_color_id, sum(b.finish_fabric) as wo_qnty, 0 as lib_yarn_count_deter_id, b.construction, b.composition as copmposition, b.gsm_weight, b.dia_width, b.uom, 2 as type
					from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $pay_mode_cond $wo_year_con
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id,  a.supplier_id, b.fabric_color, b.construction, b.composition, b.gsm_weight, b.dia_width, b.uom
					order by booking_no_prefix_num desc";
				}

				$prev_pi_qty_arr=array();
				$sql_prev="select b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 $pi_wo_number
				group by b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom";// and b.work_order_dtls_id in($wo_dtls_id)
				$prevData=sql_select($sql_prev);
				foreach($prevData as $rowP)
				{
					$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('gsm')]][$rowP[csf('dia_width')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
				}

			}
		}
		
		// echo $sql;
		//print_r($prev_pi_qnty_arr);die;

		//var_dump($prev_pi_qty_arr);die;
		//echo $sql; //die;
		//$result = sql_select($sql);

		$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
		$supplier_arr=return_library_array( "select id, short_name from lib_supplier",'id','short_name');
		$arr=array (2=>$supplier_arr,3=>$color_library,8=>$unit_of_measurement);

		//echo  create_list_view("tbl_list_search", "WO Number, WO Date, Supplier, Color, Construction, Copmposition, GSM, Dia/Width, UOM", "105,80,100,80,120,120,60,70,60","880","250",0, $sql, "js_set_value", "id", "", 1, "0,0,supplier_id,fabric_color_id,0,0,0,0,uom", $arr , "booking_no_prefix_num,booking_date,supplier_id,fabric_color_id,construction,copmposition,gsm_weight,dia_width,uom", "",'','0,3,0,0,0,0,0,0,0','',1);

		//echo $goods_rcv_status." && ".$goods_rcv_variable;

		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{
			?>
			 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="980" class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="50">WO No</th>
					<th width="75">WO Date</th>
					<th width="100">Buyer</th>
					<th width="80">Supplier</th>
					<th width="80">Color</th>
					<th width="100">Construction</th>
					<th width="130">Copmposition</th>
					<th width="60">GSM</th>
					<th width="60">Dia/ Width</th>
					<th width="60">UOM</th>
					<th>Booking Type</th>
				</thead>
			 </table>
			 <div style="width:980px; max-height:250px; overflow-y:scroll">
				 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="960" class="rpt_table" id="tbl_list_search">
				 <?
				 $i=1;
				 $nameArray=sql_select( $sql );
				 foreach ($nameArray as $row)
				 {
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					if($db_type==2 ) $row[csf('dtls_id')] = $row[csf('dtls_id')]->load();

					$construction=''; $copmposition='';
					echo $construction=$construction_arr[$row[csf('detarmination_id')]];
					$copmposition=$composition_arr[$row[csf('detarmination_id')]];

					$prev_datas="";
					if($selected_based_on!=1)
					{
						$prev_datas=$prev_dtls_data_arr[$row[csf('booking_no')]][$row[csf('detarmination_id')]][$row[csf('fabric_color_id')]][$construction][$copmposition][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];						
					}
					//echo '<pre>';print_r($prev_dtls_data_arr);

					if($prev_datas=="")
					{
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$row[csf('dtls_id')]."*".$row[csf('type')];?>')">
							<td width="40"><? echo "$i"; ?></td>
							<td width="50"><p><? echo $row[csf('booking_no_prefix_num')];?></p></td>
							<td width="75" align="center"><p><? if($row[csf('booking_date')]!="" && $row[csf('booking_date')]!="0000-00-00") echo change_date_format($row[csf('booking_date')]);?></p></td>
							<td width="100"><p><? echo $buyer_arr[$row[csf('buyer_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $supplier_arr[$row[csf('supplier_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $color_library[$row[csf('fabric_color_id')]]; ?>&nbsp;</p></td>
							<td width="100"><p><? echo $construction; ?>&nbsp;</p></td>
							<td width="130"><p><? echo chop($copmposition,","); ?></p></td>
							<td width="60"><p><? echo $row[csf('gsm_weight')]; ?></p></td>
							<td width="60"><p><? echo $row[csf('dia_width')]; ?>&nbsp;</p></td>
							<td align="center" width="60"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?>&nbsp;</p></td>
							<td><p>
							<?
							$booking_type="";
							if($row[csf('type')]==1)
							{
								if($row[csf('booking_type')]==1 && $row[csf('is_short')]==1) $booking_type="Short Fab.";
								if($row[csf('booking_type')]==1 && $row[csf('is_short')]==2) $booking_type="Main Fab.";
								if($row[csf('booking_type')]==4 && $row[csf('is_short')]==2) $booking_type="Sample With Order";
							}
							else
							{
								$booking_type="Sample Without Order";
							}
							echo $booking_type;
							?>&nbsp;</p></td>
						</tr>
						 <?
						 $i++;
					}
				 }

				 ?>
				</table>
			</div>
			<?
		}
		else
		{
			?>
			 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="980" class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="50">WO No</th>
					<th width="75">WO Date</th>
					<th width="100">Buyer</th>
					<th width="80">Supplier</th>
					<th width="80">Color</th>
					<th width="100">Construction</th>
					<th width="130">Copmposition</th>
					<th width="60">GSM</th>
					<th width="60">Dia/ Width</th>
					<th width="60">UOM</th>
					<th>Booking Type</th>
				</thead>
			 </table>
			 <div style="width:980px; max-height:250px; overflow-y:scroll">
				 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="960" class="rpt_table" id="tbl_list_search">
				 <?

				/*$con_select22 = connect();

				//echo "<pre>";print_r($prev_dtls_data_arr);die;
				$result = oci_parse($con_select22, $sql);
				oci_execute($result);
				//echo $result[csf("dtls_id")]->load();
				//print_r($result);
				while($summ=oci_fetch_array($result))
				{
					echo $summ[csf("dtls_id")]->load();
				}
				die;*/
				 $i=1;
				 $nameArray = sql_select($sql);
				 //print_r($nameArray);
				 foreach ($nameArray as $row)
				 {
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					// if($db_type==2 ) $row[csf('dtls_id')] = $row[csf('dtls_id')]->load();

					$construction=''; $copmposition='';
					if($goods_rcv_status==2)
					{
						$construction=$row[csf('construction')];
						$copmposition=$row[csf('copmposition')];
					}
					else
					{
						$construction=$construction_arr[$row[csf('detarmination_id')]];
						$copmposition=$composition_arr[$row[csf('detarmination_id')]];
					}
					$prev_datas="";
					if($selected_based_on==1)
					{
						//$bal_qtny=$row[csf('wo_qnty')]-$prev_pi_qnty_arr[$row[csf('mst_id')]];
						$bal_qtny=$row[csf('wo_qnty')]-$prev_pi_qnty_arr[$rowP[csf('mst_id')]][$rowP[csf('booking_no')]];
					}
					else
					{
						$bal_qtny=$row[csf('wo_qnty')]-$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];
						$prev_datas=$prev_dtls_data_arr[$row[csf('booking_no')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];
					}
					//echo $bal_qtny."=".$prev_datas."<br>";
					if($bal_qtny>0 && $prev_datas=="")
					{

						if($db_type==0)
						{
						  	$dtls_ids = $row[csf('dtls_id')];
						}else{
						  	$dtls_ids = $row[csf('dtls_id')]->load();
						}

						$booking_type="";
						if($row[csf('type')]==1)
						{
							if($row[csf('booking_type')]==1 && $row[csf('is_short')]==1)
							{
								$booking_type="Short Fab.";
								$fabric_approval_string=$trims_approval_need_arr[6];
							}
							if($row[csf('booking_type')]==1 && $row[csf('is_short')]==2)
							{
								$booking_type="Main Fab.";
								$fabric_approval_string=$trims_approval_need_arr[5];
							}
							if($row[csf('booking_type')]==4 && $row[csf('is_short')]==2)
							{
								$booking_type="Sample With Order";
								$fabric_approval_string=$trims_approval_need_arr[7];
							}
						}
						else
						{
							$booking_type="Sample Without Order";
							$fabric_approval_string=$trims_approval_need_arr[8];
						}
						//echo $row[csf('is_approved')]."**".$fabric_approval_string;die;
						//print_r($trims_approval_need_arr);die;
						if($row[csf('is_approved')]!=1 && $fabric_approval_string ==1) $bgcolor="#ffa38f";
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$dtls_ids."*".$row[csf('type')]."_".$row[csf('is_approved')]."_".$company_id."_".$fabric_approval_string; ;?>')">
							<td width="40" align="center"><? echo "$i"; ?></td>
							<td width="50" align="center"><p><? echo $row[csf('booking_no_prefix_num')];?></p></td>
							<td width="75" align="center"><p><? if($row[csf('booking_date')]!="" && $row[csf('booking_date')]!="0000-00-00") echo change_date_format($row[csf('booking_date')]);?></p></td>
							<td width="100"><p><? echo $buyer_arr[$row[csf('buyer_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $supplier_arr[$row[csf('supplier_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $color_library[$row[csf('fabric_color_id')]]; ?>&nbsp;</p></td>
							<td width="100"><p><? echo $construction; ?>&nbsp;</p></td>
							<td width="130"><p><? echo chop($copmposition,","); ?></p></td>
							<td width="60" align="center"><p><? echo $row[csf('gsm_weight')]; ?></p></td>
							<td width="60" align="center"><p><? echo $row[csf('dia_width')]; ?>&nbsp;</p></td>
							<td align="center" width="60"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?>&nbsp;</p></td>
							<td><p>
							<?

							echo $booking_type;
							?>&nbsp;</p></td>
						</tr>
						 <?
						 $i++;
					}
				 }
				 ?>
				</table>
			</div>
			<?
		}

		?>
        <table width="980" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
        <?
	}

	else if($item_category_id==14)  // Grey Fabric(woven)
	{
		$buyer_id_cond=$buyer_id_cond2='';
		if ($buyer_id != 0){
			$buyer_id_cond = " and a.buyer_id=$buyer_id";
			$buyer_id_cond2 = " and c.buyer_id=$buyer_id";
		}
		if($user_buyer_id!="") $buyer_id_cond .= " and a.buyer_id in($user_buyer_id)";
		if($user_buyer_id!="") $buyer_id_cond2 .= " and c.buyer_id in($user_buyer_id)";
		
		$wo_number=$wo_number2=$pi_wo_number="";	

		if ($data[0]!="")
		{
			$wo_number=" and a.booking_no like '%".trim($data[0])."'";
			$wo_number2=" and c.booking_no like '%".trim($data[0])."'";
			$pi_wo_number=" and b.work_order_no like '%".trim($data[0])."'";
		}
		
		$pi_mst_sql=sql_select("select BUYER_ID, BRAND_ID, SEASON_YEAR_ID, SEASON_ID from com_pi_master_details where id=$pi_mst_id and status_active=1");
		$mst_buyer_id=$pi_mst_sql[0]["BUYER_ID"];
		$mst_brand_id=$pi_mst_sql[0]["BRAND_ID"];
		$mst_season_year_id=$pi_mst_sql[0]["SEASON_YEAR_ID"];
		$mst_season_id=$pi_mst_sql[0]["SEASON_ID"];
		$sql_book_cond=$sql_book_cond2="";
		if($mst_buyer_id>0)
		{
			$sql_book_cond.=" and a.BUYER_ID=$mst_buyer_id";
			$sql_book_cond2.=" and c.BUYER_ID=$mst_buyer_id";
		}
		
		if($mst_brand_id>0)
		{
			$sql_book_cond.=" and a.BRAND_ID=$mst_brand_id";
			$sql_book_cond2.=" and c.BRAND_ID=$mst_brand_id";
		}
		
		if($mst_season_year_id>0)
		{
			$sql_book_cond.=" and a.SEASON_YEAR=$mst_season_year_id";
			$sql_book_cond2.=" and c.SEASON_YEAR=$mst_season_year_id";
		}
		
		if($mst_season_id>0)
		{
			$sql_book_cond.=" and a.SEASON_ID=$mst_season_id";
			$sql_book_cond2.=" and c.SEASON_ID=$mst_season_id";
		}
		
		//echo $selected_based_on."==".$goods_rcv_status."==".$goods_rcv_variable;die;
		if($selected_based_on==1)
		{
			//echo "$goods_rcv_status = $goods_rcv_variable";die;
			$prev_wo_mst_cond=$prev_wo_mst_cond2="";
			if($prev_wo_mst_ids!="") 
			{
				$prev_wo_mst_cond=" and a.id not in($prev_wo_mst_ids)";
				$prev_wo_mst_cond2=" and c.id not in($prev_wo_mst_ids)";
			}
			
			

			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				if($db_type==0)
				{
					$sql = "SELECT c.id as mst_id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id, group_concat(c.id) as dtls_id, max(a.color) as fabric_color_id, max(a.gsm) as gsm_weight, max(a.dia_width) as dia_width, max(b.order_uom) as uom, 1 as type
					from product_details_master a, inv_transaction b, wo_booking_mst c, wo_booking_dtls d,  fabric_sales_order_dtls e
					where a.id=b.prod_id and b.pi_wo_batch_no=c.id and c.booking_no=d.booking_no and d.pre_cost_fabric_cost_dtls_id=e.mst_id and d.po_break_down_id = e.id and a.item_category_id=3 and b.item_category=3 and b.transaction_type=1 and b.receive_basis=2 and a.item_category_id in($item_category_id) and c.company_id=$company_id and b.item_category in($item_category_id) and c.supplier_id like '$supplier_id' and c.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.pi_is_lock!=1 $buyer_id_cond2 $wo_number2 $wo_date_cond2 $prev_wo_mst_cond2 $sql_book_cond2
					group by c.id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id					
					order by c.booking_no_prefix_num desc";
					

				}
				else
				{
					$sql = "SELECT c.id as mst_id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, max(a.color) as fabric_color_id, max(a.gsm) as gsm_weight, max(a.dia_width) as dia_width, max(b.order_uom) as uom, 1 as type
					from product_details_master a, inv_transaction b, wo_booking_mst c, wo_booking_dtls d,  fabric_sales_order_dtls e
					where a.id=b.prod_id and b.pi_wo_batch_no=c.id and c.booking_no=d.booking_no and d.pre_cost_fabric_cost_dtls_id=e.mst_id and d.po_break_down_id = e.id and a.item_category_id=3 and b.item_category=3 and b.transaction_type=1 
					and b.receive_basis=2 and a.item_category_id in($item_category_id) and c.company_id=$company_id and b.item_category in($item_category_id) and c.supplier_id like '$supplier_id' and c.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.pi_is_lock!=1 $buyer_id_cond2 $wo_number2 $wo_date_cond2 $prev_wo_mst_cond2 $sql_book_cond2
					group by c.id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id					
					order by c.booking_no_prefix_num desc";
				}
				
				$construction_arr=array(); $composition_arr=array();
				$sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
				$data_array=sql_select($sql_deter);
				if(count($data_array)>0)
				{
					foreach( $data_array as $row )
					{
						$construction_arr[$row[csf('id')]]=$row[csf('construction')];

						if(array_key_exists($row[csf('id')],$composition_arr))
						{
							$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
						else
						{
							$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
					}
				}
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; 
				else $pay_mode_cond=" and a.pay_mode=2";

				if($db_type==0)
				{
					$sql = "SELECT a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date  ,a.is_approved, a.buyer_id, a.supplier_id, group_concat(b.id) as dtls_id, max(b.fabric_color_id) as  fabric_color_id, sum(b.fin_fab_qnty) as wo_qnty, max(c.determination_id) as lib_yarn_count_deter_id, max(b.construction) as construction, max(b.copmposition) as copmposition, max(c.gsm_weight) as gsm_weight, max(b.dia_width) as dia_width, max(c.cons_uom) as uom, 1 as type
					from wo_booking_mst a, wo_booking_dtls b, fabric_sales_order_dtls c
					where a.booking_no=b.booking_no  and b.pre_cost_fabric_cost_dtls_id = c.mst_id and b.po_break_down_id = c.id and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $prev_wo_mst_cond $wo_date_cond $pay_mode_cond $sql_book_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date  ,a.is_approved, a.buyer_id, a.supplier_id
					
					order by a.booking_no_prefix_num desc";
				}
				else
				{
					$sql = "SELECT a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date  ,a.is_approved, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, max(b.fabric_color_id) as  fabric_color_id, sum(b.fin_fab_qnty) as wo_qnty, max(c.determination_id) as lib_yarn_count_deter_id, max(b.construction) as construction, max(b.copmposition) as copmposition, max(c.gsm_weight) as gsm_weight, max(b.dia_width) as dia_width, max(c.cons_uom) as uom, 1 as type
					from wo_booking_mst a, wo_booking_dtls b, fabric_sales_order_dtls c
					where a.booking_no=b.booking_no  and b.pre_cost_fabric_cost_dtls_id = c.mst_id and b.po_break_down_id = c.id and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $prev_wo_mst_cond $wo_date_cond $pay_mode_cond $sql_book_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date  ,a.is_approved, a.buyer_id, a.supplier_id
					
					order by a.booking_no_prefix_num desc";
				}
				//echo $sql;//die;
			}


			$prev_pi_qnty_arr=return_library_array("select b.work_order_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and a.pi_basis_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $pi_wo_number group by b.work_order_id",'work_order_id','quantity');
			//print_r($prev_pi_qnty_arr);

		}
		else
		{
			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				if($db_type==0)
				{
					$sql = "SELECT c.id as mst_id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id, group_concat(c.id) as dtls_id, a.color as fabric_color_id, a.detarmination_id, a.gsm as gsm_weight, a.dia_width, b.order_uom as uom, 1 as type
					from product_details_master a, inv_transaction b, wo_booking_mst c, wo_booking_dtls d,  fabric_sales_order_dtls e
					where a.id=b.prod_id and b.pi_wo_batch_no=c.id and c.booking_no=d.booking_no and d.pre_cost_fabric_cost_dtls_id=e.mst_id and d.po_break_down_id=e.id and a.item_category_id=3 and b.item_category=3 and b.transaction_type=1 
					and b.receive_basis=2 and a.item_category_id in($item_category_id) and c.company_id=$company_id and b.item_category in($item_category_id) and c.supplier_id like '$supplier_id' and c.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.pi_is_lock!=1 $buyer_id_cond2 $wo_number2 $wo_date_cond2 $sql_book_cond2
					group by c.id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id, a.color, a.detarmination_id, a.gsm, a.dia_width, b.order_uom					
					order by c.booking_no_prefix_num desc";
					
				}
				else
				{
					$sql = "SELECT c.id as mst_id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, a.color as fabric_color_id, a.detarmination_id, a.gsm as gsm_weight, a.dia_width, b.order_uom as uom, 1 as type
					from product_details_master a, inv_transaction b, wo_booking_mst c, wo_booking_dtls d,  fabric_sales_order_dtls e
					where a.id=b.prod_id and b.pi_wo_batch_no=c.id and c.booking_no=d.booking_no and d.pre_cost_fabric_cost_dtls_id=e.mst_id and d.po_break_down_id=e.id and a.item_category_id=3 and b.item_category=3 and b.transaction_type=1 
					and b.receive_basis=2 and a.item_category_id in($item_category_id) and c.company_id=$company_id and b.item_category in($item_category_id) and c.supplier_id like '$supplier_id' and c.pay_mode=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and b.pi_is_lock!=1 $buyer_id_cond2 $wo_number2 $wo_date_cond2 $sql_book_cond2 
					group by c.id, c.booking_type, c.is_short, c.booking_no_prefix_num, c.booking_no, c.booking_date, c.buyer_id, c.supplier_id, a.color, a.detarmination_id, a.gsm, a.dia_width, b.order_uom					
					order by c.booking_no_prefix_num desc";
					
				}
				// and c.pi_is_lock!=1 and c.pi_is_lock!=1

				$construction_arr=array(); $composition_arr=array();
				$sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
				$data_array=sql_select($sql_deter);
				if(count($data_array)>0)
				{
					foreach( $data_array as $row )
					{
						$construction_arr[$row[csf('id')]]=$row[csf('construction')];

						if(array_key_exists($row[csf('id')],$composition_arr))
						{
							$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
						else
						{
							$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
					}
				}
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
				if($db_type==0)
				{

					$sql = "SELECT a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, group_concat(b.id) as dtls_id, b.fabric_color_id as  fabric_color_id, sum(b.fin_fab_qnty) as wo_qnty, c.determination_id as lib_yarn_count_deter_id, b.construction as construction, b.copmposition as copmposition, c.gsm_weight as gsm_weight, b.dia_width, c.cons_uom as uom, 1 as type
					from wo_booking_mst a, wo_booking_dtls b, fabric_sales_order_dtls c
					where a.booking_no=b.booking_no  and b.pre_cost_fabric_cost_dtls_id = c.mst_id and b.po_break_down_id = c.id and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.pay_mode=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $sql_book_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, b.fabric_color_id, c.determination_id, b.construction, b.copmposition, c.gsm_weight, b.dia_width, c.cons_uom
					
					order by a.booking_no_prefix_num desc";

				}
				else
				{
					$sql = "SELECT a.id as mst_id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id, b.fabric_color_id as  fabric_color_id, sum(b.fin_fab_qnty) as wo_qnty, c.determination_id as lib_yarn_count_deter_id, b.construction as construction, b.copmposition as copmposition, c.gsm_weight as gsm_weight, b.dia_width, c.cons_uom as uom, 1 as type
					from wo_booking_mst a, wo_booking_dtls b, fabric_sales_order_dtls c
					where a.booking_no=b.booking_no  and b.pre_cost_fabric_cost_dtls_id = c.mst_id and b.po_break_down_id = c.id and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.pay_mode=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $sql_book_cond
					group by a.id, a.booking_type, a.is_short, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, b.fabric_color_id, c.determination_id, b.construction, b.copmposition, c.gsm_weight, b.dia_width, c.cons_uom
					
					order by a.booking_no_prefix_num desc";
				}

				$prev_pi_qty_arr=array();
				$sql_prev="SELECT b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0 $pi_wo_number
				group by b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom";// and b.work_order_dtls_id in($wo_dtls_id)
				$prevData=sql_select($sql_prev);
				foreach($prevData as $rowP)
				{
					$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('gsm')]][$rowP[csf('dia_width')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
				}

			}
		}
		
		//echo $sql;
		//print_r($prev_pi_qnty_arr);die;

		//var_dump($prev_pi_qty_arr);die;
		//echo $sql; //die;
		//$result = sql_select($sql);

		$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
		$supplier_arr=return_library_array( "select id, short_name from lib_supplier",'id','short_name');
		$arr=array (2=>$supplier_arr,3=>$color_library,8=>$unit_of_measurement);

		

		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{
			?>
			 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="980" class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="50">WO No</th>
					<th width="75">WO Date</th>
					<th width="100">Buyer</th>
					<th width="80">Supplier</th>
					<th width="80">Color</th>
					<th width="100">Construction</th>
					<th width="130">Copmposition</th>
					<th width="60">GSM</th>
					<th width="60">Dia/ Width</th>
					<th width="60">UOM</th>
					<th>Booking Type</th>
				</thead>
			 </table>
			 <div style="width:980px; max-height:250px; overflow-y:scroll">
				 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="960" class="rpt_table" id="tbl_list_search">
				 <?
				 $i=1;
				 $nameArray=sql_select( $sql );
				 foreach ($nameArray as $row)
				 {
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					if($db_type==2 ) $row[csf('dtls_id')] = $row[csf('dtls_id')]->load();

					$construction=''; $copmposition='';
					echo $construction=$construction_arr[$row[csf('detarmination_id')]];
					$copmposition=$composition_arr[$row[csf('detarmination_id')]];

					$prev_datas="";
					if($selected_based_on!=1)
					{
						$prev_datas=$prev_dtls_data_arr[$row[csf('booking_no')]][$row[csf('detarmination_id')]][$row[csf('fabric_color_id')]][$construction][$copmposition][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];						
					}
					//echo '<pre>';print_r($prev_dtls_data_arr);

					if($prev_datas=="")
					{
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$row[csf('dtls_id')]."*".$row[csf('type')];?>')">
							<td width="40"><? echo "$i"; ?></td>
							<td width="50"><p><? echo $row[csf('booking_no_prefix_num')];?></p></td>
							<td width="75" align="center"><p><? if($row[csf('booking_date')]!="" && $row[csf('booking_date')]!="0000-00-00") echo change_date_format($row[csf('booking_date')]);?></p></td>
							<td width="100"><p><? echo $buyer_arr[$row[csf('buyer_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $supplier_arr[$row[csf('supplier_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $color_library[$row[csf('fabric_color_id')]]; ?>&nbsp;</p></td>
							<td width="100"><p><? echo $construction; ?>&nbsp;</p></td>
							<td width="130"><p><? echo chop($copmposition,","); ?></p></td>
							<td width="60"><p><? echo $row[csf('gsm_weight')]; ?></p></td>
							<td width="60"><p><? echo $row[csf('dia_width')]; ?>&nbsp;</p></td>
							<td align="center" width="60"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?>&nbsp;</p></td>
							<td><p>
							<?
							$booking_type="";
							if($row[csf('type')]==1)
							{
								if($row[csf('booking_type')]==1 && $row[csf('is_short')]==1) $booking_type="Short Fab.";
								if($row[csf('booking_type')]==1 && $row[csf('is_short')]==2) $booking_type="Main Fab.";
								if($row[csf('booking_type')]==4 && $row[csf('is_short')]==2) $booking_type="Sample With Order";
								if($row[csf('booking_type')]==7 && $row[csf('is_short')]==2) $booking_type="Woven Grey Fabric";
							}
							else
							{
								$booking_type="Sample Without Order";
							}
							echo $booking_type;
							?>&nbsp;</p></td>
						</tr>
						 <?
						 $i++;
					}
				 }

				 ?>
				</table>
			</div>
			<?
		}
		else
		{
			?>
			 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="980" class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="50">WO No</th>
					<th width="75">WO Date</th>
					<th width="100">Buyer</th>
					<th width="80">Supplier</th>
					<th width="80">Color</th>
					<th width="100">Construction</th>
					<th width="130">Copmposition</th>
					<th width="60">GSM</th>
					<th width="60">Dia/ Width</th>
					<th width="60">UOM</th>
					<th>Booking Type</th>
				</thead>
			 </table>
			 <div style="width:980px; max-height:250px; overflow-y:scroll">
				 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="960" class="rpt_table" id="tbl_list_search">
				 <?

				
				 $i=1;
				 $nameArray = sql_select($sql);
				 //print_r($nameArray);
				 foreach ($nameArray as $row)
				 {
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					// if($db_type==2 ) $row[csf('dtls_id')] = $row[csf('dtls_id')]->load();

					$construction=''; $copmposition='';
					if($goods_rcv_status==2)
					{
						$construction=$row[csf('construction')];
						$copmposition=$row[csf('copmposition')];
					}
					else
					{
						$construction=$construction_arr[$row[csf('detarmination_id')]];
						$copmposition=$composition_arr[$row[csf('detarmination_id')]];
					}
					$prev_datas="";
					if($selected_based_on==1)
					{
						$bal_qtny=$row[csf('wo_qnty')]-$prev_pi_qnty_arr[$row[csf('mst_id')]];
					}
					else
					{
						$bal_qtny=$row[csf('wo_qnty')]-$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];
						$prev_datas=$prev_dtls_data_arr[$row[csf('booking_no')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];
					}
					//echo $bal_qtny."=".$prev_datas."<br>";
					if($bal_qtny>0 && $prev_datas=="")
					{

						if($db_type==0)
						{
						  	$dtls_ids = $row[csf('dtls_id')];
						}else{
						  	$dtls_ids = $row[csf('dtls_id')]->load();
						}

						$booking_type="";
						if($row[csf('type')]==1)
						{
							if($row[csf('booking_type')]==1 && $row[csf('is_short')]==1)
							{
								$booking_type="Short Fab.";
								$fabric_approval_string=$trims_approval_need_arr[6];
							}
							if($row[csf('booking_type')]==1 && $row[csf('is_short')]==2)
							{
								$booking_type="Main Fab.";
								$fabric_approval_string=$trims_approval_need_arr[5];
							}
							if($row[csf('booking_type')]==4 && $row[csf('is_short')]==2)
							{
								$booking_type="Sample With Order";
								$fabric_approval_string=$trims_approval_need_arr[7];
							}
							if($row[csf('booking_type')]==7 && $row[csf('is_short')]==2) $booking_type="Woven Grey Fabric";
						}
						else
						{
							$booking_type="Sample Without Order";
							$fabric_approval_string=$trims_approval_need_arr[8];
						}
						//echo $row[csf('is_approved')]."**".$fabric_approval_string;die;
						//print_r($trims_approval_need_arr);die;
						if($row[csf('is_approved')]!=1 && $fabric_approval_string ==1) $bgcolor="#ffa38f";
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$dtls_ids."*".$row[csf('type')]."_".$row[csf('is_approved')]."_".$company_id."_".$fabric_approval_string; ;?>')">
							<td width="40" align="center"><? echo "$i"; ?></td>
							<td width="50" align="center"><p><? echo $row[csf('booking_no_prefix_num')];?></p></td>
							<td width="75" align="center"><p><? if($row[csf('booking_date')]!="" && $row[csf('booking_date')]!="0000-00-00") echo change_date_format($row[csf('booking_date')]);?></p></td>
							<td width="100"><p><? echo $buyer_arr[$row[csf('buyer_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $supplier_arr[$row[csf('supplier_id')]]; ?>&nbsp;</p></td>
							<td width="80"><p><? echo $color_library[$row[csf('fabric_color_id')]]; ?>&nbsp;</p></td>
							<td width="100"><p><? echo $construction; ?>&nbsp;</p></td>
							<td width="130"><p><? echo chop($copmposition,","); ?></p></td>
							<td width="60" align="center"><p><? echo $row[csf('gsm_weight')]; ?></p></td>
							<td width="60" align="center"><p><? echo $row[csf('dia_width')]; ?>&nbsp;</p></td>
							<td align="center" width="60"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?>&nbsp;</p></td>
							<td><p>
							<?

							echo $booking_type;
							?>&nbsp;</p></td>
						</tr>
						 <?
						 $i++;
					}
				 }
				 ?>
				</table>
			</div>
			<?
		}

		?>
        <table width="980" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
        <?
	}

	else if($item_category_id==4)  // Accessories
	{
		
		$booking_id_cond=""; $result=explode(",",$wo_dtls_id);
		if($db_type==2 && count($result)>999)
		{
			$booking_id_chunk_arr=array_chunk($result,999) ;
			foreach($booking_id_chunk_arr as $chunk_arr)
			{
				$chunk_arr_value=implode(",",$chunk_arr);
				$bokIds_cond.=" b.work_order_dtls_id in($chunk_arr_value) or ";
			}

			$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
			//echo $booking_id_cond;die;
		}
		else
		{
			$booking_id_cond=" and b.work_order_dtls_id in($wo_dtls_id)";
		}

		$buyer_id_cond=$buyer_id_cond_samp='';
		if ($buyer_id != 0){
			$buyer_id_cond = " and a.buyer_id=$buyer_id";
			$buyer_id_cond_samp = " and s.buyer_id=$buyer_id";
		}
		if($user_buyer_id!="" && $user_buyer_id > 0) $buyer_id_cond .= " and a.buyer_id in($user_buyer_id)";
		if($user_buyer_id!="" && $user_buyer_id > 0) $buyer_id_cond_samp .= " and s.buyer_id in($user_buyer_id)";

		if ($wo_year != 0){
			$wo_year_con = " and to_char(a.insert_date,'YYYY') ='$wo_year'";
			$wo_year_con_sample = " and to_char(s.insert_date,'YYYY') ='$wo_year'";
		}
		
	

		if(trim($data[0])!="")
		{
			$wo_number=" and a.booking_no like '%".trim($data[0])."'";
			$sample_wo_number=" and s.booking_no like '%".trim($data[0])."'";
		}
		else
		{
			$wo_number = '';
			$sample_wo_number = '';
		}

		if($db_type==0)
		{
			$year_field="YEAR(a.insert_date) as year,";
			$year_field_sample="YEAR(s.insert_date) as year,";
		}
		else if($db_type==2)
		{
			$year_field="to_char(a.insert_date,'YYYY') as year,";
			$year_field_sample="to_char(s.insert_date,'YYYY') as year,";
		}
		else
		{
			$year_field="";//defined Later
			$year_field_sample="";//defined Later
		}
		$wo_currency_cond="";
		if($pi_currency_id) $wo_currency_cond=" and a.currency_id=$pi_currency_id";
		//echo "gd_rcv_status=".$goods_rcv_status."__gd_rcv_vrbl=".$goods_rcv_variable;die;
		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{
			//echo "gd_rcv_status=".$goods_rcv_status."__gd_rcv_vrb=".$goods_rcv_variable;die;
			//echo trim($selected_based_on); die;
			if(trim($selected_based_on)==1)
			{
				if($db_type==0)
				{
					$sql = "select a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, a.is_short, a.booking_type, group_concat(d.id) as id, 0 as trim_group, max(b.item_description) as description, max(b.sensitivity) as sensitivity, 0 as uom, 1 as type, $year_field sum(d.order_amount) as amount, a.is_approved
					from wo_booking_mst a, inv_trims_entry_dtls b, inv_receive_master c, order_wise_pro_details d
					where a.id=b.booking_id and b.mst_id=c.id and b.id=d.dtls_id and b.trans_id=d.trans_id and c.entry_form=24 and c.item_category=4 and c.receive_basis=2 and a.pay_mode=1 and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and d.trans_type=1 and d.entry_form=24 $buyer_id_cond $wo_number $wo_date_cond $wo_year_con $prev_wo_ids_cond3 $wo_currency_cond
					group by a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, a.is_short, a.insert_date, a.booking_type, a.is_approved
					union all
					select booking_no_prefix_num, s.booking_no, s.booking_date, s.buyer_id, s.supplier_id, s.is_short, e.sample_type as booking_type, group_concat(e.id) as id, 0 as trim_group, max(d.item_description) as description, 0 as sensitivity, 0 as uom, 2 as type, YEAR(s.insert_date) as year, sum(e.order_amount) as amount , s.is_approved
					FROM wo_non_ord_samp_booking_dtls m, wo_non_ord_samp_booking_mst s, inv_trims_entry_dtls d, inv_transaction e
					WHERE e.booking_no=s.booking_no and s.id=d.booking_id and s.booking_no=d.booking_no and d.trans_id=e.id and d.booking_without_order=1 and s.company_id=2 and e.pi_is_lock!=1 and s.pay_mode=1 and s.status_active =1 and s.is_deleted=0 and e.status_active =1 and e.is_deleted=0 and s.item_category=4 and e.transaction_type=1 and year(s.insert_date)=2019 $buyer_id_cond_samp
					group by s.booking_no_prefix_num, s.booking_no, s.booking_date, s.buyer_id, s.supplier_id, s.is_short, s.insert_date, e.sample_type , s.is_approved";
					
					//echo $sql;die;

				}
				else
				{
					$sql = "select a.id as wo_id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, a.is_short, a.booking_type,rtrim(xmlagg(xmlelement(e,d.trans_id,',').extract('//text()') order by d.trans_id).GetClobVal(),',') AS id , 0 as trim_group, max(b.item_description) as description, max(b.sensitivity) as sensitivity, 0 as uom, 1 as type, $year_field sum(d.order_amount) as amount, sum(d.quantity) as order_qnty, a.is_approved
					from wo_booking_mst a, inv_trims_entry_dtls b, inv_receive_master c, order_wise_pro_details d
					where a.id=b.booking_id and b.mst_id=c.id and b.id=d.dtls_id and b.trans_id=d.trans_id and c.entry_form=24 and c.item_category=4 and c.receive_basis=2 and a.pay_mode=1 and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and d.trans_type=1 and d.entry_form=24 $buyer_id_cond $wo_number $wo_date_cond $wo_year_con $prev_wo_ids_cond3 $wo_currency_cond
					group by a.id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, a.is_short, a.insert_date, a.booking_type , a.is_approved
					union all
					select s.id as wo_id, s.booking_no_prefix_num, s.booking_no, s.booking_date, s.buyer_id, s.supplier_id, s.is_short, e.sample_type as booking_type, rtrim(xmlagg(xmlelement(e,e.id,',').extract('//text()') order by e.id).GetClobVal(),',') AS id , 0 as trim_group, max(d.item_description) as description, 0 as sensitivity, 0 as uom, 2 as type, $year_field_sample sum(e.order_amount) as amount, sum(e.order_qnty) as order_qnty , s.is_approved
					FROM wo_non_ord_samp_booking_mst s, inv_trims_entry_dtls d, inv_receive_master n, inv_transaction e
					WHERE s.booking_no=e.booking_no and n.id=d.mst_id and n.id=e.mst_id and s.id=n.booking_id and e.id=d.trans_id and s.company_id=$company_id and s.pay_mode=1 and e.pi_is_lock!=1 and s.status_active =1 and s.is_deleted=0 and e.status_active =1 and e.is_deleted=0 and s.item_category=4 and n.entry_form=24 and n.item_category=4 and n.receive_basis=2 and e.transaction_type=1 $buyer_id_cond_samp $sample_wo_number $sample_wo_date_cond $wo_year_con_sample $prev_wo_ids_cond4
					group by  s.id, s.booking_no_prefix_num, s.booking_no, s.booking_date, s.buyer_id, s.supplier_id, s.is_short, s.insert_date, e.sample_type , s.is_approved order by booking_no_prefix_num desc";
				}
				//echo $sql;//die;
				
				$pi_qnty_sql="select work_order_id, sum(quantity) as quantity from com_pi_item_details where work_order_id>0 and status_active=1 and is_deleted=0 and item_category_id=4 group by work_order_id";
				//echo $pi_qnty_sql;
				$pi_qnty_sql_result=sql_select($pi_qnty_sql);
				$prev_qnty_arr=array();
				foreach ($pi_qnty_sql_result as $row)
				{
					$prev_pi_qty_arr[$row[csf('work_order_id')]]=$row[csf('quantity')];
				}

			}
			else
			{
				if($db_type==0)
				{
					$sql = "select e.id as id,a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, a.is_short, a.booking_type,  b.item_group_id as trim_group, max(b.item_description) as description, max(b.sensitivity) as sensitivity, max(e.order_uom) as uom, 1 as type, $year_field sum(e.order_amount) as amount, sum(e.order_qnty) as order_qnty, e.prod_id , a.is_approved
					from wo_booking_mst a, inv_trims_entry_dtls b, inv_receive_master c, inv_transaction e
					where a.id=b.booking_id and b.mst_id=c.id and c.id=d.mst_id and d.id=b.trans_id and e.pi_is_lock!=1 and c.entry_form=24 and c.item_category=4 and c.receive_basis=2 and a.pay_mode=1 and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and e.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond $year_cond $prev_wo_ids_cond4 $wo_currency_cond
					group by e.id,a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, a.is_short, a.insert_date, a.booking_type, b.item_group_id, e.prod_id , a.is_approved
					union all
					select e.id as id,s.booking_no_prefix_num, s.booking_no, s.booking_date, s.buyer_id, s.supplier_id, s.is_short, m.sample_type as booking_type, d.item_group_id as trim_group, max(d.item_description) as description, 0 as sensitivity, max(e.order_uom) as uom, 2 as type, $year_field_sample sum(e.order_amount) as amount, sum(e.order_qnty) as order_qnty , e.prod_id , s.is_approved
					FROM wo_non_ord_samp_booking_mst s, wo_non_ord_samp_booking_dtls m, inv_trims_entry_dtls d, inv_receive_master n, inv_transaction e
					WHERE s.booking_no=m.booking_no and n.id=d.mst_id and n.id=e.mst_id and s.id=n.booking_id and e.id=d.trans_id and e.pi_is_lock!=1 and s.company_id=$company_id and s.pay_mode=1 and s.status_active =1 and s.is_deleted=0 and m.status_active =1 and m.is_deleted=0 and s.item_category=4 and n.entry_form=24 and n.item_category=4 and n.receive_basis=2  and e.transaction_type=1  $buyer_id_cond_samp $sample_wo_number $sample_wo_date_cond $year_cond_sample $prev_wo_ids_cond4
					group by  e.id,s.booking_no_prefix_num, s.booking_no, s.booking_date, s.buyer_id, s.supplier_id, s.is_short, s.insert_date, m.sample_type, d.item_group_id, e.prod_id , s.is_approved
					order by type, id";
				}
				else
				{
					$sql = "select e.id as id,a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, a.is_short, a.booking_type, b.item_group_id as trim_group, max(b.item_description) as description, max(b.sensitivity) as sensitivity, max(e.order_uom) as uom, 1 as type, $year_field sum(e.order_amount) as amount, sum(e.order_qnty) as order_qnty , e.prod_id , a.is_approved
					from wo_booking_mst a, inv_trims_entry_dtls b, inv_receive_master c, inv_transaction e
					where a.id=b.booking_id and b.mst_id=c.id and c.id=d.mst_id and d.id=b.trans_id and e.pi_is_lock!=1 and c.entry_form=24 and c.item_category=4 and c.receive_basis=2 and a.pay_mode=1 and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and e.transaction_type=1 $buyer_id_cond $wo_number $wo_date_cond $wo_year_con $prev_wo_ids_cond4 $wo_currency_cond
					group by  e.id,a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, a.is_short, a.insert_date, a.booking_type, b.item_group_id, e.prod_id , a.is_approved
					union all
					select e.id as id,s.booking_no_prefix_num, s.booking_no, s.booking_date, s.buyer_id, s.supplier_id, s.is_short, m.sample_type as booking_type, d.item_group_id as trim_group, max(d.item_description) as description, 0 as sensitivity, max(e.order_uom) as uom, 2 as type, $year_field_sample sum(e.order_amount) as amount, sum(e.order_qnty) as order_qnty, e.prod_id , s.is_approved
					FROM wo_non_ord_samp_booking_mst s, wo_non_ord_samp_booking_dtls m, inv_trims_entry_dtls d, inv_receive_master n, inv_transaction e
					WHERE s.booking_no=m.booking_no and n.id=d.mst_id and n.id=e.mst_id and s.id=n.booking_id and e.id=d.trans_id and e.pi_is_lock!=1 and s.company_id=$company_id and s.pay_mode=1 and s.status_active =1 and s.is_deleted=0 and m.status_active =1 and m.is_deleted=0 and s.item_category=4 and n.entry_form=24 and n.item_category=4 and n.receive_basis=2  and e.transaction_type=1 $buyer_id_cond_samp $sample_wo_number $sample_wo_date_cond $wo_year_con_sample $prev_wo_ids_cond4
					group by  e.id,s.booking_no_prefix_num, s.booking_no, s.booking_date, s.buyer_id, s.supplier_id, s.is_short, s.insert_date, m.sample_type, d.item_group_id, e.prod_id  , s.is_approved
					order by booking_no_prefix_num desc";
				}
				
				$pi_qnty_sql="select work_order_dtls_id, sum(quantity) as quantity from com_pi_item_details a, com_pi_master_details b 
				where a.pi_id=b.id and a.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and a.item_category_id=4 and b.after_goods_source=2 and b.item_category_id=4
				group by work_order_dtls_id";//after_goods_source
				//echo $pi_qnty_sql;
				$pi_qnty_sql_result=sql_select($pi_qnty_sql);
				$prev_qnty_arr=array();
				foreach ($pi_qnty_sql_result as $row)
				{
					$prev_pi_qty_arr[$row[csf('work_order_dtls_id')]]=$row[csf('quantity')];
				}

			}

		}
 		else
		{
			if($goods_rcv_status==1 && $goods_rcv_variable==1)
			{
				$pay_mode_cond=" and a.pay_mode=1";
				$pay_mode_nonOrd_cond=" and s.pay_mode=1";
			}
			else
			{
				$pay_mode_cond=" and a.pay_mode=2";
				$pay_mode_nonOrd_cond=" and s.pay_mode=2";
			}
			//echo $selected_based_on;die;
			if(trim($selected_based_on)==1)
			{
				if($db_type==0)
				{
					$sql = "select a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, a.is_short,group_concat(b.id) as id, 0 as trim_group,  max(b.description) as description, max(b.Sensitivity) as sensitivity, 0 as uom, 1 as type, $year_field b.booking_type, sum(b.amount) as amount, sum(b.wo_qnty) as quantity, a.is_approved
					from wo_booking_mst a, wo_booking_dtls b
					where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $year_cond $prev_wo_ids_cond $pay_mode_cond $wo_currency_cond
					group by a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, a.is_short, a.insert_date, b.booking_type , a.is_approved
					union all
					select s.booking_no_prefix_num, s.booking_no, s.booking_date, s.buyer_id, s.supplier_id, s.is_short, group_concat(d.id) as id, 0 as trim_group, max(d.fabric_description) as description, 0 as sensitivity, 0 as uom, 2 as type, $year_field_sample d.sample_type as booking_type, sum(d.amount) as amount, sum(d.trim_qty) as quantity , s.is_approved
					FROM wo_non_ord_samp_booking_mst s, wo_non_ord_samp_booking_dtls d
					WHERE s.booking_no=d.booking_no and s.company_id=$company_id and s.status_active =1 and s.is_deleted=0 and d.status_active =1 and d.is_deleted=0 and s.item_category=4 $buyer_id_cond_samp $sample_wo_number $sample_wo_date_cond $year_cond_sample $prev_wo_ids_cond3 $pay_mode_nonOrd_cond
					group by s.booking_no_prefix_num, s.booking_no, s.booking_date, s.buyer_id, s.supplier_id, s.is_short, s.insert_date, d.sample_type , s.is_approved
					order by type";
				}
 				else
				{


					$sql = "select a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, a.is_short, b.id as id, 0 as trim_group, null as description, b.Sensitivity as sensitivity, 0 as uom, 1 as type, $year_field b.booking_type, b.amount as amount, b.wo_qnty as quantity , a.is_approved
					from wo_booking_mst a, wo_booking_dtls b
					where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $wo_year_con $prev_wo_ids_cond $pay_mode_cond $buyer_id_cond $wo_currency_cond
					union all
					select s.booking_no_prefix_num, s.booking_no, s.booking_date, s.buyer_id, s.supplier_id, s.is_short, d.id as id, 0 as trim_group, d.fabric_description as description, 0 as sensitivity, 0 as uom, 2 as type, $year_field_sample d.sample_type as booking_type, d.amount as amount, d.trim_qty as quantity  , s.is_approved
					FROM wo_non_ord_samp_booking_mst s, wo_non_ord_samp_booking_dtls d WHERE s.booking_no=d.booking_no and s.company_id=$company_id and s.status_active =1 and s.is_deleted=0 and d.status_active =1 and d.is_deleted=0 and s.item_category=4 $buyer_id_cond_samp $sample_wo_number $sample_wo_date_cond $wo_year_con_sample $prev_wo_ids_cond3 $pay_mode_nonOrd_cond order by booking_no_prefix_num desc";
					// listagg(cast(b.id as varchar(4000)),',') within group (order by b.id) as id,  listagg(cast(d.id as varchar(4000)),',') within group (order by d.id) as id,
				}

				// echo $sql;die;

				$nameArray=sql_select( $sql );
				$booking_dtls_idArr=array();
				$booking_dtls_dataArr=array();
				foreach ($nameArray as $row)
				{
					if($db_type==0)
					{
						$wo_dtls_id[$row[csf('id')]]=$row[csf('id')];
						$booking_dtls_dataArr[$row[csf('booking_no')]]['id']=$row[csf('id')];
					}
					else
					{
						if ($booking_dtls_dataArr[$row[csf('booking_no')]]=='')
						{
							$booking_dtls_dataArr[$row[csf('booking_no')]]['id']=$row[csf('id')];
						}
						else
						{
							$booking_dtls_dataArr[$row[csf('booking_no')]]['id'].=','.$row[csf('id')];
						}
						$wo_dtls_id[$row[csf('id')]]=$row[csf('id')];
					}
					
					$booking_dtls_dataArr[$row[csf('booking_no')]]['type']=$row[csf('type')];
					$booking_dtls_dataArr[$row[csf('booking_no')]]['booking_type']=$row[csf('booking_type')];
					$booking_dtls_dataArr[$row[csf('booking_no')]]['is_short']=$row[csf('is_short')];
					$booking_dtls_dataArr[$row[csf('booking_no')]]['sensitivity']=$row[csf('sensitivity')];
					$booking_dtls_dataArr[$row[csf('booking_no')]]['amount']+=$row[csf('amount')];
					$booking_dtls_dataArr[$row[csf('booking_no')]]['booking_no_prefix_num']=$row[csf('booking_no_prefix_num')];
					$booking_dtls_dataArr[$row[csf('booking_no')]]['year']=$row[csf('year')];
					$booking_dtls_dataArr[$row[csf('booking_no')]]['booking_date']=$row[csf('booking_date')];
					$booking_dtls_dataArr[$row[csf('booking_no')]]['buyer_id']=$row[csf('buyer_id')];
					$booking_dtls_dataArr[$row[csf('booking_no')]]['supplier_id']=$row[csf('supplier_id')];
					$booking_dtls_dataArr[$row[csf('booking_no')]]['trim_group']=$row[csf('trim_group')];
					$booking_dtls_dataArr[$row[csf('booking_no')]]['description']=$row[csf('description')];
					$booking_dtls_dataArr[$row[csf('booking_no')]]['uom']=$row[csf('uom')];
					$booking_dtls_dataArr[$row[csf('booking_no')]]['quantity']+=$row[csf('quantity')];
					$booking_dtls_dataArr[$row[csf('booking_no')]]['wo_id']=$row[csf('id')];
					$booking_dtls_dataArr[$row[csf('booking_no')]]['is_approved']=$row[csf('is_approved')];
				}
			  	//print_r($wo_dtls_id);die;
				
				$con = connect();
				$r_id=execute_query("delete from GBL_TEMP_ENGINE where user_id=$user_id");
				if($r_id)
				{
					oci_commit($con);
				}
				
				if(count($wo_dtls_id)>0)
				{
					fnc_tempengine("GBL_TEMP_ENGINE", $user_id, 167, 1,$wo_dtls_id, $empty_arr);
				}
				
				//echo $pi_qnty_cond;die;
				
				$pi_qnty_sql="select A.WORK_ORDER_NO, A.WORK_ORDER_DTLS_ID, A.QUANTITY, A.AMOUNT 
				from com_pi_item_details a, GBL_TEMP_ENGINE b 
				where a.work_order_dtls_id=b.ref_val and b.REF_FROM=1 and a.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0";
				//echo $pi_qnty_sql;
				$pi_qnty_sql_result=sql_select($pi_qnty_sql);
				$prev_qnty_arr=array();
				foreach ($pi_qnty_sql_result as $row)
				{
					$prev_qnty_arr[$row['WORK_ORDER_NO']]['qnty']+=$row['QUANTITY'];
					$prev_qnty_arr[$row['WORK_ORDER_NO']]['amount']+=$row['AMOUNT'];
				}
						//print_r($booking_dtls_idArr);
						//print_r( $prev_qnty_arr);
				?>
				<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1000" class="rpt_table">
					<thead>
						<th width="40">SL No</th>
						<th width="60">WO No</th>
						<th width="50">Year</th>
						<th width="105">Type</th>
						<th width="80">WO Date</th>
						<th width="120">Buyer</th>
						<th width="130">Supplier</th>
						<th width="100">Item Group</th>
						<th width="140">Item Description</th>
						<th width="105">sensitivity</th>
						<th>uom</th>
					</thead>
				 </table>
				 <div style="width:1020px; max-height:250px; overflow-y:scroll">
					 <table cellspacing="0" cellpadding="0" border="1" rules="all" width="1000" class="rpt_table" id="tbl_list_search">
					 <?
					 $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
					 $supplier_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');
					 $item_group_arr=return_library_array( "select id,item_name FROM lib_item_group",'id','item_name');
					 $i=1;
					 $conj_dtls_id_arr=array();
					 foreach ($booking_dtls_dataArr as $bookingNo=>$value)
					 {
						if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";

						//print_r($trims_approval_setting);; echo $trims_approval_setting[9];

						if($value['type']==2)
						{
							$booking_type_text="Sample Without Order";
							$trims_approval_setting=$trims_approval_need_arr[12];
						}
						else
						{
							if($value['booking_type']==5)
							{
								$trims_approval_setting=$trims_approval_need_arr[11];
								$booking_type_text="Sample With Order";
							}
							else
							{
								if($value['is_short']==1)
								{
									$booking_type_text="Short";
									$trims_approval_setting=$trims_approval_need_arr[10];
								}
								else
								{
									$booking_type_text="Main";
									$trims_approval_setting=$trims_approval_need_arr[9];
									if($value['booking_type']==8) $trims_approval_setting=$trims_approval_need_arr[50];
								}
							}
						}

						if($value['is_approved']!=1 && $trims_approval_setting ==1) $bgcolor="#ffa38f";
						$booking_dtls_id='';
						$booking_dtls_id=implode(',',array_unique(explode(',',$value['id'])));
						//echo number_format($value['quantity'],6,'.','').'>'.number_format($prev_qnty_arr[$bookingNo]['qnty'],6,'.','')."=$bookingNo<br>";
						if( number_format($value['quantity'],4,'.','')> number_format($prev_qnty_arr[$bookingNo]['qnty'],4,'.','') )
						{
							$woAmount=$value['amount']-$prev_qnty_arr[$bookingNo]['amount'];
							?>
							<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$booking_dtls_id."_".$value['sensitivity']."_".$value['type']."_".$selected_based_on."_".$value['is_approved']."_".$company_id."_".$trims_approval_setting; ?>')">
								<td width="40">
									<? echo "$i"; ?>
									<input type="hidden" id="woAmt_<? echo $i;?>" name="woAmt_[]" value="<? echo number_format($woAmount,6,'.',''); ?>" style="width:50px;" />
								</td>
								<td width="60" title="<? echo $booking_dtls_id;?>"><p><? echo $value['booking_no_prefix_num'];?></p></td>
								<td width="50" title="<? echo number_format($value['quantity'],6,'.','')."=".number_format($prev_qnty_arr[$bookingNo]['qnty'],6,'.','');?>"><p><? echo $value['year'];?></p></td>
								<td width="105" title="<? echo $value['is_short']; ?>"><p><? echo $booking_type_text; ?></p></td>
								<td width="80" align="center"><p><? echo change_date_format($value['booking_date']); ?>&nbsp;</p></td>
								<td width="120"><p><? echo $buyer_arr[$value['buyer_id']]; ?>&nbsp;</p></td>
								<td width="130"><p><? echo $supplier_arr[$value['supplier_id']]; ?>&nbsp;</p></td>
								<td width="100"><p><? echo $item_group_arr[$value['trim_group']]; ?></p></td>
								<td width="140"><p><? echo $value['description']; ?></p></td>
								<td width="105"><p><? echo $size_color_sensitive[$value['sensitivity']]; ?>&nbsp;</p></td>
								<td align="center"><p><? echo $unit_of_measurement[$value['uom']]; ?></p></td>
							</tr>
							<?
							$i++;
						}

					 }
					 ?>
					</table>
				</div>
				<table width="1000" cellspacing="0" cellpadding="0" style="border:none" align="center">
					<tr>
						<td align="center" height="30" valign="bottom">
							<div style="width:100%">
								<div style="width:50%; float:left" align="left">
									<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
								</div>
								<div style="width:50%; float:left" align="left">
								<input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
								&nbsp;Total Wo Amount : &nbsp;
								<input type="text" class="text_boxes_numeric" id="totWoAmt" name="totWoAmt" value="" readonly />
								</div>
							</div>
						</td>
					</tr>
				</table>
				<?
				
				$r_id=execute_query("delete from GBL_TEMP_ENGINE where user_id=$user_id");
				if($r_id)
				{
					oci_commit($con);
				}
				disconnect($con);
				
				exit();
			}
			else
			{
				if($db_type==0)
				{
					$sql = "select b.id as id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, a.is_short , b.trim_group,  b.description as description, b.Sensitivity as sensitivity, b.uom as uom, 1 as type, $year_field b.booking_type, b.amount as amount, b.wo_qnty as quantity
					from wo_booking_mst a, wo_booking_dtls b
					where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $year_cond $prev_wo_ids_cond $pay_mode_cond $wo_currency_cond
					union all
					select d.id as id, s.booking_no_prefix_num, s.booking_no, s.booking_date, s.buyer_id, s.supplier_id, s.is_short , d.trim_group as trim_group, d.fabric_description as description, 0 as sensitivity, d.uom as uom, 2 as type, $year_field_sample d.sample_type as booking_type, d.amount as amount, d.trim_qty as quantity
					FROM wo_non_ord_samp_booking_mst s, wo_non_ord_samp_booking_dtls d
					WHERE s.booking_no=d.booking_no and s.company_id=$company_id and s.status_active =1 and s.is_deleted=0 and d.status_active =1 and d.is_deleted=0 and s.item_category=4 $buyer_id_cond_samp $sample_wo_number $sample_wo_date_cond $year_cond_sample $prev_wo_ids_cond3 $pay_mode_nonOrd_cond
					order by type, id";
				}
				else
				{
					$sql = "select b.id as id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, a.is_short , b.trim_group, null as description, b.Sensitivity as sensitivity, b.uom as uom, 1 as type, $year_field b.booking_type, b.amount as amount, b.wo_qnty as quantity
					from wo_booking_mst a, wo_booking_dtls b
					where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $year_cond $prev_wo_ids_cond $pay_mode_cond $wo_currency_cond
					union all
					select d.id as id, s.booking_no_prefix_num, s.booking_no, s.booking_date, s.buyer_id, s.supplier_id, s.is_short , d.trim_group as trim_group, d.fabric_description as description, 0 as sensitivity, d.uom as uom, 2 as type, $year_field_sample d.sample_type as booking_type, d.amount as amount, d.trim_qty as quantity
					FROM wo_non_ord_samp_booking_mst s, wo_non_ord_samp_booking_dtls d WHERE s.booking_no=d.booking_no and s.company_id=$company_id and s.status_active =1 and s.is_deleted=0 and d.status_active =1 and d.is_deleted=0 and s.item_category=4 $buyer_id_cond_samp $sample_wo_number $sample_wo_date_cond $year_cond_sample $prev_wo_ids_cond3 $pay_mode_nonOrd_cond order by booking_no_prefix_num desc";
				}
			}

			//echo $sql;

			/*$sql_prev="select b.work_order_no, b.work_order_dtls_id, b.color_id, b.item_group, b.item_description, b.size_id, b.item_color, b.item_size, b.uom, b.rate, b.brand_supplier, sum(b.quantity) as qty
			from com_pi_master_details a, com_pi_item_details b
			where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.goods_rcv_status=$goods_rcv_status and b.status_active=1 and b.is_deleted=0
			group by b.work_order_no, b.work_order_dtls_id, b.color_id, b.item_group, b.item_description, b.size_id, b.item_color, b.item_size, b.uom, b.rate, b.brand_supplier";// and b.work_order_dtls_id in($wo_dtls_id)
			$prevData=sql_select($sql_prev);
			foreach($prevData as $rowP)
			{
				$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('work_order_dtls_id')]][$rowP[csf('color_id')]][$rowP[csf('item_group')]][$rowP[csf('item_description')]][$rowP[csf('size_id')]][$rowP[csf('item_color')]][$rowP[csf('item_size')]][$rowP[csf('brand_supplier')]][$rowP[csf('uom')]][$rowP[csf('rate')]]=$rowP[csf('qty')];
			}*/

			$pi_qnty_sql="select work_order_dtls_id , sum(quantity) as quantity,sum(amount) as amount from com_pi_item_details where work_order_dtls_id>0 and status_active=1 and is_deleted=0 group by work_order_dtls_id";
			//echo $pi_qnty_sql;
			$pi_qnty_sql_result=sql_select($pi_qnty_sql);
			$prev_pi_qty_arr=array();
			foreach ($pi_qnty_sql_result as $row)
			{
				$prev_pi_qty_arr[$row[csf('work_order_dtls_id')]]['quantity']=$row[csf('quantity')];
				$prev_pi_qty_arr[$row[csf('work_order_dtls_id')]]['amount']+=$row[csf('amount')];
			}

		}
		//echo $sql;die;


		/*$sql = "select a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, b.id as dtls_id, b.trim_group, c.description, b.Sensitivity as sensitivity, c.id, b.uom, 0 as type, $year_field a.booking_type, a.is_short, c.amount from wo_booking_mst a, wo_booking_dtls b, wo_trim_book_con_dtls c where a.booking_no=b.booking_no and b.id=c.wo_trim_booking_dtls_id and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.pay_mode=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $year_cond
			union all
				select s.booking_no_prefix_num, s.booking_no, s.booking_date, s.supplier_id, d.id as dtls_id, d.trim_group, d.fabric_description as description, 0 as sensitivity, d.id as id, d.uom, 1 as type, $year_field_sample s.booking_type, s.is_short, d.amount FROM wo_non_ord_samp_booking_mst s, wo_non_ord_samp_booking_dtls d WHERE s.booking_no=d.booking_no and s.company_id=$company_id and s.pay_mode=2 and s.status_active =1 and s.is_deleted=0 and d.status_active =1 and d.is_deleted=0 and s.item_category=4 $sample_wo_number $sample_wo_date_cond $year_cond_sample order by type, id"; */

		//echo $sql;//die;
		//$result = sql_select($sql);

		$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
		$supplier_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');
		$item_group_arr=return_library_array( "select id,item_name FROM lib_item_group",'id','item_name');

		//$arr=array (2=>$supplier_arr,3=>$item_group_arr,5=>$size_color_sensitive,6=>$unit_of_measurement);
		//echo create_list_view("tbl_list_search", "WO Number, WO Date, Supplier, Item Group, Item Description, sensitivity, UOM", "80,80,160,100,170,140,60","880","250",0, $sql, "js_set_value", "id,sensitivity,type", "", 1, "0,0,supplier_id,trim_group,0,sensitivity,uom", $arr , "booking_no_prefix_num,booking_date,supplier_id,trim_group,description,sensitivity,uom", "",'','0,3,0,0,0,0,0','',1);

		?>
        <table cellspacing="0" cellpadding="0" border="1" rules="all" width="1100" class="rpt_table">
            <thead>
                <th width="40">SL No</th>
                <th width="60">WO No</th>
                <th width="50">Year</th>
                <th width="105">Type</th>
                <th width="80">WO Date</th>
                <th width="120">Buyer</th>
                <th width="130">Supplier</th>
                <th width="100">Item Group</th>
                <th width="140">Item Description</th>
                <th width="80">Qnty</th>
                <th width="105">sensitivity</th>
                <th>uom</th>
            </thead>
         </table>
         <div style="width:1100px; max-height:250px; overflow-y:scroll">
             <table cellspacing="0" cellpadding="0" border="1" rules="all" width="1080" class="rpt_table" id="tbl_list_search">
             <?
             $i=1;
             $nameArray=sql_select( $sql );$conj_dtls_id_arr=array();
             foreach ($nameArray as $row)
             {

                if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";

				if($row[csf('type')]==2)
				{
					$booking_type_text="Sample Without Order";
				}
				else
				{
					if($row[csf('booking_type')]==5)
					{
						$booking_type_text="Sample With Order";
					}
					else
					{
						if($row[csf('is_short')]==1) $booking_type_text="Short"; else $booking_type_text="Main";

					}
				}

				if($goods_rcv_status==1 && $goods_rcv_variable!=1)
				{
					if(trim($selected_based_on)==1)
					{
						$blance_qnty=$row[csf('order_qnty')]-$prev_pi_qty_arr[$row[csf('wo_id')]]['quantity'];
						$prev_pi_qnty=$prev_pi_qty_arr[$row[csf('wo_id')]]['quantity'];
					}
					else
					{
						$blance_qnty=$row[csf('order_qnty')]-$prev_pi_qty_arr[$row[csf('id')]]['quantity'];
						$prev_pi_qnty=$prev_pi_qty_arr[$row[csf('id')]]['quantity'];
					}
					if($blance_qnty>0)
					{
						$woAmount=$row[csf('amount')]-$prev_pi_qty_arr[$row[csf('id')]]['amount'];
						if($db_type==2 && trim($selected_based_on)==1) $row[csf('id')] = $row[csf('id')]->load();
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$row[csf('id')]."_".$row[csf('sensitivity')]."_".$row[csf('type')]."_".$selected_based_on; ?>')">
							<td width="40">
							<? echo "$i"; ?>
							<input type="hidden" id="woAmt_<? echo $i;?>" name="woAmt_[]" value="<? echo number_format($woAmount,6,'.',''); ?>" style="width:50px;" />
							</td>
							<td width="60"><p><? echo $row[csf('booking_no_prefix_num')];?></p></td>
							<td width="50"><p><? echo $row[csf('year')];?></p></td>
	
							<td width="105"><p><? echo $booking_type_text; ?></p></td>
							<td width="80" align="center"><p><? echo change_date_format($row[csf('booking_date')]); ?>&nbsp;</p></td>
							<td width="120"><p><? echo $buyer_arr[$row[csf('buyer_id')]]; ?>&nbsp;</p></td>
							<td width="130"><p><? echo $supplier_arr[$row[csf('supplier_id')]]; ?>&nbsp;</p></td>
							<td width="100"><p><? echo $item_group_arr[$row[csf('trim_group')]]; ?></p></td>
							<td width="140"><p><? echo $row[csf('description')]; ?></p></td>
                            <td width="80" align="right"><? echo number_format($row[csf('quantity')],4); ?></td>
							<td width="105" align="center"><p><? echo $size_color_sensitive[$row[csf('sensitivity')]]; ?>&nbsp;</p></td>
							<td align="center" title="<?= "wo_qnty=".$row[csf('order_qnty')]. "prev pi=".$prev_pi_qnty; ?>"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?></p></td>
						</tr>
						<?
						$i++;
					}

				}
				else
				{
					/*if($row[csf('type')]==0)
					{
						$bl_qty=$row[csf('qnty')]-$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('dtls_id')]][$row[csf('color_number_id')]][$row[csf('trim_group')]][$row[csf('description')]][$row[csf('size_id')]][$row[csf('item_color')]][$row[csf('item_size')]][$row[csf('brand_supplier')]][$row[csf('uom')]][$row[csf('rate')]];
					}
					else
					{
						$bl_qty=$row[csf('qnty')]-$prev_pi_qty_arr[$row[csf('dtls_id')]];
					}*/

					$bl_qty=$row[csf('quantity')]-$prev_pi_qty_arr[$row[csf('id')]]['quantity'];
					if($bl_qty>0)
					{
						$woAmount=$row[csf('amount')]-$prev_pi_qty_arr[$row[csf('id')]]['amount'];
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$row[csf('id')]."_".$row[csf('sensitivity')]."_".$row[csf('type')]."_".$selected_based_on; ?>')">
							<td width="40">
							<? echo "$i"; ?>
							<input type="hidden" id="woAmt_<? echo $i;?>" name="woAmt_[]" value="<? echo number_format($woAmount,6,'.',''); ?>" style="width:50px;" />
							</td>
							<td width="60"><p><? echo $row[csf('booking_no_prefix_num')];?></p></td>
							<td width="50"><p><? echo $row[csf('year')];?></p></td>
							<td width="105"><p><? echo $booking_type_text; ?></p></td>
							<td width="80" align="center"><p><? echo change_date_format($row[csf('booking_date')]); ?>&nbsp;</p></td>
							<td width="120"><p><? echo $buyer_arr[$row[csf('buyer_id')]]; ?>&nbsp;</p></td>
							<td width="130"><p><? echo $supplier_arr[$row[csf('supplier_id')]]; ?>&nbsp;</p></td>
							<td width="100"><p><? echo $item_group_arr[$row[csf('trim_group')]]; ?></p></td>
							<td width="140"><p><? echo $row[csf('description')]; ?></p></td>
                            <td width="80" align="right"><? echo number_format($row[csf('quantity')],4); ?></td>
							<td width="105" align="center"><p><? echo $size_color_sensitive[$row[csf('sensitivity')]]; ?>&nbsp;</p></td>
							<td align="center"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?></p></td>
						</tr>
						<?
						$i++;
					}
				}

				/*if($conj_dtls_id_arr[$row[csf('id')]]=="")
				{
					$conj_dtls_id_arr[$row[csf('id')]]=$row[csf('id')];

				}*/

             }
             ?>
            </table>
        </div>
		<table width="1000" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        &nbsp;Total Wo Amount : &nbsp; <input type="text" class="text_boxes_numeric" id="totWoAmt" name="totWoAmt" value="" readonly />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
	    <?
	}

	else if($item_category_id==12) // Services - Fabric
	{
		if($user_buyer_id!="") $buyer_id_cond .= " and a.buyer_id in($user_buyer_id)";
		
		if ($data[0]!="") $wo_number=" and a.booking_no like '%".trim($data[0])."'"; else { $wo_number = ''; }
		if ($data[0]!="") $wo_sam_number=" and a.wo_no like '%".trim($data[0])."'"; else { $wo_sam_number = ''; }
		if ($data[0]!="") $wo_dyeing_number=" and a.do_no like '%".trim($data[0])."'"; else { $wo_dyeing_number = ''; }
        
		if ($wo_year != 0){
			$wo_year_con = " and to_char(a.insert_date,'YYYY') ='$wo_year'";
		}

		/*$sql = "select a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, b.id, b.process, b.uom, b.color_size_table_id, b.fabric_color_id, b.item_size, c.fabric_description from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fab_conv_cost_dtls c where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.company_id=$company_id and a.item_category=$item_category_id and a.pay_mode=2 and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond order by a.id";*/
		if($selected_based_on==1)
		{
			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				if($db_type==0)
				{
					$sql = "SELECT a.id as mst_id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, group_concat(b.id) as id, sum(b.wo_qnty) as wo_qnty, 1 as type
					from wo_booking_mst a, wo_booking_dtls b, inv_receive_mas_batchroll c, pro_grey_batch_dtls d
					where a.booking_no=b.booking_no and c.entry_form=92 and c.id=d.mst_id and a.id=d.booking_id and b.id=d.booking_dtls_id and a.company_id=$company_id and a.item_category=$item_category_id and a.pay_mode=2 and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and d.status_active=1 $wo_number $wo_date_cond $prev_wo_ids_cond $buyer_id_cond
					group by a.id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id
					order by a.booking_no_prefix_num desc";
				}
				else
				{
					$sql = "SELECT a.id as mst_id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS id, sum(b.wo_qnty) as wo_qnty, 1 as type
					from wo_booking_mst a, wo_booking_dtls b, inv_receive_mas_batchroll c, pro_grey_batch_dtls d
					where a.booking_no=b.booking_no and c.entry_form=92 and c.id=d.mst_id and a.id=d.booking_id and b.id=d.booking_dtls_id and a.company_id=$company_id and a.item_category=$item_category_id and a.pay_mode=1 and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and d.status_active=1 $wo_number $wo_date_cond $prev_wo_ids_cond $buyer_id_cond $wo_year_con
					group by a.id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id
					order by a.booking_no_prefix_num desc";

				}
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
				if($db_type==0)
				{
					$sql = "SELECT a.id as mst_id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, group_concat(b.id) as id, sum(b.wo_qnty) as wo_qnty, 1 as type
					from wo_booking_mst a, wo_booking_dtls b
					where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id $pay_mode_cond and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $prev_wo_ids_cond $buyer_id_cond
					group by a.id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id
					union all
					select a.id as mst_id, a.wo_no_prefix_num as booking_no_prefix_num, a.wo_no as booking_no, a.booking_date, a.supplier_id, group_concat(b.id) as id, sum(b.wo_qty) as wo_qnty, 2 as type
					from wo_non_ord_aop_booking_mst a, wo_non_ord_aop_booking_dtls b
					where a.id=b.wo_id and a.company_id=$company_id and a.supplier_id like '$supplier_id' $pay_mode_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_sam_number $wo_date_cond $prev_wo_ids_cond $buyer_id_cond
					group by a.id, a.wo_no_prefix_num, a.wo_no, a.booking_date, a.supplier_id
					union all
					select a.id as mst_id, a.prefix_num as booking_no_prefix_num, a.booking_no as booking_no, a.booking_date, a.supplier_id, group_concat(b.id) as id, sum(b.wo_qty) as wo_qnty, 3 as type
					from wo_non_ord_knitdye_booking_mst a, wo_non_ord_knitdye_booking_dtl b
					where a.id=b.mst_id and a.company_id=$company_id and a.supplier_id like '$supplier_id' $pay_mode_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_date_cond $prev_wo_ids_cond $wo_number $buyer_id_cond
					group by a.id, a.prefix_num, a.booking_no, a.booking_date, a.supplier_id
					union all
					select a.id as mst_id, a.wo_number_prefix_num as booking_no_prefix_num, a.wo_no as booking_no, a.booking_date, a.supplier_id, group_concat(b.id) as id, sum(b.wo_qty) as wo_qnty, 4 as type
					from knitting_work_order_mst a, knitting_work_order_dtls b
					where a.id=b.mst_id and a.company_id=$company_id and a.supplier_id like '$supplier_id' $pay_mode_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_date_cond $prev_wo_ids_cond $wo_sam_number 
					group by a.id, a.wo_number_prefix_num, a.wo_no, a.booking_date, a.supplier_id
					union all
					select a.id as mst_id, a.do_number_prefix_num as booking_no_prefix_num, a.do_no as booking_no, a.wo_date as booking_date, a.dyeing_compnay_id as supplier_id, group_concat(b.id) as id, sum(b.wo_qty) as wo_qnty, 5 as type
					from dyeing_work_order_mst a, dyeing_work_order_dtls b
					where a.id=b.mst_id and a.company_id=$company_id and a.dyeing_compnay_id like '$supplier_id' $pay_mode_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $dyeing_wo_date_cond $prev_wo_ids_cond $wo_dyeing_number 
					group by a.id, a.wo_number_prefix_num, a.wo_no, a.booking_date, a.supplier_id
					order by booking_no_prefix_num desc";
				}
				else
				{
					$sql = "SELECT a.id as mst_id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS id, sum(b.wo_qnty) as wo_qnty, 1 as type
					from wo_booking_mst a, wo_booking_dtls b
					where a.booking_no=b.booking_no and a.company_id=$company_id and a.item_category=$item_category_id $pay_mode_cond and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $prev_wo_ids_cond $buyer_id_cond $wo_year_con
					group by a.id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id
					union all
					select a.id as mst_id, a.wo_no_prefix_num as booking_no_prefix_num, a.wo_no as booking_no, a.booking_date, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS id, sum(b.wo_qty) as wo_qnty, 2 as type
					from wo_non_ord_aop_booking_mst a, wo_non_ord_aop_booking_dtls b
					where a.id=b.wo_id and a.company_id=$company_id and a.supplier_id like '$supplier_id' $pay_mode_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_sam_number $wo_date_cond $prev_wo_ids_cond $buyer_id_cond $wo_year_con
					group by a.id, a.wo_no_prefix_num, a.wo_no, a.booking_date, a.supplier_id
					union all
					select a.id as mst_id, a.prefix_num as booking_no_prefix_num, a.booking_no as booking_no, a.booking_date, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS id, sum(b.wo_qty) as wo_qnty, 3 as type
					from wo_non_ord_knitdye_booking_mst a, wo_non_ord_knitdye_booking_dtl b
					where a.id=b.mst_id and a.company_id=$company_id and a.supplier_id like '$supplier_id' $pay_mode_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_date_cond $prev_wo_ids_cond $wo_number $buyer_id_cond $wo_year_con
					group by a.id, a.prefix_num, a.booking_no, a.booking_date, a.supplier_id
					union all
					select a.id as mst_id, a.wo_number_prefix_num as booking_no_prefix_num, a.wo_no as booking_no, a.booking_date, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS id, sum(b.wo_qty) as wo_qnty, 4 as type
					from knitting_work_order_mst a, knitting_work_order_dtls b
					where a.id=b.mst_id and a.company_id=$company_id and a.supplier_id like '$supplier_id' $pay_mode_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_date_cond $prev_wo_ids_cond $wo_sam_number $wo_year_con
					group by a.id, a.wo_number_prefix_num, a.wo_no, a.booking_date, a.supplier_id
					union all
					select a.id as mst_id, a.do_number_prefix_num as booking_no_prefix_num, a.do_no as booking_no, a.wo_date as booking_date, a.dyeing_compnay_id as supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS id, sum(b.wo_qty) as wo_qnty, 5 as type
					from dyeing_work_order_mst a, dyeing_work_order_dtls b
					where a.id=b.mst_id and a.company_id=$company_id and a.dyeing_compnay_id like '$supplier_id' $pay_mode_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $dyeing_wo_date_cond $prev_wo_ids_cond $wo_dyeing_number $wo_year_con
					group by a.id, a.do_number_prefix_num, a.do_no, a.wo_date, a.dyeing_compnay_id

					order by booking_no_prefix_num desc";

				}
				
				$prev_pi_qnty_arr=return_library_array("select b.work_order_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_id",'work_order_id','quantity');
			}
			//echo $sql;//die;
		}
		else
		{
			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				$sql = "SELECT a.id as mst_id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, b.id, b.process, b.uom, b.fabric_color_id as fabric_color_id, b.item_size, c.fabric_description, b.gmts_size, b.gmts_color_id, b.wo_qnty, 1 as type
				from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fab_conv_cost_dtls c, inv_receive_mas_batchroll d, pro_grey_batch_dtls e
				where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id  and d.entry_form=92 and d.id=e.mst_id and a.id=e.booking_id and b.id=e.booking_dtls_id and a.company_id=$company_id and a.item_category=$item_category_id and a.pay_mode=1 and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and d.status_active=1 and e.status_active=1 $wo_number $wo_date_cond $prev_wo_ids_cond $buyer_id_cond $wo_year_con
				order by a.booking_no_prefix_num desc";
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
				$sql = "SELECT a.id as mst_id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, b.id, b.process, b.uom, b.fabric_color_id as fabric_color_id, b.item_size, c.fabric_description, b.gmts_size, b.gmts_color_id, b.wo_qnty, 1 as type
				from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fab_conv_cost_dtls c
				where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.company_id=$company_id and a.item_category=$item_category_id $pay_mode_cond and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $prev_wo_ids_cond $buyer_id_cond $wo_year_con
				union all
				select a.id as mst_id, a.wo_no_prefix_num as booking_no_prefix_num, a.wo_no as booking_no, a.booking_date, a.supplier_id, b.id, 35 as process, b.uom, 0 as fabric_color_id, null as item_size, null as fabric_description, 0 as gmts_size, 0 as gmts_color_id, b.wo_qty as wo_qnty, 2 as type
				from wo_non_ord_aop_booking_mst a, wo_non_ord_aop_booking_dtls b
				where a.id=b.wo_id and a.company_id=$company_id and a.supplier_id like '$supplier_id' $pay_mode_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_sam_number $wo_date_cond $prev_wo_ids_cond $buyer_id_cond $wo_year_con
				union all
				select a.id as mst_id, a.prefix_num as booking_no_prefix_num, a.booking_no as booking_no, a.booking_date, a.supplier_id, b.id as id, 35 as process, b.uom, 0 as fabric_color_id, null as item_size, null as fabric_description, 0 as gmts_size, 0 as gmts_color_id, b.wo_qty as wo_qnty, 3 as type
				from wo_non_ord_knitdye_booking_mst a, wo_non_ord_knitdye_booking_dtl b
				where a.id=b.mst_id and a.company_id=$company_id and a.supplier_id like '$supplier_id' $pay_mode_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_date_cond $prev_wo_ids_cond $wo_number $buyer_id_cond $wo_year_con
				order by mst_id
				union all
				select a.id as mst_id, a.wo_number_prefix_num as booking_no_prefix_num, a.booking_no as booking_no, a.booking_date, a.supplier_id, b.id as id, 1 as process, b.uom, 0 as fabric_color_id, null as item_size, null as fabric_description, 0 as gmts_size, 0 as gmts_color_id, b.wo_qty as wo_qnty, 4 as type
				from knitting_work_order_mst a, knitting_work_order_dtls b
				where a.id=b.mst_id and a.company_id=$company_id and a.supplier_id like '$supplier_id' $pay_mode_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_date_cond $prev_wo_ids_cond $wo_sam_number $wo_year_con
				union all
				select a.id as mst_id, a.do_number_prefix_num as booking_no_prefix_num, a.do_no as booking_no, a.wo_date as booking_date, a.dyeing_compnay_id as supplier_id, 171 as process, b.uom, 0 as fabric_color_id, null as item_size, null as fabric_description, 0 as gmts_size, 0 as gmts_color_id, b.wo_qty as wo_qnty, 5 as type
				from dyeing_work_order_mst a, dyeing_work_order_dtls b
				where a.id=b.mst_id and a.company_id=$company_id and a.dyeing_compnay_id like '$supplier_id' $pay_mode_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $dyeing_wo_date_cond $prev_wo_ids_cond $wo_dyeing_number $wo_year_con
				order by booking_no_prefix_num desc";
	
				$prev_pi_qnty_arr=return_library_array("select b.work_order_dtls_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_dtls_id",'work_order_dtls_id','quantity');

			}

		}
		//echo $sql;
		//, b.color_size_table_id, 0 as color_size_table_id
		// echo $sql;die;
		$supplier_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');

		/*$sizeColor_arr=array();
		$col_size=sql_select( "select id, color_number_id, size_number_id from wo_po_color_size_breakdown where status_active=1 and is_deleted=0" );
		foreach($col_size as $csRow)
		{
			$sizeColor_arr[$csRow[csf('id')]]['color']=$csRow[csf('color_number_id')];
			$sizeColor_arr[$csRow[csf('id')]]['size']=$csRow[csf('size_number_id')];
		}*/

		$desc_arr=array();
		$descArrray=sql_select( "select id, body_part_id, color_type_id, construction, composition from wo_pre_cost_fabric_cost_dtls where status_active=1 and is_deleted=0");
		foreach($descArrray as $dRow)
		{
			$descArrray[$dRow[csf('id')]]['bp']=$dRow[csf('body_part_id')];
			$descArrray[$dRow[csf('id')]]['ct']=$dRow[csf('color_type_id')];
			$descArrray[$dRow[csf('id')]]['cons']=$dRow[csf('construction')];
			$descArrray[$dRow[csf('id')]]['comp']=$dRow[csf('composition')];
		}

		?>
        <table cellspacing="0" cellpadding="0" border="1" rules="all" width="870" class="rpt_table">
            <thead>
                <th width="40">SL No</th>
                <th width="60">WO No</th>
                <th width="70">WO Date</th>
                <th width="120">Supplier</th>
                <th width="80">process</th>
                <th width="160">Description</th>
                <th width="80">Gmts Color</th>
                <th width="80">Item Color</th>
                <th width="60">Gmts Size</th>
                <th width="60">Item Size</th>
                <th>uom</th>
            </thead>
         </table>
         <div style="width:888px; max-height:250px; overflow-y:scroll">
             <table cellspacing="0" cellpadding="0" border="1" rules="all" width="870" class="rpt_table" id="tbl_list_search">
             <?
			 $i=1;
			 //echo $sql;die;
             $nameArray=sql_select( $sql );
             foreach ($nameArray as $selectResult)
             {
                if ($i%2==0)
                    $bgcolor="#E9F3FF";
                else
                    $bgcolor="#FFFFFF";
                if($db_type==2 && $selected_based_on==1) $selectResult[csf('id')] = $selectResult[csf('id')]->load();

                //$col_size=sql_select( "select color_number_id, size_number_id from wo_po_color_size_breakdown where id='".$selectResult[csf('color_size_table_id')]."'" );
                //echo $selectResult[csf('id')].'system';
				if($selectResult[csf('fabric_description')]==0)
				{
					$desc="All Fabrics";
				}
				else
				{
					//$descArrray=sql_select( "select body_part_id, color_type_id, construction, composition from wo_pre_cost_fabric_cost_dtls where id='".$selectResult[csf('fabric_description')]."'" );
					//$desc=$body_part[$descArrray[0][csf('body_part_id')]].", ".$color_type[$descArrray[0][csf('color_type_id')]].", ".$descArrray[0][csf('construction')].", ".$descArrray[0][csf('composition')];

					$desc=$body_part[$descArrray[$selectResult[csf('fabric_description')]]['bp']].", ".$color_type[$descArrray[$selectResult[csf('fabric_description')]]['ct']].", ".$descArrray[$selectResult[csf('fabric_description')]]['cons'].", ".$descArrray[$selectResult[csf('fabric_description')]]['comp'];
				}

				if($goods_rcv_status==1 && $goods_rcv_variable!=1)
				{
					$bal_qnty=1;

				}
				else
				{
					if($selected_based_on==1)
					{
						$bal_qnty=$selectResult[csf('wo_qnty')]-$prev_pi_qnty_arr[$selectResult[csf('mst_id')]];
					}
					else
					{
						$bal_qnty=$selectResult[csf('wo_qnty')]-$prev_pi_qnty_arr[$selectResult[csf('id')]];
					}
				}



				if($bal_qnty>0)
				{
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$selectResult[csf('id')]."*".$selectResult[csf('type')]; ?>')">
						<td width="40"><? echo "$i"; ?></td>
						<td width="60"><p><? echo $selectResult[csf('booking_no_prefix_num')];?></p></td>
						<td width="70"><p><? echo change_date_format($selectResult[csf('booking_date')]); ?>&nbsp;</p></td>
						<td width="120"><p><? echo $supplier_arr[$selectResult[csf('supplier_id')]]; ?>&nbsp;</p></td>
						<td width="80"><p><? echo $conversion_cost_head_array[$selectResult[csf('process')]]; ?>&nbsp;</p></td>
						<td width="160"><p><? echo $desc; ?>&nbsp;</p></td>
						<td width="80"><p><? echo $color_library[$selectResult[csf('gmts_color_id')]]; ?>&nbsp;</p></td>
						<td width="80"><p><? echo $color_library[$selectResult[csf('fabric_color_id')]]; ?>&nbsp;</p></td>
						<td width="60"><p><? echo $size_library[$selectResult[csf('gmts_size')]]; ?>&nbsp;</p></td>
						<td width="60"><p><? echo $selectResult[csf('item_size')]; ?>&nbsp;</p></td>
						<td><p><? echo $unit_of_measurement[$selectResult[csf('uom')]]; ?>&nbsp;</p></td>
					</tr>
					<?
					$i++;
				}
             }
             ?>
            </table>
        </div>
		<table width="870" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
	    <?
	}

	else if($item_category_id==24)  // Services - Yarn Dyeing
	{
		//if($user_buyer_id!="") $buyer_id_cond .= " and a.buyer_id in($user_buyer_id)";
		//if($user_buyer_id!="") $buyer_id_cond_samp .= " and s.buyer_id in($user_buyer_id)";
		if ($data[0]!="") $wo_number=" and a.ydw_no like '%".trim($data[0])."'"; else { $wo_number = ''; }

		if ($wo_year != 0){
			$wo_year_con = " and to_char(a.insert_date,'YYYY') ='$wo_year'";
		}

		//echo $goods_rcv_status."=".$goods_rcv_variable;die;
		if($selected_based_on==1)
		{
			//echo $goods_rcv_status."=".$goods_rcv_variable;die;
			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				if($db_type==0)
				{
					$sql = "select a.id as mst_id, a.yarn_dyeing_prefix_num, a.ydw_no, a.booking_date, a.supplier_id, group_concat(c.id) as id
					from wo_yarn_dyeing_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form=1 and b.receive_purpose=2 and c.item_category=1 and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id=1 and a.company_id=$company_id and a.item_category_id=$item_category_id and a.pay_mode=2 and c.pi_is_lock<>1 and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.transaction_type=1 $wo_number $wo_date_cond $wo_year_con $prev_wo_ids_cond2
					group by a.id, a.yarn_dyeing_prefix_num, a.ydw_no, a.booking_date, a.supplier_id
					order by a.yarn_dyeing_prefix_num desc";
				}
				else
				{
					$sql = "select a.id as mst_id, a.yarn_dyeing_prefix_num, a.ydw_no, a.booking_date, a.supplier_id, listagg(cast(c.id as varchar(4000)),',') within group(order by c.id) AS id 
					from wo_yarn_dyeing_mst a, inv_receive_master b, inv_transaction c, product_details_master d
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form=1 and b.receive_purpose=2 and c.item_category=1 and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id=1 and a.company_id=$company_id and a.item_category_id=$item_category_id and a.pay_mode=2 and c.pi_is_lock<>1 and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  and c.transaction_type=1 $wo_number $wo_date_cond $wo_year_con $prev_wo_ids_cond2
					group by a.id, a.yarn_dyeing_prefix_num, a.ydw_no, a.booking_date, a.supplier_id
					order by a.yarn_dyeing_prefix_num desc";
				}
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
				if($db_type==0)
				{
					$sql = "select a.id as mst_id, a.yarn_dyeing_prefix_num, a.ydw_no, a.booking_date, a.supplier_id, group_concat(b.job_no) as job_no, group_concat(b.id) as id, sum(b.yarn_wo_qty) as yarn_wo_qty
					from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b
					where a.id=b.mst_id and a.company_id=$company_id and a.item_category_id=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $prev_wo_ids_cond $wo_year_con  $pay_mode_cond
					group by  a.id, a.yarn_dyeing_prefix_num, a.ydw_no, a.booking_date, a.supplier_id
					order by a.yarn_dyeing_prefix_num desc";
				}
				else
				{
					//
					$sql = "select a.id as mst_id, a.yarn_dyeing_prefix_num, a.ydw_no, a.booking_date, a.supplier_id, listagg(cast(b.job_no as varchar(4000)),',') within group(order by b.job_no) AS job_no, listagg(cast(b.id as varchar(4000)),',') within group(order by b.id) AS id, sum(b.yarn_wo_qty) as yarn_wo_qty
					from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b
					where a.id=b.mst_id and a.company_id=$company_id and a.item_category_id=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $prev_wo_ids_cond $wo_year_con $pay_mode_cond
					group by  a.id, a.yarn_dyeing_prefix_num, a.ydw_no, a.booking_date, a.supplier_id
					order by a.yarn_dyeing_prefix_num desc";
				}
				//echo $sql;die;

				$prev_pi_qnty_arr=return_library_array("select b.work_order_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_id",'work_order_id','quantity');

			}
		}
		else
		{
			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				$sql = "select a.id as mst_id, a.yarn_dyeing_prefix_num, a.ydw_no, a.booking_date, a.supplier_id, c.id, c.prod_id as product_id, c.job_no, c.order_uom as uom, d.product_name_details as yarn_description, d.color as yarn_color, 0 as color_range from wo_yarn_dyeing_mst a, inv_receive_master b, inv_transaction c, product_details_master d
				 where a.id=b.booking_id and b.id=c.mst_id and b.entry_form=1 and b.receive_purpose=2 and c.item_category=1 and c.prod_id=d.id and b.receive_basis=2 and c.pi_is_lock<>1 and d.item_category_id=1 and a.company_id=$company_id and a.item_category_id=$item_category_id and a.pay_mode=2 and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.transaction_type=1 $wo_number $wo_date_cond $prev_wo_ids_cond2 order by a.yarn_dyeing_prefix_num desc";
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
				$sql = "select a.id as mst_id, a.yarn_dyeing_prefix_num, a.ydw_no, a.booking_date, a.supplier_id, b.id, b.product_id, b.job_no, b.uom, b.yarn_description, b.yarn_color, b.color_range
				from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and a.company_id=$company_id and a.item_category_id=$item_category_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $prev_wo_ids_cond $pay_mode_cond order by a.yarn_dyeing_prefix_num desc";

				$prev_pi_qnty_arr=return_library_array("select b.work_order_dtls_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_dtls_id",'work_order_dtls_id','quantity');
			}
		}



		//echo $sql;//die;
		//$result = sql_select($sql);

		$supplier_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');
		$lot_arr=return_library_array( "select id, lot from product_details_master where item_category_id=1",'id','lot');
		$color_array=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
		?>
        <table cellspacing="0" cellpadding="0" border="1" rules="all" width="870" class="rpt_table">
            <thead>
                <th width="40">SL No</th>
                <th width="70">WO No</th>
                <th width="80">WO Date</th>
                <th width="130">Supplier</th>
                <th width="100">Job No</th>
                <th width="80">Lot</th>
                <th width="150">Yarn Description</th>
                <th width="80">Yarn Color</th>
                <th width="80">Color_range</th>
                <th>UOM</th>
            </thead>
         </table>
         <div style="width:888px; max-height:250px; overflow-y:scroll">
             <table cellspacing="0" cellpadding="0" border="1" rules="all" width="870" class="rpt_table" id="tbl_list_search">
             <?
             $i=1;
             $nameArray=sql_select( $sql );
             foreach ($nameArray as $selectResult)
             {
                if ($i%2==0)
                    $bgcolor="#E9F3FF";
                else
                    $bgcolor="#FFFFFF";
                /*if($selected_based_on==1){
                	if($goods_rcv_status==1 && $goods_rcv_variable!=1){
                		if($db_type==2) $row[csf('id')] = $row[csf('id')]->load();
                	}
                	else{
                		if($db_type==2) $row[csf('id')] = $row[csf('id')]->load();
                		if($db_type==2) $row[csf('job_no')] = $row[csf('job_no')]->load();
                	}
                }*/

				if($goods_rcv_status==2 || $goods_rcv_status==1)
				{
					if($selected_based_on==1)
					{
						$bal_quantity=$selectResult[csf("yarn_wo_qty")]-$prev_pi_qnty_arr[$selectResult[csf("mst_id")]];
					}
					else
					{
						$bal_quantity=$selectResult[csf("yarn_wo_qty")]-$prev_pi_qnty_arr[$selectResult[csf("id")]];
					}
				}
				else
				{
					$bal_quantity=1;
				}

				if($bal_quantity>0)
				{
					//if($selectResult[csf('job_no')] !="") $order_nooOrder_type=1;else $order_nooOrder_type=2;
					$job_nos=implode(",",array_unique(explode(",",$selectResult[csf('job_no')])));
					if(trim($job_nos) !="") $order_nooOrder_type=1; else $order_nooOrder_type=2;
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$selectResult[csf('id')]."*".$order_nooOrder_type; ?>')">
						<td width="40"><? echo "$i"; ?></td>
						<td width="70"><p><? echo $selectResult[csf('yarn_dyeing_prefix_num')];?></p></td>
						<td width="80"><p><? echo change_date_format($selectResult[csf('booking_date')]); ?>&nbsp;</p></td>
						<td width="130"><p><? echo $supplier_arr[$selectResult[csf('supplier_id')]]; ?>&nbsp;</p></td>
						<td width="100"><p><? echo $job_nos; ?>&nbsp;</p></td>
						<td width="80"><p><? echo $lot_arr[$selectResult[csf('product_id')]]; ?>&nbsp;</p></td>
						<td width="150"><p><? echo $selectResult[csf('yarn_description')]; ?>&nbsp;</p></td>
						<td width="80"><p><? echo $color_array[$selectResult[csf('yarn_color')]]; ?>&nbsp;</p></td>
						<td width="80"><p><? echo $color_range[$selectResult[csf('color_range')]]; ?>&nbsp;</p></td>
						<td><p><? echo $unit_of_measurement[$selectResult[csf('uom')]]; ?>&nbsp;</p></td>
					</tr>
					<?
					$i++;
				}
             }
             ?>
            </table>
        </div>
		<table width="870" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
	    <?
	}

	else if($item_category_id==25) // Services - Embalishment
	{
		$buyer_id_cond='';
		if ($buyer_id != 0){
			$buyer_id_cond = " and a.buyer_id=$buyer_id";
		}

		if ($wo_year != 0){
			$wo_year_con = " and to_char(a.insert_date,'YYYY') ='$wo_year'";
		}
		if($user_buyer_id!="") $buyer_id_cond .= " and a.buyer_id in($user_buyer_id)";
		if ($data[0]!="") $wo_number=" and a.booking_no like '%".trim($data[0])."'"; else { $wo_number = ''; }
		//echo $user_buyer_id."=".$buyer_id_cond.test;die;
		if($selected_based_on==1)
		{
			if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
			if($db_type==0)
			{
				$sql = "select a.id as mst_id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, a.buyer_id, group_concat(b.id) as id, sum(b.wo_qnty) as wo_qnty
				from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_embe_cost_dtls c
				where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' $pay_mode_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_year_con $wo_number $wo_date_cond $prev_wo_ids_cond
				group by a.id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, a.buyer_id
				order by a.booking_no_prefix_num desc";
			}
			else
			{
				$sql = "select a.id as mst_id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, a.buyer_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS id , sum(b.wo_qnty) as wo_qnty
				from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_embe_cost_dtls c
				where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' $pay_mode_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_year_con $wo_number $wo_date_cond $prev_wo_ids_cond
				group by a.id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, a.buyer_id
				order by a.booking_no_prefix_num desc";
			}
			$prev_pi_qnty_arr=return_library_array("select b.work_order_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_id",'work_order_id','quantity');
		}
		else
		{
			if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
			$sql = "select a.id as mst_id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, a.buyer_id, b.id, b.gmts_color_id, b.gmt_item, c.emb_name, c.emb_type, b.wo_qnty as wo_qnty
			from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_embe_cost_dtls c
			where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' $pay_mode_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_year_con $wo_date_cond $prev_wo_ids_cond
			order by a.booking_no_prefix_num desc";
			$prev_pi_qnty_arr=return_library_array("select b.work_order_dtls_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_dtls_id",'work_order_dtls_id','quantity');
		}
		// echo $sql;die;

		$nameArray=sql_select( $sql );

		foreach ($nameArray as $selectResult)
		{
			//$selectResult[csf('id')] = $selectResult[csf('id')]->load();
			//$wo_id .= $selectResult[csf('id')].",";
			$booking_no .= "'".$selectResult[csf('booking_no')]."'".",";
		}
		//$all_wo_id = ltrim(implode(",", array_unique(explode(",", chop($wo_id, ",")))), ',');
		$all_booking_no = ltrim(implode(",", array_unique(explode(",", chop($booking_no, ",")))), ',');
		
		$style_ref_sql = "SELECT A.STYLE_REF_NO,C.BOOKING_NO
		FROM WO_PO_DETAILS_MASTER A, WO_PO_BREAK_DOWN B ,WO_BOOKING_DTLS C
		WHERE A.ID=B.JOB_ID AND B.ID = C.PO_BREAK_DOWN_ID AND C.BOOKING_NO in ($all_booking_no) AND  A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0  AND  c.IS_DELETED=0 AND c.STATUS_ACTIVE=1 group by A.STYLE_REF_NO,C.BOOKING_NO";
		//echo $style_ref_sql;
		$styleArray=sql_select( $style_ref_sql );
		
		foreach ($styleArray as $row)
		{
			$style_arr[$row['BOOKING_NO']]['STYLE_REF_NO'] .= $row['STYLE_REF_NO']." ,";
		}
	
		$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
		$supplier_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');
		//$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');
		$order_nonOrder_type=1;
		?>
        <table cellspacing="0" cellpadding="0" border="1" rules="all" width="900" class="rpt_table">
            <thead>
                <th width="40">SL No</th>
                <th width="70">WO No</th>
                <th width="80">WO Date</th>
                <th width="100">Buyer</th>
                <th width="120">Supplier</th>                
                <th width="150">Gmts Item</th>
                <th width="90">Embell. Name</th>
                <th width="100">Embell. Type</th>
                <th>Gmts Color</th>
            </thead>
        </table>
        <div style="width:920px; max-height:250px; overflow-y:scroll">
            <table cellspacing="0" cellpadding="0" border="1" rules="all" width="900" class="rpt_table" id="tbl_list_search">
            <?
            $i=1;
            
            foreach ($nameArray as $selectResult)
            {
                if ($i%2==0)
                    $bgcolor="#E9F3FF";
                else
                    $bgcolor="#FFFFFF";
                if($db_type==2 && $selected_based_on==1 ) $selectResult[csf('id')] = $selectResult[csf('id')]->load();

             	$bal_qnty=0;
				if($goods_rcv_status==1 && $goods_rcv_variable!=1)
				{
					$bal_qnty=1;
 
				}
				else
				{
					if($selected_based_on==1)
					{
						$bal_qnty=$selectResult[csf('wo_qnty')]-$prev_pi_qnty_arr[$selectResult[csf('mst_id')]];
					}
					else
					{
						$bal_qnty=$selectResult[csf('wo_qnty')]-$prev_pi_qnty_arr[$selectResult[csf('id')]];
					}
				}
				
				if($bal_qnty>0)
				{
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$selectResult[csf('id')]."*".$order_nonOrder_type; ?>')">
						<td width="40"><? echo "$i"; ?></td>
						<td width="70" title="<? echo chop($style_arr[$selectResult[csf('booking_no')]]['STYLE_REF_NO'],',');?>"><p><? echo $selectResult[csf('booking_no_prefix_num')];?></p></td>
						<td width="80"><p><? echo change_date_format($selectResult[csf('booking_date')]); ?>&nbsp;</p></td>
						<td width="100"><p><? echo $buyer_arr[$selectResult[csf('buyer_id')]]; ?>&nbsp;</p></td>
						<td width="120"><p><? echo $supplier_arr[$selectResult[csf('supplier_id')]]; ?>&nbsp;</p></td>		
						<td width="150"><p><? echo $garments_item[$selectResult[csf('gmt_item')]]; ?>&nbsp;</p></td>
						<td width="90"><p><? echo $emblishment_name_array[$selectResult[csf('emb_name')]]; ?>&nbsp;</p></td>
						<td width="100">
							<p>
								<?
									if($selectResult[csf('emb_name')]==1) echo $emblishment_print_type[$selectResult[csf('emb_type')]];
									else if($selectResult[csf('emb_name')]==2) echo $emblishment_embroy_type[$selectResult[csf('emb_type')]];
									else if($selectResult[csf('emb_name')]==3) echo $emblishment_wash_type[$selectResult[csf('emb_type')]];
									else if($selectResult[csf('emb_name')]==4) echo $emblishment_spwork_type[$selectResult[csf('emb_type')]];
								?>
								&nbsp;
							</p>
						</td>
						<td><p><? echo $color_library[$selectResult[csf('gmts_color_id')]]; ?>&nbsp;</p></td>
					</tr>
					<?
					$i++;
				}
            }
            ?>
            </table>
        </div>
		<table width="900" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        	<input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
	    <?
	}

	// 102=Services - Printing, 103=Services - Wash, 104=Services - Embroidery
	else if($item_category_id==102 || $item_category_id==103 || $item_category_id==104)
	{
		$buyer_id_cond='';
		if ($buyer_id != 0){
			$buyer_id_cond = " and a.buyer_id=$buyer_id";
		}
		if($user_buyer_id!="") $buyer_id_cond .= " and a.buyer_id in($user_buyer_id)";
		if ($data[0]!="") $wo_number=" and a.booking_no like '%".trim($data[0])."'"; else { $wo_number = ''; }
		//echo $user_buyer_id."=".$buyer_id_cond.test;die;
		if($selected_based_on==1)
		{
			if($db_type==0)
			{
				$sql = "select a.id as mst_id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, a.buyer_id, group_concat(b.id) as id, sum(b.wo_qnty) as wo_qnty
				from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_embe_cost_dtls c
				where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.pay_mode=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_ids_cond
				group by a.id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, a.buyer_id
				order by a.booking_no_prefix_num desc";
			}
			else
			{
				$sql = "select a.id as mst_id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, a.buyer_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS id , sum(b.wo_qnty) as wo_qnty
				from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_embe_cost_dtls c
				where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.pay_mode=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_ids_cond
				group by a.id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, a.buyer_id
				order by a.booking_no_prefix_num desc";
			}
			$prev_pi_qnty_arr=return_library_array("select b.work_order_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_id",'work_order_id','quantity');
		}
		else
		{
			$sql = "select a.id as mst_id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.supplier_id, a.buyer_id, b.id, b.gmts_color_id, b.gmt_item, c.emb_name, c.emb_type, b.wo_qnty as wo_qnty
			from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_embe_cost_dtls c
			where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.company_id=$company_id and a.item_category=$item_category_id and a.supplier_id like '$supplier_id' and a.pay_mode=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $buyer_id_cond $wo_number $wo_date_cond $prev_wo_ids_cond
			order by a.booking_no_prefix_num desc";
			$prev_pi_qnty_arr=return_library_array("select b.work_order_dtls_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_dtls_id",'work_order_dtls_id','quantity');
		}

		//echo $sql;die;
		$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
		$supplier_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');
		//$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');
		$order_nonOrder_type=1;
		?>
        <table cellspacing="0" cellpadding="0" border="1" rules="all" width="900" class="rpt_table">
            <thead>
                <th width="40">SL No</th>
                <th width="70">WO No</th>
                <th width="80">WO Date</th>
                <th width="100">Buyer</th>
                <th width="120">Supplier</th>                
                <th width="150">Gmts Item</th>
                <th width="90">Embell. Name</th>
                <th width="100">Embell. Type</th>
                <th>Gmts Color</th>
            </thead>
         </table>
         <div style="width:920px; max-height:250px; overflow-y:scroll">
             <table cellspacing="0" cellpadding="0" border="1" rules="all" width="900" class="rpt_table" id="tbl_list_search">
             <?
             $i=1;
             $nameArray=sql_select( $sql );
             foreach ($nameArray as $selectResult)
             {
                if ($i%2==0)
                    $bgcolor="#E9F3FF";
                else
                    $bgcolor="#FFFFFF";
                if($db_type==2 && $selected_based_on==1 ) $selectResult[csf('id')] = $selectResult[csf('id')]->load();

             	$bal_qnty=0;
				if($selected_based_on==1)
				{
					$bal_qnty=$selectResult[csf('wo_qnty')]-$prev_pi_qnty_arr[$selectResult[csf('mst_id')]];
				}
				else
				{
					$bal_qnty=$selectResult[csf('wo_qnty')]-$prev_pi_qnty_arr[$selectResult[csf('id')]];
				}
				if($bal_qnty>0)
				{
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$selectResult[csf('id')]."*".$order_nonOrder_type; ?>')">
						<td width="40"><? echo "$i"; ?></td>
						<td width="70"><p><? echo $selectResult[csf('booking_no_prefix_num')];?></p></td>
						<td width="80"><p><? echo change_date_format($selectResult[csf('booking_date')]); ?>&nbsp;</p></td>
						<td width="100"><p><? echo $buyer_arr[$selectResult[csf('buyer_id')]]; ?>&nbsp;</p></td>
						<td width="120"><p><? echo $supplier_arr[$selectResult[csf('supplier_id')]]; ?>&nbsp;</p></td>		
						<td width="150"><p><? echo $garments_item[$selectResult[csf('gmt_item')]]; ?>&nbsp;</p></td>
						<td width="90"><p><? echo $emblishment_name_array[$selectResult[csf('emb_name')]]; ?>&nbsp;</p></td>
						<td width="100">
							<p>
								<?
									if($selectResult[csf('emb_name')]==1) echo $emblishment_print_type[$selectResult[csf('emb_type')]];
									else if($selectResult[csf('emb_name')]==2) echo $emblishment_embroy_type[$selectResult[csf('emb_type')]];
									else if($selectResult[csf('emb_name')]==3) echo $emblishment_wash_type[$selectResult[csf('emb_type')]];
									else if($selectResult[csf('emb_name')]==4) echo $emblishment_spwork_type[$selectResult[csf('emb_type')]];
								?>
								&nbsp;
							</p>
						</td>
						<td><p><? echo $color_library[$selectResult[csf('gmts_color_id')]]; ?>&nbsp;</p></td>
					</tr>
					<?
					$i++;
				}
             }
             ?>
            </table>
        </div>
		<table width="900" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        	<input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
	    <?
	}

	else if($item_category_id==31 || $item_category_id==115)  // Services Lab Test Services Inspection
	{
		//if($user_buyer_id!="") $buyer_id_cond .= " and a.buyer_id in($user_buyer_id)";
		//if($user_buyer_id!="") $buyer_id_cond_samp .= " and s.buyer_id in($user_buyer_id)";
		if ($wo_year != 0){
			$wo_year_con = " and to_char(a.insert_date,'YYYY') ='$wo_year'";
		}
		$wo_number = '';
		if ($data[0]!="") 
		{
			if($item_category_id==31) $wo_number=" and a.labtest_no like '%".trim($data[0])."'"; else $wo_number=" and a.booking_no like '%".trim($data[0])."'";
		}
		
		if($db_type==0) $year_field="YEAR(a.insert_date) as year";
		else if($db_type==2) $year_field="to_char(a.insert_date,'YYYY') as year";
		else $year_field="";//defined Later
		if($selected_based_on==1)
		{
			if($item_category_id==31)
			{
				$sql = "select a.id as mst_id, a.labtest_prefix_num, a.labtest_no, a.wo_date, a.supplier_id, a.is_approved, $year_field, listagg(cast(b.id as varchar(4000)),',') within group (order by b.id) AS id , sum(b.wo_value) as wo_value, 1 as type
				from wo_labtest_mst a, wo_labtest_dtls b
				where a.id=b.mst_id and a.company_id=$company_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_year_con $wo_date_cond $prev_wo_ids_cond
				group by a.id, a.labtest_prefix_num, a.labtest_no, a.wo_date, a.supplier_id, a.is_approved, a.insert_date
				order by a.labtest_prefix_num desc";
			}
			else
			{
				$sql = "select a.id as mst_id, a.BOOKING_PREFIX_NUM as labtest_prefix_num, a.BOOKING_NO as labtest_no, a.BOOKING_DATE as wo_date, a.supplier_id, a.is_approved, $year_field, listagg(cast(b.id as varchar(4000)),',') within group (order by b.id) AS id , sum(b.AMOUNT) as wo_value, 1 as type
				from WO_INSPECTION_MST a, WO_INSPECTION_DTLS b
				where a.id=b.BOOKING_MST_ID and a.company_id=$company_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_year_con $wo_date_cond $prev_wo_ids_cond
				group by a.id, a.BOOKING_PREFIX_NUM, a.BOOKING_NO, a.BOOKING_DATE, a.supplier_id, a.is_approved, a.insert_date
				order by a.BOOKING_PREFIX_NUM desc";
			}
			

			$prev_pi_qnty_arr=return_library_array("select b.work_order_id, sum(b.amount) as amount from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_id",'work_order_id','amount');

		}
		else
		{
			if($item_category_id==31)
			{
				$sql = "select a.id as mst_id, a.labtest_prefix_num, a.labtest_no, a.wo_date, a.supplier_id, a.is_approved, $year_field, b.id, b.test_for, b.test_item_id, b.color, b.wo_value, 1 as type
				from wo_labtest_mst a, wo_labtest_dtls b
				where a.id=b.mst_id and a.company_id=$company_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $wo_year_con $prev_wo_ids_cond order by a.labtest_prefix_num desc";
			}
			else
			{
				$sql = "select a.id as mst_id, a.BOOKING_PREFIX_NUM as labtest_prefix_num, a.BOOKING_NO as labtest_no, a.BOOKING_DATE as wo_date, a.supplier_id, a.is_approved, $year_field, b.id, b.INSPECTION_FOR_ID as test_for, 0 as test_item_id, 0 as color, b.amount as wo_value, 1 as type
				from WO_INSPECTION_MST a, WO_INSPECTION_DTLS b
				where a.id=b.BOOKING_MST_ID and a.company_id=$company_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $wo_year_con $prev_wo_ids_cond order by a.BOOKING_PREFIX_NUM desc";
			}
			

			$prev_pi_qnty_arr=return_library_array("select b.work_order_dtls_id, sum(b.amount) as amount from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_dtls_id",'work_order_dtls_id','amount');
		}

		//echo $sql;//die;

		$supplier_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');
		$test_item_arr=return_library_array( "SELECT id, test_item FROM lib_lab_test_rate_chart",'id','test_item');

		?>
        <table cellspacing="0" cellpadding="0" border="1" rules="all" width="870" class="rpt_table">
            <thead>
                <th width="40">SL No</th>
                <th width="70">WO No</th>
                <th width="60">Year</th>
                <th width="80">WO Date</th>
                <th width="170">Supplier</th>
                <th width="120">Test For</th>
                <th width="200">Test Item</th>
                <th>Color</th>
            </thead>
         </table>
         <div style="width:890px; max-height:250px; overflow-y:scroll">
             <table cellspacing="0" cellpadding="0" border="1" rules="all" width="870" class="rpt_table" id="tbl_list_search">
             <?
             $i=1;
             $nameArray=sql_select( $sql );
             foreach ($nameArray as $selectResult)
             {
                if ($i%2==0) $bgcolor="#E9F3FF";                    
                else  $bgcolor="#FFFFFF";
                   
               // if($db_type==2 && $selected_based_on==1 ) $row[csf('id')] = $row[csf('id')]->load();

				$test_item='';
				$test_item_ids=array_unique(explode(",",$selectResult[csf('test_item_id')]));
				foreach($test_item_ids as $test_item_id)
				{
					$test_item.=$test_item_arr[$test_item_id].",";
				}
				$test_item=chop($test_item,',');
				$bl_amt=0;
				if($selected_based_on==1)
				{
					$bl_amt=$selectResult[csf("wo_value")]-$prev_pi_qnty_arr[$selectResult[csf("mst_id")]];
				}
				else
				{
					$bl_amt=$selectResult[csf("wo_value")]-$prev_pi_qnty_arr[$selectResult[csf("id")]];
				}
				$approval_need=$trims_approval_need_arr[33];
				if($selectResult[csf('is_approved')]!=1 && $approval_need ==1) $bgcolor="#ffa38f";

				if($bl_amt>0)
				{
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$selectResult[csf('id')]."*".$selectResult[csf('type')]."_".$selectResult[csf('is_approved')]."_".$approval_need; ?>')">
						<td width="40"><? echo "$i"; ?></td>
						<td width="70"><p><? echo $selectResult[csf('labtest_prefix_num')];?></p></td>
						<td width="60" align="center"><p><? echo $selectResult[csf('year')];?></p></td>
						<td width="80" align="center"><p><? echo change_date_format($selectResult[csf('wo_date')]); ?>&nbsp;</p></td>
						<td width="170"><p><? echo $supplier_arr[$selectResult[csf('supplier_id')]]; ?>&nbsp;</p></td>
						<td width="120"><p><? echo $test_for[$selectResult[csf('test_for')]]; ?>&nbsp;</p></td>
						<td width="200"><p><? echo $test_item; ?>&nbsp;</p></td>
						<td><p><? echo $color_library[$selectResult[csf('color')]]; ?>&nbsp;</p></td>
					</tr>
					<?
					$i++;
				}
             }
             ?>
            </table>
        </div>
		<table width="870" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
	    <?
	}
	
	else if($item_category_id==116)  // Services Garments
	{
		if ($wo_year != 0){
			$wo_year_con = " and to_char(a.insert_date,'YYYY') ='$wo_year'";
		}
		$wo_number = '';
		if ($data[0]!="") 
		{
			$wo_number=" and a.SYS_NUMBER like '%".trim($data[0])."'";
		}

		
		if($db_type==0) $year_field="YEAR(a.insert_date) as year";
		else if($db_type==2) $year_field="to_char(a.insert_date,'YYYY') as year";
		else $year_field="";//defined Later
		if($selected_based_on==1)
		{
			$sql = "select a.id as mst_id, a.SYS_NUMBER_PREFIX_NUM as labtest_prefix_num, a.SYS_NUMBER as labtest_no, a.wo_date, a.WORKING_COMPANY_ID as supplier_id, $year_field, listagg(cast(b.id as varchar(4000)),',') within group (order by b.id) AS id , sum(b.AMOUNT) as wo_value, 1 as type
			from GARMENTS_SERVICE_WO_MST a, GARMENTS_SERVICE_WO_DTLS b
			where a.id=b.mst_id and a.company_id=$company_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_year_con $wo_date_cond $prev_wo_ids_cond
			group by a.id, a.SYS_NUMBER_PREFIX_NUM, a.SYS_NUMBER, a.wo_date, a.WORKING_COMPANY_ID, a.insert_date
			order by a.SYS_NUMBER_PREFIX_NUM desc";
			

			$prev_pi_qnty_arr=return_library_array("select b.work_order_id, sum(b.amount) as amount from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_id",'work_order_id','amount');

		}
		else
		{
			$sql = "select a.id as mst_id, a.SYS_NUMBER_PREFIX_NUM as labtest_prefix_num, a.SYS_NUMBER as labtest_no, a.wo_date, a.WORKING_COMPANY_ID as supplier_id, $year_field, b.id, b.item_id, b.rate_for, b.AMOUNT as wo_value, 1 as type
			from GARMENTS_SERVICE_WO_MST a, GARMENTS_SERVICE_WO_DTLS b
			where a.id=b.mst_id and a.company_id=$company_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $wo_year_con $prev_wo_ids_cond order by a.SYS_NUMBER_PREFIX_NUM desc";
			

			$prev_pi_qnty_arr=return_library_array("select b.work_order_dtls_id, sum(b.amount) as amount from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_dtls_id",'work_order_dtls_id','amount');
		}


		//echo $sql;die;

		$comp_arr=return_library_array( "select id, company_name from lib_company",'id','company_name');
		$test_item_arr=return_library_array( "SELECT id,test_item FROM lib_lab_test_rate_chart",'id','test_item');

		?>
        <table cellspacing="0" cellpadding="0" border="1" rules="all" width="870" class="rpt_table">
            <thead>
                <th width="40">SL No</th>
                <th width="70">WO No</th>
                <th width="60">Year</th>
                <th width="80">WO Date</th>
                <th width="170">Working Company</th>
                <th width="200">Item Name</th>
                <th >Process</th>
            </thead>
         </table>
         <div style="width:890px; max-height:250px; overflow-y:scroll">
             <table cellspacing="0" cellpadding="0" border="1" rules="all" width="870" class="rpt_table" id="tbl_list_search">
             <?
             $i=1;
             $nameArray=sql_select( $sql );
             foreach ($nameArray as $selectResult)
             {
                if ($i%2==0)
                    $bgcolor="#E9F3FF";
                else
                    $bgcolor="#FFFFFF";

				$test_item='';
				$test_item_ids=array_unique(explode(",",$selectResult[csf('rate_for')]));
				foreach($test_item_ids as $test_item_id)
				{
					$test_item.=$rate_for[$test_item_id].",";
				}
				$test_item=chop($test_item,',');
				$bl_amt=0;
				if($selected_based_on==1)
				{
					$bl_amt=$selectResult[csf("wo_value")]-$prev_pi_qnty_arr[$selectResult[csf("mst_id")]];
				}
				else
				{
					$bl_amt=$selectResult[csf("wo_value")]-$prev_pi_qnty_arr[$selectResult[csf("id")]];
				}
				if($bl_amt>0)
				{
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$selectResult[csf('id')]."*".$selectResult[csf('type')]; ?>')">
						<td width="40"><? echo "$i"; ?></td>
						<td width="70"><p><? echo $selectResult[csf('labtest_prefix_num')];?></p></td>
						<td width="60" align="center"><p><? echo $selectResult[csf('year')];?></p></td>
						<td width="80" align="center"><p><? echo change_date_format($selectResult[csf('wo_date')]); ?>&nbsp;</p></td>
						<td width="170"><p><? echo $comp_arr[$selectResult[csf('supplier_id')]]; ?>&nbsp;</p></td>
						<td width="200"><p><? echo $garments_item[$selectResult[csf('item_id')]]; ?>&nbsp;</p></td>
						<td><p><? echo $test_item; ?>&nbsp;</p></td>
					</tr>
					 <?
					 $i++;
				}
             }
             ?>
            </table>
        </div>
		<table width="870" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
	    <?
	}
	
	else if($item_category_id==100)  // Sweater Services Garments
	{
		if ($wo_year != 0){
			$wo_year_con = " and to_char(a.insert_date,'YYYY') ='$wo_year'";
		}
		$wo_number = '';
		if ($data[0]!="") 
		{
			$wo_number=" and a.SUCON_WO_NO like '%".trim($data[0])."'";
		}
		
		if($db_type==0) $year_field="YEAR(a.insert_date) as year";
		else if($db_type==2) $year_field="to_char(a.insert_date,'YYYY') as year";
		else $year_field="";//defined Later
		if($selected_based_on==1)
		{
			$sql = "select a.id as mst_id, a.SUBCON_WO_SUFFIX_NUM as labtest_prefix_num, a.SUCON_WO_NO as labtest_no, a.BOOKING_DATE as wo_date, a.supplier_id, $year_field, listagg(cast(b.id as varchar(4000)),',') within group (order by b.id) AS id , sum(b.AMOUNT) as wo_value, 1 as type
			from SUBCON_WO_MST a, SUBCON_WO_DTLS b
			where a.id=b.mst_id and a.ENTRY_FORM=643 and a.company_id=$company_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_year_con $wo_date_cond $prev_wo_ids_cond
			group by a.id, a.SUBCON_WO_SUFFIX_NUM, a.SUCON_WO_NO, a.BOOKING_DATE, a.supplier_id, a.insert_date
			order by a.SUCON_WO_NO desc";
			

			$prev_pi_qnty_arr=return_library_array("select b.work_order_id, sum(b.amount) as amount from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_id",'work_order_id','amount');

		}
		else
		{
			$sql = "select a.id as mst_id, a.SUBCON_WO_SUFFIX_NUM as labtest_prefix_num, a.SUCON_WO_NO as labtest_no, a.BOOKING_DATE as wo_date, a.supplier_id, $year_field, b.id, b.GMTS_NO as item_id, b.DYEING_CHARGE as rate_for, b.AMOUNT as wo_value, 1 as type
			from SUBCON_WO_MST a, SUBCON_WO_DTLS b
			where a.id=b.mst_id and a.ENTRY_FORM=643 and a.company_id=$company_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_year_con $wo_date_cond $prev_wo_ids_cond 
			order by a.SUCON_WO_NO desc";
			

			$prev_pi_qnty_arr=return_library_array("select b.work_order_dtls_id, sum(b.amount) as amount from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_dtls_id",'work_order_dtls_id','amount');
		}


		//echo $sql;//die;

		$comp_arr=return_library_array( "select id, company_name from lib_company",'id','company_name');
		$test_item_arr=return_library_array( "SELECT id,test_item FROM lib_lab_test_rate_chart",'id','test_item');

		?>
        <table cellspacing="0" cellpadding="0" border="1" rules="all" width="870" class="rpt_table">
            <thead>
                <th width="40">SL No</th>
                <th width="70">WO No</th>
                <th width="60">Year</th>
                <th width="80">WO Date</th>
                <th width="170">Working Company</th>
                <th width="200">Item Name</th>
                <th >Process</th>
            </thead>
         </table>
         <div style="width:890px; max-height:250px; overflow-y:scroll">
             <table cellspacing="0" cellpadding="0" border="1" rules="all" width="870" class="rpt_table" id="tbl_list_search">
             <?
             $i=1;
             $nameArray=sql_select( $sql );
             foreach ($nameArray as $selectResult)
             {
                if ($i%2==0)
                    $bgcolor="#E9F3FF";
                else
                    $bgcolor="#FFFFFF";

				$test_item='';
				$test_item_ids=array_unique(explode(",",$selectResult[csf('rate_for')]));
				foreach($test_item_ids as $test_item_id)
				{
					$test_item.=$rate_for[$test_item_id].",";
				}
				$test_item=chop($test_item,',');
				$bl_amt=0;
				if($selected_based_on==1)
				{
					$bl_amt=$selectResult[csf("wo_value")]-$prev_pi_qnty_arr[$selectResult[csf("mst_id")]];
				}
				else
				{
					$bl_amt=$selectResult[csf("wo_value")]-$prev_pi_qnty_arr[$selectResult[csf("id")]];
				}
				if($bl_amt>0)
				{
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$selectResult[csf('id')]."*".$selectResult[csf('type')]; ?>')">
						<td width="40"><? echo "$i"; ?></td>
						<td width="70"><p><? echo $selectResult[csf('labtest_prefix_num')];?></p></td>
						<td width="60" align="center"><p><? echo $selectResult[csf('year')];?></p></td>
						<td width="80" align="center"><p><? echo change_date_format($selectResult[csf('wo_date')]); ?>&nbsp;</p></td>
						<td width="170"><p><? echo $comp_arr[$selectResult[csf('supplier_id')]]; ?>&nbsp;</p></td>
						<td width="200"><p><? echo $garments_item[$selectResult[csf('item_id')]]; ?>&nbsp;</p></td>
						<td><p><? echo $test_item; ?>&nbsp;</p></td>
					</tr>
					 <?
					 $i++;
				}
             }
             ?>
            </table>
        </div>
		<table width="870" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
	    <?
	}
	
	else if($item_category_id==114)  // Services
	{
		$other_purchase_order_array=array(114);
		if ($data[0]!="") $wo_number=" and a.wo_number like '%".trim($data[0])."'"; else { $wo_number = ''; }

		 
		if ($wo_year != 0){
			$wo_year_con = " and to_char(a.insert_date,'YYYY') ='$wo_year'";
			$wo_year_con_sample = " and to_char(s.insert_date,'YYYY') ='$wo_year'";
		}
		
		if($selected_based_on==1)
		{
			$sql="select a.id as mst_id, a.is_approved, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.item_category, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id , sum(b.supplier_order_quantity) as wo_qnty
			from wo_non_order_info_mst a, wo_non_order_info_dtls b
			where a.id=b.mst_id and a.company_name=$company_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ENTRY_FORM=484 $wo_number $wo_date_cond $prev_wo_ids_cond $pay_mode_cond $wo_year_con
			group by a.id,a.is_approved, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.item_category, a.supplier_id 
			order by a.wo_number_prefix_num desc";
			

			$prev_pi_qnty_arr=return_library_array("select b.work_order_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_id",'work_order_id','quantity');
		}
		else
		{
			if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
			$sql="select a.id as mst_id, a.is_approved, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.item_category, a.supplier_id, b.id as dtls_id, b.item_id, b.uom, b.supplier_order_quantity, 0 as item_group_id, null as item_description, null as item_size, b.supplier_order_quantity as wo_qnty
			from wo_non_order_info_mst a, wo_non_order_info_dtls b
			where a.id=b.mst_id and b.item_id=c.id and a.company_name=$company_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ENTRY_FORM=484 $wo_number $wo_date_cond $prev_wo_ids_cond $pay_mode_cond $wo_year_con 
			order by a.wo_number_prefix_num desc";

			$prev_pi_qnty_arr=return_library_array("select b.work_order_dtls_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_dtls_id",'work_order_dtls_id','quantity');
		}

		//echo $sql;
		$data_array=sql_select($sql);

		$result = sql_select($sql);
		$supplier_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');
		//$item_group_arr=return_library_array( "select id,item_name FROM lib_item_group",'id','item_name');

		$order_nonOrder_type='';
		if($item_category_id==11) {
			$order_nonOrder_type=1;
		}
		?>
        <table cellspacing="0" cellpadding="0" border="1" rules="all" width="880" class="rpt_table">
            <thead>
                <th width="40">SL No</th>
                <th width="70">WO Number</th>
                <th width="80">WO Date</th>
                <th width="140">Supplier</th>
                <th width="90">Item Category</th>
                <th width="120">Item Group</th>
                <th width="160">Item Description</th>
                <th width="80">Item Size</th>
                <th>uom</th>
            </thead>
         </table>
         <div style="width:880px; max-height:250px; overflow-y:scroll">
             <table cellspacing="0" cellpadding="0" border="1" rules="all" width="860" class="rpt_table" id="tbl_list_search">
             <?
             $i=1;

			foreach ($data_array as $row)
			{
				if($db_type==2 && $selected_based_on==1) $row[csf('dtls_id')] = $row[csf('dtls_id')]->load(); 
				//echo $row[csf('dtls_id')].'==';
				if($selected_based_on==1)
				{
					$bal_qnty=$row[csf('wo_qnty')]-$prev_pi_qnty_arr[$row[csf('mst_id')]];
				}
				else
				{
					$bal_qnty=$row[csf('wo_qnty')]-$prev_pi_qnty_arr[$row[csf('dtls_id')]];
				}
				
				if($bal_qnty>0)
				{
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";

					if($app_needed==1)
					{
						if($partial_allow==1)
						{
							if($row[csf('is_approved')]!=1 && $row[csf('is_approved')]!=3) $bgcolor="#ffa38f";
						}
						else
						{
							if($row[csf('is_approved')]!=1) $bgcolor="#ffa38f";
						}

					}
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$row[csf('dtls_id')]."*".$order_nonOrder_type."_".$app_needed."_".$row[csf('is_approved')]."_".$partial_allow; ?>')">
                        <td width="40"><? echo "$i"; ?></td>
                        <td width="70"><p><? echo $row[csf('wo_number_prefix_num')];?></p></td>
                        <td width="80"><p><? echo change_date_format($row[csf('wo_date')]);?></p></td>
                        <td width="140"><p><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></p></td>
                        <td width="90" align="center"><p><? echo $item_category[$row[csf('item_category')]]; ?>&nbsp;</p></td>
                        <td width="120"><p><? echo $item_group_arr[$row[csf('item_group_id')]]; ?>&nbsp;</p></td>
                        <td width="160"><p><? echo $row[csf('item_description')]; ?></p></td>
                        <td width="80"><p><? echo $row[csf('item_size')]; ?></p></td>
                        <td align="center"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?></p></td>
					</tr>
					<?
					$i++;
				}
			}
			?>
		</table>
        </div>
		<table width="880" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
        <?
	}
	else
	{
		$other_purchase_order_array=array(8,9,10,15,16,17,18,19,20,21,22,32,34,36,35,37,38,39,23,33,40,41,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,69,70,89,90,91,92,93,94);
		if ($data[0]!="") $wo_number=" and a.wo_number like '%".trim($data[0])."'"; else { $wo_number = ''; }
		if($item_category_id==11) $wo_item_category_id="4,11";else $wo_item_category_id = $item_category_id;

		$entry_form_cond = ($item_category_id==11) ? "" : " and e.entry_form = 20";

		  $page_id_cond="";
		// for approval nececity check
		if($item_category_id==11)
		{
			$page_id_cond=" and page_id=16";
			if($db_type==0)
			{
				$approval_status_sql="select approval_need,allow_partial from approval_setup_dtls where mst_id=(select id from approval_setup_mst where company_id='$company_id' and setup_date=(select max(setup_date) from approval_setup_mst where  company_id='$company_id')) and page_id=16 and status_active=1 and is_deleted=0";
			}
			else
			{
				$approval_status_sql="select approval_need,allow_partial from approval_setup_dtls where mst_id=(select id from approval_setup_mst where company_id='$company_id' and setup_date=(select max(setup_date) from approval_setup_mst where  company_id='$company_id')) and page_id=16 and status_active=1 and is_deleted=0";
			}
		}
		else if($item_category_id==5 || $item_category_id==6 || $item_category_id==7 || $item_category_id==23)
		{
			$page_id_cond=" and page_id=21";
			if($db_type==0)
			{
				$approval_status_sql="select approval_need,allow_partial from approval_setup_dtls where mst_id=(select id from approval_setup_mst where company_id='$company_id' and setup_date=(select max(setup_date) from approval_setup_mst where  company_id='$company_id')) and page_id=21 and status_active=1 and is_deleted=0";
			}
			else
			{
				$approval_status_sql="select approval_need,allow_partial from approval_setup_dtls where mst_id=(select id from approval_setup_mst where company_id='$company_id' and setup_date=(select max(setup_date) from approval_setup_mst where  company_id='$company_id')) and page_id=21 and status_active=1 and is_deleted=0";
			}
		}
		else if (in_array($item_category_id, $other_purchase_order_array))
		{
			$page_id_cond=" and page_id=22";
			if($db_type==0)
			{
				$approval_status_sql="select approval_need,allow_partial from approval_setup_dtls where mst_id=(select id from approval_setup_mst where company_id='$company_id' and setup_date=(select max(setup_date) from approval_setup_mst where  company_id='$company_id')) and page_id=22 and status_active=1 and is_deleted=0";
			}
			else
			{
				$approval_status_sql="select approval_need,allow_partial from approval_setup_dtls where mst_id=(select id from approval_setup_mst where company_id='$company_id' and setup_date=(select max(setup_date) from approval_setup_mst where  company_id='$company_id')) and page_id=22 and status_active=1 and is_deleted=0";
			}



		}
		if ($wo_year != 0){
			$wo_year_con = " and to_char(a.insert_date,'YYYY') ='$wo_year'";
			$wo_year_con_sample = " and to_char(s.insert_date,'YYYY') ='$wo_year'";
		}
		$item_cat_cond="";
		if($item_category_id==5 || $item_category_id==6 || $item_category_id==7 || $item_category_id==23)
		{
			$item_cat_cond=" and b.item_category_id in($item_category_id)";
			$item_cat_cond2=" and e.item_category_id in($item_category_id)";
			$item_cat_cond3=" and c.item_category_id in($item_category_id)";
			$item_cat_cond4=" and a.item_category_id in($item_category_id)";
			
		}
		else
		{
			$item_cat_cond=" and ( b.item_category_id in(select category_id from lib_item_category_list where category_type=1) or b.item_category_id in(101))";
			$item_cat_cond2=" and ( e.item_category_id in(select category_id from lib_item_category_list where category_type=1) or e.item_category_id in(101))";
			$item_cat_cond3=" and ( c.item_category_id in(select category_id from lib_item_category_list where category_type=1) or c.item_category_id in(101))";
			$item_cat_cond4=" and ( a.item_category_id in(select category_id from lib_item_category_list where category_type=1) or a.item_category_id in(101))";
		}
		
		//echo $approval_status;die;
		$app_needed_arr=sql_select($approval_status_sql);
		$app_needed=$app_needed_arr[0][csf('approval_need')];
		$partial_allow=$app_needed_arr[0][csf('allow_partial')];
		if($selected_based_on==1)
		{
			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				if($db_type==0)
				{
					$sql="select a.id as mst_id,a.is_approved, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.item_category, a.supplier_id, group_concat(d.id) as dtls_id, sum(d.cons_quantity) as supplier_order_quantity
					from wo_non_order_info_mst a, wo_non_order_info_dtls b, inv_receive_master c, inv_transaction d, product_details_master e
					where a.id=b.mst_id and b.mst_id=c.booking_id and c.id=d.mst_id and d.prod_id=e.id and d.prod_id=b.item_id and c.entry_form=20 $entry_form_cond and a.company_name=$company_id and a.supplier_id like '$supplier_id' $item_cat_cond and a.pay_mode=1 and d.pi_is_lock!=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.transaction_type=1 $wo_number $wo_date_cond $prev_wo_ids_cond3 $item_cat_cond $item_cat_cond2
					group by a.id,a.is_approved, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.item_category, a.supplier_id";
				}
				else
				{
					$sql="select a.id as mst_id,a.is_approved, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.item_category, a.supplier_id, rtrim(xmlagg(xmlelement(e,d.id,',').extract('//text()') order by d.id).GetClobVal(),',') AS dtls_id, sum(d.cons_quantity) as supplier_order_quantity
					from wo_non_order_info_mst a, wo_non_order_info_dtls b, inv_receive_master c, inv_transaction d, product_details_master e
					where a.id=b.mst_id and b.mst_id=c.booking_id and c.id=d.mst_id and d.prod_id=e.id and d.prod_id=b.item_id and c.entry_form=20 $entry_form_cond and a.company_name=$company_id and a.supplier_id like '$supplier_id' and a.pay_mode=1 and d.pi_is_lock!=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.transaction_type=1 and e.item_category_id in($wo_item_category_id) $wo_number $wo_date_cond $prev_wo_ids_cond3 $wo_year_con $item_cat_cond $item_cat_cond2
					group by a.id,a.is_approved, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.item_category, a.supplier_id order by a.wo_number_prefix_num desc";
				}
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
				if($db_type==0)
				{
					$sql="select a.id as mst_id,a.is_approved, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.item_category, a.supplier_id, group_concat(b.id) as dtls_id, sum(b.supplier_order_quantity) as wo_qnty
					from wo_non_order_info_mst a, wo_non_order_info_dtls b, product_details_master c
					where a.id=b.mst_id and b.item_id=c.id and a.company_name=$company_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $prev_wo_ids_cond $pay_mode_cond $item_cat_cond $item_cat_cond3
					group by a.id,a.is_approved, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.item_category, a.supplier_id";
				}
				else
				{
					$sql="select a.id as mst_id,a.is_approved, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.item_category, a.supplier_id, rtrim(xmlagg(xmlelement(e,b.id,',').extract('//text()') order by b.id).GetClobVal(),',') AS dtls_id , sum(b.supplier_order_quantity) as wo_qnty
					from wo_non_order_info_mst a, wo_non_order_info_dtls b, product_details_master c
					where a.id=b.mst_id and b.item_id=c.id and a.company_name=$company_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $prev_wo_ids_cond $pay_mode_cond $wo_year_con $item_cat_cond $item_cat_cond3
					group by a.id,a.is_approved, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.item_category, a.supplier_id order by a.wo_number_prefix_num desc";
				}
				
				
				$wo_qnty_array=return_library_array("select a.id as mst_id, sum(b.supplier_order_quantity) as wo_qnty from wo_non_order_info_mst a, wo_non_order_info_dtls b where a.id=b.mst_id and a.company_name=$company_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $wo_number $wo_date_cond $pay_mode_cond $item_cat_cond group by a.id",'mst_id','wo_qnty');
				//echo "<pre>";print_r($wo_qnty_array);die;

				// $prev_pi_qnty_arr=return_library_array("select b.work_order_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $item_cat_cond4 group by b.work_order_id",'work_order_id','quantity');


				$prev_pi_qnty_arr=return_library_array("select b.work_order_dtls_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id $item_cat_cond4 and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_dtls_id",'work_order_dtls_id','quantity');

			}
		}
		else
		{
			if($goods_rcv_status==1 && $goods_rcv_variable!=1)
			{
				$sql="select a.id as mst_id,a.is_approved, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.item_category, a.supplier_id, d.id as dtls_id, b.item_id, b.uom, d.cons_quantity as supplier_order_quantity, e.item_group_id, e.item_description, e.item_size
				from wo_non_order_info_mst a, wo_non_order_info_dtls b, inv_receive_master c, inv_transaction d, product_details_master e
				where a.id=b.mst_id and b.mst_id=c.booking_id and c.id=d.mst_id and d.prod_id=e.id and d.prod_id=b.item_id and c.entry_form=20 $entry_form_cond and a.company_name=$company_id and a.supplier_id like '$supplier_id' and a.pay_mode=1 and d.pi_is_lock!=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.transaction_type=1  $item_cat_cond $item_cat_cond2 $wo_number $wo_date_cond $prev_wo_ids_cond3 $wo_year_con order by a.wo_number_prefix_num desc";
			}
			else
			{
				if($goods_rcv_status==1 && $goods_rcv_variable==1) $pay_mode_cond=" and a.pay_mode<>2"; else $pay_mode_cond=" and a.pay_mode=2";
				$sql="select a.id as mst_id,a.is_approved, a.wo_number_prefix_num, a.wo_number, a.wo_date, a.item_category, a.supplier_id, b.id as dtls_id, b.item_id, b.uom, b.supplier_order_quantity, c.item_group_id, c.item_description, c.item_size, b.supplier_order_quantity as wo_qnty
				from wo_non_order_info_mst a, wo_non_order_info_dtls b, product_details_master c
				where a.id=b.mst_id and b.item_id=c.id and a.company_name=$company_id and a.supplier_id like '$supplier_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $item_cat_cond $item_cat_cond3 $wo_number $wo_date_cond $prev_wo_ids_cond $pay_mode_cond $wo_year_con order by a.wo_number_prefix_num desc";

				$prev_pi_qnty_arr=return_library_array("select b.work_order_dtls_id, sum(b.quantity) as quantity from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id $item_cat_cond4 and a.after_goods_source=1 and b.after_goods_source=1 and b.work_order_dtls_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.work_order_dtls_id",'work_order_dtls_id','quantity');

			}
		}

		//echo $sql;
		$data_array=sql_select($sql);

		$result = sql_select($sql);
		$supplier_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');
		$item_group_arr=return_library_array( "select id,item_name FROM lib_item_group",'id','item_name');

		$order_nonOrder_type='';
		if($item_category_id==11) {
			$order_nonOrder_type=1;
		}
		?>
        <table cellspacing="0" cellpadding="0" border="1" rules="all" width="880" class="rpt_table">
            <thead>
                <th width="40">SL No</th>
                <th width="70">WO Number</th>
                <th width="80">WO Date</th>
                <th width="140">Supplier</th>
                <th width="90">Item Category</th>
                <th width="120">Item Group</th>
                <th width="160">Item Description</th>
                <th width="80">Item Size</th>
                <th>uom</th>
            </thead>
         </table>
         <div style="width:880px; max-height:250px; overflow-y:scroll">
             <table cellspacing="0" cellpadding="0" border="1" rules="all" width="860" class="rpt_table" id="tbl_list_search">
             <?
             $i=1;

			foreach ($data_array as $row)
			{
				if($db_type==2 && $selected_based_on==1) $row[csf('dtls_id')] = $row[csf('dtls_id')]->load(); 
				//echo $row[csf('dtls_id')].'==';
				if($goods_rcv_status==1 && $goods_rcv_variable!=1)
				{
					$bal_qnty=1;

				}
				else
				{
					if($selected_based_on==1)
					{
						//$bal_qnty=$wo_qnty_array[$row[csf('mst_id')]]-$prev_pi_qnty_arr[$row[csf('mst_id')]];
						$bal_qnty=$wo_qnty_array[$row[csf('mst_id')]]-$prev_pi_qnty_arr[$row[csf('dtls_id')]];
					}
					else
					{
						$bal_qnty=$row[csf('wo_qnty')]-$prev_pi_qnty_arr[$row[csf('dtls_id')]];
					}
				}
				if($bal_qnty>0)
				{
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";

					if($app_needed==1)
					{
						if($partial_allow==1)
						{
							if($row[csf('is_approved')]!=1 && $row[csf('is_approved')]!=3) $bgcolor="#ffa38f";
						}
						else
						{
							if($row[csf('is_approved')]!=1) $bgcolor="#ffa38f";
						}

					}
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="tr_<? echo $i;?>" onClick="js_set_value('<? echo $i."_".$row[csf('dtls_id')]."*".$order_nonOrder_type."_".$app_needed."_".$row[csf('is_approved')]."_".$partial_allow; ?>')">
                        <td width="40"><? echo "$i"; ?></td>
                        <td width="70"><p><? echo $row[csf('wo_number_prefix_num')];?></p></td>
                        <td width="80"><p><? echo change_date_format($row[csf('wo_date')]);?></p></td>
                        <td width="140"><p><? echo $supplier_arr[$row[csf('supplier_id')]]; ?></p></td>
                        <td width="90" align="center"><p><? echo $item_category[$row[csf('item_category')]]; ?>&nbsp;</p></td>
                        <td width="120"><p><? echo $item_group_arr[$row[csf('item_group_id')]]; ?>&nbsp;</p></td>
                        <td width="160"><p><? echo $row[csf('item_description')]; ?></p></td>
                        <td width="80"><p><? echo $row[csf('item_size')]; ?></p></td>
                        <td align="center"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?></p></td>
					</tr>
					<?
					$i++;
				}
			}
			?>
		</table>
        </div>
		<table width="880" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
        <?
	}

	exit();
}

if( $action == 'populate_data_wo_form' )
{
	$data=explode('**',$data);
	//print_r($data);die;
	$wo_dtls_id=$data[0];
	$item_category_id=$data[1];
	$tblRow=$data[2];
	$order_type=str_replace(",","",$data[3]);
	$goods_rcv_status=$data[4];
	$importer_id=$data[5];
	$cbo_pi_basis_id=$data[6];

	//echo $order_type;die;

	$goods_rcv_variable=return_field_value("export_invoice_qty_source as source","variable_settings_commercial","company_name=$importer_id and variable_list=23 and status_active=1","source");
	//echo $goods_rcv_status.'**'.$goods_rcv_variable;

	$prev_pi_amnt_arr=array(); $prev_pi_qty_arr=array();

	if($item_category_id==31) // Services Lab Test
	{
		$prev_pi_amnt_arr=return_library_array( "select b.work_order_dtls_id,sum(b.amount) as amnt from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "amnt");
	}
	else if($item_category_id==2 || $item_category_id==13)  // knit finish fabric
	{
		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{
			$booking_id_cond=""; $result=explode(",",$wo_dtls_id);
			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" b.work_order_dtls_id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
				//echo $booking_id_cond;die;
			}
			else
			{
				$booking_id_cond=" and b.work_order_dtls_id in($wo_dtls_id)";
			}

			$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.after_goods_source=2 and b.after_goods_source=2 and b.status_active=1 and b.is_deleted=0 $booking_id_cond group by b.work_order_dtls_id", "work_order_dtls_id", "qty");// and b.work_order_dtls_id in($wo_dtls_id)
		}
		else
		{
			if($order_type==1)
			{
				$booking_id_cond=""; $result=explode(",",$wo_dtls_id);
				if($db_type==2 && count($result)>999)
				{
					$booking_id_chunk_arr=array_chunk($result,999) ;
					foreach($booking_id_chunk_arr as $chunk_arr)
					{
						$chunk_arr_value=implode(",",$chunk_arr);
						$bokIds_cond.=" id in($chunk_arr_value) or ";
					}

					$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
					//echo $booking_id_cond;die;
				}
				else
				{
					$booking_id_cond=" and id in($wo_dtls_id)";
				}

				$wo_nos='';
				$woNosData=sql_select("select distinct booking_no from wo_booking_dtls where status_active=1 and is_deleted=0 $booking_id_cond");
				foreach ($woNosData as $rowB)
				{
					$wo_nos.="'".$rowB[csf('booking_no')]."',";
				}
				$wo_nos=chop($wo_nos,',');


				$prev_pi_qty_arr=array();
				$sql_prev="select b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_no in($wo_nos) group by b.work_order_no, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.gsm, b.dia_width, b.uom";// and b.work_order_dtls_id in($wo_dtls_id)
				$prevData=sql_select($sql_prev);
				foreach($prevData as $rowP)
				{
					$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('gsm')]][$rowP[csf('dia_width')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
				}
			}
			else
			{
				$booking_id_cond=""; $result=explode(",",$wo_dtls_id);
				if($db_type==2 && count($result)>999)
				{
					$booking_id_chunk_arr=array_chunk($result,999) ;
					foreach($booking_id_chunk_arr as $chunk_arr)
					{
						$chunk_arr_value=implode(",",$chunk_arr);
						$bokIds_cond.=" b.work_order_dtls_id in($chunk_arr_value) or ";
					}

					$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
					//echo $booking_id_cond;die;
				}
				else
				{
					$booking_id_cond=" and b.work_order_dtls_id in($wo_dtls_id)";
				}

				$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and b.is_deleted=0 $booking_id_cond group by b.work_order_dtls_id", "work_order_dtls_id", "qty");// and b.work_order_dtls_id in($wo_dtls_id)
			}
		}
	}
	else if($item_category_id==3)  // woven fabrics
	{
		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{
			$booking_id_cond=""; $result=explode(",",$wo_dtls_id);
			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" b.work_order_dtls_id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
				//echo $booking_id_cond;die;
			}
			else
			{
				$booking_id_cond=" and b.work_order_dtls_id in($wo_dtls_id)";
			}

			$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.after_goods_source=2 and b.after_goods_source=2 and b.status_active=1 and b.is_deleted=0 $booking_id_cond group by b.work_order_dtls_id", "work_order_dtls_id", "qty");// and b.work_order_dtls_id in($wo_dtls_id)
		}
		else
		{
			if($order_type==1)
			{
				$booking_id_cond=""; $result=explode(",",$wo_dtls_id);
				if($db_type==2 && count($result)>999)
				{
					$booking_id_chunk_arr=array_chunk($result,999) ;
					foreach($booking_id_chunk_arr as $chunk_arr)
					{
						$chunk_arr_value=implode(",",$chunk_arr);
						$bokIds_cond.=" id in($chunk_arr_value) or ";
					}

					$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
					//echo $booking_id_cond;die;
				}
				else
				{
					$booking_id_cond=" and id in($wo_dtls_id)";
				}

				$wo_nos='';
				$woNosData=sql_select("select distinct booking_no from wo_booking_dtls where status_active=1 and is_deleted=0 $booking_id_cond");
				foreach ($woNosData as $rowB)
				{
					$wo_nos.="'".$rowB[csf('booking_no')]."',";
				}
				$wo_nos=chop($wo_nos,',');				

				$prev_pi_qty_arr=array();
				$sql_prev="SELECT b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.fab_weight_type, b.width_dia_type, b.dia_width, b.cutable_width, b.uom, sum(b.quantity) as qty 
				from com_pi_master_details a, com_pi_item_details b 
				where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and b.work_order_no in($wo_nos) 
				group by b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.fab_weight_type, b.width_dia_type, b.dia_width, b.cutable_width, b.uom";// and b.work_order_dtls_id in($wo_dtls_id)
				$prevData=sql_select($sql_prev);
				foreach($prevData as $rowP)
				{
					$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('body_part_id')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('fab_weight')]][$rowP[csf('fab_weight_type')]][$rowP[csf('width_dia_type')]][$rowP[csf('dia_width')]][$rowP[csf('cutable_width')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
				}
			}
			else
			{
				$booking_id_cond=""; $result=explode(",",$wo_dtls_id);
				if($db_type==2 && count($result)>999)
				{
					$booking_id_chunk_arr=array_chunk($result,999) ;
					foreach($booking_id_chunk_arr as $chunk_arr)
					{
						$chunk_arr_value=implode(",",$chunk_arr);
						$bokIds_cond.=" b.work_order_dtls_id in($chunk_arr_value) or ";
					}

					$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
					//echo $booking_id_cond;die;
				}
				else
				{
					$booking_id_cond=" and b.work_order_dtls_id in($wo_dtls_id)";
				}

				$prev_pi_qty_arr=array();
				$sql_prev="SELECT b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.width_dia_type, b.cutable_width, b.uom, sum(b.quantity) as qty 
				from com_pi_master_details a, com_pi_item_details b 
				where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and b.is_deleted=0 $booking_id_cond 
				group by b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.fab_weight, b.width_dia_type, b.cutable_width, b.uom";// and b.work_order_dtls_id in($wo_dtls_id)
				$prevData=sql_select($sql_prev);
				foreach($prevData as $rowP)
				{
					$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('body_part_id')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('fab_weight')]][$rowP[csf('width_dia_type')]][$rowP[csf('cutable_width')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
				}
			}
		}
	}
	else if($item_category_id==14)  // Grey fabrics woven
	{
		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{
			$booking_id_cond=""; $result=explode(",",$wo_dtls_id);
			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" b.work_order_dtls_id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
				//echo $booking_id_cond;die;
			}
			else
			{
				$booking_id_cond=" and b.work_order_dtls_id in($wo_dtls_id)";
			}

			$prev_pi_qty_arr=return_library_array( "SELECT b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.after_goods_source=2 and b.after_goods_source=2 and b.status_active=1 and b.is_deleted=0 $booking_id_cond group by b.work_order_dtls_id", "work_order_dtls_id", "qty");// and b.work_order_dtls_id in($wo_dtls_id)
		}
		else
		{
			
			$booking_id_cond=""; $result=explode(",",$wo_dtls_id);
			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
				//echo $booking_id_cond;die;
			}
			else
			{
				$booking_id_cond=" and id in($wo_dtls_id)";
			}

			$wo_nos='';
			$woNosData=sql_select("select distinct booking_no from wo_booking_dtls where status_active=1 and is_deleted=0 $booking_id_cond");
			foreach ($woNosData as $rowB)
			{
				$wo_nos.="'".$rowB[csf('booking_no')]."',";
			}
			$wo_nos=chop($wo_nos,',');				

			$prev_pi_qty_arr=array();
			$sql_prev="SELECT b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.uom, sum(b.quantity) as qty ,b.work_order_dtls_id
			from com_pi_master_details a, com_pi_item_details b 
			where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and b.is_deleted=0 and b.work_order_no in($wo_nos) 
			group by b.work_order_no, b.body_part_id, b.determination_id, b.color_id, b.fabric_construction, b.fabric_composition, b.uom,b.work_order_dtls_id";// and b.work_order_dtls_id in($wo_dtls_id)
			$prevData=sql_select($sql_prev);
			foreach($prevData as $rowP)
			{
				$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('work_order_dtls_id')]][$rowP[csf('body_part_id')]][$rowP[csf('determination_id')]][$rowP[csf('color_id')]][$rowP[csf('fabric_construction')]][$rowP[csf('fabric_composition')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
			}
		}
	}
	else if($item_category_id==4)  // Accessories
	{		
		$booking_id_cond=""; $result=explode(",",$wo_dtls_id);
		if($db_type==2 && count($result)>999)
		{
			$booking_id_chunk_arr=array_chunk($result,999) ;
			foreach($booking_id_chunk_arr as $chunk_arr)
			{
				$chunk_arr_value=implode(",",$chunk_arr);
				$bokIds_cond.=" b.work_order_dtls_id in($chunk_arr_value) or ";
			}

			$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
			//echo $booking_id_cond;die;
		}
		else
		{
			$booking_id_cond=" and b.work_order_dtls_id in($wo_dtls_id)";
		}

		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{
			if($order_type==1)
			{
				$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty
				from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.importer_id='$importer_id' and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.after_goods_source=2 and b.after_goods_source=2 and b.status_active=1 and b.is_deleted=0 $booking_id_cond group by b.work_order_dtls_id", "work_order_dtls_id", "qty");// and b.work_order_dtls_id in($wo_dtls_id)
			}
			else
			{
				$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty
				from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.importer_id='$importer_id' and a.item_category_id=$item_category_id and a.pi_basis_id=1  and a.after_goods_source=2 and b.after_goods_source=2 and b.status_active=1 and b.is_deleted=0 $booking_id_cond and b.booking_without_order =1 group by b.work_order_dtls_id", "work_order_dtls_id", "qty");
			}
		}
		else
		{
			$prev_pi_qty_arr=array();
			if($order_type==1)
			{
				$sql_prev="select b.work_order_no, b.work_order_dtls_id, b.order_id, b.color_id, b.item_group, b.item_description, b.size_id, b.item_color, b.item_size, b.uom, b.rate, b.brand_supplier, sum(b.quantity) as qty
				from com_pi_master_details a, com_pi_item_details b
				where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and b.status_active=1 and b.is_deleted=0 $booking_id_cond group by b.work_order_no, b.work_order_dtls_id, b.order_id, b.color_id, b.item_group, b.item_description, b.size_id, b.item_color, b.item_size, b.uom, b.rate, b.brand_supplier";// and b.work_order_dtls_id in($wo_dtls_id)
				$prevData=sql_select($sql_prev);
				foreach($prevData as $rowP)
				{
					//$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('work_order_dtls_id')]][$rowP[csf('color_id')]][$rowP[csf('item_group')]][$rowP[csf('item_description')]][$rowP[csf('size_id')]][$rowP[csf('item_color')]][$rowP[csf('item_size')]][$rowP[csf('brand_supplier')]][$rowP[csf('uom')]][$rowP[csf('rate')]]=$rowP[csf('qty')];
					$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('work_order_dtls_id')]][$rowP[csf('order_id')]][$rowP[csf('color_id')]][$rowP[csf('item_group')]][$rowP[csf('item_description')]][$rowP[csf('size_id')]][$rowP[csf('item_color')]][$rowP[csf('item_size')]][$rowP[csf('brand_supplier')]][$rowP[csf('uom')]]=$rowP[csf('qty')];
				}
			}
			else
			{
				$sql_prev="select b.work_order_dtls_id,sum(b.quantity) as qty
				from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.importer_id='$importer_id' and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and a.status_active=1 and b.status_active=1 and b.is_deleted=0 $booking_id_cond group by b.work_order_dtls_id";
				$prevData=sql_select($sql_prev);
				foreach($prevData as $rowP)
				{
					$prev_pi_qty_arr[$rowP[csf('work_order_no')]][$rowP[csf('work_order_dtls_id')]]=$rowP[csf('qty')];
				}
				//$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.importer_id='$importer_id' and a.item_category_id=$item_category_id and a.pi_basis_id=1 and a.after_goods_source=1 and b.after_goods_source=1 and a.status_active=1 and b.status_active=1 and b.is_deleted=0 $booking_id_cond group by b.work_order_dtls_id", "work_order_dtls_id", "qty");// and
			}

		}
	}
	// 1=Yarn, 3=woven fabrics, 24=Services - Yarn Dyeing
	else if($item_category_id==1 || $item_category_id==3 || $item_category_id==24 || $item_category_id==116)
	{
		if($goods_rcv_status==1 && $goods_rcv_variable !=1) $rcv_source_cond=" and a.after_goods_source=2 and b.after_goods_source=2"; else $rcv_source_cond=" and a.after_goods_source=1 and b.after_goods_source=1";
		$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 $rcv_source_cond and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");
	}
	else if($item_category_id == 12)  // Services - Fabric
	{//pending work
		if($goods_rcv_status==1 && $goods_rcv_variable !=1) $rcv_source_cond=" and a.after_goods_source=2 and b.after_goods_source=2"; else $rcv_source_cond=" and a.after_goods_source=1 and b.after_goods_source=1";
		$booking_id_cond=""; $result=array_unique(explode(",",$wo_dtls_id));
		if($db_type==2 && count($result)>999)
		{
			$booking_id_chunk_arr=array_chunk($result,999) ;
			foreach($booking_id_chunk_arr as $chunk_arr)
			{
				$chunk_arr_value=implode(",",$chunk_arr);
				$bokIds_cond.=" b.work_order_dtls_id in($chunk_arr_value) or ";
			}

			$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
			//echo $booking_id_cond;die;
		}
		else
		{
			$booking_id_cond=" and b.work_order_dtls_id in($wo_dtls_id)";
		}
		$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 $rcv_source_cond and b.status_active=1 and b.is_deleted=0 $booking_id_cond group by b.work_order_dtls_id", "work_order_dtls_id", "qty");
	}
	else
	{
		if($goods_rcv_status==1 && $goods_rcv_variable !=1) $rcv_source_cond=" and a.after_goods_source=2 and b.after_goods_source=2"; else $rcv_source_cond=" and a.after_goods_source=1 and b.after_goods_source=1";
		if($item_category_id!=114)
		{
			if($order_type==1) $booking_without_order_cond=" and b.booking_without_order=0"; else $booking_without_order_cond=" and b.booking_without_order <> 0";
		}
		
		$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id,sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id in(select category_id from lib_item_category_list where category_type=1) and a.pi_basis_id=1 $rcv_source_cond and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id) and b.ITEM_PROD_ID>0 $booking_without_order_cond group by b.work_order_dtls_id", "work_order_dtls_id", "qty");
		
	}

	if($cbo_pi_basis_id==1) $disable_rate="disabled='disabled'";  else $disable_rate="";


	if($item_category_id==1)  // Yarn
	{
		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{
			$rcv_rtn_qnty=return_library_array("select recv_trans_id, sum(issue_qnty) as qnty from  inv_mrr_wise_issue_details where entry_form=8 and status_active=1 group by recv_trans_id","recv_trans_id","qnty");

			$data_array=sql_select("select a.id, a.wo_number, c.id as dtls_id, d.color as color_name, d.yarn_count_id as  yarn_count, d.yarn_comp_type1st, d.yarn_comp_percent1st, d.yarn_comp_type2nd, d.yarn_comp_percent2nd, d.yarn_type, c.order_qnty as qnty, c.order_uom as uom, c.order_amount as order_amount, d.id as prod_id
			from wo_non_order_info_mst a, inv_receive_master b, inv_transaction c, product_details_master d
			where a.id=b.booking_id and b.id=c.mst_id and c.prod_id=d.id and b.entry_form=1 and b.receive_purpose!=2 and c.item_category=1 and b.receive_basis=2 and d.item_category_id=1 and c.id in($wo_dtls_id) and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0");
			$dtls_data=array();
			foreach($data_array as $row)
			{
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["wo_number"]=$row[csf("wo_number")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["color_name"]=$row[csf("color_name")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["yarn_count"]=$row[csf("yarn_count")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["yarn_comp_type1st"]=$row[csf("yarn_comp_type1st")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["yarn_comp_percent1st"]=$row[csf("yarn_comp_percent1st")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["yarn_comp_type2nd"]=$row[csf("yarn_comp_type2nd")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["yarn_comp_percent2nd"]=$row[csf("yarn_comp_percent2nd")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["yarn_type"]=$row[csf("yarn_type")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["uom"]=$row[csf("uom")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["dtls_id"].=$row[csf("dtls_id")]."_";

				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]["trans_qnty"]=$row[csf("qnty")];
				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]["order_amount"]=$row[csf("order_amount")];
			}
			$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count WHERE status_active = 1 AND is_deleted = 0 ORDER BY yarn_count",'id','yarn_count');

			foreach($dtls_data as $book_id=>$book_data)
			{
				foreach($book_data as $pord_id=>$row)
				{

					$rtn_qnty=$rate=$prev_pi_qnty=$book_item_qnty=$book_item_amt=$bl_trans_qnty=$item_amt=$item_rate=0;$trans_id_arr=$trans_data_arr=array();$trans_data=$all_dtls_id="";

					$trans_id_arr=explode("_",chop($row[("dtls_id")],'_'));
					foreach($trans_id_arr as $trans_id)
					{
						$bl_trans_qnty=number_format(($trans_qnty_data[$book_id][$pord_id][$trans_id]["trans_qnty"]-($rcv_rtn_qnty[$trans_id]+$prev_pi_qty_arr[$trans_id])),2,'.','');
						$item_rate=$trans_qnty_data[$book_id][$pord_id][$trans_id]["order_amount"]/$trans_qnty_data[$book_id][$pord_id][$trans_id]["trans_qnty"];
						$item_amt=number_format($bl_trans_qnty*$item_rate,2,'.','');
						$trans_data.=$trans_id."_".$bl_trans_qnty."_".$item_amt."_".$pord_id."__";
						$rtn_qnty+=$rcv_rtn_qnty[$trans_id];
						$prev_pi_qnty+=$prev_pi_qty_arr[$trans_id];
						$book_item_qnty+=$trans_qnty_data[$book_id][$pord_id][$trans_id]["trans_qnty"];
						$book_item_amt+=$trans_qnty_data[$book_id][$pord_id][$trans_id]["order_amount"];
						$all_dtls_id.=$trans_id.",";

					}
					$all_dtls_id=chop($all_dtls_id,",");
					$bl_qty=($book_item_qnty-($rtn_qnty+$prev_pi_qnty));
					$rate=$book_item_amt/$book_item_qnty;
					$amount=$rate*$bl_qty;
					$bl_qty=number_format($bl_qty,6,'.','');
					if($bl_qty>0)
					{
						$tblRow++;
						?>
						<tr class="general" id="row_<? echo $tblRow; ?>">
							<td>
								<input type="checkbox" name="workOrderChkbox_<? echo $tblRow; ?>" id="workOrderChkbox_<? echo $tblRow; ?>" value="" />
							</td>
							<td>
								<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[('wo_number')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" title="<? echo $row[('wo_number')];?>" readonly />
								<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $book_id; ?>" readonly />
								<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $all_dtls_id; ?>" readonly />
								<input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="<? echo chop($trans_data,'__'); ?>" readonly />
                                <input type="hidden" name="hideOrdeSource[]" id="hideOrdeSource_<? echo $tblRow; ?>" value="0" readonly />
							</td>
                            <td>
                                <input type="text" name="hsCode[]" id="hsCode_<? echo $tblRow; ?>" class="text_boxes" value="" style="width:40px;" />
                            </td>
							<td>
								<input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" style="width:80px"  maxlength="50" value="<? echo $color_library[$row[('color_name')]]; ?>" title="<? echo $color_library[$row[('color_name')]]; ?>" disabled="disabled" />
                                <input type="hidden" name="colorId[]" id="colorId_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[('color_name')]; ?>"/>
							</td>
							<td title="<? echo $count_arr[$row[('yarn_count')]]; ?>">
							<?
								echo create_drop_down( "countName_".$tblRow, 85, "SELECT id,yarn_count FROM lib_yarn_count WHERE status_active = 1 AND is_deleted = 0 ORDER BY yarn_count ASC",'id,yarn_count', 1, '-Select-',$row[('yarn_count')],"",1, "", "", "", "", "", "", "countName[]");
							?>
							</td>
							<td colspan="2" title="<? echo $row['yarn_comp_type1st']; ?>">
	                        <?
	                            $composition_item1_width = '190px';
	                           // echo create_drop_down( "yarnCompositionItem1_1",$composition_item1_width, $composition,'', 1, '-Select-',0,"control_composition(1,'comp_one')",$disable_status);
							    if($row['yarn_comp_type1st']!="") $onclick_fnc=''; else $onclick_fnc='openmypage_comp(1)';
	                        	?>
		                        <input type="text" name="txtyarnCompositionItem1[]" id="txtyarnCompositionItem1_<? echo $tblRow; ?>" class="text_boxes" <?= $onclick_fnc;?> placeholder="Browse" readonly style="width: <? echo $composition_item1_width; ?>; " value="<? echo $composition[$row['yarn_comp_type1st']]; ?>" <? echo $disable_data; ?> />
		                        <input type="hidden" name="yarnCompositionItem1[]" id="yarnCompositionItem1_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row['yarn_comp_type1st']; ?>" <? echo $disable_data; ?> />


		                        <input type="text" name="yarnCompositionPercentage1[]" id="yarnCompositionPercentage1_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row['yarn_comp_percent1st']; ?>" onChange="control_composition(<? echo $tblRow; ?>,'percent_one')" style="width:25px;" disabled/>%
		                        <input type="hidden" name="yarnCompositionItem2[]" id="yarnCompositionItem2_<? echo $tblRow; ?>" readonly value="<? echo $row['yarn_comp_type2nd']; ?>" />
		                        <input type="hidden" name="yarnCompositionPercentage2[]" id="yarnCompositionPercentage2_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row['yarn_comp_type2nd']; ?>" onChange="control_composition(<? echo $tblRow; ?>,'percent_two')" style="width:25px;" disabled/>
	                    	</td>
							<td title="<? echo $yarn_type[$row[('yarn_type')]]; ?>">
								<?
									echo create_drop_down( "yarnType_".$tblRow,70,$yarn_type,'', 1,'-Select-',$row[('yarn_type')],"",1, '', '', '', '', '', '', 'yarnType[]');
								?>
							</td>
							<td id="tduom_"<? echo $tblRow; ?>>
								<?
									echo create_drop_down( "uom_".$tblRow, 60, $unit_of_measurement,'', 0, '',$row[('uom')],'',1, '', '', '', '', '', '', 'uom[]');
								?>
							</td>
							<td>
								<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bl_qty; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" />
							</td>
							<td>
								<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $rate; ?>" style="width:45px; text-align:right;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" readonly />
							</td>
							<td>
								<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $amount; ?>" style="width:75px; text-align:right;" readonly/>
								<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>

							</td>
						</tr>
						<?
					}

				}
			}

		}
		else
		{
			$data_array=sql_select("select a.id, a.wo_number, a.payterm_id, b.id as dtls_id, b.color_name, b.yarn_count, b.yarn_comp_type1st, b.yarn_comp_percent1st, b.yarn_comp_type2nd, b.yarn_comp_percent2nd, b.yarn_type, b.supplier_order_quantity, b.uom, b.rate, b.amount from wo_non_order_info_mst a, wo_non_order_info_dtls b where a.id=b.mst_id and b.id in($wo_dtls_id)");
			$disable_data=$checkBox_check="";
			foreach($data_array as $row)
			{
				if($row[csf('payterm_id')]==5)
				{
					$disable_data="disabled='disabled'";
					$checkBox_check="checked";
				}
				else
				{
					$disable_data="";
					$checkBox_check="";
				}
				$bl_qty=$row[csf('supplier_order_quantity')]-$prev_pi_qty_arr[$row[csf('dtls_id')]];

				$amnt=number_format($bl_qty*$row[csf('rate')],4,'.','');
				$bl_qty=number_format($bl_qty,6,'.','');

				if($bl_qty>0)
				{
					$tblRow++;
					?>
					<tr class="general" id="row_<? echo $tblRow; ?>">
						<td>
							<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" <? echo $disable_data." ".$checkBox_check; ?> />
						</td>
						<td>
							<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('wo_number')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" title="<? echo $row[csf('wo_number')];?>" readonly />
							<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>" readonly />
							<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('dtls_id')]; ?>" readonly />
                            <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="" readonly />
                            <input type="hidden" name="hideOrdeSource[]" id="hideOrdeSource_<? echo $tblRow; ?>" value="<? echo $row[csf('payterm_id')]; ?>" readonly />
						</td>
                        <td>
                            <input type="text" name="hsCode[]" id="hsCode_<? echo $tblRow; ?>" class="text_boxes" value="" style="width:40px;" />
                        </td>
						<td>
							<input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" style="width:80px"  maxlength="50" value="<? echo $color_library[$row[csf('color_name')]]; ?>" disabled="disabled" />
						</td>
						<td>
						<?
							echo create_drop_down( "countName_".$tblRow, 85, "SELECT id,yarn_count FROM lib_yarn_count WHERE status_active = 1 AND is_deleted = 0 ORDER BY yarn_count ASC",'id,yarn_count', 1, '-Select-',$row[csf('yarn_count')],"",1, '', '', '', '', '', '', 'countName[]');
						?>
						</td>

						<td colspan="2" title="<? echo $composition[$row[csf('yarn_composition_item1')]]; ?>">
                        <?
                            $composition_item1_width = '190px';
                           // echo create_drop_down( "yarnCompositionItem1_1",$composition_item1_width, $composition,'', 1, '-Select-',0,"control_composition(1,'comp_one')",$disable_status);
                        	?>
	                        <input type="text" name="txtyarnCompositionItem1[]" id="txtyarnCompositionItem1_<? echo $tblRow; ?>" class="text_boxes" onClick="openmypage_comp(1);" placeholder="Browse" readonly style="width: <? echo $composition_item1_width; ?>; " value="<? echo $composition[$row[csf('yarn_comp_type1st')]]; ?>" <? echo $disable_data; ?> />
	                        <input type="hidden" name="yarnCompositionItem1[]" id="yarnCompositionItem1_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('yarn_comp_type1st')]; ?>" <? echo $disable_data; ?> />

	                        <input type="text" name="yarnCompositionPercentage1[]" id="yarnCompositionPercentage1_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('yarn_comp_percent1st')]; ?>" onChange="control_composition(<? echo $tblRow; ?>,'percent_one')" style="width:25px;" disabled/>%
	                        <input type="hidden" name="yarnCompositionItem2[]" id="yarnCompositionItem2_<? echo $tblRow; ?>" readonly value="<? echo $row[csf('yarn_comp_type2nd')]; ?>" />
	                        <input type="hidden" name="yarnCompositionPercentage2[]" id="yarnCompositionPercentage2_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('yarn_comp_percent2nd')]; ?>" onChange="control_composition(<? echo $tblRow; ?>,'percent_two')" style="width:25px;" disabled/>
                    	</td>
						<td>
							<?
								echo create_drop_down( "yarnType_".$tblRow,70,$yarn_type,'', 1,'-Select-',$row[csf('yarn_type')],"",1, '', '', '', '', '', '', 'yarnType[]');
							?>
						</td>
						<td id="tduom_"<? echo $tblRow; ?>>
							<?
								echo create_drop_down( "uom_".$tblRow, 60, $unit_of_measurement,'', 0, '',$row[csf('uom')],'',1, '', '', '', '', '', '', 'uom[]');
							?>
						</td>
						<td>
							<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bl_qty; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" <? echo $disable_data; ?> />
						</td>
						<td>
							<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:45px; text-align:right;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" <? echo $disable_rate; echo $disable_data;?>   />
						</td>
						<td>
							<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $amnt; ?>" style="width:75px; text-align:right;" readonly/>
							<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
						</td>
					</tr>
					<?
				}
			}


		}
	}

	else if($item_category_id==2) // Knit Finish Fabric
	{
		//echo $goods_rcv_status."=".$item_category_id;die;
		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{

			$construction_arr=array(); $composition_arr=array();
			$sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by b.id asc";
			$data_array=sql_select($sql_deter);
			if(count($data_array)>0)
			{
				foreach( $data_array as $row )
				{
					$construction_arr[$row[csf('id')]]=$row[csf('construction')];

					if(array_key_exists($row[csf('id')],$composition_arr))
					{
						$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
					}
					else
					{
						$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
					}
				}
			}

			$booking_id_cond=""; $result=explode(",",$wo_dtls_id);
			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" c.id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
				//echo $booking_id_cond;die;
			}
			else
			{
				$booking_id_cond=" and c.id in($wo_dtls_id)";
			}

			$rcv_rtn_qnty=return_library_array("select recv_trans_id, sum(issue_qnty) as qnty from  inv_mrr_wise_issue_details where entry_form=46 and status_active=1 group by recv_trans_id","recv_trans_id","qnty");

			if($order_type==1)
			{
				$data_array=sql_select("SELECT a.id, a.booking_no, d.color as fabric_color_id, d.gsm as gsm_weight, d.dia_width, c.order_qnty as fin_fab_qnty, c.order_amount as amount, d.detarmination_id as lib_yarn_count_deter_id, c.id as dtls_id, c.order_uom as uom, c.order_rate as rate, d.id as prod_id 
					from wo_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d 
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.pay_mode=1 $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0");//and c.id in($wo_dtls_id)
			}
			else
			{
				$data_array=sql_select("select a.id, a.booking_no, d.color as fabric_color_id, d.detarmination_id as lib_yarn_count_deter_id, d.gsm as gsm_weight, d.dia_width, c.order_amount as amount, c.order_qnty as fin_fab_qnty, c.id as dtls_id, c.order_uom as uom, c.order_rate as rate, d.id as prod_id
				from wo_non_ord_samp_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
				where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and   c.is_deleted=0 and d.status_active=1 and d.is_deleted=0");// and c.id in($wo_dtls_id)
			}

			$dtls_data=array();
			foreach($data_array as $row)
			{
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["id"]=$row[csf("id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["prod_id"]=$row[csf("prod_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["booking_no"]=$row[csf("booking_no")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["fabric_color_id"]=$row[csf("fabric_color_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["gsm_weight"]=$row[csf("gsm_weight")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["dia_width"]=$row[csf("dia_width")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["lib_yarn_count_deter_id"]=$row[csf("lib_yarn_count_deter_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["uom"]=$row[csf("uom")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["dtls_id"].=$row[csf("dtls_id")]."_";

				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]["fin_fab_qnty"]=$row[csf("fin_fab_qnty")];
				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]["amount"]=$row[csf("amount")];
			}

			if($order_type==1) $booking_without_order=0; else $booking_without_order=1;
			foreach($dtls_data as $book_id=>$book_data)
			{
				foreach($book_data as $prod_id=>$row)
				{

					$construction=''; $copmposition='';
					$construction=$construction_arr[$row[('lib_yarn_count_deter_id')]];
					$copmposition=$composition_arr[$row[('lib_yarn_count_deter_id')]];


					//$rtn_qnty=$rate=$prev_pi_qnty=$book_item_qnty=$book_item_amt=0;$trans_data="";
					$rtn_qnty=$rate=$prev_pi_qnty=$book_item_qnty=$book_item_amt=$bl_trans_qnty=$item_amt=$item_rate=0;$trans_data=$all_dtls_id="";

					$trans_id_arr=explode("_",chop($row[("dtls_id")],'_'));
					foreach($trans_id_arr as $trans_id)
					{
						$bl_trans_qnty=number_format(($trans_qnty_data[$book_id][$prod_id][$trans_id]["fin_fab_qnty"]-($rcv_rtn_qnty[$trans_id]+$prev_pi_qty_arr[$trans_id])),2,'.','');
						$item_rate=$trans_qnty_data[$book_id][$prod_id][$trans_id]["amount"]/$trans_qnty_data[$book_id][$prod_id][$trans_id]["fin_fab_qnty"];
						$item_amt=number_format($bl_trans_qnty*$item_rate,2,'.','');
						$trans_data.=$trans_id."_".$bl_trans_qnty."_".$item_amt."_".$prod_id."__";
						$rtn_qnty+=$rcv_rtn_qnty[$trans_id];
						$prev_pi_qnty+=$prev_pi_qty_arr[$trans_id];
						$book_item_qnty+=$trans_qnty_data[$book_id][$prod_id][$trans_id]["fin_fab_qnty"];
						$book_item_amt+=$trans_qnty_data[$book_id][$prod_id][$trans_id]["amount"];
						$all_dtls_id.=$trans_id.",";

					}
					$all_dtls_id=chop($all_dtls_id,",");
					$bl_qty=($book_item_qnty-($rtn_qnty+$prev_pi_qnty));
					$rate=$book_item_amt/$book_item_qnty;
					$amount=$rate*$bl_qty;
					$bl_qty=number_format($bl_qty,6,'.','');

					if($bl_qty>0)
					{
						$tblRow++;
					    ?>
						<tr class="general" id="row_<? echo $tblRow; ?>">
							<td>
								<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" />
							</td>
							<td>
								<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[('booking_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
								<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[('id')]; ?>" readonly />
								<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $all_dtls_id; ?>" readonly />
                                <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="<? echo chop($trans_data,'__'); ?>" readonly />
							</td>
                            <td>
                                <input type="text" name="hsCode[]" id="hsCode_<? echo $tblRow; ?>" class="text_boxes" value="" style="width:40px;" />
                            </td>
							<td>
								<input type="text" name="construction[]" id="construction_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $construction; ?>" style="width:110px" disabled="disabled"/>
								<input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_<? echo $tblRow; ?>" value="<? echo $row[('lib_yarn_count_deter_id')]; ?>" readonly />
							</td>
							<td>
								<input type="text" name="composition[]" id="composition_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $copmposition; ?>" style="width:120px" disabled="disabled"/>
							</td>
							<td>
								<input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[('fabric_color_id')]]; ?>" style="width:80px" maxlength="50" disabled="disabled"/>
							</td>
							<td>
								<input type="text" name="gsm[]" id="gsm_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[('gsm_weight')]; ?>" style="width:60px" disabled="disabled"/>
							</td>
							<td>
								<input type="text" name="diawidth[]" id="diawidth_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[('dia_width')]; ?>" style="width:70px" disabled="disabled"/>
							</td>
							 <td>
								<?
									echo create_drop_down( "uom_".$tblRow, 60, $unit_of_measurement,'', 1, 'Select',$row[('uom')],'','1', '', '', '', '', '', '', 'uom[]');
								?>
							</td>
							<td>
								<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bl_qty; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" readonly />
							</td>
							<td>
								<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $rate; ?>" style="width:45px; text-align:right;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" readonly />
							</td>
							<td>
								<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $amount; ?>" style="width:75px; text-align:right;" readonly/>
								<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
								<input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="<? echo $booking_without_order; ?>"/>
							</td>
						</tr>
					    <?
					}

				}

			}

		}
		else
		{

			$booking_id_cond=""; $bokIds_cond=""; $result=explode(",",$wo_dtls_id);
			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" b.id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
				//echo $booking_id_cond;die;
			}
			else
			{
				$booking_id_cond=" and b.id in($wo_dtls_id)";
			}

			if($order_type==1)
			{
				
				$data_sql="select a.id, a.booking_no, b.fabric_color_id, c.construction as construction, c.composition as copmposition, c.gsm_weight, b.dia_width, sum(b.fin_fab_qnty) as fin_fab_qnty, sum(b.fin_fab_qnty*b.rate) as amount, c.lib_yarn_count_deter_id, c.uom, 0 as dtls_id 
				from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c 
				where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 
				group by a.id, a.booking_no, b.fabric_color_id, c.construction, c.composition, c.gsm_weight, b.dia_width,c.lib_yarn_count_deter_id,c.uom";  // and b.id in($wo_dtls_id)
			}
			else
			{
				$data_sql="select a.id, a.booking_no, b.id as dtls_id, b.fabric_color as fabric_color_id, b.construction as construction, b.composition as copmposition, b.gsm_weight, b.dia_width as dia_width, b.uom, b.finish_fabric as fin_fab_qnty, b.rate,b.lib_yarn_count_deter_id,b.color_all_data, (b.finish_fabric*b.rate) as amount, b.lib_yarn_count_deter_id as lib_yarn_count_deter_id 
				from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b 
				where a.booking_no=b.booking_no $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
				
				$sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by b.id asc";
				$count_data_array=sql_select($sql_deter);
				foreach( $count_data_array as $row )
				{
						$construction_arr[$row[csf('id')]]=$row[csf('construction')];

						if(array_key_exists($row[csf('id')],$composition_arr))
						{
							$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
						else
						{
							$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
					}
			}
			//echo $data_sql;die;
			$data_array=sql_select($data_sql);

			$disable_data=$checkBox_check="";
			if($goods_rcv_variable==1 && $goods_rcv_status==1)
			{
				$disable_data="disabled='disabled'";
				$checkBox_check="checked";
			}
			//print_r($data_array);die;
			if($order_type==1) $booking_without_order=0; else $booking_without_order=1;
			foreach($data_array as $row)
			{
				$construction=''; $copmposition='';$fabric_color='';

				$prev_pi=0;
				if($order_type==1)
				{
					$bl_qty=$row[csf('fin_fab_qnty')]-$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];
					$prev_pi=$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];
					$construction=$row[csf('construction')];
					$copmposition=$row[csf('copmposition')];
					$fabric_color=$color_library[$row[csf('fabric_color_id')]];
				}
				else
				{
					$bl_qty=$row[csf('fin_fab_qnty')]-$prev_pi_qty_arr[$row[csf('dtls_id')]];
					$prev_pi=$prev_pi_qty_arr[$row[csf('dtls_id')]];
					$construction=$construction_arr[$row[csf('lib_yarn_count_deter_id')]];
					$copmposition=$composition_arr[$row[csf('lib_yarn_count_deter_id')]];
					$colordata=explode("_",$row[csf('color_all_data')]);
					$fabric_color=$colordata[1];
				}
				//$amnt=number_format($bl_qty*$row[csf('rate')],4,'.','');
				$bl_qty=number_format($bl_qty,6,'.','');
				if($bl_qty>0)
				{
					$tblRow++;
				    ?>
					<tr class="general" id="row_<? echo $tblRow; ?>">
						<td>
							<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" <? echo $checkBox_check; ?> />
						</td>
						<td>
							<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
							<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>" readonly />
							<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('dtls_id')]; ?>" readonly />
                            <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="" readonly />
						</td>
                        <td>
                            <input type="text" name="hsCode[]" id="hsCode_<? echo $tblRow; ?>" class="text_boxes" value="" style="width:40px;" />
                        </td>
						<td>
							<input type="text" name="construction[]" id="construction_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $construction; ?>" style="width:110px" disabled="disabled"/>
							<input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_<? echo $tblRow; ?>" value="<? echo $row[csf('lib_yarn_count_deter_id')]; ?>" readonly />
						</td>
						<td>
							<input type="text" name="composition[]" id="composition_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $copmposition; ?>" style="width:120px" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('fabric_color_id')]]; ?>" style="width:80px" maxlength="50" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="gsm[]" id="gsm_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('gsm_weight')]; ?>" style="width:60px" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="diawidth[]" id="diawidth_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('dia_width')]; ?>" style="width:70px" disabled="disabled"/>
						</td>
						<td>
                        <input type="text" name="uom[]" id="uom_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $unit_of_measurement[$row[csf('uom')]]; ?>" placeholder="<? echo $row[csf('uom')]; ?>" style="width:50px" readonly />

						</td>
						<td>
							<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bl_qty; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" title="<? echo $prev_pi; ?>" />
						</td>
						<td>
							<? $rate=number_format($row[csf('amount')]/$row[csf('fin_fab_qnty')],4,'.',''); $amnt=number_format($bl_qty*$rate,4,'.',''); ?>
							<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $rate; ?>" style="width:45px; text-align:right;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" <? echo $disable_rate; ?> />
						</td>
						<td>
							<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $amnt; ?>" style="width:75px; text-align:right;" readonly/>
							<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
							 <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="<? echo $booking_without_order; ?>"/>
						</td>
					</tr>
				<?
				}
			}

		}
	}
	
	else if($item_category_id==13) // Grey Fabric
	{
		//echo $goods_rcv_status."=".$item_category_id;die;
		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{

			$construction_arr=array(); $composition_arr=array();
			$sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by b.id asc";
			$data_array=sql_select($sql_deter);
			if(count($data_array)>0)
			{
				foreach( $data_array as $row )
				{
					$construction_arr[$row[csf('id')]]=$row[csf('construction')];

					if(array_key_exists($row[csf('id')],$composition_arr))
					{
						$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
					}
					else
					{
						$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
					}
				}
			}

			$booking_id_cond=""; $result=explode(",",$wo_dtls_id);
			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" c.id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
				//echo $booking_id_cond;die;
			}
			else
			{
				$booking_id_cond=" and c.id in($wo_dtls_id)";
			}

			$rcv_rtn_qnty=return_library_array("select recv_trans_id, sum(issue_qnty) as qnty from  inv_mrr_wise_issue_details where entry_form=46 and status_active=1 group by recv_trans_id","recv_trans_id","qnty");

			if($order_type==1)
			{
				$data_array=sql_select("SELECT a.id, a.booking_no, d.color as fabric_color_id, d.gsm as gsm_weight, d.dia_width, c.order_qnty as fin_fab_qnty, c.order_amount as amount, d.detarmination_id as lib_yarn_count_deter_id, c.id as dtls_id, c.order_uom as uom, c.order_rate as rate, d.id as prod_id 
					from wo_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d 
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.pay_mode=1 $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0");//and c.id in($wo_dtls_id)
			}
			else
			{
				$data_array=sql_select("select a.id, a.booking_no, d.color as fabric_color_id, d.detarmination_id as lib_yarn_count_deter_id, d.gsm as gsm_weight, d.dia_width, c.order_amount as amount, c.order_qnty as fin_fab_qnty, c.id as dtls_id, c.order_uom as uom, c.order_rate as rate, d.id as prod_id
				from wo_non_ord_samp_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
				where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and   c.is_deleted=0 and d.status_active=1 and d.is_deleted=0");// and c.id in($wo_dtls_id)
			}

			$dtls_data=array();
			foreach($data_array as $row)
			{
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["id"]=$row[csf("id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["prod_id"]=$row[csf("prod_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["booking_no"]=$row[csf("booking_no")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["fabric_color_id"]=$row[csf("fabric_color_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["gsm_weight"]=$row[csf("gsm_weight")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["dia_width"]=$row[csf("dia_width")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["lib_yarn_count_deter_id"]=$row[csf("lib_yarn_count_deter_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["uom"]=$row[csf("uom")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["dtls_id"].=$row[csf("dtls_id")]."_";

				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]["fin_fab_qnty"]=$row[csf("fin_fab_qnty")];
				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]["amount"]=$row[csf("amount")];
			}

			if($order_type==1) $booking_without_order=0; else $booking_without_order=1;
			foreach($dtls_data as $book_id=>$book_data)
			{
				foreach($book_data as $prod_id=>$row)
				{

					$construction=''; $copmposition='';
					$construction=$construction_arr[$row[('lib_yarn_count_deter_id')]];
					$copmposition=$composition_arr[$row[('lib_yarn_count_deter_id')]];


					//$rtn_qnty=$rate=$prev_pi_qnty=$book_item_qnty=$book_item_amt=0;$trans_data="";
					$rtn_qnty=$rate=$prev_pi_qnty=$book_item_qnty=$book_item_amt=$bl_trans_qnty=$item_amt=$item_rate=0;$trans_data=$all_dtls_id="";

					$trans_id_arr=explode("_",chop($row[("dtls_id")],'_'));
					foreach($trans_id_arr as $trans_id)
					{
						$bl_trans_qnty=number_format(($trans_qnty_data[$book_id][$prod_id][$trans_id]["fin_fab_qnty"]-($rcv_rtn_qnty[$trans_id]+$prev_pi_qty_arr[$trans_id])),2,'.','');
						$item_rate=$trans_qnty_data[$book_id][$prod_id][$trans_id]["amount"]/$trans_qnty_data[$book_id][$prod_id][$trans_id]["fin_fab_qnty"];
						$item_amt=number_format($bl_trans_qnty*$item_rate,2,'.','');
						$trans_data.=$trans_id."_".$bl_trans_qnty."_".$item_amt."_".$prod_id."__";
						$rtn_qnty+=$rcv_rtn_qnty[$trans_id];
						$prev_pi_qnty+=$prev_pi_qty_arr[$trans_id];
						$book_item_qnty+=$trans_qnty_data[$book_id][$prod_id][$trans_id]["fin_fab_qnty"];
						$book_item_amt+=$trans_qnty_data[$book_id][$prod_id][$trans_id]["amount"];
						$all_dtls_id.=$trans_id.",";

					}
					$all_dtls_id=chop($all_dtls_id,",");
					$bl_qty=($book_item_qnty-($rtn_qnty+$prev_pi_qnty));
					$rate=$book_item_amt/$book_item_qnty;
					$amount=$rate*$bl_qty;
					$bl_qty=number_format($bl_qty,6,'.','');

					if($bl_qty>0)
					{
						$tblRow++;
					    ?>
						<tr class="general" id="row_<? echo $tblRow; ?>">
							<td>
								<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" />
							</td>
							<td>
								<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[('booking_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
								<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[('id')]; ?>" readonly />
								<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $all_dtls_id; ?>" readonly />
                                <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="<? echo chop($trans_data,'__'); ?>" readonly />
							</td>
                            <td>
                                <input type="text" name="hsCode[]" id="hsCode_<? echo $tblRow; ?>" class="text_boxes" value="" style="width:40px;" />
                            </td>
							<td>
								<input type="text" name="construction[]" id="construction_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $construction; ?>" style="width:110px" disabled="disabled"/>
								<input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_<? echo $tblRow; ?>" value="<? echo $row[('lib_yarn_count_deter_id')]; ?>" readonly />
							</td>
							<td>
								<input type="text" name="composition[]" id="composition_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $copmposition; ?>" style="width:120px" disabled="disabled"/>
							</td>
							<td>
								<input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[('fabric_color_id')]]; ?>" style="width:80px" maxlength="50" disabled="disabled"/>
							</td>
							<td>
								<input type="text" name="gsm[]" id="gsm_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[('gsm_weight')]; ?>" style="width:60px" disabled="disabled"/>
							</td>
							<td>
								<input type="text" name="diawidth[]" id="diawidth_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[('dia_width')]; ?>" style="width:70px" disabled="disabled"/>
							</td>
							 <td>
								<?
									echo create_drop_down( "uom_".$tblRow, 60, $unit_of_measurement,'', 1, 'Select',$row[('uom')],'','1', '', '', '', '', '', '', 'uom[]');
								?>
							</td>
							<td>
								<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bl_qty; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" readonly />
							</td>
							<td>
								<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $rate; ?>" style="width:45px; text-align:right;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" readonly />
							</td>
							<td>
								<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $amount; ?>" style="width:75px; text-align:right;" readonly/>
								<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
								<input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="<? echo $booking_without_order; ?>"/>
							</td>
						</tr>
					    <?
					}

				}

			}

		}
		else
		{

			$booking_id_cond=""; $bokIds_cond=""; $result=explode(",",$wo_dtls_id);
			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" b.id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
				//echo $booking_id_cond;die;
			}
			else
			{
				$booking_id_cond=" and b.id in($wo_dtls_id)";
			}

			if($order_type==1)
			{
				
				$data_sql="select a.id, a.booking_no, b.fabric_color_id, c.construction as construction, c.composition as copmposition, c.gsm_weight, b.dia_width, sum(b.grey_fab_qnty) as fin_fab_qnty, sum(b.grey_fab_qnty*b.rate) as amount, c.lib_yarn_count_deter_id, c.uom, 0 as dtls_id 
				from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c 
				where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 
				group by a.id, a.booking_no, b.fabric_color_id, c.construction, c.composition, c.gsm_weight, b.dia_width,c.lib_yarn_count_deter_id,c.uom";  // and b.id in($wo_dtls_id)
			}
			else
			{
				$data_sql="select a.id, a.booking_no, b.id as dtls_id, b.fabric_color as fabric_color_id, b.construction as construction, b.composition as copmposition, b.gsm_weight, b.dia_width as dia_width, b.uom, b.finish_fabric as fin_fab_qnty, b.rate,b.lib_yarn_count_deter_id,b.color_all_data, (b.finish_fabric*b.rate) as amount, b.lib_yarn_count_deter_id as lib_yarn_count_deter_id 
				from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b 
				where a.booking_no=b.booking_no $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
				
				$sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by b.id asc";
				$count_data_array=sql_select($sql_deter);
				foreach( $count_data_array as $row )
				{
						$construction_arr[$row[csf('id')]]=$row[csf('construction')];

						if(array_key_exists($row[csf('id')],$composition_arr))
						{
							$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
						else
						{
							$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
						}
					}
			}
			//echo $data_sql;
			$data_array=sql_select($data_sql);

			$disable_data=$checkBox_check="";
			if($goods_rcv_variable==1 && $goods_rcv_status==1)
			{
				$disable_data="disabled='disabled'";
				$checkBox_check="checked";
			}
			//print_r($data_array);die;
			if($order_type==1) $booking_without_order=0; else $booking_without_order=1;
			foreach($data_array as $row)
			{
				$construction=''; $copmposition='';$fabric_color='';

				$prev_pi=0;
				if($order_type==1)
				{
					$bl_qty=$row[csf('fin_fab_qnty')]-$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];
					$prev_pi=$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('uom')]];
					$construction=$row[csf('construction')];
					$copmposition=$row[csf('copmposition')];
					$fabric_color=$color_library[$row[csf('fabric_color_id')]];
				}
				else
				{
					$bl_qty=$row[csf('fin_fab_qnty')]-$prev_pi_qty_arr[$row[csf('dtls_id')]];
					$prev_pi=$prev_pi_qty_arr[$row[csf('dtls_id')]];
					$construction=$construction_arr[$row[csf('lib_yarn_count_deter_id')]];
					$copmposition=$composition_arr[$row[csf('lib_yarn_count_deter_id')]];
					$colordata=explode("_",$row[csf('color_all_data')]);
					$fabric_color=$colordata[1];
				}
				//$amnt=number_format($bl_qty*$row[csf('rate')],4,'.','');
				$bl_qty=number_format($bl_qty,6,'.','');
				if($bl_qty>0)
				{
					$tblRow++;
				    ?>
					<tr class="general" id="row_<? echo $tblRow; ?>">
						<td>
							<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" <? echo $checkBox_check; ?> />
						</td>
						<td>
							<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
							<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>" readonly />
							<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('dtls_id')]; ?>" readonly />
                            <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="" readonly />
						</td>
                        <td>
                            <input type="text" name="hsCode[]" id="hsCode_<? echo $tblRow; ?>" class="text_boxes" value="" style="width:40px;" />
                        </td>
						<td>
							<input type="text" name="construction[]" id="construction_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $construction; ?>" style="width:110px" disabled="disabled"/>
							<input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_<? echo $tblRow; ?>" value="<? echo $row[csf('lib_yarn_count_deter_id')]; ?>" readonly />
						</td>
						<td>
							<input type="text" name="composition[]" id="composition_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $copmposition; ?>" style="width:120px" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('fabric_color_id')]]; ?>" style="width:80px" maxlength="50" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="gsm[]" id="gsm_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('gsm_weight')]; ?>" style="width:60px" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="diawidth[]" id="diawidth_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('dia_width')]; ?>" style="width:70px" disabled="disabled"/>
						</td>
						<td>
                        <input type="text" name="uom[]" id="uom_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $unit_of_measurement[$row[csf('uom')]]; ?>" placeholder="<? echo $row[csf('uom')]; ?>" style="width:50px" readonly />

						</td>
						<td>
							<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bl_qty; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" title="<? echo $prev_pi; ?>" />
						</td>
						<td>
							<? $rate=number_format($row[csf('amount')]/$row[csf('fin_fab_qnty')],4,'.',''); $amnt=number_format($bl_qty*$rate,4,'.',''); ?>
							<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $rate; ?>" style="width:45px; text-align:right;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" <? echo $disable_rate; ?> />
						</td>
						<td>
							<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $amnt; ?>" style="width:75px; text-align:right;" readonly/>
							<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
							 <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="<? echo $booking_without_order; ?>"/>
						</td>
					</tr>
				<?
				}
			}

		}
	}

	else if($item_category_id==3)  // Woven Fabrics
	{
		//echo $goods_rcv_status.'**'.$goods_rcv_variable;
		if($order_type==1) $booking_without_order=0; else $booking_without_order=1;
		$lib_body_part_arr=return_library_array("select id, body_part_full_name from lib_body_part", "id", "body_part_full_name");
		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{

			$construction_arr=array(); $composition_arr=array();
			$sql_deter="select a.id, a.construction, a.fabric_ref, a.rd_no, a.type, a.design, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
			$data_array=sql_select($sql_deter);
			if(count($data_array)>0)
			{
				foreach( $data_array as $row )
				{
					$construction_arr[$row[csf('id')]]=$row[csf('construction')];
					$determination_arr[$row[csf('id')]]['fabric_ref']=$row[csf('fabric_ref')];
					$determination_arr[$row[csf('id')]]['rd_no']=$row[csf('rd_no')];
					$determination_arr[$row[csf('id')]]['fabric_type']=$row[csf('type')];
					$determination_arr[$row[csf('id')]]['design']=$row[csf('design')];

					if(array_key_exists($row[csf('id')],$composition_arr))
					{
						$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
					}
					else
					{
						$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
					}
				}
			}

			$booking_id_cond=""; $bokIds_cond=""; $result=explode(",",$wo_dtls_id);
			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" b.id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
				//echo $booking_id_cond;die;
			}
			else
			{
				$booking_id_cond=" and b.id in($wo_dtls_id)";
			}

			$rcv_rtn_qnty=return_library_array("select recv_trans_id, sum(issue_qnty) as qnty from  inv_mrr_wise_issue_details where entry_form=50 and status_active=1 group by recv_trans_id","recv_trans_id","qnty");

			if($order_type==1)
			{
				$data_array=sql_select("SELECT c.id, c.booking_no, a.id as prod_id, a.detarmination_id as lib_yarn_count_deter_id, a.color as fabric_color_id, a.gsm as gsm_weight, a.dia_width, a.item_size as cutable_width, b.order_qnty as fin_fab_qnty, b.order_amount as amount, b.id as dtls_id, b.order_uom as uom, b.order_rate as rate, e.gsm_weight_type as fab_weight_type, e.width_dia_type as dia_or_width, e.body_part_id
				from product_details_master a, inv_transaction b, wo_booking_mst c, wo_booking_dtls d, wo_pre_cost_fabric_cost_dtls e 
				where a.id=b.prod_id and b.pi_wo_batch_no=c.id and c.booking_no=d.booking_no and d.pre_cost_fabric_cost_dtls_id=e.id and a.item_category_id=3 and b.item_category=3 and b.transaction_type=1 and b.receive_basis=2 and a.item_category_id in($item_category_id) and b.item_category in($item_category_id) and c.pay_mode=1 $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0
				group by c.id, c.booking_no, a.id, a.detarmination_id, a.color, a.gsm, a.dia_width, a.item_size, b.order_qnty, b.order_amount, b.id, b.order_uom, b.order_rate, e.gsm_weight_type, e.width_dia_type, e.body_part_id");//and c.id in($wo_dtls_id)
				/*$data_array=sql_select("SELECT a.id, a.booking_no, d.color as fabric_color_id, d.gsm as gsm_weight, d.dia_width, c.order_qnty as fin_fab_qnty, c.order_amount as amount, d.detarmination_id as lib_yarn_count_deter_id, c.id as dtls_id, c.order_uom as uom, c.order_rate as rate, d.id as prod_id 
					from wo_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d 
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.pay_mode=1 $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0");*/
			}
			else
			{
				
				$data_array=sql_select("select a.id, a.booking_no, d.color as fabric_color_id, d.detarmination_id as lib_yarn_count_deter_id, d.gsm as gsm_weight, d.dia_width, c.order_amount as amount, c.order_qnty as fin_fab_qnty, c.id as dtls_id, c.order_uom as uom, c.order_rate as rate, d.id as prod_id
				from wo_non_ord_samp_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d
				where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(17,37) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and   c.is_deleted=0 and d.status_active=1 and d.is_deleted=0");// and c.id in($wo_dtls_id)
			}

			$dtls_data=array();
			foreach($data_array as $row)
			{
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["id"]=$row[csf("id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["prod_id"]=$row[csf("prod_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["booking_no"]=$row[csf("booking_no")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["fabric_color_id"]=$row[csf("fabric_color_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["body_part_id"]=$row[csf("body_part_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["gsm_weight"]=$row[csf("gsm_weight")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["dia_width"]=$row[csf("dia_width")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["fab_weight_type"]=$row[csf("fab_weight_type")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["dia_or_width"]=$row[csf("dia_or_width")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["cutable_width"]=$row[csf("cutable_width")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["lib_yarn_count_deter_id"]=$row[csf("lib_yarn_count_deter_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["uom"]=$row[csf("uom")];
				
				if($dtls_check[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]=="")
				{
					$dtls_check[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]=$row[csf("dtls_id")];
					$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["dtls_id"].=$row[csf("dtls_id")]."_";
				}

				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]["fin_fab_qnty"]=$row[csf("fin_fab_qnty")];
				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]["amount"]=$row[csf("amount")];
			}

			//echo '<pre>';print_r($dtls_data);

			
			foreach($dtls_data as $book_id=>$book_data)
			{
				foreach($book_data as $prod_id=>$row)
				{

					$construction=''; $copmposition='';
					$construction=$construction_arr[$row['lib_yarn_count_deter_id']];
					$copmposition=$composition_arr[$row['lib_yarn_count_deter_id']];

					$body_part    = $lib_body_part_arr[$row['body_part_id']];
					$fabric_color = $color_library[$row['fabric_color_id']];
					$fabric_ref   = $determination_arr[$row['lib_yarn_count_deter_id']]['fabric_ref'];
					$rd_no        = $determination_arr[$row['lib_yarn_count_deter_id']]['rd_no'];
					$fabric_type  = $determination_arr[$row['lib_yarn_count_deter_id']]['fabric_type'];
					$design       = $determination_arr[$row['lib_yarn_count_deter_id']]['design'];
					$weight_type  = $determination_arr[$row['lib_yarn_count_deter_id']]['fab_weight_type'];
					//echo $fabric_color.'system';
					$fab_description=$body_part." ".$fabric_type." ".$construction." ".$design." ".$copmposition;


					//$rtn_qnty=$rate=$prev_pi_qnty=$book_item_qnty=$book_item_amt=0;$trans_data="";
					$rtn_qnty=$rate=$prev_pi_qnty=$book_item_qnty=$book_item_amt=$bl_trans_qnty=$item_amt=$item_rate=0;$trans_data=$all_dtls_id="";

					$trans_id_arr=explode("_",chop($row[("dtls_id")],'_'));
					foreach($trans_id_arr as $trans_id)
					{
						$bl_trans_qnty=number_format(($trans_qnty_data[$book_id][$prod_id][$trans_id]["fin_fab_qnty"]-($rcv_rtn_qnty[$trans_id]+$prev_pi_qty_arr[$trans_id])),2,'.','');
						$item_rate=$trans_qnty_data[$book_id][$prod_id][$trans_id]["amount"]/$trans_qnty_data[$book_id][$prod_id][$trans_id]["fin_fab_qnty"];
						$item_amt=number_format($bl_trans_qnty*$item_rate,2,'.','');
						$trans_data.=$trans_id."_".$bl_trans_qnty."_".$item_amt."_".$prod_id."__";
						$rtn_qnty+=$rcv_rtn_qnty[$trans_id];
						$prev_pi_qnty+=$prev_pi_qty_arr[$trans_id];
						$book_item_qnty+=$trans_qnty_data[$book_id][$prod_id][$trans_id]["fin_fab_qnty"];
						$book_item_amt+=$trans_qnty_data[$book_id][$prod_id][$trans_id]["amount"];
						$all_dtls_id.=$trans_id.",";

					}
					$all_dtls_id=chop($all_dtls_id,",");
					$bl_qty=($book_item_qnty-($rtn_qnty+$prev_pi_qnty));
					$rate=$book_item_amt/$book_item_qnty;
					$amount=$rate*$bl_qty;
					$bl_qty=number_format($bl_qty,6,'.','');

					if($bl_qty>0)
					{
						$tblRow++;
					    ?>
						<tr class="general" id="row_<? echo $tblRow; ?>">
							<td>
								<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" />
							</td>
							<td>
								<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[('booking_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
								<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[('id')]; ?>" readonly />
								<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $all_dtls_id; ?>" readonly />
                                <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="<? echo chop($trans_data,'__'); ?>" readonly />
							</td>
                            <td>
								<input type="text" name="fabricRef[]" id="fabricRef_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $fabric_ref; ?>" style="width:60px" disabled="disabled"/>
							</td>
							<td>
								<input type="text" name="rdNo[]" id="rdNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $rd_no; ?>" style="width:60px" disabled="disabled"/>
							</td>
							<td>
								<input type="text" name="fabDescription[]" id="fabDescription_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $fab_description; ?>" style="width:195px" disabled="disabled"/>
								<input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_<? echo $tblRow; ?>" value="<? echo $row['lib_yarn_count_deter_id']; ?>" readonly />
								<input type="hidden" name="construction[]" id="construction_<? echo $tblRow; ?>" value="<? echo $construction; ?>" readonly />
								<input type="hidden" name="composition[]" id="composition_<? echo $tblRow; ?>" value="<? echo $copmposition; ?>" readonly />
								<input type="hidden" name="bodyPart[]" id="bodyPart_<? echo $tblRow; ?>" value="<? echo $row['body_part_id']; ?>" readonly />
								<input type="hidden" name="fabType[]" id="fabType_<? echo $tblRow; ?>" value="<? echo $fabric_type; ?>" readonly />
								<input type="hidden" name="fabDesign[]" id="fabDesign_<? echo $tblRow; ?>" value="<? echo $design; ?>" readonly />
							</td>
							<td>
								<input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $fabric_color; ?>" style="width:50px" maxlength="50" disabled="disabled"/>
							</td>							

							<td>
								<input type="text" name="fabWeight[]" id="fabWeight_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row['gsm_weight']; ?>" style="width:35px" disabled="disabled"/>
							</td>
							<td>
								<input type="text" name="fabWeightType[]" id="fabWeightType_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $fabric_weight_type[$row[csf('fab_weight_type')]]; ?>" placeholder="<? echo $row['fab_weight_type']; ?>" style="width:40px" readonly />
								<!-- <input type="text" name="weightType[]" id="weightType_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $fabric_weight_type[$row['fab_weight_type']]; ?>" style="width:55px" disabled="disabled"/>
								<input type="hidden" name="fabWeightType[]" id="fabWeightType_<? echo $tblRow; ?>" value="<? echo $row['fab_weight_type']; ?>" readonly /> -->
							</td>
							<td>
								<input type="text" name="diawidthType[]" id="diawidthType_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $fabric_typee[$row['dia_or_width']]; ?>" placeholder="<? echo $row[csf('dia_or_width')]; ?>" style="width:40px" readonly />
								<!-- <input type="text" name="diawidth_type[]" id="diawidth_type_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $fabric_typee[$row['dia_or_width']]; ?>" style="width:55px" disabled="disabled"/>
								<input type="hidden" name="diawidthType[]" id="diawidthType_<? echo $tblRow; ?>" value="<? echo $row['dia_or_width']; ?>" readonly /> -->
							</td>
							<td>
								<input type="text" name="diawidth[]" id="diawidth_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row['dia_width']; ?>" style="width:35px" disabled="disabled"/>
							</td>
							<td>
								<input type="text" name="cutableWidth[]" id="cutableWidth_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row['cutable_width']; ?>" style="width:60px" disabled="disabled"/>
							</td>
							<td>
								<?
								echo create_drop_down( "uom_".$tblRow, 40, $unit_of_measurement,'', 1, 'Select',$row['uom'],'','1', '', '', '', '', '', '', 'uom[]');
								?>
							</td>
							<td>
								<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($bl_qty,6,'.',''); ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" readonly />
							</td>
							<td>
								<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($rate,6,'.',''); ?>" style="width:45px; text-align:right;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" readonly />
							</td>
							<td>
								<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $amount; ?>" style="width:75px; text-align:right;" readonly/>
								<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
								<input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="<? echo $booking_without_order; ?>"/>
							</td>
						</tr>
					    <?
					}

				}

			}

		}
		else
		{

			$booking_id_cond=""; $bokIds_cond=""; $result=explode(",",$wo_dtls_id);
			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" b.id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
				//echo $booking_id_cond;die;
			}
			else
			{
				$booking_id_cond=" and b.id in($wo_dtls_id)";
			}
			
			if($order_type==1)
			{
				//echo "SELECT a.id, a.booking_no, b.fabric_color_id, c.construction as construction, c.composition as copmposition, b.gsm_weight as weight, c.width_dia_type as dia_or_width, b.dia_width as width, b.item_size as cutable_width, sum(b.fin_fab_qnty) as fin_fab_qnty, sum(b.fin_fab_qnty*b.rate) as amount, c.lib_yarn_count_deter_id, c.body_part_id, c.uom from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.id, a.booking_no, b.fabric_color_id, c.construction, c.composition, b.gsm_weight, c.width_dia_type, b.dia_width, b.item_size, c.lib_yarn_count_deter_id, c.body_part_id, c.uom";
				$data_array=sql_select("SELECT a.id, a.booking_no, b.fabric_color_id, c.construction as construction, c.composition as copmposition, b.gsm_weight as weight, c.gsm_weight_type as fab_weight_type, c.width_dia_type as dia_or_width, b.dia_width as width, b.item_size as cutable_width, sum(b.fin_fab_qnty) as fin_fab_qnty, sum(b.fin_fab_qnty*b.rate) as amount, c.lib_yarn_count_deter_id, c.body_part_id, c.uom, 0 as dtls_id
					from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c 
					where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 
					group by a.id, a.booking_no, b.fabric_color_id, c.construction, c.composition, b.gsm_weight, c.gsm_weight_type, c.width_dia_type, b.dia_width, b.item_size, c.lib_yarn_count_deter_id, c.body_part_id, c.uom
					order by a.booking_no, c.body_part_id");

				$sql_deter="SELECT a.id, a.fabric_ref, a.rd_no, a.type, a.design, a.weight_type from lib_yarn_count_determina_mst a";
				$count_data_array=sql_select($sql_deter);
				$determination_arr=array();
				foreach( $count_data_array as $row )
				{
					$determination_arr[$row[csf('id')]]['fabric_ref']=$row[csf('fabric_ref')];
					$determination_arr[$row[csf('id')]]['rd_no']=$row[csf('rd_no')];
					$determination_arr[$row[csf('id')]]['fabric_type']=$row[csf('type')];
					$determination_arr[$row[csf('id')]]['design']=$row[csf('design')];
					//$determination_arr[$row[csf('id')]]['fab_weight_type']=$row[csf('weight_type')];

					/*if(array_key_exists($row[csf('id')],$composition_arr))
					{
						$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('type')]].", ".$row[csf('construction')]." ".$row[csf('design')]." ".$row[csf('fab_composition')];
					}
					else
					{
						$composition_arr[$row[csf('id')]]=$composition[$row[csf('type')]]." ".$row[csf('construction')]." ".$row[csf('design')]." ".$row[csf('fab_composition')];
					}*/
				}
				//echo '<pre>';print_r($determination_arr);
			}
			else
			{		

				$data_array=sql_select("SELECT a.id, a.booking_no, b.fabric_color as fabric_color_id, b.construction as construction, b.composition as copmposition, b.body_part as body_part_id, b.gsm_weight as weight, b.dia_width as dia_or_width, b.item_size as cutable_width, b.uom, sum(b.finish_fabric) as fin_fab_qnty, sum(b.finish_fabric*b.rate) as amount, b.lib_yarn_count_deter_id, 0 as dtls_id
				from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b 
				where a.booking_no=b.booking_no $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0
				group by a.id, a.booking_no, b.fabric_color, b.construction, b.composition, b.body_part, b.gsm_weight, b.dia_width, b.item_size, b.uom, b.lib_yarn_count_deter_id
				order by a.booking_no, b.body_part");

				$sql_deter="SELECT a.id, a.fabric_ref, a.rd_no, a.type, a.design, a.weight_type from lib_yarn_count_determina_mst a";
				$count_data_array=sql_select($sql_deter);
				$determination_arr=array();
				foreach( $count_data_array as $row )
				{
					$determination_arr[$row[csf('id')]]['fabric_ref']=$row[csf('fabric_ref')];
					$determination_arr[$row[csf('id')]]['rd_no']=$row[csf('rd_no')];
					$determination_arr[$row[csf('id')]]['fabric_type']=$row[csf('type')];
					$determination_arr[$row[csf('id')]]['design']=$row[csf('design')];
					/*if(array_key_exists($row[csf('id')],$composition_arr))
					{
						$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('type')]].", ".$row[csf('construction')]." ".$row[csf('design')]." ".$row[csf('fab_composition')];
					}
					else
					{
						$composition_arr[$row[csf('id')]]=$composition[$row[csf('type')]]." ".$row[csf('construction')]." ".$row[csf('design')]." ".$row[csf('fab_composition')];
					}*/
				}
			}

			$disable_data=$checkBox_check="";
			if($goods_rcv_variable==1 && $goods_rcv_status==1)
			{
				$disable_data="disabled='disabled'";
				$checkBox_check="checked";
			}
			// print_r($data_array);die;
			if($order_type==1) $booking_without_order=0; else $booking_without_order=1;
			foreach($data_array as $row)
			{
				$prev_pi=0;
				if($order_type==1)
				{
					$bl_qty=$row[csf('fin_fab_qnty')]-$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('body_part_id')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('weight')]][$row[csf('fab_weight_type')]][$row[csf('dia_or_width')]][$row[csf('width')]][$row[csf('cutable_width')]][$row[csf('uom')]];
					$prev_pi=$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('body_part_id')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('weight')]][$row[csf('fab_weight_type')]][$row[csf('dia_or_width')]][$row[csf('width')]][$row[csf('cutable_width')]][$row[csf('uom')]];

					$construction = $row[csf('construction')];
					$copmposition = $row[csf('copmposition')];
					$body_part    = $lib_body_part_arr[$row[csf('body_part_id')]];
					$fabric_color = $color_library[$row[csf('fabric_color_id')]];
					$fabric_ref   = $determination_arr[$row[csf('lib_yarn_count_deter_id')]]['fabric_ref'];
					$rd_no        = $determination_arr[$row[csf('lib_yarn_count_deter_id')]]['rd_no'];
					$fabric_type  = $determination_arr[$row[csf('lib_yarn_count_deter_id')]]['fabric_type'];
					$design       = $determination_arr[$row[csf('lib_yarn_count_deter_id')]]['design'];
					$weight_type  = $determination_arr[$row[csf('lib_yarn_count_deter_id')]]['fab_weight_type'];

					$fab_description=$body_part." ".$fabric_type." ".$construction." ".$design." ".$copmposition;	
						
				}
				else
				{
					//$bl_qty=$row[csf('fin_fab_qnty')]-$prev_pi_qty_arr[$row[csf('dtls_id')]];
					//$prev_pi=$prev_pi_qty_arr[$row[csf('dtls_id')]];

					$construction = $row[csf('construction')];
					$copmposition = $row[csf('copmposition')];
					$body_part    = $lib_body_part_arr[$row[csf('body_part_id')]];
					$fabric_color = $color_library[$row[csf('fabric_color_id')]];
					$fabric_ref   = $determination_arr[$row[csf('lib_yarn_count_deter_id')]]['fabric_ref'];
					$rd_no        = $determination_arr[$row[csf('lib_yarn_count_deter_id')]]['rd_no'];
					$fabric_type  = $determination_arr[$row[csf('lib_yarn_count_deter_id')]]['fabric_type'];
					$design       = $determination_arr[$row[csf('lib_yarn_count_deter_id')]]['design'];

					$bl_qty=$row[csf('fin_fab_qnty')]-$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('body_part_id')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('weight')]][$row[csf('dia_or_width')]][$row[csf('cutable_width')]][$row[csf('uom')]];
					$prev_pi=$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('body_part_id')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('weight')]][$row[csf('dia_or_width')]][$row[csf('cutable_width')]][$row[csf('uom')]];

					$fab_description=$body_part." ".$fabric_type." ".$construction." ".$design." ".$copmposition;
				}
				//$amnt=number_format($bl_qty*$row[csf('rate')],4,'.','');
				$bl_qty=number_format($bl_qty,6,'.','');
				if($bl_qty>0)
				{
					$tblRow++;
				    ?>
					<tr class="general" id="row_<? echo $tblRow; ?>">
						<td>
							<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" <? echo $checkBox_check; ?> />
						</td>
						<td>
							<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
							<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>" readonly />
							<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('dtls_id')]; ?>" readonly />
                            <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="" readonly />
						</td>
						<td>
							<input type="text" name="fabricRef[]" id="fabricRef_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $fabric_ref; ?>" style="width:60px" disabled="disabled"/>
						</td>
                        <td>
							<input type="text" name="rdNo[]" id="rdNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $rd_no; ?>" style="width:60px" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="fabDescription[]" id="fabDescription_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $fab_description; ?>" style="width:195px" disabled="disabled"/>
							<input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_<? echo $tblRow; ?>" value="<? echo $row[csf('lib_yarn_count_deter_id')]; ?>" readonly />
							<input type="hidden" name="construction[]" id="construction_<? echo $tblRow; ?>" value="<? echo $row[csf('construction')]; ?>" readonly />
							<input type="hidden" name="composition[]" id="composition_<? echo $tblRow; ?>" value="<? echo $row[csf('copmposition')]; ?>" readonly />
							<input type="hidden" name="bodyPart[]" id="bodyPart_<? echo $tblRow; ?>" value="<? echo $row[csf('body_part_id')]; ?>" readonly />
							<input type="hidden" name="fabType[]" id="fabType_<? echo $tblRow; ?>" value="<? echo $fabric_type; ?>" readonly />
							<input type="hidden" name="fabDesign[]" id="fabDesign_<? echo $tblRow; ?>" value="<? echo $design; ?>" readonly />
						</td>						
						
						<td>
							<input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $fabric_color; ?>" style="width:50px" maxlength="50" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="fabWeight[]" id="fabWeight_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('weight')]; ?>" style="width:35px" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="fabWeightType[]" id="fabWeightType_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $fabric_weight_type[$row[csf('fab_weight_type')]]; ?>" placeholder="<? echo $row[csf('fab_weight_type')]; ?>" style="width:40px" readonly />
							<!-- <input type="text" name="weightType[]" id="weightType_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $fabric_weight_type[$row[csf('fab_weight_type')]]; ?>" style="width:55px" disabled="disabled"/>
							<input type="hidden" name="fabWeightType[]" id="fabWeightType_<? echo $tblRow; ?>" value="<? echo $row[csf('fab_weight_type')]; ?>" readonly /> -->
						</td>
						<td>
							<input type="text" name="diawidthType[]" id="diawidthType_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $fabric_typee[$row[csf('dia_or_width')]]; ?>" placeholder="<? echo $row[csf('dia_or_width')]; ?>" style="width:40px" readonly />
							<!-- <input type="text" name="diawidth_type[]" id="diawidth_type_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $fabric_typee[$row[csf('dia_or_width')]]; ?>" style="width:55px" disabled="disabled"/>
							<input type="hidden" name="diawidthType[]" id="diawidthType_<? echo $tblRow; ?>" value="<? echo $row[csf('dia_or_width')]; ?>" readonly /> -->
						</td>
						<td>
							<input type="text" name="diawidth[]" id="diawidth_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('width')]; ?>" style="width:35px" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="cutableWidth[]" id="cutableWidth_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('cutable_width')]; ?>" style="width:60px" disabled="disabled"/>
						</td>
						<td>
                        <input type="text" name="uom[]" id="uom_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $unit_of_measurement[$row[csf('uom')]]; ?>" placeholder="<? echo $row[csf('uom')]; ?>" style="width:40px" readonly />

						</td>
						<td>
							<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($bl_qty,6,'.',''); ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" title="<? echo $prev_pi; ?>" />
						</td>
						<td>
							<? $rate=number_format($row[csf('amount')]/$row[csf('fin_fab_qnty')],6,'.',''); $amnt=number_format($bl_qty*$rate,4,'.',''); ?>
							<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $rate; ?>" style="width:45px; text-align:right;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" <? echo $disable_rate; ?> />
						</td>
						<td>
							<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $amnt; ?>" style="width:75px; text-align:right;" readonly/>
							<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
							<input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="<? echo $booking_without_order; ?>"/>
						</td>
					</tr>
				<?
				}
			}

		}
	}
	else if($item_category_id==14)  // Woven Grey Fabric
	{
		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{

			$construction_arr=array(); $composition_arr=array();
			$sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
			$data_array=sql_select($sql_deter);
			if(count($data_array)>0)
			{
				foreach( $data_array as $row )
				{
					$construction_arr[$row[csf('id')]]=$row[csf('construction')];

					if(array_key_exists($row[csf('id')],$composition_arr))
					{
						$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
					}
					else
					{
						$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
					}
				}
			}

			$booking_id_cond=""; $result=explode(",",$wo_dtls_id);
			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" c.id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
				//echo $booking_id_cond;die;
			}
			else
			{
				$booking_id_cond=" and c.id in($wo_dtls_id)";
			}

			$rcv_rtn_qnty=return_library_array("select recv_trans_id, sum(issue_qnty) as qnty from  inv_mrr_wise_issue_details where entry_form=46 and status_active=1 group by recv_trans_id","recv_trans_id","qnty");

			
			$data_array=sql_select("SELECT a.id, a.booking_no, d.color as fabric_color_id, d.gsm as gsm_weight, d.dia_width, c.order_qnty as fin_fab_qnty, c.order_amount as amount, d.detarmination_id as lib_yarn_count_deter_id, c.id as dtls_id, c.order_uom as uom, c.order_rate as rate, d.id as prod_id 
					from wo_booking_mst a, inv_receive_master b, inv_transaction c, product_details_master d 
					where a.id=b.booking_id and b.id=c.mst_id and b.entry_form in(550) and c.item_category in($item_category_id) and c.prod_id=d.id and b.receive_basis=2 and d.item_category_id in($item_category_id) and a.pay_mode=1 $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0");//and c.id in($wo_dtls_id)
			
			

			$dtls_data=array();
			foreach($data_array as $row)
			{
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["id"]=$row[csf("id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["prod_id"]=$row[csf("prod_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["booking_no"]=$row[csf("booking_no")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["fabric_color_id"]=$row[csf("fabric_color_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["gsm_weight"]=$row[csf("gsm_weight")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["dia_width"]=$row[csf("dia_width")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["lib_yarn_count_deter_id"]=$row[csf("lib_yarn_count_deter_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["uom"]=$row[csf("uom")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["dtls_id"].=$row[csf("dtls_id")]."_";

				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]["fin_fab_qnty"]=$row[csf("fin_fab_qnty")];
				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]["amount"]=$row[csf("amount")];
			}

			if($order_type==1) $booking_without_order=0; else $booking_without_order=1;
			foreach($dtls_data as $book_id=>$book_data)
			{
				foreach($book_data as $prod_id=>$row)
				{

					$construction=''; $copmposition='';
					$construction=$construction_arr[$row[('lib_yarn_count_deter_id')]];
					$copmposition=$composition_arr[$row[('lib_yarn_count_deter_id')]];


					//$rtn_qnty=$rate=$prev_pi_qnty=$book_item_qnty=$book_item_amt=0;$trans_data="";
					$rtn_qnty=$rate=$prev_pi_qnty=$book_item_qnty=$book_item_amt=$bl_trans_qnty=$item_amt=$item_rate=0;$trans_data=$all_dtls_id="";

					$trans_id_arr=explode("_",chop($row[("dtls_id")],'_'));
					foreach($trans_id_arr as $trans_id)
					{
						$bl_trans_qnty=number_format(($trans_qnty_data[$book_id][$prod_id][$trans_id]["fin_fab_qnty"]-($rcv_rtn_qnty[$trans_id]+$prev_pi_qty_arr[$trans_id])),2,'.','');
						$item_rate=$trans_qnty_data[$book_id][$prod_id][$trans_id]["amount"]/$trans_qnty_data[$book_id][$prod_id][$trans_id]["fin_fab_qnty"];
						$item_amt=number_format($bl_trans_qnty*$item_rate,2,'.','');
						$trans_data.=$trans_id."_".$bl_trans_qnty."_".$item_amt."_".$prod_id."__";
						$rtn_qnty+=$rcv_rtn_qnty[$trans_id];
						$prev_pi_qnty+=$prev_pi_qty_arr[$trans_id];
						$book_item_qnty+=$trans_qnty_data[$book_id][$prod_id][$trans_id]["fin_fab_qnty"];
						$book_item_amt+=$trans_qnty_data[$book_id][$prod_id][$trans_id]["amount"];
						$all_dtls_id.=$trans_id.",";

					}
					$all_dtls_id=chop($all_dtls_id,",");
					$bl_qty=($book_item_qnty-($rtn_qnty+$prev_pi_qnty));
					$rate=$book_item_amt/$book_item_qnty;
					$amount=$rate*$bl_qty;
					$bl_qty=number_format($bl_qty,6,'.','');

					if($bl_qty>0)
					{
						$tblRow++;
					    ?>
						<tr class="general" id="row_<? echo $tblRow; ?>">
							<td>
								<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" />
							</td>
							<td>
								<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[('booking_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
								<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[('id')]; ?>" readonly />
								<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $all_dtls_id; ?>" readonly />
                                <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="<? echo chop($trans_data,'__'); ?>" readonly />
							</td>
                            <td>
                                <input type="text" name="hsCode[]" id="hsCode_<? echo $tblRow; ?>" class="text_boxes" value="" style="width:40px;" />
                            </td>
							<td>
								<input type="text" name="construction[]" id="construction_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $construction; ?>" style="width:110px" disabled="disabled"/>
								<input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_<? echo $tblRow; ?>" value="<? echo $row[('lib_yarn_count_deter_id')]; ?>" readonly />
							</td>
							<td>
								<input type="text" name="composition[]" id="composition_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $copmposition; ?>" style="width:120px" disabled="disabled"/>
							</td>
							<td>
								<input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[('fabric_color_id')]]; ?>" style="width:80px" maxlength="50" disabled="disabled"/>
							</td>
							<td>
								<input type="text" name="gsm[]" id="gsm_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[('gsm_weight')]; ?>" style="width:60px" disabled="disabled"/>
							</td>
							<td>
								<input type="text" name="diawidth[]" id="diawidth_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[('dia_width')]; ?>" style="width:70px" disabled="disabled"/>
							</td>
							 <td>
								<?
									echo create_drop_down( "uom_".$tblRow, 60, $unit_of_measurement,'', 1, 'Select',$row[('uom')],'','1', '', '', '', '', '', '', 'uom[]');
								?>
							</td>
							<td>
								<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bl_qty; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" readonly />
							</td>
							<td>
								<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $rate; ?>" style="width:45px; text-align:right;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" readonly />
							</td>
							<td>
								<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $amount; ?>" style="width:75px; text-align:right;" readonly/>
								<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
								<input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="<? echo $booking_without_order; ?>"/>
							</td>
						</tr>
					    <?
					}
				}
			}
		}
		else
		{

			$booking_id_cond=""; $bokIds_cond=""; $result=explode(",",$wo_dtls_id);
			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" b.id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
				//echo $booking_id_cond;die;
			}
			else
			{
				$booking_id_cond=" and b.id in($wo_dtls_id)";
			}

			$sql_mst = "SELECT a.id, a.booking_no, b.fabric_color_id, b.construction as construction, b.copmposition as copmposition, c.body_part_id,c.gsm_weight, b.dia_width, sum(b.fin_fab_qnty) as fin_fab_qnty, sum(b.fin_fab_qnty*b.rate) as amount, c.determination_id as lib_yarn_count_deter_id, c.cons_uom as uom, b.id as dtls_id 
				from wo_booking_mst a, wo_booking_dtls b, fabric_sales_order_dtls c 
				where a.booking_no=b.booking_no  and b.pre_cost_fabric_cost_dtls_id = c.mst_id and b.po_break_down_id = c.id $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 
				group by a.id, a.booking_no, b.fabric_color_id, b.construction, b.copmposition,C.body_part_id, c.gsm_weight, b.dia_width,c.determination_id,c.cons_uom,b.id";
			//echo $sql_mst;
			$data_array=sql_select($sql_mst);  // and b.id in($wo_dtls_id)
			

			$disable_data=$checkBox_check="";
			if($goods_rcv_variable==1 && $goods_rcv_status==1)
			{
				$disable_data="disabled='disabled'";
				$checkBox_check="checked";
			}
			//print_r($data_array);die;
			if($order_type==1) $booking_without_order=0; else $booking_without_order=1;
			foreach($data_array as $row)
			{
				$construction=''; $copmposition='';$fabric_color='';

				$prev_pi=0;
				
				
				$bl_qty=$row[csf('fin_fab_qnty')]-$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('dtls_id')]][$row[csf('body_part_id')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('uom')]];
				$prev_pi=$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('dtls_id')]][$row[csf('body_part_id')]][$row[csf('lib_yarn_count_deter_id')]][$row[csf('fabric_color_id')]][$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('uom')]];
				$construction=$row[csf('construction')];
				$copmposition=$row[csf('copmposition')];
				$fabric_color=$color_library[$row[csf('fabric_color_id')]];
				$body_part_id = $row[csf('body_part_id')];
				
				//$amnt=number_format($bl_qty*$row[csf('rate')],4,'.','');
				$bl_qty=number_format($bl_qty,6,'.','');
				if($bl_qty>0)
				{
					$tblRow++;
				    ?>
					<tr class="general" id="row_<? echo $tblRow; ?>">
						<td>
							<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" <? echo $checkBox_check; ?> />
						</td>
						<td>
							<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
							<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>" readonly />
							<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('dtls_id')]; ?>" readonly />
                            <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="" readonly />
						</td>
                        <td>
                            <input type="text" name="hsCode[]" id="hsCode_<? echo $tblRow; ?>" class="text_boxes" value="" style="width:40px;" />
                        </td>
						<td>
							<input type="text" name="construction[]" id="construction_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $construction; ?>" style="width:110px" disabled="disabled"/>
							<input type="hidden" name="hideDeterminationId[]" id="hideDeterminationId_<? echo $tblRow; ?>" value="<? echo $row[csf('lib_yarn_count_deter_id')]; ?>" readonly />
							<input type="hidden" name="bodyPart[]" id="bodyPart_<? echo $tblRow; ?>" value="<? echo $body_part_id; ?>" readonly />
						</td>
						<td>
							<input type="text" name="composition[]" id="composition_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $copmposition; ?>" style="width:120px" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('fabric_color_id')]]; ?>" style="width:80px" maxlength="50" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="gsm[]" id="gsm_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('gsm_weight')]; ?>" style="width:60px" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="diawidth[]" id="diawidth_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('dia_width')]; ?>" style="width:70px" disabled="disabled"/>
						</td>
						<td>
                        <input type="text" name="uom[]" id="uom_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $unit_of_measurement[$row[csf('uom')]]; ?>" placeholder="<? echo $row[csf('uom')]; ?>" style="width:50px" readonly />

						</td>
						<td>
							<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bl_qty; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" title="<? echo $prev_pi; ?>" />
						</td>
						<td>
							<? $rate=number_format($row[csf('amount')]/$row[csf('fin_fab_qnty')],4,'.',''); $amnt=number_format($bl_qty*$rate,4,'.',''); ?>
							<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $rate; ?>" style="width:45px; text-align:right;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" <? echo $disable_rate; ?> />
						</td>
						<td>
							<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $amnt; ?>" style="width:75px; text-align:right;" readonly/>
							<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
							<input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="<? echo $booking_without_order; ?>"/>
						</td>
					</tr>
				<?
				}
			}

		}
	}

	else if($item_category_id==4)  // Accessories
	{
		//echo "test";die;
		$item_group_arr=return_library_array("SELECT id,item_name FROM lib_item_group WHERE item_category=4 AND status_active=1 and is_deleted=0",'id','item_name');
		
		if($order_type==1) $booking_without_order=0; else $booking_without_order=1;
		//echo $goods_rcv_status."==".$goods_rcv_variable."==".$order_type;die;
		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{
			$prev_retun_qnty=array();
			$order_arr=array();
			$booking_ids_cond=$bookingIds_cond=""; $result=explode(",",$wo_dtls_id);
			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bookingIds_cond.=" b.trans_id in($chunk_arr_value) or ";
				}

				$booking_ids_cond=" and (".chop($bookingIds_cond,'or ').")";
				//echo $booking_id_cond;die;
			}
			else
			{
				$booking_ids_cond=" and b.trans_id in($wo_dtls_id)";
			}

			if($order_type==1)
			{
				$sql_order_res=sql_select("select a.style_ref_no, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
				foreach ($sql_order_res as $row) {
					$order_arr[$row[csf("id")]]['po_number']=$row[csf("po_number")];
					$order_arr[$row[csf("id")]]['style_ref_no']=$row[csf("style_ref_no")];
				}
				$conver_factor=return_library_array("select a.id, b.conversion_factor from product_details_master a, lib_item_group b where a.item_group_id=b.id and a.entry_form=24","id","conversion_factor");
				$prev_retun_sql="select a.booking_id, a.prod_id, b.quantity, b.po_breakdown_id as order_id from inv_trims_issue_dtls a, order_wise_pro_details b where a.trans_id=b.trans_id and b.entry_form=73 and b.trans_type=4 and a.booking_id>0 and a.status_active=1 and b.status_active=1";
				$prev_retun_sql_result=sql_select($prev_retun_sql);
				foreach($prev_retun_sql_result as $row)
				{
					$prev_retun_qnty[$row[csf("booking_id")]][$row[csf("prod_id")]][$row[csf("order_id")]]+=$row[csf("quantity")]/$conver_factor[$row[csf("prod_id")]];
				}
				//$prev_retun_qnty
				$sql_trims=("select a.id, a.booking_no, d.trans_id as trans_id, b.item_group_id as trim_group, b.item_description as description, b.order_uom as uom, b.gmts_color_id as color_number_id, b.item_color as item_color, b.gmts_size_id as size_id, b.item_size, b.brand_supplier, d.id as propor_id, d.po_breakdown_id as order_id, d.prod_id, d.order_rate as rate, d.quantity as qnty, d.order_amount
				from wo_booking_mst a, inv_trims_entry_dtls b, inv_receive_master c, order_wise_pro_details d
				where c.id=b.mst_id and a.id=b.booking_id and b.id=d.dtls_id and b.trans_id=d.trans_id $booking_ids_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0");// and d.id in ($wo_dtls_id)
			}
			else
			{
				$sql_trims=("select a.id, a.booking_no, d.id as trans_id, b.item_group_id as trim_group, b.item_description as description, b.order_uom as uom, b.gmts_color_id as color_number_id, b.item_color as item_color, b.gmts_size_id as size_id, b.item_size, b.brand_supplier, 0 as propor_id, 0 as order_id, d.prod_id, d.order_rate as rate, d.order_qnty as qnty, d.order_amount
				from wo_non_ord_samp_booking_mst a, inv_trims_entry_dtls b, inv_receive_master c, inv_transaction d
				where c.id=b.mst_id and a.id=c.booking_id and c.id=d.mst_id and d.id=b.trans_id $booking_ids_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0");// and d.id in($wo_dtls_id)
			}

			//echo($prev_retun_qnty[8278][9228]);die;

			$data_array=sql_select($sql_trims);
			$dtls_data=array();
			foreach($data_array as $row)
			{
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["id"]=$row[csf("id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["booking_no"]=$row[csf("booking_no")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["trim_group"]=$row[csf("trim_group")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["description"]=$row[csf("description")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["uom"]=$row[csf("uom")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["color_number_id"]=$row[csf("color_number_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["item_color"]=$row[csf("item_color")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["size_id"]=$row[csf("size_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["item_size"]=$row[csf("item_size")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["brand_supplier"]=$row[csf("brand_supplier")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["order_id"]=$row[csf("order_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["prod_id"]=$row[csf("prod_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["qnty"]+=$row[csf("qnty")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["order_amount"]+=$row[csf("order_amount")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["trans_id"].=$row[csf("trans_id")]."_";
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]]["propor_id"]=$row[csf("propor_id")];

				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]][$row[csf("trans_id")]]["trans_qnty"]=$row[csf("qnty")];
				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("order_id")]][$row[csf("trans_id")]]["order_amount"]=$row[csf("order_amount")];
			}
			//echo '<pre>';print_r($dtls_data);echo '<pre>';print_r($trans_qnty_data);


			foreach($dtls_data as $book_id=>$row_val)
			{
				foreach($row_val as $pord_id=>$row_order)
				{
					foreach($row_order as $order_id=>$row)
					{						

						$rtn_qnty=$rate=$prev_pi_qnty=$book_item_qnty=$book_item_amt=$bl_trns_qnty=$item_rate=$item_amt=0;$trans_id_arr=$trans_data_arr=array();$trans_data=$all_dtls_id="";

						$trans_id_arr=explode("_",chop($row[("trans_id")],'_'));
						foreach($trans_id_arr as $trans_id)
						{
							//$dtls_data[$book_id][$pord_id][$trans_id]["trans_qnty"]-$prev_pi_qty_arr[$trans_id];
							if($trans_qnty_data[$book_id][$pord_id][$order_id][$trans_id]["trans_qnty"]>$prev_retun_qnty[$book_id][$pord_id][$order_id])
							{
								//$trans_qnty_data[$book_id][$pord_id][$trans_id]["trans_qnty"]=
								$bl_trns_qnty=number_format(($trans_qnty_data[$book_id][$pord_id][$order_id][$trans_id]["trans_qnty"]-($prev_retun_qnty[$book_id][$pord_id][$order_id]+$prev_pi_qty_arr[$trans_id])),2,'.','');
								$item_rate=$trans_qnty_data[$book_id][$pord_id][$order_id][$trans_id]["order_amount"]/$trans_qnty_data[$book_id][$pord_id][$order_id][$trans_id]["trans_qnty"];
								$item_amt=number_format($bl_trns_qnty*$item_rate,2,'.','');

								$rtn_qnty+=$prev_retun_qnty[$book_id][$pord_id][$order_id];
								if ($order_type==1)
								{
									$all_dtls_id.=$trans_id.",";
									$trans_data.=$trans_id."_".$bl_trns_qnty."_".$item_amt."_".$pord_id."_".$order_id."__";
								}
								else
								{
									$all_dtls_id.=$trans_id.",";
									$trans_data.=$trans_id."_".$bl_trns_qnty."_".$item_amt."_".$pord_id."_".$order_id."__";
								}	
								$prev_retun_qnty[$book_id][$pord_id][$order_id]=0;

							}
							else
							{
								//$trans_qnty_data[$book_id][$pord_id][$trans_id]["trans_qnty"]=
								$bl_trns_qnty=number_format(($trans_qnty_data[$book_id][$pord_id][$order_id][$trans_id]["trans_qnty"]-($trans_qnty_data[$book_id][$pord_id][$order_id][$trans_id]["trans_qnty"]+$prev_pi_qty_arr[$trans_id])),2,'.','');
								$item_rate=$trans_qnty_data[$book_id][$pord_id][$order_id][$trans_id]["order_amount"]/$trans_qnty_data[$book_id][$pord_id][$order_id][$trans_id]["trans_qnty"];
								$item_amt=number_format($bl_trns_qnty*$item_rate,2,'.','');								
								$rtn_qnty+=$trans_qnty_data[$book_id][$pord_id][$order_id][$trans_id]["trans_qnty"];
								$prev_retun_qnty[$book_id][$pord_id][$order_id]=$prev_retun_qnty[$book_id][$pord_id][$order_id]-$trans_qnty_data[$book_id][$pord_id][$order_id][$trans_id]["trans_qnty"];
								if ($order_type==1)
								{
									$trans_data.=$trans_id."_".$bl_trns_qnty."_".$item_amt."_".$pord_id."_".$order_id."__";
									$all_dtls_id.=$trans_id.",";
								}
								else
								{
									$trans_data.=$trans_id."_".$bl_trns_qnty."_".$item_amt."_".$pord_id."_".$order_id."__";
									$all_dtls_id.=$trans_id.",";
								}
								

							}
							$book_item_qnty+=$trans_qnty_data[$book_id][$pord_id][$order_id][$trans_id]["trans_qnty"];
							$book_item_amt+=$trans_qnty_data[$book_id][$pord_id][$order_id][$trans_id]["order_amount"];
							$prev_pi_qnty+=$prev_pi_qty_arr[$trans_id];

						}
						$all_dtls_id=chop($all_dtls_id,",");
						$bl_qty=($book_item_qnty-($rtn_qnty+$prev_pi_qnty));
						$rate=$book_item_amt/$book_item_qnty;
						$amount=$rate*$bl_qty;

						$bl_qty=number_format($bl_qty,6,'.','');
						//echo $bl_qty.'=';
						if($bl_qty>0)
						{
							$tblRow++;
							$bgcolor=($tblRow%2==0)? "#E9F3FF":"#FFFFFF";
							?>
							<tr bgcolor="<?=$bgcolor; ?>" id="row_<? echo $tblRow; ?>">
								<td width="20">
									<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" />
								</td>
								<td width="80">
									<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[('booking_no')]; ?>" style="width:80px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
									<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[('id')]; ?>" readonly />
									<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $all_dtls_id; ?>" readonly />
									<input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="<? echo chop($trans_data,'__'); ?>" readonly />
	                                <input type="hidden" name="itemProdId[]" id="itemProdId_<? echo $tblRow; ?>" value="<? echo $pord_id; ?>" readonly />
	                                <input type="hidden" name="hidePoId[]" id="hidePoId_<? echo $tblRow; ?>" value="<? echo $row[('order_id')]; ?>" readonly />
								</td>
								<td width="60" id="poNo_<? echo $tblRow; ?>" title="<? echo $row[csf('item_ref')]; ?>"><? echo $order_arr[$row[('order_id')]]['po_number']; ?></td>
								<td width="60" id="styleRef_<? echo $tblRow; ?>"><? echo $order_arr[$row[('order_id')]]['style_ref_no']; ?></td>
	                            <td width="50">
	                                <input type="text" name="hsCode[]" id="hsCode_<? echo $tblRow; ?>" class="text_boxes" value="" style="width:40px;" />
	                            </td>
								<td width="120" id="itemgroupid_<? echo $tblRow; ?>" title="<? echo $row[('trim_group')]?>"><? echo $item_group_arr[$row[('trim_group')]];?>
									<?
										//echo create_drop_down( "itemgroupid_".$tblRow, 70, $item_group_arr,'', 1, '-Select-',$row[('trim_group')],"get_php_form_data( this.value+'**'+'uom_$tblRow', 'get_uom', 'requires/pi_controller_urmi' );",1, '', '', '', '', '', '', 'itemgroupid[]');
									?>
								</td>
								<td width="120" id="itemdescription_<? echo $tblRow; ?>"><? echo $row[('description')]; ?></td>
								<td width="70" id="brandSupRef_<? echo $tblRow; ?>"><? echo $row[('brand_supplier')]; ?></td>
								<td width="70" id="colorName_<? echo $tblRow; ?>"><? echo $color_library[$row[('color_number_id')]]; ?></td>
								<td width="70" id="sizeName_<? echo $tblRow; ?>"><? echo $size_library[$row[('size_id')]]; ?></td>
								<td width="70" id="itemColor_<? echo $tblRow; ?>"><? echo $color_library[$row[('item_color')]]; ?></td>
								<td width="60" id="itemSize_<? echo $tblRow; ?>"><? echo $row[('item_size')]; ?></td>
								<td width="50" id="uom_<? echo $tblRow; ?>" title="<? echo $row[('uom')];?>"><? echo $unit_of_measurement[$row[('uom')]]; ?></td>
								<td width="70">
									<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($bl_qty,6,'.',''); ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo number_format($bl_qty,6,'.',''); ?>" />
								</td>
								<td width="50">
									<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($rate,6,'.',''); ?>" style="width:45px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" readonly />
								</td>
								<td>
									<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($amount,6,'.',''); ?>" style="width:75px;" readonly />
									<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
									<input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="<? echo $booking_without_order; ?>"/>
								</td>
							</tr>
						<?
						}
					}
				}
			}

		}
		else
		{
			//echo $goods_rcv_status."==".$goods_rcv_variable.nahid;die;
			$booking_ids_cond=$bookingIds_cond=""; $result=explode(",",$wo_dtls_id);

			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bookingIds_cond.=" b.id in($chunk_arr_value) or ";
				}

				$booking_ids_cond=" and (".chop($bookingIds_cond,'or ').")";
				//echo $booking_ids_cond;die;
			}
			else
			{
				$booking_ids_cond=" and b.id in($wo_dtls_id)";
			}

			$order_arr=array();

			if($order_type==1)
			{				
				$sql_trims=("SELECT a.id, a.booking_no, b.id as dtls_id, b.po_break_down_id as order_id, b.trim_group, b.uom, c.description, c.rate, c.color_number_id, c.item_color, c.gmts_sizes as size_id, c.item_size, c.brand_supplier, c.item_ref, sum(c.cons) as qnty 
				from wo_booking_mst a, wo_booking_dtls b, wo_trim_book_con_dtls c 
				where a.booking_no=b.booking_no and b.booking_no=c.booking_no and b.booking_no=c.booking_no and b.id=c.wo_trim_booking_dtls_id $booking_ids_cond and c.cons>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and  c.is_deleted=0
				group by a.id, a.booking_no, b.id, b.po_break_down_id, b.trim_group, b.uom, c.description, c.rate, c.color_number_id, c.item_color, c.gmts_sizes, c.item_size, c.brand_supplier, c.item_ref");// and b.id in($wo_dtls_id)
					
				$sql_order_res=sql_select("select a.style_ref_no, b.id, b.po_number, b.grouping as ref_no 
				from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
				foreach ($sql_order_res as $row) {
					$order_arr[$row[csf("id")]]['po_number']=$row[csf("po_number")];
					$order_arr[$row[csf("id")]]['style_ref_no']=$row[csf("style_ref_no")];
					$order_arr[$row[csf("id")]]['ref_no']=$row[csf("ref_no")];
				}
				/*foreach ($data_array as $val) {
					$order_ids.=$val[csf('order_id')].',';
				}
				$order_ids = implode(',',array_unique(explode(',',chop($order_ids,',')))); 
				$order_arr=return_library_array("SELECT id,po_number FROM wo_po_break_down WHERE id in($order_ids) and status_active=1 and is_deleted=0",'id','po_number');*/
			}
			else
			{
				$sql_trims=("select a.id, a.booking_no, b.id as dtls_id, 0 as order_id, b.trim_group, b.fabric_description as description, b.uom, b.rate, b.trim_qty as qnty, b.gmts_color as color_number_id, b.fabric_color as item_color, b.gmts_size as size_id, b.item_size, b.barnd_sup_ref as brand_supplier
				from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b
				where a.booking_no=b.booking_no $booking_ids_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");// and b.id in($wo_dtls_id)				
			}
			//echo $sql_trims;die;
			$data_array=sql_select($sql_trims);


			$disable_data=$checkBox_check="";
			if($goods_rcv_variable==1 && $goods_rcv_status==1)

			{
				$disable_data="disabled='disabled'";
				$checkBox_check="checked";
			}


			foreach($data_array as $row)
			{
				//echo $order_type.test;die;
				if($order_type==1)
				{
					//$bl_qty=$row[csf('qnty')]-$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('dtls_id')]][$row[csf('color_number_id')]][$row[csf('trim_group')]][$row[csf('description')]][$row[csf('size_id')]][$row[csf('item_color')]][$row[csf('item_size')]][$row[csf('brand_supplier')]][$row[csf('uom')]][$row[csf('rate')]];
					$bl_qty=$row[csf('qnty')]-$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('dtls_id')]][$row[csf('order_id')]][$row[csf('color_number_id')]][$row[csf('trim_group')]][$row[csf('description')]][$row[csf('size_id')]][$row[csf('item_color')]][$row[csf('item_size')]][$row[csf('brand_supplier')]][$row[csf('uom')]];
				}
				else
				{
					$bl_qty=$row[csf('qnty')]-$prev_pi_qty_arr[$row[csf('booking_no')]][$row[csf('dtls_id')]];
					//echo $row[csf('qnty')].'**'.$prev_pi_qty_arr[$row[csf('dtls_id')]].'**'.$bl_qty.'system';
				}

				//$bl_qty=$row[csf('qnty')]-$prev_pi_qty_arr[$row[csf('dtls_id')]];
				$amount=$row[csf('rate')]*$bl_qty;
				$bl_qty=number_format($bl_qty,6,'.','');
				if($bl_qty>0)
				{
					$tblRow++;
					$bgcolor=($tblRow%2==0)? "#E9F3FF":"#FFFFFF";
					?>
					<tr bgcolor="<?=$bgcolor; ?>" id="row_<? echo $tblRow; ?>">
						<td width="20">
							<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" <? //echo $checkBox_check; ?> />
						</td>
						<td width="80">
							<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:80px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
							<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>" readonly />
							<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('dtls_id')]; ?>" readonly />
							<input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="" readonly />
                            <input type="hidden" name="itemProdId[]" id="itemProdId_<? echo $tblRow; ?>" value="" readonly />
                            <input type="hidden" name="hidePoId[]" id="hidePoId_<? echo $tblRow; ?>" value="<? echo $row[csf('order_id')]; ?>" readonly />
						</td>
						<td width="70" id="poNo_<? echo $tblRow; ?>" title="<? echo $row[csf('item_ref')]; ?>"><? echo $order_arr[$row[csf('order_id')]]['po_number']; ?></td>
						<td width="70" id="styleRef_<? echo $tblRow; ?>"><? echo $order_arr[$row[csf('order_id')]]['style_ref_no']; ?></td>
                        <td width="50">
                            <input type="text" name="hsCode[]" id="hsCode_<? echo $tblRow; ?>" class="text_boxes" value="" style="width:40px;" />
                        </td>
						<td width="120" id="itemgroupid_<? echo $tblRow; ?>" title="<? echo $row[csf('trim_group')]; ?>"><? echo $item_group_arr[$row[csf('trim_group')]]; ?></td>
						<td width="120" id="itemdescription_<? echo $tblRow; ?>"><? echo $row[csf('description')]; ?></td>
						<td width="70" id="brandSupRef_<? echo $tblRow; ?>"><? echo $row[csf('brand_supplier')]; ?></td>
						<td width="70" id="colorName_<? echo $tblRow; ?>"><? echo $color_library[$row[csf('color_number_id')]]; ?></td>
						<td width="70" id="sizeName_<? echo $tblRow; ?>"><? echo $size_library[$row[csf('size_id')]]; ?></td>
						<td width="70" id="itemColor_<? echo $tblRow; ?>"><? echo $color_library[$row[csf('item_color')]]; ?></td>
						<td width="60" id="itemSize_<? echo $tblRow; ?>"><? echo $row[csf('item_size')]; ?></td>
						<td width="60"id="uom_<? echo $tblRow; ?>" title="<? echo $row[csf('uom')];?>"><? echo $unit_of_measurement[$row[csf('uom')]]; ?></td>
						<td width="70">
							<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($bl_qty,6,'.',''); ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo number_format($bl_qty,6,'.',''); ?>" title="<? echo $bl_qty; ?>" <? //echo $disable_data;?> />
						</td>
						<td width="50">
							<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($row[csf('rate')],6,'.',''); ?>" style="width:45px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" <? echo $disable_rate; ?> />
						</td>
						<td>
							<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($amount,6,'.',''); ?>" style="width:75px;" readonly />
							<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
							<input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="<? echo $booking_without_order; ?>"/>
						</td>
					</tr>
				<?
				}
			}
		}
		//echo $sql_trims;//die;
	}

	else if($item_category_id==12) // Services - Fabric
	{
		$descArray=array();
		$descData=sql_select( "select id, body_part_id, color_type_id, construction, composition from wo_pre_cost_fabric_cost_dtls" );
		foreach($descData as $descRow)
		{
			$descArray[$descRow[csf('id')]]['bp']=$descRow[csf('body_part_id')];
			$descArray[$descRow[csf('id')]]['ct']=$descRow[csf('color_type_id')];
			$descArray[$descRow[csf('id')]]['con']=$descRow[csf('construction')];
			$descArray[$descRow[csf('id')]]['com']=$descRow[csf('composition')];
		}

		/*$col_sizeArr=array();
		$col_sizeData=sql_select( "select id, color_number_id, size_number_id from wo_po_color_size_breakdown" );
		foreach($col_sizeData as $colSizeRow)
		{
			$col_sizeArr[$colSizeRow[csf('id')]]['color']=$colSizeRow[csf('color_number_id')];
			$col_sizeArr[$colSizeRow[csf('id')]]['size']=$colSizeRow[csf('size_number_id')];
		}*/

		//$data_array=sql_select("select a.id, a.booking_no, b.id as dtls_id, b.process, b.uom, b.color_size_table_id, b.fabric_color_id, b.item_size, b.wo_qnty as qnty, b.rate, b.amount, c.fabric_description from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fab_conv_cost_dtls c where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and b.id in($wo_dtls_id)");
		//echo $order_type;//die;
		
		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{
			$booking_id_cond=$bokIds_cond=""; $result=array_unique(explode(",",$wo_dtls_id));

			//echo count($result).$booking_id_cond;die;
			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" b.id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
				//echo $booking_id_cond;die;
			}
			else
			{
				$booking_id_cond=" and b.id in($wo_dtls_id)";
			}
			
			if($order_type==1)
			{
				
				$data_array=sql_select("SELECT a.id, a.booking_no, b.id as dtls_id, b.process, b.uom, b.gmts_size, b.gmts_color_id, b.fabric_color_id, b.item_size, e.batch_issue_qty as qnty, e.rate, e.amount, c.fabric_description 
				from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fab_conv_cost_dtls c, inv_receive_mas_batchroll d, pro_grey_batch_dtls e
				where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and d.entry_form=92 and d.id=e.mst_id and a.id=e.booking_id and b.id=e.booking_dtls_id $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and  c.is_deleted=0 and d.status_active=1 and e.status_active=1");
				$booking_without_order=0;
			}
			/* else
			{
				if($order_type==2)
				{
					$data_array=sql_select("SELECT a.id, a.wo_no as booking_no, b.id as dtls_id, 35 as process, b.uom, 0 as gmts_size, 0 as gmts_color_id, 0 as fabric_color_id, null as item_size, b.wo_qty as qnty, b.rate, b.amount, b.fabric_description from wo_non_ord_aop_booking_mst a, wo_non_ord_aop_booking_dtls b where a.id=b.wo_id $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
				}
				else
				{
					$data_array=sql_select("SELECT a.id, a.booking_no as booking_no, b.id as dtls_id, b.process_id as process, b.uom, 0 as gmts_size, 0 as gmts_color_id, 0 as fabric_color_id, null as item_size, b.wo_qty as qnty, b.rate, b.amount, b.fab_des_id as fabric_description from wo_non_ord_knitdye_booking_mst a, wo_non_ord_knitdye_booking_dtl b where a.id=b.mst_id $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
				}

				$booking_without_order=1;
			} */

			$dtls_data=array();
			foreach($data_array as $row)
			{
				$dtls_data[$row[csf("dtls_id")]]["id"]=$row[csf("id")];
				$dtls_data[$row[csf("dtls_id")]]["booking_no"]=$row[csf("booking_no")];
				$dtls_data[$row[csf("dtls_id")]]["dtls_id"]=$row[csf("dtls_id")];
				$dtls_data[$row[csf("dtls_id")]]["process"]=$row[csf("process")];
				$dtls_data[$row[csf("dtls_id")]]["uom"]=$row[csf("uom")];
				$dtls_data[$row[csf("dtls_id")]]["gmts_size"]=$row[csf("gmts_size")];
				$dtls_data[$row[csf("dtls_id")]]["gmts_color_id"]=$row[csf("gmts_color_id")];
				$dtls_data[$row[csf("dtls_id")]]["fabric_color_id"]=$row[csf("fabric_color_id")];
				$dtls_data[$row[csf("dtls_id")]]["item_size"]=$row[csf("item_size")];
				$dtls_data[$row[csf("dtls_id")]]["qnty"]+=$row[csf("qnty")];
				$dtls_data[$row[csf("dtls_id")]]["rate"]=$row[csf("rate")];
				$dtls_data[$row[csf("dtls_id")]]["amount"]+=$row[csf("amount")];
				$dtls_data[$row[csf("dtls_id")]]["fabric_description"]=$row[csf("fabric_description")];
			}

			foreach($dtls_data as $row)
			{
				if($row['fabric_description']==0)
				{
					$desc="All Fabrics";
				}
				else
				{
					//$descArrray=sql_select( "select body_part_id, color_type_id, construction, composition from wo_pre_cost_fabric_cost_dtls where id='$row[fabric_description]'" );
					$desc=$body_part[$descArray[$row['fabric_description']]['bp']].", ".$color_type[$descArray[$row['fabric_description']]['ct']].", ".$descArray[$row['fabric_description']]['con'].", ".$descArray[$row['fabric_description']]['com'];
				}

				$bl_qty=$row['qnty']-$prev_pi_qty_arr[$row['dtls_id']];
				$rate=$row['amount']/$row['qnty'];
				$amount=number_format($rate*$bl_qty,4,'.','');
				$bl_qty=number_format($bl_qty,6,'.','');

				if($bl_qty>0)
				{
					$tblRow++;
					?>
					<tr class="general" id="row_<?=$tblRow; ?>">
						<td>
							<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<?=$tblRow; ?>" value="" />
						</td>
						<td>
							<input type="text" name="workOrderNo[]" id="workOrderNo_<?=$tblRow; ?>" class="text_boxes" value="<?=$row['booking_no']; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<?=$tblRow; ?>);" readonly />
							<input type="hidden" name="hideWoId[]" id="hideWoId_<?=$tblRow; ?>" value="<?=$row['id']; ?>" readonly />
							<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<?=$tblRow; ?>" value="<?=$row['dtls_id']; ?>" readonly />
						</td>
						<td>
							<?=create_drop_down( "servicetype_".$tblRow, 110, $conversion_cost_head_array,'', 1,'-Select-',$row['process'],"",1, '', '', '', '', '', '', 'servicetype[]'); ?>
						</td>
						<td>
							<input type="text" name="itemdescription[]" id="itemdescription_<?=$tblRow; ?>" class="text_boxes" value="<?=$desc; ?>" style="width:150px" maxlength="200" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="colorName[]" id="colorName_<?=$tblRow; ?>" class="text_boxes" style="width:80px" maxlength="50" value="<?=$color_library[$row['gmts_color_id']]; ?>" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="sizeName[]" id="sizeName_<?=$tblRow; ?>" class="text_boxes" value="<?=$size_library[$row['gmts_size']]; ?>" style="width:70px;" maxlength="50" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="itemColor[]" id="itemColor_<?=$tblRow; ?>" class="text_boxes" value="<?=$color_library[$row['fabric_color_id']]; ?>" style="width:80px" maxlength="50" disabled="disabled"/>
						</td>
						<td>

							<input type="text" name="itemSize[]" id="itemSize_<?=$tblRow; ?>" class="text_boxes" value="<?=$row['item_size']; ?>" style="width:70px;" maxlength="50" disabled="disabled"/>
						</td>
						<td>
							<?
								echo create_drop_down( "uom_".$tblRow, 60, $unit_of_measurement,'', 0, '',$row['uom'],'',1, '', '', '', '', '', '', 'uom[]');
							?>
						</td>
						<td>
							<input type="text" name="quantity[]" id="quantity_<?=$tblRow; ?>" class="text_boxes_numeric" value="<?=$bl_qty; ?>" style="width:61px;" onKeyUp="calculate_amount(<?=$tblRow; ?>)" placeholder="<?=$bl_qty; ?>" />
						</td>
						<td>
							<input type="text" name="rate[]" id="rate_<?=$tblRow; ?>" class="text_boxes_numeric" value="<?=$rate; ?>" style="width:45px;" onKeyUp="calculate_amount(<?=$tblRow; ?>)" <?=$disable_rate; ?> />
						</td>
						<td>
							<input type="text" name="amount[]" id="amount_<?=$tblRow; ?>" class="text_boxes_numeric" value="<?=$amount; ?>" style="width:75px;" readonly/>
							<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<?=$tblRow; ?>" readonly value=""/>
							<input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<?=$tblRow; ?>" value="<?=$booking_without_order; ?>"/>
						</td>
					</tr>
					<?
				}
			}
		}
		else
		{
			$booking_id_cond=$bokIds_cond=""; $result=array_unique(explode(",",$wo_dtls_id));
			//echo count($result).$booking_id_cond;die;
			if($db_type==2 && count($result)>999)
			{
				$booking_id_chunk_arr=array_chunk($result,999) ;
				foreach($booking_id_chunk_arr as $chunk_arr)
				{
					$chunk_arr_value=implode(",",$chunk_arr);
					$bokIds_cond.=" b.id in($chunk_arr_value) or ";
				}

				$booking_id_cond.=" and (".chop($bokIds_cond,'or ').")";
				//echo $booking_id_cond;die;
			}
			else
			{
				$booking_id_cond=" and b.id in($wo_dtls_id)";
			}
			
			if($order_type==1)
			{
				$data_array=sql_select("SELECT a.id, a.booking_no, b.id as dtls_id, b.process, b.uom, b.gmts_size, b.gmts_color_id, b.fabric_color_id, b.item_size, b.wo_qnty as qnty, b.rate, b.amount, c.fabric_description from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fab_conv_cost_dtls c where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and  c.is_deleted=0");
				$booking_without_order=0;
			}
			else if($order_type==4)
			{
				$data_array=sql_select("SELECT a.id, a.wo_no as booking_no, b.id as dtls_id, 1 as process, 12 as uom, 0 as gmts_size, 0 as gmts_color_id, 0 as fabric_color_id, null as item_size, b.wo_qty as qnty, b.rate, b.amount, b.fabric_desc as fabric_description, 4 as type from knitting_work_order_mst a, knitting_work_order_dtls b where a.id=b.mst_id $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
			}
			else if($order_type==5)
			{
				$data_array=sql_select("SELECT a.id, a.do_no as booking_no, b.id as dtls_id, 31 as process, 12 as uom, 0 as gmts_size, 0 as gmts_color_id, 0 as fabric_color_id, null as item_size, b.wo_qty as qnty, b.rate, b.amount, b.fabric_desc as fabric_description, 5 as type from dyeing_work_order_mst a, dyeing_work_order_dtls b where a.id=b.mst_id $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

				$composition_arr=array(); $construction_arr=array();
				$sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
				$sql_deter_res=sql_select($sql_deter);
				foreach( $sql_deter_res as $row )
				{
					$construction_arr[$row[csf('id')]]=$row[csf('construction')];
					$composition_arr[$row[csf('id')]].=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ";
				}
			}			
			else
			{
				if($order_type==2)
				{
					$data_array=sql_select("SELECT a.id, a.wo_no as booking_no, b.id as dtls_id, 35 as process, b.uom, 0 as gmts_size, 0 as gmts_color_id, 0 as fabric_color_id, null as item_size, b.wo_qty as qnty, b.rate, b.amount, b.fabric_description from wo_non_ord_aop_booking_mst a, wo_non_ord_aop_booking_dtls b where a.id=b.wo_id $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
				}
				else
				{
					$data_array=sql_select("SELECT a.id, a.booking_no as booking_no, b.id as dtls_id, b.process_id as process, b.uom, 0 as gmts_size, 0 as gmts_color_id, 0 as fabric_color_id, null as item_size, b.wo_qty as qnty, b.rate, b.amount, b.fab_des_id as fabric_description from wo_non_ord_knitdye_booking_mst a, wo_non_ord_knitdye_booking_dtl b where a.id=b.mst_id $booking_id_cond and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
				}
				/*ech"select a.id, a.booking_no as booking_no, b.id as dtls_id, 35 as process, b.uom, 0 as gmts_size, 0 as gmts_color_id, 0 as fabric_color_id, null as item_size, b.wo_qty as qnty, b.rate, b.amount, b.fab_des_id as fabric_description from wo_non_ord_knitdye_booking_mst a, wo_non_ord_knitdye_booking_dtl b where a.id=b.mst_id and b.id in($wo_dtls_id) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";*/
				$booking_without_order=1;
			}
			
			foreach($data_array as $row)
			{
				$desc="";
				if ($order_type==4) $desc=$row[csf('fabric_description')];
				else if ($order_type==5) { $desc=$construction_arr[$row[csf('fabric_description')]].', '.$composition_arr[$row[csf('fabric_description')]]; }
				else
				{
					if($row[csf('fabric_description')]==0) $desc="All Fabrics";
					else { $desc=$body_part[$descArray[$row[csf('fabric_description')]]['bp']].", ".$color_type[$descArray[$row[csf('fabric_description')]]['ct']].", ".$descArray[$row[csf('fabric_description')]]['con'].", ".$descArray[$row[csf('fabric_description')]]['com']; }
				}

				$bl_qty=$row[csf('qnty')]-$prev_pi_qty_arr[$row[csf('dtls_id')]];
				$amount=number_format($bl_qty*$row[csf('rate')],4,'.','');
				$bl_qty=number_format($bl_qty,6,'.','');
				if($bl_qty>0)
				{
					$tblRow++;
					?>
					<tr class="general" id="row_<? echo $tblRow; ?>">
						<td>
							<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" />
						</td>
						<td>
							<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
							<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>" readonly />
							<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('dtls_id')]; ?>" readonly />
						</td>
						<td>
							<? echo create_drop_down( "servicetype_".$tblRow, 110, $conversion_cost_head_array,'', 1,'-Select-',$row[csf('process')],"",1, '', '', '', '', '', '', 'servicetype[]'); ?>
						</td>
						<td>
							<input type="text" name="itemdescription[]" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $desc; ?>" style="width:150px" maxlength="200" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" style="width:80px" maxlength="50" value="<? echo $color_library[$row[csf('gmts_color_id')]]; ?>" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="sizeName[]" id="sizeName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $size_library[$row[csf('gmts_size')]]; ?>" style="width:70px;" maxlength="50" disabled="disabled"/>
						</td>
						<td>
							<input type="text" name="itemColor[]" id="itemColor_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('fabric_color_id')]]; ?>" style="width:80px" maxlength="50" disabled="disabled"/>
						</td>
						<td>

							<input type="text" name="itemSize[]" id="itemSize_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('item_size')]; ?>" style="width:70px;" maxlength="50" disabled="disabled"/>
						</td>
						<td>
							<?
								echo create_drop_down( "uom_".$tblRow, 60, $unit_of_measurement,'', 0, '',$row[csf('uom')],'',1, '', '', '', '', '', '', 'uom[]');
							?>
						</td>
						<td>
							<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bl_qty; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" />
						</td>
						<td>
							<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:45px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" <? echo $disable_rate; ?> />
						</td>
						<td>
							<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $amount; ?>" style="width:75px;" readonly/>
							<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
							<input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="<? echo $booking_without_order; ?>"/>
						</td>
					</tr>
					<?
				}
			}
		}
	}

	else if($item_category_id==24) // Services - Yarn Dyeing
	{

		//$colorIds=array();
		$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count WHERE status_active = 1 AND is_deleted = 0 ORDER BY yarn_count",'id','yarn_count');
		
		//echo $goods_rcv_status."=".$goods_rcv_variable;die;
		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{
			//echo $goods_rcv_status."=".$goods_rcv_variable;die;
			$rcv_rtn_qnty=return_library_array("select recv_trans_id, sum(issue_qnty) as qnty from  inv_mrr_wise_issue_details where entry_form=8 and status_active=1 group by recv_trans_id","recv_trans_id","qnty");

			$data_array=sql_select("select a.id, a.ydw_no, c.id as dtls_id, c.prod_id, c.order_uom as uom, d.product_name_details as yarn_description, d.color as yarn_color, 0 as color_range, c.order_qnty as qnty, c.order_rate as rate, c.order_amount as amount, d.lot, d.yarn_count_id, d.yarn_type, b.booking_without_order
			from wo_yarn_dyeing_mst a, inv_receive_master b, inv_transaction c, product_details_master d
			where a.id=b.booking_id and b.id=c.mst_id and b.entry_form=1 and b.receive_purpose=2 and c.item_category=1 and c.prod_id=d.id and b.receive_basis=2 and b.receive_purpose=2 and d.item_category_id=1 and c.id in($wo_dtls_id)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0");
			
			$dtls_data=$all_color_arr=array();
			foreach($data_array as $row)
			{
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["id"]=$row[csf("id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["prod_id"]=$row[csf("prod_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["ydw_no"]=$row[csf("ydw_no")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["yarn_description"]=$row[csf("yarn_description")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["yarn_color"]=$row[csf("yarn_color")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["color_range"]=$row[csf("color_range")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["lot"]=$row[csf("lot")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["yarn_count_id"]=$row[csf("yarn_count_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["yarn_type"]=$row[csf("yarn_type")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["uom"]=$row[csf("uom")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["booking_without_order"]=$row[csf("booking_without_order")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["dtls_id"].=$row[csf("dtls_id")]."_";

				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]["trans_qnty"]=$row[csf("qnty")];
				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]["order_amount"]=$row[csf("amount")];
				
				$all_color_arr[$row[csf("yarn_color")]]=$row[csf("yarn_color")];
			}
			
			if(count($all_color_arr)>0)
			{
				$color_array=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0 and id in(".implode(",",$all_color_arr).")",'id','color_name');
			}
			

			//$data_array=sql_select("select a.id, a.ydw_no, b.id as dtls_id, b.product_id, b.uom, b.yarn_description, b.yarn_color, b.color_range, b.yarn_wo_qty as qnty, b.dyeing_charge as rate, b.amount from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and b.id in($wo_dtls_id)");
			foreach($dtls_data as $book_id=>$book_data)
			{
				foreach($book_data as $prod_id=>$row)
				{
					$rtn_qnty=$rate=$prev_pi_qnty=$book_item_qnty=$book_item_amt=$bl_trans_qnty=$item_amt=$item_rate=0;$trans_data=$all_dtls_id="";
					$trans_id_arr=explode("_",chop($row[("dtls_id")],'_'));
					foreach($trans_id_arr as $trans_id)
					{
						$bl_trans_qnty=number_format(($trans_qnty_data[$book_id][$prod_id][$trans_id]["trans_qnty"]-($rcv_rtn_qnty[$trans_id]+$prev_pi_qty_arr[$trans_id])),2,'.','');
						$item_rate=$trans_qnty_data[$book_id][$prod_id][$trans_id]["order_amount"]/$trans_qnty_data[$book_id][$prod_id][$trans_id]["trans_qnty"];
						$item_amt=number_format($bl_trans_qnty*$item_rate,2,'.','');
						$trans_data.=$trans_id."_".$bl_trans_qnty."_".$item_amt."_".$prod_id."__";
						$rtn_qnty+=$rcv_rtn_qnty[$trans_id];
						$prev_pi_qnty+=$prev_pi_qty_arr[$trans_id];
						$book_item_qnty+=$trans_qnty_data[$book_id][$prod_id][$trans_id]["trans_qnty"];
						$book_item_amt+=$trans_qnty_data[$book_id][$prod_id][$trans_id]["order_amount"];
						$all_dtls_id.=$trans_id.",";

					}
					$all_dtls_id=chop($all_dtls_id,",");
					$bl_qty=($book_item_qnty-($rtn_qnty+$prev_pi_qnty));
					$rate=$book_item_amt/$book_item_qnty;
					$amount=$rate*$bl_qty;
					$bl_qty=number_format($bl_qty,6,'.','');
					if($bl_qty>0)
					{
						$tblRow++;
					?>
						<tr class="general" id="row_<? echo $tblRow; ?>">
							<td>
								<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" />
							</td>
							<td>
								<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[('ydw_no')]; ?>" style="width:115px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
								<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $book_id; ?>" readonly />
								<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $all_dtls_id; ?>" readonly />
                                <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="<? echo chop($trans_data,'__'); ?>" readonly />
                                <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="<? echo $row[('booking_without_order')]; ?>" readonly />
							</td>
							<td>
								<input type="text" name="lot[]" id="lot_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[('lot')]; ?>" style="width:80px" maxlength="200" disabled readonly/>
								<input type="hidden" name="itemProdId[]" id="itemProdId_<? echo $tblRow; ?>" readonly value="<? echo $prod_id;?>"/>
							</td>
							<td>
								<? echo create_drop_down( "countName_".$tblRow, 90, $count_arr,'', 1, '-Select-', $row[('yarn_count_id')],"",1, '', '', '', '', '', '', 'countName[]'); ?>
							</td>
							<td>
								<input type="text" name="itemdescription[]" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" style="width:200px" value="<? echo $row[('yarn_description')]; ?>" disabled/>
							</td>
							<td>
								<? echo create_drop_down( "yarnColor_".$tblRow, 110, $color_array,'', 1, '-Select-', $row[('yarn_color')],"",1, '', '', '', '', '', '', 'yarnColor[]'); ?>
							</td>
							<td>
								<? echo create_drop_down( "colorRange_".$tblRow, 110, $color_range,'', 1, '-Select-', $row[('color_range')],"",1, '', '', '', '', '', '', 'colorRange[]'); ?>
							</td>
							<td>
								<? echo create_drop_down( "uom_".$tblRow, 60, $unit_of_measurement,'', 0, '',$row[('uom')],'',1,12, '', '', '', '', '', 'uom[]'); ?>
							</td>
							<td>
								<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bl_qty; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" readonly />
							</td>
							<td>
								<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $rate; ?>" style="width:45px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" readonly />
							</td>
							<td>
								<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $amount; ?>" style="width:75px;" readonly/>
								<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
							</td>
						</tr>
					<?
					}
				}

			}


		}
		else
		{
			//echo "SELECT a.id, a.ydw_no, b.id as dtls_id, b.product_id, b.uom, b.yarn_description, b.yarn_color, b.color_range, b.yarn_wo_qty as qnty, b.dyeing_charge as rate, b.amount, (case when b.entry_form=41 then 0 else 1 end) as booking_without_order, b.count as COUNT
			//from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b 
			//where a.id=b.mst_id and b.id in($wo_dtls_id) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";die;23984,23985,23986,23987
			$data_array=sql_select("SELECT a.id, a.ydw_no, b.id as dtls_id, b.product_id, b.uom, b.yarn_description, b.yarn_color, b.color_range, b.yarn_wo_qty as qnty, b.dyeing_charge as rate, b.amount, (case when b.entry_form=41 then 0 else 1 end) as booking_without_order, b.count
			from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b 
			where a.id=b.mst_id and b.id in($wo_dtls_id) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
			//print_r($data_array);die;
			$all_color_arr=$all_prod_id=array();
			foreach($data_array as $val)
			{
				$all_color_arr[$val[csf("yarn_color")]]=$val[csf("yarn_color")];
				$all_prod_id[$val[csf("product_id")]]=$val[csf("product_id")];
			}
			
			if(count($all_color_arr)>0)
			{
				$color_array=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0 and id in(".implode(",",$all_color_arr).")",'id','color_name');
			}
			
			$lot_arr=array();
			if(count($all_prod_id)>0)
			{
				$lot_data=sql_select( "select id, lot, yarn_count_id from product_details_master where item_category_id=1 and status_active=1 and id in(".implode(",",$all_prod_id).")");
				foreach($lot_data as $lotRow)
				{
					$lot_arr[$lotRow[csf('id')]]['lot']=$lotRow[csf('lot')];
					$lot_arr[$lotRow[csf('id')]]['count']=$lotRow[csf('yarn_count_id')];
				}
				unset($lot_data);
			}
			
			
			$disable_data=$checkBox_check="";
			if($goods_rcv_variable==1 && $goods_rcv_status==1)
			{
				$disable_data="disabled='disabled'";
				$checkBox_check="checked";
			}
			
			foreach($data_array as $row)
			{
				$bl_qty=$row[csf('qnty')]-$prev_pi_qty_arr[$row[csf('dtls_id')]];
				$amount=number_format($bl_qty*$row[csf('rate')],4,'.','');
				$bl_qty=number_format($bl_qty,6,'.','');
				$i++;
				$count_id=($row[csf('count')])?$row[csf('count')]:$lot_arr[$row[csf('product_id')]]['count'];
				if($bl_qty>0)
				{
					$tblRow++;
					?>
					<tr class="general" id="row_<? echo $tblRow; ?>">
						<td>
							<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" <? //echo $disable_data." ".$checkBox_check; ?> />
						</td>
						<td>
							<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('ydw_no')]; ?>" style="width:115px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
							<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>" readonly />
							<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('dtls_id')]; ?>" readonly />
                            <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="" readonly />
                            <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="<? echo $row[csf('booking_without_order')]; ?>" readonly />
						</td>
						<td>
							<input type="text" name="lot[]" id="lot_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $lot_arr[$row[csf('product_id')]]['lot']; ?>" style="width:80px" maxlength="200" disabled readonly/>
							<input type="hidden" name="itemProdId[]" id="itemProdId_<? echo $tblRow; ?>" readonly value="<? echo $row[csf('product_id')];?>"/>
						</td>
						<td>
							<? echo create_drop_down( "countName_".$tblRow, 90, $count_arr,'', 1, '-Select-',$count_id,"",1, '', '', '', '', '', '', 'countName[]'); ?>
						</td>
						<td>
							<input type="text" name="itemdescription[]" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" style="width:200px" value="<? echo $row[csf('yarn_description')]; ?>" disabled/>
						</td>
						<td>
							<? echo create_drop_down( "yarnColor_".$tblRow, 110, $color_array,'', 1, '-Select-', $row[csf('yarn_color')],"",1, '', '', '', '', '', '', 'yarnColor[]'); ?>
						</td>
						<td>
							<? echo create_drop_down( "colorRange_".$tblRow, 110, $color_range,'', 1, '-Select-', $row[csf('color_range')],"",1, '', '', '', '', '', '', 'colorRange[]'); ?>
						</td>
						<td>
							<? echo create_drop_down( "uom_".$tblRow, 60, $unit_of_measurement,'', 0, '',$row[csf('uom')],'',1,12, '', '', '', '', '', 'uom[]'); ?>
						</td>
						<td>
							<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bl_qty; ?>" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" <?// echo $disable_data; ?> />
						</td>
						<td>
							<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:45px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" <? echo $disable_rate; ?> />
						</td>
						<td>
							<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $amount; ?>" style="width:75px;" readonly/>
							<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
						</td>
					</tr>
					<?
				}
			}

		}

	}

	else if($item_category_id==25) // 25=Services - Embellishment
	{
		if($goods_rcv_status==1 && $goods_rcv_variable !=1) $rcv_source_cond=" and a.after_goods_source=2 and b.after_goods_source=2"; else $rcv_source_cond=" and a.after_goods_source=1 and b.after_goods_source=1";

		$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 $rcv_source_cond and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");
		$data_array=sql_select("select a.id, a.booking_no, b.id as dtls_id, b.gmts_color_id, b.gmt_item, b.uom, b.wo_qnty as qnty, b.rate, b.amount, c.emb_name, c.emb_type 
		from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_embe_cost_dtls c
		where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and b.id in($wo_dtls_id) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0");
		
		foreach($data_array as $row)
		{
			$bl_qty=$row[csf('qnty')]-$prev_pi_qty_arr[$row[csf('dtls_id')]];
			$amount=number_format($bl_qty*$row[csf('rate')],4,'.','');
			$bl_qty=number_format($bl_qty,6,'.','');
			if($bl_qty>0)
			{
				$tblRow++;
				?>
                <tr class="general" id="row_<? echo $tblRow; ?>">
                    <td>
                        <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" />
                    </td>
                    <td>
                        <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
                        <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>" readonly />
                        <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('dtls_id')]; ?>" readonly />
                    </td>
                    <td>
                        <? echo create_drop_down( "gmtsitem_".$tblRow, 150, $garments_item,'', 1, '-Select-', $row[csf('gmt_item')],"",1, '', '', '', '', '', '', 'gmtsitem[]'); ?>
                    </td>
                    <td>
                        <? echo create_drop_down( "embellname_".$tblRow, 130, $emblishment_name_array,'', 1, '-Select-', $row[csf('emb_name')],"load_drop_down( 'requires/pi_controller_urmi', this.value+'**'+1+'**'+'embelltype_$tblRow', 'load_drop_down_embelltype', 'embelltypeTd_$tblRow');",1, '', '', '', '', '', '', 'embellname[]'); ?>
                    </td>
                    <td id="embelltypeTd_<? echo $tblRow; ?>">
                        <?
                            $emb_arr=array();
                            if ($row[csf('emb_name')]==1) $emb_arr=$emblishment_print_type;
                            else if($row[csf('emb_name')]==2) $emb_arr=$emblishment_embroy_type;
                            else if($row[csf('emb_name')]==3) $emb_arr=$emblishment_wash_type;
                            else if($row[csf('emb_name')]==4) $emb_arr=$emblishment_spwork_type;
                            else if($row[csf('emb_name')]==5) $emb_arr=$emblishment_gmts_type;
                            else $emb_arr=$blank_array;

                            echo create_drop_down( "embelltype_".$tblRow, 130, $emb_arr,'', 1, '-Select-', $row[csf('emb_type')],"",1, '', '', '', '', '', '', 'embelltype[]');
                        ?>
                    </td>
                    <td>
                        <input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('gmts_color_id')]]; ?>" style="width:90px" maxlength="50" disabled="disabled"/>
                    </td>
                     <td>
                        <?
							//if($row[csf('uom')]==2) $row[csf('uom')]=1; else $row[csf('uom')]=2;
                            echo create_drop_down( "uom_".$tblRow, 70, $unit_of_measurement,'', 0, '',$row[csf('uom')],'',1,'', '', '', '', '', '', 'uom[]');
                        ?>
                    </td>
                    <td>
                        <input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($bl_qty,6,'.',''); ?>" style="width:81px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" />
                    </td>
                    <td>
                        <input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:50px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" <? echo $disable_rate; ?> />
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $amount; ?>" style="width:85px;" readonly/>
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
                    </td>
                </tr>
            <?
			}
		}
	}

	// 102=Services - Printing, 103=Services - Wash, 104=Services - Embroidery
	else if($item_category_id==102 || $item_category_id==103 || $item_category_id==104)
	{
		if($goods_rcv_status==1 && $goods_rcv_variable !=1) $rcv_source_cond=" and a.after_goods_source=2 and b.after_goods_source=2"; else $rcv_source_cond=" and a.after_goods_source=1 and b.after_goods_source=1";

		$prev_pi_qty_arr=return_library_array( "select b.work_order_dtls_id, sum(b.quantity) as qty from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and a.item_category_id=$item_category_id and a.pi_basis_id=1 $rcv_source_cond and b.status_active=1 and b.is_deleted=0 and b.work_order_dtls_id in($wo_dtls_id) group by b.work_order_dtls_id", "work_order_dtls_id", "qty");
		
		$data_array=sql_select("select a.id, a.booking_no, b.id as dtls_id, b.gmts_color_id, b.gmt_item, b.uom, b.wo_qnty as qnty, b.rate, b.amount, c.emb_name, c.emb_type 
		from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_embe_cost_dtls c
		where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and b.id in($wo_dtls_id) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0");
		
		foreach($data_array as $row)
		{
			$bl_qty=$row[csf('qnty')]-$prev_pi_qty_arr[$row[csf('dtls_id')]];
			$amount=number_format($bl_qty*$row[csf('rate')],4,'.','');
			$bl_qty=number_format($bl_qty,6,'.','');
			if($bl_qty>0)
			{
				$tblRow++;
				?>
                <tr class="general" id="row_<? echo $tblRow; ?>">
                    <td>
                        <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" />
                    </td>
                    <td>
                        <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('booking_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
                        <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>" readonly />
                        <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('dtls_id')]; ?>" readonly />
                    </td>
                    <td>
                        <? echo create_drop_down( "gmtsitem_".$tblRow, 150, $garments_item,'', 1, '-Select-', $row[csf('gmt_item')],"",1, '', '', '', '', '', '', 'gmtsitem[]'); ?>
                    </td>
                    <td>
                        <? echo create_drop_down( "embellname_".$tblRow, 130, $emblishment_name_array,'', 1, '-Select-', $row[csf('emb_name')],"load_drop_down( 'requires/pi_controller_urmi', this.value+'**'+1+'**'+'embelltype_$tblRow', 'load_drop_down_embelltype', 'embelltypeTd_$tblRow');",1, '', '', '', '', '', '', 'embellname[]'); ?>
                    </td>
                    <td id="embelltypeTd_<? echo $tblRow; ?>">
                        <?
                            $emb_arr=array();
                            if ($row[csf('emb_name')]==1) $emb_arr=$emblishment_print_type;
                            else if($row[csf('emb_name')]==2) $emb_arr=$emblishment_embroy_type;
                            else if($row[csf('emb_name')]==3) $emb_arr=$emblishment_wash_type;
                            else if($row[csf('emb_name')]==4) $emb_arr=$emblishment_spwork_type;
                            else if($row[csf('emb_name')]==5) $emb_arr=$emblishment_gmts_type;
                            else $emb_arr=$blank_array;

                            echo create_drop_down( "embelltype_".$tblRow, 130, $emb_arr,'', 1, '-Select-', $row[csf('emb_type')],"",1, '', '', '', '', '', '', 'embelltype[]');
                        ?>
                    </td>
                    <td>
                        <input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('gmts_color_id')]]; ?>" style="width:90px" maxlength="50" disabled="disabled"/>
                    </td>
                     <td>
                        <?
							//if($row[csf('uom')]==2) $row[csf('uom')]=1; else $row[csf('uom')]=2;
                            echo create_drop_down( "uom_".$tblRow, 70, $unit_of_measurement,'', 0, '',$row[csf('uom')],'',1,'', '', '', '', '', '', 'uom[]');
                        ?>
                    </td>
                    <td>
                        <input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($bl_qty,6,'.',''); ?>" style="width:81px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" />
                    </td>
                    <td>
                        <input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row[csf('rate')]; ?>" style="width:50px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" <? echo $disable_rate; ?> />
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $amount; ?>" style="width:85px;" readonly/>
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
                    </td>
                </tr>
            <?
			}
		}
	}

	else if($item_category_id==31 || $item_category_id==115)  // Services Lab Test
	{
		$test_item_arr=return_library_array( "SELECT id,test_item FROM lib_lab_test_rate_chart",'id','test_item');
		
		if($item_category_id==31)
		{
			$data_array=sql_select("select a.id, a.labtest_no, b.id as dtls_id, b.test_for, b.test_item_id, b.color, b.wo_value, b.remarks 
			from wo_labtest_mst a, wo_labtest_dtls b where a.id=b.mst_id and b.id in($wo_dtls_id) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
		}
		else
		{
			$data_array=sql_select("select a.id, a.BOOKING_NO as labtest_no, b.id as dtls_id, b.INSPECTION_FOR_ID as test_for, 0 as test_item_id, 0 as color, b.NET_AMOUNT as wo_value, b.REMARK as remarks 
			from WO_INSPECTION_MST a, WO_INSPECTION_DTLS b where a.id=b.BOOKING_MST_ID and b.id in($wo_dtls_id) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
		}
		
		foreach($data_array as $row)
		{
			$bl_amnt=$row[csf('wo_value')]-$prev_pi_amnt_arr[$row[csf('dtls_id')]];
			$bl_amnt=number_format($bl_amnt,2,'.','');
			if($bl_amnt>0)
			{
				$tblRow++;
			?>
                <tr class="general" id="row_<? echo $tblRow; ?>">
                    <td>
                        <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" />
                    </td>
                    <td>
                        <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('labtest_no')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
                        <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>" readonly />
                        <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('dtls_id')]; ?>" readonly />
                    </td>
                    <td>
                         <?
                            echo create_drop_down( "cboTestFor_".$tblRow, 140, $test_for,'', 1, '-Select-',$row[csf('test_for')],"",1, '', '', '', '', '', '', 'cboTestFor[]');
                         ?>
                    </td>
                    <td>
                        <input type="text" name="remarks[]" id="remarks_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('remarks')]; ?>" style="width:170px;" maxlength="250" disabled/>
                    </td>
                    <td>
                        <input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $color_library[$row[csf('color')]]; ?>" style="width:100px;" maxlength="100" disabled/>
                    </td>
                    <td>
                        <?
                            $test_item='';
                            $test_item_ids=array_unique(explode(",",$row[csf('test_item_id')]));
                            foreach($test_item_ids as $test_item_id)
                            {
                                $test_item.=$test_item_arr[$test_item_id].",";
                            }
                            $test_item=chop($test_item,',');
                        ?>
                        <input type="text" name="txtTestItem[]" id="txtTestItem_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $test_item; ?>" style="width:200px" maxlength="200" <? echo $disable; ?> onDblClick="openmypage_test_item(<? echo $tblRow; ?>);" placeholder="<? echo $placeholder; ?>" readonly/>
                        <input type="hidden" name="testItemId[]" id="testItemId_<? echo $tblRow; ?>" readonly value="<? echo $row[csf('test_item_id')]; ?>"/>
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bl_amnt; ?>" style="width:85px;" onKeyUp="check_amount(<? echo $tblRow; ?>);" placeholder="<? echo $bl_amnt; ?>" <? echo $disable_rate; ?>/>
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
                    </td>
                </tr>
            <?
			}
		}
	}
	
	else if($item_category_id==116)  // Services Garments
	{
		$test_item_arr=return_library_array( "SELECT id,test_item FROM lib_lab_test_rate_chart",'id','test_item');
		
		$data_sql="select a.ID, a.SYS_NUMBER, b.ID as DTLS_ID, b.ITEM_ID, b.RATE_FOR, b.UOM, b.WO_QTY, b.AVG_RATE, b.AMOUNT
		from GARMENTS_SERVICE_WO_MST a, GARMENTS_SERVICE_WO_DTLS b 
		where a.id=b.MST_ID and b.id in($wo_dtls_id) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
		//echo $data_sql;die;
		$data_array=sql_select($data_sql);
		
		foreach($data_array as $row)
		{
			$bl_qnty=$row["WO_QTY"]-$prev_pi_qty_arr[$row['DTLS_ID']];
			$bl_qnty=number_format($bl_qnty,2,'.','');
			if($bl_qnty>0)
			{
				$tblRow++;
				$all_process_name="";
				$process_id_arr=explode(",",$row['RATE_FOR']);
				foreach($process_id_arr as $process_id)
				{
					$all_process_name.=$rate_for[$process_id].",";
				}
				$bal_amt=$bl_qnty*$row['AVG_RATE'];
				?>
                <tr class="general" id="row_<? echo $tblRow; ?>">
                    <td>
                        <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" />
                    </td>
                    <td>
                        <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row['SYS_NUMBER']; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
                        <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row["ID"]; ?>" readonly />
                        <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row["DTLS_ID"]; ?>" readonly />
                    </td>
                    <td>
                        <input type="text" name="itemdescription[]" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $garments_item[$row['ITEM_ID']]; ?>" title="<?= $row['ITEM_ID'];?>" style="width:200px" readonly />
                    </td>
                    <td>
                        <input type="text" name="processName[]" id="processName_<? echo $tblRow; ?>" class="text_boxes"   value="<? echo $all_process_name; ?>" title="<?= $row['RATE_FOR'];?>"  style="width:200px" readonly />
                    </td>
                    <td>
                        <?
                            echo create_drop_down( "uom_".$tblRow, 80, $unit_of_measurement, '', 0, '', $row['UOM'], '', $disable_status, '', '', '', '', '', '', 'uom[]');
                        ?>
                    </td>
                    <td>
                        <input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bl_qnty; ?>" style="width:80px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qnty; ?>" />
                    </td>
                    <td>
                        <input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row['AVG_RATE']; ?>" style="width:70px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" />
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bal_amt; ?>" style="width:90px;" readonly/>
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
                        <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="0"/>
                    </td>
                </tr>
            	<?
			}
		}
	}
	else if($item_category_id==100)  // Sweater Services Garments
	{
		$test_item_arr=return_library_array( "SELECT id,test_item FROM lib_lab_test_rate_chart",'id','test_item');
		
		$data_sql="select a.ID, a.SUCON_WO_NO as SYS_NUMBER, b.ID as DTLS_ID, b.GMTS_NO, 0 as RATE_FOR, 94 as UOM, b.WO_QTY, b.DYEING_CHARGE as AVG_RATE, b.AMOUNT
		from SUBCON_WO_MST a, SUBCON_WO_DTLS b 
		where a.id=b.MST_ID and a.ENTRY_FORM=643 and b.id in($wo_dtls_id) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
		//echo $data_sql;die;
		$data_array=sql_select($data_sql);
		
		foreach($data_array as $row)
		{
			$bl_qnty=$row["WO_QTY"]-$prev_pi_qty_arr[$row['DTLS_ID']];
			$bl_qnty=number_format($bl_qnty,2,'.','');
			if($bl_qnty>0)
			{
				$tblRow++;
				$all_process_name="";
				$process_id_arr=explode(",",$row['RATE_FOR']);
				foreach($process_id_arr as $process_id)
				{
					$all_process_name.=$rate_for[$process_id].",";
				}
				$bal_amt=$bl_qnty*$row['AVG_RATE'];
				?>
                <tr class="general" id="row_<? echo $tblRow; ?>">
                    <td>
                        <input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" />
                    </td>
                    <td>
                        <input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row['SYS_NUMBER']; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
                        <input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row["ID"]; ?>" readonly />
                        <input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row["DTLS_ID"]; ?>" readonly />
                    </td>
                    <td>
                        <input type="text" name="itemdescription[]" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row['GMTS_NO']; ?>" title="0" style="width:200px" readonly />
                    </td>
                    <td>
                        <input type="text" name="processName[]" id="processName_<? echo $tblRow; ?>" class="text_boxes"   value="<? echo $all_process_name; ?>" title="<?= $row['RATE_FOR'];?>"  style="width:200px" readonly />
                    </td>
                    <td>
                        <?
                            echo create_drop_down( "uom_".$tblRow, 80, $unit_of_measurement, '', 0, '', $row['UOM'], '', $disable_status, '', '', '', '', '', '', 'uom[]');
                        ?>
                    </td>
                    <td>
                        <input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bl_qnty; ?>" style="width:80px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qnty; ?>" />
                    </td>
                    <td>
                        <input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $row['AVG_RATE']; ?>" style="width:70px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" />
                    </td>
                    <td>
                        <input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo $bal_amt; ?>" style="width:90px;" readonly/>
                        <input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly value=""/>
                        <input type="hidden" name="bookingWithoutOrder[]" id="bookingWithoutOrder_<? echo $tblRow; ?>" value="0"/>
                    </td>
                </tr>
            	<?
			}
		}
	}
	else if($item_category_id==114)  // Services
	{
		$sql_data="select a.id, a.wo_number, a.wo_date, a.supplier_id, b.id as dtls_id, b.item_id, b.uom, b.supplier_order_quantity, b.rate, b.amount, 0 as item_group_id, b.service_details as item_description, null as item_size, 0 as trans_id
		from wo_non_order_info_mst a, wo_non_order_info_dtls b
		where a.id=b.mst_id and b.is_deleted=0 and b.id in($wo_dtls_id) ";
		//and b.item_category_id=$item_category_id and c.item_category_id=$item_category_id  --category mismatch for Stationaries and Accessories
		$data_array=sql_select($sql_data);
		$disable_data=$checkBox_check="";
		if($goods_rcv_variable==1 && $goods_rcv_status==1)
		{
			$disable_data="disabled='disabled'";
			$checkBox_check="checked";
		}
		
		foreach($data_array as $row)
		{
			$bl_qty=$row[csf('supplier_order_quantity')]-$prev_pi_qty_arr[$row[csf('dtls_id')]];
			$rate=$row[csf("amount")]/$row[csf("supplier_order_quantity")];
			$amount=number_format(($bl_qty*$rate),8,'.','');
			$bl_qty=number_format($bl_qty,4,'.','');
			//if($bl_qty>0)
			if($bl_qty>0)
			{
				$tblRow++;
				?>
				<tr class="general" id="row_<? echo $tblRow; ?>">
					<td>
						<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" <? //echo $disable_data." ".$checkBox_check; ?> />
					</td>
					<td>
						<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('wo_number')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
						<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>" readonly />
						<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('dtls_id')]; ?>" readonly />
						<input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="" readonly />
					</td>
					<td>
						<input type="text" name="hsCode[]" id="hsCode_<? echo $tblRow; ?>" class="text_boxes" value="" style="width:40px;" />
					</td>
					<td>
					<?
						echo create_drop_down( "itemgroupid_".$tblRow, 130, $item_group_arr,'', 1, '- Select -',$row[csf('item_group_id')],"get_php_form_data( this.value+'**'+'uom_$tblRow', 'get_uom', 'requires/pi_controller_urmi' );",1, '', '', '', '', '', '', 'itemgroupid[]');
					?>
					</td>
					<td>
						<input type="text" name="itemdescription[]" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('item_description')]; ?>" style="width:200px" maxlength="200" <? echo $disable; ?> onDblClick="openmypage_item_desc(<? echo $tblRow; ?>);" placeholder="Double Click" readonly/>
						<input type="hidden" name="itemProdId[]" id="itemProdId_<? echo $tblRow; ?>" readonly value="<? echo $row[csf('item_id')]; ?>"/>
					</td>
					<td>
						<input type="text" name="itemSize[]" id="itemSize_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('item_size')]; ?>" style="width:90px;" maxlength="50" disabled="disabled"/>
					</td>
					<td>
						<?
							echo create_drop_down( "uom_$tblRow", 80, $unit_of_measurement,'', 0, '',$row[csf('uom')],'',1, '', '', '', '', '', '', 'uom[]');
						?>
					</td>
					<td>
						<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($bl_qty,4,'.',''); ?>" style="width:90px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" <? echo $disable_data; ?> />
					</td>
					<td>
						<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($rate,8,'.',''); ?>" style="width:75px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" <? echo $disable_rate; ?> />
					</td>
					<td>
						<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($amount,8,'.',''); ?>" style="width:85px;" readonly/>
						<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly/>
					</td>
				</tr>
				<?
			}
		}
	}
	else
	{
		$item_group_arr=return_library_array( "SELECT id,item_name FROM lib_item_group where ITEM_CATEGORY in(select category_id from lib_item_category_list where category_type=1)",'id','item_name');

		if($goods_rcv_status==1 && $goods_rcv_variable!=1)
		{
			$conver_factor=return_library_array("select a.id, b.conversion_factor from product_details_master a, lib_item_group b where a.item_group_id=b.id and a.entry_form<>24 and a.ITEM_CATEGORY_ID not in(5,6,7,23)","id","conversion_factor");

			$rcv_rtn_qnty=return_library_array("select recv_trans_id, sum(issue_qnty) as qnty from  inv_mrr_wise_issue_details where entry_form=26 and status_active=1 group by recv_trans_id","recv_trans_id","qnty");

			$sql_data="select a.id, a.wo_number, a.wo_date, a.supplier_id, c.id as dtls_id, c.order_uom as uom, c.order_qnty as qnty, c.order_amount as amount, d.id as prod_id, d.item_group_id, d.item_description, d.item_size
			from wo_non_order_info_mst a, inv_receive_master b, inv_transaction c, product_details_master d
			where a.id=b.booking_id and b.id=c.mst_id and c.prod_id=d.id and b.entry_form=20 and b.receive_basis=2 and a.is_deleted=0 and b.is_deleted=0 and c.is_deleted=0 and d.is_deleted=0 and d.status_active in(1,3) and c.id in($wo_dtls_id) and c.item_category in(select category_id from lib_item_category_list where category_type=1) and d.item_category_id in(select category_id from lib_item_category_list where category_type=1)";
			$data_array=sql_select($sql_data);

			$dtls_data=array();
			foreach($data_array as $row)
			{
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["id"]=$row[csf("id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["prod_id"]=$row[csf("prod_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["wo_number"]=$row[csf("wo_number")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["supplier_id"]=$row[csf("supplier_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["item_group_id"]=$row[csf("item_group_id")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["item_description"]=$row[csf("item_description")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["item_size"]=$row[csf("item_size")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["uom"]=$row[csf("uom")];
				$dtls_data[$row[csf("id")]][$row[csf("prod_id")]]["dtls_id"].=$row[csf("dtls_id")]."_";

				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]["trans_qnty"]=$row[csf("qnty")];
				$trans_qnty_data[$row[csf("id")]][$row[csf("prod_id")]][$row[csf("dtls_id")]]["order_amount"]=$row[csf("amount")];
			}

			foreach($dtls_data as $book_id=>$book_data)
			{
				foreach($book_data as $prod_id=>$row)
				{
					$rtn_qnty=$rate=$prev_pi_qnty=$book_item_qnty=$book_item_amt=$bl_trans_qnty=$item_amt=$item_rate=0;$trans_data="";
					$trans_id_arr=explode("_",chop($row[("dtls_id")],'_'));
					$all_dtls_id="";
					foreach($trans_id_arr as $trans_id)
					{
						$bl_trans_qnty=number_format(($trans_qnty_data[$book_id][$prod_id][$trans_id]["trans_qnty"]-(($rcv_rtn_qnty[$trans_id]/$conver_factor[$prod_id])+$prev_pi_qty_arr[$trans_id])),2,'.','');
						$item_rate=$trans_qnty_data[$book_id][$prod_id][$trans_id]["order_amount"]/$trans_qnty_data[$book_id][$prod_id][$trans_id]["trans_qnty"];
						$item_amt=number_format($bl_trans_qnty*$item_rate,2,'.','');

						$trans_data.=$trans_id."_".$bl_trans_qnty."_".$item_amt."_".$prod_id."__";
						$rtn_qnty+=$rcv_rtn_qnty[$trans_id]/$conver_factor[$prod_id];
						$prev_pi_qnty+=$prev_pi_qty_arr[$trans_id];
						$book_item_qnty+=$trans_qnty_data[$book_id][$prod_id][$trans_id]["trans_qnty"];
						$book_item_amt+=$trans_qnty_data[$book_id][$prod_id][$trans_id]["order_amount"];
						$all_dtls_id.=$trans_id.",";
					}
					$all_dtls_id=chop($all_dtls_id,",");
					$bl_qty=($book_item_qnty-($rtn_qnty+$prev_pi_qnty));
					$rate=$book_item_amt/$book_item_qnty;
					$amount=$rate*$bl_qty;
					$bl_qty=number_format($bl_qty,4,'.','');
					if($bl_qty>0)
					{
						$tblRow++;
						?>
						<tr class="general" id="row_<? echo $tblRow; ?>">
							<td>
								<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" />
							</td>
							<td>
								<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[('wo_number')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" title="<? echo $rtn_qnty; ?>" readonly />
								<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[('id')]; ?>" readonly />
								<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $all_dtls_id; ?>" readonly />
                                <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="<? echo chop($trans_data,'__'); ?>" readonly />
							</td>
                            <td>
                                <input type="text" name="hsCode[]" id="hsCode_<? echo $tblRow; ?>" class="text_boxes" value="" style="width:40px;" />
                            </td>
							<td>
							<?
								echo create_drop_down( "itemgroupid_".$tblRow, 130, $item_group_arr,'', 1, '- Select -',$row[('item_group_id')],"get_php_form_data( this.value+'**'+'uom_$tblRow', 'get_uom', 'requires/pi_controller_urmi' );",1, '', '', '', '', '', '', 'itemgroupid[]');
							?>
							</td>
							<td>
								<input type="text" name="itemdescription[]" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[('item_description')]; ?>" style="width:200px" maxlength="200" <? echo $disable; ?> onDblClick="openmypage_item_desc(<? echo $tblRow; ?>);" placeholder="Double Click" readonly/>
								<input type="hidden" name="itemProdId[]" id="itemProdId_<? echo $tblRow; ?>" readonly value="<? echo $prod_id; ?>"/>
							</td>
							<td>
								<input type="text" name="itemSize[]" id="itemSize_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[('item_size')]; ?>" style="width:90px;" maxlength="50" disabled="disabled"/>
							</td>
							<td>
								<?
									echo create_drop_down( "uom_$tblRow", 80, $unit_of_measurement,'', 0, '',$row[('uom')],'',1, '', '', '', '', '', '', 'uom[]');
								?>
							</td>
							<td>
								<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($bl_qty,4,'.',''); ?>" style="width:90px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" readonly />
							</td>
							<td>
								<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($rate,4,'.',''); ?>" style="width:75px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" readonly />
							</td>
							<td>
								<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($amount,4,'.',''); ?>" style="width:85px;" readonly/>
								<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly/>
							</td>
						</tr>
						<?
					}
				}
			}
		}
		else
		{

			$sql_data="select a.id, a.wo_number, a.wo_date, a.supplier_id, b.id as dtls_id, b.item_id, b.uom, b.supplier_order_quantity, b.rate, b.amount, c.item_group_id, c.item_description, c.item_size, 0 as trans_id, b.item_category_id
			from wo_non_order_info_mst a, wo_non_order_info_dtls b, product_details_master c
			where a.id=b.mst_id and b.item_id=c.id and b.is_deleted=0 and c.is_deleted=0 and c.status_active in(1,3) and b.id in($wo_dtls_id) ";
			//echo $sql_data;
			//and b.item_category_id=$item_category_id and c.item_category_id=$item_category_id  --category mismatch for Stationaries and Accessories

			$data_array=sql_select($sql_data);
			$disable_data=$checkBox_check="";
			if($goods_rcv_variable==1 && $goods_rcv_status==1)
			{
				$disable_data="disabled='disabled'";
				$checkBox_check="checked";
			}
			
			foreach($data_array as $row)
			{
				$bl_qty=$row[csf('supplier_order_quantity')]-$prev_pi_qty_arr[$row[csf('dtls_id')]];
				$rate=$row[csf("amount")]/$row[csf("supplier_order_quantity")];
				$amount=number_format(($bl_qty*$rate),8,'.','');
				$bl_qty=number_format($bl_qty,4,'.','');
				//if($bl_qty>0)
				if($bl_qty>0)
				{
					$tblRow++;
					?>
					<tr class="general" id="row_<? echo $tblRow; ?>">
						<td>
							<input type="checkbox" name="workOrderChkbox[]" id="workOrderChkbox_<? echo $tblRow; ?>" value="" <? //echo $disable_data." ".$checkBox_check; ?> />
						</td>
						<td>
							<input type="text" name="workOrderNo[]" id="workOrderNo_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('wo_number')]; ?>" style="width:110px;" placeholder="Dbl click" onDblClick="openmypage_wo(<? echo $tblRow; ?>);" readonly />
							<input type="hidden" name="hideWoId[]" id="hideWoId_<? echo $tblRow; ?>" value="<? echo $row[csf('id')]; ?>" readonly />
							<input type="hidden" name="hideWoDtlsId[]" id="hideWoDtlsId_<? echo $tblRow; ?>" value="<? echo $row[csf('dtls_id')]; ?>" readonly />
                            <input type="hidden" name="hideTransData[]" id="hideTransData_<? echo $tblRow; ?>" value="" readonly />
						</td>
                        <td>
						 <?
                            echo create_drop_down( "itemcategory_".$tblRow, 120, $general_item_category, '', 1, '-Select-', $row[csf('item_category_id')], "", 1, '', '', '', '', '', '', 'itemcategory[]');
                         ?>
                    </td>
                        <td>
                            <input type="text" name="hsCode[]" id="hsCode_<? echo $tblRow; ?>" class="text_boxes" value="" style="width:40px;" />
                        </td>
						<td>
						<?
							echo create_drop_down( "itemgroupid_".$tblRow, 120, $item_group_arr,'', 1, '- Select -',$row[csf('item_group_id')],"get_php_form_data( this.value+'**'+'uom_$tblRow', 'get_uom', 'requires/pi_controller_urmi' );",1, '', '', '', '', '', '', 'itemgroupid[]');
						?>
						</td>
						<td>
							<input type="text" name="itemdescription[]" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('item_description')]; ?>" style="width:160px" maxlength="200" <? echo $disable; ?> onDblClick="openmypage_item_desc(<? echo $tblRow; ?>);" placeholder="Double Click" readonly/>
							<input type="hidden" name="itemProdId[]" id="itemProdId_<? echo $tblRow; ?>" readonly value="<? echo $row[csf('item_id')]; ?>"/>
						</td>
						<td>
							<input type="text" name="itemSize[]" id="itemSize_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('item_size')]; ?>" style="width:60px;" maxlength="50" disabled="disabled"/>
						</td>
						<td>
							<?
								echo create_drop_down( "uom_$tblRow", 50, $unit_of_measurement,'', 0, '',$row[csf('uom')],'',1, '', '', '', '', '', '', 'uom[]');
							?>
						</td>
						<td>
							<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($bl_qty,4,'.',''); ?>" style="width:80px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" placeholder="<? echo $bl_qty; ?>" <? echo $disable_data; ?> />
						</td>
						<td>
							<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($rate,8,'.',''); ?>" style="width:75px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" <? echo $disable_rate; ?> />
						</td>
						<td>
							<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="<? echo number_format($amount,8,'.',''); ?>" style="width:85px;" readonly/>
							<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly/>
						</td>
					</tr>
					<?
				}
			}
		}
	}
	exit();
}

if ($action=="itemDesc_popup")
{
	echo load_html_head_contents("WO Info", "../../../", 1, 1,'','','');
	extract($_REQUEST);
	?>
	<script>
 
	var item_category=<? echo $item_category; ?>;
	var selected_id = new Array, selected_name = new Array();

		function check_all_data()
		{
			var tbl_row_count = document.getElementById( 'tbl_list_search' ).rows.length;
			tbl_row_count = tbl_row_count - 1;

			for( var i = 1; i <= tbl_row_count; i++ )
			{
				$('#tr_'+i).trigger('click');
			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function js_set_value( str ) {

			if (str!="") str=str.split("_");

			toggle( document.getElementById( 'tr_' + str[0] ), '#FFFFCC' );

			if( jQuery.inArray( str[1], selected_id ) == -1 ) {
				selected_id.push( str[1] );

			}
			else {
				for( var i = 0; i < selected_id.length; i++ ) {
					if( selected_id[i] == str[1] ) break;
				}
				selected_id.splice( i, 1 );
			}
			var id = '';
			for( var i = 0; i < selected_id.length; i++ ) {
				id += selected_id[i] + ',';
			}
			id = id.substr( 0, id.length - 1 );

			$('#txt_selected_item_id').val( id );
		}

		function reset_hide_field()
		{
			$('#txt_selected_item_id').val( '' );
		}

    </script>

	</head>

	<body>
	<div align="center" style="width:800px;">
		<form name="searchwofrm"  id="searchwofrm">
			<fieldset style="width:100%;">
			<legend>Enter search words</legend>
				<table cellpadding="0" cellspacing="0" width="700px" class="rpt_table">
					<thead>
						<th>Company</th>
						<th style="display:none">Supplier</th>
						<th>Item Description</th>
						<th>
							<input type="reset" name="reset" id="reset" value="Reset" style="width:100px" class="formbutton" onClick="reset_hide_field()" />
							<input type="hidden" name="txt_item_category" id="txt_item_category" class="text_boxes" style="width:70px" value="<? echo $item_category; ?>">
							<input type="hidden" name="txt_selected_item_id" id="txt_selected_item_id" class="text_boxes" value="">
						</th>
					</thead>
					<tr class="general">
						<td>
							<? 
							//load_drop_down( 'pi_controller_urmi',this.value+'_'+$item_category, 'load_supplier_dropdown', 'supplier_td' );
							echo create_drop_down( "cbo_importer_id", 151,"select comp.id, comp.company_name from lib_company comp where comp.status_active=1 and comp.is_deleted=0 and comp.id=$cbo_importer_id order by comp.company_name",'id,company_name', 1, 'Select',0,"",1); ?>

						</td>
						<td id="supplier_td" style="display:none">
							<?
							echo create_drop_down( "cbo_supplier_id", 151, $blank_array,"", 1, "-- Select Supplier --", 0, "" );
							?>
						</td>
						<td>
							<input type="text" name="txt_item_desc" id="txt_item_desc" class="text_boxes" style="width:150px">
						</td>
						<td align="center">
							<input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('txt_item_desc').value+'_'+document.getElementById('txt_item_category').value+'_'+document.getElementById('cbo_importer_id').value+'_'+document.getElementById('cbo_supplier_id').value, 'create_item_search_list_view', 'search_div', 'pi_controller_urmi', 'setFilterGrid(\'tbl_list_search\',-1);reset_hide_field();')" style="width:100px;" />
						</td>
					</tr>
			</table>
			<table width="100%" style="margin-top:5px">
					<tr>
						<td colspan="5">
							<div style="width:100%; margin-top:10px; margin-left:10px" id="search_div" align="left"></div>
						</td>
					</tr>
				</table>
			</fieldset>
		</form>
	</div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if($action=="create_item_search_list_view")
{
	$data = explode("_",$data);

	$item_category_id =$data[1];
	$company_id =$data[2];

	if($item_category_id==1) $field_name="product_name_details"; else $field_name="item_description";

	if($company_id==0) { echo "Please Select Company First."; die; }
	if($data[3]==0) $supplier_id="%%"; else $supplier_id =$data[3];

	$supplier_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');
	if($item_category_id==1)
	{
		$sql = "select id, item_category_id, supplier_id, lot, product_name_details, unit_of_measure from product_details_master where company_id=$company_id and item_category_id=$item_category_id and supplier_id like '$supplier_id' and product_name_details like '%".trim($data[0])."%' and status_active=1 and is_deleted=0";

		$arr=array (0=>$item_category,1=>$supplier_arr,4=>$unit_of_measurement);

		echo create_list_view("tbl_list_search", "Item Category, Supplier, Lot No, Yarn Description, UOM", "100,170,100,260","770","250",0, $sql, "js_set_value", "id", "", 1, "item_category_id,supplier_id,0,0,unit_of_measure", $arr , "item_category_id,supplier_id,lot,product_name_details,unit_of_measure", "",'','0,0,0,0,0','',1);
	}
	elseif($item_category_id==5 || $item_category_id==6 || $item_category_id==7 || $item_category_id==23 || $item_category_id==101)
	{
		$sql = "select min(id) as id, item_category_id, supplier_id, item_group_id, item_description, item_size, unit_of_measure 
		from product_details_master 
		where company_id=$company_id and item_category_id=$item_category_id and supplier_id like '$supplier_id' and item_description like '%".trim($data[0])."%' and status_active=1 and is_deleted=0
		group by item_category_id, supplier_id, item_group_id, item_description, item_size, unit_of_measure";
		// echo $sql;

		$item_group_arr=return_library_array( "select id, item_name from lib_item_group",'id','item_name');
		$arr=array (0=>$item_category,1=>$supplier_arr,2=>$item_group_arr,5=>$unit_of_measurement);

		echo create_list_view("tbl_list_search", "Item Category, Supplier, Item Group, Item Description, Item Size, UOM", "120,120,120,160,90","770","250",0, $sql, "js_set_value", "id", "", 1, "item_category_id,supplier_id,item_group_id,0,0,unit_of_measure", $arr , "item_category_id,supplier_id,item_group_id,item_description,item_size,unit_of_measure", "",'','0,0,0,0,0,0','',1);

	}
	else
	{
		$sql = "select id, item_category_id, supplier_id, item_group_id, item_description, item_size, unit_of_measure from product_details_master where company_id=$company_id and item_category_id in(select category_id from lib_item_category_list where category_type=1) and entry_form<>24 and supplier_id like '$supplier_id' and item_description like '%".trim($data[0])."%' and status_active=1 and is_deleted=0";
		//echo $sql;

		$item_group_arr=return_library_array( "select id, item_name from lib_item_group",'id','item_name');
		$arr=array (0=>$item_category,1=>$supplier_arr,2=>$item_group_arr,5=>$unit_of_measurement);

		echo create_list_view("tbl_list_search", "Item Category, Supplier, Item Group, Item Description, Item Size, UOM", "120,120,120,160,90","770","250",0, $sql, "js_set_value", "id", "", 1, "item_category_id,supplier_id,item_group_id,0,0,unit_of_measure", $arr , "item_category_id,supplier_id,item_group_id,item_description,item_size,unit_of_measure", "",'','0,0,0,0,0,0','',1);

	}
	//echo $sql;
	exit();
}

if( $action == 'populate_data_item_form' )
{
	$data=explode('**',$data);
	//print_r($data);
	//die;
	$item_id=$data[0];
	$item_category_id=$data[1];
	$tblRow=$data[2];

	if($item_category_id==1)
	{
		$count_arr=return_library_array( "select id, yarn_count from lib_yarn_count WHERE status_active = 1 AND is_deleted = 0 ORDER BY yarn_count",'id','yarn_count');
		$color_array=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0 ORDER BY color_name",'id','color_name');

		$data_array=sql_select("select id, lot, product_name_details, yarn_count_id, unit_of_measure from product_details_master where id in($item_id)");
		foreach($data_array as $row)
		{
			$tblRow++;
			?>
			<tr class="general  niazi" id="row_<? echo $tblRow; ?>">
				<!-- <td>
                    <input type="text" name="hsCode_<? //echo $tblRow; ?>" id="hsCode_<? //echo $tblRow; ?>" class="text_boxes" value="" style="width:40px;" />
                </td> -->
                <td>
                    <input type="text" name="lot[]" id="lot_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('lot')];?>" style="width:80px" maxlength="200" onDblClick="openmypage_item_desc(<? echo $tblRow; ?>);" placeholder="Double Click" readonly/>
                    <input type="hidden" name="itemProdId[]" id="itemProdId_<? echo $tblRow; ?>" readonly value="<? echo $row[csf('id')];?>"/>
                </td>
                <td>
                    <? echo create_drop_down( "countName_".$tblRow, 90, $count_arr,'', 1, '-Select-', $row[csf('yarn_count_id')],"",1, '', '', '', '', '', '', 'countName[]'); ?>
                </td>
                <td>
                    <input type="text" name="itemdescription[]" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" style="width:200px" value="<? echo $row[csf('product_name_details')];?>" disabled/>
                </td>
                <td>
                    <? //echo create_drop_down( "yarnColor_".$tblRow, 110, $color_array,'', 1, '-Select-',0,"",0); ?>
                    <input type="text" name="colorName[]" id="colorName_<? echo $tblRow; ?>" class="text_boxes" onFocus="add_auto_complete( <? echo $tblRow; ?> )" style="width:100px" onBlur="fn_add_color_id(<? echo $tblRow; ?>)"  maxlength="50" <? echo $disable; ?>/>
                    <input type="hidden" name="colorId[]" id="colorId_<? echo $tblRow; ?>" class="text_boxes" value=""/>
                </td>
                <td>
                    <? echo create_drop_down( "colorRange_".$tblRow, 110, $color_range,'', 1, '-Select-',0,"",0, '', '', '', '', '', '', 'colorRange[]'); ?>
                </td>
                <td>
                    <?
                        echo create_drop_down( "uom_".$tblRow, 60, $unit_of_measurement,'', 0, '',12,'12',1, '', '', '', '', '', '', 'uom[]');
                    ?>
                </td>
				<td>
					<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="" style="width:61px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" />
				</td>
				<td>
					<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="" style="width:45px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" />
				</td>
				<td>
					<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="" style="width:75px;" readonly/>
					<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly/>
				</td>
				<td width="65">
					<input type="button" name="increase[]" id="increase_<? echo $tblRow; ?>" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( <? echo $tblRow; ?> )" />
					<input type="button" name="decrease[]" id="decrease_<? echo $tblRow; ?>" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(<? echo $tblRow; ?>);" />
				</td>
			</tr>
		<?
		}
	}
	else
	{
		$data_array=sql_select("select id, item_category_id, item_group_id, item_description, item_size, unit_of_measure from product_details_master where id in($item_id)");
		foreach($data_array as $row)
		{
			$tblRow++;
			?>
			<tr class="general" id="row_<? echo $tblRow; ?>">
				<td>
					<?
					if($item_category_id==101)
					{
						echo create_drop_down( "itemcategory_$tblRow", 120, "SELECT CATEGORY_ID, SHORT_NAME FROM lib_item_category_list WHERE CATEGORY_ID=".$row[csf('item_category_id')]." AND status_active = 1 AND is_deleted = 0", 'item_category_id,SHORT_NAME', 0, '-Select-',"", "", 1, '', '', '', '', '', '', 'itemcategory[]');
					 }else{
						echo create_drop_down( "itemcategory_$tblRow", 120, $general_item_category, '', 0, '-Select-', $row[csf('item_category_id')], "", 1, '', '', '', '', '', '', 'itemcategory[]');
					 }
                    ?>
                </td>
                <td>
                    <input type="text" name="hsCode[]" id="hsCode_<? echo $tblRow; ?>" class="text_boxes" value="" style="width:40px;" />
                </td>
                <td>
					<?
						//echo $row[csf('item_group_id')];
						echo create_drop_down( "itemgroupid_".$tblRow, 120, "SELECT id,item_name FROM lib_item_group WHERE item_category =".$row[csf('item_category_id')]." AND status_active = 1 AND is_deleted = 0 ORDER BY item_name ASC",'id,item_name', 1, '-Select-',$row[csf('item_group_id')],"get_php_form_data( this.value+'**'+'uom_$tblRow', 'get_uom', 'requires/pi_controller_urmi' );",1, '', '', '', '', '', '', 'itemgroupid[]');
					?>
				</td>
				<td>
					<input type="text" name="itemdescription[]" id="itemdescription_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('item_description')]; ?>" style="width:160px" maxlength="200" <? echo $disable; ?> onDblClick="openmypage_item_desc(<? echo $tblRow; ?>);" placeholder="Double Click" readonly/>
					<input type="hidden" name="itemProdId[]" id="itemProdId_<? echo $tblRow; ?>" readonly value="<? echo $row[csf('id')]; ?>"/>
				</td>
				<td>
					<input type="text" name="itemSize[]" id="itemSize_<? echo $tblRow; ?>" class="text_boxes" value="<? echo $row[csf('item_size')]; ?>" style="width:60px;" maxlength="50" disabled="disabled"/>
				</td>
				<td>
					<?
						echo create_drop_down( "uom_$tblRow", 50, $unit_of_measurement,'', 0, '',$row[csf('unit_of_measure')],'',1, '', '', '', '', '', '', 'uom[]');
					?>
				</td>
				<td>
					<input type="text" name="quantity[]" id="quantity_<? echo $tblRow; ?>" class="text_boxes_numeric" value="" style="width:80px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" />
				</td>
				<td>
					<input type="text" name="rate[]" id="rate_<? echo $tblRow; ?>" class="text_boxes_numeric" value="" style="width:75px;" onKeyUp="calculate_amount(<? echo $tblRow; ?>)" />
				</td>
				<td>
					<input type="text" name="amount[]" id="amount_<? echo $tblRow; ?>" class="text_boxes_numeric" value="" style="width:85px;" readonly/>
					<input type="hidden" name="updateIdDtls[]" id="updateIdDtls_<? echo $tblRow; ?>" readonly/>
				</td>
				<td width="65">
					<input type="button" name="increase[]" id="increase_<? echo $tblRow; ?>" style="width:30px" class="formbuttonplasminus" value="+" onClick="add_break_down_tr( <? echo $tblRow; ?> )" />
					<input type="button" name="decrease[]" id="decrease_<? echo $tblRow; ?>" style="width:30px" class="formbuttonplasminus" value="-" onClick="fn_deleteRow(<? echo $tblRow; ?>);" />
				</td>
			</tr>
		<?
		}
	}
	exit();
}

if($action=="approvalUser_popup")
{
	echo load_html_head_contents("User Info", "../../../", 1, 1,'','','');
	extract($_REQUEST);
	//echo $menu_id;
	?>
	<script>

		function js_set_value( str )
		{
			//alert(str)
			var splitData = str.split("_");
			document.getElementById('hdn_user_id').value=splitData[0];
			document.getElementById('hdn_user_name').value=splitData[1];
			parent.emailwindow.hide();
		}

    </script>
	<input type="hidden" name="hdn_user_name" id="hdn_user_name" class="text_boxes" style="width:70px">
    <input type="hidden" name="hdn_user_id" id="hdn_user_id" class="text_boxes" style="width:70px">
	<?
	$sql= "select a.id, a.user_name, a.user_full_name from user_passwd a, user_priv_mst b where a.id=b.user_id and a.valid=1 and b.main_menu_id=$menu_id and b.valid=1 and b.approve_priv=1 order by a.id ASC";

	echo create_list_view("list_view", "User ID, User Name, User Full Name","60,80,150","360","300",0, $sql , "js_set_value", "id,user_name", "", 1, "0,0,0", $arr, "id,user_name,user_full_name", "","setFilterGrid('list_view',-1)",'0,0,0') ;
	exit();
}

if ($action == "cross_check_popup") 
{
	echo load_html_head_contents("Cross Check Details", "../../../", 1, 1,'','','');
	extract($_REQUEST);

	$pi_cross_check_array = array(1=>"Yarn Price checked", 2=>"Trims Price Checked", 3=>"Consumption Checked", 4=>"Pilling Test", 5=>"Shrinkage test", 6=>"High Risk Analysis test");

	if($pi_id != "")
	{
		$cross_check_items = return_field_value("cross_check_activity_ids","com_cross_check_activity","pi_id=$pi_id and status_active=1","cross_check_activity_ids");
		$id = return_field_value("id","com_cross_check_activity","pi_id=$pi_id and status_active=1","id");
	}

	$cross_check_items = explode(",", chop($cross_check_items,","));
	//echo $id;die;

	?>
	<script>
	var activity_id = "<? echo $id;?>";
	//alert(activity_id);
		function js_set_value( str )
		{
			var val = $(str).val();
			var id = "#cross_checked_item_"+val;
			if(!$(id).is(':checked')){
				$(id).attr("checked", true);
			}else{
				$(id).attr("checked", false);
			}

		}
		function set_checkbox_value(str){
			var id = "#cross_checked_item_"+str;
			if(!$(id).is(':checked')){
				$(id).attr("checked", true);
			}else{
				$(id).attr("checked", false);
			}
		}
		function check_all_data(is_checked)
		{
			//alert(is_checked);
			$("#crosscheckform").find('input[type="checkbox"]').each(function(){
				if(is_checked==''){//$(this).is(':checked')
					$(this).attr("checked",false);
				}else{
					$(this).attr("checked",true);
				}
			});
			$(this).val(99);
		}
		function set_cross_check_value(){
			var checked_items="";
			$("#crosscheckform").find('input[type="checkbox"]:checked').each(function(){
				checked_items += $(this).val()+"_";

			});
			//alert(checked_items);
			$('#cross_checked_item').val(checked_items);
			$('#update_a_id').val(activity_id);
			parent.emailwindow.hide();
		}

	</script>
	</head>

	<body>
	<div align="center" style="width:500px;" >
		<form name="crosscheckform" id="crosscheckform"  autocomplete="off">
		<table cellpadding="0" cellspacing="0" width="500" border="1" class="rpt_table" rules="all" align="center">
			<thead>
				<tr>
					<th width="40">SL</th>
					<th width="80">Checked/<br/>Unchecked</th>
					<th width="">Checked/Unchecked Item Details</th>
				</tr>
			</thead>
			<tbody>
		<?
		$i=1;
		foreach ($pi_cross_check_array as $key => $value) {
			if($i%2==0) $bg_color = "#E9F3FF";
				else $bg_color = "#FFFFFF";
		?>
			<tr bgcolor="<? echo $bg_color;?>" onClick="set_checkbox_value(<? echo $i;?>)" style="cursor:pointer">
				<td align="center"><? echo $i;?></td>
				<td align="center">
				<input type="checkbox" name="cross_checked_item_<? echo $i;?>" id="cross_checked_item_<? echo $i;?>" class="cross_check_item" value="<? echo $key;?>" onClick="js_set_value(this);" readonly/> </td>
				<td> <? echo $value; ?></td>
			</tr>
		<?
		$i++;
		}

		?>
			</tbody>
			<tfoot>
				<tr><td colspan="3">&nbsp;</td></tr>
				<tr>
					<td align="left" colspan="2">
						<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data(this.checked)" value="99"/>
						<strong>Check / Uncheck All</strong>
					</td>
					<td align="left">
						<input type="button" name="close" onClick="set_cross_check_value()" class="formbutton" value="Close" style="width:100px" />
						<input type="hidden" name="cross_checked_item" id="cross_checked_item" class="text-boxes">
						<input type="hidden" name="update_a_id" id="update_a_id" class="text-boxes">
					</td>
				</tr>
			</tfoot>
        </table>
		<?
		foreach ($cross_check_items as $value) {
			?>
			<script>
				var id = "#cross_checked_item_"+<? echo $value;?>;
				$(id).attr("checked",true).val(<? echo $value;?>);
				//$("#cross_checked_item_"+val).val(val);
			</script>
			<?
		}
		?>
		</form>
	</div>
	</body>
	</html>
	<?
	exit();
}
	
if ($action=="load_drop_down_search")
{
	$data=explode('_',$data);
	if($data[1]==1) echo '<input type="text" name="txt_search_common" id="txt_search_common" class="text_boxes" style="width:160px" autocomplete=off />';
	if($data[1]==2) echo create_drop_down( "txt_search_common", 170, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$data[0]' and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90))  $buyer_cond order by buyer_name","id,buyer_name", 1, "-- All Buyer --", $selected, "" ,0);
	if($data[1]==3) echo create_drop_down( "txt_search_common", 170, "select bank_name,id from lib_bank where is_deleted=0  and status_active=1 and lien_bank=1 order by bank_name","id,bank_name", 1, "-- All Lein Bank --", $selected, "",0,"" );

    if($data[1]==4) echo '<input type="text" name="txt_search_common" id="txt_search_common" class="text_boxes" style="width:160px" autocomplete=off />';
	exit();
}

if ($action=="file_popup")
{

  	echo load_html_head_contents("Popup Info","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	//echo $lien_bank;die;
	?>
	<script>
		function js_set_value(str)
		{
			$("#hide_file_no").val(str);
			parent.emailwindow.hide();
		}
		function set_caption(id)
		{
		if(id==1)  document.getElementById('search_by_td_up').innerHTML='Enter File No';
		if(id==2)  document.getElementById('search_by_td_up').innerHTML='Enter Buyer Name';
		if(id==3)  document.getElementById('search_by_td_up').innerHTML='Enter Lein Bank';
	    if(id==4)  document.getElementById('search_by_td_up').innerHTML='Enter SC/LC';
		}
	</script>
	</head>
	<body>
	    <div style="width:530px">
		    <form name="search_order_frm"  id="search_order_frm">
			    <fieldset style="width:530px">
			        <table cellspacing="0" cellpadding="0" border="1" rules="all" class="rpt_table" align="center" width="100%">
			            <thead>
			            	<th>Year</th>
			                <th>Search By</th>
			                <th id="search_by_td_up">Enter File No</th>
			                <th>
				                <input type="hidden" name="txt_company_id" id="txt_company_id" value="<?  echo $company_id; ?>"/>
				               
				                <input type="hidden" name="txt_sclc_id" id="txt_sclc_id" value="<? //echo ?>"/>
				                <input type="hidden" name="txt_selected_file" id="txt_selected_file" value=""/>
			                </th>
			            </thead>
			            <tbody>
			                <tr class="general">
			                	<td>
			                    <?
								$sql=sql_select("select lc_year as lc_sc_year from com_export_lc where beneficiary_name='$company_id' and status_active=1 and is_deleted=0  union all select sc_year as lc_sc_year from com_sales_contract where beneficiary_name='$company_id' and status_active=1 and is_deleted=0");
								foreach($sql as $row)
								{
									$lc_sc_year[$row[csf("lc_sc_year")]]=$row[csf("lc_sc_year")];
								}
								echo create_drop_down( "cbo_year", 100,$lc_sc_year,"", 1, "-- Select --",$cbo_year);
								?>
			                    </td>
			                    <td>
			                    <?
								$sarch_by_arr=array(1=>"File No",2=>"Buyer",3=>"Lien Bank",4=>"SC/LC");
								echo create_drop_down( "cbo_search_by", 130,$sarch_by_arr,"", 0, "-- Select Search --", 1,"load_drop_down( 'pi_controller_urmi',document.getElementById('txt_company_id').value+'_'+this.value, 'load_drop_down_search', 'search_by_td' );set_caption(this.value)");
								?>
			                    </td>
			                    <td align="center" id="search_by_td">
			                    	<input type="text" name="txt_search_common" id="txt_search_common" class="text_boxes" style="width:160px" autocomplete=off />
			                    </td>
			                    <td>
			                    	<input type="button" name="show" id="show" onClick="show_list_view(document.getElementById('cbo_search_by').value+'_'+document.getElementById('txt_search_common').value+'_'+<? echo $company_id; ?>+'_'+document.getElementById('cbo_year').value+'_'+'<? echo $is_lc_sc; ?>'+'_'+'<? echo $lc_sc_id; ?>','search_file_info','search_div_file','pi_controller_urmi','setFilterGrid(\'list_view\',-1)')" class="formbutton" style="width:100px;" value="Show" />
			                    </td>
			                </tr>
			            </tbody>
			        </table>
			        <table width="100%">
			            <tr>
			                <td>
			                	<div style="width:560px; margin-top:5px" id="search_div_file" align="left"></div>
			                </td>
			            </tr>
			        </table>
			    </fieldset>
		    </form>
	    </div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if ($action=="order_file_popup")
{

  	echo load_html_head_contents("Popup Info","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	//echo $lien_bank;die;
	?>
	<script>
		function js_set_value(str)
		{
			$("#hide_order_file_no").val(str);
			parent.emailwindow.hide();
		}
		function set_caption(id)
		{
		if(id==1)  document.getElementById('search_by_td_up').innerHTML='Enter File No';
		if(id==2)  document.getElementById('search_by_td_up').innerHTML='Enter Buyer Name';
		if(id==3)  document.getElementById('search_by_td_up').innerHTML='Enter Lein Bank';
	    if(id==4)  document.getElementById('search_by_td_up').innerHTML='Enter SC/LC';
		}
	</script>
	</head>
	<body>
	    <div style="width:530px">
		    <form name="search_order_frm"  id="search_order_frm">
			    <fieldset style="width:530px">
			        <table cellspacing="0" cellpadding="0" border="1" rules="all" class="rpt_table" align="center" width="100%">
			            <thead>
			            	<th>Year</th>
			                <th>Search By</th>
			                <th id="search_by_td_up">Enter File No</th>
			                <th>
				                <input type="hidden" name="txt_company_id" id="txt_company_id" value="<?  echo $company_id; ?>"/>
				               
				                <input type="hidden" name="txt_sclc_id" id="txt_sclc_id" value="<? //echo ?>"/>
				                <input type="hidden" name="txt_selected_file" id="txt_selected_file" value=""/>
			                </th>
			            </thead>
			            <tbody>
			                <tr class="general">
			                	<td>
			                    <?
								$sql=sql_select("select lc_year as lc_sc_year from com_export_lc where beneficiary_name='$company_id' and status_active=1 and is_deleted=0  union all select sc_year as lc_sc_year from com_sales_contract where beneficiary_name='$company_id' and status_active=1 and is_deleted=0");
								foreach($sql as $row)
								{
									$lc_sc_year[$row[csf("lc_sc_year")]]=$row[csf("lc_sc_year")];
								}
								echo create_drop_down( "cbo_year", 100,$lc_sc_year,"", 1, "-- Select --",$cbo_year);
								?>
			                    </td>
			                    <td>
			                    <?
								$sarch_by_arr=array(1=>"File No",2=>"Buyer",3=>"Lien Bank",4=>"SC/LC");
								echo create_drop_down( "cbo_search_by", 130,$sarch_by_arr,"", 0, "-- Select Search --", 1,"load_drop_down( 'pi_controller_urmi',document.getElementById('txt_company_id').value+'_'+this.value, 'load_drop_down_search', 'search_by_td' );set_caption(this.value)");
								?>
			                    </td>
			                    <td align="center" id="search_by_td">
			                    	<input type="text" name="txt_search_common" id="txt_search_common" class="text_boxes" style="width:160px" autocomplete=off />
			                    </td>
			                    <td>
			                    	<input type="button" name="show" id="show" onClick="show_list_view(document.getElementById('cbo_search_by').value+'_'+document.getElementById('txt_search_common').value+'_'+<? echo $company_id; ?>+'_'+document.getElementById('cbo_year').value+'_'+'<? echo $is_lc_sc1; ?>'+'_'+'<? echo $lc_sc_id1; ?>','search_order_file_info','search_div_file','pi_controller_urmi','setFilterGrid(\'list_view\',-1)')" class="formbutton" style="width:100px;" value="Show" />
			                    </td>
			                </tr>
			            </tbody>
			        </table>
			        <table width="100%">
			            <tr>
			                <td>
			                	<div style="width:560px; margin-top:5px" id="search_div_file" align="left"></div>
			                </td>
			            </tr>
			        </table>
			    </fieldset>
		    </form>
	    </div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if ($action=="search_file_info")
{
	$ex_data = explode("_",$data);
	// print_r($ex_data);die;
	$cbo_search_by = $ex_data[0];

	$txt_search_common = $ex_data[1];
	$company_id = $ex_data[2];
	//$buyer_id = $ex_data[3];
	//$lien_bank_id = $ex_data[4];
	$cbo_year = $ex_data[3];
	$is_lc_sc = str_replace("'","",$ex_data[4]);
	$lc_sc_id = str_replace("'","",$ex_data[5]);
	//echo $cbo_year; die;
	//if($buyer_id!=0) $buy_query="and buyer_name='$buyer_id'"; else  $buy_query="";
	//if($lien_bank_id!=0) $lien_bank_id="and lien_bank='$lien_bank_id'"; else  $lien_bank_id="";
	if($cbo_year!=0)
	{
		$year_cond_sc="and sc_year='$cbo_year'";
		$year_cond_lc="and lc_year='$cbo_year'";
	}
	else
	{
		$year_cond_sc="";
		$year_cond_lc="";
	}
	//$year_cond_sc="and sc_year='".date("Y")."'";
	//$year_cond_lc="and lc_year='".date("Y")."'";
	//echo $lien_bank_id;die;

	//if($txt_search_common==0)$txt_search_common="";

    $txt_search_common = trim($txt_search_common);
    $search_cond ="";$search_cond_lc="";$search_cond_sc="";
    if($txt_search_common!="")
    {
        if($cbo_search_by==1)
        {
            $search_cond .= " and internal_file_no like '%$txt_search_common%'";
        }
        else if($cbo_search_by==2)
        {
            $search_cond .= " and buyer_name='$txt_search_common'";
        }
        else if($cbo_search_by==3)
        {
            $search_cond .= " and lien_bank='$txt_search_common'";
        }
        else if($cbo_search_by==4)
        {
            $search_cond_lc .= " and export_lc_no='$txt_search_common'";
            $search_cond_sc .= " and contract_no='$txt_search_common'";
        }
    }
    //echo $cbo_search_by."**".$txt_search_common; die;
    //echo $cbo_search_by."**".$search_cond_lc."**".$search_cond_sc; die;
    if($db_type == 0)
    {
		$sql = "select a.id,a.beneficiary_name, a.internal_file_no, a.lien_bank, a.buyer_name ,  a.lc_sc_year , group_concat(a.export_lc_no) as export_lc_no,a.is_lc_sc
		from (
		select id,beneficiary_name, internal_file_no, lien_bank, buyer_name , lc_year as lc_sc_year, group_concat(export_lc_no) as export_lc_no, 'export' as type, 1 as is_lc_sc
		from com_export_lc
		where beneficiary_name='$company_id' and status_active=1 and is_deleted=0 $buy_query $lien_bank_id $year_cond_lc $search_cond $search_cond_lc
		group by id,internal_file_no, lc_year, beneficiary_name, buyer_name , lien_bank
		union all
		select id,beneficiary_name, internal_file_no, lien_bank, buyer_name, sc_year as lc_sc_year,group_concat(contract_no) as export_lc_no, 'import' as type, 2 as is_lc_sc
		from com_sales_contract
		where beneficiary_name='$company_id'
		and status_active=1 and is_deleted=0 $buy_query $lien_bank_id $year_cond_sc $search_cond $search_cond_sc
		group by id,internal_file_no, sc_year, beneficiary_name, buyer_name , lien_bank
		) a
		group by a.id,a.beneficiary_name, a.internal_file_no, a.lien_bank, a.buyer_name , a.lc_sc_year,a.is_lc_sc";
    }
    else
    {
    	/*$sql = "select a.id,a.beneficiary_name, a.internal_file_no, a.lien_bank, a.buyer_name ,  a.lc_sc_year , rtrim(xmlagg(xmlelement(e,a.export_lc_no,',').extract('//text()') order by a.export_lc_no).GetClobVal(),',') AS export_lc_no
		from (
		select id,beneficiary_name, internal_file_no, lien_bank, buyer_name , lc_year as lc_sc_year, listagg(cast(export_lc_no as varchar(4000)),',') within group(order by export_lc_no) as export_lc_no, 'export' as type
		from com_export_lc
		where beneficiary_name='$company_id' and status_active=1 and is_deleted=0 $buy_query $lien_bank_id $year_cond_lc $search_cond $search_cond_lc
		group by id,internal_file_no, lc_year, beneficiary_name, buyer_name , lien_bank
		union all
		select id,beneficiary_name, internal_file_no, lien_bank, buyer_name, sc_year as lc_sc_year,listagg(cast(contract_no as varchar(4000)),',') within group(order by contract_no) as export_lc_no, 'import' as type
		from com_sales_contract
		where beneficiary_name='$company_id'
		and status_active=1 and is_deleted=0 $buy_query $lien_bank_id $year_cond_sc $search_cond $search_cond_sc
		group by id,internal_file_no, sc_year, beneficiary_name, buyer_name , lien_bank
		) a
		group by a.id,a.beneficiary_name, a.internal_file_no, a.lien_bank, a.buyer_name , a.lc_sc_year";*/
		
		$sql = "SELECT a.id, a.beneficiary_name, a.internal_file_no, a.lien_bank, a.buyer_name ,  a.lc_sc_year , listagg(cast(a.export_lc_no as varchar2(4000)),',') within group (order by a.export_lc_no) as export_lc_no ,a.is_lc_sc from (
		select id,beneficiary_name, internal_file_no, lien_bank, buyer_name , lc_year as lc_sc_year,  listagg(cast(export_lc_no as varchar2(4000)),',') within group (order by export_lc_no) as export_lc_no, 'export' as type, 1 as is_lc_sc
		from com_export_lc
		where beneficiary_name='$company_id' and status_active=1 and is_deleted=0 $buy_query $lien_bank_id $year_cond_lc $search_cond $search_cond_lc
		group by id,internal_file_no, lc_year, beneficiary_name, buyer_name , lien_bank
		union all
		select id,beneficiary_name, internal_file_no, lien_bank, buyer_name, sc_year as lc_sc_year, listagg(cast(contract_no as varchar2(4000)),',') within group (order by contract_no) as export_lc_no, 'import' as type, 2 as is_lc_sc
		from com_sales_contract		
		where beneficiary_name='$company_id'
		and status_active=1 and is_deleted=0 $buy_query $lien_bank_id $year_cond_sc $search_cond $search_cond_sc
		group by id,internal_file_no, sc_year, beneficiary_name, buyer_name , lien_bank
		) a
		group by a.id,a.beneficiary_name, a.internal_file_no, a.lien_bank, a.buyer_name , a.lc_sc_year, a.is_lc_sc
		order by a.id desc";
		// echo $sql;
    }
    $lein_bank_arr=return_library_array( "select bank_name,id from lib_bank where is_deleted=0  and status_active=1 and lien_bank=1 order by bank_name",'id','bank_name');
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer where is_deleted=0  and status_active=1 order by buyer_name",'id','buyer_name');
	//echo $sql;
	?>
   <div style="width:560px">
    <form name="display_file"  id="display_file">
        <table cellspacing="0" cellpadding="0" border="1" rules="all" class="rpt_table" align="center" width="100%">
            <thead>
                <th width="60">Sl NO.</td>
                <th width="80">File NO</td>
                <th width="80">Year</td>
                <th width="130"> Buyer</td>
                <th width="100"> Lien Bank</td>
                <th >SC/LC No.</td>
            </thead>
            </table>
        <table cellspacing="0" cellpadding="0" border="1" rules="all" class="rpt_table" align="center" width="100%" id="list_view">
            <tbody>
            <?
			$sql_results=sql_select($sql);
			$i=1;
			//echo count($sql_results);
			foreach($sql_results as $row)
			{
				if ($i%2==0) $bgcolor="#E9F3FF"; 
				else $bgcolor="#FFFFFF";
				//echo $row[csf("internal_file_no")];die;
				//if($db_type==2) $row[csf('export_lc_no')] = $row[csf('export_lc_no')]->load();
				if($is_lc_sc==$row[csf('is_lc_sc')] && $lc_sc_id==$row[csf('id')]){$bgcolor="#FFFF00";}else{$bgcolor=$bgcolor;};
				?>
                <tr bgcolor="<? echo $bgcolor; ?>"  onclick="js_set_value('<? echo $row[csf('internal_file_no')].'_'.$row[csf('is_lc_sc')].'_'.$row[csf('id')].'_'.$row[csf('export_lc_no')].'_'.$row[csf('lc_sc_year')];?>')" id="search<? echo $row[csf("id")]; ?>" style="cursor:pointer">
                    <td align="center" width="60"> <? echo $i;?></td>
                    <td align="center" width="80"><p><? echo $row[csf("internal_file_no")];  ?></p></td>
                    <td align="center" width="80"><p><? echo $row[csf("lc_sc_year")];  ?></p></td>
                    <td width="130"><p><? echo $buyer_name_arr[$row[csf("buyer_name")]];  ?></p></td>
                    <td width="100"><p><? echo $lein_bank_arr[$row[csf("lien_bank")]];  ?></p></td>
                    <td><p><? echo $row[csf("export_lc_no")];  ?></p></td>
                </tr>
                <?
				$i++;
			}
			?>
            </tbody>
            <input type="hidden" id="hide_file_no" name="hide_file_no"  />
        </table>
    </form>
    <script>setFilterGrid('list_view',-1)</script>
    </div>

        <?
}

if ($action=="search_order_file_info")
{
	$ex_data = explode("_",$data);
	// print_r($ex_data);die;
	$cbo_search_by = $ex_data[0];
	$txt_search_common = $ex_data[1];
	$company_id = $ex_data[2];
	//$buyer_id = $ex_data[3];
	//$lien_bank_id = $ex_data[4];
	$cbo_year = $ex_data[3];
	$is_lc_sc = str_replace("'","",$ex_data[4]);
	$lc_sc_id = str_replace("'","",$ex_data[5]);
	//echo $cbo_year; die;
	//if($buyer_id!=0) $buy_query="and buyer_name='$buyer_id'"; else  $buy_query="";
	//if($lien_bank_id!=0) $lien_bank_id="and lien_bank='$lien_bank_id'"; else  $lien_bank_id="";
	if($cbo_year!=0)
	{
		$year_cond_sc="and sc_year='$cbo_year'";
		$year_cond_lc="and lc_year='$cbo_year'";
	}
	else
	{
		$year_cond_sc="";
		$year_cond_lc="";
	}
	//$year_cond_sc="and sc_year='".date("Y")."'";
	//$year_cond_lc="and lc_year='".date("Y")."'";
	//echo $lien_bank_id;die;

	//if($txt_search_common==0)$txt_search_common="";

    $txt_search_common = trim($txt_search_common);
    $search_cond ="";$search_cond_lc="";$search_cond_sc="";
    if($txt_search_common!="")
    {
        if($cbo_search_by==1)
        {
            $search_cond .= " and internal_file_no like '%$txt_search_common%'";
        }
        else if($cbo_search_by==2)
        {
            $search_cond .= " and buyer_name='$txt_search_common'";
        }
        else if($cbo_search_by==3)
        {
            $search_cond .= " and lien_bank='$txt_search_common'";
        }
        else if($cbo_search_by==4)
        {
            $search_cond_lc .= " and export_lc_no='$txt_search_common'";
            $search_cond_sc .= " and contract_no='$txt_search_common'";
        }
    }
    //echo $cbo_search_by."**".$txt_search_common; die;
    //echo $cbo_search_by."**".$search_cond_lc."**".$search_cond_sc; die;
    if($db_type == 0)
    {
		$sql = "select a.id,a.beneficiary_name, a.internal_file_no, a.lien_bank, a.buyer_name ,  a.lc_sc_year , group_concat(a.export_lc_no) as export_lc_no,a.is_lc_sc
		from (
		select id,beneficiary_name, internal_file_no, lien_bank, buyer_name , lc_year as lc_sc_year, group_concat(export_lc_no) as export_lc_no, 'export' as type, 1 as is_lc_sc
		from com_export_lc
		where beneficiary_name='$company_id' and status_active=1 and is_deleted=0 $buy_query $lien_bank_id $year_cond_lc $search_cond $search_cond_lc
		group by id,internal_file_no, lc_year, beneficiary_name, buyer_name , lien_bank
		union all
		select id,beneficiary_name, internal_file_no, lien_bank, buyer_name, sc_year as lc_sc_year,group_concat(contract_no) as export_lc_no, 'import' as type, 2 as is_lc_sc
		from com_sales_contract
		where beneficiary_name='$company_id'
		and status_active=1 and is_deleted=0 $buy_query $lien_bank_id $year_cond_sc $search_cond $search_cond_sc
		group by id,internal_file_no, sc_year, beneficiary_name, buyer_name , lien_bank
		) a
		group by a.id,a.beneficiary_name, a.internal_file_no, a.lien_bank, a.buyer_name , a.lc_sc_year,a.is_lc_sc";
    }
    else
    {
    	/*$sql = "select a.id,a.beneficiary_name, a.internal_file_no, a.lien_bank, a.buyer_name ,  a.lc_sc_year , rtrim(xmlagg(xmlelement(e,a.export_lc_no,',').extract('//text()') order by a.export_lc_no).GetClobVal(),',') AS export_lc_no
		from (
		select id,beneficiary_name, internal_file_no, lien_bank, buyer_name , lc_year as lc_sc_year, listagg(cast(export_lc_no as varchar(4000)),',') within group(order by export_lc_no) as export_lc_no, 'export' as type
		from com_export_lc
		where beneficiary_name='$company_id' and status_active=1 and is_deleted=0 $buy_query $lien_bank_id $year_cond_lc $search_cond $search_cond_lc
		group by id,internal_file_no, lc_year, beneficiary_name, buyer_name , lien_bank
		union all
		select id,beneficiary_name, internal_file_no, lien_bank, buyer_name, sc_year as lc_sc_year,listagg(cast(contract_no as varchar(4000)),',') within group(order by contract_no) as export_lc_no, 'import' as type
		from com_sales_contract
		where beneficiary_name='$company_id'
		and status_active=1 and is_deleted=0 $buy_query $lien_bank_id $year_cond_sc $search_cond $search_cond_sc
		group by id,internal_file_no, sc_year, beneficiary_name, buyer_name , lien_bank
		) a
		group by a.id,a.beneficiary_name, a.internal_file_no, a.lien_bank, a.buyer_name , a.lc_sc_year";*/
		
		$sql = "SELECT a.id, a.beneficiary_name, a.internal_file_no, a.lien_bank, a.buyer_name ,  a.lc_sc_year , listagg(cast(a.export_lc_no as varchar2(4000)),',') within group (order by a.export_lc_no) as export_lc_no ,a.is_lc_sc from (
		select id,beneficiary_name, internal_file_no, lien_bank, buyer_name , lc_year as lc_sc_year,  listagg(cast(export_lc_no as varchar2(4000)),',') within group (order by export_lc_no) as export_lc_no, 'export' as type, 1 as is_lc_sc
		from com_export_lc
		where beneficiary_name='$company_id' and status_active=1 and is_deleted=0 $buy_query $lien_bank_id $year_cond_lc $search_cond $search_cond_lc
		group by id,internal_file_no, lc_year, beneficiary_name, buyer_name , lien_bank
		union all
		select id,beneficiary_name, internal_file_no, lien_bank, buyer_name, sc_year as lc_sc_year, listagg(cast(contract_no as varchar2(4000)),',') within group (order by contract_no) as export_lc_no, 'import' as type, 2 as is_lc_sc
		from com_sales_contract		
		where beneficiary_name='$company_id'
		and status_active=1 and is_deleted=0 $buy_query $lien_bank_id $year_cond_sc $search_cond $search_cond_sc
		group by id,internal_file_no, sc_year, beneficiary_name, buyer_name , lien_bank
		) a
		group by a.id,a.beneficiary_name, a.internal_file_no, a.lien_bank, a.buyer_name , a.lc_sc_year, a.is_lc_sc
		order by a.id desc";
		// echo $sql;
    }
    $lein_bank_arr=return_library_array( "select bank_name,id from lib_bank where is_deleted=0  and status_active=1 and lien_bank=1 order by bank_name",'id','bank_name');
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer where is_deleted=0  and status_active=1 order by buyer_name",'id','buyer_name');
	//echo $sql;
	?>
   <div style="width:560px">
    <form name="display_file"  id="display_file">
        <table cellspacing="0" cellpadding="0" border="1" rules="all" class="rpt_table" align="center" width="100%">
            <thead>
                <th width="60">Sl NO.</td>
                <th width="80">File NO</td>
                <th width="80">Year</td>
                <th width="130"> Buyer</td>
                <th width="100"> Lien Bank</td>
                <th >SC/LC No.</td>
            </thead>
            </table>
        <table cellspacing="0" cellpadding="0" border="1" rules="all" class="rpt_table" align="center" width="100%" id="list_view">
            <tbody>
            <?
			$sql_results=sql_select($sql);
			$i=1;
			//echo count($sql_results);
			foreach($sql_results as $row)
			{
				if ($i%2==0) $bgcolor="#E9F3FF"; 
				else $bgcolor="#FFFFFF";
				//echo $row[csf("internal_file_no")];die;
				//if($db_type==2) $row[csf('export_lc_no')] = $row[csf('export_lc_no')]->load();
				if($is_lc_sc==$row[csf('is_lc_sc')] && $lc_sc_id==$row[csf('id')]){$bgcolor="#FFFF00";}else{$bgcolor=$bgcolor;};
				?>
                <tr bgcolor="<? echo $bgcolor; ?>"  onclick="js_set_value('<? echo $row[csf('internal_file_no')].'_'.$row[csf('is_lc_sc')].'_'.$row[csf('id')].'_'.$row[csf('export_lc_no')].'_'.$row[csf('lc_sc_year')];?>')" id="search<? echo $row[csf("id")]; ?>" style="cursor:pointer">
                    <td align="center" width="60"> <? echo $i;?></td>
                    <td align="center" width="80"><p><? echo $row[csf("internal_file_no")];  ?></p></td>
                    <td align="center" width="80"><p><? echo $row[csf("lc_sc_year")];  ?></p></td>
                    <td width="130"><p><? echo $buyer_name_arr[$row[csf("buyer_name")]];  ?></p></td>
                    <td width="100"><p><? echo $lein_bank_arr[$row[csf("lien_bank")]];  ?></p></td>
                    <td><p><? echo $row[csf("export_lc_no")];  ?></p></td>
                </tr>
                <?
				$i++;
			}
			?>
            </tbody>
            <input type="hidden" id="hide_order_file_no" name="hide_order_file_no"  />
        </table>
    </form>
    <script>setFilterGrid('list_view',-1)</script>
    </div>

        <?
}
if($action=='file_upload')
{
	extract($_REQUEST);
	$data_array="";
	$id=return_next_id( "id","common_photo_library", 1 ) ;
	for($i=0;$i<count($_FILES['file']);$i++)
	{
		$filename = time(). $_FILES['file'][name][$i]; 
		$location = "../../../file_upload/".$filename;
		if(move_uploaded_file( $_FILES['file']['tmp_name'][$i], $location))
		{ 
			if($data_array!="") $data_array.=",";
			$data_array .="(".$id.",".$mst_id.",'proforma_invoice','file_upload/".$filename."','2','".$filename."')";
		}
		else
		{ 
			echo 0; 
		}
		$id++; 
	}
		
		
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	
	$field_array="id,master_tble_id,form_name,image_location,file_type,real_file_name";
	$rID=sql_insert("common_photo_library",$field_array,$data_array,1);
	if($db_type==0)
	{
		if($rID)
		{
			mysql_query("COMMIT");
			echo "0**".$new_system_id[0]."**".$id_mst;
		}
		else
		{
			mysql_query("ROLLBACK");
			echo "10**".$id_mst;
		}
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID)
		{
			oci_commit($con);
			echo "0**".$new_system_id[0]."**".$id_mst;
		}
		else
		{
			oci_rollback($con);
			echo "10**".$id_mst;
		}
	}
	disconnect($con);
	die;
}

if ($action=="not_approved_cause_popup")
{
	extract($_REQUEST);
	$max_cause_id = return_field_value("max(id) as id", "fabric_booking_approval_cause", "booking_id=$pi_id and page_id=867 and entry_form=27 and approval_type=0 and status_active=1 and is_deleted=0", "id");
	$not_app_cause=return_field_value("not_approval_cause", "fabric_booking_approval_cause", "id=$max_cause_id");
	?>
	<table align="center" cellspacing="0" width="430" class="rpt_table" rules="all">
        <tr>
            <td width="420" align="center">
                <textarea name="not_appv_cause_id" id="not_appv_cause_id" class="text_area" style="width:420px; height:230px;"><? echo $not_app_cause; ?></textarea>
            </td>
        </tr>
    </table>          
	<?
}

if($action=="notes_popup")
{
	echo load_html_head_contents("Freight Info", "../../../", 1, 1,'','','');
	extract($_REQUEST);
	$hdn_notes=trim(str_replace("'","",$hdn_notes));
	$hdn_notes_arr=explode("__",$hdn_notes);
	?>
	<script>
	function add_break_down_tr(i)
	{
		var row_num=$('#tbl_list_search tbody tr').length;
		if (row_num!=i)
		{
			return false;
		}
		else
		{
			i++;
			$("#tbl_list_search tr:last").clone().find("input,select").each(function() {
				$(this).attr({
					'id': function(_, id) { var id=id.split("_"); return id[0] +"_"+ i },
					'name': function(_, name) { return name + i },
					'value': function(_, value) { return value }
					});
				}).end().appendTo("#tbl_list_search");
			//
			$("#tbl_list_search tr:eq("+i+")").removeAttr('id').attr('id','tr_'+i);
			$("#tbl_list_search tr:eq("+i+")").find('td:first').html(i);
			//$('#tbl_list_search tr:eq('+i+') td:eq(3)').attr('id','tdcause_'+i);
			//$('#slNo_'+i).html(i);
			
			//$('#txtqty_'+i).removeAttr("onBlur").attr("onBlur","fnc_percent_calculate("+i+");");
			//$('#cbocausetype_'+i).val(0);
			//$('#cbocauseid_'+i).val(0);
			//$('#txtAmt_'+i).val("");
			//$('#txtPer_'+i).val("");
			//$('#txtRemarks_'+i).val("");
			
			$('#increase_'+i).removeAttr("onClick").attr("onClick","add_break_down_tr("+i+");");
			$('#decrease_'+i).removeAttr("onClick").attr("onClick","fn_deletebreak_down_tr("+i+")");
			//$('#cbocausetype_'+i).removeAttr("onChange").attr("onChange","load_drop_down( 'export_information_entry_controller',this.value+'__'+'cbocauseid_"+i+"', 'load_drop_down_cause', 'tdcause_"+i+"' )");
			//$('#embellname_'+i).removeAttr("onchange").attr("onchange","load_drop_down('requires/pi_controller_urmi',this.value+'**'+'embelltype_"+i+"', 'load_drop_down_embelltype','embelltypeTd_"+i+"')");
			//cbocausetype_2
			//load_drop_down( 'export_information_entry_controller',this.value, 'load_drop_down_cause', 'causeTd_'".$i." );
			set_all_onclick();
		}
	}

	function fn_deletebreak_down_tr(rowNo)
	{
		var numRow = $('table#tbl_list_search tbody tr').length;
		if(rowNo!=1)
		{
			//var permission_array=permission.split("_");
			var rowid=$('#tr_'+rowNo).val();
			var index=rowNo-1
			$('#tbl_list_search tbody tr:eq('+index+')').remove();
		}
	}
	
	function fn_close()
	{
		var numRow = $('table#tbl_list_search tbody tr').length;
		var data_all=""; var tot_amt=0;
		for(i = 1; i <= numRow; i++)
		{
			var txtNotes=trim($('#txtNotes_'+i).val());
			if(txtNotes!="")
			data_all+=txtNotes+"__";
		}
		data_all = data_all.substr( 0, data_all.length - 2 );
		//alert(data_all);return;
		$('#notes_dtls_data').val(data_all);
		parent.emailwindow.hide();
	}
    </script>
    </head>
    <body>
	<div align="center" style="width:100%;" >
	<form name="invoiceFreightInfo_1"  id="invoiceFreightInfo_1" autocomplete="off">
		<table width="590" cellspacing="0" cellpadding="0" class="rpt_table" align="center" border="1" rules="all" id="tbl_list_search">
        	<thead>
            	<tr>
                	<th width="50">SL</th>
                    <th width="450">Notes</th>
                    <th><input type="hidden" id="notes_dtls_data" name="notes_dtls_data" /></th>
                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			if($hdn_notes!="" && count($hdn_notes_arr)>0)
			{
				foreach($hdn_notes_arr as $val)
				{
					if ($i%2==0)
						$bgcolor="#FFFFFF";
					else
						$bgcolor="#E9F3FF";
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
						<td align="center"><? echo $i; ?></td>
						<td><input type="text" id="txtNotes_<? echo $i;?>" name="txtNotes[]" class="text_boxes" style="width:430px;" value="<? echo $val; ?>"/></td>
						<td>
						<input type="button" id="increase_<? echo $i;?>" name="increase_<? echo $i;?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr(<? echo $i;?>)" />
						<input type="button" id="decrease_<? echo $i;?>" name="decrease_<? echo $i;?>" style="width:30px" class="formbutton" value="-" onClick="fn_deletebreak_down_tr(<? echo $i;?>);" />
                        </td>
					</tr>
					<?
					$i++;
				}
			}
			else
			{
				?>
                <tr bgcolor="<? echo $bgcolor; ?>" id="tr_1">
                    <td align="center">1</td>
                    <td><input type="text" id="txtNotes_1" name="txtNotes[]" class="text_boxes" style="width:430px;" value=""/></td>
                    <td>
                    <input type="button" id="increase_1" name="increase_1" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr(1)" />
                    <input type="button" id="decrease_1" name="decrease_1" style="width:30px" class="formbutton" value="-" onClick="fn_deletebreak_down_tr(1);" />
                    </td>
                </tr>
                <?
			}
			?>	
            </tbody>    
    	</table>
        <p style="text-align:center"><input type="button" value="Close" style="width:100px" id="btb_close" name="btn_close" onClick="fn_close()" class="formbuttonplasminus" /></p>
    </form>
	</div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}


if($action=="print_button_variable_setting")
{ 
    $print_report_format=0;
    $print_report_format=return_field_value("format_id","lib_report_template","template_name ='".$data."' and module_id=5 and report_id=183 and is_deleted=0 and status_active=1");
   	$printButton=explode(',',$print_report_format);

	foreach($printButton as $id){
		if($id==86)$buttonHtml.='<input type="button" name="printBtn4" id="printBtn4" value="Print" onClick="fnc_pi_mst(4)" style="width:100px" class="formbutton" />';	
		if($id==116)$buttonHtml.='<input type="button" name="printBtn2" id="printBtn2" value="Print 2" onClick="fnc_print_wf()" style="width:100px" class="formbutton" />';
		if($id==85)$buttonHtml.='<input type="button" name="printBtn3" id="printBtn3" value="Print 3" onClick="fnc_print_sf()" style="width:100px" class="formbutton" />';	
		if($id==751)$buttonHtml.='<input type="button" name="printBtn" id="printBtn" value="PI-Print" onClick="fnc_print_pi()" style="width:100px" class="formbutton" />';	
		if($id==137)$buttonHtml.='<input type="button" name="printBtn" id="printBtn" value="PI-Print 4" onClick="fnc_print_pi_two()" style="width:100px" class="formbutton" />';	
		if($id==479)$buttonHtml.='<input type="button" name="printBtn" id="printBtn" value="Acc." onClick="fnc_print_f()" style="width:100px" class="formbutton" />';	
	}

   echo "document.getElementById('button_data_panel').innerHTML = '".$buttonHtml."';\n";
    exit();
}
?>
