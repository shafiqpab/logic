<?
session_start();
date_default_timezone_set('Asia/Dhaka');
extract($_REQUEST);
if ($_SESSION['logic_erp']['user_id'] == "") {
    header("location:login.php");
    die;
}
$user_id=$_SESSION['logic_erp']['user_id'];

require_once('../../../../includes/common.php');
require_once('../../../../includes/class4/class.conditions.php');
require_once('../../../../includes/class4/class.reports.php');
require_once('../../../../includes/class4/class.yarns.php');
require_once('../../../../includes/class4/class.conversions.php');
require_once('../../../../includes/class4/class.emblishments.php');
require_once('../../../../includes/class4/class.commisions.php');
require_once('../../../../includes/class4/class.commercials.php');
require_once('../../../../includes/class4/class.others.php');
require_once('../../../../includes/class4/class.trims.php');
require_once('../../../../includes/class4/class.fabrics.php');
require_once('../../../../includes/class4/class.washes.php');

$date = date('Y-m-d');

if($action=="print_button_variable_setting")
{
    $print_report_format_arr = return_library_array("select format_id,format_id from lib_report_template where template_name =$data and module_id=11 and report_id=72 and is_deleted=0 and status_active=1","format_id","format_id");
    echo "print_report_button_setting('".implode(',',$print_report_format_arr)."');\n";
    exit(); 
}

if ($action == "load_drop_down_buyer") 
{
    // echo $_SESSION['logic_erp']["buyer_id"]."ssssss";
    if($_SESSION['logic_erp']["data_level_secured"]==1)
    {
        if($_SESSION['logic_erp']["buyer_id"]!="")
        {   
            $buyer_cond=" and buy.id in (".$_SESSION['logic_erp']["buyer_id"].")";
        }
    }
    echo create_drop_down("cbo_buyer_name", 60, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$data' $buyer_cond  and buy.id in (select buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90)) group by buy.id,buy.buyer_name order by buyer_name", "id,buyer_name", 1, "-- Select Buyer --", $selected, "load_drop_down( 'requires/order_monitoring_report_with_tna_controller', this.value, 'load_drop_down_season_buyer', 'season_td');");
    exit();
}

if ($action=="load_drop_down_season_buyer")
{
    echo create_drop_down( "cbo_season_name", 60, "select id, season_name from lib_buyer_season where buyer_id='$data' and status_active =1 and is_deleted=0 order by season_name ASC","id,season_name", 1, "-- Select Season--", "", "" );
    exit();
}

if ($action=="load_drop_down_buyer_client")
{
    echo create_drop_down( "cbo_client", 60, "select a.id,a.buyer_name from lib_buyer a, lib_buyer_tag_company b where a.status_active =1 and a.is_deleted=0 and b.buyer_id=a.id and b.tag_company='$data' and a.id in (select  buyer_id from  lib_buyer_party_type where party_type in (7))  group by a.id,a.buyer_name order by buyer_name","id,buyer_name", 1, "-- All --", $selected, "" );
    exit();
}


if ($action=="load_drop_down_location")
{
    //echo "select id, location_name from lib_location where company_id='$data' and status_active =1 and is_deleted=0 order by location_name ASC";
    echo create_drop_down( "cbo_location_name", 60, "select id, location_name from lib_location where company_id='$data' and status_active =1 and is_deleted=0 order by location_name ASC","id,location_name", 1, "-Select Location-", "", "" );
    exit();
}

if ($action == "eval_multi_select") {
    // echo "set_multiselect('cbo_location_name','0','0','','0');\n";
    exit();
}

if ($action == "load_drop_down_team_member") {
    echo create_drop_down("cbo_team_member", 60, "select id,team_member_name from lib_mkt_team_member_info where team_id='$data' and status_active=1 and is_deleted=0 order by team_member_name", "id,team_member_name", 1, "- Team Member-", $selected, "");
}

$buyer_short_name_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
$buyer_name_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');
$company_short_name_arr = return_library_array("select id,company_name from lib_company", 'id', 'company_name');
$imge_arr = return_library_array("select master_tble_id,image_location from common_photo_library where file_type=1", 'master_tble_id', 'image_location');
//$dealing_merchant_array = return_library_array("select id, team_member_name from lib_mkt_team_member_info","id","team_member_name");

$SqlResult = sql_select("select id, team_member_name,member_contact_no from lib_mkt_team_member_info");
foreach ($SqlResult as $row) {
    if ($row[csf('member_contact_no')]) {
        $phone = "<br>Ph:" . $row[csf('member_contact_no')];
    } else {
        $phone = "";
    }
    $dealing_merchant_array[$row[csf('id')]] = $row[csf('team_member_name')];// . $phone;
}

$team_library = return_library_array("select id, team_name from lib_marketing_team", "id", "team_name");
$country_library = return_library_array("select id, country_name from  lib_country", "id", "country_name");
$location_library = return_library_array("select id, location_name from  lib_location", "id", "location_name");

if($action=="open_intref_search_popup")
{
	echo load_html_head_contents("Search Info", "../../../../", 1, 1,'','','');
	extract($_REQUEST);
	?>
     
	<script>
		
		var selected_id = new Array; var selected_name = new Array;
		
		function check_all_data()
		{
			var tbl_row_count = document.getElementById( 'tbl_list_search' ).rows.length;
			tbl_row_count = tbl_row_count - 1;

			for( var i = 1; i <= tbl_row_count; i++ )
			{
				$('#tr_'+i).trigger('click'); 
			}
		}
		
		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}
		
		function js_set_value( str ) {
			
			if (str!="") str=str.split("_");
			 
			toggle( document.getElementById( 'tr_' + str[0] ), '#FFFFCC' );
			 
			if( jQuery.inArray( str[1], selected_id ) == -1 ) {
				selected_id.push( str[1] );
				selected_name.push( str[2] );
				
			}
			else {
				for( var i = 0; i < selected_id.length; i++ ) {
					if( selected_id[i] == str[1] ) break;
				}
				selected_id.splice( i, 1 );
				selected_name.splice( i, 1 );
			}
			var id = ''; var name = '';
			for( var i = 0; i < selected_id.length; i++ ) {
				id += selected_id[i] + ',';
				name += selected_name[i] + '*';
			}
			
			id = id.substr( 0, id.length - 1 );
			name = name.substr( 0, name.length - 1 );
			
			$('#hide_order_id').val( id );
			$('#hide_order_no').val( name );
		}
	
    </script>

	</head>

	<body>
	<div align="center">
		<form name="styleRef_form" id="styleRef_form">
			<fieldset style="width:780px;">
	            <table width="770" cellspacing="0" cellpadding="0" border="1" rules="all" align="center" class="rpt_table" id="tbl_list">
	            	<thead>
	                    <th>Buyer</th>
	                    <th>Search By</th>
	                    <th id="search_by_td_up" width="170">Please Enter Internal Ref</th>
	                    <th>Shipment Date</th>
	                    <th>
                            <input type="reset" name="button" class="formbutton" value="Reset"  style="width:100px;"> 
                            <input type="hidden" name="hide_order_no" id="hide_order_no" value="" />
                            <input type="hidden" name="hide_order_id" id="hide_order_id" value="" />
                        </th>
	                </thead>
	                <tbody>
	                	<tr>
	                        <td align="center">
	                        	 <? 
									echo create_drop_down( "cbo_buyer_name", 140, "select buy.id, buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company=$company $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buy.buyer_name","id,buyer_name",1, "-- All Buyer--",0,"",0 );
								?>
	                        </td>                 
	                        <td align="center">	
	                    	<?
	                       		$search_by_arr=array(1=>"Internal Ref",2=>"Style Ref",3=>"Job No");
								$dd="change_search_event(this.value, '0*0*0', '0*0*0', '../../') ";							
								echo create_drop_down( "cbo_search_by", 110, $search_by_arr,"",0, "--Select--", "",$dd,0 );
							?>
	                        </td>     
	                        <td align="center" id="search_by_td">				
	                            <input type="text" style="width:130px" class="text_boxes" name="txt_search_common" id="txt_search_common" />	
	                        </td> 
	                        <td align="center">
	                            <input type="text" name="txt_date_from" id="txt_date_from" class="datepicker" style="width:70px" readonly>To
	                            <input type="text" name="txt_date_to" id="txt_date_to" class="datepicker" style="width:70px" readonly>
	                        </td>	
	                        <td align="center">
	                        	<input type="button" name="button" class="formbutton" value="Show" onClick="show_list_view ('<? echo $company; ?>'+'**'+document.getElementById('cbo_buyer_name').value+'**'+document.getElementById('cbo_search_by').value+'**'+document.getElementById('txt_search_common').value+'**'+document.getElementById('txt_date_from').value+'**'+document.getElementById('txt_date_to').value+'**'+'<? echo $job_no; ?>', 'search_list_view', 'search_div', 'order_monitoring_report_with_tna_controller', 'setFilterGrid(\'tbl_list_search\',-1)');" style="width:100px;" />
	                    	</td>
	                    </tr>
	                    <tr>
	                        <td colspan="5" height="20" valign="middle"><? echo load_month_buttons(1); ?></td>
	                    </tr>
	            	</tbody>
	           	</table>
	            <div style="margin-top:15px" id="search_div"></div>
			</fieldset>
		</form>
	</div>
	</body>           
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit(); 
}

if($action=="search_list_view")
{
	$data=explode('**',$data);
	$company_id=$data[0];
	$job_no=$data[6];
    /* if(trim($data[3])=="" && $data[4]=="" && $data[5]=="")
    {
        ?>
        <div style="text-align:center;font-size:16px;color:red;">Please enter search field value.</div>
        <?
        die;
    } */
	$type = 1;
	if($job_no!='') $job_no_cond="and a.job_no_prefix_num=$job_no";else $job_no_cond="";
	
	if($data[1]==0)
	{
		if ($_SESSION['logic_erp']["data_level_secured"]==1)
		{
			if($_SESSION['logic_erp']["buyer_id"]!="") $buyer_id_cond=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")"; else $buyer_id_cond="";
		}
		else
		{
			$buyer_id_cond="";
		}
	}
	else
	{
		$buyer_id_cond=" and a.buyer_name=$data[1]";
	}
	
	$search_by=$data[2];
	if(str_replace("'", "", $data[3])!="")
	{
		$search_string="".trim($data[3])."";
	}

	if($search_by==1) 
		$search_field="b.grouping"; 
	else if($search_by==2) 
		$search_field="a.style_ref_no"; 	
	else 
		$search_field="a.job_no_prefix_num";
	$search_cond="";
	if($search_string!="")	{$search_cond=" and $search_field='$search_string'";}
	$start_date =$data[4];
	$end_date =$data[5];	
	
	if($start_date!="" && $end_date!="")
	{
		if($db_type==0)
		{
			$date_cond="and b.pub_shipment_date between '".change_date_format(trim($start_date),"yyyy-mm-dd")."' and '".change_date_format(trim($end_date),"yyyy-mm-dd")."'";
		}
		else
		{
			$date_cond="and b.pub_shipment_date between '".change_date_format(trim($start_date),'','',1)."' and '".change_date_format(trim($end_date),'','',1)."'";	
		}
	}
	else
	{
		$date_cond="";
	}
	$company_library=return_library_array( "select id, company_short_name from lib_company", "id", "company_short_name"  );
	$buyer_arr=return_library_array( "select id, short_name from lib_buyer", "id", "short_name"  );
	$arr=array (0=>$company_library,1=>$buyer_arr,6=>$shipment_status);
	
	if($db_type==0) $year_field="YEAR(a.insert_date) as year"; 
	else if($db_type==2) $year_field="to_char(a.insert_date,'YYYY') as year";
	else $year_field="";//defined Later
	
	if($type==1){$field='grouping';}
	else if($type==2){$field='job_no_prefix_num';}
	else{$field='style_ref_no';}
	
	$sql= "SELECT a.id, a.job_no, $year_field, a.job_no_prefix_num, a.company_name, a.buyer_name, a.style_ref_no, b.grouping,b.shiping_status from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.company_name=$company_id $search_cond $buyer_id_cond $job_no_cond $date_cond group by a.id,
         a.job_no, a.insert_date, a.job_no_prefix_num, a.company_name, a.buyer_name, a.style_ref_no, b.grouping,b.shiping_status order by a.id, b.grouping"; 
    // echo $sql;
		
	echo create_list_view("tbl_list_search", "Company,Buyer Name,Year,Job No,Style Ref. No, Int Ref,Shiping Status", "80,80,50,70,100,180,80","750","220",0, $sql , "js_set_value", "id,$field","",1,"company_name,buyer_name,0,0,0,0,shiping_status",$arr,"company_name,buyer_name,year,job_no_prefix_num,style_ref_no,grouping,shiping_status","",'','0,0,0,0,0,0,0','',1) ;
   exit(); 
}

function change_date_format_new($date)
{
    if(isset($date))
    {
        return date('d-M',strtotime($date));
    }
    
} 

if ($action == "report_generate") 
{
    $company_id     = str_replace("'", "", $cbo_company_name);
    $location_name  = str_replace("'", "", $cbo_location_name);
    $buyer_name     = str_replace("'", "", $cbo_buyer_name);
    $season_name    = str_replace("'", "", $cbo_season_name);
    $item_id        = str_replace("'", "", $cbo_item_name);
    $year           = str_replace("'", "", $cbo_year_selection);
    $shipment_status= str_replace("'", "", $cbo_shipment_status);
    $order_status   = str_replace("'", "", $cbo_order_status);
    $status         = str_replace("'", "", $cbo_status);
    $merchant       = str_replace("'", "", $cbo_merchant);
    $client         = str_replace("'", "", $cbo_client);
    $search_by      = str_replace("'", "", $cbo_search_by);
    $int_ref_no     = str_replace("'", "", $txt_int_ref_no);
    $hidden_order_id= str_replace("'", "", $hidden_order_id);
    $style_ref      = str_replace("'", "", $txt_style_ref);
    $emblishment    = str_replace("'", "", $cbo_emblishment);
    $start_alarm    = str_replace("'", "", $cbo_start_alarm);
    $end_alarm      = str_replace("'", "", $cbo_end_alarm);
    $backLog        = str_replace("'", "", $cbo_backlog);
    $cbo_balance    = str_replace("'", "", $cbo_balance);
    $date_from      = str_replace("'", "", $txt_date_from);
    $date_to        = str_replace("'", "", $txt_date_to);
    
	$current_date = date("j-M-Y");

    $client_array = return_library_array("SELECT a.id,a.buyer_name from lib_buyer a, lib_buyer_tag_company b where a.status_active =1 and a.is_deleted=0 and b.buyer_id=a.id and b.tag_company='$company_id' and a.id in (select  buyer_id from  lib_buyer_party_type where party_type in (7))  order by buyer_name", "id", "buyer_name");

    if($rptType==1) // Show button
    {
        /*------------------------------------------------------------------------------/
        /                        MAKING CONDITION FOR BUDGET                            /
        /------------------------------------------------------------------------------*/

        $budgetCond = "";
        $budgetCond .= " and a.company_name=$company_id";
        // $budgetCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
        $budgetCond .= ($season_name != 0)  ? " and a.season_buyer_wise=$season_name"         : "";
        $budgetCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";
        $budgetCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
        if($hidden_order_id!="")
        {
            $budgetCond .= ($hidden_order_id !="")   ? " and a.id in($hidden_order_id)" : "";
        }
        else
        {
            $budgetCond .= ($int_ref_no !="")   ? " and b.grouping like '$int_ref_no%'"      : "";
        }
        $budgetCond .= ($style_ref !="")    ? " and a.style_ref_no like UPPER('%$style_ref%')" : "";
        $budgetCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
        if($shipment_status==1)
        {
            $budgetCond .= " and b.shiping_status in(1,2)";
        }
        elseif ($shipment_status==2) {
            $budgetCond .= " and b.shiping_status in(3)";
        }
        $budgetCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
        $budgetCond .= ($status !=0) ? " and b.status_active in($status)" : "";
        $budgetCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
        // $budgetCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";

        if($buyer_name==0)
        {
            if($_SESSION['logic_erp']["data_level_secured"]==1)
            {
                if($_SESSION['logic_erp']["buyer_id"]!="")
                {   
                    $budgetCond.=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")";
                }
            }
        }
        else
        {
            $budgetCond.=" and a.buyer_name=$buyer_name";
        }

        if($date_from !="" && $date_to !="")
        {
            if($db_type==0)
            {
                $start_date=change_date_format($date_from,"yyyy-mm-dd","");
                $end_date=change_date_format($date_to,"yyyy-mm-dd","");
            }
            else
            {
                $start_date=date("j-M-Y",strtotime($date_from));
                $end_date=date("j-M-Y",strtotime($date_to));
            }
            
            switch ($search_by) 
            {
                case 2:
                    $budgetCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                    break;
                case 3:
                   $budgetCond .= " and b.po_received_date between '$start_date' and '$end_date'";
                   break;
                case 5:
                    $budgetCond .= " and b.insert_date between '$start_date' and '$end_date'";
                    break;
               
                default:
                    $budgetCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                    break;
            }
        }      

        /*------------------------------------------------------------------------------/
        /                     GEIIING PO FROM BUDGET FOR EMBLISHMENT                    /
        /------------------------------------------------------------------------------*/
        if($emblishment!=0)
        {
            if($emblishment==1) // aop
            {
                $sqlemb = sql_select("SELECT b.ID from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_avg_con_dtls d where a.id=b.job_id and a.job_no=c.job_no and c.id=d.pre_cost_fabric_cost_dtls_id and b.id=d.po_break_down_id and c.color_type_id in(5) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 $budgetCond  and d.CONS>0");
                
            }
            elseif ($emblishment==2) // yarn dyeing
            {
                $sqlemb = sql_select("SELECT b.ID from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e,wo_pre_cost_fab_conv_cost_dtls f where a.id=b.job_id and a.id=c.job_id and a.id=d.job_id and a.id=e.job_id and a.id=f.job_id and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and d.id=f.fabric_description and e.cons !=0 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and c.is_deleted=0 and c.status_active=1 and d.is_deleted=0 and d.status_active=1 and e.is_deleted=0 and e.status_active=1 and f.is_deleted=0 and f.status_active=1 and f.cons_process in(30) $budgetCond");
            }
            elseif ($emblishment==3 || $emblishment==4 || $emblishment==5) // wash - print - emb
            {
                $embCond = '';
                if($emblishment==3) // wash
                {
                    $embCond = "and d.emb_name in(3)";
                }
                elseif($emblishment==4) // print
                {
                    $embCond = "and d.emb_name in(1)";
                }
                else // emb
                {
                    $embCond = "and d.emb_name in(2)";
                }

                $sqlemb = sql_select("SELECT b.ID  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_embe_cost_dtls d , wo_pre_cos_emb_co_avg_con_dtls e where 1=1 $embCond and cons_dzn_gmts>0 and a.id=b.job_id and a.id=c.job_id and a.id=d.job_id and a.id=e.job_id and b.id=c.po_break_down_id and b.id=e.po_break_down_id and c.item_number_id= e.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.size_number_id and d.id=e.pre_cost_emb_cost_dtls_id and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and c.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.is_deleted=0 and d.status_active=1 $budgetCond  and e.REQUIRMENT>0");
            }
            elseif ($emblishment==6) // fab. source
            {
                $sqlemb = sql_select("SELECT b.ID from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_avg_con_dtls d where a.id=b.job_id and a.job_no=c.job_no and c.id=d.pre_cost_fabric_cost_dtls_id and b.id=d.po_break_down_id and c.fabric_source in(2) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 $budgetCond  and d.CONS>0");
            }
            // echo $sqlemb;die();
            $embPoArray = array();
            if(count($sqlemb)>0)
            {
                 foreach ($sqlemb as $val) 
                 {
                     $embPoArray[$val['ID']] = $val['ID'];
                 }
            }
            if(count($embPoArray)==0)
            {
                echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
            }
        }
        // echo "<pre>";print_r($embPoArray);die();
        /*------------------------------------------------------------------------------/
        /                        MAKING CONDITION FOR MAIN QUERY                        /
        /------------------------------------------------------------------------------*/
        $sqlCond = "";
        $sqlCond .= " and a.company_name=$company_id";
        // $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
        $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
        $sqlCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";
        $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
        if($hidden_order_id!="")
        {
            $sqlCond .= ($hidden_order_id !="")   ? " and a.id in($hidden_order_id)" : "";
        }
        else
        {
            $sqlCond .= ($int_ref_no !="")   ? " and b.grouping like '$int_ref_no%'"      : "";
        }
        $sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like UPPER('%$style_ref%')" : "";
        $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
        if($shipment_status==1)
        {
            $sqlCond .= " and b.shiping_status in(1,2)";
        }
        elseif ($shipment_status==2) {
            $sqlCond .= " and b.shiping_status in(3)";
        }
        $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
        $sqlCond .= ($status !=0) ? " and b.status_active in($status)" : "";
        $sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
        // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";

        if($buyer_name==0)
        {
            if($_SESSION['logic_erp']["data_level_secured"]==1)
            {
                if($_SESSION['logic_erp']["buyer_id"]!="")
                {   
                    $sqlCond.=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")";
                }
            }
        }
        else
        {
            $sqlCond.=" and a.buyer_name=$buyer_name";
        }
        if($date_from !="" && $date_to !="")
        {
            if($db_type==0)
            {
                $start_date=change_date_format($date_from,"yyyy-mm-dd","");
                $end_date=change_date_format($date_to,"yyyy-mm-dd","");
            }
            else
            {
                $start_date=date("j-M-Y",strtotime($date_from));
                $end_date=date("j-M-Y",strtotime($date_to));
            }
            
            switch ($search_by) 
            {
                case 2:
                    $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                    break;
                case 3:
                   $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
                   break;
                case 4:
                    $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                    break;
                case 5:
                    $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                    break;
               
                default:
                    $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                    break;
            }
        }


        /*------------------------------------------------------------------------------/
        /                         GEIIING PO FROM START ALARM OPTION                    /
        /------------------------------------------------------------------------------*/
        $toDay = date('d-m-Y');
        if($start_alarm !=0)   
        {
            $embPOCond = "";
            if($emblishment !=0)
            {
                $embPO = implode(",", $embPoArray);
                $embPOCond = " and b.id in($embPO)";
            }
            $sqlOrd = sql_select("SELECT B.SHIPMENT_DATE,b.id as PO_ID,c.order_quantity as QTY,c.color_number_id as COLOR_ID from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $sqlCond $embPOCond");
            //echo "SELECT B.SHIPMENT_DATE,b.id as PO_ID,c.order_quantity as QTY,c.color_number_id as COLOR_ID from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $sqlCond $embPOCond"; 
            $ordDataArray = array();
            $poArray = array();
            foreach ($sqlOrd as $val) 
            {
                $ordDataArray[$val['PO_ID']]['shipment_date'] = $val['SHIPMENT_DATE'];
                $poWiseColorArray[$row['PO_ID']][$row['COLOR_ID']] += $row['COLOR_ID'];
                $ordDataArray[$val['PO_ID']]['qty'] += $val['QTY'];
                $poArray[$val['PO_ID']] = $val['PO_ID'];
            }
            $poIdBl = implode(",", $poArray);
            $poIdBlCond = "";
            if($poIdBl !="")
            {
                if($db_type==2 && count($poArray)>1000)
                {
                    $poIdBlCond=" and (";
                    $poIdsArr=array_chunk($poArray,999);
                    foreach($poIdsArr as $ids)
                    {
                        $ids=implode(",",$ids);
                        $poIdBlCond.=" a.po_number_id in($ids) or ";
                    }
                    $poIdBlCond=chop($poIdBlCond,'or ');
                    $poIdBlCond.=")";
                }
                else
                {
                    $poIdBlCond=" and a.po_number_id in($poIdBl)";
                }
            }
            else
            {
                echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
            }

            // ======================================= TNA DATA  ==================================
            // $poIdsCondTna = ($poIdBl !="") ? " and a.po_number_id in($poIdBl)" : '';
            $sqltna = "SELECT A.PO_NUMBER_ID,A.TASK_NUMBER,MAX(A.TASK_START_DATE) AS START_DATE,MAX(A.TASK_FINISH_DATE) AS END_DATE,MAX(A.ACTUAL_START_DATE) AS ACTUAL_START_DATE,MAX(A.ACTUAL_FINISH_DATE) AS ACTUAL_FINISH_DATE FROM TNA_PROCESS_MST A,WO_PO_BREAK_DOWN B WHERE A.PO_NUMBER_ID=B.ID AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0  and A.TASK_START_DATE is not null AND B.PO_QUANTITY>0 $poIdBlCond AND A.TASK_TYPE=1 group by A.PO_NUMBER_ID,A.TASK_NUMBER";
             //echo $sqltna;die();
            $tnaRes = sql_select($sqltna);
            $tnaDateArray = array();
            foreach ($tnaRes as $val) 
            {
                $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['start_date']          = $val['START_DATE'];
                $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['end_date']            = $val['END_DATE'];
                $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_start_date']   = $val['ACTUAL_START_DATE'];
                $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_finish_date']  = $val['ACTUAL_FINISH_DATE'];
            }
            $start_alarm_po_array = array();
            if($start_alarm ==1)// labdid submit  
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][9]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==2)// labdid app   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][10]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==3)// SMS/ GSS Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][265]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==4)// SMS/ GSS App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][266]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==5)// AOP Strike Off Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][254]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==6)// AOP Strike Off App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][255]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==7)// Styling submit
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][7]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==8)// Styling App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][13]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==9)// Size Set Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][14]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==10)// Size Set App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][15]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==11)// Ware Trial Sample Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][21]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==12)// Ware Trial Sample App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][22]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==13)// Bulk Fabric Submission To Buyer
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][28]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==14)// Bulk Fabric App from Buyer
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][29]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==15)// Bulk Fabric Submission To Lab
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][197]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==16)// Bulk Fabric App from Lab
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][198]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==17)// Knit down Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][256]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==18)// Knit down Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][257]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==19)// Print Strike Off Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][126]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==20)// Print Strike Off App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][127]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==21)// Embroidery Strike off Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][128]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==22)// Embroidery Strike off Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][129]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==23)// PP Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][8]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==24)// PP App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][12]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==25)// Trim Card Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][16]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==26)// Trim Card Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][17]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==27)// Top Sample Submission To Buyer
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][26]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==28)// Top Sample app from Buyer
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][27]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==29)// Top Sample Submission to Lab
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][26]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==30)// Top Sample app from Lab
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][27]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==31)// mock up sample sub
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][23]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==32)// mock up sample app
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][24]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==33)// acc booking   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][32]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($start_alarm ==34)// fab booking   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][31]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($start_alarm ==35)// yarn alloc   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][48]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($start_alarm ==36)// yarn dyeing  
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][52]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($start_alarm ==37)// gre fabric  
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][60]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($start_alarm ==38)// dyeing production   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][61]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($start_alarm ==39)// aop   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][63]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($start_alarm ==40)// finish fab   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][73]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($start_alarm ==41) // cut and lay  
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][84]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($start_alarm ==42)//print   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][267]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($start_alarm ==43) // emb  
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][268]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($start_alarm ==44) // sewing trims  
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][70]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($start_alarm ==45)// fin trims   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][71]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($start_alarm ==46)//sewing   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][86]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($start_alarm ==47)// wash   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][90]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($start_alarm ==48)// Garments Finishing   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][88]['start_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $start_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            //print_r($start_alarm_po_array);
            if(count($start_alarm_po_array)==0)
            {
                echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
            }
        }

        /*------------------------------------------------------------------------------/
        /                         GEIIING PO FROM END ALARM OPTION                      /
        /------------------------------------------------------------------------------*/
        if($end_alarm !=0)   
        {
            $embPOCond = "";
            $embPO = "";
            if($start_alarm !=0)
            {
                $embPO = implode(",", $start_alarm_po_array);
                $embPOCond = " and b.id in($embPO)";
            }
            elseif ($emblishment !=0) 
            {
                $embPO = implode(",", $embPoArray);
                $embPOCond = " and b.id in($embPO)";
            }
            $sqlOrd = sql_select("SELECT B.SHIPMENT_DATE,b.id as PO_ID,c.order_quantity as QTY,c.color_number_id as COLOR_ID from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $sqlCond $embPOCond");
            $ordDataArray = array();
            $poArray = array();
            foreach ($sqlOrd as $val) 
            {
                $ordDataArray[$val['PO_ID']]['shipment_date'] = $val['SHIPMENT_DATE'];
                $poWiseColorArray[$row['PO_ID']][$row['COLOR_ID']] += $row['COLOR_ID'];
                $ordDataArray[$val['PO_ID']]['qty'] += $val['QTY'];
                $poArray[$val['PO_ID']] = $val['PO_ID'];
            }
            $poIdBl = implode(",", $poArray);
            $poIdBlCond = "";
            if($poIdBl !="")
            {
                if($db_type==2 && count($poArray)>1000)
                {
                    $poIdBlCond=" and (";
                    $poIdsArr=array_chunk($poArray,999);
                    foreach($poIdsArr as $ids)
                    {
                        $ids=implode(",",$ids);
                        $poIdBlCond.=" a.po_number_id in($ids) or ";
                    }
                    $poIdBlCond=chop($poIdBlCond,'or ');
                    $poIdBlCond.=")";
                }
                else
                {
                    $poIdBlCond=" and a.po_number_id in($poIdBl)";
                }
            }
            else
            {
                echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
            }

            // ======================================= TNA DATA  ==================================
            // $poIdsCondTna = ($poIdBl !="") ? " and a.po_number_id in($poIdBl)" : '';
            $sqltna = "SELECT A.PO_NUMBER_ID,A.TASK_NUMBER,MAX(A.TASK_START_DATE) AS START_DATE,MAX(A.TASK_FINISH_DATE) AS END_DATE,MAX(A.ACTUAL_START_DATE) AS ACTUAL_START_DATE,MAX(A.ACTUAL_FINISH_DATE) AS ACTUAL_FINISH_DATE FROM TNA_PROCESS_MST A,WO_PO_BREAK_DOWN B WHERE A.PO_NUMBER_ID=B.ID AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND A.STATUS_ACTIVE=1 and A.TASK_START_DATE is not null AND A.IS_DELETED=0 AND B.PO_QUANTITY>0 $poIdBlCond AND A.TASK_TYPE=1 group by A.PO_NUMBER_ID,A.TASK_NUMBER";
            // echo $sqltna;die();
            $tnaRes = sql_select($sqltna);
            $tnaDateArray = array();
            foreach ($tnaRes as $val) 
            {
                $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['start_date']          = $val['START_DATE'];
                $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['end_date']            = $val['END_DATE'];
                $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_start_date']   = $val['ACTUAL_START_DATE'];
                $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_finish_date']  = $val['ACTUAL_FINISH_DATE'];
            }
            $end_alarm_po_array = array();
            if($end_alarm ==1)// labdid submit  
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][9]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==2)// labdid app   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][10]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==3)// SMS/ GSS Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][265]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==4)// SMS/ GSS App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][266]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==5)// AOP Strike Off Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][254]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==6)// AOP Strike Off App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][255]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==7)// Styling submit
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][7]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==8)// Styling App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][13]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==9)// Size Set Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][14]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==10)// Size Set App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][15]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==11)// Ware Trial Sample Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][21]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==12)// Ware Trial Sample App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][22]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==13)// Bulk Fabric Submission To Buyer
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][28]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==14)// Bulk Fabric App from Buyer
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][29]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==15)// Bulk Fabric Submission To Lab
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][197]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==16)// Bulk Fabric App from Lab
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][198]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==17)// Knit down Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][256]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==18)// Knit down Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][257]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==19)// Print Strike Off Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][126]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==20)// Print Strike Off App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][127]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==21)// Embroidery Strike off Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][128]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==22)// Embroidery Strike off Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][129]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==23)// PP Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][8]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==24)// PP App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][12]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==25)// Trim Card Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][16]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==26)// Trim Card Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][17]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==27)// Top Sample Submission To Buyer
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][26]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==28)// Top Sample app from Buyer
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][27]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==29)// Top Sample Submission to Lab
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][26]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==30)// Top Sample app from Lab
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][27]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==31)// mock up sample sub
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][23]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==32)// mock up sample app
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    //$tnaStDate     = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    //$tnaExtndDate  = $tnaStDate->modify('+2 day');
                    $tnaStDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][24]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaStDate. ' + 2 days'));
                    //echo $tnaStDate."==".$tnaExtndDate;
                    if(strtotime($toDay)==strtotime($tnaStDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }               
                }
            }
            if($end_alarm ==33)// acc booking   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][32]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($end_alarm ==34)// fab booking   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][31]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($end_alarm ==35)// yarn alloc   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][48]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($end_alarm ==36)// yarn dyeing  
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][52]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($end_alarm ==37)// gre fabric  
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][60]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($end_alarm ==38)// dyeing production   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][61]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($end_alarm ==39)// aop   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][63]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($end_alarm ==40)// finish fab   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][73]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($end_alarm ==41) // cut and lay  
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][84]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($end_alarm ==42)//print   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][267]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($end_alarm ==43) // emb  
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][268]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($end_alarm ==44) // sewing trims  
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][70]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($end_alarm ==45)// fin trims   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][71]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($end_alarm ==46)//sewing   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][86]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($end_alarm ==47)// wash   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][90]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }
            if($end_alarm ==48)// Garments Finishing   
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $tnaEndDate     = date('d-m-Y',strtotime($tnaDateArray[$poId][88]['end_date']));
                    $tnaExtndDate  = date('d-m-Y', strtotime($tnaEndDate. ' + 2 days'));
                    if(strtotime($toDay)==strtotime($tnaEndDate) || strtotime($toDay) <= strtotime($tnaExtndDate))
                    {
                        $end_alarm_po_array[$poId] = $poId;
                    }
                }
            }

            if(count($end_alarm_po_array)==0)
            {
                echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
            }
        }



        /*------------------------------------------------------------------------------/
        /                         FOR SEARCH WITH OPTION BACKLOG                        /
        /------------------------------------------------------------------------------*/


        $toDay = new DateTime('now');
        //echo $toDay->format('Y-m-d');die;
        $backlogPOArray = array();
        $poWiseColorArray = array();
        if($backLog !=0)
        {
            $embPOCond = "";
            $embPO = "";
            if($end_alarm !=0)
            {
                $embPO = implode(",", $end_alarm_po_array);
                $embPOCond = " and b.id in($embPO)";
            }
            elseif ($start_alarm !=0) 
            {
                $embPO = implode(",", $start_alarm_po_array);
                $embPOCond = " and b.id in($embPO)";
            }
            elseif($emblishment !=0)
            {
                $embPO = implode(",", $embPoArray);
                $embPOCond = " and b.id in($embPO)";
            }
            //echo $embPOCond;die();
            $sqlOrd = sql_select("SELECT B.SHIPMENT_DATE,b.id as PO_ID,c.order_quantity as QTY,c.color_number_id as COLOR_ID from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and a.is_deleted=0  and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $sqlCond $embPOCond");
            //echo "SELECT B.SHIPMENT_DATE,b.id as PO_ID,c.order_quantity as QTY,c.color_number_id as COLOR_ID from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and a.is_deleted=0  and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $sqlCond $embPOCond";
            $ordDataArray = array();
            $poArray = array();
            foreach ($sqlOrd as $val) 
            {
                $ordDataArray[$val['PO_ID']]['shipment_date'] = $val['SHIPMENT_DATE'];
                $poWiseColorArray[$val['PO_ID']][$val['COLOR_ID']] += $val['COLOR_ID'];
                $ordDataArray[$val['PO_ID']]['qty'] += $val['QTY'];
                $poArray[$val['PO_ID']] = $val['PO_ID'];
            }
            //print_r($poWiseColorArray);
            $poIdBl = implode(",", $poArray);
            $poIdBlCond = "";
            if($poIdBl !="")
            {
                if($db_type==2 && count($poArray)>1000)
                {
                    $poIdBlCond=" and (";
                    $poIdsArr=array_chunk($poArray,999);
                    foreach($poIdsArr as $ids)
                    {
                        $ids=implode(",",$ids);
                        $poIdBlCond.=" a.po_number_id in($ids) or ";
                    }
                    $poIdBlCond=chop($poIdBlCond,'or ');
                    $poIdBlCond.=")";
                }
                else
                {
                    $poIdBlCond=" and a.po_number_id in($poIdBl)";
                }
            }
            else
            {
                echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
            }

            // ======================================= TNA DATA  ==================================
            // $poIdsCondTna = ($poIdBl !="") ? " and a.po_number_id in($poIdBl)" : '';
            $sqltna = "SELECT A.PO_NUMBER_ID,A.TASK_NUMBER,MAX(A.TASK_START_DATE) AS START_DATE,MAX(A.TASK_FINISH_DATE) AS END_DATE,MAX(A.ACTUAL_START_DATE) AS ACTUAL_START_DATE,MAX(A.ACTUAL_FINISH_DATE) AS ACTUAL_FINISH_DATE FROM TNA_PROCESS_MST A,WO_PO_BREAK_DOWN B WHERE A.PO_NUMBER_ID=B.ID AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.PO_QUANTITY>0 $poIdBlCond AND A.TASK_TYPE=1 group by A.PO_NUMBER_ID,A.TASK_NUMBER";
            // echo $sqltna;die();
            $tnaRes = sql_select($sqltna);
            $tnaDateArray = array();
            foreach ($tnaRes as $val) 
            {
                $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['start_date']          = $val['START_DATE'];
                $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['end_date']            = $val['END_DATE'];
                $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_start_date']   = $val['ACTUAL_START_DATE'];
                $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_finish_date']  = $val['ACTUAL_FINISH_DATE'];
            }

            if($backLog == 49) // ex-factory
            { 
                $poIdsCondExfBl = str_replace("a.po_number_id", "c.po_break_down_id", $poIdBlCond);
                $sqlEx = "SELECT  c.po_break_down_id as PO_ID,d.production_qnty as EX_FACT_QTY from pro_ex_factory_mst c, pro_ex_factory_dtls d, pro_ex_factory_delivery_mst e where c.id=d.mst_id and e.id=c.delivery_mst_id  and c.status_active=1 and d.status_active=1 and e.status_active=1 $poIdsCondExfBl "; 
                // echo $sqlEx;die();
                $sqlXRes = sql_select($sqlEx);
                $exfArr = array();
                foreach ($sqlXRes as  $val) 
                {
                   $exfArr[$val['PO_ID']]['ex_qty'] += $val['EX_FACT_QTY'];
                }

                //============================= GETTING BACKLOG PO ===================
                foreach ($ordDataArray as $poId => $val) 
                {
                    //echo $exfArr[$poId]['qty'];die();
                    $orig_ship_date = $val['shipment_date'];
                    if(strtotime(date('d-m-Y')) > strtotime($orig_ship_date))
                    {
                        //echo $val['qty']."-".$exfArr[$poId]['ex_qtyex_qty']."<br>";
                        if($val['qty'] - $exfArr[$poId]['ex_qty']>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                }
            }
            elseif ($backLog == 48 || $backLog == 47 || $backLog == 46 || $backLog == 43 || $backLog == 42) 
            {
                $poIdsCondGmtsBk = str_replace("a.po_number_id", "A.PO_BREAK_DOWN_ID", $poIdBlCond);

                $sqlProd = "SELECT  A.PO_BREAK_DOWN_ID AS PO_ID, sum(case when a.production_type=3 and a.embel_name=1 then b.production_qnty else 0 end) as PRINTING_QTY,sum(case when a.production_type=2 and a.embel_name=1 then b.production_qnty else 0 end) as PRINT_ISS_QTY,sum(case when a.production_type=3 and a.embel_name=2 then b.production_qnty else 0 end) as EMB_QTY,sum(case when a.production_type=2 and a.embel_name=2 then b.production_qnty else 0 end) as EMB_ISSUE_QTY,sum(case when a.production_type=3 and a.embel_name=3 then b.production_qnty else 0 end) as WASH_QTY,sum(case when a.production_type=2 and a.embel_name=3 then b.production_qnty else 0 end) as WASH_ISSUE_QTY,sum(case when a.production_type=4 then b.production_qnty else 0 end) as INPUT_QTY, sum(case when a.production_type=5 then b.production_qnty else 0 end) as OUT_QTY, sum(case when a.production_type=5 then b.alter_qty else 0 end) as ALTER_QTY, sum(case when a.production_type=5 then b.spot_qty else 0 end) as SPOT_QTY, sum(case when a.production_type=5 then b.replace_qty else 0 end) as REPLACE_QTY,sum(case when a.production_type=3 and a.embel_name=1 then b.reject_qty else 0 end) as PRINT_REJECT_QTY,sum(case when a.production_type=3 and a.embel_name=2 then b.reject_qty else 0 end) as EMB_REJECT_QTY,sum(case when a.production_type=3 and a.embel_name=3 then b.reject_qty else 0 end) as WASH_REJECT_QTY,sum(case when a.production_type=5 then b.reject_qty else 0 end) as REJECT_QTY,sum(case when a.production_type=8 then b.production_qnty else 0 end) as FINISH_QTY,sum(case when a.production_type=8 then b.reject_qty else 0 end) as FIN_REJECT_QTY
                from pro_garments_production_mst a, pro_garments_production_dtls b
                where a.id=b.mst_id and a.status_active=1 and b.status_active=1 $poIdsCondGmtsBk and a.production_date < '$current_date' and a.production_type in(2,3,4,5,8) group by a.po_break_down_id";
                // echo $sqlProd;die();
                $prodRes = sql_select($sqlProd);
                $prodArr = array();
                foreach ($prodRes as  $val) 
                {
                   $prodArr[$val['PO_ID']]['print_qty']     += $val['PRINTING_QTY'];
                   $prodArr[$val['PO_ID']]['print_iss_qty'] += $val['PRINT_ISS_QTY'];
                   $prodArr[$val['PO_ID']]['print_rej_qty'] += $val['PRINT_REJECT_QTY'];
                   $prodArr[$val['PO_ID']]['emb_qty']       += $val['EMB_QTY'];
                   $prodArr[$val['PO_ID']]['emb_issue_qty'] += $val['EMB_ISSUE_QTY'];
                   $prodArr[$val['PO_ID']]['emb_rej_qty']   += $val['EMB_REJECT_QTY'];
                   $prodArr[$val['PO_ID']]['wash_qty']      += $val['WASH_QTY'];
                   $prodArr[$val['PO_ID']]['wash_issue_qty']+= $val['WASH_ISSUE_QTY'];
                   $prodArr[$val['PO_ID']]['wash_rej_qty']  += $val['WASH_REJECT_QTY'];
                   $prodArr[$val['PO_ID']]['input_qty']     += $val['INPUT_QTY'];
                   $prodArr[$val['PO_ID']]['out_qty']       += $val['OUT_QTY'];
                   $prodArr[$val['PO_ID']]['reject_qty']    += $val['REJECT_QTY'];
                   $prodArr[$val['PO_ID']]['alter_qty']     += $val['ALTER_QTY'];
                   $prodArr[$val['PO_ID']]['spot_qty']      += $val['SPOT_QTY'];
                   $prodArr[$val['PO_ID']]['replace_qty']   += $val['REPLACE_QTY'];
                   $prodArr[$val['PO_ID']]['finish_qty']    += $val['FINISH_QTY'];
                   $prodArr[$val['PO_ID']]['fin_rej_qty']   += $val['FIN_REJECT_QTY'];
                }                              

                //================================ getting tna plan data ==========================
                $po_id_cond = str_replace("a.po_number_id", "a.po_id", $poIdBlCond);
                $sqltna = "SELECT A.PO_ID,a.TASK_ID,a.PLAN_QTY as ALL_PLAN_QTY,(case when a.plan_date < '$current_date' then a.PLAN_QTY else 0 end) as prev_plan_qty from tna_plan_target a,wo_po_break_down b where a.PO_ID=b.id and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0  and a.PLAN_QTY>0 and a.task_type=1  and a.PLAN_DATE is not null and a.TASK_ID in(42,43,46,47,48)  $po_id_cond";
                // echo $sqltna;die();
                $tnaRes = sql_select($sqltna);
                $tnaPlanTargetArray = array();
                foreach ($tnaRes as $val) 
                {
                    $tnaPlanTargetArray[$val['PO_ID']][$val['TASK_ID']] += $val['PREV_PLAN_QTY'];
                }
                unset($tnaRes);

                //============================= GETTING BACKLOG PO ===================
                if($backLog == 48) // finish
                {
                    foreach ($ordDataArray as $poId => $val) 
                    {
                        $finishQty = $prodArr[$poId]['finish_qty'];
                        $tnaPlanTargetQty = $tnaPlanTargetArray[$poId][88];
                        if($tnaPlanTargetQty > $finishQty)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                        /* $StDate   = new DateTime($tnaDateArray[$poId][88]['start_date']);// gmt finish
                        $EndDate  = new DateTime($tnaDateArray[$poId][88]['end_date']);// gmt finish
                        if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                        {
                            if($val['qty'] - $finishQty>0)
                            {
                                $backlogPOArray[$poId] = $poId;
                            }
                        }
                        elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                        {
                            $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                            $todayDaysDif= $StDate->diff($toDay)->format('%a');

                            if((($val['qty']/$tnaDaysDif)*$todayDaysDif) - $finishQty>0)
                            {
                                $backlogPOArray[$poId] = $poId;
                            }
                        } */
                    }
                }
                if($backLog == 47)// wash
                {
                    foreach ($ordDataArray as $poId => $val) 
                    { 
                        $wash_qty = $prodArr[$poId]['wash_qty'];
                        $tnaPlanTargetQty = $tnaPlanTargetArray[$poId][90];
                        if($tnaPlanTargetQty > $wash_qty)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                        /* $StDate   = new DateTime($tnaDateArray[$poId][90]['start_date']);// gmt wash
                        $EndDate  = new DateTime($tnaDateArray[$poId][90]['end_date']);// gmt wash
                        $wash_qty = $prodArr[$poId]['wash_qty'];
                        if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                        {
                            if($val['qty'] - $wash_qty>0)
                            {
                                $backlogPOArray[$poId] = $poId;
                            }
                        }
                        elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                        {
                            $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                            $todayDaysDif= $StDate->diff($toDay)->format('%a');

                            if((($val['qty']/$tnaDaysDif)*$todayDaysDif) - $wash_qty>0)
                            {
                                $backlogPOArray[$poId] = $poId;
                            }
                        } */
                    }
                }
                if($backLog == 46)//sewing
                {
                    foreach ($ordDataArray as $poId => $val) 
                    { 
                        $out_qty = $prodArr[$poId]['out_qty'];
                        $tnaPlanTargetQty = $tnaPlanTargetArray[$poId][86];
                        if($tnaPlanTargetQty > $out_qty)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                        /* $StDate   = new DateTime($tnaDateArray[$poId][86]['start_date']);// gmt finish
                        $EndDate  = new DateTime($tnaDateArray[$poId][86]['end_date']);// gmt finish
                        $out_qty = $prodArr[$poId]['out_qty'];
                        if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                        {
                            if($val['qty'] - $out_qty>0)
                            {
                                $backlogPOArray[$poId] = $poId;
                            }
                        }
                        elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                        {
                            $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                            $todayDaysDif= $StDate->diff($toDay)->format('%a');

                            if((($val['qty']/$tnaDaysDif)*$todayDaysDif) - $out_qty>0)
                            {
                                $backlogPOArray[$poId] = $poId;
                            }
                        } */
                    }
                }
                if($backLog == 43)// emb
                {
                    foreach ($ordDataArray as $poId => $val) 
                    { 
                        $emb_qty = $prodArr[$poId]['emb_qty'];
                        $tnaPlanTargetQty = $tnaPlanTargetArray[$poId][268];
                        if($tnaPlanTargetQty > $emb_qty)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                        /* $StDate   = new DateTime($tnaDateArray[$poId][268]['start_date']);// gmt finish
                        $EndDate  = new DateTime($tnaDateArray[$poId][268]['end_date']);// gmt finish
                        $emb_qty = $prodArr[$poId]['emb_qty'];
                        if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                        {
                            if($val['qty'] - $emb_qty>0)
                            {
                                $backlogPOArray[$poId] = $poId;
                            }
                        }
                        elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                        {
                            $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                            $todayDaysDif= $StDate->diff($toDay)->format('%a');

                            if((($val['qty']/$tnaDaysDif)*$todayDaysDif) - $emb_qty>0)
                            {
                                $backlogPOArray[$poId] = $poId;
                            }
                        } */
                    }
                }
                if($backLog == 42)//print
                {
                    foreach ($ordDataArray as $poId => $val) 
                    {
                        $print_qty = $prodArr[$poId]['print_qty'];
                        $tnaPlanTargetQty = $tnaPlanTargetArray[$poId][267];
                        if($tnaPlanTargetQty > $print_qty)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                        /* $StDate   = new DateTime($tnaDateArray[$poId][267]['start_date']);// gmt finish
                        $EndDate  = new DateTime($tnaDateArray[$poId][267]['end_date']);// gmt finish
                        $print_qty = $prodArr[$poId]['print_qty'];
                        if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                        {
                            if($val['qty'] - $print_qty>0)
                            {
                                $backlogPOArray[$poId] = $poId;
                            }
                        }
                        elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                        {
                            $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                            $todayDaysDif= $StDate->diff($toDay)->format('%a');

                            if((($val['qty']/$tnaDaysDif)*$todayDaysDif) - $print_qty>0)
                            {
                                $backlogPOArray[$poId] = $poId;
                            }
                        } */
                    }
                }
            }
            elseif ($backLog == 45) // fin trims
            {
                $condition= new condition();     
                $condition->po_id_in($poIdBl);     
                $condition->init();
                $trims= new trims($condition);
                 // echo $trims->getQuery(); die;
                $trims_costing_arr=$trims->getQtyArray_by_orderAndTrimsTypeid();
                // echo"<pre>";print_r($trims_costing_arr);die();

                $poIdsCondTrBl = str_replace("a.po_number_id", "C.PO_BREAKDOWN_ID", $poIdBlCond);
                $sqlacc = "SELECT C.PO_BREAKDOWN_ID,SUM(C.QUANTITY) AS QNTY from inv_receive_master a,inv_trims_entry_dtls b,order_wise_pro_details c,lib_item_group d where a.id=b.mst_id and b.id=c.dtls_id and d.id=b.item_group_id and c.trans_type=1 $poIdsCondTrBl and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=24 AND c.entry_form = 24 and d.trim_type !=0 and a.item_category=4 and d.trim_type in(2) group by c.po_breakdown_id";
                // echo $sqlacc;die();
                $accbRes = sql_select($sqlacc);
                $accArr = array();
                foreach ($accbRes as  $val) 
                {
                   $accArr[$val['PO_BREAKDOWN_ID']] = $val['QNTY'];
                }
                foreach ($ordDataArray as $poId => $val) 
                {
                    $finTrimsReq    = $trims_costing_arr[$poId][2];
                    $finTrimsQty    = $accArr[$poId];
                    $finTrimsPrsnt  = ($finTrimsQty/$finTrimsReq)*100;

                    $StDate = $tnaDateArray[$poId][71]['start_date'];
                    $EndDate= $tnaDateArray[$poId][71]['end_date'];
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                    {
                        if(100 - $finTrimsPrsnt>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                    elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                        $todayDaysDif= $StDate->diff($toDay)->format('%a');

                        if(((100/$tnaDaysDif)*$todayDaysDif) - $finTrimsPrsnt>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }

                }
            }
            elseif ($backLog == 44) // sewing trims
            {
                $condition= new condition();     
                $condition->po_id_in($poIdBl);     
                $condition->init();
                $trims= new trims($condition);
                 // echo $trims->getQuery(); die;
                $trims_costing_arr=$trims->getQtyArray_by_orderAndTrimsTypeid();
                // echo"<pre>";print_r($trims_costing_arr);die();

                $poIdsCondTrBl = str_replace("a.po_number_id", "C.PO_BREAKDOWN_ID", $poIdBlCond);
                $sqlacc = "SELECT C.PO_BREAKDOWN_ID,SUM(C.QUANTITY) AS QNTY from inv_receive_master a,inv_trims_entry_dtls b,order_wise_pro_details c,lib_item_group d where a.id=b.mst_id and b.id=c.dtls_id and d.id=b.item_group_id and c.trans_type=1 $poIdsCondTrBl and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=24 AND c.entry_form = 24 and d.trim_type !=0 and a.item_category=4 and d.trim_type in(0,1) group by c.po_breakdown_id";
                // echo $sqlacc;die();
                $accbRes = sql_select($sqlacc);
                $accArr = array();
                foreach ($accbRes as  $val) 
                {
                   $accArr[$val['PO_BREAKDOWN_ID']] = $val['QNTY'];
                }
                foreach ($ordDataArray as $poId => $val) 
                {
                    $finTrimsReq    = $trims_costing_arr[$poId][2];
                    $finTrimsQty    = $accArr[$poId];
                    $finTrimsPrsnt  = ($finTrimsQty/$finTrimsReq)*100;

                    $StDate = $tnaDateArray[$poId][70]['start_date'];
                    $EndDate= $tnaDateArray[$poId][70]['end_date'];
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                    {
                        if(100 - $finTrimsPrsnt>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                    elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                        $todayDaysDif= $StDate->diff($toDay)->format('%a');

                        if(((100/$tnaDaysDif)*$todayDaysDif) - $finTrimsPrsnt>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }

                }
            }
            elseif ($backLog == 41) // cut and lay
            {
                // ======================================= CUTTING QC ============================== 
                $poIdsCondQCBk = str_replace("a.po_number_id", "B.ORDER_ID", $poIdBlCond);
                $sqlCutQC = "SELECT B.ORDER_ID,sum(b.qc_pass_qty) as QNTY,sum(b.replace_qty) as REPLACE_QTY,sum(b.reject_qty) as REJQNTY from pro_gmts_cutting_qc_mst a,pro_gmts_cutting_qc_dtls b where a.id=b.mst_id $poIdsCondQCBk and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.ENTRY_DATE < '$current_date' group by b.order_id";
                // echo $sqlCutQC;die();
                $CutQCRes = sql_select($sqlCutQC);
                $CutQCArr = array();
                foreach ($CutQCRes as  $val) 
                {
                   $CutQCArr[$val['ORDER_ID']]  = $val['QNTY'];
                }               

                //================================ getting tna plan data ==========================
                $po_id_cond = str_replace("a.po_number_id", "a.po_id", $poIdBlCond);
                $sqltna = "SELECT A.PO_ID,a.TASK_ID,a.PLAN_QTY as ALL_PLAN_QTY,(case when a.plan_date < '$current_date' then a.PLAN_QTY else 0 end) as prev_plan_qty from tna_plan_target a,wo_po_break_down b where a.PO_ID=b.id and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0  and a.PLAN_QTY>0 and a.task_type=1  and a.PLAN_DATE is not null and a.TASK_ID=84  $po_id_cond";
                // echo $sqltna;die();
                $tnaRes = sql_select($sqltna);
                $tnaPlanTargetArray = array();
                foreach ($tnaRes as $val) 
                {
                    $tnaPlanTargetArray[$val['PO_ID']] += $val['PREV_PLAN_QTY'];
                }
                unset($tnaRes);

                foreach ($ordDataArray as $poId => $val) 
                {
                    $qcQty    = $CutQCArr[$poId];
                    $tnaPlanTargetQty    = $tnaPlanTargetArray[$poId];
                    if($tnaPlanTargetQty > $qcQty)
                    {
                        $backlogPOArray[$poId] = $poId;
                    }
                   /*  $StDate   = new DateTime($tnaDateArray[$poId][84]['start_date']);
                    $EndDate  = new DateTime($tnaDateArray[$poId][84]['end_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                    {
                        if($val['qty'] - $qcQty>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                    elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                        $todayDaysDif= $StDate->diff($toDay)->format('%a');

                        if((($val['qty']/$tnaDaysDif)*$todayDaysDif) - $qcQty>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    } */
                }
            }
            elseif ($backLog == 40) // finish fab
            {
                // ======================================= FINISH FAB RCV ==============================   
                $poIdsCondFinBk = str_replace("a.po_number_id", "C.PO_BREAKDOWN_ID", $poIdBlCond);
                $sqlFinFab = "SELECT C.PO_BREAKDOWN_ID,sum(c.quantity) as QNTY from inv_receive_master a,inv_transaction b,order_wise_pro_details c where a.id=b.mst_id and b.id=c.trans_id and b.transaction_type=1 $poIdsCondFinBk and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=7 and a.item_category=2 and a.receive_date < '$current_date' group by c.po_breakdown_id";
                // echo $sqlFinFab;die();
                $finFabRes = sql_select($sqlFinFab);
                $finFabProdArr = array();
                foreach ($finFabRes as  $val) 
                {
                   $finFabProdArr[$val['PO_BREAKDOWN_ID']] += $val['QNTY'];
                }               

                //================================ getting tna plan data ==========================
                $po_id_cond = str_replace("a.po_number_id", "a.po_id", $poIdBlCond);
                $sqltna = "SELECT A.PO_ID,a.TASK_ID,a.PLAN_QTY as ALL_PLAN_QTY,(case when a.plan_date < '$current_date' then a.PLAN_QTY else 0 end) as prev_plan_qty from tna_plan_target a,wo_po_break_down b where a.PO_ID=b.id and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0  and a.PLAN_QTY>0 and a.task_type=1  and a.PLAN_DATE is not null and a.TASK_ID=73  $po_id_cond";
                // echo $sqltna;die();
                $tnaRes = sql_select($sqltna);
                $tnaPlanTargetArray = array();
                foreach ($tnaRes as $val) 
                {
                    $tnaPlanTargetArray[$val['PO_ID']] += $val['PREV_PLAN_QTY'];
                }
                unset($tnaRes);

               /*  $condition= new condition();     
                $condition->po_id_in($poIdBl);     
                $condition->init();
                $fabric= new fabric($condition);
                $fabric_costing_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish_production(); */

                foreach ($ordDataArray as $poId => $val) 
                {
                    $finFabQty    = $finFabProdArr[$poId];
                    $tnaPlanTargetQty    = $tnaPlanTargetArray[$poId];
                    if($tnaPlanTargetQty > $finFabQty)
                    {
                        $backlogPOArray[$poId] = $poId;
                    }
                   /*  $fabfinishReg  = array_sum($fabric_costing_arr['knit']['finish'][$poId]);
                    $StDate   = new DateTime($tnaDateArray[$poId][88]['start_date']);
                    $EndDate  = new DateTime($tnaDateArray[$poId][88]['end_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                    {
                        if($fabfinishReg - $qcQty>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                    elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                        $todayDaysDif= $StDate->diff($toDay)->format('%a');

                        if((($fabfinishReg/$tnaDaysDif)*$todayDaysDif) - $qcQty>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    } */
                }
            }
            elseif ($backLog == 39) // aop
            {
                // ======================================= AOP ==============================
                $poIdsCondAopBk = str_replace("a.po_number_id", "B.ORDER_ID", $poIdBlCond);
                $sqlAOP = "SELECT B.ORDER_ID,sum(case when a.entry_form=92 then b.batch_issue_qty else 0 end) as RCV_QTY from inv_receive_mas_batchroll a, pro_grey_batch_dtls b where a.id=b.mst_id $poIdsCondAopBk and b.process_id=35 and a.entry_form in(91,92) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.RECEIVE_DATE < '$current_date' group by b.order_id";
                // echo $sqlAOP;die();
                $AOPRes = sql_select($sqlAOP);
                $aopProdArr = array();
                foreach ($AOPRes as $val) 
                {
                    $aopProdArr[$val['ORDER_ID']] = $val['RCV_QTY'];
                }                

                //================================ getting tna plan data ==========================
                $po_id_cond = str_replace("a.po_number_id", "a.po_id", $poIdBlCond);
                $sqltna = "SELECT A.PO_ID,a.TASK_ID,a.PLAN_QTY as ALL_PLAN_QTY,(case when a.plan_date < '$current_date' then a.PLAN_QTY else 0 end) as prev_plan_qty from tna_plan_target a,wo_po_break_down b where a.PO_ID=b.id and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0  and a.PLAN_QTY>0 and a.task_type=1  and a.PLAN_DATE is not null and a.TASK_ID=63  $po_id_cond";
                // echo $sqltna;die();
                $tnaRes = sql_select($sqltna);
                $tnaPlanTargetArray = array();
                foreach ($tnaRes as $val) 
                {
                    $tnaPlanTargetArray[$val['PO_ID']] += $val['PREV_PLAN_QTY'];
                }
                unset($tnaRes);
               /*  $condition= new condition();     
                $condition->po_id_in($poIdBl);     
                $condition->init();
                $conversion= new conversion($condition);
                // echo $conversion->getQuery(); die;
                $conversion_costing_arr=$conversion->getQtyArray_by_orderAndProcess(); */

                foreach ($ordDataArray as $poId => $val) 
                {
                    $aopRcvQty    = $aopProdArr[$poId];
                    $tnaPlanTargetQty    = $tnaPlanTargetArray[$poId];
                    if($tnaPlanTargetQty > $aopRcvQty)
                    {
                        $backlogPOArray[$poId] = $poId;
                    }

                   /*  $aopReq   = array_sum($conversion_costing_arr[$poId][35]);
                    $StDate   = new DateTime($tnaDateArray[$poId][63]['start_date']);
                    $EndDate  = new DateTime($tnaDateArray[$poId][63]['end_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                    {
                        if($aopReq - $aopRcvQty>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                    elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                        $todayDaysDif= $StDate->diff($toDay)->format('%a');

                        if((($aopReq/$tnaDaysDif)*$todayDaysDif) - $aopRcvQty>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    } */
                }
            }
            elseif ($backLog == 38) // dyeing production
            {
                $poIdsCondDyeBk = str_replace("a.po_number_id", "B.PO_ID", $poIdBlCond);
                $sqlDye = "SELECT B.PO_ID,sum(b.batch_qnty) as QTY from pro_batch_create_mst a, pro_batch_create_dtls b,pro_fab_subprocess c where a.id=b.mst_id and a.id=c.batch_id $poIdsCondDyeBk and c.load_unload_id=2 and c.process_id='31' and c.result=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and c.PROCESS_END_DATE < '$current_date' group by b.po_id";
                // echo $sqlDye;die();
                $dyeRes = sql_select($sqlDye);
                $dyeingProdArr = array();
                foreach ($dyeRes as $val) 
                {
                   $dyeingProdArr[$val['PO_ID']] = $val['QTY'];
                }                

                //================================ getting tna plan data ==========================
                $po_id_cond = str_replace("a.po_number_id", "a.po_id", $poIdBlCond);
                $sqltna = "SELECT A.PO_ID,a.TASK_ID,a.PLAN_QTY as ALL_PLAN_QTY,(case when a.plan_date < '$current_date' then a.PLAN_QTY else 0 end) as prev_plan_qty from tna_plan_target a,wo_po_break_down b where a.PO_ID=b.id and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0  and a.PLAN_QTY>0 and a.task_type=1  and a.PLAN_DATE is not null and a.TASK_ID=61  $po_id_cond";
                // echo $sqltna;die();
                $tnaRes = sql_select($sqltna);
                $tnaPlanTargetArray = array();
                foreach ($tnaRes as $val) 
                {
                    $tnaPlanTargetArray[$val['PO_ID']] += $val['PREV_PLAN_QTY'];
                }
                unset($tnaRes);
                /* $condition= new condition();     
                $condition->po_id_in($poIdBl);     
                $condition->init();
                $conversion= new conversion($condition);
                // echo $conversion->getQuery(); die;
                $conversion_costing_arr=$conversion->getQtyArray_by_orderAndProcess(); */

                foreach ($ordDataArray as $poId => $val) 
                {
                    $dyeingRcvQty  = $dyeingProdArr[$poId];
                    $tnaPlanTargetQty  = $tnaPlanTargetArray[$poId];
                    if($tnaPlanTargetQty > $dyeingRcvQty)
                    {
                        $backlogPOArray[$poId] = $poId;
                    }

                    /* $dyeingReq   = array_sum($conversion_costing_arr[$poId][31]);
                    $StDate     = new DateTime($tnaDateArray[$poId][61]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][61]['end_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                    {
                        if($dyeingReq - $dyeingRcvQty>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                    elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                        $todayDaysDif= $StDate->diff($toDay)->format('%a');

                        if((($dyeingReq/$tnaDaysDif)*$todayDaysDif) - $dyeingRcvQty>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    } */
                }
            }
            elseif ($backLog == 37) // gre fabric
            {
                $poIdsCondGreyBk = str_replace("a.po_number_id", "C.PO_BREAKDOWN_ID", $poIdBlCond);
                $sqlGrey = "SELECT C.PO_BREAKDOWN_ID,SUM(C.QUANTITY) AS QNTY from inv_receive_master a,inv_transaction b,order_wise_pro_details c where a.id=b.mst_id and b.id=c.trans_id and b.transaction_type=1 $poIdsCondGreyBk and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=2 and a.item_category=13 and a.receive_date < '$current_date' group by c.po_breakdown_id ";
                // echo $sqlGrey;die();
                $greyRes = sql_select($sqlGrey);
                $greyProdArr = array();
                foreach ($greyRes as  $val) 
                {
                   $greyProdArr[$val['PO_BREAKDOWN_ID']]  = $val['QNTY'];
                }                

                //================================ getting tna plan data ==========================
                $po_id_cond = str_replace("a.po_number_id", "a.po_id", $poIdBlCond);
                $sqltna = "SELECT A.PO_ID,a.TASK_ID,a.PLAN_QTY as ALL_PLAN_QTY,(case when a.plan_date < '$current_date' then a.PLAN_QTY else 0 end) as prev_plan_qty from tna_plan_target a,wo_po_break_down b where a.PO_ID=b.id and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0  and a.PLAN_QTY>0 and a.task_type=1  and a.PLAN_DATE is not null and a.TASK_ID=60  $po_id_cond";
                // echo $sqltna;die();
                $tnaRes = sql_select($sqltna);
                $tnaPlanTargetArray = array();
                foreach ($tnaRes as $val) 
                {
                    $tnaPlanTargetArray[$val['PO_ID']] += $val['PREV_PLAN_QTY'];
                }
                unset($tnaRes);

                /* $condition= new condition();     
                $condition->po_id_in($poIdBl);     
                $condition->init();
                $fabric= new fabric($condition);
                $fabric_costing_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish_production(); */

                foreach ($ordDataArray as $poId => $val) 
                {
                    $greyRcvQty  = $greyProdArr[$poId];
                    $tnaPlanTargetqty  = $tnaPlanTargetArray[$poId];

                    if($tnaPlanTargetqty > $greyRcvQty)
                    {
                        $backlogPOArray[$poId] = $poId;
                    }
                    /* $greyReq    = array_sum($fabric_costing_arr['knit']['grey'][$poId]);
                    $StDate     = new DateTime($tnaDateArray[$poId][60]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][60]['end_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                    {
                        if($greyReq - $greyRcvQty>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                    elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                        $todayDaysDif= $StDate->diff($toDay)->format('%a');

                        if((($greyReq/$tnaDaysDif)*$todayDaysDif) - $greyRcvQty>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    } */
                }
            }
            elseif ($backLog == 36) // yarn dyeing
            {
                $poIdsCondYarnDyeBk = str_replace("a.po_number_id", "B.ORDER_ID", $poIdBlCond);
                $sql = "SELECT B.ORDER_ID,sum(b.cons_quantity) as QNTY from inv_receive_master a,inv_transaction b where a.receive_basis=2 and a.receive_purpose=2 and b.transaction_type=1 $poIdsCondYarnDyeBk and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.entry_form=1 and a.item_category=1 and a.receive_date < '$current_date' group by b.order_id ";
                // echo $sql;die();
                $sqlYRes = sql_select($sql);
                $yarnDyedArr = array();
                foreach ($sqlYRes as  $val) 
                {
                   $yarnDyedArr[$val['ORDER_ID']] = $val['QNTY'];
                }                

                //================================ getting tna plan data ==========================
                $po_id_cond = str_replace("a.po_number_id", "a.po_id", $poIdBlCond);
                $sqltna = "SELECT A.PO_ID,a.TASK_ID,a.PLAN_QTY as ALL_PLAN_QTY,(case when a.plan_date < '$current_date' then a.PLAN_QTY else 0 end) as prev_plan_qty from tna_plan_target a,wo_po_break_down b where a.PO_ID=b.id and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0  and a.PLAN_QTY>0 and a.task_type=1  and a.PLAN_DATE is not null and a.TASK_ID=52  $po_id_cond";
                // echo $sqltna;die();
                $tnaRes = sql_select($sqltna);
                $tnaPlanTargetArray = array();
                foreach ($tnaRes as $val) 
                {
                    $tnaPlanTargetArray[$val['PO_ID']] += $val['PREV_PLAN_QTY'];
                }
                unset($tnaRes);

               /*  $condition= new condition();     
                $condition->po_id_in($poIdBl);     
                $condition->init();
                $conversion= new conversion($condition);
                // echo $conversion->getQuery(); die;
                $conversion_costing_arr=$conversion->getQtyArray_by_orderAndProcess(); */

                foreach ($ordDataArray as $poId => $val) 
                {
                    $yarnDyeingRcvQty  = $yarnDyedArr[$poId];
                    $planTargetQty  = $tnaPlanTargetArray[$poId];
                    if($planTargetQty > $yarnDyeingRcvQty)
                    {
                        $backlogPOArray[$poId] = $poId;
                    }


                    /* $yarnDyeingReq  = array_sum($conversion_costing_arr[$poId][30]);
                    $StDate     = new DateTime($tnaDateArray[$poId][52]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][52]['end_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                    {
                        if($yarnDyeingReq - $yarnDyeingRcvQty>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                    elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                        $todayDaysDif= $StDate->diff($toDay)->format('%a');

                        if((($yarnDyeingReq/$tnaDaysDif)*$todayDaysDif) - $yarnDyeingRcvQty>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    } */
                }  
            }
            elseif ($backLog == 35) // Yarn
            {
                $poIdsCondYarnAlloBk = str_replace("a.po_number_id", "B.PO_BREAK_DOWN_ID", $poIdBlCond);
                $sqlYarnAllo = "SELECT B.PO_BREAK_DOWN_ID as PO_ID,SUM(B.QNTY) AS QNTY from INV_MATERIAL_ALLOCATION_MST A, INV_MATERIAL_ALLOCATION_DTLS B WHERE A.ID=B.MST_ID AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 and a.ALLOCATION_DATE < '$current_date' $poIdsCondYarnAlloBk GROUP BY B.PO_BREAK_DOWN_ID";
                // echo $sqlYarnAllo;die();
                $sqlYarnAlloRes = sql_select($sqlYarnAllo);
                $yarnAlloArr = array();
                foreach ($sqlYarnAlloRes as $val) 
                {
                    $yarnAlloArr[$val['PO_ID']] = $val['QNTY'];
                }

                //================================ getting tna plan data ==========================
                $po_id_cond = str_replace("a.po_number_id", "a.po_id", $poIdBlCond);
                $sqltna = "SELECT A.PO_ID,a.TASK_ID,a.PLAN_QTY as ALL_PLAN_QTY,(case when a.plan_date < '$current_date' then a.PLAN_QTY else 0 end) as prev_plan_qty from tna_plan_target a,wo_po_break_down b where a.PO_ID=b.id and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0  and a.PLAN_QTY>0 and a.task_type=1  and a.PLAN_DATE is not null and a.TASK_ID=48  $po_id_cond";
                // echo $sqltna;die();
                $tnaRes = sql_select($sqltna);
                $tnaPlanTargetArray = array();
                foreach ($tnaRes as $val) 
                {
                    $tnaPlanTargetArray[$val['PO_ID']] += $val['PREV_PLAN_QTY'];
                }
                unset($tnaRes);

                /* $condition= new condition();     
                $condition->po_id_in($poIdBl);     
                $condition->init();
                $yarn= new yarn($condition);    
                $yarnReqQtyArr=$yarn->getOrderWiseYarnQtyArray(); */

                foreach ($ordDataArray as $poId => $val) 
                {
                    $yarnAlloQty  = $yarnAlloArr[$poId];
                    $planTargetQty  = $tnaPlanTargetArray[$poId];
                    if($planTargetQty > $yarnAlloQty)
                    {
                        $backlogPOArray[$poId] = $poId;
                    }

                    /* $StDate     = new DateTime($tnaDateArray[$poId][48]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][48]['end_date']);
                    $yarnAlloQty  = $yarnAlloArr[$poId];
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                    {
                        if(fn_number_format($yarnReqQty,0) - fn_number_format($yarnAlloQty,0)>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                    elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                        $todayDaysDif= $StDate->diff($toDay)->format('%a');

                        if((($yarnReqQty/$tnaDaysDif)*$todayDaysDif) - $yarnAlloQty>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    } */
                } 
            }
            elseif ($backLog == 34) // fab booking
            {
                $poIdsCondBookingBk = str_replace("a.po_number_id", "B.PO_BREAK_DOWN_ID", $poIdBlCond);
                $sqlBooking = "SELECT B.PO_BREAK_DOWN_ID,SUM(B.FIN_FAB_QNTY) AS QTY FROM WO_BOOKING_MST A,WO_BOOKING_DTLS B WHERE A.BOOKING_NO=B.BOOKING_NO AND A.IS_APPROVED=1 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 $poIdsCondBookingBk group by B.PO_BREAK_DOWN_ID";
                // echo $sqlBooking;die();
                $bookingRes = sql_select($sqlBooking);
                $bookingQtyArray = array();
                foreach ($bookingRes as $val) 
                {
                    $bookingQtyArray[$val['PO_BREAK_DOWN_ID']] = $val['QTY'];
                }
                $condition= new condition();     
                $condition->po_id_in($poIdBl);     
                $condition->init();
                $fabric= new fabric($condition);
                $fabric_costing_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish_production();

                foreach ($ordDataArray as $poId => $val) 
                {
                    $fabfinishReg  = array_sum($fabric_costing_arr['knit']['finish'][$poId]);
                    $StDate     = new DateTime($tnaDateArray[$poId][31]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][31]['end_date']);
                    $bookingQty  = $bookingQtyArray[$poId];
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                    {
                        if($fabfinishReg - $bookingQty>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                    elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                        $todayDaysDif= $StDate->diff($toDay)->format('%a');

                        if((($fabfinishReg/$tnaDaysDif)*$todayDaysDif) - $bookingQty>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                } 
            }
            elseif ($backLog == 33) // acc booking
            {
                $poIdsCondAccBk = str_replace("a.po_number_id", "C.PO_BREAK_DOWN_ID", $poIdBlCond);
                $sqlTrims = "SELECT C.PO_BREAK_DOWN_ID,COUNT(distinct B.TRIM_GROUP) AS TOT_ITEM FROM WO_BOOKING_MST A,WO_BOOKING_DTLS B,WO_TRIM_BOOK_CON_DTLS C WHERE A.BOOKING_NO=B.BOOKING_NO AND B.BOOKING_NO=C.BOOKING_NO AND B.ID=C.WO_TRIM_BOOKING_DTLS_ID $poIdsCondAccBk and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=87 AND A.BOOKING_TYPE=2 AND A.IS_SHORT=2 GROUP BY C.PO_BREAK_DOWN_ID ";
                // echo $sqlTrims;die();
                $trimsRes = sql_select($sqlTrims);
                $trimsBookingArr = array();
                foreach ($trimsRes as  $val) 
                {
                   $trimsBookingArr[$val['PO_BREAK_DOWN_ID']] = $val['TOT_ITEM'];
                }

                $poIdsCondAccBk = str_replace("a.po_number_id", "B.ID", $poIdBlCond);
                $sqlTrimsBudget = "SELECT B.ID AS PO_ID,COUNT(A.ID) AS TOT_ITEM FROM WO_PRE_COST_TRIM_COST_DTLS A, WO_PO_BREAK_DOWN B WHERE A.JOB_ID=B.JOB_ID $poIdsCondAccBk AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY B.ID";
                // echo $sqlTrimsBudget;die();
                $trimsItemCountBudgetWise = array();
                $trimsBudgetRes = sql_select($sqlTrimsBudget);
                foreach ($trimsBudgetRes as $val) 
                {
                    $trimsItemCountBudgetWise[$val['PO_ID']] = $val['TOT_ITEM'];
                }

                foreach ($ordDataArray as $poId => $val) 
                {
                    $tot_item = $trimsItemCountBudgetWise[$poId];
                    $tot_booking_item = $trimsBookingArr[$poId];
                    $accBookingPrsnt = ($tot_booking_item/$tot_item)*100;
                    $StDate     = new DateTime($tnaDateArray[$poId][32]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][32]['end_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                    {
                        if(100 - $accBookingPrsnt>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                    elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') <= $EndDate->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                        $todayDaysDif= $StDate->diff($toDay)->format('%a');

                        if(((100/$tnaDaysDif)*$todayDaysDif) - $accBookingPrsnt>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                } 
            }
            elseif ($backLog == 32) // mock up sample app
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][23]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][23]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][23]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][23]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][23]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                } 
            }
            elseif ($backLog == 31) // mock up sample sub
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][23]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][23]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][23]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][23]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][23]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }
            }
            elseif ($backLog == 30) // Top Sample app to Lab
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][27]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][27]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][27]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][27]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][27]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                } 
            }
            elseif ($backLog == 29) // Top Sample Submission to Lab
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][26]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][26]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][26]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][26]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][26]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                } 
            }
            elseif ($backLog == 28) // Top Sample App To Buyer
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][27]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][27]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][27]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][27]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][27]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                } 
            }
            elseif ($backLog == 27) // Top Sample Submission To Buyer
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][26]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][26]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][26]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][26]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][26]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                } 
            }
            elseif ($backLog == 26) // Trim Card App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][17]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][17]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][17]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][17]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][17]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }  
            }
            elseif ($backLog == 25) // Trim Card Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][16]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][16]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][16]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][16]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][16]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                } 
            }
            elseif ($backLog == 24) // PP Approval
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][12]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][12]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][12]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][12]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][12]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                } 
            }
            elseif ($backLog == 23) // PP Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][8]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][8]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][8]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][8]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][8]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                } 
            }
            elseif ($backLog == 22) // Embroidery Strike off App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][129]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][129]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][129]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][129]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][129]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                } 
            }
            elseif ($backLog == 21) // Embroidery Strike off Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][128]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][128]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][128]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][128]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][128]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                } 
            }
            elseif ($backLog == 20) // Print Strike Off App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][127]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][127]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][127]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][127]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][127]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                } 
            }
            elseif ($backLog == 19) // Print Strike Off Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][126]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][126]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][126]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][126]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][126]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                } 
            }
            elseif ($backLog == 18) // Knit down App
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][257]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][257]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][257]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][257]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][257]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }

            }
            elseif ($backLog == 17) // Knit down Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][256]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][256]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][256]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][256]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][256]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }

            }
            elseif ($backLog == 16) // Bulk Fabric app To Lab
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][198]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][198]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][198]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][198]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][198]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }

            }
            elseif ($backLog == 15) // Bulk Fabric Submission To Lab
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][197]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][197]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][197]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][197]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][197]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }

            }
            elseif ($backLog == 14) // Bulk Fabric approval To Buyer
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][29]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][29]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][29]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][29]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][29]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }

            }
            elseif ($backLog == 13) // Bulk Fabric Submission To Buyer
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][28]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][28]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][28]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][28]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][28]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }

            }
            elseif ($backLog == 12) // Ware Trial Sample approval
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][22]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][22]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][22]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][22]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][22]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }

            }
            elseif ($backLog == 11) // Ware Trial Sample Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][21]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][21]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][21]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][21]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][21]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }

            }
            elseif ($backLog == 10) // Size Set approval
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][15]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][15]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][15]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][15]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][15]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }

            }
            elseif ($backLog == 9) // Size Set Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][14]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][14]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][14]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][14]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][14]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }

            }
            elseif ($backLog == 8) // Styling Approval
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][13]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][13]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][13]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][13]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][13]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }

            }
            elseif ($backLog == 7) // Styling submit
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][7]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][7]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][7]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][7]['actual_finish_date']);
                    
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][7]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }

            }
            elseif ($backLog == 6) // AOP Strike Off Approva
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][255]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][255]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][255]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][255]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][255]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }

            }
            elseif ($backLog == 5) // AOP Strike Off Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][254]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][254]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][254]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][254]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][254]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                }

            }
            elseif ($backLog == 4) // SMS/ GSS Approval
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][266]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][266]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][266]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][266]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][266]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                } 
            

            }
            elseif ($backLog == 3) // SMS/ GSS Submission
            {
                foreach ($ordDataArray as $poId => $val) 
                {
                    $StDate     = new DateTime($tnaDateArray[$poId][265]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][265]['end_date']);
                    $AcStDate   = new DateTime($tnaDateArray[$poId][265]['actual_start_date']);
                    $AcEndDate  = new DateTime($tnaDateArray[$poId][265]['actual_finish_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d') && $tnaDateArray[$poId][265]['actual_start_date']=="")
                    {
                        $backlogPOArray[$poId] = $poId;                        
                    }
                } 
            }
            elseif ($backLog == 2) // labdid approval
            {
                $poIdsCondBk = ($poIdBl !="") ? " and PO_BREAK_DOWN_ID in($poIdBl)" : '';
                $sqlLabDip = "SELECT PO_BREAK_DOWN_ID,APPROVAL_STATUS,count (distinct case when approval_status=3 then  color_name_id else 0 end) AS TOT_APP,count (distinct case when approval_status in(1,3) and submitted_to_buyer is not null then  color_name_id else 0 end) as TOT_SUB from wo_po_lapdip_approval_info where approval_status in(1,3) $poIdsCondBk and status_active=1 and is_deleted=0 group by po_break_down_id,approval_status";
                // echo $sqlLabDip;die();
                $sqlLabDipRes = sql_select($sqlLabDip);
                $labDipArray = array();
                foreach ($sqlLabDipRes as $val) 
                {
                    $labDipArray[$val['PO_BREAK_DOWN_ID']]['approve_color'] = $val['TOT_APP'];
                    $labDipArray[$val['PO_BREAK_DOWN_ID']]['submit_color'] = $val['TOT_SUB'];
                }
                
                foreach ($ordDataArray as $poId => $val) 
                {
                    $totPoColor     = count($poWiseColorArray[$poId]);
                    $labDipColorApp = $labDipArray[$poId]['approve_color'];
                    $StDate     = new DateTime($tnaDateArray[$poId][10]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][10]['end_date']);
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                    {
                        if($totPoColor - $labDipColorApp>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                    elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') >= $EndDate->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                        $todayDaysDif= $StDate->diff($toDay)->format('%a');

                        if((($totPoColor/$tnaDaysDif)*$todayDaysDif) - $labDipColorApp>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                } 
            }
            elseif ($backLog == 1) // labdid submit
            {
                $poIdsCondBk = ($poIdBl !="") ? " and PO_BREAK_DOWN_ID in($poIdBl)" : '';
                $sqlLabDip = "SELECT PO_BREAK_DOWN_ID,APPROVAL_STATUS,count (distinct case when approval_status=3 then  color_name_id else 0 end) AS TOT_APP,count (distinct case when approval_status in(1,3) and submitted_to_buyer is not null then  color_name_id else 0 end) as TOT_SUB from wo_po_lapdip_approval_info where approval_status in(1,3) $poIdsCondBk and status_active=1 and is_deleted=0 group by po_break_down_id,approval_status";
                // echo $sqlLabDip;die();
                $sqlLabDipRes = sql_select($sqlLabDip);
                $labDipArray = array();
                foreach ($sqlLabDipRes as $val) 
                {
                    $labDipArray[$val['PO_BREAK_DOWN_ID']]['approve_color'] = $val['TOT_APP'];
                    $labDipArray[$val['PO_BREAK_DOWN_ID']]['submit_color'] = $val['TOT_SUB'];
                }
               
                foreach ($ordDataArray as $poId => $val) 
                {
                    $totPoColor     = count($poWiseColorArray[$poId]);
                    $labDipColorSub = $labDipArray[$poId]['submit_color'];
                    $StDate     = new DateTime($tnaDateArray[$poId][9]['start_date']);
                    $EndDate    = new DateTime($tnaDateArray[$poId][9]['end_date']);
                    //echo $StDate->format('Y-m-d')."<br>";
                    if($toDay->format('Y-m-d') > $EndDate->format('Y-m-d'))
                    {
                        //echo $totPoColor." - ".$labDipColorSub;
                        if($totPoColor - $labDipColorSub>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                    elseif ($toDay->format('Y-m-d') > $StDate->format('Y-m-d') && $toDay->format('Y-m-d') >= $EndDate->format('Y-m-d'))
                    { //echo "ok";
                        $tnaDaysDif  = $EndDate->diff($StDate)->format('%a')+1;

                        $todayDaysDif= $StDate->diff($toDay)->format('%a');

                        if((($totPoColor/$tnaDaysDif)*$todayDaysDif) - $labDipColorSub>0)
                        {
                            $backlogPOArray[$poId] = $poId;
                        }
                    }
                }
            }
        }

        //print_r($start_alarm_po_array);
        $embBklogPoIds = "";
        if($backLog !=0)
        {
            $embBklogPoIds = implode(",", $backlogPOArray);
        }
        elseif($end_alarm !=0)
        {
            $embBklogPoIds = implode(",", $end_alarm_po_array);
        }       
        elseif($start_alarm !=0)
        {
            $embBklogPoIds = implode(",", $start_alarm_po_array);
        }
        elseif($emblishment !=0)
        {
            $embBklogPoIds = implode(",", $embPoArray);
        }
        unset($backlogPOArray);
        unset($end_alarm_po_array);
        unset($start_alarm_po_array);
        unset($embPoArray);
        /*$embBklogPoArray = array_unique(array_merge((array)$embPoArray,(array)$backlogPOArray));      
        $embBklogPoArray = array_unique(array_merge((array)$embBklogPoArray,(array)$start_alarm_po_array));
        $embBklogPoArray = array_unique(array_merge((array)$embBklogPoArray,(array)$end_alarm_po_array));
        $embBklogPoIds = implode(",", $embBklogPoArray);*/
        $embBklogPoCond = "";

        if($emblishment !=0 || $backLog !=0 || $start_alarm !=0 || $end_alarm !=0)
        {
            if($embBklogPoIds !="")
            {
                if($db_type==2 && count($embBklogPoArray)>1000)
                {
                    $embBklogPoCond=" and (";
                    $poIdsArr=array_chunk($embBklogPoArray,999);
                    foreach($poIdsArr as $ids)
                    {
                        $ids=implode(",",$ids);
                        $embBklogPoCond.=" b.id in($ids) or ";
                    }
                    $embBklogPoCond=chop($embBklogPoCond,'or ');
                    $embBklogPoCond.=")";
                }
                else
                {
                    $embBklogPoCond=" and b.id in($embBklogPoIds)";
                }
            }
            else // this will be execute when emblishment or baclog dropdown select but there is no PO
            {
                echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
            }
        }
        // echo $embBklogPoCond;die();


        /*------------------------------------------------------------------------------/
        /                                  MAIN QUERY                                   /
        /------------------------------------------------------------------------------*/

        $sql = "SELECT A.JOB_NO,A.GMTS_ITEM_ID,A.BUYER_NAME,A.LOCATION_NAME,A.STYLE_REF_NO,A.SET_SMV,A.DEALING_MARCHANT,A.CLIENT_ID,B.PO_NUMBER,B.GROUPING,B.PUB_SHIPMENT_DATE,B.SHIPMENT_DATE,B.ID AS PO_ID,C.COLOR_NUMBER_ID AS COLOR_ID,C.ORDER_QUANTITY AS QTY,(B.PUB_SHIPMENT_DATE-B.PO_RECEIVED_DATE) AS DAYS FROM WO_PO_DETAILS_MASTER A,WO_PO_BREAK_DOWN B,WO_PO_COLOR_SIZE_BREAKDOWN C WHERE A.ID=B.JOB_ID AND A.ID=C.JOB_ID AND B.ID=C.PO_BREAK_DOWN_ID AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 $sqlCond $embBklogPoCond order by B.GROUPING,B.SHIPMENT_DATE";
        // echo $sql;die();
        $sqlRes = sql_select($sql);
        if(count($sqlRes)==0)
        {
            echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
        }
        $dataArray = array();
        $poIdArray = array();
        $jobArray = array();
        $poWiseColorArray = array();
        $jobWisePoArray = array();
        foreach ($sqlRes as $row) 
        {
           $dataArray[$row['PO_ID']]['buyer']       = $row['BUYER_NAME'];
           $dataArray[$row['PO_ID']]['client']       = $row['CLIENT_ID'];
           $dataArray[$row['PO_ID']]['location']    = $row['LOCATION_NAME'];
           $dataArray[$row['PO_ID']]['style']       = $row['STYLE_REF_NO'];
           $dataArray[$row['PO_ID']]['po_no']       = $row['PO_NUMBER'];
           $dataArray[$row['PO_ID']]['int_ref']     = $row['GROUPING'];
           $dataArray[$row['PO_ID']]['ship_date']   = $row['PUB_SHIPMENT_DATE'];
           $dataArray[$row['PO_ID']]['orig_ship_date']= $row['SHIPMENT_DATE'];
           $dataArray[$row['PO_ID']]['item']        = $row['GMTS_ITEM_ID'];
           $dataArray[$row['PO_ID']]['smv']         = $row['SET_SMV'];
           $dataArray[$row['PO_ID']]['job_no']      = $row['JOB_NO'];
           $dataArray[$row['PO_ID']]['merchant']    = $row['DEALING_MARCHANT'];
           $dataArray[$row['PO_ID']]['days']        = $row['DAYS'];
           $dataArray[$row['PO_ID']]['qty']         += $row['QTY'];
           $poIdArray[$row['PO_ID']]                = $row['PO_ID'];
           $poWiseColorArray[$row['PO_ID']][$row['COLOR_ID']] += $row['COLOR_ID'];
           $jobArray[$row['JOB_NO']] = "'".$row['JOB_NO']."'";
           $jobWisePoArray[$row['JOB_NO']][$row['PO_ID']]  = $row['PO_ID'];
        }
        $poIDS = implode(",", $poIdArray);
        unset($sqlRes);
        // echo count($poWiseColorArray[38932]);
        // echo "<pre>";
        // print_r($poWiseColorArray);
        //================================ PO Cond=================================
        $poIdsCond="";
        if($db_type==2 && count($poIdArray)>1000)
        {
            $poIdsCond=" and (";
            $poIdsArr=array_chunk($poIdArray,999);
            foreach($poIdsArr as $ids)
            {
                $ids=implode(",",$ids);
                $poIdsCond.=" po_break_down_id in($ids) or ";
            }
            $poIdsCond=chop($poIdsCond,'or ');
            $poIdsCond.=")";
        }
        else
        {
            $poIdsCond=" and po_break_down_id in($poIDS)";
        }

        //================================ Job Cond=================================
        $jobNo = implode(",", $jobArray);
        $jobCond="";
        if($db_type==2 && count($jobArray)>1000)
        {
            $jobCond=" and (";
            $poIdsArr=array_chunk($jobArray,999);
            foreach($poIdsArr as $ids)
            {
                $ids=implode(",",$ids);
                $jobCond.=" a.job_no in($ids) or ";
            }
            $jobCond=chop($jobCond,'or ');
            $jobCond.=")";
        }
        else
        {
            $jobCond=" and a.job_no in($jobNo)";
        }
        // echo $jobCond;die();

        // ======================================= LABDIP ==================================
        $sqlLabDip = "SELECT PO_BREAK_DOWN_ID,APPROVAL_STATUS,COUNT (DISTINCT CASE WHEN APPROVAL_STATUS=3 THEN  COLOR_NAME_ID ELSE 0 END)     AS TOT_APP,COUNT (DISTINCT CASE WHEN APPROVAL_STATUS IN(1,3) AND SUBMITTED_TO_BUYER IS NOT NULL THEN  COLOR_NAME_ID ELSE 0 END) AS TOT_SUB FROM WO_PO_LAPDIP_APPROVAL_INFO WHERE APPROVAL_STATUS in(1,3) $poIdsCond and STATUS_ACTIVE=1 AND IS_DELETED=0 group by PO_BREAK_DOWN_ID,APPROVAL_STATUS";
        // echo $sqlLabDip;die();
        $sqlLabDipRes = sql_select($sqlLabDip);
        $labDipArray = array();
        foreach ($sqlLabDipRes as $val) 
        {
            $labDipArray[$val['PO_BREAK_DOWN_ID']]['approve_color'] = $val['TOT_APP'];
            $labDipArray[$val['PO_BREAK_DOWN_ID']]['submit_color'] = $val['TOT_SUB'];
        }
        // print_r($labDipArray);
        unset($sqlLabDipRes);
        // ======================================= SAMPLE  ==================================
        $sqlLabSM = "SELECT PO_BREAK_DOWN_ID,SAMPLE_TYPE_ID,COUNT(COLOR_NUMBER_ID) AS TOT_COLOR FROM WO_PO_SAMPLE_APPROVAL_INFO WHERE APPROVAL_STATUS=1 $poIdsCond AND SAMPLE_TYPE_ID IN(7,18,60) and STATUS_ACTIVE=1 AND IS_DELETED=0 group by PO_BREAK_DOWN_ID,SAMPLE_TYPE_ID";
        // echo $sqlLabSM;
        $sqlLabSMRes = sql_select($sqlLabSM);
        $smArray = array();
        foreach ($sqlLabSMRes as $val) 
        {
            $smArray[$val['PO_BREAK_DOWN_ID']][$val['SAMPLE_TYPE_ID']] = $val['TOT_COLOR'];
        }
        unset($sqlLabSMRes);
        // print_r($smArray);

        // ======================================= BOOKING DATA  ==================================
        $poIdsCondBooking = str_replace("po_break_down_id", "b.po_break_down_id", $poIdsCond);
        // $sqlBooking = "SELECT B.PO_BREAK_DOWN_ID,MAX(A.BOOKING_DATE) AS BDATE,SUM(B.FIN_FAB_QNTY) AS QTY FROM WO_BOOKING_MST A,WO_BOOKING_DTLS B WHERE A.BOOKING_NO=B.BOOKING_NO AND A.IS_APPROVED=1 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 $poIdsCondBooking group by B.PO_BREAK_DOWN_ID";
        $sqlBooking = "SELECT A.IS_APPROVED,a.FABRIC_COMPOSITION,a.FABRICSTRUCTURE,a.FABRICGSM, a.FABRIC_SOURCE,a.IS_SHORT,B.PO_BREAK_DOWN_ID,MAX(A.BOOKING_DATE) AS BDATE,SUM(B.FIN_FAB_QNTY) AS QTY,SUM(B.GREY_FAB_QNTY) AS GREY_QTY FROM WO_BOOKING_MST A,WO_BOOKING_DTLS B WHERE A.BOOKING_NO=B.BOOKING_NO AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 and a.booking_type=1 $poIdsCondBooking group by A.IS_APPROVED,a.FABRIC_COMPOSITION,a.FABRICSTRUCTURE,a.FABRICGSM,a.FABRIC_SOURCE,a.IS_SHORT,B.PO_BREAK_DOWN_ID";
        // echo $sqlBooking;die();
        $bookingRes = sql_select($sqlBooking);
        $bookingQtyArray = array();
        $bookingFabInfoArray = array();
        foreach ($bookingRes as $val) 
        {
            //if($val['IS_APPROVED']==1)
            //{
                if($val['IS_SHORT']==2)
                {
                    $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['qty'] += $val['QTY'];
                    $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['date'] = $val['BDATE'];
                }
                else
                {
                    
                    $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['fin_fab_excess_qty'] += $val['QTY'];
                    if($val['FABRIC_SOURCE'] !=2)// avoid purchase
                    {
                        $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['grey_fab_excess_qty'] += $val['GREY_QTY'];
                        $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['yarn_excess_qty'] += $val['GREY_QTY'];
                    }

                }
            //}   

            if($val['IS_SHORT']==2)
            {                         
                $bookingFabInfoArray[$val['PO_BREAK_DOWN_ID']]['construction'] = $val['FABRICSTRUCTURE'];
                $bookingFabInfoArray[$val['PO_BREAK_DOWN_ID']]['composition'] = $val['FABRIC_COMPOSITION'];
                $bookingFabInfoArray[$val['PO_BREAK_DOWN_ID']]['gsm'] = $val['FABRICGSM'];
            }
            
        }
        // echo "<pre>";print_r($bookingQtyArray);die();

        // ======================================= COLOR TYPE WISE BOOKING DATA  ==================================
        $poIdsCondBooking = str_replace("po_break_down_id", "a.po_break_down_id", $poIdsCond);
        $shortSql = "SELECT a.PO_BREAK_DOWN_ID, b.COLOR_TYPE_ID,a.FIN_FAB_QNTY, a.GREY_FAB_QNTY FROM wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b WHERE a.pre_cost_fabric_cost_dtls_id=b.id $poIdsCondBooking and a.is_short=1 and a.status_active=1 and  a.is_deleted=0";
        $shortRes = sql_select($shortSql);
        $color_type_wise_booking_qty_array = array();
        foreach ($shortRes as $val) 
        {
            $color_type_wise_booking_qty_array[$val['PO_BREAK_DOWN_ID']][$val['COLOR_TYPE_ID']] += $val['FIN_FAB_QNTY'];
        }
        // echo "<pre>";print_r($color_type_wise_booking_qty_array);die();

        // ======================================= TNA DATA  ==================================
        $poIdsCondTna = str_replace("po_break_down_id", "A.PO_NUMBER_ID", $poIdsCond);
        $sqltna = "SELECT A.PO_NUMBER_ID,A.TASK_NUMBER,MAX(A.TASK_START_DATE) AS START_DATE,MAX(A.TASK_FINISH_DATE) AS END_DATE,MAX(A.ACTUAL_START_DATE) AS ACTUAL_START_DATE,MAX(A.ACTUAL_FINISH_DATE) AS ACTUAL_FINISH_DATE FROM TNA_PROCESS_MST A,WO_PO_BREAK_DOWN B WHERE A.PO_NUMBER_ID=B.ID AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.PO_QUANTITY>0 $poIdsCondTna AND A.TASK_TYPE=1 group by A.PO_NUMBER_ID,A.TASK_NUMBER";
        // echo $sqltna;die();
        $tnaRes = sql_select($sqltna);
        $tnaDateArray = array();
        foreach ($tnaRes as $val) 
        {
            $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['start_date']          = $val['START_DATE'];
            $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['end_date']            = $val['END_DATE'];
            $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_start_date']   = $val['ACTUAL_START_DATE'];
            $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_finish_date']  = $val['ACTUAL_FINISH_DATE'];
        }
        // print_r($tnaDateArray);
        unset($tnaRes);
        //======================================== avg cons qty for yarn dyed =========================
        $poIdsCondCons = str_replace("po_break_down_id", "b.id", $poIdsCond);
        $sqlCons = sql_select("SELECT a.JOB_NO,b.ID,d.REQUIRMENT from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_avg_con_dtls d where a.id=b.job_id and a.job_no=c.job_no and c.id=d.pre_cost_fabric_cost_dtls_id and b.id=d.po_break_down_id and c.color_type_id in(2,3,4,6) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 $poIdsCondCons  and d.CONS>0");
        $job_wise_cons_array = array();
        $po_wise_cons_array = array();
        foreach ($sqlCons as $val) 
        {
            $job_wise_cons_array[$val['JOB_NO']] += $val['REQUIRMENT'];
            $po_wise_cons_array[$val['JOB_NO']][$val['ID']] += $val['REQUIRMENT'];
        }
        unset($sqlCons);
        // ======================================= dayed yarn rcv ====================================
        $sql_yarn_dyed = "SELECT a.JOB_NO ,a.cons_quantity as RECV_QNTY,(case when b.RECEIVE_DATE < '$current_date' then a.cons_quantity else 0 end) as PREV_RECV_QNTY from inv_transaction a, inv_receive_master b, product_details_master c where a.mst_id=b.id and a.prod_id=c.id and b.entry_form=1 and b.receive_basis=2 and b.receive_purpose=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.item_category=1 and a.transaction_type=1 $jobCond and c.dyed_type=1";
        // echo $sql_yarn_dyed;die();
        $sql_yarn_dyed_res = sql_select($sql_yarn_dyed);
        $yarn_dyed_rcv_qty_array = array();
        $yarn_dyed_prev_rcv_qty_array = array();
        foreach ($sql_yarn_dyed_res as $val) 
        {
            $yarn_dyed_rcv_qty_array[$val['JOB_NO']] += $val['RECV_QNTY'];
            $yarn_dyed_prev_rcv_qty_array[$val['JOB_NO']] += $val['PREV_RECV_QNTY'];
        }
        unset($sql_yarn_dyed);
        // ======================================= Primary yarn req  ==================================
        $poIdsCondYarn = str_replace("po_break_down_id", "b.id", $poIdsCond);
        $sqlpo="SELECT a.id as JOB_ID, a.job_no AS JOB_NO, b.id AS ID, c.item_number_id AS ITEM_NUMBER_ID, c.color_number_id AS COLOR_NUMBER_ID, c.size_number_id AS SIZE_NUMBER_ID, c.order_quantity AS ORDER_QUANTITY, c.plan_cut_qnty AS PLAN_CUT_QNTY, d.costing_per_id AS COSTING_PER from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_dtls d where a.id=b.job_id and b.id=c.po_break_down_id and a.id=d.job_id and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.is_deleted=0 and d.status_active=1 $poIdsCondYarn";
        // echo $sqlpo;
        $sqlpoRes = sql_select($sqlpo);
        $po_arr=array(); $costingPerArr=array(); 
        foreach($sqlpoRes as $row)
        {
            $costingPerQty=0;
            if($row['COSTING_PER']==1) $costingPerQty=12;
            elseif($row['COSTING_PER']==2) $costingPerQty=1;    
            elseif($row['COSTING_PER']==3) $costingPerQty=24;
            elseif($row['COSTING_PER']==4) $costingPerQty=36;
            elseif($row['COSTING_PER']==5) $costingPerQty=48;
            else $costingPerQty=0;
            
            $costingPerArr[$row['JOB_ID']]=$costingPerQty;
            
            $po_arr[$row['JOB_ID']][$row['ID']][$row['ITEM_NUMBER_ID']][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['poqty']+=$row['ORDER_QUANTITY'];
            $po_arr[$row['JOB_ID']][$row['ID']][$row['ITEM_NUMBER_ID']][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['planqty']+=$row['PLAN_CUT_QNTY'];     
        }
        //==================================== YARN ALLOCATION ==============================================
        $poIdsCondYarnAllo = str_replace("po_break_down_id", "B.PO_BREAK_DOWN_ID", $poIdsCond);
        $sqlYarnAllo = "SELECT B.PO_BREAK_DOWN_ID as PO_ID,MAX(B.ALLOCATION_DATE) AS ADATE,SUM(B.QNTY) AS QNTY,SUM(case when a.allocation_date < '$current_date' then B.QNTY else 0 end) AS PREV_QNTY from INV_MATERIAL_ALLOCATION_MST A, INV_MATERIAL_ALLOCATION_DTLS B,PRODUCT_DETAILS_MASTER C WHERE A.ID=B.MST_ID AND A.ITEM_ID=C.ID AND B.ITEM_ID=C.ID AND B.IS_DYIED_YARN!=1 AND C.item_category_id=1 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 and B.IS_SALES!=2 and a.allocation_date <= '$current_date' $poIdsCondYarnAllo GROUP BY B.PO_BREAK_DOWN_ID";
        // echo $sqlYarnAllo;die();
        $sqlYarnAlloRes = sql_select($sqlYarnAllo);
        $yarnAlloArr = array();
        foreach ($sqlYarnAlloRes as $val) 
        {
            $yarnAlloArr[$val['PO_ID']]['qnty'] = $val['QNTY'];
            $yarnAlloArr[$val['PO_ID']]['prev_qnty'] = $val['PREV_QNTY'];
            $yarnAlloArr[$val['PO_ID']]['date'] = $val['ADATE'];
        }
        $condition= new condition();     
        $condition->po_id_in($poIDS);     
        $condition->init();
        $costPerArr=$condition->getCostingPerArr();
        // print_r($costPerArr['KAL-20-00024']);die();
       /* $costPerQty=$costPerArr[$jobNumber];
        if($costPerQty>1)
        {
            $costPerUom=($costPerQty/12)." Dzn";
        }
        else
        {
            $costPerUom=($costPerQty/1)." Pcs";
        }*/
        $yarn= new yarn($condition);
        //echo $yarn->getQuery(); die;       
        $yarnReqQtyArr=$yarn->getOrderWiseYarnQtyArray();
        //$yarn->unsetDataArray();
        // print_r($yarn_qty_arr);die();
        $conversion= new conversion($condition);
        $conversion_costing_arr=$conversion->getQtyArray_by_orderAndProcess();
        // echo"<pre>";print_r($conversion_costing_arr);die();
        $trims= new trims($condition);
         // echo $trims->getQuery(); die;
        $trims_costing_arr=$trims->getQtyArray_by_orderAndTrimsTypeid();
        // echo"<pre>";print_r($trims_costing_arr);die();
        $fabric= new fabric($condition);
        // echo $fabric->getQuery(); die; 
        //$fabric_costing_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();
        $fabric_costing_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish_production();
        $fabric_purchase_costing_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish_purchase();
        $fabric_po_color_type_wise_arr=$fabric->getQtyArray_by_orderColorType_knitAndwoven_greyAndfinish();
        $fabric_costing_aop_arr = $fabric->getQtyArray_by_orderAndColorTypeFabricSource_knitAndwoven_greyAndfinish();

        // echo"<pre>";print_r($fabric_costing_arr);die();
        $emblishment= new emblishment($condition);
        $emblishment_costing_arr=$emblishment->getQtyArray_by_orderAndEmbname();
        // echo"<pre>";print_r($emblishment_costing_arr);die();
        // echo $emblishment->getQuery(); die;   
        $wash= new wash($condition);
        $emblishment_costing_arr_name=$wash->getQtyArray_by_orderAndEmbname();
        // echo $wash->getQuery(); die; 
        // $commercial= new commercial($condition);
        // $commercial_costing_arr=$commercial->getAmountArray_by_order();
       
        // $commission= new commision($condition);    
        // $commission_costing_arr=$commission->getAmountArray_by_orderAndItemid();
      
        // $other= new other($condition);
        // $other_costing_arr=$other->getAmountArray_by_order();
        //$other->unsetDataArray();

        //======================================== YARN ISSUE ====================================
        $poIdsCondYrnIss = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
        $sqlYrnIss = "SELECT C.PO_BREAKDOWN_ID,SUM(CASE WHEN B.TRANSACTION_TYPE=2 THEN C.QUANTITY ELSE 0 END) AS ISSUE_QNTY,SUM(CASE WHEN B.TRANSACTION_TYPE=4 THEN C.QUANTITY ELSE 0 END) AS RTN_QTY FROM INV_ISSUE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE in(2,4) $poIdsCondYrnIss and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=3 AND A.ITEM_CATEGORY=1 and a.issue_basis=3 and a.issue_purpose=1 GROUP BY C.PO_BREAKDOWN_ID";
        // echo $sqlYrnIss;die();
        $sqlYrnIssRes = sql_select($sqlYrnIss);
        $yarnIssueQtyArr = array();
        foreach ($sqlYrnIssRes as $val) 
        {
            $yarnIssueQtyArr[$val['PO_BREAKDOWN_ID']]['issue'] += $val['ISSUE_QNTY'];
            $yarnIssueQtyArr[$val['PO_BREAKDOWN_ID']]['rtn'] += $val['RTN_QTY'];
            // echo $val['ISSUE_QNTY']."<br>";
        }
        // echo "<pre>";print_r($yarnIssueQtyArr);die();
        //======================================== YARN ISSUE RETURN ====================================
        $poIdsCondYrnIss = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
        // $sqlYrnIss = "SELECT C.PO_BREAKDOWN_ID,C.QUANTITY FROM ORDER_WISE_PRO_DETAILS C WHERE c.trans_type=4 and c.entry_form=9 $poIdsCondYrnIss";
        // echo $sqlYrnIss;die();
        $sqlYrnIssRtn = "SELECT c.po_breakdown_id, sum(b.cons_quantity) as QUANTITY,sum(b.cons_reject_qnty) as REJ_QUANTITY from inv_receive_master a, inv_transaction b,order_wise_pro_details c where a.id = b.mst_id and b.id=c.trans_id $poIdsCondYrnIss and a.status_active =1 and a.is_deleted=0 and a.entry_form in(9) and b.transaction_type in(4) and b.item_category=1 and a.status_active =1 and b.status_active =1 group by c.po_breakdown_id";

        $sqlYrnIssRes = sql_select($sqlYrnIssRtn);
        $yarnIssueRtnQtyArr = array();
        foreach ($sqlYrnIssRes as $val) 
        {
            $yarnIssueRtnQtyArr[$val['PO_BREAKDOWN_ID']]['issue_return'] += $val['QUANTITY'];
            $yarnIssueRtnQtyArr[$val['PO_BREAKDOWN_ID']]['reject_qty'] += $val['REJ_QUANTITY'];
        }
        // ======================================= Yarn dyed receive ==============================
        $poIdsCondYarnDye = str_replace("po_break_down_id", "B.ORDER_ID", $poIdsCond);
        $sql = "SELECT A.RECEIVE_DATE,B.ORDER_ID,SUM(B.CONS_QUANTITY) AS QNTY FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B WHERE A.RECEIVE_BASIS=2 AND A.RECEIVE_PURPOSE=2 AND B.TRANSACTION_TYPE=1 $poIdsCondYarnDye and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND A.ENTRY_FORM=1 AND A.ITEM_CATEGORY=1 GROUP BY B.ORDER_ID,A.RECEIVE_DATE order by A.RECEIVE_DATE ASC ";
        // echo $sql;die();
        $sqlYRes = sql_select($sql);
        $yarnDyedArr = array();
        foreach ($sqlYRes as  $val) 
        {
           $yarnDyedArr[$val['ORDER_ID']]['qty'] += $val['QNTY'];
           $yarnDyedArr[$val['ORDER_ID']]['lstqty'] = $val['QNTY'];
        }
        // ======================================= YARN DYED ISSUE ==============================
        // $poIdsCondYarnDye = str_replace("po_break_down_id", "B.ORDER_ID", $poIdsCond);
        $sqlDyeYrnIss = "SELECT C.PO_BREAKDOWN_ID,SUM(CASE WHEN B.TRANSACTION_TYPE=2 THEN C.QUANTITY ELSE 0 END) AS ISSUE_QNTY,SUM(CASE WHEN B.TRANSACTION_TYPE=4 THEN C.QUANTITY ELSE 0 END) AS RTN_QTY FROM INV_ISSUE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE in(2,4) $poIdsCondYrnIss and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=3 AND A.ITEM_CATEGORY=1 and a.issue_basis=1 and a.issue_purpose=2 GROUP BY C.PO_BREAKDOWN_ID";
        // echo $sqlDyeYrnIss;die();
        $sqlDyeYrnIssRes = sql_select($sqlDyeYrnIss);
        $yarnDyeIssueQtyArr = array();
        foreach ($sqlDyeYrnIssRes as $val) 
        {
            $yarnDyeIssueQtyArr[$val['PO_BREAKDOWN_ID']]['issue'] = $val['ISSUE_QNTY'];
            $yarnDyeIssueQtyArr[$val['PO_BREAKDOWN_ID']]['rtn'] = $val['RTN_QTY'];
        }
        // echo "<pre>";print_r($yarnDyeIssueQtyArr);die();
        // ======================================= GREY PROD ==============================
        $poIdsCondGrey = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
        $sqlGrey = "SELECT C.PO_BREAKDOWN_ID,A.RECEIVE_DATE AS RCV_DATE,SUM(C.QUANTITY) AS QNTY,SUM(case when a.receive_date < '$current_date' then C.QUANTITY else 0 end) AS PREV_QNTY FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE=1 $poIdsCondGrey and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM in(2,22,58) AND A.ITEM_CATEGORY=13 GROUP BY C.PO_BREAKDOWN_ID,A.RECEIVE_DATE order by A.RECEIVE_DATE ASC ";
        // echo $sqlGrey;die();
        $greyRes = sql_select($sqlGrey);
        $greyProdArr = array();
        foreach ($greyRes as  $val) 
        {
           $greyProdArr[$val['PO_BREAKDOWN_ID']]['qty']     += $val['QNTY'];
           $greyProdArr[$val['PO_BREAKDOWN_ID']]['prev_qnty']     += $val['PREV_QNTY'];
           $greyProdArr[$val['PO_BREAKDOWN_ID']]['lstqty']  = $val['QNTY'];
           $greyProdArr[$val['PO_BREAKDOWN_ID']]['date']    = $val['RCV_DATE'];
        }
        /*======================================================================================/
        /                                    grey fab transfer                                  /
        /======================================================================================*/
        $to_order_id_con =where_con_using_array($poIdArray,0,"a.to_order_id");
        $from_order_id_con =where_con_using_array($poIdArray,0,"a.from_order_id");

        $transfer_sql_in=sql_select("SELECT a.to_order_id,b.transfer_qnty as qnty FROM inv_item_transfer_mst a, inv_item_transfer_dtls b WHERE a.id = b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=13 and a.entry_form in(13) and a.transfer_criteria=4 and b.active_dtls_id_in_transfer=1 $to_order_id_con");
        $grey_fab_transfer_data=array();
        foreach ($transfer_sql_in as $row) 
        {
            $grey_fab_transfer_data[$row[csf('to_order_id')]]['in']+=$row[csf('qnty')];
        }
        $transfer_sql_out=sql_select("SELECT a.from_order_id,b.transfer_qnty as qnty FROM inv_item_transfer_mst a, inv_item_transfer_dtls b WHERE a.id = b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=13 and a.entry_form in(13) and a.transfer_criteria=4 and b.active_dtls_id_in_transfer=0 $from_order_id_con");
        foreach ($transfer_sql_out as $row) 
        {
            $grey_fab_transfer_data[$row[csf('from_order_id')]]['out']+=$row[csf('qnty')];
        }
        // echo "<pre>";print_r($grey_fab_transfer_data);die();

        //======================================== PROGRAM QNTY ================================
        $poIdsProg = str_replace("po_break_down_id", "PO_ID", $poIdsCond);
        $sqlProg = "SELECT PO_ID,sum(program_qnty) as QTY from ppl_planning_entry_plan_dtls where status_active=1 and is_deleted=0 $poIdsProg group by PO_ID";
        // echo $sqlProg;die();
        $pogRes = sql_select($sqlProg);
        $progQtyArray = array();
        foreach ($pogRes as $val) 
        {
            $progQtyArray[$val['PO_ID']] = $val['QTY'];
        }

        // ======================================= DYEING PRODUCTION ==============================
        $poIdsCondDye = str_replace("po_break_down_id", "B.PO_ID", $poIdsCond);
        $sqlDye = "SELECT B.PO_ID,C.PRODUCTION_DATE AS PDATE,SUM(B.BATCH_QNTY) AS QTY,SUM(case when c.PROCESS_END_DATE < '$current_date' then B.BATCH_QNTY else 0 end) AS PREV_QTY FROM PRO_BATCH_CREATE_MST A, PRO_BATCH_CREATE_DTLS B,PRO_FAB_SUBPROCESS C WHERE A.ID=B.MST_ID  AND A.ID=C.BATCH_ID $poIdsCondDye AND C.LOAD_UNLOAD_ID=2  and a.batch_against<>2  AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 and a.extention_no is null GROUP BY B.PO_ID,C.PRODUCTION_DATE order by C.PRODUCTION_DATE ASC";//AND C.RESULT=1 and c.process_id=31
        // echo $sqlDye;die();
        $dyeRes = sql_select($sqlDye);
        $dyeingProdArr = array();
        foreach ($dyeRes as $val) 
        {
           $dyeingProdArr[$val['PO_ID']]['in'] += $val['QTY'];
           $dyeingProdArr[$val['PO_ID']]['prev_in'] += $val['PREV_QTY'];
           $dyeingProdArr[$val['PO_ID']]['lstqty'] = $val['QTY'];
           $dyeingProdArr[$val['PO_ID']]['date'] = $val['PDATE'];
        }

        // ======================================= DYEING PRODUCTION (Outbound) ==============================
        $poIdsCondDye = str_replace("po_break_down_id", "B.order_id", $poIdsCond);
        $sqlDye = "SELECT B.order_id as PO_ID,A.RECEIVE_DATE AS PDATE,SUM(B.GREY_USED) AS QTY,sum(b.BATCH_ISSUE_QTY) as BATCH_QTY FROM INV_RECEIVE_MAS_BATCHROLL A, PRO_GREY_BATCH_DTLS B WHERE A.ID=B.MST_ID  $poIdsCondDye  AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 and a.dyeing_source=3 and a.entry_form=92 GROUP BY B.order_id,A.RECEIVE_DATE order by A.RECEIVE_DATE ASC";
        // echo $sqlDye;die();
        $dyeRes = sql_select($sqlDye);
        foreach ($dyeRes as $val) 
        {
           // $dyeingProdArr[$val['PO_ID']]['out'] += $val['QTY'];
           $dyeingProdArr[$val['PO_ID']]['batch_qty'] += $val['QTY'];
           // $dyeingProdArr[$val['PO_ID']]['lstqty'] = $val['QTY'];
           // $dyeingProdArr[$val['PO_ID']]['date'] = $val['PDATE'];
        }
        $poIdsCondFin = str_replace("po_break_down_id", "c.po_breakdown_id", $poIdsCond);
        $sqlDye = "SELECT c.po_breakdown_id as po_id,b.grey_used_qty as QTY,(case when a.receive_date<'$current_date' then b.grey_used_qty else 0 end) as PREV_QTY from inv_receive_master a,pro_finish_fabric_rcv_dtls b,order_wise_pro_details c where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 $poIdsCondFin and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(37) and c.entry_form in(37) and a.item_category=2 and a.receive_basis=11 and a.company_id=$company_id";
         // echo $sqlDye;die();
        $dyeRes = sql_select($sqlDye);
        foreach ($dyeRes as $val) 
        {
           $dyeingProdArr[$val['PO_ID']]['out'] += $val['QTY'];
           $dyeingProdArr[$val['PO_ID']]['prev_out'] += $val['PREV_QTY'];
        }

        // ======================================= BATCH QNTY ==============================
        $poIdsCondDye = str_replace("po_break_down_id", "B.PO_ID", $poIdsCond);
        $sqlBatch = "SELECT B.PO_ID,SUM(B.BATCH_QNTY) AS QTY FROM PRO_BATCH_CREATE_MST A, PRO_BATCH_CREATE_DTLS B WHERE A.ID=B.MST_ID $poIdsCondDye AND a.batch_against IN (1) AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY B.PO_ID";
        // echo $sqlBatch;die();
        $batchRes = sql_select($sqlBatch);
        $batchQtyArr = array();
        foreach ($batchRes as $val) 
        {
           $batchQtyArr[$val['PO_ID']]['qty'] = $val['QTY'];
        }

        // ======================================= AOP ==============================
        $poIdsCondAop = str_replace("po_break_down_id", "B.ORDER_ID", $poIdsCond);
        $sqlAOP = "SELECT B.ORDER_ID,A.RECEIVE_DATE AS RDATE,SUM(CASE WHEN A.ENTRY_FORM=91 THEN B.BATCH_ISSUE_QTY ELSE 0 END) AS ISSUE_QTY,SUM(CASE WHEN A.ENTRY_FORM=92 THEN B.BATCH_ISSUE_QTY ELSE 0 END) AS RCV_QTY,SUM(CASE WHEN A.ENTRY_FORM=92 and a.RECEIVE_DATE < '$current_date' THEN B.BATCH_ISSUE_QTY ELSE 0 END) AS PREV_RCV_QTY FROM INV_RECEIVE_MAS_BATCHROLL A, PRO_GREY_BATCH_DTLS B WHERE A.ID=B.MST_ID $poIdsCondAop AND B.PROCESS_ID=35 AND A.ENTRY_FORM in(91,92) AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY B.ORDER_ID,A.RECEIVE_DATE order by A.RECEIVE_DATE";
        // echo $sqlAOP;die();
        $AOPRes = sql_select($sqlAOP);
        $aopProdArr = array();
        foreach ($AOPRes as $val) 
        {
            $aopProdArr[$val['ORDER_ID']]['qty'] += $val['RCV_QTY'];
            $aopProdArr[$val['ORDER_ID']]['prev_qty'] += $val['PREV_RCV_QTY'];
            $aopProdArr[$val['ORDER_ID']]['issueqty'] += $val['ISSUE_QTY'];
            if($val['RCV_QTY']!=0)
            {
                $aopProdArr[$val['ORDER_ID']]['lstqty'] = $val['RCV_QTY'];
            }
            $aopProdArr[$val['ORDER_ID']]['date'] = $val['RDATE'];
        }
        // print_r($aopProdArr);die();
        // ======================================= TRIMS (acc)============================== 
        $poIdsCondAcc = str_replace("po_break_down_id", "B.ID", $poIdsCond);
        $sqlTrimsBudget = "SELECT B.ID AS PO_ID,COUNT(distinct A.trim_group) AS TOT_ITEM FROM WO_PRE_COST_TRIM_COST_DTLS A, WO_PO_BREAK_DOWN B WHERE A.JOB_ID=B.JOB_ID $poIdsCondAcc AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY B.ID";//COUNT(A.ID)
        // echo $sqlTrimsBudget;die();
        $trimsItemCountBudgetWise = array();
        $trimsBudgetRes = sql_select($sqlTrimsBudget);
        foreach ($trimsBudgetRes as $val) 
        {
            $trimsItemCountBudgetWise[$val['PO_ID']] = $val['TOT_ITEM'];
        }
        //====================================================================     
        $poIdsCondAcc = str_replace("po_break_down_id", "C.PO_BREAK_DOWN_ID", $poIdsCond);
        $sqlTrims = "SELECT C.PO_BREAK_DOWN_ID,COUNT(distinct B.TRIM_GROUP) AS TOT_ITEM FROM WO_BOOKING_MST A,WO_BOOKING_DTLS B,WO_TRIM_BOOK_CON_DTLS C WHERE A.BOOKING_NO=B.BOOKING_NO AND B.BOOKING_NO=C.BOOKING_NO AND B.ID=C.WO_TRIM_BOOKING_DTLS_ID $poIdsCondAcc and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=87 AND A.BOOKING_TYPE=2 AND A.IS_SHORT=2 GROUP BY C.PO_BREAK_DOWN_ID ";
        // echo $sqlTrims;die();
        $trimsRes = sql_select($sqlTrims);
        $trimsBookingArr = array();
        foreach ($trimsRes as  $val) 
        {
           $trimsBookingArr[$val['PO_BREAK_DOWN_ID']] = $val['TOT_ITEM'];
        }

        // ======================================= FINISH FAB RCV ==============================   
        $poIdsCondFin = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
        $sqlFinFab = "SELECT C.PO_BREAKDOWN_ID,A.RECEIVE_DATE AS RCV_DATE,SUM(C.QUANTITY) AS QNTY FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE=1 $poIdsCondFin and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM in(7,37) AND A.ITEM_CATEGORY=2 GROUP BY C.PO_BREAKDOWN_ID,A.RECEIVE_DATE order by A.RECEIVE_DATE ASC";
         //echo $sqlFinFab;die();
        $finFabRes = sql_select($sqlFinFab);
        $finFabProdArr = array();
        foreach ($finFabRes as  $val) 
        {
           $finFabProdArr[$val['PO_BREAKDOWN_ID']]['qty'] += $val['QNTY'];
           $finFabProdArr[$val['PO_BREAKDOWN_ID']]['lstqty'] = $val['QNTY'];
           $finFabProdArr[$val['PO_BREAKDOWN_ID']]['date'] = $val['RCV_DATE'];
        }
        
        // ======================================= FINISH FAB PURCHASE ==============================   
        $poIdsCondFin = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
        $sqlFinFabpur = "SELECT C.PO_BREAKDOWN_ID,A.RECEIVE_DATE AS RCV_DATE,SUM(C.QUANTITY) AS QNTY,SUM(case when a.receive_date < '$current_date' then C.QUANTITY else 0 end) AS PREV_QNTY FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE=1 and a.receive_basis in(1,2,4) $poIdsCondFin and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM in(37) AND A.ITEM_CATEGORY=2 GROUP BY C.PO_BREAKDOWN_ID,A.RECEIVE_DATE order by A.RECEIVE_DATE ASC";
        // echo $sqlFinFabpur;die();
        $finFabPurRes = sql_select($sqlFinFabpur);
        $finFabPurchaseArr = array();
        foreach ($finFabPurRes as  $val) 
        {
           $finFabPurchaseArr[$val['PO_BREAKDOWN_ID']]['qty'] += $val['QNTY'];
           $finFabPurchaseArr[$val['PO_BREAKDOWN_ID']]['prev_qty'] += $val['PREV_QNTY'];
        }

        // ======================================= FINISH FAB TRANSFER ==============================   
        $poIdsCondTrnsfr = str_replace("po_break_down_id", "B.PO_BREAKDOWN_ID", $poIdsCond);
        //$sqlFinFabTr = "SELECT C.ORDER_ID,C.TRANSACTION_TYPE,SUM(B.TRANSFER_QNTY) AS QNTY FROM INV_ITEM_TRANSFER_MST A,INV_ITEM_TRANSFER_DTLS B,INV_TRANSACTION C WHERE A.ID=B.MST_ID AND A.ID=C.MST_ID AND C.ID=B.TRANS_ID  AND C.TRANSACTION_TYPE in(5,6) and A.TRANSFER_CRITERIA=4 $poIdsCondTrnsfr and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=14 AND A.ITEM_CATEGORY=2 GROUP BY C.ORDER_ID,C.TRANSACTION_TYPE ";
        $sqlFinFabTr = "SELECT B.PO_BREAKDOWN_ID,A.TRANSACTION_TYPE,SUM(B.QUANTITY) AS QNTY FROM INV_TRANSACTION A,ORDER_WISE_PRO_DETAILS B,INV_ITEM_TRANSFER_MST C WHERE A.ID=B.trans_id and a.prod_id=b.prod_id and c.id=a.mst_id AND a.TRANSACTION_TYPE in(5,6) and c.TRANSFER_CRITERIA=4 $poIdsCondTrnsfr and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND c.ENTRY_FORM=14 AND A.ITEM_CATEGORY=2 GROUP BY B.PO_BREAKDOWN_ID,A.TRANSACTION_TYPE ";
        // echo $sqlFinFabTr;die();
        $sqlFinFabTrRes = sql_select($sqlFinFabTr);
        $finFabTrnsArr = array();
        foreach ($sqlFinFabTrRes as  $val) 
        {
           $finFabTrnsArr[$val['PO_BREAKDOWN_ID']][$val['TRANSACTION_TYPE']]['qty'] = $val['QNTY'];
        }

        // ======================================= FINISH FAB ISSUE TO CUT ==============================
        $sqlIssue = "SELECT C.PO_BREAKDOWN_ID,MAX(A.ISSUE_DATE) AS ISSUE_DATE,SUM(C.QUANTITY) AS QNTY FROM INV_ISSUE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE=2 AND A.ISSUE_PURPOSE=9 $poIdsCondFin and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=18 AND A.ITEM_CATEGORY=2 GROUP BY C.PO_BREAKDOWN_ID ";
        // echo $sqlIssue;die();
        $issueRes = sql_select($sqlIssue);
        $issueProdArr = array();
        foreach ($issueRes as  $val) 
        {
           $issueProdArr[$val['PO_BREAKDOWN_ID']]['qty'] = $val['QNTY'];
           $issueProdArr[$val['PO_BREAKDOWN_ID']]['date'] = $val['ISSUE_DATE'];
        }

        // ======================================= FIN FAB STOCK ==============================
        $poIdsCondStock = str_replace("po_break_down_id", "D.PO_BREAKDOWN_ID", $poIdsCond);
        $sql_stock="SELECT D.PO_BREAKDOWN_ID, 
        SUM(CASE WHEN D.ENTRY_FORM IN (7,37,66,68) AND C.STORE_ID IN(14,16,46,47) THEN D.QUANTITY ELSE 0 END) AS DYE_RECEIVE_QNTY,
        SUM(CASE WHEN D.ENTRY_FORM IN (46) AND C.STORE_ID IN(14,16,46,47) THEN D.QUANTITY ELSE 0 END) AS DYE_RCV_RTN_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=5 AND C.STORE_ID IN(14,16,46,47) THEN D.QUANTITY ELSE 0 END) AS DYE_REC_TRNS_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN (18,71) AND C.STORE_ID IN(14,16,46,47) THEN D.QUANTITY ELSE 0 END) AS DYE_ISSUE_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN (126,52) AND C.STORE_ID IN(14,16,46,47) THEN D.QUANTITY ELSE 0 END) AS DYE_ISSUE_RET_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=6 AND C.STORE_ID IN(14,16,46,47) THEN D.QUANTITY ELSE 0 END) AS DYE_ISSUE_TRNS_QNTY,    
        SUM(CASE WHEN D.ENTRY_FORM IN (7,37,66,68) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_RECEIVE_QNTY,
        SUM(CASE WHEN D.ENTRY_FORM IN (46) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_RCV_RTN_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=5 AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_REC_TRNS_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN (18,71) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_ISSUE_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN (126,52) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_ISSUE_RET_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=6 AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_ISSUE_TRNS_QNTY 
        FROM  ORDER_WISE_PRO_DETAILS D,INV_TRANSACTION C,PRODUCT_DETAILS_MASTER E WHERE D.TRANS_ID=C.ID AND C.PROD_ID=E.ID AND D.TRANS_ID!=0 AND D.ENTRY_FORM IN (14,7,37,66,68,14,15,18,71,126,134,52) AND C.ITEM_CATEGORY=2 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND D.STATUS_ACTIVE=1 AND D.IS_DELETED=0 AND E.STATUS_ACTIVE=1 AND E.IS_DELETED=0 $poIdsCondStock AND E.COMPANY_ID=$company_id
        GROUP BY D.PO_BREAKDOWN_ID ";
        // echo $sql_stock;die();
        $stockRes = sql_select($sql_stock);
        $finFabStkArray = array();
        foreach ($stockRes as $val) 
        {
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_rcv'] = $val['DYE_RECEIVE_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_rcv_rtn'] = $val['DYE_RCV_RTN_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_rcv_trns'] = $val['DYE_REC_TRNS_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_issue'] = $val['DYE_ISSUE_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_issue_rtn'] = $val['DYE_ISSUE_RET_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_issue_trns'] = $val['DYE_ISSUE_TRNS_QNTY'];

            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_rcv'] = $val['GMT_RECEIVE_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_rcv_rtn'] = $val['GMT_RCV_RTN_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_rcv_trns'] = $val['GMT_REC_TRNS_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_issue'] = $val['GMT_ISSUE_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_issue_rtn'] = $val['GMT_ISSUE_RET_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_issue_trns'] = $val['GMT_ISSUE_TRNS_QNTY'];
        }
        // ======================================= FIN FAB RECEIVE BY FIN FAB STORE ==============================        
        $sql_stock2="SELECT D.PO_BREAKDOWN_ID, 
        SUM(CASE WHEN D.ENTRY_FORM IN (7,37,66,68) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_RECEIVE_QNTY,
        SUM(CASE WHEN D.ENTRY_FORM IN (7,37,66,68) AND C.STORE_ID IN(8,20,32) and b.TRANSFER_DATE < '$current_date' THEN D.QUANTITY ELSE 0 END) AS PREV_GMT_RECEIVE_QNTY,
        SUM(CASE WHEN D.ENTRY_FORM IN (46) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_RCV_RTN_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=5 AND a.from_store IN (16,46,14,47) and a.to_store in(8,20,32,52) THEN D.QUANTITY ELSE 0 END) AS GMT_REC_TRNS_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=5 AND a.from_store IN (16,46,14,47) and a.to_store in(8,20,32,52)  and b.TRANSFER_DATE < '$current_date' THEN D.QUANTITY ELSE 0 END) AS PREV_GMT_REC_TRNS_QNTY
        FROM  INV_ITEM_TRANSFER_MST b,ORDER_WISE_PRO_DETAILS D,INV_TRANSACTION C,PRODUCT_DETAILS_MASTER E,INV_ITEM_TRANSFER_DTLS a WHERE D.TRANS_ID=C.ID AND C.PROD_ID=E.ID and b.id=c.mst_id and b.is_acknowledge=1 AND D.TRANS_ID!=0  AND C.ITEM_CATEGORY=2 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND D.STATUS_ACTIVE=1 AND D.IS_DELETED=0 AND E.STATUS_ACTIVE=1 AND E.IS_DELETED=0 $poIdsCondStock AND E.COMPANY_ID=$company_id  and b.id=a.mst_id and a.id=D.DTLS_ID and a.status_active=1 GROUP BY D.PO_BREAKDOWN_ID ";//AND D.ENTRY_FORM IN (7,37,66,68)
        // echo $sql_stock2;die();
        $stockRes = sql_select($sql_stock2);
        $finFabStkArray2 = array();
        foreach ($stockRes as $val) 
        {
            $finFabStkArray2[$val['PO_BREAKDOWN_ID']]['gmt_rcv'] = $val['GMT_RECEIVE_QNTY'];
            $finFabStkArray2[$val['PO_BREAKDOWN_ID']]['prev_gmt_rcv'] = $val['PREV_GMT_RECEIVE_QNTY'];
            $finFabStkArray2[$val['PO_BREAKDOWN_ID']]['gmt_rcv_rtn'] = $val['GMT_RCV_RTN_QNTY'];
            $finFabStkArray2[$val['PO_BREAKDOWN_ID']]['gmt_rcv_trns'] = $val['GMT_REC_TRNS_QNTY'];
            $finFabStkArray2[$val['PO_BREAKDOWN_ID']]['prev_gmt_rcv_trns'] = $val['PREV_GMT_REC_TRNS_QNTY'];
        }

        // ======================================= FIN FAB RECEIVE(outbound) ==============================  
        $poIdsCondFin = str_replace("po_break_down_id", "c.po_breakdown_id", $poIdsCond);
        $sqlDye = "SELECT c.po_breakdown_id as po_id,b.receive_qnty as QTY from inv_receive_master a,pro_finish_fabric_rcv_dtls b,order_wise_pro_details c where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 $poIdsCondFin and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(37) and c.entry_form in(37) and a.item_category=2 and a.receive_basis=11 and a.company_id=$company_id";
         // echo $sqlDye;die();
        $dyeRes = sql_select($sqlDye);
        foreach ($dyeRes as $val) 
        {
           $finFabOutProdArr[$val['PO_ID']] += $val['QTY'];
        }

        // ======================================= CUT AND LAY ==============================  
        $poIdsCondFin = str_replace("po_break_down_id", "C.ORDER_ID", $poIdsCond);
        $sqlLay = "SELECT C.ORDER_ID,MAX(A.ENTRY_DATE) AS CUT_DATE,SUM(C.SIZE_QTY) AS QNTY FROM PPL_CUT_LAY_MST A,PPL_CUT_LAY_DTLS B,PPL_CUT_LAY_BUNDLE C WHERE A.ID=B.MST_ID AND A.ID=C.MST_ID AND B.ID=C.DTLS_ID $poIdsCondFin and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 GROUP BY C.ORDER_ID ";
        // echo $sqlLay;die();
        $layRes = sql_select($sqlLay);
        $cutAndLayArr = array();
        foreach ($layRes as  $val) 
        {
           $cutAndLayArr[$val['ORDER_ID']]['qty'] = $val['QNTY'];
           $cutAndLayArr[$val['ORDER_ID']]['date'] = $val['CUT_DATE'];
        }

        // ======================================= CUTTING QC ============================== 
        $poIdsCondQC = str_replace("po_break_down_id", "B.ORDER_ID", $poIdsCond);
        $sqlCutQC = "SELECT B.ORDER_ID,A.ENTRY_DATE AS QC_DATE,SUM(B.QC_PASS_QTY) AS QNTY,SUM(B.REPLACE_QTY) AS REPLACE_QTY,SUM(B.REJECT_QTY) AS REJQNTY FROM PRO_GMTS_CUTTING_QC_MST A,PRO_GMTS_CUTTING_QC_DTLS B WHERE A.ID=B.MST_ID $poIdsCondQC and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY B.ORDER_ID,A.ENTRY_DATE order by A.ENTRY_DATE ASC";
        // echo $sqlCutQC;die();
        $CutQCRes = sql_select($sqlCutQC);
        $CutQCArr = array();
        foreach ($CutQCRes as  $val) 
        {
           $CutQCArr[$val['ORDER_ID']]['qty']   += $val['QNTY'];
           $CutQCArr[$val['ORDER_ID']]['rejqty']+= $val['REJQNTY'];
           $CutQCArr[$val['ORDER_ID']]['rplsqty']+= $val['REPLACE_QTY'];
           $CutQCArr[$val['ORDER_ID']]['date']  = $val['QC_DATE'];
           if($CutQCArr[$val['ORDER_ID']]['qty'] !=0)
           {
                $CutQCArr[$val['ORDER_ID']]['lst_rpls_qty']   = $val['QNTY'];
           }
        }

        // ======================================= SEW/FINISH TRIMS RCV ==============================
        $poIdsCondTr = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
        $sqlacc = "SELECT D.TRIM_TYPE,C.PO_BREAKDOWN_ID,MAX(A.RECEIVE_DATE) AS RCV_DATE,SUM(C.QUANTITY) AS QNTY FROM INV_RECEIVE_MASTER A,INV_TRIMS_ENTRY_DTLS B,ORDER_WISE_PRO_DETAILS C,LIB_ITEM_GROUP D WHERE A.ID=B.MST_ID AND B.ID=C.DTLS_ID AND D.ID=B.ITEM_GROUP_ID AND C.TRANS_TYPE=1 $poIdsCondTr and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=24 AND c.entry_form = 24 AND D.TRIM_TYPE !=0 AND A.ITEM_CATEGORY=4 GROUP BY C.PO_BREAKDOWN_ID,D.TRIM_TYPE ";
        // echo $sqlacc;die();
        $accbRes = sql_select($sqlacc);
        $accArr = array();
        foreach ($accbRes as  $val) 
        {
           $accArr[$val['PO_BREAKDOWN_ID']][$val['TRIM_TYPE']]['qty'] = $val['QNTY'];
           $accArr[$val['PO_BREAKDOWN_ID']][$val['TRIM_TYPE']]['date'] = $val['RCV_DATE'];
        }
        // echo "<pre>";print_r($accArr);die();
        // ======================================= GMTS PRODUCTION DATA ==============================
        $poIdsCondGmts = str_replace("po_break_down_id", "A.PO_BREAK_DOWN_ID", $poIdsCond);
        $sqlProd = "SELECT  A.PO_BREAK_DOWN_ID AS PO_ID,A.PRODUCTION_DATE AS PROD_DATE, 
        SUM(CASE WHEN A.PRODUCTION_TYPE=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS CUT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=1 THEN B.REJECT_QTY ELSE 0 END) AS CUT_REJECT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PRINTING_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=2 AND A.EMBEL_NAME=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PRINT_ISS_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=2 THEN B.PRODUCTION_QNTY ELSE 0 END) AS EMB_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=2 AND A.EMBEL_NAME=2 THEN B.PRODUCTION_QNTY ELSE 0 END) AS EMB_ISSUE_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=3 THEN B.PRODUCTION_QNTY ELSE 0 END) AS WASH_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=2 AND A.EMBEL_NAME=3 THEN B.PRODUCTION_QNTY ELSE 0 END) AS WASH_ISSUE_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=4 THEN B.PRODUCTION_QNTY ELSE 0 END) AS INPUT_QTY, 
        SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.PRODUCTION_QNTY ELSE 0 END) AS OUT_QTY, 
        SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.ALTER_QTY ELSE 0 END) AS ALTER_QTY, 
        SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.SPOT_QTY ELSE 0 END) AS SPOT_QTY, 
        SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.REPLACE_QTY ELSE 0 END) AS REPLACE_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=1 THEN B.REJECT_QTY ELSE 0 END) AS PRINT_REJECT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=2 THEN B.REJECT_QTY ELSE 0 END) AS EMB_REJECT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=3 THEN B.REJECT_QTY ELSE 0 END) AS WASH_REJECT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.REJECT_QTY ELSE 0 END) AS REJECT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=8 THEN B.PRODUCTION_QNTY ELSE 0 END) AS FINISH_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=8 THEN B.REJECT_QTY ELSE 0 END) AS FIN_REJECT_QTY,
         
        SUM(CASE WHEN A.PRODUCTION_TYPE=1 and a.production_date < '$current_date' THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_CUT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=1 and a.production_date < '$current_date' THEN B.REJECT_QTY ELSE 0 END) AS PREV_CUT_REJECT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_PRINTING_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=2 and a.production_date < '$current_date' AND A.EMBEL_NAME=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_PRINT_ISS_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=2 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_EMB_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=2 and a.production_date < '$current_date' AND A.EMBEL_NAME=2 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_EMB_ISSUE_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=3 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_WASH_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=2 and a.production_date < '$current_date' AND A.EMBEL_NAME=3 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_WASH_ISSUE_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=4 and a.production_date < '$current_date' THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_INPUT_QTY, 
        SUM(CASE WHEN A.PRODUCTION_TYPE=5 and a.production_date < '$current_date' THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_OUT_QTY, 
        SUM(CASE WHEN A.PRODUCTION_TYPE=5 and a.production_date < '$current_date' THEN B.ALTER_QTY ELSE 0 END) AS PREV_ALTER_QTY, 
        SUM(CASE WHEN A.PRODUCTION_TYPE=5 and a.production_date < '$current_date' THEN B.SPOT_QTY ELSE 0 END) AS PREV_SPOT_QTY, 
        SUM(CASE WHEN A.PRODUCTION_TYPE=5 and a.production_date < '$current_date' THEN B.REPLACE_QTY ELSE 0 END) AS PREV_REPLACE_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=1 THEN B.REJECT_QTY ELSE 0 END) AS PREV_PRINT_REJECT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=2 THEN B.REJECT_QTY ELSE 0 END) AS PREV_EMB_REJECT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=3 THEN B.REJECT_QTY ELSE 0 END) AS PREV_WASH_REJECT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=5 and a.production_date < '$current_date' THEN B.REJECT_QTY ELSE 0 END) AS PREV_REJECT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=8 and a.production_date < '$current_date' THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_FINISH_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=8 and a.production_date < '$current_date' THEN B.REJECT_QTY ELSE 0 END) AS PREV_FIN_REJECT_QTY
        FROM PRO_GARMENTS_PRODUCTION_MST A, PRO_GARMENTS_PRODUCTION_DTLS B
        WHERE A.ID=B.MST_ID AND A.STATUS_ACTIVE=1 AND B.STATUS_ACTIVE=1 $poIdsCondGmts AND A.PRODUCTION_TYPE IN(1,2,3,4,5,8) GROUP BY A.PO_BREAK_DOWN_ID,A.PRODUCTION_DATE order by A.PRODUCTION_DATE ASC ";
        // echo $sqlProd;die();
        $prodRes = sql_select($sqlProd);
        $prodArr = array();
        foreach ($prodRes as  $val) 
        {
            $prodArr[$val['PO_ID']]['cut_qty']       += $val['CUT_QTY'];
            $prodArr[$val['PO_ID']]['cut_reject_qty']+= $val['CUT_REJECT_QTY'];
            $prodArr[$val['PO_ID']]['print_qty']     += $val['PRINTING_QTY'];
            $prodArr[$val['PO_ID']]['print_iss_qty'] += $val['PRINT_ISS_QTY'];
            $prodArr[$val['PO_ID']]['print_rej_qty'] += $val['PRINT_REJECT_QTY'];
            $prodArr[$val['PO_ID']]['emb_qty']       += $val['EMB_QTY'];
            $prodArr[$val['PO_ID']]['emb_issue_qty'] += $val['EMB_ISSUE_QTY'];
            $prodArr[$val['PO_ID']]['emb_rej_qty']   += $val['EMB_REJECT_QTY'];
            $prodArr[$val['PO_ID']]['wash_qty']      += $val['WASH_QTY'];
            $prodArr[$val['PO_ID']]['wash_issue_qty']+= $val['WASH_ISSUE_QTY'];
            $prodArr[$val['PO_ID']]['wash_rej_qty']  += $val['WASH_REJECT_QTY'];
            $prodArr[$val['PO_ID']]['input_qty']     += $val['INPUT_QTY'];
            $prodArr[$val['PO_ID']]['out_qty']       += $val['OUT_QTY'];

            $prodArr[$val['PO_ID']]['prev_cut_qty']       += $val['PREV_CUT_QTY'];
            $prodArr[$val['PO_ID']]['prev_cut_reject_qty']+= $val['PREV_CUT_REJECT_QTY'];
            $prodArr[$val['PO_ID']]['prev_print_qty']     += $val['PREV_PRINTING_QTY'];
            $prodArr[$val['PO_ID']]['prev_print_iss_qty'] += $val['PREV_PRINT_ISS_QTY'];
            $prodArr[$val['PO_ID']]['prev_print_rej_qty'] += $val['PREV_PRINT_REJECT_QTY'];
            $prodArr[$val['PO_ID']]['prev_emb_qty']       += $val['PREV_EMB_QTY'];
            $prodArr[$val['PO_ID']]['prev_emb_issue_qty'] += $val['PREV_EMB_ISSUE_QTY'];
            $prodArr[$val['PO_ID']]['prev_emb_rej_qty']   += $val['PREV_EMB_REJECT_QTY'];
            $prodArr[$val['PO_ID']]['prev_wash_qty']      += $val['PREV_WASH_QTY'];
            $prodArr[$val['PO_ID']]['prev_wash_issue_qty']+= $val['PREV_WASH_ISSUE_QTY'];
            $prodArr[$val['PO_ID']]['prev_wash_rej_qty']  += $val['PREV_WASH_REJECT_QTY'];
            $prodArr[$val['PO_ID']]['prev_input_qty']     += $val['PREV_INPUT_QTY'];
            $prodArr[$val['PO_ID']]['prev_out_qty']       += $val['PREV_OUT_QTY'];

            if($val['OUT_QTY']>0)
            {
                $prodArr[$val['PO_ID']]['lst_out_qty']    = $val['OUT_QTY'];
            }
            $prodArr[$val['PO_ID']]['reject_qty']    += $val['REJECT_QTY'];
            $prodArr[$val['PO_ID']]['alter_qty']     += $val['ALTER_QTY'];
            $prodArr[$val['PO_ID']]['spot_qty']      += $val['SPOT_QTY'];
            $prodArr[$val['PO_ID']]['replace_qty']   += $val['REPLACE_QTY'];
            $prodArr[$val['PO_ID']]['finish_qty']    += $val['FINISH_QTY'];
            $prodArr[$val['PO_ID']]['fin_rej_qty']   += $val['FIN_REJECT_QTY'];

            $prodArr[$val['PO_ID']]['prev_reject_qty']    += $val['PREV_REJECT_QTY'];
            $prodArr[$val['PO_ID']]['prev_alter_qty']     += $val['PREV_ALTER_QTY'];
            $prodArr[$val['PO_ID']]['prev_spot_qty']      += $val['PREV_SPOT_QTY'];
            $prodArr[$val['PO_ID']]['prev_replace_qty']   += $val['PREV_REPLACE_QTY'];
            $prodArr[$val['PO_ID']]['prev_finish_qty']    += $val['PREV_FINISH_QTY'];
            $prodArr[$val['PO_ID']]['prev_fin_rej_qty']   += $val['PREV_FIN_REJECT_QTY'];

            $prodArr[$val['PO_ID']]['date']          = $val['PROD_DATE'];
            if($val['FINISH_QTY'] != 0)
            {
                $prodArr[$val['PO_ID']]['lst_finish_qty']= $val['FINISH_QTY'];
            }
            if($val['WASH_QTY'] != 0)
            {
                $prodArr[$val['PO_ID']]['lst_wash_qty']= $val['WASH_QTY'];
            }
            if($val['EMB_QTY'] != 0)
            {
                $prodArr[$val['PO_ID']]['lst_emb_qty']= $val['EMB_QTY'];
            }
            if($val['PRINTING_QTY'] != 0)
            {
                $prodArr[$val['PO_ID']]['lst_prnt_qty']= $val['PRINTING_QTY'];
            }
        }
        // echo "<pre>";print_r($prodArr);die();

        // ======================================= EXFACTORY DATA ==============================
        $poIdsCondExf = str_replace("po_break_down_id", "C.PO_BREAK_DOWN_ID", $poIdsCond);
        $sqlEx = "SELECT  C.PO_BREAK_DOWN_ID AS PO_ID,C.EX_FACTORY_DATE AS EX_DATE, SUM(D.PRODUCTION_QNTY) AS EX_FACT_QTY FROM PRO_EX_FACTORY_MST C, PRO_EX_FACTORY_DTLS D, PRO_EX_FACTORY_DELIVERY_MST E WHERE C.ID=D.MST_ID AND E.ID=C.DELIVERY_MST_ID  AND C.STATUS_ACTIVE=1 AND D.STATUS_ACTIVE=1 AND E.STATUS_ACTIVE=1 $poIdsCondExf GROUP BY C.PO_BREAK_DOWN_ID,C.EX_FACTORY_DATE ORDER BY C.EX_FACTORY_DATE ASC"; 
        // echo $sqlEx;die();
        $sqlXRes = sql_select($sqlEx);
        $exfArr = array();
        foreach ($sqlXRes as  $val) 
        {
           $exfArr[$val['PO_ID']]['qty']    += $val['EX_FACT_QTY'];
           $exfArr[$val['PO_ID']]['lqty']   = $val['EX_FACT_QTY'];
           $exfArr[$val['PO_ID']]['exdate'] .= isset($exfArr[$val['PO_ID']]['exdate']) ? ",".strtotime($val['EX_DATE']) : strtotime($val['EX_DATE']);
        }
        // echo "<pre>";print_r($exfArr);die();

        //================================ getting tna plan data ==========================
        $po_id_cond = str_replace("po_break_down_id", "A.PO_ID", $poIdsCond);
        $sqltna = "SELECT A.PO_ID,a.TASK_ID,a.SOURCE_ID,a.PLAN_QTY as ALL_PLAN_QTY,(case when a.plan_date < '$current_date' then a.PLAN_QTY else 0 end) as prev_plan_qty from tna_plan_target a,wo_po_break_down b where a.PO_ID=b.id and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0  and a.PLAN_QTY>0 and a.task_type=1  and a.PLAN_DATE is not null   $po_id_cond";
        // echo $sqltna;die();
        $tnaRes = sql_select($sqltna);
        $tnaPlanTargetArray = array();
        foreach ($tnaRes as $val) 
        {
            if($val['TASK_ID']==73)
            {
                $tnaPlanTargetArray[$val['PO_ID']][$val['TASK_ID']][$val['SOURCE_ID']]['all_plan_qty'] += $val['ALL_PLAN_QTY'];
                $tnaPlanTargetArray[$val['PO_ID']][$val['TASK_ID']][$val['SOURCE_ID']]['prev_plan_qty'] += $val['PREV_PLAN_QTY'];
            }
            else
            {
                $tnaPlanTargetArray[$val['PO_ID']][$val['TASK_ID']]['all_plan_qty'] += $val['ALL_PLAN_QTY'];
                $tnaPlanTargetArray[$val['PO_ID']][$val['TASK_ID']]['prev_plan_qty'] += $val['PREV_PLAN_QTY'];
            }
        }
        unset($tnaRes);
        // echo "<pre>";print_r($tnaPlanTargetArray);die();

        function checkOperator($value1, $operator, $value2) 
        {
            switch ($operator) {
                case '<': // Less than
                    return $value1 < $value2;
                case '<=': // Less than or equal to
                    return $value1 <= $value2;
                case '>': // Greater than
                    return $value1 > $value2;
                case '>=': // Greater than or equal to
                    return $value1 >= $value2;
                case '==': // Equal
                    return $value1 == $value2;
                case '===': // Identical
                    return $value1 === $value2;
                case '!==': // Not Identical
                    return $value1 !== $value2;
                case '!=': // Not equal
                case '<>': // Not equal
                    return $value1 != $value2;
                case '||': // Or
                case 'or': // Or
                   return $value1 || $value2;
                case '&&': // And
                case 'and': // And
                   return $value1 && $value2;
                case 'xor': // Or
                   return $value1 xor $value2;  
                default:
                    return FALSE;
            } // end switch
        }
        ?>
        <!-- <div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">This report is under development. Please be patience.</div>        -->
              
        <style type="text/css">        
            .GridViewScrollHeader TH, .GridViewScrollHeader TD 
            {
                padding: 2px 4px;
                font-weight: normal;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                text-align: left;
                vertical-align: middle;
            }

            .GridViewScrollHeader TH{
                background-image: -webkit-linear-gradient( rgb(194,220,255) 10%, rgb(136,170,214) 96%);
                border: 1px solid #8DAFDA;
                color:#444;
                font-size: 13px;
                font-weight: bold;
                text-align: center;
                line-height: 12px;
                height: 25px;
            }

            .GridViewScrollItem TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
               /* background-color: #FFFFFF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollItemFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #E9F3FF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollFooterFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-top: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                vertical-align: middle;
                font-weight: 700;
                background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB));
            }
            tr.GridViewScrollItemFreeze:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            tr.footerTr:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            html {
              --scrollbarBG: #CFD8DC;
              --thumbBG: #8ec5fc;
            }
            body::-webkit-scrollbar {
              width: 11px;
            }
            body {
              scrollbar-width: thin;
              scrollbar-color: var(--thumbBG) var(--scrollbarBG);
            }
            body::-webkit-scrollbar-track {
              background: var(--scrollbarBG);
            }
            body::-webkit-scrollbar-thumb {
              background-color: var(--thumbBG) ;
              border-radius: 6px;
              border: 3px solid var(--scrollbarBG);
            }
        </style>
        <? ob_start(); ?>
        <main class="main">
            <div class="tableContainer" style="width: 1345px;text-align: left;">
                <div style="margin:0 0%; padding-bottom: 5px;">
                    <span style="background:#FF0000; padding:0 6px; border-radius:9px; cursor:pointer;" title="Red">&nbsp;</span>&nbsp; Target Date Over. &nbsp;&nbsp;
                    <span style="background:#2A9FFF; padding:0 6px; border-radius:9px; cursor:pointer;" title="Blue">&nbsp;</span>&nbsp; Done In Late. &nbsp;&nbsp;
                    <span style="background:#fea200; padding:0 6px; border-radius:9px; cursor:pointer;" title="Yellow">&nbsp;</span>&nbsp; Reminder.                
                </div>

                <table cellspacing="0" id="gvMain" style="width: 100%; border-collapse: collapse;" class="rpt_table" cellpadding="0" border="1">
                    <thead>
                        <tr class="GridViewScrollHeader">
                            <th style="background: #03a45e;" colspan="11">PO <span style="color: red;"> <?=($client) ? ": ".$client_array[$client] : " : All"; ?></span></th>
                            <th style="background: #add68a;" colspan="5">Merchant Information</th>
                            <th style="background: #569834;" colspan="8">Labdip Submission</th>
                            <th style="background: #00acac;" colspan="7">Labdip Approval</th>
                            <th style="background: #f5a872;" colspan="4">SMS/ GSS Submission</th>
                            <th style="background: #fcc777;" colspan="4">SMS/ GSS Approval</th>
                            <th style="background: #5c88c5;" colspan="4">AOP Strike Off Submission</th>
                            <th style="background: #b8add5;" colspan="4">AOP Strike Off Approva</th>
                            <th style="background: #bd7cb4;" colspan="4">Styling Submission</th>
                            <th style="background: #56c4c5;" colspan="4">Styling Approval</th>
                            <th style="background: #f5796d;" colspan="4">Size Set Submission</th>
                            <th style="background: #f58d74;" colspan="4">Size Set Approval</th>
                            <th style="background: #cbbe00;" colspan="4">Ware Trial Sample Submission</th>
                            <th style="background: #00acac;" colspan="4">Ware Trial Sample Approval</th>
                            <th style="background: #64c195;" colspan="4">Bulk Fabric Submission To Buyer</th>
                            <th style="background: #f58d74;" colspan="4">Bulk Fabric Approval From Buyer</th>
                            <th style="background: #f5796d;" colspan="4">Bulk Fabric Submission To Lab</th>
                            <th style="background: #f58d74;" colspan="4">Bulk Fabric Approval From Lab</th>
                            <th style="background: #f5796d;" colspan="4">Knit down Submission</th>
                            <th style="background: #f58d74;" colspan="4">Knit down Approval</th>
                            <th style="background: #f5796d;" colspan="4">Print Strike Off Submission</th>
                            <th style="background: #f58d74;" colspan="4">Print Strike Off Approval</th>
                            <th style="background: #f5796d;" colspan="4">Embroidery Strike off Submission</th>
                            <th style="background: #f58d74;" colspan="4">Embroidery Strike off Approval</th>
                            <th style="background: #f5a872;" colspan="4">PP Submission</th>
                            <th style="background: #fcc777;" colspan="4">PP Approval</th>
                            <th style="background: #f5a872;" colspan="4">Trim Card Submission</th>
                            <th style="background: #fcc777;" colspan="4">Trim Card Approval</th>
                            <th style="background: #f5a872;" colspan="4">Top Sample Submission To Buyer</th>
                            <th style="background: #fcc777;" colspan="4">Top Sample Approval From Buyer</th>
                            <th style="background: #f5a872;" colspan="4">Top Sample  Submission to Lab</th>
                            <th style="background: #fcc777;" colspan="4">Top Sample  Approval to Buyer</th>
                            <th style="background: #f5a872;" colspan="4">Mock up Sample Submission</th>
                            <th style="background: #fcc777;" colspan="4">Mock up Sample Approval</th>
                            <th style="background: #018989;" colspan="6">Accessories Booking</th>
                            <th style="background: #fef102;" colspan="6">Fabric Booking</th>
                            <th style="background: #f8a51b;" colspan="10">Yarn</th>
                            <th style="background: #f58225;" colspan="12">Dyed Yarn</th>
                            <th style="background: #ed403c;" colspan="17">Grey Fabric</th>
                            <th style="background: #cbbe00;" colspan="13">Dyeing Production</th>
                            <th style="background: #00acac;" colspan="12">AOP Fabric</th>
                            <th style="background: #56c4c5;" colspan="18">Finish Fabric</th>
                            <th style="background: #64c195;" colspan="12">Cut and Lay</th>
                            <th style="background: #add68a;" colspan="13">Printing</th>
                            <th style="background: #fbf583;" colspan="13">Embroidery</th>
                            <th style="background: #a19600;" colspan="7">Sewing Trims Rcvd</th>
                            <th style="background: #018989;" colspan="7">Finishing Trims Rcvd</th>
                            <th style="background: #f5a872;" colspan="15">Sewing Production</th>
                            <th style="background: #f58d74;" colspan="13">Garments Wash</th>
                            <th style="background: #f5796d;" colspan="11">Garments Finishing</th>
                            <th style="background: #bd7cb4;" colspan="7">Shipment</th>
                        </tr>
                        <tr class="GridViewScrollHeader">
                            <th>Sl</th>
                            <th>Ref-No</th>
                            <th>Style</th>
                            <th>Ship Date</th>
                            <th>PO No</th>
                            <th>SBU/Client</th>
                            <th>Fab.Structure</th>
                            <th>GSM</th>
                            <th>Fab.Composition</th>
                            <th>Item Name</th>
                            <th>Order Qnty</th>

                            <th>Buyer</th>
                            <th>Merchandiser</th>
                            <th>Exe Unit</th>
                            <th>Lead Time</th>
                            <th>SMV</th>

                            <th>Labdip Req.</th>
                            <th>Labdip Sub.</th>
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Labdip Backlog</th>
                            <th>Labdip Bal</th>

                            <th>Labdip App.</th>
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Labdip Backlog</th>
                            <th>Labdip Bal</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>

                            <th>Acc Booking</th>
                            <th>Plan Start</th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Backlog</th>

                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Booking Backlog</th>
                            <th>Booking Bal</th>

                            <th>Primary Yarn Req</th>
                            <th>Excess Yarn</th>
                            <th>Yarn Allo</th>
                            <th>Plan Start</th>
                            <th>Plan End</th>
                            <th>Plan Bal</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Yarn Backlog</th>
                            <th>Allo Bal</th>
                           <!--  <th>Yarn Issue</th>
                            <th>Ready Yarn<br> Stock</th> -->

                            <th>YD Req Qnty</th>
                            <th>YD Rcv Qty</th>
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Plan Bal</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Last Day Rcv</th>
                            <th>YD Backlog</th>
                            <th>YD Bal</th>
                            <th>Yarn Snd to <br>Y/d factory</th>
                            <th>Sending Bal</th>

                            <th>Primary Grey<br> Req</th>
                            <th>Excess Grey</th>
                            <th>Grey Prod</th>
                            <th>Trans In</th>
                            <th>Trans Out</th>
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Plan Bal</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Last Day Prod.</th>
                            <th>Grey Backlog</th>
                            <th>Grey Bal</th>
                            <th>Prog Qty</th>
                            <th>Prog Bal</th>
                            <th>Yarn Send<br> to Factory</th>
                            <th>Yarn Sending<br> Bal</th>

                            <th>Dye Req Qnty</th>
                            <th>Dye Prod</th>
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Plan Bal</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Last Day Prod</th>
                            <th>Dye Backlog</th>
                            <th>Dye Bal</th>
                            <th>Batch Qty</th>
                            <th>Batch Bal</th>
                            <th>Ready To Batch</th>

                            <th>AOP Req</th>
                            <th>AOP Qty</th>
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Plan Bal</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Last Day Rcvd</th>
                            <th>AOP Backlog</th>
                            <th>AOP Bal</th>
                            <th>Finish Fabric Send<br> to Aop factory</th>
                            <th>Fabric Sending Bal</th>

                            <th>Fin Fab Req</th>
                            <th>Excess F.Fab</th>
                            <th>Transfer In</th>
                            <th>Transfer Out</th>
                            <th>Reject</th>
                            <th>F.F. Rcv</th>
                            <th>Plan Start</th>
                            <th>Plan End</th>
                            <th>Plan Bal</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Last Day Rcvd</th>
                            <th>Mgf Fab Backlog</th>
                            <th>Pur Fab Backlog</th>
                            <th>FF Bal</th>
                            <th>Issue to Cut</th>
                            <th>Stock at Dyeing<br> Store</th>
                            <th>Stock at Gmts<br> Store</th>

                           
                            <th>Lay Qty </th>
                            <th>Rej Qty</th>
                            <th>Replace</th>
                            <th>QC Qty</th>
                            <th>Plan Start</th>
                            <th>Plan End</th>
                            <th>Plan Bal</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Last Day<br> Cutting QC</th>
                            <th>Cut Backlog</th>
                            <th>Cut Bal</th>

                            <th>Printing Req</th>
                            <th>Rej print</th>
                            <th>OK Print Qty</th>
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Plan Bal</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Last Day<br> Print Rcvd</th>
                            <th>Print Backlog</th>
                            <th>Print Bal</th>
                            <th>Cut panel<br> Delivery qty</th>
                            <th>Print Sending<br> Bal</th>

                            <th>Emb Req</th>
                            <th>Emb Rej Qty</th>
                            <th>OK Emb Qty</th>
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Plan Bal</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Last Day<br> Embroi Rcvd</th>
                            <th>Emb Backlog</th>
                            <th>Emb Bal</th>
                            <th>Cut panel<br> Delivery qty</th>
                            <th>Emb Sending Bal</th>

                            <th>Sew Trims Rcv</th>
                            <th>Plan Start</th>
                            <th>Plan End</th>
                            <th>Plan Bal</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Backlog</th>

                            <th>Fin Trims Rcv</th>
                            <th>Plan Start</th>
                            <th>Plan End</th>
                            <th>Plan Bal</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Backlog</th>

                            <th>Input Qty</th>
                            <th>Input WIP</th>
                            <th>Reject Qty</th>
                            <th>Replace Qty</th>
                            <th>Ok Sewing</th>
                            <th>Total Sewing</th>
                            <th>Plan Start </th>
                            <th>Plan End</th>
                            <th>Plan Bal</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Last Day Sewing</th>
                            <th>Sewing Backlog</th>
                            <th>Sewing WIP</th>
                            <th>Sewing Bal</th>

                            <th>Wash Req</th>
                            <th>Wash Rej</th>
                            <th>OK Wash</th>
                            <th>Plan Start</th>
                            <th>Plan End</th>
                            <th>Plan Bal</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Last Day Wash</th>
                            <th>Wash Backlog</th>
                            <th>Wash Bal</th>
                            <th>Del. to Wash</th>
                            <th>Sending Bal</th>

                            <th>Finish Qty</th>
                            <th>Finish Rej</th>
                            <th>Plan Start</th>
                            <th>Plan End</th>
                            <th>Plan Bal</th>
                            <th>Act Start</th>
                            <th>Act End</th>
                            <th>Fin WIP</th>
                            <th>Backlog</th>
                            <th>Fin Bal </th>
                            <th>Last Day Fin</th>

                            <th>Shipment Qty</th>
                            <th>Shipment WIP</th>
                            <th>1st Ship Date</th>
                            <th>Last Ship Date</th>
                            <th>Last Ship Qty</th>
                            <th>Ship Backlog</th>
                            <th>Ship Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?
                        $toDay = new DateTime('now');
                        $i=1;
                        $total_po_qty       = 0;
                        $total_book_qty     = 0;
                        $total_book_bklg    = 0;
                        $total_book_bal     = 0;
                        $total_yarn_req     = 0;
                        $total_yarn_exs     = 0;
                        $total_yarn_allo    = 0;
                        $total_yarn_allo_plan_bal  = 0;
                        $total_yarn_bklog   = 0;
                        $total_yarn_allo_bal= 0;

                        $total_yarn_dyed_req = 0;
                        $total_yarn_dyed_rcv = 0;
                        $total_yarn_dyed_bklog = 0;
                        $total_yarn_dyed_bal = 0;
                        $total_yarn_dyed_plan_bal = 0;
                        $total_lst_day_yarn = 0;
                        $total_yarn_snd_to_fact = 0;
                        $total_yarn_snd_bal = 0;

                        $total_grey_req     = 0;
                        $total_grey_exs     = 0;
                        $total_grey_rcv     = 0;
                        $total_grey_bklog   = 0;
                        $total_grey_bal     = 0;
                        $total_grey_plan_bal     = 0;
                        $total_grey_lst_day_prod = 0;
                        $total_grey_prog_qty = 0;
                        $total_grey_prog_bal = 0;
                        $total_yrn_snd_to_fact= 0;
                        $total_yarn_snd_bal= 0;

                        $total_dye_req      = 0;
                        $total_dye_rcv      = 0;
                        $total_dye_bklog    = 0;
                        $total_dye_bal      = 0;
                        $total_dye_plan_bal      = 0;
                        $total_lst_day_prod_dye = 0;
                        $total_dye_batch    = 0;
                        $total_dye_batch_bal      = 0;
                        $total_dye_redy_to_batch      = 0;

                        $total_aop_req      = 0;
                        $total_aop_rcv      = 0;
                        $total_aop_bklog    = 0;
                        $total_aop_bal      = 0;
                        $total_aop_plan_bal      = 0;
                        $total_lst_day_aop  = 0;
                        $total_aop_sen_to_fact= 0;
                        $total_aop_send_bal = 0;

                        $total_fin_fab_req  = 0;
                        $total_fin_fab_exs  = 0;
                        $total_fin_fab_rcv  = 0;
                        $total_fin_fab_bklog= 0;
                        $total_fin_fab_bal  = 0;
                        $total_fin_fab_plan_bal  = 0;
                        $total_stk_gmt_store  = 0;
                        $total_stk_fin_store  = 0;
                        $total_lst_day_rcv_fin_fab  = 0;
                        $total_trns_in_fin_fab  = 0;
                        $total_trns_out_fin_fab  = 0;
                        $total_rej_fin_fab  = 0;

                        $total_issue_to_cut = 0;
                        $total_lay_qty      = 0;
                        $total_lay_qc_qty   = 0;
                        $total_lay_rej_qty  = 0;
                        $total_cut_bklog    = 0;
                        $total_cut_bal      = 0;
                        $total_lst_day_cut_qc= 0;

                        $total_print_req    = 0;
                        $total_print_rcv    = 0;
                        $total_print_rej    = 0;
                        $total_print_bklog  = 0;
                        $total_print_bal    = 0;
                        $total_print_plan_bal    = 0;
                        $total_print_snd_bal  = 0;
                        $total_cut_panel_del_print= 0;
                        $total_lst_day_print= 0;

                        $total_emb_req      = 0;
                        $total_emb_rcv      = 0;
                        $total_emb_rej      = 0;
                        $total_emb_bklog    = 0;
                        $total_emb_bal      = 0;
                        $total_emb_plan_bal = 0;
                        $total_emb_snd_bal  = 0;
                        $total_cut_panel_del= 0;
                        $total_lst_day_emb= 0;

                        $total_sew_trim_rcv = 0;
                        $total_sew_trim_bklg = 0;
                        $total_fin_trim_rcv = 0;
                        $total_fin_trim_bklg = 0;

                        $total_input_qty    = 0;
                        $total_plan_input_qty= 0;
                        $total_rej_qty      = 0;
                        $total_ok_out_qty   = 0;
                        $total_out_qty      = 0;
                        $total_out_wip      = 0;
                        $total_out_bal      = 0;
                        $total_out_plan_bal = 0;
                        $total_lst_day_sew  = 0;
                        $total_sew_rpls     = 0;

                        $total_wash_req     = 0;
                        $total_wash_req     = 0;
                        $total_wash_rcv     = 0;
                        $total_wash_rej     = 0;
                        $total_wash_bklog   = 0;
                        $total_wash_bal     = 0;
                        $total_wash_plan_bal= 0;
                        $total_send_wash     = 0;
                        $total_send_bal     = 0;
                        $total_lst_day_wash = 0;

                        $total_finish_qty   = 0;
                        $total_fin_rej_qty  = 0;
                        $total_finish_wip   = 0;
                        $total_finish_bal   = 0;
                        $total_finish_plan_bal   = 0;
                        $total_lst_fin_qty  = 0;
                        $total_fin_bklog_qty= 0;

                        $total_shipment_qty = 0;
                        $total_shipment_wip = 0;
                        $total_lst_ship_qty = 0;
                        $total_shipment_bklog= 0;
                        $total_shipment_bal = 0;

                        $toDay = new DateTime('now');
                        foreach ($dataArray as $po_id => $val)
                        {
                            $costingPer     =  $costPerArr[$val['job_no']];
                            $labDipColorSub = $labDipArray[$po_id]['submit_color'];
                            $labDipColorApp = $labDipArray[$po_id]['approve_color'];
                            $totPoColor     = count($poWiseColorArray[$po_id]);
                            $labDipPrsnt    = ($labDipColorSub/$totPoColor)*100;
                            $strickoff      = $smArray[$po_id][60];
                            $strickoffPrsnt = ($strickoff/$totPoColor)*100;
                            $pp             = $smArray[$po_id][7];
                            $ppPrsnt        = ($pp/$totPoColor)*100;
                            $sizeSet        = $smArray[$po_id][60];
                            $sizeSetPrsnt   = ($sizeSet/$totPoColor)*100;
                            $bookingQty     = $bookingQtyArray[$po_id]['qty'];
                            $bookingDate    = $bookingQtyArray[$po_id]['date'];
                            //============= calculate yarn dyed rcv ============
                            $yarn_dyed_rcv_qty  = $yarn_dyed_rcv_qty_array[$val['job_no']];
                            $yarn_dyed_prev_rcv_qty  = $yarn_dyed_prev_rcv_qty_array[$val['job_no']];
                            $po_wise_cons       = $po_wise_cons_array[$val['job_no']][$po_id];
                            $job_wise_cons      = $job_wise_cons_array[$val['job_no']];
                            $job_wise_dyed      = $yarn_dyed_rcv_qty / $job_wise_cons;
                            $job_wise_prev_dyed      = $yarn_dyed_prev_rcv_qty / $job_wise_cons;
                            $yarn_dyed_qty      = $job_wise_dyed * $po_wise_cons;
                            $yarn_dyed_prev_qty      = $job_wise_prev_dyed * $po_wise_cons;

                            $yarn_excess_qty    = $bookingQtyArray[$po_id]['yarn_excess_qty'];
                            $grey_fab_excess_qty= $bookingQtyArray[$po_id]['grey_fab_excess_qty'];
                            $fin_fab_excess_qty = $bookingQtyArray[$po_id]['fin_fab_excess_qty'];

                            $stylingSbStDate    = $tnaDateArray[$po_id][7]['start_date'];// Styling submit
                            $stylingSbEndDate   = $tnaDateArray[$po_id][7]['end_date'];// Styling submit                        
                            $stylingSbAcStDate  = $tnaDateArray[$po_id][7]['actual_start_date'];// Styling submit
                            $stylingSbAcEndDate = $tnaDateArray[$po_id][7]['actual_finish_date'];// Styling submit

                            $stylingApStDate    = $tnaDateArray[$po_id][13]['start_date'];// Styling Approval
                            $stylingApEndDate   = $tnaDateArray[$po_id][13]['end_date'];// Styling Approval                        
                            $stylingApAcStDate  = $tnaDateArray[$po_id][13]['actual_start_date'];// Styling Approval
                            $stylingApAcEndDate = $tnaDateArray[$po_id][13]['actual_finish_date'];// Styling Approval

                            $lbdpSbStDate    = $tnaDateArray[$po_id][9]['start_date'];// labdip submit
                            $lbdpSbEndDate   = $tnaDateArray[$po_id][9]['end_date'];// labdip submit                        
                            $lbdpSbAcStDate  = $tnaDateArray[$po_id][9]['actual_start_date'];// labdip submit
                            $lbdpSbAcEndDate = $tnaDateArray[$po_id][9]['actual_finish_date'];// labdip submit

                            $lbdpApStDate    = $tnaDateArray[$po_id][10]['start_date'];// labdip Approval
                            $lbdpApEndDate   = $tnaDateArray[$po_id][10]['end_date'];// labdip Approval                        
                            $lbdpApAcStDate  = $tnaDateArray[$po_id][10]['actual_start_date'];// labdip Approval
                            $lbdpApAcEndDate = $tnaDateArray[$po_id][10]['actual_finish_date'];// labdip Approval

                            $ppSbStDate    = $tnaDateArray[$po_id][8]['start_date'];// PP Sample submit
                            $ppSbEndDate   = $tnaDateArray[$po_id][8]['end_date'];// PP Sample submit                        
                            $ppSbAcStDate  = $tnaDateArray[$po_id][8]['actual_start_date'];// PP Sample submit
                            $ppSbAcEndDate = $tnaDateArray[$po_id][8]['actual_finish_date'];// PP Sample submit

                            $ppApStDate    = $tnaDateArray[$po_id][12]['start_date'];// PP Sample Approval
                            $ppApEndDate   = $tnaDateArray[$po_id][12]['end_date'];// PP Sample Approval                        
                            $ppApAcStDate  = $tnaDateArray[$po_id][12]['actual_start_date'];// PP Sample Approval
                            $ppApAcEndDate = $tnaDateArray[$po_id][12]['actual_finish_date'];// PP Sample Approval

                            $sizeSetSbStDate    = $tnaDateArray[$po_id][14]['start_date'];// Size Set submit
                            $sizeSetSbEndDate   = $tnaDateArray[$po_id][14]['end_date'];// Size Set submit                        
                            $sizeSetSbAcStDate  = $tnaDateArray[$po_id][14]['actual_start_date'];// Size Set submit
                            $sizeSetSbAcEndDate = $tnaDateArray[$po_id][14]['actual_finish_date'];// Size Set submit

                            $sizeSetApStDate    = $tnaDateArray[$po_id][15]['start_date'];// Size Set Approval
                            $sizeSetApEndDate   = $tnaDateArray[$po_id][15]['end_date'];// Size Set Approval                        
                            $sizeSetApAcStDate  = $tnaDateArray[$po_id][15]['actual_start_date'];// Size Set Approval
                            $sizeSetApAcEndDate = $tnaDateArray[$po_id][15]['actual_finish_date'];// Size Set Approval

                            $bookStDate       = $tnaDateArray[$po_id][31]['start_date'];// booking
                            $bookEndDate      = $tnaDateArray[$po_id][31]['end_date'];// booking
                            $bookAcStDate     = $tnaDateArray[$po_id][31]['actual_start_date'];// booking
                            $bookAcEndDate    = $tnaDateArray[$po_id][31]['actual_finish_date'];// booking

                            $accBkStDate    = $tnaDateArray[$po_id][32]['start_date'];// acc booking
                            $accBkEndDate   = $tnaDateArray[$po_id][32]['end_date'];// acc booking
                            $accAcBkStDate  = $tnaDateArray[$po_id][32]['actual_start_date'];// acc booking
                            $accAcBkEndDate = $tnaDateArray[$po_id][32]['actual_finish_date'];// acc booking

                            $yarntnaStDate  = $tnaDateArray[$po_id][48]['start_date'];// yan allocation
                            $yarntnaEndDate = $tnaDateArray[$po_id][48]['end_date'];// yan allocation
                            $yarntnaAcStDate= $tnaDateArray[$po_id][48]['actual_start_date'];// yan allocation
                            $yarntnaAcEndDate= $tnaDateArray[$po_id][48]['actual_finish_date'];// yan allocation

                            $ydtnaStDate    = $tnaDateArray[$po_id][52]['start_date'];// yarn dyed
                            $ydtnaEndDate   = $tnaDateArray[$po_id][52]['end_date'];// yarn dyed
                            $ydtnaAcStDate  = $tnaDateArray[$po_id][52]['actual_start_date'];// yarn dyed
                            $ydtnaAcEndDate = $tnaDateArray[$po_id][52]['actual_finish_date'];// yarn dyed

                            $greyStDate     = $tnaDateArray[$po_id][60]['start_date'];// grey fab
                            $greyEndDate    = $tnaDateArray[$po_id][60]['end_date'];// grey fab
                            $greyAcStDate   = $tnaDateArray[$po_id][60]['actual_start_date'];// grey fab
                            $greyAcEndDate  = $tnaDateArray[$po_id][60]['actual_finish_date'];// grey fab

                            $aopStDate      = $tnaDateArray[$po_id][63]['start_date'];// grey fab
                            $aopEndDate     = $tnaDateArray[$po_id][63]['end_date'];// grey fab
                            $aopAcStDate    = $tnaDateArray[$po_id][63]['actual_start_date'];// grey fab
                            $aopAcEndDate   = $tnaDateArray[$po_id][63]['actual_finish_date'];// grey fab

                            $dyeingStDate   = $tnaDateArray[$po_id][61]['start_date'];// fab dyeing
                            $dyeingEndDate  = $tnaDateArray[$po_id][61]['end_date'];// fab dyeing
                            $dyeingAcStDate = $tnaDateArray[$po_id][61]['actual_start_date'];// fab dyeing
                            $dyeingAcEndDate= $tnaDateArray[$po_id][61]['actual_finish_date'];// fab dyeing

                            $sewTrimsStDate = $tnaDateArray[$po_id][70]['start_date'];// trims-sew
                            $sewTrimsEndDate= $tnaDateArray[$po_id][70]['end_date'];// trims-sew
                            $sewTrimsAcStDate = $tnaDateArray[$po_id][70]['actual_start_date'];// trims-sew
                            $sewTrimsAcEndDate= $tnaDateArray[$po_id][70]['actual_finish_date'];// trims-sew

                            $finTrimsStDate = $tnaDateArray[$po_id][71]['start_date'];// trims-fin
                            $finTrimsEndDate= $tnaDateArray[$po_id][71]['end_date'];// trims-fin
                            $finTrimsAcStDate = $tnaDateArray[$po_id][71]['actual_start_date'];// trims-fin
                            $finTrimsAcEndDate= $tnaDateArray[$po_id][71]['actual_finish_date'];// trims-fin

                            $fabFinStDate   = $tnaDateArray[$po_id][73]['start_date'];// fab finish
                            $fabFinEndDate  = $tnaDateArray[$po_id][73]['end_date'];// fab finish
                            $fabFinAcStDate = $tnaDateArray[$po_id][73]['actual_start_date'];// fab finish
                            $fabFinAcEndDate= $tnaDateArray[$po_id][73]['actual_finish_date'];// fab finish

                            $finishStDate   = $tnaDateArray[$po_id][88]['start_date'];// gmt finish
                            $finishEndDate  = $tnaDateArray[$po_id][88]['end_date'];// gmt finish
                            $finishAcStDate = $tnaDateArray[$po_id][88]['actual_start_date'];// gmt finish
                            $finishAcEndDate= $tnaDateArray[$po_id][88]['actual_finish_date'];// gmt finish

                            $cuttStDate     = $tnaDateArray[$po_id][84]['start_date'];// fab dyeing
                            $cuttEndDate    = $tnaDateArray[$po_id][84]['end_date'];// fab dyeing
                            $cuttAcStDate   = $tnaDateArray[$po_id][84]['actual_start_date'];// fab dyeing
                            $cuttAcEndDate  = $tnaDateArray[$po_id][84]['actual_finish_date'];// fab dyeing

                            $printStDate    = $tnaDateArray[$po_id][267]['start_date'];// fab print
                            $printEndDate   = $tnaDateArray[$po_id][267]['end_date'];// fab print
                            $printAcStDate  = $tnaDateArray[$po_id][267]['actual_start_date'];// fab print
                            $printAcEndDate = $tnaDateArray[$po_id][267]['actual_finish_date'];// fab print

                            $embStDate      = $tnaDateArray[$po_id][268]['start_date'];// fab emb
                            $embEndDate     = $tnaDateArray[$po_id][268]['end_date'];// fab emb
                            $embAcStDate    = $tnaDateArray[$po_id][268]['actual_start_date'];// fab emb
                            $embAcEndDate   = $tnaDateArray[$po_id][268]['actual_finish_date'];// fab emb

                            $washStDate     = $tnaDateArray[$po_id][90]['start_date'];// fab wash
                            $washEndDate    = $tnaDateArray[$po_id][90]['end_date'];// fab wash
                            $washAcStDate   = $tnaDateArray[$po_id][90]['actual_start_date'];// fab wash
                            $washAcEndDate  = $tnaDateArray[$po_id][90]['actual_finish_date'];// fab wash

                            $inputStDate    = $tnaDateArray[$po_id][86]['start_date'];// INPUT
                            $inputEndDate   = $tnaDateArray[$po_id][86]['end_date'];// INPUT
                            $inputAcStDate  = $tnaDateArray[$po_id][86]['actual_start_date'];// INPUT
                            $inputAcEndDate = $tnaDateArray[$po_id][86]['actual_finish_date'];// INPUT

                            $exfStDate      = $tnaDateArray[$po_id][110]['start_date'];// Exfact tna date
                            $exfEndDate     = $tnaDateArray[$po_id][110]['end_date'];// Exfact tna date
                            $exfAcStDate    = $tnaDateArray[$po_id][110]['actual_start_date'];// Exfact tna date
                            $exfAcEndDate   = $tnaDateArray[$po_id][110]['actual_finish_date'];// Exfact tna date

                            $aopStOfSbStDate      = $tnaDateArray[$po_id][254]['start_date'];// AOP STRICK OFF SUBMISSION
                            $aopStOfSbEndDate     = $tnaDateArray[$po_id][254]['end_date'];// AOP STRICK OFF SUBMISSION
                            $aopStOfSbAcStDate    = $tnaDateArray[$po_id][254]['actual_start_date'];// AOP STRICK OFF SUBMISSION
                            $aopStOfSbAcEndDate   = $tnaDateArray[$po_id][254]['actual_finish_date'];// AOP STRICK OFF SUBMISSION

                            $aopStOfApStDate      = $tnaDateArray[$po_id][255]['start_date'];// AOP STRICK OFF APPROVAL
                            $aopStOfApEndDate     = $tnaDateArray[$po_id][255]['end_date'];// AOP STRICK OFF APPROVAL
                            $aopStOfApAcStDate    = $tnaDateArray[$po_id][255]['actual_start_date'];// AOP STRICK OFF APPROVAL
                            $aopStOfApAcEndDate   = $tnaDateArray[$po_id][255]['actual_finish_date'];// AOP STRICK OFF APPROVAL

                            $smsSmpleSbStDate      = $tnaDateArray[$po_id][265]['start_date'];// SMS/GSS SAMPLE SUBMISSION
                            $smsSmpleSbEndDate     = $tnaDateArray[$po_id][265]['end_date'];// SMS/GSS SAMPLE SUBMISSION
                            $smsSmpleSbAcStDate    = $tnaDateArray[$po_id][265]['actual_start_date'];// SMS/GSS SAMPLE SUBMISSION
                            $smsSmpleSbAcEndDate   = $tnaDateArray[$po_id][265]['actual_finish_date'];// SMS/GSS SAMPLE SUBMISSION

                            $smsSmpleApStDate      = $tnaDateArray[$po_id][266]['start_date'];// SMS/GSS SAMPLE APPROVAL
                            $smsSmpleApEndDate     = $tnaDateArray[$po_id][266]['end_date'];// SMS/GSS SAMPLE APPROVAL
                            $smsSmpleApAcStDate    = $tnaDateArray[$po_id][266]['actual_start_date'];// SMS/GSS SAMPLE APPROVAL
                            $smsSmpleApAcEndDate   = $tnaDateArray[$po_id][266]['actual_finish_date'];// SMS/GSS SAMPLE APPROVAL

                            $wareTrialSbStDate      = $tnaDateArray[$po_id][21]['start_date'];// WARE TRAIL SUBMISSION
                            $wareTrialSbEndDate     = $tnaDateArray[$po_id][21]['end_date'];// WARE TRAIL SUBMISSION
                            $wareTrialSbAcStDate    = $tnaDateArray[$po_id][21]['actual_start_date'];// WARE TRAIL SUBMISSION
                            $wareTrialSbAcEndDate   = $tnaDateArray[$po_id][21]['actual_finish_date'];// WARE TRAIL SUBMISSION

                            $wareTrialApStDate      = $tnaDateArray[$po_id][22]['start_date'];// WARE TRAIL APPROVAL
                            $wareTrialApEndDate     = $tnaDateArray[$po_id][22]['end_date'];// WARE TRAIL APPROVAL
                            $wareTrialApAcStDate    = $tnaDateArray[$po_id][22]['actual_start_date'];// WARE TRAIL APPROVAL
                            $wareTrialApAcEndDate   = $tnaDateArray[$po_id][22]['actual_finish_date'];// WARE TRAIL APPROVAL

                            $bulkFabBrSbStDate      = $tnaDateArray[$po_id][28]['start_date'];// BULK FABRIC SUBMISSION BUYER
                            $bulkFabBrSbEndDate     = $tnaDateArray[$po_id][28]['end_date'];// BULK FABRIC SUBMISSION BUYER
                            $bulkFabBrSbAcStDate    = $tnaDateArray[$po_id][28]['actual_start_date'];// BULK FABRIC SUBMISSION BUYER
                            $bulkFabBrSbAcEndDate   = $tnaDateArray[$po_id][28]['actual_finish_date'];// BULK FABRIC SUBMISSION BUYER

                            $bulkFabBrApStDate      = $tnaDateArray[$po_id][29]['start_date'];// BULK FABRIC APPROVAL BUYER
                            $bulkFabBrApEndDate     = $tnaDateArray[$po_id][29]['end_date'];// BULK FABRIC APPROVAL BUYER
                            $bulkFabBrApAcStDate    = $tnaDateArray[$po_id][29]['actual_start_date'];// BULK FABRIC APPROVAL BUYER
                            $bulkFabBrApAcEndDate   = $tnaDateArray[$po_id][29]['actual_finish_date'];// BULK FABRIC APPROVAL BUYER

                            $bulkFabLbSbStDate      = $tnaDateArray[$po_id][197]['start_date'];// BULK FABRIC SUBMISSION LAB
                            $bulkFabLbSbEndDate     = $tnaDateArray[$po_id][197]['end_date'];// BULK FABRIC SUBMISSION LAB
                            $bulkFabLbSbAcStDate    = $tnaDateArray[$po_id][197]['actual_start_date'];// BULK FABRIC SUBMISSION LAB
                            $bulkFabLbSbAcEndDate   = $tnaDateArray[$po_id][197]['actual_finish_date'];// BULK FABRIC SUBMISSION LAB

                            $bulkFabLbApStDate      = $tnaDateArray[$po_id][198]['start_date'];// BULK FABRIC APPROVAL LAB
                            $bulkFabLbApEndDate     = $tnaDateArray[$po_id][198]['end_date'];// BULK FABRIC APPROVAL LAB
                            $bulkFabLbApAcStDate    = $tnaDateArray[$po_id][198]['actual_start_date'];// BULK FABRIC APPROVAL LAB
                            $bulkFabLbApAcEndDate   = $tnaDateArray[$po_id][198]['actual_finish_date'];// BULK FABRIC APPROVAL LAB

                            $knitDwnSbStDate      = $tnaDateArray[$po_id][256]['start_date'];// Knit down SUBMISSION 
                            $knitDwnSbEndDate     = $tnaDateArray[$po_id][256]['end_date'];// Knit down SUBMISSION 
                            $knitDwnSbAcStDate    = $tnaDateArray[$po_id][256]['actual_start_date'];// Knit down SUBMISSION 
                            $knitDwnSbAcEndDate   = $tnaDateArray[$po_id][256]['actual_finish_date'];// Knit down SUBMISSION 

                            $knitDwnApStDate      = $tnaDateArray[$po_id][257]['start_date'];// Knit down APPROVAL 
                            $knitDwnApEndDate     = $tnaDateArray[$po_id][257]['end_date'];// Knit down APPROVAL 
                            $knitDwnApAcStDate    = $tnaDateArray[$po_id][257]['actual_start_date'];// Knit down APPROVAL 
                            $knitDwnApAcEndDate   = $tnaDateArray[$po_id][257]['actual_finish_date'];// Knit down APPROVAL 

                            $prntStOfSbStDate      = $tnaDateArray[$po_id][126]['start_date'];//print strick off SUBMISSION 
                            $prntStOfSbEndDate     = $tnaDateArray[$po_id][126]['end_date'];//print strick off SUBMISSION 
                            $prntStOfSbAcStDate    = $tnaDateArray[$po_id][126]['actual_start_date'];//print strick off SUBMISSION 
                            $prntStOfSbAcEndDate   = $tnaDateArray[$po_id][126]['actual_finish_date'];//print strick off SUBMISSION 

                            $prntStOfApStDate      = $tnaDateArray[$po_id][127]['start_date'];// Knit down APPROVAL 
                            $prntStOfApEndDate     = $tnaDateArray[$po_id][127]['end_date'];// Knit down APPROVAL 
                            $prntStOfApAcStDate    = $tnaDateArray[$po_id][127]['actual_start_date'];// Knit down APPROVAL 
                            $prntStOfApAcEndDate   = $tnaDateArray[$po_id][127]['actual_finish_date'];// Knit down APPROVAL  

                            $embStOfSbStDate      = $tnaDateArray[$po_id][128]['start_date'];//print strick off SUBMISSION 
                            $embStOfSbEndDate     = $tnaDateArray[$po_id][128]['end_date'];//print strick off SUBMISSION 
                            $embStOfSbAcStDate    = $tnaDateArray[$po_id][128]['actual_start_date'];//print strick off SUBMISSION 
                            $embStOfSbAcEndDate   = $tnaDateArray[$po_id][128]['actual_finish_date'];//print strick off SUBMISSION 

                            $embStOfApStDate      = $tnaDateArray[$po_id][129]['start_date'];// Knit down APPROVAL 
                            $embStOfApEndDate     = $tnaDateArray[$po_id][129]['end_date'];// Knit down APPROVAL 
                            $embStOfApAcStDate    = $tnaDateArray[$po_id][129]['actual_start_date'];// Knit down APPROVAL 
                            $embStOfApAcEndDate   = $tnaDateArray[$po_id][129]['actual_finish_date'];// Knit down APPROVAL 

                            $topSmBrSbStDate      = $tnaDateArray[$po_id][26]['start_date'];// Top Sample SUBMISSION buyer 
                            $topSmBrSbEndDate     = $tnaDateArray[$po_id][26]['end_date'];// Top Sample SUBMISSION buyer 
                            $topSmBrSbAcStDate    = $tnaDateArray[$po_id][26]['actual_start_date'];// Top Sample SUBMISSION buyer 
                            $topSmBrSbAcEndDate   = $tnaDateArray[$po_id][26]['actual_finish_date'];// Top Sample SUBMISSION buyer 

                            $topSmBrApStDate      = $tnaDateArray[$po_id][27]['start_date'];// Top Sample APPROVAL  buyer
                            $topSmBrApEndDate     = $tnaDateArray[$po_id][27]['end_date'];// Top Sample APPROVAL  buyer
                            $topSmBrApAcStDate    = $tnaDateArray[$po_id][27]['actual_start_date'];// Top Sample APPROVAL  buyer
                            $topSmBrApAcEndDate   = $tnaDateArray[$po_id][27]['actual_finish_date'];// Top Sample APPROVAL  buyer

                            $topSmLbSbStDate      = $tnaDateArray[$po_id][26]['start_date'];// Top Sample SUBMISSION Lab 
                            $topSmLbSbEndDate     = $tnaDateArray[$po_id][26]['end_date'];// Top Sample SUBMISSION Lab 
                            $topSmLbSbAcStDate    = $tnaDateArray[$po_id][26]['actual_start_date'];// Top Sample SUBMISSION Lab 
                            $topSmLbSbAcEndDate   = $tnaDateArray[$po_id][26]['actual_finish_date'];// Top Sample SUBMISSION Lab 

                            $topSmLbApStDate      = $tnaDateArray[$po_id][27]['start_date'];// Top Sample APPROVAL  Lab
                            $topSmLbApEndDate     = $tnaDateArray[$po_id][27]['end_date'];// Top Sample APPROVAL  Lab
                            $topSmLbApAcStDate    = $tnaDateArray[$po_id][27]['actual_start_date'];// Top Sample APPROVAL  Lab
                            $topSmLbApAcEndDate   = $tnaDateArray[$po_id][27]['actual_finish_date'];// Top Sample APPROVAL  Lab

                            $mockUpSbStDate      = $tnaDateArray[$po_id][23]['start_date'];// Mock up SUBMISSION 
                            $mockUpSbEndDate     = $tnaDateArray[$po_id][23]['end_date'];// Mock up SUBMISSION 
                            $mockUpSbAcStDate    = $tnaDateArray[$po_id][23]['actual_start_date'];// Mock up SUBMISSION 
                            $mockUpSbAcEndDate   = $tnaDateArray[$po_id][23]['actual_finish_date'];// Mock up SUBMISSION 

                            $mockUpApStDate      = $tnaDateArray[$po_id][23]['start_date'];// Mock up APPROVAL 
                            $mockUpApEndDate     = $tnaDateArray[$po_id][23]['end_date'];// Mock up APPROVAL 
                            $mockUpApAcStDate    = $tnaDateArray[$po_id][23]['actual_start_date'];// Mock up APPROVAL 
                            $mockUpApAcEndDate   = $tnaDateArray[$po_id][23]['actual_finish_date'];// Mock up APPROVAL 

                            $trimsCardSbStDate      = $tnaDateArray[$po_id][16]['start_date'];// Trims Card SUBMISSION 
                            $trimsCardSbEndDate     = $tnaDateArray[$po_id][16]['end_date'];// Trims Card SUBMISSION 
                            $trimsCardSbAcStDate    = $tnaDateArray[$po_id][16]['actual_start_date'];// Trims Card SUBMISSION 
                            $trimsCardSbAcEndDate   = $tnaDateArray[$po_id][16]['actual_finish_date'];// Trims Card SUBMISSION 

                            $trimsCardApStDate      = $tnaDateArray[$po_id][17]['start_date'];// Trims Card APPROVAL 
                            $trimsCardApEndDate     = $tnaDateArray[$po_id][17]['end_date'];// Trims Card APPROVAL 
                            $trimsCardApAcStDate    = $tnaDateArray[$po_id][17]['actual_start_date'];// Trims Card APPROVAL 
                            $trimsCardApAcEndDate   = $tnaDateArray[$po_id][17]['actual_finish_date'];// Trims Card APPROVAL 

                            $bdate          = new DateTime($bookingDate);
                            $tdate          = new DateTime($bookEndDate);
                            $days           = $tdate->diff($bdate)->format('%a');
                            //============================ LABDIP SUBMIT ==========================
                            $lbdpSbBackLog = 0;
                            $start_date  = new DateTime($lbdpSbStDate);
                            $end_date    = new DateTime($lbdpSbEndDate);
                            // echo $lbdpSbEndDate."-------";die();
                            // print_r($end_date);die();
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $lbdpSbBackLog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $lbdpSbBackLog = $totPoColor - $labDipColorSub;
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $lbdpSbBackLog = (($totPoColor/$tnaDaysDif)*$todayDaysDif) - $labDipColorSub;
                            }
                            $lbdpSbBal         = $totPoColor - $labDipColorSub;
                            //============================ LABDIP APPROVAL ==========================
                            $lbdpApBackLog = 0;
                            $start_date  = new DateTime($lbdpApStDate);
                            $end_date    = new DateTime($lbdpApEndDate);
                            // print_r($end_date);die();
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $lbdpApBackLog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $lbdpApBackLog = $totPoColor - $labDipColorApp;
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $lbdpApBackLog = (($totPoColor/$tnaDaysDif)*$todayDaysDif) - $labDipColorApp;
                            }
                            $lbdpApBal         = $totPoColor - $labDipColorApp;
                            //============================ yarn allocation ==========================
                            $yarnReqQty     = $yarnReqQtyArr[$po_id];
                            $yarnAlloQty    = $yarnAlloArr[$po_id]['qnty'];
                            $yarnAlloDt     = $yarnAlloArr[$po_id]['date'];
                            $yarnIssueQty   = $yarnIssueQtyArr[$po_id]['issue'];
                            $yarnIssueRtnQty= $yarnIssueQtyArr[$po_id]['rtn'];
                            $yarnStock      = $yarnAlloQty - $yarnIssueQty;
                            $yarnPlanBal = ($yarnReqQty+$yarn_excess_qty) - $tnaPlanTargetArray[$po_id][48]['all_plan_qty'];
                            // echo $yarnReqQty."+".$yarn_excess_qty." - ".$tnaPlanTargetArray[$po_id][48];

                            $yarnBackLog    =  $tnaPlanTargetArray[$po_id][48]['prev_plan_qty'] - $yarnAlloArr[$po_id]['prev_qnty'];
                            // echo $tnaPlanTargetArray[$po_id][48]['prev_plan_qty'] ."-". $yarnAlloArr[$po_id]['prev_qnty']; 
                          
                            $yarnBal         = ($yarnReqQty+$yarn_excess_qty) - $yarnAlloQty;
                            //========================= yarn dayed ==========================
                            $yarnDyedReqQty  = array_sum($conversion_costing_arr[$po_id][30]);
                            $ydRcv      = $yarnDyedArr[$po_id]['qty'];
                            $ydLstRcv   = $yarnDyedArr[$po_id]['lstqty'];
                            $ydIssueQty = $yarnDyeIssueQtyArr[$po_id]['issue'];
                            $ydIssueRtnQty = $yarnDyeIssueQtyArr[$po_id]['rtn'];
                            $ydSndBal = $yarnDyedReqQty - $ydIssueQty;                            
                            $yarnDyedPlanBal = $yarnDyedReqQty - $tnaPlanTargetArray[$po_id][52]['all_plan_qty'];

                            $ydBackLog  = $tnaPlanTargetArray[$po_id][52]['prev_plan_qty'] - $yarn_dyed_prev_qty;
                           /*  $start_date = new DateTime($ydtnaStDate);
                            $end_date   = new DateTime($ydtnaEndDate);
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $ydBackLog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $ydBackLog = $yarnDyedReqQty - $yarn_dyed_qty;
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $ydBackLog = (($yarnDyedReqQty/$tnaDaysDif)*$todayDaysDif) - $yarn_dyed_qty;
                            } */
                            $ydBal         = $yarnDyedReqQty - $yarn_dyed_qty;
                            //============================= grey req. =========================
                            $fabGreyReg = array_sum($fabric_costing_arr['knit']['grey'][$po_id]);
                            $grey_trans_in = $grey_fab_transfer_data[$po_id]['in'];
                            $grey_trans_out = $grey_fab_transfer_data[$po_id]['out'];
                            $greyRcv    = $greyProdArr[$po_id]['qty'];
                            $greyRcvPrev    = $greyProdArr[$po_id]['prev_qnty'];
                            $greyLstRcv = $greyProdArr[$po_id]['lstqty'];
                            $progQty    = $progQtyArray[$po_id];
                            $progBalQty = ($fabGreyReg+$grey_fab_excess_qty) - $progQty;
                            $yrnSndtoFact= $yarnIssueQty - $yarnIssueRtnQty;
                            $yrnSndBal  = $progQty - $yarnIssueQty;
                            $greyFabPlanBal = ($fabGreyReg+$grey_fab_excess_qty) - $tnaPlanTargetArray[$po_id][60]['all_plan_qty'];
                            $greyBackLog = $tnaPlanTargetArray[$po_id][60]['prev_plan_qty'] - ($greyRcvPrev + $grey_trans_in);
                            /* $start_date  = new DateTime($greyStDate);
                            $end_date    = new DateTime($greyEndDate);
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $greyBackLog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $greyBackLog = ($fabGreyReg+$grey_fab_excess_qty + $grey_trans_out) - ($greyRcv + $grey_trans_in);
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $greyBackLog = ((($fabGreyReg+$grey_fab_excess_qty + $grey_trans_out)/$tnaDaysDif)*$todayDaysDif) - ($greyRcv + $grey_trans_in);
                            } */
                            $greyBal         = ($fabGreyReg+$grey_fab_excess_qty + $grey_trans_out) - ($greyRcv + $grey_trans_in);
                            //============================= FABRIC DYEING. =========================
                            // $fabDyeingReq   = array_sum($conversion_costing_arr[$po_id][31]);
                            $fabDyeingReq   = $fabGreyReg+$grey_fab_excess_qty;
                            $dyeingRcv      = $dyeingProdArr[$po_id]['in']+$dyeingProdArr[$po_id]['out'];
                            $dyeingRcvPrev      = $dyeingProdArr[$po_id]['prev_in']+$dyeingProdArr[$po_id]['prev_out'];
                            $lstDyeingRcv   = $dyeingProdArr[$po_id]['lstqty'];
                            $batchQty       = $batchQtyArr[$po_id]['qty']+$dyeingProdArr[$po_id]['out'];
                            $batchBal       = ($fabGreyReg+$grey_fab_excess_qty) - $batchQty;
                            $redyToBatch    = $greyRcv - $batchQty;
                            $fabDyePlanBal = $fabDyeingReq - $tnaPlanTargetArray[$po_id][61]['all_plan_qty'];
                            $dyeingBackLog  = $tnaPlanTargetArray[$po_id][61]['prev_plan_qty'] - $dyeingRcvPrev;
                            /* $start_date  = new DateTime($dyeingStDate);
                            $end_date    = new DateTime($dyeingEndDate);
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $dyeingBackLog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $dyeingBackLog = $fabDyeingReq - $dyeingRcv;
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $dyeingBackLog = (($fabDyeingReq/$tnaDaysDif)*$todayDaysDif) - $dyeingRcv;
                            } */
                            $dyeingBal         = $fabDyeingReq - $dyeingRcv;
                            //============================= BOOKING =========================
                            $fabfinishPurReg  = array_sum($fabric_purchase_costing_arr['knit']['finish'][$po_id]);
                            $fabfinishReg  = array_sum($fabric_costing_arr['knit']['finish'][$po_id]);
                            $tot_finfab_req_qty = $fabfinishReg + $fabfinishPurReg;
                            $bookingBackLog    = 0;
                            $bookingBal        = 0;
                            $start_date  = new DateTime($bookStDate);
                            $end_date    = new DateTime($bookEndDate);
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $bookingBackLog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $bookingBackLog = $tot_finfab_req_qty - $bookingQty;
                                // echo $bookingBackLog ."=". $fabfinishReg ."-". $bookingQty."<br>"; 
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $bookingBackLog = (($tot_finfab_req_qty/$tnaDaysDif)*$todayDaysDif) - $bookingQty;
                            }
                            $bookingBal         = $tot_finfab_req_qty - $bookingQty;
                            //============================= ALL OVER PRINT =========================
                            // $aopReq  = array_sum($conversion_costing_arr[$po_id][35]);
                            // $aop_Req     = array_sum($fabric_po_color_type_wise_arr['knit']['finish'][$po_id][5]);
                            $aop_Req     = array_sum($fabric_costing_aop_arr['knit']['finish'][$po_id][5][1]);
                            $aopReq     = $aop_Req+$color_type_wise_booking_qty_array[$po_id][5];
                            $aopRcv     = $aopProdArr[$po_id]['qty'];
                            $aopRcvPrev = $aopProdArr[$po_id]['prev_qty'];
                            $aopLstRcv  = $aopProdArr[$po_id]['lstqty'];
                            $aopIssueQty= $aopProdArr[$po_id]['issueqty'];
                            $aopFbSndBal= $aopReq - $aopIssueQty;
                            $aopPlanBal = $aopReq - $tnaPlanTargetArray[$po_id][63]['all_plan_qty'];
                            $aopBackLog  = $tnaPlanTargetArray[$po_id][63]['prev_plan_qty'] - $aopRcvPrev;
                            /* $aopBackLog    = 0;
                            $start_date  = new DateTime($aopStDate);
                            $end_date    = new DateTime($aopEndDate);
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $aopBackLog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $aopBackLog = $aopReq - $aopRcv;
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $aopBackLog = (($aopReq/$tnaDaysDif)*$todayDaysDif) - $aopRcv;
                            } */
                            $aopBal         = $aopReq - $aopRcv;
                            //============================= finish fab. prod =========================
                            //$fabfinishPurReg  = array_sum($fabric_purchase_costing_arr['knit']['finish'][$po_id]);
                            $finishRcv  = $finFabProdArr[$po_id]['qty'];
                            $finishLstRcv  = $finFabProdArr[$po_id]['lstqty'];
                            $finFabTrnsIn  = $finFabTrnsArr[$po_id][5]['qty'];
                            $finFabTrnsOut  = $finFabTrnsArr[$po_id][6]['qty'];
                            
                            $finFabOutProd  = $finFabOutProdArr[$po_id];
                            $finFab_purchase_qty = $finFabPurchaseArr[$po_id]['qty'];
                            $gmtStrRcv2      = $finFabStkArray2[$po_id]['gmt_rcv'];
                            $gmtStrRcvRtn2   = $finFabStkArray2[$po_id]['gmt_rcv_rtn'];
                            $gmtStrTrnsIn2   = $finFabStkArray2[$po_id]['gmt_rcv_trns'];

                            $gmtStrRcv2Prev      = $finFabStkArray2[$po_id]['prev_gmt_rcv'];
                            $finFab_purchase_qty_prev = $finFabPurchaseArr[$po_id]['prev_qty'];
                            $gmtStrTrnsIn2Prev   = $finFabStkArray2[$po_id]['prev_gmt_rcv_trns'];

                            $fin_rcv_qnty2   = $gmtStrTrnsIn2+$gmtStrRcv2+$finFab_purchase_qty;//+$finFabOutProd;
                            // echo $val['intRef']."==".$gmtStrTrnsIn2."+".$gmtStrRcv2."+".$finFab_purchase_qty."<br>";
                            $ttlFinFabPlan = ($tnaPlanTargetArray[$po_id][73][1]['all_plan_qty'] + $tnaPlanTargetArray[$po_id][73][2]['all_plan_qty']);
                            $finFabPlanBal = ($tot_finfab_req_qty+$fin_fab_excess_qty) - $ttlFinFabPlan;
                            $finishBackLog  = $tnaPlanTargetArray[$po_id][73][1]['prev_plan_qty'] - ($gmtStrRcv2Prev+$gmtStrTrnsIn2Prev);
                            $finishBackLogPur  = $tnaPlanTargetArray[$po_id][73][2]['prev_plan_qty'] - $finFab_purchase_qty_prev;
                            // echo $tnaPlanTargetArray[$po_id][73]['prev_plan_qty'] ."- (".$gmtStrRcv2Prev."+".$finFab_purchase_qty_prev."+".$gmtStrTrnsIn2Prev.")<br>";
                            
                           /*  $finishBackLog      = 0;
                            $start_date  = new DateTime($fabFinStDate);
                            $end_date    = new DateTime($fabFinEndDate);
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $finishBackLog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $finishBackLog = ($tot_finfab_req_qty+$fin_fab_excess_qty) - $fin_rcv_qnty2;
                                // echo $finishBackLog ."= (".$tot_finfab_req_qty."+".$fin_fab_excess_qty.") - ".$fin_rcv_qnty2."<br>";
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                //echo $start_date->format('Y-m-d'); echo $end_date->format('Y-m-d')."<br>".$po_id;
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $finishBackLog = ((($tot_finfab_req_qty+$fin_fab_excess_qty)/$tnaDaysDif)*$todayDaysDif) - $fin_rcv_qnty2;
                                
                                //echo $finishBackLog ."= ((".$fabfinishReg."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$fin_rcv_qnty2."<br>";
                            } */
                            
                            
                            $finishFabBal    = ($tot_finfab_req_qty+$fin_fab_excess_qty) - $fin_rcv_qnty2;
                            //$finishFabBal         = $fabfinishReg - $finishRcv;
                            //============================= ISSUE TO CUT =========================
                            $issueToCut= $issueProdArr[$po_id]['qty'];
                            $layQty    = $cutAndLayArr[$po_id]['qty'];
                            // $qcQty     = $CutQCArr[$po_id]['qty'];

                            $qcQty          = $prodArr[$po_id]['cut_qty'];
                            
                            // $qcRejQty  = $CutQCArr[$po_id]['rejqty'];
                            $qcRplsQty = $CutQCArr[$po_id]['rplsqty'];
                            $lstQcQty  = $CutQCArr[$po_id]['lst_rpls_qty'];
                            $cutBal    = $val['qty'] -  $qcQty;
                            
                            $cuttingPlanBal = $val['qty'] - $tnaPlanTargetArray[$po_id][84]['all_plan_qty'];
                            $qcBackLog  = $tnaPlanTargetArray[$po_id][84]['prev_plan_qty'] - $prodArr[$po_id]['prev_cut_qty'];

                            $dyeStrIss      = $finFabStkArray[$po_id]['dye_issue'];
                            $dyeStrIssRtn   = $finFabStkArray[$po_id]['dye_issue_rtn'];
                            $dyeStrTrnsOut  = $finFabStkArray[$po_id]['dye_issue_trns'];
                            $dyeStrRcv      = $finFabStkArray[$po_id]['dye_rcv'];
                            $dyeStrRcvRtn   = $finFabStkArray[$po_id]['dye_rcv_rtn'];
                            $dyeStrTrnsIn   = $finFabStkArray[$po_id]['dye_rcv_trns'];

                            $dye_total_receive=$dyeStrTrnsIn+$dyeStrRcv+$dyeStrIssRtn;
                            $dye_total_issue=$dyeStrTrnsOut+$dyeStrIss+$dyeStrRcvRtn;
                            $dyeStock = $dye_total_receive - $dye_total_issue;
                            // echo $dyeStrTrnsIn."+".$dyeStrRcv."+".$dyeStrIssRtn ."-". $dyeStrTrnsOut."+".$dyeStrIss."+".$dyeStrRcvRtn."<br>";

                            $gmtStrIss      = $finFabStkArray[$po_id]['gmt_issue'];
                            $gmtStrIssRtn   = $finFabStkArray[$po_id]['gmt_issue_rtn'];
                            $gmtStrTrnsOut  = $finFabStkArray[$po_id]['gmt_issue_trns'];
                            $gmtStrRcv      = $finFabStkArray[$po_id]['gmt_rcv'];
                            $gmtStrRcvRtn   = $finFabStkArray[$po_id]['gmt_rcv_rtn'];
                            $gmtStrTrnsIn   = $finFabStkArray[$po_id]['gmt_rcv_trns'];

                            $gmt_total_receive=$gmtStrTrnsIn+$gmtStrRcv+$gmtStrIssRtn;
                            $gmt_total_issue=$gmtStrTrnsOut+$gmtStrIss+$gmtStrRcvRtn;
                            $gmtStock = $gmt_total_receive - $gmt_total_issue;
                            
                            

                           /*  $qcBackLog = 0;
                            $start_date  = new DateTime($cuttStDate);
                            $end_date    = new DateTime($cuttEndDate);
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $qcBackLog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $qcBackLog = $val['qty'] - $qcQty;
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $qcBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $qcQty;
                                //echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$qcQty."<br>";
                            } */
                            //============================= PRINTING DATA =========================
                            $printReq       = $emblishment_costing_arr[$po_id][1]*$costingPer;
                            $printQty       = $prodArr[$po_id]['print_qty'];
                            $printIssQty    = $prodArr[$po_id]['print_iss_qty'];
                            $printRejQty    = $prodArr[$po_id]['print_rej_qty'];
                            $lstPrntQty     = $prodArr[$po_id]['lst_prnt_qty'];
                            $prntSndBal     = $printReq - $printIssQty;
                            if($emblishment_costing_arr[$po_id][1]>0)
                            {
                                $printBal       = $printReq - $printQty;
                            }
                            else
                            {
                                $printBal = 0;
                            } 
                            
                            $printPlanBal = $printReq - $tnaPlanTargetArray[$po_id][267]['all_plan_qty'];
                            $printBackLog  = $tnaPlanTargetArray[$po_id][267]['prev_plan_qty'] - $prodArr[$po_id]['prev_print_qty'];

                            /* $printBackLog   = 0;
                            $start_date     = new DateTime($printStDate);
                            $end_date       = new DateTime($printEndDate);
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $printBackLog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $printBackLog = $printReq - $printQty;
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $printBackLog = (($printReq/$tnaDaysDif)*$todayDaysDif) - $printQty;
                            } */
                            //============================= EMBROIDERY  =========================
                            $embReq  = $emblishment_costing_arr[$po_id][2]*$costingPer;
                            $embQty  = $prodArr[$po_id]['emb_qty'];
                            $embIssueQty = $prodArr[$po_id]['emb_issue_qty'];
                            $embSndBal = $embReq - $embIssueQty;
                            $embRejQty  = $prodArr[$po_id]['emb_rej_qty'];
                            $lstEmbQty  = $prodArr[$po_id]['lst_emb_qty'];
                            if($emblishment_costing_arr[$po_id][2]>0)
                            {
                                $embBal  = $embReq - $embQty;
                            }
                            else
                            {
                                $embBal = 0;
                            }
                            
                            $embPlanBal = $embReq - $tnaPlanTargetArray[$po_id][268]['all_plan_qty'];
                            $embBackLog  = $tnaPlanTargetArray[$po_id][268]['prev_plan_qty'] - $prodArr[$po_id]['prev_emb_qty'];
                            
                           /*  $embBackLog = 0;
                            $start_date  = new DateTime($embStDate);
                            $end_date    = new DateTime($embEndDate);
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $embBackLog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $embBackLog = $embReq - $embQty;
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $embBackLog = (($embReq/$tnaDaysDif)*$todayDaysDif) - $embQty;
                            } */
                            //============================= WASH  =========================
                            $washReq     = $emblishment_costing_arr_name[$po_id][3]*$costingPer;
                            $washQty     = $prodArr[$po_id]['wash_qty'];
                            $lstWashQty  = $prodArr[$po_id]['lst_wash_qty'];
                            $washIssueQty= $prodArr[$po_id]['wash_issue_qty'];
                            $washRejQty  = $prodArr[$po_id]['wash_rej_qty'];
                            $sendBal     = $washReq - $washIssueQty;

                            $washBal     = $washReq > 0 ? $washReq - $washQty : 0;
                            
                            $washPlanBal = $washReq - $tnaPlanTargetArray[$po_id][90]['all_plan_qty'];
                            $washBackLog  = $tnaPlanTargetArray[$po_id][90]['prev_plan_qty'] - $prodArr[$po_id]['prev_wash_qty'];

                           /*  $washBackLog = 0;
                            $start_date  = new DateTime($washStDate);
                            $end_date    = new DateTime($washEndDate);
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $washBackLog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $washBackLog = $washReq - $washQty;
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $washBackLog = (($washReq/$tnaDaysDif)*$todayDaysDif) - $washQty;
                            } */
                            //============================= SEW TRIMS =========================
                            $sewTrimsReq    = $trims_costing_arr[$po_id][1];
                            $sewTrimsQty    = $accArr[$po_id][1]['qty'];
                            $sewTrimsPrsnt  = ($sewTrimsQty/$sewTrimsReq)*100;
                            $sewTrmBacklog  = 0;
                            $start_date     = new DateTime($sewTrimsStDate);
                            $end_date       = new DateTime($sewTrimsEndDate);
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $sewTrmBacklog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $sewTrmBacklog = 100 - $sewTrimsPrsnt;
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $sewTrmBacklog = ((100/$tnaDaysDif)*$todayDaysDif) - $sewTrimsPrsnt;
                            }
                            //================================= FIN TRIMS =======================
                            $finTrimsReq    = $trims_costing_arr[$po_id][2];
                            $finTrimsQty    = $accArr[$po_id][2]['qty'];
                            $finTrimsPrsnt  = ($finTrimsQty/$finTrimsReq)*100;
                            $finTrmBacklog = 0;
                            $start_date  = new DateTime($finTrimsStDate);
                            $end_date    = new DateTime($finTrimsEndDate);
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $finTrmBacklog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $finTrmBacklog = 100 - $finTrimsPrsnt;
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $finTrmBacklog = ((100/$tnaDaysDif)*$todayDaysDif) - $finTrimsPrsnt;
                            }
                            // ============================= Accessories=========================================
                            $tot_item = $trimsItemCountBudgetWise[$po_id];
                            $tot_booking_item = $trimsBookingArr[$po_id];
                            $accBookingPrsnt = ($tot_item) ? ($tot_booking_item/$tot_item)*100 : 0;
                            $accBacklog = 0;
                            $start_date  = new DateTime($accBkStDate);
                            $end_date    = new DateTime($accBkEndDate);
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $accBacklog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $accBacklog = 100 - $accBookingPrsnt;
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $accBacklog = ((100/$tnaDaysDif)*$todayDaysDif) - $accBookingPrsnt;
                            }
                            //=============================== PRODUCTION AND EX-FACTORY ===========================

                            $qcQty          = $prodArr[$po_id]['cut_qty'];
                            $qcRejQty       = $prodArr[$po_id]['cut_reject_qty'];
                            $inputQty       = $prodArr[$po_id]['input_qty'];
                            $input_bal      = $qcQty - $inputQty;
                            $plan_input_bal = $qcQty - $prodArr[$po_id]['input_qty']-$printRejQty - $embRejQty;
                            $outputQty      = $prodArr[$po_id]['out_qty'];
                            $lstOutputQty   = $prodArr[$po_id]['lst_out_qty'];
                            $rejectQty      = $prodArr[$po_id]['reject_qty'];
                            $alterQty       = $prodArr[$po_id]['alter_qty'];
                            $spotQty        = $prodArr[$po_id]['spot_qty'];
                            $replaceQty     = $prodArr[$po_id]['replace_qty'];
                            $rejectQty      = $rejectQty+$alterQty+$spotQty-$replaceQty;
                            $okOutQty       = $outputQty;
                            $totSewQty      = $okOutQty + $rejectQty;
                            $sewingWIP      = $inputQty - $totSewQty;
                            $sewingBAL      = $val['qty'] - $okOutQty;
                            $finishQty      = $prodArr[$po_id]['finish_qty'];
                            $lstFinishQty   = $prodArr[$po_id]['lst_finish_qty'];
                            $finRejQty      = $prodArr[$po_id]['fin_rej_qty'];
                            $finishBal      = $val['qty'] - $finishQty;
                            $finishWIP      = $outputQty - $finishQty - $finRejQty;
                            $exfactoryQty   = $exfArr[$po_id]['qty'];
                            $exfactoryLstQty= $exfArr[$po_id]['lqty'];
                            $exfactoryWIP   = $finishQty - $exfactoryQty;
                            $exBal          = $val['qty'] - $exfArr[$po_id]['qty'];
                            $exDateArray    = array_filter(explode(",", $exfArr[$po_id]['exdate']));
                            // print_r($exDateArray);
                            // echo max($exDateArray);
                            // echo "<br>";
                            // echo min($exDateArray);
                            
                            $sewFinPlanBal = $val['qty'] - $tnaPlanTargetArray[$po_id][86]['all_plan_qty'];
                            $sewFinBackLog  = $tnaPlanTargetArray[$po_id][86]['prev_plan_qty'] - $prodArr[$po_id]['prev_out_qty'];

                            /* $sewFinBackLog = 0;
                            $start_date  = new DateTime($inputStDate);
                            $end_date    = new DateTime($inputEndDate);
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $sewFinBackLog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $sewFinBackLog = $val['qty'] - $okOutQty;
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $sewFinBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $okOutQty;
                                //echo "((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$okOutQty."<br>";
                            } */
                           
                            //============================= GMTS FINISH  =========================
                            
                            $gmtFinBal     = $val['qty'] - $finishQty;
                            
                            $gmtFinPlanBal = $val['qty'] - $tnaPlanTargetArray[$po_id][88]['all_plan_qty'];
                            $gmtFinBackLog  = $tnaPlanTargetArray[$po_id][88]['prev_plan_qty'] - $prodArr[$po_id]['prev_finish_qty'];
                            /* $gmtFinBackLog = 0;
                            $start_date  = new DateTime($finishStDate);
                            $end_date    = new DateTime($finishEndDate);
                            if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                            {
                                $gmtFinBackLog = 0;
                            }
                            elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                            {
                                $gmtFinBackLog = $val['qty'] - $finishQty;
                            }
                            elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                            {
                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                                $todayDaysDif= $start_date->diff($toDay)->format('%a');

                                $gmtFinBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $finishQty;
                                //echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$finishQty."<br>";
                            } */
                            //============================= SHIPING BACKLOG ===================
                            // $shiping_backlog = 0;
                            $orig_ship_date = new DateTime($val['orig_ship_date']);
                            $shiping_backlog = (strtotime($toDay->format('Y-m-d')) <= strtotime($val['orig_ship_date'])) ? 0 : $val['qty'] - $exfArr[$po_id]['qty'];
                            
                            
                            if($cbo_balance) // Balance search filter working here============================
                            {
                                if($cbo_balance==1)
                                {
                                    $particular = $accBookingPrsnt;
                                    $operator = "<";
                                    $compare = 100;
                                }
                                elseif($cbo_balance==2)
                                {
                                    $particular = $bookingBal;
                                    $operator = ">";
                                    $compare = 0;
                                }
                                elseif($cbo_balance==3)
                                {
                                    $particular = $yarnBal;
                                    $operator = ">";
                                    $compare = 0;
                                }
                                elseif($cbo_balance==4)
                                {
                                    $particular = $ydBal;
                                    $operator = ">";
                                    $compare = 0;
                                }
                                elseif($cbo_balance==5)
                                {
                                    $particular = $greyBal;
                                    $operator = ">";
                                    $compare = 0;
                                }
                                elseif($cbo_balance==6)
                                {
                                    $particular = $dyeingBal;
                                    $operator = ">";
                                    $compare = 0;
                                }
                                elseif($cbo_balance==7)
                                {
                                    $particular = $aopBal;
                                    $operator = ">";
                                    $compare = 0;
                                }
                                elseif($cbo_balance==8)
                                {
                                    $particular = $finishFabBal;
                                    $operator = ">";
                                    $compare = 0;
                                }
                                elseif($cbo_balance==9)
                                {
                                    $particular = $cutBal;
                                    $operator = ">";
                                    $compare = 0;
                                }
                                elseif($cbo_balance==10)
                                {
                                    $particular = $printBal;
                                    $operator = ">";
                                    $compare = 0;
                                }
                                elseif($cbo_balance==11)
                                {
                                    $particular = $embBal;
                                    $operator = ">";
                                    $compare = 0;
                                }
                                elseif($cbo_balance==12)
                                {
                                    $particular = $sewTrimsPrsnt;
                                    $operator = "<";
                                    $compare = 100;
                                }
                                elseif($cbo_balance==13)
                                {
                                    $particular = $finTrimsPrsnt;
                                    $operator = "<";
                                    $compare = 100;
                                }
                                elseif($cbo_balance==14)
                                {
                                    $particular = $sewingBAL;
                                    $operator = ">";
                                    $compare = 0;
                                }
                                elseif($cbo_balance==15)
                                {
                                    $particular = $washBal;
                                    $operator = ">";
                                    $compare = 0;
                                }
                                elseif($cbo_balance==16)
                                {
                                    $particular = $gmtFinBal;
                                    $operator = ">";
                                    $compare = 0;
                                }
                                elseif($cbo_balance==17)
                                {
                                    $particular = $exBal;
                                    $operator = ">";
                                    $compare = 0;
                                }
                                if(checkOperator($particular,$operator,$compare))
                                {
                                    $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                    ?>
                                    <tr class="GridViewScrollItem" bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                        <td><? echo $i;?></td>
                                        <td>
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','production_calendar_popup')">                             
                                                <? echo $val['int_ref'];?>
                                            </a>   
                                        </td>
                                        <td title="<? echo $val['style'];?>">

                                            <a href="javascript:void()" onclick="garments_popup('<? echo $po_id;?>','sample_approval_popup')">  
                                                <? echo strlen($val['style'])>10 ? substr($val['style'], 0, 10) : $val['style'];?>
                                            </a>                                    
                                        </td>
                                        <td>
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','sample_fabric_popup')">  
                                                <? echo change_date_format($val['orig_ship_date']); ?>
                                            </a>
                                            
                                        </td>
                                        <td title="<? echo $val['po_no'];?>">
                                            <a href="javascript:void()" onclick="garments_popup('<? echo $po_id;?>','plan_monitoring_popup')">  
                                                <? echo substr($val['po_no'],0,10);?>
                                            </a>
                                        </td>
                                        <td>
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','tna_calendar_popup')"> 
                                                <?=$client_array[$val['client']];?>
                                            </a>
                                        </td>
                                        <td title="<? echo $bookingFabInfoArray[$po_id]['construction'];?>">
                                            <a href="javascript:void()" onclick="open_fab_stucture_popup('<? echo $po_id;?>','<? echo $val['int_ref'];?>','<? echo $client;?>','<? echo $val['style'];?>')"> 
                                                <? 
                                                    echo ($bookingFabInfoArray[$po_id]['construction'] !="") ? substr($bookingFabInfoArray[$po_id]['construction'],0,10) : "View";
                                                ?>
                                            </a>                                        
                                        </td>
                                        <td><? echo $bookingFabInfoArray[$po_id]['gsm'];?></td>
                                        <td title="<? echo $bookingFabInfoArray[$po_id]['composition'];?>"><? echo substr($bookingFabInfoArray[$po_id]['composition'],0,20);?></td>
                                        <?
                                        $itemName = "";
                                        $itemIdArr = explode(",", $val['item']);
                                        $counter = 1;
                                        foreach ($itemIdArr as $row) 
                                        {
                                            if($counter==2){$itemName .= "<br>";$counter=0;}
                                            $itemName .= $garments_item[$row].",";
                                            $counter++;
                                        }?>                                    
                                        <td title="<? echo chop($itemName,',');?>"> 
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','sample_production_popup')">  
                                                <? echo substr(chop($itemName,','),0,10);?>
                                            </a>
                                          
                                        </td>
                                        <!-- <td align="right">
                                            <a href="javascript:void()" onclick="open_cost_report2_from_budget('<? echo $company_id;?>','<? //echo $val['job_no'];?>','<? //echo $val['buyer'];?>')">
                                                <? //echo fn_number_format($val['qty'],0); ?>
                                            </a>
                                        </td> -->
                                        <td align="right">
                                            <a href="javascript:void()" onclick="open_actual_po_popup('<? echo $val['job_no'];?>','<? echo $po_id;?>','<? echo $val['int_ref'];?>')">
                                                <? echo fn_number_format($val['qty'],0); ?>
                                            </a>
                                        </td>

                                        <td>
                                            <!-- <a href="javascript:void()" onclick="garments_popup('<? echo $po_id;?>','sample_approval_popup')">   -->
                                                <? echo $buyer_short_name_arr[$val['buyer']];?>
                                            <!-- </a>                                 -->
                                        </td>
                                        <td>
                                            <!-- <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','sample_fabric_popup')">   -->
                                                <? echo $dealing_merchant_array[$val['merchant']];?>
                                            <!-- </a>                                  -->
                                        </td>
                                        <td>
                                            <!-- <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','sample_production_popup')">   -->
                                                <? echo $location_library[$val['location']];?>
                                            <!-- </a>                                  -->
                                        </td>
                                        <td align="center"><? echo fn_number_format($val['days'],0); ?></td>
                                        <td><a href="javascript:void()" onclick="operation_bulletin_popup('<? echo $val['style'];?>')"><? echo $val['smv'];?></a></td>

                                        <td align="center">
                                            <a href="javascript:void()" onclick="garments_popup('<? echo $po_id;?>','labdip_approval_popup')">  
                                                <? echo fn_number_format($totPoColor,0); ?>
                                            </a>                                
                                        </td>
                                        <td align="center"><? echo fn_number_format($labDipColorSub,0); ?></td>
                                        <td align="center"><? echo change_date_format_new($lbdpSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($lbdpSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($lbdpSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($lbdpSbAcEndDate);?></td>
                                        <td align="right"><? echo ($lbdpSbBackLog >0) ? fn_number_format($lbdpSbBackLog,0) : 0; ?></td>
                                        <td align="right"><? echo fn_number_format($lbdpSbBal,0); ?></td>
                                        
                                        <td align="center"><? echo fn_number_format($labDipColorApp,0); ?></td>
                                        <td align="center"><? echo change_date_format_new($lbdpApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($lbdpApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($lbdpApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($lbdpApAcEndDate);?></td>
                                        <td align="right"><? echo ($lbdpApBackLog >0) ? fn_number_format($lbdpApBackLog,0) : 0 ; ?></td>
                                        <td align="right"><? echo fn_number_format($lbdpApBal,0); ?></td>

                                        <td align="center"><? echo change_date_format_new($smsSmpleSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($smsSmpleSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($smsSmpleSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($smsSmpleSbAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($smsSmpleApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($smsSmpleApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($smsSmpleApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($smsSmpleApAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($aopStOfSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($aopStOfSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($aopStOfSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($aopStOfSbAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($aopStOfApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($aopStOfApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($aopStOfApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($aopStOfApAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($stylingSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($stylingSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($stylingSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($stylingSbAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($stylingApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($stylingApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($stylingApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($stylingApAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($sizeSetSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($sizeSetSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($sizeSetSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($sizeSetSbAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($sizeSetApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($sizeSetApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($sizeSetApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($sizeSetApAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($wareTrialSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($wareTrialSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($wareTrialSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($wareTrialSbAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($wareTrialApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($wareTrialApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($wareTrialApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($wareTrialApAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($bulkFabBrSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($bulkFabBrSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($bulkFabBrSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($bulkFabBrSbAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($bulkFabBrApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($bulkFabBrApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($bulkFabBrApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($bulkFabBrApAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($bulkFabLbSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($bulkFabLbSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($bulkFabLbSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($bulkFabLbSbAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($bulkFabLbApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($bulkFabLbApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($bulkFabLbApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($bulkFabLbApAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($knitDwnSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($knitDwnSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($knitDwnSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($knitDwnSbAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($knitDwnApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($knitDwnApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($knitDwnApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($knitDwnApAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($prntStOfSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($prntStOfSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($prntStOfSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($prntStOfSbAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($prntStOfApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($prntStOfApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($prntStOfApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($prntStOfApAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($embStOfSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($embStOfSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($embStOfSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($embStOfSbAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($embStOfApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($embStOfApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($embStOfApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($embStOfApAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($ppSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($ppSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($ppSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($ppSbAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($ppApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($ppApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($ppApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($ppApAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($trimsCardSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($trimsCardSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($trimsCardSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($trimsCardSbAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($trimsCardApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($trimsCardApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($trimsCardApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($trimsCardApAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($topSmBrSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($topSmBrSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($topSmBrSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($topSmBrSbAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($topSmBrApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($topSmBrApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($topSmBrApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($topSmBrApAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($topSmLbSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($topSmLbSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($topSmLbSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($topSmLbSbAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($topSmLbApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($topSmLbApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($topSmLbApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($topSmLbApAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($mockUpSbStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($mockUpSbEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($mockUpSbAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($mockUpSbAcEndDate);?></td>

                                        <td align="center"><? echo change_date_format_new($mockUpApStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($mockUpApEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($mockUpApAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($mockUpApAcEndDate);?></td>

                                        <td align="right" title="<? echo $tot_booking_item; ?>/<? echo $tot_item;?>*100">
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','acc_booking_popup')">
                                                 <? echo fn_number_format($accBookingPrsnt,2); ?>%
                                            </a>                                
                                        </td>
                                        <td align="right"><? echo change_date_format_new($accBkStDate); ?></td>
                                        <td align="right"><? echo change_date_format_new($accBkEndDate); ?></td>
                                        <td align="right"><? echo change_date_format_new($accAcBkStDate); ?></td>
                                        <td align="right"><? echo change_date_format_new($accAcBkEndDate); ?></td>
                                        <td align="right"><? echo ($accBacklog >0) ? fn_number_format($accBacklog,0) : 0; ?>%</td>

                                        <td align="center"><? echo change_date_format_new($bookStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($bookEndDate);?></td>
                                        <td align="center"><? echo change_date_format_new($bookAcStDate);?></td>
                                        <td align="center"><? echo change_date_format_new($bookAcEndDate);?></td>
                                        <td align="right"><? echo ($bookingBackLog >0) ? fn_number_format($bookingBackLog,0) : 0 ; ?></td>
                                        <td align="right" title="<? echo "Req. Qty=".$tot_finfab_req_qty." Booking Qty=".$bookingQty; ?>"><? $bookingBal = $tot_finfab_req_qty-$bookingQty;echo ($bookingBal>0) ? fn_number_format($bookingBal,0) : 0; ?></td>

                                        <td align="right"><? echo fn_number_format($yarnReqQty,0); ?></td>
                                        <td align="right"><? echo fn_number_format($yarn_excess_qty); ?></td>
                                        <td align="right">                                
                                            <a href="javascript:void()" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val['job_no']]);?>','yarn_allocatio_popup')">
                                                <? echo fn_number_format($yarnAlloQty,0); ?>
                                            </a>
                                        </td>
                                        <td align="center"><? echo change_date_format_new($yarntnaStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($yarntnaEndDate); ?></td>
                                        <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][48]['all_plan_qty'];?>">
                                            <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**48";?>','plan_balance_popup')">
                                                <? echo fn_number_format($yarnPlanBal,0); ?>
                                            </a>
                                        </td>
                                        <td align="center"><? echo change_date_format_new($yarntnaAcStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($yarntnaAcEndDate); ?></td>
                                        <td align="right"><? echo ($yarnBackLog >0) ? fn_number_format($yarnBackLog,0) : 0 ;?></td>
                                        <td align="right"><? echo fn_number_format($yarnBal,0); ?></td>
                                        <!-- <td align="right"><? //echo fn_number_format($yarnIssueQty,2); ?></td>
                                        <td align="right"><? //echo fn_number_format($yarnStock,2); ?></td> -->

                                        <td align="right"> <? echo fn_number_format($yarnDyedReqQty,0); ?></td>
                                        <td align="right" title="check by helal">
                                            <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val['job_no']]);?>','dyed_yarn_req_popup')">
                                                <? echo fn_number_format($yarn_dyed_qty,0); ?>
                                            </a>
                                        </td>
                                        <td align="center"><? echo change_date_format_new($ydtnaStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($ydtnaEndDate); ?></td>
                                        <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][52]['all_plan_qty'];?>">
                                            <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**52";?>','plan_balance_popup')">
                                                <? echo fn_number_format($yarnDyedPlanBal,0); ?>
                                            </a>
                                        </td>
                                        <td align="center"><? echo change_date_format_new($ydtnaAcStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($ydtnaAcEndDate); ?></td>
                                        <td align="center"><? echo fn_number_format($ydLstRcv,0); ?></td>
                                        <td align="right"><? echo ($ydBackLog >0) ? fn_number_format($ydBackLog,0) : 0 ;?></td>
                                        <td align="right"><? echo fn_number_format($ydBal,0); ?></td>
                                        <td align="right"><? echo fn_number_format($ydIssueQty,0); ?></td>
                                        <td align="right"><? echo fn_number_format($ydSndBal,0); ?></td>

                                        <td align="right"><? echo fn_number_format($fabGreyReg,0); ?></td>
                                        <td align="right"><? echo fn_number_format($grey_fab_excess_qty,0); ?></td>
                                        <td align="right"><a href="##" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','grey_popup')"><? echo fn_number_format($greyRcv,0); ?></a></td>
                                        <td align="right"><? echo fn_number_format($grey_trans_in,0); ?></td>
                                        <td align="right"><? echo fn_number_format($grey_trans_out,0); ?></td>
                                        <td align="center"><? echo change_date_format_new($greyStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($greyEndDate); ?></td>
                                        <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][60]['all_plan_qty'];?>">
                                            <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**60";?>','plan_balance_popup')">
                                                <? echo fn_number_format($greyFabPlanBal,0); ?>
                                            </a>
                                        </td>
                                        <td align="center"><? echo change_date_format_new($greyAcStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($greyAcEndDate); ?></td>
                                        <td align="center"><? echo fn_number_format($greyLstRcv,0); ?></td>
                                        <td align="right"><? echo ($greyBackLog >0) ? fn_number_format($greyBackLog,0) : 0 ;?></td>
                                        <td align="right"><? echo fn_number_format($greyBal,0); ?></td>
                                        <td align="right"><? echo fn_number_format($progQty,0); ?></td>
                                        <td align="right"><? echo fn_number_format($progBalQty,0); ?></td>
                                        <td align="right" title="Issue Qty=<?=$yarnIssueQty;?>,Rtn Qty=<?=$yarnIssueRtnQtyArr[$po_id]['issue_return'];?>,Rej Qty=<?=$yarnIssueRtnQtyArr[$po_id]['reject_qty'];?>">
                                            <? echo fn_number_format($yrnSndtoFact,0); ?>
                                                
                                            </td>
                                        <td align="right"><? echo fn_number_format($yrnSndBal,0); ?></td>

                                        <td align="right" title="<?= "Budget=".fn_number_format($fabGreyReg,0)."kg, Excess = ".fn_number_format($grey_fab_excess_qty,0);?>kg"><? echo fn_number_format($fabDyeingReq,0); ?></td>
                                        <td align="right" title="Inhouse=<?=$dyeingProdArr[$po_id]['in'].'kg,Outbound='.$dyeingProdArr[$po_id]['out'];?>kg">
                                            <? echo fn_number_format($dyeingRcv,0); ?>
                                        </td>
                                        <td align="center"><? echo change_date_format_new($dyeingStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($dyeingEndDate); ?></td>
                                        <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][61]['all_plan_qty'];?>">
                                            <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**61";?>','plan_balance_popup')">
                                                <? echo fn_number_format($fabDyePlanBal,0); ?>
                                            </a>
                                        </td>
                                        <td align="center"><? echo change_date_format_new($dyeingAcStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($dyeingAcEndDate); ?></td>
                                        <td align="center"><? echo fn_number_format($lstDyeingRcv,0); ?></td>
                                        <td align="right"><? echo ($dyeingBackLog >0) ? fn_number_format($dyeingBackLog,0) : 0 ;?></td>
                                        <td align="right"><? echo fn_number_format($dyeingBal,0); ?></td>
                                        <td align="right" title="Inhouse=<?=$batchQtyArr[$po_id]['qty'].',Outbound='.$dyeingProdArr[$po_id]['out'];?>">                                
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','batch_popup')">
                                                <? echo fn_number_format($batchQty,0); ?>
                                            </a>
                                        </td>
                                        <td title="(Primary Grey Req + Excess Grey) - Batch Qty" align="right"><? echo fn_number_format($batchBal,0); ?></td>
                                        <td title="Grey Rcv - Batch Qty" align="right"><? echo fn_number_format($redyToBatch,0); ?></td>

                                        <td align="right" title="<?= "Budget=".$aop_Req.", Excess=".$color_type_wise_booking_qty_array[$po_id][5];?>">
                                            <? echo fn_number_format($aopReq,0); ?>                                        
                                        </td>
                                        <td align="right"><a href="##" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','aop_popup')"><? echo fn_number_format($aopRcv,0); ?></a></td>
                                        <td align="center"><? echo change_date_format_new($aopStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($aopEndDate); ?></td>
                                        <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][63]['all_plan_qty'];?>">
                                            <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**63";?>','plan_balance_popup')">
                                                <? echo fn_number_format($aopPlanBal,0); ?>
                                            </a>
                                        </td>
                                        <td align="center"><? echo change_date_format_new($aopAcStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($aopAcEndDate); ?></td>
                                        <td align="center"><? echo fn_number_format($aopLstRcv,0); ?></td>
                                        <td align="right"><? echo ($aopBackLog >0) ? fn_number_format($aopBackLog,0) : 0 ;?></td>
                                        <td align="right"><? echo fn_number_format($aopBal); ?></td>
                                        <td align="right"><? echo fn_number_format($aopIssueQty,0); ?></td>
                                        <td align="right"><? echo fn_number_format($aopFbSndBal,0); ?></td>

                                        <td align="right">
                                            <a href="##" onclick="garments_popup('<? echo $val['job_no']."__".implode(",", $jobWisePoArray[$val['job_no']]);?>','finish_fab_popup')">
                                                <? echo fn_number_format(($fabfinishReg+$fabfinishPurReg),0); ?>
                                            </a>
                                        </td>
                                        <td align="right"><? echo fn_number_format($fin_fab_excess_qty,0); ?></td>
                                        <td align="right"><? echo fn_number_format($finFabTrnsIn,0); ?></td>
                                        <td align="right"><? echo fn_number_format($finFabTrnsOut,0); ?></td>
                                        <td align="right"><? echo fn_number_format($a,0); ?></td>
                                        <td align="right" title="Inhouse=<?=$gmtStrTrnsIn2+$gmtStrRcv2-$finFabOutProd;?>,purchase=<?=$finFab_purchase_qty;?>,Outbound=<?=$finFabOutProd;?>">
                                            <a href="##" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','finish_popup')"><? echo fn_number_format($fin_rcv_qnty2,0);//$finishRcv ?></a>
                                        </td>
                                        <td align="center"><? echo change_date_format_new($fabFinStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($fabFinEndDate); ?></td>
                                        <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][73]['all_plan_qty'];?>">
                                            <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**73";?>','plan_balance_popup')">
                                                <? echo fn_number_format($finFabPlanBal,0); ?>
                                            </a>
                                        </td>
                                        <td align="center"><? echo change_date_format_new($fabFinAcStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($fabFinAcEndDate); ?></td>
                                        <td align="center"><? echo fn_number_format($finishLstRcv,0); ?></td>
                                        <td align="right"><? echo ($finishBackLog >0) ? fn_number_format($finishBackLog,0) : 0; ?></td>
                                        <td align="right"><? echo ($finishBackLogPur >0) ? fn_number_format($finishBackLogPur,0) : 0; ?></td>
                                        <td align="right"><? echo fn_number_format($finishFabBal,0); ?></td>
                                        <td align="right"><? echo fn_number_format($issueToCut,0); ?></td>
                                        <td align="right"><? echo fn_number_format($dyeStock,0); ?></td>
                                        <td align="right"><? echo fn_number_format($gmtStock,0); ?></td>                           
                                        <td align="right">
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','garments_popup')">
                                                <? echo fn_number_format($layQty,0); ?>
                                            </a> 
                                        </td>
                                        <td align="right"><? echo fn_number_format($qcRejQty,0); ?></td>
                                        <td align="right"><? echo fn_number_format($qcRplsQty,0); ?></td>
                                        <td align="right"><? echo fn_number_format($qcQty,0); ?></td>
                                        <td align="center"><? echo change_date_format_new($cuttStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($cuttEndDate); ?></td>
                                        <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][84]['all_plan_qty'];?>">
                                            <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**84";?>','plan_balance_popup')">
                                                <? echo fn_number_format($cuttingPlanBal,0); ?>
                                            </a>
                                        </td>
                                        <td align="center"><? echo change_date_format_new($cuttAcStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($cuttAcEndDate); ?></td>
                                        <td align="center"><? echo fn_number_format($lstQcQty,0); ?></td>
                                        <td align="right"><? echo ($qcBackLog >0) ? fn_number_format($qcBackLog,0) : 0;?></td>
                                        <td align="right"><? echo fn_number_format($cutBal,0); ?></td>



                                        <td align="right"><? echo fn_number_format($printReq,0); ?></td>
                                        <td align="right"><? echo fn_number_format($printRejQty,0); ?></td>
                                        <td align="right">
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','garments_print_popup')">
                                                <? echo fn_number_format($printQty,0); ?>
                                            </a>                                  
                                        </td>
                                        <td align="center"><? echo change_date_format_new($printStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($printEndDate); ?></td>
                                        <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][267]['all_plan_qty'];?>">
                                            <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**267";?>','plan_balance_popup')">
                                                <? echo fn_number_format($printPlanBal,0); ?>
                                            </a>
                                        </td>
                                        <td align="center"><? echo change_date_format_new($printAcStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($printAcEndDate); ?></td>
                                        <td align="right"><? echo fn_number_format($lstPrntQty,0); ?></td>
                                        <td align="right"><? echo ($printBackLog >0) ? fn_number_format($printBackLog,0) : 0;?></td>
                                        <td align="right"><? echo fn_number_format($printBal,0); ?></td>
                                        <td align="right"><? echo fn_number_format($printIssQty,0); ?></td>
                                        <td align="right"><? echo fn_number_format($prntSndBal,0); ?></td>

                                        <td align="right"><? echo fn_number_format($embReq,0); ?></td>
                                        <td align="right"><? echo fn_number_format($embRejQty,0); ?></td>
                                        <td align="right">
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','garments_emb_popup')">
                                                <? echo fn_number_format($embQty,0); ?>
                                            </a>                                 
                                        </td>
                                        <td align="center"><? echo change_date_format_new($embStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($embEndDate); ?></td>
                                        <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][268]['all_plan_qty'];?>">
                                            <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**268";?>','plan_balance_popup')">
                                                <? echo fn_number_format($embPlanBal,0); ?>
                                            </a>
                                        </td>
                                        <td align="center"><? echo change_date_format_new($embAcStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($embAcEndDate); ?></td>
                                        <td align="right"><? echo fn_number_format($lstEmbQty,0); ?></td>
                                        <td align="right"><? echo ($embBackLog >0) ? fn_number_format($embBackLog,0) : 0;?></td>
                                        <td align="right"><? echo fn_number_format($embBal,0); ?></td>
                                        <td align="right"><? echo fn_number_format($embIssueQty); ?></td>
                                        <td align="right"><? echo fn_number_format($embSndBal); ?></td>

                                        <td align="right" title="<? echo $sewTrimsQty; ?>/<? echo $sewTrimsReq;?>*100">
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','acc_booking_popup')">
                                                 <? echo fn_number_format($sewTrimsPrsnt,2); ?>%
                                            </a>                                
                                        </td>
                                        <td align="right"><? echo change_date_format_new($sewTrimsStDate); ?></td>
                                        <td align="right"><? echo change_date_format_new($sewTrimsEndDate); ?></td>
                                        <td align="right"><? echo fn_number_format($planBal,0); ?></td>
                                        <td align="right"><? echo change_date_format_new($sewTrimsAcStDate); ?></td>
                                        <td align="right"><? echo change_date_format_new($sewTrimsAcEndDate); ?></td>
                                        <td align="right"><? echo ($sewTrmBacklog >0) ? fn_number_format($sewTrmBacklog,0) : 0; ?></td>

                                        <td align="right" title="<? echo $finTrimsQty; ?>/<? echo $finTrimsReq;?>*100">
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','acc_booking_popup')">
                                                 <? echo fn_number_format($finTrimsPrsnt,2); ?>%
                                            </a>                                
                                        </td>
                                        <td align="right"><? echo change_date_format_new($finTrimsStDate); ?></td>
                                        <td align="right"><? echo change_date_format_new($finTrimsEndDate); ?></td>
                                        <td align="right"><? echo fn_number_format($planBal,0); ?></td>
                                        <td align="right"><? echo change_date_format_new($finTrimsAcStDate); ?></td>
                                        <td align="right"><? echo change_date_format_new($finTrimsAcEndDate); ?></td>
                                        <td align="right"><? echo ($finTrmBacklog >0) ? fn_number_format($finTrmBacklog,0) : 0; ?></td>

                                        <td align="right"><? echo fn_number_format($inputQty,0); ?></td>
                                        <td align="right"><? echo fn_number_format($plan_input_bal,0); ?></td>
                                        <td align="right"><? echo fn_number_format($rejectQty,0); ?></td>
                                        <td align="right"><? echo fn_number_format($replaceQty,0); ?></td>
                                        <td align="right"><? echo fn_number_format($okOutQty,0); ?></td>                           
                                        <td align="right">
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','garments_popup')">
                                                <? echo fn_number_format($totSewQty,0); ?>
                                            </a> 
                                        </td>
                                        <td align="center"><? echo change_date_format_new($inputStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($inputEndDate); ?></td>
                                        <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][86]['all_plan_qty'];?>">
                                            <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**86";?>','plan_balance_popup')">
                                                <? echo fn_number_format($sewFinPlanBal,0); ?>
                                            </a>
                                        </td>
                                        <td align="center"><? echo change_date_format_new($inputAcStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($inputAcEndDate); ?></td>
                                        <td align="right"><? echo fn_number_format($lstOutputQty,0); ?></td>
                                        <td align="right"><? echo ($sewFinBackLog >0) ? fn_number_format($sewFinBackLog,0) : 0; ?></td>
                                        <td align="right"><? echo ($sewingWIP >0) ? fn_number_format($sewingWIP,0) : 0; ?></td>
                                        <td align="right"><? echo fn_number_format($sewingBAL,0); ?></td>

                                        <td align="right"><? echo fn_number_format($washReq); ?></td>
                                        <td align="right"><? echo fn_number_format($washRejQty); ?></td>
                                        <td align="right">
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','garments_wash_popup')">
                                                <? echo fn_number_format($washQty,0); ?>
                                            </a> 
                                        </td>
                                        <td align="right"><? echo change_date_format_new($washStDate); ?></td>
                                        <td align="right"><? echo change_date_format_new($washEndDate); ?></td>
                                        <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][90]['all_plan_qty'];?>">
                                            <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**90";?>','plan_balance_popup')">
                                                <? echo fn_number_format($washPlanBal,0); ?>
                                            </a>
                                        </td>
                                        <td align="right"><? echo change_date_format_new($washAcStDate); ?></td>
                                        <td align="right"><? echo change_date_format_new($washAcEndDate); ?></td>
                                        <td align="right"><? echo fn_number_format($lstWashQty,0); ?></td>
                                        <td align="right"><? echo ($washBackLog >0) ? fn_number_format($washBackLog,0) : 0;?></td>
                                        <td align="right"><? echo fn_number_format($washBal); ?></td>
                                        <td align="right"><? echo fn_number_format($washIssueQty,0); ?></td>
                                        <td align="right"><? echo fn_number_format($sendBal,0); ?></td>
                                                                  
                                        <td align="right">
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','garments_popup')">
                                                <? echo fn_number_format($finishQty,0); ?>
                                            </a> 
                                        </td>
                                        <td align="right"><? echo fn_number_format($finRejQty); ?></td>
                                        <td align="center"><? echo change_date_format_new($finishStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($finishEndDate); ?></td>
                                        <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][88]['all_plan_qty'];?>">
                                            <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**88";?>','plan_balance_popup')">
                                                <? echo fn_number_format($gmtFinPlanBal,0); ?>
                                            </a>
                                        </td>
                                        <td align="center"><? echo change_date_format_new($finishAcStDate); ?></td>
                                        <td align="center"><? echo change_date_format_new($finishAcEndDate); ?></td>
                                        <td align="right"><? echo fn_number_format($finishWIP); ?></td>
                                        <td align="right"><? echo ($gmtFinBackLog >0) ? fn_number_format($gmtFinBackLog,0) : 0;?></td>
                                        <td align="right"><? echo fn_number_format($gmtFinBal); ?></td>
                                        <td align="right"><? echo fn_number_format($lstFinishQty);?></td>
                                                                   
                                        <td align="right">
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','exfactory_popup')">
                                                <? echo fn_number_format($exfactoryQty,0); ?>
                                            </a> 
                                        </td>
                                        <td align="right"><? echo fn_number_format($exfactoryWIP); ?></td>
                                        <td align="right"><? echo (count($exDateArray)>0) ? date('d-M-Y',(min($exDateArray))) : ""; ?></td>
                                        <td align="right"><? echo (count($exDateArray)>0) ? date('d-M-Y',(max($exDateArray))) : ""; ?></td>
                                        <td align="right"><? echo fn_number_format($exfactoryLstQty); ?></td>
                                        <td align="right"><? echo ($shiping_backlog >0) ? fn_number_format($shiping_backlog,0) : 0;?></td>
                                        <td align="right">
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','exfactory_popup_acct_po')">
                                                <? echo fn_number_format($exBal,0); ?>
                                            </a> 
                                        </td>
                                    </tr>
                                    <?
                                    $i++;
                                    $total_po_qty       += $val['qty'];
                                    $total_book_qty     += $bookingQty;
                                    if($bookingBal>0)
                                    {
                                        $total_book_bal     += $bookingBal;
                                    }
                                    if($bookingBackLog>0)
                                    {
                                        $total_book_bklg    += $bookingBackLog;
                                    }

                                    $total_yarn_req     += fn_number_format($yarnReqQty,4,".","");
                                    $total_yarn_exs     += $yarn_excess_qty;
                                    $total_yarn_allo    += $yarnAlloQty;
                                    $total_yarn_bklog   += ($yarnBackLog>0) ? $yarnBackLog : 0;
                                    $total_yarn_allo_bal+= $yarnBal;
                                    $total_yarn_allo_plan_bal += $yarnPlanBal;

                                    $total_yarn_dyed_req+= $yarnDyedReqQty;
                                    $total_yarn_dyed_rcv+= fn_number_format($yarn_dyed_qty,4,".","");
                                    $total_yarn_dyed_bklog+= ($ydBackLog>0) ? $ydBackLog : 0;
                                    $total_yarn_dyed_bal+= $ydBal;                            
                                    $total_yarn_dyed_plan_bal += $yarnDyedPlanBal;                              
                                    $total_lst_day_yarn = $ydLstRcv;
                                    $total_yarn_snd_to_fact = $ydIssueQty;
                                    $total_yarn_snd_bal = fn_number_format($ydSndBal,4,".","");

                                    $total_grey_req     += $fabGreyReg;
                                    $total_grey_exs     += $grey_fab_excess_qty;
                                    $total_grey_rcv     += $greyRcv;
                                    $total_grey_in      += $grey_trans_in;
                                    $total_grey_out     += $grey_trans_out;
                                    $total_grey_bklog   += ($greyBackLog>0) ? $greyBackLog : 0;
                                    $total_grey_bal     += $greyBal;                              
                                    $total_grey_plan_bal     += $greyFabPlanBal;                             
                                    $total_grey_lst_day_prod += $greyLstRcv;
                                    $total_grey_prog_qty += $progQty;
                                    $total_grey_prog_bal += $progBalQty;
                                    $total_yrn_snd_to_fact+= $yrnSndtoFact;
                                    $total_yarn_snd_bal+= fn_number_format($yrnSndBal,4,".","");

                                    $total_dye_req      += $fabDyeingReq;
                                    $total_dye_rcv      += $dyeingRcv;
                                    $total_dye_bklog    += ($dyeingBackLog>0) ? $dyeingBackLog : 0;
                                    $total_dye_bal      += $dyeingBal;                             
                                    $total_dye_plan_bal   += $fabDyePlanBal;                           
                                    $total_lst_day_prod_dye += $lstDyeingRcv;
                                    $total_dye_batch    += $batchQty;
                                    $total_dye_batch_bal += $batchBal;
                                    $total_dye_redy_to_batch += $redyToBatch;

                                    $total_aop_req      += $aopReq;
                                    $total_aop_rcv      += $aopRcv;
                                    $total_aop_bklog    += ($aopBackLog>0) ? $aopBackLog : 0;
                                    $total_aop_bal      += $aopBal;                             
                                    $total_aop_plan_bal      += $aopPlanBal;                           
                                    $total_lst_day_aop  += $aopLstRcv;
                                    $total_aop_sen_to_fact+= $aopIssueQty;
                                    $total_aop_send_bal += $aopFbSndBal;

                                    $total_fin_fab_req  += $fabfinishReg+$fabfinishPurReg;
                                    $total_fin_fab_exs  += $fin_fab_excess_qty;
                                    $total_fin_fab_rcv  += $fin_rcv_qnty2;
                                    $total_fin_fab_bklog+= ($finishBackLog>0) ? $finishBackLog : 0;
                                    $total_fin_fab_bklog_pur+= ($finishBackLogPur>0) ? $finishBackLogPur : 0;
                                    $total_fin_fab_bal  += $finishFabBal;
                                    $total_fin_fab_plan_bal  += $finFabPlanBal;
                                    $total_stk_gmt_store  += $gmtStock;
                                    $total_stk_fin_store  += $dyeStock;
                                    $total_lst_day_rcv_fin_fab  += $finishLstRcv;
                                    $total_trns_in_fin_fab  += $finFabTrnsIn;
                                    $total_trns_out_fin_fab  += $finFabTrnsOut;
                                    $total_rej_fin_fab  += 0;

                                    $total_issue_to_cut += $issueToCut;
                                    $total_lay_qty      += $layQty;
                                    $total_lay_qc_qty   += $qcQty;
                                    $total_lay_rej_qty  += $qcRejQty;
                                    $total_cut_bklog    += ($qcBackLog>0) ? $qcBackLog : 0;
                                    $total_cut_bal      += $cutBal;
                                    $total_lst_day_cut_qc+= $lstQcQty;

                                    $total_print_req    += $printReq;
                                    $total_print_rcv    += $printQty;
                                    $total_print_rej    += $printRejQty;
                                    $total_print_bklog  += ($printBackLog>0) ? $printBackLog : 0;
                                    $total_print_bal    += $printBal;
                                    $total_print_plan_bal  += $printPlanBal;
                                    $total_print_snd_bal  += $prntSndBal;
                                    $total_cut_panel_del_print+= $printIssQty;
                                    $total_lst_day_print+= $lstPrntQty;

                                    $total_emb_req      += $embReq;
                                    $total_emb_rcv      += $embQty;
                                    $total_emb_rej      += $embRejQty;
                                    $total_emb_bklog    += ($embBackLog>0) ? $embBackLog : 0;
                                    $total_emb_bal      += $embBal;
                                    $total_emb_plan_bal      += $embPlanBal;
                                    $total_emb_snd_bal  += $embSndBal;
                                    $total_cut_panel_del+= $embIssueQty;
                                    $total_lst_day_emb+= $lstEmbQty;

                                    $total_sew_trim_rcv += $sewTrimsQty;
                                    $total_sew_trim_bklg += $sewTrmBacklog;
                                    $total_fin_trim_rcv += $finTrimsQty;
                                    $total_fin_trim_bklg += ($finTrmBacklog>0) ? $finTrmBacklog : 0;

                                    $total_input_qty    += $inputQty;
                                    $total_plan_input_qty+= $plan_input_bal;
                                    $total_rej_qty      += $rejectQty;
                                    $total_ok_out_qty   += $outputQty;
                                    $total_out_qty      += $totSewQty;
                                    if($sewFinBackLog>0){
                                    $total_sew_bklog    += $sewFinBackLog;
                                    }
                                    $total_out_wip      += $sewingWIP;
                                    $total_out_bal      += $sewingBAL;                                
                                    $total_out_plan_bal += $sewFinPlanBal;                       
                                    $total_lst_day_sew  += $lstOutputQty;
                                    $total_sew_rpls     += $replaceQty;

                                    $total_wash_req     += $washReq;
                                    $total_wash_rej     += $washRejQty;
                                    $total_wash_rcv     += $washQty;
                                    $total_wash_bklog   += ($washBackLog>0) ? $washBackLog : 0;
                                    $total_wash_bal     += $washBal;
                                    $total_wash_plan_bal     += $washPlanBal;
                                    $total_send_wash    += $washIssueQty;
                                    $total_send_bal     += $sendBal;
                                    $total_lst_day_wash += $lstWashQty;

                                    $total_finish_qty   += $finishQty;
                                    $total_fin_rej_qty  += $finRejQty;
                                    $total_finish_wip   += $finishWIP;
                                    $total_finish_bal   += $finishBal;
                                    $total_finish_plan_bal   += $gmtFinPlanBal;
                                    $total_lst_fin_qty  += $lstFinishQty;
                                    $total_fin_bklog_qty+= ($gmtFinBackLog>0) ? $gmtFinBackLog: 0;

                                    $total_shipment_qty += $exfactoryQty;
                                    $total_shipment_wip += $exfactoryWIP;
                                    $total_shipment_bklog+= ($shiping_backlog>0) ? $shiping_backlog : 0;
                                    $total_lst_ship_qty+= $exfactoryLstQty;
                                    $total_shipment_bal += $exBal;
                                }
                            }
                            else
                            {
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>
                                <tr class="GridViewScrollItem" bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                    <td><? echo $i;?></td>
                                    <td>
                                        <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','production_calendar_popup')">                             
                                            <? echo $val['int_ref'];?>
                                        </a>   
                                    </td>
                                    <td title="<? echo $val['style'];?>">

                                        <a href="javascript:void()" onclick="garments_popup('<? echo $po_id;?>','sample_approval_popup')">  
                                            <? echo strlen($val['style'])>10 ? substr($val['style'], 0, 10) : $val['style'];?>
                                        </a>                                    
                                    </td>
                                    <td>
                                        <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','sample_fabric_popup')">  
                                            <? echo change_date_format($val['orig_ship_date']); ?>
                                        </a>
                                        
                                    </td>
                                    <td title="<? echo $val['po_no'];?>">
                                        <a href="javascript:void()" onclick="garments_popup('<? echo $po_id;?>','plan_monitoring_popup')">  
                                            <? echo substr($val['po_no'],0,10);?>
                                        </a>
                                    </td>
                                        <td>
                                            <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','tna_calendar_popup')"> 
                                                <?=$client_array[$val['client']];?>
                                            </a>
                                        </td>
                                    <td title="<? echo $bookingFabInfoArray[$po_id]['construction'];?>">
                                        <a href="javascript:void()" onclick="open_fab_stucture_popup('<? echo $po_id;?>','<? echo $val['int_ref'];?>','<? echo $client;?>','<? echo $val['style'];?>')"> 
                                            <? 
                                                echo ($bookingFabInfoArray[$po_id]['construction'] !="") ? substr($bookingFabInfoArray[$po_id]['construction'],0,10) : "View";
                                            ?>
                                        </a>                                        
                                    </td>
                                    <td><? echo $bookingFabInfoArray[$po_id]['gsm'];?></td>
                                    <td title="<? echo $bookingFabInfoArray[$po_id]['composition'];?>"><? echo substr($bookingFabInfoArray[$po_id]['composition'],0,20);?></td>
                                    <?
                                    $itemName = "";
                                    $itemIdArr = explode(",", $val['item']);
                                    $counter = 1;
                                    foreach ($itemIdArr as $row) 
                                    {
                                        if($counter==2){$itemName .= "<br>";$counter=0;}
                                        $itemName .= $garments_item[$row].",";
                                        $counter++;
                                    }?>                                    
                                    <td title="<? echo chop($itemName,',');?>"> 
                                        <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','sample_production_popup')">  
                                            <? echo substr(chop($itemName,','),0,10);?>
                                        </a>
                                      
                                    </td>
                                    <!-- <td align="right">
                                        <a href="javascript:void()" onclick="open_cost_report2_from_budget('<? echo $company_id;?>','<? //echo $val['job_no'];?>','<? //echo $val['buyer'];?>')">
                                            <? //echo fn_number_format($val['qty'],0); ?>
                                        </a>
                                    </td> -->
                                    <td align="right">
                                        <a href="javascript:void()" onclick="open_actual_po_popup('<? echo $val['job_no'];?>','<? echo $po_id;?>','<? echo $val['int_ref'];?>')">
                                            <? echo fn_number_format($val['qty'],0); ?>
                                        </a>
                                    </td>

                                    <td>
                                        <!-- <a href="javascript:void()" onclick="garments_popup('<? echo $po_id;?>','sample_approval_popup')">   -->
                                            <? echo $buyer_short_name_arr[$val['buyer']];?>
                                        <!-- </a>                                 -->
                                    </td>
                                    <td>
                                        <!-- <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','sample_fabric_popup')">   -->
                                            <? echo $dealing_merchant_array[$val['merchant']];?>
                                        <!-- </a>                                  -->
                                    </td>
                                    <td>
                                        <!-- <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','sample_production_popup')">   -->
                                            <? echo $location_library[$val['location']];?>
                                        <!-- </a>                                  -->
                                    </td>
                                    <td align="center"><? echo fn_number_format($val['days'],0); ?></td>
                                    <td><a href="javascript:void()" onclick="operation_bulletin_popup('<? echo $val['style'];?>')"><? echo $val['smv'];?></a></td>

                                    <td align="center">
                                        <a href="javascript:void()" onclick="garments_popup('<? echo $po_id;?>','labdip_approval_popup')">  
                                            <? echo fn_number_format($totPoColor,0); ?>
                                        </a>                                
                                    </td>
                                    <td align="center"><? echo fn_number_format($labDipColorSub,0); ?></td>
                                    <td align="center"><? echo change_date_format_new($lbdpSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($lbdpSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($lbdpSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($lbdpSbAcEndDate);?></td>
                                    <td align="right"><? echo ($lbdpSbBackLog >0) ? fn_number_format($lbdpSbBackLog,0) : 0; ?></td>
                                    <td align="right"><? echo fn_number_format($lbdpSbBal,0); ?></td>
                                    
                                    <td align="center"><? echo fn_number_format($labDipColorApp,0); ?></td>
                                    <td align="center"><? echo change_date_format_new($lbdpApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($lbdpApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($lbdpApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($lbdpApAcEndDate);?></td>
                                    <td align="right"><? echo ($lbdpApBackLog >0) ? fn_number_format($lbdpApBackLog,0) : 0 ; ?></td>
                                    <td align="right"><? echo fn_number_format($lbdpApBal,0); ?></td>

                                    <td align="center"><? echo change_date_format_new($smsSmpleSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($smsSmpleSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($smsSmpleSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($smsSmpleSbAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($smsSmpleApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($smsSmpleApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($smsSmpleApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($smsSmpleApAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($aopStOfSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($aopStOfSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($aopStOfSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($aopStOfSbAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($aopStOfApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($aopStOfApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($aopStOfApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($aopStOfApAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($stylingSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($stylingSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($stylingSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($stylingSbAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($stylingApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($stylingApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($stylingApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($stylingApAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($sizeSetSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($sizeSetSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($sizeSetSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($sizeSetSbAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($sizeSetApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($sizeSetApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($sizeSetApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($sizeSetApAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($wareTrialSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($wareTrialSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($wareTrialSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($wareTrialSbAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($wareTrialApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($wareTrialApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($wareTrialApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($wareTrialApAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($bulkFabBrSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($bulkFabBrSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($bulkFabBrSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($bulkFabBrSbAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($bulkFabBrApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($bulkFabBrApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($bulkFabBrApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($bulkFabBrApAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($bulkFabLbSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($bulkFabLbSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($bulkFabLbSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($bulkFabLbSbAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($bulkFabLbApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($bulkFabLbApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($bulkFabLbApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($bulkFabLbApAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($knitDwnSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($knitDwnSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($knitDwnSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($knitDwnSbAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($knitDwnApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($knitDwnApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($knitDwnApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($knitDwnApAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($prntStOfSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($prntStOfSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($prntStOfSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($prntStOfSbAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($prntStOfApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($prntStOfApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($prntStOfApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($prntStOfApAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($embStOfSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($embStOfSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($embStOfSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($embStOfSbAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($embStOfApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($embStOfApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($embStOfApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($embStOfApAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($ppSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($ppSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($ppSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($ppSbAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($ppApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($ppApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($ppApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($ppApAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($trimsCardSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($trimsCardSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($trimsCardSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($trimsCardSbAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($trimsCardApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($trimsCardApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($trimsCardApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($trimsCardApAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($topSmBrSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($topSmBrSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($topSmBrSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($topSmBrSbAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($topSmBrApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($topSmBrApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($topSmBrApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($topSmBrApAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($topSmLbSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($topSmLbSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($topSmLbSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($topSmLbSbAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($topSmLbApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($topSmLbApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($topSmLbApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($topSmLbApAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($mockUpSbStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($mockUpSbEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($mockUpSbAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($mockUpSbAcEndDate);?></td>

                                    <td align="center"><? echo change_date_format_new($mockUpApStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($mockUpApEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($mockUpApAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($mockUpApAcEndDate);?></td>

                                    <td align="right" title="<? echo $tot_booking_item; ?>/<? echo $tot_item;?>*100">
                                        <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','acc_booking_popup')">
                                             <? echo fn_number_format($accBookingPrsnt,2); ?>%
                                        </a>                                
                                    </td>
                                    <td align="right"><? echo change_date_format_new($accBkStDate); ?></td>
                                    <td align="right"><? echo change_date_format_new($accBkEndDate); ?></td>
                                    <td align="right"><? echo change_date_format_new($accAcBkStDate); ?></td>
                                    <td align="right"><? echo change_date_format_new($accAcBkEndDate); ?></td>
                                    <td align="right"><? echo ($accBacklog >0) ? fn_number_format($accBacklog,0) : 0; ?>%</td>

                                    <td align="center"><? echo change_date_format_new($bookStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($bookEndDate);?></td>
                                    <td align="center"><? echo change_date_format_new($bookAcStDate);?></td>
                                    <td align="center"><? echo change_date_format_new($bookAcEndDate);?></td>
                                    <td align="right"><? echo ($bookingBackLog >0) ? fn_number_format($bookingBackLog,0) : 0 ; ?></td>
                                    <td align="right" title="<? echo "Req. Qty=".$tot_finfab_req_qty." Booking Qty=".$bookingQty; ?>"><? $bookingBal = $tot_finfab_req_qty-$bookingQty;echo ($bookingBal>0) ? fn_number_format($bookingBal,0) : 0; ?></td>

                                    <td align="right"><? echo fn_number_format($yarnReqQty,0); ?></td>
                                    <td align="right"><? echo fn_number_format($yarn_excess_qty); ?></td>
                                    <td align="right">                                
                                        <a href="javascript:void()" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val['job_no']]);?>','yarn_allocatio_popup')">
                                            <? echo fn_number_format($yarnAlloQty,0); ?>
                                        </a>
                                    </td>
                                    <td align="center"><? echo change_date_format_new($yarntnaStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($yarntnaEndDate); ?></td>
                                    <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][48]['all_plan_qty'];?>">
                                        <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**48";?>','plan_balance_popup')">
                                            <? echo fn_number_format($yarnPlanBal,0); ?>
                                        </a>
                                    </td>
                                    <td align="center"><? echo change_date_format_new($yarntnaAcStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($yarntnaAcEndDate); ?></td>
                                    <td align="right"><? echo ($yarnBackLog >0) ? fn_number_format($yarnBackLog,0) : 0 ;?></td>
                                    <td align="right"><? echo fn_number_format($yarnBal,0); ?></td>
                                    <!-- <td align="right"><? //echo fn_number_format($yarnIssueQty,2); ?></td>
                                    <td align="right"><? //echo fn_number_format($yarnStock,2); ?></td> -->

                                    <td align="right"> <? echo fn_number_format($yarnDyedReqQty,0); ?></td>
                                    <td align="right">
                                        <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val['job_no']]);?>','dyed_yarn_req_popup')">
                                            <? echo fn_number_format($yarn_dyed_qty,0); ?>
                                        </a>
                                    </td>
                                    <td align="center"><? echo change_date_format_new($ydtnaStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($ydtnaEndDate); ?></td>
                                    <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][52]['all_plan_qty'];?>">
                                        <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**52";?>','plan_balance_popup')">
                                            <? echo fn_number_format($yarnDyedPlanBal,0); ?>
                                        </a>
                                    </td>
                                    <td align="center"><? echo change_date_format_new($ydtnaAcStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($ydtnaAcEndDate); ?></td>
                                    <td align="center"><? echo fn_number_format($ydLstRcv,0); ?></td>
                                    <td align="right"><? echo ($ydBackLog >0) ? fn_number_format($ydBackLog,0) : 0 ;?></td>
                                    <td align="right"><? echo fn_number_format($ydBal,0); ?></td>
                                    <td align="right"><? echo fn_number_format($ydIssueQty,0); ?></td>
                                    <td align="right"><? echo fn_number_format($ydSndBal,0); ?></td>

                                    <td align="right"><? echo fn_number_format($fabGreyReg,0); ?></td>
                                    <td align="right"><? echo fn_number_format($grey_fab_excess_qty,0); ?></td>
                                    <td align="right"><a href="##" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','grey_popup')"><? echo fn_number_format($greyRcv,0); ?></a></td>
                                    <td align="right"><? echo fn_number_format($grey_trans_in,0); ?></td>
                                    <td align="right"><? echo fn_number_format($grey_trans_out,0); ?></td>
                                    <td align="center"><? echo change_date_format_new($greyStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($greyEndDate); ?></td>
                                    <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][60]['all_plan_qty'];?>">
                                        <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**60";?>','plan_balance_popup')">
                                            <? echo fn_number_format($greyFabPlanBal,0); ?>
                                        </a>
                                    </td>
                                    <td align="center"><? echo change_date_format_new($greyAcStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($greyAcEndDate); ?></td>
                                    <td align="center"><? echo fn_number_format($greyLstRcv,0); ?></td>
                                    <td align="right"><? echo ($greyBackLog >0) ? fn_number_format($greyBackLog,0) : 0 ;?></td>
                                    <td align="right"><? echo fn_number_format($greyBal,0); ?></td>
                                    <td align="right"><? echo fn_number_format($progQty,0); ?></td>
                                    <td align="right"><? echo fn_number_format($progBalQty,0); ?></td>
                                    <td align="right" title="Issue Qty=<?=$yarnIssueQty;?>,Rtn Qty=<?=$yarnIssueRtnQtyArr[$po_id]['issue_return'];?>,Rej Qty=<?=$yarnIssueRtnQtyArr[$po_id]['reject_qty'];?>">
                                        <? echo fn_number_format($yrnSndtoFact,0); ?>                                            
                                    </td>
                                    <td align="right"><? echo fn_number_format($yrnSndBal,0); ?></td>

                                    <td align="right" title="<?= "Budget=".fn_number_format($fabGreyReg,0)."kg, Excess = ".fn_number_format($grey_fab_excess_qty,0);?>kg"><? echo fn_number_format($fabDyeingReq,0); ?></td>
                                    <td align="right" title="Inhouse=<?=$dyeingProdArr[$po_id]['in'].'kg,Outbound='.$dyeingProdArr[$po_id]['out'];?>kg">
                                        <? echo fn_number_format($dyeingRcv,0); ?>
                                    </td>
                                    <td align="center"><? echo change_date_format_new($dyeingStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($dyeingEndDate); ?></td>
                                    <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][61]['all_plan_qty'];?>">
                                        <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**61";?>','plan_balance_popup')">
                                            <? echo fn_number_format($fabDyePlanBal,0); ?>
                                        </a>
                                    </td>
                                    <td align="center"><? echo change_date_format_new($dyeingAcStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($dyeingAcEndDate); ?></td>
                                    <td align="center"><? echo fn_number_format($lstDyeingRcv,0); ?></td>
                                    <td align="right"><? echo ($dyeingBackLog >0) ? fn_number_format($dyeingBackLog,0) : 0 ;?></td>
                                    <td align="right"><? echo fn_number_format($dyeingBal,0); ?></td>
                                    <td align="right" title="Inhouse=<?=$batchQtyArr[$po_id]['qty'].',Outbound='.$dyeingProdArr[$po_id]['out'];?>">                              
                                        <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','batch_popup')">
                                            <? echo fn_number_format($batchQty,0); ?>
                                        </a>
                                    </td>
                                    <td title="(Primary Grey Req + Excess Grey) - Batch Qty" align="right"><? echo fn_number_format($batchBal,0); ?></td>
                                    <td title="Grey Rcv - Batch Qty" align="right"><? echo fn_number_format($redyToBatch,0); ?></td>

                                    <td align="right" title="<?= "Budget=".$aop_Req.", Excess=".$color_type_wise_booking_qty_array[$po_id][5];?>">
                                        <? echo fn_number_format($aopReq,0); ?>                                        
                                    </td>
                                    <td align="right"><a href="##" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','aop_popup')"><? echo fn_number_format($aopRcv,0); ?></a></td>
                                    <td align="center"><? echo change_date_format_new($aopStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($aopEndDate); ?></td>
                                    <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][63]['all_plan_qty'];?>">
                                        <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**63";?>','plan_balance_popup')">
                                            <? echo fn_number_format($aopPlanBal,0); ?>
                                        </a>
                                    </td>
                                    <td align="center"><? echo change_date_format_new($aopAcStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($aopAcEndDate); ?></td>
                                    <td align="center"><? echo fn_number_format($aopLstRcv,0); ?></td>
                                    <td align="right"><? echo ($aopBackLog >0) ? fn_number_format($aopBackLog,0) : 0 ;?></td>
                                    <td align="right"><? echo fn_number_format($aopBal); ?></td>
                                    <td align="right"><? echo fn_number_format($aopIssueQty,0); ?></td>
                                    <td align="right"><? echo fn_number_format($aopFbSndBal,0); ?></td>

                                    <td align="right">
                                        <a href="##" onclick="garments_popup('<? echo $val['job_no']."__".implode(",", $jobWisePoArray[$val['job_no']]);?>','finish_fab_popup')">
                                            <? echo fn_number_format(($fabfinishReg+$fabfinishPurReg),0); ?>
                                        </a>
                                    </td>
                                    <td align="right"><? echo fn_number_format($fin_fab_excess_qty,0); ?></td>
                                    <td align="right"><? echo fn_number_format($finFabTrnsIn,0); ?></td>
                                    <td align="right"><? echo fn_number_format($finFabTrnsOut,0); ?></td>
                                    <td align="right"><? echo fn_number_format($a,0); ?></td>
                                    <td align="right" title="Inhouse=<?=$gmtStrTrnsIn2+$gmtStrRcv2-$finFabOutProd;?>,purchase=<?=$finFab_purchase_qty;?>,Outbound=<?=$finFabOutProd;?>">
                                        <a href="##" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','finish_popup')"><? echo fn_number_format($fin_rcv_qnty2,0);//$finishRcv ?></a>
                                    </td>
                                    <td align="center"><? echo change_date_format_new($fabFinStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($fabFinEndDate); ?></td>
                                    <td align="right" title="TTL Plan =<?=$ttlFinFabPlan."; Mfg Plan=".$tnaPlanTargetArray[$po_id][73][1]['all_plan_qty'].",Pur Plan=".$tnaPlanTargetArray[$po_id][73][2]['all_plan_qty'];?>">
                                        <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**73";?>','plan_balance_popup')">
                                            <? echo fn_number_format($finFabPlanBal,0); ?>
                                        </a>
                                    </td>
                                    <td align="center"><? echo change_date_format_new($fabFinAcStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($fabFinAcEndDate); ?></td>
                                    <td align="center"><? echo fn_number_format($finishLstRcv,0); ?></td>
                                    <td align="right"><? echo ($finishBackLog >0) ? fn_number_format($finishBackLog,0) : 0; ?></td>
                                    <td align="right"><? echo ($finishBackLogPur >0) ? fn_number_format($finishBackLogPur,0) : 0; ?></td>
                                    <td align="right"><? echo fn_number_format($finishFabBal,0); ?></td>
                                    <td align="right"><? echo fn_number_format($issueToCut,0); ?></td>
                                    <td align="right"><? echo fn_number_format($dyeStock,0); ?></td>
                                    <td align="right"><? echo fn_number_format($gmtStock,0); ?></td>                           
                                    <td align="right">
                                        <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','garments_popup')">
                                            <? echo fn_number_format($layQty,0); ?>
                                        </a> 
                                    </td>
                                    <td align="right"><? echo fn_number_format($qcRejQty,0); ?></td>
                                    <td align="right"><? echo fn_number_format($qcRplsQty,0); ?></td>
                                    <td align="right"><? echo fn_number_format($qcQty,0); ?></td>
                                    <td align="center"><? echo change_date_format_new($cuttStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($cuttEndDate); ?></td>
                                    <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][84]['all_plan_qty'];?>">
                                        <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**84";?>','plan_balance_popup')">
                                            <? echo fn_number_format($cuttingPlanBal,0); ?>
                                        </a>
                                    </td>
                                    <td align="center"><? echo change_date_format_new($cuttAcStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($cuttAcEndDate); ?></td>
                                    <td align="center"><? echo fn_number_format($lstQcQty,0); ?></td>
                                    <td align="right"><? echo ($qcBackLog >0) ? fn_number_format($qcBackLog,0) : 0;?></td>
                                    <td align="right"><? echo fn_number_format($cutBal,0); ?></td>



                                    <td align="right"><? echo fn_number_format($printReq,0); ?></td>
                                    <td align="right"><? echo fn_number_format($printRejQty,0); ?></td>
                                    <td align="right">
                                        <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','garments_print_popup')">
                                            <? echo fn_number_format($printQty,0); ?>
                                        </a>                                  
                                    </td>
                                    <td align="center"><? echo change_date_format_new($printStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($printEndDate); ?></td>
                                    <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][267]['all_plan_qty'];?>">
                                        <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**267";?>','plan_balance_popup')">
                                            <? echo fn_number_format($printPlanBal,0); ?>
                                        </a>
                                    </td>
                                    <td align="center"><? echo change_date_format_new($printAcStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($printAcEndDate); ?></td>
                                    <td align="right"><? echo fn_number_format($lstPrntQty,0); ?></td>
                                    <td align="right"><? echo ($printBackLog >0) ? fn_number_format($printBackLog,0) : 0;?></td>
                                    <td align="right"><? echo fn_number_format($printBal,0); ?></td>
                                    <td align="right"><? echo fn_number_format($printIssQty,0); ?></td>
                                    <td align="right"><? echo fn_number_format($prntSndBal,0); ?></td>

                                    <td align="right"><? echo fn_number_format($embReq,0); ?></td>
                                    <td align="right"><? echo fn_number_format($embRejQty,0); ?></td>
                                    <td align="right">
                                        <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','garments_emb_popup')">
                                            <? echo fn_number_format($embQty,0); ?>
                                        </a>                                 
                                    </td>
                                    <td align="center"><? echo change_date_format_new($embStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($embEndDate); ?></td>
                                    <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][268]['all_plan_qty'];?>">
                                        <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**268";?>','plan_balance_popup')">
                                            <? echo fn_number_format($embPlanBal,0); ?>
                                        </a>
                                    </td>
                                    <td align="center"><? echo change_date_format_new($embAcStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($embAcEndDate); ?></td>
                                    <td align="right"><? echo fn_number_format($lstEmbQty,0); ?></td>
                                    <td align="right"><? echo ($embBackLog >0) ? fn_number_format($embBackLog,0) : 0;?></td>
                                    <td align="right"><? echo fn_number_format($embBal,0); ?></td>
                                    <td align="right"><? echo fn_number_format($embIssueQty); ?></td>
                                    <td align="right"><? echo fn_number_format($embSndBal); ?></td>

                                    <td align="right" title="<? echo $sewTrimsQty; ?>/<? echo $sewTrimsReq;?>*100">
                                        <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','acc_booking_popup')">
                                             <? echo fn_number_format($sewTrimsPrsnt,2); ?>%
                                        </a>                                
                                    </td>
                                    <td align="right"><? echo change_date_format_new($sewTrimsStDate); ?></td>
                                    <td align="right"><? echo change_date_format_new($sewTrimsEndDate); ?></td>
                                    <td align="right"><? echo fn_number_format($planBal,0); ?></td>
                                    <td align="right"><? echo change_date_format_new($sewTrimsAcStDate); ?></td>
                                    <td align="right"><? echo change_date_format_new($sewTrimsAcEndDate); ?></td>
                                    <td align="right"><? echo ($sewTrmBacklog >0) ? fn_number_format($sewTrmBacklog,0) : 0; ?></td>

                                    <td align="right" title="<? echo $finTrimsQty; ?>/<? echo $finTrimsReq;?>*100">
                                        <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','acc_booking_popup')">
                                             <? echo fn_number_format($finTrimsPrsnt,2); ?>%
                                        </a>                                
                                    </td>
                                    <td align="right"><? echo change_date_format_new($finTrimsStDate); ?></td>
                                    <td align="right"><? echo change_date_format_new($finTrimsEndDate); ?></td>
                                    <td align="right"><? echo fn_number_format($planBal,0); ?></td>
                                    <td align="right"><? echo change_date_format_new($finTrimsAcStDate); ?></td>
                                    <td align="right"><? echo change_date_format_new($finTrimsAcEndDate); ?></td>
                                    <td align="right"><? echo ($finTrmBacklog >0) ? fn_number_format($finTrmBacklog,0) : 0; ?></td>

                                    <td align="right"><? echo fn_number_format($inputQty,0); ?></td>
                                    <td align="right"><? echo fn_number_format($plan_input_bal,0); ?></td>
                                    <td align="right"><? echo fn_number_format($rejectQty,0); ?></td>
                                    <td align="right"><? echo fn_number_format($replaceQty,0); ?></td>
                                    <td align="right"><? echo fn_number_format($okOutQty,0); ?></td>                           
                                    <td align="right">
                                        <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','garments_popup')">
                                            <? echo fn_number_format($totSewQty,0); ?>
                                        </a> 
                                    </td>
                                    <td align="center"><? echo change_date_format_new($inputStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($inputEndDate); ?></td>
                                    <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][86]['all_plan_qty'];?>">
                                        <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**86";?>','plan_balance_popup')">
                                            <? echo fn_number_format($sewFinPlanBal,0); ?>
                                        </a>
                                    </td>
                                    <td align="center"><? echo change_date_format_new($inputAcStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($inputAcEndDate); ?></td>
                                    <td align="right"><? echo fn_number_format($lstOutputQty,0); ?></td>
                                    <td align="right"><? echo ($sewFinBackLog >0) ? fn_number_format($sewFinBackLog,0) : 0; ?></td>
                                    <td align="right"><? echo ($sewingWIP >0) ? fn_number_format($sewingWIP,0) : 0; ?></td>
                                    <td align="right"><? echo fn_number_format($sewingBAL,0); ?></td>

                                    <td align="right"><? echo fn_number_format($washReq); ?></td>
                                    <td align="right"><? echo fn_number_format($washRejQty); ?></td>
                                    <td align="right">
                                        <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','garments_wash_popup')">
                                            <? echo fn_number_format($washQty,0); ?>
                                        </a> 
                                    </td>
                                    <td align="right"><? echo change_date_format_new($washStDate); ?></td>
                                    <td align="right"><? echo change_date_format_new($washEndDate); ?></td>
                                    <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][90]['all_plan_qty'];?>">
                                        <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**90";?>','plan_balance_popup')">
                                            <? echo fn_number_format($washPlanBal,0); ?>
                                        </a>
                                    </td>
                                    <td align="right"><? echo change_date_format_new($washAcStDate); ?></td>
                                    <td align="right"><? echo change_date_format_new($washAcEndDate); ?></td>
                                    <td align="right"><? echo fn_number_format($lstWashQty,0); ?></td>
                                    <td align="right"><? echo ($washBackLog >0) ? fn_number_format($washBackLog,0) : 0;?></td>
                                    <td align="right"><? echo fn_number_format($washBal); ?></td>
                                    <td align="right"><? echo fn_number_format($washIssueQty,0); ?></td>
                                    <td align="right"><? echo fn_number_format($sendBal,0); ?></td>
                                                              
                                    <td align="right">
                                        <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','garments_popup')">
                                            <? echo fn_number_format($finishQty,0); ?>
                                        </a> 
                                    </td>
                                    <td align="right"><? echo fn_number_format($finRejQty); ?></td>
                                    <td align="center"><? echo change_date_format_new($finishStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($finishEndDate); ?></td>
                                    <td align="right" title="plan Qty=<?=$tnaPlanTargetArray[$po_id][88]['all_plan_qty'];?>">
                                        <a href="##" onclick="garments_popup('<? echo $val['job_no']."**".implode(",", $jobWisePoArray[$val[job_no]])."**88";?>','plan_balance_popup')">
                                            <? echo fn_number_format($gmtFinPlanBal,0); ?>
                                        </a>
                                    </td>
                                    <td align="center"><? echo change_date_format_new($finishAcStDate); ?></td>
                                    <td align="center"><? echo change_date_format_new($finishAcEndDate); ?></td>
                                    <td align="right"><? echo fn_number_format($finishWIP); ?></td>
                                    <td align="right"><? echo ($gmtFinBackLog >0) ? fn_number_format($gmtFinBackLog,0) : 0;?></td>
                                    <td align="right"><? echo fn_number_format($gmtFinBal); ?></td>
                                    <td align="right"><? echo fn_number_format($lstFinishQty);?></td>
                                                               
                                    <td align="right">
                                        <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','exfactory_popup')">
                                            <? echo fn_number_format($exfactoryQty,0); ?>
                                        </a> 
                                    </td>
                                    <td align="right"><? echo fn_number_format($exfactoryWIP); ?></td>
                                    <td align="right"><? echo (count($exDateArray)>0) ? date('d-M-Y',(min($exDateArray))) : ""; ?></td>
                                    <td align="right"><? echo (count($exDateArray)>0) ? date('d-M-Y',(max($exDateArray))) : ""; ?></td>
                                    <td align="right"><? echo fn_number_format($exfactoryLstQty); ?></td>
                                    <td align="right"><? echo ($shiping_backlog >0) ? fn_number_format($shiping_backlog,0) : 0;?></td>
                                    <td align="right">
                                        <a href="javascript:void()" onclick="garments_popup('<? echo implode(",", $jobWisePoArray[$val['job_no']]);?>','exfactory_popup_acct_po')">
                                            <? echo fn_number_format($exBal,0); ?>
                                        </a> 
                                    </td>
                                </tr>
                                <?
                                $i++;
                                $total_po_qty       += $val['qty'];
                                $total_book_qty     += $bookingQty;
                                if($bookingBal>0)
                                {
                                    $total_book_bal     += $bookingBal;
                                }
                                if($bookingBackLog>0)
                                {
                                    $total_book_bklg    += $bookingBackLog;
                                }

                                $total_yarn_req     += $yarnReqQty;
                                $total_yarn_exs     += $yarn_excess_qty;
                                $total_yarn_allo    += $yarnAlloQty;
                                $total_yarn_bklog   += ($yarnBackLog>0) ? $yarnBackLog : 0;
                                $total_yarn_allo_bal+= $yarnBal;
                                $total_yarn_allo_plan_bal += $yarnPlanBal;

                                $total_yarn_dyed_req+= $yarnDyedReqQty;
                                $total_yarn_dyed_rcv+= fn_number_format($yarn_dyed_qty,4,".","");
                                $total_yarn_dyed_bklog+= ($ydBackLog>0) ? $ydBackLog : 0;
                                $total_yarn_dyed_bal+= $ydBal;                            
                                $total_yarn_dyed_plan_bal += $yarnDyedPlanBal;                          
                                $total_lst_day_yarn = $ydLstRcv;
                                $total_yarn_snd_to_fact = $ydIssueQty;
                                $total_yarn_snd_bal = fn_number_format($ydSndBal,4,".","");

                                $total_grey_req     += $fabGreyReg;
                                $total_grey_exs     += $grey_fab_excess_qty;
                                $total_grey_rcv     += $greyRcv;
                                $total_grey_in      += $grey_trans_in;
                                $total_grey_out     += $grey_trans_out;
                                $total_grey_bklog   += ($greyBackLog>0) ? $greyBackLog : 0;
                                $total_grey_bal     += $greyBal;                            
                                $total_grey_plan_bal     += $greyFabPlanBal;                          
                                $total_grey_lst_day_prod += $greyLstRcv;
                                $total_grey_prog_qty += $progQty;
                                $total_grey_prog_bal += $progBalQty;
                                $total_yrn_snd_to_fact+= $yrnSndtoFact;
                                $total_yarn_snd_bal+= fn_number_format($yrnSndBal,4,".","");

                                $total_dye_req      += $fabDyeingReq;
                                $total_dye_rcv      += $dyeingRcv;
                                $total_dye_bklog    += ($dyeingBackLog>0) ? $dyeingBackLog : 0;
                                $total_dye_bal      += $dyeingBal;                            
                                $total_dye_plan_bal   += $fabDyePlanBal;                         
                                $total_lst_day_prod_dye += $lstDyeingRcv;
                                $total_dye_batch    += $batchQty;
                                $total_dye_batch_bal += $batchBal;
                                $total_dye_redy_to_batch += $redyToBatch;

                                $total_aop_req      += $aopReq;
                                $total_aop_rcv      += $aopRcv;
                                $total_aop_bklog    += ($aopBackLog>0) ? $aopBackLog : 0;
                                $total_aop_bal      += $aopBal;                            
                                $total_aop_plan_bal      += $aopPlanBal;
                                $total_lst_day_aop  += $aopLstRcv;
                                $total_aop_sen_to_fact+= $aopIssueQty;
                                $total_aop_send_bal += $aopFbSndBal;

                                $total_fin_fab_req  += $fabfinishReg+$fabfinishPurReg;
                                $total_fin_fab_exs  += $fin_fab_excess_qty;
                                $total_fin_fab_rcv  += $fin_rcv_qnty2;
                                $total_fin_fab_bklog+= ($finishBackLog>0) ? $finishBackLog : 0;
                                $total_fin_fab_bklog_pur += ($finishBackLogPur>0) ? $finishBackLogPur : 0;
                                $total_fin_fab_bal  += $finishFabBal;
                                $total_fin_fab_plan_bal  += $finFabPlanBal;
                                $total_stk_gmt_store  += $gmtStock;
                                $total_stk_fin_store  += $dyeStock;
                                $total_lst_day_rcv_fin_fab  += $finishLstRcv;
                                $total_trns_in_fin_fab  += $finFabTrnsIn;
                                $total_trns_out_fin_fab  += $finFabTrnsOut;
                                $total_rej_fin_fab  += 0;

                                $total_issue_to_cut += $issueToCut;
                                $total_lay_qty      += $layQty;
                                $total_lay_qc_qty   += $qcQty;
                                $total_lay_rej_qty  += $qcRejQty;
                                $total_cut_bklog    += ($qcBackLog>0) ? $qcBackLog : 0;
                                $total_cut_bal      += $cutBal;
                                $total_lst_day_cut_qc+= $lstQcQty;

                                $total_print_req    += $printReq;
                                $total_print_rcv    += $printQty;
                                $total_print_rej    += $printRejQty;
                                $total_print_bklog  += ($printBackLog>0) ? $printBackLog : 0;
                                $total_print_bal    += $printBal;
                                $total_print_plan_bal  += $printPlanBal;
                                $total_print_snd_bal  += $prntSndBal;
                                $total_cut_panel_del_print+= $printIssQty;
                                $total_lst_day_print+= $lstPrntQty;

                                $total_emb_req      += $embReq;
                                $total_emb_rcv      += $embQty;
                                $total_emb_rej      += $embRejQty;
                                $total_emb_bklog    += ($embBackLog>0) ? $embBackLog : 0;
                                $total_emb_bal      += $embBal;
                                $total_emb_plan_bal      += $embPlanBal;
                                $total_emb_snd_bal  += $embSndBal;
                                $total_cut_panel_del+= $embIssueQty;
                                $total_lst_day_emb+= $lstEmbQty;

                                $total_sew_trim_rcv += $sewTrimsQty;
                                $total_sew_trim_bklg += $sewTrmBacklog;
                                $total_fin_trim_rcv += $finTrimsQty;
                                $total_fin_trim_bklg += ($finTrmBacklog>0) ? $finTrmBacklog : 0;

                                $total_input_qty    += $inputQty;
                                $total_plan_input_qty+= $plan_input_bal;
                                $total_rej_qty      += $rejectQty;
                                $total_ok_out_qty   += $outputQty;
                                $total_out_qty      += $totSewQty;
                                if($sewFinBackLog>0){
                                $total_sew_bklog    += $sewFinBackLog;
                                }
                                $total_out_wip      += $sewingWIP;
                                $total_out_bal      += $sewingBAL;                            
                                $total_out_plan_bal += $sewFinPlanBal;
                                $total_lst_day_sew  += $lstOutputQty;
                                $total_sew_rpls     += $replaceQty;

                                $total_wash_req     += $washReq;
                                $total_wash_rej     += $washRejQty;
                                $total_wash_rcv     += $washQty;
                                $total_wash_bklog   += ($washBackLog>0) ? $washBackLog : 0;
                                $total_wash_bal     += $washBal;
                                $total_wash_plan_bal     += $washPlanBal;
                                $total_send_wash    += $washIssueQty;
                                $total_send_bal     += $sendBal;
                                $total_lst_day_wash += $lstWashQty;

                                $total_finish_qty   += $finishQty;
                                $total_fin_rej_qty  += $finRejQty;
                                $total_finish_wip   += $finishWIP;
                                $total_finish_bal   += $finishBal;
                                $total_finish_plan_bal   += $gmtFinPlanBal;
                                $total_lst_fin_qty  += $lstFinishQty;
                                $total_fin_bklog_qty+= ($gmtFinBackLog>0) ? $gmtFinBackLog: 0;

                                $total_shipment_qty += $exfactoryQty;
                                $total_shipment_wip += $exfactoryWIP;
                                $total_shipment_bklog+= ($shiping_backlog>0) ? $shiping_backlog : 0;
                                $total_lst_ship_qty+= $exfactoryLstQty;
                                $total_shipment_bal += $exBal;
                            }
                        }
                        ?>
                        <tr id="trs_<? echo $i;?>" class="GridViewScrollItem footerTr">
                            <td><div class="gridViewScrollHelper"></div></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td align="right">Total</td>
                            <td align="right"><? echo fn_number_format($total_po_qty,0); ?></td>

                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>

                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            
                            <td align="right"><? //echo fn_number_format($total_book_qty,2); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_book_bklg,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_book_bal,0); ?></td>

                            <td align="right"><? echo fn_number_format($total_yarn_req,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_yarn_exs,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_yarn_allo,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_yarn_allo_plan_bal,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_yarn_bklog,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_yarn_allo_bal,0); ?></td>
                           <!--  <td align="right"><? //echo fn_number_format($total_yarn_allo_bal,2); ?></td>
                            <td align="right"><? //echo fn_number_format($total_yarn_allo_bal,2); ?></td> -->

                            <td align="right"><? echo fn_number_format($total_yarn_dyed_req,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_yarn_dyed_rcv,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_yarn_dyed_plan_bal,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_lst_day_yarn,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_yarn_dyed_bklog,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_yarn_dyed_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_yarn_snd_to_fact,2); ?></td>
                            <td align="right"><? echo fn_number_format($total_yarn_snd_bal,2); ?></td>

                            <td align="right"><? echo fn_number_format($total_grey_req,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_grey_exs,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_grey_rcv,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_grey_in,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_grey_out,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_grey_plan_bal,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_grey_lst_day_prod,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_grey_bklog,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_grey_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_grey_prog_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_grey_prog_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_yrn_snd_to_fact,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_yarn_snd_bal,0); ?></td>

                            <td align="right"><? echo fn_number_format($total_dye_req,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_dye_rcv,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_dye_plan_bal,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_lst_day_prod_dye,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_dye_bklog,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_dye_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_dye_batch,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_dye_batch_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_dye_redy_to_batch,0); ?></td>

                            <td align="right"><? echo fn_number_format($total_aop_req,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_aop_rcv,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_aop_plan_bal,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_lst_day_aop,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_aop_bklog,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_aop_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_aop_sen_to_fact,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_aop_send_bal,0); ?></td>

                            <td align="right"><? echo fn_number_format($total_fin_fab_req,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_fin_fab_exs,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_trns_in_fin_fab,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_trns_out_fin_fab,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_rej_fin_fab,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_fin_fab_rcv,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_fin_fab_plan_bal,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_lst_day_rcv_fin_fab,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_fin_fab_bklog,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_fin_fab_bklog_pur,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_fin_fab_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_issue_to_cut,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_stk_fin_store,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_stk_gmt_store,0); ?></td>
                            
                            <td align="right"><? echo fn_number_format($total_lay_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_lay_rej_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_lay_rep_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_lay_qc_qty,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_lst_day_cut_qc,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_cut_bklog,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_cut_bal,0); ?></td>

                            <td align="right"><? echo fn_number_format($total_print_req,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_print_rej,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_print_rcv,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_print_plan_bal,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_lst_day_print,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_print_bklog,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_print_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_cut_panel_del_print,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_print_snd_bal,0); ?></td>

                            <td align="right"><? echo fn_number_format($total_emb_req,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_emb_rej,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_emb_rcv,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_emb_plan_bal,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_lst_day_emb,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_emb_bklog,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_emb_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_cut_panel_del,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_emb_snd_bal,0); ?></td>

                            <td align="right"><? echo fn_number_format($total_sew_trim_rcv,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_sew_trim_bklg,0); ?></td>

                            <td align="right"><? echo fn_number_format($total_fin_trim_rcv,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_fin_trim_bklg,0); ?></td>

                            <td align="right"><? echo fn_number_format($total_input_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_plan_input_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_rej_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_sew_rpls,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_ok_out_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_out_qty,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_out_plan_bal,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_lst_day_sew,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_sew_bklog,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_out_wip,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_out_bal,0); ?></td>

                            <td align="right"><? echo fn_number_format($total_wash_req,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_wash_rej,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_wash_rcv,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_wash_plan_bal,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_lst_day_wash,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_wash_bklog,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_wash_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_send_wash,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_send_bal,0); ?></td>

                            <td align="right"><? echo fn_number_format($total_finish_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_fin_rej_qty,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_finish_plan_bal,0); ?></td>
                            <td align="right"></td>
                            <td align="right"></td>
                            <td align="right"><? echo fn_number_format($total_finish_wip,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_fin_bklog_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_finish_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_lst_fin_qty,0); ?></td>

                            <td align="right"><? echo fn_number_format($total_shipment_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_shipment_wip,0); ?></td>
                            <td align="right"><? //echo fn_number_format($total_shipment_wip,0); ?></td>
                            <td align="right"><? //echo fn_number_format($total_shipment_wip,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_lst_ship_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_shipment_bklog,0); ?></td>
                            <td align="right"><? echo fn_number_format($total_shipment_bal,0); ?></td>

                        </tr>
                    </tbody>
                </table>
            </div>
        </main> 
      
        <script type="text/javascript" src="../../../js/gridviewscroll.js"></script>
        <script type="text/javascript">
            var gridViewScroll = null;
            fnGridView = function () {
                gridViewScroll = new GridViewScroll({
                    elementID: "gvMain",
                    width: screen.width-30,
                    // width: 1335,
                    height: 380,
                    freezeColumn: true,
                    freezeFooter: true,
                    freezeColumnCssClass: "GridViewScrollItemFreeze",
                    freezeFooterCssClass: "GridViewScrollFooterFreeze",
                    freezeHeaderRowCount: 2,
                    freezeColumnCount: 11,
                    onscroll: function (scrollTop, scrollLeft) {
                        console.log(scrollTop + " - " + scrollLeft);
                    }
                });
                gridViewScroll.enhance();
            }
            function getScrollPosition() {
                var position = gridViewScroll.scrollPosition;
                alert("scrollTop: " + position.scrollTop + ", scrollLeft: " + position.scrollLeft);
            }
            function setScrollPosition() {
                var scrollPosition = { scrollTop: 50, scrollLeft: 50};

                gridViewScroll.scrollPosition = scrollPosition;
            }
            fnGridView();
            //=================================================
            
        </script>
        <?
        foreach (glob("$user_id*.xls") as $filename) 
        {
            if( @filemtime($filename) < (time()-$seconds_old) )
            @unlink($filename);
        }
        //---------end------------//
        $name=time();
        $filename="tmp/".$user_id."_".$name.".xls";
        $create_new_doc = fopen($filename, 'w');
        $is_created = fwrite($create_new_doc,ob_get_contents());
        //$filename=$user_id."_".$name.".xls";
        echo "$total_data####$filename";
        exit();
    }   
    elseif ($rptType==2) // Acc summary button
    {
        $sqlCond = "";
        $sqlCond .= " and a.company_name=$company_id";
        // $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
        $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
        $sqlCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";
        $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
        // $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
        if($hidden_order_id!="")
        {
            $sqlCond .= ($hidden_order_id !="")   ? " and a.id in($hidden_order_id)" : "";
        }
        else
        {
            $sqlCond .= ($int_ref_no !="")   ? " and b.grouping like '$int_ref_no%'"      : "";
        }
        $sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";
        $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
        if($shipment_status==1)
        {
            $sqlCond .= " and b.shiping_status in(1,2)";
        }
        elseif ($shipment_status==2) {
            $sqlCond .= " and b.shiping_status in(3)";
        }
        $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
        $sqlCond .= ($status !=0) ? " and b.status_active in($status)" : "";
        $sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
        // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";

        if($buyer_name==0)
        {
            if($_SESSION['logic_erp']["data_level_secured"]==1)
            {
                if($_SESSION['logic_erp']["buyer_id"]!="")
                {   
                    $sqlCond.=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")";
                }
            }
        }
        else
        {
            $sqlCond.=" and a.buyer_name=$buyer_name";
        }
        if($date_from !="" && $date_to !="")
        {
            if($db_type==0)
            {
                $start_date=change_date_format($date_from,"yyyy-mm-dd","");
                $end_date=change_date_format($date_to,"yyyy-mm-dd","");
            }
            else
            {
                $start_date=date("j-M-Y",strtotime($date_from));
                $end_date=date("j-M-Y",strtotime($date_to));
            }
            
            switch ($search_by) 
            {
                case 2:
                    $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                    break;
                case 3:
                   $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
                   break;
                case 4:
                    $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                    break;
                case 5:
                    $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                    break;
               
                default:
                    $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                    break;
            }
        }

        $costing_per_sql=sql_select("SELECT JOB_NO,COSTING_PER from wo_pre_cost_mst");
        $costing_per_arr=array();
        foreach($costing_per_sql as $cost_val)
        {
            $costing_per_arr[$cost_val['JOB_NO']] = $cost_val['COSTING_PER'];
        }
        unset($costing_per_sql);

        $current_date = strtotime(date("d-m-Y"));

        $lib_item_group_name = return_library_array("select id,item_name from lib_item_group", "id", "item_name");
        $lib_supplier = return_library_array("select id,short_name from lib_supplier", "id", "short_name");
        /*======================================================================================/
        /                                    main query                                         /
        /======================================================================================*/       
        $sql = "SELECT a.id as job_id, a.job_no AS JOB_NO,a.style_ref_no as STYLE,a.total_set_qnty AS TOTAL_SET_QNTY,b.id AS PO_ID,b.grouping as INT_REF,c.item_number_id AS ITEM_NUMBER_ID, c.order_quantity AS ORDER_QUANTITY ,c.plan_cut_qnty AS PLAN_CUT_QNTY,d.trim_group AS TRIM_GROUP,d.CONS_UOM,e.cons AS CONS from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c, wo_pre_cost_trim_cost_dtls d, wo_pre_cost_trim_co_cons_dtls e where 1=1 and a.id=b.job_id and b.id=c.po_break_down_id and a.id=d.job_id and d.id=e.wo_pre_cost_trim_cost_dtls_id and b.id=e.po_break_down_id and c.item_number_id= e.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.size_number_id and e.cons>0 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.is_deleted=0 and d.status_active=1 and e.is_deleted=0 and e.status_active=1 $sqlCond order by b.grouping";//$sqlCond
        // echo $sql;die();
        $sqlRes = sql_select($sql);
        if(count($sqlRes)==0)
        {
            echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
        }
        $job_id_arr = array();
        $item_number_id_arr = array();
        $item_group_id_arr = array();
        foreach ($sqlRes as $row) 
        {
            $job_id_arr[$row['JOB_ID']] = $row['JOB_ID'];
            $item_number_id_arr[$row['ITEM_NUMBER_ID']] = $row['ITEM_NUMBER_ID'];
            $item_group_id_arr[$row['TRIM_GROUP']] = $row['TRIM_GROUP'];
        }

        $job_id_cond = where_con_using_array($job_id_arr,0,"a.id");
        $item_id_cond = where_con_using_array($item_number_id_arr,0,"b.gmts_item_id");
        $item_group_cond = where_con_using_array($item_group_id_arr,0,"id");

        // ============================ gmtsitemRatioArray ==========================
        $gmtsitemRatioArray = array();
        $gmtsitemRatioSql=sql_select('SELECT a.job_no AS JOB_NO,b.gmts_item_id AS GMTS_ITEM_ID ,b.set_item_ratio AS SET_ITEM_RATIO from wo_po_details_master a, wo_po_details_mas_set_details b where 1=1 and a.id=b.job_id');//  $job_id_cond $item_id_cond
        foreach($gmtsitemRatioSql as $gmtsitemRatioSqlRow)
        {
            $gmtsitemRatioArray[$gmtsitemRatioSqlRow['JOB_NO']][$gmtsitemRatioSqlRow['GMTS_ITEM_ID']]=$gmtsitemRatioSqlRow['SET_ITEM_RATIO'];    
        }
        unset($gmtsitemRatioSql);

        // ============================ item category =========================
        $item_cat_arr = return_library_array("SELECT id,item_category from lib_item_group where status_active=1 $item_group_cond", "id", "item_category");

        $poIdArray = array();
        $dataArray = array();
        foreach ($sqlRes as $row) 
        {
            $reqQty = 0;
            $costingPer = $costing_per_arr[$row['JOB_NO']];            
            if($costingPer==1) $pcs_value=1*12;
            else if($costingPer==2) $pcs_value=1*1;
            else if($costingPer==3) $pcs_value=2*12;
            else if($costingPer==4) $pcs_value=3*12;
            else if($costingPer==5) $pcs_value=4*12;
            $gmtsitemRatio = $gmtsitemRatioArray[$row['JOB_NO']][$row['ITEM_NUMBER_ID']];
            $reqQty = ($row['ORDER_QUANTITY']/$gmtsitemRatio)*($row['CONS']/$pcs_value);
            // echo "(".$row['ORDER_QUANTITY']."/".$gmtsitemRatio.")*(".$row['CONS']."/".$pcs_value.")<br>";
            $tgroup = strtolower($lib_item_group_name[$row['TRIM_GROUP']]);
            $category = strtolower($item_category[$item_cat_arr[$row['TRIM_GROUP']]]);

            $dataArray[$category][$tgroup]['trim_group'] = $row['TRIM_GROUP'];       
            $dataArray[$category][$tgroup]['req_qty'] += $reqQty;   
            $dataArray[$category][$tgroup]['cons_uom'] = $row['CONS_UOM'];  

            $poIdArray[$row['PO_ID']] = $row['PO_ID'];
        }
        // echo "<pre>";print_r($dataArray);die();
        $poIDS = implode(",", $poIdArray);
        $po_id_list_arr=array_chunk($poIdArray,999);
    
        $poCon = " and ";$poCon2 = " and ";$poCon3 = " and ";
        $p=1;
        foreach($po_id_list_arr as $po_process)
        {
            if($p==1) $poCon .="  ( c.po_break_down_id in(".implode(',',$po_process).")"; 
            else  $poCon .=" or c.po_break_down_id in(".implode(',',$po_process).")";
            

            if($p==1) $poCon2 .="  ( c.po_breakdown_id in(".implode(',',$po_process).")"; 
            else  $poCon2 .=" or c.po_breakdown_id in(".implode(',',$po_process).")"; 
            
            if($p==1) $poCon3 .="  ( e.id in(".implode(',',$po_process).")"; 
            else  $poCon3 .=" or e.id in(".implode(',',$po_process).")";         
            
            $p++;
        }
        $poCon .=")";$poCon2 .=")";$poCon3 .=")";
        /*======================================================================================/
        /                                    trims booking qty                                  /
        /======================================================================================*/
        $sqlTrims = "SELECT a.booking_no_prefix_num as BOOKING_NUM,a.BOOKING_NO,a.id as BOOKING_ID,d.job_no as JOB_NO,e.grouping as INT_REF, c.po_break_down_id as PO_ID,b.trim_group as TRIM_GROUP, sum(case when a.is_short=2 then c.requirment else 0 end) as QTY, sum(case when a.is_short=1 then c.requirment else 0 end) as SHOR_QTY, max(a.booking_date) as BOOKING_DATE,a.SUPPLIER_ID FROM wo_booking_mst a,wo_booking_dtls b,wo_trim_book_con_dtls c,wo_po_details_master d,wo_po_break_down e WHERE a.booking_no=b.booking_no and b.booking_no=c.booking_no and b.id=c.wo_trim_booking_dtls_id and d.id=e.job_id and c.po_break_down_id=e.id $poCon and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(87,262)  and a.item_category=4 and a.booking_type=2  group by a.booking_no_prefix_num,a.id,a.booking_no,d.job_no,e.grouping,b.trim_group,a.supplier_id,c.po_break_down_id ";
        // echo $sqlTrims;die();
        $trimsRes = sql_select($sqlTrims);
        $tbArray = array();
        $bookingDataArray = array();
        foreach ($trimsRes as  $val) 
        {
            $tgroup = strtolower($lib_item_group_name[$val['TRIM_GROUP']]);
            $category = strtolower($item_category[$item_cat_arr[$val['TRIM_GROUP']]]);
            $bookingDataArray[$category][$tgroup]['book_qty'] += $val['QTY'];
            $bookingDataArray[$category][$tgroup]['short_book_qty'] += $val['SHOR_QTY'];
            $bookingDataArray[$category][$tgroup]['booking_date'] = $val['BOOKING_DATE'];
            $bookingDataArray[$category][$tgroup]['supplier_id'] .= $val['SUPPLIER_ID'].",";
            $bookingDataArray[$category][$tgroup]['booking_num'] .= $val['BOOKING_NUM'].",";
            $bookingDataArray[$category][$tgroup]['booking_no'] = $val['BOOKING_NO'];
            $tbArray[$val['BOOKING_ID']] = $val['BOOKING_ID'];
        }
        // echo "<pre>";print_r($bookingDataArray);die();
        $trimsBoingIds = implode(",", $tbArray);
        $tb_id_list_arr=array_chunk($tbArray,999);
    
        $tbCon = " and ";
        $p=1;
        foreach($tb_id_list_arr as $tb_process)
        {
            if($p==1) $tbCon .="  ( b.work_order_id in(".implode(',',$tb_process).")"; 
            else  $tbCon .=" or b.work_order_id in(".implode(',',$tb_process).")";       
            
            $p++;
        }
        $tbCon .=")";

        /*======================================================================================/
        /                                    trims receive qty                                  /
        /======================================================================================*/
        $sqlacc = "SELECT a.receive_date, d.job_no as JOB_NO,e.grouping as INT_REF, B.ITEM_GROUP_ID as TRIM_GROUP,c.quantity AS QNTY,c.reject_qty as REJ_QTY FROM inv_receive_master a,inv_trims_entry_dtls b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=24 AND c.entry_form = 24 AND c.entry_form = 24 and a.item_category=4 and d.id=e.job_id and c.po_breakdown_id=e.id $poCon2";
        // echo $sqlacc;die();
        $accRes = sql_select($sqlacc);
        $trimsDataArray = array();
        foreach ($accRes as $val) 
        {
            $tgroup = strtolower($lib_item_group_name[$val['TRIM_GROUP']]);
            $category = strtolower($item_category[$item_cat_arr[$val['TRIM_GROUP']]]);
            $trimsDataArray[$category][$tgroup]['rcv_qty'] += $val['QNTY'];
            $trimsDataArray[$category][$tgroup]['rej_qty'] += $val['REJ_QTY'];
        }

        /*======================================================================================/
        /                               trims issue and rcv return                              /
        /======================================================================================*/
        $sqlacc = "SELECT d.job_no as JOB_NO,e.grouping as INT_REF,a.entry_form,a.issue_date, B.ITEM_GROUP_ID,C.QUANTITY AS QNTY FROM inv_issue_master a,inv_trims_issue_dtls b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type in(2,3) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(25,49) AND c.entry_form in(25,49) AND c.entry_form in(25,49) and a.item_category=4 and d.id=e.job_id and c.po_breakdown_id=e.id  $poCon2";
        // echo $sqlacc;die();
        $accRes = sql_select($sqlacc);
        foreach ($accRes as $val) 
        {
            $tgroup = strtolower($lib_item_group_name[$val['ITEM_GROUP_ID']]);
            $category = strtolower($item_category[$item_cat_arr[$val['ITEM_GROUP_ID']]]);
            if($val['ENTRY_FORM']==49)
            {
                $trimsDataArray[$category][$tgroup]['rcv_rtn_qty'] += $val['QNTY'];
            }
            if($val['ENTRY_FORM']==25)
            {
                $trimsDataArray[$category][$tgroup]['issue_qty'] += $val['QNTY'];
            }
        }

        /*======================================================================================/
        /                                    trims issue return                                   /
        /======================================================================================*/
        $sqlacc = "SELECT a.receive_date, d.job_no as JOB_NO,e.grouping as INT_REF, f.item_group_id as ITEM_GROUP_ID,b.CONS_QUANTITY AS QNTY FROM inv_receive_master a,inv_transaction b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e,product_details_master f where a.id=b.mst_id and b.id=c.trans_id and c.trans_type=4 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=73 AND c.entry_form = 73 AND c.entry_form = 73 and a.item_category=4 and d.id=e.job_id and c.po_breakdown_id=e.id and c.prod_id=f.id  $poCon2";
        // echo $sqlacc;die();
        $accRes = sql_select($sqlacc);
        foreach ($accRes as $val) 
        {
            $tgroup = strtolower($lib_item_group_name[$val['ITEM_GROUP_ID']]);
            $category = strtolower($item_category[$item_cat_arr[$val['ITEM_GROUP_ID']]]);
            $trimsDataArray[$category][$tgroup]['issue_rtn_qty'] += $val['QNTY'];
        }
        /*======================================================================================/
        /                                    LC and   PI Infor                                  /
        /======================================================================================*/
        $sqlpi = "SELECT d.job_no as JOB_NO,e.grouping as INT_REF, a.ID,a.PI_DATE,b.WORK_ORDER_NO,b.ITEM_GROUP as TRIM_GROUP from com_pi_master_details a, com_pi_item_details b,wo_booking_dtls c,wo_po_details_master d,wo_po_break_down e where a.id=b.pi_id and c.booking_no=b.work_order_no and c.po_break_down_id=e.id and d.id=e.job_id $poCon3 and a.item_category_id=4";//$tbCon
        // echo $sqlpi;die();
        $piRes = sql_select($sqlpi);
        $lib_pi_rcv_date = array();
        $lib_pi_no = array();
        $piDataArray = array();
        foreach ($piRes as $val) 
        {
            $tgroup = strtolower($lib_item_group_name[$val['TRIM_GROUP']]);
            $category = strtolower($item_category[$item_cat_arr[$val['TRIM_GROUP']]]);
            $piDataArray[$category][$tgroup]['pi_date'] .= $val['PI_DATE'].",";
            $lib_pi_no[$val['ID']] = $val['ID'];
        }
        $piIds = implode(",", $lib_pi_no);
        $pi_id_list_arr=array_chunk($lib_pi_no,999);
    
        if($piIds !="")
        {
            $piCon = " and ";
            $p=1;
            foreach($pi_id_list_arr as $pi_process)
            {
                if($p==1) $piCon .="  ( b.pi_id in(".implode(',',$pi_process).")"; 
                else  $piCon .=" or b.pi_id in(".implode(',',$pi_process).")";       
                
                $p++;
            }
            $piCon .=")";
        }

        $lcsql = "SELECT c.ITEM_GROUP as TRIM_GROUP, d.JOB_NO,f.grouping as INT_REF,a.LC_NUMBER from com_btb_lc_master_details a,com_btb_lc_pi b,com_pi_item_details c,wo_booking_dtls d,wo_po_details_master e,wo_po_break_down f where a.id=b.com_btb_lc_master_details_id and c.pi_id=b.pi_id and c.work_order_no=d.booking_no and d.po_break_down_id=f.id and f.job_id=e.id $piCon and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
        // echo $lcsql;die();
        $lcRes = sql_select($lcsql);
        $lc_array = array();
        foreach ($lcRes as $val) 
        {
            $tgroup = strtolower($lib_item_group_name[$val['TRIM_GROUP']]);
            $category = strtolower($item_category[$item_cat_arr[$val['TRIM_GROUP']]]);
            $lc_array[$category][$tgroup]['lc_number'] .= $val['LC_NUMBER'].",";
        }
        /*======================================================================================/
        /                                    trims transfer                                     /
        /======================================================================================*/
        $item_group_cond = where_con_using_array($item_group_id_arr,0,"b.item_group");
        // $sql = "SELECT b.item_category,b.item_group,b.transfer_qnty from inv_item_transfer_mst a,inv_item_transfer_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.entry_form in(78,112) $item_group_cond";

        $to_order_id_con =where_con_using_array($poIdArray,0,"a.to_order_id");
        $from_order_id_con =where_con_using_array($poIdArray,0,"a.from_order_id");

        $transfer_sql_in=sql_select("SELECT a.transfer_date, b.item_category,b.item_group,b.transfer_qnty as qnty FROM inv_item_transfer_mst a, inv_item_transfer_dtls b WHERE a.id = b.mst_id   and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=4 and a.entry_form in(78,112) $to_order_id_con $item_group_cond");
        $transfer_data=array();
        foreach ($transfer_sql_in as $row) 
        {
            $transfer_data[$row[csf('item_category')]][$row[csf('item_group')]]['in']+=$row[csf('qnty')];
        }
        $transfer_sql_out=sql_select("SELECT a.transfer_date, b.item_category,b.item_group,b.transfer_qnty as qnty FROM inv_item_transfer_mst a, inv_item_transfer_dtls b WHERE a.id = b.mst_id   and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=4 and a.entry_form in(78,112)  $from_order_id_con $item_group_cond");
        foreach ($transfer_sql_out as $row) 
        {
            $transfer_data[$row[csf('item_category')]][$row[csf('item_group')]]['out']+=$row[csf('qnty')];
        }
        
        // echo "<pre>"; print_r($transfer_data);die();
        /*======================================================================================/
        /                                   getting rowspan                                     /
        /======================================================================================*/
        $rowspan = array();
        foreach ($dataArray as $groupCatId => $groupCatData) 
        {
            foreach ($groupCatData as $groupId => $row) 
            {
                $rowspan[$groupCatId]++;                
            }
        }

        ob_start();
        ?>
        <div class="tableContainer">  
            <style type="text/css">
                .word_break_wrap{
                    word-wrap: break-word;
                    word-break: break-all;
                }
            </style>          
            <fieldset style="width:99%;">
                <div style="width:98%;">
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tr><td colspan="17" align="center" style="font-size:22px;">Accessories Summary Report <span style="color: red;font-size: 18px;font-weight: bold;"> <?=($client) ? ": ".$client_array[$client] : ": All"; ?></span></td></tr>
                        <tr><td colspan="17" align="center" style="font-size:14px;padding-bottom:10px;">Date : <? echo change_date_format($start_date);?> To <? echo change_date_format($end_date);?></td></tr>
                    </table>
                    <table width="100%" border="1" rules="all"  class="rpt_table"> 
                        <thead>
                            <tr style="font-size:12px"> 
                                <th width="11%">Item Category</th>
                                <th width="11%">Item Group</th>
                                <th width="6%">Req Qty</th>
                                <th width="6%">Excess Qty</th>
                                <th width="6%">Total Qty</th>
                                <th width="6%">Unit</th>
                                <th width="6%">Booking Qty</th>
                                <th width="6%">Booking Bal</th>
                                <th width="6%">Rcv Qty</th>
                                <th width="6%">Rcv Balance</th>
                                <th width="6%">Trans In</th>
                                <th width="6%">Trans Out</th>
                                <th width="6%">Overall Bal Qty</th>
                                <th width="6%">Issue Qty</th>
                                <th width="6%">Stock Qty</th>
                           </tr>
                        </thead>
                    </table>
                    <div style="width:101%;overflow-y:scroll;max-height:335px;" id="scroll_body">
                        <table width="100%" border="1" rules="all"  class="rpt_table">
                            <tbody>
                                <?
                                $i = 1;
                                ksort($dataArray);
                                foreach ($dataArray as $trims_cat => $trimsCatData) 
                                {                
                                    ksort($trimsCatData);                     
                                    foreach ($trimsCatData as $trims_group => $row) 
                                    {         

                                        $itm_id = $row['trim_group'];                               
                                        $book_qty = $bookingDataArray[$trims_cat][$trims_group]['book_qty'];
                                        $short_book_qty = $bookingDataArray[$trims_cat][$trims_group]['short_book_qty'];
                                        $booking_date = $bookingDataArray[$trims_cat][$trims_group]['booking_date'];
                                        $supplier_id = $bookingDataArray[$trims_cat][$trims_group]['supplier_id'];
                                        $booking_num = $bookingDataArray[$trims_cat][$trims_group]['booking_num'];
                                        $booking_no = $bookingDataArray[$trims_cat][$trims_group]['booking_no'];

                                        $rcv_qty = $trimsDataArray[$trims_cat][$trims_group]['rcv_qty'];
                                        $rej_qty = $trimsDataArray[$trims_cat][$trims_group]['rej_qty'];
                                        $rcv_rtn_qty = $trimsDataArray[$trims_cat][$trims_group]['rcv_rtn_qty'];

                                        $rcv_with_rtn = $rcv_qty - $rcv_rtn_qty;

                                        $issue_qty = $trimsDataArray[$trims_cat][$trims_group]['issue_qty'];
                                        $issue_rtn_qty = $trimsDataArray[$trims_cat][$trims_group]['issue_rtn_qty'];


                                        $pi_date = $piDataArray[$trims_cat][$trims_group]['pi_date'];


                                        $totQty = $row['req_qty']+$short_book_qty;
                                        $bookingBal = $totQty - ($book_qty+$short_book_qty);
                                        $balQty = $totQty - $rcv_with_rtn;
                                        $trans_in = $transfer_data[4][$itm_id]['in'];
                                        $trans_out = $transfer_data[4][$itm_id]['out'];
                                        $ovrl_bal = $totQty - ($rcv_with_rtn+$trans_in-$trans_out);

                                        $stock_qty = ($rcv_qty+$issue_rtn_qty+$trans_in) - ($issue_qty+$rcv_rtn_qty+$trans_out);
                                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                        ?>
                                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                                <? if($r==0){?>
                                                <td title="<? echo $trims_cat;?>" valign="middle" width="11%" rowspan="<? echo $rowspan[$trims_cat];?>"><? echo ucwords($trims_cat);?></td>
                                                <?}?>

                                                <td title="<? echo $trims_group;?>" width="11%">
                                                    <a href="##" onclick="show_acc_details_report('<?=$itm_id;?>');">
                                                        <? echo ucwords($trims_group);?>
                                                    </a>                                                        
                                                </td>
                                                
                                                <td width="6%" align="right"><? echo fn_number_format($row['req_qty'],0);?></td>
                                                <td width="6%" align="right"><? echo fn_number_format($short_book_qty,0);?></td>
                                                <td width="6%" align="right"><? echo fn_number_format($row['req_qty']+$short_book_qty,0);?></td>
                                                <td width="6%" align="center"><? echo $unit_of_measurement[$row['cons_uom']];?></td>
                                                <td width="6%" align="right"><? echo fn_number_format(($book_qty+$short_book_qty),0);?></td>
                                                <td width="6%" align="right"><? echo fn_number_format($bookingBal,0);?></td>
                                                <td width="6%" align="right" title="Receive=<?=$rcv_qty.',Return='.$rcv_rtn_qty;?>">
                                                    <? echo fn_number_format($rcv_with_rtn,0);?>
                                                        
                                                    </td>
                                                <td width="6%" align="right"><? echo fn_number_format($balQty,0);?></td>
                                                <td width="6%" align="right"><?=fn_number_format($trans_in,0); ?></td>
                                                <td width="6%" align="right"><?=fn_number_format($trans_out,0); ?></td>
                                                <td width="6%" align="right"><?=fn_number_format($ovrl_bal,0); ?></td>
                                                <td width="6%" align="right" title="Issue=<?=$issue_qty.',Return='.$issue_rtn_qty;?>">
                                                    <?=fn_number_format(($issue_qty-$issue_rtn_qty),0); ?>    
                                                </td>
                                                <td width="6%" align="right">
                                                    <a href="##" onclick="show_acc_popup('<?=$poIDS.'**'.$itm_id;?>');">
                                                        <?=fn_number_format($stock_qty,0); ?>
                                                    </a>
                                                </td>
                                            </tr>
                                        <?
                                        $i++;    
                                        $r++;                           
                                        
                                    }
                                }
                                ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </fieldset>
        </div>
        <?
        foreach (glob("$user_id*.xls") as $filename) 
        {
            if( @filemtime($filename) < (time()-$seconds_old) )
            @unlink($filename);
        }
        //---------end------------//
        $name=time();
        $filename="tmp/".$user_id."_".$name.".xls";
        $create_new_doc = fopen($filename, 'w');
        $is_created = fwrite($create_new_doc,ob_get_contents());
        //$filename=$user_id."_".$name.".xls";
        echo "$total_data####$filename####$rptType";
        exit();
    }
    elseif ($rptType==3) // Buyer summary button
    {
        $sqlCond = "";
        $sqlCond .= " and a.company_name=$company_id";
        // $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
        $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
        $sqlCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";
        $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
        // $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
        if($hidden_order_id!="")
        {
            $sqlCond .= ($hidden_order_id !="")   ? " and a.id in($hidden_order_id)" : "";
        }
        else
        {
            $sqlCond .= ($int_ref_no !="")   ? " and b.grouping like '$int_ref_no%'"      : "";
        }
        $sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";
        $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
        if($shipment_status==1)
        {
            $sqlCond .= " and b.shiping_status in(1,2)";
        }
        elseif ($shipment_status==2) {
            $sqlCond .= " and b.shiping_status in(3)";
        }
        $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
        $sqlCond .= ($status !=0) ? " and b.status_active = $status" : "";
        $sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
        // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";

        if($buyer_name==0)
        {
            if($_SESSION['logic_erp']["data_level_secured"]==1)
            {
                if($_SESSION['logic_erp']["buyer_id"]!="")
                {   
                    $sqlCond.=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")";
                }
            }
        }
        else
        {
            $sqlCond.=" and a.buyer_name=$buyer_name";
        }
        if($date_from !="" && $date_to !="")
        {
            if($db_type==0)
            {
                $start_date=change_date_format($date_from,"yyyy-mm-dd","");
                $end_date=change_date_format($date_to,"yyyy-mm-dd","");
            }
            else
            {
                $start_date=date("j-M-Y",strtotime($date_from));
                $end_date=date("j-M-Y",strtotime($date_to));
            }
            
            switch ($search_by) 
            {
                case 2:
                    $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                    break;
                case 3:
                   $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
                   break;
                case 4:
                    $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                    break;
                case 5:
                    $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                    break;
               
                default:
                    $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                    break;
            }
        }
        $sqlPopupCond = "$company_id**$buyer_name**$season_name**$merchant**$int_ref_no**$style_ref**$location_name**$shipment_status**$order_status**$status**$item_id**$date_from**$date_to**$search_by**$client";
        /*======================================================================================/
        /                                    main query                                         /
        /======================================================================================*/
        $sql = "SELECT a.id as job_id,a.job_no, A.BUYER_NAME,b.id as PO_ID,b.PO_TOTAL_PRICE,b.UNIT_PRICE,a.SET_SMV,(b.po_quantity*a.total_set_qnty) as PO_QNTY,sum(c.ORDER_QUANTITY) as PO_QUANTITY from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $sqlCond group by a.id,a.job_no, A.BUYER_NAME,b.id,b.PO_TOTAL_PRICE,b.UNIT_PRICE,a.SET_SMV,b.po_quantity,a.total_set_qnty order by b.po_quantity desc";
        // echo $sql;die();
        $sqlRes = sql_select($sql);
        if(count($sqlRes)==0)
        {
            echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
        }
        $poIdArray = array();
        $jobIdArray = array();
        $po_wise_job_arr = array();
        foreach ($sqlRes as $row) 
        {
            $order_data_arr[]=$row;            
            $poIdArray[$row['PO_ID']] = $row['PO_ID'];
            $jobIdArray[$row['JOB_ID']] = $row['JOB_ID'];
            $po_wise_job_arr[$row['PO_ID']] = $row['JOB_NO'];
        }
        $poIDS = implode(",", $poIdArray);
        $jobIDS = implode(",", $jobIdArray);
        // echo "<pre>";print_r($buyerDataArray);
        $po_id_list_arr=array_chunk($poIdArray,999);
    
        $poCon = " and ";$poCon2 = " and ";$poCon3 = " and ";$poCon4 = " and ";$poCon5 = " and ";$poCon6 = " and ";$poCon7 = " and ";$poCon8 = " and ";
        $p=1;
        foreach($po_id_list_arr as $po_process)
        {
            if($p==1) $poCon .="  ( a.po_break_down_id in(".implode(',',$po_process).")"; 
            else  $poCon .=" or a.po_break_down_id in(".implode(',',$po_process).")";
            
            if($p==1) $poCon2 .="  ( b.po_id in(".implode(',',$po_process).")"; 
            else  $poCon2 .=" or b.po_id in(".implode(',',$po_process).")";
            
            if($p==1) $poCon3 .="  ( po_break_down_id in(".implode(',',$po_process).")"; 
            else  $poCon3 .=" or po_break_down_id in(".implode(',',$po_process).")";
            
            if($p==1) $poCon4 .="  ( a.po_breakdown_id in(".implode(',',$po_process).")"; 
            else  $poCon4 .=" or a.po_breakdown_id in(".implode(',',$po_process).")";            
            
            if($p==1) $poCon5 .="  ( po_breakdown_id in(".implode(',',$po_process).")"; 
            else  $poCon5 .=" or po_breakdown_id in(".implode(',',$po_process).")";
            
            if($p==1) $poCon6 .="  ( b.order_id in(".implode(',',$po_process).")"; 
            else  $poCon6 .=" or b.order_id in(".implode(',',$po_process).")";

            if($p==1) $poCon7 .="  ( b.po_breakdown_id in(".implode(',',$po_process).")"; 
            else  $poCon7 .=" or b.po_breakdown_id in(".implode(',',$po_process).")";

            if($p==1) $poCon8 .="  ( b.po_break_down_id in(".implode(',',$po_process).")"; 
            else  $poCon8 .=" or b.po_break_down_id in(".implode(',',$po_process).")";            
            
            $p++;
        }
        $poCon .=")";$poCon2 .=")";$poCon3 .=")";$poCon4 .=")";$poCon5 .=")";$poCon6 .=")";$poCon7 .=")";$poCon8 .=")";
        /*======================================================================================/
        /                                    grey and fin fab qty                               /
        /======================================================================================*/
        $fab_sql="SELECT b.po_break_down_id as PO_ID ,b.GREY_FAB_QNTY,a.booking_no_prefix_num,a.booking_no,
        (CASE WHEN b.booking_type=1 THEN b.fin_fab_qnty END) as FIN_FAB_QNTY,a.fabric_source
        from wo_booking_mst a, wo_booking_dtls b,wo_po_break_down c,wo_po_details_master d where a.booking_no=b.booking_no and  b.po_break_down_id=c.id and d.job_no=c.job_no_mst  and b.booking_type=1 and b.status_active=1 and b.is_deleted=0 $poCon8";//and a.fabric_source=1
        // echo $fab_sql;die();
        $fab_result = sql_select($fab_sql);// or die(mysql_error());
        foreach($fab_result as $row)
        { 
            $ff_qnty_array[$row['PO_ID']][$row['FABRIC_SOURCE']]+=$row['FIN_FAB_QNTY'];
            if($row['FABRIC_SOURCE']==1)
            {
                $gf_qnty_array[$row['PO_ID']]+=$row['GREY_FAB_QNTY']; 
            }      
        }
        unset($fab_result);        

        // ======================================= finish fab transfer =====================
        $transPoCond = str_replace("a.po_break_down_id", "a.to_order_id", $poCon);
	    $sqlTrnsfrIn = "SELECT e.po_breakdown_id,e.QUANTITY from inv_item_transfer_mst a,inv_item_transfer_dtls b,wo_po_details_master c,wo_po_break_down d,order_wise_pro_details e where a.id=b.mst_id and c.id=d.job_id and a.item_category=2 and e.dtls_id=b.id and e.trans_type=5 and e.po_breakdown_id=d.id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transfer_criteria=4 and a.entry_form=14 and d.id=a.to_order_id  $transPoCond";
        // echo $sqlTrnsfrIn;die;
        $trnsfrResIn = sql_select($sqlTrnsfrIn);
        $transfer_in_data_array = array();
        foreach ($trnsfrResIn as $val) 
        {
            $transfer_in_data_array[$val['PO_BREAKDOWN_ID']] += $val['QUANTITY'];
        }
        // ============================================================
        $transPoCond = str_replace("a.po_break_down_id", "a.from_order_id", $poCon);
	    $sqlTrnsfrOut = "SELECT e.po_breakdown_id,e.QUANTITY from inv_item_transfer_mst a,inv_item_transfer_dtls b,wo_po_details_master c,wo_po_break_down d,order_wise_pro_details e where a.id=b.mst_id and c.id=d.job_id and a.item_category=2 and e.dtls_id=b.id and e.trans_type=6 and e.po_breakdown_id=d.id and e.dtls_id=b.id and e.po_breakdown_id=d.id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transfer_criteria=4 and a.entry_form=14 and d.id=a.from_order_id  $transPoCond";
        // echo $sqlTrnsfrOut;die;
        $trnsfrResOut = sql_select($sqlTrnsfrOut);
        $transfer_out_data_array = array();
        foreach ($trnsfrResOut as $val) 
        {
            $transfer_out_data_array[$val['PO_BREAKDOWN_ID']] += $val['QUANTITY'];
        }

        /*======================================================================================/
        /                                   grey fab qty                                        /
        /======================================================================================*/
        $recvData=sql_select("SELECT a.PO_BREAKDOWN_ID, sum(quantity) as GREY_PROD_QNTY from order_wise_pro_details a, pro_grey_prod_entry_dtls b where a.dtls_id=b.id and a.prod_id=b.prod_id and a.entry_form =2 and a.is_deleted=0 and a.status_active=1 $poCon4 group by a.po_breakdown_id");
        foreach($recvData as $row)
        {
            $gp_qty_array[$row['PO_BREAKDOWN_ID']]=$row['GREY_PROD_QNTY'];
        }
        unset($recvData);
        /*======================================================================================/
        /                                    grey fab issue                                     /
        /======================================================================================*/
        $dataArrayYarnIssuesQty = array();
         $sqlsTrans="SELECT  b.PO_BREAKDOWN_ID, sum(b.quantity) as QNTY from inv_transaction a, order_wise_pro_details b where a.id=b.trans_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.entry_form in(16,19,61) and a.item_category=13 and a.transaction_type in(2) and b.trans_type in(2) $poCon7 group by  b.po_breakdown_id";
        $results_trans=sql_select( $sqlsTrans );
        foreach ($results_trans as $row)
        {
            $dataArrayYarnIssuesQty[$row['PO_BREAKDOWN_ID']]['qnty']+=$row['QNTY'];
        }
        /*======================================================================================/
        /                                    yarn allocation                                    /
        /======================================================================================*/
        $yarn_allocation_arr = return_library_array("select po_break_down_id, sum(qnty) as qnty from inv_material_allocation_dtls where item_category = 1 and  status_active = 1 and is_deleted=0 $poCon3 group by po_break_down_id", "po_break_down_id", "qnty");
        /*======================================================================================/
        /                                    yarn issue                                         /
        /======================================================================================*/
        $yarn_issue_array=return_library_array( "SELECT po_breakdown_id, sum(case when entry_form=3 then quantity else 0 end) - sum(case when entry_form=9 then quantity else 0 end) as quantity from order_wise_pro_details where entry_form in(3,9) $poCon5 and status_active=1 and is_deleted=0 and is_sales !=1 group by po_breakdown_id", "po_breakdown_id", "quantity");
        /*======================================================================================/
        /                                    yarn issue rtn                                     /
        /======================================================================================*/
        $issue_return=sql_select("SELECT a.entry_form,a.po_breakdown_id as PO_ID,a.prod_id,a.QUANTITY 
            from order_wise_pro_details a,inv_transaction b where a.trans_id=b.id and a.trans_type=4 and b.transaction_type in(4) and a.entry_form=9 and a.status_active=1 and a.is_deleted=0  and b.status_active=1 and b.is_deleted=0 $poCon4 ");
        foreach ($issue_return as $row)
        {
            $dataArrayYarnIssues_ret_arr[$row['PO_ID']] += $row['QUANTITY'];
        }
        /*======================================================================================/
        /                                    fab dyeing qty                                     /
        /======================================================================================*/
        $daying_qnty_array=return_library_array( "SELECT sum(b.batch_qnty) as batch_qnty,b.po_id from pro_batch_create_mst a,pro_batch_create_dtls b, pro_fab_subprocess c where a.id=b.mst_id and a.id=c.batch_id and c.load_unload_id=2 and c.entry_form=35 and a.batch_against<>2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $poCon2  group by b.po_id", "po_id", "batch_qnty");

        
        // ======================================= DYEING PRODUCTION (Outbound) ==============================   
        $poIdsCondFin = str_replace("a.po_break_down_id", "c.po_breakdown_id", $poCon);
        $sqlDyeing = "SELECT c.po_breakdown_id,b.grey_used_qty as QNTY from inv_receive_master a,pro_finish_fabric_rcv_dtls b,order_wise_pro_details c where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 $poIdsCondFin and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(37) and c.entry_form in(37) and a.item_category=2 and a.receive_basis=11 and a.company_id=$company_id";
         // echo $sqlDyeing;die();
        $dyeingRes = sql_select($sqlDyeing);
        $dyeingProdOutArr = array();
        foreach ($dyeingRes as  $val) 
        {
            $dyeingProdOutArr[$val['PO_BREAKDOWN_ID']] += $val['QNTY'];
        }

        /*======================================================================================/
        /                                    fab available qty                                  /
        /======================================================================================*/
        /*if(return_field_value("auto_update","variable_settings_production","company_name=$cbo_company_name and variable_list=15 and item_category_id=2 order by id","auto_update")==2)
        {
            $fabrics_avl_qnty_array=return_library_array( "SELECT po_breakdown_id, sum(quantity) as quantity from order_wise_pro_details where entry_form in(17,37) $poCon5 and status_active=1 and is_deleted=0 group by po_breakdown_id", "po_breakdown_id", "quantity"); 
        }
        else
        {
            $fabrics_avl_qnty_array=return_library_array( "SELECT po_breakdown_id, sum(quantity) as quantity from order_wise_pro_details where entry_form=7 $poCon5 and status_active=1 and is_deleted=0 group by po_breakdown_id
            union all
            select a.po_breakdown_id, sum(a.quantity) as quantity from order_wise_pro_details a, inv_transaction b where  a.trans_id = b.id and  a.entry_form in(37,17) $poCon5 and b.receive_basis in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  group by a.po_breakdown_id", "po_breakdown_id", "quantity");

        }*/
        $poIdsCondFin = str_replace("po_breakdown_id", "e.id", $poCon5);
        $sqlFinFab = "SELECT a.receive_basis, e.id as PO_ID,c.quantity as QNTY from inv_receive_master a,inv_transaction b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e where a.id=b.mst_id and b.id=c.trans_id and b.transaction_type=1 and e.id=c.po_breakdown_id and e.job_id=d.id $poIdsCondFin and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(7,37) and a.item_category=2 and a.receive_basis in(1,2,11,5)";
         // echo $sqlFinFab;die();
        $finFabRes = sql_select($sqlFinFab);
        $fabrics_avl_qnty_array = array();
        foreach ($finFabRes as  $val) 
        {
            if($val['RECEIVE_BASIS']==1 || $val['RECEIVE_BASIS']==2)
            {
                $fabrics_avl_qnty_array[$val['PO_ID']][2] += $val['QNTY'];
            }
            else
            {
                $fabrics_avl_qnty_array[$val['PO_ID']][1] += $val['QNTY'];
            }
        }

        /*======================================================================================/
        /                                    fab lay qty                                       /
        /======================================================================================*/
        $lay_sql="SELECT b.ORDER_ID,sum(b.size_qty) as QNTY from ppl_cut_lay_dtls a,ppl_cut_lay_bundle b where a.id=b.dtls_id and a.status_active=1 and b.status_active=1 $poCon6 group by b.order_id ";
        // echo $lay_sql;die();
        foreach(sql_select($lay_sql) as $rows)
        {
            $po_buyer=$po_buyer_array[$rows['ORDER_ID']]['buyer'];
            $job_no=$po_buyer_array[$rows['ORDER_ID']]['job_no'];
            
            $lay_cut_data[$job_no][$po_buyer]       += $rows['QNTY'];
            $lay_cut_data_dtls[$rows["ORDER_ID"]]   += $rows["QNTY"];
        }

        /*======================================================================================/
        /                          print,embro req qty from budget                              /
        /======================================================================================*/
        $condition= new condition();
        $condition->po_id_in($poIDS);
        $condition->jobid_in($jobIDS);
        $condition->init();
        $costPerArr=$condition->getCostingPerArr();
        $emblishment= new emblishment($condition);
        $emblishment_costing_arr=$emblishment->getQtyArray_by_orderAndEmbname();
        // echo"<pre>";print_r($costPerArr);die();

        /*$budgetPoCon = str_replace("a.po_break_down_id", "b.id", $poCon);

        $costing_per_sql=sql_select("SELECT JOB_NO,COSTING_PER from wo_pre_cost_mst");
        $costing_per_arr=array();
        foreach($costing_per_sql as $cost_val)
        {
            $costing_per_arr[$cost_val['JOB_NO']] = $cost_val['COSTING_PER'];
        }
        unset($costing_per_sql);

        $gmtsitemRatioArray = array();
        $gmtsitemRatioSql=sql_select('SELECT a.job_no AS JOB_NO,b.gmts_item_id AS GMTS_ITEM_ID ,b.set_item_ratio AS SET_ITEM_RATIO from wo_po_details_master a, wo_po_details_mas_set_details b where 1=1 and a.id=b.job_id');
        foreach($gmtsitemRatioSql as $gmtsitemRatioSqlRow)
        {
            $gmtsitemRatioArray[$gmtsitemRatioSqlRow['JOB_NO']][$gmtsitemRatioSqlRow['GMTS_ITEM_ID']]=$gmtsitemRatioSqlRow['SET_ITEM_RATIO'];    
        }
        unset($gmtsitemRatioSql);

        $emReqSql = "SELECT a.job_no AS JOB_NO,a.BUYER_NAME,a.total_set_qnty AS TOTAL_SET_QNTY,b.id AS ID,b.grouping as INT_REF,c.item_number_id AS ITEM_NUMBER_ID,c.order_quantity AS ORDER_QUANTITY ,c.plan_cut_qnty AS PLAN_CUT_QNTY,d.id AS EMBLISHMENT_ID,d.emb_name AS EMB_NAME,d.emb_type AS EMB_TYPE,d.cons_dzn_gmts AS CONS_DZN_GMTS_MST,d.rate AS RATE_MST,e.requirment AS CONS_DZN_GMTS from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_embe_cost_dtls d , wo_pre_cos_emb_co_avg_con_dtls e where 1=1  and d.emb_name in(1,2,4,5,99) and cons_dzn_gmts>0 and  a.id=b.job_id and a.id=c.job_id and a.id=d.job_id and a.id=e.job_id  and b.id=c.po_break_down_id and b.id=e.po_break_down_id and c.item_number_id= e.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.size_number_id and d.id=e.pre_cost_emb_cost_dtls_id    and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1 $budgetPoCon";
        // echo $emReqSql;die();

        $emReqRes = sql_select($emReqSql);  
        $emReqQtyArr = array();       
        foreach ($emReqRes as $key => $row) 
        {
            $costingPer = $costing_per_arr[$row['JOB_NO']];
            if($costingPer==1) $pcs_value=1*12;
            else if($costingPer==2) $pcs_value=1*1;
            else if($costingPer==3) $pcs_value=2*12;
            else if($costingPer==4) $pcs_value=3*12;
            else if($costingPer==5) $pcs_value=4*12;
            $gmtsitemRatio = $gmtsitemRatioArray[$row['JOB_NO']][$row['ITEM_NUMBER_ID']];
            $requirment=$row['CONS_DZN_GMTS_MST'];
            $reqQty = ($row['PLAN_CUT_QNTY']/$gmtsitemRatio)*($requirment/$pcs_value);
            // echo "(".$row['PLAN_CUT_QNTY']."/".$gmtsitemRatio.")*(".$requirment."/".$pcs_value.")<br>";

            $emReqQtyArr[$row['BUYER_NAME']][$row['EMB_NAME']] += $reqQty*$costingPer;
        }*/
        /*======================================================================================/
        /                                    gmts prod qty                                      /
        /======================================================================================*/
        $sql="SELECT a.PO_BREAK_DOWN_ID, 
        SUM(CASE WHEN a.production_type=1 THEN b.production_qnty END) as TOTALCUT,
        SUM(CASE WHEN a.production_type=4 THEN b.production_qnty END) as TOTALINPUT,
        SUM(CASE WHEN a.production_type=3 and a.embel_name=1 THEN b.production_qnty ELSE 0 END) as TOTALSPRINTING,
        SUM(CASE WHEN a.production_type=3 and a.embel_name=2 THEN b.production_qnty ELSE 0 END) as TOTALSEMBRO,
        SUM(CASE WHEN a.production_type=3 and a.embel_name=1 THEN b.reject_qty ELSE 0 END) as PRINTINGREJ,
        SUM(CASE WHEN a.production_type=3 and a.embel_name=2 THEN b.reject_qty ELSE 0 END) as EMBROREJ,
        SUM(CASE WHEN a.production_type=5 THEN b.production_qnty ELSE 0 END) as TOTALSEWING,
        SUM(CASE WHEN a.production_type=8 THEN b.production_qnty ELSE 0 END) as TOTALFINISH,
        SUM(CASE WHEN a.production_type=2 THEN b.production_qnty ELSE 0 END) as TOTAEMBISSUE,
        SUM(CASE WHEN a.production_type=3 THEN b.production_qnty ELSE 0 END) as TOTAEMBREC
        from pro_garments_production_mst a,pro_garments_production_dtls b
        WHERE  a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1  and b.is_deleted=0 $poCon group by po_break_down_id";
        // echo $sql;
        $dataArray=sql_select($sql);
        $emb_data_array = array();
        foreach($dataArray as $row)
        {  
            $cut_qnty_array[$row['PO_BREAK_DOWN_ID']]           = $row['TOTALCUT'];
            $sewing_in_qnty_array[$row['PO_BREAK_DOWN_ID']]     = $row['TOTALINPUT'];
            $sewing_out_qnty_array[$row['PO_BREAK_DOWN_ID']]    = $row['TOTALSEWING'];
            $sewing_finish_qnty_array[$row['PO_BREAK_DOWN_ID']] = $row['TOTALFINISH'];
            $emb_issue_qnty_array[$row['PO_BREAK_DOWN_ID']]     = $row['TOTAEMBISSUE'];
            $emb_rec_qnty_array[$row['PO_BREAK_DOWN_ID']]       = $row['TOTAEMBREC'];
            $emb_data_array[$row['PO_BREAK_DOWN_ID']]['print']  = $row['TOTALSPRINTING'];
            $emb_data_array[$row['PO_BREAK_DOWN_ID']]['embro']  = $row['TOTALSEMBRO'];
            $emb_data_array[$row['PO_BREAK_DOWN_ID']]['print_rej'] = $row['PRINTINGREJ'];
            $emb_data_array[$row['PO_BREAK_DOWN_ID']]['embro_rej'] = $row['EMBROREJ'];
        
        }
        unset($dataArray);
        /*======================================================================================/
        /                                    ex-factory qty                                     /
        /======================================================================================*/
        $ex_qnty_array=return_library_array( "SELECT po_break_down_id, sum(ex_factory_qnty) as ex_factory_qnty from pro_ex_factory_mst where  status_active=1 $poCon3 and is_deleted=0 group by po_break_down_id", "po_break_down_id", "ex_factory_qnty");
        // echo "SELECT po_break_down_id, sum(ex_factory_qnty) as ex_factory_qnty from pro_ex_factory_mst where  status_active=1 $poCon3 and is_deleted=0 group by po_break_down_id";die();

        $buyerDataArray = array();
        $buyer_tot_arr = array();
        foreach ($order_data_arr as $row) 
        {
            $costingPer = $costPerArr[$po_wise_job_arr[$row['PO_ID']]];
            $poQty = $row['PO_QUANTITY'];           
            $buyerDataArray[$row['BUYER_NAME']]['avg_smv']      += $row['SET_SMV']*$row['PO_QNTY'];
            $buyerDataArray[$row['BUYER_NAME']]['qty']          += $row['PO_QNTY'];
            $buyerDataArray[$row['BUYER_NAME']]['po_val']       += $row['PO_TOTAL_PRICE'];
            $buyerDataArray[$row['BUYER_NAME']]['po_quantity']  += $row['PO_QUANTITY'];
            $buyerDataArray[$row['BUYER_NAME']]['grey_prod']    += $gp_qty_array[$row['PO_ID']];
            $buyerDataArray[$row['BUYER_NAME']]['grey_to_dye']  += $dataArrayYarnIssuesQty[$row['PO_ID']]['qnty'];
            $buyerDataArray[$row['BUYER_NAME']]['grey_req']     += $gf_qnty_array[$row['PO_ID']];
            $buyerDataArray[$row['BUYER_NAME']]['yarn_alloc']   += $yarn_allocation_arr[$row['PO_ID']];
            $buyerDataArray[$row['BUYER_NAME']]['yarn_issue']   += $yarn_issue_array[$row['PO_ID']] - $dataArrayYarnIssues_ret_arr[$row['PO_ID']];
            $buyerDataArray[$row['BUYER_NAME']]['dyeing']       += $daying_qnty_array[$row['PO_ID']];
            $buyerDataArray[$row['BUYER_NAME']]['dyeing_out']   += $dyeingProdOutArr[$row['PO_ID']];
            $buyerDataArray[$row['BUYER_NAME']]['freq']         += $ff_qnty_array[$row['PO_ID']][1];
            $buyerDataArray[$row['BUYER_NAME']]['freq_pur']     += $ff_qnty_array[$row['PO_ID']][2];
            $buyerDataArray[$row['BUYER_NAME']]['favl']         += $fabrics_avl_qnty_array[$row['PO_ID']][1]+$transfer_in_data_array[$row['PO_ID']]-$transfer_out_data_array[$row['PO_ID']];
            $buyerDataArray[$row['BUYER_NAME']]['favl_pur']     += $fabrics_avl_qnty_array[$row['PO_ID']][2];
            $buyerDataArray[$row['BUYER_NAME']]['lay_cut_qty']  += $lay_cut_data_dtls[$row['PO_ID']];
            $buyerDataArray[$row['BUYER_NAME']]['cutting_qty']  += $cut_qnty_array[$row['PO_ID']];
            $buyerDataArray[$row['BUYER_NAME']]['emb_issue']    += $emb_issue_qnty_array[$row['PO_ID']];
            $buyerDataArray[$row['BUYER_NAME']]['emb_rec_qty']  += $emb_rec_qnty_array[$row['PO_ID']];
            $buyerDataArray[$row['BUYER_NAME']]['sewing_in']    += $sewing_in_qnty_array[$row['PO_ID']];
            $buyerDataArray[$row['BUYER_NAME']]['sewing_out']   += $sewing_out_qnty_array[$row['PO_ID']];
            $buyerDataArray[$row['BUYER_NAME']]['finish_qty']   += $sewing_finish_qnty_array[$row['PO_ID']];
            $buyerDataArray[$row['BUYER_NAME']]['exfactory_qty']+= $ex_qnty_array[$row['PO_ID']];

            $buyerDataArray[$row['BUYER_NAME']]['print']+= $emb_data_array[$row['PO_ID']]['print'];
            $buyerDataArray[$row['BUYER_NAME']]['print_req']+= $emblishment_costing_arr[$row['PO_ID']][1]*$costingPer;
            $buyerDataArray[$row['BUYER_NAME']]['embro']+= $emb_data_array[$row['PO_ID']]['embro'];
            $buyerDataArray[$row['BUYER_NAME']]['embro_req']+= $emblishment_costing_arr[$row['PO_ID']][2]*$costingPer;
            $buyerDataArray[$row['BUYER_NAME']]['print_rej']+= $emb_data_array[$row['PO_ID']]['print_rej'];
            $buyerDataArray[$row['BUYER_NAME']]['embro_rej']+= $emb_data_array[$row['PO_ID']]['embro_rej'];

            /*$buyer_tot_arr['po_quantity']       += $row[csf('po_quantity')];
            $buyer_tot_arr['po_val']            += $row[csf('po_total_price')]; 
            $buyer_tot_arr['cutting_qty']       += $cut_qnty_array[$row['PO_ID']];
            if($lay_cut_data[$row[csf('job_no')]][$row[csf('buyer_name')]]>0)
            {
                $buyer_tot_arr['lay_cut_qty']   += $lay_cut_data[$row[csf('job_no')]][$row[csf('buyer_name')]];
            }
            
            $buyer_tot_arr['sewing_in']         += $sewing_in_qnty_array[$row['PO_ID']];
            $buyer_tot_arr['sewing_out']        += $sewing_out_qnty_array[$row['PO_ID']];
            $buyer_tot_arr['finish_qty']        += $sewing_finish_qnty_array[$row['PO_ID']];
            $buyer_tot_arr['exfactory_qty']     += $ex_qnty_array[$row['PO_ID']];
            $buyer_tot_arr['emb_rec_qty']       += $emb_rec_qnty_array[$row['PO_ID']];
            
            $buyer_tot_arr['grey_req']          += round($gf_qnty_array[$row['PO_ID']]);
            $buyer_tot_arr['yarn_alloc']        += round($yarn_allocation_arr[$row['PO_ID']]);
            $buyer_tot_arr['yarn_issue']        += round($yarn_issue_array[$row['PO_ID']]-$dataArrayYarnIssues_ret_arr[$row['PO_ID']]['quantity']);
            $buyer_tot_arr['grey_prod']         += $gp_qty_array[$row['PO_ID']];
            $buyer_tot_arr['grey_to_dye']       += $dataArrayYarnIssuesQty[$row['PO_ID']]['qnty'];
            $buyer_tot_arr['dyeing']            += round($daying_qnty_array[$row['PO_ID']]);
            $buyer_tot_arr['freq']              += round($ff_qnty_array[$row['PO_ID']]);
            $buyer_tot_arr['favl']              += round($fabrics_avl_qnty_array[$row['PO_ID']]);
            $buyer_tot_arr['emb_issue']         += $emb_issue_qnty_array[$row['PO_ID']];*/
        }
        ob_start();
        ?>
        <div class="tableContainer">  
            <style type="text/css">        
            .GridViewScrollHeader TH, .GridViewScrollHeader TD 
            {
                padding: 2px 4px;
                font-weight: normal;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                text-align: left;
                vertical-align: middle;
            }

            .GridViewScrollHeader TH{
                background-image: -webkit-linear-gradient( rgb(194,220,255) 10%, rgb(136,170,214) 96%);
                border: 1px solid #8DAFDA;
                color:#444;
                font-size: 13px;
                font-weight: bold;
                text-align: center;
                line-height: 12px;
                height: 25px;
            }

            .GridViewScrollItem TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
               /* background-color: #FFFFFF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollItemFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #E9F3FF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollFooterFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-top: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                vertical-align: middle;
                font-weight: 700;
                background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB));
            }
            tr.GridViewScrollItemFreeze:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            tr.footerTr:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            html {
              --scrollbarBG: #CFD8DC;
              --thumbBG: #8ec5fc;
            }
            body::-webkit-scrollbar {
              width: 11px;
            }
            body {
              scrollbar-width: thin;
              scrollbar-color: var(--thumbBG) var(--scrollbarBG);
            }
            body::-webkit-scrollbar-track {
              background: var(--scrollbarBG);
            }
            body::-webkit-scrollbar-thumb {
              background-color: var(--thumbBG) ;
              border-radius: 6px;
              border: 3px solid var(--scrollbarBG);
            }
        </style>         
            <fieldset style="width:1310px;">
                <table width="100%" cellpadding="0" cellspacing="0">
                    <tr><td colspan="28" align="center" style="font-size:22px;">Buyer Summary <span style="color: red;font-size: 18px;font-weight: bold;"> <?=($client) ? ": ".$client_array[$client] : ": All"; ?></span></td></tr>
                    <tr><td colspan="28" align="center" style="font-size:18px;">Ship Date : <? echo change_date_format($date_from); ?> to <? echo change_date_format($date_to); ?></td></tr>
                </table>
                <table style="width: 100%; border-collapse: collapse;" border="1" rules="all"  class="rpt_table" align="left" id="gvMain"> 
                    <thead>
                        <tr class="GridViewScrollHeader"> 
                            <th>Sl</th>
                            <th>Buyer</th>
                            <th>PO Qty</th>
                            <th>Grey Req</th>
                            <th>Yarn Alloc</th>
                            <th>Alloc Bal</th>
                            <th>Grey Prod.</th>
                            <th>Grey Bal</th>
                            <th>Dyeing</th>
                            <th>Dyeing Bal</th>
                            <th>Fab Req Prod</th> 
                            <th>Fab Rcvd Prod</th>
                            <th>Balance</th>
                            <th>Fab Req Pur</th> 
                            <th>Fab Rcvd Pur</th>
                            <th>Balance</th>
                            <th>Cut Qc</th>
                            <th>Cut Bal</th>
                            <th>Print Req</th>
                            <th>Print Bal</th>
                            <th>Embo Req</th>
                            <th>Embo Bal</th>
                            <th>Sew Input</th>
                            <th>Input Bal</th>
                            <th>Output</th>
                            <th>Output Bal</th>
                            <th>Fin Qty</th>
                            <th>Fin Bal</th>
                            <th>Ship Qty</th>
                            <th>Ship Bal</th>
                       </tr>
                    </thead>
                    <tbody>
                        <? 
                        $i=1;
                        $gr_order_qty   = 0;
                        $gr_order_val   = 0;
                        $gr_grey_req    = 0;
                        $gr_yarn_alloc  = 0;
                        $gr_alloc_bal   = 0;
                        $gr_grey_qty    = 0;
                        $gr_grey_bal    = 0;
                        $gr_dyeing_qty  = 0;
                        $gr_dyeing_bal  = 0;
                        $gr_fab_req     = 0;
                        $gr_fab_rcvd    = 0;
                        $gr_fab_bal     = 0;
                        $gr_fab_req_pur = 0;
                        $gr_fab_rcvd_pur= 0;
                        $gr_fab_bal_pur = 0;
                        $gr_cuting_qc   = 0;
                        $gr_cuting_bal  = 0;
                        $gr_print_req   = 0;
                        $gr_print_bal   = 0;
                        $gr_embro_req   = 0;
                        $gr_embro_bal   = 0;
                        $gr_input_qty   = 0;
                        $gr_input_bal   = 0;
                        $gr_output_qty  = 0;
                        $gr_output_bal  = 0;
                        $gr_fin_qty     = 0;
                        $gr_fin_bal     = 0;
                        $gr_ship_qty    = 0;
                        $gr_ship_bal    = 0;
                        // for qty wise sort (big to small)
                        function aasort (&$array, $key) 
                        {
                            $sorter=array();
                            $ret=array();
                            reset($array);
                            foreach ($array as $ii => $va) {
                                $sorter[$ii]=$va[$key];
                            }
                            arsort($sorter);
                            foreach ($sorter as $ii => $va) {
                                $ret[$ii]=$array[$ii];
                            }
                            $array=$ret;
                        }

                        aasort($buyerDataArray,"qty");
                        foreach ($buyerDataArray as $buyer_id => $row) 
                        {
                            $avg_smv        = $row['avg_smv'];
                            $po_qty         = $row['po_quantity'];
                            $smv            = ($avg_smv/$po_qty);
                            $lay_cut_per    = ($row['lay_cut_qty']/$row['po_quantity'])*100;
                            $cut_per        = ($row['cutting_qty']/$row['po_quantity'])*100;
                            $finish_par     = ($row['finish_qty']/$row['po_quantity'])*100;
                            $exfactory_par  = ($row['exfactory_qty']/$row['po_quantity'])*100;
                            $alloc_bal      = $row['grey_req'] - $row['yarn_alloc'];
                            $grey_bal       = $row['grey_req'] - $row['grey_prod'];
                            $dyeing_bal     = $row['grey_req'] - ($row['dyeing']+$row['dyeing_out']);
                            $cutting_bal    = $po_qty - $row['lay_cut_qty'];

                            // $print_req      = $emReqQtyArr[$buyer_id][1];
                            $print_req      = $row['print_req'];
                            $print_qty      = $row['print'];
                            $print_rej      = $row['print_rej'];
                            $print_bal      = $print_req - ($print_qty - $print_rej);
                            // $embro_req      = $emReqQtyArr[$buyer_id][2];
                            $embro_req      = $row['embro_req'];
                            $embro_qty      = $row['embro'];
                            $embro_rej      = $row['embro_rej'];
                            $embro_bal      = $embro_req - ($embro_qty - $embro_rej);
                            $input_bal      = $po_qty - $row['sewing_in'];
                            $output_bal     = $po_qty - $row['sewing_out'];
                            $finish_bal     = $po_qty - $row['finish_qty'];
                            $ship_bal       = $po_qty - $row['exfactory_qty'];

                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>
                            <tr class="GridViewScrollItem" bgcolor="<? echo $bgcolor; ?>" onclick="change_color('str_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="str_<? echo $i; ?>" style="font-size:12px;" valign="middle">
                                <td> <? echo $i; ?></td>
                                <td title="<?=$buyer_short_name_arr[$buyer_id];?>">
                                    <a href="javascript:void(0)" onClick="open_buyer_summary_popup('<? echo $sqlPopupCond;?>','<? echo $buyer_id; ?>' ,'<? echo $date_from; ?>' ,'<? echo $date_to; ?>','buyer_summary_popup')">
                                        <? echo substr($buyer_short_name_arr[$buyer_id], 0,6);?>
                                    </a>
                                </td>
                                <td align="right"><? echo fn_number_format($po_qty,0); ?></td>
                                <td align="right"><? echo fn_number_format($row['grey_req'],0); ?></td>
                                <td align="right"><? echo fn_number_format($row['yarn_alloc'],0); ?></td>
                                <td align="right"><? echo fn_number_format($alloc_bal,0); ?></td>
                                <td align="right"><? echo fn_number_format($row['grey_prod'],0); ?></td>
                                <td align="right"><? echo fn_number_format($grey_bal,0); ?></td>
                                <td align="right" title="Inhouse=<?=$row['dyeing'].',Outbound='.$row['dyeing_out'];?>">
                                    <? echo fn_number_format(($row['dyeing']+$row['dyeing_out']),0); ?>
                                </td>
                                <td align="right"><? echo fn_number_format($dyeing_bal,0); ?></td>
                                <td align="right"><? echo fn_number_format($row['freq'],0); ?></td>
                                <td align="right"><? echo fn_number_format($row['favl'],0); ?></td>
                                <td align="right"><? echo fn_number_format(($row['freq']-$row['favl']),0); ?></td>
                                <td align="right"><? echo fn_number_format($row['freq_pur'],0); ?></td>
                                <td align="right"><? echo fn_number_format($row['favl_pur'],0); ?></td>
                                <td align="right"><? echo fn_number_format(($row['freq_pur']-$row['favl_pur']),0); ?></td>
                                <td align="right"><? echo fn_number_format($row['lay_cut_qty'],0); ?></td>
                                <td align="right"><? echo fn_number_format($cutting_bal,0); ?></td>
                                <td align="right"><? echo fn_number_format($print_req,0); ?></td>
                                <td align="right"><? echo fn_number_format($print_bal,0); ?></td>
                                <td align="right"><? echo fn_number_format($embro_req,0); ?></td>
                                <td align="right"><? echo fn_number_format($embro_bal,0); ?></td>
                                <td align="right"><? echo fn_number_format($row['sewing_in'],0); ?></td>
                                <td align="right"><? echo fn_number_format($input_bal,0); ?></td>
                                <td align="right"><? echo fn_number_format($row['sewing_out'],0); ?></td>
                                <td align="right"><? echo fn_number_format($output_bal,0); ?></td>
                                <td align="right"><? echo fn_number_format($row['finish_qty'],0); ?></td>
                                <td align="right"><? echo fn_number_format($finish_bal,0); ?></td>
                                <td align="right"><? echo fn_number_format($row['exfactory_qty'],0); ?></td>
                                <td align="right"><? echo fn_number_format($ship_bal,0); ?></td>
                            </tr>
                            <? 
                            $i++;
                            $gr_order_qty   += $po_qty;
                            $gr_order_val   += $row['po_val'];
                            $gr_grey_req    += $row['grey_req'];
                            $gr_yarn_alloc  += $row['yarn_alloc'];
                            $gr_alloc_bal   += $alloc_bal;
                            $gr_grey_qty    += $row['grey_prod'];
                            $gr_grey_bal    += $grey_bal;
                            $gr_dyeing_qty  += ($row['dyeing']+$row['dyeing_out']);
                            $gr_dyeing_bal  += $dyeing_bal;
                            $gr_fab_req     += $row['freq'];
                            $gr_fab_rcvd    += $row['favl'];
                            $gr_fab_bal     += $row['freq']-$row['favl'];
                            $gr_fab_req_pur += $row['freq_pur'];
                            $gr_fab_rcvd_pur+= $row['favl_pur'];
                            $gr_fab_bal_pur += $row['freq_pur']-$row['favl_pur'];
                            $gr_cuting_qc   += $row['lay_cut_qty'];
                            $gr_cuting_bal  += $cutting_bal;
                            $gr_print_req   += $print_req;
                            $gr_print_bal   += $print_bal;
                            $gr_embro_req   += $embro_req;
                            $gr_embro_bal   += $embro_bal;
                            $gr_input_qty   += $row['sewing_in'];
                            $gr_input_bal   += $input_bal;
                            $gr_output_qty  += $row['sewing_out'];
                            $gr_output_bal  += $output_bal;
                            $gr_fin_qty     += $row['finish_qty'];
                            $gr_fin_bal     += $finish_bal;
                            $gr_ship_qty    += $row['exfactory_qty'];
                            $gr_ship_bal    += $ship_bal;
                        }
                        
                       ?>
                    </tbody>
                    
                    <tr class="GridViewScrollItem footerTr">
                        <td> <div class="gridViewScrollHelper"></div></td>   
                        <td align="right">Total</td>   
                        <td align="right"><? echo fn_number_format($gr_order_qty,0);?></td> 
                        <td align="right"><? echo fn_number_format($gr_grey_req,0);?></td> 
                        <td align="right"><? echo fn_number_format($gr_yarn_alloc,0);?></td>   
                        <td align="right"><? echo fn_number_format($gr_alloc_bal,0);?></td>   
                        <td align="right"><? echo fn_number_format($gr_grey_qty,0);?></td>    
                        <td align="right"><? echo fn_number_format($gr_grey_bal,0);?></td>  
                        <td align="right"><? echo fn_number_format($gr_dyeing_qty,0);?></td>   
                        <td align="right"><? echo fn_number_format($gr_dyeing_bal,0);?></td>   
                        <td align="right"><? echo fn_number_format($gr_fab_req,0);?></td> 
                        <td align="right"><? echo fn_number_format($gr_fab_rcvd,0);?></td> 
                        <td align="right"><? echo fn_number_format($gr_fab_bal,0);?></td>   
                        <td align="right"><? echo fn_number_format($gr_fab_req_pur,0);?></td> 
                        <td align="right"><? echo fn_number_format($gr_fab_rcvd_pur,0);?></td> 
                        <td align="right"><? echo fn_number_format($gr_fab_bal_pur,0);?></td>
                        <td align="right"><? echo fn_number_format($gr_cuting_qc,0);?></td> 
                        <td align="right"><? echo fn_number_format($gr_cuting_bal,0);?></td>
                        <td align="right"><? echo fn_number_format($gr_print_req,0);?></td>    
                        <td align="right"><? echo fn_number_format($gr_print_bal,0);?></td>    
                        <td align="right"><? echo fn_number_format($gr_embro_req,0);?></td>    
                        <td align="right"><? echo fn_number_format($gr_embro_bal,0);?></td>  
                        <td align="right"><? echo fn_number_format($gr_input_qty,0);?></td>    
                        <td align="right"><? echo fn_number_format($gr_input_bal,0);?></td>    
                        <td align="right"><? echo fn_number_format($gr_output_qty,0);?></td>   
                        <td align="right"><? echo fn_number_format($gr_output_bal,0);?></td>   
                        <td align="right"><? echo fn_number_format($gr_fin_qty,0);?></td>   
                        <td align="right"><? echo fn_number_format($gr_fin_bal,0);?></td>   
                        <td align="right"><? echo fn_number_format($gr_ship_qty,0);?></td>  
                        <td align="right"><? echo fn_number_format($gr_ship_bal,0);?></td> 
                    </tr>   
                    
                    
                </table>
            </fieldset>
        </div>
        <script type="text/javascript" src="../../../js/gridviewscroll.js"></script>
        <script type="text/javascript">
            var gridViewScroll = null;
            fnGridView = function () {
                gridViewScroll = new GridViewScroll({
                    elementID: "gvMain",
                    width: screen.width-30,
                    // width: 1335,
                    height: 380,
                    freezeColumn: true,
                    freezeFooter: true,
                    freezeColumnCssClass: "GridViewScrollItemFreeze",
                    freezeFooterCssClass: "GridViewScrollFooterFreeze",
                    freezeHeaderRowCount: 1,
                    freezeColumnCount: 3,
                    onscroll: function (scrollTop, scrollLeft) {
                        console.log(scrollTop + " - " + scrollLeft);
                    }
                });
                gridViewScroll.enhance();
            }
            function getScrollPosition() {
                var position = gridViewScroll.scrollPosition;
                alert("scrollTop: " + position.scrollTop + ", scrollLeft: " + position.scrollLeft);
            }
            function setScrollPosition() {
                var scrollPosition = { scrollTop: 50, scrollLeft: 50};

                gridViewScroll.scrollPosition = scrollPosition;
            }
            fnGridView();
            //=================================================
            
        </script>
        <?
        foreach (glob("$user_id*.xls") as $filename) 
        {
            if( @filemtime($filename) < (time()-$seconds_old) )
            @unlink($filename);
        }
        //---------end------------//
        $name=time();
        $filename="tmp/".$user_id."_".$name.".xls";
        $create_new_doc = fopen($filename, 'w');
        $is_created = fwrite($create_new_doc,ob_get_contents());
       // $filename=$user_id."_".$name.".xls";
        echo "$total_data####$filename";
        exit();
    }
    elseif ($rptType==4) // Style summary button
    {
        /*------------------------------------------------------------------------------/
        /                        MAKING CONDITION FOR BUDGET                            /
        /------------------------------------------------------------------------------*/

        $budgetCond = "";
        $budgetCond .= " and a.company_name=$company_id";
        // $budgetCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
        $budgetCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
        $budgetCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";
        $budgetCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
        // $budgetCond .= ($int_ref_no !="")  ? " and b.grouping like '$int_ref_no%'"      : "";
        if($hidden_order_id!="")
        {
            $sqlCond .= ($hidden_order_id !="")   ? " and a.id in($hidden_order_id)" : "";
        }
        else
        {
            $sqlCond .= ($int_ref_no !="")   ? " and b.grouping like '$int_ref_no%'"      : "";
        }
        $budgetCond .= ($style_ref !="")   ? " and a.style_ref_no like '$style_ref%'" : "";
        $budgetCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
        if($shipment_status==1)
        {
            $budgetCond .= " and b.shiping_status in(1,2)";
        }
        elseif ($shipment_status==2) {
            $budgetCond .= " and b.shiping_status in(3)";
        }
        $budgetCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
        $budgetCond .= ($status !=0) ? " and b.status_active in($status)" : "";
        $budgetCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
        // $budgetCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";

        if($buyer_name==0)
        {
            if($_SESSION['logic_erp']["data_level_secured"]==1)
            {
                if($_SESSION['logic_erp']["buyer_id"]!="")
                {   
                    $budgetCond.=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")";
                }
            }
        }
        else
        {
            $budgetCond.=" and a.buyer_name=$buyer_name";
        }
        if($date_from !="" && $date_to !="")
        {
            if($db_type==0)
            {
                $start_date=change_date_format($date_from,"yyyy-mm-dd","");
                $end_date=change_date_format($date_to,"yyyy-mm-dd","");
            }
            else
            {
                $start_date=date("j-M-Y",strtotime($date_from));
                $end_date=date("j-M-Y",strtotime($date_to));
            }
            
            switch ($search_by) 
            {
                case 2:
                    $budgetCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                    break;
                case 3:
                   $budgetCond .= " and b.po_received_date between '$start_date' and '$end_date'";
                   break;
                case 5:
                    $budgetCond .= " and b.insert_date between '$start_date' and '$end_date'";
                    break;
               
                default:
                    $budgetCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                    break;
            }
        }      

        /*------------------------------------------------------------------------------/
        /                     GEIIING PO FROM BUDGET FOR EMBLISHMENT                    /
        /------------------------------------------------------------------------------*/
        
        if($emblishment!=0)
        {
            if($emblishment==1) // aop
            {
                $sqlemb = sql_select("SELECT b.ID from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_avg_con_dtls d where a.id=b.job_id and a.job_no=c.job_no and c.id=d.pre_cost_fabric_cost_dtls_id and b.id=d.po_break_down_id and c.color_type_id in(5) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 $budgetCond  and d.CONS>0");
                
            }
            elseif ($emblishment==2) // yarn dyeing
            {
                $sqlemb = sql_select("SELECT b.ID from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e,wo_pre_cost_fab_conv_cost_dtls f where a.id=b.job_id and a.id=c.job_id and a.id=d.job_id and a.id=e.job_id and a.id=f.job_id and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and d.id=f.fabric_description and e.cons !=0 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and c.is_deleted=0 and c.status_active=1 and d.is_deleted=0 and d.status_active=1 and e.is_deleted=0 and e.status_active=1 and f.is_deleted=0 and f.status_active=1 and f.cons_process in(30) $budgetCond");
            }
            elseif ($emblishment==3 || $emblishment==4 || $emblishment==5) // wash - print - emb
            {
                $embCond = '';
                if($emblishment==3) // wash
                {
                    $embCond = "and d.emb_name in(3)";
                }
                elseif($emblishment==4) // print
                {
                    $embCond = "and d.emb_name in(1)";
                }
                else // emb
                {
                    $embCond = "and d.emb_name in(2)";
                }

                $sqlemb = sql_select("SELECT b.ID  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_embe_cost_dtls d , wo_pre_cos_emb_co_avg_con_dtls e where 1=1 $embCond and cons_dzn_gmts>0 and a.id=b.job_id and a.id=c.job_id and a.id=d.job_id and a.id=e.job_id and b.id=c.po_break_down_id and b.id=e.po_break_down_id and c.item_number_id= e.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.size_number_id and d.id=e.pre_cost_emb_cost_dtls_id and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and c.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.is_deleted=0 and d.status_active=1 $budgetCond  and e.REQUIRMENT>0");
            }
            elseif ($emblishment==6) // fab. source
            {
                $sqlemb = sql_select("SELECT b.ID from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_avg_con_dtls d where a.id=b.job_id and a.job_no=c.job_no and c.id=d.pre_cost_fabric_cost_dtls_id and b.id=d.po_break_down_id and c.fabric_source in(2) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 $budgetCond  and d.CONS>0");
            }
            // echo $sqlemb;die();
            $embPoArray = array();
            if(count($sqlemb)>0)
            {
                 foreach ($sqlemb as $val) 
                 {
                     $embPoArray[$val['ID']] = $val['ID'];
                 }
            }
            if(count($embPoArray)==0)
            {
                echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
            }
        }
        // echo "<pre>";print_r($embPoArray);die();
        
        if(count($embPoArray))
        {
            $embBklogPoIds = implode(",", $embPoArray);
            
            if($db_type==2 && count($embBklogPoArray)>1000)
            {
                $embBklogPoCond=" and (";
                $poIdsArr=array_chunk($embBklogPoArray,999);
                foreach($poIdsArr as $ids)
                {
                    $ids=implode(",",$ids);
                    $embBklogPoCond.=" b.id in($ids) or ";
                }
                $embBklogPoCond=chop($embBklogPoCond,'or ');
                $embBklogPoCond.=")";
            }
            else
            {
                $embBklogPoCond=" and b.id in($embBklogPoIds)";
            }
        }
       
        // echo $embBklogPoCond;die();
        
        
        //=========================================================================================================
        $sqlCond = "";
        $sqlCond .= " and a.company_name=$company_id";
        // $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
        $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
        $sqlCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";   
        $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
        $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
        $sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";
        $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
        if($shipment_status==1)
        {
            $sqlCond .= " and b.shiping_status in(1,2)";
        }
        elseif ($shipment_status==2) {
            $sqlCond .= " and b.shiping_status in(3)";
        }
        $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
        $sqlCond .= ($status !=0) ? " and b.status_active in($status)" : "";
        $sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
        // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";

        if($buyer_name==0)
        {
            if($_SESSION['logic_erp']["data_level_secured"]==1)
            {
                if($_SESSION['logic_erp']["buyer_id"]!="")
                {   
                    $sqlCond.=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")";
                }
            }
        }
        else
        {
            $sqlCond.=" and a.buyer_name=$buyer_name";
        }
        if($date_from !="" && $date_to !="")
        {
            if($db_type==0)
            {
                $start_date=change_date_format($date_from,"yyyy-mm-dd","");
                $end_date=change_date_format($date_to,"yyyy-mm-dd","");
            }
            else
            {
                $start_date=date("j-M-Y",strtotime($date_from));
                $end_date=date("j-M-Y",strtotime($date_to));
            }
            
            switch ($search_by) 
            {
                case 2:
                    $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                    break;
                case 3:
                   $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
                   break;
                case 4:
                    $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                    break;
                case 5:
                    $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                    break;
               
                default:
                    $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                    break;
            }
        }

        $costing_per_sql=sql_select("SELECT JOB_NO,COSTING_PER from wo_pre_cost_mst");
        $costing_per_arr=array();
        foreach($costing_per_sql as $cost_val)
        {
            $costing_per_arr[$cost_val['JOB_NO']] = $cost_val['COSTING_PER'];
        }
        unset($costing_per_sql);

        $gmtsitemRatioArray = array();
        $gmtsitemRatioSql=sql_select('SELECT a.job_no AS JOB_NO,b.gmts_item_id AS GMTS_ITEM_ID ,b.set_item_ratio AS SET_ITEM_RATIO from wo_po_details_master a, wo_po_details_mas_set_details b where 1=1 and a.id=b.job_id');
        foreach($gmtsitemRatioSql as $gmtsitemRatioSqlRow)
        {
            $gmtsitemRatioArray[$gmtsitemRatioSqlRow['JOB_NO']][$gmtsitemRatioSqlRow['GMTS_ITEM_ID']]=$gmtsitemRatioSqlRow['SET_ITEM_RATIO'];    
        }
        unset($gmtsitemRatioSql);
        
        $lib_buyer = return_library_array("select id,buyer_name from lib_buyer", "id", "buyer_name");
        /*======================================================================================/
        /                                    main query                                         /
        /======================================================================================*/       
        $sql = "SELECT a.job_no AS JOB_NO,a.style_ref_no as STYLE,a.buyer_name AS BUYER_NAME,b.id AS PO_ID,b.grouping as INT_REF,c.order_quantity AS ORDER_QUANTITY from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where 1=1 and a.id=b.job_id and b.id=c.po_break_down_id and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and c.is_deleted=0 and c.status_active=1 $sqlCond $embBklogPoCond order by b.grouping";//$sqlCond
        // echo $sql;die();
        $sqlRes = sql_select($sql);
        if(count($sqlRes)==0)
        {
            echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
        }
        $poIdArray = array();
        $dataArray = array();
        foreach ($sqlRes as $row) 
        {
            $dataArray[strtolower($lib_buyer[$row['BUYER_NAME']])][$row['INT_REF']]['style'] = $row['STYLE'];       
            $dataArray[strtolower($lib_buyer[$row['BUYER_NAME']])][$row['INT_REF']]['buyer_name'] = $row['BUYER_NAME'];       
            $dataArray[strtolower($lib_buyer[$row['BUYER_NAME']])][$row['INT_REF']]['order_quantity'] += $row['ORDER_QUANTITY'];

            $poIdArray[$row['PO_ID']] = $row['PO_ID'];
        }
        // echo "<pre>";print_r($dataArray);die();
        $poIDS = implode(",", $poIdArray);
        $po_id_list_arr=array_chunk($poIdArray,999);
    
        $poCon = " and ";
        $p=1;
        foreach($po_id_list_arr as $po_process)
        {
            if($p==1) $poCon .="  ( b.id in(".implode(',',$po_process).")"; 
            else  $poCon .=" or b.id in(".implode(',',$po_process).")";
            
            $p++;
        }
        $poCon .=")";
        // ======================================= Yarn req  ==================================
        $poIdsCondYarn = str_replace("b.id", "c.po_break_down_id", $poCon);
        $sqlYarnReq = "SELECT a.JOB_NO,a.buyer_name AS BUYER_NAME ,b.grouping as INT_REF,c.item_number_id AS ITEM_NUMBER_ID,c.order_quantity AS ORDER_QUANTITY,c.plan_cut_qnty AS PLAN_CUT_QNTY,e.cons AS CONS,e.requirment AS REQUIRMENT,f.cons_qnty AS CONS_QNTY,f.avg_cons_qnty AS AVG_CONS_QNTY,f.cons_ratio AS CONS_RATIO from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e,wo_pre_cost_fab_yarn_cost_dtls f where 1=1 and a.id=b.job_id and a.id=c.job_id and a.id=d.job_id and a.id=e.job_id and a.id=f.job_id and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and d.id=f.fabric_cost_dtls_id and e.cons !=0 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.is_deleted=0 and d.status_active=1 and e.is_deleted=0 and e.status_active=1 and f.is_deleted=0 and f.status_active=1 $poIdsCondYarn";//and b.grouping is not null 
        // echo $sqlYarnReq;die();
        $yarnReqRes = sql_select($sqlYarnReq);  
        $yarnReqQtyArr = array();       
        foreach ($yarnReqRes as $key => $row) 
        {
            $costingPer = $costing_per_arr[$row['JOB_NO']];
            if($costingPer==1) $pcs_value=1*12;
            else if($costingPer==2) $pcs_value=1*1;
            else if($costingPer==3) $pcs_value=2*12;
            else if($costingPer==4) $pcs_value=3*12;
            else if($costingPer==5) $pcs_value=4*12;
            $gmtsitemRatio = $gmtsitemRatioArray[$row['JOB_NO']][$row['ITEM_NUMBER_ID']];
            $consRatio=$row['CONS_RATIO'];
            $requirment=$row['REQUIRMENT'];
            $consQnty=$requirment*$consRatio/100;
            $reqQty = ($row['PLAN_CUT_QNTY']/$gmtsitemRatio)*($consQnty/$pcs_value);
            // echo "(".$row['PLAN_CUT_QNTY']."/".$gmtsitemRatio.")*(".$consQnty."/".$pcs_value.")<br>";

            $yarnReqQtyArr[$row['BUYER_NAME']][$row['INT_REF']] += $reqQty;
        }
        // echo "<pre>";print_r($yarnReqQtyArr);die();

        //==================================== yarn excess qty =========================================
        $poIdsCondBooking = str_replace("b.id", "B.PO_BREAK_DOWN_ID", $poCon);
        $sqlexcess = "SELECT c.BUYER_NAME,d.grouping as INT_REF, b.grey_fab_qnty as GREY_QTY from wo_booking_mst a,wo_booking_dtls b,wo_po_details_master c,wo_po_break_down d where a.booking_no=b.booking_no and c.id=d.job_id and d.id=b.po_break_down_id  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_type=1 and a.is_short=1 $poIdsCondBooking";//and a.is_approved=1
        // echo $sqlexcess;die();
        $sqlexcessRes = sql_select($sqlexcess);
        $yarnExcessArr = array();
        foreach ($sqlexcessRes as $val) 
        {
            $yarnExcessArr[$val['BUYER_NAME']][$val['INT_REF']] += $val['GREY_QTY'];
        }

        //==================================== YARN ALLOCATION ==============================================
        $poIdsCondYarnAllo = str_replace("b.id", "B.PO_BREAK_DOWN_ID", $poCon);
        $sqlYarnAllo = "SELECT c.BUYER_NAME,d.grouping as INT_REF, B.QNTY AS QNTY from inv_material_allocation_mst a, inv_material_allocation_dtls b,wo_po_details_master c,wo_po_break_down d,wo_booking_mst e where a.id=b.mst_id and c.id=d.job_id and d.id=b.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and e.booking_no=b.booking_no  and e.booking_type=1 $poIdsCondYarnAllo";
        // echo $sqlYarnAllo;die();
        $sqlYarnAlloRes = sql_select($sqlYarnAllo);
        $yarnAlloArr = array();
        foreach ($sqlYarnAlloRes as $val) 
        {
            $yarnAlloArr[$val['BUYER_NAME']][$val['INT_REF']] += $val['QNTY'];
        }

        // ======================================= GREY RCV ==============================
        $poIdsCondGrey = str_replace("b.id", "c.po_breakdown_id", $poCon);
        $sqlGrey = "SELECT d.BUYER_NAME,e.grouping as INT_REF, C.QUANTITY AS QNTY from inv_receive_master a,inv_transaction b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e where a.id=b.mst_id and b.id=c.trans_id and b.transaction_type=1 and c.po_breakdown_id=e.id and e.job_id=d.id $poIdsCondGrey and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=2 and a.item_category=13";
        // echo $sqlGrey;die();
        $greyRes = sql_select($sqlGrey);
        $greyRcvdArr = array();
        foreach ($greyRes as  $val) 
        {
           $greyRcvdArr[$val['BUYER_NAME']][$val['INT_REF']]  += $val['QNTY'];
        }
        // ======================================= DYEING PRODUCTION ==============================
        $poIdsCondDye = str_replace("b.id", "b.po_id", $poCon);
        $sqlDye = "SELECT d.BUYER_NAME,e.grouping as INT_REF, B.BATCH_QNTY AS QTY from pro_batch_create_mst a, pro_batch_create_dtls b,pro_fab_subprocess c,wo_po_details_master d,wo_po_break_down e where a.id=b.mst_id and a.id=c.batch_id and e.id=b.po_id and e.job_id=d.id $poIdsCondDye and c.load_unload_id=2 and a.batch_against<>2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0";//and c.process_id='31' and c.result=1  and a.extention_no is null
        // echo $sqlDye;die();
        $dyeRes = sql_select($sqlDye);
        $dyeingProdArr = array();
        foreach ($dyeRes as $val) 
        {
           $dyeingProdArr[$val['BUYER_NAME']][$val['INT_REF']] += $val['QTY'];
        }
        // ======================================= DYEING PRODUCTION (Outbound) ==============================   
        $poIdsCondFin = str_replace("b.id", "c.po_breakdown_id", $poCon);
        $sqlDyeing = "SELECT d.BUYER_NAME,e.grouping as INT_REF,b.grey_used_qty as QNTY from inv_receive_master a,pro_finish_fabric_rcv_dtls b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 and e.id=c.po_breakdown_id and e.job_id=d.id $poIdsCondFin and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(37) and c.entry_form in(37) and c.entry_form in(37) and a.item_category=2 and a.receive_basis=11 and a.company_id=$company_id";
         // echo $sqlDyeing;die();
        $dyeingRes = sql_select($sqlDyeing);
        $dyeingProdOutArr = array();
        foreach ($dyeingRes as  $val) 
        {
            $dyeingProdOutArr[$val['BUYER_NAME']][$val['INT_REF']] += $val['QNTY'];
        }
        // ======================================= FINISH FAB RCV ==============================   
        $poIdsCondFin = str_replace("b.id", "c.po_breakdown_id", $poCon);
        $sqlFinFab = "SELECT d.BUYER_NAME,e.grouping as INT_REF,c.quantity as QNTY from inv_receive_master a,inv_transaction b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e where a.id=b.mst_id and b.id=c.trans_id and b.transaction_type=1 and e.id=c.po_breakdown_id and e.job_id=d.id $poIdsCondFin and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(7,37) and a.item_category=2";
         // echo $sqlFinFab;die();
        $finFabRes = sql_select($sqlFinFab);
        $finFabProdArr = array();
        foreach ($finFabRes as  $val) 
        {
           $finFabProdArr[$val['BUYER_NAME']][$val['INT_REF']] += $val['QNTY'];
        }

        // ======================================= finish fab transfer =====================
        $transPoCond = str_replace("b.id", "a.to_order_id", $poCon);
	    $sqlTrnsfrIn = "SELECT c.BUYER_NAME,d.grouping as INT_REF,e.QUANTITY from inv_item_transfer_mst a,inv_item_transfer_dtls b,wo_po_details_master c,wo_po_break_down d,order_wise_pro_details e where a.id=b.mst_id and c.id=d.job_id and a.item_category=2 and e.dtls_id=b.id and e.trans_type=5 and e.po_breakdown_id=d.id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transfer_criteria=4 and a.entry_form=14 and d.id=a.to_order_id  $transPoCond";
        // echo $sqlTrnsfrIn;die;
        $trnsfrResIn = sql_select($sqlTrnsfrIn);
        $transfer_in_data_array = array();
        foreach ($trnsfrResIn as $val) 
        {
            $transfer_in_data_array[$val['BUYER_NAME']][$val['INT_REF']] += $val['QUANTITY'];
        }
        // ============================================================
        $transPoCond = str_replace("b.id", "a.from_order_id", $poCon);
	    $sqlTrnsfrOut = "SELECT c.BUYER_NAME,d.grouping as INT_REF,e.QUANTITY from inv_item_transfer_mst a,inv_item_transfer_dtls b,wo_po_details_master c,wo_po_break_down d,order_wise_pro_details e where a.id=b.mst_id and c.id=d.job_id and a.item_category=2 and e.dtls_id=b.id and e.trans_type=6 and e.po_breakdown_id=d.id and e.dtls_id=b.id and e.po_breakdown_id=d.id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.transfer_criteria=4 and a.entry_form=14 and d.id=a.from_order_id  $transPoCond";
        // echo $sqlTrnsfrOut;die;
        $trnsfrResOut = sql_select($sqlTrnsfrOut);
        $transfer_out_data_array = array();
        foreach ($trnsfrResOut as $val) 
        {
            $transfer_out_data_array[$val['BUYER_NAME']][$val['INT_REF']] += $val['QUANTITY'];
        }

        // ======================================= CUTTING QC ==============================  
        $poIdsCondQC = str_replace("b.id", "b.order_id", $poCon);
        $sqlLay = "SELECT c.BUYER_NAME,d.grouping as INT_REF,B.QC_PASS_QTY AS QNTY from pro_gmts_cutting_qc_mst a,pro_gmts_cutting_qc_dtls b,wo_po_details_master c,wo_po_break_down d where a.id=b.mst_id and c.id=d.job_id and d.id=b.order_id $poIdsCondQC and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
        // echo $sqlLay;die();
        $layRes = sql_select($sqlLay);
        $cutAndLayArr = array();
        foreach ($layRes as  $val) 
        {
           $cutAndLayArr[$val['BUYER_NAME']][$val['INT_REF']] += $val['QNTY'];
        }

        //=============================== print, emb req qty ====================================
        $emReqSql = "SELECT a.job_no AS JOB_NO,a.BUYER_NAME,a.total_set_qnty AS TOTAL_SET_QNTY,b.id AS ID,b.grouping as INT_REF,c.item_number_id AS ITEM_NUMBER_ID,c.order_quantity AS ORDER_QUANTITY ,c.plan_cut_qnty AS PLAN_CUT_QNTY,d.id AS EMBLISHMENT_ID,d.emb_name AS EMB_NAME,d.emb_type AS EMB_TYPE,d.cons_dzn_gmts AS CONS_DZN_GMTS_MST,d.rate AS RATE_MST,e.requirment AS CONS_DZN_GMTS from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_embe_cost_dtls d , wo_pre_cos_emb_co_avg_con_dtls e where 1=1  and d.emb_name in(1,2,4,5,99) and cons_dzn_gmts>0 and  a.id=b.job_id and a.id=c.job_id and a.id=d.job_id and a.id=e.job_id  and b.id=c.po_break_down_id and b.id=e.po_break_down_id and c.item_number_id= e.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.size_number_id and d.id=e.pre_cost_emb_cost_dtls_id    and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1 $poCon";
        // echo $emReqSql;die();

        $emReqRes = sql_select($emReqSql);  
        $emReqQtyArr = array();       
        foreach ($emReqRes as $key => $row) 
        {
            $costingPer = $costing_per_arr[$row['JOB_NO']];
            if($costingPer==1) $pcs_value=1*12;
            else if($costingPer==2) $pcs_value=1*1;
            else if($costingPer==3) $pcs_value=2*12;
            else if($costingPer==4) $pcs_value=3*12;
            else if($costingPer==5) $pcs_value=4*12;
            $gmtsitemRatio = $gmtsitemRatioArray[$row['JOB_NO']][$row['ITEM_NUMBER_ID']];
            $requirment=$row['CONS_DZN_GMTS_MST'];
            $reqQty = ($row['PLAN_CUT_QNTY']/$gmtsitemRatio)*($requirment/$pcs_value);
            // echo "(".$row['PLAN_CUT_QNTY']."/".$gmtsitemRatio.")*(".$requirment."/".$pcs_value.")<br>";

            $emReqQtyArr[$row['BUYER_NAME']][$row['INT_REF']][$row['EMB_NAME']] += $reqQty*$pcs_value;
        }
        // echo "<pre>";print_r($emReqQtyArr);die();
        // ======================================= GMTS PRODUCTION DATA ==============================
        $poIdsCondGmts = str_replace("b.id", "A.PO_BREAK_DOWN_ID", $poCon);
        $sqlProd = "SELECT c.BUYER_NAME,d.grouping as INT_REF, sum(case when a.production_type=3 and a.embel_name=1 then b.production_qnty else 0 end) as PRINTING_QTY,sum(case when a.production_type=3 and a.embel_name=2 then b.production_qnty else 0 end) as EMB_QTY,sum(case when a.production_type=4 then b.production_qnty else 0 end) as INPUT_QTY, sum(case when a.production_type=5 then b.production_qnty else 0 end) as OUT_QTY,sum(case when a.production_type=8 then b.production_qnty else 0 end) as FINISH_QTY
        from pro_garments_production_mst a, pro_garments_production_dtls b,wo_po_details_master c,wo_po_break_down d
        where a.id=b.mst_id and a.status_active=1 and b.status_active=1 and c.id=d.job_id and d.id=a.po_break_down_id $poIdsCondGmts and a.production_type in(1,2,3,4,5,8) group by c.buyer_name,d.grouping";
        // echo $sqlProd;die();
        $prodRes = sql_select($sqlProd);
        $prodArr = array();
        foreach ($prodRes as  $val) 
        {
           $prodArr[$val['BUYER_NAME']][$val['INT_REF']]['print_qty']  += $val['PRINTING_QTY'];
           $prodArr[$val['BUYER_NAME']][$val['INT_REF']]['emb_qty']    += $val['EMB_QTY'];
           $prodArr[$val['BUYER_NAME']][$val['INT_REF']]['input_qty']  += $val['INPUT_QTY'];
           $prodArr[$val['BUYER_NAME']][$val['INT_REF']]['out_qty']    += $val['OUT_QTY'];
           $prodArr[$val['BUYER_NAME']][$val['INT_REF']]['finish_qty'] += $val['FINISH_QTY'];
        }
        // ======================================= EXFACTORY DATA ==============================
        $poIdsCondExf = str_replace("b.id", "C.PO_BREAK_DOWN_ID", $poCon);
        $sqlEx = "SELECT a.BUYER_NAME,b.grouping as INT_REF, d.production_qnty as EX_FACT_QTY from wo_po_details_master a,wo_po_break_down b, pro_ex_factory_mst c, pro_ex_factory_dtls d, pro_ex_factory_delivery_mst e where c.id=d.mst_id and e.id=c.delivery_mst_id  and c.status_active=1 and d.status_active=1 and e.status_active=1 and a.id=b.job_id and b.id=c.po_break_down_id $poIdsCondExf"; 
        // echo $sqlEx;die();
        $sqlXRes = sql_select($sqlEx);
        $exfArr = array();
        foreach ($sqlXRes as  $val) 
        {
           $exfArr[$val['BUYER_NAME']][$val['INT_REF']]  += $val['EX_FACT_QTY'];
        }
        /*======================================================================================/
        /                                   getting rowspan                                     /
        /======================================================================================*/
        $rowspan = array();
        foreach ($dataArray as $buyerId => $buyerData) 
        {
            foreach ($buyerData as $intRef => $val) 
            {
                $rowspan[$buyerId]++;
            }
           
        }

        ob_start();
        ?>
        <div class="tableContainer">  
            <style type="text/css">
                .word_break_wrap{
                    word-wrap: break-word;
                    word-break: break-all;
                }
            </style>          
            <fieldset style="width:99%;">
                <div style="width:98%;">
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tr><td colspan="18" align="center" style="font-size:22px;">Style Summary Report <span style="color: red;font-size: 18px;font-weight: bold;"> <?=($client) ? ": ".$client_array[$client] : ": All"; ?></span></td></tr>
                        <tr><td colspan="18" align="center" style="font-size:14px;padding-bottom:10px;">Date : <? echo change_date_format($start_date);?> To <? echo change_date_format($end_date);?></td></tr>
                    </table>
                    <table width="100%" border="1" rules="all"  class="rpt_table"> 
                        <thead>
                            <tr style="font-size:12px"> 
                                <th class="word_break_wrap" width="5.5%">Buyer</th>
                                <th class="word_break_wrap" width="5.5%">Int. Ref.</th>
                                <th class="word_break_wrap" width="6.5%">Style Ref.</th>
                                <th class="word_break_wrap" width="5.5%">Gmts Qty</th>
                                <th class="word_break_wrap" width="5.5%">Yarn Req</th>
                                <th class="word_break_wrap" width="5.5%">Allocation</th>
                                <th class="word_break_wrap" width="5.5%">Gray Rcv</th>
                                <th class="word_break_wrap" width="5.5%">Dyeing</th>
                                <th class="word_break_wrap" width="5.5%">Fin. Fab. Rcv</th>
                                <th class="word_break_wrap" width="5.5%">Cutting</th>
                                <th class="word_break_wrap" width="5.5%">Print Req</th>
                                <th class="word_break_wrap" width="5.5%">Printing</th>
                                <th class="word_break_wrap" width="5.5%">Embro Req</th>
                                <th class="word_break_wrap" width="5.5%">Embro</th>
                                <th class="word_break_wrap" width="5.5%">Input</th>
                                <th class="word_break_wrap" width="5.5%">Sewing</th>
                                <th class="word_break_wrap" width="5.5%">Finishing</th>
                                <th class="word_break_wrap" width="5.5%">Shipment</th>
                           </tr>
                        </thead>
                    </table>
                    <div style="width:101%;overflow-y:scroll;max-height:335px;" id="scroll_body">
                        <table width="100%" border="1" rules="all"  class="rpt_table">
                            <tbody>
                                <?
                                $i = 1;
                                ksort($dataArray);
                                $gr_order_quantity = 0;
                                $gr_yarn_req_qty   = 0;
                                $gr_yarn_alloc_qty = 0;
                                $gr_grey_rcv_qty   = 0;
                                $gr_dyeing_qty     = 0;
                                $gr_fin_fab_rcv_qty= 0;
                                $gr_cutting_qty    = 0;
                                $gr_print_req_qty  = 0;
                                $gr_print_qty      = 0;
                                $gr_emb_req_qty    = 0;
                                $gr_emb_qty        = 0;
                                $gr_input_qty      = 0;
                                $gr_output_qty     = 0;
                                $gr_finish_qty     = 0;
                                $gr_ship_qty       = 0;
                                foreach ($dataArray as $buyer_name => $buyerData) 
                                {
                                    $r = 0;
                                    $buyer_order_quantity = 0;
                                    $buyer_yarn_req_qty   = 0;
                                    $buyer_yarn_alloc_qty = 0;
                                    $buyer_grey_rcv_qty   = 0;
                                    $buyer_dyeing_qty     = 0;
                                    $buyer_fin_fab_rcv_qty= 0;
                                    $buyer_cutting_qty    = 0;
                                    $buyer_print_req_qty  = 0;
                                    $buyer_print_qty      = 0;
                                    $buyer_emb_req_qty    = 0;
                                    $buyer_emb_qty        = 0;
                                    $buyer_input_qty      = 0;
                                    $buyer_output_qty     = 0;
                                    $buyer_finish_qty     = 0;
                                    $buyer_ship_qty       = 0;
                                    foreach ($buyerData as $intRef => $row) 
                                    {
                                        $yarnReqQty =  $yarnReqQtyArr[$row['buyer_name']][$intRef];
                                        $yarnExsQty =  $yarnExcessArr[$row['buyer_name']][$intRef];
                                        $yarnAlloQty=  $yarnAlloArr[$row['buyer_name']][$intRef];
                                        $greyRcv    =  $greyRcvdArr[$row['buyer_name']][$intRef];
                                        $dyeingQty  =  $dyeingProdArr[$row['buyer_name']][$intRef];
                                        $dyeingOutQty  =  $dyeingProdOutArr[$row['buyer_name']][$intRef];
                                        $finFabTrQty  =  $transfer_in_data_array[$row['buyer_name']][$intRef] - $transfer_out_data_array[$row['buyer_name']][$intRef];
                                        $finFabQty  =  $finFabProdArr[$row['buyer_name']][$intRef]+ $finFabTrQty;
                                        $layQty     =  $cutAndLayArr[$row['buyer_name']][$intRef];
                                        $printReqQty=  $emReqQtyArr[$row['buyer_name']][$intRef][1];
                                        $embReqQty  =  $emReqQtyArr[$row['buyer_name']][$intRef][2];
                                        $print_qty  =  $prodArr[$row['buyer_name']][$intRef]['print_qty'];
                                        $emb_qty    =  $prodArr[$row['buyer_name']][$intRef]['emb_qty'];
                                        $input_qty  =  $prodArr[$row['buyer_name']][$intRef]['input_qty'];
                                        $output_qty =  $prodArr[$row['buyer_name']][$intRef]['out_qty'];
                                        $finish_qty =  $prodArr[$row['buyer_name']][$intRef]['finish_qty'];
                                        $exfact_qty =  $exfArr[$row['buyer_name']][$intRef];

                                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                        ?>
                                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                                <? if($r==0){?>
                                                <td valign="middle" width="5.5%" rowspan="<? echo $rowspan[$buyer_name];?>"><? echo ucwords($buyer_name);?></td>
                                                <?}?>
                                                <td width="5.5%"><? echo $intRef;?></td>
                                                <td width="6.5%" title="<? echo $row['style'];?>">
                                                    <? echo (strlen($row['style']) > 8) ? substr($row['style'],0,8) : $row['style'];?>
                                                </td>
                                                <td width="5.5%" align="right"><? echo fn_number_format($row['order_quantity'],0);?></td>
                                                <td width="5.5%" align="right"><? echo fn_number_format(($yarnReqQty+$yarnExsQty),0);?></td>
                                                <td width="5.5%" align="right"><? echo fn_number_format($yarnAlloQty,0);?></td>
                                                <td width="5.5%" align="right"><? echo fn_number_format($greyRcv,0);?></td>
                                                <td width="5.5%" align="right" title="Inhouse=<?=$dyeingQty.',Outbound='.$dyeingOutQty;?>">
                                                    <? echo fn_number_format($dyeingQty+$dyeingOutQty,0);?>
                                                </td>
                                                <td width="5.5%" align="right"><? echo fn_number_format($finFabQty,0);?></td>
                                                <td width="5.5%" align="right"><? echo fn_number_format($layQty,0);?></td>
                                                <td width="5.5%" align="right"><? echo fn_number_format($printReqQty,0);?></td>
                                                <td width="5.5%" align="right"><? echo fn_number_format($print_qty,0);?></td>
                                                <td width="5.5%" align="right"><? echo fn_number_format($embReqQty,0);?></td>
                                                <td width="5.5%" align="right"><? echo fn_number_format($emb_qty,0);?></td>
                                                <td width="5.5%" align="right"><? echo fn_number_format($input_qty,0);?></td>
                                                <td width="5.5%" align="right"><? echo fn_number_format($output_qty,0);?></td>
                                                <td width="5.5%" align="right"><? echo fn_number_format($finish_qty,0);?></td>
                                                <td width="5.5%" align="right"><? echo fn_number_format($exfact_qty,0);?></td>
                                            </tr>
                                        <?
                                        $i++; 
                                        $r++;   
                                        $buyer_order_quantity += $row['order_quantity']; 
                                        $buyer_yarn_req_qty   += $yarnReqQty+$yarnExsQty;
                                        $buyer_yarn_alloc_qty += $yarnAlloQty;
                                        $buyer_grey_rcv_qty   += $greyRcv;
                                        $buyer_dyeing_qty     += $dyeingQty+$dyeingOutQty;
                                        $buyer_fin_fab_rcv_qty+= $finFabQty;
                                        $buyer_cutting_qty    += $layQty;
                                        $buyer_print_req_qty  += $printReqQty;
                                        $buyer_print_qty      += $print_qty;
                                        $buyer_emb_req_qty    += $embReqQty;
                                        $buyer_emb_qty        += $emb_qty;
                                        $buyer_input_qty      += $input_qty;
                                        $buyer_output_qty     += $output_qty;
                                        $buyer_finish_qty     += $finish_qty;
                                        $buyer_ship_qty       += $exfact_qty; 

                                        $gr_order_quantity += $row['order_quantity']; 
                                        $gr_yarn_req_qty   += $yarnReqQty+$yarnExsQty;
                                        $gr_yarn_alloc_qty += $yarnAlloQty;
                                        $gr_grey_rcv_qty   += $greyRcv;
                                        $gr_dyeing_qty     += $dyeingQty+$dyeingOutQty;
                                        $gr_fin_fab_rcv_qty+= $finFabQty;
                                        $gr_cutting_qty    += $layQty;
                                        $gr_print_req_qty  += $printReqQty;
                                        $gr_print_qty      += $print_qty;
                                        $gr_emb_req_qty    += $embReqQty;
                                        $gr_emb_qty        += $emb_qty;
                                        $gr_input_qty      += $input_qty;
                                        $gr_output_qty     += $output_qty;
                                        $gr_finish_qty     += $finish_qty;
                                        $gr_ship_qty       += $exfact_qty;                            
                                        
                                    }
                                    ?>
                                    <tr style="font-size:12px;font-weight:bold;background:#ccc;"> 
                                        <td colspan="3" align="right">Buyer Total</td>
                                        <td align="right"><? echo fn_number_format($buyer_order_quantity,0);?></td>
                                        <td align="right"><? echo fn_number_format($buyer_yarn_req_qty,0);?></td>
                                        <td align="right"><? echo fn_number_format($buyer_yarn_alloc_qty,0);?></td>
                                        <td align="right"><? echo fn_number_format($buyer_grey_rcv_qty,0);?></td>
                                        <td align="right"><? echo fn_number_format($buyer_dyeing_qty,0);?></td>
                                        <td align="right"><? echo fn_number_format($buyer_fin_fab_rcv_qty,0);?></td>
                                        <td align="right"><? echo fn_number_format($buyer_cutting_qty,0);?></td>
                                        <td align="right"><? echo fn_number_format($buyer_print_req_qty,0);?></td>
                                        <td align="right"><? echo fn_number_format($buyer_print_qty,0);?></td>
                                        <td align="right"><? echo fn_number_format($buyer_emb_req_qty,0);?></td>
                                        <td align="right"><? echo fn_number_format($buyer_emb_qty,0);?></td>
                                        <td align="right"><? echo fn_number_format($buyer_input_qty,0);?></td>
                                        <td align="right"><? echo fn_number_format($buyer_output_qty,0);?></td>
                                        <td align="right"><? echo fn_number_format($buyer_finish_qty,0);?></td>
                                        <td align="right"><? echo fn_number_format($buyer_ship_qty,0);?></td>
                                   </tr>                                
                                    <?
                                }
                                ?>
                            </tbody>
                        </table>
                    </div>
                    <table width="100%" border="1" rules="all"  class="rpt_table"> 
                        <tfoot>
                            <tr style="font-size:12px"> 
                                <th width="5.5%" class="word_break_wrap"></th>
                                <th width="5.5%" class="word_break_wrap"></th>
                                <th width="6.5%" class="word_break_wrap">Grand Total</th>
                                <th width="5.5%" align="right"><? echo fn_number_format($gr_order_quantity,0);?></th>
                                <th width="5.5%" align="right"><? echo fn_number_format($gr_yarn_req_qty,0);?></th>
                                <th width="5.5%" align="right"><? echo fn_number_format($gr_yarn_alloc_qty,0);?></th>
                                <th width="5.5%" align="right"><? echo fn_number_format($gr_grey_rcv_qty,0);?></th>
                                <th width="5.5%" align="right"><? echo fn_number_format($gr_dyeing_qty,0);?></th>
                                <th width="5.5%" align="right"><? echo fn_number_format($gr_fin_fab_rcv_qty,0);?></th>
                                <th width="5.5%" align="right"><? echo fn_number_format($gr_cutting_qty,0);?></th>
                                <th width="5.5%" align="right"><? echo fn_number_format($gr_print_req_qty,0);?></th>
                                <th width="5.5%" align="right"><? echo fn_number_format($gr_print_qty,0);?></th>
                                <th width="5.5%" align="right"><? echo fn_number_format($gr_emb_req_qty,0);?></th>
                                <th width="5.5%" align="right"><? echo fn_number_format($gr_emb_qty,0);?></th>
                                <th width="5.5%" align="right"><? echo fn_number_format($gr_input_qty,0);?></th>
                                <th width="5.5%" align="right"><? echo fn_number_format($gr_output_qty,0);?></th>
                                <th width="5.5%" align="right"><? echo fn_number_format($gr_finish_qty,0);?></th>
                                <th width="5.5%" align="right"><? echo fn_number_format($gr_ship_qty,0);?></th>
                           </tr>
                        </tfoot>
                    </table>
                </div>
            </fieldset>
        </div>
        <?
        foreach (glob("$user_id*.xls") as $filename) 
        {
            if( @filemtime($filename) < (time()-$seconds_old) )
            @unlink($filename);
        }
        //---------end------------//
        $name=time();
        $filename="tmp/".$user_id."_".$name.".xls";
        $create_new_doc = fopen($filename, 'w');
        $is_created = fwrite($create_new_doc,ob_get_contents());
       // $filename=$user_id."_".$name.".xls";
        echo "$total_data####$filename####$rptType";
        exit();
    }
    elseif($rptType==5) // Alor Michil Button
    {
        $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
        $company_arr=return_library_array( "select id,company_name from lib_company",'id','company_name');
        $company_id     = str_replace("'","",$cbo_company_name);
        $location_cond='';
        if($location_name !=0) $location_cond=" and a.location_name=$location_name";   
        $clientCond = ($client != 0)       ? " and a.client_id=$client"            : "";

        if($buyer_name==0)
        {
            if($_SESSION['logic_erp']["data_level_secured"]==1)
            {
                if($_SESSION['logic_erp']["buyer_id"]!="")
                {   
                    $buyer_cond =" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")";
                }
            }
        }
        else
        {
            $buyer_cond =" and a.buyer_name=$buyer_name";
        }              

        // ============================ ex-factory data =========================
        $sql = "SELECT d.ACTUAL_PO_DTLS_ID as dtls_id,d.EX_FACT_QTY  from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join PRO_EX_FACTORY_MST c on b.id=c.po_break_down_id and c.status_active=1 JOIN PRO_EX_FACTORY_ACTUAL_PO_DETAILS d ON c.id = d.mst_id and d.status_active=1 where b.shiping_status in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and a.company_name=$company_id $location_cond $buyer_cond $clientCond";
        // echo $sql;
        $res = sql_select($sql);
        $exf_data_array = array();
        foreach ($res as $v) 
        {
            $exf_data_array[$v['DTLS_ID']] += $v['EX_FACT_QTY'];
        }
        // echo "<pre>"; print_r($exf_data_array);
        $buyer_wise_summery_sql = sql_select("SELECT a.buyer_name as BUYER_NAME, d.po_qty as ACC_PO_QTY, c.acc_ship_date as  ACC_SHIP_DATE, TO_CHAR(c.acc_ship_date,'MON') as MONTH, TO_CHAR(c.acc_ship_date,'YY') as YEAR , d.gmts_item as GMTS_ITEM,d.id as dtls_id  from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join wo_po_acc_po_info c on b.id=c.po_break_down_id JOIN wo_po_acc_po_info_dtls d ON c.id = d.mst_id where b.shiping_status in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and c.acc_ship_date IS NOT NULL and a.company_name=$company_id and d.gmts_item <>0 and c.acc_po_status=1 $location_cond $buyer_cond $clientCond order by c.acc_ship_date ASC"); 

        foreach ($buyer_wise_summery_sql as $row) 
        {
            $yearmonth=trim($row['YEAR'].'.'.ucfirst(strtolower($row['MONTH'])));
            $buyer_wise_summery_arr[$row['BUYER_NAME']][$yearmonth] += max($row['ACC_PO_QTY'] - $exf_data_array[$row['DTLS_ID']],0);
            $item_wise_summery_arr[$row['GMTS_ITEM']][$yearmonth] += max($row['ACC_PO_QTY'] - $exf_data_array[$row['DTLS_ID']],0);
            if(max($row['ACC_PO_QTY'] - $exf_data_array[$row['DTLS_ID']],0)>0)
            {
                $yearmonth_arr[$yearmonth]=$yearmonth;
            }
            // echo $row['DTLS_ID']."==".$row['ACC_PO_QTY'] ."-". $exf_data_array[$row['DTLS_ID']]."<br>";
        } 

        $tbl_width = 200+count($yearmonth_arr)*60;
        ob_start();

        ?>
        <div class="tableContainer">
            <style type="text/css">
                .word_break_wrap{
                    word-wrap: break-word;
                    word-break: break-all;
                }
                .GridViewScrollHeader TH, .GridViewScrollHeader TD 
                {
                    padding: 2px 4px;
                    font-weight: normal;
                    white-space: nowrap;
                    border-right: 1px solid #e6e6e6;
                    border-bottom: 1px solid #e6e6e6;
                    /*background-color: #F4F4F4;*/
                    color: #000000;
                    text-align: left;
                    vertical-align: middle;
                }

                .GridViewScrollHeader TH{
                    background-image: -webkit-linear-gradient( rgb(194,220,255) 10%, rgb(136,170,214) 96%);
                    border: 1px solid #8DAFDA;
                    color:#444;
                    font-size: 13px;
                    font-weight: bold;
                    text-align: center;
                    line-height: 12px;
                    height: 25px;
                }

                .GridViewScrollItem TD {
                     padding: 2px 4px;
                    white-space: nowrap;
                    border-right: 1px solid #e6e6e6;
                    border-bottom: 1px solid #e6e6e6;
                   /* background-color: #FFFFFF;*/
                    color: #000000;
                    vertical-align: middle;
                }

                .GridViewScrollItemFreeze TD {
                     padding: 2px 4px;
                    white-space: nowrap;
                    border-right: 1px solid #e6e6e6;
                    border-bottom: 1px solid #e6e6e6;
                    /*background-color: #E9F3FF;*/
                    color: #000000;
                    vertical-align: middle;
                }

                .GridViewScrollFooterFreeze TD {
                     padding: 2px 4px;
                    white-space: nowrap;
                    border-right: 1px solid #e6e6e6;
                    border-top: 1px solid #e6e6e6;
                    border-bottom: 1px solid #e6e6e6;
                    /*background-color: #F4F4F4;*/
                    color: #000000;
                    vertical-align: middle;
                    font-weight: 700;
                    background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB));
                }
                tr.GridViewScrollItemFreeze:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
                tr.footerTr:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
                html {
                  --scrollbarBG: #CFD8DC;
                  --thumbBG: #8ec5fc;
                }
                body::-webkit-scrollbar {
                  width: 11px;
                }
                body {
                  scrollbar-width: thin;
                  scrollbar-color: var(--thumbBG) var(--scrollbarBG);
                }
                body::-webkit-scrollbar-track {
                  background: var(--scrollbarBG);
                }
                body::-webkit-scrollbar-thumb {
                  background-color: var(--thumbBG) ;
                  border-radius: 6px;
                  border: 3px solid var(--scrollbarBG);
                }
            </style>
            <fieldset class="first_part" style="width:98%">
            <div class="report_heading">
                <table width="100%"  cellspacing="0">
                    <tr class="form_caption">
                        <td colspan="25" align="center" ><strong style="font-size:19px"><?php echo $company_arr[$company_id]; ?></strong></td>
                    </tr>
                    <tr class="form_caption">
                        <td colspan="25" align="center"><strong style="font-size:14px">Alor Michil Report <span style="color: red;font-size: 14px;font-weight: bold;"> <?=($client) ? ": ".$client_array[$client] : ": All"; ?></span></strong></td>
                    </tr>
                </table>
            </div>
            <!-- ======================================  Buyer wise Summery ============================== -->
            <!-- <h3 style="width:100%;" align="left" id="accordion_h1" class="accordion_h" onClick="accordion_menu( this.id,'buyer_wise_summery', '')"> -<b>Buyer wise Summery</b></h3> -->
            <h2><b>Buyer wise Summery</b></h2>
            <div id="buyer_wise_summery">
                <table border="1" rules="all" class="rpt_table" width="100%" cellpadding="0" cellspacing="0" id="gvMain">            
                    <thead>
                        <tr class="GridViewScrollHeader">
                            <th>Buyer</th>
                            <? foreach ($yearmonth_arr as $year_month) { ?>
                                <th><?= $year_month ?></th>
                            <? } ?>
                            <th>Total</th>
                        </tr>
                    </thead>
                
                    <tbody>
                        <? 
                        $i=1;
                        foreach ($buyer_wise_summery_arr as $buyer_id => $value) 
                        { 
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>
                            <tr class="GridViewScrollItem" bgcolor="<? echo $bgcolor;?>" onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $i; ?>">
                                <td align="center">
                                    <a href="javascript:void(0)" onclick="report_generate_by_buyer('<? echo $buyer_id;?>','<? echo $client;?>')">
                                        <?= $buyer_arr[$buyer_id] ?>
                                    </a></td>
                                <?
                                $buyer_wise_total=0;
                                foreach ($yearmonth_arr as $year_month) 
                                { 
                                    ?>
                                    <td align="right"><?= fn_number_format($value[$year_month]); $buyer_wise_total+=$value[$year_month]; $buyer_wise_total_arr[$year_month]+=$value[$year_month]; ?></td>
                                    <? 
                                } 
                                ?>
                                <td align="right">
                                    <a href="javascript:void(0)" onclick="report_by_buyer_style('<? echo $buyer_id?>','<? echo $client;?>')">
                                       <?= fn_number_format($buyer_wise_total);  ?>
                                    </a>
                                    
                                    
                                </td>
                            </tr>
                            <? 
                            $i++;
                        } 
                        ?>
                    </tbody>                
                   
                    <tr class="GridViewScrollItem footerTr">
                        <td><div class="gridViewScrollHelper"></div></td> 
                        <?
                        foreach ($yearmonth_arr as $year_month) { ?>
                            <td  align="right">
                            <a href="javascript:void(0)" onclick="report_by_month_summery('<? echo $year_month?>','<? echo $client;?>')">                      
                                <?= fn_number_format($buyer_wise_total_arr[$year_month]); 
                                $buyer_wise_total_sum+=$buyer_wise_total_arr[$year_month]; ?>
                            </a>
                                
                            </td>
                        <? } ?>
                        <td  align="right"><?= fn_number_format($buyer_wise_total_sum); ?></td>
                    </tr>
                   
                </table>     
                
            </div> 

            <!-- ======================================  Item wise Summery ============================== -->

            <!-- <h3 style="width:100%" align="left" id="accordion_h1" class="accordion_h" onClick="accordion_menu( this.id,'item_wise_summery', '')"> -<b>Item wise Summery</b></h3> -->
            <br clear="all">
            <h2><b>Item wise Summery</b></h2>
            <div id="item_wise_summery">
                <table id="gvMain2" border="1" rules="all" class="rpt_table" width="100%" cellpadding="0" cellspacing="0">            
                    <thead>
                        <tr class="GridViewScrollHeader">
                            <th>Item</th>
                            <? foreach ($yearmonth_arr as $year_month) { ?>
                                <th><?= $year_month ?></th>
                            <? } ?>
                            <th>Total</th>
                        </tr>
                    </thead>
                
                    <tbody>
                        <? 
                        $i=1;
                        foreach ($item_wise_summery_arr as $item_id => $value) 
                        { 
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>
                            <tr class="GridViewScrollItem" bgcolor="<? echo $bgcolor;?>" onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $i; ?>">
                                <td align="center">
                                <a href="javascript:void(0)" onclick="report_generate_by_item('<? echo $item_id?>','<? echo $client;?>')">
                                        <?= $garments_item[$item_id] ?>
                                    </a>
                                </td>
                                <?
                                $item_wise_total=0;
                                foreach ($yearmonth_arr as $year_month) { ?>
                                    <td align="right"><?= fn_number_format($value[$year_month]); $item_wise_total+=$value[$year_month]; $item_wise_total_arr[$year_month]+=$value[$year_month]; ?></td>
                                <? } ?>
                                <td align="right"><?= fn_number_format($item_wise_total);  ?></td>
                            </tr>
                            <? 
                            $i++;
                        } 
                        ?>
                    </tbody>
                    <tr class="GridViewScrollItem footerTr">
                        <td><div class="gridViewScrollHelper"></div></td>
                        <?
                        foreach ($yearmonth_arr as $year_month) { ?>
                            <td  align="right"><?= fn_number_format($item_wise_total_arr[$year_month]); $item_wise_total_sum+=$item_wise_total_arr[$year_month]; ?></td>
                        <? } ?>
                        <td  align="right"><?= fn_number_format($item_wise_total_sum); ?></td>
                    </tr>
                    
                </table>     
            </div>  
            </fieldset>

            <script type="text/javascript" src="../../../js/gridviewscroll.js"></script>
            <script type="text/javascript">
                var gridViewScroll = null;
                fnGridView = function () {
                    gridViewScroll = new GridViewScroll({
                        elementID: "gvMain",
                        width: screen.width-50,
                        // width: 1335,
                        height: 300,
                        freezeColumn: true,
                        freezeFooter: true,
                        freezeColumnCssClass: "GridViewScrollItemFreeze",
                        freezeFooterCssClass: "GridViewScrollFooterFreeze",
                        freezeHeaderRowCount: 1,
                        freezeColumnCount: 1,
                        onscroll: function (scrollTop, scrollLeft) {
                            console.log(scrollTop + " - " + scrollLeft);
                        }
                    });
                    gridViewScroll.enhance();
                }
                
                //=================================================
                var gridViewScroll = null;
                fnGridView2 = function () {
                    gridViewScroll = new GridViewScroll({
                        elementID: "gvMain2",
                        width: screen.width-50,
                        // width: 1335,
                        height: 300,
                        freezeColumn: true,
                        freezeFooter: true,
                        freezeColumnCssClass: "GridViewScrollItemFreeze",
                        freezeFooterCssClass: "GridViewScrollFooterFreeze",
                        freezeHeaderRowCount: 1,
                        freezeColumnCount: 1,
                        onscroll: function (scrollTop, scrollLeft) {
                            console.log(scrollTop + " - " + scrollLeft);
                        }
                    });
                    gridViewScroll.enhance();
                }
                function getScrollPosition() {
                    var position = gridViewScroll.scrollPosition;
                    alert("scrollTop: " + position.scrollTop + ", scrollLeft: " + position.scrollLeft);
                }
                function setScrollPosition() {
                    var scrollPosition = { scrollTop: 50, scrollLeft: 50};

                    gridViewScroll.scrollPosition = scrollPosition;
                }
                fnGridView();
                fnGridView2();
            </script>
        </div>
        <?
        foreach (glob("$user_id*.xls") as $filename) 
        {
            if( @filemtime($filename) < (time()-$seconds_old) )
            @unlink($filename);
        }
        //---------end------------//
        $name=time();
        $filename="tmp/".$user_id."_".$name.".xls";
        $create_new_doc = fopen($filename, 'w');
        $is_created = fwrite($create_new_doc,ob_get_contents());
     
        echo "$total_data####$filename####$rptType";
        exit();
    }
    elseif($rptType==6) // Backlog Button
    { 
        $buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');
        $company_arr=return_library_array( "select id,company_name from lib_company",'id','company_name');

        $sqlCond = "";
        $sqlCond .= " and a.company_name=$company_id";
        // $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name" : "";
        $sqlCond .= ($location_name !=0) ? " and a.location_name=$location_name" : ""; 
        $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";  

        if($buyer_name==0)
        {
            if($_SESSION['logic_erp']["data_level_secured"]==1)
            {
                if($_SESSION['logic_erp']["buyer_id"]!="")
                {   
                    $sqlCond.=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")";
                }
            }
        }
        else
        {
            $sqlCond.=" and a.buyer_name=$buyer_name";
        }     
        
        /*------------------------------------------------------------------------------/
        /                                  MAIN QUERY                                   /
        /------------------------------------------------------------------------------*/

        $sql = "SELECT A.JOB_NO,A.BUYER_NAME,a.CLIENT_ID,B.ID AS PO_ID,b.grouping,b.SHIPMENT_DATE,(B.UNIT_PRICE/a.total_set_qnty) as UNIT_PRICE,C.COLOR_NUMBER_ID AS COLOR_ID,C.order_quantity AS QTY from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=c.job_id and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.shiping_status in(1,2) $sqlCond";
        // echo $sql;die();
        $sqlRes = sql_select($sql);
        if(count($sqlRes)==0)
        {
            echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
        }
        $dataArray = array();
        $poIdArray = array();
        $jobArray = array();
        $poWiseColorArray = array();
        $jobWisePoArray = array();
        foreach ($sqlRes as $row) 
        {
            $dataArray[$row['BUYER_NAME']."##".$row['CLIENT_ID']][$row['PO_ID']]['po_id'] = $row['PO_ID'];          
            $dataArray[$row['BUYER_NAME']."##".$row['CLIENT_ID']][$row['PO_ID']]['job_no'] = $row['JOB_NO'];          
            $dataArray[$row['BUYER_NAME']."##".$row['CLIENT_ID']][$row['PO_ID']]['qty'] += $row['QTY'];          
            $dataArray[$row['BUYER_NAME']."##".$row['CLIENT_ID']][$row['PO_ID']]['orig_ship_date'] = $row['SHIPMENT_DATE'];          
            $dataArray[$row['BUYER_NAME']."##".$row['CLIENT_ID']][$row['PO_ID']]['unit_price'] = $row['UNIT_PRICE'];          
            $dataArray[$row['BUYER_NAME']."##".$row['CLIENT_ID']][$row['PO_ID']]['grouping'] = $row['GROUPING'];          
            $poIdArray[$row['PO_ID']] = $row['PO_ID'];
            $poWiseColorArray[$row['PO_ID']][$row['COLOR_ID']] += $row['COLOR_ID'];
            $jobArray[$row['JOB_NO']] = "'".$row['JOB_NO']."'";
            $jobWisePoArray[$row['JOB_NO']][$row['PO_ID']]  = $row['PO_ID'];
        }
        $poIDS = implode(",", $poIdArray);
        unset($sqlRes);
        // echo count($poWiseColorArray[38932]);
        // echo "<pre>";
        // print_r($poWiseColorArray);
        //================================ PO Cond=================================
        $poIdsCond="";
        if($db_type==2 && count($poIdArray)>1000)
        {
            $poIdsCond=" and (";
            $poIdsArr=array_chunk($poIdArray,999);
            foreach($poIdsArr as $ids)
            {
                $ids=implode(",",$ids);
                $poIdsCond.=" po_break_down_id in($ids) or ";
            }
            $poIdsCond=chop($poIdsCond,'or ');
            $poIdsCond.=")";
        }
        else
        {
            $poIdsCond=" and po_break_down_id in($poIDS)";
        }

        //================================ Job Cond=================================
        $jobNo = implode(",", $jobArray);
        $jobCond="";
        if($db_type==2 && count($jobArray)>1000)
        {
            $jobCond=" and (";
            $poIdsArr=array_chunk($jobArray,999);
            foreach($poIdsArr as $ids)
            {
                $ids=implode(",",$ids);
                $jobCond.=" a.job_no in($ids) or ";
            }
            $jobCond=chop($jobCond,'or ');
            $jobCond.=")";
        }
        else
        {
            $jobCond=" and a.job_no in($jobNo)";
        }
        // echo $poIdsCond;die();

        // ======================================= Actual PO Info ==================================
        $poIdsConAcc = str_replace("po_break_down_id", "b.po_break_down_id", $poIdsCond);
        $sqlAccPo = "SELECT b.PO_BREAK_DOWN_ID,a.ACC_PO_NO,b.po_qty as ACC_PO_QTY,a.ACC_SHIP_DATE FROM WO_PO_ACC_PO_INFO a, WO_PO_ACC_PO_INFO_DTLS b WHERE a.id=b.mst_id and a.STATUS_ACTIVE=1 AND a.IS_DELETED=0 and b.STATUS_ACTIVE=1 AND b.IS_DELETED=0 and b.gmts_item <> 0 and a.acc_po_status=1 $poIdsConAcc";
        // echo $sqlAccPo;die();
        $sqlAccPoRes = sql_select($sqlAccPo);
        $accPoArray = array();
        $accPoIDArray = array();
        foreach ($sqlAccPoRes as $val) 
        {
            $accPoArray[$val['PO_BREAK_DOWN_ID']][$val['ACC_PO_NO']][$val['ACC_SHIP_DATE']]['acc_po_qty'] += $val['ACC_PO_QTY'];
            // $accPoArray[$val['PO_BREAK_DOWN_ID']][$val['ACC_PO_NO']]['acc_ship_date'] = $val['ACC_SHIP_DATE'];
            $accPoIDArray[$val['PO_BREAK_DOWN_ID']] .= $val['ACC_PO_NO'].",";
        }
        unset($sqlAccPoRes);
        // echo "<pre>";print_r($accPoArray);die();
        // ======================================= LABDIP ==================================
        $sqlLabDip = "SELECT PO_BREAK_DOWN_ID,APPROVAL_STATUS,COUNT (DISTINCT CASE WHEN APPROVAL_STATUS=3 THEN  COLOR_NAME_ID ELSE 0 END)     AS TOT_APP,COUNT (DISTINCT CASE WHEN APPROVAL_STATUS IN(1,3) AND SUBMITTED_TO_BUYER IS NOT NULL THEN  COLOR_NAME_ID ELSE 0 END) AS TOT_SUB FROM WO_PO_LAPDIP_APPROVAL_INFO WHERE APPROVAL_STATUS in(1,3) $poIdsCond and STATUS_ACTIVE=1 AND IS_DELETED=0 group by PO_BREAK_DOWN_ID,APPROVAL_STATUS";
        // echo $sqlLabDip;die();
        $sqlLabDipRes = sql_select($sqlLabDip);
        $labDipArray = array();
        foreach ($sqlLabDipRes as $val) 
        {
            $labDipArray[$val['PO_BREAK_DOWN_ID']]['approve_color'] = $val['TOT_APP'];
            $labDipArray[$val['PO_BREAK_DOWN_ID']]['submit_color'] = $val['TOT_SUB'];
        }
        // print_r($labDipArray);
        unset($sqlLabDipRes);
        // ======================================= SAMPLE  ==================================
        $sqlLabSM = "SELECT PO_BREAK_DOWN_ID,SAMPLE_TYPE_ID,COUNT(COLOR_NUMBER_ID) AS TOT_COLOR FROM WO_PO_SAMPLE_APPROVAL_INFO WHERE APPROVAL_STATUS=1 $poIdsCond AND SAMPLE_TYPE_ID IN(7,18,60) and STATUS_ACTIVE=1 AND IS_DELETED=0 group by PO_BREAK_DOWN_ID,SAMPLE_TYPE_ID";
        // echo $sqlLabSM;
        $sqlLabSMRes = sql_select($sqlLabSM);
        $smArray = array();
        foreach ($sqlLabSMRes as $val) 
        {
            $smArray[$val['PO_BREAK_DOWN_ID']][$val['SAMPLE_TYPE_ID']] = $val['TOT_COLOR'];
        }
        unset($sqlLabSMRes);
        // print_r($smArray);

        // ======================================= BOOKING DATA  ==================================
        $poIdsCondBooking = str_replace("po_break_down_id", "b.po_break_down_id", $poIdsCond);
        $sqlBooking = "SELECT A.IS_APPROVED,a.FABRIC_COMPOSITION,a.FABRICSTRUCTURE,a.FABRICGSM, a.FABRIC_SOURCE,a.IS_SHORT,B.PO_BREAK_DOWN_ID,MAX(A.BOOKING_DATE) AS BDATE,SUM(B.FIN_FAB_QNTY) AS QTY,SUM(B.GREY_FAB_QNTY) AS GREY_QTY FROM WO_BOOKING_MST A,WO_BOOKING_DTLS B WHERE A.BOOKING_NO=B.BOOKING_NO AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 and a.booking_type=1 $poIdsCondBooking group by A.IS_APPROVED,a.FABRIC_COMPOSITION,a.FABRICSTRUCTURE,a.FABRICGSM,a.FABRIC_SOURCE,a.IS_SHORT,B.PO_BREAK_DOWN_ID";
        // echo $sqlBooking;die();
        $bookingRes = sql_select($sqlBooking);
        $bookingQtyArray = array();
        $bookingFabInfoArray = array();
        foreach ($bookingRes as $val) 
        {
            //if($val['IS_APPROVED']==1)
            //{
                if($val['IS_SHORT']==2)
                {
                    $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['qty'] += $val['QTY'];
                    $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['date'] = $val['BDATE'];
                }
                else
                {
                    $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['fin_fab_excess_qty'] += $val['QTY'];
                    if($val['FABRIC_SOURCE'] !=2)// avoid purchase
                    {
                        $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['grey_fab_excess_qty'] += $val['GREY_QTY'];
                        $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['yarn_excess_qty'] += $val['GREY_QTY'];
                    }

                }
            //}   

            if($val['IS_SHORT']==2)
            {                         
                $bookingFabInfoArray[$val['PO_BREAK_DOWN_ID']]['construction'] = $val['FABRICSTRUCTURE'];
                $bookingFabInfoArray[$val['PO_BREAK_DOWN_ID']]['composition'] = $val['FABRIC_COMPOSITION'];
                $bookingFabInfoArray[$val['PO_BREAK_DOWN_ID']]['gsm'] = $val['FABRICGSM'];
            }
            
        }
        unset($bookingRes);
        // echo "<pre>";print_r($bookingQtyWithUomArray);die();

        // ======================================= COLOR TYPE WISE BOOKING DATA  ==================================
        $poIdsCondBooking = str_replace("po_break_down_id", "a.po_break_down_id", $poIdsCond);
        $shortSql = "SELECT a.PO_BREAK_DOWN_ID, b.COLOR_TYPE_ID,a.FIN_FAB_QNTY, a.GREY_FAB_QNTY FROM wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b WHERE a.pre_cost_fabric_cost_dtls_id=b.id $poIdsCondBooking and a.is_short=1 and a.status_active=1 and  a.is_deleted=0";
        $shortRes = sql_select($shortSql);
        $color_type_wise_booking_qty_array = array();
        foreach ($shortRes as $val) 
        {
            $color_type_wise_booking_qty_array[$val['PO_BREAK_DOWN_ID']][$val['COLOR_TYPE_ID']] += $val['FIN_FAB_QNTY'];
        }
        // echo "<pre>";print_r($color_type_wise_booking_qty_array);die();

        // ======================================= BOOKING DATA WITH UOM ==================================
        $poIdsCondBooking = str_replace("po_break_down_id", "b.po_break_down_id", $poIdsCond);
        $sqlBooking = "SELECT A.IS_APPROVED,a.FABRIC_COMPOSITION,a.FABRICSTRUCTURE,a.FABRICGSM, a.FABRIC_SOURCE,a.IS_SHORT,B.PO_BREAK_DOWN_ID,MAX(A.BOOKING_DATE) AS BDATE,SUM(B.FIN_FAB_QNTY) AS QTY,SUM(B.GREY_FAB_QNTY) AS GREY_QTY,C.UOM FROM WO_BOOKING_MST A,WO_BOOKING_DTLS B,WO_PRE_COST_FABRIC_COST_DTLS C WHERE A.BOOKING_NO=B.BOOKING_NO and c.id=b.pre_cost_fabric_cost_dtls_id AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 and a.booking_type=1 $poIdsCondBooking group by A.IS_APPROVED,a.FABRIC_COMPOSITION,a.FABRICSTRUCTURE,a.FABRICGSM,a.FABRIC_SOURCE,a.IS_SHORT,B.PO_BREAK_DOWN_ID,C.UOM";
        // echo $sqlBooking;die();
        $bookingRes = sql_select($sqlBooking);
        $bookingQtyWithUomArray = array();
        foreach ($bookingRes as $val) 
        {
            if($val['IS_SHORT']==2)
            {
                $bookingQtyWithUomArray[$val['PO_BREAK_DOWN_ID']][$val['UOM']]['qty'] += $val['QTY'];
            }
            else
            {
                $bookingQtyWithUomArray[$val['PO_BREAK_DOWN_ID']][$val['UOM']]['fin_fab_excess_qty'] += $val['QTY'];
            }
            
            
        }
        unset($bookingRes);
        // echo "<pre>";print_r($bookingQtyWithUomArray);die();

        // ======================================= TNA DATA  ==================================
        $poIdsCondTna = str_replace("po_break_down_id", "A.PO_NUMBER_ID", $poIdsCond);
        $sqltna = "SELECT A.PO_NUMBER_ID,A.TASK_NUMBER,MAX(A.TASK_START_DATE) AS START_DATE,MAX(A.TASK_FINISH_DATE) AS END_DATE,MAX(A.ACTUAL_START_DATE) AS ACTUAL_START_DATE,MAX(A.ACTUAL_FINISH_DATE) AS ACTUAL_FINISH_DATE FROM TNA_PROCESS_MST A,WO_PO_BREAK_DOWN B WHERE A.PO_NUMBER_ID=B.ID AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.PO_QUANTITY>0 $poIdsCondTna AND A.TASK_TYPE=1 group by A.PO_NUMBER_ID,A.TASK_NUMBER";
        // echo $sqltna;die();
        $tnaRes = sql_select($sqltna);
        $tnaDateArray = array();
        foreach ($tnaRes as $val) 
        {
            $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['start_date']          = $val['START_DATE'];
            $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['end_date']            = $val['END_DATE'];
            $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_start_date']   = $val['ACTUAL_START_DATE'];
            $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_finish_date']  = $val['ACTUAL_FINISH_DATE'];
        }
        // print_r($tnaDateArray);
        unset($tnaRes);
        //======================================== avg cons qty for yarn dyed =========================
        $poIdsCondCons = str_replace("po_break_down_id", "b.id", $poIdsCond);
        $sqlCons = sql_select("SELECT a.JOB_NO,b.ID,d.REQUIRMENT from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_avg_con_dtls d where a.id=b.job_id and a.job_no=c.job_no and c.id=d.pre_cost_fabric_cost_dtls_id and b.id=d.po_break_down_id and c.color_type_id in(2,3,4,6) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 $poIdsCondCons  and d.CONS>0");
        $job_wise_cons_array = array();
        $po_wise_cons_array = array();
        foreach ($sqlCons as $val) 
        {
            $job_wise_cons_array[$val['JOB_NO']] += $val['REQUIRMENT'];
            $po_wise_cons_array[$val['JOB_NO']][$val['ID']] += $val['REQUIRMENT'];
        }
        unset($sqlCons);
        // ======================================= dayed yarn rcv ====================================
        $sql_yarn_dyed = "SELECT a.JOB_NO ,a.cons_quantity as RECV_QNTY,(case when b.RECEIVE_DATE < '$current_date' then a.cons_quantity else 0 end) as PREV_RECV_QNTY from inv_transaction a, inv_receive_master b, product_details_master c where a.mst_id=b.id and a.prod_id=c.id and b.entry_form=1 and b.receive_basis=2 and b.receive_purpose=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.item_category=1 and a.transaction_type=1 $jobCond and c.dyed_type=1";
        // echo $sql_yarn_dyed;die();
        $sql_yarn_dyed_res = sql_select($sql_yarn_dyed);
        $yarn_dyed_rcv_qty_array = array();
        $yarn_dyed_prev_rcv_qty_array = array();
        foreach ($sql_yarn_dyed_res as $val) 
        {
            $yarn_dyed_rcv_qty_array[$val['JOB_NO']] += $val['RECV_QNTY'];
            $yarn_dyed_prev_rcv_qty_array[$val['JOB_NO']] += $val['PREV_RECV_QNTY'];
        }
        unset($sql_yarn_dyed);
        // ======================================= Primary yarn req  ==================================
        $poIdsCondYarn = str_replace("po_break_down_id", "b.id", $poIdsCond);
        $sqlpo="SELECT a.id as JOB_ID, a.job_no AS JOB_NO, b.id AS ID, c.item_number_id AS ITEM_NUMBER_ID, c.color_number_id AS COLOR_NUMBER_ID, c.size_number_id AS SIZE_NUMBER_ID, c.order_quantity AS ORDER_QUANTITY, c.plan_cut_qnty AS PLAN_CUT_QNTY, d.costing_per_id AS COSTING_PER from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_dtls d where a.id=b.job_id and b.id=c.po_break_down_id and a.id=d.job_id and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.is_deleted=0 and d.status_active=1 $poIdsCondYarn";
        // echo $sqlpo;
        $sqlpoRes = sql_select($sqlpo);
        $po_arr=array(); $costingPerArr=array(); 
        foreach($sqlpoRes as $row)
        {
            $costingPerQty=0;
            if($row['COSTING_PER']==1) $costingPerQty=12;
            elseif($row['COSTING_PER']==2) $costingPerQty=1;    
            elseif($row['COSTING_PER']==3) $costingPerQty=24;
            elseif($row['COSTING_PER']==4) $costingPerQty=36;
            elseif($row['COSTING_PER']==5) $costingPerQty=48;
            else $costingPerQty=0;
            
            $costingPerArr[$row['JOB_ID']]=$costingPerQty;
            
            $po_arr[$row['JOB_ID']][$row['ID']][$row['ITEM_NUMBER_ID']][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['poqty']+=$row['ORDER_QUANTITY'];
            $po_arr[$row['JOB_ID']][$row['ID']][$row['ITEM_NUMBER_ID']][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['planqty']+=$row['PLAN_CUT_QNTY'];     
        }
        unset($sqlpoRes);
        //==================================== YARN ALLOCATION ==============================================
        $poIdsCondYarnAllo = str_replace("po_break_down_id", "B.PO_BREAK_DOWN_ID", $poIdsCond);
        $sqlYarnAllo = "SELECT B.PO_BREAK_DOWN_ID as PO_ID,MAX(B.ALLOCATION_DATE) AS ADATE,SUM(B.QNTY) AS QNTY,SUM(case when a.allocation_date < '$current_date' then B.QNTY else 0 end) AS PREV_QNTY from INV_MATERIAL_ALLOCATION_MST A, INV_MATERIAL_ALLOCATION_DTLS B, PRODUCT_DETAILS_MASTER C WHERE A.ID=B.MST_ID AND A.ITEM_ID = C.ID AND B.ITEM_ID = C.ID AND C.item_category_id = 1 AND B.IS_DYIED_YARN != 1 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 $poIdsCondYarnAllo GROUP BY B.PO_BREAK_DOWN_ID";
        // ECHO $sqlYarnAllo;die();
        $sqlYarnAlloRes = sql_select($sqlYarnAllo);
        $yarnAlloArr = array();
        foreach ($sqlYarnAlloRes as $val) 
        {
            $yarnAlloArr[$val['PO_ID']]['qnty'] = $val['QNTY'];
            $yarnAlloArr[$val['PO_ID']]['prev_qnty'] = $val['PREV_QNTY'];
            $yarnAlloArr[$val['PO_ID']]['date'] = $val['ADATE'];
        }
        unset($sqlYarnAlloRes);

        $condition= new condition();     
        $condition->po_id_in($poIDS);     
        $condition->init();
        $costPerArr=$condition->getCostingPerArr();
        $yarn= new yarn($condition);
        //echo $yarn->getQuery(); die;       
        $yarnReqQtyArr=$yarn->getOrderWiseYarnQtyArray();
        $conversion= new conversion($condition);
        $conversion_costing_arr=$conversion->getQtyArray_by_orderAndProcess();
        // echo"<pre>";print_r($conversion_costing_arr);die();
        $trims= new trims($condition);
         // echo $trims->getQuery(); die;
        $trims_costing_arr=$trims->getQtyArray_by_orderAndTrimsTypeid();
        // echo"<pre>";print_r($trims_costing_arr);die();
        $fabric= new fabric($condition);
        // echo $fabric->getQuery(); die; 
        $fabric_costing_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish_production();
        $fabric_purchase_costing_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish_purchase();        
        $fabric_po_color_type_wise_arr=$fabric->getQtyArray_by_orderColorType_knitAndwoven_greyAndfinish();
        $fabric_costing_aop_arr = $fabric->getQtyArray_by_orderAndColorTypeFabricSource_knitAndwoven_greyAndfinish();
        // echo"<pre>";print_r($fabric_purchase_costing_arr);die();
        $emblishment= new emblishment($condition);
        $emblishment_costing_arr=$emblishment->getQtyArray_by_orderAndEmbname();
        // echo"<pre>";print_r($emblishment_costing_arr);die();
        // echo $emblishment->getQuery(); die;   
        $wash= new wash($condition);
        $emblishment_costing_arr_name=$wash->getQtyArray_by_orderAndEmbname();
        // echo $wash->getQuery(); die;       

        //======================================== YARN ISSUE ====================================
        $poIdsCondYrnIss = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
        $sqlYrnIss = "SELECT C.PO_BREAKDOWN_ID,SUM(CASE WHEN B.TRANSACTION_TYPE=2 THEN C.QUANTITY ELSE 0 END) AS ISSUE_QNTY,SUM(CASE WHEN B.TRANSACTION_TYPE=4 THEN C.QUANTITY ELSE 0 END) AS RTN_QTY FROM INV_ISSUE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE in(2,4) $poIdsCondYrnIss and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=3 AND A.ITEM_CATEGORY=1 and a.issue_basis=3 and a.issue_purpose=1 GROUP BY C.PO_BREAKDOWN_ID";
        // echo $sqlYrnIss;die();
        $sqlYrnIssRes = sql_select($sqlYrnIss);
        $yarnIssueQtyArr = array();
        foreach ($sqlYrnIssRes as $val) 
        {
            $yarnIssueQtyArr[$val['PO_BREAKDOWN_ID']]['issue'] = $val['ISSUE_QNTY'];
            $yarnIssueQtyArr[$val['PO_BREAKDOWN_ID']]['rtn'] = $val['RTN_QTY'];
        }
        unset($sqlYrnIssRes);
        // ======================================= Yarn dyed receive ==============================
        $poIdsCondYarnDye = str_replace("po_break_down_id", "B.ORDER_ID", $poIdsCond);
        $sql = "SELECT A.RECEIVE_DATE,B.ORDER_ID,SUM(B.CONS_QUANTITY) AS QNTY FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B WHERE A.RECEIVE_BASIS=2 AND A.RECEIVE_PURPOSE=2 AND B.TRANSACTION_TYPE=1 $poIdsCondYarnDye and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND A.ENTRY_FORM=1 AND A.ITEM_CATEGORY=1 GROUP BY B.ORDER_ID,A.RECEIVE_DATE order by A.RECEIVE_DATE ASC ";
        // echo $sql;die();
        $sqlYRes = sql_select($sql);
        $yarnDyedArr = array();
        foreach ($sqlYRes as  $val) 
        {
           $yarnDyedArr[$val['ORDER_ID']]['qty'] += $val['QNTY'];
           $yarnDyedArr[$val['ORDER_ID']]['lstqty'] = $val['QNTY'];
        }
        unset($sqlYRes);
        // ======================================= YARN DYED ISSUE ==============================
        // $poIdsCondYarnDye = str_replace("po_break_down_id", "B.ORDER_ID", $poIdsCond);
        $sqlDyeYrnIss = "SELECT C.PO_BREAKDOWN_ID,SUM(CASE WHEN B.TRANSACTION_TYPE=2 THEN C.QUANTITY ELSE 0 END) AS ISSUE_QNTY,SUM(CASE WHEN B.TRANSACTION_TYPE=4 THEN C.QUANTITY ELSE 0 END) AS RTN_QTY FROM INV_ISSUE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE in(2,4) $poIdsCondYrnIss and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=3 AND A.ITEM_CATEGORY=1 and a.issue_basis=1 and a.issue_purpose=2 GROUP BY C.PO_BREAKDOWN_ID";
        // echo $sqlDyeYrnIss;die();
        $sqlDyeYrnIssRes = sql_select($sqlDyeYrnIss);
        $yarnDyeIssueQtyArr = array();
        foreach ($sqlDyeYrnIssRes as $val) 
        {
            $yarnDyeIssueQtyArr[$val['PO_BREAKDOWN_ID']]['issue'] = $val['ISSUE_QNTY'];
            $yarnDyeIssueQtyArr[$val['PO_BREAKDOWN_ID']]['rtn'] = $val['RTN_QTY'];
        }
        unset($sqlDyeYrnIssRes);
        // echo "<pre>";print_r($yarnDyeIssueQtyArr);die();
        // ======================================= GREY PROD ==============================
        $poIdsCondGrey = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
        $sqlGrey = "SELECT C.PO_BREAKDOWN_ID,A.RECEIVE_DATE AS RCV_DATE,SUM(C.QUANTITY) AS QNTY,SUM(case when a.receive_date < '$current_date' then C.QUANTITY else 0 end) AS PREV_QNTY FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE=1 $poIdsCondGrey and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=2 AND A.ITEM_CATEGORY=13 GROUP BY C.PO_BREAKDOWN_ID,A.RECEIVE_DATE order by A.RECEIVE_DATE ASC ";
        // echo $sqlGrey;die();
        $greyRes = sql_select($sqlGrey);
        $greyProdArr = array();
        foreach ($greyRes as  $val) 
        {
           $greyProdArr[$val['PO_BREAKDOWN_ID']]['qty']     += $val['QNTY'];
           $greyProdArr[$val['PO_BREAKDOWN_ID']]['prev_qnty']     += $val['PREV_QNTY'];
           $greyProdArr[$val['PO_BREAKDOWN_ID']]['lstqty']  = $val['QNTY'];
           $greyProdArr[$val['PO_BREAKDOWN_ID']]['date']    = $val['RCV_DATE'];
        }
        unset($greyRes);
        /*======================================================================================/
        /                                    grey fab transfer                                  /
        /======================================================================================*/
        $to_order_id_con =where_con_using_array($poIdArray,0,"a.to_order_id");
        $from_order_id_con =where_con_using_array($poIdArray,0,"a.from_order_id");

        $transfer_sql_in=sql_select("SELECT a.to_order_id,b.transfer_qnty as qnty FROM inv_item_transfer_mst a, inv_item_transfer_dtls b WHERE a.id = b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=13 and a.entry_form in(13) and a.transfer_criteria=4 and b.active_dtls_id_in_transfer=1 $to_order_id_con");
        $grey_fab_transfer_data=array();
        foreach ($transfer_sql_in as $row) 
        {
            $grey_fab_transfer_data[$row[csf('to_order_id')]]['in']+=$row[csf('qnty')];
        }
        $transfer_sql_out=sql_select("SELECT a.from_order_id,b.transfer_qnty as qnty FROM inv_item_transfer_mst a, inv_item_transfer_dtls b WHERE a.id = b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=13 and a.entry_form in(13) and a.transfer_criteria=4 and b.active_dtls_id_in_transfer=0 $from_order_id_con");
        foreach ($transfer_sql_out as $row) 
        {
            $grey_fab_transfer_data[$row[csf('from_order_id')]]['out']+=$row[csf('qnty')];
        }
        // echo "<pre>";print_r($grey_fab_transfer_data);die();
        //======================================== PROGRAM QNTY ================================
        $poIdsProg = str_replace("po_break_down_id", "PO_ID", $poIdsCond);
        $sqlProg = "SELECT PO_ID,sum(program_qnty) as QTY from ppl_planning_entry_plan_dtls where status_active=1 and is_deleted=0 $poIdsProg group by PO_ID";
        // echo $sqlProg;die();
        $pogRes = sql_select($sqlProg);
        $progQtyArray = array();
        foreach ($pogRes as $val) 
        {
            $progQtyArray[$val['PO_ID']] = $val['QTY'];
        }
        unset($pogRes);
        // ======================================= DYEING PRODUCTION ==============================
        $poIdsCondDye = str_replace("po_break_down_id", "B.PO_ID", $poIdsCond);
        // $sqlDye = "SELECT B.PO_ID,C.PRODUCTION_DATE AS PDATE,SUM(B.BATCH_QNTY) AS QTY FROM PRO_BATCH_CREATE_MST A, PRO_BATCH_CREATE_DTLS B,PRO_FAB_SUBPROCESS C WHERE A.ID=B.MST_ID AND A.ID=C.BATCH_ID $poIdsCondDye AND C.LOAD_UNLOAD_ID=2 and a.batch_against<>2 AND C.PROCESS_ID='31' AND C.RESULT=1 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 GROUP BY B.PO_ID,C.PRODUCTION_DATE order by C.PRODUCTION_DATE ASC";

        $sqlDye = "SELECT B.PO_ID,C.PRODUCTION_DATE AS PDATE,SUM(B.BATCH_QNTY) AS QTY,SUM(case when c.PROCESS_END_DATE < '$current_date' then B.BATCH_QNTY else 0 end) AS PREV_QTY FROM PRO_BATCH_CREATE_MST A, PRO_BATCH_CREATE_DTLS B,PRO_FAB_SUBPROCESS C WHERE A.ID=B.MST_ID  AND A.ID=C.BATCH_ID $poIdsCondDye AND C.LOAD_UNLOAD_ID=2  and a.batch_against<>2  AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 and a.extention_no is null GROUP BY B.PO_ID,C.PRODUCTION_DATE order by C.PRODUCTION_DATE ASC";
        // echo $sqlDye;die();
        $dyeRes = sql_select($sqlDye);
        $dyeingProdArr = array();
        foreach ($dyeRes as $val) 
        {
           $dyeingProdArr[$val['PO_ID']]['in'] += $val['QTY'];
           $dyeingProdArr[$val['PO_ID']]['prev_in'] += $val['PREV_QTY'];
           $dyeingProdArr[$val['PO_ID']]['lstqty'] = $val['QTY'];
           $dyeingProdArr[$val['PO_ID']]['date'] = $val['PDATE'];
        }
        unset($dyeRes);

        // ======================================= DYEING PRODUCTION (Outbound) ==============================
        $poIdsCondDye = str_replace("po_break_down_id", "B.ORDER_ID", $poIdsCond);
        $sqlDye = "SELECT B.order_id as PO_ID,A.RECEIVE_DATE AS PDATE,SUM(B.GREY_USED) AS QTY,sum(b.BATCH_ISSUE_QTY) as BATCH_QTY FROM INV_RECEIVE_MAS_BATCHROLL A, PRO_GREY_BATCH_DTLS B WHERE A.ID=B.MST_ID  $poIdsCondDye AND B.PROCESS_ID='31' AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 and a.dyeing_source=3 and a.entry_form=92 GROUP BY B.order_id,A.RECEIVE_DATE order by A.RECEIVE_DATE ASC";
        // echo $sqlDye;die();
        $dyeRes = sql_select($sqlDye);
        foreach ($dyeRes as $val) 
        {
           // $dyeingProdArr[$val['PO_ID']]['qty'] += $val['QTY'];
           $dyeingProdArr[$val['PO_ID']]['batch_qty'] += $val['QTY'];
           // $dyeingProdArr[$val['PO_ID']]['lstqty'] = $val['QTY'];
           // $dyeingProdArr[$val['PO_ID']]['date'] = $val['PDATE'];
        }

        $poIdsCondFin = str_replace("po_break_down_id", "c.po_breakdown_id", $poIdsCond);
        $sqlDye = "SELECT c.po_breakdown_id as po_id,b.grey_used_qty as QTY,(case when a.receive_date<'$current_date' then b.grey_used_qty else 0 end) as PREV_QTY from inv_receive_master a,pro_finish_fabric_rcv_dtls b,order_wise_pro_details c where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 $poIdsCondFin and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(37) and c.entry_form in(37) and a.item_category=2 and a.receive_basis=11 and a.company_id=$company_id";
         // echo $sqlDye;die();
        $dyeRes = sql_select($sqlDye);
        foreach ($dyeRes as $val) 
        {
           $dyeingProdArr[$val['PO_ID']]['out'] += $val['QTY'];
           $dyeingProdArr[$val['PO_ID']]['prev_out'] += $val['PREV_QTY'];
        }

        // ======================================= BATCH QNTY ==============================
        $poIdsCondDye = str_replace("po_break_down_id", "B.PO_ID", $poIdsCond);
        $sqlBatch = "SELECT B.PO_ID,SUM(B.BATCH_QNTY) AS QTY FROM PRO_BATCH_CREATE_MST A, PRO_BATCH_CREATE_DTLS B WHERE A.ID=B.MST_ID $poIdsCondDye AND a.batch_against IN (1) AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY B.PO_ID";
        // echo $sqlBatch;die();
        $batchRes = sql_select($sqlBatch);
        $batchQtyArr = array();
        foreach ($batchRes as $val) 
        {
           $batchQtyArr[$val['PO_ID']]['qty'] = $val['QTY'];
        }
        unset($batchRes);
        // ======================================= AOP ==============================
        $poIdsCondAop = str_replace("po_break_down_id", "B.ORDER_ID", $poIdsCond);
        $sqlAOP = "SELECT B.ORDER_ID,A.RECEIVE_DATE AS RDATE,SUM(CASE WHEN A.ENTRY_FORM=91 THEN B.BATCH_ISSUE_QTY ELSE 0 END) AS ISSUE_QTY,SUM(CASE WHEN A.ENTRY_FORM=92 THEN B.BATCH_ISSUE_QTY ELSE 0 END) AS RCV_QTY,SUM(CASE WHEN A.ENTRY_FORM=92 and a.RECEIVE_DATE < '$current_date' THEN B.BATCH_ISSUE_QTY ELSE 0 END) AS PREV_RCV_QTY FROM INV_RECEIVE_MAS_BATCHROLL A, PRO_GREY_BATCH_DTLS B WHERE A.ID=B.MST_ID $poIdsCondAop AND B.PROCESS_ID=35 AND A.ENTRY_FORM in(91,92) AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY B.ORDER_ID,A.RECEIVE_DATE order by A.RECEIVE_DATE";
        // echo $sqlAOP;die();
        $AOPRes = sql_select($sqlAOP);
        $aopProdArr = array();
        foreach ($AOPRes as $val) 
        {
            $aopProdArr[$val['ORDER_ID']]['qty'] += $val['RCV_QTY'];
            $aopProdArr[$val['ORDER_ID']]['prev_qty'] += $val['PREV_RCV_QTY'];
            $aopProdArr[$val['ORDER_ID']]['issueqty'] += $val['ISSUE_QTY'];
            if($val['RCV_QTY']!=0)
            {
                $aopProdArr[$val['ORDER_ID']]['lstqty'] = $val['RCV_QTY'];
            }
            $aopProdArr[$val['ORDER_ID']]['date'] = $val['RDATE'];
        }
        unset($AOPRes);
        // print_r($aopProdArr);die();
        // ======================================= TRIMS (acc)============================== 
        $poIdsCondAcc = str_replace("po_break_down_id", "B.ID", $poIdsCond);
        $sqlTrimsBudget = "SELECT B.ID AS PO_ID,COUNT(distinct A.trim_group) AS TOT_ITEM FROM WO_PRE_COST_TRIM_COST_DTLS A, WO_PO_BREAK_DOWN B WHERE A.JOB_ID=B.JOB_ID $poIdsCondAcc AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY B.ID";//COUNT(A.ID)
        // echo $sqlTrimsBudget;die();
        $trimsItemCountBudgetWise = array();
        $trimsBudgetRes = sql_select($sqlTrimsBudget);
        foreach ($trimsBudgetRes as $val) 
        {
            $trimsItemCountBudgetWise[$val['PO_ID']] = $val['TOT_ITEM'];
        }
        unset($trimsBudgetRes);
        //====================================================================     
        $poIdsCondAcc = str_replace("po_break_down_id", "C.PO_BREAK_DOWN_ID", $poIdsCond);
        $sqlTrims = "SELECT C.PO_BREAK_DOWN_ID,COUNT(distinct B.TRIM_GROUP) AS TOT_ITEM FROM WO_BOOKING_MST A,WO_BOOKING_DTLS B,WO_TRIM_BOOK_CON_DTLS C WHERE A.BOOKING_NO=B.BOOKING_NO AND B.BOOKING_NO=C.BOOKING_NO AND B.ID=C.WO_TRIM_BOOKING_DTLS_ID $poIdsCondAcc and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=87 AND A.BOOKING_TYPE=2 AND A.IS_SHORT=2 GROUP BY C.PO_BREAK_DOWN_ID ";
        // echo $sqlTrims;die();
        $trimsRes = sql_select($sqlTrims);
        $trimsBookingArr = array();
        foreach ($trimsRes as  $val) 
        {
           $trimsBookingArr[$val['PO_BREAK_DOWN_ID']] = $val['TOT_ITEM'];
        }
        unset($trimsRes);
        // ======================================= FINISH FAB RCV ==============================   
        $poIdsCondFin = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
        $sqlFinFab = "SELECT C.PO_BREAKDOWN_ID,A.RECEIVE_DATE AS RCV_DATE,SUM(C.QUANTITY) AS QNTY,SUM(case when a.receive_date < '$current_date' then C.QUANTITY else 0 end) AS PREV_QNTY,b.ORDER_UOM FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE=1 $poIdsCondFin and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM in(7,37) AND A.ITEM_CATEGORY=2 GROUP BY C.PO_BREAKDOWN_ID,A.RECEIVE_DATE,b.ORDER_UOM order by A.RECEIVE_DATE ASC";
         // echo $sqlFinFab;die();
        $finFabRes = sql_select($sqlFinFab);
        $finFabProdArr = array();
        $finFabProdWithUomArray = array();
        foreach ($finFabRes as  $val) 
        {
            $finFabProdArr[$val['PO_BREAKDOWN_ID']]['qty'] += $val['QNTY'];
            $finFabProdArr[$val['PO_BREAKDOWN_ID']]['lstqty'] = $val['QNTY'];
            $finFabProdArr[$val['PO_BREAKDOWN_ID']]['date'] = $val['RCV_DATE'];

            $finFabProdWithUomArray[$val['PO_BREAKDOWN_ID']][$val['ORDER_UOM']]['qty'] += $val['QNTY'];
            $finFabProdWithUomArray[$val['PO_BREAKDOWN_ID']][$val['ORDER_UOM']]['prev_qty'] += $val['PREV_QNTY'];
        }
        unset($finFabRes);
        // echo "<pre>";print_r($finFabProdWithUomArray);die();
        // ======================================= FINISH FAB PURCHASE ==============================   
        $poIdsCondFin = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
        $sqlFinFabpur = "SELECT C.PO_BREAKDOWN_ID,A.RECEIVE_DATE AS RCV_DATE,SUM(C.QUANTITY) AS QNTY,SUM(case when a.receive_date < '$current_date' then C.QUANTITY else 0 end) AS PREV_QNTY FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE=1 and a.receive_basis in(1,2,4) $poIdsCondFin and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM in(37) AND A.ITEM_CATEGORY=2 GROUP BY C.PO_BREAKDOWN_ID,A.RECEIVE_DATE order by A.RECEIVE_DATE ASC";
        // echo $sqlFinFabpur;die();
        $finFabPurRes = sql_select($sqlFinFabpur);
        $finFabPurchaseArr = array();
        foreach ($finFabPurRes as  $val) 
        {
           $finFabPurchaseArr[$val['PO_BREAKDOWN_ID']]['qty'] += $val['QNTY'];
           $finFabPurchaseArr[$val['PO_BREAKDOWN_ID']]['prev_qty'] += $val['PREV_QNTY'];
        }
        unset($finFabPurRes);

        // ======================================= FINISH FAB TRANSFER ==============================   
        $poIdsCondTrnsfr = str_replace("po_break_down_id", "B.PO_BREAKDOWN_ID", $poIdsCond);
        //$sqlFinFabTr = "SELECT C.ORDER_ID,C.TRANSACTION_TYPE,SUM(B.TRANSFER_QNTY) AS QNTY FROM INV_ITEM_TRANSFER_MST A,INV_ITEM_TRANSFER_DTLS B,INV_TRANSACTION C WHERE A.ID=B.MST_ID AND A.ID=C.MST_ID AND C.ID=B.TRANS_ID  AND C.TRANSACTION_TYPE in(5,6) and A.TRANSFER_CRITERIA=4 $poIdsCondTrnsfr and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=14 AND A.ITEM_CATEGORY=2 GROUP BY C.ORDER_ID,C.TRANSACTION_TYPE ";
        $sqlFinFabTr = "SELECT B.PO_BREAKDOWN_ID,A.TRANSACTION_TYPE,SUM(B.QUANTITY) AS QNTY FROM INV_TRANSACTION A,ORDER_WISE_PRO_DETAILS B,INV_ITEM_TRANSFER_MST C WHERE A.ID=B.trans_id and a.prod_id=b.prod_id and c.id=a.mst_id AND a.TRANSACTION_TYPE in(5,6) and c.TRANSFER_CRITERIA=4 $poIdsCondTrnsfr and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND c.ENTRY_FORM=14 AND A.ITEM_CATEGORY=2 GROUP BY B.PO_BREAKDOWN_ID,A.TRANSACTION_TYPE ";
        // echo $sqlFinFabTr;die();
        $sqlFinFabTrRes = sql_select($sqlFinFabTr);
        $finFabTrnsArr = array();
        foreach ($sqlFinFabTrRes as  $val) 
        {
           $finFabTrnsArr[$val['PO_BREAKDOWN_ID']][$val['TRANSACTION_TYPE']]['qty'] = $val['QNTY'];
        }
        unset($sqlFinFabTrRes);
        
        // ======================================= FIN FAB RECEIVE BY FIN FAB STORE ==============================    
        $poIdsCondStock = str_replace("po_break_down_id", "D.PO_BREAKDOWN_ID", $poIdsCond);    
        $sql_stock2="SELECT D.PO_BREAKDOWN_ID, 
        SUM(CASE WHEN D.ENTRY_FORM IN (7,37,66,68) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_RECEIVE_QNTY,
        SUM(CASE WHEN D.ENTRY_FORM IN (7,37,66,68) AND C.STORE_ID IN(8,20,32) and b.TRANSFER_DATE < '$current_date' THEN D.QUANTITY ELSE 0 END) AS PREV_GMT_RECEIVE_QNTY,
        SUM(CASE WHEN D.ENTRY_FORM IN (46) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_RCV_RTN_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=5 AND a.from_store IN (16,46,14,47) and a.to_store in(8,20,32,52) THEN D.QUANTITY ELSE 0 END) AS GMT_REC_TRNS_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=5 AND a.from_store IN (16,46,14,47) and a.to_store in(8,20,32,52)  and b.TRANSFER_DATE < '$current_date' THEN D.QUANTITY ELSE 0 END) AS PREV_GMT_REC_TRNS_QNTY
        FROM  INV_ITEM_TRANSFER_MST b,ORDER_WISE_PRO_DETAILS D,INV_TRANSACTION C,PRODUCT_DETAILS_MASTER E,INV_ITEM_TRANSFER_DTLS a WHERE D.TRANS_ID=C.ID AND C.PROD_ID=E.ID and b.id=c.mst_id and b.is_acknowledge=1 AND D.TRANS_ID!=0  AND C.ITEM_CATEGORY=2 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND D.STATUS_ACTIVE=1 AND D.IS_DELETED=0 AND E.STATUS_ACTIVE=1 AND E.IS_DELETED=0 $poIdsCondStock AND E.COMPANY_ID=$company_id  and b.id=a.mst_id and a.id=D.DTLS_ID and a.status_active=1 GROUP BY D.PO_BREAKDOWN_ID ";//AND D.ENTRY_FORM IN (7,37,66,68)
        // echo $sql_stock2;die();
        $stockRes = sql_select($sql_stock2);
        $finFabStkArray2 = array();
        foreach ($stockRes as $val) 
        {
            $finFabStkArray2[$val['PO_BREAKDOWN_ID']]['gmt_rcv'] = $val['GMT_RECEIVE_QNTY'];
            $finFabStkArray2[$val['PO_BREAKDOWN_ID']]['prev_gmt_rcv'] = $val['PREV_GMT_RECEIVE_QNTY'];
            $finFabStkArray2[$val['PO_BREAKDOWN_ID']]['gmt_rcv_rtn'] = $val['GMT_RCV_RTN_QNTY'];
            $finFabStkArray2[$val['PO_BREAKDOWN_ID']]['gmt_rcv_trns'] = $val['GMT_REC_TRNS_QNTY'];
            $finFabStkArray2[$val['PO_BREAKDOWN_ID']]['prev_gmt_rcv_trns'] = $val['PREV_GMT_REC_TRNS_QNTY'];
        }

        // ======================================= FINISH FAB ISSUE TO CUT ==============================
        $sqlIssue = "SELECT C.PO_BREAKDOWN_ID,MAX(A.ISSUE_DATE) AS ISSUE_DATE,SUM(C.QUANTITY) AS QNTY FROM INV_ISSUE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE=2 AND A.ISSUE_PURPOSE=9 $poIdsCondFin and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=18 AND A.ITEM_CATEGORY=2 GROUP BY C.PO_BREAKDOWN_ID ";
        // echo $sqlIssue;die();
        $issueRes = sql_select($sqlIssue);
        $issueProdArr = array();
        foreach ($issueRes as  $val) 
        {
           $issueProdArr[$val['PO_BREAKDOWN_ID']]['qty'] = $val['QNTY'];
           $issueProdArr[$val['PO_BREAKDOWN_ID']]['date'] = $val['ISSUE_DATE'];
        }
        unset($issueRes);
        // ======================================= FIN FAB STOCK ==============================
        $poIdsCondStock = str_replace("po_break_down_id", "D.PO_BREAKDOWN_ID", $poIdsCond);
        $sql_stock="SELECT D.PO_BREAKDOWN_ID, 
        SUM(CASE WHEN D.ENTRY_FORM IN (7,37,66,68) AND C.STORE_ID IN(14,16) THEN D.QUANTITY ELSE 0 END) AS DYE_RECEIVE_QNTY,
        SUM(CASE WHEN D.ENTRY_FORM IN (46) AND C.STORE_ID IN(14,16) THEN D.QUANTITY ELSE 0 END) AS DYE_RCV_RTN_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=5 AND C.STORE_ID IN(14,16) THEN D.QUANTITY ELSE 0 END) AS DYE_REC_TRNS_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN (18,71) AND C.STORE_ID IN(14,16) THEN D.QUANTITY ELSE 0 END) AS DYE_ISSUE_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN (126,52) AND C.STORE_ID IN(14,16) THEN D.QUANTITY ELSE 0 END) AS DYE_ISSUE_RET_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=6 AND C.STORE_ID IN(14,16) THEN D.QUANTITY ELSE 0 END) AS DYE_ISSUE_TRNS_QNTY,    
        SUM(CASE WHEN D.ENTRY_FORM IN (7,37,66,68) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_RECEIVE_QNTY,
        SUM(CASE WHEN D.ENTRY_FORM IN (46) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_RCV_RTN_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=5 AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_REC_TRNS_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN (18,71) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_ISSUE_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN (126,52) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_ISSUE_RET_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=6 AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_ISSUE_TRNS_QNTY 
        FROM  ORDER_WISE_PRO_DETAILS D,INV_TRANSACTION C,PRODUCT_DETAILS_MASTER E WHERE D.TRANS_ID=C.ID AND C.PROD_ID=E.ID AND D.TRANS_ID!=0 AND D.ENTRY_FORM IN (14,7,37,66,68,14,15,18,71,126,134,52) AND C.ITEM_CATEGORY=2 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND D.STATUS_ACTIVE=1 AND D.IS_DELETED=0 AND E.STATUS_ACTIVE=1 AND E.IS_DELETED=0 $poIdsCondStock AND E.COMPANY_ID=$company_id
        GROUP BY D.PO_BREAKDOWN_ID ";
        // echo $sql_stock;die();
        $stockRes = sql_select($sql_stock);
        $finFabStkArray = array();
        foreach ($stockRes as $val) 
        {
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_rcv'] = $val['DYE_RECEIVE_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_rcv_rtn'] = $val['DYE_RCV_RTN_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_rcv_trns'] = $val['DYE_REC_TRNS_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_issue'] = $val['DYE_ISSUE_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_issue_rtn'] = $val['DYE_ISSUE_RET_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_issue_trns'] = $val['DYE_ISSUE_TRNS_QNTY'];

            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_rcv'] = $val['GMT_RECEIVE_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_rcv_rtn'] = $val['GMT_RCV_RTN_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_rcv_trns'] = $val['GMT_REC_TRNS_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_issue'] = $val['GMT_ISSUE_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_issue_rtn'] = $val['GMT_ISSUE_RET_QNTY'];
            $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_issue_trns'] = $val['GMT_ISSUE_TRNS_QNTY'];
        }
        unset($stockRes);
        // ======================================= CUT AND LAY ==============================  
        $poIdsCondFin = str_replace("po_break_down_id", "C.ORDER_ID", $poIdsCond);
        $sqlLay = "SELECT C.ORDER_ID,MAX(A.ENTRY_DATE) AS CUT_DATE,SUM(C.SIZE_QTY) AS QNTY FROM PPL_CUT_LAY_MST A,PPL_CUT_LAY_DTLS B,PPL_CUT_LAY_BUNDLE C WHERE A.ID=B.MST_ID AND A.ID=C.MST_ID AND B.ID=C.DTLS_ID $poIdsCondFin and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 GROUP BY C.ORDER_ID ";
        // echo $sqlLay;die();
        $layRes = sql_select($sqlLay);
        $cutAndLayArr = array();
        foreach ($layRes as  $val) 
        {
           $cutAndLayArr[$val['ORDER_ID']]['qty'] = $val['QNTY'];
           $cutAndLayArr[$val['ORDER_ID']]['date'] = $val['CUT_DATE'];
        }
        unset($layRes);
        // ======================================= CUTTING QC ============================== 
        $poIdsCondQC = str_replace("po_break_down_id", "B.ORDER_ID", $poIdsCond);
        $sqlCutQC = "SELECT B.ORDER_ID,A.ENTRY_DATE AS QC_DATE,SUM(B.QC_PASS_QTY) AS QNTY,SUM(B.REPLACE_QTY) AS REPLACE_QTY,SUM(B.REJECT_QTY) AS REJQNTY FROM PRO_GMTS_CUTTING_QC_MST A,PRO_GMTS_CUTTING_QC_DTLS B WHERE A.ID=B.MST_ID $poIdsCondQC and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY B.ORDER_ID,A.ENTRY_DATE order by A.ENTRY_DATE ASC";
        // echo $sqlCutQC;die();
        $CutQCRes = sql_select($sqlCutQC);
        $CutQCArr = array();
        foreach ($CutQCRes as  $val) 
        {
           $CutQCArr[$val['ORDER_ID']]['qty']   += $val['QNTY'];
           $CutQCArr[$val['ORDER_ID']]['rejqty']+= $val['REJQNTY'];
           $CutQCArr[$val['ORDER_ID']]['rplsqty']+= $val['REPLACE_QTY'];
           $CutQCArr[$val['ORDER_ID']]['date']  = $val['QC_DATE'];
           if($CutQCArr[$val['ORDER_ID']]['qty'] !=0)
           {
                $CutQCArr[$val['ORDER_ID']]['lst_rpls_qty']   = $val['QNTY'];
           }
        }
        unset($CutQCRes);
        // ======================================= SEW/FINISH TRIMS RCV ==============================
        $poIdsCondTr = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
        $sqlacc = "SELECT D.TRIM_TYPE,C.PO_BREAKDOWN_ID,MAX(A.RECEIVE_DATE) AS RCV_DATE,SUM(C.QUANTITY) AS QNTY FROM INV_RECEIVE_MASTER A,INV_TRIMS_ENTRY_DTLS B,ORDER_WISE_PRO_DETAILS C,LIB_ITEM_GROUP D WHERE A.ID=B.MST_ID AND B.ID=C.DTLS_ID AND D.ID=B.ITEM_GROUP_ID AND C.TRANS_TYPE=1 $poIdsCondTr and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=24 AND c.entry_form = 24 AND D.TRIM_TYPE !=0 AND A.ITEM_CATEGORY=4 GROUP BY C.PO_BREAKDOWN_ID,D.TRIM_TYPE ";
        // echo $sqlacc;die();
        $accbRes = sql_select($sqlacc);
        $accArr = array();
        foreach ($accbRes as  $val) 
        {
           $accArr[$val['PO_BREAKDOWN_ID']][$val['TRIM_TYPE']]['qty'] = $val['QNTY'];
           $accArr[$val['PO_BREAKDOWN_ID']][$val['TRIM_TYPE']]['date'] = $val['RCV_DATE'];
        }
        unset($accbRes);
        // echo "<pre>";print_r($accArr);die();
        // ======================================= GMTS PRODUCTION DATA ==============================
        $poIdsCondGmts = str_replace("po_break_down_id", "A.PO_BREAK_DOWN_ID", $poIdsCond);
        $sqlProd = "SELECT  A.PO_BREAK_DOWN_ID AS PO_ID,A.PRODUCTION_DATE AS PROD_DATE, SUM(CASE WHEN A.PRODUCTION_TYPE=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS CUT_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PRINTING_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=2 AND A.EMBEL_NAME=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PRINT_ISS_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=2 THEN B.PRODUCTION_QNTY ELSE 0 END) AS EMB_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=2 AND A.EMBEL_NAME=2 THEN B.PRODUCTION_QNTY ELSE 0 END) AS EMB_ISSUE_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=3 THEN B.PRODUCTION_QNTY ELSE 0 END) AS WASH_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=2 AND A.EMBEL_NAME=3 THEN B.PRODUCTION_QNTY ELSE 0 END) AS WASH_ISSUE_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=4 THEN B.PRODUCTION_QNTY ELSE 0 END) AS INPUT_QTY, SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.PRODUCTION_QNTY ELSE 0 END) AS OUT_QTY, SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.ALTER_QTY ELSE 0 END) AS ALTER_QTY, SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.SPOT_QTY ELSE 0 END) AS SPOT_QTY, SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.REPLACE_QTY ELSE 0 END) AS REPLACE_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=1 THEN B.REJECT_QTY ELSE 0 END) AS PRINT_REJECT_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=2 THEN B.REJECT_QTY ELSE 0 END) AS EMB_REJECT_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=3 THEN B.REJECT_QTY ELSE 0 END) AS WASH_REJECT_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.REJECT_QTY ELSE 0 END) AS REJECT_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=8 THEN B.PRODUCTION_QNTY ELSE 0 END) AS FINISH_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=8 THEN B.REJECT_QTY ELSE 0 END) AS FIN_REJECT_QTY,
         
        SUM(CASE WHEN A.PRODUCTION_TYPE=1 and a.production_date < '$current_date' THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_CUT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=1 and a.production_date < '$current_date' THEN B.REJECT_QTY ELSE 0 END) AS PREV_CUT_REJECT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_PRINTING_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=2 and a.production_date < '$current_date' AND A.EMBEL_NAME=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_PRINT_ISS_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=2 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_EMB_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=2 and a.production_date < '$current_date' AND A.EMBEL_NAME=2 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_EMB_ISSUE_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=3 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_WASH_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=2 and a.production_date < '$current_date' AND A.EMBEL_NAME=3 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_WASH_ISSUE_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=4 and a.production_date < '$current_date' THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_INPUT_QTY, 
        SUM(CASE WHEN A.PRODUCTION_TYPE=5 and a.production_date < '$current_date' THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_OUT_QTY, 
        SUM(CASE WHEN A.PRODUCTION_TYPE=5 and a.production_date < '$current_date' THEN B.ALTER_QTY ELSE 0 END) AS PREV_ALTER_QTY, 
        SUM(CASE WHEN A.PRODUCTION_TYPE=5 and a.production_date < '$current_date' THEN B.SPOT_QTY ELSE 0 END) AS PREV_SPOT_QTY, 
        SUM(CASE WHEN A.PRODUCTION_TYPE=5 and a.production_date < '$current_date' THEN B.REPLACE_QTY ELSE 0 END) AS PREV_REPLACE_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=1 THEN B.REJECT_QTY ELSE 0 END) AS PREV_PRINT_REJECT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=2 THEN B.REJECT_QTY ELSE 0 END) AS PREV_EMB_REJECT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=3 THEN B.REJECT_QTY ELSE 0 END) AS PREV_WASH_REJECT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=5 and a.production_date < '$current_date' THEN B.REJECT_QTY ELSE 0 END) AS PREV_REJECT_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=8 and a.production_date < '$current_date' THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_FINISH_QTY,
        SUM(CASE WHEN A.PRODUCTION_TYPE=8 and a.production_date < '$current_date' THEN B.REJECT_QTY ELSE 0 END) AS PREV_FIN_REJECT_QTY
        FROM PRO_GARMENTS_PRODUCTION_MST A, PRO_GARMENTS_PRODUCTION_DTLS B
        WHERE A.ID=B.MST_ID AND A.STATUS_ACTIVE=1 AND B.STATUS_ACTIVE=1 $poIdsCondGmts AND A.PRODUCTION_TYPE IN(1,2,3,4,5,8) GROUP BY A.PO_BREAK_DOWN_ID,A.PRODUCTION_DATE order by A.PRODUCTION_DATE ASC ";
        // echo $sqlProd;die();
        $prodRes = sql_select($sqlProd);
        $prodArr = array();
        foreach ($prodRes as  $val) 
        {
           $prodArr[$val['PO_ID']]['cut_qty']       += $val['CUT_QTY'];
           $prodArr[$val['PO_ID']]['print_qty']     += $val['PRINTING_QTY'];
           $prodArr[$val['PO_ID']]['print_iss_qty'] += $val['PRINT_ISS_QTY'];
           $prodArr[$val['PO_ID']]['print_rej_qty'] += $val['PRINT_REJECT_QTY'];
           $prodArr[$val['PO_ID']]['emb_qty']       += $val['EMB_QTY'];
           $prodArr[$val['PO_ID']]['emb_issue_qty'] += $val['EMB_ISSUE_QTY'];
           $prodArr[$val['PO_ID']]['emb_rej_qty']   += $val['EMB_REJECT_QTY'];
           $prodArr[$val['PO_ID']]['wash_qty']      += $val['WASH_QTY'];
           $prodArr[$val['PO_ID']]['wash_issue_qty']+= $val['WASH_ISSUE_QTY'];
           $prodArr[$val['PO_ID']]['wash_rej_qty']  += $val['WASH_REJECT_QTY'];
           $prodArr[$val['PO_ID']]['input_qty']     += $val['INPUT_QTY'];
           $prodArr[$val['PO_ID']]['out_qty']       += $val['OUT_QTY'];
           

           $prodArr[$val['PO_ID']]['prev_cut_qty']       += $val['PREV_CUT_QTY'];
           $prodArr[$val['PO_ID']]['prev_cut_reject_qty']+= $val['PREV_CUT_REJECT_QTY'];
           $prodArr[$val['PO_ID']]['prev_print_qty']     += $val['PREV_PRINTING_QTY'];
           $prodArr[$val['PO_ID']]['prev_print_iss_qty'] += $val['PREV_PRINT_ISS_QTY'];
           $prodArr[$val['PO_ID']]['prev_print_rej_qty'] += $val['PREV_PRINT_REJECT_QTY'];
           $prodArr[$val['PO_ID']]['prev_emb_qty']       += $val['PREV_EMB_QTY'];
           $prodArr[$val['PO_ID']]['prev_emb_issue_qty'] += $val['PREV_EMB_ISSUE_QTY'];
           $prodArr[$val['PO_ID']]['prev_emb_rej_qty']   += $val['PREV_EMB_REJECT_QTY'];
           $prodArr[$val['PO_ID']]['prev_wash_qty']      += $val['PREV_WASH_QTY'];
           $prodArr[$val['PO_ID']]['prev_wash_issue_qty']+= $val['PREV_WASH_ISSUE_QTY'];
           $prodArr[$val['PO_ID']]['prev_wash_rej_qty']  += $val['PREV_WASH_REJECT_QTY'];
           $prodArr[$val['PO_ID']]['prev_input_qty']     += $val['PREV_INPUT_QTY'];
           $prodArr[$val['PO_ID']]['prev_out_qty']       += $val['PREV_OUT_QTY'];

           if($val['OUT_QTY']>0)
           {
                $prodArr[$val['PO_ID']]['lst_out_qty']    = $val['OUT_QTY'];
           }
           $prodArr[$val['PO_ID']]['reject_qty']    += $val['REJECT_QTY'];
           $prodArr[$val['PO_ID']]['alter_qty']     += $val['ALTER_QTY'];
           $prodArr[$val['PO_ID']]['spot_qty']      += $val['SPOT_QTY'];
           $prodArr[$val['PO_ID']]['replace_qty']   += $val['REPLACE_QTY'];
           $prodArr[$val['PO_ID']]['finish_qty']    += $val['FINISH_QTY'];
           $prodArr[$val['PO_ID']]['fin_rej_qty']   += $val['FIN_REJECT_QTY'];
           $prodArr[$val['PO_ID']]['date']          = $val['PROD_DATE'];

            $prodArr[$val['PO_ID']]['prev_reject_qty']    += $val['PREV_REJECT_QTY'];
            $prodArr[$val['PO_ID']]['prev_alter_qty']     += $val['PREV_ALTER_QTY'];
            $prodArr[$val['PO_ID']]['prev_spot_qty']      += $val['PREV_SPOT_QTY'];
            $prodArr[$val['PO_ID']]['prev_replace_qty']   += $val['PREV_REPLACE_QTY'];
            $prodArr[$val['PO_ID']]['prev_finish_qty']    += $val['PREV_FINISH_QTY'];
            $prodArr[$val['PO_ID']]['prev_fin_rej_qty']   += $val['PREV_FIN_REJECT_QTY'];

           if($val['FINISH_QTY'] != 0)
           {
                $prodArr[$val['PO_ID']]['lst_finish_qty']= $val['FINISH_QTY'];
           }
           if($val['WASH_QTY'] != 0)
           {
                $prodArr[$val['PO_ID']]['lst_wash_qty']= $val['WASH_QTY'];
           }
           if($val['EMB_QTY'] != 0)
           {
                $prodArr[$val['PO_ID']]['lst_emb_qty']= $val['EMB_QTY'];
           }
           if($val['PRINTING_QTY'] != 0)
           {
                $prodArr[$val['PO_ID']]['lst_prnt_qty']= $val['PRINTING_QTY'];
           }
        }
        unset($prodRes);
        // echo "<pre>";print_r($prodArr);die();

        // ======================================= EXFACTORY DATA ==============================
        $poIdsCondExf = str_replace("po_break_down_id", "C.PO_BREAK_DOWN_ID", $poIdsCond);
        $sqlEx = "SELECT  C.PO_BREAK_DOWN_ID AS PO_ID,C.EX_FACTORY_DATE AS EX_DATE, SUM(D.PRODUCTION_QNTY) AS EX_FACT_QTY FROM PRO_EX_FACTORY_MST C, PRO_EX_FACTORY_DTLS D, PRO_EX_FACTORY_DELIVERY_MST E WHERE C.ID=D.MST_ID AND E.ID=C.DELIVERY_MST_ID  AND C.STATUS_ACTIVE=1 AND D.STATUS_ACTIVE=1 AND E.STATUS_ACTIVE=1 $poIdsCondExf GROUP BY C.PO_BREAK_DOWN_ID,C.EX_FACTORY_DATE ORDER BY C.EX_FACTORY_DATE ASC"; 
        // echo $sqlEx;die();
        $sqlXRes = sql_select($sqlEx);
        $exfArr = array();
        foreach ($sqlXRes as  $val) 
        {
           $exfArr[$val['PO_ID']]['qty']    += $val['EX_FACT_QTY'];
           $exfArr[$val['PO_ID']]['lqty']   = $val['EX_FACT_QTY'];
           $exfArr[$val['PO_ID']]['exdate'] .= isset($exfArr[$val['PO_ID']]['exdate']) ? ",".strtotime($val['EX_DATE']) : strtotime($val['EX_DATE']);
        }
        unset($sqlXRes);
        // echo "<pre>";print_r($exfArr);die();

        //================================ getting tna plan data ==========================
        $po_id_cond = str_replace("po_break_down_id", "A.PO_ID", $poIdsCond);
        $sqltna = "SELECT A.PO_ID,a.TASK_ID,a.SOURCE_ID,a.PLAN_QTY as ALL_PLAN_QTY,(case when a.plan_date < '$current_date' then a.PLAN_QTY else 0 end) as prev_plan_qty from tna_plan_target a,wo_po_break_down b where a.PO_ID=b.id and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0  and a.PLAN_QTY>0 and a.task_type=1  and a.PLAN_DATE is not null   $po_id_cond";
        // echo $sqltna;die();
        $tnaRes = sql_select($sqltna);
        $tnaPlanTargetArray = array();
        $ffTnaPlanTargetArray = array();
        foreach ($tnaRes as $val) 
        {
            $tnaPlanTargetArray[$val['PO_ID']][$val['TASK_ID']]['all_plan_qty'] += $val['ALL_PLAN_QTY'];
            $tnaPlanTargetArray[$val['PO_ID']][$val['TASK_ID']]['prev_plan_qty'] += $val['PREV_PLAN_QTY'];

            $ffTnaPlanTargetArray[$val['PO_ID']][$val['TASK_ID']][$val['SOURCE_ID']]['all_plan_qty'] += $val['ALL_PLAN_QTY'];
            $ffTnaPlanTargetArray[$val['PO_ID']][$val['TASK_ID']][$val['SOURCE_ID']]['prev_plan_qty'] += $val['PREV_PLAN_QTY'];
        }
        unset($tnaRes);
        ?>
        <!-- <div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">This report is under development. Please be patience.</div>        -->
        
        <? 
        // echo "<pre>";print_r($dataArray);die();
        $toDay = new DateTime('now');
        $po_chk_array = array();
        $i=1;
        $buyer_wise_backlog_array = array();
        $client_wise_backlog_array = array();
        $buyerWiseAccPoArray = array();
        foreach ($dataArray as $buyer_client_id => $buyer_data)
        {
            foreach ($buyer_data as $po_id => $val)
            {
                list($buyer_id,$client_id) = explode("##", $buyer_client_id);
                $costingPer     =  $costPerArr[$val['job_no']];
                $labDipColorSub = $labDipArray[$po_id]['submit_color'];
                $labDipColorApp = $labDipArray[$po_id]['approve_color'];
                $totPoColor     = count($poWiseColorArray[$po_id]);
                $labDipPrsnt    = ($labDipColorSub/$totPoColor)*100;
                $strickoff      = $smArray[$po_id][60];
                $strickoffPrsnt = ($strickoff/$totPoColor)*100;
                $pp             = $smArray[$po_id][7];
                $ppPrsnt        = ($pp/$totPoColor)*100;
                $sizeSet        = $smArray[$po_id][60];
                $sizeSetPrsnt   = ($sizeSet/$totPoColor)*100;
                $bookingQty     = $bookingQtyArray[$po_id]['qty'];
                $bookingQtyKg   = $bookingQtyWithUomArray[$po_id][12]['qty'];
                $bookingQtyYds  = $bookingQtyWithUomArray[$po_id][23]['qty']+$bookingQtyWithUomArray[$po_id][27]['qty'];
                $bookingDate    = $bookingQtyArray[$po_id]['date'];
                //============= calculate yarn dyed rcv ============
                $yarn_dyed_rcv_qty  = $yarn_dyed_rcv_qty_array[$val['job_no']];
                $yarn_dyed_prev_rcv_qty  = $yarn_dyed_prev_rcv_qty_array[$val['job_no']];
                $po_wise_cons       = $po_wise_cons_array[$val['job_no']][$po_id];
                $job_wise_cons      = $job_wise_cons_array[$val['job_no']];
                $job_wise_dyed      = $yarn_dyed_rcv_qty / $job_wise_cons;
                $yarn_dyed_qty      = $job_wise_dyed * $po_wise_cons;

                $yarn_excess_qty    = $bookingQtyArray[$po_id]['yarn_excess_qty'];
                $grey_fab_excess_qty= $bookingQtyArray[$po_id]['grey_fab_excess_qty'];

                $fin_fab_excess_qty = $bookingQtyArray[$po_id]['fin_fab_excess_qty'];
                $fin_fab_excess_qty_kg = $bookingQtyWithUomArray[$po_id][12]['fin_fab_excess_qty'];
                $fin_fab_excess_qty_yds = $bookingQtyWithUomArray[$po_id][23]['fin_fab_excess_qty']+$bookingQtyWithUomArray[$po_id][27]['fin_fab_excess_qty'];

                $stylingSbStDate    = $tnaDateArray[$po_id][7]['start_date'];// Styling submit
                $stylingSbEndDate   = $tnaDateArray[$po_id][7]['end_date'];// Styling submit                        
                $stylingSbAcStDate  = $tnaDateArray[$po_id][7]['actual_start_date'];// Styling submit
                $stylingSbAcEndDate = $tnaDateArray[$po_id][7]['actual_finish_date'];// Styling submit

                $stylingApStDate    = $tnaDateArray[$po_id][13]['start_date'];// Styling Approval
                $stylingApEndDate   = $tnaDateArray[$po_id][13]['end_date'];// Styling Approval                        
                $stylingApAcStDate  = $tnaDateArray[$po_id][13]['actual_start_date'];// Styling Approval
                $stylingApAcEndDate = $tnaDateArray[$po_id][13]['actual_finish_date'];// Styling Approval

                $lbdpSbStDate    = $tnaDateArray[$po_id][9]['start_date'];// labdip submit
                $lbdpSbEndDate   = $tnaDateArray[$po_id][9]['end_date'];// labdip submit                        
                $lbdpSbAcStDate  = $tnaDateArray[$po_id][9]['actual_start_date'];// labdip submit
                $lbdpSbAcEndDate = $tnaDateArray[$po_id][9]['actual_finish_date'];// labdip submit

                $lbdpApStDate    = $tnaDateArray[$po_id][10]['start_date'];// labdip Approval
                $lbdpApEndDate   = $tnaDateArray[$po_id][10]['end_date'];// labdip Approval                        
                $lbdpApAcStDate  = $tnaDateArray[$po_id][10]['actual_start_date'];// labdip Approval
                $lbdpApAcEndDate = $tnaDateArray[$po_id][10]['actual_finish_date'];// labdip Approval

                $ppSbStDate    = $tnaDateArray[$po_id][8]['start_date'];// PP Sample submit
                $ppSbEndDate   = $tnaDateArray[$po_id][8]['end_date'];// PP Sample submit                        
                $ppSbAcStDate  = $tnaDateArray[$po_id][8]['actual_start_date'];// PP Sample submit
                $ppSbAcEndDate = $tnaDateArray[$po_id][8]['actual_finish_date'];// PP Sample submit

                $ppApStDate    = $tnaDateArray[$po_id][12]['start_date'];// PP Sample Approval
                $ppApEndDate   = $tnaDateArray[$po_id][12]['end_date'];// PP Sample Approval                        
                $ppApAcStDate  = $tnaDateArray[$po_id][12]['actual_start_date'];// PP Sample Approval
                $ppApAcEndDate = $tnaDateArray[$po_id][12]['actual_finish_date'];// PP Sample Approval

                $sizeSetSbStDate    = $tnaDateArray[$po_id][14]['start_date'];// Size Set submit
                $sizeSetSbEndDate   = $tnaDateArray[$po_id][14]['end_date'];// Size Set submit                        
                $sizeSetSbAcStDate  = $tnaDateArray[$po_id][14]['actual_start_date'];// Size Set submit
                $sizeSetSbAcEndDate = $tnaDateArray[$po_id][14]['actual_finish_date'];// Size Set submit

                $sizeSetApStDate    = $tnaDateArray[$po_id][15]['start_date'];// Size Set Approval
                $sizeSetApEndDate   = $tnaDateArray[$po_id][15]['end_date'];// Size Set Approval                        
                $sizeSetApAcStDate  = $tnaDateArray[$po_id][15]['actual_start_date'];// Size Set Approval
                $sizeSetApAcEndDate = $tnaDateArray[$po_id][15]['actual_finish_date'];// Size Set Approval

                $bookStDate       = $tnaDateArray[$po_id][31]['start_date'];// booking
                $bookEndDate      = $tnaDateArray[$po_id][31]['end_date'];// booking
                $bookAcStDate     = $tnaDateArray[$po_id][31]['actual_start_date'];// booking
                $bookAcEndDate    = $tnaDateArray[$po_id][31]['actual_finish_date'];// booking

                $accBkStDate    = $tnaDateArray[$po_id][32]['start_date'];// acc booking
                $accBkEndDate   = $tnaDateArray[$po_id][32]['end_date'];// acc booking
                $accAcBkStDate  = $tnaDateArray[$po_id][32]['actual_start_date'];// acc booking
                $accAcBkEndDate = $tnaDateArray[$po_id][32]['actual_finish_date'];// acc booking

                $yarntnaStDate  = $tnaDateArray[$po_id][48]['start_date'];// yan allocation
                $yarntnaEndDate = $tnaDateArray[$po_id][48]['end_date'];// yan allocation
                $yarntnaAcStDate= $tnaDateArray[$po_id][48]['actual_start_date'];// yan allocation
                $yarntnaAcEndDate= $tnaDateArray[$po_id][48]['actual_finish_date'];// yan allocation

                $ydtnaStDate    = $tnaDateArray[$po_id][52]['start_date'];// yarn dyed
                $ydtnaEndDate   = $tnaDateArray[$po_id][52]['end_date'];// yarn dyed
                $ydtnaAcStDate  = $tnaDateArray[$po_id][52]['actual_start_date'];// yarn dyed
                $ydtnaAcEndDate = $tnaDateArray[$po_id][52]['actual_finish_date'];// yarn dyed

                $greyStDate     = $tnaDateArray[$po_id][60]['start_date'];// grey fab
                $greyEndDate    = $tnaDateArray[$po_id][60]['end_date'];// grey fab
                $greyAcStDate   = $tnaDateArray[$po_id][60]['actual_start_date'];// grey fab
                $greyAcEndDate  = $tnaDateArray[$po_id][60]['actual_finish_date'];// grey fab

                $aopStDate      = $tnaDateArray[$po_id][63]['start_date'];// grey fab
                $aopEndDate     = $tnaDateArray[$po_id][63]['end_date'];// grey fab
                $aopAcStDate    = $tnaDateArray[$po_id][63]['actual_start_date'];// grey fab
                $aopAcEndDate   = $tnaDateArray[$po_id][63]['actual_finish_date'];// grey fab

                $dyeingStDate   = $tnaDateArray[$po_id][61]['start_date'];// fab dyeing
                $dyeingEndDate  = $tnaDateArray[$po_id][61]['end_date'];// fab dyeing
                $dyeingAcStDate = $tnaDateArray[$po_id][61]['actual_start_date'];// fab dyeing
                $dyeingAcEndDate= $tnaDateArray[$po_id][61]['actual_finish_date'];// fab dyeing

                $sewTrimsStDate = $tnaDateArray[$po_id][70]['start_date'];// trims-sew
                $sewTrimsEndDate= $tnaDateArray[$po_id][70]['end_date'];// trims-sew
                $sewTrimsAcStDate = $tnaDateArray[$po_id][70]['actual_start_date'];// trims-sew
                $sewTrimsAcEndDate= $tnaDateArray[$po_id][70]['actual_finish_date'];// trims-sew

                $finTrimsStDate = $tnaDateArray[$po_id][71]['start_date'];// trims-fin
                $finTrimsEndDate= $tnaDateArray[$po_id][71]['end_date'];// trims-fin
                $finTrimsAcStDate = $tnaDateArray[$po_id][71]['actual_start_date'];// trims-fin
                $finTrimsAcEndDate= $tnaDateArray[$po_id][71]['actual_finish_date'];// trims-fin

                $fabFinStDate   = $tnaDateArray[$po_id][73]['start_date'];// fab finish
                $fabFinEndDate  = $tnaDateArray[$po_id][73]['end_date'];// fab finish
                $fabFinAcStDate = $tnaDateArray[$po_id][73]['actual_start_date'];// fab finish
                $fabFinAcEndDate= $tnaDateArray[$po_id][73]['actual_finish_date'];// fab finish

                $finishStDate   = $tnaDateArray[$po_id][88]['start_date'];// gmt finish
                $finishEndDate  = $tnaDateArray[$po_id][88]['end_date'];// gmt finish
                $finishAcStDate = $tnaDateArray[$po_id][88]['actual_start_date'];// gmt finish
                $finishAcEndDate= $tnaDateArray[$po_id][88]['actual_finish_date'];// gmt finish

                $cuttStDate     = $tnaDateArray[$po_id][84]['start_date'];// cutting
                $cuttEndDate    = $tnaDateArray[$po_id][84]['end_date'];// cutting
                $cuttAcStDate   = $tnaDateArray[$po_id][84]['actual_start_date'];// cutting
                $cuttAcEndDate  = $tnaDateArray[$po_id][84]['actual_finish_date'];// cutting

                $printStDate    = $tnaDateArray[$po_id][267]['start_date'];// fab print
                $printEndDate   = $tnaDateArray[$po_id][267]['end_date'];// fab print
                $printAcStDate  = $tnaDateArray[$po_id][267]['actual_start_date'];// fab print
                $printAcEndDate = $tnaDateArray[$po_id][267]['actual_finish_date'];// fab print

                $embStDate      = $tnaDateArray[$po_id][268]['start_date'];// fab emb
                $embEndDate     = $tnaDateArray[$po_id][268]['end_date'];// fab emb
                $embAcStDate    = $tnaDateArray[$po_id][268]['actual_start_date'];// fab emb
                $embAcEndDate   = $tnaDateArray[$po_id][268]['actual_finish_date'];// fab emb

                $washStDate     = $tnaDateArray[$po_id][90]['start_date'];// fab wash
                $washEndDate    = $tnaDateArray[$po_id][90]['end_date'];// fab wash
                $washAcStDate   = $tnaDateArray[$po_id][90]['actual_start_date'];// fab wash
                $washAcEndDate  = $tnaDateArray[$po_id][90]['actual_finish_date'];// fab wash

                $inputStDate    = $tnaDateArray[$po_id][86]['start_date'];// INPUT
                $inputEndDate   = $tnaDateArray[$po_id][86]['end_date'];// INPUT
                $inputAcStDate  = $tnaDateArray[$po_id][86]['actual_start_date'];// INPUT
                $inputAcEndDate = $tnaDateArray[$po_id][86]['actual_finish_date'];// INPUT

                $exfStDate      = $tnaDateArray[$po_id][110]['start_date'];// Exfact tna date
                $exfEndDate     = $tnaDateArray[$po_id][110]['end_date'];// Exfact tna date
                $exfAcStDate    = $tnaDateArray[$po_id][110]['actual_start_date'];// Exfact tna date
                $exfAcEndDate   = $tnaDateArray[$po_id][110]['actual_finish_date'];// Exfact tna date

                $aopStOfSbStDate      = $tnaDateArray[$po_id][254]['start_date'];// AOP STRICK OFF SUBMISSION
                $aopStOfSbEndDate     = $tnaDateArray[$po_id][254]['end_date'];// AOP STRICK OFF SUBMISSION
                $aopStOfSbAcStDate    = $tnaDateArray[$po_id][254]['actual_start_date'];// AOP STRICK OFF SUBMISSION
                $aopStOfSbAcEndDate   = $tnaDateArray[$po_id][254]['actual_finish_date'];// AOP STRICK OFF SUBMISSION

                $aopStOfApStDate      = $tnaDateArray[$po_id][255]['start_date'];// AOP STRICK OFF APPROVAL
                $aopStOfApEndDate     = $tnaDateArray[$po_id][255]['end_date'];// AOP STRICK OFF APPROVAL
                $aopStOfApAcStDate    = $tnaDateArray[$po_id][255]['actual_start_date'];// AOP STRICK OFF APPROVAL
                $aopStOfApAcEndDate   = $tnaDateArray[$po_id][255]['actual_finish_date'];// AOP STRICK OFF APPROVAL

                $smsSmpleSbStDate      = $tnaDateArray[$po_id][265]['start_date'];// SMS/GSS SAMPLE SUBMISSION
                $smsSmpleSbEndDate     = $tnaDateArray[$po_id][265]['end_date'];// SMS/GSS SAMPLE SUBMISSION
                $smsSmpleSbAcStDate    = $tnaDateArray[$po_id][265]['actual_start_date'];// SMS/GSS SAMPLE SUBMISSION
                $smsSmpleSbAcEndDate   = $tnaDateArray[$po_id][265]['actual_finish_date'];// SMS/GSS SAMPLE SUBMISSION

                $smsSmpleApStDate      = $tnaDateArray[$po_id][266]['start_date'];// SMS/GSS SAMPLE APPROVAL
                $smsSmpleApEndDate     = $tnaDateArray[$po_id][266]['end_date'];// SMS/GSS SAMPLE APPROVAL
                $smsSmpleApAcStDate    = $tnaDateArray[$po_id][266]['actual_start_date'];// SMS/GSS SAMPLE APPROVAL
                $smsSmpleApAcEndDate   = $tnaDateArray[$po_id][266]['actual_finish_date'];// SMS/GSS SAMPLE APPROVAL

                $wareTrialSbStDate      = $tnaDateArray[$po_id][21]['start_date'];// WARE TRAIL SUBMISSION
                $wareTrialSbEndDate     = $tnaDateArray[$po_id][21]['end_date'];// WARE TRAIL SUBMISSION
                $wareTrialSbAcStDate    = $tnaDateArray[$po_id][21]['actual_start_date'];// WARE TRAIL SUBMISSION
                $wareTrialSbAcEndDate   = $tnaDateArray[$po_id][21]['actual_finish_date'];// WARE TRAIL SUBMISSION

                $wareTrialApStDate      = $tnaDateArray[$po_id][22]['start_date'];// WARE TRAIL APPROVAL
                $wareTrialApEndDate     = $tnaDateArray[$po_id][22]['end_date'];// WARE TRAIL APPROVAL
                $wareTrialApAcStDate    = $tnaDateArray[$po_id][22]['actual_start_date'];// WARE TRAIL APPROVAL
                $wareTrialApAcEndDate   = $tnaDateArray[$po_id][22]['actual_finish_date'];// WARE TRAIL APPROVAL

                $bulkFabBrSbStDate      = $tnaDateArray[$po_id][28]['start_date'];// BULK FABRIC SUBMISSION BUYER
                $bulkFabBrSbEndDate     = $tnaDateArray[$po_id][28]['end_date'];// BULK FABRIC SUBMISSION BUYER
                $bulkFabBrSbAcStDate    = $tnaDateArray[$po_id][28]['actual_start_date'];// BULK FABRIC SUBMISSION BUYER
                $bulkFabBrSbAcEndDate   = $tnaDateArray[$po_id][28]['actual_finish_date'];// BULK FABRIC SUBMISSION BUYER

                $bulkFabBrApStDate      = $tnaDateArray[$po_id][29]['start_date'];// BULK FABRIC APPROVAL BUYER
                $bulkFabBrApEndDate     = $tnaDateArray[$po_id][29]['end_date'];// BULK FABRIC APPROVAL BUYER
                $bulkFabBrApAcStDate    = $tnaDateArray[$po_id][29]['actual_start_date'];// BULK FABRIC APPROVAL BUYER
                $bulkFabBrApAcEndDate   = $tnaDateArray[$po_id][29]['actual_finish_date'];// BULK FABRIC APPROVAL BUYER

                $bulkFabLbSbStDate      = $tnaDateArray[$po_id][197]['start_date'];// BULK FABRIC SUBMISSION LAB
                $bulkFabLbSbEndDate     = $tnaDateArray[$po_id][197]['end_date'];// BULK FABRIC SUBMISSION LAB
                $bulkFabLbSbAcStDate    = $tnaDateArray[$po_id][197]['actual_start_date'];// BULK FABRIC SUBMISSION LAB
                $bulkFabLbSbAcEndDate   = $tnaDateArray[$po_id][197]['actual_finish_date'];// BULK FABRIC SUBMISSION LAB

                $bulkFabLbApStDate      = $tnaDateArray[$po_id][198]['start_date'];// BULK FABRIC APPROVAL LAB
                $bulkFabLbApEndDate     = $tnaDateArray[$po_id][198]['end_date'];// BULK FABRIC APPROVAL LAB
                $bulkFabLbApAcStDate    = $tnaDateArray[$po_id][198]['actual_start_date'];// BULK FABRIC APPROVAL LAB
                $bulkFabLbApAcEndDate   = $tnaDateArray[$po_id][198]['actual_finish_date'];// BULK FABRIC APPROVAL LAB

                $knitDwnSbStDate      = $tnaDateArray[$po_id][256]['start_date'];// Knit down SUBMISSION 
                $knitDwnSbEndDate     = $tnaDateArray[$po_id][256]['end_date'];// Knit down SUBMISSION 
                $knitDwnSbAcStDate    = $tnaDateArray[$po_id][256]['actual_start_date'];// Knit down SUBMISSION 
                $knitDwnSbAcEndDate   = $tnaDateArray[$po_id][256]['actual_finish_date'];// Knit down SUBMISSION 

                $knitDwnApStDate      = $tnaDateArray[$po_id][257]['start_date'];// Knit down APPROVAL 
                $knitDwnApEndDate     = $tnaDateArray[$po_id][257]['end_date'];// Knit down APPROVAL 
                $knitDwnApAcStDate    = $tnaDateArray[$po_id][257]['actual_start_date'];// Knit down APPROVAL 
                $knitDwnApAcEndDate   = $tnaDateArray[$po_id][257]['actual_finish_date'];// Knit down APPROVAL 

                $prntStOfSbStDate      = $tnaDateArray[$po_id][126]['start_date'];//print strick off SUBMISSION 
                $prntStOfSbEndDate     = $tnaDateArray[$po_id][126]['end_date'];//print strick off SUBMISSION 
                $prntStOfSbAcStDate    = $tnaDateArray[$po_id][126]['actual_start_date'];//print strick off SUBMISSION 
                $prntStOfSbAcEndDate   = $tnaDateArray[$po_id][126]['actual_finish_date'];//print strick off SUBMISSION 

                $prntStOfApStDate      = $tnaDateArray[$po_id][127]['start_date'];// Knit down APPROVAL 
                $prntStOfApEndDate     = $tnaDateArray[$po_id][127]['end_date'];// Knit down APPROVAL 
                $prntStOfApAcStDate    = $tnaDateArray[$po_id][127]['actual_start_date'];// Knit down APPROVAL 
                $prntStOfApAcEndDate   = $tnaDateArray[$po_id][127]['actual_finish_date'];// Knit down APPROVAL  

                $embStOfSbStDate      = $tnaDateArray[$po_id][128]['start_date'];//print strick off SUBMISSION 
                $embStOfSbEndDate     = $tnaDateArray[$po_id][128]['end_date'];//print strick off SUBMISSION 
                $embStOfSbAcStDate    = $tnaDateArray[$po_id][128]['actual_start_date'];//print strick off SUBMISSION 
                $embStOfSbAcEndDate   = $tnaDateArray[$po_id][128]['actual_finish_date'];//print strick off SUBMISSION 

                $embStOfApStDate      = $tnaDateArray[$po_id][129]['start_date'];// Knit down APPROVAL 
                $embStOfApEndDate     = $tnaDateArray[$po_id][129]['end_date'];// Knit down APPROVAL 
                $embStOfApAcStDate    = $tnaDateArray[$po_id][129]['actual_start_date'];// Knit down APPROVAL 
                $embStOfApAcEndDate   = $tnaDateArray[$po_id][129]['actual_finish_date'];// Knit down APPROVAL 

                $topSmBrSbStDate      = $tnaDateArray[$po_id][26]['start_date'];// Top Sample SUBMISSION buyer 
                $topSmBrSbEndDate     = $tnaDateArray[$po_id][26]['end_date'];// Top Sample SUBMISSION buyer 
                $topSmBrSbAcStDate    = $tnaDateArray[$po_id][26]['actual_start_date'];// Top Sample SUBMISSION buyer 
                $topSmBrSbAcEndDate   = $tnaDateArray[$po_id][26]['actual_finish_date'];// Top Sample SUBMISSION buyer 

                $topSmBrApStDate      = $tnaDateArray[$po_id][27]['start_date'];// Top Sample APPROVAL  buyer
                $topSmBrApEndDate     = $tnaDateArray[$po_id][27]['end_date'];// Top Sample APPROVAL  buyer
                $topSmBrApAcStDate    = $tnaDateArray[$po_id][27]['actual_start_date'];// Top Sample APPROVAL  buyer
                $topSmBrApAcEndDate   = $tnaDateArray[$po_id][27]['actual_finish_date'];// Top Sample APPROVAL  buyer

                $topSmLbSbStDate      = $tnaDateArray[$po_id][26]['start_date'];// Top Sample SUBMISSION Lab 
                $topSmLbSbEndDate     = $tnaDateArray[$po_id][26]['end_date'];// Top Sample SUBMISSION Lab 
                $topSmLbSbAcStDate    = $tnaDateArray[$po_id][26]['actual_start_date'];// Top Sample SUBMISSION Lab 
                $topSmLbSbAcEndDate   = $tnaDateArray[$po_id][26]['actual_finish_date'];// Top Sample SUBMISSION Lab 

                $topSmLbApStDate      = $tnaDateArray[$po_id][27]['start_date'];// Top Sample APPROVAL  Lab
                $topSmLbApEndDate     = $tnaDateArray[$po_id][27]['end_date'];// Top Sample APPROVAL  Lab
                $topSmLbApAcStDate    = $tnaDateArray[$po_id][27]['actual_start_date'];// Top Sample APPROVAL  Lab
                $topSmLbApAcEndDate   = $tnaDateArray[$po_id][27]['actual_finish_date'];// Top Sample APPROVAL  Lab

                $mockUpSbStDate      = $tnaDateArray[$po_id][23]['start_date'];// Mock up SUBMISSION 
                $mockUpSbEndDate     = $tnaDateArray[$po_id][23]['end_date'];// Mock up SUBMISSION 
                $mockUpSbAcStDate    = $tnaDateArray[$po_id][23]['actual_start_date'];// Mock up SUBMISSION 
                $mockUpSbAcEndDate   = $tnaDateArray[$po_id][23]['actual_finish_date'];// Mock up SUBMISSION 

                $mockUpApStDate      = $tnaDateArray[$po_id][23]['start_date'];// Mock up APPROVAL 
                $mockUpApEndDate     = $tnaDateArray[$po_id][23]['end_date'];// Mock up APPROVAL 
                $mockUpApAcStDate    = $tnaDateArray[$po_id][23]['actual_start_date'];// Mock up APPROVAL 
                $mockUpApAcEndDate   = $tnaDateArray[$po_id][23]['actual_finish_date'];// Mock up APPROVAL 

                $trimsCardSbStDate      = $tnaDateArray[$po_id][16]['start_date'];// Trims Card SUBMISSION 
                $trimsCardSbEndDate     = $tnaDateArray[$po_id][16]['end_date'];// Trims Card SUBMISSION 
                $trimsCardSbAcStDate    = $tnaDateArray[$po_id][16]['actual_start_date'];// Trims Card SUBMISSION 
                $trimsCardSbAcEndDate   = $tnaDateArray[$po_id][16]['actual_finish_date'];// Trims Card SUBMISSION 

                $trimsCardApStDate      = $tnaDateArray[$po_id][17]['start_date'];// Trims Card APPROVAL 
                $trimsCardApEndDate     = $tnaDateArray[$po_id][17]['end_date'];// Trims Card APPROVAL 
                $trimsCardApAcStDate    = $tnaDateArray[$po_id][17]['actual_start_date'];// Trims Card APPROVAL 
                $trimsCardApAcEndDate   = $tnaDateArray[$po_id][17]['actual_finish_date'];// Trims Card APPROVAL 

                $bdate          = new DateTime($bookingDate);
                $tdate          = new DateTime($bookEndDate);
                $days           = $tdate->diff($bdate)->format('%a');
                //============================ LABDIP SUBMIT ==========================
                $lbdpSbBackLog = 0;
                $start_date  = new DateTime($lbdpSbStDate);
                $end_date    = new DateTime($lbdpSbEndDate);
                // echo $lbdpSbEndDate."-------";die();
                // print_r($end_date);die();
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $lbdpSbBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $lbdpSbBackLog = $totPoColor - $labDipColorSub;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $lbdpSbBackLog = (($totPoColor/$tnaDaysDif)*$todayDaysDif) - $labDipColorSub;
                    // echo "((".$totPoColor."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$labDipColorSub."<br>";
                }
                $lbdpSbBal         = $totPoColor - $labDipColorSub;
                // echo $lbdpSbBal."<br>";
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['lbdpSbBackLog'] += max(0,$lbdpSbBackLog);
                $client_wise_backlog_array[$client_array[$client_id]]['lbdpSbBackLog'] += max(0,$lbdpSbBackLog);
                //============================ LABDIP APPROVAL ==========================
                $lbdpApBackLog = 0;
                $start_date  = new DateTime($lbdpApStDate);
                $end_date    = new DateTime($lbdpApEndDate);
                // print_r($end_date);die();
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $lbdpApBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $lbdpApBackLog = $totPoColor - $labDipColorApp;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $lbdpApBackLog = (($totPoColor/$tnaDaysDif)*$todayDaysDif) - $labDipColorApp;
                }
                $lbdpApBal         = $totPoColor - $labDipColorApp;
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['lbdpApBackLog'] += max(0,$lbdpApBackLog);
                $client_wise_backlog_array[$client_array[$client_id]]['lbdpApBackLog'] += max(0,$lbdpApBackLog);
                //============================ yarn allocation ==========================
                $yarnReqQty     = $yarnReqQtyArr[$po_id];
                $yarnAlloQty    = $yarnAlloArr[$po_id]['qnty'];
                $yarnAlloDt     = $yarnAlloArr[$po_id]['date'];
                $yarnIssueQty   = $yarnIssueQtyArr[$po_id]['issue'];
                $yarnIssueRtnQty= $yarnIssueQtyArr[$po_id]['rtn'];
                $yarnStock      = $yarnAlloQty - $yarnIssueQty;

                $yarnBackLog    =  $tnaPlanTargetArray[$po_id][48]['prev_plan_qty'] - $yarnAlloArr[$po_id]['prev_qnty'];
                /* $start_date  = new DateTime($yarntnaStDate);
                $end_date    = new DateTime($yarntnaEndDate);
                // print_r($end_date);die();
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $yarnBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $yarnBackLog = ($yarnReqQty+$yarn_excess_qty) - $yarnAlloQty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $yarnBackLog = ((($yarnReqQty+$yarn_excess_qty)/$tnaDaysDif)*$todayDaysDif) - $yarnAlloQty;
                    // echo $yarnBackLog ."= ((".$yarnReqQty."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$yarnAlloQty;die();
                } */
                $yarnBal         = ($yarnReqQty+$yarn_excess_qty) - $yarnAlloQty;
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['yarnBackLog'] += max(0,$yarnBackLog);
                $client_wise_backlog_array[$client_array[$client_id]]['yarnBackLog'] += max(0,$yarnBackLog);
                //========================= yarn dayed ==========================
                $yarnDyedReqQty  = array_sum($conversion_costing_arr[$po_id][30]);
                $ydRcv      = $yarnDyedArr[$po_id]['qty'];
                $ydLstRcv   = $yarnDyedArr[$po_id]['lstqty'];
                $ydIssueQty = $yarnDyeIssueQtyArr[$po_id]['issue'];
                $ydIssueRtnQty = $yarnDyeIssueQtyArr[$po_id]['rtn'];
                $ydSndBal = $yarnDyedReqQty - $ydIssueQty;
                $ydBackLog  = $tnaPlanTargetArray[$po_id][52]['prev_plan_qty'] - $yarn_dyed_prev_rcv_qty; 
                /* $ydBackLog  = 0;
                $start_date = new DateTime($ydtnaStDate);
                $end_date   = new DateTime($ydtnaEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $ydBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $ydBackLog = $yarnDyedReqQty - $yarn_dyed_qty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $ydBackLog = (($yarnDyedReqQty/$tnaDaysDif)*$todayDaysDif) - $yarn_dyed_qty;
                } */
                $ydBal         = $yarnDyedReqQty - $yarn_dyed_qty;
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['ydBackLog'] += max(0,$ydBackLog);
                $client_wise_backlog_array[$client_array[$client_id]]['ydBackLog'] += max(0,$ydBackLog);
                //============================= grey req. =========================
                $fabGreyReg = array_sum($fabric_costing_arr['knit']['grey'][$po_id]);
                $grey_trans_in = $grey_fab_transfer_data[$po_id]['in'];
                $grey_trans_out = $grey_fab_transfer_data[$po_id]['out'];
                $greyRcv    = $greyProdArr[$po_id]['qty'];
                $greyRcvPrev    = $greyProdArr[$po_id]['prev_qnty'];
                $greyLstRcv = $greyProdArr[$po_id]['lstqty'];
                $progQty    = $progQtyArray[$po_id];
                $progBalQty = ($fabGreyReg+$grey_fab_excess_qty) - $progQty;
                $yrnSndtoFact= $yarnIssueQty - $yarnIssueRtnQty;
                $yrnSndBal  = $progQty - $yarnIssueQty;
                $greyBackLog = $tnaPlanTargetArray[$po_id][60]['prev_plan_qty'] - ($greyRcvPrev + $grey_trans_in);
                /* $start_date  = new DateTime($greyStDate);
                $end_date    = new DateTime($greyEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $greyBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $greyBackLog = ($fabGreyReg+$grey_fab_excess_qty + $grey_trans_out) - ($greyRcv + $grey_trans_in);
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $greyBackLog = ((($fabGreyReg+$grey_fab_excess_qty + $grey_trans_out)/$tnaDaysDif)*$todayDaysDif) - ($greyRcv + $grey_trans_in);
                } */
                $greyBal         = ($fabGreyReg+$grey_fab_excess_qty + $grey_trans_out) - ($greyRcv + $grey_trans_in);
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['greyBackLog'] += max(0,$greyBackLog);
                $client_wise_backlog_array[$client_array[$client_id]]['greyBackLog'] += max(0,$greyBackLog);
                //============================= FABRIC DYEING. =========================
                // $fabDyeingReq   = array_sum($conversion_costing_arr[$po_id][31]);
                $fabDyeingReq   = $fabGreyReg+$grey_fab_excess_qty;
                $dyeingRcv      = $dyeingProdArr[$po_id]['in']+$dyeingProdArr[$po_id]['out'];
                $dyeingRcvPrev      = $dyeingProdArr[$po_id]['prev_in']+$dyeingProdArr[$po_id]['prev_out'];
                $lstDyeingRcv   = $dyeingProdArr[$po_id]['lstqty'];
                $batchQty       = $batchQtyArr[$po_id]['qty']+$dyeingProdArr[$po_id]['out'];
                $batchBal       = $fabGreyReg - $batchQty;
                $redyToBatch    = $greyRcv - $batchQty;
                $dyeingBackLog  = $tnaPlanTargetArray[$po_id][61]['prev_plan_qty'] - $dyeingRcvPrev;
                /* $dyeingBackLog  = 0;
                $start_date  = new DateTime($dyeingStDate);
                $end_date    = new DateTime($dyeingEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $dyeingBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $dyeingBackLog = $fabDyeingReq - $dyeingRcv;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $dyeingBackLog = (($fabDyeingReq/$tnaDaysDif)*$todayDaysDif) - $dyeingRcv;
                } */
                $dyeingBal         = $fabDyeingReq - $dyeingRcv;
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['dyeingBackLog'] += max(0,$dyeingBackLog);
                $client_wise_backlog_array[$client_array[$client_id]]['dyeingBackLog'] += max(0,$dyeingBackLog);
                //============================= BOOKING =========================
                $fabfinishPurReg  = array_sum($fabric_purchase_costing_arr['knit']['finish'][$po_id]);
                $fabfinishReg  = array_sum($fabric_costing_arr['knit']['finish'][$po_id]);

                $fabfinishPurRegKg  = $fabric_purchase_costing_arr['knit']['finish'][$po_id][12]; //12=KG , 23=Mtr, 27=Yds
                $fabfinishRegKg  = $fabric_costing_arr['knit']['finish'][$po_id][12];

                $fabfinishPurRegYds  = $fabric_purchase_costing_arr['knit']['finish'][$po_id][23]+$fabric_purchase_costing_arr['knit']['finish'][$po_id][27];
                $fabfinishRegKgYds  = $fabric_costing_arr['knit']['finish'][$po_id][23]+$fabric_costing_arr['knit']['finish'][$po_id][27];

                $tot_finfab_req_qty = $fabfinishReg + $fabfinishPurReg;
                $tot_finfab_req_qty_kg = $fabfinishRegKg + $fabfinishPurRegKg;
                $tot_finfab_req_qty_yds = $fabfinishRegKgYds + $fabfinishPurRegYds;
                $bookingBackLog    = 0;
                $bookingBackLogKg    = 0;
                $bookingBackLogYds    = 0;
                $bookingBal        = 0;
                $start_date  = new DateTime($bookStDate);
                $end_date    = new DateTime($bookEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $bookingBackLog = 0;
                    $bookingBackLogKg = 0;
                    $bookingBackLogYds = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $bookingBackLog = $tot_finfab_req_qty - $bookingQty;
                    $bookingBackLogKg = $tot_finfab_req_qty_kg - $bookingQtyKg;
                    $bookingBackLogYds = $tot_finfab_req_qty_yds - $bookingQtyYds;
                    // echo $bookingBackLog ."=". $fabfinishReg ."-". $bookingQty."<br>"; 
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $bookingBackLog = (($tot_finfab_req_qty/$tnaDaysDif)*$todayDaysDif) - $bookingQty;
                    $bookingBackLogKg = (($tot_finfab_req_qty_kg/$tnaDaysDif)*$todayDaysDif) - $bookingQtyKg;
                    $bookingBackLogYds = (($tot_finfab_req_qty_yds/$tnaDaysDif)*$todayDaysDif) - $bookingQtyYds;

                }
                // echo $bookingBackLogYds;
                $bookingBal         = $tot_finfab_req_qty - $bookingQty;
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['bookingBackLog'] += max(0,$bookingBackLog);
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['bookingBackLogKg'] += max(0,$bookingBackLogKg);
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['bookingBackLogYds'] += max(0,$bookingBackLogYds);

                $client_wise_backlog_array[$client_array[$client_id]]['bookingBackLog'] += max(0,$bookingBackLog);
                $client_wise_backlog_array[$client_array[$client_id]]['bookingBackLogKg'] += max(0,$bookingBackLogKg);
                $client_wise_backlog_array[$client_array[$client_id]]['bookingBackLogYds'] += max(0,$bookingBackLogYds);
                //============================= ALL OVER PRINT =========================
                // $aopReq     = array_sum($conversion_costing_arr[$po_id][35]);
                // $aop_Req     = array_sum($fabric_po_color_type_wise_arr['knit']['finish'][$po_id][5]);
                $aop_Req     = array_sum($fabric_costing_aop_arr['knit']['finish'][$po_id][5][1]);
                $aopReq     = $aop_Req+$color_type_wise_booking_qty_array[$po_id][5];
                $aopRcv     = $aopProdArr[$po_id]['qty'];
                $aopRcvPrev = $aopProdArr[$po_id]['prev_qty'];
                $aopLstRcv  = $aopProdArr[$po_id]['lstqty'];
                $aopIssueQty= $aopProdArr[$po_id]['issueqty'];
                $aopFbSndBal= $aopReq - $aopIssueQty;
                $aopBackLog  = $tnaPlanTargetArray[$po_id][63]['prev_plan_qty'] - $aopRcvPrev;
                /* $aopBackLog    = 0;
                $start_date  = new DateTime($aopStDate);
                $end_date    = new DateTime($aopEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $aopBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $aopBackLog = $aopReq - $aopRcv;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $aopBackLog = (($aopReq/$tnaDaysDif)*$todayDaysDif) - $aopRcv;
                } */
                $aopBal         = $aopReq - $aopRcv;
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['aopBackLog'] += max(0,$aopBackLog);
                $client_wise_backlog_array[$client_array[$client_id]]['aopBackLog'] += max(0,$aopBackLog);

                //============================= FINISH FAB. PROD =========================
                //$fabfinishPurReg  = array_sum($fabric_purchase_costing_arr['knit']['finish'][$po_id]);
                $finishRcv  = $finFabProdArr[$po_id]['qty'];
                $finishLstRcv  = $finFabProdArr[$po_id]['lstqty'];
                $finFabTrnsIn  = $finFabTrnsArr[$po_id][5]['qty'];
                $finFabTrnsOut  = $finFabTrnsArr[$po_id][6]['qty'];
                
                $finFab_purchase_qty = $finFabPurchaseArr[$po_id]['qty'];
                $gmtStrRcv2      = $finFabStkArray2[$po_id]['gmt_rcv'];
                $gmtStrRcvRtn2   = $finFabStkArray2[$po_id]['gmt_rcv_rtn'];
                $gmtStrTrnsIn2   = $finFabStkArray2[$po_id]['gmt_rcv_trns'];

                $gmtStrRcv2Prev      = $finFabStkArray2[$po_id]['prev_gmt_rcv'];
                $finFab_purchase_qty_prev = $finFabPurchaseArr[$po_id]['prev_qty'];
                $gmtStrTrnsIn2Prev   = $finFabStkArray2[$po_id]['prev_gmt_rcv_trns'];


                $fin_rcv_qnty2   = $gmtStrTrnsIn2+$gmtStrRcv2+$finFab_purchase_qty;

                $fin_rcv_qnty2Kg      = $finFabProdWithUomArray[$po_id][12]['qty'];
                $fin_rcv_qnty2Yds      = $finFabProdWithUomArray[$po_id][23]['qty']+$finFabProdWithUomArray[$po_id][27]['qty'];

                $fin_rcv_qnty2KgPrev      = $finFabProdWithUomArray[$po_id][12]['prev_qty'];
                $fin_rcv_qnty2YdsPrev      = $finFabProdWithUomArray[$po_id][23]['prev_qty']+$finFabProdWithUomArray[$po_id][27]['prev_qty'];

                
                $finishBackLogKg  = $ffTnaPlanTargetArray[$po_id][73][12]['prev_plan_qty'] - $fin_rcv_qnty2KgPrev;
                $finishBackLogYds  = ($ffTnaPlanTargetArray[$po_id][73][23]['prev_plan_qty']+$ffTnaPlanTargetArray[$po_id][73][27]['prev_plan_qty']) - $fin_rcv_qnty2YdsPrev;       

                
                $finishBackLog  = $ffTnaPlanTargetArray[$po_id][73][1]['prev_plan_qty'] - ($gmtStrRcv2Prev+$gmtStrTrnsIn2Prev);
                $finishBackLogPur  = $ffTnaPlanTargetArray[$po_id][73][2]['prev_plan_qty'] - $finFab_purchase_qty_prev;
                // echo $ffTnaPlanTargetArray[$po_id][73][2]['prev_plan_qty'] ."-". $finFab_purchase_qty_prev."<br>";

                
                $finishFabBal    = ($tot_finfab_req_qty+$fin_fab_excess_qty) - $fin_rcv_qnty2;
                //$finishFabBal         = $fabfinishReg - $finishRcv;
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['finishBackLog'] += max(0,$finishBackLog);
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['finishBackLogPur'] += max(0,$finishBackLogPur);
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['finishBackLogKg'] += max(0,$finishBackLogKg);
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['finishBackLogYds'] += max(0,$finishBackLogYds);

                $client_wise_backlog_array[$client_array[$client_id]]['finishBackLog'] += max(0,$finishBackLog);
                $client_wise_backlog_array[$client_array[$client_id]]['finishBackLogPur'] += max(0,$finishBackLogPur);
                $client_wise_backlog_array[$client_array[$client_id]]['finishBackLogKg'] += max(0,$finishBackLogKg);
                $client_wise_backlog_array[$client_array[$client_id]]['finishBackLogYds'] += max(0,$finishBackLogYds);

                //============================= ISSUE TO CUT =========================
                $issueToCut= $issueProdArr[$po_id]['qty'];
                $layQty    = $cutAndLayArr[$po_id]['qty'];
                $qcQty     = $CutQCArr[$po_id]['qty'];
                $qcRejQty  = $CutQCArr[$po_id]['rejqty'];
                $qcRplsQty = $CutQCArr[$po_id]['rplsqty'];
                $lstQcQty  = $CutQCArr[$po_id]['lst_rpls_qty'];
                $cutBal    = $val['qty'] -  $qcQty;

                $dyeStrIss      = $finFabStkArray[$po_id]['dye_issue'];
                $dyeStrIssRtn   = $finFabStkArray[$po_id]['dye_issue_rtn'];
                $dyeStrTrnsOut  = $finFabStkArray[$po_id]['dye_issue_trns'];
                $dyeStrRcv      = $finFabStkArray[$po_id]['dye_rcv'];
                $dyeStrRcvRtn   = $finFabStkArray[$po_id]['dye_rcv_rtn'];
                $dyeStrTrnsIn   = $finFabStkArray[$po_id]['dye_rcv_trns'];

                $dye_total_receive=$dyeStrTrnsIn+$dyeStrRcv+$dyeStrIssRtn;
                $dye_total_issue=$dyeStrTrnsOut+$dyeStrIss+$dyeStrRcvRtn;
                $dyeStock = $dye_total_receive - $dye_total_issue;

                $gmtStrIss      = $finFabStkArray[$po_id]['gmt_issue'];
                $gmtStrIssRtn   = $finFabStkArray[$po_id]['gmt_issue_rtn'];
                $gmtStrTrnsOut  = $finFabStkArray[$po_id]['gmt_issue_trns'];
                $gmtStrRcv      = $finFabStkArray[$po_id]['gmt_rcv'];
                $gmtStrRcvRtn   = $finFabStkArray[$po_id]['gmt_rcv_rtn'];
                $gmtStrTrnsIn   = $finFabStkArray[$po_id]['gmt_rcv_trns'];

                $gmt_total_receive=$gmtStrTrnsIn+$gmtStrRcv+$gmtStrIssRtn;
                $gmt_total_issue=$gmtStrTrnsOut+$gmtStrIss+$gmtStrRcvRtn;
                $gmtStock = $gmt_total_receive - $gmt_total_issue;
                
                

                $qcBackLog  = $tnaPlanTargetArray[$po_id][84]['prev_plan_qty'] - $prodArr[$po_id]['prev_cut_qty'];
                /* $qcBackLog = 0;
                $start_date  = new DateTime($cuttStDate);
                $end_date    = new DateTime($cuttEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $qcBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $qcBackLog = $val['qty'] - $qcQty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $qcBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $qcQty;
                    //echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$qcQty."<br>";
                } */
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['qcBackLog'] += max(0,$qcBackLog);
                $client_wise_backlog_array[$client_array[$client_id]]['qcBackLog'] += max(0,$qcBackLog);
                //============================= PRINTING DATA =========================
                $printReq       = $emblishment_costing_arr[$po_id][1]*$costingPer;
                $printQty       = $prodArr[$po_id]['print_qty'];
                $printIssQty    = $prodArr[$po_id]['print_iss_qty'];
                $printRejQty    = $prodArr[$po_id]['print_rej_qty'];
                $lstPrntQty     = $prodArr[$po_id]['lst_prnt_qty'];
                $prntSndBal     = $printReq - $printIssQty;
                if($emblishment_costing_arr[$po_id][1]>0)
                {
                    $printBal       = $printReq - $printQty;
                }
                else
                {
                    $printBal = 0;
                }
                $printBackLog  = $tnaPlanTargetArray[$po_id][267]['prev_plan_qty'] - $prodArr[$po_id]['prev_print_qty'];
                /* $printBackLog   = 0;
                $start_date     = new DateTime($printStDate);
                $end_date       = new DateTime($printEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $printBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $printBackLog = $printReq - $printQty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $printBackLog = (($printReq/$tnaDaysDif)*$todayDaysDif) - $printQty;
                } */
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['printBackLog'] += max(0,$printBackLog);
                $client_wise_backlog_array[$client_array[$client_id]]['printBackLog'] += max(0,$printBackLog);
                //============================= EMBROIDERY  =========================
                $embReq  = $emblishment_costing_arr[$po_id][2]*$costingPer;
                $embQty  = $prodArr[$po_id]['emb_qty'];
                $embIssueQty = $prodArr[$po_id]['emb_issue_qty'];
                $embSndBal = $embReq - $embIssueQty;
                $embRejQty  = $prodArr[$po_id]['emb_rej_qty'];
                $lstEmbQty  = $prodArr[$po_id]['lst_emb_qty'];
                if($emblishment_costing_arr[$po_id][1]>0)
                {
                    $embBal  = $embReq - $embQty;
                }
                else
                {
                    $embBal = 0;
                }
                
                $embBackLog  = $tnaPlanTargetArray[$po_id][268]['prev_plan_qty'] - $prodArr[$po_id]['prev_emb_qty'];
                /* $embBackLog = 0;
                $start_date  = new DateTime($embStDate);
                $end_date    = new DateTime($embEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $embBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $embBackLog = $embReq - $embQty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $embBackLog = (($embReq/$tnaDaysDif)*$todayDaysDif) - $embQty;
                } */
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['embBackLog'] += max(0,$embBackLog);
                $client_wise_backlog_array[$client_array[$client_id]]['embBackLog'] += max(0,$embBackLog);
                //============================= WASH  =========================
                $washReq     = $emblishment_costing_arr_name[$po_id][3]*$costingPer;
                $washQty     = $prodArr[$po_id]['wash_qty'];
                $lstWashQty  = $prodArr[$po_id]['lst_wash_qty'];
                $washIssueQty= $prodArr[$po_id]['wash_issue_qty'];
                $washRejQty  = $prodArr[$po_id]['wash_rej_qty'];
                $sendBal     = $washReq - $washIssueQty;

                $washBal     = $washReq > 0 ? $washReq - $washQty : 0;
                $washBackLog  = $tnaPlanTargetArray[$po_id][90]['prev_plan_qty'] - $prodArr[$po_id]['prev_wash_qty'];
                /* $washBackLog = 0;
                $start_date  = new DateTime($washStDate);
                $end_date    = new DateTime($washEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $washBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $washBackLog = $washReq - $washQty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $washBackLog = (($washReq/$tnaDaysDif)*$todayDaysDif) - $washQty;
                } */
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['washBackLog'] += max(0,$washBackLog);
                $client_wise_backlog_array[$client_array[$client_id]]['washBackLog'] += max(0,$washBackLog);
                //============================= SEW TRIMS =========================
                $sewTrimsReq    = $trims_costing_arr[$po_id][1];
                $sewTrimsQty    = $accArr[$po_id][1]['qty'];
                $sewTrimsPrsnt  = ($sewTrimsQty/$sewTrimsReq)*100;
                $sewTrmBacklog  = 0;
                $start_date     = new DateTime($sewTrimsStDate);
                $end_date       = new DateTime($sewTrimsEndDate);
                $sewTrmCurBk = 0;
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $sewTrmBacklog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $sewTrmBacklog = 100 - $sewTrimsPrsnt;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $perDayAllo = $sewTrimsReq/$tnaDaysDif;
                    $reqAllo = $perDayAllo*$todayDaysDif;
                    $sewTrmCurBk = $reqAllo - $sewTrimsQty;

                    $sewTrmBacklog = ((100/$tnaDaysDif)*$todayDaysDif) - $sewTrimsPrsnt;
                }
                // echo $curBk."<br>";
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['sewTrmBacklog'] += max(0,$sewTrmBacklog);
                $client_wise_backlog_array[$client_array[$client_id]]['sewTrmBacklog'] += max(0,$sewTrmBacklog);

                if($sewTrmCurBk>0)
                {
                    $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['sewTrmCurBk'] += $sewTrmCurBk;
                    $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['sewTrimsReq'] += $sewTrimsReq;

                    $client_wise_backlog_array[$client_array[$client_id]]['sewTrmCurBk'] += $sewTrmCurBk;
                    $client_wise_backlog_array[$client_array[$client_id]]['sewTrimsReq'] += $sewTrimsReq;
                }
                //================================= FIN TRIMS =======================
                $finTrimsReq    = $trims_costing_arr[$po_id][2];
                $finTrimsQty    = $accArr[$po_id][2]['qty'];
                $finTrimsPrsnt  = ($finTrimsQty/$finTrimsReq)*100;
                $finTrmBacklog = 0;
                $start_date  = new DateTime($finTrimsStDate);
                $end_date    = new DateTime($finTrimsEndDate);
                $finTrmCurBk = 0;
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $finTrmBacklog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $finTrmBacklog = 100 - $finTrimsPrsnt;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $perDayAllo = $finTrimsReq/$tnaDaysDif;
                    $reqAllo = $perDayAllo*$todayDaysDif;
                    $finTrmCurBk = $reqAllo - $finTrimsQty;

                    $finTrmBacklog = ((100/$tnaDaysDif)*$todayDaysDif) - $finTrimsPrsnt;
                }
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['finTrmBacklog'] += max(0,$finTrmBacklog);
                $client_wise_backlog_array[$client_array[$client_id]]['finTrmBacklog'] += max(0,$finTrmBacklog);
                // echo $finTrmCurBk."<br>";
                if($finTrmCurBk>0)
                {
                    $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['finTrmCurBk'] += $finTrmCurBk;
                    $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['finTrimsReq'] += $finTrimsReq;

                    $client_wise_backlog_array[$client_array[$client_id]]['finTrmCurBk'] += $finTrmCurBk;
                    $client_wise_backlog_array[$client_array[$client_id]]['finTrimsReq'] += $finTrimsReq;
                }
                // ============================= Accessories=========================================
                $tot_item = $trimsItemCountBudgetWise[$po_id];
                $tot_booking_item = $trimsBookingArr[$po_id];
                $accBookingPrsnt = ($tot_booking_item/$tot_item)*100;
                $accBacklog = 0;
                $start_date  = new DateTime($accBkStDate);
                $end_date    = new DateTime($accBkEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $accBacklog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $accBacklog = 100 - $accBookingPrsnt;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $accBacklog = ((100/$tnaDaysDif)*$todayDaysDif) - $accBookingPrsnt;
                }
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['accBacklog'] += max(0,$accBacklog);
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['accBookingPrsnt'] += $accBookingPrsnt;

                $client_wise_backlog_array[$client_array[$client_id]]['accBacklog'] += max(0,$accBacklog);
                $client_wise_backlog_array[$client_array[$client_id]]['accBookingPrsnt'] += $accBookingPrsnt;

                if($accBacklog>0)
                {
                    $buyerWiseAccPoArray[$buyer_id][$po_id]=$po_id;
                    $clientWiseAccPoArray[$client_id][$po_id]=$po_id;
                }
                // echo "<pre>";print_r($buyerWiseAccPoArray);
                //=============================== PRODUCTION AND EX-FACTORY ===========================

                $inputQty       = $prodArr[$po_id]['input_qty'];
                $input_bal      = $qcQty - $inputQty;
                $plan_input_bal = $qcQty - $prodArr[$po_id]['input_qty']-$printRejQty - $embRejQty;
                $outputQty      = $prodArr[$po_id]['out_qty'];
                $lstOutputQty   = $prodArr[$po_id]['lst_out_qty'];
                $rejectQty      = $prodArr[$po_id]['reject_qty'];
                $alterQty       = $prodArr[$po_id]['alter_qty'];
                $spotQty        = $prodArr[$po_id]['spot_qty'];
                $replaceQty     = $prodArr[$po_id]['replace_qty'];
                $rejectQty      = $rejectQty+$alterQty+$spotQty-$replaceQty;
                $okOutQty       = $outputQty;
                $totSewQty      = $okOutQty - $replaceQty + $rejectQty;
                $sewingWIP      = $inputQty - $totSewQty;
                $sewingBAL      = $val['qty'] - $okOutQty;
                $finishQty      = $prodArr[$po_id]['finish_qty'];
                $lstFinishQty   = $prodArr[$po_id]['lst_finish_qty'];
                $finRejQty      = $prodArr[$po_id]['fin_rej_qty'];
                $finishBal      = $val['qty'] - $finishQty;
                $finishWIP      = $outputQty - $finishQty - $finRejQty;
                $exfactoryQty   = $exfArr[$po_id]['qty'];
                $exfactoryLstQty= $exfArr[$po_id]['lqty'];
                $exfactoryWIP   = $finishQty - $exfactoryQty;
                $exBal          = $val['qty'] - $exfArr[$po_id]['qty'];
                $exDateArray    = array_filter(explode(",", $exfArr[$po_id]['exdate']));
                // print_r($exDateArray);
                // echo max($exDateArray);
                // echo "<br>";
                // echo min($exDateArray);

                $sewFinBackLog  = $tnaPlanTargetArray[$po_id][86]['prev_plan_qty'] - $prodArr[$po_id]['prev_out_qty'];
                /* $sewFinBackLog = 0;
                $start_date  = new DateTime($inputStDate);
                $end_date    = new DateTime($inputEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $sewFinBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $sewFinBackLog = $val['qty'] - $okOutQty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $sewFinBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $okOutQty;
                    // echo "((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$okOutQty."<br>";
                } */
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['sewFinBackLog'] += max(0,$sewFinBackLog);
                $client_wise_backlog_array[$client_array[$client_id]]['sewFinBackLog'] += max(0,$sewFinBackLog);
               
                //============================= GMTS FINISH  =========================
                
                $gmtFinBal     = $val['qty'] - $finishQty;
                $gmtFinBackLog  = $tnaPlanTargetArray[$po_id][88]['prev_plan_qty'] - $prodArr[$po_id]['prev_finish_qty'];
                /* $gmtFinBackLog = 0;
                $start_date  = new DateTime($finishStDate);
                $end_date    = new DateTime($finishEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $gmtFinBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $gmtFinBackLog = $val['qty'] - $finishQty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $gmtFinBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $finishQty;
                    //echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$finishQty."<br>";
                } */
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['gmtFinBackLog'] += max(0,$gmtFinBackLog);
                $client_wise_backlog_array[$client_array[$client_id]]['gmtFinBackLog'] += max(0,$gmtFinBackLog);
                //============================= SHIPING BACKLOG ===================
                $shiping_backlog = 0;
                $fob_backlog = 0;
                // $orig_ship_date = new DateTime($val['orig_ship_date']);
                // $shiping_backlog = (strtotime($toDay->format('Y-m-d')) <= strtotime($val['orig_ship_date'])) ? 0 : $val['qty'] - $exfArr[$po_id]['qty'];

                $accPoIdsArr = array_unique(array_filter(explode(",", $accPoIDArray[$po_id])));
                // echo "<pre>";print_r($accPoIdsArr);die();
                $acc_backlog = 0;
                /*foreach ($accPoIdsArr as $acc_po_key => $acc_po_val) 
                {
                    if(strtotime($toDay->format('Y-m-d')) > strtotime($accPoArray[$po_id][$acc_po_val]['acc_ship_date']))
                    {
                        $acc_backlog += $accPoArray[$po_id][$acc_po_val]['acc_po_qty'];
                    }

                }*/

                foreach ($accPoArray[$po_id] as $aac_po => $acc_po_value) 
                {
                    foreach ($acc_po_value as $aac_date => $acc_date_value) 
                    {
                        if(strtotime($toDay->format('Y-m-d')) > strtotime($aac_date))
                        {
                            $acc_backlog += $acc_date_value['acc_po_qty'];
                            // echo $jobNo."==".$acc_date_value['acc_po_qty']."<br>";
                        }
                    }
                }

                $shiping_backlog = $acc_backlog - $exfArr[$po_id]['qty'];
                $fob_backlog     = $shiping_backlog*$val['unit_price'];
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['shiping_backlog'] += max(0,$shiping_backlog);            
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['fob_backlog'] += max(0,$fob_backlog);
                $buyer_wise_backlog_array[$buyer_arr[$buyer_id]]['buyer_id'] = $buyer_id;

                $client_wise_backlog_array[$client_array[$client_id]]['shiping_backlog'] += max(0,$shiping_backlog);            
                $client_wise_backlog_array[$client_array[$client_id]]['fob_backlog'] += max(0,$fob_backlog);
                $client_wise_backlog_array[$client_array[$client_id]]['buyer_id'] = $buyer_id;

                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                ?>
                <tr class="GridViewScrollItem" bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                    
                </tr>
                <?
                $i++;
            }
        }
        // echo "<pre>";print_r($buyer_wise_backlog_array);die();
        ob_start(); 
        ?>
        <main class="main">
            <div class="tableContainer" style="width: 100%;text-align: left;">
                <h2 style="font-size: 20px;text-align: center;">Backlog - SBU/Client Wise <span style="color: red;font-size: 18px;font-weight: bold;"> <?=($client) ? ": ".$client_array[$client] : ": All"; ?></span></h2>
                <table cellspacing="0" style="width: 100%; border-collapse: collapse;" class="rpt_table" cellpadding="0" border="1">
                    <thead>
                        <tr>
                            <th width="4%">SBU/Client</th>
                            <th width="4%">LD Sub</th>
                            <th width="4%">LD Aprv</th>
                            <th width="4%">Acc Booking</th>
                            <!-- <th width="4%">Fab Booking</th> -->
                            <th width="4%">Fab Booking Kg</th>
                            <th width="4%">Fab Booking Y/M</th>
                            <th width="4%">Yarn</th>
                            <th width="4%">YD</th>
                            <th width="4%">Gray</th>
                            <th width="4%">Dyeing</th>
                            <th width="4%">AOP</th>
                            <!-- <th width="4%">F. Fabric</th> -->
                            <th width="4%">F. Fabric Prod.</th>
                            <th width="4%">F. Fabric Purc</th>
                            <th width="4%">Cutting</th>
                            <th width="4%">Printing</th>
                            <th width="4%">Embroidery</th>
                            <th width="4%">S. Acc Rcv</th>
                            <th width="4%">F. Acc Rcv</th>
                            <th width="4%">Sewing</th>
                            <th width="4%">Washing</th>
                            <th width="4%">Finishing</th>
                            <th width="4%">Shipment</th>                                
                            <th width="4%">FOB Backlog</th>                                
                        </tr>
                    </thead>
                    <tbody>
                    <?
                    $i=1;
                    $lbdpSbBackLog      = 0;
                    $lbdpApBackLog      = 0;
                    $bookingBackLog     = 0;
                    $bookingBackLogKg   = 0;
                    $bookingBackLogYds  = 0;
                    $yarnBackLog        = 0;
                    $ydBackLog          = 0;
                    $greyBackLog        = 0;
                    $dyeingBackLog      = 0;
                    $aopBackLog         = 0;
                    $finishBackLog      = 0;
                    $finishBackLogKg      = 0;
                    $finishBackLogYds      = 0;
                    $qcBackLog          = 0;
                    $printBackLog       = 0;
                    $embBackLog         = 0;
                    $sewTrmBacklog      = 0;
                    $finTrmBacklog      = 0;
                    $sewingBackLog      = 0;
                    $washBackLog        = 0;
                    $finishingBackLog   = 0;
                    $shiping_backlog    = 0;
                    $fob_backlog        = 0;
                    ksort($client_wise_backlog_array);
                    foreach ($client_wise_backlog_array as $client_Name => $row) 
                    {
                        $buyer_id = $row['buyer_id'];
                        $buyer_tot_po = count($buyerWiseAccPoArray[$buyer_id]);
                        $accBacklog = $row['accBacklog']/$buyer_tot_po;

                        $sewTrmBacklog = ($row['sewTrmCurBk']/$row['sewTrimsReq'])*100;
                        $finTrmBacklog = ($row['finTrmCurBk']/$row['finTrimsReq'])*100;

                        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                        if($row['lbdpSbBackLog']>0 || $row['lbdpApBackLog']>0 || $row['bookingBackLog']>0 || $row['yarnBackLog']>0 || $row['ydBackLog']>0 || $row['greyBackLog']>0 || $row['dyeingBackLog']>0 || $row['aopBackLog']>0 || $row['finishBackLog']>0 || $row['finishBackLogPur']>0 || $row['qcBackLog']>0 || $row['printBackLog']>0 || $row['embBackLog']>0 || $sewTrmBacklog>0 || $finTrmBacklog>0 || $row['sewFinBackLog']>0 || $row['washBackLog']>0 || $row['gmtFinBackLog']>0 || $row['shiping_backlog']>0 || $row['fob_backlog']>0)
                        {
                            ?>
                            <tr bgcolor="<? echo $bgcolor; ?>" onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
                                <td><p><?=$client_Name;?></p></td>
                                <td align="right"><?=  fn_number_format($row['lbdpSbBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['lbdpApBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($accBacklog,2); ?>%</td>
                                <!-- <td align="right"><?=  fn_number_format($row['bookingBackLog'],0); ?></td> -->
                                <td align="right"><?=  fn_number_format($row['bookingBackLogKg'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['bookingBackLogYds'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['yarnBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['ydBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['greyBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['dyeingBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['aopBackLog'],0); ?></td>
                                <!-- <td align="right"><?=  fn_number_format($row['finishBackLog'],0); ?></td> -->
                                <td align="right"><?=  fn_number_format($row['finishBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['finishBackLogPur'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['qcBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['printBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['embBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($sewTrmBacklog,2); ?>%</td>
                                <td align="right"><?=  fn_number_format($finTrmBacklog,2); ?>%</td>
                                <td align="right"><?=  fn_number_format($row['sewFinBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['washBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['gmtFinBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['shiping_backlog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['fob_backlog'],0); ?></td>
                            </tr>
                            <?
                            $i++;
                            $lbdpSbBackLog      += $row['lbdpSbBackLog'];
                            $lbdpApBackLog      += $row['lbdpApBackLog'];
                            $bookingBackLog     += $row['bookingBackLog'];
                            $bookingBackLogKg   += $row['bookingBackLogKg'];
                            $bookingBackLogYds  += $row['bookingBackLogYds'];
                            $yarnBackLog        += $row['yarnBackLog'];
                            $ydBackLog          += $row['ydBackLog'];
                            $greyBackLog        += $row['greyBackLog'];
                            $dyeingBackLog      += $row['dyeingBackLog'];
                            $aopBackLog         += $row['aopBackLog'];
                            $finishBackLog      += $row['finishBackLog'];
                            $finishBackLogKg    += $row['finishBackLog'];
                            $finishBackLogYds   += $row['finishBackLogPur'];
                            $qcBackLog          += $row['qcBackLog'];
                            $printBackLog       += $row['printBackLog'];
                            $embBackLog         += $row['embBackLog'];
                            $sewTrmBacklog      += $row['sewTrmBacklog'];
                            $finTrmBacklog      += $row['finTrmBacklog'];

                            $sewingBackLog      += $row['sewFinBackLog'];
                            $washBackLog        += $row['washBackLog'];
                            $finishingBackLog   += $row['gmtFinBackLog'];
                            $shiping_backlog    += $row['shiping_backlog'];
                            $fob_backlog        += $row['fob_backlog'];
                        }
                    }
                    ?>
                    </tbody>
                    <tfoot>
                        <tr>
                            <th>Total</th>
                            <th><? echo fn_number_format($lbdpSbBackLog,0);?></th>
                            <th><? echo fn_number_format($lbdpApBackLog,0);?></th>
                            <th><? //echo fn_number_format($a,0);?></th>
                            <!-- <th><? echo fn_number_format($bookingBackLog,0);?></th> -->
                            <th><? echo fn_number_format($bookingBackLogKg,0);?></th>
                            <th><? echo fn_number_format($bookingBackLogYds,0);?></th>
                            <th><? echo fn_number_format($yarnBackLog,0);?></th>
                            <th><? echo fn_number_format($ydBackLog,0);?></th>
                            <th><? echo fn_number_format($greyBackLog,0);?></th>
                            <th><? echo fn_number_format($dyeingBackLog,0);?></th>
                            <th><? echo fn_number_format($aopBackLog,0);?></th>
                            <!-- <th><? echo fn_number_format($finishBackLog,0);?></th> -->
                            <th><? echo fn_number_format($finishBackLogKg,0);?></th>
                            <th><? echo fn_number_format($finishBackLogYds,0);?></th>
                            <th><? echo fn_number_format($qcBackLog,0);?></th>
                            <th><? echo fn_number_format($printBackLog,0);?></th>
                            <th><? echo fn_number_format($embBackLog,0);?></th>
                            <th><? //echo fn_number_format($sewTrmBacklog,0);?></th>
                            <th><? //echo fn_number_format($finTrmBacklog,0);?></th>

                            <th><? echo fn_number_format($sewingBackLog,0);?></th>
                            <th><? echo fn_number_format($washBackLog,0);?></th>
                            <th><? echo fn_number_format($finishingBackLog,0);?></th>
                            <th><? echo fn_number_format($shiping_backlog,0);?></th>                                
                            <th><? echo fn_number_format($fob_backlog,0);?></th>                                
                        </tr>
                    </tfoot>
                </table>
            </div>
        </main>
        <main class="main">
            <div class="tableContainer" style="width: 100%;text-align: left;">
                <h2 style="font-size: 20px;text-align: center;">Backlog - Buyer Wise <span style="color: red;font-size: 18px;font-weight: bold;"> <?=($client) ? ": ".$client_array[$client] : ": All"; ?></span></h2>
                <table cellspacing="0" style="width: 100%; border-collapse: collapse;" class="rpt_table" cellpadding="0" border="1">
                    <thead>
                        <tr>
                            <th width="4%">Buyer</th>
                            <th width="4%">LD Sub</th>
                            <th width="4%">LD Aprv</th>
                            <th width="4%">Acc Booking</th>
                            <!-- <th width="4%">Fab Booking</th> -->
                            <th width="4%">Fab Booking Kg</th>
                            <th width="4%">Fab Booking Y/M</th>
                            <th width="4%">Yarn</th>
                            <th width="4%">YD</th>
                            <th width="4%">Gray</th>
                            <th width="4%">Dyeing</th>
                            <th width="4%">AOP</th>
                            <!-- <th width="4%">F. Fabric</th> -->
                            <th width="4%">F. Fabric Prod.</th>
                            <th width="4%">F. Fabric Purc</th>
                            <th width="4%">Cutting</th>
                            <th width="4%">Printing</th>
                            <th width="4%">Embroidery</th>
                            <th width="4%">S. Acc Rcv</th>
                            <th width="4%">F. Acc Rcv</th>
                            <th width="4%">Sewing</th>
                            <th width="4%">Washing</th>
                            <th width="4%">Finishing</th>
                            <th width="4%">Shipment</th>                                
                            <th width="4%">FOB Backlog</th>                                
                        </tr>
                    </thead>
                    <tbody>
                    <?
                    $i=1;
                    $lbdpSbBackLog      = 0;
                    $lbdpApBackLog      = 0;
                    $bookingBackLog     = 0;
                    $bookingBackLogKg   = 0;
                    $bookingBackLogYds  = 0;
                    $yarnBackLog        = 0;
                    $ydBackLog          = 0;
                    $greyBackLog        = 0;
                    $dyeingBackLog      = 0;
                    $aopBackLog         = 0;
                    $finishBackLog      = 0;
                    $finishBackLogKg      = 0;
                    $finishBackLogYds      = 0;
                    $qcBackLog          = 0;
                    $printBackLog       = 0;
                    $embBackLog         = 0;
                    $sewTrmBacklog      = 0;
                    $finTrmBacklog      = 0;
                    $sewingBackLog      = 0;
                    $washBackLog        = 0;
                    $finishingBackLog   = 0;
                    $shiping_backlog    = 0;
                    $fob_backlog        = 0;
                    ksort($buyer_wise_backlog_array);
                    foreach ($buyer_wise_backlog_array as $buyer_Name => $row) 
                    {
                        $buyer_id = $row['buyer_id'];
                        $buyer_tot_po = count($buyerWiseAccPoArray[$buyer_id]);
                        $accBacklog = $row['accBacklog']/$buyer_tot_po;

                        $sewTrmBacklog = ($row['sewTrmCurBk']/$row['sewTrimsReq'])*100;
                        $finTrmBacklog = ($row['finTrmCurBk']/$row['finTrimsReq'])*100;

                        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                        if($row['lbdpSbBackLog']>0 || $row['lbdpApBackLog']>0 || $row['bookingBackLog']>0 || $row['yarnBackLog']>0 || $row['ydBackLog']>0 || $row['greyBackLog']>0 || $row['dyeingBackLog']>0 || $row['aopBackLog']>0 || $row['finishBackLog']>0 || $row['finishBackLogPur']>0 || $row['qcBackLog']>0 || $row['printBackLog']>0 || $row['embBackLog']>0 || $sewTrmBacklog>0 || $finTrmBacklog>0 || $row['sewFinBackLog']>0 || $row['washBackLog']>0 || $row['gmtFinBackLog']>0 || $row['shiping_backlog']>0 || $row['fob_backlog']>0)
                        {
                            ?>
                            <tr bgcolor="<? echo $bgcolor; ?>" onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
                                <td><p><a href="javascript:void(0)" onClick="display_buyer_details('<? echo $buyer_id;?>','<? echo $client;?>');"><?= $buyer_Name ?></a></p></td>
                                <td align="right"><?=  fn_number_format($row['lbdpSbBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['lbdpApBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($accBacklog,2); ?>%</td>
                                <!-- <td align="right"><?=  fn_number_format($row['bookingBackLog'],0); ?></td> -->
                                <td align="right"><?=  fn_number_format($row['bookingBackLogKg'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['bookingBackLogYds'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['yarnBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['ydBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['greyBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['dyeingBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['aopBackLog'],0); ?></td>
                                <!-- <td align="right"><?=  fn_number_format($row['finishBackLog'],0); ?></td> -->
                                <td align="right"><?=  fn_number_format($row['finishBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['finishBackLogPur'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['qcBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['printBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['embBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($sewTrmBacklog,2); ?>%</td>
                                <td align="right"><?=  fn_number_format($finTrmBacklog,2); ?>%</td>
                                <td align="right"><?=  fn_number_format($row['sewFinBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['washBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['gmtFinBackLog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['shiping_backlog'],0); ?></td>
                                <td align="right"><?=  fn_number_format($row['fob_backlog'],0); ?></td>
                            </tr>
                            <?
                            $i++;
                            $lbdpSbBackLog      += $row['lbdpSbBackLog'];
                            $lbdpApBackLog      += $row['lbdpApBackLog'];
                            $bookingBackLog     += $row['bookingBackLog'];
                            $bookingBackLogKg   += $row['bookingBackLogKg'];
                            $bookingBackLogYds  += $row['bookingBackLogYds'];
                            $yarnBackLog        += $row['yarnBackLog'];
                            $ydBackLog          += $row['ydBackLog'];
                            $greyBackLog        += $row['greyBackLog'];
                            $dyeingBackLog      += $row['dyeingBackLog'];
                            $aopBackLog         += $row['aopBackLog'];
                            $finishBackLog      += $row['finishBackLog'];
                            $finishBackLogKg    += $row['finishBackLog'];
                            $finishBackLogYds   += $row['finishBackLogPur'];
                            $qcBackLog          += $row['qcBackLog'];
                            $printBackLog       += $row['printBackLog'];
                            $embBackLog         += $row['embBackLog'];
                            $sewTrmBacklog      += $row['sewTrmBacklog'];
                            $finTrmBacklog      += $row['finTrmBacklog'];

                            $sewingBackLog      += $row['sewFinBackLog'];
                            $washBackLog        += $row['washBackLog'];
                            $finishingBackLog   += $row['gmtFinBackLog'];
                            $shiping_backlog    += $row['shiping_backlog'];
                            $fob_backlog        += $row['fob_backlog'];
                        }
                    }
                    ?>
                    </tbody>
                    <tfoot>
                        <tr>
                            <th>Total</th>
                            <th><? echo fn_number_format($lbdpSbBackLog,0);?></th>
                            <th><? echo fn_number_format($lbdpApBackLog,0);?></th>
                            <th><? //echo fn_number_format($a,0);?></th>
                            <!-- <th><? echo fn_number_format($bookingBackLog,0);?></th> -->
                            <th><? echo fn_number_format($bookingBackLogKg,0);?></th>
                            <th><? echo fn_number_format($bookingBackLogYds,0);?></th>
                            <th><? echo fn_number_format($yarnBackLog,0);?></th>
                            <th><? echo fn_number_format($ydBackLog,0);?></th>
                            <th><? echo fn_number_format($greyBackLog,0);?></th>
                            <th><? echo fn_number_format($dyeingBackLog,0);?></th>
                            <th><? echo fn_number_format($aopBackLog,0);?></th>
                            <!-- <th><? echo fn_number_format($finishBackLog,0);?></th> -->
                            <th><? echo fn_number_format($finishBackLogKg,0);?></th>
                            <th><? echo fn_number_format($finishBackLogYds,0);?></th>
                            <th><? echo fn_number_format($qcBackLog,0);?></th>
                            <th><? echo fn_number_format($printBackLog,0);?></th>
                            <th><? echo fn_number_format($embBackLog,0);?></th>
                            <th><? //echo fn_number_format($sewTrmBacklog,0);?></th>
                            <th><? //echo fn_number_format($finTrmBacklog,0);?></th>

                            <th><? echo fn_number_format($sewingBackLog,0);?></th>
                            <th><? echo fn_number_format($washBackLog,0);?></th>
                            <th><? echo fn_number_format($finishingBackLog,0);?></th>
                            <th><? echo fn_number_format($shiping_backlog,0);?></th>                                
                            <th><? echo fn_number_format($fob_backlog,0);?></th>                                
                        </tr>
                    </tfoot>
                </table>
            </div>
        </main> 
        <?

        foreach (glob("$user_id*.xls") as $filename) 
        {
            if( @filemtime($filename) < (time()-$seconds_old) )
            @unlink($filename);
        }
        //---------end------------//
        $name=time();
        $filename="tmp/".$user_id."_".$name.".xls";
        $create_new_doc = fopen($filename, 'w');
        $is_created = fwrite($create_new_doc,ob_get_contents());
        //$filename=$user_id."_".$name.".xls";
        echo "$total_data####$filename";
        exit();
    }     
    elseif ($rptType==7) // Unplan button
    {
        $sqlCond = "";
        $sqlCond .= " and a.company_name=$company_id";
        // $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name" : "";
        $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";        
        $sqlCond .= " and b.shiping_status in(1,2)";   
        $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";   

        if($buyer_name==0)
        {
            if($_SESSION['logic_erp']["data_level_secured"]==1)
            {
                if($_SESSION['logic_erp']["buyer_id"]!="")
                {   
                    $sqlCond.=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")";
                }
            }
        }
        else
        {
            $sqlCond.=" and a.buyer_name=$buyer_name";
        }   
        
        /*======================================================================================/
        /                                    main query                                         /
        /======================================================================================*/
        $sql = "SELECT A.BUYER_NAME,b.id as po_id,c.TASK_NUMBER,c.TASK_START_DATE,c.TASK_FINISH_DATE from wo_po_details_master a,wo_po_break_down b,tna_process_mst c where a.id=b.job_id and b.id=c.po_number_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.task_number in(9,10,32,31,48,52,60,61,63,73,84,267,268,70,71,86,90,88) $sqlCond"; // and c.task_start_date is null and c.task_finish_date is null
        // echo $sql;die();
        $sqlRes = sql_select($sql);
        if(count($sqlRes)==0)
        {
            echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
        }

        $data_array = array();
        $grand_tot_array = array();
        foreach ($sqlRes as $row) 
        {    
            if($row['TASK_START_DATE'] !="" && $row['TASK_FINISH_DATE'] !="")
            {

            }
            else
            {
                // echo $row['TASK_NUMBER']."<br>";
                $data_array[$buyer_name_arr[$row['BUYER_NAME']]."**".$row['BUYER_NAME']][$row['TASK_NUMBER']]++;
                $grand_tot_array[$row['TASK_NUMBER']]++;
               
            }
        }
        // echo "<pre>";print_r($data_array);
        
        // ============================ order qty ==========================
        $sql = "SELECT a.job_no,a.BUYER_NAME,b.id as po_id,c.order_quantity as PO_QUANTITY from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and b.status_active=1 and c.status_active=1 and c.is_deleted=0 $sqlCond";
        // echo $sql;die;
        $res = sql_select($sql);
        $order_qty_array = array();
        $buyer_po_array = array();
        $po_id_array = array();
        foreach ($res as $val) 
        {
            $order_qty_array[$buyer_name_arr[$val['BUYER_NAME']]."**".$val['BUYER_NAME']] += $val['PO_QUANTITY'];
            $po_id_array[$val['PO_ID']] = $val['PO_ID'];
            $buyer_po_array[$val['BUYER_NAME']][$val['PO_ID']]['qty'] += $val['PO_QUANTITY'];
            $buyer_po_array[$val['BUYER_NAME']][$val['PO_ID']]['job_no'] = $val['JOB_NO'];
        }
        $po_id_cond = where_con_using_array($po_id_array,0,"b.id");
         // ============================ Acct po qty ==========================
        $sql = "SELECT a.BUYER_NAME, d.PO_QTY as ACC_PO_QTY from wo_po_details_master a,wo_po_break_down b,wo_po_acc_po_info c,wo_po_acc_po_info_dtls d where a.id=b.job_id and b.id=c.po_break_down_id and c.id=d.mst_id and a.status_active=1 and b.status_active=1 and b.shiping_status !=3 and c.status_active=1 and d.status_active=1 and d.is_deleted=0 and c.acc_po_status=1 $sqlCond";
        // echo $sql;
        $res = sql_select($sql);
        $acct_order_qty_array = array();
        foreach ($res as $val) 
        {
            $acct_order_qty_array[$buyer_name_arr[$val['BUYER_NAME']]] += $val['ACC_PO_QTY'];
        }
        // ============================ tna plan qty ==========================
        $sql = "SELECT a.BUYER_NAME,c.TASK_ID,c.PLAN_QTY,c.po_id from wo_po_details_master a,wo_po_break_down b,tna_plan_target c where a.id=b.job_id and a.id=b.job_id and b.id=c.po_id and a.status_active=1 and b.status_active=1 and c.status_active=1 and c.is_deleted=0 $sqlCond $po_id_cond";
        // echo $sql;die;
        $res = sql_select($sql);
        $plan_qty_array = array();
        foreach ($res as $val) 
        {
            $plan_qty_array[$val['BUYER_NAME']][$val['PO_ID']][$val['TASK_ID']] += $val['PLAN_QTY'];
        }
        // echo "<pre>";print_r($plan_qty_array);die;

        foreach ($order_qty_array as $b_key => $val) 
        {
            $data_array[$b_key][0]=0;
        }
        // echo "<pre>";print_r($order_qty_array);

        // =============================== getting excess qty ====================
        $po_id_cond = where_con_using_array($po_id_array,0,"b.PO_BREAK_DOWN_ID");
        $sqlBooking = "SELECT a.FABRIC_SOURCE,a.IS_SHORT,B.PO_BREAK_DOWN_ID,B.FIN_FAB_QNTY AS QTY,B.GREY_FAB_QNTY AS GREY_QTY FROM WO_BOOKING_MST A,WO_BOOKING_DTLS B WHERE A.BOOKING_NO=B.BOOKING_NO AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 and a.booking_type=1 and a.IS_SHORT=1 $po_id_cond";
        // echo $sqlBooking;die();
        $bookingRes = sql_select($sqlBooking);
        $bookingQtyArray = array();
        $bookingFabInfoArray = array();
        foreach ($bookingRes as $val) 
        {                
            $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['fin_fab_excess_qty'] += $val['QTY'];
            if($val['FABRIC_SOURCE'] !=2)// avoid purchase
            {
                $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['grey_fab_excess_qty'] += $val['GREY_QTY'];
                $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['yarn_excess_qty'] += $val['GREY_QTY'];
            }                     
            
        }
        // echo "<pre>";print_r($bookingQtyArray);

        // ======================================= COLOR TYPE WISE BOOKING DATA  ==================================
        $po_id_cond = where_con_using_array($po_id_array,0,"a.PO_BREAK_DOWN_ID");
        $shortSql = "SELECT a.PO_BREAK_DOWN_ID, b.COLOR_TYPE_ID,a.FIN_FAB_QNTY, a.GREY_FAB_QNTY FROM wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b WHERE a.pre_cost_fabric_cost_dtls_id=b.id $po_id_cond and a.is_short=1 and a.status_active=1 and  a.is_deleted=0";
        // echo $shortSql;die;
        $shortRes = sql_select($shortSql);
        $color_type_wise_booking_qty_array = array();
        foreach ($shortRes as $val) 
        {
            $color_type_wise_booking_qty_array[$val['PO_BREAK_DOWN_ID']][$val['COLOR_TYPE_ID']] += $val['FIN_FAB_QNTY'];
        }
        // echo "<pre>";print_r($color_type_wise_booking_qty_array);die();


        $poIds = implode(",",$po_id_array);
        $condition= new condition();     
        $condition->po_id_in($poIds);     
        $condition->init();
        $costPerArr=$condition->getCostingPerArr();
        $yarn= new yarn($condition); 
        // echo $yarn->getQuery(); die;  
        $yarnReqQtyArr=$yarn->getOrderWiseYarnQtyArray();
        // echo "<pre>";print_r($yarnReqQtyArr);die;
        
        $conversion= new conversion($condition);
        $conversion_costing_arr=$conversion->getQtyArray_by_orderAndProcess();
        // echo "<pre>";print_r($conversion_costing_arr);die;
        
        $fabric= new fabric($condition);
        $fabric_costing_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish_production();        
        $fabric_purchase_costing_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish_purchase();
        $fabric_po_color_type_wise_arr=$fabric->getQtyArray_by_orderColorType_knitAndwoven_greyAndfinish();
        $fabric_costing_aop_arr = $fabric->getQtyArray_by_orderAndColorTypeFabricSource_knitAndwoven_greyAndfinish();
        // echo "<pre>";print_r($fabric_costing_aop_arr);die;
        
        $emblishment= new emblishment($condition);
        $emblishment_costing_arr=$emblishment->getQtyArray_by_orderAndEmbname();
        //  echo "<pre>";print_r($emb_costing_arr);die;  
        $wash= new wash($condition);
        $emblishment_costing_arr_name=$wash->getQtyArray_by_orderAndEmbname();


        $unplan_qty_array = array();
        foreach ($buyer_po_array as $b_key => $b_data) 
        {
           foreach ($b_data as $p_key => $v) 
           {
                $costingPer     =  $costPerArr[$v['job_no']];
                $unplan_qty_array[$b_key][48] += ($yarnReqQtyArr[$p_key]+$bookingQtyArray[$p_key]['yarn_excess_qty']) - $plan_qty_array[$b_key][$p_key][48];

                $unplan_qty_array[$b_key][52] += array_sum($conversion_costing_arr[$p_key][30]) - $plan_qty_array[$b_key][$p_key][52];

                $unplan_qty_array[$b_key][60] += (array_sum($fabric_costing_arr['knit']['grey'][$p_key])+$bookingQtyArray[$p_key]['grey_fab_excess_qty']) - $plan_qty_array[$b_key][$p_key][60];

                $unplan_qty_array[$b_key][61] += (array_sum($fabric_costing_arr['knit']['grey'][$p_key])+$bookingQtyArray[$p_key]['grey_fab_excess_qty']) - $plan_qty_array[$b_key][$p_key][61];

                // $unplan_qty_array[$b_key][63] += (array_sum($fabric_po_color_type_wise_arr['knit']['finish'][$p_key][5])+$color_type_wise_booking_qty_array[$p_key][5]) - $plan_qty_array[$b_key][$p_key][63];
                $unplan_qty_array[$b_key][63] += (array_sum($fabric_costing_aop_arr['knit']['finish'][$p_key][5][1])+$color_type_wise_booking_qty_array[$p_key][5]) - $plan_qty_array[$b_key][$p_key][63];

                // echo  ".(".array_sum($fabric_costing_aop_arr['knit']['finish'][$p_key][5][1])."+".$color_type_wise_booking_qty_array[$p_key][5].") - ".$plan_qty_array[$b_key][$p_key][63]."<br>";

                $unplan_qty_array[$b_key][73] += (array_sum($fabric_costing_arr['knit']['finish'][$p_key])+array_sum($fabric_purchase_costing_arr['knit']['finish'][$p_key])+$bookingQtyArray[$p_key]['fin_fab_excess_qty']) - $plan_qty_array[$b_key][$p_key][73];
                // echo array_sum($fabric_costing_arr['knit']['finish'][$p_key])."=".array_sum($fabric_purchase_costing_arr['knit']['finish'][$p_key])."=".$bookingQtyArray[$p_key]['fin_fab_excess_qty']."<br>";

                $unplan_qty_array[$b_key][84] += $v['qty'] - $plan_qty_array[$b_key][$p_key][84];
                $unplan_qty_array[$b_key][267] += ($emblishment_costing_arr[$p_key][1]*$costingPer) - $plan_qty_array[$b_key][$p_key][267];
                $unplan_qty_array[$b_key][268] += ($emblishment_costing_arr[$p_key][2]*$costingPer) - $plan_qty_array[$b_key][$p_key][268];
                $unplan_qty_array[$b_key][86] += $v['qty'] - $plan_qty_array[$b_key][$p_key][86];
                $unplan_qty_array[$b_key][90] += ($emblishment_costing_arr_name[$p_key][3]*$costingPer) - $plan_qty_array[$b_key][$p_key][90];
                $unplan_qty_array[$b_key][88] += $v['qty'] - $plan_qty_array[$b_key][$p_key][88];
                // echo $emblishment_costing_arr[$p_key][1]."*".$costingPer."<br>";
           }
        }
        
        ob_start();
        ?>
        <div class="tableContainer">  
            <style type="text/css">
            .rpt_table tr th, .rpt_table tr td,.rpt_table tfoot th{font-size:13px;}
            </style>          
            <fieldset style="width:1310px;">
                <table width="100%" cellpadding="0" cellspacing="0">
                    <tr><td colspan="28" align="center" style="font-size:22px;">Unplan Buyer Wise <span style="color: red;font-size: 18px;font-weight: bold;"> <?=($client) ? ": ".$client_array[$client] : ": All"; ?></span></td></tr>
                </table>
                <table width="1290" border="1" rules="all"  class="rpt_table" align="left"> 
                    <thead>
                        <tr> 
                            <th width="100">Buyer</th>
                            <th width="62">LD Sub</th>
                            <th width="62">LD Aprv</th>
                            <th width="62">Acc Booking</th>
                            <th width="62">Fab Booking</th>
                            <th width="62">Yarn</th>
                            <th width="62">YD</th>
                            <th width="62">Grey</th>
                            <th width="62">Dyeing</th>
                            <th width="62">AOP</th>
                            <th width="62">F. Fabric</th> 
                            <th width="62">Cutting</th>
                            <th width="62">Printing</th>
                            <th width="62">Embroidery</th>
                            <th width="62">S. Acc Rcv</th>
                            <th width="62">F. Acc Rcv</th>
                            <th width="62">Sewing</th>
                            <th width="62">Washing</th>
                            <th width="62">Finishing</th>
                            <th width="74">PO Distribution</th>
                       </tr>
                    </thead>
                </table>
                <div style="max-height:325px; overflow-y:scroll; width:1310px;" id="scroll_body">
                    <table width="1290" border="1" rules="all"  class="rpt_table">
                        <tbody>
                            <? 
                            $i=1;
                            $gr_po_dis_qty   = 0;                            
                            ksort($data_array);

                            $tot_yarn_qty = 0;
                            $tot_yd_qty = 0;
                            $tot_grey_qty = 0;
                            $tot_dyeing_qty = 0;
                            $tot_aop_qty = 0;
                            $tot_ff_qty = 0;
                            $tot_cut_qty = 0;
                            $tot_print_qty = 0;
                            $tot_emb_qty = 0;
                            $tot_sewing_qty = 0;
                            $tot_wash_qty = 0;
                            $tot_fin_qty = 0;
                            
                            foreach ($data_array as $buyer_name => $buyer_data) 
                            {                                
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                $buyer_ex = explode("**",$buyer_name);
                                $buyer_name = $buyer_ex[0];
                                $buyer_id = $buyer_ex[1];
                                $po_dis_qty = $order_qty_array[$buyer_name."**".$buyer_id]  - $acct_order_qty_array[$buyer_name];
                                $yarn_qty = $unplan_qty_array[$buyer_id][48];
                                $yarn_dyed_qty = $unplan_qty_array[$buyer_id][52];
                                $grey_qty = $unplan_qty_array[$buyer_id][60];
                                $dyeing_qty = $unplan_qty_array[$buyer_id][61];
                                $aop_qty = $unplan_qty_array[$buyer_id][63];
                                $ff_qty = $unplan_qty_array[$buyer_id][73];
                                $cut_qty = $unplan_qty_array[$buyer_id][84];
                                $print_qty = $unplan_qty_array[$buyer_id][267];
                                $emb_qty = $unplan_qty_array[$buyer_id][268];
                                $sewing_qty = $unplan_qty_array[$buyer_id][86];
                                $wash_qty = $unplan_qty_array[$buyer_id][90];
                                $fin_qty = $unplan_qty_array[$buyer_id][88];

                               /*  $yarn_dyed_qty = $order_qty_array[$buyer_name."**".$buyer_id] - $plan_qty_array[$buyer_id][52];
                                $grey_qty = $order_qty_array[$buyer_name."**".$buyer_id] - $plan_qty_array[$buyer_id][60];
                                $dyeing_qty = $order_qty_array[$buyer_name."**".$buyer_id] - $plan_qty_array[$buyer_id][61];
                                $aop_qty = $order_qty_array[$buyer_name."**".$buyer_id] - $plan_qty_array[$buyer_id][63];
                                $ff_qty = $order_qty_array[$buyer_name."**".$buyer_id] - $plan_qty_array[$buyer_id][73];
                                $cut_qty = $order_qty_array[$buyer_name."**".$buyer_id] - $plan_qty_array[$buyer_id][84];
                                $print_qty = $order_qty_array[$buyer_name."**".$buyer_id] - $plan_qty_array[$buyer_id][267];
                                $emb_qty = $order_qty_array[$buyer_name."**".$buyer_id] - $plan_qty_array[$buyer_id][268];
                                $sewing_qty = $order_qty_array[$buyer_name."**".$buyer_id] - $plan_qty_array[$buyer_id][86];
                                $wash_qty = $order_qty_array[$buyer_name."**".$buyer_id] - $plan_qty_array[$buyer_id][90];
                                $fin_qty = $order_qty_array[$buyer_name."**".$buyer_id] - $plan_qty_array[$buyer_id][88]; */

                                //  echo $order_qty_array[$buyer_name."**".$buyer_id]."-". $acct_order_qty_array[$buyer_name]."<br>";
                                if($buyer_data[9] !=0 || $buyer_data[10] !=0 || $buyer_data[32] !=0 || $buyer_data[31] !=0 || $yarn_qty !=0 || $yarn_dyed_qty !=0 || $grey_qty !=0 || $dyeing_qty !=0 || $aop_qty !=0 || $ff_qty !=0 || $cut_qty !=0 || $print_qty !=0 || $emb_qty !=0 || $buyer_data[70] !=0 || $buyer_data[71] !=0 || $sewing_qty !=0 || $wash_qty !=0 || $fin_qty !=0 || $po_dis_qty !=0)
                                {
                                    
                                    $gr_po_dis_qty += $po_dis_qty;
                                    ?>
                                    <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('str_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="str_<? echo $i; ?>" style="font-size:12px;" valign="middle">
                                        <td width="100"><p><? echo $buyer_name;?></p></td>
                                        <td width="62" align="right">
                                            <a href="javascript:void(0)" onclick="open_unplan_popup('<?=$sqlCond;?>','<?=$buyer_id;?>',9)">
                                                <? echo fn_number_format($buyer_data[9],0); ?>
                                            </a>
                                        </td>
                                        <td width="62" align="right">
                                            <a href="javascript:void(0)" onclick="open_unplan_popup('<?=$sqlCond;?>','<?=$buyer_id;?>',10)">
                                                <? echo fn_number_format($buyer_data[10],0); ?>
                                            </a>
                                        </td>
                                        <td width="62" align="right">
                                             <a href="javascript:void(0)" onclick="open_unplan_popup('<?=$sqlCond;?>','<?=$buyer_id;?>',32)">
                                               <? echo fn_number_format($buyer_data[32],0); ?>
                                         </a>
                                        </td>
                                        <td width="62" align="right">
                                           <a href="javascript:void(0)" onclick="open_unplan_popup('<?=$sqlCond;?>','<?=$buyer_id;?>',31)">
                                             <? echo fn_number_format($buyer_data[31],0); ?>
                                           </a>
                                        </td>
                                        <td width="62" align="right">
                                          <a href="javascript:void(0)" onclick="open_unplan_popup2('<?=$sqlCond;?>','<?=$buyer_id;?>',48)">
                                            <? echo fn_number_format($yarn_qty,0); ?>
                                          </a>
                                        </td>
                                        <td width="62" align="right">
                                           <a href="javascript:void(0)" onclick="open_unplan_popup2('<?=$sqlCond;?>','<?=$buyer_id;?>',52)">
                                            <? echo fn_number_format($yarn_dyed_qty,0); ?>
                                           </a>
                                        </td>
                                        <td width="62" align="right">
                                        <a href="javascript:void(0)" onclick="open_unplan_popup2('<?=$sqlCond;?>','<?=$buyer_id;?>',60)">
                                            <? echo fn_number_format($grey_qty,0); ?>
                                        </a>
                                        </td>
                                        <td width="62" align="right">
                                         <a href="javascript:void(0)" onclick="open_unplan_popup2('<?=$sqlCond;?>','<?=$buyer_id;?>',61)">
                                            <? echo fn_number_format($dyeing_qty,0); ?>
                                         </a>
                                        </td>
                                        <td width="62" align="right">
                                           <a href="javascript:void(0)" onclick="open_unplan_popup2('<?=$sqlCond;?>','<?=$buyer_id;?>',63)">
                                            <? echo fn_number_format($aop_qty,0); ?>
                                            </a>
                                        </td>
                                        <td width="62" align="right">
                                           <a href="javascript:void(0)" onclick="open_unplan_popup2('<?=$sqlCond;?>','<?=$buyer_id;?>',73)">
                                            <? echo fn_number_format($ff_qty,0); ?>
                                            </a>
                                        </td>
                                        <td width="62" align="right">
                                          <a href="javascript:void(0)" onclick="open_unplan_popup2('<?=$sqlCond;?>','<?=$buyer_id;?>',84)">
                                            <? echo fn_number_format($cut_qty,0); ?>
                                          </a>
                                        </td>
                                        <td width="62" align="right">
                                           <a href="javascript:void(0)" onclick="open_unplan_popup2('<?=$sqlCond;?>','<?=$buyer_id;?>',267)">
                                            <? echo fn_number_format($print_qty,0); ?>
                                           </a>
                                        </td>
                                        <td width="62" align="right">
                                        <a href="javascript:void(0)" onclick="open_unplan_popup2('<?=$sqlCond;?>','<?=$buyer_id;?>',268)">
                                            <? echo fn_number_format($emb_qty,0); ?>
                                        </a>
                                        </td>
                                        <td width="62" align="right">
                                        <a href="javascript:void(0)" onclick="open_unplan_popup('<?=$sqlCond;?>','<?=$buyer_id;?>',70)">
                                            <? echo fn_number_format($buyer_data[70],0); ?>
                                        </a>
                                        </td>
                                        <td width="62" align="right">
                                          <a href="javascript:void(0)" onclick="open_unplan_popup('<?=$sqlCond;?>','<?=$buyer_id;?>',71)">
                                            <? echo fn_number_format($buyer_data[71],0); ?>
                                          </a>
                                        </td>
                                        <td width="62" align="right">
                                        <a href="javascript:void(0)" onclick="open_unplan_popup2('<?=$sqlCond;?>','<?=$buyer_id;?>',86)">
                                            <? echo fn_number_format($sewing_qty,0); ?>
                                        </a>
                                        </td>
                                        <td width="62" align="right">
                                           <a href="javascript:void(0)" onclick="open_unplan_popup2('<?=$sqlCond;?>','<?=$buyer_id;?>',90)">
                                            <? echo fn_number_format($wash_qty,0); ?>
                                           </a>
                                        </td>
                                        <td width="62" align="right">
                                            <a href="javascript:void(0)" onclick="open_unplan_popup2('<?=$sqlCond;?>','<?=$buyer_id;?>',88)">
                                            <? echo fn_number_format($fin_qty,0); ?>
                                            </a>
                                        </td>
                                        <td width="74" align="right">
                                          <a href="javascript:void(0)" onclick="open_unplan_popup('<?=$sqlCond;?>','<?=$buyer_id;?>','')">
                                            <? echo fn_number_format($po_dis_qty,0); ?>
                                          </a>
                                        </td>
                                        
                                    </tr>
                                    <? 
                                    $i++;
                                    $tot_yarn_qty += $yarn_qty;
                                    $tot_yd_qty += $yarn_dyed_qty;
                                    $tot_grey_qty += $grey_qty;
                                    $tot_dyeing_qty += $dyeing_qty;
                                    $tot_aop_qty += $aop_qty;
                                    $tot_ff_qty += $ff_qty;
                                    $tot_cut_qty += $cut_qty;
                                    $tot_print_qty += $print_qty;
                                    $tot_emb_qty += $emb_qty;
                                    $tot_sewing_qty += $sewing_qty;
                                    $tot_wash_qty += $wash_qty;
                                    $tot_fin_qty += $fin_qty;
                                }
                            }
                            
                           ?>
                        </tbody>
                    </table>
                </div>
                <table width="1290" border="1" rules="all"  class="rpt_table" align="left">
                    <tfoot>
                        <th width="100" align="right">Grand Total </th> 
                        <th width="62" align="right"><? echo fn_number_format($grand_tot_array[9],0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($grand_tot_array[10],0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($grand_tot_array[32],0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($grand_tot_array[31],0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($tot_yarn_qty,0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($tot_yd_qty,0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($tot_grey_qty,0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($tot_dyeing_qty,0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($tot_aop_qty,0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($tot_ff_qty,0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($tot_cut_qty,0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($tot_print_qty,0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($tot_emb_qty,0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($grand_tot_array[70],0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($grand_tot_array[71],0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($tot_sewing_qty,0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($tot_wash_qty,0); ?></th>
                        <th width="62" align="right"><? echo fn_number_format($tot_fin_qty,0); ?></th>  
                        <th width="74" align="right"><? echo fn_number_format($gr_po_dis_qty,0);?></th>    
                        
                    </tfoot>
                    
                </table>
            </fieldset>
        </div>
        <?
        foreach (glob("$user_id*.xls") as $filename) 
        {
            if( @filemtime($filename) < (time()-$seconds_old) )
            @unlink($filename);
        }
        //---------end------------//
        $name=time();
        $filename="tmp/".$user_id."_".$name.".xls";
        $create_new_doc = fopen($filename, 'w');
        $is_created = fwrite($create_new_doc,ob_get_contents());
       // $filename=$user_id."_".$name.".xls";
        echo "$total_data####$filename";
        exit();
    }
}

if($action=="plan_balance_popup")
{
	
	//echo load_html_head_contents("TNA","../../../", 1, 1, $unicode);
	echo load_html_head_contents("TNA", "../../../../", 1, 1,'','','',1);
	list($job_no,$po_id,$task_id) = explode("**",$po_break_down_id);


		
    $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
    
    $sql ="select a.po_number,b.job_no,b.buyer_name,b.style_ref_no,a.GROUPING from  wo_po_break_down a,wo_po_details_master b where a.id=$po_id and a.job_no_mst=b.job_no";
    //echo $sql;
    $result=sql_select($sql);

    $sql = "SELECT min(PLAN_DATE) as plan_start_date,max(PLAN_DATE) as plan_end_date from TNA_PLAN_TARGET where po_id=$po_id and task_id=$task_id and status_active=1 and is_deleted=0";
    // echo $sql;
    $res=sql_select($sql);
	$plan_start_date = 	$res[0][csf('plan_start_date')];
	$plan_end_date = 	$res[0][csf('plan_end_date')];
		
	?> 
    
    
     <script>
	 
	 var permission='<? echo $permission; ?>';


	let set_target_entry_form = ()=>{
		let txt_plan_start_date = '<?=$plan_start_date;?>';
		let txt_plan_finish_date = '<?=$plan_end_date;?>';
		let task_id = '<?=$task_id;?>';
		let po_id = '<?=$po_id;?>';
		let tna_mst_id = '<?=$tna_mst_id;?>';
		let permission = '<?=$permission;?>';

		var data="action=tna_target_list_view&txt_plan_start_date="+txt_plan_start_date+"&txt_plan_finish_date="+txt_plan_finish_date+"&task_id="+task_id+"&po_id="+po_id+"&tna_mst_id="+tna_mst_id+"&permission="+permission;
		// alert (data);return;
		//freeze_window(operation);
		http.open("POST","order_monitoring_report_with_tna_controller.php",true);
		http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
		http.send(data);
		http.onreadystatechange = ()=>{
			if(http.readyState == 4) 
			{ 
				
				
				document.querySelector('#target_entry_form_container').innerHTML = http.responseText;
				if(task_id == 48){
					fnGridView('gvMain',7);
				}
				else if(task_id == 52){
					fnGridView('gvMain',6);
				}
				else if(task_id == 60){
					fnGridView('gvMain',7);
				}
				else if(task_id == 63 || task_id == 61){
					fnGridView('gvMain',5);
				}
				else if(task_id == 73){
					fnGridView('gvMain',7);
				}
				else if(task_id == 70 || task_id == 71){ 
					fnGridView('gvMain',8);
				}
				else{
					fnGridView('gvMain',3);
				}
				
				$('#gvMain').freezeTable('update');
				
			}
		}
	}

	

	let calculate_day_val = (rowSelectorKey,colSelectorKey,all_date_key,task_id,other_selector)=>{

		var currVal = document.querySelector('#targetQty_'+rowSelectorKey+'_'+colSelectorKey).value*1;
		if( Number.isInteger(currVal) == false ){ 
			document.querySelector('#targetQty_'+rowSelectorKey+'_'+colSelectorKey).style.color = 'red';
			document.querySelector('#targetQty_'+rowSelectorKey+'_'+colSelectorKey).value=0;
			return;			
		}
		else{
			document.querySelector('#targetQty_'+rowSelectorKey+'_'+colSelectorKey).style.color = 'black';
		}
		

		//'plan_qty_td*plan_bal_td'
		var all_date_key_arr = all_date_key.split('*');
		var targetQtyVal=0;
		all_date_key_arr.forEach(function(item, index){
			targetQtyVal += document.querySelector('#targetQty_'+rowSelectorKey+'_'+item).value * 1;
		});
		
		var req_qty_td = document.querySelector('#req_qty_td_'+rowSelectorKey).innerHTML*1;
		let bal = req_qty_td - targetQtyVal;

		if(bal<0){ //alert('#targetQty_'+rowSelectorKey+'_'+colSelectorKey);
			document.querySelector('#targetQty_'+rowSelectorKey+'_'+colSelectorKey).style.color = 'red';
			document.querySelector('#targetQty_'+rowSelectorKey+'_'+colSelectorKey).value=0;
			return;			
		}
		$('#plan_qty_td_'+rowSelectorKey).text(targetQtyVal.toFixed(0));
		$('#plan_bal_td_'+rowSelectorKey).text(bal.toFixed(0));
		$('#gvMain').freezeTable('update');

	}
	</script>
			
		</head>
			<body onLoad="set_hotkey()">
			<? 
				echo load_freeze_divs ("../../../../",$permission,1);
			?>
		<form id="targetForm">
		<input type="hidden" id="auto_field_data_str" name="auto_field_data_str"  value="" />
		<div align="center">
		<fieldset style="width:620px;">
			<table><tr><td><font size="+1"><b><? echo $tna_task_array[$tna_result[0][csf('task_number')]]; ?></b></font></td></tr></table>  
			<table width="600" cellspacing="0" cellpadding="0" class="rpt_table">
				<thead>
					<th width="100">Buyer Name</th>
					<th width="100">Job No</th>
					<th width="120">Style Ref No</th>
					<th width="120">PO Number</th>
					<th width="120">IR No</th>
				</thead>
				<tr>
					<td><? echo $buyer_arr[$result[0][csf('buyer_name')]]; ?></td>
					<td> <? echo $result[0][csf('job_no')]; ?></td>
					<td><? echo $result[0][csf('style_ref_no')]; ?></td>
					<td><? echo  $result[0][csf('po_number')]; ?></td>
					<td><? echo  $result[0][csf('GROUPING')]; ?></td>
				</tr>
				</table>
				
		</fieldset>
		</div>
		<div id="target_entry_form_container"></div>
		</form>


		
		</body>           
			<script src="../../../../includes/functions_bottom.js" type="text/javascript"></script>
			<script>
				set_target_entry_form();
			</script>
			<script src="../../../../js/freeze-table.js"></script>

	<script>

		let fnGridView = (freeze_table_select='table-multi-columns',columnNum=6) =>{
			$("#"+freeze_table_select).freezeTable({
				'columnNum' : columnNum,
				'scrollable':true,
				'freezeColumnHead':true,
				'columnKeep': true,
			});	
		}

		 
	</script>

	
	
	<?  
		die;

}

if(!function_exists('load_class'))
{
    function load_class($back_path,$classArr=array())
    {
        include($back_path.'includes/class4/class.conditions.php');
        include($back_path.'includes/class4/class.reports.php');
        foreach($classArr as $class_name)
        {
            include($back_path."includes/class4/class.".$class_name.".php");
        }
    }
}

if($action=="tna_target_list_view")
{
	 
	//echo load_freeze_divs ("../../../",$permission,1);
 

	extract($_REQUEST);

	$plan_start_date = date('d-M-Y', strtotime($txt_plan_start_date));
	$plan_finish_date = date('d-M-Y', strtotime($txt_plan_finish_date));

	//......................
	$total_day = datediff('d', $txt_plan_start_date,$txt_plan_finish_date);
	$dayArr=array();
	$dformat = "d-M";
	for($i=0; $i < $total_day; $i++){
		$day = date($dformat, strtotime($txt_plan_start_date. " + $i day"));
		$dmyKey = date('dmY', strtotime($txt_plan_start_date. " + $i day"));
		$dayArr[$dmyKey] = $day;
	}
	$colspan = count($dayArr) + 3;
	$width = (count($dayArr)*55) + 350;
	//..........................
 
	if($task_id == 86 || $task_id == 90 || $task_id == 84 || $task_id == 267 || $task_id == 268 || $task_id == 88 || $task_id == 122)
	{

        if($task_id == 267 || $task_id == 268)
		{
			load_class('../../../',['emblishments']);

			$condition= new condition();
			if(trim($po_id) !=''){
				$condition->po_id(" =$po_id");
			}
			$condition->init();
			$costPerArr=$condition->getCostingPerArr();
			$emblishment= new emblishment($condition);
            $emblishment_costing_arr=$emblishment->getQtyArray_by_orderAndEmbname();
		}
		if($task_id == 90)
		{
			load_class('../../../',['washes']);
			$condition= new condition();
			if(trim($po_id) !=''){
				$condition->po_id(" =$po_id");
			}
			$condition->init();
			$costPerArr=$condition->getCostingPerArr();
			$wash= new wash($condition);
            $emblishment_costing_arr_name=$wash->getQtyArray_by_orderAndEmbname();
		}

		$tna_plan_target_sql = "select TNA_MST_ID,TASK_ID,TASK_TYPE, PO_ID,PLAN_QTY,PLAN_DATE, STATUS_ACTIVE,IS_DELETED,INSERTED_BY,INSERT_DATE  from TNA_PLAN_TARGET where  PO_ID=$po_id and TASK_ID=$task_id and task_type=1 and PLAN_DATE between '$plan_start_date' and '$plan_finish_date'";//TNA_MST_ID=$tna_mst_id and
		 //echo $tna_plan_target_sql;
		$tna_plan_target_sql_res = sql_select( $tna_plan_target_sql );
		$tna_plan_target_arr = array();
		foreach( $tna_plan_target_sql_res as $row ) 
		{
			$dmyKey = date('dmY', strtotime($row['PLAN_DATE']));
			$tna_plan_target_arr[$row['PO_ID'].$dmyKey] = $row['PLAN_QTY']; 
		}
 
		//$sql = "select d.BUYER_NAME,e.GROUPING,b.PO_BREAK_DOWN_ID,sum((b.requirment/b.PCS)*c.PLAN_CUT_QNTY) as REQUIRMENT from wo_pre_cos_fab_co_avg_con_dtls b,WO_PO_COLOR_SIZE_BREAKDOWN c,WO_PO_DETAILS_MASTER d,WO_PO_BREAK_DOWN e  WHERE b.po_break_down_id=e.id and e.job_id=d.id and  c.id=b.COLOR_SIZE_TABLE_ID  and b.po_break_down_id =$po_id  and b.status_active =1 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 group by d.BUYER_NAME,e.GROUPING,b.PO_BREAK_DOWN_ID";

		$sql = "SELECT a.job_no, a.BUYER_NAME,b.GROUPING,b.id as PO_BREAK_DOWN_ID,sum(c.ORDER_QUANTITY) as REQUIRMENT from WO_PO_DETAILS_MASTER a,WO_PO_BREAK_DOWN b,WO_PO_COLOR_SIZE_BREAKDOWN c WHERE a.id=b.job_id and b.job_id=c.job_id and b.id=c.PO_BREAK_DOWN_ID and b.id =$po_id and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 group by a.job_no,a.BUYER_NAME,b.GROUPING,b.id ";
		// echo $sql;

		$result = sql_select( $sql );
		$po_data_arr = array();
		foreach( $result as $row ) 
		{
			$po_data_arr[$row['PO_BREAK_DOWN_ID']]=[
				'REQUIRMENT' => $row['REQUIRMENT'],
				'BUYER_NAME' => $row['BUYER_NAME'],
				'GROUPING' => $row['GROUPING'],
				'JOB_NO' => $row['JOB_NO'],
			];
            
		}
        
		
		

		?>
		 

		 <div id="gvMain">
		 <table border="1" rules="all"  cellspacing="0" cellpadding="0" class="rpt_table">
				 	<thead>
					<tr>
						<th width="150">Target&nbsp;Qty</th>
						<th width="100">Plan&nbsp;Qty</th>
						<th width="100">Plan&nbsp;Bal</th>
						<?php
						foreach ($dayArr as $key => $value) {
							echo "<th width='55'>$value</th>";
						}
						?>
					</tr>
					</thead>
			 
				<?php
				$rowKeyArr=array();
				foreach($po_data_arr as $po_id => $rows){
				$rowKeyArr[] = $po_id;
                $costingPer     =  $costPerArr[$rows['JOB_NO']];
                if($task_id==267)//print
                {
                    // echo $emblishment_costing_arr[$po_id][1]."*".$costingPer;
                    $req_qty = ($emblishment_costing_arr[$po_id][1]*$costingPer);
                    $rows['REQUIRMENT'] = $req_qty;
                }
                if($task_id==268)//print 
                {
                    $req_qty = ($emblishment_costing_arr[$po_id][2]*$costingPer);
                    $rows['REQUIRMENT'] = $req_qty;
                }
                if($task_id==90)//print 
                {
                    $req_qty = ($emblishment_costing_arr_name[$po_id][3]*$costingPer);
                    $rows['REQUIRMENT'] = $req_qty;
                }
				?>
				<tr>
					<td align="right" id="req_qty_td_<?=$po_id;?>"><?= round($rows['REQUIRMENT']);?></td>
					<td align="right" id="plan_qty_td_<?=$po_id;?>"><?= round(array_sum($tna_plan_target_arr));?></td>
					<td  align="right" id="plan_bal_td_<?=$po_id;?>"><?= round($rows['REQUIRMENT'] - array_sum($tna_plan_target_arr));?></td>
					<?php
						$allDayKey = implode('*',array_keys($dayArr));
						foreach ($dayArr as $key => $value) {
							?>
							<td><input disabled type="text" id="targetQty_<?=$po_id.'_'.$key;?>" onkeyup="calculate_day_val('<?=$po_id;?>','<?=$key;?>','<?=$allDayKey;?>',<?=$task_id;?>)" value="<?= $tna_plan_target_arr[$po_id.$key];?>" class="text_boxes_numeric" style="width:40px;"></td>
							<?
						}
					?>
				</tr>

				<?php
					}
				?>
			 
			</table>
			</div>
			<? 

			
	}

	else if($task_id == 48){

		//'fabrics','yarns','washes','emblishments','trims'
		load_class('../../../',['yarns']);
		
		//---class
		$condition= new condition();
		if(trim($po_id) !=''){
			$condition->po_id(" =$po_id");
		}
		$condition->init();
		$yarn= new yarn($condition);
        //echo $yarn->getQuery();
		$yarn_data_arr = $yarn->getOrderCountAndCompositionWiseYarnQtyArray();



			$yarn_sql_array=sql_select("SELECT  a.COUNT_ID, a.COPM_ONE_ID, sum (b.grey_fab_qnty*a.cons_ratio/100) AS GREY_REQ FROM wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b WHERE a.status_active=1 and a.is_deleted=0  and b.status_active=1 and b.is_deleted=0 and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no=b.job_no and b.PO_BREAK_DOWN_ID=$po_id  and b.IS_SHORT=1 GROUP BY a.count_id, a.copm_one_id");
			$short_req_data_arr=array();
			foreach($yarn_sql_array as $row){
				$key = $row['COUNT_ID'].'_'.$row['COPM_ONE_ID'];
				$short_req_data_arr[$key] += $row['GREY_REQ'];
		}


		$req_data_arr=array();$count_id_arr=array();$composition_id_arr=array();
		foreach($yarn_data_arr[$po_id] as $count_id => $compositionArr){
			foreach($compositionArr as $composition_id => $reqQty){
				$key = $count_id.'_'.$composition_id;
				$req_data_arr[$key] = [
					'COUNT_ID' => $count_id,
					'COMPOSITION_ID' => $composition_id,
					'REQUIRMENT' => $reqQty
				];

				$count_id_arr[$count_id] = $count_id;
				$composition_id_arr[$composition_id] = $composition_id;
			}
		}


		$lib_count_arr=return_library_array( "select ID,YARN_COUNT from LIB_YARN_COUNT where is_deleted = 0 and status_active = 1 and id in(".implode(',',$count_id_arr).")",'ID','YARN_COUNT');

		$lib_comp_arr=return_library_array( "select ID,COMPOSITION_NAME from LIB_COMPOSITION_ARRAY where  is_deleted = 0 and status_active = 1 and id in(".implode(',',$composition_id_arr).")",'ID','COMPOSITION_NAME');



		$tna_plan_target_sql = "select COUNT_ID,COMPOSITION_ID,TNA_MST_ID,TASK_ID,TASK_TYPE, PO_ID,PLAN_QTY,PLAN_DATE, STATUS_ACTIVE,IS_DELETED,INSERTED_BY,INSERT_DATE  from TNA_PLAN_TARGET where  PO_ID=$po_id and TASK_ID=$task_id and task_type=1 and PLAN_DATE between '$plan_start_date' and '$plan_finish_date'";
		//echo $tna_plan_target_sql;
		$tna_plan_target_sql_res = sql_select( $tna_plan_target_sql );
		$tna_plan_target_arr = array();
		foreach( $tna_plan_target_sql_res as $row ) 
		{
			$dmyKey = date('dmY', strtotime($row['PLAN_DATE']));
			$tna_plan_target_arr[$row['COUNT_ID'].'_'.$row['COMPOSITION_ID']][$dmyKey] = $row['PLAN_QTY']; 
		}

	

		?>
		<div id="gvMain">
		<table border="1" rules="all" cellspacing="0" cellpadding="0" class="rpt_table">
			<thead>
				<tr>
					<th>Composition&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
					<th width="100">Count</th>
					<th width="100">Main&nbsp;Req</th>
					<th width="60">Exc&nbsp;Req</th>
					<th width="60">Total&nbsp;Req</th>
					<th width="60">Plan&nbsp;Qty </th>
					<th width="60">Plan&nbsp;Bal </th>
				<?php
					foreach ($dayArr as $key => $value) {
						echo "<th width='55'>$value</th>";
					}
				?>
				</tr>
			</thead>
		<?php
		$allDayKey = implode('*',array_keys($dayArr));
		$rowKeyArr = array();
		$dateWiseSumArr = array();
        $main_req = 0;
        $excess_req = 0;
        $tot_req = 0;
        $tot_plan_req = 0;
        $tot_plan_bal = 0;
		foreach($req_data_arr as $count_composition_id_key => $rows)
        {
			$rowKeyArr[] = $count_composition_id_key;
		?>
			<tr>
				<td align="left" id="component_id<?= $count_composition_id_key;?>" title="<?= $rows['COMPOSITION_ID'];?>">
					<?= $lib_comp_arr[$rows['COMPOSITION_ID']];?>
				</td>
				<td align="right" id="count_id<?= $count_composition_id_key;?>" title="<?= $rows['COUNT_ID'];?>">
					<?= $lib_count_arr[$rows['COUNT_ID']];?>
				</td>
				<td align="right"><?= round($rows['REQUIRMENT']);?></td>
				<td align="right"><?= round($short_req_data_arr[$count_composition_id_key]);?></td>
				<td align="right" id="req_qty_td_<?=$count_composition_id_key;?>"><?= $total_req = round($rows['REQUIRMENT'] + $short_req_data_arr[$count_composition_id_key]);?></td>
				<td align="right" id="plan_qty_td_<?=$count_composition_id_key;?>"><?= round(array_sum($tna_plan_target_arr[$count_composition_id_key]));?></td>
				<td align="right" id="plan_bal_td_<?=$count_composition_id_key;?>"><?= round($total_req - array_sum($tna_plan_target_arr[$count_composition_id_key]));?></td>
				<?php
				foreach ($dayArr as $key => $value) 
                {
                    ?>
                        <td>
                            <input disabled type="text" id="targetQty_<?=$count_composition_id_key.'_'.$key;?>" onkeyup="calculate_day_val('<?=$count_composition_id_key;?>','<?=$key;?>','<?=$allDayKey;?>',<?=$task_id;?>)" value="<?= $tna_plan_target_arr[$count_composition_id_key][$key];?>" class="text_boxes_numeric" style="width:50px;">
                        </td>
                    <?php
                    $dateWiseSumArr[$key] += $tna_plan_target_arr[$count_composition_id_key][$key];
				}
				?>
			</tr>
		<?php
         $main_req += $rows['REQUIRMENT'];
         $excess_req += $short_req_data_arr[$count_composition_id_key];
         $tot_req += $rows['REQUIRMENT'] + $short_req_data_arr[$count_composition_id_key];
         $tot_plan_req += array_sum($tna_plan_target_arr[$count_composition_id_key]);
         $tot_plan_bal += $total_req - array_sum($tna_plan_target_arr[$count_composition_id_key]);
		}
		?>
            <tfoot>
                <tr>
                    <th>Total</th>
                    <th></th>
                    <th><?=fn_number_format($main_req,0);?></th>
                    <th><?=fn_number_format($excess_req,0);?></th>
                    <th><?=fn_number_format($tot_req,0);?></th>
                    <th><?=fn_number_format($tot_plan_req,0);?></th>
                    <th><?=fn_number_format($tot_plan_bal,0);?></th>
                    <?php
                    foreach ($dayArr as $key => $value) 
                    {
                        ?>
                            <td>
                                <input disabled type="text"  value="<?= $dateWiseSumArr[$key];?>" class="text_boxes_numeric" style="width:50px;">
                            </td>
                        <?php
                    }
                    ?>
                </tr>
            </tfoot>
		</table>
		</div>
		
		

		<?
		exit();

	}
	else if($task_id == 70 || $task_id == 71){
	

			//'fabrics','yarns','washes','emblishments','trims'
			load_class('../../../',['trims']);
			
			//---class
			$condition= new condition();
			if(trim($po_id) !=''){
				$condition->po_id(" =$po_id");
			}	
			$condition->init();
			$trims = new trims($condition);
			$trims_data_arr = $trims->getQtyArray_by_orderAndItemidTypeid();

			//print_r($trims_data_arr[$po_id]);die;

			$trims_type = ($task_id == 70)?1:2;

			$req_data_arr=array();$type_id_arr=array();$item_id_arr=array();
			foreach($trims_data_arr[$po_id] as $item_id => $typeDataArr){
				foreach($typeDataArr as $type_id => $reqQty){
					if($trims_type === $type_id){
						$key = $type_id.'_'.$item_id;
						$req_data_arr[$key] = [
							'TYPE_ID' => $type_id,
							'ITEM_ID' => $item_id,
							'REQUIRMENT' => $reqQty
						];

						$type_id_arr[$type_id] = $type_id;
						$item_id_arr[$item_id] = $item_id;
						$type_id_by_trims_group_id_arr[$item_id] = $type_id;
					}

				}
			}


					
			 $yarn_sql_array = sql_select("select a.TRIM_GROUP,sum(b.requirment) as CONS from wo_booking_dtls a, wo_trim_book_con_dtls b  where a.id= b.wo_trim_booking_dtls_id  and a.booking_no=b.booking_no   and a.PO_BREAK_DOWN_ID =$po_id   and a.sensitivity=0 and a.status_active=1 and a.is_deleted=0 o and a.is_short=1 and b.status_active=1 and b.is_deleted=0  group by a.trim_group ");

 
			 
			//echo $yarn_sql_array;die;
			$short_req_data_arr=array();
			foreach($yarn_sql_array as $row){
				$row['TYPE_ID'] = $type_id_by_trims_group_id_arr[$row['TRIM_GROUP']];
				$key = $row['TYPE_ID'].'_'.$row['TRIM_GROUP'];
				$short_req_data_arr[$key] += $row['CONS'];
		   }

		  // print_r($short_req_data_arr);




			$lib_trims_group_arr=return_library_array( "select ID,ITEM_NAME from LIB_ITEM_GROUP where is_deleted = 0 and status_active = 1 and id in(".implode(',',$item_id_arr).")",'ID','ITEM_NAME');
			$lib_trims_uom_arr=return_library_array( "select ID,TRIM_UOM from LIB_ITEM_GROUP where is_deleted = 0 and status_active = 1 and id in(".implode(',',$item_id_arr).")",'ID','TRIM_UOM');


			$tna_plan_target_sql = "select TYPE_ID,ITEM_ID,TNA_MST_ID,TASK_ID,TASK_TYPE, PO_ID,PLAN_QTY,PLAN_DATE, STATUS_ACTIVE,IS_DELETED,INSERTED_BY,INSERT_DATE  from TNA_PLAN_TARGET where  PO_ID=$po_id and TASK_ID=$task_id and task_type=1 and PLAN_DATE between '$plan_start_date' and '$plan_finish_date'";
			//echo $tna_plan_target_sql;
			$tna_plan_target_sql_res = sql_select( $tna_plan_target_sql );
			$tna_plan_target_arr = array();
			foreach( $tna_plan_target_sql_res as $row ) 
			{
				$dmyKey = date('dmY', strtotime($row['PLAN_DATE']));
				$tna_plan_target_arr[$row['TYPE_ID'].'_'.$row['ITEM_ID']][$dmyKey] = $row['PLAN_QTY']; 
			}

			//......................
			// $total_day = datediff('d', $txt_plan_start_date,$txt_plan_finish_date);
			// $dayArr=array();
			// $dformat = "d-M";
			// for($i=0; $i < $total_day; $i++){
			// 	$day = date($dformat, strtotime($txt_plan_start_date. " + $i day"));
			// 	$dmyKey = date('dmY', strtotime($txt_plan_start_date. " + $i day"));
			// 	$dayArr[$dmyKey] = $day;
			// }
			// $colspan = count($dayArr) + 8;
			//..........................


		?>
		<div id="gvMain">
		<table border="1" rules="all" cellspacing="0" cellpadding="0" class="rpt_table">
			<thead>
				<tr>
					<th width="100">Acc&nbsp;Type</th>
					<th width="150">Item&nbsp;Name</th>
					<th width="100">Unit</th>
					<th width="60">Main&nbsp;Req</th>
					<th width="60">Exc&nbsp;Req</th>
					<th width="60">Total&nbsp;Req</th>
					<th width="60">Plan&nbsp;Qty </th>
					<th width="60">Plan&nbsp;Bal</th>
				<?php
					foreach ($dayArr as $key => $value) {
						echo "<th width='45'>$value</th>";
					}
				?>
				</tr>
			</thead>
			<tbody>
		<?php
		$allDayKey = implode('*',array_keys($dayArr));
		$rowKeyArr = array();
		foreach($req_data_arr as $type_item_id_key => $rows){
			$rowKeyArr[] = $type_item_id_key;
		?>
			<tr>
				<td id="type_id<?= $type_item_id_key;?>" title="<?= $rows['TYPE_ID'];?>">
					<?= $trim_type[$rows['TYPE_ID']];?>
				</td>
				<td id="item_id<?= $type_item_id_key;?>" title="<?= $rows['ITEM_ID'];?>">
					<?= $lib_trims_group_arr[$rows['ITEM_ID']];?>
				</td>
				<td align="center"><?= $unit_of_measurement[$lib_trims_uom_arr[$rows['ITEM_ID']]];?></td>
				<td align="right"><?= round($rows['REQUIRMENT']);?></td>
				<td align="right"><?= round($short_req_data_arr[$type_item_id_key]);?></td>
				<td align="right" id="req_qty_td_<?=$type_item_id_key;?>"><?= $total_req = round($rows['REQUIRMENT'] + $short_req_data_arr[$type_item_id_key]);?></td>
				<td align="right" id="plan_qty_td_<?=$type_item_id_key;?>"><?= round(array_sum($tna_plan_target_arr[$type_item_id_key]));?></td>
				<td align="right" id="plan_bal_td_<?=$type_item_id_key;?>"><?= round($total_req - array_sum($tna_plan_target_arr[$type_item_id_key]));?></td>
				<?php
				foreach ($dayArr as $key => $value) {
				?>
					<td>
						<input disabled type="text" id="targetQty_<?=$type_item_id_key.'_'.$key;?>" onkeyup="calculate_day_val('<?=$type_item_id_key;?>','<?=$key;?>','<?=$allDayKey;?>',<?=$task_id;?>)" value="<?= $tna_plan_target_arr[$type_item_id_key][$key];?>" class="text_boxes_numeric" style="width:50px;">
					</td>
				<?php
				}
				?>
			</tr>
			</tbody>
		<?php
		}
		?>
		</table>

		<?

	}
	else if($task_id == 73){

		//'fabrics','yarns','washes','emblishments','trims'
		load_class('../../../',['fabrics']);
		
		//---class
		$condition= new condition();
		if(trim($po_id) !=''){
			$condition->po_id(" =$po_id");
		}
		$condition->init();
		$fabric = new fabric($condition);
		$fabric_data_arr = $fabric->getQtyArray_by_orderAndFabricSource_knitAndwoven_greyAndfinish();


		 $yarn_sql_array=sql_select("SELECT a.FABRIC_SOURCE,a.UOM,  b.FIN_FAB_QNTY FROM wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b WHERE  a.job_no=b.job_no and a.id=b.PRE_COST_FABRIC_COST_DTLS_ID and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.PO_BREAK_DOWN_ID=$po_id and b.IS_SHORT=1 ");
		 $short_req_data_arr=array();
		 foreach($yarn_sql_array as $row){
				$key = $row['FABRIC_SOURCE'].'_'.$row['UOM'];
				$short_req_data_arr[$key] += $row['FIN_FAB_QNTY'];
		}
		//print_r($short_req_data_arr);

		
		$req_data_arr=array();//$source_id_arr=array();$uom_id_arr=array();
		foreach($fabric_data_arr['knit']['finish'][$po_id] as $source_id => $uomArr){
			foreach($uomArr as $uom_id => $reqQty){
				$key = $source_id.'_'.$uom_id;
				$req_data_arr[$key] = [
					'SOURCE_ID' => $source_id,
					'UOM_ID' => $uom_id,
					'REQUIRMENT' => $reqQty
				];

				//$source_id_arr[$source_id] = $source_id;
				//$uom_id_arr[$uom_id] = $uom_id;
			}
		}



		$tna_plan_target_sql = "select SOURCE_ID,UOM_ID,TNA_MST_ID,TASK_ID,TASK_TYPE, PO_ID,PLAN_QTY,PLAN_DATE, STATUS_ACTIVE,IS_DELETED,INSERTED_BY,INSERT_DATE  from TNA_PLAN_TARGET where  PO_ID=$po_id and TASK_ID=$task_id and task_type=1 and PLAN_DATE between '$plan_start_date' and '$plan_finish_date'";
		//echo $tna_plan_target_sql;
		$tna_plan_target_sql_res = sql_select( $tna_plan_target_sql );
		$tna_plan_target_arr = array();
		foreach( $tna_plan_target_sql_res as $row ) 
		{
			$dmyKey = date('dmY', strtotime($row['PLAN_DATE']));
			$tna_plan_target_arr[$row['SOURCE_ID'].'_'.$row['UOM_ID']][$dmyKey] = $row['PLAN_QTY']; 
		}

		//......................
		// $total_day = datediff('d', $txt_plan_start_date,$txt_plan_finish_date);
		// $dayArr=array();
		// $dformat = "d-M";
		// for($i=0; $i < $total_day; $i++){
		// 	$day = date($dformat, strtotime($txt_plan_start_date. " + $i day"));
		// 	$dmyKey = date('dmY', strtotime($txt_plan_start_date. " + $i day"));
		// 	$dayArr[$dmyKey] = $day;
		// }
		// $colspan = count($dayArr) + 7;
		//..........................
			?>
			<div id="gvMain">
			<table border="1" rules="all" cellspacing="0" cellpadding="0" class="rpt_table">
				<thead>
					<tr>
						<th width="80">Fab.&nbsp;Source</th>
						<th width="60">Unit</th>
						<th width="100">Main&nbsp;Req</th>
						<th width="60">Exc&nbsp;Req</th>
						<th width="60">Total&nbsp;Req</th>
						<th width="60">Plan&nbsp;Qty </th>
						<th width="60">Plan&nbsp;Bal </th>
					<?php
						foreach ($dayArr as $key => $value) {
							echo "<th width='55'>$value</th>";
						}
					?>
					</tr>
				</thead>
			<?php
			$allDayKey = implode('*',array_keys($dayArr));
			$rowKeyArr = array();
			foreach($req_data_arr as $source_uom_id_key => $rows){
				$rowKeyArr[] = $source_uom_id_key;
			?>
				<tr>
					<td align="left" id="source_id<?= $source_uom_id_key;?>" title="<?= $rows['SOURCE_ID'];?>">
						<?= $fabric_source[$rows['SOURCE_ID']];?>
					</td>
					<td align="center" id="uom_id<?= $source_uom_id_key;?>" title="<?= $rows['UOM_ID'];?>">
						<?= $unit_of_measurement[$rows['UOM_ID']];?>
					</td>
					<td align="right"><?= round($rows['REQUIRMENT']);?></td>
					<td align="right"><?= round($short_req_data_arr[$source_uom_id_key]);?></td>
					<td align="right" id="req_qty_td_<?=$source_uom_id_key;?>"><?= $total_req = round($rows['REQUIRMENT'] + $short_req_data_arr[$source_uom_id_key]);?></td>
					<td align="right" id="plan_qty_td_<?=$source_uom_id_key;?>"><?= round(array_sum($tna_plan_target_arr[$source_uom_id_key]));?></td>
					<td align="right" id="plan_bal_td_<?=$source_uom_id_key;?>"><?= round($total_req - array_sum($tna_plan_target_arr[$source_uom_id_key]));?></td>
					<?php
					foreach ($dayArr as $key => $value) {
					?>
						<td>
							<input disabled type="text" id="targetQty_<?=$source_uom_id_key.'_'.$key;?>" onkeyup="calculate_day_val('<?=$source_uom_id_key;?>','<?=$key;?>','<?=$allDayKey;?>',<?=$task_id;?>)" value="<?= $tna_plan_target_arr[$source_uom_id_key][$key];?>" class="text_boxes_numeric" style="width:50px;">
						</td>
					<?php
					}
					?>
				</tr>
			<?php
			}
			?>
			</table>
			</div>
				

			<?
			exit();
	}

	else if($task_id == 63)
	{

		
		//'fabrics','yarns','washes','emblishments','trims'
		load_class('../../../',['fabrics']);
	
		//---class
		$condition= new condition();
		if(trim($po_id) !=''){
			$condition->po_id(" =$po_id");
		}
		$condition->init();
		$fabric = new fabric($condition);
		// $fabric_data_arr = $fabric->getQtyArray_by_orderColorType_knitAndwoven_greyAndfinish();
        $fabric_data_arr = $fabric->getQtyArray_by_orderAndColorTypeFabricSource_knitAndwoven_greyAndfinish();
		
		$yarn_sql_array=sql_select("SELECT b.FIN_FAB_QNTY FROM wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b WHERE  a.job_no=b.job_no and a.id=b.PRE_COST_FABRIC_COST_DTLS_ID and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.PO_BREAK_DOWN_ID=$po_id and b.IS_SHORT=1 and a.color_type_id in (2,3,4,6,5) ");
		$short_req_data_arr=0;
		foreach($yarn_sql_array as $row){
			   $short_req_data_arr += $row['FIN_FAB_QNTY'];
	   }


		$tna_plan_target_sql = "select TNA_MST_ID,TASK_ID,TASK_TYPE, PO_ID,PLAN_QTY,PLAN_DATE, STATUS_ACTIVE,IS_DELETED,INSERTED_BY,INSERT_DATE  from TNA_PLAN_TARGET where  PO_ID=$po_id and TASK_ID=$task_id and task_type=1 and PLAN_DATE between '$plan_start_date' and '$plan_finish_date'";
		 //echo $tna_plan_target_sql;
		$tna_plan_target_sql_res = sql_select( $tna_plan_target_sql );
		$tna_plan_target_arr = array();
		foreach( $tna_plan_target_sql_res as $row ) 
		{
			$dmyKey = date('dmY', strtotime($row['PLAN_DATE']));
			$tna_plan_target_arr[$row['PO_ID']][$dmyKey] = $row['PLAN_QTY']; 
		}




		$po_data_arr[$po_id]['REQUIRMENT']=array_sum($fabric_data_arr['knit']['finish'][$po_id][5][1]);


		?>
		<div id="gvMain">
		 <table border="1" rules="all"  cellspacing="0" cellpadding="0" class="rpt_table">
				<thead>
				<tr>
					<th width="80">Main&nbsp;Req</th>
					<th width="80">Exc&nbsp;Req</th>
					<th width="80">Target&nbsp;Qty</th>
					<th width="80">Plan&nbsp;Qty</th>
					<th width="80">Plan&nbsp;Bal</th>
					<?php
					foreach ($dayArr as $key => $value) {
						echo "<th width='55'>$value</th>";
					}
					?>
				</tr>
				</thead>
			 
				<?php
				$rowKeyArr=array();
				foreach($po_data_arr as $po_id => $rows){
				$rowKeyArr[] = $po_id;
				$rows['EXC_REQUIRMENT'] = $short_req_data_arr;
				?>
				<tr>
					<td align="right"><?= round($rows['REQUIRMENT']);?></td>
					<td align="right"><?= round($rows['EXC_REQUIRMENT']);?></td>


					<td align="right" id="req_qty_td_<?=$po_id;?>"><?= round($rows['REQUIRMENT']+$rows['EXC_REQUIRMENT']);?></td>
					<td align="right" id="plan_qty_td_<?=$po_id;?>"><?= round(array_sum($tna_plan_target_arr[$po_id]));?></td>
					<td align="right" id="plan_bal_td_<?=$po_id;?>"><?= round($rows['REQUIRMENT'] - array_sum($tna_plan_target_arr[$po_id]));?></td>
					<?php
						$allDayKey = implode('*',array_keys($dayArr));
						foreach ($dayArr as $key => $value) {
							?>
							<td width='55'><input disabled type="text" id="targetQty_<?=$po_id.'_'.$key;?>" onkeyup="calculate_day_val('<?=$po_id;?>','<?=$key;?>','<?=$allDayKey;?>',<?=$task_id;?>)" value="<?= $tna_plan_target_arr[$po_id][$key];?>" class="text_boxes_numeric" style="width:40px;"></td>
							<?
						}
					?>
				</tr>

				<?php
					}
				?>
			 
			</table>
			</div>
			<? 

		exit();
	}

	else if($task_id == 61)
	{

		//'fabrics','yarns','washes','emblishments','trims'
		load_class('../../../',['fabrics']);
		//---class
		$condition= new condition();
		if(trim($po_id) !=''){
			$condition->po_id(" =$po_id");
		}
		$condition->init();
		$fabric = new fabric($condition);

		$fabric_data_arr = $fabric->getQtyArray_by_orderAndFabricSource_knitAndwoven_greyAndfinish();


		$yarn_sql_array=sql_select("SELECT b.GREY_FAB_QNTY FROM wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b WHERE  a.job_no=b.job_no and a.id=b.PRE_COST_FABRIC_COST_DTLS_ID and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.PO_BREAK_DOWN_ID=$po_id and b.IS_SHORT=1 and a.FABRIC_SOURCE =1 ");
		$short_req_data_arr=0;
		foreach($yarn_sql_array as $row){
			   $short_req_data_arr += $row['GREY_FAB_QNTY'];
	   }



		$tna_plan_target_sql = "select TNA_MST_ID,TASK_ID,TASK_TYPE, PO_ID,PLAN_QTY,PLAN_DATE, STATUS_ACTIVE,IS_DELETED,INSERTED_BY,INSERT_DATE  from TNA_PLAN_TARGET where  PO_ID=$po_id and TASK_ID=$task_id and task_type=1 and PLAN_DATE between '$plan_start_date' and '$plan_finish_date'";
		 //echo $tna_plan_target_sql;
		$tna_plan_target_sql_res = sql_select( $tna_plan_target_sql );
		$tna_plan_target_arr = array();
		foreach( $tna_plan_target_sql_res as $row ) 
		{
			$dmyKey = date('dmY', strtotime($row['PLAN_DATE']));
			$tna_plan_target_arr[$row['PO_ID']][$dmyKey] = $row['PLAN_QTY']; 
		}


		$po_data_arr[$po_id]['REQUIRMENT'] = array_sum($fabric_data_arr['knit']['grey'][$po_id][1]);


		?>
		<div id="gvMain">
		 <table border="1" rules="all"  cellspacing="0" cellpadding="0" class="rpt_table">
				<thead>
				<tr>
					<th width="80">Main&nbsp;Req</th>
					<th width="80">Exc&nbsp;Req</th>
					<th width="80">Target&nbsp;Qty</th>
					<th width="80">Plan&nbsp;Qty</th>
					<th width="80">Plan&nbsp;Bal</th>
					<?php
					foreach ($dayArr as $key => $value) {
						echo "<th width='55'>$value</th>";
					}
					?>
				</tr>
				</thead>
			 
				<?php
				$rowKeyArr=array();
				foreach($po_data_arr as $po_id => $rows){
				$rowKeyArr[] = $po_id;
				$rows['EXC_REQUIRMENT'] = $short_req_data_arr;
				?>
				<tr>
					<td align="right"><?= round($rows['REQUIRMENT']);?></td>
					<td align="right"><?= round($rows['EXC_REQUIRMENT']);?></td>
					<td align="right" id="req_qty_td_<?=$po_id;?>"><?= round($rows['REQUIRMENT']+$rows['EXC_REQUIRMENT']);?></td>
					<td align="right" id="plan_qty_td_<?=$po_id;?>"><?= round(array_sum($tna_plan_target_arr[$po_id]));?></td>
					<td align="right" id="plan_bal_td_<?=$po_id;?>"><?= round($rows['REQUIRMENT'] - array_sum($tna_plan_target_arr[$po_id]));?></td>
					<?php
						$allDayKey = implode('*',array_keys($dayArr));
						foreach ($dayArr as $key => $value) {
							?>
							<td><input disabled type="text" id="targetQty_<?=$po_id.'_'.$key;?>" onkeyup="calculate_day_val('<?=$po_id;?>','<?=$key;?>','<?=$allDayKey;?>',<?=$task_id;?>)" value="<?= $tna_plan_target_arr[$po_id][$key];?>" class="text_boxes_numeric" style="width:40px;"></td>
							<?
						}
					?>
				</tr>

				<?php
					}
				?>
			 
			</table>
			</div>
			<? 

		exit();
	}

	else if($task_id == 52)
    {
		$sql_array=sql_select("SELECT c.id as PO_ID,b.STRIPE_COLOR,sum(b.FABREQTOTKG) as QTY from WO_PRE_COST_FABRIC_COST_DTLS a,WO_PRE_STRIPE_COLOR b,WO_PO_BREAK_DOWN c where a.id=b.PRE_COST_FABRIC_COST_DTLS_ID and a.JOB_NO=c.job_no_mst and c.id=$po_id and a.COLOR_TYPE_ID in(2,3,4,6,5) and a.IS_DELETED=0 and a.STATUS_ACTIVE=1 and a.FABRIC_SOURCE=1 and b.IS_DELETED=0 and b.STATUS_ACTIVE=1 and b.yarn_dyed=1 group by c.id,b.STRIPE_COLOR");
		$req_data_arr=array();$strip_color_id_arr=array();
		foreach($sql_array as  $row){
				$req_data_arr[$row['STRIPE_COLOR']] = [
					'STRIPE_COLOR' => $row['STRIPE_COLOR'],
					'REQUIRMENT' => $row['QTY'],
					'PO_ID' => $row['PO_ID']
				];
				$strip_color_id_arr[$row['STRIPE_COLOR']] = $row['STRIPE_COLOR'];
		}


		$color_library=return_library_array( "select id,color_name from lib_color where id in(".implode(',',$strip_color_id_arr).")", "id", "color_name" );


		$tna_plan_target_sql = "SELECT COLOUR_ID,TNA_MST_ID,TASK_ID,TASK_TYPE, PO_ID,PLAN_QTY,PLAN_DATE, STATUS_ACTIVE,IS_DELETED,INSERTED_BY,INSERT_DATE  from TNA_PLAN_TARGET where PO_ID=$po_id and TASK_ID=$task_id and task_type=1 and PLAN_DATE between '$plan_start_date' and '$plan_finish_date'";
		//echo $tna_plan_target_sql;
		$tna_plan_target_sql_res = sql_select( $tna_plan_target_sql );
		$tna_plan_target_arr = array();
		foreach( $tna_plan_target_sql_res as $row ) 
		{
			$dmyKey = date('dmY', strtotime($row['PLAN_DATE']));
			$tna_plan_target_arr[$row['COLOUR_ID']][$dmyKey] = $row['PLAN_QTY']; 
		}

       /*  load_class('../../../',['conversions']);
		$condition= new condition();
		if(trim($po_id) !=''){
			$condition->po_id(" =$po_id");
		}
		$condition->init();
		$conversion= new conversion($condition);
        $conversion_costing_arr=$conversion->getQtyArray_by_orderAndProcess();	 */

		?>
		<div id="gvMain">
		<table border="1" rules="all" cellspacing="0" cellpadding="0" class="rpt_table">
			<thead>
				<tr>
					<th width="100">Yarn&nbsp;Color&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
					<th width="100">Main&nbsp;Req</th>
					<th width="60">Exc&nbsp;Req</th>
					<th width="60">Total&nbsp;Req</th>
					<th width="60">Plan&nbsp;Qty </th>
					<th width="60">Plan&nbsp;Bal </th>
				<?php
					foreach ($dayArr as $key => $value) {
						echo "<th width='55'>$value</th>";
					}
				?>
				</tr>
			</thead>
		<?php
		$allDayKey = implode('*',array_keys($dayArr));
		$rowKeyArr = array();
        $dateWiseSumArr = array();
        $main_req = 0;
        $excess_req = 0;
        $tot_req = 0;
        $tot_plan_req = 0;
        $tot_plan_bal = 0;
		foreach($req_data_arr as $strip_color_id_key => $rows){
			$rowKeyArr[] = $strip_color_id_key;
		?>
			<tr>
				<td align="left" id="yarn_color_id<?= $strip_color_id_key;?>" title="<?= $rows['STRIPE_COLOR'];?>">
					<?= $color_library[$rows['STRIPE_COLOR']];?>
				</td>
				<td align="right"><?= round($rows['REQUIRMENT']);?></td>
				<td align="right"><?= round($short_req_data_arr[$strip_color_id_key]);?></td>
				<td align="right" id="req_qty_td_<?=$strip_color_id_key;?>"><?= $total_req = round($rows['REQUIRMENT'] + $short_req_data_arr[$strip_color_id_key]);?></td>
				<td align="right" id="plan_qty_td_<?=$strip_color_id_key;?>"><?= round(array_sum($tna_plan_target_arr[$strip_color_id_key]));?></td>
				<td align="right" id="plan_bal_td_<?=$strip_color_id_key;?>"><?= round($total_req - array_sum($tna_plan_target_arr[$strip_color_id_key]));?></td>
				<?php
				foreach ($dayArr as $key => $value) {
				?>
					<td>
						<input disabled type="text" id="targetQty_<?=$strip_color_id_key.'_'.$key;?>" onkeyup="calculate_day_val('<?=$strip_color_id_key;?>','<?=$key;?>','<?=$allDayKey;?>',<?=$task_id;?>)" value="<?= $tna_plan_target_arr[$strip_color_id_key][$key];?>" class="text_boxes_numeric" style="width:50px;">
					</td>
				<?php
                
                    $dateWiseSumArr[$key] += $tna_plan_target_arr[$strip_color_id_key][$key];
				}
				?>
			</tr>
		<?php        
            $main_req += $rows['REQUIRMENT'];
            $excess_req += $short_req_data_arr[$count_composition_id_key];
            $tot_req += $rows['REQUIRMENT'] + $short_req_data_arr[$count_composition_id_key];
            $tot_plan_req += array_sum($tna_plan_target_arr[$strip_color_id_key]);
            $tot_plan_bal += $total_req - array_sum($tna_plan_target_arr[$strip_color_id_key]);
		}
		?>
        <tfoot>
                <tr>
                    <th>Total</th>
                    <th><?=fn_number_format($main_req,0);?></th>
                    <th><?=fn_number_format($excess_req,0);?></th>
                    <th><?=fn_number_format($tot_req,0);?></th>
                    <th><?=fn_number_format($tot_plan_req,0);?></th>
                    <th><?=fn_number_format($tot_plan_bal,0);?></th>
                    <?php
                    foreach ($dayArr as $key => $value) 
                    {
                        ?>
                            <td>
                                <input disabled type="text"  value="<?= $dateWiseSumArr[$key];?>" class="text_boxes_numeric" style="width:50px;">
                            </td>
                        <?php
                    }
                    ?>
                </tr>
            </tfoot>
		</table>
		</div>

		<?
		exit();

	}

	else if($task_id == 60)
    {

		$yarn_sql_array=sql_select("SELECT a.LIB_YARN_COUNT_DETER_ID,b.GREY_FAB_QNTY FROM wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b WHERE  a.job_no=b.job_no and a.id=b.PRE_COST_FABRIC_COST_DTLS_ID and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.PO_BREAK_DOWN_ID=$po_id and b.IS_SHORT=1 and a.FABRIC_SOURCE=1 and a.FABRIC_SOURCE =1 ");
		$short_req_data_arr=array();
		foreach($yarn_sql_array as $row){
			   $short_req_data_arr[$row['LIB_YARN_COUNT_DETER_ID']] += $row['GREY_FAB_QNTY'];
	   }

		
		$yarn_sql_array=sql_select("select a.LIB_YARN_COUNT_DETER_ID as YARN_COUNT_DETER_ID,a.CONSTRUCTION,a.COMPOSITION,sum((b.requirment/b.PCS)*c.PLAN_CUT_QNTY) as REQUIRMENT from wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b,WO_PO_COLOR_SIZE_BREAKDOWN c WHERE c.id=b.COLOR_SIZE_TABLE_ID and a.id=b.PRE_COST_FABRIC_COST_DTLS_ID AND b.po_break_down_id=$po_id and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and a.FABRIC_SOURCE=1 group by a.LIB_YARN_COUNT_DETER_ID,a.CONSTRUCTION,a.COMPOSITION");


		$req_data_arr=array();
		foreach($yarn_sql_array as $row){
				$req_data_arr[$row['YARN_COUNT_DETER_ID']] = [
					'CONSTRUCTION' => $row['CONSTRUCTION'],
					'COMPOSITION' => $row['COMPOSITION'],
					'REQUIRMENT' => $row['REQUIRMENT'],
					'YARN_COUNT_DETER_ID' => $row['YARN_COUNT_DETER_ID']
				];
		}


		$tna_plan_target_sql = "select YARN_COUNT_DETER_ID,TNA_MST_ID,TASK_ID,TASK_TYPE, PO_ID,PLAN_QTY,PLAN_DATE, STATUS_ACTIVE,IS_DELETED,INSERTED_BY,INSERT_DATE  from TNA_PLAN_TARGET where  PO_ID=$po_id and TASK_ID=$task_id and task_type=1 and PLAN_DATE between '$plan_start_date' and '$plan_finish_date'";
		//echo $tna_plan_target_sql;
		$tna_plan_target_sql_res = sql_select( $tna_plan_target_sql );
		$tna_plan_target_arr = array();
		foreach( $tna_plan_target_sql_res as $row ) 
		{
			$dmyKey = date('dmY', strtotime($row['PLAN_DATE']));
			$tna_plan_target_arr[$row['YARN_COUNT_DETER_ID']][$dmyKey] = $row['PLAN_QTY']; 
		}

		//WO_PRE_COST_FABRIC_COST_DTLS

	

		?>
		<div id="gvMain">
		<table border="1" rules="all" cellspacing="0" cellpadding="0" class="rpt_table">
			<thead>
				<tr>
					<th width="150">Fabric&nbsp;Structure&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
					<th width="250">Composition&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
					<th width="60">Main&nbsp;Req</th>
					<th width="60">Exc&nbsp;Req</th>
					<th width="60">Total&nbsp;Req</th>
					<th width="60">Plan&nbsp;Qty </th>
					<th width="60">Plan&nbsp;Bal </th>
				<?php
					foreach ($dayArr as $key => $value) {
						echo "<th width='55'>$value</th>";
					}
				?>
				</tr>
			</thead>
		<?php
		$allDayKey = implode('*',array_keys($dayArr));
		$rowKeyArr = array();
        $dateWiseSumArr = array();
        $main_req = 0;
        $excess_req = 0;
        $tot_req = 0;
        $tot_plan_req = 0;
        $tot_plan_bal = 0;
		foreach($req_data_arr as $yarn_count_deter_id_key => $rows){
			$rowKeyArr[] = $yarn_count_deter_id_key;
		?>
			<tr>
				<td align="left" id="yarn_count_deter_id<?= $yarn_count_deter_id_key;?>" title="<?= $rows['YARN_COUNT_DETER_ID'];?>">
					<?= $rows['CONSTRUCTION'];?>
				</td>
				<td align="left"><p style="word-wrap: break-word;width:240px;"><?= wordwrap($rows['COMPOSITION'],45,"<br>\n");;?></p></td>
				<td align="right"><?= round($rows['REQUIRMENT']);?></td>
				<td align="right"><?= round($short_req_data_arr[$yarn_count_deter_id_key]);?></td>
				<td align="right" id="req_qty_td_<?=$yarn_count_deter_id_key;?>"><?= $total_req = round($rows['REQUIRMENT'] + $short_req_data_arr[$yarn_count_deter_id_key]);?></td>
				<td align="right" id="plan_qty_td_<?=$yarn_count_deter_id_key;?>"><?= round(array_sum($tna_plan_target_arr[$yarn_count_deter_id_key]));?></td>
				<td align="right" id="plan_bal_td_<?=$yarn_count_deter_id_key;?>"><?= round($total_req - array_sum($tna_plan_target_arr[$yarn_count_deter_id_key]));?></td>
				<?php
				foreach ($dayArr as $key => $value) {
				?>
					<td>
						<input disabled type="text" id="targetQty_<?=$yarn_count_deter_id_key.'_'.$key;?>" onkeyup="calculate_day_val('<?=$yarn_count_deter_id_key;?>','<?=$key;?>','<?=$allDayKey;?>',<?=$task_id;?>)" value="<?= $tna_plan_target_arr[$yarn_count_deter_id_key][$key];?>" class="text_boxes_numeric" style="width:50px;">
					</td>
				<?php
                $dateWiseSumArr[$key] += $tna_plan_target_arr[$yarn_count_deter_id_key][$key];
				}
				?>
			</tr>
		<?php        
        $main_req += $rows['REQUIRMENT'];
        $excess_req += $short_req_data_arr[$yarn_count_deter_id_key];
        $tot_req += $rows['REQUIRMENT'] + $short_req_data_arr[$yarn_count_deter_id_key];
        $tot_plan_req += array_sum($tna_plan_target_arr[$yarn_count_deter_id_key]);
        $tot_plan_bal += $total_req - array_sum($tna_plan_target_arr[$yarn_count_deter_id_key]);
		}
		?>
         <tfoot>
                <tr>
                    <th>Total</th>
                    <th></th>
                    <th><?=fn_number_format($main_req,0);?></th>
                    <th><?=fn_number_format($excess_req,0);?></th>
                    <th><?=fn_number_format($tot_req,0);?></th>
                    <th><?=fn_number_format($tot_plan_req,0);?></th>
                    <th><?=fn_number_format($tot_plan_bal,0);?></th>
                    <?php
                    foreach ($dayArr as $key => $value) 
                    {
                        ?>
                            <td>
                                <input disabled type="text"  value="<?= $dateWiseSumArr[$key];?>" class="text_boxes_numeric" style="width:50px;">
                            </td>
                        <?php
                    }
                    ?>
                </tr>
            </tfoot>
		</table>
		</div>


		<?
		exit();

	}

}

if($action=="open_unplan_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    extract($_REQUEST);
    // echo $buyer_id;
    if($task_id!="")
    {
        $sql = "SELECT a.job_no,b.po_number,b.id as po_id,b.grouping as internal_ref,c.TASK_NUMBER,c.TASK_START_DATE,c.TASK_FINISH_DATE from wo_po_details_master a,wo_po_break_down b,tna_process_mst c where a.id=b.job_id and b.id=c.po_number_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.task_number=$task_id  and a.buyer_name=$buyer_id $sqlCond group by a.job_no,b.po_number,b.grouping,b.id,c.task_number,c.task_start_date,c.task_finish_date";
        // echo $sql;  
        $result = sql_select($sql);

        ?>
        <div>
            <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="310">
                <thead>
                    <tr>
                        <th width="80">Job No</th>
                        <th width="100">Int Ref</th>
                        <th width="50">PO Number</th>
                    </tr>
                </thead>
            </table>
            <div style="width:330px;overflow-y:auto;max-height:300px;" id="scroll_body">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="310">
                    <tbody>
                        <?
                        $i=1;
                        $tot_unplan_qty = 0;
                        foreach ($result as $v)
                        {
                            if($v['TASK_START_DATE'] !="" && $v['TASK_FINISH_DATE'] !="")  
                            {
                    
                            }
                            else 
                            {
                                $unplan_qty = $order_qty_array[$v['PO_ID']] -  $tna_plan_qty_array[$v['PO_ID']];
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>
                                <tr bgcolor="<?=$bgcolor;?>">
                                    <td width="80"><?=$v['JOB_NO'];?></td>
                                    <td width="100"><?=$v['INTERNAL_REF'];?></td>
                                    <td width="50"><?=$v['PO_NUMBER'];?></td>
                                </tr>
                                <?
                                $i++;
                                $tot_unplan_qty += $unplan_qty;
                            }
                        }
                        ?>
                        </tbody> 
                </table>
            </div>

        </div>
        <?
    }
    else // for distribute qty 
    {
        // Order Quantity
        $sql = "SELECT a.job_no,b.po_number,b.grouping, (b.po_quantity*a.total_set_qnty) as PO_QUANTITY__,c.order_quantity as PO_QUANTITY from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and b.status_active=1 and c.status_active=1 and c.is_deleted=0 and a.buyer_name=$buyer_id $sqlCond";
        // echo $sql;
        $res = sql_select($sql);
        $order_qty_array = array();
        $a=0;
        foreach ($res as $val) 
        {
            $order_qty_array[$val['JOB_NO']][$val['GROUPING']][$val['PO_NUMBER']]['PO_QUANTITY'] += $val['PO_QUANTITY'];
            $a+= $val['PO_QUANTITY'];
            $data_array[$val['JOB_NO']][$val['GROUPING']][$val['PO_NUMBER']] = $val['PO_NUMBER'];
        }
        //  echo "<pre>";print_r($order_qty_array);die;
        // echo $a;die;
        // Actual Po Quantity
         $sql = "SELECT a.job_no,b.po_number,b.grouping, d.PO_QTY as ACC_PO_QTY from wo_po_details_master a,wo_po_break_down b,wo_po_acc_po_info c,wo_po_acc_po_info_dtls d where a.id=b.job_id and b.id=c.po_break_down_id and c.id=d.mst_id and a.status_active=1 and b.status_active=1 and b.shiping_status !=3 and c.status_active=1 and d.status_active=1 and d.is_deleted=0 and c.acc_po_status=1 and a.buyer_name=$buyer_id $sqlCond";
        // echo $sql;
        $res = sql_select($sql);
        $acct_order_qty_array = array();
        $a=0;
        foreach ($res as $val) 
        {
            $acct_order_qty_array[$val['JOB_NO']][$val['GROUPING']][$val['PO_NUMBER']]['ACC_PO_QTY'] += $val['ACC_PO_QTY'];
            $a+= $val['ACC_PO_QTY'];
        }
        // =========================
        foreach ($order_qty_array as $job=>$job_data)
        {
            foreach ($job_data as $int_ref => $ref_data) 
            {
                foreach ($ref_data as $po => $v) 
                {
                    // $data_array[$job][$int_ref][$po]=$po;
                }
            }
        }
        // echo $a;die;
        // print_r($acct_order_qty_array);
        // $po_dis_qty = $order_qty_array[$val['JOB_NO']]['PO_QUANTITY']-$acct_order_qty_array[$val['JOB_NO']]['ACC_PO_QTY'];
        
        ?>
        <div>
            <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="330">
                <thead>
                    <tr>
                        <th width="80">Job No</th>
                        <th width="100">Int Ref</th>
                        <th width="100">PO Number</th>
                        <th width="70">Balance Qty</th>
                    </tr>
                </thead>
            </table>
            <div style="width:350px;overflow-y:auto;max-height:300px;" id="scroll_body">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="330">
                    <?
                    $i=1;
                    $tot_bal = 0;
                    foreach ($data_array as $job=>$job_data)
                    {
                        foreach ($job_data as $int_ref => $ref_data) 
                        {
                            foreach ($ref_data as $po => $v) 
                            {                         
                                $bal = $order_qty_array[$job][$int_ref][$po]['PO_QUANTITY'] - $acct_order_qty_array[$job][$int_ref][$po]['ACC_PO_QTY'];
                                // echo $acct_order_qty_array[$job][$int_ref][$po]['ACC_PO_QTY']."<br>";// ."-". $acct_order_qty_array[$job][$int_ref][$po]['ACC_PO_QTY']."<br>";
                                $tot_po_qty += $order_qty_array[$job][$int_ref][$po]['PO_QUANTITY'];
                                $tot_acc_qty += $acct_order_qty_array[$job][$int_ref][$po]['ACC_PO_QTY'];
                                if($bal!=0)
                                {                                    
                                    $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                    ?>
                                    <tr bgcolor="<?=$bgcolor;?>">
                                        <td width="80"><?=$job;?></td>
                                        <td width="100"><?=$int_ref;?></td>
                                        <td width="100"><?=$po;?></td>
                                        <td align="right" width="70"><?=$bal;?></td>
                                    </tr>
                                    <?
                                    $tot_bal += $bal;
                                    $i++;
                                }
                            }
                        }
                    }
                        
                    //    echo $i."==". $tot_po_qty."==".$tot_acc_qty;
                    ?>
                </table>
            </div>            
            <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="330">
                <tfoot>
                    <tr>
                        <th width="80"></th>
                        <th width="100"></th>
                        <th width="100"></th>
                        <th width="70"><?=fn_number_format($tot_bal,0);?></th>
                    </tr>
                </tfoot>
            </table>

        </div>
        <?
    }
}

if($action=="open_unplan_popup2")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    extract($_REQUEST);
    // echo $buyer_id;
    if($task_id !="")
    {
        // Order Quantity
        $sql = "SELECT a.job_no,b.grouping,b.po_number, b.id,c.order_quantity as PO_QUANTITY from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and b.status_active=1 and c.status_active=1 and c.is_deleted=0 and a.buyer_name=$buyer_id $sqlCond order by a.job_no";
        // echo $sql;die;
        $res = sql_select($sql);
        $data_array = array();
        $po_id_array = array();
        $a=0;
        foreach ($res as $val) 
        {
            $data_array[$val['ID']]['qty']+= $val['PO_QUANTITY'];
            $data_array[$val['ID']]['job_no']= $val['JOB_NO'];
            $data_array[$val['ID']]['grouping']= $val['GROUPING'];
            $data_array[$val['ID']]['po_number']= $val['PO_NUMBER'];
            $po_id_array[$val['ID']] = $val['ID'];
        }

        $poIds = implode(",",$po_id_array);
        $condition= new condition();     
        $condition->po_id_in($poIds);
        $condition->init();
        $costPerArr=$condition->getCostingPerArr();
        if($task_id==48)
        {
            $yarn= new yarn($condition);         
            // echo $yarn->getQuery(); die;  
            $yarnReqQtyArr=$yarn->getOrderWiseYarnQtyArray();
        }
        if($task_id==52)
        {
            $conversion= new conversion($condition);
            $conversion_costing_arr=$conversion->getQtyArray_by_orderAndProcess();
        }
        if($task_id==61 || $task_id==60 || $task_id==73)
        {
            $fabric= new fabric($condition);
            $fabric_costing_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish_production();        
            $fabric_purchase_costing_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish_purchase();
        }
        if($task_id==63)//aop
        {
            $fabric= new fabric($condition);         
            $fabric_po_color_type_wise_arr=$fabric->getQtyArray_by_orderColorType_knitAndwoven_greyAndfinish();            
            $fabric_costing_aop_arr=$fabric->getQtyArray_by_orderAndColorTypeFabricSource_knitAndwoven_greyAndfinish();            

            // ======================================= COLOR TYPE WISE BOOKING DATA  ==================================
            $po_id_cond = where_con_using_array($po_id_array,0,"a.PO_BREAK_DOWN_ID");
            $shortSql = "SELECT a.PO_BREAK_DOWN_ID, b.COLOR_TYPE_ID,a.FIN_FAB_QNTY, a.GREY_FAB_QNTY FROM wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b WHERE a.pre_cost_fabric_cost_dtls_id=b.id $po_id_cond and a.is_short=1 and a.status_active=1 and  a.is_deleted=0";
            $shortRes = sql_select($shortSql);
            $color_type_wise_booking_qty_array = array();
            foreach ($shortRes as $val) 
            {
                $color_type_wise_booking_qty_array[$val['PO_BREAK_DOWN_ID']][$val['COLOR_TYPE_ID']] += $val['FIN_FAB_QNTY'];
            }

        }
        if($task_id==267 || $task_id==268)//print, emb
        {
            $emblishment= new emblishment($condition);
            $emblishment_costing_arr=$emblishment->getQtyArray_by_orderAndEmbname();
        }
        if($task_id==90)//wash
        {
            $wash= new wash($condition);
            $emblishment_costing_arr_name=$wash->getQtyArray_by_orderAndEmbname();
        }

        //  echo "<pre>";print_r($conversion_costing_arr);die;
        // echo $a;die;
        // Actual Po Quantity
        $sql = "SELECT c.po_id, c.PLAN_QTY from wo_po_details_master a,wo_po_break_down b,TNA_PLAN_TARGET c where a.id=b.job_id and b.id=c.po_id and a.status_active=1 and b.status_active=1 and c.status_active=1 and c.task_id=$task_id  and a.buyer_name=$buyer_id $sqlCond";
        // echo $sql;
        $res = sql_select($sql);
        $tna_plan_qty_array = array();
        $a=0;
        foreach ($res as $val) 
        {
            $tna_plan_qty_array[$val['PO_ID']] += $val['PLAN_QTY'];
        }

        // =============================== getting excess qty ====================
        $po_id_cond = where_con_using_array($po_id_array,0,"b.PO_BREAK_DOWN_ID");
        $sqlBooking = "SELECT a.FABRIC_SOURCE,a.IS_SHORT,B.PO_BREAK_DOWN_ID,B.FIN_FAB_QNTY AS QTY,B.GREY_FAB_QNTY AS GREY_QTY FROM WO_BOOKING_MST A,WO_BOOKING_DTLS B WHERE A.BOOKING_NO=B.BOOKING_NO AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 and a.booking_type=1 and a.IS_SHORT=1 $po_id_cond";
        // echo $sqlBooking;die();
        $bookingRes = sql_select($sqlBooking);
        $bookingQtyArray = array();
        $bookingFabInfoArray = array();
        foreach ($bookingRes as $val) 
        {                
            $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['fin_fab_excess_qty'] += $val['QTY'];
            if($val['FABRIC_SOURCE'] !=2)// avoid purchase
            {
                $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['grey_fab_excess_qty'] += $val['GREY_QTY'];
                $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['yarn_excess_qty'] += $val['GREY_QTY'];
            }                     
            
        }


        ?>
        <div>
            <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="450">
                <thead>
                    <tr>
                        <th width="80">Job No</th>
                        <th width="100">Int Ref</th>
                        <th width="50">PO Number</th>
                        <th width="80">Req Qnty</th>
                        <th width="80">Plan Qnty</th>
                        <th width="80">Bal Qnty</th>
                    </tr>
                </thead>
            </table>
            <div style="width:470px;overflow-y:auto;max-height:300px;" id="scroll_body">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="450">
                    <tbody>
                        <?
                        $i=1;
                        $tot_req_qty = 0;
                        $tot_plan_qty = 0;
                        $tot_bal_qty = 0;
                        foreach ($data_array as $po_id => $v)
                        {
                            $costingPer     =  $costPerArr[$v['job_no']];
                            $plan_qty = $tna_plan_qty_array[$po_id];
                            $req_qty = $v['qty'];
                            $bal_qty = $req_qty -  $plan_qty;
                            $bal_qty2 = $req_qty -  $plan_qty;

                            if($task_id==48)// yarn allo
                            {
                                $req_qty = $yarnReqQtyArr[$po_id]+$bookingQtyArray[$po_id]['yarn_excess_qty'];
                                $bal_qty = $req_qty -  $plan_qty;
                                $bal_qty2 = $req_qty -  $plan_qty;
                            }
                            if($task_id==52) // dyeid yarn
                            {
                                $req_qty = array_sum($conversion_costing_arr[$po_id][30]);
                                $bal_qty = $req_qty -  $plan_qty;
                                $bal_qty2 = $req_qty -  $plan_qty;
                            }
                            if($task_id==60) // grey fab
                            {
                                $req_qty = array_sum($fabric_costing_arr['knit']['grey'][$po_id])+$bookingQtyArray[$po_id]['grey_fab_excess_qty'];
                                $bal_qty = $req_qty -  $plan_qty;
                                $bal_qty2 = $req_qty -  $plan_qty;
                            }
                            if($task_id==61) // fab dyeing
                            {
                                $req_qty =  array_sum($fabric_costing_arr['knit']['grey'][$po_id])+$bookingQtyArray[$po_id]['grey_fab_excess_qty'];
                                $bal_qty = $req_qty -  $plan_qty;
                                $bal_qty2 = $req_qty -  $plan_qty;
                            }
                            if($task_id==63) // aop
                            {
                                // $req_qty = array_sum($fabric_po_color_type_wise_arr['knit']['finish'][$po_id][5])+$color_type_wise_booking_qty_array[$po_id][5];
                                $req_qty = array_sum($fabric_costing_aop_arr['knit']['finish'][$po_id][5][1])+$color_type_wise_booking_qty_array[$po_id][5];
                                $bal_qty = $req_qty -  $plan_qty;
                                $bal_qty2 = $req_qty -  $plan_qty;
                            }
                            if($task_id==73) // fin fab
                            {
                                $req_qty = array_sum($fabric_costing_arr['knit']['finish'][$po_id])+array_sum($fabric_purchase_costing_arr['knit']['finish'][$po_id])+$bookingQtyArray[$po_id]['fin_fab_excess_qty'];
                                $bal_qty = $req_qty -  $plan_qty;
                                $bal_qty2 = $req_qty -  $plan_qty;
                            }
                            if($task_id==267)//print, emb
                            {
                                $req_qty = ($emblishment_costing_arr[$po_id][1]*$costingPer);
                                $bal_qty = $req_qty -  $plan_qty;
                                $bal_qty2 = $req_qty -  $plan_qty;
                            }
                            if($task_id==268)//print, emb
                            {
                                $req_qty = ($emblishment_costing_arr[$po_id][2]*$costingPer);
                                $bal_qty = $req_qty -  $plan_qty;
                                $bal_qty2 = $req_qty -  $plan_qty;
                            }
                            if($task_id==90)//print, emb
                            {
                                $req_qty = ($emblishment_costing_arr_name[$po_id][3]*$costingPer);
                                $bal_qty = $req_qty -  $plan_qty;
                                $bal_qty2 = $req_qty -  $plan_qty;
                            }
                            $bal_qty = fn_number_format($bal_qty,0);
                            if($bal_qty!=0)
                            {
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>
                                <tr bgcolor="<?=$bgcolor;?>">
                                    <td width="80"><?=$v['job_no'];?></td>
                                    <td width="100"><?=$v['grouping'];?></td>
                                    <td width="50"><?=$v['po_number'];?></td>
                                    <td align="right" width="80"><?=fn_number_format($req_qty,0);?></td>
                                    <td align="right" width="80"><?=fn_number_format($plan_qty,0);?></td>
                                    <td align="right" width="80"><?=$bal_qty;?></td>
                                </tr>
                                <?
                                $i++;
                                $tot_req_qty += $req_qty;
                                $tot_plan_qty += $plan_qty;
                                $tot_bal_qty += $bal_qty2;
                            }
                            
                        }
                        ?>
                        </tbody> 
                        <tfoot>
                            <tr>
                                <th colspan="3"></th>
                                <th><?=fn_number_format($tot_req_qty,0);?></th>
                                <th><?=fn_number_format($tot_plan_qty,0);?></th>
                                <th><?=fn_number_format($tot_bal_qty,0);?></th>
                            </tr>
                        </tfoot>
                </table>
            </div>

        </div>
        <?
    }
}

if($action=="report_generate_rmg") // RMG Report
{
    $company_id     = str_replace("'", "", $cbo_company_name);
    $location_name  = str_replace("'", "", $cbo_location_name);
    $buyer_name     = str_replace("'", "", $cbo_buyer_name);
    $season_name    = str_replace("'", "", $cbo_season_name);
    $client         = str_replace("'", "", $cbo_client);
    $merchant       = str_replace("'", "", $cbo_merchant);
    $int_ref_no     = str_replace("'", "", $txt_int_ref_no);
    $shipment_status= str_replace("'", "", $cbo_shipment_status);
    $order_status   = str_replace("'", "", $cbo_order_status);
    $status         = str_replace("'", "", $cbo_status);
    $search_by      = str_replace("'", "", $cbo_search_by);
    $date_from      = str_replace("'", "", $txt_date_from);
    $date_to        = str_replace("'", "", $txt_date_to);

    $search_data = $company_id."*".$location_name."*".$buyer_name."*".$season_name."*".$client."*".$merchant."*".$int_ref_no."*".$shipment_status."*".$order_status."*".$status."*".$search_by."*".$date_from."*".$date_to;

    //$item_id        = str_replace("'", "", $cbo_item_name);
    //$style_ref      = str_replace("'", "", $txt_style_ref);

    $client_array = return_library_array("SELECT a.id,a.buyer_name from lib_buyer a, lib_buyer_tag_company b where a.status_active =1 and a.is_deleted=0 and b.buyer_id=a.id and b.tag_company='$company_id' and a.id in (select  buyer_id from  lib_buyer_party_type where party_type in (7))  order by buyer_name", "id", "buyer_name");

    // Circular Fabric button


    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    // $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    $sqlCond .= ($merchant != 0)     ? " and a.factory_marchant=$merchant"            : "";
    $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    //$sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";

    if($buyer_name==0)
    {
        if($_SESSION['logic_erp']["data_level_secured"]==1)
        {
            if($_SESSION['logic_erp']["buyer_id"]!="")
            {   
                $sqlCond.=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")";
            }
        }
    }
    else
    {
        $sqlCond.=" and a.buyer_name=$buyer_name";
    }

    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active = $status" : "";
    //$sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }
    // echo "string".$sqlCond;die();    
    
    ob_start();
    ?>
    <div class="tableContainer">  
        <style type="text/css">
        .rpt_table tr th, .rpt_table tr td,.rpt_table tfoot th{font-size:13px;}
        .word_break_wrap{
            word-wrap: break-word;
            word-break: break-all;
        }
        </style>

        <fieldset style="width:1310px;">
            <table width="100%" cellpadding="0" cellspacing="0">
                <tr><td colspan="28" align="center" style="font-size:22px;">RMG Report </td></tr>
                <tr>
            <td colspan="28" align="center" style="font-size:14px;">
                <input type="button" id="show_button" class="formbutton" style="width:90px;" value="Buyer Wise" onClick="fn_rmg_report_generated(1)" />
                <input type="button" id="show_button" class="formbutton" style="width:90px;" value="SBU Wise" onClick="fn_rmg_report_generated(2)" />
                <input type="button" id="show_button" class="formbutton" style="width:90px;" value="Ref Wise" onClick="fn_rmg_report_generated(3)" />
                <input type="button" id="show_button" class="formbutton" style="width:90px;" value="Color Wise" onClick="fn_rmg_report_generated(4)" />
                <input type="button" id="show_button" class="formbutton" style="width:90px;" value="Size Wise" onClick="fn_rmg_report_generated(5)" />
            </td>
                </tr>
                <tr><td colspan="28" align="center" style="font-size:17px;">SBU <span style="color: black;font-size: 18px;font-weight: bold;"> <?=($client) ? ": ".$client_array[$client] : ": All"; ?></span></td></tr>
            </table>
            <? 
            if($rptType==1) // buyer wise
            {
                /*===================================================================================== /
                /                                      Order data                                       /
                /===================================================================================== */

                /*$sql = "SELECT a.buyer_name,b.id as po_id,c.id as color_size_id,c.order_quantity,d.production_type,d.embel_name,e.production_qnty as qty,e.reject_qty
                from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , pro_garments_production_mst d, pro_garments_production_dtls e
                where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 $sqlCond";*/

                $sql = "SELECT a.buyer_name,b.id as po_id,c.id as color_size_id,c.order_quantity
                from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c 
                where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id 
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0  $sqlCond";
                // echo $sql;die();

                $sqlRes = sql_select($sql);
                if(count($sqlRes)==0)
                {
                    echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
                }

                $poIdArray = array();       
                $dataArray = array();       
                $color_size_id_arr = array();       
                foreach ($sqlRes as $row) 
                {
                    $poIdArray[$row['PO_ID']] = $row['PO_ID'];
                    
                    $dataArray[$buyer_name_arr[$row['BUYER_NAME']]]['order_qty'] += $row['ORDER_QUANTITY'];
                    $dataArray[$buyer_name_arr[$row['BUYER_NAME']]]['buyer_name'] = $row['BUYER_NAME'];
                    $color_size_id_arr[$row['COLOR_SIZE_ID']] = $row['COLOR_SIZE_ID'];
                    
                } 
                // echo "<pre>";print_r($dataArray);echo "</pre>";

                $po_id_cond = where_con_using_array($poIdArray,0,"b.id");

                /*===================================================================================== /
                /                                      Order data                                       /
                /===================================================================================== */

                $sql = "SELECT a.buyer_name,d.production_type,d.embel_name,e.production_qnty as qty,e.reject_qty
                from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , pro_garments_production_mst d, pro_garments_production_dtls e
                where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 $sqlCond $po_id_cond";
                $res = sql_select($sql);
                foreach ($res as $row) 
                {                    
                    $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['PRODUCTION_TYPE']][$row['EMBEL_NAME']]['prod_qty'] += $row['QTY'];
                    $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['PRODUCTION_TYPE']][$row['EMBEL_NAME']]['reject_qty'] += $row['REJECT_QTY'];
                }

                /*===================================================================================== /
                /                                      Shipment Data                                    /
                /===================================================================================== */
                $sql = "SELECT a.buyer_name,e.production_qnty from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c, pro_ex_factory_mst d,pro_ex_factory_dtls e where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 $sqlCond $po_id_cond";
                // echo $sql;die();
                $res = sql_select($sql);
                $ex_data = array();
                foreach ($res as $row) 
                {
                    $ex_data[$buyer_name_arr[$row['BUYER_NAME']]] += $row['PRODUCTION_QNTY'];
                }
                ?>
                <table width="100%" border="1" rules="all"  class="rpt_table" align="left" cellspacing="0" cellpadding="0" > 
                    <thead>                                                                    
                        <tr>
                            <th colspan="20">Buyer Wise</th>
                        </tr>
                        <tr>
                            <th width="5%">Buyer</th>
                            <th width="5%">Qty</th>
                            <th width="5%">Cut QC</th>
                            <th width="5%">Cut Rej</th>
                            <th width="5%">Cut Bal</th>
                            <th width="5%">Input </th>
                            <th width="5%">Input Bal</th>
                            <th width="5%">WIP with PE Rej</th>
                            <th width="5%">PE Rej</th>
                            <th width="5%">Sewing</th> 
                            <th width="5%">Sew Rej</th>
                            <th width="5%">Sew Bal</th>
                            <th width="5%">Sew WIP</th> 
                            <th width="5%">Gmt Fin</th>
                            <th width="5%">Finish Bal</th>
                            <th width="5%">Un-Finish WIP</th>
                            <th width="5%">Wash Rej</th>
                            <th width="5%">Shipment</th>
                            <th width="5%">Ship Bal</th>
                            <th width="5%">Ready to Ship</th>
                       </tr>
                    </thead>
                </table>
                <div style="max-height:425px; overflow-y:auto; width:100%;" id="scroll_body">
                    <table width="100%" border="1" rules="all"  class="rpt_table" cellpadding="0" cellspacing="0">
                        <tbody>
                            <?
                            $i=1;
                            $order_qty      = 0;
                            $cutting_qty    = 0;
                            $cutting_rej    = 0;
                            $cutting_bal    = 0;
                            $input_qty      = 0;
                            $input_bal      = 0;
                            $pe_wip_reject  = 0;
                            $pe_reject      = 0;
                            $output_qty     = 0;
                            $output_rej     = 0;
                            $output_bal     = 0;
                            $output_wip     = 0;
                            $finish_qty     = 0;
                            $finish_bal     = 0;
                            $unfinish_wip   = 0;
                            $wash_rej       = 0;
                            $shipment_qty   = 0;
                            $shipment_bal   = 0;
                            $ready_to_ship  = 0;
                            ksort($dataArray);
                            foreach ($dataArray as $buyer_name=>$val) 
                            {       
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('str_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="str_<? echo $i; ?>" style="" valign="middle">
                                    <td width="5%" title="<?=$buyer_name;?>"><?=substr($buyer_name,0,9);?></td>
                                    <td width="5%" align="right"><?=fn_number_format($val['order_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format($val[1][0]['prod_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format($val[1][0]['reject_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format(($val['order_qty'] - $val[1][0]['prod_qty']),0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format($val[4][0]['prod_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format(($val['order_qty'] - $val[4][0]['prod_qty']),0);?></td>
                                    <td width="5%" align="right">
                                        <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name];?>','wip_with_pe_popup','WIP with PE Rej',1)">
                                            <?=fn_number_format(($val[1][0]['prod_qty'] - $val[4][0]['prod_qty']),0);?>
                                        </a>                                            
                                    </td>
                                    <td width="5%" align="right"><?=fn_number_format(($val[3][1]['reject_qty']+$val[3][2]['reject_qty']),0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format($val[5][0]['prod_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format($val[5][0]['reject_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format(($val['order_qty'] - $val[5][0]['prod_qty']),0);?></td>
                                    <td width="5%" align="right">
                                        <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name];?>','sewing_wip_popup','Sewing WIP',1)">
                                            <?=fn_number_format(($val[4][0]['prod_qty']-($val[5][0]['prod_qty']+$val[5][0]['reject_qty'])),0);?>
                                        </a>                                            
                                    </td>
                                    <td width="5%" align="right"><?=fn_number_format($val[8][0]['prod_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format(($val['order_qty'] - $val[8][0]['prod_qty']),0);?></td>
                                    <td width="5%" align="right">
                                        <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name];?>','unfinish_wip_popup','Un- Finish WIP',1)">
                                            <?=fn_number_format(($val[5][0]['prod_qty'] - ($val[8][0]['prod_qty']+$val[8][0]['reject_qty'])),0);?>
                                        </a>                                            
                                    </td>
                                    <td width="5%" align="right"><?=fn_number_format($val[3][3]['reject_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format($ex_data[$buyer_name],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format(($val['order_qty'] - $ex_data[$buyer_name]),0);?></td>
                                    <td width="5%" align="right">
                                        <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name];?>','ready_to_ship_popup','Ready To Ship',1)">
                                            <?=fn_number_format(($val[8][0]['prod_qty'] - $ex_data[$buyer_name]),0);?>
                                        </a>                                            
                                    </td>
                                </tr>
                                <? 
                                $i++;
                                $order_qty      += $val['order_qty'];
                                $cutting_qty    += $val[1][0]['prod_qty'];
                                $cutting_rej    += $val[1][0]['reject_qty'];
                                $cutting_bal    += $val['order_qty'] - $val[1][0]['prod_qty'];
                                $input_qty      += $val[4][0]['prod_qty'];
                                $input_bal      += $val['order_qty'] - $val[4][0]['prod_qty'];
                                $pe_wip_reject  += $val[1][0]['prod_qty'] - $val[4][0]['prod_qty'];
                                $pe_reject      += $val[3][1]['reject_qty']+$val[3][2]['reject_qty'];
                                $output_qty     += $val[5][0]['prod_qty'];
                                $output_rej     += $val[5][0]['reject_qty'];
                                $output_bal     += $val['order_qty'] - $val[5][0]['prod_qty'];
                                $output_wip     += $val[4][0]['prod_qty']-($val[5][0]['prod_qty']+$val[5][0]['reject_qty']);
                                $finish_qty     += $val[8][0]['prod_qty'];
                                $finish_bal     += $val['order_qty'] - $val[8][0]['prod_qty'];
                                $unfinish_wip   += $val[5][0]['prod_qty'] - ($val[8][0]['prod_qty']+$val[8][0]['reject_qty']);
                                $wash_rej       += $val[3][3]['reject_qty'];
                                $shipment_qty   += $ex_data[$buyer_name];
                                $shipment_bal   += $val['order_qty'] - $ex_data[$buyer_name];
                                $ready_to_ship  += $val[8][0]['prod_qty'] - $ex_data[$buyer_name];                                
                            }

                           ?>
                        </tbody>
                    </table>
                </div>
                <table width="100%" border="1" rules="all"  class="rpt_table" align="left" cellspacing="0" cellpadding="0" > 
                    <tfoot> 
                        <tr>
                            <th width="5%">Total</th>
                            <th width="5%"><?=fn_number_format($order_qty,0);?></th>
                            <th width="5%"><?=fn_number_format($cutting_qty,0);?></th>
                            <th width="5%"><?=fn_number_format($cutting_rej,0);?></th>
                            <th width="5%"><?=fn_number_format($cutting_bal,0);?></th>
                            <th width="5%"><?=fn_number_format($input_qty,0);?></th>
                            <th width="5%"><?=fn_number_format($input_bal,0);?></th>
                            <th width="5%"><?=fn_number_format($pe_wip_reject,0);?></th>
                            <th width="5%"><?=fn_number_format($pe_reject,0);?></th>
                            <th width="5%"><?=fn_number_format($output_qty,0);?></th> 
                            <th width="5%"><?=fn_number_format($output_rej,0);?></th>
                            <th width="5%"><?=fn_number_format($output_bal,0);?></th>
                            <th width="5%"><?=fn_number_format($output_wip,0);?></th> 
                            <th width="5%"><?=fn_number_format($finish_qty,0);?></th>
                            <th width="5%"><?=fn_number_format($finish_bal,0);?></th>
                            <th width="5%"><?=fn_number_format($unfinish_wip,0);?></th>
                            <th width="5%"><?=fn_number_format($wash_rej,0);?></th>
                            <th width="5%"><?=fn_number_format($shipment_qty,0);?></th>
                            <th width="5%"><?=fn_number_format($shipment_bal,0);?></th>
                            <th width="5%"><?=fn_number_format($ready_to_ship,0);?></th>
                       </tr>
                    </tfoot>
                </table>
               
                <?
            }
            elseif($rptType==2) // SBU Wise
            {
                /*===================================================================================== /
                /                                       Prod data                                       /
                /===================================================================================== */

                /*$sql = "SELECT a.client_id,b.id as po_id,c.id as color_size_id,c.order_quantity,d.production_type,d.embel_name,e.production_qnty as qty,e.reject_qty
                from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , pro_garments_production_mst d, pro_garments_production_dtls e
                where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 $sqlCond";*/
                $sql = "SELECT a.client_id,b.id as po_id,c.id as color_size_id,c.order_quantity,d.production_type,d.embel_name,e.production_qnty as qty,e.reject_qty
                from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c left join pro_garments_production_dtls e on c.id=e.color_size_break_down_id and e.status_active=1 and e.is_deleted=0 left join pro_garments_production_mst d on e.mst_id=d.id  and d.status_active=1 and d.is_deleted=0 
                where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id 
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0  $sqlCond";
                // echo $sql;die();

                $sqlRes = sql_select($sql);
                if(count($sqlRes)==0)
                {
                    echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
                }

                $poIdArray = array();       
                $dataArray = array();       
                $color_size_id_arr = array();       
                foreach ($sqlRes as $row) 
                {
                    /*if($row['PRODUCTION_TYPE']!=2 || $row['PRODUCTION_TYPE']!=3 || $row['PRODUCTION_TYPE']!=4)
                    {
                        $row['EMBEL_NAME'] = 0;
                    }*/
                    $poIdArray[$row['PO_ID']] = $row['PO_ID'];
                    $dataArray[$client_array[$row['CLIENT_ID']]][$row['PRODUCTION_TYPE']][$row['EMBEL_NAME']]['prod_qty'] += $row['QTY'];
                    $dataArray[$client_array[$row['CLIENT_ID']]][$row['PRODUCTION_TYPE']][$row['EMBEL_NAME']]['reject_qty'] += $row['REJECT_QTY'];
                    if(!in_array($row['COLOR_SIZE_ID'],$color_size_id_arr))
                    {
                        $dataArray[$client_array[$row['CLIENT_ID']]]['order_qty'] += $row['ORDER_QUANTITY'];
                        $dataArray[$client_array[$row['CLIENT_ID']]]['buyer_name'] = $row['CLIENT_ID'];
                        $color_size_id_arr[$row['COLOR_SIZE_ID']] = $row['COLOR_SIZE_ID'];
                    }
                } 
                // echo "<pre>";print_r($dataArray);echo "</pre>";

                $po_id_cond = where_con_using_array($poIdArray,0,"b.id");

                /*===================================================================================== /
                /                                      Shipment Data                                    /
                /===================================================================================== */
                $sql = "SELECT a.client_id,e.production_qnty from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c, pro_ex_factory_mst d,pro_ex_factory_dtls e where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 $sqlCond $po_id_cond";
                // echo $sql;die();
                $res = sql_select($sql);
                $ex_data = array();
                foreach ($res as $row) 
                {
                    $ex_data[$client_array[$row['CLIENT_ID']]] += $row['PRODUCTION_QNTY'];
                }
                ?>
                <table width="100%" border="1" rules="all"  class="rpt_table" align="left" cellspacing="0" cellpadding="0" > 
                    <thead>                                                                    
                        <tr>
                            <th colspan="20">SBU Wise</th>
                        </tr>
                        <tr>
                            <th width="5%">SBU</th>
                            <th width="5%">Qty</th>
                            <th width="5%">Cut QC</th>
                            <th width="5%">Cut Rej</th>
                            <th width="5%">Cut Bal</th>
                            <th width="5%">Input </th>
                            <th width="5%">Input Bal</th>
                            <th width="5%">WIP with PE Rej</th>
                            <th width="5%">PE Rej</th>
                            <th width="5%">Sewing</th> 
                            <th width="5%">Sew Rej</th>
                            <th width="5%">Sew Bal</th>
                            <th width="5%">Sew WIP</th> 
                            <th width="5%">Gmt Fin</th>
                            <th width="5%">Finish Bal</th>
                            <th width="5%">Un-Finish WIP</th>
                            <th width="5%">Wash Rej</th>
                            <th width="5%">Shipment</th>
                            <th width="5%">Ship Bal</th>
                            <th width="5%">Ready to Ship</th>
                       </tr>
                    </thead>
                </table>
                <div style="max-height:425px; overflow-y:auto; width:100%;" id="scroll_body">
                    <table width="100%" border="1" rules="all"  class="rpt_table" cellpadding="0" cellspacing="0">
                        <tbody>
                            <?
                            $i=1;
                            $order_qty      = 0;
                            $cutting_qty    = 0;
                            $cutting_rej    = 0;
                            $cutting_bal    = 0;
                            $input_qty      = 0;
                            $input_bal      = 0;
                            $pe_wip_reject  = 0;
                            $pe_reject      = 0;
                            $output_qty     = 0;
                            $output_rej     = 0;
                            $output_bal     = 0;
                            $output_wip     = 0;
                            $finish_qty     = 0;
                            $finish_bal     = 0;
                            $unfinish_wip   = 0;
                            $wash_rej       = 0;
                            $shipment_qty   = 0;
                            $shipment_bal   = 0;
                            $ready_to_ship  = 0;
                            ksort($dataArray);
                            foreach ($dataArray as $buyer_name=>$val) 
                            {       
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('str_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="str_<? echo $i; ?>" style="" valign="middle">
                                    <td width="5%" title="<?=$buyer_name;?>"><?=substr($buyer_name,0,9);?></td>
                                    <td width="5%" align="right"><?=fn_number_format($val['order_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format($val[1][0]['prod_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format($val[1][0]['reject_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format(($val['order_qty'] - $val[1][0]['prod_qty']),0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format($val[4][0]['prod_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format(($val['order_qty'] - $val[4][0]['prod_qty']),0);?></td>
                                    <td width="5%" align="right">
                                        <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name];?>','wip_with_pe_popup','WIP With PE Rej',2)">
                                            <?=fn_number_format(($val[1][0]['prod_qty'] - $val[4][0]['prod_qty']),0);?>
                                        </a>                                            
                                    </td>
                                    <td width="5%" align="right"><?=fn_number_format(($val[3][1]['reject_qty']+$val[3][2]['reject_qty']),0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format($val[5][0]['prod_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format($val[5][0]['reject_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format(($val['order_qty'] - $val[5][0]['prod_qty']),0);?></td>
                                    <td width="5%" align="right">
                                        <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name];?>','sewing_wip_popup','Sewing WIP',2)">
                                            <?=fn_number_format(($val[4][0]['prod_qty']-($val[5][0]['prod_qty']+$val[5][0]['reject_qty'])),0);?>
                                        </a>                                            
                                    </td>
                                    <td width="5%" align="right"><?=fn_number_format($val[8][0]['prod_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format(($val['order_qty'] - $val[8][0]['prod_qty']),0);?></td>
                                    <td width="5%" align="right">
                                        <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name];?>','unfinish_wip_popup','Un-Finish WIP',2)">
                                            <?=fn_number_format(($val[5][0]['prod_qty'] - ($val[8][0]['prod_qty']+$val[8][0]['reject_qty'])),0);?>
                                        </a>                                            
                                    </td>
                                    <td width="5%" align="right"><?=fn_number_format($val[3][3]['reject_qty'],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format($ex_data[$buyer_name],0);?></td>
                                    <td width="5%" align="right"><?=fn_number_format(($val['order_qty'] - $ex_data[$buyer_name]),0);?></td>
                                    <td width="5%" align="right">
                                        <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name];?>','ready_to_ship_popup','Ready to Ship',2)">
                                            <?=fn_number_format(($val[8][0]['prod_qty'] - $ex_data[$buyer_name]),0);?>
                                        </a>                                            
                                    </td>
                                </tr>
                                <? 
                                $i++;
                                $order_qty      += $val['order_qty'];
                                $cutting_qty    += $val[1][0]['prod_qty'];
                                $cutting_rej    += $val[1][0]['reject_qty'];
                                $cutting_bal    += $val['order_qty'] - $val[1][0]['prod_qty'];
                                $input_qty      += $val[4][0]['prod_qty'];
                                $input_bal      += $val['order_qty'] - $val[4][0]['prod_qty'];
                                $pe_wip_reject  += $val[1][0]['prod_qty'] - $val[4][0]['prod_qty'];
                                $pe_reject      += $val[3][1]['reject_qty']+$val[3][2]['reject_qty'];
                                $output_qty     += $val[5][0]['prod_qty'];
                                $output_rej     += $val[5][0]['reject_qty'];
                                $output_bal     += $val['order_qty'] - $val[5][0]['prod_qty'];
                                $output_wip     += $val[4][0]['prod_qty']-($val[5][0]['prod_qty']+$val[5][0]['reject_qty']);
                                $finish_qty     += $val[8][0]['prod_qty'];
                                $finish_bal     += $val['order_qty'] - $val[8][0]['prod_qty'];
                                $unfinish_wip   += $val[5][0]['prod_qty'] - ($val[8][0]['prod_qty']+$val[8][0]['reject_qty']);
                                $wash_rej       += $val[3][3]['reject_qty'];
                                $shipment_qty   += $ex_data[$buyer_name];
                                $shipment_bal   += $val['order_qty'] - $ex_data[$buyer_name];
                                $ready_to_ship  += $val[8][0]['prod_qty'] - $ex_data[$buyer_name];                                
                            }

                           ?>
                        </tbody>
                    </table>
                </div>
                <table width="100%" border="1" rules="all"  class="rpt_table" align="left" cellspacing="0" cellpadding="0" > 
                    <tfoot> 
                        <tr>
                            <th width="5%">Total</th>
                            <th width="5%"><?=fn_number_format($order_qty,0);?></th>
                            <th width="5%"><?=fn_number_format($cutting_qty,0);?></th>
                            <th width="5%"><?=fn_number_format($cutting_rej,0);?></th>
                            <th width="5%"><?=fn_number_format($cutting_bal,0);?></th>
                            <th width="5%"><?=fn_number_format($input_qty,0);?></th>
                            <th width="5%"><?=fn_number_format($input_bal,0);?></th>
                            <th width="5%"><?=fn_number_format($pe_wip_reject,0);?></th>
                            <th width="5%"><?=fn_number_format($pe_reject,0);?></th>
                            <th width="5%"><?=fn_number_format($output_qty,0);?></th> 
                            <th width="5%"><?=fn_number_format($output_rej,0);?></th>
                            <th width="5%"><?=fn_number_format($output_bal,0);?></th>
                            <th width="5%"><?=fn_number_format($output_wip,0);?></th> 
                            <th width="5%"><?=fn_number_format($finish_qty,0);?></th>
                            <th width="5%"><?=fn_number_format($finish_bal,0);?></th>
                            <th width="5%"><?=fn_number_format($unfinish_wip,0);?></th>
                            <th width="5%"><?=fn_number_format($wash_rej,0);?></th>
                            <th width="5%"><?=fn_number_format($shipment_qty,0);?></th>
                            <th width="5%"><?=fn_number_format($shipment_bal,0);?></th>
                            <th width="5%"><?=fn_number_format($ready_to_ship,0);?></th>
                       </tr>
                    </tfoot>
                </table>
               
                <?
            }
            elseif($rptType==3) // Ref. Wise
            {
                /*===================================================================================== /
                /                                       Prod data                                       /
                /===================================================================================== */

                /*$sql = "SELECT a.buyer_name,a.style_ref_no,b.id as po_id,b.grouping,c.id as color_size_id,c.order_quantity,d.production_type,d.embel_name,e.production_qnty as qty,e.reject_qty
                from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , pro_garments_production_mst d, pro_garments_production_dtls e
                where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 $sqlCond";*/
                $sql = "SELECT a.buyer_name,a.style_ref_no,b.id as po_id,b.grouping,c.id as color_size_id,c.order_quantity,d.production_type,d.embel_name,e.production_qnty as qty,e.reject_qty
                from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c left join pro_garments_production_dtls e on c.id=e.color_size_break_down_id and e.status_active=1 and e.is_deleted=0 left join pro_garments_production_mst d on e.mst_id=d.id  and d.status_active=1 and d.is_deleted=0 
                where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id 
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0  $sqlCond";
                // echo $sql;die();

                $sqlRes = sql_select($sql);
                if(count($sqlRes)==0)
                {
                    echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
                }

                $poIdArray = array();       
                $dataArray = array();       
                $color_size_id_arr = array();       
                foreach ($sqlRes as $row) 
                {
                    /*if($row['PRODUCTION_TYPE']!=2 || $row['PRODUCTION_TYPE']!=3 || $row['PRODUCTION_TYPE']!=4)
                    {
                        $row['EMBEL_NAME'] = 0;
                    }*/
                    $poIdArray[$row['PO_ID']] = $row['PO_ID'];
                    $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']][$row['PRODUCTION_TYPE']][$row['EMBEL_NAME']]['prod_qty'] += $row['QTY'];
                    $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']][$row['PRODUCTION_TYPE']][$row['EMBEL_NAME']]['reject_qty'] += $row['REJECT_QTY'];
                    if(!in_array($row['COLOR_SIZE_ID'],$color_size_id_arr))
                    {
                        $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']]['order_qty'] += $row['ORDER_QUANTITY'];
                        $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']]['buyer_name'] = $row['BUYER_NAME'];
                        $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']]['style'] = $row['STYLE_REF_NO'];
                        $color_size_id_arr[$row['COLOR_SIZE_ID']] = $row['COLOR_SIZE_ID'];
                    }
                } 
                // echo "<pre>";print_r($dataArray);echo "</pre>";

                $po_id_cond = where_con_using_array($poIdArray,0,"b.id");

                /*===================================================================================== /
                /                                      Shipment Data                                    /
                /===================================================================================== */
                $sql = "SELECT a.buyer_name,b.grouping,e.production_qnty from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c, pro_ex_factory_mst d,pro_ex_factory_dtls e where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 $sqlCond $po_id_cond";
                // echo $sql;die();
                $res = sql_select($sql);
                $ex_data = array();
                foreach ($res as $row) 
                {
                    $ex_data[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']] += $row['PRODUCTION_QNTY'];
                }

                $rowspan = array();
                foreach ($dataArray as $b_key => $b_value) 
                {
                    foreach ($b_value as $g_key => $g_value) 
                    {
                        $rowspan[$b_key]++;
                    }
                }
                ?>
                <table width="100%" border="1" rules="all"  class="rpt_table" align="left" cellspacing="0" cellpadding="0" > 
                    <thead>                                                                    
                        <tr>
                            <th colspan="22">Int. Ref. Wise</th>
                        </tr>
                        <tr>
                            <th width="5%">Buyer</th>
                            <th width="5%">Ref No</th>
                            <th width="4.5%">Style</th>
                            <th width="4.5%">Qty</th>
                            <th width="4.5%">Cut QC</th>
                            <th width="4.5%">Cut Rej</th>
                            <th width="4.5%">Cut Bal</th>
                            <th width="4.5%">Input </th>
                            <th width="4.5%">Input Bal</th>
                            <th width="4.5%">WIP with PE Rej</th>
                            <th width="4.5%">PE Rej</th>
                            <th width="4.5%">Sewing</th> 
                            <th width="4.5%">Sew Rej</th>
                            <th width="4.5%">Sew Bal</th>
                            <th width="4.5%">Sew WIP</th> 
                            <th width="4.5%">Gmt Fin</th>
                            <th width="4.5%">Finish Bal</th>
                            <th width="4.5%">Un-Finish WIP</th>
                            <th width="4.5%">Wash Rej</th>
                            <th width="4.5%">Shipment</th>
                            <th width="4.5%">Ship Bal</th>
                            <th width="4.5%">Ready to Ship</th>
                       </tr>
                    </thead>
                </table>
                <div style="max-height:425px; overflow-y:auto; width:100%;" id="scroll_body">
                    <table width="100%" border="1" rules="all"  class="rpt_table" cellpadding="0" cellspacing="0">
                        <tbody>
                            <?
                            $i=1;
                            $order_qty      = 0;
                            $cutting_qty    = 0;
                            $cutting_rej    = 0;
                            $cutting_bal    = 0;
                            $input_qty      = 0;
                            $input_bal      = 0;
                            $pe_wip_reject  = 0;
                            $pe_reject      = 0;
                            $output_qty     = 0;
                            $output_rej     = 0;
                            $output_bal     = 0;
                            $output_wip     = 0;
                            $finish_qty     = 0;
                            $finish_bal     = 0;
                            $unfinish_wip   = 0;
                            $wash_rej       = 0;
                            $shipment_qty   = 0;
                            $shipment_bal   = 0;
                            $ready_to_ship  = 0;
                            ksort($dataArray);
                            foreach ($dataArray as $buyer_name=>$buyer_data) 
                            { 
                                $b= 0;                                
                                $buyer_order_qty      = 0;
                                $buyer_cutting_qty    = 0;
                                $buyer_cutting_rej    = 0;
                                $buyer_cutting_bal    = 0;
                                $buyer_input_qty      = 0;
                                $buyer_input_bal      = 0;
                                $buyer_pe_wip_reject  = 0;
                                $buyer_pe_reject      = 0;
                                $buyer_output_qty     = 0;
                                $buyer_output_rej     = 0;
                                $buyer_output_bal     = 0;
                                $buyer_output_wip     = 0;
                                $buyer_finish_qty     = 0;
                                $buyer_finish_bal     = 0;
                                $buyer_unfinish_wip   = 0;
                                $buyer_wash_rej       = 0;
                                $buyer_shipment_qty   = 0;
                                $buyer_shipment_bal   = 0;
                                $buyer_ready_to_ship  = 0;     
                                ksort($buyer_data); 
                                foreach ($buyer_data as $grouping => $val) 
                                {                                    
                                    $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                    ?>
                                    <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('str_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="str_<? echo $i; ?>" style="" valign="middle">
                                        <? if($b==0){?>
                                        <td rowspan="<?=$rowspan[$buyer_name];?>" width="5%" title="<?=$buyer_name;?>"><?=substr($buyer_name,0,8);?></td>
                                        <? $b++;} ?>
                                        <td width="5%" title="<?=$grouping;?>"><?=substr($grouping,0,8);?></td>
                                        <td width="4.5%" title="<?=$val[style];?>"><?=substr($val[style],0,6);?></td>
                                        <td width="4.5%" align="right"><?=fn_number_format($val['order_qty'],0);?></td>
                                        <td width="4.5%" align="right"><?=fn_number_format($val[1][0]['prod_qty'],0);?></td>
                                        <td width="4.5%" align="right"><?=fn_number_format($val[1][0]['reject_qty'],0);?></td>
                                        <td width="4.5%" align="right"><?=fn_number_format(($val['order_qty'] - $val[1][0]['prod_qty']),0);?></td>
                                        <td width="4.5%" align="right"><?=fn_number_format($val[4][0]['prod_qty'],0);?></td>
                                        <td width="4.5%" align="right"><?=fn_number_format(($val['order_qty'] - $val[4][0]['prod_qty']),0);?></td>
                                        <td width="4.5%" align="right">
                                            <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name]."*".$grouping;?>','wip_with_pe_popup','WIP with PE Rej',3)">
                                                <?=fn_number_format(($val[1][0]['prod_qty'] - $val[4][0]['prod_qty']),0);?>
                                            </a>                                            
                                        </td>
                                        <td width="4.5%" align="right"><?=fn_number_format(($val[3][1]['reject_qty']+$val[3][2]['reject_qty']),0);?></td>
                                        <td width="4.5%" align="right"><?=fn_number_format($val[5][0]['prod_qty'],0);?></td>
                                        <td width="4.5%" align="right"><?=fn_number_format($val[5][0]['reject_qty'],0);?></td>
                                        <td width="4.5%" align="right"><?=fn_number_format(($val['order_qty'] - $val[5][0]['prod_qty']),0);?></td>
                                        <td width="4.5%" align="right">
                                            <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name]."*".$grouping;?>','sewing_wip_popup','Sewing WIP',3)">
                                                <?=fn_number_format(($val[4][0]['prod_qty']-($val[5][0]['prod_qty']+$val[5][0]['reject_qty'])),0);?>
                                            </a>                                            
                                        </td>
                                        <td width="4.5%" align="right"><?=fn_number_format($val[8][0]['prod_qty'],0);?></td>
                                        <td width="4.5%" align="right"><?=fn_number_format(($val['order_qty'] - $val[8][0]['prod_qty']),0);?></td>
                                        <td width="4.5%" align="right">
                                            <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name]."*".$grouping;?>','unfinish_wip_popup','Un-Finish WIP',3)">
                                                <?=fn_number_format(($val[5][0]['prod_qty'] - ($val[8][0]['prod_qty']+$val[8][0]['reject_qty'])),0);?>
                                            </a>                                            
                                        </td>
                                        <td width="4.5%" align="right"><?=fn_number_format($val[3][3]['reject_qty'],0);?></td>
                                        <td width="4.5%" align="right"><?=fn_number_format($ex_data[$buyer_name][$grouping],0);?></td>
                                        <td width="4.5%" align="right"><?=fn_number_format(($val['order_qty'] - $ex_data[$buyer_name][$grouping]),0);?></td>
                                        <td width="4.5%" align="right">
                                            <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name]."*".$grouping;?>','ready_to_ship_popup','Ready to Ship',3)">
                                                <?=fn_number_format(($val[8][0]['prod_qty'] - $ex_data[$buyer_name][$grouping]),0);?>
                                            </a>                                            
                                        </td>
                                    </tr>
                                    <? 
                                    $i++;
                                    $buyer_order_qty      += $val['order_qty'];
                                    $buyer_cutting_qty    += $val[1][0]['prod_qty'];
                                    $buyer_cutting_rej    += $val[1][0]['reject_qty'];
                                    $buyer_cutting_bal    += $val['order_qty'] - $val[1][0]['prod_qty'];
                                    $buyer_input_qty      += $val[4][0]['prod_qty'];
                                    $buyer_input_bal      += $val['order_qty'] - $val[4][0]['prod_qty'];
                                    $buyer_pe_wip_reject  += $val[1][0]['prod_qty'] - $val[4][0]['prod_qty'];
                                    $buyer_pe_reject      += $val[3][1]['reject_qty']+$val[3][2]['reject_qty'];
                                    $buyer_output_qty     += $val[5][0]['prod_qty'];
                                    $buyer_output_rej     += $val[5][0]['reject_qty'];
                                    $buyer_output_bal     += $val['order_qty'] - $val[5][0]['prod_qty'];
                                    $buyer_output_wip     += $val[4][0]['prod_qty']-($val[5][0]['prod_qty']+$val[5][0]['reject_qty']);
                                    $buyer_finish_qty     += $val[8][0]['prod_qty'];
                                    $buyer_finish_bal     += $val['order_qty'] - $val[8][0]['prod_qty'];
                                    $buyer_unfinish_wip   += $val[5][0]['prod_qty'] - ($val[8][0]['prod_qty']+$val[8][0]['reject_qty']);
                                    $buyer_wash_rej       += $val[3][3]['reject_qty'];
                                    $buyer_shipment_qty   += $ex_data[$buyer_name][$grouping];
                                    $buyer_shipment_bal   += $val['order_qty'] - $ex_data[$buyer_name][$grouping];
                                    $buyer_ready_to_ship  += $val[8][0]['prod_qty'] - $ex_data[$buyer_name][$grouping]; 

                                    $order_qty      += $val['order_qty'];
                                    $cutting_qty    += $val[1][0]['prod_qty'];
                                    $cutting_rej    += $val[1][0]['reject_qty'];
                                    $cutting_bal    += $val['order_qty'] - $val[1][0]['prod_qty'];
                                    $input_qty      += $val[4][0]['prod_qty'];
                                    $input_bal      += $val['order_qty'] - $val[4][0]['prod_qty'];
                                    $pe_wip_reject  += $val[1][0]['prod_qty'] - $val[4][0]['prod_qty'];
                                    $pe_reject      += $val[3][1]['reject_qty']+$val[3][2]['reject_qty'];
                                    $output_qty     += $val[5][0]['prod_qty'];
                                    $output_rej     += $val[5][0]['reject_qty'];
                                    $output_bal     += $val['order_qty'] - $val[5][0]['prod_qty'];
                                    $output_wip     += $val[4][0]['prod_qty']-($val[5][0]['prod_qty']+$val[5][0]['reject_qty']);
                                    $finish_qty     += $val[8][0]['prod_qty'];
                                    $finish_bal     += $val['order_qty'] - $val[8][0]['prod_qty'];
                                    $unfinish_wip   += $val[5][0]['prod_qty'] - ($val[8][0]['prod_qty']+$val[8][0]['reject_qty']);
                                    $wash_rej       += $val[3][3]['reject_qty'];
                                    $shipment_qty   += $ex_data[$buyer_name][$grouping];
                                    $shipment_bal   += $val['order_qty'] - $ex_data[$buyer_name][$grouping];
                                    $ready_to_ship  += $val[8][0]['prod_qty'] - $ex_data[$buyer_name][$grouping]; 
                                } 
                                ?>
                                <tr style="background: #cddcdc;font-weight: bold;text-align: right;">
                                    <td></td>
                                    <td></td>
                                    <td>Byr Total</td>
                                    <td><?=fn_number_format($buyer_order_qty,0);?></td>
                                    <td><?=fn_number_format($buyer_cutting_qty,0);?></td>
                                    <td><?=fn_number_format($buyer_cutting_rej,0);?></td>
                                    <td><?=fn_number_format($buyer_cutting_bal,0);?></td>
                                    <td><?=fn_number_format($buyer_input_qty,0);?></td>
                                    <td><?=fn_number_format($buyer_input_bal,0);?></td>
                                    <td><?=fn_number_format($buyer_pe_wip_reject,0);?></td>
                                    <td><?=fn_number_format($buyer_pe_reject,0);?></td>
                                    <td><?=fn_number_format($buyer_output_qty,0);?></td> 
                                    <td><?=fn_number_format($buyer_output_rej,0);?></td>
                                    <td><?=fn_number_format($buyer_output_bal,0);?></td>
                                    <td><?=fn_number_format($buyer_output_wip,0);?></td> 
                                    <td><?=fn_number_format($buyer_finish_qty,0);?></td>
                                    <td><?=fn_number_format($buyer_finish_bal,0);?></td>
                                    <td><?=fn_number_format($buyer_unfinish_wip,0);?></td>
                                    <td><?=fn_number_format($buyer_wash_rej,0);?></td>
                                    <td><?=fn_number_format($buyer_shipment_qty,0);?></td>
                                    <td><?=fn_number_format($buyer_shipment_bal,0);?></td>
                                    <td><?=fn_number_format($buyer_ready_to_ship,0);?></td>
                               </tr>
                                <?                              
                            }

                           ?>
                        </tbody>
                    </table>
                </div>
                <table width="100%" border="1" rules="all"  class="rpt_table" align="left" cellspacing="0" cellpadding="0" > 
                    <tfoot> 
                        <tr>
                            <th width="5%"></th>
                            <th width="5%"></th>
                            <th width="4.5%">Grnd Total</th>
                            <th width="4.5%"><?=fn_number_format($order_qty,0);?></th>
                            <th width="4.5%"><?=fn_number_format($cutting_qty,0);?></th>
                            <th width="4.5%"><?=fn_number_format($cutting_rej,0);?></th>
                            <th width="4.5%"><?=fn_number_format($cutting_bal,0);?></th>
                            <th width="4.5%"><?=fn_number_format($input_qty,0);?></th>
                            <th width="4.5%"><?=fn_number_format($input_bal,0);?></th>
                            <th width="4.5%"><?=fn_number_format($pe_wip_reject,0);?></th>
                            <th width="4.5%"><?=fn_number_format($pe_reject,0);?></th>
                            <th width="4.5%"><?=fn_number_format($output_qty,0);?></th> 
                            <th width="4.5%"><?=fn_number_format($output_rej,0);?></th>
                            <th width="4.5%"><?=fn_number_format($output_bal,0);?></th>
                            <th width="4.5%"><?=fn_number_format($output_wip,0);?></th> 
                            <th width="4.5%"><?=fn_number_format($finish_qty,0);?></th>
                            <th width="4.5%"><?=fn_number_format($finish_bal,0);?></th>
                            <th width="4.5%"><?=fn_number_format($unfinish_wip,0);?></th>
                            <th width="4.5%"><?=fn_number_format($wash_rej,0);?></th>
                            <th width="4.5%"><?=fn_number_format($shipment_qty,0);?></th>
                            <th width="4.5%"><?=fn_number_format($shipment_bal,0);?></th>
                            <th width="4.5%"><?=fn_number_format($ready_to_ship,0);?></th>
                       </tr>
                    </tfoot>
                </table>
               
                <?
            }
            elseif($rptType==4) // Color Wise
            {
                $color_arr = return_library_array("select id, color_name from  lib_color", "id", "color_name");
                /*===================================================================================== /
                /                                       Prod data                                       /
                /===================================================================================== */

                /*$sql = "SELECT a.buyer_name,a.style_ref_no,b.id as po_id,b.grouping,c.id as color_size_id,c.item_number_id as item_id,c.color_number_id as color_id,c.order_quantity,d.production_type,d.embel_name,e.production_qnty as qty,e.reject_qty
                from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , pro_garments_production_mst d, pro_garments_production_dtls e
                where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 $sqlCond";*/
                $sql = "SELECT a.buyer_name,a.style_ref_no,b.id as po_id,b.grouping,c.id as color_size_id,c.item_number_id as item_id,c.color_number_id as color_id,c.order_quantity,d.production_type,d.embel_name,e.production_qnty as qty,e.reject_qty
                from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c left join pro_garments_production_dtls e on c.id=e.color_size_break_down_id and e.status_active=1 and e.is_deleted=0 left join pro_garments_production_mst d on e.mst_id=d.id  and d.status_active=1 and d.is_deleted=0 
                where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id 
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0  $sqlCond";
                // echo $sql;die();

                $sqlRes = sql_select($sql);
                if(count($sqlRes)==0)
                {
                    echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
                }

                $poIdArray = array();       
                $dataArray = array();       
                $color_size_id_arr = array();       
                foreach ($sqlRes as $row) 
                {
                    /*if($row['PRODUCTION_TYPE']!=2 || $row['PRODUCTION_TYPE']!=3 || $row['PRODUCTION_TYPE']!=4)
                    {
                        $row['EMBEL_NAME'] = 0;
                    }*/
                    $poIdArray[$row['PO_ID']] = $row['PO_ID'];
                    $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']][$row['ITEM_ID']][$row['COLOR_ID']][$row['PRODUCTION_TYPE']][$row['EMBEL_NAME']]['prod_qty'] += $row['QTY'];
                    $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']][$row['ITEM_ID']][$row['COLOR_ID']][$row['PRODUCTION_TYPE']][$row['EMBEL_NAME']]['reject_qty'] += $row['REJECT_QTY'];
                    if(!in_array($row['COLOR_SIZE_ID'],$color_size_id_arr))
                    {
                        $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']][$row['ITEM_ID']][$row['COLOR_ID']]['order_qty'] += $row['ORDER_QUANTITY'];
                        $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']][$row['ITEM_ID']][$row['COLOR_ID']]['buyer_name'] = $row['BUYER_NAME'];
                        $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']][$row['ITEM_ID']][$row['COLOR_ID']]['style'] = $row['STYLE_REF_NO'];
                        $color_size_id_arr[$row['COLOR_SIZE_ID']] = $row['COLOR_SIZE_ID'];
                    }
                } 
                // echo "<pre>";print_r($dataArray);echo "</pre>";

                $po_id_cond = where_con_using_array($poIdArray,0,"b.id");

                /*===================================================================================== /
                /                                      Shipment Data                                    /
                /===================================================================================== */
                $sql = "SELECT a.buyer_name,b.grouping,c.item_number_id as item_id,c.color_number_id as color_id,e.production_qnty from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c, pro_ex_factory_mst d,pro_ex_factory_dtls e where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 $sqlCond $po_id_cond";
                // echo $sql;die();
                $res = sql_select($sql);
                $ex_data = array();
                foreach ($res as $row) 
                {
                    $ex_data[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']][$row['ITEM_ID']][$row['COLOR_ID']] += $row['PRODUCTION_QNTY'];
                }

                $rowspan = array();
                foreach ($dataArray as $b_key => $b_value) 
                {
                    foreach ($b_value as $g_key => $g_value) 
                    {
                        foreach ($g_value as $i_key => $i_value) 
                        {
                            foreach ($i_value as $c_key => $c_value) 
                            {
                                $rowspan[$b_key][b]++;
                                $rowspan[$b_key][$g_key][r]++;
                                $rowspan[$b_key][$g_key][$i_key][i]++;
                            }
                        }
                    }
                }

                ?>
                <table width="100%" border="1" rules="all"  class="rpt_table" align="left" cellspacing="0" cellpadding="0" > 
                    <thead>                                                                    
                        <tr>
                            <th colspan="24">Color Wise</th>
                        </tr>
                        <tr>
                            <th width="5%">Buyer</th>
                            <th width="5%">Ref No</th>
                            <th width="5%">Style</th>
                            <th width="5%">Item</th>
                            <th width="4%">Color</th>
                            <th width="4%">Qty</th>
                            <th width="4%">Cut QC</th>
                            <th width="4%">Cut Rej</th>
                            <th width="4%">Cut Bal</th>
                            <th width="4%">Input </th>
                            <th width="4%">Input Bal</th>
                            <th width="4%">WIP with PE Rej</th>
                            <th width="4%">PE Rej</th>
                            <th width="4%">Sewing</th> 
                            <th width="4%">Sew Rej</th>
                            <th width="4%">Sew Bal</th>
                            <th width="4%">Sew WIP</th> 
                            <th width="4%">Gmt Fin</th>
                            <th width="4%">Finish Bal</th>
                            <th width="4%">Un-Finish WIP</th>
                            <th width="4%">Wash Rej</th>
                            <th width="4%">Shipment</th>
                            <th width="4%">Ship Bal</th>
                            <th width="4%">Ready to Ship</th>
                       </tr>
                    </thead>
                </table>
                <div style="max-height:425px; overflow-y:auto; width:100%;" id="scroll_body">
                    <table width="100%" border="1" rules="all"  class="rpt_table" cellpadding="0" cellspacing="0">
                        <tbody>
                            <?
                            $i=1;
                            $order_qty      = 0;
                            $cutting_qty    = 0;
                            $cutting_rej    = 0;
                            $cutting_bal    = 0;
                            $input_qty      = 0;
                            $input_bal      = 0;
                            $pe_wip_reject  = 0;
                            $pe_reject      = 0;
                            $output_qty     = 0;
                            $output_rej     = 0;
                            $output_bal     = 0;
                            $output_wip     = 0;
                            $finish_qty     = 0;
                            $finish_bal     = 0;
                            $unfinish_wip   = 0;
                            $wash_rej       = 0;
                            $shipment_qty   = 0;
                            $shipment_bal   = 0;
                            $ready_to_ship  = 0;
                            ksort($dataArray);
                            foreach ($dataArray as $buyer_name=>$buyer_data) 
                            {  
                                $b = 0;
                                $buyer_order_qty      = 0;
                                $buyer_cutting_qty    = 0;
                                $buyer_cutting_rej    = 0;
                                $buyer_cutting_bal    = 0;
                                $buyer_input_qty      = 0;
                                $buyer_input_bal      = 0;
                                $buyer_pe_wip_reject  = 0;
                                $buyer_pe_reject      = 0;
                                $buyer_output_qty     = 0;
                                $buyer_output_rej     = 0;
                                $buyer_output_bal     = 0;
                                $buyer_output_wip     = 0;
                                $buyer_finish_qty     = 0;
                                $buyer_finish_bal     = 0;
                                $buyer_unfinish_wip   = 0;
                                $buyer_wash_rej       = 0;
                                $buyer_shipment_qty   = 0;
                                $buyer_shipment_bal   = 0;
                                $buyer_ready_to_ship  = 0;    
                                ksort($buyer_data); 
                                foreach ($buyer_data as $grouping => $grouping_data) 
                                { 
                                    $g = 0;
                                    foreach ($grouping_data as $item_id => $item_data) 
                                    {
                                        $it = 0;
                                        foreach ($item_data as $color_id => $val) 
                                        {                                   
                                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                            ?>
                                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('str_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="str_<? echo $i; ?>" style="" valign="middle">
                                                <? if($b==0){ ?>
                                                <td rowspan="<?=$rowspan[$buyer_name][b];?>" width="5%" title="<?=$buyer_name;?>"><p><?=substr($buyer_name,0,8);?></p></td>
                                                <? $b++;} if($g==0){ ?>
                                                <td rowspan="<?=$rowspan[$buyer_name][$grouping][r];?>" width="5%" title="<?=$grouping;?>"><p><?=substr($grouping,0,8);?></p></td>
                                                
                                                <td rowspan="<?=$rowspan[$buyer_name][$grouping][r];?>" width="5%" title="<?=$val[style];?>"><p><?=substr($val[style],0,8);?></p></td>
                                                <? $g++;} if($it==0){?>
                                                <td rowspan="<?=$rowspan[$buyer_name][$grouping][$item_id][i];?>" width="5%" title="<?=$garments_item[$item_id];?>"><p><?=substr($garments_item[$item_id],0,8);?></p></td>
                                                <? $it++;}?>
                                                <td width="4%" title="<?=$color_arr[$color_id];?>"><p><?=substr($color_arr[$color_id],0,8);?></p></td>
                                                <td width="4%" align="right"><?=fn_number_format($val['order_qty'],0);?></td>
                                                <td width="4%" align="right"><?=fn_number_format($val[1][0]['prod_qty'],0);?></td>
                                                <td width="4%" align="right"><?=fn_number_format($val[1][0]['reject_qty'],0);?></td>
                                                <td width="4%" align="right"><?=fn_number_format(($val['order_qty'] - $val[1][0]['prod_qty']),0);?></td>
                                                <td width="4%" align="right"><?=fn_number_format($val[4][0]['prod_qty'],0);?></td>
                                                <td width="4%" align="right"><?=fn_number_format(($val['order_qty'] - $val[4][0]['prod_qty']),0);?></td>
                                                <td width="4%" align="right">
                                                    <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name]."*".$grouping."*".$item_id."*".$color_id;?>','wip_with_pe_popup','WIP with PE Rej',4)">
                                                        <?=fn_number_format(($val[1][0]['prod_qty'] - $val[4][0]['prod_qty']),0);?>
                                                    </a>                                            
                                                </td>
                                                <td width="4%" align="right"><?=fn_number_format(($val[3][1]['reject_qty']+$val[3][2]['reject_qty']),0);?></td>
                                                <td width="4%" align="right"><?=fn_number_format($val[5][0]['prod_qty'],0);?></td>
                                                <td width="4%" align="right"><?=fn_number_format($val[5][0]['reject_qty'],0);?></td>
                                                <td width="4%" align="right"><?=fn_number_format(($val['order_qty'] - $val[5][0]['prod_qty']),0);?></td>
                                                <td width="4%" align="right">
                                                    <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name]."*".$grouping."*".$item_id."*".$color_id;?>','sewing_wip_popup','Sewing WIP',4)">
                                                        <?=fn_number_format(($val[4][0]['prod_qty']-($val[5][0]['prod_qty']+$val[5][0]['reject_qty'])),0);?>
                                                    </a>                                            
                                                </td>
                                                <td width="4%" align="right"><?=fn_number_format($val[8][0]['prod_qty'],0);?></td>
                                                <td width="4%" align="right"><?=fn_number_format(($val['order_qty'] - $val[8][0]['prod_qty']),0);?></td>
                                                <td width="4%" align="right">
                                                    <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name];?>','unfinish_wip_popup','Un-Finish WIP',4)">
                                                        <?=fn_number_format(($val[5][0]['prod_qty'] - ($val[8][0]['prod_qty']+$val[8][0]['reject_qty'])),0);?>
                                                    </a>                                            
                                                </td>
                                                <td width="4%" align="right"><?=fn_number_format($val[3][3]['reject_qty'],0);?></td>
                                                <td width="4%" align="right"><?=fn_number_format($ex_data[$buyer_name][$grouping][$item_id][$color_id],0);?></td>
                                                <td width="4%" align="right"><?=fn_number_format(($val['order_qty'] - $ex_data[$buyer_name][$grouping][$item_id][$color_id]),0);?></td>
                                                <td width="4%" align="right">
                                                    <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name]."*".$grouping."*".$item_id."*".$color_id;?>','ready_to_ship_popup','Ready to Ship',4)">
                                                        <?=fn_number_format(($val[8][0]['prod_qty'] - $ex_data[$buyer_name][$grouping][$item_id][$color_id]),0);?>
                                                    </a>                                            
                                                </td>
                                            </tr>
                                            <? 
                                            $i++;
                                            $buyer_order_qty      += $val['order_qty'];
                                            $buyer_cutting_qty    += $val[1][0]['prod_qty'];
                                            $buyer_cutting_rej    += $val[1][0]['reject_qty'];
                                            $buyer_cutting_bal    += $val['order_qty'] - $val[1][0]['prod_qty'];
                                            $buyer_input_qty      += $val[4][0]['prod_qty'];
                                            $buyer_input_bal      += $val['order_qty'] - $val[4][0]['prod_qty'];
                                            $buyer_pe_wip_reject  += $val[1][0]['prod_qty'] - $val[4][0]['prod_qty'];
                                            $buyer_pe_reject      += $val[3][1]['reject_qty']+$val[3][2]['reject_qty'];
                                            $buyer_output_qty     += $val[5][0]['prod_qty'];
                                            $buyer_output_rej     += $val[5][0]['reject_qty'];
                                            $buyer_output_bal     += $val['order_qty'] - $val[5][0]['prod_qty'];
                                            $buyer_output_wip     += $val[4][0]['prod_qty']-($val[5][0]['prod_qty']+$val[5][0]['reject_qty']);
                                            $buyer_finish_qty     += $val[8][0]['prod_qty'];
                                            $buyer_finish_bal     += $val['order_qty'] - $val[8][0]['prod_qty'];
                                            $buyer_unfinish_wip   += $val[5][0]['prod_qty'] - ($val[8][0]['prod_qty']+$val[8][0]['reject_qty']);
                                            $buyer_wash_rej       += $val[3][3]['reject_qty'];
                                            $buyer_shipment_qty   += $ex_data[$buyer_name][$grouping][$item_id][$color_id];
                                            $buyer_shipment_bal   += $val['order_qty'] - $ex_data[$buyer_name][$grouping][$item_id][$color_id];
                                            $buyer_ready_to_ship  += $val[8][0]['prod_qty'] - $ex_data[$buyer_name][$grouping][$item_id][$color_id]; 


                                            $order_qty      += $val['order_qty'];
                                            $cutting_qty    += $val[1][0]['prod_qty'];
                                            $cutting_rej    += $val[1][0]['reject_qty'];
                                            $cutting_bal    += $val['order_qty'] - $val[1][0]['prod_qty'];
                                            $input_qty      += $val[4][0]['prod_qty'];
                                            $input_bal      += $val['order_qty'] - $val[4][0]['prod_qty'];
                                            $pe_wip_reject  += $val[1][0]['prod_qty'] - $val[4][0]['prod_qty'];
                                            $pe_reject      += $val[3][1]['reject_qty']+$val[3][2]['reject_qty'];
                                            $output_qty     += $val[5][0]['prod_qty'];
                                            $output_rej     += $val[5][0]['reject_qty'];
                                            $output_bal     += $val['order_qty'] - $val[5][0]['prod_qty'];
                                            $output_wip     += $val[4][0]['prod_qty']-($val[5][0]['prod_qty']+$val[5][0]['reject_qty']);
                                            $finish_qty     += $val[8][0]['prod_qty'];
                                            $finish_bal     += $val['order_qty'] - $val[8][0]['prod_qty'];
                                            $unfinish_wip   += $val[5][0]['prod_qty'] - ($val[8][0]['prod_qty']+$val[8][0]['reject_qty']);
                                            $wash_rej       += $val[3][3]['reject_qty'];
                                            $shipment_qty   += $ex_data[$buyer_name][$grouping][$item_id][$color_id];
                                            $shipment_bal   += $val['order_qty'] - $ex_data[$buyer_name][$grouping][$item_id][$color_id];
                                            $ready_to_ship  += $val[8][0]['prod_qty'] - $ex_data[$buyer_name][$grouping][$item_id][$color_id];
                                        }
                                    }
                                } 
                                ?>
                                <tr style="background: #cddcdc;font-weight: bold;text-align: right;">
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>Byr Total</td>
                                    <td><?=fn_number_format($buyer_order_qty,0);?></td>
                                    <td><?=fn_number_format($buyer_cutting_qty,0);?></td>
                                    <td><?=fn_number_format($buyer_cutting_rej,0);?></td>
                                    <td><?=fn_number_format($buyer_cutting_bal,0);?></td>
                                    <td><?=fn_number_format($buyer_input_qty,0);?></td>
                                    <td><?=fn_number_format($buyer_input_bal,0);?></td>
                                    <td><?=fn_number_format($buyer_pe_wip_reject,0);?></td>
                                    <td><?=fn_number_format($buyer_pe_reject,0);?></td>
                                    <td><?=fn_number_format($buyer_output_qty,0);?></td> 
                                    <td><?=fn_number_format($buyer_output_rej,0);?></td>
                                    <td><?=fn_number_format($buyer_output_bal,0);?></td>
                                    <td><?=fn_number_format($buyer_output_wip,0);?></td> 
                                    <td><?=fn_number_format($buyer_finish_qty,0);?></td>
                                    <td><?=fn_number_format($buyer_finish_bal,0);?></td>
                                    <td><?=fn_number_format($buyer_unfinish_wip,0);?></td>
                                    <td><?=fn_number_format($buyer_wash_rej,0);?></td>
                                    <td><?=fn_number_format($buyer_shipment_qty,0);?></td>
                                    <td><?=fn_number_format($buyer_shipment_bal,0);?></td>
                                    <td><?=fn_number_format($buyer_ready_to_ship,0);?></td>
                               </tr>
                                <?                                
                            }

                           ?>
                        </tbody>
                    </table>
                </div>
                <table width="100%" border="1" rules="all"  class="rpt_table" align="left" cellspacing="0" cellpadding="0" > 
                    <tfoot> 
                        <tr>
                            <th width="5%"></th>
                            <th width="5%"></th>
                            <th width="5%"></th>
                            <th width="5%"></th>
                            <th width="4%">Total</th>
                            <th width="4%"><?=fn_number_format($order_qty,0);?></th>
                            <th width="4%"><?=fn_number_format($cutting_qty,0);?></th>
                            <th width="4%"><?=fn_number_format($cutting_rej,0);?></th>
                            <th width="4%"><?=fn_number_format($cutting_bal,0);?></th>
                            <th width="4%"><?=fn_number_format($input_qty,0);?></th>
                            <th width="4%"><?=fn_number_format($input_bal,0);?></th>
                            <th width="4%"><?=fn_number_format($pe_wip_reject,0);?></th>
                            <th width="4%"><?=fn_number_format($pe_reject,0);?></th>
                            <th width="4%"><?=fn_number_format($output_qty,0);?></th> 
                            <th width="4%"><?=fn_number_format($output_rej,0);?></th>
                            <th width="4%"><?=fn_number_format($output_bal,0);?></th>
                            <th width="4%"><?=fn_number_format($output_wip,0);?></th> 
                            <th width="4%"><?=fn_number_format($finish_qty,0);?></th>
                            <th width="4%"><?=fn_number_format($finish_bal,0);?></th>
                            <th width="4%"><?=fn_number_format($unfinish_wip,0);?></th>
                            <th width="4%"><?=fn_number_format($wash_rej,0);?></th>
                            <th width="4%"><?=fn_number_format($shipment_qty,0);?></th>
                            <th width="4%"><?=fn_number_format($shipment_bal,0);?></th>
                            <th width="4%"><?=fn_number_format($ready_to_ship,0);?></th>
                       </tr>
                    </tfoot>
                </table>
               
                <?
            }
            elseif($rptType==5) // Size Wise
            {
                $color_arr = return_library_array("select id, color_name from  lib_color", "id", "color_name");
                $size_arr = return_library_array("select id, size_name from  lib_size", "id", "size_name");
                /*===================================================================================== /
                /                                       Prod data                                       /
                /===================================================================================== */

                /*$sql = "SELECT a.buyer_name,a.style_ref_no,b.id as po_id,b.grouping,c.id as color_size_id,c.item_number_id as item_id,c.color_number_id as color_id,size_number_id as size_id,c.size_order,c.order_quantity,d.production_type,d.embel_name,e.production_qnty as qty,e.reject_qty
                from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , pro_garments_production_mst d, pro_garments_production_dtls e
                where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 $sqlCond order by c.size_order";*/
                $sql = "SELECT a.buyer_name,a.style_ref_no,b.id as po_id,b.grouping,c.id as color_size_id,c.item_number_id as item_id,c.color_number_id as color_id,size_number_id as size_id,c.size_order,c.order_quantity,d.production_type,d.embel_name,e.production_qnty as qty,e.reject_qty
                from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c left join pro_garments_production_dtls e on c.id=e.color_size_break_down_id and e.status_active=1 and e.is_deleted=0 left join pro_garments_production_mst d on e.mst_id=d.id  and d.status_active=1 and d.is_deleted=0 
                where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id 
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0  $sqlCond";
                // echo $sql;die();

                $sqlRes = sql_select($sql);
                if(count($sqlRes)==0)
                {
                    echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
                }

                $poIdArray = array();       
                $dataArray = array();       
                $color_size_id_arr = array();       
                foreach ($sqlRes as $row) 
                {
                    /*if($row['PRODUCTION_TYPE']!=2 || $row['PRODUCTION_TYPE']!=3)
                    {
                        $row['EMBEL_NAME'] = 0;
                    }*/
                    $poIdArray[$row['PO_ID']] = $row['PO_ID'];
                    $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']][$row['ITEM_ID']][$row['COLOR_ID']][$row['SIZE_ID']][$row['PRODUCTION_TYPE']][$row['EMBEL_NAME']]['prod_qty'] += $row['QTY'];
                    $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']][$row['ITEM_ID']][$row['COLOR_ID']][$row['SIZE_ID']][$row['PRODUCTION_TYPE']][$row['EMBEL_NAME']]['reject_qty'] += $row['REJECT_QTY'];
                    if(!in_array($row['COLOR_SIZE_ID'],$color_size_id_arr))
                    {
                        $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']][$row['ITEM_ID']][$row['COLOR_ID']][$row['SIZE_ID']]['order_qty'] += $row['ORDER_QUANTITY'];
                        $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']][$row['ITEM_ID']][$row['COLOR_ID']][$row['SIZE_ID']]['buyer_name'] = $row['BUYER_NAME'];
                        $dataArray[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']][$row['ITEM_ID']][$row['COLOR_ID']][$row['SIZE_ID']]['style'] = $row['STYLE_REF_NO'];
                        $color_size_id_arr[$row['COLOR_SIZE_ID']] = $row['COLOR_SIZE_ID'];
                    }
                } 
                // echo "<pre>";print_r($dataArray);echo "</pre>";

                $po_id_cond = where_con_using_array($poIdArray,0,"b.id");

                /*===================================================================================== /
                /                                      Shipment Data                                    /
                /===================================================================================== */
                $sql = "SELECT a.buyer_name,b.grouping,c.item_number_id as item_id,c.color_number_id as color_id,size_number_id as size_id,e.production_qnty from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c, pro_ex_factory_mst d,pro_ex_factory_dtls e where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id
                and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 $sqlCond $po_id_cond";
                // echo $sql;die();
                $res = sql_select($sql);
                $ex_data = array();
                foreach ($res as $row) 
                {
                    $ex_data[$buyer_name_arr[$row['BUYER_NAME']]][$row['GROUPING']][$row['ITEM_ID']][$row['COLOR_ID']][$row['SIZE_ID']] += $row['PRODUCTION_QNTY'];
                }
                // echo "<pre>";print_r($ex_data);echo "</pre>";die;

                $rowspan = array();
                foreach ($dataArray as $b_key => $b_value) 
                {
                    foreach ($b_value as $g_key => $g_value) 
                    {
                        foreach ($g_value as $i_key => $i_value) 
                        {
                            foreach ($i_value as $c_key => $c_value) 
                            {
                                foreach ($c_value as $s_key => $s_value) 
                                {
                                    $rowspan[$b_key][b]++;
                                    $rowspan[$b_key][$g_key][r]++;
                                    $rowspan[$b_key][$g_key][$i_key][i]++;
                                    $rowspan[$b_key][$g_key][$i_key][$c_key][c]++;
                                }
                            }
                        }
                    }
                }
                ?>
                <table width="100%" border="1" rules="all"  class="rpt_table" align="left" cellspacing="0" cellpadding="0" > 
                    <thead>                                                                    
                        <tr>
                            <th colspan="25">Size Wise</th>
                        </tr>
                        <tr>
                            <th width="4%">Buyer</th>
                            <th width="4%">Ref No</th>
                            <th width="4%">Style</th>
                            <th width="4%">Item</th>
                            <th width="4%">Color</th>
                            <th width="4%">Size</th>
                            <th width="4%">Qty</th>
                            <th width="4%">Cut QC</th>
                            <th width="4%">Cut Rej</th>
                            <th width="4%">Cut Bal</th>
                            <th width="4%">Input </th>
                            <th width="4%">Input Bal</th>
                            <th width="4%">WIP with PE Rej</th>
                            <th width="4%">PE Rej</th>
                            <th width="4%">Sewing</th> 
                            <th width="4%">Sew Rej</th>
                            <th width="4%">Sew Bal</th>
                            <th width="4%">Sew WIP</th> 
                            <th width="4%">Gmt Fin</th>
                            <th width="4%">Finish Bal</th>
                            <th width="4%">Un-Finish WIP</th>
                            <th width="4%">Wash Rej</th>
                            <th width="4%">Shipment</th>
                            <th width="4%">Ship Bal</th>
                            <th width="4%">Ready to Ship</th>
                       </tr>
                    </thead>
                </table>
                <div style="max-height:1425px; overflow-y:auto; width:100%;" id="scroll_body">
                    <table width="100%" border="1" rules="all"  class="rpt_table" cellpadding="0" cellspacing="0">
                        <tbody>
                            <?
                            $i=1;
                            $order_qty      = 0;
                            $cutting_qty    = 0;
                            $cutting_rej    = 0;
                            $cutting_bal    = 0;
                            $input_qty      = 0;
                            $input_bal      = 0;
                            $pe_wip_reject  = 0;
                            $pe_reject      = 0;
                            $output_qty     = 0;
                            $output_rej     = 0;
                            $output_bal     = 0;
                            $output_wip     = 0;
                            $finish_qty     = 0;
                            $finish_bal     = 0;
                            $unfinish_wip   = 0;
                            $wash_rej       = 0;
                            $shipment_qty   = 0;
                            $shipment_bal   = 0;
                            $ready_to_ship  = 0;
                            ksort($dataArray);
                            foreach ($dataArray as $buyer_name=>$buyer_data) 
                            {      
                                $b=0;                                
                                $buyer_order_qty      = 0;
                                $buyer_cutting_qty    = 0;
                                $buyer_cutting_rej    = 0;
                                $buyer_cutting_bal    = 0;
                                $buyer_input_qty      = 0;
                                $buyer_input_bal      = 0;
                                $buyer_pe_wip_reject  = 0;
                                $buyer_pe_reject      = 0;
                                $buyer_output_qty     = 0;
                                $buyer_output_rej     = 0;
                                $buyer_output_bal     = 0;
                                $buyer_output_wip     = 0;
                                $buyer_finish_qty     = 0;
                                $buyer_finish_bal     = 0;
                                $buyer_unfinish_wip   = 0;
                                $buyer_wash_rej       = 0;
                                $buyer_shipment_qty   = 0;
                                $buyer_shipment_bal   = 0;
                                $buyer_ready_to_ship  = 0;
                                ksort($buyer_data); 
                                foreach ($buyer_data as $grouping => $grouping_data) 
                                { 
                                    $g=0;
                                    foreach ($grouping_data as $item_id => $item_data) 
                                    {
                                        $it=0;
                                        foreach ($item_data as $color_id => $color_data) 
                                        {
                                            $c=0;
                                            foreach ($color_data as $size_id => $val) 
                                            {                                   
                                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                                ?>
                                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('str_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="str_<? echo $i; ?>" style="" valign="middle">
                                                    <? if($b==0){?>
                                                    <td rowspan="<?=$rowspan[$buyer_name][b];?>"  width="4%" title="<?=$buyer_name;?>"><p><?=substr($buyer_name,0,8);?></p></td>
                                                    <? $b++;} if($g==0){?>
                                                    <td rowspan="<?=$rowspan[$buyer_name][$grouping][r];?>" width="4%" title="<?=$grouping;?>"><p><?=substr($grouping,0,8);?></p></td>
                                                    <td rowspan="<?=$rowspan[$buyer_name][$grouping][r];?>" width="4%" title="<?=$val[style];?>"><p><?=substr($val[style],0,6);?></p></td>
                                                    <? $g++;} if($it==0){?>
                                                    <td rowspan="<?=$rowspan[$buyer_name][$grouping][$item_id][i];?>" width="4%" title="<?=$garments_item[$item_id];?>"><p><?=substr($garments_item[$item_id],0,6);?></p></td>
                                                    <? $it++;} if($c==0){?>
                                                    <td rowspan="<?=$rowspan[$buyer_name][$grouping][$item_id][$color_id][c];?>" width="4%" title="<?=$color_arr[$color_id];?>"><p><?=substr($color_arr[$color_id],0,8);?></p></td>
                                                    <? $c++;}?>
                                                    <td width="4%" title="<?=$size_arr[$size_id];?>"><p><?=substr($size_arr[$size_id],0,6);?></p></td>
                                                    <td width="4%" align="right"><?=fn_number_format($val['order_qty'],0);?></td>
                                                    <td width="4%" align="right"><?=fn_number_format($val[1][0]['prod_qty'],0);?></td>
                                                    <td width="4%" align="right"><?=fn_number_format($val[1][0]['reject_qty'],0);?></td>
                                                    <td width="4%" align="right"><?=fn_number_format(($val['order_qty'] - $val[1][0]['prod_qty']),0);?></td>
                                                    <td width="4%" align="right"><?=fn_number_format($val[4][0]['prod_qty'],0);?></td>
                                                    <td width="4%" align="right"><?=fn_number_format(($val['order_qty'] - $val[4][0]['prod_qty']),0);?></td>
                                                    <td width="4%" align="right">
                                                        <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name]."*".$grouping."*".$item_id."*".$color_id."*".$size_id;?>','wip_with_pe_popup','WIP with PE Rej',5)">
                                                            <?=fn_number_format(($val[1][0]['prod_qty'] - $val[4][0]['prod_qty']),0);?>
                                                        </a>                                            
                                                    </td>
                                                    <td width="4%" align="right"><?=fn_number_format(($val[3][1]['reject_qty']+$val[3][2]['reject_qty']),0);?></td>
                                                    <td width="4%" align="right"><?=fn_number_format($val[5][0]['prod_qty'],0);?></td>
                                                    <td width="4%" align="right"><?=fn_number_format($val[5][0]['reject_qty'],0);?></td>
                                                    <td width="4%" align="right"><?=fn_number_format(($val['order_qty'] - $val[5][0]['prod_qty']),0);?></td>
                                                    <td width="4%" align="right">
                                                        <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name]."*".$grouping."*".$item_id."*".$color_id."*".$size_id;?>','sewing_wip_popup','Sewing WIP',5)">
                                                            <?=fn_number_format(($val[4][0]['prod_qty']-($val[5][0]['prod_qty']+$val[5][0]['reject_qty'])),0);?>
                                                        </a>                                            
                                                    </td>
                                                    <td width="4%" align="right"><?=fn_number_format($val[8][0]['prod_qty'],0);?></td>
                                                    <td width="4%" align="right"><?=fn_number_format(($val['order_qty'] - $val[8][0]['prod_qty']),0);?></td>
                                                    <td width="4%" align="right">
                                                        <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name]."*".$grouping."*".$item_id."*".$color_id."*".$size_id;?>','unfinish_wip_popup','Un-Finish WIP',5)">
                                                            <?=fn_number_format(($val[5][0]['prod_qty'] - ($val[8][0]['prod_qty']+$val[8][0]['reject_qty'])),0);?>
                                                        </a>                                            
                                                    </td>
                                                    <td width="4%" align="right"><?=fn_number_format($val[3][3]['reject_qty'],0);?></td>
                                                    <td width="4%" align="right"><?=fn_number_format($ex_data[$buyer_name][$grouping][$item_id][$color_id][$size_id],0);?></td>
                                                    <td width="4%" align="right"><?=fn_number_format(($val['order_qty'] - $ex_data[$buyer_name][$grouping][$item_id][$color_id][$size_id]),0);?></td>
                                                    <td width="4%" align="right" title="<?=$val[8][0]['prod_qty']."**".$ex_data[$buyer_name][$grouping][$item_id][$color_id][$size_id];?>">
                                                        <a href="javascript:void(0);" onclick="open_rmg_popup('<?=$search_data."*".$val[buyer_name]."*".$grouping."*".$item_id."*".$color_id."*".$size_id;?>','ready_to_ship_popup','Ready to Ship',5)">
                                                            <?=fn_number_format(($val[8][0]['prod_qty'] - $ex_data[$buyer_name][$grouping][$item_id][$color_id][$size_id]),0);?>
                                                        </a>                                            
                                                    </td>
                                                </tr>
                                                <? 
                                                $i++;
                                                $buyer_order_qty      += $val['order_qty'];
                                                $buyer_cutting_qty    += $val[1][0]['prod_qty'];
                                                $buyer_cutting_rej    += $val[1][0]['reject_qty'];
                                                $buyer_cutting_bal    += $val['order_qty'] - $val[1][0]['prod_qty'];
                                                $buyer_input_qty      += $val[4][0]['prod_qty'];
                                                $buyer_input_bal      += $val['order_qty'] - $val[4][0]['prod_qty'];
                                                $buyer_pe_wip_reject  += $val[1][0]['prod_qty'] - $val[4][0]['prod_qty'];
                                                $buyer_pe_reject      += $val[3][1]['reject_qty']+$val[3][2]['reject_qty'];
                                                $buyer_output_qty     += $val[5][0]['prod_qty'];
                                                $buyer_output_rej     += $val[5][0]['reject_qty'];
                                                $buyer_output_bal     += $val['order_qty'] - $val[5][0]['prod_qty'];
                                                $buyer_output_wip     += $val[4][0]['prod_qty']-($val[5][0]['prod_qty']+$val[5][0]['reject_qty']);
                                                $buyer_finish_qty     += $val[8][0]['prod_qty'];
                                                $buyer_finish_bal     += $val['order_qty'] - $val[8][0]['prod_qty'];
                                                $buyer_unfinish_wip   += $val[5][0]['prod_qty'] - ($val[8][0]['prod_qty']+$val[8][0]['reject_qty']);
                                                $buyer_wash_rej       += $val[3][3]['reject_qty'];
                                                $buyer_shipment_qty   += $ex_data[$buyer_name][$grouping][$item_id][$color_id][$size_id];
                                                $buyer_shipment_bal   += $val['order_qty'] - $ex_data[$buyer_name][$grouping][$item_id][$color_id][$size_id];
                                                $buyer_ready_to_ship  += $val[8][0]['prod_qty'] - $ex_data[$buyer_name][$grouping][$item_id][$color_id][$size_id]; 


                                                $order_qty      += $val['order_qty'];
                                                $cutting_qty    += $val[1][0]['prod_qty'];
                                                $cutting_rej    += $val[1][0]['reject_qty'];
                                                $cutting_bal    += $val['order_qty'] - $val[1][0]['prod_qty'];
                                                $input_qty      += $val[4][0]['prod_qty'];
                                                $input_bal      += $val['order_qty'] - $val[4][0]['prod_qty'];
                                                $pe_wip_reject  += $val[1][0]['prod_qty'] - $val[4][0]['prod_qty'];
                                                $pe_reject      += $val[3][1]['reject_qty']+$val[3][2]['reject_qty'];
                                                $output_qty     += $val[5][0]['prod_qty'];
                                                $output_rej     += $val[5][0]['reject_qty'];
                                                $output_bal     += $val['order_qty'] - $val[5][0]['prod_qty'];
                                                $output_wip     += $val[4][0]['prod_qty']-($val[5][0]['prod_qty']+$val[5][0]['reject_qty']);
                                                $finish_qty     += $val[8][0]['prod_qty'];
                                                $finish_bal     += $val['order_qty'] - $val[8][0]['prod_qty'];
                                                $unfinish_wip   += $val[5][0]['prod_qty'] - ($val[8][0]['prod_qty']+$val[8][0]['reject_qty']);
                                                $wash_rej       += $val[3][3]['reject_qty'];
                                                $shipment_qty   += $ex_data[$buyer_name][$grouping][$item_id][$color_id][$size_id];
                                                $shipment_bal   += $val['order_qty'] - $ex_data[$buyer_name][$grouping][$item_id][$color_id][$size_id];
                                                $ready_to_ship  += $val[8][0]['prod_qty'] - $ex_data[$buyer_name][$grouping][$item_id][$color_id][$size_id];
                                            }
                                        }
                                    }
                                } 
                                ?>
                                <tr style="background: #cddcdc;font-weight: bold;text-align: right;">
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>Byr Total</td>
                                    <td><?=fn_number_format($buyer_order_qty,0);?></td>
                                    <td><?=fn_number_format($buyer_cutting_qty,0);?></td>
                                    <td><?=fn_number_format($buyer_cutting_rej,0);?></td>
                                    <td><?=fn_number_format($buyer_cutting_bal,0);?></td>
                                    <td><?=fn_number_format($buyer_input_qty,0);?></td>
                                    <td><?=fn_number_format($buyer_input_bal,0);?></td>
                                    <td><?=fn_number_format($buyer_pe_wip_reject,0);?></td>
                                    <td><?=fn_number_format($buyer_pe_reject,0);?></td>
                                    <td><?=fn_number_format($buyer_output_qty,0);?></td> 
                                    <td><?=fn_number_format($buyer_output_rej,0);?></td>
                                    <td><?=fn_number_format($buyer_output_bal,0);?></td>
                                    <td><?=fn_number_format($buyer_output_wip,0);?></td> 
                                    <td><?=fn_number_format($buyer_finish_qty,0);?></td>
                                    <td><?=fn_number_format($buyer_finish_bal,0);?></td>
                                    <td><?=fn_number_format($buyer_unfinish_wip,0);?></td>
                                    <td><?=fn_number_format($buyer_wash_rej,0);?></td>
                                    <td><?=fn_number_format($buyer_shipment_qty,0);?></td>
                                    <td><?=fn_number_format($buyer_shipment_bal,0);?></td>
                                    <td><?=fn_number_format($buyer_ready_to_ship,0);?></td>
                               </tr>
                                <?                                
                            }
                           ?>
                        </tbody>
                    </table>
                </div>
                <table width="100%" border="1" rules="all"  class="rpt_table" align="left" cellspacing="0" cellpadding="0" > 
                    <tfoot> 
                        <tr>
                            <th width="4%"></th>
                            <th width="4%"></th>
                            <th width="4%"></th>
                            <th width="4%"></th>
                            <th width="4%"></th>
                            <th width="4%">Total</th>
                            <th width="4%"><?=fn_number_format($order_qty,0);?></th>
                            <th width="4%"><?=fn_number_format($cutting_qty,0);?></th>
                            <th width="4%"><?=fn_number_format($cutting_rej,0);?></th>
                            <th width="4%"><?=fn_number_format($cutting_bal,0);?></th>
                            <th width="4%"><?=fn_number_format($input_qty,0);?></th>
                            <th width="4%"><?=fn_number_format($input_bal,0);?></th>
                            <th width="4%"><?=fn_number_format($pe_wip_reject,0);?></th>
                            <th width="4%"><?=fn_number_format($pe_reject,0);?></th>
                            <th width="4%"><?=fn_number_format($output_qty,0);?></th> 
                            <th width="4%"><?=fn_number_format($output_rej,0);?></th>
                            <th width="4%"><?=fn_number_format($output_bal,0);?></th>
                            <th width="4%"><?=fn_number_format($output_wip,0);?></th> 
                            <th width="4%"><?=fn_number_format($finish_qty,0);?></th>
                            <th width="4%"><?=fn_number_format($finish_bal,0);?></th>
                            <th width="4%"><?=fn_number_format($unfinish_wip,0);?></th>
                            <th width="4%"><?=fn_number_format($wash_rej,0);?></th>
                            <th width="4%"><?=fn_number_format($shipment_qty,0);?></th>
                            <th width="4%"><?=fn_number_format($shipment_bal,0);?></th>
                            <th width="4%"><?=fn_number_format($ready_to_ship,0);?></th>
                       </tr>
                    </tfoot>
                </table>
               
                <?
            }
           
            ?>
        </fieldset>
    </div>
    <?
    foreach (glob("$user_id*.xls") as $filename) 
    {
        if( @filemtime($filename) < (time()-$seconds_old) )
        @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename="tmp/".$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');
    $is_created = fwrite($create_new_doc,ob_get_contents());
   // $filename=$user_id."_".$name.".xls";
    echo "$total_data####$filename";
    exit();
}

if($action=="wip_with_pe_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_floor = return_library_array("select id,floor_name from lib_prod_floor", "id", "floor_name");
    $lib_supplier = return_library_array("select id,short_name from lib_supplier", "id", "short_name");
    extract($_REQUEST);
    list($company_id,$location_name,$buyer_name,$season_name,$client,$merchant,$int_ref,$shipment_status,$order_status,$status,$search_by,$date_from,$date_to,$buyer_id,$int_ref_no,$item_id,$color_id,$size_id) = explode("*", $data);

    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    if($type==2)
    {
        $sqlCond .= ($buyer_id != 0)       ? " and a.client_id=$buyer_id"            : "";
    }
    else
    {
        $sqlCond .= ($buyer_id != 0)   ? " and a.buyer_name=$buyer_id"         : "";
    }
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    $sqlCond .= ($merchant != 0)     ? " and a.factory_marchant=$merchant"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    $sqlCond .= ($int_ref !="")  ? " and b.grouping ='$int_ref'"      : "";
    $sqlCond .= ($item_id !="")   ? " and c.item_number_id=$item_id" : "";
    $sqlCond .= ($color_id !="")   ? " and c.color_number_id=$color_id" : "";
    $sqlCond .= ($size_id !="")   ? " and c.size_number_id=$size_id" : "";
    
    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active = $status" : "";
    //$sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }
    // echo "string".$sqlCond;die(); 

    $sql = "SELECT d.production_source as source, d.serving_company, e.cut_no, d.floor_id,d.production_type,d.embel_name,e.production_qnty as qty,e.reject_qty from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , pro_garments_production_mst d, pro_garments_production_dtls e where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and d.production_type in(1,2,3,4) $sqlCond"; 
    // echo $sql;die();
    $res = sql_select($sql);
    $cutting_data = array();
    $input_data = array();
    $print_data = array();
    $emb_data = array();
    $cutting_no_arr = array();

    foreach ($res as $val) 
    {
        if($val['PRODUCTION_TYPE']==4)
        {
            $cutting_no_arr[$val['CUT_NO']] = $val['CUT_NO'];        
        }
    }
    if(count($cutting_no_arr)>0)
    {
        $cut_cond = where_con_using_array($cutting_no_arr,1,"b.cut_no");
        $cut_no_floor_arr = return_library_array("select a.floor_id,b.cut_no from pro_garments_production_mst a,pro_garments_production_dtls b where a.id=b.mst_id and a.status_active=1 and b.status_active=1 and a.production_type=1 $cut_cond", "cut_no", "floor_id");
        // echo "<pre>";print_r($cut_no_floor_arr);echo "</pre>";
    }


    foreach ($res as $val) 
    {
        if($val['PRODUCTION_TYPE']==1)
        {
            $cutting_data[$lib_floor[$val['FLOOR_ID']]]['qty'] += $val['QTY'];
            $cutting_data[$lib_floor[$val['FLOOR_ID']]]['rej_qty'] += $val['REJECT_QTY'];
        }
        if($val['PRODUCTION_TYPE']==4)
        {
            $input_data[$lib_floor[$cut_no_floor_arr[$val['CUT_NO']]]]['qty'] += $val['QTY'];
            $input_data[$lib_floor[$cut_no_floor_arr[$val['CUT_NO']]]]['rej_qty'] += $val['REJECT_QTY'];
        }

        if($val['PRODUCTION_TYPE']==2 || $val['PRODUCTION_TYPE']==3)
        {
            if($val['SOURCE']==1)
            {
                $c_name = $company_short_name_arr[$val['SERVING_COMPANY']];
            }
            else
            {
                $c_name = $lib_supplier[$val['SERVING_COMPANY']];
            }
            if($val['EMBEL_NAME']==1)
            {
                $print_data[$c_name][$val['PRODUCTION_TYPE']]['qty'] += $val['QTY'];
                $print_data[$c_name][$val['PRODUCTION_TYPE']]['rej_qty'] += $val['REJECT_QTY'];
            }
            elseif ($val['EMBEL_NAME']==2) 
            {                
                $emb_data[$c_name][$val['PRODUCTION_TYPE']]['qty'] += $val['QTY'];
                $emb_data[$c_name][$val['PRODUCTION_TYPE']]['rej_qty'] += $val['REJECT_QTY'];
            }
        }
    }
    // echo "<pre>";print_r($emb_data);echo "</pre>";    
    
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 300;" id="details_reports">
        <div class="main_part" style="width:300px;">
            <div>
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="280">
                    <caption><b>WIP with PE Rej</b></caption>
                    <thead>
                        <tr>
                            <th width="100">Type of Floor</th>
                            <th width="150">Name of Floor</th>
                            <th width="80">Qty</th>
                        </tr>
                    </thead>
                </table>
            </div>
            <div style="width:300px;overflow-y:auto;max-height:300px;" id="scroll_body">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="280">
                    <tbody>
                        <?
                        $i=0;
                        ksort($cutting_data);
                        $tot = 0;
                        foreach ($cutting_data as $f_name => $row) 
                        {                                
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                <? if($i==0){?>
                                <td rowspan="<?=count($cutting_data);?>" width="100">Cutting</td>
                                <?}?>
                                <td width="150"><?=$f_name;?></td>
                                <td width="80" align="right"><?=fn_number_format(($row['qty']-$input_data[$f_name]['qty']),0);?></td>
                            </tr>
                            <?
                            $i++;
                            $tot += $row['qty']-$input_data[$f_name]['qty'];
                            
                        }
                        ?>
                        <tr style="background: #cddcdc;font-weight: bold;text-align: right;">
                            <th></th>
                            <th>Total</th>
                            <th><?=fn_number_format($tot,0);?></th>
                        </tr>
                        <?
                        $j=0;
                        ksort($print_data);
                        $tot = 0;
                        foreach ($print_data as $f_name => $row) 
                        {                                
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                <? if($j==0){?>
                                <td rowspan="<?=count($print_data);?>" width="100">Printing</td>
                                <?}?>
                                <td width="150"><?=$f_name;?></td>
                                <td width="80" align="right"><?=fn_number_format(($row[2]['qty']-$row[3]['qty']),0);?></td>
                            </tr>
                            <?
                            $i++;
                            $j++;
                            $tot += $row[2]['qty']-$row[3]['qty'];
                            
                        }
                        ?>
                        <tr style="background: #cddcdc;font-weight: bold;text-align: right;">
                            <th></th>
                            <th>Total</th>
                            <th><?=fn_number_format($tot,0);?></th>
                        </tr>
                        <?
                        $k=0;
                        ksort($emb_data);
                        $tot = 0;
                        foreach ($emb_data as $f_name => $row) 
                        {                                
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                <? if($k==0){?>
                                <td rowspan="<?=count($emb_data);?>" width="100">Embroidery</td>
                                <?}?>
                                <td width="150"><?=$f_name;?></td>
                                <td width="80" align="right"><?=fn_number_format(($row[2]['qty']-$row[3]['qty']),0);?></td>
                            </tr>
                            <?
                            $i++;
                            $k++;
                            $tot += $row[2]['qty']-$row[3]['qty'];
                            
                        }
                        ?>
                        <tr style="background: #cddcdc;font-weight: bold;text-align: right;">
                            <th></th>
                            <th>Total</th>
                            <th><?=fn_number_format($tot,0);?></th>
                        </tr>
                        

                    </tbody>
                </table>
            </div>
        </div>
    </div>  
    <?
}

if($action=="sewing_wip_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');

    extract($_REQUEST);
    list($company_id,$location_name,$buyer_name,$season_name,$client,$merchant,$int_ref,$shipment_status,$order_status,$status,$search_by,$date_from,$date_to,$buyer_id,$int_ref_no,$item_id,$color_id,$size_id) = explode("*", $data);


    $lib_floor = return_library_array("select id,floor_name from lib_prod_floor", "id", "floor_name");
    $lib_supplier = return_library_array("select id,short_name from lib_supplier", "id", "short_name");
    $lineArr = return_library_array("select id,line_name from lib_sewing_line where company_name=$company_id","id","line_name"); 
    $prod_reso_arr=return_library_array( "select id, line_number from prod_resource_mst",'id','line_number');


    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    if($type==2)
    {
        $sqlCond .= ($buyer_id != 0)       ? " and a.client_id=$buyer_id"            : "";
    }
    else
    {
        $sqlCond .= ($buyer_id != 0)   ? " and a.buyer_name=$buyer_id"         : "";
    }
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    $sqlCond .= ($merchant != 0)     ? " and a.factory_marchant=$merchant"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    $sqlCond .= ($int_ref !="")  ? " and b.grouping ='$int_ref'"      : "";
    $sqlCond .= ($item_id !="")   ? " and c.item_number_id=$item_id" : "";
    $sqlCond .= ($color_id !="")   ? " and c.color_number_id=$color_id" : "";
    $sqlCond .= ($size_id !="")   ? " and c.size_number_id=$size_id" : "";
    
    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active = $status" : "";
    //$sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }
    // echo "string".$sqlCond;die(); 

    $sql = "SELECT d.prod_reso_allo,d.serving_company, d.production_source as source,d.floor_id,d.sewing_line,d.production_type,e.production_qnty as qty,e.reject_qty from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , pro_garments_production_mst d, pro_garments_production_dtls e where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and d.production_type in(4,5) $sqlCond"; 
    // echo $sql;die();
    $res = sql_select($sql);
    $sewing_data = array();
    $outbound_data = array();

    foreach ($res as $val) 
    {
        if($val['SOURCE']==1)
        {
            $sewing_line='';            
            if($val['PROD_RESO_ALLO']==1)
            {
                $line_number=explode(",",$prod_reso_arr[$val['SEWING_LINE']]);
                foreach($line_number as $vals)
                {
                    if($sewing_line=='') $sewing_line=$lineArr[$vals]; else $sewing_line.=",".$lineArr[$vals];
                }
            }
            else 
            {
                $sewing_line=$lineArr[$val['SEWING_LINE']];
            }

            $sewing_data[$lib_floor[$val['FLOOR_ID']]][$sewing_line][$val['PRODUCTION_TYPE']]['qty'] += $val['QTY'];
            $sewing_data[$lib_floor[$val['FLOOR_ID']]][$sewing_line][$val['PRODUCTION_TYPE']]['rej_qty'] += $val['REJECT_QTY'];
        }
        else
        {
            $outbound_data[$lib_supplier[$val['SERVING_COMPANY']]][$val['PRODUCTION_TYPE']]['qty'] += $val['QTY'];
            $outbound_data[$lib_supplier[$val['SERVING_COMPANY']]][$val['PRODUCTION_TYPE']]['rej_qty'] += $val['REJECT_QTY'];
        }
        
    }
    // echo "<pre>";print_r($sewing_data);echo "</pre>";    

    $rowspan = array();
    foreach ($sewing_data as $fkey => $fvalue) 
    {
        foreach ($fvalue as $lkey => $lvalue) 
        {
            $rowspan[$fkey]++;
        }
    }
    // echo "<pre>";print_r($rowspan);echo "</pre>";    
    
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 300;" id="details_reports">
        <div class="main_part" style="width:300px;">
            <div>
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="280">
                    <caption><b>Sewing WIP</b></caption>
                    <thead>
                        <tr>
                            <th width="100">Floor Name</th>
                            <th width="150">Line Name</th>
                            <th width="80">Qty</th>
                        </tr>
                    </thead>
                </table>
            </div>
            <div style="width:300px;overflow-y:auto;max-height:300px;" id="scroll_body">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="280">
                    <tbody>
                        <?
                        $i=0;
                        ksort($sewing_data);
                        $tot = 0;
                        foreach ($sewing_data as $f_name => $f_data) 
                        {  
                            $flr=0;
                            ksort($f_data);
                            foreach ($f_data as $l_name => $row) 
                            {                            
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                    <? if($flr==0){?>
                                    <td rowspan="<?=$rowspan[$f_name];?>" width="100"><?=$f_name;?></td>
                                    <? $flr++;}?>
                                    <td width="150"><?=$l_name;?></td>
                                    <td width="80" align="right"><?=fn_number_format(($row[4]['qty']-($row[5]['qty']+$row[5]['rej_qty'])),0);?></td>
                                </tr>
                                <?
                                $i++;
                                $tot += $row[4]['qty']-($row[5]['qty']+$row[5]['rej_qty']);
                            }                            
                        }
                        // ================== outbound data ============= 
                        ksort($outbound_data);
                        foreach ($outbound_data as $co_name => $row) 
                        {                            
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                   
                                    <td width="100"><?=$co_name;?></td>                                   
                                    <td width="150">Outbound</td>
                                    <td width="80" align="right"><?=fn_number_format(($row[4]['qty']-($row[5]['qty']+$row[5]['rej_qty'])),0);?></td>
                                </tr>
                                <?
                                $i++;
                                $tot += $row[4]['qty']-($row[5]['qty']+$row[5]['rej_qty']);
                                                       
                        }
                        ?>
                    </tbody>
                    <tfoot>                        
                        <tr style="background: #cddcdc;font-weight: bold;text-align: right;">
                            <th></th>
                            <th>Total</th>
                            <th><?=fn_number_format($tot,0);?></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>  
    <?
}

if($action=="unfinish_wip_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_floor = return_library_array("select id,floor_name from lib_prod_floor", "id", "floor_name");
    $lib_supplier = return_library_array("select id,short_name from lib_supplier", "id", "short_name");
    extract($_REQUEST);
    list($company_id,$location_name,$buyer_name,$season_name,$client,$merchant,$int_ref,$shipment_status,$order_status,$status,$search_by,$date_from,$date_to,$buyer_id,$int_ref_no,$item_id,$color_id,$size_id) = explode("*", $data);

    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    if($type==2)
    {
        $sqlCond .= ($buyer_id != 0)       ? " and a.client_id=$buyer_id"            : "";
    }
    else
    {
        $sqlCond .= ($buyer_id != 0)   ? " and a.buyer_name=$buyer_id"         : "";
    }
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    $sqlCond .= ($merchant != 0)     ? " and a.factory_marchant=$merchant"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    $sqlCond .= ($int_ref !="")  ? " and b.grouping ='$int_ref'"      : "";
    $sqlCond .= ($item_id !="")   ? " and c.item_number_id=$item_id" : "";
    $sqlCond .= ($color_id !="")   ? " and c.color_number_id=$color_id" : "";
    $sqlCond .= ($size_id !="")   ? " and c.size_number_id=$size_id" : "";
    
    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active = $status" : "";
    //$sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }
    // echo "string".$sqlCond;die(); 

    $sql = "SELECT d.production_source as source, d.serving_company, e.cut_no, d.floor_id,d.production_type,d.embel_name,e.production_qnty as qty,e.reject_qty from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , pro_garments_production_mst d, pro_garments_production_dtls e where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and d.production_type in(2,3,5,8) $sqlCond"; 
    // echo $sql;die();
    $res = sql_select($sql);
    $cutting_data = array();
    $input_data = array();
    $wash_data = array();
    $cutting_no_arr = array();

    /*foreach ($res as $val) 
    {
        if($val['PRODUCTION_TYPE']==4)
        {
            $cutting_no_arr[$val['CUT_NO']] = $val['CUT_NO'];        
        }
    }
    if(count($cutting_no_arr)>0)
    {
        $cut_cond = where_con_using_array($cutting_no_arr,1,"b.cut_no");
        $cut_no_floor_arr = return_library_array("select a.floor_id,b.cut_no from pro_garments_production_mst a,pro_garments_production_dtls b where a.id=b.mst_id and a.status_active=1 and b.status_active=1 and a.production_type=1 $cut_cond", "cut_no", "floor_id");
        // echo "<pre>";print_r($cut_no_floor_arr);echo "</pre>";
    }*/


    foreach ($res as $val) 
    {
        if($val['PRODUCTION_TYPE']==1)
        {
            $cutting_data[$lib_floor[$val['FLOOR_ID']]]['qty'] += $val['QTY'];
            $cutting_data[$lib_floor[$val['FLOOR_ID']]]['rej_qty'] += $val['REJECT_QTY'];
        }
        if($val['PRODUCTION_TYPE']==4)
        {
            $input_data[$lib_floor[$cut_no_floor_arr[$val['CUT_NO']]]]['qty'] += $val['QTY'];
            $input_data[$lib_floor[$cut_no_floor_arr[$val['CUT_NO']]]]['rej_qty'] += $val['REJECT_QTY'];
        }

        if($val['PRODUCTION_TYPE']==2 || $val['PRODUCTION_TYPE']==3)
        {
            if($val['SOURCE']==1)
            {
                $c_name = $company_short_name_arr[$val['SERVING_COMPANY']];
            }
            else
            {
                $c_name = $lib_supplier[$val['SERVING_COMPANY']];
            }
            if($val['EMBEL_NAME']==3)
            {
                $wash_data[$c_name][$val['PRODUCTION_TYPE']]['qty'] += $val['QTY'];
                $wash_data[$c_name][$val['PRODUCTION_TYPE']]['rej_qty'] += $val['REJECT_QTY'];
            }
        }
    }
    // echo "<pre>";print_r($emb_data);echo "</pre>";    
    
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 300;" id="details_reports">
        <div class="main_part" style="width:300px;">
            <div>
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="280">
                    <caption><b>WIP with PE Rej</b></caption>
                    <thead>
                        <tr>
                            <th width="100">Type of Emb.</th>
                            <th width="150">Party</th>
                            <th width="80">Qty</th>
                        </tr>
                    </thead>
                </table>
            </div>
            <div style="width:300px;overflow-y:auto;max-height:300px;" id="scroll_body">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="280">
                    <tbody>
                        
                        <?
                        $j=0;
                        ksort($wash_data);
                        $tot = 0;
                        foreach ($wash_data as $f_name => $row) 
                        {                                
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                <? if($j==0){?>
                                <td rowspan="<?=count($wash_data);?>" width="100">Washing</td>
                                <?}?>
                                <td width="150"><?=$f_name;?></td>
                                <td width="80" align="right"><?=fn_number_format(($row[2]['qty']-$row[3]['qty']),0);?></td>
                            </tr>
                            <?
                            $i++;
                            $j++;
                            $tot += $row[2]['qty']-$row[3]['qty'];
                            
                        }
                        ?>
                        <tr style="background: #cddcdc;font-weight: bold;text-align: right;">
                            <th></th>
                            <th>Total</th>
                            <th><?=fn_number_format($tot,0);?></th>
                        </tr>
                        

                    </tbody>
                </table>
            </div>
        </div>
    </div>  
    <?
}

if($action=="ready_to_ship_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');

    extract($_REQUEST);
    list($company_id,$location_name,$buyer_name,$season_name,$client,$merchant,$int_ref,$shipment_status,$order_status,$status,$search_by,$date_from,$date_to,$buyer_id,$int_ref_no,$item_id,$color_id,$size_id) = explode("*", $data);


    $lib_floor = return_library_array("select id,floor_name from lib_prod_floor", "id", "floor_name");


    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    if($type==2)
    {
        $sqlCond .= ($buyer_id != 0)       ? " and a.client_id=$buyer_id"            : "";
    }
    else
    {
        $sqlCond .= ($buyer_id != 0)   ? " and a.buyer_name=$buyer_id"         : "";
    }
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    $sqlCond .= ($merchant != 0)     ? " and a.factory_marchant=$merchant"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    $sqlCond .= ($int_ref !="")  ? " and b.grouping ='$int_ref'"      : "";
    $sqlCond .= ($item_id !="")   ? " and c.item_number_id=$item_id" : "";
    $sqlCond .= ($color_id !="")   ? " and c.color_number_id=$color_id" : "";
    $sqlCond .= ($size_id !="")   ? " and c.size_number_id=$size_id" : "";
    
    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active = $status" : "";
    //$sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }
    // echo "string".$sqlCond;die(); 

    $sql = "SELECT d.floor_id,e.production_qnty as qty,e.reject_qty from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , pro_garments_production_mst d, pro_garments_production_dtls e where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and d.production_type in(8) $sqlCond"; 
    // echo $sql;die();
    $res = sql_select($sql);
    $finishing_data = array();

    foreach ($res as $val) 
    {
        $finishing_data[$lib_floor[$val['FLOOR_ID']]]['qty'] += $val['QTY'];
        $finishing_data[$lib_floor[$val['FLOOR_ID']]]['rej_qty'] += $val['REJECT_QTY'];
    }
    // echo "<pre>";print_r($finishing_data);echo "</pre>";    

    /*===================================================================================== /
    /                                      Shipment Data                                    /
    /===================================================================================== */
    $sql = "SELECT f.delivery_floor_id as floor_id,e.production_qnty from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c, pro_ex_factory_mst d,pro_ex_factory_dtls e,pro_ex_factory_delivery_mst f where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and d.id=e.mst_id and c.id=e.color_size_break_down_id and b.id=d.po_break_down_id and f.id=d.delivery_mst_id and f.status_active=1
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 $sqlCond";
    // echo $sql;die();
    $res = sql_select($sql);
    foreach ($res as $val) 
    {
        $finishing_data[$lib_floor[$val['FLOOR_ID']]]['ex_qty'] += $val['PRODUCTION_QNTY'];
    }
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 300;" id="details_reports">
        <div class="main_part" style="width:300px;">
            <div>
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="280">
                    <caption><b>Ready to Ship</b></caption>
                    <thead>
                        <tr>
                            <th width="100">Floor Name</th>
                            <th width="80">Qty</th>
                        </tr>
                    </thead>
                </table>
            </div>
            <div style="width:300px;overflow-y:auto;max-height:300px;" id="scroll_body">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="280">
                    <tbody>
                        <?
                        $i=0;
                        ksort($finishing_data);
                        $tot = 0;
                        foreach ($finishing_data as $f_name => $row) 
                        {                         
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                               
                                <td  width="100"><?=$f_name;?></td>
                               
                                <td width="80" align="right"><?=fn_number_format(($row['qty'] - $row['ex_qty']),0);?></td>
                            </tr>
                            <?
                            $i++;
                            $tot += $row['qty'] - $row['ex_qty'];
                                                       
                        }
                        ?>
                    </tbody>
                    <tfoot>                        
                        <tr style="background: #cddcdc;font-weight: bold;text-align: right;">
                            <th>Total</th>
                            <th><?=fn_number_format($tot,0);?></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>  
    <?
}

if($action=="display_accessories_details_report")
{
    $company_id     = str_replace("'", "", $cbo_company_name);
    $location_name  = str_replace("'", "", $cbo_location_name);
    $buyer_name     = str_replace("'", "", $cbo_buyer_name);
    $season_name    = str_replace("'", "", $cbo_season_name);
    $item_id        = str_replace("'", "", $cbo_item_name);
    $year           = str_replace("'", "", $cbo_year_selection);
    $shipment_status= str_replace("'", "", $cbo_shipment_status);
    $order_status   = str_replace("'", "", $cbo_order_status);
    $status         = str_replace("'", "", $cbo_status);
    $merchant       = str_replace("'", "", $cbo_merchant);
    $client         = str_replace("'", "", $cbo_client);
    $search_by      = str_replace("'", "", $cbo_search_by);
    $int_ref_no     = str_replace("'", "", $txt_int_ref_no);
    $style_ref      = str_replace("'", "", $txt_style_ref);
    $emblishment    = str_replace("'", "", $cbo_emblishment);
    $start_alarm    = str_replace("'", "", $cbo_start_alarm);
    $end_alarm      = str_replace("'", "", $cbo_end_alarm);
    $backLog        = str_replace("'", "", $cbo_backlog);
    $date_from      = str_replace("'", "", $txt_date_from);
    $date_to        = str_replace("'", "", $txt_date_to);

    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    $sqlCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";
    $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    $sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active in($status)" : "";
    $sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    $sqlCond .= ($trims_group_id !="") ? " and d.trim_group in($trims_group_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }

    $costing_per_sql=sql_select("SELECT JOB_NO,COSTING_PER from wo_pre_cost_mst");
    $costing_per_arr=array();
    foreach($costing_per_sql as $cost_val)
    {
        $costing_per_arr[$cost_val['JOB_NO']] = $cost_val['COSTING_PER'];
    }
    unset($costing_per_sql);

    $gmtsitemRatioArray = array();
    $gmtsitemRatioSql=sql_select('SELECT a.job_no AS JOB_NO,b.gmts_item_id AS GMTS_ITEM_ID ,b.set_item_ratio AS SET_ITEM_RATIO from wo_po_details_master a, wo_po_details_mas_set_details b where 1=1 and a.id=b.job_id');
    foreach($gmtsitemRatioSql as $gmtsitemRatioSqlRow)
    {
        $gmtsitemRatioArray[$gmtsitemRatioSqlRow['JOB_NO']][$gmtsitemRatioSqlRow['GMTS_ITEM_ID']]=$gmtsitemRatioSqlRow['SET_ITEM_RATIO'];    
    }
    unset($gmtsitemRatioSql);

    $lib_item_group_name = return_library_array("select id,item_name from lib_item_group", "id", "item_name");
    $lib_supplier = return_library_array("select id,short_name from lib_supplier", "id", "short_name");
    /*======================================================================================/
    /                                    main query                                         /
    /======================================================================================*/       
    $sql = "SELECT a.job_no AS JOB_NO,a.style_ref_no as STYLE,a.total_set_qnty AS TOTAL_SET_QNTY,b.id AS PO_ID,b.grouping as INT_REF,c.item_number_id AS ITEM_NUMBER_ID, c.order_quantity AS ORDER_QUANTITY ,c.plan_cut_qnty AS PLAN_CUT_QNTY,d.trim_group AS TRIM_GROUP,d.CONS_UOM,e.cons AS CONS from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c, wo_pre_cost_trim_cost_dtls d, wo_pre_cost_trim_co_cons_dtls e where 1=1 and a.id=b.job_id and b.id=c.po_break_down_id and a.id=d.job_id and d.id=e.wo_pre_cost_trim_cost_dtls_id and b.id=e.po_break_down_id and c.item_number_id= e.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.size_number_id and e.cons>0 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.is_deleted=0 and d.status_active=1 and e.is_deleted=0 and e.status_active=1 $sqlCond order by b.grouping";//$sqlCond
    // echo $sql;die();
    $sqlRes = sql_select($sql);
    if(count($sqlRes)==0)
    {
        echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
    }
    $poIdArray = array();
    $dataArray = array();
    foreach ($sqlRes as $row) 
    {
        $reqQty = 0;
        $costingPer = $costing_per_arr[$row['JOB_NO']];            
        if($costingPer==1) $pcs_value=1*12;
        else if($costingPer==2) $pcs_value=1*1;
        else if($costingPer==3) $pcs_value=2*12;
        else if($costingPer==4) $pcs_value=3*12;
        else if($costingPer==5) $pcs_value=4*12;
        $gmtsitemRatio = $gmtsitemRatioArray[$row['JOB_NO']][$row['ITEM_NUMBER_ID']];
        $reqQty = ($row['ORDER_QUANTITY']/$gmtsitemRatio)*($row['CONS']/$pcs_value);
        // echo "(".$row['ORDER_QUANTITY']."/".$gmtsitemRatio.")*(".$row['CONS']."/".$pcs_value.")$row[TRIM_GROUP]<br>";
        $tgroup = strtolower($lib_item_group_name[$row['TRIM_GROUP']]);
        $dataArray[$tgroup][$row['JOB_NO']][$row['INT_REF']]['style'] = $row['STYLE'];       
        $dataArray[$tgroup][$row['JOB_NO']][$row['INT_REF']]['req_qty'] += $reqQty;   
        $dataArray[$tgroup][$row['JOB_NO']][$row['INT_REF']]['cons_uom'] = $row['CONS_UOM'];  

        $poIdArray[$row['PO_ID']] = $row['PO_ID'];
    }
    // echo "<pre>";print_r($dataArray);die();
    $poIDS = implode(",", $poIdArray);
    $po_id_list_arr=array_chunk($poIdArray,999);

    $poCon = " and ";$poCon2 = " and ";$poCon3 = " and ";
    $p=1;
    foreach($po_id_list_arr as $po_process)
    {
        if($p==1) $poCon .="  ( c.po_break_down_id in(".implode(',',$po_process).")"; 
        else  $poCon .=" or c.po_break_down_id in(".implode(',',$po_process).")";
        

        if($p==1) $poCon2 .="  ( c.po_breakdown_id in(".implode(',',$po_process).")"; 
        else  $poCon2 .=" or c.po_breakdown_id in(".implode(',',$po_process).")"; 
        
        if($p==1) $poCon3 .="  ( e.id in(".implode(',',$po_process).")"; 
        else  $poCon3 .=" or e.id in(".implode(',',$po_process).")";         
        
        $p++;
    }
    $poCon .=")";$poCon2 .=")";$poCon3 .=")";
    /*======================================================================================/
    /                                    trims booking qty                                  /
    /======================================================================================*/
    $sqlTrims = "SELECT a.booking_no_prefix_num as BOOKING_NUM,a.BOOKING_NO,a.id as BOOKING_ID,d.job_no as JOB_NO,e.grouping as INT_REF, c.po_break_down_id as PO_ID,b.trim_group as TGROUP, sum(case when a.is_short=2 then c.requirment else 0 end) as QTY, sum(case when a.is_short=1 then c.requirment else 0 end) as SHOR_QTY, max(a.booking_date) as BOOKING_DATE,a.SUPPLIER_ID FROM wo_booking_mst a,wo_booking_dtls b,wo_trim_book_con_dtls c,wo_po_details_master d,wo_po_break_down e WHERE a.booking_no=b.booking_no and b.booking_no=c.booking_no and b.id=c.wo_trim_booking_dtls_id and d.id=e.job_id and c.po_break_down_id=e.id and b.trim_group=$trims_group_id $poCon and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(87,262)  and a.item_category=4 and a.booking_type=2  group by a.booking_no_prefix_num,a.id,a.booking_no,d.job_no,e.grouping,b.trim_group,a.supplier_id,c.po_break_down_id ";
    // echo $sqlTrims;die();
    $trimsRes = sql_select($sqlTrims);
    $tbArray = array();
    $bookingDataArray = array();
    foreach ($trimsRes as  $val) 
    {
        $tgroup = strtolower($lib_item_group_name[$val['TGROUP']]); 
        $bookingDataArray[$tgroup][$val['JOB_NO']][$val['INT_REF']]['book_qty'] += $val['QTY'];
        $bookingDataArray[$tgroup][$val['JOB_NO']][$val['INT_REF']]['short_book_qty'] += $val['SHOR_QTY'];
        $bookingDataArray[$tgroup][$val['JOB_NO']][$val['INT_REF']]['booking_date'] = $val['BOOKING_DATE'];
        $bookingDataArray[$tgroup][$val['JOB_NO']][$val['INT_REF']]['supplier_id'] .= $val['SUPPLIER_ID'].",";
        $bookingDataArray[$tgroup][$val['JOB_NO']][$val['INT_REF']]['booking_num'] .= $val['BOOKING_NUM'].",";
        $bookingDataArray[$tgroup][$val['JOB_NO']][$val['INT_REF']]['booking_no'] = $val['BOOKING_NO'];
        $tbArray[$val['BOOKING_ID']] = $val['BOOKING_ID'];
    }
    // echo "<pre>";print_r($bookingDataArray);die();
    $trimsBoingIds = implode(",", $tbArray);
    $tb_id_list_arr=array_chunk($tbArray,999);

    $tbCon = " and ";
    $p=1;
    foreach($tb_id_list_arr as $tb_process)
    {
        if($p==1) $tbCon .="  ( b.work_order_id in(".implode(',',$tb_process).")"; 
        else  $tbCon .=" or b.work_order_id in(".implode(',',$tb_process).")";       
        
        $p++;
    }
    $tbCon .=")";

    /*======================================================================================/
    /                                    trims receive qty                                  /
    /======================================================================================*/
    $sqlacc = "SELECT d.job_no as JOB_NO,e.grouping as INT_REF, B.ITEM_GROUP_ID,c.quantity AS QNTY,b.reject_receive_qnty as REJ_QTY FROM inv_receive_master a,inv_trims_entry_dtls b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=24 AND c.entry_form = 24 AND c.entry_form = 24 and a.item_category=4 and d.id=e.job_id and c.po_breakdown_id=e.id and b.ITEM_GROUP_ID=$trims_group_id $poCon2";
    // echo $sqlacc;die();
    $accRes = sql_select($sqlacc);
    $trimsDataArray = array();
    foreach ($accRes as $val) 
    {
        $tgroup = strtolower($lib_item_group_name[$val['ITEM_GROUP_ID']]);
        $trimsDataArray[$tgroup][$val['JOB_NO']][$val['INT_REF']]['rcv_qty'] += $val['QNTY'];
        $trimsDataArray[$tgroup][$val['JOB_NO']][$val['INT_REF']]['rej_qty'] += $val['REJ_QTY'];
    }

    /*======================================================================================/
    /                              trims issue and rcv return                               /
    /======================================================================================*/
    $sqlacc = "SELECT d.job_no as JOB_NO,e.grouping as INT_REF,a.entry_form,a.issue_date, B.ITEM_GROUP_ID,C.QUANTITY AS QNTY FROM inv_issue_master a,inv_trims_issue_dtls b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type in(2,3) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(25,49) AND c.entry_form in(25,49) AND c.entry_form in(25,49) and a.item_category=4 and d.id=e.job_id and c.po_breakdown_id=e.id and b.ITEM_GROUP_ID=$trims_group_id $poCon2";
    // echo $sqlacc;die();
    $accRes = sql_select($sqlacc);
    foreach ($accRes as $val) 
    {
        $tgroup = strtolower($lib_item_group_name[$val['ITEM_GROUP_ID']]);
        if($val['ENTRY_FORM']==49)
        {
            $trimsDataArray[$tgroup][$val['JOB_NO']][$val['INT_REF']]['rcv_rtn_qty'] += $val['QNTY'];
        }
        if($val['ENTRY_FORM']==25)
        {
            $trimsDataArray[$tgroup][$val['JOB_NO']][$val['INT_REF']]['issue_qty'] += $val['QNTY'];
        }
    }

    /*======================================================================================/
    /                                    trims issue return                                   /
    /======================================================================================*/
    $sqlacc = "SELECT a.receive_date, d.job_no as JOB_NO,e.grouping as INT_REF, f.item_group_id as ITEM_GROUP_ID,b.cons_quantity AS QNTY FROM inv_receive_master a,inv_transaction b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e,product_details_master f where a.id=b.mst_id and b.id=c.trans_id and c.trans_type=4 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=73 AND c.entry_form = 73 AND c.entry_form = 73 and a.item_category=4 and d.id=e.job_id and c.po_breakdown_id=e.id and b.ITEM_CATEGORY=4 and c.prod_id=f.id and f.item_group_id=$trims_group_id $poCon2";
    // echo $sqlacc;die();
    $accRes = sql_select($sqlacc);
    foreach ($accRes as $val) 
    {
        $tgroup = strtolower($lib_item_group_name[$val['ITEM_GROUP_ID']]);
        $trimsDataArray[$tgroup][$val['JOB_NO']][$val['INT_REF']]['issue_rtn_qty'] += $val['QNTY'];
    }
    /*======================================================================================/
    /                                    LC and   PI Infor                                  /
    /======================================================================================*/
    $sqlpi = "SELECT d.job_no as JOB_NO,e.grouping as INT_REF, a.ID,a.PI_DATE,b.WORK_ORDER_NO,b.ITEM_GROUP from com_pi_master_details a, com_pi_item_details b,wo_booking_dtls c,wo_po_details_master d,wo_po_break_down e where a.id=b.pi_id and c.booking_no=b.work_order_no and c.po_break_down_id=e.id and d.id=e.job_id and b.ITEM_GROUP=$trims_group_id $poCon3 and a.item_category_id=4";//$tbCon
    // echo $sqlpi;die();
    $piRes = sql_select($sqlpi);
    $lib_pi_rcv_date = array();
    $lib_pi_no = array();
    $piDataArray = array();
    foreach ($piRes as $val) 
    {
        $tgroup = strtolower($lib_item_group_name[$val['ITEM_GROUP']]);
        $piDataArray[$tgroup][$val['JOB_NO']][$val['INT_REF']]['pi_date'] .= $val['PI_DATE'].",";
        $lib_pi_no[$val['ID']] = $val['ID'];
    }
    $piIds = implode(",", $lib_pi_no);
    $pi_id_list_arr=array_chunk($lib_pi_no,999);

    if($piIds !="")
    {
        $piCon = " and ";
        $p=1;
        foreach($pi_id_list_arr as $pi_process)
        {
            if($p==1) $piCon .="  ( b.pi_id in(".implode(',',$pi_process).")"; 
            else  $piCon .=" or b.pi_id in(".implode(',',$pi_process).")";       
            
            $p++;
        }
        $piCon .=")";
    }

    $lcsql = "SELECT c.ITEM_GROUP, d.JOB_NO,f.grouping as INT_REF,a.LC_NUMBER from com_btb_lc_master_details a,com_btb_lc_pi b,com_pi_item_details c,wo_booking_dtls d,wo_po_details_master e,wo_po_break_down f where a.id=b.com_btb_lc_master_details_id and c.pi_id=b.pi_id and c.work_order_no=d.booking_no and d.po_break_down_id=f.id and f.job_id=e.id and c.ITEM_GROUP=$trims_group_id $piCon and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
    // echo $lcsql;die();
    $lcRes = sql_select($lcsql);
    $lc_array = array();
    foreach ($lcRes as $val) 
    {
        $tgroup = strtolower($lib_item_group_name[$val['ITEM_GROUP']]);
        $lc_array[$tgroup][$val['JOB_NO']][$val['INT_REF']]['lc_number'] .= $val['LC_NUMBER'].",";
    }

    /*======================================================================================/
    /                                    trims transfer                                     /
    /======================================================================================*/
    $item_group_cond = where_con_using_array($item_group_id_arr,0,"b.item_group");
    // $sql = "SELECT b.item_category,b.item_group,b.transfer_qnty from inv_item_transfer_mst a,inv_item_transfer_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.entry_form in(78,112) $item_group_cond";

    $to_order_id_con =where_con_using_array($poIdArray,0,"a.to_order_id");
    $from_order_id_con =where_con_using_array($poIdArray,0,"a.from_order_id");

    $transfer_sql_in=sql_select("SELECT d.job_no_mst as job_no,d.grouping as int_ref, a.transfer_date, b.item_category,b.item_group,b.transfer_qnty as qnty FROM inv_item_transfer_mst a, inv_item_transfer_dtls b,wo_po_break_down d WHERE a.id = b.mst_id and a.to_order_id=d.id  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and d.status_active=1 and b.item_category=4 and a.entry_form in(78,112) and b.item_group=$trims_group_id $to_order_id_con");
    $transfer_data=array();
    foreach ($transfer_sql_in as $row) 
    {
        $tgroup = strtolower($lib_item_group_name[$val['ITEM_GROUP']]);
        $transfer_data[$tgroup][$row[csf('job_no')]][$row[csf('int_ref')]]['in']+=$row[csf('qnty')];
    }
    $transfer_sql_out=sql_select("SELECT d.job_no_mst as job_no,d.grouping as int_ref,a.transfer_date, b.item_category,b.item_group,b.transfer_qnty as qnty FROM inv_item_transfer_mst a, inv_item_transfer_dtls b,wo_po_break_down d WHERE a.id = b.mst_id and a.from_order_id=d.id   and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and d.status_active=1 and b.item_category=4 and a.entry_form in(78,112) and b.item_group=$trims_group_id $from_order_id_con");
    foreach ($transfer_sql_out as $row) 
    {
        $tgroup = strtolower($lib_item_group_name[$val['ITEM_GROUP']]);
        $transfer_data[$tgroup][$row[csf('job_no')]][$row[csf('int_ref')]]['out']+=$row[csf('qnty')];
    }

    // print_r($transfer_data); echo "string";
    /*======================================================================================/
    /                                   getting rowspan                                     /
    /======================================================================================*/
    $rowspan = array();
    foreach ($dataArray as $groupId => $groupData) 
    {
        foreach ($groupData as $job_no => $jobData) 
        {
            foreach ($jobData as $intRef => $val) 
            {
                $rowspan[$groupId]++;
            }
        }
    }

    ob_start();
    ?>
    <div class="tableContainer" style="margin-top: 10px;margin-bottom: 10px;">  
        <style type="text/css">
            .word_break_wrap{
                word-wrap: break-word;
                word-break: break-all;
            }
        </style>          
        <fieldset style="width:99%;">
            <div style="width:98%;">
                <table width="100%" cellpadding="0" cellspacing="0">
                    <tr><td colspan="17" align="center" style="font-size:22px;">Accssories Details By Ref no Wise: <?=$lib_item_group_name[$trims_group_id];?> <span style="color: red;font-size: 18px;font-weight: bold;"> <?=($client) ? ": ".$client_array[$client] : ": All"; ?></span></td></tr>
                </table>
                <table width="100%" border="1" rules="all"  class="rpt_table"> 
                    <thead>
                        <tr style="font-size:12px"> 
                            <th class="word_break_wrap" width="7%">Int. Ref.</th>
                            <th class="word_break_wrap" width="7%">Style Ref.</th>
                            <th class="word_break_wrap" width="4.6%">Req qty</th>
                            <th class="word_break_wrap" width="4.6%">Excess Qty</th>
                            <th class="word_break_wrap" width="4.6%">Total Qty</th>
                            <th class="word_break_wrap" width="4.6%">Unit</th>
                            <th class="word_break_wrap" width="4.6%">Booking Bal</th>
                            <th class="word_break_wrap" width="4.6%">Last Book Date</th>
                            <th class="word_break_wrap" width="7%">Supplier</th>
                            <th class="word_break_wrap" width="4.6%">Booking Qty</th>
                            <th class="word_break_wrap" width="4.6%">Ok Rcv Qty</th>
                            <th class="word_break_wrap" width="4.6%">Rej Rcv Qty</th>
                            <th class="word_break_wrap" width="4.6%">Balance Qty</th>
                            <th class="word_break_wrap" width="4.6%">TB No</th>
                            <th class="word_break_wrap" width="4.6%">PI Rcvd Date</th>
                            <th class="word_break_wrap" width="4.6%">L/c No</th>
                            <th class="word_break_wrap" width="4.6%">Trans In</th>
                            <th class="word_break_wrap" width="4.6%">Trans Out</th>
                            <th class="word_break_wrap" width="4.6%">Issue Qty</th>
                            <th class="word_break_wrap" width="4.6%">Stock Qty</th>
                       </tr>
                    </thead>
                </table>
                <div style="width:101%;overflow-y:scroll;max-height:335px;" id="scroll_body">
                    <table width="100%" border="1" rules="all"  class="rpt_table">
                        <tbody>
                            <?
                            $i = 100;
                            ksort($dataArray);
                            foreach ($dataArray as $trims_group => $trimsData) 
                            {
                                $r = 0;
                                $item_wise_tot_req_qty      = 0;
                                $item_wise_tot_exs_qty      = 0;
                                $item_wise_tot_qty          = 0;
                                $item_wise_tot_bok_bal_qty  = 0;
                                $item_wise_tot_bok_qty      = 0;
                                $item_wise_tot_rcv_qty      = 0;
                                $item_wise_tot_rej_qty      = 0;
                                $item_wise_tot_bal_qty      = 0;
                                $item_wise_tot_trns_in      = 0;
                                $item_wise_tot_trns_out     = 0;
                                $item_wise_tot_iss_qty      = 0;
                                $item_wise_tot_stk_qty      = 0;
                                foreach ($trimsData as $job => $jobData) 
                                {
                                    foreach ($jobData as $intRef => $row) 
                                    {
                                        $book_qty = $bookingDataArray[$trims_group][$job][$intRef]['book_qty'];
                                        $short_book_qty = $bookingDataArray[$trims_group][$job][$intRef]['short_book_qty'];
                                        $booking_date = $bookingDataArray[$trims_group][$job][$intRef]['booking_date'];
                                        $supplier_id = $bookingDataArray[$trims_group][$job][$intRef]['supplier_id'];
                                        $booking_num = $bookingDataArray[$trims_group][$job][$intRef]['booking_num'];
                                        $booking_no = $bookingDataArray[$trims_group][$job][$intRef]['booking_no'];

                                        $rcv_qty = $trimsDataArray[$trims_group][$job][$intRef]['rcv_qty'];
                                        $rej_qty = $trimsDataArray[$trims_group][$job][$intRef]['rej_qty'];
                                        $rcv_rtn_qty = $trimsDataArray[$trims_group][$job][$intRef]['rcv_rtn_qty'];

                                        $issue_qty = $trimsDataArray[$trims_group][$job][$intRef]['issue_qty'];
                                        $issue_rtn_qty = $trimsDataArray[$trims_group][$job][$intRef]['issue_rtn_qty'];

                                        $trans_in = $transfer_data[$trims_group][$job][$intRef]['in'];
                                        $trans_out = $transfer_data[$trims_group][$job][$intRef]['out'];

                                        $stock_qty = ($rcv_qty+$issue_rtn_qty+$trans_in) - ($issue_qty+$rcv_rtn_qty+$trans_out);
                                        // echo "(rcv=".$rcv_qty."+rtn=".$issue_rtn_qty."+trns in=".$trans_in.") - (issue=".$issue_qty."+rcv rtn=".$rcv_rtn_qty."+out=".$trans_out.")<br>";

                                        $pi_date = $piDataArray[$trims_group][$job][$intRef]['pi_date'];

                                        $rcv_with_rtn = $rcv_qty-$rcv_rtn_qty;
                                        $totQty = $row['req_qty']+$short_book_qty;
                                        //$bookingBal = $totQty - $rcv_with_rtn;
                                        $bookingBal = $totQty - ($book_qty+$short_book_qty);
                                        $balQty = $totQty - ($rcv_qty+$rcv_rtn_qty);
                                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                        ?>
                                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                                
                                                <td width="7%"><? echo $intRef;?></td>
                                                <td width="7%"><? echo $row['style'];?></td>
                                                <td width="4.6%" align="right"><? echo fn_number_format($row['req_qty'],0);?></td>
                                                <td width="4.6%" align="right"><? echo fn_number_format($short_book_qty,0);?></td>
                                                <td width="4.6%" align="right"><? echo fn_number_format($row['req_qty']+$short_book_qty,0);?></td>
                                                <td width="4.6%" align="center"><? echo $unit_of_measurement[$row['cons_uom']];?></td>
                                                <td width="4.6%" align="right"><? echo fn_number_format($bookingBal,0);?></td>
                                                <td width="4.6%" align="center"><? echo $booking_date !="" ? date('d M',strtotime($booking_date)) : "";?></td>
                                                <td width="7%">
                                                    <?
                                                    $sum_name = "";
                                                    $supp_array = array_unique(explode(",", chop($supplier_id,',')));
                                                    foreach ($supp_array as $val) 
                                                    {
                                                        $sum_name .= ($sum_name == "") ? $lib_supplier[$val] : " ,".$lib_supplier[$val];
                                                    }
                                                     echo $sum_name;
                                                     ?>
                                                </td>
                                                <td width="4.6%" align="right"><? echo fn_number_format(($book_qty+$short_book_qty),0);?></td>
                                                <td title="Rcv=<?=$rcv_qty.", Rcv Rtn=".$rtn_qty;?>" width="4.6%" align="right"><? echo fn_number_format($rcv_with_rtn,0);?></td>
                                                <td width="4.6%" align="right"><? echo fn_number_format($rej_qty,0);?></td>
                                                <td width="4.6%" align="right"><? echo fn_number_format($balQty,0);?></td>
                                                <td width="4.6%" align="center">
                                                    <?
                                                    $booking_nums = "";
                                                    $booking_nums_array = array_unique(explode(",", chop($booking_num,',')));
                                                    foreach ($booking_nums_array as $val) 
                                                    {
                                                        $booking_nums .= ($booking_nums == "") ? $val : " ,".$val;
                                                    }
                                                     echo $booking_nums;
                                                     ?>
                                                </td>
                                                <td width="4.6%" align="center">
                                                    <?
                                                    $pi_dates = "";
                                                    $pi_date_array = array_unique(explode(",", chop($pi_date,',')));
                                                    foreach ($pi_date_array as $val) 
                                                    {
                                                        if($val !="")
                                                        {
                                                            $pi_dates .= ($pi_dates == "") ? date('d M',strtotime($val)) : " ,".date('d M',strtotime($val));
                                                        }
                                                    }
                                                     echo $pi_dates;
                                                     ?>
                                                </td>
                                                <td width="4.6%">
                                                    <?
                                                    $lc_number = "";
                                                    //$lc_number_array = array_unique(explode(",", chop($row['lc_number'],',')));                                                       
                                                    $lc_number_array = array_unique(explode(",", chop($lc_array[$trims_group][$job][$intRef]['lc_number'],',')));
                                                    
                                                    foreach ($lc_number_array as $val) 
                                                    {
                                                        $lc_number .= ($lc_number == "") ? $val : " ,".$val;
                                                    }
                                                     echo $lc_number;
                                                     ?>
                                                </td>
                                                <td align="right" width="4.6%"><?=fn_number_format($trans_in,0);?></td>
                                                <td align="right" width="4.6%"><?=fn_number_format($trans_out,0);?></td>
                                                <td align="right" width="4.6%" title="issue=<?=$issue_qty.', Issue Rtn='.$issue_rtn_qty;?>">
                                                    <?=fn_number_format(($issue_qty-$issue_rtn_qty),0);?>      
                                                </td>
                                                <td align="right" width="4.6%">
                                                    <a href="##" onclick="show_acc_popup('<?=$poIDS.'**'.$trims_group_id.'**'.$job.'**'.$intRef;?>');">
                                                        <?=fn_number_format($stock_qty,0);?>
                                                    </a>                                                        
                                                </td>
                                            </tr>
                                        <?
                                        $i++; 
                                        $r++; 
                                        $item_wise_tot_req_qty      += $row['req_qty'];
                                        $item_wise_tot_exs_qty      += $short_book_qty;
                                        $item_wise_tot_qty          += $totQty;
                                        $item_wise_tot_bok_bal_qty  += $bookingBal;
                                        $item_wise_tot_bok_qty      += $book_qty+$short_book_qty;
                                        $item_wise_tot_rcv_qty      += $rcv_with_rtn;
                                        $item_wise_tot_rej_qty      += $rej_qty;
                                        $item_wise_tot_bal_qty      += $balQty; 
                                        $item_wise_tot_trns_in      += $trans_in;
                                        $item_wise_tot_trns_out     += $trans_out;
                                        $item_wise_tot_iss_qty      += $issue_qty;                                
                                        $item_wise_tot_stk_qty      += $stock_qty;                                 
                                    }
                                }
                                ?>
                                <tr style="font-size:12px;font-weight:bold;background:#ccc;"> 
                                    <td colspan="2" align="right">Total</td>
                                    <td align="right"><? echo fn_number_format($item_wise_tot_req_qty,0);?></td>
                                    <td align="right"><? echo fn_number_format($item_wise_tot_exs_qty,0);?></td>
                                    <td align="right"><? echo fn_number_format($item_wise_tot_qty,0);?></td>
                                    <td></td>
                                    <td align="right"><? echo fn_number_format($item_wise_tot_bok_bal_qty,0);?></td>
                                    <td></td>
                                    <td></td>
                                    <td align="right"><? echo fn_number_format($item_wise_tot_bok_qty,0);?></td>
                                    <td align="right"><? echo fn_number_format($item_wise_tot_rcv_qty,0);?></td>
                                    <td align="right"><? echo fn_number_format($item_wise_tot_rej_qty,0);?></td>
                                    <td align="right"><? echo fn_number_format($item_wise_tot_bal_qty,0);?></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td align="right"><? echo fn_number_format($item_wise_tot_trns_in,0);?></td>
                                    <td align="right"><? echo fn_number_format($item_wise_tot_trns_out,0);?></td>
                                    <td align="right"><? echo fn_number_format($item_wise_tot_iss_qty,0);?></td>
                                    <td align="right"><? echo fn_number_format($item_wise_tot_stk_qty,0);?></td>
                               </tr>                                
                                <?
                            }
                            ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </fieldset>
    </div>
    <?
    exit();

}

if($action =="display_report_by_buyer")
{
    $current_date = date("j-M-Y");
    $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');    
    $season_lib=return_library_array( "select id,season_name from lib_buyer_season",'id','season_name');
    $company_id     = str_replace("'","",$company_name);
    $location_id    = str_replace("'","",$location_name);
    $buyer_id   = str_replace("'","",$buyer_id);
    $client_id   = str_replace("'","",$client_id);
    if($location_id)
    {
        $location_cond = " and a.location_name=$location_id";
    }
    if($client_id)
    {
        $client_cond = " and a.client_id=$client_id";
    }

    /*------------------------------------------------------------------------------/
    /                                  MAIN QUERY                                   /
    /------------------------------------------------------------------------------*/

    $sql = "SELECT a.season_buyer_wise as season, A.JOB_NO,A.style_ref_no as STYLE,b.GROUPING,b.shipment_date as SHIPMENT_DATE,B.ID AS PO_ID,(b.UNIT_PRICE/a.total_set_qnty) as UNIT_PRICE,C.COLOR_NUMBER_ID AS COLOR_ID,sum(c.order_quantity) as QTY from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=c.job_id and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.shiping_status in(1,2) and a.company_name=$company_id and a.buyer_name=$buyer_id $location_cond $client_cond  group by a.season_buyer_wise,a.job_no,a.style_ref_no,b.grouping,b.id,b.unit_price,a.total_set_qnty,c.color_number_id,b.shipment_date order by b.shipment_date";//and b.id=15920
    // echo $sql;die();
    $sqlRes = sql_select($sql);
    if(count($sqlRes)==0)
    {
        echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
    }
    $dataArray = array();
    $poIdArray = array();
    $jobArray = array();
    $poWiseColorArray = array();
    $jobWisePoArray = array();
    foreach ($sqlRes as $row) 
    {
       $dataArray[$season_lib[$row['SEASON']]][$row['JOB_NO']][$row['PO_ID']]['po_id'] = $row['PO_ID'];          
       $dataArray[$season_lib[$row['SEASON']]][$row['JOB_NO']][$row['PO_ID']]['style'] = $row['STYLE'];          
       $dataArray[$season_lib[$row['SEASON']]][$row['JOB_NO']][$row['PO_ID']]['intRef'] = $row['GROUPING'];          
       $dataArray[$season_lib[$row['SEASON']]][$row['JOB_NO']][$row['PO_ID']]['orig_ship_date'] = $row['SHIPMENT_DATE'];          
       $dataArray[$season_lib[$row['SEASON']]][$row['JOB_NO']][$row['PO_ID']]['unit_price'] = $row['UNIT_PRICE'];          
       $dataArray[$season_lib[$row['SEASON']]][$row['JOB_NO']][$row['PO_ID']]['qty'] += $row['QTY'];

       $poIdArray[$row['PO_ID']] = $row['PO_ID'];
       $poWiseColorArray[$row['PO_ID']][$row['COLOR_ID']] += $row['COLOR_ID'];
       $jobArray[$row['JOB_NO']] = "'".$row['JOB_NO']."'";
       $jobWisePoArray[$row['JOB_NO']][$row['PO_ID']]  = $row['PO_ID'];
    }
    $poIDS = implode(",", $poIdArray);
    unset($sqlRes);
    // echo count($poWiseColorArray[38932]);
    // echo "<pre>";
    // print_r($dataArray);die();
    //================================ PO Cond=================================
    $poIdsCond="";
    if($db_type==2 && count($poIdArray)>1000)
    {
        $poIdsCond=" and (";
        $poIdsArr=array_chunk($poIdArray,999);
        foreach($poIdsArr as $ids)
        {
            $ids=implode(",",$ids);
            $poIdsCond.=" po_break_down_id in($ids) or ";
        }
        $poIdsCond=chop($poIdsCond,'or ');
        $poIdsCond.=")";
    }
    else
    {
        $poIdsCond=" and po_break_down_id in($poIDS)";
    }

    //================================ Job Cond=================================
    $jobNo = implode(",", $jobArray);
    $jobCond="";
    if($db_type==2 && count($jobArray)>1000)
    {
        $jobCond=" and (";
        $poIdsArr=array_chunk($jobArray,999);
        foreach($poIdsArr as $ids)
        {
            $ids=implode(",",$ids);
            $jobCond.=" a.job_no in($ids) or ";
        }
        $jobCond=chop($jobCond,'or ');
        $jobCond.=")";
    }
    else
    {
        $jobCond=" and a.job_no in($jobNo)";
    }
    // echo $poIdsCond;die();

    // ======================================= Actual PO Info ==================================
    $acc_po_id_cond = str_replace("po_break_down_id","b.po_break_down_id",$poIdsCond);
    $sqlAccPo = "SELECT b.PO_BREAK_DOWN_ID,a.ACC_PO_NO,b.PO_QTY as ACC_PO_QTY,a.ACC_SHIP_DATE FROM WO_PO_ACC_PO_INFO a, WO_PO_ACC_PO_INFO_DTLS B WHERE a.id=b.mst_id and a.STATUS_ACTIVE=1 AND a.IS_DELETED=0 and b.STATUS_ACTIVE=1 AND b.IS_DELETED=0 and b.gmts_item <> 0 and a.acc_po_status=1 $acc_po_id_cond order by a.ACC_SHIP_DATE";
    // echo $sqlAccPo;die();
    $sqlAccPoRes = sql_select($sqlAccPo);
    $accPoQtyArray = array();
    $accPoArray = array();
    $accPoIDArray = array();
    foreach ($sqlAccPoRes as $val) 
    {
        // $accPoQtyArray[$val['PO_BREAK_DOWN_ID']][$val['ACC_PO_NO']][$val['ACC_SHIP_DATE']] += $val['ACC_PO_QTY'];
        // $accPoArray[$val['PO_BREAK_DOWN_ID']][$val['ACC_PO_NO']]['acc_po_qty'] += $val['ACC_PO_QTY'];
        $accPoArray[$val['PO_BREAK_DOWN_ID']][$val['ACC_PO_NO']][$val['ACC_SHIP_DATE']]['acc_po_qty'] += $val['ACC_PO_QTY'];
        $accPoIDArray[$val['PO_BREAK_DOWN_ID']] .= $val['ACC_PO_NO'].",";
    }
    unset($sqlAccPoRes);
    // echo "<pre>";print_r($accPoArray);die();
    // ======================================= LABDIP ==================================
    $sqlLabDip = "SELECT PO_BREAK_DOWN_ID,APPROVAL_STATUS,COUNT (DISTINCT CASE WHEN APPROVAL_STATUS=3 THEN  COLOR_NAME_ID ELSE 0 END)     AS TOT_APP,COUNT (DISTINCT CASE WHEN APPROVAL_STATUS IN(1,3) AND SUBMITTED_TO_BUYER IS NOT NULL THEN  COLOR_NAME_ID ELSE 0 END) AS TOT_SUB FROM WO_PO_LAPDIP_APPROVAL_INFO WHERE APPROVAL_STATUS in(1,3) $poIdsCond and STATUS_ACTIVE=1 AND IS_DELETED=0 group by PO_BREAK_DOWN_ID,APPROVAL_STATUS";
    // echo $sqlLabDip;die();
    $sqlLabDipRes = sql_select($sqlLabDip);
    $labDipArray = array();
    foreach ($sqlLabDipRes as $val) 
    {
        $labDipArray[$val['PO_BREAK_DOWN_ID']]['approve_color'] = $val['TOT_APP'];
        $labDipArray[$val['PO_BREAK_DOWN_ID']]['submit_color'] = $val['TOT_SUB'];
    }
    // print_r($labDipArray);
    unset($sqlLabDipRes);
    // ======================================= SAMPLE  ==================================
    $sqlLabSM = "SELECT PO_BREAK_DOWN_ID,SAMPLE_TYPE_ID,COUNT(COLOR_NUMBER_ID) AS TOT_COLOR FROM WO_PO_SAMPLE_APPROVAL_INFO WHERE APPROVAL_STATUS=1 $poIdsCond AND SAMPLE_TYPE_ID IN(7,18,60) and STATUS_ACTIVE=1 AND IS_DELETED=0 group by PO_BREAK_DOWN_ID,SAMPLE_TYPE_ID";
    // echo $sqlLabSM;
    $sqlLabSMRes = sql_select($sqlLabSM);
    $smArray = array();
    foreach ($sqlLabSMRes as $val) 
    {
        $smArray[$val['PO_BREAK_DOWN_ID']][$val['SAMPLE_TYPE_ID']] = $val['TOT_COLOR'];
    }
    unset($sqlLabSMRes);
    // print_r($smArray);

    // ======================================= BOOKING DATA  ==================================
    $poIdsCondBooking = str_replace("po_break_down_id", "b.po_break_down_id", $poIdsCond);
    // $sqlBooking = "SELECT B.PO_BREAK_DOWN_ID,MAX(A.BOOKING_DATE) AS BDATE,SUM(B.FIN_FAB_QNTY) AS QTY FROM WO_BOOKING_MST A,WO_BOOKING_DTLS B WHERE A.BOOKING_NO=B.BOOKING_NO AND A.IS_APPROVED=1 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 $poIdsCondBooking group by B.PO_BREAK_DOWN_ID";
    $sqlBooking = "SELECT A.IS_APPROVED,a.FABRIC_COMPOSITION,a.FABRICSTRUCTURE,a.FABRICGSM, a.FABRIC_SOURCE,a.IS_SHORT,B.PO_BREAK_DOWN_ID,MAX(A.BOOKING_DATE) AS BDATE,SUM(B.FIN_FAB_QNTY) AS QTY,SUM(B.GREY_FAB_QNTY) AS GREY_QTY FROM WO_BOOKING_MST A,WO_BOOKING_DTLS B WHERE A.BOOKING_NO=B.BOOKING_NO AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 and a.booking_type=1 $poIdsCondBooking group by A.IS_APPROVED,a.FABRIC_COMPOSITION,a.FABRICSTRUCTURE,a.FABRICGSM,a.FABRIC_SOURCE,a.IS_SHORT,B.PO_BREAK_DOWN_ID";
    // echo $sqlBooking;die();
    $bookingRes = sql_select($sqlBooking);
    $bookingQtyArray = array();
    $bookingFabInfoArray = array();
    foreach ($bookingRes as $val) 
    {
        //if($val['IS_APPROVED']==1)
        //{
            if($val['IS_SHORT']==2)
            {
                $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['qty'] += $val['QTY'];
                $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['date'] = $val['BDATE'];
            }
            else
            {
                $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['fin_fab_excess_qty'] += $val['QTY'];
                if($val['FABRIC_SOURCE'] !=2)// avoid purchase
                {
                    $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['grey_fab_excess_qty'] += $val['GREY_QTY'];
                    $bookingQtyArray[$val['PO_BREAK_DOWN_ID']]['yarn_excess_qty'] += $val['GREY_QTY'];
                }

            }
        //}   

        if($val['IS_SHORT']==2)
        {                         
            $bookingFabInfoArray[$val['PO_BREAK_DOWN_ID']]['construction'] = $val['FABRICSTRUCTURE'];
            $bookingFabInfoArray[$val['PO_BREAK_DOWN_ID']]['composition'] = $val['FABRIC_COMPOSITION'];
            $bookingFabInfoArray[$val['PO_BREAK_DOWN_ID']]['gsm'] = $val['FABRICGSM'];
        }
        
    }
    // echo "<pre>";print_r($bookingQtyArray);die();

    // ======================================= BOOKING DATA WITH UOM ==================================
    $poIdsCondBooking = str_replace("po_break_down_id", "b.po_break_down_id", $poIdsCond);
    $sqlBooking = "SELECT A.IS_APPROVED,a.FABRIC_COMPOSITION,a.FABRICSTRUCTURE,a.FABRICGSM, a.FABRIC_SOURCE,a.IS_SHORT,B.PO_BREAK_DOWN_ID,MAX(A.BOOKING_DATE) AS BDATE,SUM(B.FIN_FAB_QNTY) AS QTY,SUM(B.GREY_FAB_QNTY) AS GREY_QTY,C.UOM FROM WO_BOOKING_MST A,WO_BOOKING_DTLS B,WO_PRE_COST_FABRIC_COST_DTLS C WHERE A.BOOKING_NO=B.BOOKING_NO AND C.ID=B.PRE_COST_FABRIC_COST_DTLS_ID AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 and a.booking_type=1 $poIdsCondBooking group by A.IS_APPROVED,a.FABRIC_COMPOSITION,a.FABRICSTRUCTURE,a.FABRICGSM,a.FABRIC_SOURCE,a.IS_SHORT,B.PO_BREAK_DOWN_ID,C.UOM";
    // echo $sqlBooking;die();
    $bookingRes = sql_select($sqlBooking);
    $bookingQtyWithUomArray = array();
    foreach ($bookingRes as $val) 
    {
        if($val['IS_SHORT']==2)
        {
            $bookingQtyWithUomArray[$val['PO_BREAK_DOWN_ID']][$val['UOM']]['qty'] += $val['QTY'];
        }
        else
        {
            $bookingQtyWithUomArray[$val['PO_BREAK_DOWN_ID']][$val['UOM']]['fin_fab_excess_qty'] += $val['QTY'];            
        } 
    }
    // echo "<pre>";print_r($bookingQtyArray);die();

    // ======================================= COLOR TYPE WISE BOOKING DATA  ==================================
    $poIdsCondBooking = str_replace("po_break_down_id", "a.po_break_down_id", $poIdsCond);
    $shortSql = "SELECT a.PO_BREAK_DOWN_ID, b.COLOR_TYPE_ID,a.FIN_FAB_QNTY, a.GREY_FAB_QNTY FROM wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b WHERE a.pre_cost_fabric_cost_dtls_id=b.id $poIdsCondBooking and a.is_short=1 and a.status_active=1 and  a.is_deleted=0";
    // echo $shortSql;
    $shortRes = sql_select($shortSql);
    $color_type_wise_booking_qty_array = array();
    foreach ($shortRes as $val) 
    {
        $color_type_wise_booking_qty_array[$val['PO_BREAK_DOWN_ID']][$val['COLOR_TYPE_ID']] += $val['FIN_FAB_QNTY'];
    }
    // echo "<pre>";print_r($color_type_wise_booking_qty_array);die();

    // ======================================= TNA DATA  ==================================
    $poIdsCondTna = str_replace("po_break_down_id", "A.PO_NUMBER_ID", $poIdsCond);
    $sqltna = "SELECT A.PO_NUMBER_ID,A.TASK_NUMBER,MAX(A.TASK_START_DATE) AS START_DATE,MAX(A.TASK_FINISH_DATE) AS END_DATE,MAX(A.ACTUAL_START_DATE) AS ACTUAL_START_DATE,MAX(A.ACTUAL_FINISH_DATE) AS ACTUAL_FINISH_DATE FROM TNA_PROCESS_MST A,WO_PO_BREAK_DOWN B WHERE A.PO_NUMBER_ID=B.ID AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.PO_QUANTITY>0 $poIdsCondTna AND A.TASK_TYPE=1 group by A.PO_NUMBER_ID,A.TASK_NUMBER";
    // echo $sqltna;die();
    $tnaRes = sql_select($sqltna);
    $tnaDateArray = array();
    foreach ($tnaRes as $val) 
    {
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['start_date']          = $val['START_DATE'];
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['end_date']            = $val['END_DATE'];
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_start_date']   = $val['ACTUAL_START_DATE'];
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_finish_date']  = $val['ACTUAL_FINISH_DATE'];
    }
    // print_r($tnaDateArray);
    unset($tnaRes);
    //======================================== avg cons qty for yarn dyed =========================
    $poIdsCondCons = str_replace("po_break_down_id", "b.id", $poIdsCond);
    $sqlCons = sql_select("SELECT a.JOB_NO,b.ID,d.REQUIRMENT from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_avg_con_dtls d where a.id=b.job_id and a.job_no=c.job_no and c.id=d.pre_cost_fabric_cost_dtls_id and b.id=d.po_break_down_id and c.color_type_id in(2,3,4,6) and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 $poIdsCondCons  and d.CONS>0");
    $job_wise_cons_array = array();
    $po_wise_cons_array = array();
    foreach ($sqlCons as $val) 
    {
        $job_wise_cons_array[$val['JOB_NO']] += $val['REQUIRMENT'];
        $po_wise_cons_array[$val['JOB_NO']][$val['ID']] += $val['REQUIRMENT'];
    }
    unset($sqlCons);
    // ======================================= dayed yarn rcv ====================================
    $sql_yarn_dyed = "SELECT a.JOB_NO ,a.cons_quantity as RECV_QNTY,(case when b.RECEIVE_DATE < '$current_date' then a.cons_quantity else 0 end) as PREV_RECV_QNTY from inv_transaction a, inv_receive_master b, product_details_master c where a.mst_id=b.id and a.prod_id=c.id and b.entry_form=1 and b.receive_basis=2 and b.receive_purpose=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.item_category=1 and a.transaction_type=1 $jobCond and c.dyed_type=1";
    // echo $sql_yarn_dyed;die();
    $sql_yarn_dyed_res = sql_select($sql_yarn_dyed);
    $yarn_dyed_rcv_qty_array = array();
    $yarn_dyed_prev_rcv_qty_array = array();
    foreach ($sql_yarn_dyed_res as $val) 
    {
        $yarn_dyed_rcv_qty_array[$val['JOB_NO']] += $val['RECV_QNTY'];
        $yarn_dyed_prev_rcv_qty_array[$val['JOB_NO']] += $val['PREV_RECV_QNTY'];
    }
    unset($sql_yarn_dyed);
    // ======================================= Primary yarn req  ==================================
    $poIdsCondYarn = str_replace("po_break_down_id", "b.id", $poIdsCond);
    $sqlpo="SELECT a.id as JOB_ID, a.job_no AS JOB_NO, b.id AS ID, c.item_number_id AS ITEM_NUMBER_ID, c.color_number_id AS COLOR_NUMBER_ID, c.size_number_id AS SIZE_NUMBER_ID, c.order_quantity AS ORDER_QUANTITY, c.plan_cut_qnty AS PLAN_CUT_QNTY, d.costing_per_id AS COSTING_PER from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_dtls d where a.id=b.job_id and b.id=c.po_break_down_id and a.id=d.job_id and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 and d.is_deleted=0 and d.status_active=1 $poIdsCondYarn";
    // echo $sqlpo;
    $sqlpoRes = sql_select($sqlpo);
    $po_arr=array(); $costingPerArr=array(); 
    foreach($sqlpoRes as $row)
    {
        $costingPerQty=0;
        if($row['COSTING_PER']==1) $costingPerQty=12;
        elseif($row['COSTING_PER']==2) $costingPerQty=1;    
        elseif($row['COSTING_PER']==3) $costingPerQty=24;
        elseif($row['COSTING_PER']==4) $costingPerQty=36;
        elseif($row['COSTING_PER']==5) $costingPerQty=48;
        else $costingPerQty=0;
        
        $costingPerArr[$row['JOB_ID']]=$costingPerQty;
        
        $po_arr[$row['JOB_ID']][$row['ID']][$row['ITEM_NUMBER_ID']][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['poqty']+=$row['ORDER_QUANTITY'];
        $po_arr[$row['JOB_ID']][$row['ID']][$row['ITEM_NUMBER_ID']][$row['COLOR_NUMBER_ID']][$row['SIZE_NUMBER_ID']]['planqty']+=$row['PLAN_CUT_QNTY'];     
    }
    //==================================== YARN ALLOCATION ==============================================
    $poIdsCondYarnAllo = str_replace("po_break_down_id", "B.PO_BREAK_DOWN_ID", $poIdsCond);
    $sqlYarnAllo = "SELECT B.PO_BREAK_DOWN_ID as PO_ID,MAX(B.ALLOCATION_DATE) AS ADATE,SUM(B.QNTY) AS QNTY,SUM(case when a.allocation_date < '$current_date' then B.QNTY else 0 end) AS PREV_QNTY from INV_MATERIAL_ALLOCATION_MST A, INV_MATERIAL_ALLOCATION_DTLS B, PRODUCT_DETAILS_MASTER C WHERE A.ID=B.MST_ID  AND A.ITEM_ID = C.ID AND B.ITEM_ID = C.ID AND C.item_category_id = 1 AND B.IS_DYIED_YARN != 1 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 $poIdsCondYarnAllo GROUP BY B.PO_BREAK_DOWN_ID";
    // ECHO $sqlYarnAllo;die();
    $sqlYarnAlloRes = sql_select($sqlYarnAllo);
    $yarnAlloArr = array();
    foreach ($sqlYarnAlloRes as $val) 
    {
        $yarnAlloArr[$val['PO_ID']]['qnty'] = $val['QNTY'];
        $yarnAlloArr[$val['PO_ID']]['prev_qnty'] = $val['PREV_QNTY'];
        $yarnAlloArr[$val['PO_ID']]['date'] = $val['ADATE'];
    }
    // echo "<pre>";print_r($yarnAlloArr);die();
    $condition= new condition();     
    $condition->po_id_in($poIDS);     
    $condition->init();
    $costPerArr=$condition->getCostingPerArr();
    $yarn= new yarn($condition);
    //echo $yarn->getQuery(); die;       
    $yarnReqQtyArr=$yarn->getOrderWiseYarnQtyArray();
    $conversion= new conversion($condition);
    $conversion_costing_arr=$conversion->getQtyArray_by_orderAndProcess();
    // echo"<pre>";print_r($conversion_costing_arr);die();
    $trims= new trims($condition);
     // echo $trims->getQuery(); die;
    $trims_costing_arr=$trims->getQtyArray_by_orderAndTrimsTypeid();
    // echo"<pre>";print_r($trims_costing_arr);die();
    $fabric= new fabric($condition);
    // echo $fabric->getQuery(); die; 
    $fabric_costing_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish_production();
    $fabric_purchase_costing_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish_purchase();
    // echo"<pre>";print_r($fabric_costing_arr);die();
    $fabric_po_color_type_wise_arr=$fabric->getQtyArray_by_orderColorType_knitAndwoven_greyAndfinish();
    $fabric_costing_aop_arr = $fabric->getQtyArray_by_orderAndColorTypeFabricSource_knitAndwoven_greyAndfinish();
    // echo"<pre>";print_r($fabric_po_color_type_wise_arr);die();
    $emblishment= new emblishment($condition);
    $emblishment_costing_arr=$emblishment->getQtyArray_by_orderAndEmbname();
    // echo"<pre>";print_r($emblishment_costing_arr);die();
    // echo $emblishment->getQuery(); die;   
    $wash= new wash($condition);
    $emblishment_costing_arr_name=$wash->getQtyArray_by_orderAndEmbname();
    // echo $wash->getQuery(); die;       

    //======================================== YARN ISSUE ====================================
    $poIdsCondYrnIss = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
    $sqlYrnIss = "SELECT C.PO_BREAKDOWN_ID,SUM(CASE WHEN B.TRANSACTION_TYPE=2 THEN C.QUANTITY ELSE 0 END) AS ISSUE_QNTY,SUM(CASE WHEN B.TRANSACTION_TYPE=4 THEN C.QUANTITY ELSE 0 END) AS RTN_QTY FROM INV_ISSUE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE in(2,4) $poIdsCondYrnIss and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=3 AND A.ITEM_CATEGORY=1 and a.issue_basis=3 and a.issue_purpose=1 GROUP BY C.PO_BREAKDOWN_ID";
    // echo $sqlYrnIss;die();
    $sqlYrnIssRes = sql_select($sqlYrnIss);
    $yarnIssueQtyArr = array();
    foreach ($sqlYrnIssRes as $val) 
    {
        $yarnIssueQtyArr[$val['PO_BREAKDOWN_ID']]['issue'] = $val['ISSUE_QNTY'];
        $yarnIssueQtyArr[$val['PO_BREAKDOWN_ID']]['rtn'] = $val['RTN_QTY'];
    }
    unset($sqlYrnIssRes);
    // ======================================= Yarn dyed receive ==============================
    $poIdsCondYarnDye = str_replace("po_break_down_id", "B.ORDER_ID", $poIdsCond);
    $sql = "SELECT A.RECEIVE_DATE,B.ORDER_ID,SUM(B.CONS_QUANTITY) AS QNTY FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B WHERE A.RECEIVE_BASIS=2 AND A.RECEIVE_PURPOSE=2 AND B.TRANSACTION_TYPE=1 $poIdsCondYarnDye and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND A.ENTRY_FORM=1 AND A.ITEM_CATEGORY=1 GROUP BY B.ORDER_ID,A.RECEIVE_DATE order by A.RECEIVE_DATE ASC ";
    // echo $sql;die();
    $sqlYRes = sql_select($sql);
    $yarnDyedArr = array();
    foreach ($sqlYRes as  $val) 
    {
       $yarnDyedArr[$val['ORDER_ID']]['qty'] += $val['QNTY'];
       $yarnDyedArr[$val['ORDER_ID']]['lstqty'] = $val['QNTY'];
    }
    unset($sqlYRes);
    // ======================================= YARN DYED ISSUE ==============================
    // $poIdsCondYarnDye = str_replace("po_break_down_id", "B.ORDER_ID", $poIdsCond);
    $sqlDyeYrnIss = "SELECT C.PO_BREAKDOWN_ID,SUM(CASE WHEN B.TRANSACTION_TYPE=2 THEN C.QUANTITY ELSE 0 END) AS ISSUE_QNTY,SUM(CASE WHEN B.TRANSACTION_TYPE=4 THEN C.QUANTITY ELSE 0 END) AS RTN_QTY FROM INV_ISSUE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE in(2,4) $poIdsCondYrnIss and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=3 AND A.ITEM_CATEGORY=1 and a.issue_basis=1 and a.issue_purpose=2 GROUP BY C.PO_BREAKDOWN_ID";
    // echo $sqlDyeYrnIss;die();
    $sqlDyeYrnIssRes = sql_select($sqlDyeYrnIss);
    $yarnDyeIssueQtyArr = array();
    foreach ($sqlDyeYrnIssRes as $val) 
    {
        $yarnDyeIssueQtyArr[$val['PO_BREAKDOWN_ID']]['issue'] = $val['ISSUE_QNTY'];
        $yarnDyeIssueQtyArr[$val['PO_BREAKDOWN_ID']]['rtn'] = $val['RTN_QTY'];
    }
    unset($sqlDyeYrnIssRes);
    // echo "<pre>";print_r($yarnDyeIssueQtyArr);die();
    // ======================================= GREY PROD ==============================
    $poIdsCondGrey = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
    $sqlGrey = "SELECT C.PO_BREAKDOWN_ID,A.RECEIVE_DATE AS RCV_DATE,SUM(C.QUANTITY) AS QNTY,SUM(case when a.receive_date < '$current_date' then C.QUANTITY else 0 end) AS PREV_QNTY FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE=1 $poIdsCondGrey and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=2 AND A.ITEM_CATEGORY=13 GROUP BY C.PO_BREAKDOWN_ID,A.RECEIVE_DATE order by A.RECEIVE_DATE ASC ";
    // echo $sqlGrey;die();
    $greyRes = sql_select($sqlGrey);
    $greyProdArr = array();
    foreach ($greyRes as  $val) 
    {
       $greyProdArr[$val['PO_BREAKDOWN_ID']]['qty']     += $val['QNTY'];
       $greyProdArr[$val['PO_BREAKDOWN_ID']]['prev_qnty']     += $val['PREV_QNTY'];
       $greyProdArr[$val['PO_BREAKDOWN_ID']]['lstqty']  = $val['QNTY'];
       $greyProdArr[$val['PO_BREAKDOWN_ID']]['date']    = $val['RCV_DATE'];
    }
    unset($greyRes);
    /*======================================================================================/
    /                                    grey fab transfer                                  /
    /======================================================================================*/
    $to_order_id_con =where_con_using_array($poIdArray,0,"a.to_order_id");
    $from_order_id_con =where_con_using_array($poIdArray,0,"a.from_order_id");

    $transfer_sql_in=sql_select("SELECT a.to_order_id,b.transfer_qnty as qnty FROM inv_item_transfer_mst a, inv_item_transfer_dtls b WHERE a.id = b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=13 and a.entry_form in(13) and a.transfer_criteria=4 and b.active_dtls_id_in_transfer=1 $to_order_id_con");
    $grey_fab_transfer_data=array();
    foreach ($transfer_sql_in as $row) 
    {
        $grey_fab_transfer_data[$row[csf('to_order_id')]]['in']+=$row[csf('qnty')];
    }
    $transfer_sql_out=sql_select("SELECT a.from_order_id,b.transfer_qnty as qnty FROM inv_item_transfer_mst a, inv_item_transfer_dtls b WHERE a.id = b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=13 and a.entry_form in(13) and a.transfer_criteria=4 and b.active_dtls_id_in_transfer=0 $from_order_id_con");
    foreach ($transfer_sql_out as $row) 
    {
        $grey_fab_transfer_data[$row[csf('from_order_id')]]['out']+=$row[csf('qnty')];
    }
    // echo "<pre>";print_r($grey_fab_transfer_data);die();
    //======================================== PROGRAM QNTY ================================
    $poIdsProg = str_replace("po_break_down_id", "PO_ID", $poIdsCond);
    $sqlProg = "SELECT PO_ID,sum(program_qnty) as QTY from ppl_planning_entry_plan_dtls where status_active=1 and is_deleted=0 $poIdsProg group by PO_ID";
    // echo $sqlProg;die();
    $pogRes = sql_select($sqlProg);
    $progQtyArray = array();
    foreach ($pogRes as $val) 
    {
        $progQtyArray[$val['PO_ID']] = $val['QTY'];
    }
    unset($pogRes);
    // ======================================= DYEING PRODUCTION ==============================
    $poIdsCondDye = str_replace("po_break_down_id", "B.PO_ID", $poIdsCond);
    $sqlDye = "SELECT B.PO_ID,C.PRODUCTION_DATE AS PDATE,SUM(B.BATCH_QNTY) AS QTY,SUM(case when c.PROCESS_END_DATE < '$current_date' then B.BATCH_QNTY else 0 end) AS PREV_QTY FROM PRO_BATCH_CREATE_MST A, PRO_BATCH_CREATE_DTLS B,PRO_FAB_SUBPROCESS C WHERE A.ID=B.MST_ID  AND A.ID=C.BATCH_ID $poIdsCondDye AND C.LOAD_UNLOAD_ID=2  and a.batch_against<>2  AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 and a.extention_no is null GROUP BY B.PO_ID,C.PRODUCTION_DATE order by C.PRODUCTION_DATE ASC";//AND C.RESULT=1 and c.process_id=31
    // echo $sqlDye;die();
    $dyeRes = sql_select($sqlDye);
    $dyeingProdArr = array();
    foreach ($dyeRes as $val) 
    {
       $dyeingProdArr[$val['PO_ID']]['in'] += $val['QTY'];
       $dyeingProdArr[$val['PO_ID']]['prev_in'] += $val['PREV_QTY'];
       $dyeingProdArr[$val['PO_ID']]['lstqty'] = $val['QTY'];
       $dyeingProdArr[$val['PO_ID']]['date'] = $val['PDATE'];
    }
    unset($dyeRes);

    // ======================================= DYEING PRODUCTION (Outbound) ==============================
    $poIdsCondDye = str_replace("po_break_down_id", "B.ORDER_ID", $poIdsCond);
    $sqlDye = "SELECT B.ORDER_ID as PO_ID,A.RECEIVE_DATE AS PDATE,SUM(B.GREY_USED) AS QTY FROM INV_RECEIVE_MAS_BATCHROLL A, PRO_GREY_BATCH_DTLS B WHERE A.ID=B.MST_ID  $poIdsCondDye AND B.PROCESS_ID='31' AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY B.ORDER_ID,A.RECEIVE_DATE order by A.RECEIVE_DATE ASC";
    // echo $sqlDye;die();
    $dyeRes = sql_select($sqlDye);
    foreach ($dyeRes as $val) 
    {
       $dyeingProdArr[$val['PO_ID']]['qty'] += $val['QTY'];
       // $dyeingProdArr[$val['PO_ID']]['lstqty'] = $val['QTY'];
       // $dyeingProdArr[$val['PO_ID']]['date'] = $val['PDATE'];
    }

    $poIdsCondFin = str_replace("po_break_down_id", "c.po_breakdown_id", $poIdsCond);
    $sqlDye = "SELECT c.po_breakdown_id as po_id,b.grey_used_qty as QTY,(case when a.receive_date<'$current_date' then b.grey_used_qty else 0 end) as PREV_QTY from inv_receive_master a,pro_finish_fabric_rcv_dtls b,order_wise_pro_details c where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 $poIdsCondFin and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(37) and c.entry_form in(37) and a.item_category=2 and a.receive_basis=11 and a.company_id=$company_id";
     // echo $sqlDye;die();
    $dyeRes = sql_select($sqlDye);
    foreach ($dyeRes as $val) 
    {
       $dyeingProdArr[$val['PO_ID']]['out'] += $val['QTY'];
       $dyeingProdArr[$val['PO_ID']]['prev_out'] += $val['PREV_QTY'];
    }
    // ======================================= BATCH QNTY ==============================
    $poIdsCondDye = str_replace("po_break_down_id", "B.PO_ID", $poIdsCond);
    $sqlBatch = "SELECT B.PO_ID,SUM(B.BATCH_QNTY) AS QTY FROM PRO_BATCH_CREATE_MST A, PRO_BATCH_CREATE_DTLS B WHERE A.ID=B.MST_ID $poIdsCondDye AND a.batch_against IN (1) AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY B.PO_ID";
    // echo $sqlBatch;die();
    $batchRes = sql_select($sqlBatch);
    $batchQtyArr = array();
    foreach ($batchRes as $val) 
    {
       $batchQtyArr[$val['PO_ID']]['qty'] = $val['QTY'];
    }
    unset($batchRes);
    // ======================================= AOP ==============================
    $poIdsCondAop = str_replace("po_break_down_id", "B.ORDER_ID", $poIdsCond);
    $sqlAOP = "SELECT B.ORDER_ID,A.RECEIVE_DATE AS RDATE,SUM(CASE WHEN A.ENTRY_FORM=91 THEN B.BATCH_ISSUE_QTY ELSE 0 END) AS ISSUE_QTY,SUM(CASE WHEN A.ENTRY_FORM=92 THEN B.BATCH_ISSUE_QTY ELSE 0 END) AS RCV_QTY,SUM(CASE WHEN A.ENTRY_FORM=92 and a.RECEIVE_DATE < '$current_date' THEN B.BATCH_ISSUE_QTY ELSE 0 END) AS PREV_RCV_QTY FROM INV_RECEIVE_MAS_BATCHROLL A, PRO_GREY_BATCH_DTLS B WHERE A.ID=B.MST_ID $poIdsCondAop AND B.PROCESS_ID=35 AND A.ENTRY_FORM in(91,92) AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY B.ORDER_ID,A.RECEIVE_DATE order by A.RECEIVE_DATE";
    // echo $sqlAOP;die();
    $AOPRes = sql_select($sqlAOP);
    $aopProdArr = array();
    foreach ($AOPRes as $val) 
    {
        $aopProdArr[$val['ORDER_ID']]['qty'] += $val['RCV_QTY'];
        $aopProdArr[$val['ORDER_ID']]['prev_qty'] += $val['PREV_RCV_QTY'];
        $aopProdArr[$val['ORDER_ID']]['issueqty'] += $val['ISSUE_QTY'];
        if($val['RCV_QTY']!=0)
        {
            $aopProdArr[$val['ORDER_ID']]['lstqty'] = $val['RCV_QTY'];
        }
        $aopProdArr[$val['ORDER_ID']]['date'] = $val['RDATE'];
    }
    unset($AOPRes);
    // print_r($aopProdArr);die();
    // ======================================= TRIMS (acc)============================== 
    $poIdsCondAcc = str_replace("po_break_down_id", "B.ID", $poIdsCond);
    $sqlTrimsBudget = "SELECT B.ID AS PO_ID,COUNT(distinct A.trim_group) AS TOT_ITEM FROM WO_PRE_COST_TRIM_COST_DTLS A, WO_PO_BREAK_DOWN B WHERE A.JOB_ID=B.JOB_ID $poIdsCondAcc AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY B.ID";//COUNT(A.ID)
    // echo $sqlTrimsBudget;die();
    $trimsItemCountBudgetWise = array();
    $trimsBudgetRes = sql_select($sqlTrimsBudget);
    foreach ($trimsBudgetRes as $val) 
    {
        $trimsItemCountBudgetWise[$val['PO_ID']] = $val['TOT_ITEM'];
    }
    unset($trimsBudgetRes);
    //====================================================================     
    $poIdsCondAcc = str_replace("po_break_down_id", "C.PO_BREAK_DOWN_ID", $poIdsCond);
    $sqlTrims = "SELECT C.PO_BREAK_DOWN_ID,COUNT(distinct B.TRIM_GROUP) AS TOT_ITEM FROM WO_BOOKING_MST A,WO_BOOKING_DTLS B,WO_TRIM_BOOK_CON_DTLS C WHERE A.BOOKING_NO=B.BOOKING_NO AND B.BOOKING_NO=C.BOOKING_NO AND B.ID=C.WO_TRIM_BOOKING_DTLS_ID $poIdsCondAcc and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=87 AND A.BOOKING_TYPE=2 AND A.IS_SHORT=2 GROUP BY C.PO_BREAK_DOWN_ID ";
    // echo $sqlTrims;die();
    $trimsRes = sql_select($sqlTrims);
    $trimsBookingArr = array();
    foreach ($trimsRes as  $val) 
    {
       $trimsBookingArr[$val['PO_BREAK_DOWN_ID']] = $val['TOT_ITEM'];
    }
    unset($trimsRes);
    // ======================================= FINISH FAB RCV ==============================   
    $poIdsCondFin = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
    $sqlFinFab = "SELECT C.PO_BREAKDOWN_ID,A.RECEIVE_DATE AS RCV_DATE,SUM(C.QUANTITY) AS QNTY,SUM(case when a.receive_date < '$current_date' then C.QUANTITY else 0 end) AS PREV_QNTY,b.ORDER_UOM FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE=1 $poIdsCondFin and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM in(7,37) AND A.ITEM_CATEGORY=2  GROUP BY C.PO_BREAKDOWN_ID,A.RECEIVE_DATE,B.ORDER_UOM order by A.RECEIVE_DATE ASC"; 
    //  echo $sqlFinFab;die();
    $finFabRes = sql_select($sqlFinFab);
    $finFabProdArr = array();
    $finFabProdWithUomArray = array();
    foreach ($finFabRes as  $val) 
    {
       $finFabProdArr[$val['PO_BREAKDOWN_ID']]['qty'] += $val['QNTY'];
       $finFabProdArr[$val['PO_BREAKDOWN_ID']]['lstqty'] = $val['QNTY'];
       $finFabProdArr[$val['PO_BREAKDOWN_ID']]['date'] = $val['RCV_DATE'];

       $finFabProdWithUomArray[$val['PO_BREAKDOWN_ID']][$val['ORDER_UOM']]['qty'] += $val['QNTY'];
       $finFabProdWithUomArray[$val['PO_BREAKDOWN_ID']][$val['ORDER_UOM']]['prev_qty'] += $val['PREV_QNTY'];
    }
    unset($finFabRes);
    // echo "<pre>";print_r($finFabProdWithUomArray);die();
    // ======================================= FINISH FAB PURCHASE ==============================   
    $poIdsCondFin = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
    $sqlFinFabpur = "SELECT C.PO_BREAKDOWN_ID,A.RECEIVE_DATE AS RCV_DATE,SUM(C.QUANTITY) AS QNTY,d.UNIT_OF_MEASURE,SUM(case when a.receive_date < '$current_date' then C.QUANTITY else 0 end) AS PREV_QNTY FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C,PRODUCT_DETAILS_MASTER D WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE=1 and d.id=b.prod_id and a.receive_basis in(1,2,4) $poIdsCondFin and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM in(37) AND A.ITEM_CATEGORY=2 GROUP BY C.PO_BREAKDOWN_ID,A.RECEIVE_DATE,d.UNIT_OF_MEASURE order by A.RECEIVE_DATE ASC";
    // echo $sqlFinFabpur;die();
    $finFabPurRes = sql_select($sqlFinFabpur);
    $finFabPurchaseArr = array();
    $finFabPurchaseUOMArr = array();
    foreach ($finFabPurRes as  $val) 
    {
       $finFabPurchaseArr[$val['PO_BREAKDOWN_ID']]['qty'] += $val['QNTY'];
       $finFabPurchaseArr[$val['PO_BREAKDOWN_ID']]['prev_qty'] += $val['PREV_QNTY'];
       $finFabPurchaseUOMArr[$val['PO_BREAKDOWN_ID']][$val['UNIT_OF_MEASURE']]['qty'] += $val['QNTY'];
    }
    unset($finFabPurRes);
    // ======================================= FINISH FAB TRANSFER ==============================   
    $poIdsCondTrnsfr = str_replace("po_break_down_id", "B.PO_BREAKDOWN_ID", $poIdsCond);
    //$sqlFinFabTr = "SELECT C.ORDER_ID,C.TRANSACTION_TYPE,SUM(B.TRANSFER_QNTY) AS QNTY FROM INV_ITEM_TRANSFER_MST A,INV_ITEM_TRANSFER_DTLS B,INV_TRANSACTION C WHERE A.ID=B.MST_ID AND A.ID=C.MST_ID AND C.ID=B.TRANS_ID  AND C.TRANSACTION_TYPE in(5,6) and A.TRANSFER_CRITERIA=4 $poIdsCondTrnsfr and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=14 AND A.ITEM_CATEGORY=2 GROUP BY C.ORDER_ID,C.TRANSACTION_TYPE ";
    $sqlFinFabTr = "SELECT B.PO_BREAKDOWN_ID,A.TRANSACTION_TYPE,SUM(B.QUANTITY) AS QNTY FROM INV_TRANSACTION A,ORDER_WISE_PRO_DETAILS B,INV_ITEM_TRANSFER_MST C WHERE A.ID=B.trans_id and a.prod_id=b.prod_id and c.id=a.mst_id AND a.TRANSACTION_TYPE in(5,6) and c.TRANSFER_CRITERIA=4 $poIdsCondTrnsfr and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND c.ENTRY_FORM=14 AND A.ITEM_CATEGORY=2 GROUP BY B.PO_BREAKDOWN_ID,A.TRANSACTION_TYPE ";
    // echo $sqlFinFabTr;die();
    $sqlFinFabTrRes = sql_select($sqlFinFabTr);
    $finFabTrnsArr = array();
    foreach ($sqlFinFabTrRes as  $val) 
    {
       $finFabTrnsArr[$val['PO_BREAKDOWN_ID']][$val['TRANSACTION_TYPE']]['qty'] = $val['QNTY'];
    }
    unset($sqlFinFabTrRes);
    // ======================================= FINISH FAB ISSUE TO CUT ==============================
    $sqlIssue = "SELECT C.PO_BREAKDOWN_ID,MAX(A.ISSUE_DATE) AS ISSUE_DATE,SUM(C.QUANTITY) AS QNTY FROM INV_ISSUE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE=2 AND A.ISSUE_PURPOSE=9 $poIdsCondFin and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=18 AND A.ITEM_CATEGORY=2 GROUP BY C.PO_BREAKDOWN_ID ";
    // echo $sqlIssue;die();
    $issueRes = sql_select($sqlIssue);
    $issueProdArr = array();
    foreach ($issueRes as  $val) 
    {
       $issueProdArr[$val['PO_BREAKDOWN_ID']]['qty'] = $val['QNTY'];
       $issueProdArr[$val['PO_BREAKDOWN_ID']]['date'] = $val['ISSUE_DATE'];
    }
    unset($issueRes);
    // ======================================= FIN FAB STOCK ==============================
    $poIdsCondStock = str_replace("po_break_down_id", "D.PO_BREAKDOWN_ID", $poIdsCond);
    $sql_stock="SELECT D.PO_BREAKDOWN_ID, 
    SUM(CASE WHEN D.ENTRY_FORM IN (7,37,66,68) AND C.STORE_ID IN(14,16) THEN D.QUANTITY ELSE 0 END) AS DYE_RECEIVE_QNTY,
    SUM(CASE WHEN D.ENTRY_FORM IN (46) AND C.STORE_ID IN(14,16) THEN D.QUANTITY ELSE 0 END) AS DYE_RCV_RTN_QNTY, 
    SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=5 AND C.STORE_ID IN(14,16) THEN D.QUANTITY ELSE 0 END) AS DYE_REC_TRNS_QNTY, 
    SUM(CASE WHEN D.ENTRY_FORM IN (18,71) AND C.STORE_ID IN(14,16) THEN D.QUANTITY ELSE 0 END) AS DYE_ISSUE_QNTY, 
    SUM(CASE WHEN D.ENTRY_FORM IN (126,52) AND C.STORE_ID IN(14,16) THEN D.QUANTITY ELSE 0 END) AS DYE_ISSUE_RET_QNTY, 
    SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=6 AND C.STORE_ID IN(14,16) THEN D.QUANTITY ELSE 0 END) AS DYE_ISSUE_TRNS_QNTY,    
    SUM(CASE WHEN D.ENTRY_FORM IN (7,37,66,68) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_RECEIVE_QNTY,
    SUM(CASE WHEN D.ENTRY_FORM IN (46) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_RCV_RTN_QNTY, 
    SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=5 AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_REC_TRNS_QNTY, 
    SUM(CASE WHEN D.ENTRY_FORM IN (18,71) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_ISSUE_QNTY, 
    SUM(CASE WHEN D.ENTRY_FORM IN (126,52) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_ISSUE_RET_QNTY, 
    SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=6 AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_ISSUE_TRNS_QNTY 
    FROM  ORDER_WISE_PRO_DETAILS D,INV_TRANSACTION C,PRODUCT_DETAILS_MASTER E WHERE D.TRANS_ID=C.ID AND C.PROD_ID=E.ID AND D.TRANS_ID!=0 AND D.ENTRY_FORM IN (14,7,37,66,68,14,15,18,71,126,134,52) AND C.ITEM_CATEGORY=2 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND D.STATUS_ACTIVE=1 AND D.IS_DELETED=0 AND E.STATUS_ACTIVE=1 AND E.IS_DELETED=0 $poIdsCondStock AND E.COMPANY_ID=$company_id
    GROUP BY D.PO_BREAKDOWN_ID ";
    // echo $sql_stock;die();
    $stockRes = sql_select($sql_stock);
    $finFabStkArray = array();
    foreach ($stockRes as $val) 
    {
        $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_rcv'] = $val['DYE_RECEIVE_QNTY'];
        $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_rcv_rtn'] = $val['DYE_RCV_RTN_QNTY'];
        $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_rcv_trns'] = $val['DYE_REC_TRNS_QNTY'];
        $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_issue'] = $val['DYE_ISSUE_QNTY'];
        $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_issue_rtn'] = $val['DYE_ISSUE_RET_QNTY'];
        $finFabStkArray[$val['PO_BREAKDOWN_ID']]['dye_issue_trns'] = $val['DYE_ISSUE_TRNS_QNTY'];

        $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_rcv'] = $val['GMT_RECEIVE_QNTY'];
        $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_rcv_rtn'] = $val['GMT_RCV_RTN_QNTY'];
        $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_rcv_trns'] = $val['GMT_REC_TRNS_QNTY'];
        $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_issue'] = $val['GMT_ISSUE_QNTY'];
        $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_issue_rtn'] = $val['GMT_ISSUE_RET_QNTY'];
        $finFabStkArray[$val['PO_BREAKDOWN_ID']]['gmt_issue_trns'] = $val['GMT_ISSUE_TRNS_QNTY'];
    }
    unset($stockRes);
    // ======================================= FIN FAB RECEIVE BY FIN FAB STORE ==============================        
    /*$sql_stock2="SELECT D.PO_BREAKDOWN_ID,e.UOM, 
    SUM(CASE WHEN D.ENTRY_FORM IN (7,37,66,68) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_RECEIVE_QNTY,
    SUM(CASE WHEN D.ENTRY_FORM IN (46) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_RCV_RTN_QNTY, 
    SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=5 AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_REC_TRNS_QNTY
    FROM  INV_ITEM_TRANSFER_MST b,ORDER_WISE_PRO_DETAILS D,INV_TRANSACTION C,PRODUCT_DETAILS_MASTER E WHERE D.TRANS_ID=C.ID AND C.PROD_ID=E.ID and b.id=c.mst_id and b.is_acknowledge=1 AND D.TRANS_ID!=0  AND C.ITEM_CATEGORY=2 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND D.STATUS_ACTIVE=1 AND D.IS_DELETED=0 AND E.STATUS_ACTIVE=1 AND E.IS_DELETED=0 $poIdsCondStock AND E.COMPANY_ID=$company_id GROUP BY D.PO_BREAKDOWN_ID,e.uom ";//AND D.ENTRY_FORM IN (7,37,66,68)
    // echo $sql_stock2;die();*/

    $sql_stock2="SELECT D.PO_BREAKDOWN_ID, e.UNIT_OF_MEASURE as UOM,
        SUM(CASE WHEN D.ENTRY_FORM IN (7,37,66,68) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_RECEIVE_QNTY,
        SUM(CASE WHEN D.ENTRY_FORM IN (7,37,66,68) AND C.STORE_ID IN(8,20,32) and b.TRANSFER_DATE < '$current_date' THEN D.QUANTITY ELSE 0 END) AS PREV_GMT_RECEIVE_QNTY,
        SUM(CASE WHEN D.ENTRY_FORM IN (46) AND C.STORE_ID IN(8,20,32) THEN D.QUANTITY ELSE 0 END) AS GMT_RCV_RTN_QNTY, 
        SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=5 AND a.from_store IN (16,46,14,47) and a.to_store in(8,20,32,52) THEN D.QUANTITY ELSE 0 END) AS GMT_REC_TRNS_QNTY,
        SUM(CASE WHEN D.ENTRY_FORM IN(14,15,134) AND D.TRANS_TYPE=5 AND a.from_store IN (16,46,14,47) and a.to_store in(8,20,32,52)  and b.TRANSFER_DATE < '$current_date' THEN D.QUANTITY ELSE 0 END) AS PREV_GMT_REC_TRNS_QNTY
        FROM  INV_ITEM_TRANSFER_MST b,ORDER_WISE_PRO_DETAILS D,INV_TRANSACTION C,PRODUCT_DETAILS_MASTER E,INV_ITEM_TRANSFER_DTLS a WHERE D.TRANS_ID=C.ID AND C.PROD_ID=E.ID and b.id=c.mst_id and b.is_acknowledge=1 AND D.TRANS_ID!=0  AND C.ITEM_CATEGORY=2 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND D.STATUS_ACTIVE=1 AND D.IS_DELETED=0 AND E.STATUS_ACTIVE=1 AND E.IS_DELETED=0 $poIdsCondStock AND E.COMPANY_ID=$company_id  and b.id=a.mst_id and a.id=D.DTLS_ID and a.status_active=1  GROUP BY D.PO_BREAKDOWN_ID,e.UNIT_OF_MEASURE ";//AND D.ENTRY_FORM IN (7,37,66,68)
        // echo $sql_stock2;die();

    $stockRes = sql_select($sql_stock2);
    $finFabStkArray2 = array();
    $finFabStkWithUomArray = array();
    foreach ($stockRes as $val) 
    {
        $finFabStkArray2[$val['PO_BREAKDOWN_ID']]['gmt_rcv'] += $val['GMT_RECEIVE_QNTY'];
        $finFabStkArray2[$val['PO_BREAKDOWN_ID']]['prev_gmt_rcv'] = $val['PREV_GMT_RECEIVE_QNTY'];
        $finFabStkArray2[$val['PO_BREAKDOWN_ID']]['gmt_rcv_rtn'] += $val['GMT_RCV_RTN_QNTY'];
        $finFabStkArray2[$val['PO_BREAKDOWN_ID']]['gmt_rcv_trns'] += $val['GMT_REC_TRNS_QNTY'];
        $finFabStkArray2[$val['PO_BREAKDOWN_ID']]['prev_gmt_rcv_trns'] = $val['PREV_GMT_REC_TRNS_QNTY'];

        $finFabStkWithUomArray[$val['PO_BREAKDOWN_ID']][$val['UOM']]['gmt_rcv'] += $val['GMT_RECEIVE_QNTY'];
        $finFabStkWithUomArray[$val['PO_BREAKDOWN_ID']][$val['UOM']]['gmt_rcv_rtn'] += $val['GMT_RCV_RTN_QNTY'];
        $finFabStkWithUomArray[$val['PO_BREAKDOWN_ID']][$val['UOM']]['gmt_rcv_trns'] += $val['GMT_REC_TRNS_QNTY'];
    }
    // echo "<pre>";print_r($finFabStkWithUomArray);die();
    unset($stockRes);
    // ======================================= CUT AND LAY ==============================  
    $poIdsCondFin = str_replace("po_break_down_id", "C.ORDER_ID", $poIdsCond);
    $sqlLay = "SELECT C.ORDER_ID,MAX(A.ENTRY_DATE) AS CUT_DATE,SUM(C.SIZE_QTY) AS QNTY FROM PPL_CUT_LAY_MST A,PPL_CUT_LAY_DTLS B,PPL_CUT_LAY_BUNDLE C WHERE A.ID=B.MST_ID AND A.ID=C.MST_ID AND B.ID=C.DTLS_ID $poIdsCondFin and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 GROUP BY C.ORDER_ID ";
    // echo $sqlLay;die();
    $layRes = sql_select($sqlLay);
    $cutAndLayArr = array();
    foreach ($layRes as  $val) 
    {
       $cutAndLayArr[$val['ORDER_ID']]['qty'] = $val['QNTY'];
       $cutAndLayArr[$val['ORDER_ID']]['date'] = $val['CUT_DATE'];
    }
    unset($layRes);
    // ======================================= CUTTING QC ============================== 
    $poIdsCondQC = str_replace("po_break_down_id", "B.ORDER_ID", $poIdsCond);
    $sqlCutQC = "SELECT B.ORDER_ID,A.ENTRY_DATE AS QC_DATE,SUM(B.QC_PASS_QTY) AS QNTY,SUM(B.REPLACE_QTY) AS REPLACE_QTY,SUM(B.REJECT_QTY) AS REJQNTY FROM PRO_GMTS_CUTTING_QC_MST A,PRO_GMTS_CUTTING_QC_DTLS B WHERE A.ID=B.MST_ID $poIdsCondQC and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY B.ORDER_ID,A.ENTRY_DATE order by A.ENTRY_DATE ASC";
    // echo $sqlCutQC;die();
    $CutQCRes = sql_select($sqlCutQC);
    $CutQCArr = array();
    foreach ($CutQCRes as  $val) 
    {
       $CutQCArr[$val['ORDER_ID']]['qty']   += $val['QNTY'];
       $CutQCArr[$val['ORDER_ID']]['rejqty']+= $val['REJQNTY'];
       $CutQCArr[$val['ORDER_ID']]['rplsqty']+= $val['REPLACE_QTY'];
       $CutQCArr[$val['ORDER_ID']]['date']  = $val['QC_DATE'];
       if($CutQCArr[$val['ORDER_ID']]['qty'] !=0)
       {
            $CutQCArr[$val['ORDER_ID']]['lst_rpls_qty']   = $val['QNTY'];
       }
    }
    unset($CutQCRes);
    // ======================================= SEW/FINISH TRIMS RCV ==============================
    $poIdsCondTr = str_replace("po_break_down_id", "C.PO_BREAKDOWN_ID", $poIdsCond);
    $sqlacc = "SELECT D.TRIM_TYPE,C.PO_BREAKDOWN_ID,MAX(A.RECEIVE_DATE) AS RCV_DATE,SUM(C.QUANTITY) AS QNTY FROM INV_RECEIVE_MASTER A,INV_TRIMS_ENTRY_DTLS B,ORDER_WISE_PRO_DETAILS C,LIB_ITEM_GROUP D WHERE A.ID=B.MST_ID AND B.ID=C.DTLS_ID AND D.ID=B.ITEM_GROUP_ID AND C.TRANS_TYPE=1 $poIdsCondTr and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=24 AND c.entry_form = 24 AND D.TRIM_TYPE !=0 AND A.ITEM_CATEGORY=4 GROUP BY C.PO_BREAKDOWN_ID,D.TRIM_TYPE ";
    // echo $sqlacc;die();
    $accbRes = sql_select($sqlacc);
    $accArr = array();
    foreach ($accbRes as  $val) 
    {
       $accArr[$val['PO_BREAKDOWN_ID']][$val['TRIM_TYPE']]['qty'] = $val['QNTY'];
       $accArr[$val['PO_BREAKDOWN_ID']][$val['TRIM_TYPE']]['date'] = $val['RCV_DATE'];
    }
    unset($accbRes);
    // echo "<pre>";print_r($accArr);die();
    // ======================================= GMTS PRODUCTION DATA ==============================
    $poIdsCondGmts = str_replace("po_break_down_id", "A.PO_BREAK_DOWN_ID", $poIdsCond);
    $sqlProd = "SELECT  A.PO_BREAK_DOWN_ID AS PO_ID,A.PRODUCTION_DATE AS PROD_DATE, SUM(CASE WHEN A.PRODUCTION_TYPE=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS CUT_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PRINTING_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=2 AND A.EMBEL_NAME=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PRINT_ISS_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=2 THEN B.PRODUCTION_QNTY ELSE 0 END) AS EMB_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=2 AND A.EMBEL_NAME=2 THEN B.PRODUCTION_QNTY ELSE 0 END) AS EMB_ISSUE_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=3 THEN B.PRODUCTION_QNTY ELSE 0 END) AS WASH_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=2 AND A.EMBEL_NAME=3 THEN B.PRODUCTION_QNTY ELSE 0 END) AS WASH_ISSUE_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=4 THEN B.PRODUCTION_QNTY ELSE 0 END) AS INPUT_QTY, SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.PRODUCTION_QNTY ELSE 0 END) AS OUT_QTY, SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.ALTER_QTY ELSE 0 END) AS ALTER_QTY, SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.SPOT_QTY ELSE 0 END) AS SPOT_QTY, SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.REPLACE_QTY ELSE 0 END) AS REPLACE_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=1 THEN B.REJECT_QTY ELSE 0 END) AS PRINT_REJECT_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=2 THEN B.REJECT_QTY ELSE 0 END) AS EMB_REJECT_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=3 THEN B.REJECT_QTY ELSE 0 END) AS WASH_REJECT_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.REJECT_QTY ELSE 0 END) AS REJECT_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=8 THEN B.PRODUCTION_QNTY ELSE 0 END) AS FINISH_QTY,SUM(CASE WHEN A.PRODUCTION_TYPE=8 THEN B.REJECT_QTY ELSE 0 END) AS FIN_REJECT_QTY,
         
    SUM(CASE WHEN A.PRODUCTION_TYPE=1 and a.production_date < '$current_date' THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_CUT_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=1 and a.production_date < '$current_date' THEN B.REJECT_QTY ELSE 0 END) AS PREV_CUT_REJECT_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_PRINTING_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=2 and a.production_date < '$current_date' AND A.EMBEL_NAME=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_PRINT_ISS_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=2 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_EMB_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=2 and a.production_date < '$current_date' AND A.EMBEL_NAME=2 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_EMB_ISSUE_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=3 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_WASH_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=2 and a.production_date < '$current_date' AND A.EMBEL_NAME=3 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_WASH_ISSUE_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=4 and a.production_date < '$current_date' THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_INPUT_QTY, 
    SUM(CASE WHEN A.PRODUCTION_TYPE=5 and a.production_date < '$current_date' THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_OUT_QTY, 
    SUM(CASE WHEN A.PRODUCTION_TYPE=5 and a.production_date < '$current_date' THEN B.ALTER_QTY ELSE 0 END) AS PREV_ALTER_QTY, 
    SUM(CASE WHEN A.PRODUCTION_TYPE=5 and a.production_date < '$current_date' THEN B.SPOT_QTY ELSE 0 END) AS PREV_SPOT_QTY, 
    SUM(CASE WHEN A.PRODUCTION_TYPE=5 and a.production_date < '$current_date' THEN B.REPLACE_QTY ELSE 0 END) AS PREV_REPLACE_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=1 THEN B.REJECT_QTY ELSE 0 END) AS PREV_PRINT_REJECT_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=2 THEN B.REJECT_QTY ELSE 0 END) AS PREV_EMB_REJECT_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=3 and a.production_date < '$current_date' AND A.EMBEL_NAME=3 THEN B.REJECT_QTY ELSE 0 END) AS PREV_WASH_REJECT_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=5 and a.production_date < '$current_date' THEN B.REJECT_QTY ELSE 0 END) AS PREV_REJECT_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=8 and a.production_date < '$current_date' THEN B.PRODUCTION_QNTY ELSE 0 END) AS PREV_FINISH_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=8 and a.production_date < '$current_date' THEN B.REJECT_QTY ELSE 0 END) AS PREV_FIN_REJECT_QTY
    FROM PRO_GARMENTS_PRODUCTION_MST A, PRO_GARMENTS_PRODUCTION_DTLS B
    WHERE A.ID=B.MST_ID AND A.STATUS_ACTIVE=1 AND B.STATUS_ACTIVE=1 $poIdsCondGmts AND A.PRODUCTION_TYPE IN(1,2,3,4,5,8) GROUP BY A.PO_BREAK_DOWN_ID,A.PRODUCTION_DATE order by A.PRODUCTION_DATE ASC ";
    // echo $sqlProd;die();
    $prodRes = sql_select($sqlProd);
    $prodArr = array();
    foreach ($prodRes as  $val) 
    {
       $prodArr[$val['PO_ID']]['cut_qty']       += $val['CUT_QTY'];
       $prodArr[$val['PO_ID']]['print_qty']     += $val['PRINTING_QTY'];
       $prodArr[$val['PO_ID']]['print_iss_qty'] += $val['PRINT_ISS_QTY'];
       $prodArr[$val['PO_ID']]['print_rej_qty'] += $val['PRINT_REJECT_QTY'];
       $prodArr[$val['PO_ID']]['emb_qty']       += $val['EMB_QTY'];
       $prodArr[$val['PO_ID']]['emb_issue_qty'] += $val['EMB_ISSUE_QTY'];
       $prodArr[$val['PO_ID']]['emb_rej_qty']   += $val['EMB_REJECT_QTY'];
       $prodArr[$val['PO_ID']]['wash_qty']      += $val['WASH_QTY'];
       $prodArr[$val['PO_ID']]['wash_issue_qty']+= $val['WASH_ISSUE_QTY'];
       $prodArr[$val['PO_ID']]['wash_rej_qty']  += $val['WASH_REJECT_QTY'];
       $prodArr[$val['PO_ID']]['input_qty']     += $val['INPUT_QTY'];
       $prodArr[$val['PO_ID']]['out_qty']       += $val['OUT_QTY'];

       $prodArr[$val['PO_ID']]['prev_cut_qty']       += $val['PREV_CUT_QTY'];
       $prodArr[$val['PO_ID']]['prev_cut_reject_qty']+= $val['PREV_CUT_REJECT_QTY'];
       $prodArr[$val['PO_ID']]['prev_print_qty']     += $val['PREV_PRINTING_QTY'];
       $prodArr[$val['PO_ID']]['prev_print_iss_qty'] += $val['PREV_PRINT_ISS_QTY'];
       $prodArr[$val['PO_ID']]['prev_print_rej_qty'] += $val['PREV_PRINT_REJECT_QTY'];
       $prodArr[$val['PO_ID']]['prev_emb_qty']       += $val['PREV_EMB_QTY'];
       $prodArr[$val['PO_ID']]['prev_emb_issue_qty'] += $val['PREV_EMB_ISSUE_QTY'];
       $prodArr[$val['PO_ID']]['prev_emb_rej_qty']   += $val['PREV_EMB_REJECT_QTY'];
       $prodArr[$val['PO_ID']]['prev_wash_qty']      += $val['PREV_WASH_QTY'];
       $prodArr[$val['PO_ID']]['prev_wash_issue_qty']+= $val['PREV_WASH_ISSUE_QTY'];
       $prodArr[$val['PO_ID']]['prev_wash_rej_qty']  += $val['PREV_WASH_REJECT_QTY'];
       $prodArr[$val['PO_ID']]['prev_input_qty']     += $val['PREV_INPUT_QTY'];
       $prodArr[$val['PO_ID']]['prev_out_qty']       += $val['PREV_OUT_QTY'];
       if($val['OUT_QTY']>0)
       {
            $prodArr[$val['PO_ID']]['lst_out_qty']    = $val['OUT_QTY'];
       }
       $prodArr[$val['PO_ID']]['reject_qty']    += $val['REJECT_QTY'];
       $prodArr[$val['PO_ID']]['alter_qty']     += $val['ALTER_QTY'];
       $prodArr[$val['PO_ID']]['spot_qty']      += $val['SPOT_QTY'];
       $prodArr[$val['PO_ID']]['replace_qty']   += $val['REPLACE_QTY'];
       $prodArr[$val['PO_ID']]['finish_qty']    += $val['FINISH_QTY'];
       $prodArr[$val['PO_ID']]['fin_rej_qty']   += $val['FIN_REJECT_QTY'];
       $prodArr[$val['PO_ID']]['date']          = $val['PROD_DATE'];

       $prodArr[$val['PO_ID']]['prev_reject_qty']    += $val['PREV_REJECT_QTY'];
       $prodArr[$val['PO_ID']]['prev_alter_qty']     += $val['PREV_ALTER_QTY'];
       $prodArr[$val['PO_ID']]['prev_spot_qty']      += $val['PREV_SPOT_QTY'];
       $prodArr[$val['PO_ID']]['prev_replace_qty']   += $val['PREV_REPLACE_QTY'];
       $prodArr[$val['PO_ID']]['prev_finish_qty']    += $val['PREV_FINISH_QTY'];
       $prodArr[$val['PO_ID']]['prev_fin_rej_qty']   += $val['PREV_FIN_REJECT_QTY'];

       if($val['FINISH_QTY'] != 0)
       {
            $prodArr[$val['PO_ID']]['lst_finish_qty']= $val['FINISH_QTY'];
       }
       if($val['WASH_QTY'] != 0)
       {
            $prodArr[$val['PO_ID']]['lst_wash_qty']= $val['WASH_QTY'];
       }
       if($val['EMB_QTY'] != 0)
       {
            $prodArr[$val['PO_ID']]['lst_emb_qty']= $val['EMB_QTY'];
       }
       if($val['PRINTING_QTY'] != 0)
       {
            $prodArr[$val['PO_ID']]['lst_prnt_qty']= $val['PRINTING_QTY'];
       }
    }
    unset($prodRes);
    // echo "<pre>";print_r($prodArr);die();

    // ======================================= EXFACTORY DATA ==============================
    $poIdsCondExf = str_replace("po_break_down_id", "C.PO_BREAK_DOWN_ID", $poIdsCond);
    $sqlEx = "SELECT  C.PO_BREAK_DOWN_ID AS PO_ID,C.EX_FACTORY_DATE AS EX_DATE, SUM(D.PRODUCTION_QNTY) AS EX_FACT_QTY FROM PRO_EX_FACTORY_MST C, PRO_EX_FACTORY_DTLS D, PRO_EX_FACTORY_DELIVERY_MST E WHERE C.ID=D.MST_ID AND E.ID=C.DELIVERY_MST_ID  AND C.STATUS_ACTIVE=1 AND D.STATUS_ACTIVE=1 AND E.STATUS_ACTIVE=1 $poIdsCondExf GROUP BY C.PO_BREAK_DOWN_ID,C.EX_FACTORY_DATE ORDER BY C.EX_FACTORY_DATE ASC"; 
    // echo $sqlEx;die();
    $sqlXRes = sql_select($sqlEx);
    $exfArr = array();
    foreach ($sqlXRes as  $val) 
    {
       $exfArr[$val['PO_ID']]['qty']    += $val['EX_FACT_QTY'];
       $exfArr[$val['PO_ID']]['lqty']   = $val['EX_FACT_QTY'];
       $exfArr[$val['PO_ID']]['exdate'] .= isset($exfArr[$val['PO_ID']]['exdate']) ? ",".strtotime($val['EX_DATE']) : strtotime($val['EX_DATE']);
    }
    unset($sqlXRes);
    // echo "<pre>";print_r($dataArray);die();

    //================================ getting tna plan data ==========================
    $po_id_cond = str_replace("po_break_down_id", "A.PO_ID", $poIdsCond);
    $sqltna = "SELECT A.PO_ID,a.TASK_ID,a.SOURCE_ID,a.PLAN_QTY as ALL_PLAN_QTY,(case when a.plan_date < '$current_date' then a.PLAN_QTY else 0 end) as prev_plan_qty from tna_plan_target a,wo_po_break_down b where a.PO_ID=b.id and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0  and a.PLAN_QTY>0 and a.task_type=1  and a.PLAN_DATE is not null   $po_id_cond";
    // echo $sqltna;die();
    $tnaRes = sql_select($sqltna);
    $tnaPlanTargetArray = array();
    $ffTnaPlanTargetArray = array();
    foreach ($tnaRes as $val) 
    {
        $tnaPlanTargetArray[$val['PO_ID']][$val['TASK_ID']]['all_plan_qty'] += $val['ALL_PLAN_QTY'];
        $tnaPlanTargetArray[$val['PO_ID']][$val['TASK_ID']]['prev_plan_qty'] += $val['PREV_PLAN_QTY'];

        $ffTnaPlanTargetArray[$val['PO_ID']][$val['TASK_ID']][$val['SOURCE_ID']]['all_plan_qty'] += $val['ALL_PLAN_QTY'];
        $ffTnaPlanTargetArray[$val['PO_ID']][$val['TASK_ID']][$val['SOURCE_ID']]['prev_plan_qty'] += $val['PREV_PLAN_QTY'];
    }
    unset($tnaRes);
    // echo "<pre>";print_r($tnaPlanTargetArray);die();
        
    $toDay = new DateTime('now');
    $po_chk_array = array();
    $i=1;
    $buyer_details_backlog_array = array();
    $jobWisePoArray = array();
    foreach ($dataArray as $season => $season_data)
    {
        foreach ($season_data as $jobNo => $job_data)
        {
            foreach ($job_data as $po_id => $val)
            {
                $buyer_details_backlog_array[$season][$jobNo]['style'] = $val['style'];
                $buyer_details_backlog_array[$season][$jobNo]['intRef'] = $val['intRef'];
                $buyer_details_backlog_array[$season][$jobNo]['shipment_date'] = $val['orig_ship_date'];
               
                $costingPer     =  $costPerArr[$jobNo];
                $labDipColorSub = $labDipArray[$po_id]['submit_color'];
                $labDipColorApp = $labDipArray[$po_id]['approve_color'];
                $totPoColor     = count($poWiseColorArray[$po_id]);
                $labDipPrsnt    = ($labDipColorSub/$totPoColor)*100;
                $strickoff      = $smArray[$po_id][60];
                $strickoffPrsnt = ($strickoff/$totPoColor)*100;
                $pp             = $smArray[$po_id][7];
                $ppPrsnt        = ($pp/$totPoColor)*100;
                $sizeSet        = $smArray[$po_id][60];
                $sizeSetPrsnt   = ($sizeSet/$totPoColor)*100;
                $bookingQty     = $bookingQtyArray[$po_id]['qty'];
                $bookingQtyKg   = $bookingQtyWithUomArray[$po_id][12]['qty'];
                $bookingQtyYds  = $bookingQtyWithUomArray[$po_id][23]['qty']+$bookingQtyWithUomArray[$po_id][27]['qty'];
                $bookingDate    = $bookingQtyArray[$po_id]['date'];
                //============= calculate yarn dyed rcv ============
                $yarn_dyed_rcv_qty  = $yarn_dyed_rcv_qty_array[$jobNo];
                $yarn_dyed_prev_rcv_qty  = $yarn_dyed_prev_rcv_qty_array[$jobNo];
                $po_wise_cons       = $po_wise_cons_array[$jobNo][$po_id];
                $job_wise_cons      = $job_wise_cons_array[$jobNo];

                $job_wise_dyed      = $yarn_dyed_rcv_qty / $job_wise_cons;
                $yarn_dyed_qty      = $job_wise_dyed * $po_wise_cons;
                
                $job_wise_dyed_prev = ($job_wise_cons>0) ? $yarn_dyed_prev_rcv_qty / $job_wise_cons : 0;
                $yarn_dyed_prev_qty      = $job_wise_dyed_prev * $po_wise_cons;

                $yarn_excess_qty    = $bookingQtyArray[$po_id]['yarn_excess_qty'];
                $grey_fab_excess_qty= $bookingQtyArray[$po_id]['grey_fab_excess_qty'];
                $fin_fab_excess_qty = $bookingQtyArray[$po_id]['fin_fab_excess_qty'];
                $fin_fab_excess_qty_kg = $bookingQtyWithUomArray[$po_id][12]['fin_fab_excess_qty'];
                $fin_fab_excess_qty_yds = $bookingQtyWithUomArray[$po_id][23]['fin_fab_excess_qty']+$bookingQtyWithUomArray[$po_id][27]['fin_fab_excess_qty'];

                $stylingSbStDate    = $tnaDateArray[$po_id][7]['start_date'];// Styling submit
                $stylingSbEndDate   = $tnaDateArray[$po_id][7]['end_date'];// Styling submit                        
                $stylingSbAcStDate  = $tnaDateArray[$po_id][7]['actual_start_date'];// Styling submit
                $stylingSbAcEndDate = $tnaDateArray[$po_id][7]['actual_finish_date'];// Styling submit

                $stylingApStDate    = $tnaDateArray[$po_id][13]['start_date'];// Styling Approval
                $stylingApEndDate   = $tnaDateArray[$po_id][13]['end_date'];// Styling Approval                        
                $stylingApAcStDate  = $tnaDateArray[$po_id][13]['actual_start_date'];// Styling Approval
                $stylingApAcEndDate = $tnaDateArray[$po_id][13]['actual_finish_date'];// Styling Approval

                $lbdpSbStDate    = $tnaDateArray[$po_id][9]['start_date'];// labdip submit
                $lbdpSbEndDate   = $tnaDateArray[$po_id][9]['end_date'];// labdip submit                        
                $lbdpSbAcStDate  = $tnaDateArray[$po_id][9]['actual_start_date'];// labdip submit
                $lbdpSbAcEndDate = $tnaDateArray[$po_id][9]['actual_finish_date'];// labdip submit

                $lbdpApStDate    = $tnaDateArray[$po_id][10]['start_date'];// labdip Approval
                $lbdpApEndDate   = $tnaDateArray[$po_id][10]['end_date'];// labdip Approval                        
                $lbdpApAcStDate  = $tnaDateArray[$po_id][10]['actual_start_date'];// labdip Approval
                $lbdpApAcEndDate = $tnaDateArray[$po_id][10]['actual_finish_date'];// labdip Approval

                $ppSbStDate    = $tnaDateArray[$po_id][8]['start_date'];// PP Sample submit
                $ppSbEndDate   = $tnaDateArray[$po_id][8]['end_date'];// PP Sample submit                        
                $ppSbAcStDate  = $tnaDateArray[$po_id][8]['actual_start_date'];// PP Sample submit
                $ppSbAcEndDate = $tnaDateArray[$po_id][8]['actual_finish_date'];// PP Sample submit

                $ppApStDate    = $tnaDateArray[$po_id][12]['start_date'];// PP Sample Approval
                $ppApEndDate   = $tnaDateArray[$po_id][12]['end_date'];// PP Sample Approval                        
                $ppApAcStDate  = $tnaDateArray[$po_id][12]['actual_start_date'];// PP Sample Approval
                $ppApAcEndDate = $tnaDateArray[$po_id][12]['actual_finish_date'];// PP Sample Approval

                $sizeSetSbStDate    = $tnaDateArray[$po_id][14]['start_date'];// Size Set submit
                $sizeSetSbEndDate   = $tnaDateArray[$po_id][14]['end_date'];// Size Set submit                        
                $sizeSetSbAcStDate  = $tnaDateArray[$po_id][14]['actual_start_date'];// Size Set submit
                $sizeSetSbAcEndDate = $tnaDateArray[$po_id][14]['actual_finish_date'];// Size Set submit

                $sizeSetApStDate    = $tnaDateArray[$po_id][15]['start_date'];// Size Set Approval
                $sizeSetApEndDate   = $tnaDateArray[$po_id][15]['end_date'];// Size Set Approval                        
                $sizeSetApAcStDate  = $tnaDateArray[$po_id][15]['actual_start_date'];// Size Set Approval
                $sizeSetApAcEndDate = $tnaDateArray[$po_id][15]['actual_finish_date'];// Size Set Approval

                $bookStDate       = $tnaDateArray[$po_id][31]['start_date'];// booking
                $bookEndDate      = $tnaDateArray[$po_id][31]['end_date'];// booking
                $bookAcStDate     = $tnaDateArray[$po_id][31]['actual_start_date'];// booking
                $bookAcEndDate    = $tnaDateArray[$po_id][31]['actual_finish_date'];// booking

                $accBkStDate    = $tnaDateArray[$po_id][32]['start_date'];// acc booking
                $accBkEndDate   = $tnaDateArray[$po_id][32]['end_date'];// acc booking
                $accAcBkStDate  = $tnaDateArray[$po_id][32]['actual_start_date'];// acc booking
                $accAcBkEndDate = $tnaDateArray[$po_id][32]['actual_finish_date'];// acc booking

                $yarntnaStDate  = $tnaDateArray[$po_id][48]['start_date'];// yan allocation
                $yarntnaEndDate = $tnaDateArray[$po_id][48]['end_date'];// yan allocation
                $yarntnaAcStDate= $tnaDateArray[$po_id][48]['actual_start_date'];// yan allocation
                $yarntnaAcEndDate= $tnaDateArray[$po_id][48]['actual_finish_date'];// yan allocation

                $ydtnaStDate    = $tnaDateArray[$po_id][52]['start_date'];// yarn dyed
                $ydtnaEndDate   = $tnaDateArray[$po_id][52]['end_date'];// yarn dyed
                $ydtnaAcStDate  = $tnaDateArray[$po_id][52]['actual_start_date'];// yarn dyed
                $ydtnaAcEndDate = $tnaDateArray[$po_id][52]['actual_finish_date'];// yarn dyed

                $greyStDate     = $tnaDateArray[$po_id][60]['start_date'];// grey fab
                $greyEndDate    = $tnaDateArray[$po_id][60]['end_date'];// grey fab
                $greyAcStDate   = $tnaDateArray[$po_id][60]['actual_start_date'];// grey fab
                $greyAcEndDate  = $tnaDateArray[$po_id][60]['actual_finish_date'];// grey fab

                $aopStDate      = $tnaDateArray[$po_id][63]['start_date'];// grey fab
                $aopEndDate     = $tnaDateArray[$po_id][63]['end_date'];// grey fab
                $aopAcStDate    = $tnaDateArray[$po_id][63]['actual_start_date'];// grey fab
                $aopAcEndDate   = $tnaDateArray[$po_id][63]['actual_finish_date'];// grey fab

                $dyeingStDate   = $tnaDateArray[$po_id][61]['start_date'];// fab dyeing
                $dyeingEndDate  = $tnaDateArray[$po_id][61]['end_date'];// fab dyeing
                $dyeingAcStDate = $tnaDateArray[$po_id][61]['actual_start_date'];// fab dyeing
                $dyeingAcEndDate= $tnaDateArray[$po_id][61]['actual_finish_date'];// fab dyeing

                $sewTrimsStDate = $tnaDateArray[$po_id][70]['start_date'];// trims-sew
                $sewTrimsEndDate= $tnaDateArray[$po_id][70]['end_date'];// trims-sew
                $sewTrimsAcStDate = $tnaDateArray[$po_id][70]['actual_start_date'];// trims-sew
                $sewTrimsAcEndDate= $tnaDateArray[$po_id][70]['actual_finish_date'];// trims-sew

                $finTrimsStDate = $tnaDateArray[$po_id][71]['start_date'];// trims-fin
                $finTrimsEndDate= $tnaDateArray[$po_id][71]['end_date'];// trims-fin
                $finTrimsAcStDate = $tnaDateArray[$po_id][71]['actual_start_date'];// trims-fin
                $finTrimsAcEndDate= $tnaDateArray[$po_id][71]['actual_finish_date'];// trims-fin

                $fabFinStDate   = $tnaDateArray[$po_id][73]['start_date'];// fab finish
                $fabFinEndDate  = $tnaDateArray[$po_id][73]['end_date'];// fab finish
                $fabFinAcStDate = $tnaDateArray[$po_id][73]['actual_start_date'];// fab finish
                $fabFinAcEndDate= $tnaDateArray[$po_id][73]['actual_finish_date'];// fab finish

                $finishStDate   = $tnaDateArray[$po_id][88]['start_date'];// gmt finish
                $finishEndDate  = $tnaDateArray[$po_id][88]['end_date'];// gmt finish
                $finishAcStDate = $tnaDateArray[$po_id][88]['actual_start_date'];// gmt finish
                $finishAcEndDate= $tnaDateArray[$po_id][88]['actual_finish_date'];// gmt finish

                $cuttStDate     = $tnaDateArray[$po_id][84]['start_date'];// fab dyeing
                $cuttEndDate    = $tnaDateArray[$po_id][84]['end_date'];// fab dyeing
                $cuttAcStDate   = $tnaDateArray[$po_id][84]['actual_start_date'];// fab dyeing
                $cuttAcEndDate  = $tnaDateArray[$po_id][84]['actual_finish_date'];// fab dyeing

                $printStDate    = $tnaDateArray[$po_id][267]['start_date'];// fab print
                $printEndDate   = $tnaDateArray[$po_id][267]['end_date'];// fab print
                $printAcStDate  = $tnaDateArray[$po_id][267]['actual_start_date'];// fab print
                $printAcEndDate = $tnaDateArray[$po_id][267]['actual_finish_date'];// fab print

                $embStDate      = $tnaDateArray[$po_id][268]['start_date'];// fab emb
                $embEndDate     = $tnaDateArray[$po_id][268]['end_date'];// fab emb
                $embAcStDate    = $tnaDateArray[$po_id][268]['actual_start_date'];// fab emb
                $embAcEndDate   = $tnaDateArray[$po_id][268]['actual_finish_date'];// fab emb

                $washStDate     = $tnaDateArray[$po_id][90]['start_date'];// fab wash
                $washEndDate    = $tnaDateArray[$po_id][90]['end_date'];// fab wash
                $washAcStDate   = $tnaDateArray[$po_id][90]['actual_start_date'];// fab wash
                $washAcEndDate  = $tnaDateArray[$po_id][90]['actual_finish_date'];// fab wash

                $inputStDate    = $tnaDateArray[$po_id][86]['start_date'];// INPUT
                $inputEndDate   = $tnaDateArray[$po_id][86]['end_date'];// INPUT
                $inputAcStDate  = $tnaDateArray[$po_id][86]['actual_start_date'];// INPUT
                $inputAcEndDate = $tnaDateArray[$po_id][86]['actual_finish_date'];// INPUT

                $exfStDate      = $tnaDateArray[$po_id][110]['start_date'];// Exfact tna date
                $exfEndDate     = $tnaDateArray[$po_id][110]['end_date'];// Exfact tna date
                $exfAcStDate    = $tnaDateArray[$po_id][110]['actual_start_date'];// Exfact tna date
                $exfAcEndDate   = $tnaDateArray[$po_id][110]['actual_finish_date'];// Exfact tna date

                $aopStOfSbStDate      = $tnaDateArray[$po_id][254]['start_date'];// AOP STRICK OFF SUBMISSION
                $aopStOfSbEndDate     = $tnaDateArray[$po_id][254]['end_date'];// AOP STRICK OFF SUBMISSION
                $aopStOfSbAcStDate    = $tnaDateArray[$po_id][254]['actual_start_date'];// AOP STRICK OFF SUBMISSION
                $aopStOfSbAcEndDate   = $tnaDateArray[$po_id][254]['actual_finish_date'];// AOP STRICK OFF SUBMISSION

                $aopStOfApStDate      = $tnaDateArray[$po_id][255]['start_date'];// AOP STRICK OFF APPROVAL
                $aopStOfApEndDate     = $tnaDateArray[$po_id][255]['end_date'];// AOP STRICK OFF APPROVAL
                $aopStOfApAcStDate    = $tnaDateArray[$po_id][255]['actual_start_date'];// AOP STRICK OFF APPROVAL
                $aopStOfApAcEndDate   = $tnaDateArray[$po_id][255]['actual_finish_date'];// AOP STRICK OFF APPROVAL

                $smsSmpleSbStDate      = $tnaDateArray[$po_id][265]['start_date'];// SMS/GSS SAMPLE SUBMISSION
                $smsSmpleSbEndDate     = $tnaDateArray[$po_id][265]['end_date'];// SMS/GSS SAMPLE SUBMISSION
                $smsSmpleSbAcStDate    = $tnaDateArray[$po_id][265]['actual_start_date'];// SMS/GSS SAMPLE SUBMISSION
                $smsSmpleSbAcEndDate   = $tnaDateArray[$po_id][265]['actual_finish_date'];// SMS/GSS SAMPLE SUBMISSION

                $smsSmpleApStDate      = $tnaDateArray[$po_id][266]['start_date'];// SMS/GSS SAMPLE APPROVAL
                $smsSmpleApEndDate     = $tnaDateArray[$po_id][266]['end_date'];// SMS/GSS SAMPLE APPROVAL
                $smsSmpleApAcStDate    = $tnaDateArray[$po_id][266]['actual_start_date'];// SMS/GSS SAMPLE APPROVAL
                $smsSmpleApAcEndDate   = $tnaDateArray[$po_id][266]['actual_finish_date'];// SMS/GSS SAMPLE APPROVAL

                $wareTrialSbStDate      = $tnaDateArray[$po_id][21]['start_date'];// WARE TRAIL SUBMISSION
                $wareTrialSbEndDate     = $tnaDateArray[$po_id][21]['end_date'];// WARE TRAIL SUBMISSION
                $wareTrialSbAcStDate    = $tnaDateArray[$po_id][21]['actual_start_date'];// WARE TRAIL SUBMISSION
                $wareTrialSbAcEndDate   = $tnaDateArray[$po_id][21]['actual_finish_date'];// WARE TRAIL SUBMISSION

                $wareTrialApStDate      = $tnaDateArray[$po_id][22]['start_date'];// WARE TRAIL APPROVAL
                $wareTrialApEndDate     = $tnaDateArray[$po_id][22]['end_date'];// WARE TRAIL APPROVAL
                $wareTrialApAcStDate    = $tnaDateArray[$po_id][22]['actual_start_date'];// WARE TRAIL APPROVAL
                $wareTrialApAcEndDate   = $tnaDateArray[$po_id][22]['actual_finish_date'];// WARE TRAIL APPROVAL

                $bulkFabBrSbStDate      = $tnaDateArray[$po_id][28]['start_date'];// BULK FABRIC SUBMISSION BUYER
                $bulkFabBrSbEndDate     = $tnaDateArray[$po_id][28]['end_date'];// BULK FABRIC SUBMISSION BUYER
                $bulkFabBrSbAcStDate    = $tnaDateArray[$po_id][28]['actual_start_date'];// BULK FABRIC SUBMISSION BUYER
                $bulkFabBrSbAcEndDate   = $tnaDateArray[$po_id][28]['actual_finish_date'];// BULK FABRIC SUBMISSION BUYER

                $bulkFabBrApStDate      = $tnaDateArray[$po_id][29]['start_date'];// BULK FABRIC APPROVAL BUYER
                $bulkFabBrApEndDate     = $tnaDateArray[$po_id][29]['end_date'];// BULK FABRIC APPROVAL BUYER
                $bulkFabBrApAcStDate    = $tnaDateArray[$po_id][29]['actual_start_date'];// BULK FABRIC APPROVAL BUYER
                $bulkFabBrApAcEndDate   = $tnaDateArray[$po_id][29]['actual_finish_date'];// BULK FABRIC APPROVAL BUYER

                $bulkFabLbSbStDate      = $tnaDateArray[$po_id][197]['start_date'];// BULK FABRIC SUBMISSION LAB
                $bulkFabLbSbEndDate     = $tnaDateArray[$po_id][197]['end_date'];// BULK FABRIC SUBMISSION LAB
                $bulkFabLbSbAcStDate    = $tnaDateArray[$po_id][197]['actual_start_date'];// BULK FABRIC SUBMISSION LAB
                $bulkFabLbSbAcEndDate   = $tnaDateArray[$po_id][197]['actual_finish_date'];// BULK FABRIC SUBMISSION LAB

                $bulkFabLbApStDate      = $tnaDateArray[$po_id][198]['start_date'];// BULK FABRIC APPROVAL LAB
                $bulkFabLbApEndDate     = $tnaDateArray[$po_id][198]['end_date'];// BULK FABRIC APPROVAL LAB
                $bulkFabLbApAcStDate    = $tnaDateArray[$po_id][198]['actual_start_date'];// BULK FABRIC APPROVAL LAB
                $bulkFabLbApAcEndDate   = $tnaDateArray[$po_id][198]['actual_finish_date'];// BULK FABRIC APPROVAL LAB

                $knitDwnSbStDate      = $tnaDateArray[$po_id][256]['start_date'];// Knit down SUBMISSION 
                $knitDwnSbEndDate     = $tnaDateArray[$po_id][256]['end_date'];// Knit down SUBMISSION 
                $knitDwnSbAcStDate    = $tnaDateArray[$po_id][256]['actual_start_date'];// Knit down SUBMISSION 
                $knitDwnSbAcEndDate   = $tnaDateArray[$po_id][256]['actual_finish_date'];// Knit down SUBMISSION 

                $knitDwnApStDate      = $tnaDateArray[$po_id][257]['start_date'];// Knit down APPROVAL 
                $knitDwnApEndDate     = $tnaDateArray[$po_id][257]['end_date'];// Knit down APPROVAL 
                $knitDwnApAcStDate    = $tnaDateArray[$po_id][257]['actual_start_date'];// Knit down APPROVAL 
                $knitDwnApAcEndDate   = $tnaDateArray[$po_id][257]['actual_finish_date'];// Knit down APPROVAL 

                $prntStOfSbStDate      = $tnaDateArray[$po_id][126]['start_date'];//print strick off SUBMISSION 
                $prntStOfSbEndDate     = $tnaDateArray[$po_id][126]['end_date'];//print strick off SUBMISSION 
                $prntStOfSbAcStDate    = $tnaDateArray[$po_id][126]['actual_start_date'];//print strick off SUBMISSION 
                $prntStOfSbAcEndDate   = $tnaDateArray[$po_id][126]['actual_finish_date'];//print strick off SUBMISSION 

                $prntStOfApStDate      = $tnaDateArray[$po_id][127]['start_date'];// Knit down APPROVAL 
                $prntStOfApEndDate     = $tnaDateArray[$po_id][127]['end_date'];// Knit down APPROVAL 
                $prntStOfApAcStDate    = $tnaDateArray[$po_id][127]['actual_start_date'];// Knit down APPROVAL 
                $prntStOfApAcEndDate   = $tnaDateArray[$po_id][127]['actual_finish_date'];// Knit down APPROVAL  

                $embStOfSbStDate      = $tnaDateArray[$po_id][128]['start_date'];//print strick off SUBMISSION 
                $embStOfSbEndDate     = $tnaDateArray[$po_id][128]['end_date'];//print strick off SUBMISSION 
                $embStOfSbAcStDate    = $tnaDateArray[$po_id][128]['actual_start_date'];//print strick off SUBMISSION 
                $embStOfSbAcEndDate   = $tnaDateArray[$po_id][128]['actual_finish_date'];//print strick off SUBMISSION 

                $embStOfApStDate      = $tnaDateArray[$po_id][129]['start_date'];// Knit down APPROVAL 
                $embStOfApEndDate     = $tnaDateArray[$po_id][129]['end_date'];// Knit down APPROVAL 
                $embStOfApAcStDate    = $tnaDateArray[$po_id][129]['actual_start_date'];// Knit down APPROVAL 
                $embStOfApAcEndDate   = $tnaDateArray[$po_id][129]['actual_finish_date'];// Knit down APPROVAL 

                $topSmBrSbStDate      = $tnaDateArray[$po_id][26]['start_date'];// Top Sample SUBMISSION buyer 
                $topSmBrSbEndDate     = $tnaDateArray[$po_id][26]['end_date'];// Top Sample SUBMISSION buyer 
                $topSmBrSbAcStDate    = $tnaDateArray[$po_id][26]['actual_start_date'];// Top Sample SUBMISSION buyer 
                $topSmBrSbAcEndDate   = $tnaDateArray[$po_id][26]['actual_finish_date'];// Top Sample SUBMISSION buyer 

                $topSmBrApStDate      = $tnaDateArray[$po_id][27]['start_date'];// Top Sample APPROVAL  buyer
                $topSmBrApEndDate     = $tnaDateArray[$po_id][27]['end_date'];// Top Sample APPROVAL  buyer
                $topSmBrApAcStDate    = $tnaDateArray[$po_id][27]['actual_start_date'];// Top Sample APPROVAL  buyer
                $topSmBrApAcEndDate   = $tnaDateArray[$po_id][27]['actual_finish_date'];// Top Sample APPROVAL  buyer

                $topSmLbSbStDate      = $tnaDateArray[$po_id][26]['start_date'];// Top Sample SUBMISSION Lab 
                $topSmLbSbEndDate     = $tnaDateArray[$po_id][26]['end_date'];// Top Sample SUBMISSION Lab 
                $topSmLbSbAcStDate    = $tnaDateArray[$po_id][26]['actual_start_date'];// Top Sample SUBMISSION Lab 
                $topSmLbSbAcEndDate   = $tnaDateArray[$po_id][26]['actual_finish_date'];// Top Sample SUBMISSION Lab 

                $topSmLbApStDate      = $tnaDateArray[$po_id][27]['start_date'];// Top Sample APPROVAL  Lab
                $topSmLbApEndDate     = $tnaDateArray[$po_id][27]['end_date'];// Top Sample APPROVAL  Lab
                $topSmLbApAcStDate    = $tnaDateArray[$po_id][27]['actual_start_date'];// Top Sample APPROVAL  Lab
                $topSmLbApAcEndDate   = $tnaDateArray[$po_id][27]['actual_finish_date'];// Top Sample APPROVAL  Lab

                $mockUpSbStDate      = $tnaDateArray[$po_id][23]['start_date'];// Mock up SUBMISSION 
                $mockUpSbEndDate     = $tnaDateArray[$po_id][23]['end_date'];// Mock up SUBMISSION 
                $mockUpSbAcStDate    = $tnaDateArray[$po_id][23]['actual_start_date'];// Mock up SUBMISSION 
                $mockUpSbAcEndDate   = $tnaDateArray[$po_id][23]['actual_finish_date'];// Mock up SUBMISSION 

                $mockUpApStDate      = $tnaDateArray[$po_id][23]['start_date'];// Mock up APPROVAL 
                $mockUpApEndDate     = $tnaDateArray[$po_id][23]['end_date'];// Mock up APPROVAL 
                $mockUpApAcStDate    = $tnaDateArray[$po_id][23]['actual_start_date'];// Mock up APPROVAL 
                $mockUpApAcEndDate   = $tnaDateArray[$po_id][23]['actual_finish_date'];// Mock up APPROVAL 

                $trimsCardSbStDate      = $tnaDateArray[$po_id][16]['start_date'];// Trims Card SUBMISSION 
                $trimsCardSbEndDate     = $tnaDateArray[$po_id][16]['end_date'];// Trims Card SUBMISSION 
                $trimsCardSbAcStDate    = $tnaDateArray[$po_id][16]['actual_start_date'];// Trims Card SUBMISSION 
                $trimsCardSbAcEndDate   = $tnaDateArray[$po_id][16]['actual_finish_date'];// Trims Card SUBMISSION 

                $trimsCardApStDate      = $tnaDateArray[$po_id][17]['start_date'];// Trims Card APPROVAL 
                $trimsCardApEndDate     = $tnaDateArray[$po_id][17]['end_date'];// Trims Card APPROVAL 
                $trimsCardApAcStDate    = $tnaDateArray[$po_id][17]['actual_start_date'];// Trims Card APPROVAL 
                $trimsCardApAcEndDate   = $tnaDateArray[$po_id][17]['actual_finish_date'];// Trims Card APPROVAL 

                $bdate          = new DateTime($bookingDate);
                $tdate          = new DateTime($bookEndDate);
                $days           = $tdate->diff($bdate)->format('%a');
                //============================ LABDIP SUBMIT ==========================
                $lbdpSbBackLog = 0;
                $start_date  = new DateTime($lbdpSbStDate);
                $end_date    = new DateTime($lbdpSbEndDate);
                // echo $lbdpSbEndDate."-------";die();
                // print_r($end_date);die();
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $lbdpSbBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $lbdpSbBackLog = $totPoColor - $labDipColorSub;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $lbdpSbBackLog = (($totPoColor/$tnaDaysDif)*$todayDaysDif) - $labDipColorSub;
                    // echo "((".$totPoColor."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$labDipColorSub."<br>";
                }
                $lbdpSbBal         = $totPoColor - $labDipColorSub;
                // echo $lbdpSbBal."<br>";
                $buyer_details_backlog_array[$season][$jobNo]['lbdpSbBackLog'] += max(0,$lbdpSbBackLog);
                //============================ LABDIP APPROVAL ==========================
                $lbdpApBackLog = 0;
                $start_date  = new DateTime($lbdpApStDate);
                $end_date    = new DateTime($lbdpApEndDate);
                // print_r($end_date);die();
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $lbdpApBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $lbdpApBackLog = $totPoColor - $labDipColorApp;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $lbdpApBackLog = (($totPoColor/$tnaDaysDif)*$todayDaysDif) - $labDipColorApp;
                }
                $lbdpApBal         = $totPoColor - $labDipColorApp;
                $buyer_details_backlog_array[$season][$jobNo]['lbdpApBackLog'] += max(0,$lbdpApBackLog);
                //============================ yarn allocation ==========================

                $yarnReqQty     = $yarnReqQtyArr[$po_id]; 
                $yarnAlloQty    = $yarnAlloArr[$po_id]['qnty'];
                $yarnAlloDt     = $yarnAlloArr[$po_id]['date'];
                $yarnIssueQty   = $yarnIssueQtyArr[$po_id]['issue'];
                $yarnIssueRtnQty= $yarnIssueQtyArr[$po_id]['rtn'];
                $yarnStock      = $yarnAlloQty - $yarnIssueQty;
                $yarnBackLog    =  $tnaPlanTargetArray[$po_id][48]['prev_plan_qty'] - $yarnAlloArr[$po_id]['prev_qnty'];

                /* $yarnBackLog    = 0;
                $start_date  = new DateTime($yarntnaStDate);
                $end_date    = new DateTime($yarntnaEndDate);
                // print_r($end_date);die();
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $yarnBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $yarnBackLog = ($yarnReqQty+$yarn_excess_qty) - $yarnAlloQty;
                     // echo $po_id."**".$yarnBackLog ."= (".$yarnReqQty."+".$yarn_excess_qty.") - ".$yarnAlloQty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $yarnBackLog = ((($yarnReqQty+$yarn_excess_qty)/$tnaDaysDif)*$todayDaysDif) - $yarnAlloQty;
                    // echo $po_id."**".$yarnBackLog ."= ((".$yarnReqQty."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$yarnAlloQty;
                } */
                // echo $po_id."**".$yarnReqQty."**".$yarnAlloQty."**".$yarnBackLog."<br>";
                $yarnBal         = ($yarnReqQty+$yarn_excess_qty) - $yarnAlloQty;
                $buyer_details_backlog_array[$season][$jobNo]['yarnBackLog'] += max(0,$yarnBackLog);
                //========================= yarn dayed ==========================
                $yarnDyedReqQty  = array_sum($conversion_costing_arr[$po_id][30]);
                $ydRcv      = $yarnDyedArr[$po_id]['qty'];
                $ydLstRcv   = $yarnDyedArr[$po_id]['lstqty'];
                $ydIssueQty = $yarnDyeIssueQtyArr[$po_id]['issue'];
                $ydIssueRtnQty = $yarnDyeIssueQtyArr[$po_id]['rtn'];
                $ydSndBal = $yarnDyedReqQty - $ydIssueQty;
                $ydBackLog  = $tnaPlanTargetArray[$po_id][52]['prev_plan_qty'] - $yarn_dyed_prev_qty;
                // echo $tnaPlanTargetArray[$po_id][52]['prev_plan_qty'] ."-". $yarn_dyed_prev_qty."<br>";
                /* $ydBackLog  = 0;
                $start_date = new DateTime($ydtnaStDate);
                $end_date   = new DateTime($ydtnaEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $ydBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $ydBackLog = $yarnDyedReqQty - $yarn_dyed_qty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $ydBackLog = (($yarnDyedReqQty/$tnaDaysDif)*$todayDaysDif) - $yarn_dyed_qty;
                } */
                $ydBal         = $yarnDyedReqQty - $yarn_dyed_qty;
                $buyer_details_backlog_array[$season][$jobNo]['ydBackLog'] += max(0,$ydBackLog);
                //============================= grey req. =========================
                $fabGreyReg = array_sum($fabric_costing_arr['knit']['grey'][$po_id]);
                $grey_trans_in = $grey_fab_transfer_data[$po_id]['in'];
                $grey_trans_out = $grey_fab_transfer_data[$po_id]['out'];
                $greyRcv    = $greyProdArr[$po_id]['qty'];
                $greyRcvPrev    = $greyProdArr[$po_id]['prev_qnty'];
                $greyLstRcv = $greyProdArr[$po_id]['lstqty'];
                $progQty    = $progQtyArray[$po_id];
                $progBalQty = ($fabGreyReg+$grey_fab_excess_qty) - $progQty;
                $yrnSndtoFact= $yarnIssueQty - $yarnIssueRtnQty;
                $yrnSndBal  = $progQty - $yarnIssueQty;
                
                $greyBackLog = $tnaPlanTargetArray[$po_id][60]['prev_plan_qty'] - ($greyRcvPrev + $grey_trans_in);

                /* $greyBackLog = 0;
                $start_date  = new DateTime($greyStDate);
                $end_date    = new DateTime($greyEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $greyBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $greyBackLog = ($fabGreyReg+$grey_fab_excess_qty+$grey_trans_out) - ($greyRcv + $grey_trans_in);
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $greyBackLog = ((($fabGreyReg+$grey_fab_excess_qty+$grey_trans_out)/$tnaDaysDif)*$todayDaysDif) - ($greyRcv + $grey_trans_in);
                } */
                $greyBal         = ($fabGreyReg+$grey_fab_excess_qty+$grey_trans_out) - ($greyRcv + $grey_trans_in);
                $buyer_details_backlog_array[$season][$jobNo]['greyBackLog'] += max(0,$greyBackLog);
                //============================= FABRIC DYEING. =========================
                // $fabDyeingReq   = array_sum($conversion_costing_arr[$po_id][31]);
                $fabDyeingReq   = $fabGreyReg+$grey_fab_excess_qty;
                $dyeingRcv      = $dyeingProdArr[$po_id]['in']+$dyeingProdArr[$po_id]['out'];
                $dyeingRcvPrev      = $dyeingProdArr[$po_id]['prev_in']+$dyeingProdArr[$po_id]['prev_out'];
                $lstDyeingRcv   = $dyeingProdArr[$po_id]['lstqty'];
                $batchQty       = $batchQtyArr[$po_id]['qty']+$dyeingProdArr[$po_id]['out'];
                $batchBal       = $fabGreyReg - $batchQty;
                $redyToBatch    = $greyRcv - $batchQty;
                $dyeingBackLog  = $tnaPlanTargetArray[$po_id][61]['prev_plan_qty'] - $dyeingRcvPrev;

                /* $dyeingBackLog  = 0;
                $start_date  = new DateTime($dyeingStDate);
                $end_date    = new DateTime($dyeingEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $dyeingBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $dyeingBackLog = $fabDyeingReq - $dyeingRcv;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $dyeingBackLog = (($fabDyeingReq/$tnaDaysDif)*$todayDaysDif) - $dyeingRcv;
                } */
                $dyeingBal         = $fabDyeingReq - $dyeingRcv;
                $buyer_details_backlog_array[$season][$jobNo]['dyeingBackLog'] += max(0,$dyeingBackLog);
                //============================= BOOKING =========================
                $fabfinishPurReg  = array_sum($fabric_purchase_costing_arr['knit']['finish'][$po_id]);
                $fabfinishReg  = array_sum($fabric_costing_arr['knit']['finish'][$po_id]);
                $tot_finfab_req_qty = $fabfinishReg + $fabfinishPurReg;

                $fabfinishPurRegKg  = $fabric_purchase_costing_arr['knit']['finish'][$po_id][12];
                $fabfinishRegKg = $fabric_costing_arr['knit']['finish'][$po_id][12];
                $tot_finfab_req_qty_kg = $fabfinishRegKg + $fabfinishPurRegKg;

                $fabfinishPurRegYds  = $fabric_purchase_costing_arr['knit']['finish'][$po_id][23]+$fabric_purchase_costing_arr['knit']['finish'][$po_id][27];
                $fabfinishRegKgYds  = $fabric_costing_arr['knit']['finish'][$po_id][23]+$fabric_costing_arr['knit']['finish'][$po_id][27];
                $tot_finfab_req_qty_yds = $fabfinishPurRegYds + $fabfinishRegKgYds;

                $bookingBackLog    = 0;
                $bookingBackLogKg    = 0;
                $bookingBackLogYds    = 0;
                $bookingBal        = 0;
                $start_date  = new DateTime($bookStDate);
                $end_date    = new DateTime($bookEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $bookingBackLog = 0;
                    $bookingBackLogKg = 0;
                    $bookingBackLogYds = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $bookingBackLog = $tot_finfab_req_qty - $bookingQty;
                    $bookingBackLogKg = $tot_finfab_req_qty_kg - $bookingQtyKg;
                    $bookingBackLogYds = $tot_finfab_req_qty_yds - $bookingQtyYds;
                    // echo $bookingBackLog ."=". $fabfinishReg ."-". $bookingQty."<br>"; 
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $bookingBackLog = (($tot_finfab_req_qty/$tnaDaysDif)*$todayDaysDif) - $bookingQty;
                    $bookingBackLogKg = (($tot_finfab_req_qty_kg/$tnaDaysDif)*$todayDaysDif) - $bookingQtyKg;
                    $bookingBackLogYds = (($tot_finfab_req_qty_yds/$tnaDaysDif)*$todayDaysDif) - $bookingQtyYds;
                }
                $bookingBal         = $tot_finfab_req_qty - $bookingQty;
                $buyer_details_backlog_array[$season][$jobNo]['bookingBackLog'] += max(0,$bookingBackLog);
                $buyer_details_backlog_array[$season][$jobNo]['bookingBackLogKg'] += max(0,$bookingBackLogKg);
                $buyer_details_backlog_array[$season][$jobNo]['bookingBackLogYds'] += max(0,$bookingBackLogYds);

                //============================= ALL OVER PRINT =========================                
                // $aop_Req     = array_sum($fabric_po_color_type_wise_arr['knit']['finish'][$po_id][5]);
                $aop_Req     = array_sum($fabric_costing_aop_arr['knit']['finish'][$po_id][5][1]);
                $aopReq     = $aop_Req+$color_type_wise_booking_qty_array[$po_id][5];
                $aopRcv     = $aopProdArr[$po_id]['qty'];
                $aopRcvPrev = $aopProdArr[$po_id]['prev_qty'];
                $aopLstRcv  = $aopProdArr[$po_id]['lstqty'];
                $aopIssueQty= $aopProdArr[$po_id]['issueqty'];
                $aopFbSndBal= $aopReq - $aopIssueQty;
                $aopBackLog  = $tnaPlanTargetArray[$po_id][63]['prev_plan_qty'] - $aopRcvPrev;
                /* $aopBackLog    = 0;
                $start_date  = new DateTime($aopStDate);
                $end_date    = new DateTime($aopEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $aopBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $aopBackLog = $aopReq - $aopRcv;
                    // echo $aopReq ."-". $aopRcv."<br>";
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $aopBackLog = (($aopReq/$tnaDaysDif)*$todayDaysDif) - $aopRcv;
                } */
                $aopBal         = $aopReq - $aopRcv;
                $buyer_details_backlog_array[$season][$jobNo]['aopBackLog'] += max(0,$aopBackLog);
                //============================= finish fab. prod =========================
                //$fabfinishPurReg  = array_sum($fabric_purchase_costing_arr['knit']['finish'][$po_id]);
                $finishRcv  = $finFabProdArr[$po_id]['qty'];
                $finishLstRcv  = $finFabProdArr[$po_id]['lstqty'];
                $finFabTrnsIn  = $finFabTrnsArr[$po_id][5]['qty'];
                $finFabTrnsOut  = $finFabTrnsArr[$po_id][6]['qty'];
                
                $finFab_purchase_qty = $finFabPurchaseArr[$po_id]['qty'];
                $finFab_purchase_qty_kg = $finFabPurchaseUOMArr[$po_id][12]['qty'];
                $finFab_purchase_qty_othr = $finFabPurchaseUOMArr[$po_id][23]['qty']+$finFabPurchaseUOMArr[$po_id][27]['qty'];
                $gmtStrRcv2      = $finFabStkArray2[$po_id]['gmt_rcv'];
                $gmtStrRcvRtn2   = $finFabStkArray2[$po_id]['gmt_rcv_rtn'];
                $gmtStrTrnsIn2   = $finFabStkArray2[$po_id]['gmt_rcv_trns'];
                

                $gmtStrRcv2Prev      = $finFabStkArray2[$po_id]['prev_gmt_rcv'];
                $finFab_purchase_qty_prev = $finFabPurchaseArr[$po_id]['prev_qty'];
                $gmtStrTrnsIn2Prev   = $finFabStkArray2[$po_id]['prev_gmt_rcv_trns'];

                $fin_rcv_qnty2   = $gmtStrTrnsIn2+$gmtStrRcv2+$finFab_purchase_qty;
                // echo $val['intRef']."==".$finFabProdWithUomArray[$po_id][12]['qty']."+".$finFabProdWithUomArray[$po_id][1]['qty']."<br>";

                $fin_rcv_qnty2Kg      = $finFabProdWithUomArray[$po_id][12]['qty'];//+$finFabProdWithUomArray[$po_id][1]['qty'];//+$finFab_purchase_qty_kg;

                $fin_rcv_qnty2Yds      = $finFabProdWithUomArray[$po_id][23]['qty']+$finFabProdWithUomArray[$po_id][27]['qty'];//+$finFab_purchase_qty_othr;

                $fin_rcv_qnty2KgPrev      = $finFabProdWithUomArray[$po_id][12]['prev_qty'];

                $fin_rcv_qnty2YdsPrev      = $finFabProdWithUomArray[$po_id][23]['prev_qty']+$finFabProdWithUomArray[$po_id][27]['prev_qty'];

                
                // $finishBackLog  = $tnaPlanTargetArray[$po_id][73]['prev_plan_qty'] - ($gmtStrRcv2Prev+$finFab_purchase_qty_prev+$gmtStrTrnsIn2Prev);

                $finishBackLogKg  = $ffTnaPlanTargetArray[$po_id][73][12]['prev_plan_qty'] - $fin_rcv_qnty2KgPrev;
                $finishBackLogYds  = ($ffTnaPlanTargetArray[$po_id][73][23]['prev_plan_qty']+$ffTnaPlanTargetArray[$po_id][73][27]['prev_plan_qty']) - $fin_rcv_qnty2YdsPrev;

                
                $finishBackLog  = $ffTnaPlanTargetArray[$po_id][73][1]['prev_plan_qty'] - ($gmtStrRcv2Prev+$gmtStrTrnsIn2Prev);
                $finishBackLogPur  = $ffTnaPlanTargetArray[$po_id][73][2]['prev_plan_qty'] - $finFab_purchase_qty_prev;
                // echo $ffTnaPlanTargetArray[$po_id][73][2]['prev_plan_qty'] ."-". $finFab_purchase_qty_prev."<br>";


                
                /* $finishBackLog      = 0;
                $finishBackLogKg    = 0;
                $finishBackLogYds   = 0;
                $start_date  = new DateTime($fabFinStDate);
                $end_date    = new DateTime($fabFinEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $finishBackLog      = 0;
                    $finishBackLogKg    = 0;
                    $finishBackLogYds   = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $finishBackLog = ($tot_finfab_req_qty+$fin_fab_excess_qty) - $fin_rcv_qnty2;
                    $finishBackLogKg = ($tot_finfab_req_qty_kg+$fin_fab_excess_qty_kg) - $fin_rcv_qnty2Kg;
                    $finishBackLogYds = ($tot_finfab_req_qty_yds+$fin_fab_excess_qty_yds) - $fin_rcv_qnty2Yds;
                    // echo $val['intRef']."==".$finishBackLogKg ."= (".$tot_finfab_req_qty_kg."+".$fin_fab_excess_qty_kg.") - ".$fin_rcv_qnty2Kg."<br>";
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    //echo $start_date->format('Y-m-d'); echo $end_date->format('Y-m-d')."<br>".$po_id;
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $finishBackLog = ((($tot_finfab_req_qty+$fin_fab_excess_qty)/$tnaDaysDif)*$todayDaysDif) - $fin_rcv_qnty2;
                    $finishBackLogKg = ((($tot_finfab_req_qty_kg+$fin_fab_excess_qty_kg)/$tnaDaysDif)*$todayDaysDif) - $fin_rcv_qnty2Kg;
                    $finishBackLogYds = ((($tot_finfab_req_qty_yds+$fin_fab_excess_qty_yds)/$tnaDaysDif)*$todayDaysDif) - $fin_rcv_qnty2Yds;
                    
                    // echo $finishBackLogKg ."= ((".$tot_finfab_req_qty_kg."+".$fin_fab_excess_qty_kg."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$fin_rcv_qnty2Kg."<br>";
                }  */              
                
                $finishFabBal    = ($tot_finfab_req_qty+$fin_fab_excess_qty) - $fin_rcv_qnty2;
                //$finishFabBal         = $fabfinishReg - $finishRcv;
                $buyer_details_backlog_array[$season][$jobNo]['finishBackLog'] += max(0,$finishBackLog);
                $buyer_details_backlog_array[$season][$jobNo]['finishBackLogPur'] += max(0,$finishBackLogPur);
                $buyer_details_backlog_array[$season][$jobNo]['finishBackLogKg'] += max(0,$finishBackLogKg);
                $buyer_details_backlog_array[$season][$jobNo]['finishBackLogYds'] += max(0,$finishBackLogYds);
                //============================= ISSUE TO CUT =========================
                $issueToCut= $issueProdArr[$po_id]['qty'];
                $layQty    = $cutAndLayArr[$po_id]['qty'];
                $qcQty     = $CutQCArr[$po_id]['qty'];
                $qcRejQty  = $CutQCArr[$po_id]['rejqty'];
                $qcRplsQty = $CutQCArr[$po_id]['rplsqty'];
                $lstQcQty  = $CutQCArr[$po_id]['lst_rpls_qty'];
                $cutBal    = $val['qty'] -  $qcQty;
                $qcBackLog  = $tnaPlanTargetArray[$po_id][84]['prev_plan_qty'] - $prodArr[$po_id]['prev_cut_qty'];
                // echo $tnaPlanTargetArray[$po_id][84]['prev_plan_qty']." - ".$prodArr[$po_id]['prev_cut_qty']."<br>";

                $dyeStrIss      = $finFabStkArray[$po_id]['dye_issue'];
                $dyeStrIssRtn   = $finFabStkArray[$po_id]['dye_issue_rtn'];
                $dyeStrTrnsOut  = $finFabStkArray[$po_id]['dye_issue_trns'];
                $dyeStrRcv      = $finFabStkArray[$po_id]['dye_rcv'];
                $dyeStrRcvRtn   = $finFabStkArray[$po_id]['dye_rcv_rtn'];
                $dyeStrTrnsIn   = $finFabStkArray[$po_id]['dye_rcv_trns'];

                $dye_total_receive=$dyeStrTrnsIn+$dyeStrRcv+$dyeStrIssRtn;
                $dye_total_issue=$dyeStrTrnsOut+$dyeStrIss+$dyeStrRcvRtn;
                $dyeStock = $dye_total_receive - $dye_total_issue;

                $gmtStrIss      = $finFabStkArray[$po_id]['gmt_issue'];
                $gmtStrIssRtn   = $finFabStkArray[$po_id]['gmt_issue_rtn'];
                $gmtStrTrnsOut  = $finFabStkArray[$po_id]['gmt_issue_trns'];
                $gmtStrRcv      = $finFabStkArray[$po_id]['gmt_rcv'];
                $gmtStrRcvRtn   = $finFabStkArray[$po_id]['gmt_rcv_rtn'];
                $gmtStrTrnsIn   = $finFabStkArray[$po_id]['gmt_rcv_trns'];

                $gmt_total_receive=$gmtStrTrnsIn+$gmtStrRcv+$gmtStrIssRtn;
                $gmt_total_issue=$gmtStrTrnsOut+$gmtStrIss+$gmtStrRcvRtn;
                $gmtStock = $gmt_total_receive - $gmt_total_issue;
                
                
                

                /* $qcBackLog = 0;
                $start_date  = new DateTime($cuttStDate);
                $end_date    = new DateTime($cuttEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $qcBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $qcBackLog = $val['qty'] - $qcQty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $qcBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $qcQty;
                    //echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$qcQty."<br>";
                } */
                $buyer_details_backlog_array[$season][$jobNo]['qcBackLog'] += max(0,$qcBackLog);
                //============================= PRINTING DATA =========================
                $printReq       = $emblishment_costing_arr[$po_id][1]*$costingPer;
                $printQty       = $prodArr[$po_id]['print_qty'];
                $printIssQty    = $prodArr[$po_id]['print_iss_qty'];
                $printRejQty    = $prodArr[$po_id]['print_rej_qty'];
                $lstPrntQty     = $prodArr[$po_id]['lst_prnt_qty'];
                $prntSndBal     = $printReq - $printIssQty;
                if($emblishment_costing_arr[$po_id][1]>0)
                {
                    $printBal       = $printReq - $printQty;
                }
                else
                {
                    $printBal = 0;
                }
                $printBackLog  = $tnaPlanTargetArray[$po_id][267]['prev_plan_qty'] - $prodArr[$po_id]['prev_print_qty'];
                /* $printBackLog   = 0;
                $start_date     = new DateTime($printStDate);
                $end_date       = new DateTime($printEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $printBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $printBackLog = $printReq - $printQty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $printBackLog = (($printReq/$tnaDaysDif)*$todayDaysDif) - $printQty;
                } */
                $buyer_details_backlog_array[$season][$jobNo]['printBackLog'] += max(0,$printBackLog);
                //============================= EMBROIDERY  =========================
                $embReq  = $emblishment_costing_arr[$po_id][2]*$costingPer;
                $embQty  = $prodArr[$po_id]['emb_qty'];
                $embIssueQty = $prodArr[$po_id]['emb_issue_qty'];
                $embSndBal = $embReq - $embIssueQty;
                $embRejQty  = $prodArr[$po_id]['emb_rej_qty'];
                $lstEmbQty  = $prodArr[$po_id]['lst_emb_qty'];
                if($emblishment_costing_arr[$po_id][1]>0)
                {
                    $embBal  = $embReq - $embQty;
                }
                else
                {
                    $embBal = 0;
                }
                $embBackLog  = $tnaPlanTargetArray[$po_id][268]['prev_plan_qty'] - $prodArr[$po_id]['prev_emb_qty'];
                
                /* $embBackLog = 0;
                $start_date  = new DateTime($embStDate);
                $end_date    = new DateTime($embEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $embBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $embBackLog = $embReq - $embQty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $embBackLog = (($embReq/$tnaDaysDif)*$todayDaysDif) - $embQty;
                } */
                $buyer_details_backlog_array[$season][$jobNo]['embBackLog'] += max(0,$embBackLog);
                //============================= WASH  =========================
                $washReq     = $emblishment_costing_arr_name[$po_id][3]*$costingPer;
                $washQty     = $prodArr[$po_id]['wash_qty'];
                $lstWashQty  = $prodArr[$po_id]['lst_wash_qty'];
                $washIssueQty= $prodArr[$po_id]['wash_issue_qty'];
                $washRejQty  = $prodArr[$po_id]['wash_rej_qty'];
                $sendBal     = $washReq - $washIssueQty;

                $washBal     = $washReq > 0 ? $washReq - $washQty : 0;
                $washBackLog  = $tnaPlanTargetArray[$po_id][90]['prev_plan_qty'] - $prodArr[$po_id]['prev_wash_qty'];
                /* $washBackLog = 0;
                $start_date  = new DateTime($washStDate);
                $end_date    = new DateTime($washEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $washBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $washBackLog = $washReq - $washQty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $washBackLog = (($washReq/$tnaDaysDif)*$todayDaysDif) - $washQty;
                } */
                $buyer_details_backlog_array[$season][$jobNo]['washBackLog'] += max(0,$washBackLog);
                //============================= SEW TRIMS =========================
                $sewTrimsReq    = $trims_costing_arr[$po_id][1];
                $sewTrimsQty    = $accArr[$po_id][1]['qty'];
                $sewTrimsPrsnt  = ($sewTrimsQty/$sewTrimsReq)*100;
                $sewTrmBacklog  = 0;
                $start_date     = new DateTime($sewTrimsStDate);
                $end_date       = new DateTime($sewTrimsEndDate);
                $sewTrmCurBk = 0;
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $sewTrmBacklog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $sewTrmBacklog = 100 - $sewTrimsPrsnt;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $perDayAllo = $sewTrimsReq/$tnaDaysDif;
                    $reqAllo = $perDayAllo*$todayDaysDif;
                    $sewTrmCurBk = $reqAllo - $sewTrimsQty;

                    $sewTrmBacklog = ((100/$tnaDaysDif)*$todayDaysDif) - $sewTrimsPrsnt;
                }
                $buyer_details_backlog_array[$season][$jobNo]['sewTrmBacklog'] += max(0,$sewTrmBacklog);
                if($sewTrmCurBk>0)
                {
                    $buyer_details_backlog_array[$season][$jobNo]['sewTrmCurBk'] += $sewTrmCurBk;
                    $buyer_details_backlog_array[$season][$jobNo]['sewTrimsReq'] += $sewTrimsReq;
                }
                //================================= FIN TRIMS =======================
                $finTrimsReq    = $trims_costing_arr[$po_id][2];
                $finTrimsQty    = $accArr[$po_id][2]['qty'];
                $finTrimsPrsnt  = ($finTrimsQty/$finTrimsReq)*100;
                $finTrmBacklog = 0;
                $start_date  = new DateTime($finTrimsStDate);
                $end_date    = new DateTime($finTrimsEndDate);
                $finTrmCurBk = 0;
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $finTrmBacklog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $finTrmBacklog = 100 - $finTrimsPrsnt;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $perDayAllo = $finTrimsReq/$tnaDaysDif;
                    $reqAllo = $perDayAllo*$todayDaysDif;
                    $finTrmCurBk = $reqAllo - $finTrimsQty;

                    $finTrmBacklog = ((100/$tnaDaysDif)*$todayDaysDif) - $finTrimsPrsnt;
                }
                $buyer_details_backlog_array[$season][$jobNo]['finTrmBacklog'] += max(0,$finTrmBacklog);
                // echo $finTrmCurBk."<br>";
                if($finTrmCurBk>0)
                {
                    $buyer_details_backlog_array[$season][$jobNo]['finTrmCurBk'] += $finTrmCurBk;
                    $buyer_details_backlog_array[$season][$jobNo]['finTrimsReq'] += $finTrimsReq;
                }
                // ============================= Accessories=========================================
                $tot_item = $trimsItemCountBudgetWise[$po_id];
                $tot_booking_item = $trimsBookingArr[$po_id];
                $accBookingPrsnt = ($tot_booking_item/$tot_item)*100;
                $accBacklog = 0;
                $start_date  = new DateTime($accBkStDate);
                $end_date    = new DateTime($accBkEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $accBacklog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $accBacklog = 100 - $accBookingPrsnt;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $accBacklog = ((100/$tnaDaysDif)*$todayDaysDif) - $accBookingPrsnt;
                }
                // echo $jobNo."==".$accBacklog."<br>";
                $buyer_details_backlog_array[$season][$jobNo]['accBacklog'] += max(0,$accBacklog);
                $buyer_details_backlog_array[$season][$jobNo]['accBookingPrsnt'] += $accBookingPrsnt;
                $jobWiseAccPoArray = array();
                if($accBacklog>0)
                {
                    $jobWiseAccPoArray[$jobNo][$po_id]=$po_id;
                }
                //=============================== PRODUCTION AND EX-FACTORY ===========================

                $inputQty       = $prodArr[$po_id]['input_qty'];
                $input_bal      = $qcQty - $inputQty;
                $plan_input_bal = $qcQty - $prodArr[$po_id]['input_qty']-$printRejQty - $embRejQty;
                $outputQty      = $prodArr[$po_id]['out_qty'];
                $lstOutputQty   = $prodArr[$po_id]['lst_out_qty'];
                $rejectQty      = $prodArr[$po_id]['reject_qty'];
                $alterQty       = $prodArr[$po_id]['alter_qty'];
                $spotQty        = $prodArr[$po_id]['spot_qty'];
                $replaceQty     = $prodArr[$po_id]['replace_qty'];
                $rejectQty      = $rejectQty+$alterQty+$spotQty-$replaceQty;
                $okOutQty       = $outputQty;
                $totSewQty      = $okOutQty - $replaceQty + $rejectQty;
                $sewingWIP      = $inputQty - $totSewQty;
                $sewingBAL      = $val['qty'] - $okOutQty;
                $finishQty      = $prodArr[$po_id]['finish_qty'];
                $lstFinishQty   = $prodArr[$po_id]['lst_finish_qty'];
                $finRejQty      = $prodArr[$po_id]['fin_rej_qty'];
                $finishBal      = $val['qty'] - $finishQty;
                $finishWIP      = $outputQty - $finishQty - $finRejQty;
                $exfactoryQty   = $exfArr[$po_id]['qty'];
                $exfactoryLstQty= $exfArr[$po_id]['lqty'];
                $exfactoryWIP   = $finishQty - $exfactoryQty;
                $exBal          = $val['qty'] - $exfArr[$po_id]['qty'];
                $exDateArray    = array_filter(explode(",", $exfArr[$po_id]['exdate']));
                // print_r($exDateArray);
                // echo max($exDateArray);
                // echo "<br>";
                // echo min($exDateArray);

                $sewFinBackLog  = $tnaPlanTargetArray[$po_id][86]['prev_plan_qty'] - $prodArr[$po_id]['prev_out_qty'];
                /* $sewFinBackLog = 0;
                $start_date  = new DateTime($inputStDate);
                $end_date    = new DateTime($inputEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $sewFinBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $sewFinBackLog = $val['qty'] - $okOutQty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $sewFinBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $okOutQty;
                    //echo "((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$okOutQty."<br>";
                } */
                $buyer_details_backlog_array[$season][$jobNo]['sewFinBackLog'] += max(0,$sewFinBackLog);
               
                //============================= GMTS FINISH  =========================
                
                $gmtFinBal     = $val['qty'] - $finishQty;
                $gmtFinBackLog  = $tnaPlanTargetArray[$po_id][88]['prev_plan_qty'] - $prodArr[$po_id]['prev_finish_qty'];
                /* $gmtFinBackLog = 0;
                $start_date  = new DateTime($finishStDate);
                $end_date    = new DateTime($finishEndDate);
                if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                {
                    $gmtFinBackLog = 0;
                }
                elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                {
                    $gmtFinBackLog = $val['qty'] - $finishQty;
                }
                elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                {
                    $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                    $todayDaysDif= $start_date->diff($toDay)->format('%a');

                    $gmtFinBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $finishQty;
                    //echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$finishQty."<br>";
                } */
                $buyer_details_backlog_array[$season][$jobNo]['gmtFinBackLog'] += max(0,$gmtFinBackLog);

                //============================= SHIPING BACKLOG ===================
                $shiping_backlog = 0;
                $fob_backlog = 0;
                // $orig_ship_date = new DateTime($val['orig_ship_date']);
                // $shiping_backlog = (strtotime($toDay->format('Y-m-d')) <= strtotime($val['orig_ship_date'])) ? 0 : $val['qty'] - $exfArr[$po_id]['qty'];

                /*$accPoIdsArr = array_unique(array_filter(explode(",", $accPoIDArray[$po_id])));
                // echo "<pre>";print_r($accPoIdsArr);die();
                $acc_backlog = 0;
                foreach ($accPoIdsArr as $acc_po_key => $acc_po_val) 
                {
                    if(strtotime($toDay->format('Y-m-d')) > strtotime($accPoArray[$po_id][$acc_po_val]['acc_ship_date']))
                    {
                        echo $jobNo."==".$toDay->format('Y-m-d')."==".$accPoArray[$po_id][$acc_po_val]['acc_ship_date']."=".$accPoArray[$po_id][$acc_po_val]['acc_po_qty']."<br>";
                        $acc_backlog += $accPoArray[$po_id][$acc_po_val]['acc_po_qty'];
                        // echo $jobNo."==".$accPoArray[$po_id][$acc_po_val]['acc_po_qty']."<br>";
                    }

                }*/
                $acc_backlog = 0;
                foreach ($accPoArray[$po_id] as $aac_po => $acc_po_value) 
                {
                    foreach ($acc_po_value as $aac_date => $acc_date_value) 
                    {
                        if(strtotime($toDay->format('Y-m-d')) > strtotime($aac_date))
                        {
                            $acc_backlog += $acc_date_value['acc_po_qty'];
                            // echo $jobNo."==".$acc_date_value['acc_po_qty']."<br>";
                        }
                    }
                }
                $shiping_backlog = $acc_backlog - $exfArr[$po_id]['qty'];
                $fob_backlog     = $shiping_backlog*$val['unit_price'];
                $buyer_details_backlog_array[$season][$jobNo]['shiping_backlog'] += max(0,$shiping_backlog);            
                $buyer_details_backlog_array[$season][$jobNo]['fob_backlog'] += max(0,$fob_backlog);    
                if($shiping_backlog>0)        
                {
                    $jobWisePoArray[$jobNo][$po_id] = $po_id;
                }
                // echo $jobNo."==".$acc_backlog."-".$exfArr[$po_id]['qty']."<br>";
            }
        }
    }
    // echo "<pre>";print_r($buyer_details_backlog_array);die();

    // ======================== count rowspan =====================
    $rowspan = array();
    foreach ($buyer_details_backlog_array as $season => $seasonData) 
    {
        foreach ($seasonData as $job_no => $row) 
        {
            $buyer_id = $row['buyer_id'];
            $job_tot_po = count($jobWisePoArray[$job_no]);
            $accBacklog = ($job_tot_po>0) ? $row['accBacklog']/$job_tot_po : $row['accBacklog']; 

            $sewTrmBacklog = 0;
            $finTrmBacklog = 0;
            $sewTrmBacklog = ($row['sewTrmCurBk']/$row['sewTrimsReq'])*100;
            $finTrmBacklog = ($row['finTrmCurBk']/$row['finTrimsReq'])*100;
            if(is_nan($finTrmBacklog)) $finTrmBacklog=0;

            if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
            if($row['lbdpSbBackLog']>0 || $row['lbdpApBackLog']>0 || $row['bookingBackLog']>0 || $row['yarnBackLog']>0 || $row['ydBackLog']>0 || $row['greyBackLog']>0 || $row['dyeingBackLog']>0 || $row['aopBackLog']>0 || $row['finishBackLog']>0 || $row['finishBackLogPur']>0 || $row['qcBackLog']>0 || $row['printBackLog']>0 || $row['embBackLog']>0 || $sewTrmBacklog>0 || $finTrmBacklog>0 || $row['sewFinBackLog']>0 || $row['washBackLog']>0 || $row['gmtFinBackLog']>0 || $row['shiping_backlog']>0 || $row['fob_backlog']>0 || $accBacklog>0)
            {
                $rowspan[$season]++;
            }
        }
    }
    ob_start(); 
    ?>
    <fieldset class="first_part" style="width:99.5%;margin:15px 0;">
        <h3 style="width:100%;" align="left" id="accordion_h1" class="accordion_h" onClick="accordion_menu( this.id,'display_report_by_buyer', '')"> -<b>Backlog - Style Wise</b></h3>

        <div id="display_report_by_buyer" style="display: block;">
            <style type="text/css">
                .rpt_table tfoot th {font-size: 10px;}
            </style>
            
            <div class="" style="width: 100%;text-align: left;">
                <h2 style="font-size: 20px;text-align: center;">Buyer - <? echo $buyer_arr[$buyer_id];?></h2>
                <table cellspacing="0" style="width: 98.5%; border-collapse: collapse;" class="rpt_table" cellpadding="0" border="1" align="left">
                    <thead>
                        <tr>
                            <th width="5%"><p>Season</p></th>
                            <th width="6%"><p>Ref No</p></th>
                            <th width="6%"><p>Style No</p></th>
                            <th width="3.375%"><p>LD Sub</p></th>
                            <th width="3.375%"><p>LD Aprv</p></th>
                            <th width="3.375%"><p>Acc Booking</p></th>
                            <!-- <th width="3.375%"><p>Fab Booking</p></th> -->
                            <th width="3.375%"><p>Fab Booking Kg</p></th>
                            <th width="3.375%"><p>Fab Booking Y/M</p></th>
                            <th width="3.375%"><p>Yarn</p></th>
                            <th width="3.375%"><p>YD</p></th>
                            <th width="3.375%"><p>Gray</p></th>
                            <th width="3.375%"><p>Dyeing</p></th>
                            <th width="3.375%"><p>AOP</p></th>
                            <!-- <th width="3.375%"><p>F. Fabric</p></th> -->
                            <th width="3.375%"><p>F. Fabric Prod.</p></th>
                            <th width="3.375%"><p>F. Fabric Purc</p></th>
                            <th width="3.375%"><p>Cutting</p></th>
                            <th width="3.375%"><p>Printing</p></th>
                            <th width="3.375%"><p>Embroidery</p></th>
                            <th width="3.375%"><p>S. Acc Rcv</p></th>
                            <th width="3.375%"><p>F. Acc Rcv</p></th>
                            <th width="3.375%"><p>Sewing</p></th>
                            <th width="3.375%"><p>Washing</p></th>
                            <th width="3.375%"><p>Finishing</p></th>
                            <th width="3.375%"><p>Shipment</p></th>                                
                            <th width="3.375%"><p>FOB Backlog</p></th>                                
                        </tr>
                    </thead>
                </table>
                <div style="width: 100%;overflow-y: scroll;max-height: 350px;">
                    <table cellspacing="0" style="width: 99.7%; border-collapse: collapse;" class="rpt_table" cellpadding="0" border="1" align="left">
                        <tbody>
                        <?
                        $i=1000;
                        $lbdpSbBackLog      = 0;
                        $lbdpApBackLog      = 0;
                        $bookingBackLog     = 0;
                        $bookingBackLogKg   = 0;
                        $bookingBackLogYds  = 0;
                        $yarnBackLog        = 0;
                        $ydBackLog          = 0;
                        $greyBackLog        = 0;
                        $dyeingBackLog      = 0;
                        $aopBackLog         = 0;
                        $finishBackLog      = 0;
                        $finishBackLogKg    = 0;
                        $finishBackLogYds   = 0;
                        $qcBackLog          = 0;
                        $printBackLog       = 0;
                        $embBackLog         = 0;
                        $sewTrmBacklog      = 0;
                        $finTrmBacklog      = 0;
                        $sewingBackLog      = 0;
                        $washBackLog        = 0;
                        $finishingBackLog   = 0;
                        $shiping_backlog    = 0;
                        $fob_backlog        = 0;
                        // echo "<pre>";print_r($jobWiseAccPoArray);die();
                        ksort($buyer_details_backlog_array);
                        foreach ($buyer_details_backlog_array as $season => $seasonData) 
                        {
                            $s= 0;
                            foreach ($seasonData as $job_no => $row) 
                            {
                                $buyer_id = $row['buyer_id'];
                                $job_tot_po = count($jobWisePoArray[$job_no]);
                                $accBacklog = ($job_tot_po>0) ? $row['accBacklog']/$job_tot_po : $row['accBacklog']; 

                                $sewTrmBacklog = 0;
                                $finTrmBacklog = 0;
                                $sewTrmBacklog = ($row['sewTrmCurBk']/$row['sewTrimsReq'])*100;
                                $finTrmBacklog = ($row['finTrmCurBk']/$row['finTrimsReq'])*100;
                                if(is_nan($finTrmBacklog)) $finTrmBacklog=0;

                                if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                if($row['lbdpSbBackLog']>0 || $row['lbdpApBackLog']>0 || $row['bookingBackLog']>0 || $row['yarnBackLog']>0 || $row['ydBackLog']>0 || $row['greyBackLog']>0 || $row['dyeingBackLog']>0 || $row['aopBackLog']>0 || $row['finishBackLog']>0 || $row['finishBackLogPur']>0 || $row['qcBackLog']>0 || $row['printBackLog']>0 || $row['embBackLog']>0 || $sewTrmBacklog>0 || $finTrmBacklog>0 || $row['sewFinBackLog']>0 || $row['washBackLog']>0 || $row['gmtFinBackLog']>0 || $row['shiping_backlog']>0 || $row['fob_backlog']>0 || $accBacklog>0)
                                {
                                    ?>
                                    <tr bgcolor="<? echo $bgcolor; ?>" onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_<? echo $i; ?>">
                                        <? if($s==0){?>
                                        <td valign="middle" rowspan="<?=$rowspan[$season];?>" width="5%" align="center"><p><?= $season; ?></p></td>
                                        <? $s++;} ?>
                                        <td width="6%" title="<?=$row['intRef'];?>"><p><?= substr($row['intRef'],0,12);?></p></td>
                                        <td width="6%" title="<?=$row['style'];?>"><p><?= substr($row['style'],0,12);?></p></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['lbdpSbBackLog'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['lbdpApBackLog'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($accBacklog,2); ?>%</td>
                                        <!-- <td width="3.375%" align="right"><?=  fn_number_format($row['bookingBackLog'],0); ?></td> -->
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['bookingBackLogKg'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['bookingBackLogYds'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['yarnBackLog'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['ydBackLog'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['greyBackLog'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['dyeingBackLog'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['aopBackLog'],0); ?></td>
                                        <!-- <td width="3.375%" align="right"><?=  fn_number_format($row['finishBackLog'],0); ?></td> -->
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['finishBackLog'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['finishBackLogPur'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['qcBackLog'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['printBackLog'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['embBackLog'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($sewTrmBacklog,2); ?>%</td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($finTrmBacklog,2); ?>%</td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['sewFinBackLog'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['washBackLog'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['gmtFinBackLog'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['shiping_backlog'],0); ?></td>
                                        <td width="3.375%" align="right"><?=  fn_number_format($row['fob_backlog'],0); ?></td>
                                    </tr>
                                    <?
                                    $i++;
                                    $lbdpSbBackLog      += $row['lbdpSbBackLog'];
                                    $lbdpApBackLog      += $row['lbdpApBackLog'];
                                    $bookingBackLog     += $row['bookingBackLog'];
                                    $bookingBackLogKg   += $row['bookingBackLogKg'];
                                    $bookingBackLogYds  += $row['bookingBackLogYds'];
                                    $yarnBackLog        += $row['yarnBackLog'];
                                    $ydBackLog          += $row['ydBackLog'];
                                    $greyBackLog        += $row['greyBackLog'];
                                    $dyeingBackLog      += $row['dyeingBackLog'];
                                    $aopBackLog         += $row['aopBackLog'];
                                    $finishBackLog      += $row['finishBackLog'];
                                    $finishBackLogKg    += $row['finishBackLog'];
                                    $finishBackLogYds   += $row['finishBackLogPur'];
                                    $qcBackLog          += $row['qcBackLog'];
                                    $printBackLog       += $row['printBackLog'];
                                    $embBackLog         += $row['embBackLog'];
                                    $sewTrmBacklog      += $row['sewTrmBacklog'];
                                    $finTrmBacklog      += $row['finTrmBacklog'];

                                    $sewingBackLog      += $row['sewFinBackLog'];
                                    $washBackLog        += $row['washBackLog'];
                                    $finishingBackLog   += $row['gmtFinBackLog'];
                                    $shiping_backlog    += $row['shiping_backlog'];
                                    $fob_backlog        += $row['fob_backlog'];
                                }
                            }
                        }
                        ?>
                        </tbody>
                    </table>
                </div>
                <table cellspacing="0" style="width: 98.4%; border-collapse: collapse;font-size: 9px;" class="rpt_table" cellpadding="0" border="1" align="left">
                    <tfoot>
                        <tr>
                            <th width="5%"></th>
                            <th width="6%"></th>
                            <th width="6%">Total</th>
                            <th width="3.375%"><? echo fn_number_format($lbdpSbBackLog,0);?></th>
                            <th width="3.375%"><? echo fn_number_format($lbdpApBackLog,0);?></th>
                            <th width="3.375%"><? //echo fn_number_format($a,0);?></th>
                            <!-- <th width="3.375%"><? echo fn_number_format($bookingBackLog,0);?></th> -->
                            <th width="3.375%"><? echo fn_number_format($bookingBackLogKg,0);?></th>
                            <th width="3.375%"><? echo fn_number_format($bookingBackLogYds,0);?></th>
                            <th width="3.375%"><? echo fn_number_format($yarnBackLog,0);?></th>
                            <th width="3.375%"><? echo fn_number_format($ydBackLog,0);?></th>
                            <th width="3.375%"><? echo fn_number_format($greyBackLog,0);?></th>
                            <th width="3.375%"><? echo fn_number_format($dyeingBackLog,0);?></th>
                            <th width="3.375%"><? echo fn_number_format($aopBackLog,0);?></th>
                            <!-- <th width="3.375%"><? echo fn_number_format($finishBackLog,0);?></th> -->
                            <th width="3.375%"><? echo fn_number_format($finishBackLogKg,0);?></th>
                            <th width="3.375%"><? echo fn_number_format($finishBackLogYds,0);?></th>
                            <th width="3.375%"><? echo fn_number_format($qcBackLog,0);?></th>
                            <th width="3.375%"><? echo fn_number_format($printBackLog,0);?></th>
                            <th width="3.375%"><? echo fn_number_format($embBackLog,0);?></th>
                            <th width="3.375%"><? //echo fn_number_format($sewTrmBacklog,0);?></th>
                            <th width="3.375%"><? //echo fn_number_format($finTrmBacklog,0);?></th>
                            <th width="3.375%"><? echo fn_number_format($sewingBackLog,0);?></th>
                            <th width="3.375%"><? echo fn_number_format($washBackLog,0);?></th>
                            <th width="3.375%"><? echo fn_number_format($finishingBackLog,0);?></th>
                            <th width="3.375%"><? echo fn_number_format($shiping_backlog,0);?></th>                                
                            <th width="3.375%"><? echo fn_number_format($fob_backlog,0);?></th>                                
                        </tr>
                    </tfoot>
                </table>
               
            </div>
             
        </div>
         
    </fieldset>
    <?
    unset($dataArray);
    $html = ob_get_contents();
    ob_clean();
    foreach (glob("$user_id*.xls") as $filename) {
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');    
    $is_created = fwrite($create_new_doc, $html);
    echo "$html####$filename"; 
    exit();
}

if($action=="show_acc_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_store = return_library_array("select id,store_name from lib_store_location where status_active=1 and is_deleted=0", "id", "store_name");
    extract($_REQUEST);
    list($po_ids,$item_id,$job,$intref) = explode("**", $search_string);

    $job_cond = ($job!="") ? " and d.job_no='$job'" : "";
    $intref_cond = ($intref!="") ? " and e.grouping='$intref'" : "";

    /*======================================================================================/
    /                                    trims receive qty                                  /
    /======================================================================================*/
    $sqlacc = "SELECT a.store_id,c.quantity AS QNTY,c.reject_qty as REJ_QTY FROM inv_receive_master a,inv_trims_entry_dtls b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=24 AND c.entry_form = 24 AND c.entry_form = 24 and a.item_category=4 and d.id=e.job_id and c.po_breakdown_id=e.id and e.id in($po_ids) and B.item_group_id=$item_id $job_cond $intref_cond";
    // echo $sqlacc;die();
    $accRes = sql_select($sqlacc);
    $trimsDataArray = array();
    foreach ($accRes as $val) 
    {
        $trimsDataArray[$lib_store[$val['STORE_ID']]]['rcv_qty'] += $val['QNTY'];
        $trimsDataArray[$lib_store[$val['STORE_ID']]]['rej_qty'] += $val['REJ_QTY'];
    }

    // echo "<pre>";print_r($trimsDataArray);
    /*======================================================================================/
    /                               trims issue and rcv return                              /
    /======================================================================================*/
    $sqlacc = "SELECT a.store_id,a.entry_form,C.QUANTITY AS QNTY FROM inv_issue_master a,inv_trims_issue_dtls b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type in(2,3) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(25,49) AND c.entry_form in(25,49) AND c.entry_form in(25,49) and a.item_category=4 and d.id=e.job_id and c.po_breakdown_id=e.id and e.id in($po_ids) and B.item_group_id=$item_id  $job_cond $intref_cond";
    // echo $sqlacc;die();
    $accRes = sql_select($sqlacc);
    foreach ($accRes as $val) 
    {
        if($val['ENTRY_FORM']==49)
        {
            $trimsDataArray[$lib_store[$val['STORE_ID']]]['rcv_rtn_qty'] += $val['QNTY'];
        }
        if($val['ENTRY_FORM']==25)
        {
            $trimsDataArray[$lib_store[$val['STORE_ID']]]['issue_qty'] += $val['QNTY'];
        }
    }

    /*======================================================================================/
    /                                    trims issue return                                   /
    /======================================================================================*/
    $sqlacc = "SELECT a.store_id, c.quantity AS QNTY FROM inv_receive_master a,inv_transaction b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e,product_details_master f where a.id=b.mst_id and b.id=c.trans_id and c.trans_type=4 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=73 AND c.entry_form = 73 AND c.entry_form = 73 and a.item_category=4 and c.prod_id=f.id and d.id=e.job_id and c.po_breakdown_id=e.id and e.id in($po_ids) and f.item_group_id=$item_id  $job_cond $intref_cond";
    // echo $sqlacc;die();
    $accRes = sql_select($sqlacc);
    foreach ($accRes as $val) 
    {
        $trimsDataArray[$lib_store[$val['STORE_ID']]]['issue_rtn_qty'] += $val['QNTY'];
    }
    /*======================================================================================/
    /                                    trims transfer                                     /
    /======================================================================================*/
    // $item_group_cond = where_con_using_array($item_group_id_arr,0,"b.item_group");
    // $sql = "SELECT b.item_category,b.item_group,b.transfer_qnty from inv_item_transfer_mst a,inv_item_transfer_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.entry_form in(78,112) $item_group_cond";

    // $to_order_id_con =where_con_using_array($poIdArray,0,"a.to_order_id");
    // $from_order_id_con =where_con_using_array($poIdArray,0,"a.from_order_id");

    $job_cond = ($job!="") ? " and d.job_no_mst='$job'" : "";
    $intref_cond = ($intref!="") ? " and d.grouping='$intref'" : "";

    $transfer_sql_in=sql_select("SELECT a.to_store_id as store_id,b.transfer_qnty as qnty FROM inv_item_transfer_mst a, inv_item_transfer_dtls b,wo_po_break_down d WHERE a.id = b.mst_id and d.id=a.to_order_id and d.status_active=1  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=4 and a.entry_form in(78,112) and a.to_order_id in($po_ids)  and b.item_group=$item_id $job_cond $intref_cond");
    // $transfer_data=array();
    foreach ($transfer_sql_in as $row) 
    {
        $trimsDataArray[$lib_store[$row['STORE_ID']]]['in']+=$row[csf('qnty')];
    }
    $transfer_sql_out=sql_select("SELECT a.from_store_id as store_id,b.transfer_qnty as qnty FROM inv_item_transfer_mst a, inv_item_transfer_dtls b,wo_po_break_down d WHERE a.id = b.mst_id  and d.id=a.from_order_id and d.status_active=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=4 and a.entry_form in(78,112)  and a.from_order_id in($po_ids)  and b.item_group=$item_id $job_cond $intref_cond");
    foreach ($transfer_sql_out as $row) 
    {
        $trimsDataArray[$lib_store[$row['STORE_ID']]]['out']+=$row[csf('qnty')];
    }  
    // echo "<pre>";print_r($trimsDataArray);
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 300;" id="details_reports">
        <div class="main_part" style="width:300px;">
            <div>
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="280">
                    <caption><b>Store Wise Stock</b></caption>
                    <thead>
                        <tr>
                            <th width="180">Store Name</th>
                            <th width="100">Stock Qty</th>
                        </tr>
                    </thead>
                </table>
            </div>
            <div style="width:300px;overflow-y:auto;max-height:300px;" id="scroll_body">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="280">
                    <tbody>
                        <?
                        $i=0;
                        ksort($trimsDataArray);
                        $tot = 0;
                        foreach ($trimsDataArray as $store_name => $row) 
                        {                                
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF";
                            $stock_qty = ($row['rcv_qty']+$row['issue_rtn_qty']+$row['in']) - ($row['issue_qty']+$row['rcv_rtn_qty']+$row['out']);
                            // echo "(rcv=".$row['rcv_qty']."+rtn=".$row['issue_rtn_qty']."+trns in=".$row['in'].") - (issue=".$row['issue_qty']."+rcv rtn=".$row['rcv_rtn_qty']."+out=".$row['out'].")<br>";
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                
                                <td  width="180"><?=$store_name;?></td>                              
                                <td align="right" width="100"><?=fn_number_format($stock_qty,0);?></td>
                            </tr>
                            <?
                            $i++;
                            $tot += $stock_qty;
                            
                        }
                        ?>
                        <tr style="background: #cddcdc;font-weight: bold;text-align: right;">
                            <th>Total</th>
                            <th><?=fn_number_format($tot,0);?></th>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>  
    <?
}

if($action =="report_generate_by_buyer")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $company_id     = str_replace("'","",$cbo_company_name);
    $location_id    = str_replace("'","",$cbo_location_name);
    $buyer_id   = str_replace("'","",$buyer_id);
    $client_id   = str_replace("'","",$client_id);

    $location_cond='';
    if($location_id !=0) $location_cond=" and a.location_name=$location_id";
    if($client_id !=0) $client_cond=" and a.client_id=$client_id";

    $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
    $company_arr=return_library_array( "select id,company_name from lib_company",'id','company_name');

    // ============================ ex-factory data =========================
    $sql = "SELECT d.ACTUAL_PO_DTLS_ID as dtls_id,d.EX_FACT_QTY  from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join PRO_EX_FACTORY_MST c on b.id=c.po_break_down_id and c.status_active=1 JOIN PRO_EX_FACTORY_ACTUAL_PO_DETAILS d ON c.id = d.mst_id and d.status_active=1 where b.shiping_status in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and a.company_name=$company_id and a.buyer_name=$buyer_id $location_cond $client_cond ";
    // echo $sql;
    $res = sql_select($sql);
    $exf_data_array = array();
    foreach ($res as $v) 
    {
        $exf_data_array[$v['DTLS_ID']] += $v['EX_FACT_QTY'];
    }
    // echo "<pre>"; print_r($exf_data_array);


    $buyer_wise_summery_sql = sql_select("SELECT a.buyer_name as BUYER_NAME, d.po_qty as ACC_PO_QTY, c.acc_ship_date as  ACC_SHIP_DATE, TO_CHAR(c.acc_ship_date,'MON') as MONTH, TO_CHAR(c.acc_ship_date,'YY') as YEAR , d.gmts_item as GMTS_ITEM,d.id as dtls_id  from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join wo_po_acc_po_info c on b.id=c.po_break_down_id JOIN wo_po_acc_po_info_dtls d ON c.id = d.mst_id where b.shiping_status in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and c.acc_ship_date IS NOT NULL and a.company_name=$company_id and d.gmts_item <>0 and c.acc_po_status=1 and a.buyer_name=$buyer_id $location_cond $client_cond order by c.acc_ship_date ASC"); 
    foreach ($buyer_wise_summery_sql as $row) 
    {
        if(max($row['ACC_PO_QTY'] - $exf_data_array[$row['DTLS_ID']],0)>0)
        {
            $yearmonth=trim($row['YEAR'].'.'.ucfirst(strtolower($row['MONTH'])));
            $item_wise_summery_arr[$row['GMTS_ITEM']][$yearmonth] += max($row['ACC_PO_QTY'] - $exf_data_array[$row['DTLS_ID']],0);
            $yearmonth_arr[$yearmonth]=$yearmonth;
        }
    }
    $tbl_width = 1200;
    ob_start(); 
    ?>
    <fieldset class="first_part" style="width:100%;margin:15px 0;">
        <style type="text/css">        
            .GridViewScrollHeader TH, .GridViewScrollHeader TD 
            {
                padding: 2px 4px;
                font-weight: normal;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                text-align: left;
                vertical-align: middle;
            }

            .GridViewScrollHeader TH{
                background-image: -webkit-linear-gradient( rgb(194,220,255) 10%, rgb(136,170,214) 96%);
                border: 1px solid #8DAFDA;
                color:#444;
                font-size: 13px;
                font-weight: bold;
                text-align: center;
                line-height: 12px;
                height: 25px;
            }

            .GridViewScrollItem TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
               /* background-color: #FFFFFF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollItemFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #E9F3FF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollFooterFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-top: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                vertical-align: middle;
                font-weight: 700;
                background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB));
            }
            tr.GridViewScrollItemFreeze:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            tr.footerTr:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            html {
              --scrollbarBG: #CFD8DC;
              --thumbBG: #8ec5fc;
            }
            body::-webkit-scrollbar {
              width: 11px;
            }
            body {
              scrollbar-width: thin;
              scrollbar-color: var(--thumbBG) var(--scrollbarBG);
            }
            body::-webkit-scrollbar-track {
              background: var(--scrollbarBG);
            }
            body::-webkit-scrollbar-thumb {
              background-color: var(--thumbBG) ;
              border-radius: 6px;
              border: 3px solid var(--scrollbarBG);
            }
        </style>  
        <div id="report_generate_by_buyer">
            <h3>Buyer : <?= $buyer_arr[$buyer_id] ?></h3>
            <table id="gvMain" border="1" rules="all" class="rpt_table" width="100%" cellpadding="0" cellspacing="0">            
                <thead>
                    <tr class="GridViewScrollHeader">
                        <th>Item</th>
                        <? foreach ($yearmonth_arr as $year_month) { ?>
                            <th><?= $year_month ?></th>
                        <? } ?>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <? 
                    $i=1;
                    foreach ($item_wise_summery_arr as $item_id => $value) 
                    { 
                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                        ?>
                        <tr class="GridViewScrollItem" bgcolor="<? echo $bgcolor; ?>">
                        <td align="center"><?= $garments_item[$item_id] ?></td>
                        <?
                        $item_wise_total=0;
                        foreach ($yearmonth_arr as $year_month) { ?>
                            <td align="right"><?= fn_number_format($value[$year_month]); $item_wise_total+=$value[$year_month]; $item_wise_total_arr[$year_month]+=$value[$year_month]; ?></td>
                        <? } ?>
                        <td align="right"><?= fn_number_format($item_wise_total);  ?></td>
                        </tr>
                        <? $i++;
                    } ?>
                </tbody>
                 <tr class="GridViewScrollItem footerTr">
                    <td>Total<div class="gridViewScrollHelper"></div></td>
                    <?
                    foreach ($yearmonth_arr as $year_month) { ?>
                        <td align="right"><?= fn_number_format($item_wise_total_arr[$year_month]); $item_wise_total_sum+=$item_wise_total_arr[$year_month]; ?></td>
                    <? } ?>
                    <td align="right"><?= fn_number_format($item_wise_total_sum); ?></td>
                </tr>
            </table>     
        </div>    
    </fieldset>

    <script type="text/javascript" src="../../../../js/gridviewscroll.js"></script>
        <script type="text/javascript">
            var gridViewScroll = null;
            fnGridView = function () {
                gridViewScroll = new GridViewScroll({
                    elementID: "gvMain",
                    width: screen.width-200,
                    // width: 1335,
                    height: 380,
                    freezeColumn: true,
                    freezeFooter: true,
                    freezeColumnCssClass: "GridViewScrollItemFreeze",
                    freezeFooterCssClass: "GridViewScrollFooterFreeze",
                    freezeHeaderRowCount: 1,
                    freezeColumnCount: 1,
                    onscroll: function (scrollTop, scrollLeft) {
                        console.log(scrollTop + " - " + scrollLeft);
                    }
                });
                gridViewScroll.enhance();
            }
            function getScrollPosition() {
                var position = gridViewScroll.scrollPosition;
                alert("scrollTop: " + position.scrollTop + ", scrollLeft: " + position.scrollLeft);
            }
            function setScrollPosition() {
                var scrollPosition = { scrollTop: 50, scrollLeft: 50};

                gridViewScroll.scrollPosition = scrollPosition;
            }
            fnGridView();
            //=================================================
            
        </script>
    <?
    unset($main_array);
    /*$html = ob_get_contents();
    ob_clean();
    foreach (glob("$user_id*.xls") as $filename) {
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');    
    $is_created = fwrite($create_new_doc, $html);
    echo "$html####$filename"; 
    exit();*/
}
if($action =="report_generate_by_item")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $company_id     = str_replace("'","",$cbo_company_name);
    $location_id    = str_replace("'","",$cbo_location_name);
    $item_id   = str_replace("'","",$item_id);
    $client_id   = str_replace("'","",$client_id);

    $location_cond='';
    if($location_id !=0) $location_cond=" and a.location_name=$location_id";
    if($client_id !=0) $client_cond=" and a.client_id=$client_id";

    $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
    $company_arr=return_library_array( "select id,company_name from lib_company",'id','company_name');

    // ============================ ex-factory data =========================
    $sql = "SELECT d.ACTUAL_PO_DTLS_ID as dtls_id,d.EX_FACT_QTY  from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join PRO_EX_FACTORY_MST c on b.id=c.po_break_down_id and c.status_active=1 JOIN PRO_EX_FACTORY_ACTUAL_PO_DETAILS d ON c.id = d.mst_id and d.status_active=1 where b.shiping_status in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and a.company_name=$company_id and c.item_number_id=$item_id $location_cond $client_cond";
    // echo $sql;
    $res = sql_select($sql);
    $exf_data_array = array();
    foreach ($res as $v) 
    {
        $exf_data_array[$v['DTLS_ID']] += $v['EX_FACT_QTY'];
    }
    // echo "<pre>"; print_r($exf_data_array);


    $buyer_wise_summery_sql = sql_select("SELECT a.buyer_name as BUYER_NAME, d.po_qty as ACC_PO_QTY, c.acc_ship_date as  ACC_SHIP_DATE, TO_CHAR(c.acc_ship_date,'MON') as MONTH, TO_CHAR(c.acc_ship_date,'YY') as YEAR , d.gmts_item as GMTS_ITEM,d.id as dtls_id  from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join wo_po_acc_po_info c on b.id=c.po_break_down_id JOIN wo_po_acc_po_info_dtls d ON c.id = d.mst_id where b.shiping_status in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and c.acc_ship_date IS NOT NULL and a.company_name=$company_id and c.acc_po_status=1 and d.gmts_item=$item_id $client_cond $location_cond order by c.acc_ship_date ASC"); 
    foreach ($buyer_wise_summery_sql as $row) {
        $yearmonth=trim($row['YEAR'].'.'.ucfirst(strtolower($row['MONTH'])));
        $buyer_wise_summery_arr[$row['BUYER_NAME']][$yearmonth] += max($row['ACC_PO_QTY'] - $exf_data_array[$row['DTLS_ID']],0);
        $yearmonth_arr[$yearmonth]=$yearmonth;
    }
    $tbl_width = 1200;
    ob_start(); 
    ?>
    <fieldset class="first_part" style="width:96%;margin:15px 0;">
        <style type="text/css">        
            .GridViewScrollHeader TH, .GridViewScrollHeader TD 
            {
                padding: 2px 4px;
                font-weight: normal;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                text-align: left;
                vertical-align: middle;
            }

            .GridViewScrollHeader TH{
                background-image: -webkit-linear-gradient( rgb(194,220,255) 10%, rgb(136,170,214) 96%);
                border: 1px solid #8DAFDA;
                color:#444;
                font-size: 13px;
                font-weight: bold;
                text-align: center;
                line-height: 12px;
                height: 25px;
            }

            .GridViewScrollItem TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
               /* background-color: #FFFFFF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollItemFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #E9F3FF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollFooterFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-top: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                vertical-align: middle;
                font-weight: 700;
                background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB));
            }
            tr.GridViewScrollItemFreeze:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            tr.footerTr:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            html {
              --scrollbarBG: #CFD8DC;
              --thumbBG: #8ec5fc;
            }
            body::-webkit-scrollbar {
              width: 11px;
            }
            body {
              scrollbar-width: thin;
              scrollbar-color: var(--thumbBG) var(--scrollbarBG);
            }
            body::-webkit-scrollbar-track {
              background: var(--scrollbarBG);
            }
            body::-webkit-scrollbar-thumb {
              background-color: var(--thumbBG) ;
              border-radius: 6px;
              border: 3px solid var(--scrollbarBG);
            }
        </style> 
        <!-- <h3 style="width:<? echo $tbl_width;?>px;" align="left" id="accordion_h1" class="accordion_h" onClick="accordion_menu( this.id,'report_generate_by_item', '')"> -<b>Actual Shipment Plan - Buyer wise Details</b></h3> -->
        <div id="report_generate_by_item">
            <h3>Item Name: <?= $garments_item[$item_id] ?></h3>
            <table id="gvMain" border="1" rules="all" class="rpt_table" width="100%" cellpadding="0" cellspacing="0">            
                <thead>
                    <tr class="GridViewScrollHeader">
                        <th>Buyer</th>
                        <? foreach ($yearmonth_arr as $year_month) { ?>
                            <th><?= date('d-M',strtotime($year_month));?></th>
                        <? } ?>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <? 
                    $i=1;
                    foreach ($buyer_wise_summery_arr as $buyer_id => $value) { 
                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                        ?>
                        <tr class="GridViewScrollItem" bgcolor="<? echo $bgcolor; ?>">
                            <td align="center"><?= $buyer_arr[$buyer_id] ?></td>
                            <?
                            $buyer_wise_total=0;
                            foreach ($yearmonth_arr as $year_month) { ?>
                                <td align="right"><?= fn_number_format($value[$year_month]); $buyer_wise_total+=$value[$year_month]; $buyer_wise_total_arr[$year_month]+=$value[$year_month]; ?></td>
                            <? } ?>
                            <td align="right"><?= fn_number_format($buyer_wise_total);  ?></td>
                        </tr>
                        <? $i++;
                    } ?>
                </tbody>
                <tr class="GridViewScrollItem footerTr">
                    <td>Total<div class="gridViewScrollHelper"></div></td>
                    <?
                    foreach ($yearmonth_arr as $year_month) { ?>
                        <td align="right"><?= fn_number_format($buyer_wise_total_arr[$year_month]); $buyer_wise_total_sum+=$buyer_wise_total_arr[$year_month]; ?></td>
                    <? } ?>
                    <td align="right"><?= fn_number_format($buyer_wise_total_sum); ?></td>
                </tr>
            </table>     
        </div>    
    </fieldset>

    <script type="text/javascript" src="../../../../js/gridviewscroll.js"></script>
        <script type="text/javascript">
            var gridViewScroll = null;
            fnGridView = function () {
                gridViewScroll = new GridViewScroll({
                    elementID: "gvMain",
                    width: screen.width-200,
                    // width: 1335,
                    height: 300,
                    freezeColumn: true,
                    freezeFooter: true,
                    freezeColumnCssClass: "GridViewScrollItemFreeze",
                    freezeFooterCssClass: "GridViewScrollFooterFreeze",
                    freezeHeaderRowCount: 1,
                    freezeColumnCount: 1,
                    onscroll: function (scrollTop, scrollLeft) {
                        console.log(scrollTop + " - " + scrollLeft);
                    }
                });
                gridViewScroll.enhance();
            }
            function getScrollPosition() {
                var position = gridViewScroll.scrollPosition;
                alert("scrollTop: " + position.scrollTop + ", scrollLeft: " + position.scrollLeft);
            }
            function setScrollPosition() {
                var scrollPosition = { scrollTop: 50, scrollLeft: 50};

                gridViewScroll.scrollPosition = scrollPosition;
            }
            fnGridView();
            //=================================================
            
        </script>
    <?
    unset($main_array);
    /*$html = ob_get_contents();
    ob_clean();
    foreach (glob("$user_id*.xls") as $filename) {
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');    
    $is_created = fwrite($create_new_doc, $html);
    echo "$html####$filename"; */
    exit();
}
if($action =="report_by_buyer_style")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $company_id     = str_replace("'","",$cbo_company_name);
    $location_id    = str_replace("'","",$cbo_location_name);
    $buyer_id   = str_replace("'","",$buyer_id);
    $client_id   = str_replace("'","",$client_id);
    $location_cond='';
    if($location_id !=0) $location_cond=" and a.location_name=$location_id";
    if($client_id !=0) $client_cond=" and a.client_id=$client_id";

    $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
    $company_arr=return_library_array( "select id,company_name from lib_company",'id','company_name');
    $season_lib=return_library_array( "select id,season_name from lib_buyer_season",'id','season_name');

    // ============================ ex-factory data =========================
    $sql = "SELECT d.ACTUAL_PO_DTLS_ID as dtls_id,d.EX_FACT_QTY  from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join PRO_EX_FACTORY_MST c on b.id=c.po_break_down_id and c.status_active=1 JOIN PRO_EX_FACTORY_ACTUAL_PO_DETAILS d ON c.id = d.mst_id and d.status_active=1 where b.shiping_status in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and a.company_name=$company_id and a.buyer_name=$buyer_id $location_cond  $client_cond";
    // echo $sql;
    $res = sql_select($sql);
    $exf_data_array = array();
    foreach ($res as $v) 
    {
        $exf_data_array[$v['DTLS_ID']] += $v['EX_FACT_QTY'];
    }
    // echo "<pre>"; print_r($exf_data_array);


    $buyer_wise_summery_sql = sql_select("SELECT a.JOB_NO, a.buyer_name as BUYER_NAME,a.SET_SMV,a.season_buyer_wise as SEASON, a.style_ref_no as STYLE_REF_NO, b.grouping as GROUPING,  d.po_qty as ACC_PO_QTY, c.acc_ship_date as  ACC_SHIP_DATE, TO_CHAR(c.acc_ship_date,'MON') as MONTH, TO_CHAR(c.acc_ship_date,'YY') as YEAR , d.gmts_item as GMTS_ITEM ,d.id as dtls_id from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join wo_po_acc_po_info c on b.id=c.po_break_down_id JOIN wo_po_acc_po_info_dtls d ON c.id = d.mst_id where b.shiping_status in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and c.acc_ship_date IS NOT NULL and a.company_name=$company_id and d.gmts_item <> 0 and c.acc_po_status=1 and a.buyer_name= $buyer_id $client_cond $location_cond order by c.acc_ship_date ASC");
    $job_array = array();
    foreach ($buyer_wise_summery_sql as $row) 
    {
        if(max($row['ACC_PO_QTY'] - $exf_data_array[$row['DTLS_ID']],0)>0)
        {
            $yearmonth=trim($row['YEAR'].'.'.ucfirst(strtolower($row['MONTH'])));
            $buyer_wise_style_arr[$row['SEASON']][$row['GMTS_ITEM']][$row['GROUPING']]['ref_no'] = $row['GROUPING'];
            $buyer_wise_style_arr[$row['SEASON']][$row['GMTS_ITEM']][$row['GROUPING']]['smv'] = $row['SET_SMV'];
            $buyer_wise_style_arr[$row['SEASON']][$row['GMTS_ITEM']][$row['GROUPING']]['style'] = $row['STYLE_REF_NO'];
            $buyer_wise_style_arr[$row['SEASON']][$row['GMTS_ITEM']][$row['GROUPING']]['year_month'][$yearmonth] += max($row['ACC_PO_QTY'] - $exf_data_array[$row['DTLS_ID']],0);
            $yearmonth_arr[$yearmonth]=$yearmonth;
            $job_array[$row['JOB_NO']]=$row['JOB_NO'];
        }
    }
    $joNos = "'".implode("','", $job_array)."'";
    // $itm_smv_arr = return_library_array( "select gmts_item_id, smv_pcs from wo_po_details_mas_set_details where job_no in($joNos)",'gmts_item_id','smv_pcs');
    $sql = "SELECT a.gmts_item_id, a.smv_pcs,b.grouping from wo_po_details_mas_set_details a,wo_po_break_down b where a.job_id=b.job_id and a.job_no in($joNos)";
    $res = sql_select($sql);
    $itm_smv_arr = array();
    foreach ($res as $val) 
    {
        $itm_smv_arr[$val['GROUPING']][$val['GMTS_ITEM_ID']] = $val['SMV_PCS'];
    }

    // print_r($itm_smv_arr);

    $rowspan_arr = array();
    $rowspan_item_arr = array();
    foreach ($buyer_wise_style_arr as $s_key => $s_value) 
    {
        foreach ($s_value as $i_key => $i_value) 
        {
            foreach ($i_value as $ir_key => $ir_value) 
            {
                $rowspan_arr[$s_key]++;
                $rowspan_item_arr[$s_key][$i_key]++;
            }
        }
    }

    $season_wise_itm_count = array();
    foreach ($rowspan_item_arr as $season_key => $season_value) 
    {
        foreach ($season_value as $item_key => $item_value) 
        {
            $season_wise_itm_count[$season_key]++;
        }
    }

    // echo "<pre>";print_r($season_wise_itm_count);

    $tbl_width = 480+count($yearmonth_arr)*60;
    ob_start(); 
    ?>
    <fieldset class="first_part" style="width:<? echo $tbl_width+30;?>px;margin:15px 0;">
        <!-- <h3 style="width:<? echo $tbl_width;?>px;" align="left" id="accordion_h1" class="accordion_h" onClick="accordion_menu( this.id,'report_by_buyer_style', '')"> -<b>Actual Shipment Plan - Style wise</b></h3> -->
        <div id="report_by_buyer_style">
            <h3>Buyer: <?= $buyer_arr[$buyer_id] ?></h3>
            <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0">            
                <thead>
                    <tr>
                        <th width="100">Season</th>
                        <th width="100">Item</th>
                        <th width="80">Ref No</th>
                        <th width="40">SMV</th>
                        <th width="80">Style</th>
                        <? foreach ($yearmonth_arr as $year_month) { ?>
                            <th width="60"><?= $year_month ?></th>
                        <? } ?>
                        <th width="80">Total</th>
                    </tr>
                </thead>
            </table>
            <div style="max-height: 300px;overflow-y: scroll;width: <?= $tbl_width+20;?>px">
                <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0"> 
                    <tbody>
                        <? 
                        $l = 0;
                        foreach ($buyer_wise_style_arr as $season_id => $item_arr) 
                        {
                            $s = 0;
                            $season_wise_total_arr=array();
                            $season_wise_total_sum=0;
                            foreach ($item_arr as $item_id => $refno_arr) 
                            { 
                                $itm = 0;
                                $buyer_wise_total_arr=array();
                                $buyer_wise_total_sum=0;
                                foreach ($refno_arr as $ref_no => $value) 
                                { 
                                    if ($l%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                    ?>

                                    <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('tbltr_<? echo $l; ?>','<? echo $bgcolor; ?>')" id="tbltr_<? echo $l; ?>">

                                        <? if($s==0){?>
                                        <td width="100" valign="middle" rowspan="<?= $rowspan_arr[$season_id]+$season_wise_itm_count[$season_id]; ?>">
                                            <?= substr($season_lib[$season_id],0,10); ?>                                                
                                        </td>
                                        <? $s++;} if($itm==0){?>
                                        <td width="100" rowspan="<?= $rowspan_item_arr[$season_id][$item_id]; ?>" title="<?= $garments_item[$item_id];?>"><?= substr($garments_item[$item_id],0,10); ?></td>
                                        <? $itm++;} ?>
                                        <td width="80">
                                            <a href="javascript:void(0)" onclick="report_generate_by_intref('<?= $company_id;?>','<?= $location_id;?>','<?= $buyer_id;?>','<?= $value['ref_no'];?>','<?= $client_id;?>');">
                                                <?=$value['ref_no']; ?>
                                            </a>
                                        </td>
                                        <td align="center" width="40"><?=$itm_smv_arr[$value['ref_no']][$item_id]; ?></td>
                                        <td width="80" title="<?=$value['style'] ?>"><?= substr($value['style'],0,10); ?></td>
                                        <?
                                        $buyer_wise_total=0;
                                        foreach ($yearmonth_arr as $year_month) 
                                        { 
                                            ?>
                                            <td width="60" align="right"><?= fn_number_format($value['year_month'][$year_month]); 
                                            $season_wise_total+=$value['year_month'][$year_month]; 
                                            $season_wise_total_arr[$year_month]+=$value['year_month'][$year_month];

                                            $buyer_wise_total+=$value['year_month'][$year_month]; 
                                            $buyer_wise_total_arr[$year_month]+=$value['year_month'][$year_month];                                 
                                            $buyer_wise_grand_sum[$year_month] += $value['year_month'][$year_month]
                                             ?></td>
                                        <? } ?>
                                        <td width="80" align="right"><?= fn_number_format($buyer_wise_total);  ?></td>
                                    </tr>
                                    <? 
                                    $l++;
                                }
                                ?>
                                <tr style="font-weight: bold;" bgcolor="#dccdcd">
                                    <td  colspan="4" align="right">Item Total</td>
                                    <?
                                    foreach ($yearmonth_arr as $year_month) { ?>
                                        <td  align="right"><?= 
                                        fn_number_format($buyer_wise_total_arr[$year_month]); 
                                        $buyer_wise_total_sum+=$buyer_wise_total_arr[$year_month]; ?>                                    
                                        </td>
                                    <? } ?>
                                    <td  align="right"><?= fn_number_format($buyer_wise_total_sum); ?></td>
                                </tr>
                                <?
                            } 
                            ?>
                            <tr style="font-weight: bold;" bgcolor="#fff999">
                                <td  colspan="5" align="right">Season Total</td>
                                <?
                                // $season_wise_total_sum = 0;
                                foreach ($yearmonth_arr as $year_month) { ?>
                                    <td  align="right"><?= 
                                    fn_number_format($season_wise_total_arr[$year_month]); 
                                    $season_wise_total_sum+=$season_wise_total_arr[$year_month]; ?>                                    
                                    </td>
                                <? } ?>
                                <td  align="right"><?= fn_number_format($season_wise_total_sum); ?></td>
                            </tr>
                            <?
                        }
                        ?>
                    </tbody>
                </table>
            </div>
            <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0"> 
                <tfoot>
                    <tr>
                        <th width="100"></th>
                        <th width="100"></th>
                        <th width="80"></th>
                        <th width="40"></th>
                        <th width="80">Grand Total</th>
                        <?
                        foreach ($yearmonth_arr as $year_month) { ?>
                            <th width="60" align="right"><?= fn_number_format($buyer_wise_grand_sum[$year_month]); 
                            $buyer_wise_grand_total_sum+=$buyer_wise_grand_sum[$year_month]; ?></th>
                        <? } ?>
                        <th width="80" align="right"><?= fn_number_format($buyer_wise_grand_total_sum); ?></th>
                    </tr>
                </tfoot>
            </table>     
        </div>    
    </fieldset>
    <script type="text/javascript">
        function report_generate_by_intref(company_id,location_id,buyer_id,intref,client_id)
        {
            var cbo_company_name = $("#cbo_company_name").val();
            var cbo_location_name = $("#cbo_location_name").val();
            emailwindow = dhtmlmodal.open('EmailBox', 'iframe', 'order_monitoring_report_with_tna_controller.php?cbo_company_name=' + company_id+'&cbo_location_name=' + location_id+'&buyer_id=' + buyer_id+'&intref=' + intref+'&client_id=' + client_id+ '&action=report_generate_by_intref', 'Color and size wise details', 'width=1150px,height=400px,center=1,resize=0,scrolling=0', '../../../');
        }
    </script>
    <?
    unset($main_array);
    /*$html = ob_get_contents();
    ob_clean();
    foreach (glob("$user_id*.xls") as $filename) {
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');    
    $is_created = fwrite($create_new_doc, $html);
    echo "$html####$filename"; */
    exit();
}


if($action == "report_generate_by_intref")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $company_id     = str_replace("'","",$cbo_company_name);
    $location_id    = str_replace("'","",$cbo_location_name);
    $buyer_id   = str_replace("'","",$buyer_id);
    $client_id   = str_replace("'","",$client_id);

    // $intref = explode(".", $intref);
    $location_cond='';
    if($location_id !=0) $location_cond=" and a.location_name=$location_id";
    if($client_id !=0) $client_cond=" and a.client_id=$client_id";

    $color_arr=return_library_array( "select id, color_name from lib_color",'id','color_name');
    $size_arr=return_library_array( "select id,size_name from lib_size",'id','size_name');
    
    // ============================================= main query ============================================
    $sql = "SELECT a.buyer_name as BUYER_NAME, a.style_ref_no as STYLE_REF_NO,b.id as PO_ID, b.grouping as GROUPING,  d.po_qty as ACC_PO_QTY, c.acc_ship_date as  ACC_SHIP_DATE, extract(day from c.acc_ship_date) as SHIP_DATE,  d.gmts_item as GMTS_ITEM,d.GMTS_COLOR_ID,d.GMTS_SIZE_ID  from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join wo_po_acc_po_info c on b.id=c.po_break_down_id JOIN wo_po_acc_po_info_dtls d ON c.id = d.mst_id where b.shiping_status in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and c.acc_ship_date IS NOT NULL and a.company_name=$company_id and b.grouping='$intref' and a.buyer_name=$buyer_id and d.gmts_item <> 0 and c.acc_po_status=1 $location_cond $client_cond order by c.acc_ship_date ASC";//and c.gmts_color_id <> 0 and c.gmts_size_id <> 0 
    // echo $sql;
    $res = sql_select($sql);
    $dataArray = array();
    $shipDateArray = array();
    $poArray = array();
    foreach ($res as $val) 
    {
        $poArray[$val['PO_ID']] = $val['PO_ID'];
        $dataArray[$val['GMTS_ITEM']][$val['GMTS_COLOR_ID']][$val['GMTS_SIZE_ID']][strtotime($val['ACC_SHIP_DATE'])] += $val['ACC_PO_QTY'];
        $shipDateArray[strtotime($val['ACC_SHIP_DATE'])] = strtotime($val['ACC_SHIP_DATE']);
    }
    unset($res);
    // echo "<pre>";print_r($dataArray);
    $poIds = implode(",", $poArray);
    // ============================================ production qty ==============================================
    $sql = "SELECT a.production_type as PROD_TYPE, sum(b.production_qnty) as QTY, c.item_number_id as ITEM_ID,c.color_number_id as COLOR_ID,c.size_number_id as SIZE_ID from pro_garments_production_mst a, pro_garments_production_dtls b, wo_po_color_size_breakdown c where a.id=b.mst_id and a.po_break_down_id=c.po_break_down_id and c.id=b.color_size_break_down_id and a.item_number_id=c.item_number_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and a.production_type in(1,5,8) and a.po_break_down_id in($poIds) group by a.production_type,c.item_number_id,c.color_number_id,c.size_number_id";
    // echo $sql;
    $res = sql_select($sql);
    $prodDataArray = array();
    foreach ($res as $val) 
    {
        $prodDataArray[$val['ITEM_ID']][$val['COLOR_ID']][$val['SIZE_ID']][$val['PROD_TYPE']] += $val['QTY'];
    }
    // echo "<pre>";print_r($prodDataArray);
    unset($res);
    // ============================================ ex-factory qty ==============================================
    $sql = "SELECT sum(b.production_qnty) as QTY, c.item_number_id as ITEM_ID,c.color_number_id as COLOR_ID,c.size_number_id as SIZE_ID from pro_ex_factory_mst a, pro_ex_factory_dtls b, wo_po_color_size_breakdown c where a.id=b.mst_id and a.po_break_down_id=c.po_break_down_id and c.id=b.color_size_break_down_id and a.item_number_id=c.item_number_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and a.po_break_down_id in($poIds) group by c.item_number_id,c.color_number_id,c.size_number_id";
    // echo $sql;
    $res = sql_select($sql);
    $exDataArray = array();
    foreach ($res as $val) 
    {
        $exDataArray[$val['ITEM_ID']][$val['COLOR_ID']][$val['SIZE_ID']] += $val['QTY'];
    }
    // echo "<pre>";print_r($exDataArray);
    unset($res);

    // ======================================= TNA DATA  ==================================
    $poIdsCondTna = str_replace("po_break_down_id", "A.PO_NUMBER_ID", $poIdsCond);
    $sqltna = "SELECT A.PO_NUMBER_ID,A.TASK_NUMBER,MAX(A.TASK_START_DATE) AS START_DATE,MAX(A.TASK_FINISH_DATE) AS END_DATE,MAX(A.ACTUAL_START_DATE) AS ACTUAL_START_DATE,MAX(A.ACTUAL_FINISH_DATE) AS ACTUAL_FINISH_DATE FROM TNA_PROCESS_MST A,WO_PO_BREAK_DOWN B WHERE A.PO_NUMBER_ID=B.ID AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.PO_QUANTITY>0 and A.PO_NUMBER_ID in($poIds) AND A.TASK_TYPE=1 and a.task_number in(84,86,88) group by A.PO_NUMBER_ID,A.TASK_NUMBER";
    // echo $sqltna;die();
    $tnaRes = sql_select($sqltna);
    $tnaDateArray = array();
    foreach ($tnaRes as $val) 
    {
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['start_date']          = $val['START_DATE'];
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['end_date']            = $val['END_DATE'];
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_start_date']   = $val['ACTUAL_START_DATE'];
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_finish_date']  = $val['ACTUAL_FINISH_DATE'];
    }

    // ================================== color size qty ======================
    $sql = "SELECT b.id as PO_ID,c.item_number_id as ITEM_ID,c.color_number_id as COLOR_ID,c.size_number_id as SIZE_ID,sum(c.order_quantity) as QTY from wo_po_details_master a, wo_po_break_down b , wo_po_color_size_breakdown c where a.id=b.job_id and b.id=c.po_break_down_id and a.id=c.job_id and a.company_name=$company_id and b.grouping='$intref' and a.buyer_name=$buyer_id $location_cond group by b.id,c.item_number_id,c.color_number_id,c.size_number_id";
    // echo $sql;
    $res = sql_select($sql);
    $colorSizeQtyArray = array();
    foreach ($res as $val) 
    {
        $colorSizeQtyArray[$val['PO_ID']][$val['ITEM_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['qty'] += $val['QTY'];
    }
    // print_r( $colorSizeQtyArray);

    // ======================================= Actual PO Info ==================================
    $sqlAccPo = "SELECT b.PO_BREAK_DOWN_ID,a.ACC_PO_NO,b.po_qty as ACC_PO_QTY,a.ACC_SHIP_DATE,b.GMTS_ITEM,b.GMTS_COLOR_ID,b.GMTS_SIZE_ID FROM WO_PO_ACC_PO_INFO a,WO_PO_ACC_PO_INFO_DTLS b WHERE a.id=b.mst_id and a.STATUS_ACTIVE=1 AND a.IS_DELETED=0 and b.STATUS_ACTIVE=1 AND b.IS_DELETED=0 and a.acc_po_status=1 and b.po_break_down_id in($poIds)";
    // echo $sqlAccPo;die();
    $sqlAccPoRes = sql_select($sqlAccPo);
    $accPoArray = array();
    $accPoIDArray = array();
    foreach ($sqlAccPoRes as $val) 
    {
        $accPoArray[$val['PO_BREAK_DOWN_ID']][$val['ACC_PO_NO']][$val['GMTS_ITEM']][$val['GMTS_COLOR_ID']][$val['GMTS_SIZE_ID']]['acc_po_qty'] += $val['ACC_PO_QTY'];
        $accPoArray[$val['PO_BREAK_DOWN_ID']][$val['ACC_PO_NO']][$val['GMTS_ITEM']][$val['GMTS_COLOR_ID']][$val['GMTS_SIZE_ID']]['acc_ship_date'] = $val['ACC_SHIP_DATE'];
        $accPoIDArray[$val['PO_BREAK_DOWN_ID']] .= $val['ACC_PO_NO'].",";
    }

    // =============================== getting backlog ================================
    $toDay = new DateTime('now');
    $backlogDataArray = array();
    foreach ($colorSizeQtyArray as $po_id => $po_data) 
    {
        $cuttingStDate   = $tnaDateArray[$po_id][84]['start_date'];// cutting
        $cuttingEndDate  = $tnaDateArray[$po_id][84]['end_date'];// cutting
        $cuttingAcStDate = $tnaDateArray[$po_id][84]['actual_start_date'];// cutting
        $cuttingAcEndDate= $tnaDateArray[$po_id][84]['actual_finish_date'];// cutting

        $sewingStDate   = $tnaDateArray[$po_id][86]['start_date'];// sewing
        $sewingEndDate  = $tnaDateArray[$po_id][86]['end_date'];// sewing
        $sewingAcStDate = $tnaDateArray[$po_id][86]['actual_start_date'];// sewing
        $sewingAcEndDate= $tnaDateArray[$po_id][86]['actual_finish_date'];// sewing

        $finishStDate   = $tnaDateArray[$po_id][88]['start_date'];// gmt finish
        $finishEndDate  = $tnaDateArray[$po_id][88]['end_date'];// gmt finish
        $finishAcStDate = $tnaDateArray[$po_id][88]['actual_start_date'];// gmt finish
        $finishAcEndDate= $tnaDateArray[$po_id][88]['actual_finish_date'];// gmt finish

        foreach ($po_data as $itemId => $item_data) 
        {
            foreach ($item_data as $colorId => $color_data) 
            {
                foreach ($color_data as $sizeId => $val) 
                {
                    //============================= CUTTING  =========================    
                    $cuttingQty = $prodDataArray[$itemId][$colorId][$sizeId][1];            
                    $gmtFinBal     = $val['qty'] - $cuttingQty;
                    $cuttingBackLog = 0;
                    $start_date  = new DateTime($cuttingStDate);
                    $end_date    = new DateTime($cuttingEndDate);
                    if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                    {
                        $cuttingBackLog = 0;
                    }
                    elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                    {
                        $cuttingBackLog = $val['qty'] - $cuttingQty;
                    }
                    elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                        $todayDaysDif= $start_date->diff($toDay)->format('%a');

                        $cuttingBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $cuttingQty;
                        // echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$cuttingQty."<br>";
                    }
                    $backlogDataArray[$itemId][$colorId][$sizeId][1] += max(0,$cuttingBackLog);  

                    //============================= SEWING  =========================    
                    $sewingQty = $prodDataArray[$itemId][$colorId][$sizeId][5];            
                    $gmtFinBal     = $val['qty'] - $sewingQty;
                    $sewingBackLog = 0;
                    $start_date  = new DateTime($sewingStDate);
                    $end_date    = new DateTime($sewingEndDate);
                    if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                    {
                        $sewingBackLog = 0;
                    }
                    elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                    {
                        $sewingBackLog = $val['qty'] - $sewingQty;
                    }
                    elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                        $todayDaysDif= $start_date->diff($toDay)->format('%a');

                        $sewingBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $sewingQty;
                        //echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$sewingQty."<br>";
                    }
                    $backlogDataArray[$itemId][$colorId][$sizeId][5] += max(0,$sewingBackLog); 

                    //============================= GMTS FINISH  =========================    
                    $finishQty = $prodDataArray[$itemId][$colorId][$sizeId][8];            
                    $gmtFinBal     = $val['qty'] - $finishQty;
                    $gmtFinBackLog = 0;
                    $start_date  = new DateTime($finishStDate);
                    $end_date    = new DateTime($finishEndDate);
                    if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                    {
                        $gmtFinBackLog = 0;
                    }
                    elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                    {
                        $gmtFinBackLog = $val['qty'] - $finishQty;
                    }
                    elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                        $todayDaysDif= $start_date->diff($toDay)->format('%a');

                        $gmtFinBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $finishQty;
                        //echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$finishQty."<br>";
                    }
                    $backlogDataArray[$itemId][$colorId][$sizeId][8] += max(0,$gmtFinBackLog);   

                    // ============================= ex-factory =================================
                    $accPoIdsArr = array_unique(array_filter(explode(",", $accPoIDArray[$po_id])));
                    // echo "<pre>";print_r($accPoIdsArr);die();
                    $acc_backlog = 0;
                    foreach ($accPoIdsArr as $acc_po_key => $acc_po_val) 
                    {
                        if(strtotime($toDay->format('Y-m-d')) > strtotime($accPoArray[$po_id][$acc_po_val][$itemId][$colorId][$sizeId]['acc_ship_date']))
                        {
                            $acc_backlog += $accPoArray[$po_id][$acc_po_val][$itemId][$colorId][$sizeId]['acc_po_qty'];
                        }

                    }
                    $shiping_backlog = $acc_backlog - $exDataArray[$itemId][$colorId][$sizeId];
                    $backlogDataArray[$itemId][$colorId][$sizeId][0] += max(0,$shiping_backlog);
                }
            }
        }
       
    }
    // echo "<pre>";print_r($backlogDataArray);




    $rowspan_item = array();
    $rowspan_color = array();
    $rowspan_size = array();
    foreach ($dataArray as $item_id => $item_val) 
    { 
        foreach ($item_val as $color_id => $color_val) 
        {
            foreach ($color_val as $size_id => $size_val) 
            {
                $rowspan_item[$item_id]++;
                $rowspan_color[$item_id][$color_id]++;
                $rowspan_size[$item_id][$color_id][$size_id]++;
            }
        }
    }

    // ====================== clculate running slot blance ===============================
    $running_slot_bal_array = array();
    foreach ($dataArray as $item_id => $item_val) 
    { 
        foreach ($item_val as $color_id => $color_val) 
        {
            foreach ($color_val as $size_id => $size_val) 
            {
                $cutting_qty = $prodDataArray[$item_id][$color_id][$size_id][1];                      
                $tot_cutting_qty = $prodDataArray[$item_id][$color_id][$size_id][1];                      
                $sewing_qty = $prodDataArray[$item_id][$color_id][$size_id][5];                      
                $tot_sewing_qty = $prodDataArray[$item_id][$color_id][$size_id][5];                      
                $finish_qty = $prodDataArray[$item_id][$color_id][$size_id][8];                      
                $tot_finish_qty = $prodDataArray[$item_id][$color_id][$size_id][8];                      
                $ex_factory_qty = $exDataArray[$item_id][$color_id][$size_id];                
                $tot_ex_factory_qty = $exDataArray[$item_id][$color_id][$size_id];                
                
                $cutting_slot = 0;
                $sewing_slot = 0;
                $finish_slot = 0;
                $ex_factory_slot = 0;
                foreach ($shipDateArray as $dtkey => $dtlue) 
                {
                    if($size_val[$dtkey]>0)
                    {
                        if ($cutting_qty>0) 
                        {
                            $cutting_slot += $size_val[$dtkey];
                            $cutting_qty -= $size_val[$dtkey];
                        }
                        if ($sewing_qty>0) 
                        {
                            $sewing_slot += $size_val[$dtkey];
                            $sewing_qty -= $size_val[$dtkey];
                        }
                        if ($finish_qty>0) 
                        {
                            $finish_slot += $size_val[$dtkey];
                            $finish_qty -= $size_val[$dtkey];
                        }
                        if ($ex_factory_qty>0) 
                        {
                            $ex_factory_slot += $size_val[$dtkey];
                            $ex_factory_qty -= $size_val[$dtkey];
                        }
                    }
                    
                }
                $running_slot_bal_array[$item_id][$color_id][$size_id][1] += $cutting_slot - $tot_cutting_qty;
                $running_slot_bal_array[$item_id][$color_id][$size_id][5] += $sewing_slot - $tot_sewing_qty;
                $running_slot_bal_array[$item_id][$color_id][$size_id][8] += $finish_slot - $tot_finish_qty;
                $running_slot_bal_array[$item_id][$color_id][$size_id][0] += $ex_factory_slot - $tot_ex_factory_qty;
            }
        }
    }
    // echo "<pre>";print_r($running_slot_bal_array);


    $tbl_width = 480+(count($shipDateArray)*50);
    ob_start(); 
    ?>
    <fieldset class="first_part" style="width:<? echo $tbl_width+30;?>px;margin:15px 0;">
        <div id="buyer_wise_details_report">
            <h3>Int Ref. : <?= $intref;?></h3>
            <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0">            
                <thead>
                    <tr>
                        <th width="80">Item</th>
                        <th width="80">Color</th>
                        <th width="80">Size</th>
                        <th width="80">Operation</th>
                        <th width="80">Backlog</th>
                        <th width="80">Running Slot Bal</th>
                        <? 
                        foreach ($shipDateArray as $dtkey => $dtlue) 
                        {
                            ?>
                            <th width="50"><?= date('d-M',$dtkey); ?></th>
                            <? 
                        } 
                        ?>
                    </tr>
                </thead>
            </table>
            <div style="max-height: 300px; overflow-y: scroll;width: <? echo $tbl_width+20;?>px;">
                <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0"> 
                    <tbody>
                        <? 
                        $i=1;
                        $ship_date_total = array();
                        $chk_size_array = array();
                        foreach ($dataArray as $item_id => $item_val) 
                        { 
                            $itm=0;
                            foreach ($item_val as $color_id => $color_val) 
                            {
                                $clr=0;
                                foreach ($color_val as $size_id => $size_val) 
                                {    
                                    $siz = 0;
                                    if($chk_size_array[$item_id][$color_id][$size_id] !="")
                                    {
                                        $siz = 1;
                                    }
                                    if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";  

                                    $cutting_qty = $prodDataArray[$item_id][$color_id][$size_id][1];                      
                                    $sewing_qty = $prodDataArray[$item_id][$color_id][$size_id][5];                      
                                    $finish_qty = $prodDataArray[$item_id][$color_id][$size_id][8];                      
                                    $ex_factory_qty = $exDataArray[$item_id][$color_id][$size_id];                      
                                    ?>
                                    <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                    <? if($itm==0)
                                    {
                                        ?>
                                        <td valign="middle" width="80" rowspan="<?= $rowspan_item[$item_id]*4;?>" align="left"><p><?= substr($garments_item[$item_id],0,15);?></p></td>
                                        <? $itm++;} if($clr==0){?>
                                        <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_color[$item_id][$color_id]*4;?>"><p><?= $color_arr[$color_id];?></p></td>
                                        <? $clr++;} if($siz==0){?>
                                        <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_size[$item_id][$color_id][$size_id]*4;?>"><p><?= $size_arr[$size_id];?></p></td>
                                        <? $siz++;$chk_size_array[$item_id][$color_id][$size_id]='kakku';}?>
                                        <td width="80" align="left">Cutting</td>
                                        <td width="80" align="right"><?= fn_number_format($backlogDataArray[$item_id][$color_id][$size_id][1],0); ?></td>
                                        <td width="80" align="right"><?= $running_slot_bal_array[$item_id][$color_id][$size_id][1];?></td>
                                        <? 
                                        foreach ($shipDateArray as $dtkey => $dtlue) 
                                        {
                                            $tdcolor="white";
                                            if($size_val[$dtkey]>0)
                                            {
                                                if($size_val[$dtkey] <= $cutting_qty)
                                                {
                                                    $tdcolor = "#00d6ff";
                                                }
                                                elseif ($size_val[$dtkey] > $cutting_qty && $cutting_qty>0) 
                                                {
                                                    $tdcolor = "yellow";
                                                }
                                                $cutting_qty -= $size_val[$dtkey];
                                                // echo "<br>";
                                            }
                                            ?>
                                            <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= $size_val[$dtkey]; ?></td>
                                            <? 
                                            $ship_date_total[$dtkey] += $size_val[$dtkey];
                                        }
                                        $i++; 
                                        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                        ?>
                                    </tr>
                                    <!-- =========================== sewimg ===================== -->
                                    <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                        <!-- <td width="80" align="left"><?= $garments_item[$item_id];?></td> -->
                                        <!-- <td width="80" align="left"><?= $color_arr[$color_id];?></td> -->
                                        <!-- <td width="80" align="left"><?= $size_arr[$size_id];?></td> -->
                                        <td width="80" align="left">Sewing</td>
                                        <td width="80" align="right"><?= fn_number_format($backlogDataArray[$item_id][$color_id][$size_id][5],0); ?></td>
                                        <td width="80" align="right"><?= $running_slot_bal_array[$item_id][$color_id][$size_id][5];?></td>
                                        <? 
                                        foreach ($shipDateArray as $dtkey => $dtlue) 
                                        {
                                            $tdcolor="white";
                                            if($size_val[$dtkey]>0)
                                            {
                                                if($size_val[$dtkey] <= $sewing_qty)
                                                {
                                                    $tdcolor = "#00d6ff";
                                                }
                                                elseif ($size_val[$dtkey] > $sewing_qty && $sewing_qty>0) 
                                                {
                                                    $tdcolor = "yellow";
                                                }
                                                $sewing_qty -= $size_val[$dtkey];
                                                // echo "<br>";
                                            }
                                            ?>
                                            <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= $size_val[$dtkey]; ?></td>
                                            <? 
                                        } 
                                        $i++; 
                                        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                        ?>
                                    </tr>
                                    <!-- =========================== Finishing ===================== -->
                                    <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                        <!-- <td width="80" align="left"><?= $garments_item[$item_id];?></td> -->
                                        <!-- <td width="80" align="left"><?= $color_arr[$color_id];?></td> -->
                                        <!-- <td width="80" align="left"><?= $size_arr[$size_id];?></td> -->
                                        <td width="80" align="left">Finishing</td>
                                        <td width="80" align="right"><?= fn_number_format($backlogDataArray[$item_id][$color_id][$size_id][8],0); ?></td>
                                        <td width="80" align="right"><?= $running_slot_bal_array[$item_id][$color_id][$size_id][8];?></td>
                                        <? 
                                        foreach ($shipDateArray as $dtkey => $dtlue) 
                                        {
                                            $tdcolor="white";
                                            if($size_val[$dtkey]>0)
                                            {
                                                if($size_val[$dtkey] <= $finish_qty)
                                                {
                                                    $tdcolor = "#00d6ff";
                                                }
                                                elseif ($size_val[$dtkey] > $finish_qty && $finish_qty>0) 
                                                {
                                                    $tdcolor = "yellow";
                                                }
                                                $finish_qty -= $size_val[$dtkey];
                                                // echo "<br>";
                                            }
                                            ?>
                                            <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= $size_val[$dtkey]; ?></td>
                                            <? 
                                        } 
                                        $i++; 
                                        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                        ?>
                                    </tr>
                                    <!-- =========================== Shipment ===================== -->
                                    <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                        <!-- <td width="80" align="left"><?= $garments_item[$item_id];?></td> -->
                                        <!-- <td width="80" align="left"><?= $color_arr[$color_id];?></td> -->
                                        <!-- <td width="80" align="left"><?= $size_arr[$size_id];?></td> -->
                                        <td width="80" align="left">Shipment</td>
                                        <td width="80" align="right"><?= fn_number_format($backlogDataArray[$item_id][$color_id][$size_id][0],0); ?></td>
                                        <td width="80" align="right"><?= $running_slot_bal_array[$item_id][$color_id][$size_id][0];?></td>
                                        <? 
                                        foreach ($shipDateArray as $dtkey => $dtlue) 
                                        {
                                            $tdcolor="white";
                                            if($size_val[$dtkey]>0)
                                            {
                                                if($size_val[$dtkey] <= $ex_factory_qty)
                                                {
                                                    $tdcolor = "#00d6ff";
                                                }
                                                elseif ($size_val[$dtkey] > $ex_factory_qty && $ex_factory_qty>0) 
                                                {
                                                    $tdcolor = "yellow";
                                                }
                                                $ex_factory_qty -= $size_val[$dtkey];
                                                // echo "<br>";
                                            }
                                            ?>
                                            <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= $size_val[$dtkey]; ?></td>
                                            <? 
                                        } 
                                        $i++; 
                                        ?>
                                    </tr>
                                    <?
                                }
                            }
                        } 
                        ?>
                    </tbody>
                </table>   
            </div>  
            <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0"> 
                <tfoot>
                    <tr>
                        <th width="80"></th>
                        <th width="80"></th>
                        <th width="80"></th>
                        <th width="80"></th>
                        <th width="80"></th>
                        <th width="80">Total</th>
                        <? 
                        foreach ($shipDateArray as $dtkey => $dtlue) 
                        {
                            ?>
                            <th width="50"><?= $ship_date_total[$dtkey]; ?></th>
                            <? 
                        } 
                        ?>
                    </tr>
                </tfoot>
            </table>
        </div>    
    </fieldset>
    <?
    unset($main_array);
    /*$html = ob_get_contents();
    ob_clean();
    foreach (glob("$user_id*.xls") as $filename) {
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');    
    $is_created = fwrite($create_new_doc, $html);
    echo "$html####$filename"; */
    exit();

}

if($action == "report_by_month_summery")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $company_id     = str_replace("'","",$cbo_company_name);
    $location_id    = str_replace("'","",$cbo_location_name);
    $buyer_id   = str_replace("'","",$buyer_id);
    $client_id   = str_replace("'","",$client_id);

    $month_year_arr = explode(".", $month_year);
    $months_shorts = array('Jan' => 1, 'Feb' => 2, 'Mar' => 3, 'Apr' => 4, 'May' => 5, 'Jun' => 6, 'Jul' => 7, 'Aug' => 8, 'Sep' => 9, 'Oct' => 10, 'Nov' => 11, 'Dec' => 12);

    // print_r($months_shorts);
    // echo $month_year_arr[1];
    // $month_number = date("n",strtotime($month_year_arr[1]));
    $month_number = $months_shorts[$month_year_arr[1]];
    $dt = DateTime::createFromFormat('y', $month_year_arr[0]);
    $year = $dt->format('Y');
    $number_of_days=cal_days_in_month(CAL_GREGORIAN,$month_number,$year);
    $first_date = $year.'-'.$month_number.'-01';
    $last_date=date("Y-m-t", strtotime($first_date));

    $location_cond='';
    if($location_id !=0) $location_cond=" and a.location_name=$location_id";
    if($client_id !=0) $client_cond=" and a.client_id=$client_id";

    if(!$buyer_id)
    {    
        if($_SESSION['logic_erp']["data_level_secured"]==1)
        {
            if($_SESSION['logic_erp']["buyer_id"]!="")
            {   
                $buyer_cond =" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")";
            }
        }
    }
    else
    {
        $buyer_cond =" and a.buyer_name=$buyer_id";
    }
    
    

    $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
    $company_arr=return_library_array( "select id,company_name from lib_company",'id','company_name');

    // ============================ ex-factory data =========================
    $sql = "SELECT d.ACTUAL_PO_DTLS_ID as dtls_id,d.EX_FACT_QTY  from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join PRO_EX_FACTORY_MST c on b.id=c.po_break_down_id and c.status_active=1 JOIN PRO_EX_FACTORY_ACTUAL_PO_DETAILS d ON c.id = d.mst_id and d.status_active=1 where b.shiping_status in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and a.company_name=$company_id $location_cond $buyer_cond $client_cond";
    // echo $sql;
    $res = sql_select($sql);
    $exf_data_array = array();
    foreach ($res as $v) 
    {
        $exf_data_array[$v['DTLS_ID']] += $v['EX_FACT_QTY'];
    }
    // echo "<pre>"; print_r($exf_data_array);


    $shipment_date = "and c.acc_ship_date between '".change_date_format($first_date, "yyyy-mm-dd", "-",1)."' and '".change_date_format($last_date, "yyyy-mm-dd", "-",1)."'";
   $buyer_wise_summery_sql = sql_select("SELECT a.buyer_name as BUYER_NAME, a.style_ref_no as STYLE_REF_NO, b.grouping as GROUPING,  d.po_qty as ACC_PO_QTY, c.acc_ship_date as  ACC_SHIP_DATE, extract(day from c.acc_ship_date) as SHIP_DATE,  d.gmts_item as GMTS_ITEM,d.id as dtls_id  from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join wo_po_acc_po_info c on b.id=c.po_break_down_id JOIN wo_po_acc_po_info_dtls d ON c.id = d.mst_id where b.shiping_status in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and c.acc_ship_date IS NOT NULL and a.company_name=$company_id and d.gmts_item <> 0 and c.acc_po_status=1 $location_cond $client_cond $shipment_date  $buyer_cond order by c.acc_ship_date ASC");

    foreach ($buyer_wise_summery_sql as $row) 
    {
        if(max($row['ACC_PO_QTY'] - $exf_data_array[$row['DTLS_ID']],0)>0)
        {
            $buyer_wise_style_arr[$row['BUYER_NAME']][$row['SHIP_DATE']] += max($row['ACC_PO_QTY'] - $exf_data_array[$row['DTLS_ID']],0);
        }
    }
    $tbl_width = 1200;
    ob_start(); 
    ?>
    <fieldset class="first_part" style="width:96%;margin:15px 0;">
        <style type="text/css">        
            .GridViewScrollHeader TH, .GridViewScrollHeader TD 
            {
                padding: 2px 4px;
                font-weight: normal;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                text-align: left;
                vertical-align: middle;
            }

            .GridViewScrollHeader TH{
                background-image: -webkit-linear-gradient( rgb(194,220,255) 10%, rgb(136,170,214) 96%);
                border: 1px solid #8DAFDA;
                color:#444;
                font-size: 13px;
                font-weight: bold;
                text-align: center;
                line-height: 12px;
                height: 25px;
            }

            .GridViewScrollItem TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
               /* background-color: #FFFFFF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollItemFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #E9F3FF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollFooterFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-top: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                vertical-align: middle;
                font-weight: 700;
                background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB));
            }
            tr.GridViewScrollItemFreeze:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            tr.footerTr:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            html {
              --scrollbarBG: #CFD8DC;
              --thumbBG: #8ec5fc;
            }
            body::-webkit-scrollbar {
              width: 11px;
            }
            body {
              scrollbar-width: thin;
              scrollbar-color: var(--thumbBG) var(--scrollbarBG);
            }
            body::-webkit-scrollbar-track {
              background: var(--scrollbarBG);
            }
            body::-webkit-scrollbar-thumb {
              background-color: var(--thumbBG) ;
              border-radius: 6px;
              border: 3px solid var(--scrollbarBG);
            }
        </style> 
        <!-- <h3 style="width:<? echo $tbl_width;?>px;" align="left" id="accordion_h1" class="accordion_h" onClick="accordion_menu( this.id,'report_by_month_summery', '')"> -<b>Actual Shipment Plan - Month Summery</b></h3> -->
        <div id="report_by_month_summery">
            <h3>Month : <?= $month_year_arr[1].','.$year ?></h3>
            <table id="gvMain" border="1" rules="all" class="rpt_table" width="100%" cellpadding="0" cellspacing="0">            
                <thead>
                    <tr class="GridViewScrollHeader">
                        <th >Buyer</th>
                        <? for ($days=1; $days<=$number_of_days; $days++) { ?>
                            <th ><?= $days ?></th>
                        <? } ?>
                        <th >Total</th>
                    </tr>
                </thead>
                <tbody>
                    <? 
                    $i=1;
                    foreach ($buyer_wise_style_arr as $buyer_id => $value) {
                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                     ?>
                        <tr class="GridViewScrollItem" bgcolor="<? echo $bgcolor;?>" onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $i; ?>">
                            <td  align="center">
                            <a href="javascript:void(0)" onclick="report_by_month_details('<? echo $company_id?>','<? echo $location_id?>','<? echo $buyer_id?>','<? echo $month_year ?>','<?=$client_id;?>')">
                                <?= $buyer_arr[$buyer_id] ?>
                            </a>
                                
                            </td>
                            <?
                            $item_wise_total=0;
                            for ($days=1; $days<=$number_of_days; $days++) { ?>
                                <td  align="right"><?= fn_number_format($value[$days]); $item_wise_total+=$value[$days]; $item_wise_total_arr[$days]+=$value[$days]; ?></td>
                            <? } ?>
                            <td align="right"><?= fn_number_format($item_wise_total);  ?></td>
                        </tr>
                        <? $i++;
                    } ?>
                </tbody>
                <tr class="GridViewScrollItem footerTr">
                    <td>Total<div class="gridViewScrollHelper"></div></td>
                    <?
                    for ($days=1; $days<=$number_of_days; $days++) { ?>
                        <td align="right"><?= fn_number_format($item_wise_total_arr[$days]); $item_wise_total_sum+=$item_wise_total_arr[$days]; ?></td>
                    <? } ?>
                    <td align="right"><?= fn_number_format($item_wise_total_sum); ?></td>
                </tr>
            </table>     
        </div>    
    </fieldset>
    <script type="text/javascript">
        function report_by_month_details(company_id,location_id,buyer_id,month_year,client_id)
        {
            var cbo_company_name = $("#cbo_company_name").val();
            var cbo_location_name = $("#cbo_location_name").val();
            emailwindow = dhtmlmodal.open('EmailBox', 'iframe', 'order_monitoring_report_with_tna_controller.php?cbo_company_name=' + company_id+'&cbo_location_name=' + location_id+'&buyer_id=' + buyer_id+'&month_year=' + month_year+'&client_id=' + client_id+ '&action=report_by_month_details', 'Month wise Details', 'width=1150px,height=400px,center=1,resize=0,scrolling=0', '../../../');
        }
    </script>    

    <script type="text/javascript" src="../../../../js/gridviewscroll.js"></script>
        <script type="text/javascript">
            var gridViewScroll = null;
            fnGridView = function () {
                gridViewScroll = new GridViewScroll({
                    elementID: "gvMain",
                    width: screen.width-200,
                    // width: 1335,
                    height: 320,
                    freezeColumn: true,
                    freezeFooter: true,
                    freezeColumnCssClass: "GridViewScrollItemFreeze",
                    freezeFooterCssClass: "GridViewScrollFooterFreeze",
                    freezeHeaderRowCount: 1,
                    freezeColumnCount: 1,
                    onscroll: function (scrollTop, scrollLeft) {
                        console.log(scrollTop + " - " + scrollLeft);
                    }
                });
                gridViewScroll.enhance();
            }
            function getScrollPosition() {
                var position = gridViewScroll.scrollPosition;
                alert("scrollTop: " + position.scrollTop + ", scrollLeft: " + position.scrollLeft);
            }
            function setScrollPosition() {
                var scrollPosition = { scrollTop: 50, scrollLeft: 50};

                gridViewScroll.scrollPosition = scrollPosition;
            }
            fnGridView();
            //=================================================
            
        </script>
    <?
    unset($main_array);
    /*$html = ob_get_contents();
    ob_clean();
    foreach (glob("$user_id*.xls") as $filename) {
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');    
    $is_created = fwrite($create_new_doc, $html);
    echo "$html####$filename"; */
    exit();

}
if($action == "report_by_month_details")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $company_id     = str_replace("'","",$cbo_company_name);
    $location_id    = str_replace("'","",$cbo_location_name);
    $buyer_id   = str_replace("'","",$buyer_id);
    $client_id   = str_replace("'","",$client_id);

    $month_year_arr = explode(".", $month_year);
    // $month_number = date("n",strtotime($month_year_arr[1]));
    $months_shorts = array('Jan' => 1, 'Feb' => 2, 'Mar' => 3, 'Apr' => 4, 'May' => 5, 'Jun' => 6, 'Jul' => 7, 'Aug' => 8, 'Sep' => 9, 'Oct' => 10, 'Nov' => 11, 'Dec' => 12);

    // print_r($months_shorts);
    // echo $month_year_arr[1];
    // $month_number = date("n",strtotime($month_year_arr[1]));
    $month_number = $months_shorts[$month_year_arr[1]];
    $dt = DateTime::createFromFormat('y', $month_year_arr[0]);
    $year = $dt->format('Y');
    $number_of_days=cal_days_in_month(CAL_GREGORIAN,$month_number,$year);
    $first_date = $year.'-'.$month_number.'-01';
    $last_date=date("Y-m-t", strtotime($first_date));
    $location_cond='';
    if($location_id !=0) $location_cond=" and a.location_name=$location_id";
    $client_cond = "";
    if($client_id !=0) $client_cond=" and a.client_id=$client_id";

    $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
    $company_arr=return_library_array( "select id,company_name from lib_company",'id','company_name');

    // ============================ ex-factory data =========================
    $sql = "SELECT d.ACTUAL_PO_DTLS_ID as dtls_id,d.EX_FACT_QTY  from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join PRO_EX_FACTORY_MST c on b.id=c.po_break_down_id and c.status_active=1 JOIN PRO_EX_FACTORY_ACTUAL_PO_DETAILS d ON c.id = d.mst_id and d.status_active=1 where b.shiping_status in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and a.company_name=$company_id and a.buyer_name=$buyer_id $location_cond $client_cond";
    // echo $sql;
    $res = sql_select($sql);
    $exf_data_array = array();
    foreach ($res as $v) 
    {
        $exf_data_array[$v['DTLS_ID']] += $v['EX_FACT_QTY'];
    }
    // echo "<pre>"; print_r($exf_data_array);

    $shipment_date = "and c.acc_ship_date between '".change_date_format($first_date, "yyyy-mm-dd", "-",1)."' and '".change_date_format($last_date, "yyyy-mm-dd", "-",1)."'";
   $sql = "SELECT a.JOB_NO,a.buyer_name as BUYER_NAME,a.SET_SMV, a.style_ref_no as STYLE_REF_NO, b.grouping as GROUPING,  d.po_qty as ACC_PO_QTY, c.acc_ship_date as  ACC_SHIP_DATE, extract(day from c.acc_ship_date) as SHIP_DATE,  d.gmts_item as GMTS_ITEM,d.id as dtls_id  from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join wo_po_acc_po_info c on b.id=c.po_break_down_id JOIN wo_po_acc_po_info_dtls d ON c.id = d.mst_id where b.shiping_status in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and c.acc_ship_date IS NOT NULL and a.company_name=$company_id and a.buyer_name=$buyer_id and d.gmts_item <> 0 and c.acc_po_status=1 $location_cond $shipment_date $client_cond order by c.acc_ship_date ASC";
   // echo $sql;
   $sqlRes = sql_select($sql);
   $job_array = array();
    foreach ($sqlRes as $row) 
    {
        if(max($row['ACC_PO_QTY'] - $exf_data_array[$row['DTLS_ID']],0)>0)
        {
            $buyer_wise_style_arr[$row['GROUPING']][$row['GMTS_ITEM']]['style'] = $row['STYLE_REF_NO'];
            $buyer_wise_style_arr[$row['GROUPING']][$row['GMTS_ITEM']]['smv'] = $row['SET_SMV'];
            $buyer_wise_style_arr[$row['GROUPING']][$row['GMTS_ITEM']]['item'] = $row['GMTS_ITEM'];
            $buyer_wise_style_arr[$row['GROUPING']][$row['GMTS_ITEM']]['po_qty'][$row['SHIP_DATE']] += max($row['ACC_PO_QTY'] - $exf_data_array[$row['DTLS_ID']],0);
            $job_array[$row['JOB_NO']] = $row['JOB_NO'];
        }
    }
    $joNos = "'".implode("','", $job_array)."'";
    $itm_smv_arr = return_library_array( "select gmts_item_id, smv_pcs from wo_po_details_mas_set_details where job_no in($joNos)",'gmts_item_id','smv_pcs');
    $tbl_width = 1200;
    ob_start(); 
    ?>
    <fieldset class="first_part" style="width:96%;margin:15px 0;">
        <style type="text/css">        
            .GridViewScrollHeader TH, .GridViewScrollHeader TD 
            {
                padding: 2px 4px;
                font-weight: normal;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                text-align: left;
                vertical-align: middle;
            }

            .GridViewScrollHeader TH{
                background-image: -webkit-linear-gradient( rgb(194,220,255) 10%, rgb(136,170,214) 96%);
                border: 1px solid #8DAFDA;
                color:#444;
                font-size: 13px;
                font-weight: bold;
                text-align: center;
                line-height: 12px;
                height: 25px;
            }

            .GridViewScrollItem TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
               /* background-color: #FFFFFF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollItemFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #E9F3FF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollFooterFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-top: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                vertical-align: middle;
                font-weight: 700;
                background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB));
            }
            tr.GridViewScrollItemFreeze:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            tr.footerTr:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            html {
              --scrollbarBG: #CFD8DC;
              --thumbBG: #8ec5fc;
            }
            body::-webkit-scrollbar {
              width: 11px;
            }
            body {
              scrollbar-width: thin;
              scrollbar-color: var(--thumbBG) var(--scrollbarBG);
            }
            body::-webkit-scrollbar-track {
              background: var(--scrollbarBG);
            }
            body::-webkit-scrollbar-thumb {
              background-color: var(--thumbBG) ;
              border-radius: 6px;
              border: 3px solid var(--scrollbarBG);
            }
        </style> 
        <!-- <h3 style="width:<? echo $tbl_width;?>px;" align="left" id="accordion_h1" class="accordion_h" onClick="accordion_menu( this.id,'buyer_wise_details_report', '')"> -<b>Actual Shipment Plan - Month details</b></h3> -->
        <div id="buyer_wise_details_report">
            <h3>Month : <?= $month_year_arr[1].','.$year ?>(<?=  $buyer_arr[$buyer_id] ?>)</h3>
            <table id="gvMain" border="1" rules="all" class="rpt_table" width="100%" cellpadding="0" cellspacing="0">            
                <thead>
                    <tr class="GridViewScrollHeader">
                        <th>Ref No</th>
                        <th>Style</th>
                        <th>SMV</th>
                        <th>Item</th>
                        <? for ($days=1; $days<=$number_of_days; $days++) { ?>
                            <th><?= $days ?></th>
                        <? } ?>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <? 
                    
                    foreach ($buyer_wise_style_arr as $grouping => $groupingvalue) 
                    { 
                        foreach ($groupingvalue as $itmid => $value) 
                        {
                            ?>
                            <tr class="GridViewScrollItem">
                                <td align="center"><?= $grouping  ?></td>
                                <td align="center" title="<?= $value['style']  ?>"><?= substr($value['style'],0,10);?></td>
                                <td align="center" ><?= $itm_smv_arr[$itmid]  ?></td>
                                <td align="center" title="<?= $garments_item[$value['item']];?>"><?= substr($garments_item[$value['item']],0,10);?></td>
                                <?
                                $item_wise_total=0;
                                for ($days=1; $days<=$number_of_days; $days++) { ?>
                                    <td align="right"><?= fn_number_format($value['po_qty'][$days]); $item_wise_total+=$value['po_qty'][$days]; $item_wise_total_arr[$days]+=$value['po_qty'][$days]; ?></td>
                                <? } ?>
                                <td align="right"><?= fn_number_format($item_wise_total);  ?></td>
                            </tr>
                            <?
                        }
                    } 
                    ?>
                </tbody>
                <tr class="GridViewScrollItem footerTr">
                    <td>Total<div class="gridViewScrollHelper"></div></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <?
                    for ($days=1; $days<=$number_of_days; $days++) { ?>
                        <td align="right"><?= fn_number_format($item_wise_total_arr[$days]); $item_wise_total_sum+=$item_wise_total_arr[$days]; ?></td>
                    <? } ?>
                    <td align="right"><?= fn_number_format($item_wise_total_sum); ?></td>
                </tr>
            </table>     
        </div>    
    </fieldset>   

    <script type="text/javascript" src="../../../../js/gridviewscroll.js"></script>
        <script type="text/javascript">
            var gridViewScroll = null;
            fnGridView = function () {
                gridViewScroll = new GridViewScroll({
                    elementID: "gvMain",
                    width: screen.width-250,
                    // width: 1335,
                    height: 300,
                    freezeColumn: true,
                    freezeFooter: true,
                    freezeColumnCssClass: "GridViewScrollItemFreeze",
                    freezeFooterCssClass: "GridViewScrollFooterFreeze",
                    freezeHeaderRowCount: 1,
                    freezeColumnCount: 4,
                    onscroll: function (scrollTop, scrollLeft) {
                        console.log(scrollTop + " - " + scrollLeft);
                    }
                });
                gridViewScroll.enhance();
            }
            function getScrollPosition() {
                var position = gridViewScroll.scrollPosition;
                alert("scrollTop: " + position.scrollTop + ", scrollLeft: " + position.scrollLeft);
            }
            function setScrollPosition() {
                var scrollPosition = { scrollTop: 50, scrollLeft: 50};

                gridViewScroll.scrollPosition = scrollPosition;
            }
            fnGridView();
            //=================================================
            
        </script>
    <?
    unset($main_array);
    /*$html = ob_get_contents();
    ob_clean();
    foreach (glob("$user_id*.xls") as $filename) {
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');    
    $is_created = fwrite($create_new_doc, $html);
    echo "$html####$filename"; */
    exit();

}

if($action == "report_generate_by_fab_stucture_bk")// 10-04-2022
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $po_id   = str_replace("'","",$po_id);
    $int_ref   = str_replace("'","",$int_ref);
    $client_id   = str_replace("'","",$client_id);
    $style   = str_replace("'","",$style);

    // $intref = explode(".", $intref);
    if($client_id !=0) $client_cond=" and a.client_id=$client_id";
    if($int_ref !=0) $int_ref_cond=" and b.grouping='$int_ref'";

    $color_arr=return_library_array( "select id, color_name from lib_color",'id','color_name');
    $size_arr=return_library_array( "select id,size_name from lib_size",'id','size_name');
    
    // ============================================= main query ============================================
    $sql = "SELECT a.buyer_name as BUYER_NAME, a.style_ref_no as STYLE_REF_NO,b.id as PO_ID, b.grouping as GROUPING,  c.acc_po_qty as ACC_PO_QTY, c.acc_ship_date as  ACC_SHIP_DATE, extract(day from c.acc_ship_date) as SHIP_DATE,  c.gmts_item as GMTS_ITEM,c.GMTS_COLOR_ID,c.GMTS_SIZE_ID  from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join wo_po_acc_po_info c on b.id=c.po_break_down_id where b.shiping_status in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and c.acc_ship_date IS NOT NULL and c.gmts_item <> 0 and c.acc_po_status=1 $client_cond $int_ref_cond order by c.acc_ship_date ASC";//and c.gmts_color_id <> 0 and c.gmts_size_id <> 0 
    // echo $sql;
    $res = sql_select($sql);
    $dataArray = array();
    $shipDateArray = array();
    $poArray = array();
    foreach ($res as $val) 
    {
        $poArray[$val['PO_ID']] = $val['PO_ID'];
        $dataArray[$val['GMTS_ITEM']][$val['GMTS_COLOR_ID']][$val['GMTS_SIZE_ID']][strtotime($val['ACC_SHIP_DATE'])] += $val['ACC_PO_QTY'];
        $shipDateArray[strtotime($val['ACC_SHIP_DATE'])] = strtotime($val['ACC_SHIP_DATE']);
    }
    unset($res);
    // echo "<pre>";print_r($dataArray);
    $poIds = implode(",", $poArray);
    // ============================================ production qty ==============================================
    $sql = "SELECT a.production_type as PROD_TYPE, sum(b.production_qnty) as QTY, c.item_number_id as ITEM_ID,c.color_number_id as COLOR_ID,c.size_number_id as SIZE_ID from pro_garments_production_mst a, pro_garments_production_dtls b, wo_po_color_size_breakdown c where a.id=b.mst_id and a.po_break_down_id=c.po_break_down_id and c.id=b.color_size_break_down_id and a.item_number_id=c.item_number_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and a.production_type in(1,4,5,8) and a.po_break_down_id in($poIds) group by a.production_type,c.item_number_id,c.color_number_id,c.size_number_id";
    // echo $sql;
    $res = sql_select($sql);
    $prodDataArray = array();
    foreach ($res as $val) 
    {
        $prodDataArray[$val['ITEM_ID']][$val['COLOR_ID']][$val['SIZE_ID']][$val['PROD_TYPE']] += $val['QTY'];
    }
    // echo "<pre>";print_r($prodDataArray);
    unset($res);
    // ============================================ ex-factory qty ==============================================
    $sql = "SELECT sum(b.production_qnty) as QTY, c.item_number_id as ITEM_ID,c.color_number_id as COLOR_ID,c.size_number_id as SIZE_ID from pro_ex_factory_mst a, pro_ex_factory_dtls b, wo_po_color_size_breakdown c where a.id=b.mst_id and a.po_break_down_id=c.po_break_down_id and c.id=b.color_size_break_down_id and a.item_number_id=c.item_number_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and a.po_break_down_id in($poIds) group by c.item_number_id,c.color_number_id,c.size_number_id";
    // echo $sql;
    $res = sql_select($sql);
    $exDataArray = array();
    foreach ($res as $val) 
    {
        $exDataArray[$val['ITEM_ID']][$val['COLOR_ID']][$val['SIZE_ID']] += $val['QTY'];
    }
    // echo "<pre>";print_r($exDataArray);
    unset($res);

    // ======================================= TNA DATA  ==================================
    $poIdsCondTna = str_replace("po_break_down_id", "A.PO_NUMBER_ID", $poIdsCond);
    $sqltna = "SELECT A.PO_NUMBER_ID,A.TASK_NUMBER,MAX(A.TASK_START_DATE) AS START_DATE,MAX(A.TASK_FINISH_DATE) AS END_DATE,MAX(A.ACTUAL_START_DATE) AS ACTUAL_START_DATE,MAX(A.ACTUAL_FINISH_DATE) AS ACTUAL_FINISH_DATE FROM TNA_PROCESS_MST A,WO_PO_BREAK_DOWN B WHERE A.PO_NUMBER_ID=B.ID AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.PO_QUANTITY>0 and A.PO_NUMBER_ID in($poIds) AND A.TASK_TYPE=1 and a.task_number in(84,86,88,122) group by A.PO_NUMBER_ID,A.TASK_NUMBER";
    // echo $sqltna;die();
    $tnaRes = sql_select($sqltna);
    $tnaDateArray = array();
    foreach ($tnaRes as $val) 
    {
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['start_date']          = $val['START_DATE'];
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['end_date']            = $val['END_DATE'];
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_start_date']   = $val['ACTUAL_START_DATE'];
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_finish_date']  = $val['ACTUAL_FINISH_DATE'];
    }

    // ================================== color size qty ======================
    $sql = "SELECT b.id as PO_ID,c.item_number_id as ITEM_ID,c.color_number_id as COLOR_ID,c.size_number_id as SIZE_ID,sum(c.order_quantity) as QTY from wo_po_details_master a, wo_po_break_down b , wo_po_color_size_breakdown c where a.id=b.job_id and b.id=c.po_break_down_id and a.id=c.job_id and b.id in($poIds) $int_ref_cond group by b.id,c.item_number_id,c.color_number_id,c.size_number_id";
    // echo $sql;
    $res = sql_select($sql);
    $colorSizeQtyArray = array();
    foreach ($res as $val) 
    {
        $colorSizeQtyArray[$val['PO_ID']][$val['ITEM_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['qty'] += $val['QTY'];
    }
    // print_r( $colorSizeQtyArray);

    // ======================================= Actual PO Info ==================================
    $sqlAccPo = "SELECT b.PO_BREAK_DOWN_ID,a.ACC_PO_NO,b.po_qty as ACC_PO_QTY,a.ACC_SHIP_DATE,b.GMTS_ITEM,b.GMTS_COLOR_ID,b.GMTS_SIZE_ID FROM WO_PO_ACC_PO_INFO a,WO_PO_ACC_PO_INFO_DTLS b WHERE a.id=b.mst_id and a.STATUS_ACTIVE=1 AND a.IS_DELETED=0 and b.STATUS_ACTIVE=1 AND b.IS_DELETED=0 and a.acc_po_status=1 and b.po_break_down_id in($poIds)";
    // echo $sqlAccPo;die();
    $sqlAccPoRes = sql_select($sqlAccPo);
    $accPoArray = array();
    $accPoIDArray = array();
    foreach ($sqlAccPoRes as $val) 
    {
        $accPoArray[$val['PO_BREAK_DOWN_ID']][$val['ACC_PO_NO']][$val['GMTS_ITEM']][$val['GMTS_COLOR_ID']][$val['GMTS_SIZE_ID']]['acc_po_qty'] += $val['ACC_PO_QTY'];
        $accPoArray[$val['PO_BREAK_DOWN_ID']][$val['ACC_PO_NO']][$val['GMTS_ITEM']][$val['GMTS_COLOR_ID']][$val['GMTS_SIZE_ID']]['acc_ship_date'] = $val['ACC_SHIP_DATE'];
        $accPoIDArray[$val['PO_BREAK_DOWN_ID']] .= $val['ACC_PO_NO'].",";
    }

    // =============================== getting backlog ================================
    $toDay = new DateTime('now');
    $backlogDataArray = array();
    foreach ($colorSizeQtyArray as $po_id => $po_data) 
    {
        $cuttingStDate   = $tnaDateArray[$po_id][84]['start_date'];// cutting
        $cuttingEndDate  = $tnaDateArray[$po_id][84]['end_date'];// cutting
        $cuttingAcStDate = $tnaDateArray[$po_id][84]['actual_start_date'];// cutting
        $cuttingAcEndDate= $tnaDateArray[$po_id][84]['actual_finish_date'];// cutting

        $sewingInStDate   = $tnaDateArray[$po_id][122]['start_date'];// sewing
        $sewingInEndDate  = $tnaDateArray[$po_id][122]['end_date'];// sewing
        $sewingInAcStDate = $tnaDateArray[$po_id][122]['actual_start_date'];// sewing
        $sewingInAcEndDate= $tnaDateArray[$po_id][122]['actual_finish_date'];// sewing

        $sewingStDate   = $tnaDateArray[$po_id][86]['start_date'];// sewing
        $sewingEndDate  = $tnaDateArray[$po_id][86]['end_date'];// sewing
        $sewingAcStDate = $tnaDateArray[$po_id][86]['actual_start_date'];// sewing
        $sewingAcEndDate= $tnaDateArray[$po_id][86]['actual_finish_date'];// sewing

        $finishStDate   = $tnaDateArray[$po_id][88]['start_date'];// gmt finish
        $finishEndDate  = $tnaDateArray[$po_id][88]['end_date'];// gmt finish
        $finishAcStDate = $tnaDateArray[$po_id][88]['actual_start_date'];// gmt finish
        $finishAcEndDate= $tnaDateArray[$po_id][88]['actual_finish_date'];// gmt finish

        foreach ($po_data as $itemId => $item_data) 
        {
            foreach ($item_data as $colorId => $color_data) 
            {
                foreach ($color_data as $sizeId => $val) 
                {
                    //============================= CUTTING  =========================    
                    $cuttingQty = $prodDataArray[$itemId][$colorId][$sizeId][1];            
                    $gmtFinBal     = $val['qty'] - $cuttingQty;
                    $cuttingBackLog = 0;
                    $start_date  = new DateTime($cuttingStDate);
                    $end_date    = new DateTime($cuttingEndDate);
                    if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                    {
                        $cuttingBackLog = 0;
                    }
                    elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                    {
                        $cuttingBackLog = $val['qty'] - $cuttingQty;
                    }
                    elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                        $todayDaysDif= $start_date->diff($toDay)->format('%a');

                        $cuttingBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $cuttingQty;
                        // echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$cuttingQty."<br>";
                    }
                    $backlogDataArray[$itemId][$colorId][$sizeId][1] += max(0,$cuttingBackLog); 

                    //============================= SEWING Input =========================    
                    $sewingInQty = $prodDataArray[$itemId][$colorId][$sizeId][4];            
                    $gmtFinBal     = $val['qty'] - $sewingInQty;
                    $sewingInBackLog = 0;
                    $start_date  = new DateTime($sewingInStDate);
                    $end_date    = new DateTime($sewingInEndDate);
                    if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                    {
                        $sewingInBackLog = 0;
                    }
                    elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                    {
                        $sewingInBackLog = $val['qty'] - $sewingInQty;
                    }
                    elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                        $todayDaysDif= $start_date->diff($toDay)->format('%a');

                        $sewingInBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $sewingInQty;
                        //echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$sewingQty."<br>";
                    }
                    $backlogDataArray[$itemId][$colorId][$sizeId][4] += max(0,$sewingInBackLog); 

                    //============================= SEWING Out =========================    
                    $sewingQty = $prodDataArray[$itemId][$colorId][$sizeId][5];            
                    $gmtFinBal     = $val['qty'] - $sewingQty;
                    $sewingBackLog = 0;
                    $start_date  = new DateTime($sewingStDate);
                    $end_date    = new DateTime($sewingEndDate);
                    if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                    {
                        $sewingBackLog = 0;
                    }
                    elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                    {
                        $sewingBackLog = $val['qty'] - $sewingQty;
                    }
                    elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                        $todayDaysDif= $start_date->diff($toDay)->format('%a');

                        $sewingBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $sewingQty;
                        //echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$sewingQty."<br>";
                    }
                    $backlogDataArray[$itemId][$colorId][$sizeId][5] += max(0,$sewingBackLog); 

                    //============================= GMTS FINISH  =========================    
                    $finishQty = $prodDataArray[$itemId][$colorId][$sizeId][8];            
                    $gmtFinBal     = $val['qty'] - $finishQty;
                    $gmtFinBackLog = 0;
                    $start_date  = new DateTime($finishStDate);
                    $end_date    = new DateTime($finishEndDate);
                    if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                    {
                        $gmtFinBackLog = 0;
                    }
                    elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                    {
                        $gmtFinBackLog = $val['qty'] - $finishQty;
                    }
                    elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                        $todayDaysDif= $start_date->diff($toDay)->format('%a');

                        $gmtFinBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $finishQty;
                        //echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$finishQty."<br>";
                    }
                    $backlogDataArray[$itemId][$colorId][$sizeId][8] += max(0,$gmtFinBackLog);   

                    // ============================= ex-factory =================================
                    $accPoIdsArr = array_unique(array_filter(explode(",", $accPoIDArray[$po_id])));
                    // echo "<pre>";print_r($accPoIdsArr);die();
                    $acc_backlog = 0;
                    foreach ($accPoIdsArr as $acc_po_key => $acc_po_val) 
                    {
                        if(strtotime($toDay->format('Y-m-d')) > strtotime($accPoArray[$po_id][$acc_po_val][$itemId][$colorId][$sizeId]['acc_ship_date']))
                        {
                            $acc_backlog += $accPoArray[$po_id][$acc_po_val][$itemId][$colorId][$sizeId]['acc_po_qty'];
                        }

                    }
                    $shiping_backlog = $acc_backlog - $exDataArray[$itemId][$colorId][$sizeId];
                    $backlogDataArray[$itemId][$colorId][$sizeId][0] += max(0,$shiping_backlog);
                }
            }
        }
       
    }
    // echo "<pre>";print_r($backlogDataArray);




    $rowspan_item = array();
    $rowspan_color = array();
    $rowspan_size = array();
    $operation = 0;
    foreach ($dataArray as $item_id => $item_val) 
    { 
        foreach ($item_val as $color_id => $color_val) 
        {
            foreach ($color_val as $size_id => $size_val) 
            {
                $rowspan_item[$item_id]++;
                $rowspan_color[$item_id][$color_id]++;
                $rowspan_size[$item_id][$color_id][$size_id]++;
                $operation++;
            }
        }
    }

    // ====================== clculate running slot blance ===============================
    $running_slot_bal_array = array();
    foreach ($dataArray as $item_id => $item_val) 
    { 
        foreach ($item_val as $color_id => $color_val) 
        {
            foreach ($color_val as $size_id => $size_val) 
            {
                $cutting_qty = $prodDataArray[$item_id][$color_id][$size_id][1];                      
                $tot_cutting_qty = $prodDataArray[$item_id][$color_id][$size_id][1];                     
                $sewing_in_qty = $prodDataArray[$item_id][$color_id][$size_id][4];                      
                $tot_sewing_in_qty = $prodDataArray[$item_id][$color_id][$size_id][4];                        
                $sewing_qty = $prodDataArray[$item_id][$color_id][$size_id][5];                      
                $tot_sewing_qty = $prodDataArray[$item_id][$color_id][$size_id][5];                      
                $finish_qty = $prodDataArray[$item_id][$color_id][$size_id][8];                      
                $tot_finish_qty = $prodDataArray[$item_id][$color_id][$size_id][8];                      
                $ex_factory_qty = $exDataArray[$item_id][$color_id][$size_id];                
                $tot_ex_factory_qty = $exDataArray[$item_id][$color_id][$size_id];                
                
                $cutting_slot = 0;
                $sewing_in_slot = 0;
                $sewing_slot = 0;
                $finish_slot = 0;
                $ex_factory_slot = 0;
                foreach ($shipDateArray as $dtkey => $dtlue) 
                {
                    if($size_val[$dtkey]>0)
                    {
                        if ($cutting_qty>0) 
                        {
                            $cutting_slot += $size_val[$dtkey];
                            $cutting_qty -= $size_val[$dtkey];
                        }
                        if ($sewing_in_qty>0) 
                        {
                            $sewing_in_slot += $size_val[$dtkey];
                            $sewing_in_qty -= $size_val[$dtkey];
                        }
                        if ($sewing_qty>0) 
                        {
                            $sewing_slot += $size_val[$dtkey];
                            $sewing_qty -= $size_val[$dtkey];
                        }
                        if ($finish_qty>0) 
                        {
                            $finish_slot += $size_val[$dtkey];
                            $finish_qty -= $size_val[$dtkey];
                        }
                        if ($ex_factory_qty>0) 
                        {
                            $ex_factory_slot += $size_val[$dtkey];
                            $ex_factory_qty -= $size_val[$dtkey];
                        }
                    }
                    
                }
                $running_slot_bal_array[$item_id][$color_id][$size_id][1] += $cutting_slot - $tot_cutting_qty;
                $running_slot_bal_array[$item_id][$color_id][$size_id][4] += $sewing_in_slot - $tot_sewing_in_qty;
                $running_slot_bal_array[$item_id][$color_id][$size_id][5] += $sewing_slot - $tot_sewing_qty;
                $running_slot_bal_array[$item_id][$color_id][$size_id][8] += $finish_slot - $tot_finish_qty;
                $running_slot_bal_array[$item_id][$color_id][$size_id][0] += $ex_factory_slot - $tot_ex_factory_qty;
            }
        }
    }
    // echo "<pre>";print_r($running_slot_bal_array);


    $tbl_width = 480+(count($shipDateArray)*50);
    ob_start(); 
    ?>
    <fieldset class="first_part" style="width:<? echo $tbl_width+30;?>px;margin:15px 0;">
        <div id="buyer_wise_details_report">
            <h3>Int Ref. : <?=$int_ref;?>, Style : <?=$style;?></h3>
            <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0">            
                <thead>
                    <tr>
                        <th width="80">Operation</th>
                        <th width="80">Item</th>
                        <th width="80">Color</th>
                        <th width="80">Size</th>
                        <th width="80">Backlog</th>
                        <th width="80">Running Slot Bal</th>
                        <? 
                        foreach ($shipDateArray as $dtkey => $dtlue) 
                        {
                            ?>
                            <th width="50"><?= date('d-M',$dtkey); ?></th>
                            <? 
                        } 
                        ?>
                    </tr>
                </thead>
            </table>
            <div style="max-height: 420px; overflow-y: scroll;width: <? echo $tbl_width+20;?>px;">
                <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0"> 
                    <tbody>
                        <? 
                        /*==================================================================================/
                        /                                       Cutting                                     /
                        /================================================================================= */
                        $i=1;
                        $ship_date_total = array();
                        $chk_size_array = array();
                        foreach ($dataArray as $item_id => $item_val) 
                        { 
                            $itm=0;
                            foreach ($item_val as $color_id => $color_val) 
                            {
                                $clr=0;
                                foreach ($color_val as $size_id => $size_val) 
                                {    
                                    $siz = 0;
                                    if($chk_size_array[$item_id][$color_id][$size_id] !="")
                                    {
                                        $siz = 1;
                                    }
                                    if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";  

                                    $cutting_qty = $prodDataArray[$item_id][$color_id][$size_id][1];                  
                                    ?>
                                    <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                        <? if($i==1){?>
                                        <td rowspan="<?=$operation;?>" valign="middle" width="80" align="left">Cutting</td>
                                        <? } ?>
                                        <? if($itm==0)
                                        {
                                            ?>
                                            <td valign="middle" width="80" rowspan="<?= $rowspan_item[$item_id];?>" align="left"><p><?= substr($garments_item[$item_id],0,15);?></p></td>
                                            <? $itm++;} if($clr==0){?>
                                            <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_color[$item_id][$color_id];?>"><p><?= $color_arr[$color_id];?></p></td>
                                        <? $clr++;} if($siz==0){?>
                                        <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_size[$item_id][$color_id][$size_id];?>"><p><?= $size_arr[$size_id];?></p></td>
                                        <? $siz++;$chk_size_array[$item_id][$color_id][$size_id]='kakku';}?>
                                        <td width="80" align="right"><?= fn_number_format($backlogDataArray[$item_id][$color_id][$size_id][1],0); ?></td>
                                        <td width="80" align="right"><?= $running_slot_bal_array[$item_id][$color_id][$size_id][1];?></td>
                                        <? 
                                        foreach ($shipDateArray as $dtkey => $dtlue) 
                                        {
                                            $tdcolor="white";
                                            if($size_val[$dtkey]>0)
                                            {
                                                if($size_val[$dtkey] <= $cutting_qty)
                                                {
                                                    $tdcolor = "#00d6ff";
                                                }
                                                elseif ($size_val[$dtkey] > $cutting_qty && $cutting_qty>0) 
                                                {
                                                    $tdcolor = "yellow";
                                                }
                                                $cutting_qty -= $size_val[$dtkey];
                                                // echo "<br>";
                                            }
                                            ?>
                                            <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= $size_val[$dtkey]; ?></td>
                                            <? 
                                            $ship_date_total[$dtkey] += $size_val[$dtkey];
                                        }
                                        $i++; 
                                        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                        ?>
                                    </tr>
                                    <?
                                }
                            }
                        } 
                        /*==================================================================================/
                        /                                   sewing input                                    /
                        /================================================================================= */
                        $chk_size_array = array();
                        $j=1;
                        foreach ($dataArray as $item_id => $item_val) 
                        { 
                            $itm=0;
                            foreach ($item_val as $color_id => $color_val) 
                            {
                                $clr=0;
                                foreach ($color_val as $size_id => $size_val) 
                                {    
                                    $siz = 0;
                                    if($chk_size_array[$item_id][$color_id][$size_id] !="")
                                    {
                                        $siz = 1;
                                    }
                                    if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";                     
                                    $sewing_qty = $prodDataArray[$item_id][$color_id][$size_id][4];                     
                                    ?>
                                    <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                        <? if($j==1){?>
                                        <td rowspan="<?=$operation;?>" valign="middle" width="80" align="left">Sewing Input</td>
                                        <? } ?>
                                        <? if($itm==0)
                                        {
                                            ?>
                                            <td valign="middle" width="80" rowspan="<?= $rowspan_item[$item_id];?>" align="left"><p><?= substr($garments_item[$item_id],0,15);?></p></td>
                                            <? $itm++;} if($clr==0){?>
                                            <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_color[$item_id][$color_id];?>"><p><?= $color_arr[$color_id];?></p></td>
                                        <? $clr++;} if($siz==0){?>
                                        <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_size[$item_id][$color_id][$size_id];?>"><p><?= $size_arr[$size_id];?></p></td>
                                        <? $siz++;$chk_size_array[$item_id][$color_id][$size_id]='kakku';}?>
                                        <td width="80" align="right"><?= fn_number_format($backlogDataArray[$item_id][$color_id][$size_id][4],0); ?></td>
                                        <td width="80" align="right"><?= $running_slot_bal_array[$item_id][$color_id][$size_id][4];?></td>
                                        <? 
                                        foreach ($shipDateArray as $dtkey => $dtlue) 
                                        {
                                            $tdcolor="white";
                                            if($size_val[$dtkey]>0)
                                            {
                                                if($size_val[$dtkey] <= $sewing_qty)
                                                {
                                                    $tdcolor = "#00d6ff";
                                                }
                                                elseif ($size_val[$dtkey] > $sewing_qty && $sewing_qty>0) 
                                                {
                                                    $tdcolor = "yellow";
                                                }
                                                $sewing_qty -= $size_val[$dtkey];
                                                // echo "<br>";
                                            }
                                            ?>
                                            <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= $size_val[$dtkey]; ?></td>
                                            <? 
                                            // $ship_date_total[$dtkey] += $size_val[$dtkey];
                                        }
                                        $i++; 
                                        $j++; 
                                        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                        ?>
                                    </tr>
                                    <?
                                }
                            }
                        }
                        /*==================================================================================/
                        /                                   sewing output                                   /
                        /================================================================================= */
                        $chk_size_array = array();
                        $k=1;
                        foreach ($dataArray as $item_id => $item_val) 
                        { 
                            $itm=0;
                            foreach ($item_val as $color_id => $color_val) 
                            {
                                $clr=0;
                                foreach ($color_val as $size_id => $size_val) 
                                {    
                                    $siz = 0;
                                    if($chk_size_array[$item_id][$color_id][$size_id] !="")
                                    {
                                        $siz = 1;
                                    }
                                    if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";                     
                                    $sewing_qty = $prodDataArray[$item_id][$color_id][$size_id][5];                     
                                    ?>
                                    <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                        <? if($k==1){?>
                                        <td rowspan="<?=$operation;?>" valign="middle" width="80" align="left">Sewing Output</td>
                                        <? } ?>
                                        <? if($itm==0)
                                        {
                                            ?>
                                            <td valign="middle" width="80" rowspan="<?= $rowspan_item[$item_id];?>" align="left"><p><?= substr($garments_item[$item_id],0,15);?></p></td>
                                            <? $itm++;} if($clr==0){?>
                                            <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_color[$item_id][$color_id];?>"><p><?= $color_arr[$color_id];?></p></td>
                                        <? $clr++;} if($siz==0){?>
                                        <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_size[$item_id][$color_id][$size_id];?>"><p><?= $size_arr[$size_id];?></p></td>
                                        <? $siz++;$chk_size_array[$item_id][$color_id][$size_id]='kakku';}?>
                                        <td width="80" align="right"><?= fn_number_format($backlogDataArray[$item_id][$color_id][$size_id][5],0); ?></td>
                                        <td width="80" align="right"><?= $running_slot_bal_array[$item_id][$color_id][$size_id][5];?></td>
                                        <? 
                                        foreach ($shipDateArray as $dtkey => $dtlue) 
                                        {
                                            $tdcolor="white";
                                            if($size_val[$dtkey]>0)
                                            {
                                                if($size_val[$dtkey] <= $sewing_qty)
                                                {
                                                    $tdcolor = "#00d6ff";
                                                }
                                                elseif ($size_val[$dtkey] > $sewing_qty && $sewing_qty>0) 
                                                {
                                                    $tdcolor = "yellow";
                                                }
                                                $sewing_qty -= $size_val[$dtkey];
                                                // echo "<br>";
                                            }
                                            ?>
                                            <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= $size_val[$dtkey]; ?></td>
                                            <? 
                                            // $ship_date_total[$dtkey] += $size_val[$dtkey];
                                        }
                                        $i++; 
                                        $k++; 
                                        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                        ?>
                                    </tr>
                                    <?
                                }
                            }
                        }
                        /*==================================================================================/
                        /                                   finishing                                       /
                        /================================================================================= */
                        $chk_size_array = array();
                        $l=1;
                        foreach ($dataArray as $item_id => $item_val) 
                        { 
                            $itm=0;
                            foreach ($item_val as $color_id => $color_val) 
                            {
                                $clr=0;
                                foreach ($color_val as $size_id => $size_val) 
                                {    
                                    $siz = 0;
                                    if($chk_size_array[$item_id][$color_id][$size_id] !="")
                                    {
                                        $siz = 1;
                                    }
                                    if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";                     
                                    $finishing_qty = $prodDataArray[$item_id][$color_id][$size_id][8];                     
                                    ?>
                                    <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                        <? if($l==1){?>
                                        <td rowspan="<?=$operation;?>" valign="middle" width="80" align="left">Finishing</td>
                                        <? } ?>
                                        <? if($itm==0)
                                        {
                                            ?>
                                            <td valign="middle" width="80" rowspan="<?= $rowspan_item[$item_id];?>" align="left"><p><?= substr($garments_item[$item_id],0,15);?></p></td>
                                            <? $itm++;} if($clr==0){?>
                                            <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_color[$item_id][$color_id];?>"><p><?= $color_arr[$color_id];?></p></td>
                                        <? $clr++;} if($siz==0){?>
                                        <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_size[$item_id][$color_id][$size_id];?>"><p><?= $size_arr[$size_id];?></p></td>
                                        <? $siz++;$chk_size_array[$item_id][$color_id][$size_id]='kakku';}?>
                                        <td width="80" align="right"><?= fn_number_format($backlogDataArray[$item_id][$color_id][$size_id][8],0); ?></td>
                                        <td width="80" align="right"><?= $running_slot_bal_array[$item_id][$color_id][$size_id][8];?></td>
                                        <? 
                                        foreach ($shipDateArray as $dtkey => $dtlue) 
                                        {
                                            $tdcolor="white";
                                            if($size_val[$dtkey]>0)
                                            {
                                                if($size_val[$dtkey] <= $finishing_qty)
                                                {
                                                    $tdcolor = "#00d6ff";
                                                }
                                                elseif ($size_val[$dtkey] > $finishing_qty && $finishing_qty>0) 
                                                {
                                                    $tdcolor = "yellow";
                                                }
                                                $finishing_qty -= $size_val[$dtkey];
                                                // echo "<br>";
                                            }
                                            ?>
                                            <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= $size_val[$dtkey]; ?></td>
                                            <? 
                                            // $ship_date_total[$dtkey] += $size_val[$dtkey];
                                        }
                                        $i++; 
                                        $l++; 
                                        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                        ?>
                                    </tr>
                                    <?
                                }
                            }
                        }
                        /*==================================================================================/
                        /                                   ex-factory                                      /
                        /================================================================================= */
                         $chk_size_array = array();
                        $m=1;
                        foreach ($dataArray as $item_id => $item_val) 
                        { 
                            $itm=0;
                            foreach ($item_val as $color_id => $color_val) 
                            {
                                $clr=0;
                                foreach ($color_val as $size_id => $size_val) 
                                {    
                                    $siz = 0;
                                    if($chk_size_array[$item_id][$color_id][$size_id] !="")
                                    {
                                        $siz = 1;
                                    }
                                    if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";                     
                                    $ex_factory_qty = $exDataArray[$item_id][$color_id][$size_id];                     
                                    ?>
                                    <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                        <? if($m==1){?>
                                        <td rowspan="<?=$operation;?>" valign="middle" width="80" align="left">Shipment</td>
                                        <? } ?>
                                        <? if($itm==0)
                                        {
                                            ?>
                                            <td valign="middle" width="80" rowspan="<?= $rowspan_item[$item_id];?>" align="left"><p><?= substr($garments_item[$item_id],0,15);?></p></td>
                                            <? $itm++;} if($clr==0){?>
                                            <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_color[$item_id][$color_id];?>"><p><?= $color_arr[$color_id];?></p></td>
                                        <? $clr++;} if($siz==0){?>
                                        <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_size[$item_id][$color_id][$size_id];?>"><p><?= $size_arr[$size_id];?></p></td>
                                        <? $siz++;$chk_size_array[$item_id][$color_id][$size_id]='kakku';}?>
                                        <td width="80" align="right"><?= fn_number_format($backlogDataArray[$item_id][$color_id][$size_id][0],0); ?></td>
                                        <td width="80" align="right"><?= $running_slot_bal_array[$item_id][$color_id][$size_id][0];?></td>
                                        <? 
                                        foreach ($shipDateArray as $dtkey => $dtlue) 
                                        {
                                            $tdcolor="white";
                                            if($size_val[$dtkey]>0)
                                            {
                                                if($size_val[$dtkey] <= $ex_factory_qty)
                                                {
                                                    $tdcolor = "#00d6ff";
                                                }
                                                elseif ($size_val[$dtkey] > $ex_factory_qty && $ex_factory_qty>0) 
                                                {
                                                    $tdcolor = "yellow";
                                                }
                                                $ex_factory_qty -= $size_val[$dtkey];
                                                // echo "<br>";
                                            }
                                            ?>
                                            <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= $size_val[$dtkey]; ?></td>
                                            <? 
                                            // $ship_date_total[$dtkey] += $size_val[$dtkey];
                                        }
                                        $i++; 
                                        $m++; 
                                        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                        ?>
                                    </tr>
                                    <?
                                }
                            }
                        }
                        ?>
                    </tbody>
                </table>   
            </div>  
            <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0"> 
                <tfoot>
                    <tr>
                        <th width="80"></th>
                        <th width="80"></th>
                        <th width="80"></th>
                        <th width="80"></th>
                        <th width="80"></th>
                        <th width="80">Total</th>
                        <? 
                        foreach ($shipDateArray as $dtkey => $dtlue) 
                        {
                            ?>
                            <th width="50"><?= $ship_date_total[$dtkey]; ?></th>
                            <? 
                        } 
                        ?>
                    </tr>
                </tfoot>
            </table>
        </div>    
    </fieldset>
    <?
    unset($main_array);
    unset($dataArray);
    unset($shipDateArray);
    /*$html = ob_get_contents();
    ob_clean();
    foreach (glob("$user_id*.xls") as $filename) {
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');    
    $is_created = fwrite($create_new_doc, $html);
    echo "$html####$filename"; */
    exit();

}

if($action == "report_generate_by_fab_stucture")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $po_id   = str_replace("'","",$po_id);
    $int_ref   = str_replace("'","",$int_ref);
    $client_id   = str_replace("'","",$client_id);
    $style   = str_replace("'","",$style);

    // $intref = explode(".", $intref);
    if($client_id !=0) $client_cond=" and a.client_id=$client_id";
    if($int_ref !=0) $int_ref_cond=" and b.grouping='$int_ref'";

    $color_arr=return_library_array( "select id, color_name from lib_color",'id','color_name');
    $size_arr=return_library_array( "select id,size_name from lib_size",'id','size_name');
    
    // ============================================= main query ============================================
    $sql = "SELECT a.buyer_name as BUYER_NAME, a.style_ref_no as STYLE_REF_NO,b.id as PO_ID, b.grouping as GROUPING,  d.po_qty as ACC_PO_QTY, c.acc_ship_date as  ACC_SHIP_DATE, extract(day from c.acc_ship_date) as SHIP_DATE,  d.gmts_item as GMTS_ITEM,d.GMTS_COLOR_ID,d.GMTS_SIZE_ID  from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join wo_po_acc_po_info c on b.id=c.po_break_down_id join WO_PO_ACC_PO_INFO_DTLS d on c.id=d.mst_id  where b.shiping_status in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and c.acc_ship_date IS NOT NULL and d.gmts_item <> 0 and c.acc_po_status=1 $client_cond $int_ref_cond order by c.acc_ship_date ASC";//and c.gmts_color_id <> 0 and c.gmts_size_id <> 0 
    // echo $sql;
    $res = sql_select($sql);
    $dataArray = array();
    $shipDateArray = array();
    $poArray = array();
    foreach ($res as $val) 
    {
        $poArray[$val['PO_ID']] = $val['PO_ID'];
        $dataArray[$val['GMTS_ITEM']][$val['GMTS_COLOR_ID']][$val['GMTS_SIZE_ID']][strtotime($val['ACC_SHIP_DATE'])]['acc_po_qty'] += $val['ACC_PO_QTY'];
        $dataArray[$val['GMTS_ITEM']][$val['GMTS_COLOR_ID']][$val['GMTS_SIZE_ID']]['color_id'] = $val['GMTS_COLOR_ID'];
        $shipDateArray[strtotime($val['ACC_SHIP_DATE'])] = strtotime($val['ACC_SHIP_DATE']);
    }
    unset($res);
    // echo "<pre>";print_r($dataArray);die();
    $poIds = implode(",", $poArray);
    // ============================================ production qty ==============================================
    $sql = "SELECT a.production_type as PROD_TYPE, sum(b.production_qnty) as QTY, c.item_number_id as ITEM_ID,c.color_number_id as COLOR_ID,c.size_number_id as SIZE_ID from pro_garments_production_mst a, pro_garments_production_dtls b, wo_po_color_size_breakdown c where a.id=b.mst_id and a.po_break_down_id=c.po_break_down_id and c.id=b.color_size_break_down_id and a.item_number_id=c.item_number_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and a.production_type in(1,4,5,8) and a.po_break_down_id in($poIds) group by a.production_type,c.item_number_id,c.color_number_id,c.size_number_id";
    // echo $sql;
    $res = sql_select($sql);
    $prodDataArray = array();
    foreach ($res as $val) 
    {
        $prodDataArray[$val['ITEM_ID']][$val['COLOR_ID']][$val['SIZE_ID']][$val['PROD_TYPE']] += $val['QTY'];
    }
    if($_SESSION['logic_erp']['user_id'] == 1)
    {
        //echo "<pre>";print_r($prodDataArray);
    }
    
    unset($res);
    // ============================================ ex-factory qty ==============================================
    $sql = "SELECT sum(b.production_qnty) as QTY, c.item_number_id as ITEM_ID,c.color_number_id as COLOR_ID,c.size_number_id as SIZE_ID from pro_ex_factory_mst a, pro_ex_factory_dtls b, wo_po_color_size_breakdown c where a.id=b.mst_id and a.po_break_down_id=c.po_break_down_id and c.id=b.color_size_break_down_id and a.item_number_id=c.item_number_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and a.po_break_down_id in($poIds) group by c.item_number_id,c.color_number_id,c.size_number_id";
    // echo $sql;
    $res = sql_select($sql);
    $exDataArray = array();
    foreach ($res as $val) 
    {
        $exDataArray[$val['ITEM_ID']][$val['COLOR_ID']][$val['SIZE_ID']] += $val['QTY'];
    }
    // echo "<pre>";print_r($exDataArray);
    unset($res);

    // ======================================= TNA DATA  ==================================
    $poIdsCondTna = str_replace("po_break_down_id", "A.PO_NUMBER_ID", $poIdsCond);
    $sqltna = "SELECT A.PO_NUMBER_ID,A.TASK_NUMBER,MAX(A.TASK_START_DATE) AS START_DATE,MAX(A.TASK_FINISH_DATE) AS END_DATE,MAX(A.ACTUAL_START_DATE) AS ACTUAL_START_DATE,MAX(A.ACTUAL_FINISH_DATE) AS ACTUAL_FINISH_DATE FROM TNA_PROCESS_MST A,WO_PO_BREAK_DOWN B WHERE A.PO_NUMBER_ID=B.ID AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.PO_QUANTITY>0 and A.PO_NUMBER_ID in($poIds) AND A.TASK_TYPE=1 and a.task_number in(84,86,88,122) group by A.PO_NUMBER_ID,A.TASK_NUMBER";
    // echo $sqltna;die();
    $tnaRes = sql_select($sqltna);
    $tnaDateArray = array();
    foreach ($tnaRes as $val) 
    {
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['start_date']          = $val['START_DATE'];
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['end_date']            = $val['END_DATE'];
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_start_date']   = $val['ACTUAL_START_DATE'];
        $tnaDateArray[$val['PO_NUMBER_ID']][$val['TASK_NUMBER']]['actual_finish_date']  = $val['ACTUAL_FINISH_DATE'];
    }

    // ================================== color size qty ======================
    $sql = "SELECT b.id as PO_ID,c.item_number_id as ITEM_ID,c.color_number_id as COLOR_ID,c.size_number_id as SIZE_ID,sum(c.order_quantity) as QTY from wo_po_details_master a, wo_po_break_down b , wo_po_color_size_breakdown c where a.id=b.job_id and b.id=c.po_break_down_id and a.id=c.job_id and b.id in($poIds) $int_ref_cond group by b.id,c.item_number_id,c.color_number_id,c.size_number_id";
    // echo $sql;
    $res = sql_select($sql);
    $colorSizeQtyArray = array();
    foreach ($res as $val) 
    {
        $colorSizeQtyArray[$val['PO_ID']][$val['ITEM_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['qty'] += $val['QTY'];
    }
    // print_r( $colorSizeQtyArray);

    // ======================================= Actual PO Info ==================================
    $sqlAccPo = "SELECT b.PO_BREAK_DOWN_ID,a.ACC_PO_NO,b.po_qty as ACC_PO_QTY,a.ACC_SHIP_DATE,b.GMTS_ITEM,b.GMTS_COLOR_ID,b.GMTS_SIZE_ID FROM WO_PO_ACC_PO_INFO a,WO_PO_ACC_PO_INFO_DTLS b WHERE a.id=b.mst_id and a.STATUS_ACTIVE=1 AND a.IS_DELETED=0 and b.STATUS_ACTIVE=1 AND b.IS_DELETED=0 and a.acc_po_status=1 and b.po_break_down_id in($poIds)";
    // echo $sqlAccPo;die();
    $sqlAccPoRes = sql_select($sqlAccPo);
    $accPoArray = array();
    $accPoIDArray = array();
    foreach ($sqlAccPoRes as $val) 
    {
        $accPoArray[$val['PO_BREAK_DOWN_ID']][$val['ACC_PO_NO']][$val['GMTS_ITEM']][$val['GMTS_COLOR_ID']][$val['GMTS_SIZE_ID']]['acc_po_qty'] += $val['ACC_PO_QTY'];
        $accPoArray[$val['PO_BREAK_DOWN_ID']][$val['ACC_PO_NO']][$val['GMTS_ITEM']][$val['GMTS_COLOR_ID']][$val['GMTS_SIZE_ID']]['acc_ship_date'] = $val['ACC_SHIP_DATE'];
        $accPoIDArray[$val['PO_BREAK_DOWN_ID']] .= $val['ACC_PO_NO'].",";
    }

    // =============================== getting backlog ================================
    $toDay = new DateTime('now');
    $backlogDataArray = array();
    foreach ($colorSizeQtyArray as $po_id => $po_data) 
    {
        $cuttingStDate   = $tnaDateArray[$po_id][84]['start_date'];// cutting
        $cuttingEndDate  = $tnaDateArray[$po_id][84]['end_date'];// cutting
        $cuttingAcStDate = $tnaDateArray[$po_id][84]['actual_start_date'];// cutting
        $cuttingAcEndDate= $tnaDateArray[$po_id][84]['actual_finish_date'];// cutting

        $sewingInStDate   = $tnaDateArray[$po_id][122]['start_date'];// sewing
        $sewingInEndDate  = $tnaDateArray[$po_id][122]['end_date'];// sewing
        $sewingInAcStDate = $tnaDateArray[$po_id][122]['actual_start_date'];// sewing
        $sewingInAcEndDate= $tnaDateArray[$po_id][122]['actual_finish_date'];// sewing

        $sewingStDate   = $tnaDateArray[$po_id][86]['start_date'];// sewing
        $sewingEndDate  = $tnaDateArray[$po_id][86]['end_date'];// sewing
        $sewingAcStDate = $tnaDateArray[$po_id][86]['actual_start_date'];// sewing
        $sewingAcEndDate= $tnaDateArray[$po_id][86]['actual_finish_date'];// sewing

        $finishStDate   = $tnaDateArray[$po_id][88]['start_date'];// gmt finish
        $finishEndDate  = $tnaDateArray[$po_id][88]['end_date'];// gmt finish
        $finishAcStDate = $tnaDateArray[$po_id][88]['actual_start_date'];// gmt finish
        $finishAcEndDate= $tnaDateArray[$po_id][88]['actual_finish_date'];// gmt finish

        foreach ($po_data as $itemId => $item_data) 
        {
            foreach ($item_data as $colorId => $color_data) 
            {
                foreach ($color_data as $sizeId => $val) 
                {
                    //============================= CUTTING  =========================    
                    $cuttingQty = $prodDataArray[$itemId][$colorId][$sizeId][1];            
                    $gmtFinBal     = $val['qty'] - $cuttingQty;
                    $cuttingBackLog = 0;
                    $start_date  = new DateTime($cuttingStDate);
                    $end_date    = new DateTime($cuttingEndDate);
                    if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                    {
                        $cuttingBackLog = 0;
                    }
                    elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                    {
                        $cuttingBackLog = $val['qty'] - $cuttingQty;
                    }
                    elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                        $todayDaysDif= $start_date->diff($toDay)->format('%a');

                        $cuttingBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $cuttingQty;
                        // echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$cuttingQty."<br>";
                    }
                    $backlogDataArray[$itemId][$colorId][$sizeId][1] += max(0,$cuttingBackLog); 

                    //============================= SEWING Input =========================    
                    $sewingInQty = $prodDataArray[$itemId][$colorId][$sizeId][4];            
                    $gmtFinBal     = $val['qty'] - $sewingInQty;
                    $sewingInBackLog = 0;
                    $start_date  = new DateTime($sewingInStDate);
                    $end_date    = new DateTime($sewingInEndDate);
                    if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                    {
                        $sewingInBackLog = 0;
                    }
                    elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                    {
                        $sewingInBackLog = $val['qty'] - $sewingInQty;
                    }
                    elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                        $todayDaysDif= $start_date->diff($toDay)->format('%a');

                        $sewingInBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $sewingInQty;
                        //echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$sewingQty."<br>";
                    }
                    $backlogDataArray[$itemId][$colorId][$sizeId][4] += max(0,$sewingInBackLog); 

                    //============================= SEWING Out =========================    
                    $sewingQty = $prodDataArray[$itemId][$colorId][$sizeId][5];            
                    $gmtFinBal     = $val['qty'] - $sewingQty;
                    $sewingBackLog = 0;
                    $start_date  = new DateTime($sewingStDate);
                    $end_date    = new DateTime($sewingEndDate);
                    if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                    {
                        $sewingBackLog = 0;
                    }
                    elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                    {
                        $sewingBackLog = $val['qty'] - $sewingQty;
                    }
                    elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                        $todayDaysDif= $start_date->diff($toDay)->format('%a');

                        $sewingBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $sewingQty;
                        //echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$sewingQty."<br>";
                    }
                    $backlogDataArray[$itemId][$colorId][$sizeId][5] += max(0,$sewingBackLog); 

                    //============================= GMTS FINISH  =========================    
                    $finishQty = $prodDataArray[$itemId][$colorId][$sizeId][8];            
                    $gmtFinBal     = $val['qty'] - $finishQty;
                    $gmtFinBackLog = 0;
                    $start_date  = new DateTime($finishStDate);
                    $end_date    = new DateTime($finishEndDate);
                    if($toDay->format('Y-m-d') <= $start_date->format('Y-m-d'))
                    {
                        $gmtFinBackLog = 0;
                    }
                    elseif($toDay->format('Y-m-d') > $end_date->format('Y-m-d'))
                    {
                        $gmtFinBackLog = $val['qty'] - $finishQty;
                    }
                    elseif ($toDay->format('Y-m-d') > $start_date->format('Y-m-d') && $toDay->format('Y-m-d') <= $end_date->format('Y-m-d')) 
                    {
                        $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;

                        $todayDaysDif= $start_date->diff($toDay)->format('%a');

                        $gmtFinBackLog = (($val['qty']/$tnaDaysDif)*$todayDaysDif) - $finishQty;
                        //echo ".((".$val['qty']."/".$tnaDaysDif.")*".$todayDaysDif.") - ".$finishQty."<br>";
                    }
                    $backlogDataArray[$itemId][$colorId][$sizeId][8] += max(0,$gmtFinBackLog);   

                    // ============================= ex-factory =================================
                    $accPoIdsArr = array_unique(array_filter(explode(",", $accPoIDArray[$po_id])));
                    // echo "<pre>";print_r($accPoIdsArr);die();
                    $acc_backlog = 0;
                    foreach ($accPoIdsArr as $acc_po_key => $acc_po_val) 
                    {
                        if(strtotime($toDay->format('Y-m-d')) > strtotime($accPoArray[$po_id][$acc_po_val][$itemId][$colorId][$sizeId]['acc_ship_date']))
                        {
                            $acc_backlog += $accPoArray[$po_id][$acc_po_val][$itemId][$colorId][$sizeId]['acc_po_qty'];
                        }

                    }
                    $shiping_backlog = $acc_backlog - $exDataArray[$itemId][$colorId][$sizeId];
                    $backlogDataArray[$itemId][$colorId][$sizeId][0] += max(0,$shiping_backlog);
                }
            }
        }
       
    }
    // echo "<pre>";print_r($backlogDataArray);




    $rowspan_item = array();
    $rowspan_color = array();
    $rowspan_size = array();
    $operation = 0;
    foreach ($dataArray as $item_id => $item_val) 
    { 
        foreach ($item_val as $color_name => $color_val) 
        {
            foreach ($color_val as $size_id => $size_val) 
            {
                $color_id = $size_val['color_id'];
                $rowspan_item[$item_id]++;
                $rowspan_color[$item_id][$color_id]++;
                $rowspan_size[$item_id][$color_id][$size_id]++;
                $operation++;
            }
        }
    }
    // echo "<pre>";print_r($rowspan_color);die();
    // ====================== clculate running slot blance ===============================
    $running_slot_bal_array = array();
    foreach ($dataArray as $item_id => $item_val) 
    { 
        foreach ($item_val as $color_id => $color_val) 
        {
            foreach ($color_val as $size_id => $size_val) 
            {
                if($_SESSION['logic_erp']['user_id'] == 1)
                {
                    //echo "<pre>".$item_id."__".$color_id."__".$size_id."=>".$prodDataArray[$item_id][$color_id][$size_id][1]."</pre>";
                }
                $cutting_qty = $prodDataArray[$item_id][$color_id][$size_id][1];                      
                $tot_cutting_qty = $prodDataArray[$item_id][$color_id][$size_id][1];                     
                $sewing_in_qty = $prodDataArray[$item_id][$color_id][$size_id][4];                      
                $tot_sewing_in_qty = $prodDataArray[$item_id][$color_id][$size_id][4];                        
                $sewing_qty = $prodDataArray[$item_id][$color_id][$size_id][5];                      
                $tot_sewing_qty = $prodDataArray[$item_id][$color_id][$size_id][5];                      
                $finish_qty = $prodDataArray[$item_id][$color_id][$size_id][8];                      
                $tot_finish_qty = $prodDataArray[$item_id][$color_id][$size_id][8];                      
                $ex_factory_qty = $exDataArray[$item_id][$color_id][$size_id];                
                $tot_ex_factory_qty = $exDataArray[$item_id][$color_id][$size_id];                
                
                $cutting_slot = 0;
                $sewing_in_slot = 0;
                $sewing_slot = 0;
                $finish_slot = 0;
                $ex_factory_slot = 0;
                
                foreach ($shipDateArray as $dtkey => $dtlue) 
                {
                    if($size_val[$dtkey]['acc_po_qty']>0)
                    {
                        if ($cutting_qty>0) 
                        {
                            $cutting_slot += $size_val[$dtkey]['acc_po_qty'];
                            $cutting_qty -= $size_val[$dtkey]['acc_po_qty'];
                            
                        }
                        if ($sewing_in_qty>0) 
                        {
                            $sewing_in_slot += $size_val[$dtkey]['acc_po_qty'];
                            $sewing_in_qty -= $size_val[$dtkey]['acc_po_qty'];
                        }
                        if ($sewing_qty>0) 
                        {
                            $sewing_slot += $size_val[$dtkey]['acc_po_qty'];
                            $sewing_qty -= $size_val[$dtkey]['acc_po_qty'];
                        }
                        if ($finish_qty>0) 
                        {
                            $finish_slot += $size_val[$dtkey]['acc_po_qty'];
                            $finish_qty -= $size_val[$dtkey]['acc_po_qty'];
                        }
                        if ($ex_factory_qty>0) 
                        {
                            $ex_factory_slot += $size_val[$dtkey]['acc_po_qty'];
                            $ex_factory_qty -= $size_val[$dtkey]['acc_po_qty'];
                        }
                    }
                    
                }
                $running_slot_bal_array[$item_id][$color_id][$size_id][1] += $cutting_slot - $tot_cutting_qty;
                $running_slot_bal_array[$item_id][$color_id][$size_id][4] += $sewing_in_slot - $tot_sewing_in_qty;
                $running_slot_bal_array[$item_id][$color_id][$size_id][5] += $sewing_slot - $tot_sewing_qty;
                $running_slot_bal_array[$item_id][$color_id][$size_id][8] += $finish_slot - $tot_finish_qty;
                $running_slot_bal_array[$item_id][$color_id][$size_id][0] += $ex_factory_slot - $tot_ex_factory_qty;
            }
        }
    }
    // echo "<pre>";print_r($running_slot_bal_array);


    $tbl_width = 480+(count($shipDateArray)*50);
    ob_start(); 
    ?>
    <fieldset class="first_part" style="width:<? echo $tbl_width+30;?>px;margin:15px 0;">
        <div id="buyer_wise_details_report">
            <h3>Int Ref. : <?=$int_ref;?>, Style : <?=$style;?></h3>
            <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0">            
                <thead>
                    <tr>
                        <th width="80">Operation</th>
                        <th width="80">Item</th>
                        <th width="80">Color</th>
                        <th width="80">Size</th>
                        <th width="80">Backlog</th>
                        <th width="80">Running Slot Bal</th>
                        <? 
                        foreach ($shipDateArray as $dtkey => $dtlue) 
                        {
                            ?>
                            <th width="50"><?= date('d-M',$dtkey); ?></th>
                            <? 
                        } 
                        ?>
                    </tr>
                </thead>
            </table>
            <div style="max-height: 420px; overflow-y: scroll;width: <? echo $tbl_width+20;?>px;">
                <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0"> 
                    <tbody>
                        <? 
                        /*==================================================================================/
                        /                                       Cutting                                     /
                        /================================================================================= */
                        $i=1;
                        $ship_date_total = array();
                        $chk_size_array = array();
                        foreach ($dataArray as $item_id => $item_val) 
                        { 
                            $itm=0;
                            ksort($item_val);
                            foreach ($item_val as $color_name => $color_val) 
                            {
                                $clr=0;
                                foreach ($color_val as $size_id => $size_val) 
                                {  
                                    $color_id = $size_val['color_id'];  
                                    $siz = 0;
                                    if($chk_size_array[$item_id][$color_id][$size_id] !="")
                                    {
                                        $siz = 1;
                                    }
                                    if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";  

                                    $cutting_qty = $prodDataArray[$item_id][$color_id][$size_id][1];                  
                                    ?>
                                    <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                        <? if($i==1){?>
                                        <td rowspan="<?=$operation;?>" valign="middle" width="80" align="left">Cutting</td>
                                        <? } ?>
                                        <? if($itm==0)
                                        {
                                            ?>
                                            <td valign="middle" width="80" rowspan="<?= $rowspan_item[$item_id];?>" align="left"><p><?= substr($garments_item[$item_id],0,15);?></p></td>
                                            <? $itm++;} if($clr==0){?>
                                            <td title="<?=$color_arr[$color_id];?>" width="80" align="left" valign="middle" rowspan="<?= $rowspan_color[$item_id][$color_id];?>"><p><?=substr($color_arr[$color_id],0,11);?></p></td>
                                        <? $clr++;} if($siz==0){?>
                                        <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_size[$item_id][$color_id][$size_id];?>"><p><?= $size_arr[$size_id];?></p></td>
                                        <? $siz++;$chk_size_array[$item_id][$color_id][$size_id]='kakku';}?>
                                        <td width="80" align="right"><?= fn_number_format($backlogDataArray[$item_id][$color_id][$size_id][1],0); ?></td>
                                        <td width="80" align="right" title="Cut = <?=$prodDataArray[$item_id][$color_id][$size_id][1];?>"><?= $running_slot_bal_array[$item_id][$color_id][$size_id][1];?></td>
                                        <? 
                                        foreach ($shipDateArray as $dtkey => $dtlue) 
                                        {
                                            $tdcolor="white";
                                            if($size_val[$dtkey]['acc_po_qty']>0)
                                            {
                                                if($size_val[$dtkey]['acc_po_qty'] <= $cutting_qty)
                                                {
                                                    $tdcolor = "#00d6ff";
                                                }
                                                elseif ($size_val[$dtkey]['acc_po_qty'] > $cutting_qty && $cutting_qty>0) 
                                                {
                                                    $tdcolor = "yellow";
                                                }
                                                $cutting_qty -= $size_val[$dtkey]['acc_po_qty'];
                                                // echo "<br>";
                                            }
                                            ?>
                                            <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= $size_val[$dtkey]['acc_po_qty']; ?></td>
                                            <? 
                                            $ship_date_total[$dtkey] += $size_val[$dtkey]['acc_po_qty'];
                                        }
                                        $i++; 
                                        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                        ?>
                                    </tr>
                                    <?
                                }
                            }
                        } 
                        /*==================================================================================/
                        /                                   sewing input                                    /
                        /================================================================================= */
                        $chk_size_array = array();
                        $j=1;
                        foreach ($dataArray as $item_id => $item_val) 
                        { 
                            ksort($item_val);
                            $itm=0;
                            foreach ($item_val as $color_name => $color_val) 
                            {
                                $clr=0;
                                foreach ($color_val as $size_id => $size_val) 
                                {    
                                    $color_id = $size_val['color_id'];
                                    $siz = 0;
                                    if($chk_size_array[$item_id][$color_id][$size_id] !="")
                                    {
                                        $siz = 1;
                                    }
                                    if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";                     
                                    $sewing_qty = $prodDataArray[$item_id][$color_id][$size_id][4];                     
                                    ?>
                                    <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                        <? if($j==1){?>
                                        <td rowspan="<?=$operation;?>" valign="middle" width="80" align="left">Sewing Input</td>
                                        <? } ?>
                                        <? if($itm==0)
                                        {
                                            ?>
                                            <td valign="middle" width="80" rowspan="<?= $rowspan_item[$item_id];?>" align="left"><p><?= substr($garments_item[$item_id],0,15);?></p></td>
                                            <? $itm++;} if($clr==0){?>
                                            <td title="<?=$color_arr[$color_id];?>" width="80" align="left" valign="middle" rowspan="<?= $rowspan_color[$item_id][$color_id];?>"><p><?=substr($color_arr[$color_id],0,11);?></p></td>
                                        <? $clr++;} if($siz==0){?>
                                        <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_size[$item_id][$color_id][$size_id];?>"><p><?= $size_arr[$size_id];?></p></td>
                                        <? $siz++;$chk_size_array[$item_id][$color_id][$size_id]='kakku';}?>
                                        <td width="80" align="right"><?= fn_number_format($backlogDataArray[$item_id][$color_id][$size_id][4],0); ?></td>
                                        <td width="80" align="right" title="Sew In = <?=$prodDataArray[$item_id][$color_id][$size_id][4];?>"><?= $running_slot_bal_array[$item_id][$color_id][$size_id][4];?></td>
                                        <? 
                                        foreach ($shipDateArray as $dtkey => $dtlue) 
                                        {
                                            $tdcolor="white";
                                            if($size_val[$dtkey]['acc_po_qty']>0)
                                            {
                                                if($size_val[$dtkey]['acc_po_qty'] <= $sewing_qty)
                                                {
                                                    $tdcolor = "#00d6ff";
                                                }
                                                elseif ($size_val[$dtkey]['acc_po_qty'] > $sewing_qty && $sewing_qty>0) 
                                                {
                                                    $tdcolor = "yellow";
                                                }
                                                $sewing_qty -= $size_val[$dtkey]['acc_po_qty'];
                                                // echo "<br>";
                                            }
                                            ?>
                                            <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= $size_val[$dtkey]['acc_po_qty']; ?></td>
                                            <? 
                                            // $ship_date_total[$dtkey] += $size_val[$dtkey];
                                        }
                                        $i++; 
                                        $j++; 
                                        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                        ?>
                                    </tr>
                                    <?
                                }
                            }
                        }
                        /*==================================================================================/
                        /                                   sewing output                                   /
                        /================================================================================= */
                        $chk_size_array = array();
                        $k=1;
                        foreach ($dataArray as $item_id => $item_val) 
                        { 
                            ksort($item_val);
                            $itm=0;
                            foreach ($item_val as $color_name => $color_val) 
                            {
                                $clr=0;
                                foreach ($color_val as $size_id => $size_val) 
                                {    
                                    $color_id = $size_val['color_id'];
                                    $siz = 0;
                                    if($chk_size_array[$item_id][$color_id][$size_id] !="")
                                    {
                                        $siz = 1;
                                    }
                                    if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";                     
                                    $sewing_qty = $prodDataArray[$item_id][$color_id][$size_id][5];                     
                                    ?>
                                    <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                        <? if($k==1){?>
                                        <td rowspan="<?=$operation;?>" valign="middle" width="80" align="left">Sewing Output</td>
                                        <? } ?>
                                        <? if($itm==0)
                                        {
                                            ?>
                                            <td valign="middle" width="80" rowspan="<?= $rowspan_item[$item_id];?>" align="left"><p><?= substr($garments_item[$item_id],0,15);?></p></td>
                                            <? $itm++;} if($clr==0){?>
                                            <td title="<?=$color_arr[$color_id];?>" width="80" align="left" valign="middle" rowspan="<?= $rowspan_color[$item_id][$color_id];?>"><p><?=substr($color_arr[$color_id],0,11);?></p></td>
                                        <? $clr++;} if($siz==0){?>
                                        <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_size[$item_id][$color_id][$size_id];?>"><p><?= $size_arr[$size_id];?></p></td>
                                        <? $siz++;$chk_size_array[$item_id][$color_id][$size_id]='kakku';}?>
                                        <td width="80" align="right"><?= fn_number_format($backlogDataArray[$item_id][$color_id][$size_id][5],0); ?></td>
                                        <td width="80" align="right"  title="Sew Out = <?=$prodDataArray[$item_id][$color_id][$size_id][5];?>"><?= $running_slot_bal_array[$item_id][$color_id][$size_id][5];?></td>
                                        <? 
                                        foreach ($shipDateArray as $dtkey => $dtlue) 
                                        {
                                            $tdcolor="white";
                                            if($size_val[$dtkey]['acc_po_qty']>0)
                                            {
                                                if($size_val[$dtkey]['acc_po_qty'] <= $sewing_qty)
                                                {
                                                    $tdcolor = "#00d6ff";
                                                }
                                                elseif ($size_val[$dtkey]['acc_po_qty'] > $sewing_qty && $sewing_qty>0) 
                                                {
                                                    $tdcolor = "yellow";
                                                }
                                                $sewing_qty -= $size_val[$dtkey]['acc_po_qty'];
                                                // echo "<br>";
                                            }
                                            ?>
                                            <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= $size_val[$dtkey]['acc_po_qty']; ?></td>
                                            <? 
                                            // $ship_date_total[$dtkey] += $size_val[$dtkey];
                                        }
                                        $i++; 
                                        $k++; 
                                        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                        ?>
                                    </tr>
                                    <?
                                }
                            }
                        }
                        /*==================================================================================/
                        /                                   finishing                                       /
                        /================================================================================= */
                        $chk_size_array = array();
                        $l=1;
                        foreach ($dataArray as $item_id => $item_val) 
                        { 
                            ksort($item_val);
                            $itm=0;
                            foreach ($item_val as $color_name => $color_val) 
                            {
                                $clr=0;
                                foreach ($color_val as $size_id => $size_val) 
                                {    
                                    $color_id = $size_val['color_id'];
                                    $siz = 0;
                                    if($chk_size_array[$item_id][$color_id][$size_id] !="")
                                    {
                                        $siz = 1;
                                    }
                                    if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";                     
                                    $finishing_qty = $prodDataArray[$item_id][$color_id][$size_id][8];                     
                                    ?>
                                    <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                        <? if($l==1){?>
                                        <td rowspan="<?=$operation;?>" valign="middle" width="80" align="left">Finishing</td>
                                        <? } ?>
                                        <? if($itm==0)
                                        {
                                            ?>
                                            <td valign="middle" width="80" rowspan="<?= $rowspan_item[$item_id];?>" align="left"><p><?= substr($garments_item[$item_id],0,15);?></p></td>
                                            <? $itm++;} if($clr==0){?>
                                            <td title="<?=$color_arr[$color_id];?>" width="80" align="left" valign="middle" rowspan="<?= $rowspan_color[$item_id][$color_id];?>"><p><?=substr($color_arr[$color_id],0,11);?></p></td>
                                        <? $clr++;} if($siz==0){?>
                                        <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_size[$item_id][$color_id][$size_id];?>"><p><?= $size_arr[$size_id];?></p></td>
                                        <? $siz++;$chk_size_array[$item_id][$color_id][$size_id]='kakku';}?>
                                        <td width="80" align="right"><?= fn_number_format($backlogDataArray[$item_id][$color_id][$size_id][8],0); ?></td>
                                        <td width="80" align="right"  title="Finishing = <?=$prodDataArray[$item_id][$color_id][$size_id][8];?>"><?= $running_slot_bal_array[$item_id][$color_id][$size_id][8];?></td>
                                        <? 
                                        foreach ($shipDateArray as $dtkey => $dtlue) 
                                        {
                                            $tdcolor="white";
                                            if($size_val[$dtkey]['acc_po_qty']>0)
                                            {
                                                if($size_val[$dtkey]['acc_po_qty'] <= $finishing_qty)
                                                {
                                                    $tdcolor = "#00d6ff";
                                                }
                                                elseif ($size_val[$dtkey]['acc_po_qty'] > $finishing_qty && $finishing_qty>0) 
                                                {
                                                    $tdcolor = "yellow";
                                                }
                                                $finishing_qty -= $size_val[$dtkey]['acc_po_qty'];
                                                // echo "<br>";
                                            }
                                            ?>
                                            <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= $size_val[$dtkey]['acc_po_qty']; ?></td>
                                            <? 
                                            // $ship_date_total[$dtkey] += $size_val[$dtkey];
                                        }
                                        $i++; 
                                        $l++; 
                                        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                        ?>
                                    </tr>
                                    <?
                                }
                            }
                        }
                        /*==================================================================================/
                        /                                   ex-factory                                      /
                        /================================================================================= */
                         $chk_size_array = array();
                        $m=1;
                        foreach ($dataArray as $item_id => $item_val) 
                        { 
                            ksort($item_val);
                            $itm=0;
                            foreach ($item_val as $color_name => $color_val) 
                            {
                                $clr=0;
                                foreach ($color_val as $size_id => $size_val) 
                                {    
                                    $color_id = $size_val['color_id']; 
                                    $siz = 0;
                                    if($chk_size_array[$item_id][$color_id][$size_id] !="")
                                    {
                                        $siz = 1;
                                    }
                                    if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";                     
                                    $ex_factory_qty = $exDataArray[$item_id][$color_id][$size_id];                     
                                    ?>
                                    <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                        <? if($m==1){?>
                                        <td rowspan="<?=$operation;?>" valign="middle" width="80" align="left">Shipment</td>
                                        <? } ?>
                                        <? if($itm==0)
                                        {
                                            ?>
                                            <td valign="middle" width="80" rowspan="<?= $rowspan_item[$item_id];?>" align="left"><p><?= substr($garments_item[$item_id],0,15);?></p></td>
                                            <? $itm++;} if($clr==0){?>
                                            <td title="<?=$color_arr[$color_id];?>" width="80" align="left" valign="middle" rowspan="<?= $rowspan_color[$item_id][$color_id];?>"><p><?=substr($color_arr[$color_id],0,11);?></p></td>
                                        <? $clr++;} if($siz==0){?>
                                        <td width="80" align="left" valign="middle" rowspan="<?= $rowspan_size[$item_id][$color_id][$size_id];?>"><p><?= $size_arr[$size_id];?></p></td>
                                        <? $siz++;$chk_size_array[$item_id][$color_id][$size_id]='kakku';}?>
                                        <td width="80" align="right"><?= fn_number_format($backlogDataArray[$item_id][$color_id][$size_id][0],0); ?></td>
                                        <td width="80" align="right"  title="Ex-Factory = <?=$prodDataArray[$item_id][$color_id][$size_id][0];?>" ><?= $running_slot_bal_array[$item_id][$color_id][$size_id][0];?></td>
                                        <? 
                                        foreach ($shipDateArray as $dtkey => $dtlue) 
                                        {
                                            $tdcolor="white";
                                            if($size_val[$dtkey]['acc_po_qty']>0)
                                            {
                                                if($size_val[$dtkey]['acc_po_qty'] <= $ex_factory_qty)
                                                {
                                                    $tdcolor = "#00d6ff";
                                                }
                                                elseif ($size_val[$dtkey]['acc_po_qty'] > $ex_factory_qty && $ex_factory_qty>0) 
                                                {
                                                    $tdcolor = "yellow";
                                                }
                                                $ex_factory_qty -= $size_val[$dtkey]['acc_po_qty'];
                                                // echo "<br>";
                                            }
                                            ?>
                                            <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= $size_val[$dtkey]['acc_po_qty']; ?></td>
                                            <? 
                                            // $ship_date_total[$dtkey] += $size_val[$dtkey];
                                        }
                                        $i++; 
                                        $m++; 
                                        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                        ?>
                                    </tr>
                                    <?
                                }
                            }
                        }
                        ?>
                    </tbody>
                </table>   
            </div>  
            <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0"> 
                <tfoot>
                    <tr>
                        <th width="80"></th>
                        <th width="80"></th>
                        <th width="80"></th>
                        <th width="80"></th>
                        <th width="80"></th>
                        <th width="80">Total</th>
                        <? 
                        foreach ($shipDateArray as $dtkey => $dtlue) 
                        {
                            ?>
                            <th width="50"><?= $ship_date_total[$dtkey]; ?></th>
                            <? 
                        } 
                        ?>
                    </tr>
                </tfoot>
            </table>
        </div>    
    </fieldset>
    <?
    unset($main_array);
    unset($dataArray);
    unset($shipDateArray);
    /*$html = ob_get_contents();
    ob_clean();
    foreach (glob("$user_id*.xls") as $filename) {
    @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename=$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');    
    $is_created = fwrite($create_new_doc, $html);
    echo "$html####$filename"; */
    exit();

}

if($action=="garments_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);
    // ====================================== ITEM AND COLOR ==================================
    $sqlOrder = "SELECT a.style_ref_no as STYLE,b.grouping as INT_REF,c.color_number_id as COLOR_ID,c.item_number_id as ITEM_ID,sum(c.order_quantity) as QTY from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and c.status_active in(1,2) and c.is_deleted=0 and b.id in($poIds) group by a.style_ref_no,b.grouping,c.color_number_id,c.item_number_id";
    //echo $sqlOrder;die();
    $sqlOrderRes = sql_select($sqlOrder);
    $dataArray = array();
    foreach ($sqlOrderRes as $val) 
    {
       $dataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['qty']     += $val['QTY'];
       $dataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['color_id'] = $val['COLOR_ID'];
    }
    //======================================== CUT AND LAY ================================
    $sqlCut = "SELECT b.gmt_item_id as ITEM_ID,b.color_id as COLOR_ID,sum(c.size_qty) as QTY from ppl_cut_lay_mst a,ppl_cut_lay_dtls b,ppl_cut_lay_bundle c where a.id=b.mst_id and b.id=c.dtls_id and a.id=c.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and c.order_id in($poIds) group by b.gmt_item_id,b.color_id ";
    // echo $sqlCut;die();
    $sqlCutRes = sql_select($sqlCut);
    $cutLayArray = array();
    foreach ($sqlCutRes as $val) 
    {
        $cutLayArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]] += $val['QTY'];
    }
    // ======================================= CUTTING QC ============================== 
    $sqlCutQC = "SELECT b.color_id as COLOR_ID ,c.item_number_id as ITEM_ID,sum(b.qc_pass_qty) as QTY,sum(b.replace_qty) as REPLACE_QTY,sum(b.reject_qty) as REJQNTY from pro_gmts_cutting_qc_mst a,pro_gmts_cutting_qc_dtls b,wo_po_color_size_breakdown c where a.id=b.mst_id and b.order_id=c.po_break_down_id and c.id=b.color_size_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active in(1,2) and b.order_id in($poIds) group by b.color_id ,c.item_number_id";
    // echo $sqlCutQC;die();
    $CutQCRes = sql_select($sqlCutQC);
    $cutQcArr = array();
    foreach ($CutQCRes as  $val) 
    {
       $cutQcArr[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['qc_ok']    = $val['QTY'];
       $cutQcArr[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['rej_qty']  = $val['REJQNTY'];
       $cutQcArr[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['rep_qty']  = $val['REPLACE_QTY'];
    }
    //====================================== GMTS PRODUCTION =====================================
    $sqlProd = "SELECT  a.item_number_id as ITEM_ID,c.color_number_id as COLOR_ID, 
    sum(case when a.production_type=1 then b.production_qnty else 0 end) as CUT_QTY,
    sum(case when a.production_type=1 then b.replace_qty else 0 end) as CUT_REPLACE_QTY,
    sum(case when a.production_type=1 then b.reject_qty else 0 end) as CUT_REJECT_QTY,
    sum(case when a.production_type=4 then b.production_qnty else 0 end) as INPUT_QTY, 
    sum(case when a.production_type=5 then b.production_qnty else 0 end) as OUT_QTY, 
    sum(case when a.production_type=5 then b.alter_qty else 0 end) as ALTER_QTY, 
    sum(case when a.production_type=5 then b.spot_qty else 0 end) as SPOT_QTY, 
    sum(case when a.production_type=5 then b.replace_qty else 0 end) as REPLACE_QTY,
    sum(case when a.production_type=5 then b.reject_qty else 0 end) as REJECT_QTY,
    sum(case when a.production_type=8 then b.production_qnty else 0 end) as FINISH_QTY,
    sum(case when a.production_type=8 then b.reject_qty else 0 end) as FIN_REJECT_QTY
    from pro_garments_production_mst a, pro_garments_production_dtls b,wo_po_color_size_breakdown c
    where a.id=b.mst_id and c.id=b.color_size_break_down_id and a.po_break_down_id=c.po_break_down_id and a.status_active=1 and b.status_active=1 and c.status_active in(1,2) and c.is_deleted=0 and a.production_type in(1,2,3,4,5,8) and a.po_break_down_id in($poIds) group by a.item_number_id,c.color_number_id";
    // echo $sqlProd;die();
    $sqlProdRes = sql_select($sqlProd);
    $prodDataArray = array();
    foreach ($sqlProdRes as $val) 
    {
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['cut_qty']      = $val['CUT_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['cut_replace_qty']= $val['CUT_REPLACE_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['cut_reject_qty']= $val['CUT_REJECT_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['input_qty']      = $val['INPUT_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['out_qty']        = $val['OUT_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['alter_qty']      = $val['ALTER_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['spot_qty']       = $val['SPOT_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['replace_qty']    = $val['REPLACE_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['rej_qty']        = $val['REJECT_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['finish_qty']     = $val['FINISH_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['fin_reject_qty'] = $val['FIN_REJECT_QTY'];
    }
    // ====================================== EX-FACTORY DATA ==================================
    $sqlEx = "SELECT c.item_number_id as ITEM_ID,a.color_number_id as COLOR_ID, sum(d.production_qnty) as EX_FACT_QTY from wo_po_color_size_breakdown a, pro_ex_factory_mst c, pro_ex_factory_dtls d, pro_ex_factory_delivery_mst e where c.id=d.mst_id and e.id=c.delivery_mst_id and a.id=d.color_size_break_down_id and a.po_break_down_id=c.po_break_down_id and a.status_active in(1,2) and a.is_deleted=0  and c.status_active=1 and d.status_active=1 and e.status_active=1 and a.po_break_down_id in($poIds) group by c.item_number_id,a.color_number_id"; 
    // echo $sqlEx;die();
    $sqlExRes  = sql_select($sqlEx);
    $exfactArray = array();
    foreach ($sqlExRes as $val) 
    {
        $exfactArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]] += $val['EX_FACT_QTY'];
    }
    //==================================== getting rowspan no =================================
    $rowspan = array();
    foreach ($dataArray as $itemId => $itemData) 
    {
        foreach ($itemData as $colorId => $row) 
        {
            $rowspan[$itemId]++;
        }
    }
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 99%;" id="details_reports">
        <div class="header_part">
            <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="100%">
                <caption><b>Garments Production Details</b></caption>
                <thead>
                    <tr>
                        <td colspan="24" width="100%"><b>Style Name:<? echo $sqlOrderRes[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref:<? echo $sqlOrderRes[0]['INT_REF'];?></b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="main_part" style="width:100%;">
            <div>
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="100%" align="left">
                    <thead>
                        <tr>
                            <th width="6%">Item</th>
                            <th width="6%">Color</th>
                            <th width="4%">Req qty</th>
                            <th width="4%">Lay Cut</th>
                            <th width="4%">Rej Qty</th>
                            <th width="4%">Rep Qty</th>
                            <th width="4%">QC Qty</th>
                            <th width="4%">Cut Bal</th>
                            <th width="4%">Input</th>
                            <th width="4%">Input Bal</th>
                            <th width="4%">Input WIP</th>
                            <th width="4%">Ok Sew</th>
                            <th width="4%">Rej Qty</th>
                            <th width="4%">Rep Qty</th>
                            <th width="4%">TTL Sew</th>
                            <th width="4%">Sew Bal</th>
                            <th width="4%">Sew WIP</th>
                            <th width="4%">Ok Fin</th>
                            <th width="4%">Rej Fin</th>
                            <th width="4%">Fin Bal</th>
                            <th width="4%">Finish WIP</th>
                            <th width="4%">Ship Qty</th>
                            <th width="4%">Ship WIP</th>
                            <th width="4%">Ship Bal</th>
                        </tr>
                    </thead>
                </table>
            </div>
            <div style="width:100%;overflow-y:auto;max-height:350px;" id="scroll_body">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="100%"  align="left">
                    <tbody>
                        <?
                        $i=0;
                        $grnd_req_qty = 0;
                        $grnd_lay_qty = 0;
                        $grnd_rej_qty = 0;
                        $grnd_rep_qty = 0;
                        $grnd_qc_qty = 0;
                        $grnd_cut_bal_qty = 0;
                        $grnd_input_qty = 0;
                        $grnd_input_bal_qty = 0;
                        $grnd_input_wip_qty = 0;
                        $grnd_ok_sew_qty = 0;
                        $grnd_sew_rej_qty = 0;
                        $grnd_sew_rep_qty = 0;
                        $grnd_tot_sew_qty = 0;
                        $grnd_sew_bal_qty = 0;
                        $grnd_sew_wip_qty = 0;
                        $grnd_fin_qty = 0;
                        $grnd_fin_rej_qty = 0;
                        $grnd_fin_bal_qty = 0;
                        $grnd_fin_wip_qty = 0;
                        $grnd_ex_qty = 0;
                        $grnd_ex_wip_qty = 0;
                        $grnd_ex_bal_qty = 0;
                        foreach ($dataArray as $itemId => $itemData) 
                        {
                            $r=0;
                            $item_wise_req_qty = 0;
                            $item_wise_lay_qty = 0;
                            $item_wise_rej_qty = 0;
                            $item_wise_rep_qty = 0;
                            $item_wise_qc_qty = 0;
                            $item_wise_cut_bal_qty = 0;
                            $item_wise_input_qty = 0;
                            $item_wise_input_bal_qty = 0;
                            $item_wise_input_wip_qty = 0;
                            $item_wise_ok_sew_qty = 0;
                            $item_wise_sew_rej_qty = 0;
                            $item_wise_sew_rep_qty = 0;
                            $item_wise_tot_sew_qty = 0;
                            $item_wise_sew_bal_qty = 0;
                            $item_wise_sew_wip_qty = 0;
                            $item_wise_fin_qty = 0;
                            $item_wise_fin_rej_qty = 0;
                            $item_wise_fin_bal_qty = 0;
                            $item_wise_fin_wip_qty = 0;
                            $item_wise_ex_qty = 0;
                            $item_wise_ex_wip_qty = 0;
                            $item_wise_ex_bal_qty = 0;
                            ksort($itemData);
                            foreach ($itemData as $colorName => $row) 
                            {   
                                $layQty     = $cutLayArray[$itemId][$colorName];
                                // $qcQty      = $cutQcArr[$itemId][$colorName]['qc_ok'];
                                // $qcRejQty   = $cutQcArr[$itemId][$colorName]['rej_qty'];
                                // $qcRepQty   = $cutQcArr[$itemId][$colorName]['rep_qty'];
                                $qcQty      = $prodDataArray[$itemId][$colorName]['cut_qty'];
                                $qcRejQty   = $prodDataArray[$itemId][$colorName]['cut_reject_qty'];
                                $qcRepQty   = $prodDataArray[$itemId][$colorName]['cut_replace_qty'];

                                $cutBal     = $row['qty'] - $qcQty;

                                $inputQty   = $prodDataArray[$itemId][$colorName]['input_qty'];
                                $inputBal   = $row['qty'] - $inputQty;
                                $inputWIP   = $qcQty - $inputQty;
                                $outputQty  = $prodDataArray[$itemId][$colorName]['out_qty'];
                                $alterQty   = $prodDataArray[$itemId][$colorName]['alter_qty'];
                                $spotQty    = $prodDataArray[$itemId][$colorName]['spot_qty'];
                                $replaceQty = $prodDataArray[$itemId][$colorName]['replace_qty'];
                                $sewRejQty  = $prodDataArray[$itemId][$colorName]['rej_qty'];
                                $totSewQty  = $outputQty + $sewRejQty;// - $replaceQty;
                                $sewBal     = $row['qty'] - $outputQty;
                                $sewWIP     = $inputQty - $totSewQty;
                                $finQty     = $prodDataArray[$itemId][$colorName]['finish_qty'];
                                $finRejQty  = $prodDataArray[$itemId][$colorName]['fin_reject_qty'];
                                $finBal     = $row['qty'] - $finQty;
                                $finWIP     = $outputQty - ($finQty+$finRejQty);

                                $exfactQty  = $exfactArray[$itemId][$colorName];
                                $exfWIP     = $finQty - $exfactQty;
                                $exfBal     = $row['qty'] - $exfactQty;
                                $colorId    = $row['color_id'];
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                    <? if($r==0){?>
                                    <td width="6%" valign="middle" rowspan="<? echo $rowspan[$itemId];?>"><? echo $garments_item[$itemId]; ?></td>
                                    <?}?>
                                    <td width="6%" title="<?=$colorName;?>">
                                        <a href="javascript:void(0)" onclick="open_gmts_color_popup('<? echo $poIds."_".$itemId."_".$colorId;?>')">
                                            <p><? echo ucwords(substr($colorName,0,11));?></p>
                                        </a>
                                    </td>
                                    <td width="4%" align="right"><? echo fn_number_format($row['qty'],0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($layQty,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($qcRejQty,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($qcRepQty,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($qcQty,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($cutBal,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($inputQty,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($inputBal,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($inputWIP,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($outputQty,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($sewRejQty,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($replaceQty,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($totSewQty,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($sewBal,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($sewWIP,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($finQty,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($finRejQty,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($finBal,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($finWIP,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($exfactQty,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($exfWIP,0);?></td>
                                    <td width="4%" align="right"><? echo fn_number_format($exfBal,0);?></td>
                                </tr>
                                <?
                                $i++;
                                $r++;
                                $item_wise_req_qty += $row['qty'];
                                $item_wise_lay_qty += $layQty;
                                $item_wise_rej_qty += $qcRejQty;
                                $item_wise_rep_qty += $qcRepQty;
                                $item_wise_qc_qty += $qcQty;
                                $item_wise_cut_bal_qty += $cutBal;
                                $item_wise_input_qty += $inputQty;
                                $item_wise_input_bal_qty += $inputBal;
                                $item_wise_input_wip_qty += $inputWIP;
                                $item_wise_ok_sew_qty += $outputQty;
                                $item_wise_sew_rej_qty += $sewRejQty;
                                $item_wise_sew_rep_qty += $replaceQty;
                                $item_wise_tot_sew_qty += $totSewQty;
                                $item_wise_sew_bal_qty += $sewBal;
                                $item_wise_sew_wip_qty += $sewWIP;
                                $item_wise_fin_qty += $finQty;
                                $item_wise_fin_rej_qty += $finRejQty;
                                $item_wise_fin_bal_qty += $finBal;
                                $item_wise_fin_wip_qty += $finWIP;
                                $item_wise_ex_qty += $exfactQty;
                                $item_wise_ex_wip_qty += $exfWIP;
                                $item_wise_ex_bal_qty += $exfBal;

                                $grnd_req_qty += $row['qty'];
                                $grnd_lay_qty += $layQty;
                                $grnd_rej_qty += $qcRejQty;
                                $grnd_rep_qty += $qcRepQty;
                                $grnd_qc_qty += $qcQty;
                                $grnd_cut_bal_qty += $cutBal;
                                $grnd_input_qty += $inputQty;
                                $grnd_input_bal_qty += $inputBal;
                                $grnd_input_wip_qty += $inputWIP;
                                $grnd_ok_sew_qty += $outputQty;
                                $grnd_sew_rej_qty += $sewRejQty;
                                $grnd_sew_rep_qty += $replaceQty;
                                $grnd_tot_sew_qty += $totSewQty;
                                $grnd_sew_bal_qty += $sewBal;
                                $grnd_sew_wip_qty += $sewWIP;
                                $grnd_fin_qty += $finQty;
                                $grnd_fin_rej_qty += $finRejQty;
                                $grnd_fin_bal_qty += $finBal;
                                $grnd_fin_wip_qty += $finWIP;
                                $grnd_ex_qty += $exfactQty;
                                $grnd_ex_wip_qty += $exfWIP;
                                $grnd_ex_bal_qty += $exfBal;
                            }                        
                            ?>
                            <tr>
                                <td colspan="2" align="right"><b>Item Total</b></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_req_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_lay_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_rej_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_rep_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_qc_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_cut_bal_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_input_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_input_bal_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_input_wip_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_ok_sew_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_sew_rej_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_sew_rep_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_tot_sew_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_sew_bal_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_sew_wip_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_fin_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_fin_rej_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_fin_bal_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_fin_wip_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_ex_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_ex_wip_qty,0);?></strong></td>
                                <td align="right"><strong><? echo fn_number_format($item_wise_ex_bal_qty,0);?></strong></td>
                            </tr>
                            <?
                        }
                        ?>
                    </tbody>
                    <tfoot>
                        <th colspan="2" align="right">Grand Total</th>
                        <th align="right"><? echo fn_number_format($grnd_req_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_lay_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_rej_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_rep_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_qc_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_cut_bal_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_input_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_input_bal_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_input_wip_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_ok_sew_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_sew_rej_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_sew_rep_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_tot_sew_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_sew_bal_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_sew_wip_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_fin_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_fin_rej_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_fin_bal_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_fin_wip_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_ex_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_ex_wip_qty,0);?></th>
                        <th align="right"><? echo fn_number_format($grnd_ex_bal_qty,0);?></th>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>   
    <script type="text/javascript">
        function open_gmts_color_popup(data)
        {
            var width = window.innerWidth;
            width = width-30;        
            var action = "color_wise_garments_popup";
            emailwindow = dhtmlmodal.open('EmailBox', 'iframe', 'order_monitoring_report_with_tna_controller.php?data=' + data + '&action=' + action, 'Garments Production Details Popup', 'width='+width+'px,height=350px,center=1,resize=0,scrolling=0', '../../../');
        }
    </script>
    <?
}

if($action=="color_wise_garments_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_size = return_library_array("select id,size_name from lib_size", "id", "size_name");
    extract($_REQUEST);
    $data = str_replace("'", "", $data);
    $dataEx = explode("_", $data);
    $po_break_down_id = $dataEx[0];
    $itemId = $dataEx[1];
    $colorId = $dataEx[2];
    // ====================================== ITEM AND COLOR ==================================
    $sqlOrder = "SELECT a.style_ref_no as STYLE,b.grouping as INT_REF,c.item_number_id as ITEM_ID,c.color_number_id as COLOR_ID,c.size_number_id as SIZE_ID,sum(c.order_quantity) as QTY,c.size_order from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and b.id in($po_break_down_id) and c.item_number_id=$itemId and c.color_number_id=$colorId group by a.style_ref_no,b.grouping,c.size_number_id,c.item_number_id,c.color_number_id,c.size_order order by c.size_order";
    //echo $sqlOrder;die();
    $sqlOrderRes = sql_select($sqlOrder);
    $dataArray = array();
    foreach ($sqlOrderRes as $val) 
    {
       $dataArray[$val['SIZE_ID']]['qty'] += $val['QTY'];
    }
    //======================================== CUT AND LAY ================================
    $sqlCut = "SELECT c.size_id as SIZE_ID,sum(c.size_qty) as QTY from ppl_cut_lay_mst a,ppl_cut_lay_dtls b,ppl_cut_lay_bundle c where a.id=b.mst_id and b.id=c.dtls_id and a.id=c.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and c.order_id in($po_break_down_id) and b.color_id=$colorId and b.gmt_item_id=$itemId group by c.size_id";
    // echo $sqlCut;die();
    $sqlCutRes = sql_select($sqlCut);
    $cutLayArray = array();
    foreach ($sqlCutRes as $val) 
    {
        $cutLayArray[$val['SIZE_ID']] += $val['QTY'];
    }
    // ======================================= CUTTING QC ============================== 
    $sqlCutQC = "SELECT b.size_id as SIZE_ID,sum(b.qc_pass_qty) as QTY,sum(b.replace_qty) as REPLACE_QTY,sum(b.reject_qty) as REJQNTY from pro_gmts_cutting_qc_mst a,pro_gmts_cutting_qc_dtls b,wo_po_color_size_breakdown c where a.id=b.mst_id and b.order_id=c.po_break_down_id and c.id=b.color_size_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active =1 and b.order_id in($po_break_down_id) and b.color_id=$colorId and c.item_number_id=$itemId group by b.size_id";
    // echo $sqlCutQC;die();
    $CutQCRes = sql_select($sqlCutQC);
    $cutQcArr = array();
    foreach ($CutQCRes as  $val) 
    {
       $cutQcArr[$val['SIZE_ID']]['qc_ok']    = $val['QTY'];
       $cutQcArr[$val['SIZE_ID']]['rej_qty']  = $val['REJQNTY'];
       $cutQcArr[$val['SIZE_ID']]['rep_qty']  = $val['REPLACE_QTY'];
    }
    //====================================== GMTS PRODUCTION =====================================
    $sqlProd = "SELECT c.size_number_id as SIZE_ID, 
    sum(case when a.production_type=1 then b.production_qnty else 0 end) as CUT_QTY,
    sum(case when a.production_type=1 then b.reject_qty else 0 end) as CUT_REJECT_QTY,
    sum(case when a.production_type=1 then b.replace_qty else 0 end) as CUT_REPLACE_QTY,
    sum(case when a.production_type=4 then b.production_qnty else 0 end) as INPUT_QTY, 
    sum(case when a.production_type=5 then b.production_qnty else 0 end) as OUT_QTY, 
    sum(case when a.production_type=5 then b.alter_qty else 0 end) as ALTER_QTY, 
    sum(case when a.production_type=5 then b.spot_qty else 0 end) as SPOT_QTY, 
    sum(case when a.production_type=5 then b.replace_qty else 0 end) as REPLACE_QTY,
    sum(case when a.production_type=5 then b.reject_qty else 0 end) as REJECT_QTY,
    sum(case when a.production_type=8 then b.production_qnty else 0 end) as FINISH_QTY,
    sum(case when a.production_type=8 then b.reject_qty else 0 end) as FIN_REJECT_QTY
    from pro_garments_production_mst a, pro_garments_production_dtls b,wo_po_color_size_breakdown c
    where a.id=b.mst_id and c.id=b.color_size_break_down_id and a.po_break_down_id=c.po_break_down_id and a.status_active=1 and b.status_active=1 and a.production_type in(1,2,3,4,5,8) and a.po_break_down_id in($po_break_down_id) and a.item_number_id=$itemId and c.color_number_id=$colorId group by c.size_number_id";
    // echo $sqlProd;die();
    $sqlProdRes = sql_select($sqlProd);
    $prodDataArray = array();
    foreach ($sqlProdRes as $val) 
    {
        $prodDataArray[$val['SIZE_ID']]['cut_qty']          = $val['CUT_QTY'];
        $prodDataArray[$val['SIZE_ID']]['cut_reject_qty']   = $val['CUT_REJECT_QTY'];
        $prodDataArray[$val['SIZE_ID']]['cut_replace_qty']  = $val['CUT_REPLACE_QTY'];
        $prodDataArray[$val['SIZE_ID']]['input_qty']      = $val['INPUT_QTY'];
        $prodDataArray[$val['SIZE_ID']]['out_qty']        = $val['OUT_QTY'];
        $prodDataArray[$val['SIZE_ID']]['alter_qty']      = $val['ALTER_QTY'];
        $prodDataArray[$val['SIZE_ID']]['spot_qty']       = $val['SPOT_QTY'];
        $prodDataArray[$val['SIZE_ID']]['replace_qty']    = $val['REPLACE_QTY'];
        $prodDataArray[$val['SIZE_ID']]['rej_qty']        = $val['REJECT_QTY'];
        $prodDataArray[$val['SIZE_ID']]['finish_qty']     = $val['FINISH_QTY'];
        $prodDataArray[$val['SIZE_ID']]['fin_reject_qty'] = $val['FIN_REJECT_QTY'];
    }
    // ====================================== EX-FACTORY DATA ==================================
    $sqlEx = "SELECT a.size_number_id as SIZE_ID, sum(d.production_qnty) as EX_FACT_QTY from wo_po_color_size_breakdown a, pro_ex_factory_mst c, pro_ex_factory_dtls d, pro_ex_factory_delivery_mst e where c.id=d.mst_id and e.id=c.delivery_mst_id and a.id=d.color_size_break_down_id and a.po_break_down_id=c.po_break_down_id  and c.status_active=1 and d.status_active=1 and e.status_active=1 and a.po_break_down_id in($po_break_down_id) and c.item_number_id=$itemId and a.color_number_id=$colorId group by a.size_number_id"; 
    // echo $sqlEx;die();
    $sqlExRes  = sql_select($sqlEx);
    $exfactArray = array();
    foreach ($sqlExRes as $val) 
    {
        $exfactArray[$val['SIZE_ID']] += $val['EX_FACT_QTY'];
    }
    
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports2').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />

    </div>
    <div class="main" style="width: 100%;" id="details_reports2">
        <div class="header_part">
            <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="100%">
                <caption><b>Garments Production Details</b></caption>
                <thead>
                    <tr>
                        <td colspan="24" width="100%"><b>Style Name :<? echo $sqlOrderRes[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref :<? echo $sqlOrderRes[0]['INT_REF'];?></b>,&nbsp;&nbsp;<b>Item Name :<? echo $garments_item[$itemId];?></b>,&nbsp;&nbsp;<b>Color :<? echo $lib_color[$colorId];?></b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="main_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="100%">
                <thead>
                    <tr>
                        <th width="5.4%">Size</th>
                        <th width="4.3%">Req qty</th>
                        <th width="4.3%">Lay Cut</th>
                        <th width="4.3%">Rej Qty</th>
                        <th width="4.3%">Rep Qty</th>
                        <th width="4.3%">QC Qty</th>
                        <th width="4.3%">Cut Bal</th>
                        <th width="4.3%">Input</th>
                        <th width="4.3%">Input Bal</th>
                        <th width="4.3%">Input WIP</th>
                        <th width="4.3%">Ok Sew</th>
                        <th width="4.3%">Rej Qty</th>
                        <th width="4.3%">Rep Qty</th>
                        <th width="4.3%">TTL Sew</th>
                        <th width="4.3%">Sew Bal</th>
                        <th width="4.3%">Sew WIP</th>
                        <th width="4.3%">Ok Fin</th>
                        <th width="4.3%">Rej Fin</th>
                        <th width="4.3%">Fin Bal</th>
                        <th width="4.3%">Finish WIP</th>
                        <th width="4.3%">Ship Qty</th>
                        <th width="4.3%">Ship WIP</th>
                        <th width="4.3%">Ship Bal</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    $grnd_req_qty = 0;
                    $grnd_lay_qty = 0;
                    $grnd_rej_qty = 0;
                    $grnd_rep_qty = 0;
                    $grnd_qc_qty = 0;
                    $grnd_cut_bal_qty = 0;
                    $grnd_input_qty = 0;
                    $grnd_input_bal_qty = 0;
                    $grnd_input_wip_qty = 0;
                    $grnd_ok_sew_qty = 0;
                    $grnd_sew_rej_qty = 0;
                    $grnd_sew_rep_qty = 0;
                    $grnd_tot_sew_qty = 0;
                    $grnd_sew_bal_qty = 0;
                    $grnd_sew_wip_qty = 0;
                    $grnd_fin_qty = 0;
                    $grnd_fin_rej_qty = 0;
                    $grnd_fin_bal_qty = 0;
                    $grnd_fin_wip_qty = 0;
                    $grnd_ex_qty = 0;
                    $grnd_ex_wip_qty = 0;
                    $grnd_ex_bal_qty = 0;
                    foreach ($dataArray as $sizeId => $row) 
                    {  
                        $layQty     = $cutLayArray[$sizeId];
                        // $qcQty      = $cutQcArr[$sizeId]['qc_ok'];
                        // $qcRejQty   = $cutQcArr[$sizeId]['rej_qty'];
                        // $qcRepQty   = $cutQcArr[$sizeId]['rep_qty'];
                        $qcQty      = $prodDataArray[$sizeId]['cut_qty'];
                        $qcRejQty   = $prodDataArray[$sizeId]['cut_reject_qty'];
                        $qcRepQty   = $prodDataArray[$sizeId]['cut_replace_qty'];
                        $cutBal     = $row['qty'] - $qcQty;

                        $inputQty   = $prodDataArray[$sizeId]['input_qty'];
                        $inputBal   = $row['qty'] - $inputQty;
                        $inputWIP   = $qcQty - $inputQty;
                        $outputQty  = $prodDataArray[$sizeId]['out_qty'];
                        $alterQty   = $prodDataArray[$sizeId]['alter_qty'];
                        $spotQty    = $prodDataArray[$sizeId]['spot_qty'];
                        $replaceQty = $prodDataArray[$sizeId]['replace_qty'];
                        $sewRejQty  = $prodDataArray[$sizeId]['rej_qty'];
                        $totSewQty  = $outputQty + $sewRejQty;// - $replaceQty;
                        $sewBal     = $row['qty'] - $outputQty;
                        $sewWIP     = $inputQty - $totSewQty;
                        $finQty     = $prodDataArray[$sizeId]['finish_qty'];
                        $finRejQty  = $prodDataArray[$sizeId]['fin_reject_qty'];
                        $finBal     = $row['qty'] - $finQty;
                        $finWIP     = $outputQty - ($finQty+$finRejQty);

                        $exfactQty  = $exfactArray[$sizeId];
                        $exfWIP     = $finQty - $exfactQty;
                        $exfBal     = $row['qty'] - $exfactQty;
                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                        ?>                        
                        <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                            <td><? echo $lib_size[$sizeId]; ?></td>
                            <td align="right"><? echo fn_number_format($row['qty'],0);?></td>
                            <td align="right"><? echo fn_number_format($layQty,0);?></td>
                            <td align="right"><? echo fn_number_format($qcRejQty,0);?></td>
                            <td align="right"><? echo fn_number_format($qcRepQty,0);?></td>
                            <td align="right"><? echo fn_number_format($qcQty,0);?></td>
                            <td align="right"><? echo fn_number_format($cutBal,0);?></td>
                            <td align="right"><? echo fn_number_format($inputQty,0);?></td>
                            <td align="right"><? echo fn_number_format($inputBal,0);?></td>
                            <td align="right"><? echo fn_number_format($inputWIP,0);?></td>
                            <td align="right"><? echo fn_number_format($outputQty,0);?></td>
                            <td align="right"><? echo fn_number_format($sewRejQty,0);?></td>
                            <td align="right"><? echo fn_number_format($replaceQty,0);?></td>
                            <td align="right"><? echo fn_number_format($totSewQty,0);?></td>
                            <td align="right"><? echo fn_number_format($sewBal,0);?></td>
                            <td align="right"><? echo fn_number_format($sewWIP,0);?></td>
                            <td align="right"><? echo fn_number_format($finQty,0);?></td>
                            <td align="right"><? echo fn_number_format($finRejQty,0);?></td>
                            <td align="right"><? echo fn_number_format($finBal,0);?></td>
                            <td align="right"><? echo fn_number_format($finWIP,0);?></td>
                            <td align="right"><? echo fn_number_format($exfactQty,0);?></td>
                            <td align="right"><? echo fn_number_format($exfWIP,0);?></td>
                            <td align="right"><? echo fn_number_format($exfBal,0);?></td>
                        </tr>
                        <?
                        $i++; 
                        $grnd_req_qty += $row['qty'];
                        $grnd_lay_qty += $layQty;
                        $grnd_rej_qty += $qcRejQty;
                        $grnd_rep_qty += $qcRepQty;
                        $grnd_qc_qty += $qcQty;
                        $grnd_cut_bal_qty += $cutBal;
                        $grnd_input_qty += $inputQty;
                        $grnd_input_bal_qty += $inputBal;
                        $grnd_input_wip_qty += $inputWIP;
                        $grnd_ok_sew_qty += $outputQty;
                        $grnd_sew_rej_qty += $sewRejQty;
                        $grnd_sew_rep_qty += $replaceQty;
                        $grnd_tot_sew_qty += $totSewQty;
                        $grnd_sew_bal_qty += $sewBal;
                        $grnd_sew_wip_qty += $sewWIP;
                        $grnd_fin_qty += $finQty;
                        $grnd_fin_rej_qty += $finRejQty;
                        $grnd_fin_bal_qty += $finBal;
                        $grnd_fin_wip_qty += $finWIP;
                        $grnd_ex_qty += $exfactQty;
                        $grnd_ex_wip_qty += $exfWIP;
                        $grnd_ex_bal_qty += $exfBal;
                       
                    }
                    ?>
                </tbody>
                <tfoot>
                    <th align="right">Grand Total</th>
                    <th><? echo fn_number_format($grnd_req_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_lay_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_rej_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_rep_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_qc_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_cut_bal_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_input_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_input_bal_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_input_wip_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_ok_sew_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_sew_rej_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_sew_rep_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_tot_sew_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_sew_bal_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_sew_wip_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_fin_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_fin_rej_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_fin_bal_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_fin_wip_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_ex_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_ex_wip_qty,0);?></th>
                    <th><? echo fn_number_format($grnd_ex_bal_qty,0);?></th>
                </tfoot>
            </table>
        </div>
    </div>
    <?
}

if($action=="acc_booking_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_item_group_name = return_library_array("select id,item_name from lib_item_group", "id", "item_name");
    $lib_supplier = return_library_array("select id,short_name from lib_supplier", "id", "short_name");
    $trims_type_array = array(1=>'Sewing',2=>'Packing/Finishing');

    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);
    $lib_po_number = return_library_array("select id,po_number from wo_po_break_down where id in($poIds)", "id", "po_number");
    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();
    $trims= new trims($condition);
    // echo $trims->getQuery(); die;
    $trims_costing_arr=$trims->getQtyArray_by_orderAndItemidTypeid();
    // echo"<pre>";print_r($trims_costing_arr);die();
    $req_qty_array = array();
    foreach ($trims_costing_arr as $po=>$poData) 
    {
        foreach ($poData as $typeId=>$typeData) 
        {
            foreach ($typeData as $itemId=>$row) 
            {
                $req_qty_array[$typeId][$itemId] += $row;
            }
        }        
    }
    // echo"<pre>";print_r($req_qty_array);die();
     // ====================================== ORDER INFO ==================================
    $sqlOrder = "SELECT a.style_ref_no as STYLE,b.grouping as INT_REF from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in($poIds)";
    //echo $sqlOrder;die();
    $orderInfo = sql_select($sqlOrder);
    
    // ====================================== ================================================
    $sql = "SELECT distinct a.TRIM_GROUP,a.CONS_UOM, c.trim_type AS TTYPE  FROM WO_PRE_COST_TRIM_COST_DTLS a,WO_PRE_COST_TRIM_CO_CONS_DTLS b, lib_item_group c WHERE a.id = b.WO_PRE_COST_TRIM_COST_DTLS_ID AND c.id = a.trim_group and b.PO_BREAK_DOWN_ID in($poIds) and a.status_active=1 and b.status_active=1 and  c.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.is_deleted=0 and c.item_category=4"; 
    $sqlRes = sql_select($sql);
    $dataArray = array();
    foreach ($sqlRes as $val) 
    {
       $dataArray[$val['TTYPE']][$lib_item_group_name[$val['TRIM_GROUP']]]['cons_uom'] = $val['CONS_UOM'];
       $dataArray[$val['TTYPE']][$lib_item_group_name[$val['TRIM_GROUP']]]['item_id'] = $val['TRIM_GROUP'];
    }
    //echo "<pre>";print_r($dataArray);die;
    // ====================================== TRIMS BOOKING ==================================
    $sqlTrims = "SELECT a.booking_no_prefix_num as BOOKING_NUM,a.BOOKING_NO,c.po_break_down_id as PO_ID,b.trim_group as TGROUP,d.trim_type as TTYPE,b.UOM,sum(case when a.is_short=2 then c.requirment else 0 end) as QTY,sum(case when a.is_short=1 then c.requirment else 0 end) as SHOR_QTY,max(a.booking_date) as BOOKING_DATE,a.SUPPLIER_ID FROM wo_booking_mst a,wo_booking_dtls b,wo_trim_book_con_dtls c,lib_item_group d WHERE a.booking_no=b.booking_no and b.booking_no=c.booking_no and b.id=c.wo_trim_booking_dtls_id and d.id=b.trim_group and c.po_break_down_id in($poIds) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(87,262)  and a.item_category=4 and a.booking_type=2  group by a.booking_no_prefix_num,b.trim_group,d.trim_type,b.uom,a.supplier_id,c.po_break_down_id,a.booking_no ";//and d.trim_type in(1,2) and a.is_short=2
    // echo $sqlTrims;die();
    $trimsRes = sql_select($sqlTrims);
    if(count($trimsRes)==0)
    {
        ?>
        <div style="font-size:20px;color:red;text-align:center">Data not found!</div>
        <?
        die;
    }
   
    $tbArray = array();
    foreach ($trimsRes as  $val) 
    {
       //if($val['TTYPE']==0) $val['TTYPE']=1;
       $dataArray[$val['TTYPE']][$lib_item_group_name[$val['TGROUP']]]['book_qty'] += $val['QTY'];
       $dataArray[$val['TTYPE']][$lib_item_group_name[$val['TGROUP']]]['short_book_qty'] += $val['SHOR_QTY'];
       $dataArray[$val['TTYPE']][$lib_item_group_name[$val['TGROUP']]]['uom'] = $val['UOM'];
       $dataArray[$val['TTYPE']][$lib_item_group_name[$val['TGROUP']]]['booking_date'] = $val['BOOKING_DATE'];
       $dataArray[$val['TTYPE']][$lib_item_group_name[$val['TGROUP']]]['supplier_id'] = $val['SUPPLIER_ID'];
       $dataArray[$val['TTYPE']][$lib_item_group_name[$val['TGROUP']]]['po_id'] = $val['PO_ID'];
       $dataArray[$val['TTYPE']][$lib_item_group_name[$val['TGROUP']]]['booking_num'] = $val['BOOKING_NUM'];
       $dataArray[$val['TTYPE']][$lib_item_group_name[$val['TGROUP']]]['booking_no'] = $val['BOOKING_NO'];
       $dataArray[$val['TTYPE']][$lib_item_group_name[$val['TGROUP']]]['item_id'] = $val['TGROUP'];
       $tbArray[$val['BOOKING_NO']] = $val['BOOKING_NO'];
    }
    $trimsBoingNo = "'".implode("','", $tbArray)."'";
    // ====================================== getting PI Rcv Date ==========================
    $sqlpi = "select a.ID,a.PI_DATE,b.WORK_ORDER_NO from com_pi_master_details a, com_pi_item_details b where a.id=b.pi_id and b.work_order_no in($trimsBoingNo) and a.item_category_id=4";
    $piRes = sql_select($sqlpi);
    $lib_pi_rcv_date = array();
    $lib_pi_no = array();
    $lib_pi_id = array();
    foreach ($piRes as $val) 
    {
       $lib_pi_rcv_date[$val['WORK_ORDER_NO']] = $val['PI_DATE'];
       $lib_pi_id[$val['WORK_ORDER_NO']] = $val['ID'];
       $lib_pi_no[$val['ID']] = $val['ID'];
    }
    $piIds = implode(",", $lib_pi_no);

    $lcsql = "SELECT a.PI_ID,a.LC_NUMBER from com_btb_lc_master_details a,com_btb_lc_pi b where a.id=b.com_btb_lc_master_details_id and b.pi_id in($piIds) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
    // echo $lcsql;
    $lcRes = sql_select($lcsql);
    $lc_number_array = array();
    foreach ($lcRes as $val) 
    {
        $lc_number_array[$val['PI_ID']] = $val['LC_NUMBER'];
    }
    // print_r($lib_pi_rcv_date); echo "string";
    // ====================================== TRIMS RECEIVE ==================================
    $sqlacc = "SELECT D.TRIM_TYPE,B.ITEM_GROUP_ID,B.CONS_UOM,c.quantity AS QNTY,c.reject_qty as REJ_QTY FROM inv_receive_master a,inv_trims_entry_dtls b,order_wise_pro_details c,lib_item_group d where a.id=b.mst_id and b.id=c.dtls_id and d.id=b.item_group_id and c.trans_type=1 and c.po_breakdown_id in($poIds) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=24 AND c.entry_form = 24 AND c.entry_form = 24 and d.trim_type !=0 and a.item_category=4 order by d.trim_type";
    // echo $sqlacc;die();
    $accRes = sql_select($sqlacc);
    // $dataArray = array();
    foreach ($accRes as $val) 
    {
       //if($val['TRIM_TYPE']==0) $val['TRIM_TYPE']=1;
       $dataArray[$val['TRIM_TYPE']][$lib_item_group_name[$val['ITEM_GROUP_ID']]]['rcv_qty'] += $val['QNTY'];
       $dataArray[$val['TRIM_TYPE']][$lib_item_group_name[$val['ITEM_GROUP_ID']]]['rej_qty'] += $val['REJ_QTY'];
       $dataArray[$val['TRIM_TYPE']][$lib_item_group_name[$val['ITEM_GROUP_ID']]]['item_id'] = $val['ITEM_GROUP_ID'];
       //$dataArray[$val['TRIM_TYPE']][$val['ITEM_GROUP_ID']]['cons_uom'] = $val['CONS_UOM'];
    }
    // echo "<pre>";print_r($dataArray);die();


    /*======================================================================================/
    /                                    trims transfer                                     /
    /======================================================================================*/
    $item_group_cond = where_con_using_array($item_group_id_arr,0,"b.item_group");
    $to_order_id_con =where_con_using_array($poIdArray,0,"a.to_order_id");
    $from_order_id_con =where_con_using_array($poIdArray,0,"a.from_order_id");

    $transfer_sql_in=sql_select("SELECT a.transfer_date,b.item_group,b.transfer_qnty as qnty,D.trim_type FROM inv_item_transfer_mst a, inv_item_transfer_dtls b,lib_item_group d WHERE a.id = b.mst_id and d.id=b.item_group  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=4 and a.entry_form in(78,112) and a.to_order_id in($poIds)");
    // $transfer_data=array();
    foreach ($transfer_sql_in as $row) 
    {
        $dataArray[$row[csf('trim_type')]][$lib_item_group_name[$row[csf('item_group')]]]['in']+=$row[csf('qnty')];
        $dataArray[$row[csf('trim_type')]][$lib_item_group_name[$row[csf('item_group')]]]['item_id']=$row[csf('item_group')];
    }
    $transfer_sql_out=sql_select("SELECT a.transfer_date, d.trim_type,b.item_group,b.transfer_qnty as qnty FROM inv_item_transfer_mst a, inv_item_transfer_dtls b,lib_item_group d WHERE a.id = b.mst_id and d.id=b.item_group  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=4 and a.entry_form in(78,112)  and a.from_order_id in($poIds)");
    foreach ($transfer_sql_out as $row) 
    {
        $dataArray[$row[csf('trim_type')]][$lib_item_group_name[$row[csf('item_group')]]]['out']+=$row[csf('qnty')];
        $dataArray[$row[csf('trim_type')]][$lib_item_group_name[$row[csf('item_group')]]]['item_id']=$row[csf('item_group')];
    }

    $rowspan = array();
    foreach ($dataArray as $typeId => $typeData) 
    {
        foreach ($typeData as $groupId => $row) 
        {
            $groupId = $row['item_id'];
            if($req_qty_array[$groupId][$typeId]>0)
            {
                if($typeId==0) {$typeId=1;}
                $rowspan[$typeId]++;
            }
        }
    }
    // echo "<pre>";print_r($dataArray);die();
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <!-- <div style="color:red;font-size:20px;text-align:center;">This popup is under development!</div> -->
        <script>
            function new_window()
            {
                document.getElementById('scroll_body').style.overflow="auto";
                document.getElementById('scroll_body').style.maxHeight="none"; 
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
                document.getElementById('scroll_body').style.overflowY="scroll"; 
                document.getElementById('scroll_body').style.maxHeight="350px";
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 100%;" id="details_reports">
        <style type="text/css">
            table tr th, table tr td{word-wrap: break-word;word-break: break-all;}
        </style>
        <div class="header_part">
            <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="100%">
                <caption><h3>Accessories Info</h3></caption>
                <thead>
                    <tr>
                        <td colspan="18" width="100%"><b>Style Name:<? echo $orderInfo[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref:<? echo $orderInfo[0]['INT_REF'];?></b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="main_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="99%">
                <thead>
                    <tr>
                        <th width="4.8%"><p>Type</p></th>
                        <th width="8%"><p>Item Name</p></th>
                        <th width="4.8%"><p>Req qty</p></th>
                        <th width="4.8%"><p>Excess Qty</p></th>
                        <th width="4.8%"><p>Total Qty</p></th>
                        <th width="4.8%"><p>Unit</p></th>
                        <th width="4.8%"><p>Booking Bal</p></th>
                        <th width="4.8%"><p>Last Book Date</p></th>
                        <th width="7.5%"><p>Sup Name</p></th>
                        <th width="4.8%"><p>Booking Qty</p></th>
                        <th width="4.8%"><p>Ok Rcv Qty</p></th>
                        <th width="4.8%"><p>Rej Rcv Qty</p></th>
                        <th width="4.8%"><p>Trans In</p></th>
                        <th width="4.8%"><p>Trans Out</p></th>
                        <th width="4.8%"><p>Backlog Qty</p></th>
                        <th width="4.8%"><p>Balance Qty</p></th>
                        <th width="4.8%"><p>TB No</p></th>
                        <th width="4.8%"><p>PI Rcvd Date</p></th>
                        <th width="7.5%"><p>L/c No</p></th>
                    </tr>
                </thead>
                </table>
                <div style="width:100%;overflow-y:scroll;max-height:350px;" id="scroll_body">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="100%">
                    <tbody>
                        <?
                        $i=0;
                        ksort($dataArray);
                        foreach ($dataArray as $typeId => $typeData) 
                        {
                            $t=0;
                            //if($typeId==1){$t=1;}
                            ksort($typeData);
                            foreach ($typeData as $groupName => $row) 
                            {     
                                $groupId = $row['item_id'];
                                if($req_qty_array[$groupId][$typeId]>0)
                                {
                                    $req_qty = $req_qty_array[$groupId][$typeId];   
                                    $booking_bal = $req_qty-$row['book_qty'];
                                    $bal_qty = $req_qty - $row['rcv_qty'];
                                    $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                    if($typeId==0) $typeId=1;
                                    ?>                        
                                    <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                        <? if($t==0){?>
                                        <td width="4.8%" rowspan="<? echo $rowspan[$typeId];?>" title="<? echo $typeId;?>" valign="middle"><p><? echo $trims_type_array[$typeId]; ?></p></td>
                                       <? } ?>
                                        <td width="8%" title="<?=$groupName;?>"><p>
                                            <a href="javascript:void(0)" onclick="open_sewing_thread_popup('<? echo $poIds."_".$typeId."_".$groupId;?>')">
                                                <? echo substr($groupName,0,20);?>
                                            </a></p>
                                        </td>
                                        <td width="4.8%" align="right"><p><? echo fn_number_format($req_qty,0);?></p></td>
                                        <td width="4.8%" align="right"><p><? echo fn_number_format($row['short_book_qty'],0);?></p></td>
                                        <td width="4.8%" align="right"><p><? echo fn_number_format(($req_qty+$row['short_book_qty']),0);?></p></td>
                                        <td width="4.8%" align="center"><p><? echo $unit_of_measurement[$row['cons_uom']];?></p></td>
                                        <td width="4.8%" align="right"><p><? echo fn_number_format($booking_bal,0);?></p></td>
                                        <td width="4.8%" align="center"><p><? echo change_date_format($row['booking_date'],0);?></p></td>
                                        <td width="7.5%" align=""><p><? echo $lib_supplier[$row['supplier_id']];?></p></td>
                                        <td width="4.8%" align="right"><p><? echo fn_number_format(($row['book_qty']+$row['short_book_qty']),0);?></p></td>
                                        <td width="4.8%" align="right"><p><? echo fn_number_format($row['rcv_qty'],0);?></p></td>
                                        <td width="4.8%" align="right"><p><? echo fn_number_format($row['rej_qty'],0);?></p></td>
                                        <td width="4.8%" align="right"><p><? echo fn_number_format($row['in'],0);?></p></td>
                                        <td width="4.8%" align="right"><p><? echo fn_number_format($row['out'],0);?></p></td>
                                        <td width="4.8%" align="right"><p><? //echo fn_number_format($finQty,0);?></p></td>
                                        <td width="4.8%" align="right"><p><? echo fn_number_format($bal_qty,0);?></p></td>
                                        <td width="4.8%" align="center"><p><? echo $row['booking_num'];?></p></td>
                                        <!--<td align="center"><p><? //echo $lib_po_number[$row['po_id']];?></p></td>-->
                                        <td width="4.8%" align="center"><p>
                                            <? 
                                            if(!empty($lib_pi_rcv_date[$row['booking_no']]))
                                            {
                                                echo date('d M',strtotime($lib_pi_rcv_date[$row['booking_no']]));
                                            }
                                            ?>
                                                
                                            </p>
                                        </td>
                                        <td style="word-wrap: break-word;word-break: break-all;" width="7.5%" align="center"><p><? echo $lc_number_array[$lib_pi_id[$row['booking_no']]];?></p></td>
                                    </tr>
                                    <?
                                    $i++;
                                    $t++;
                                }
                            } 
                        }
                        ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>   
    <script type="text/javascript">
        function open_sewing_thread_popup(data)
        {
            var width = window.innerWidth;
            width = 750;        
            // width = width-30;        
            var action = "sewing_thread_popup";
            emailwindow = dhtmlmodal.open('EmailBox', 'iframe', 'order_monitoring_report_with_tna_controller.php?data=' + data + '&action=' + action, 'Garments Production Details Popup', 'width='+width+'px,height=350px,center=1,resize=0,scrolling=0', '../../');
        }
    </script>
    <?
    exit();
}

if($action=="sewing_thread_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_item_group_name = return_library_array("select id,item_name from lib_item_group", "id", "item_name");
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_size = return_library_array("select id,size_name from lib_size", "id", "size_name");
    extract($_REQUEST);
    $data = str_replace("'", "", $data);
    $dataEx = explode("_", $data);
    $po_break_down_id = $dataEx[0];
    $trimsTypeId = $dataEx[1];
    $trimsGroupId = $dataEx[2];

    $condition= new condition();     
    $condition->po_id_in($po_break_down_id);     
    $condition->init();
    $trims= new trims($condition);
    // echo $trims->getQuery(); die;
    $trims_costing_arr=$trims->getQtyArray_by_orderGmtscolorAndGmtssize();
    // echo"<pre>";print_r($trims_costing_arr);die();

    $req_qty_array = array();
    foreach ($trims_costing_arr as $po=>$poData) 
    {
        foreach ($poData as $typeId=>$typeData) 
        {
            foreach ($typeData as $itemId=>$row) 
            {
                $req_qty_array[$typeId][$itemId] += $row;
            }
        }        
    }
    // echo"<pre>";print_r($req_qty_array);die();
    // ====================================== TRIMS RECEIVE ==================================
    $sqlacc = "SELECT B.ITEM_COLOR,B.ITEM_SIZE,c.quantity AS QNTY,c.reject_qty as REJ_QTY FROM inv_receive_master a,inv_trims_entry_dtls b,order_wise_pro_details c,lib_item_group d where a.id=b.mst_id and b.id=c.dtls_id and d.id=b.item_group_id and c.trans_type=1 and c.po_breakdown_id in($po_break_down_id) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=24 AND c.entry_form = 24 and d.trim_type !=0 and a.item_category=4 and d.trim_type in($trimsTypeId) and b.item_group_id in($trimsGroupId) order by d.trim_type";
    // echo $sqlacc;die();
    $accRes = sql_select($sqlacc);
    // $dataArray = array();
    foreach ($accRes as $val) 
    {
       $dataArray[$val['ITEM_COLOR']][$val['ITEM_SIZE']]['rcv_qty'] += $val['QNTY'];
       $dataArray[$val['ITEM_COLOR']][$val['ITEM_SIZE']]['rej_qty'] += $val['REJ_QTY'];
       $dataArray[$val['ITEM_COLOR']][$val['ITEM_SIZE']]['cons_uom'] = $val['CONS_UOM'];
    }


    /*======================================================================================/
    /                                    trims transfer                                     /
    /======================================================================================*/
   /* $item_group_cond = where_con_using_array($item_group_id_arr,0,"b.item_group");
    $to_order_id_con =where_con_using_array($poIdArray,0,"a.to_order_id");
    $from_order_id_con =where_con_using_array($poIdArray,0,"a.from_order_id");

    $transfer_sql_in=sql_select("SELECT a.transfer_date, b.item_category,b.item_group,b.transfer_qnty as qnty FROM inv_item_transfer_mst a, inv_item_transfer_dtls b WHERE a.id = b.mst_id   and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=4 and a.entry_form in(78,112) and a.to_order_id in($poIds)");
    // $transfer_data=array();
    foreach ($transfer_sql_in as $row) 
    {
        $dataArray[$row[csf('item_category')]][$row[csf('item_group')]]['in']+=$row[csf('qnty')];
    }
    $transfer_sql_out=sql_select("SELECT a.transfer_date, b.item_category,b.item_group,b.transfer_qnty as qnty FROM inv_item_transfer_mst a, inv_item_transfer_dtls b WHERE a.id = b.mst_id   and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=4 and a.entry_form in(78,112)  and a.from_order_id in($poIds)");
    foreach ($transfer_sql_out as $row) 
    {
        $dataArray[$row[csf('item_category')]][$row[csf('item_group')]]['out']+=$row[csf('qnty')];
    }*/
    
    ?>    
    <div id="data_panel" align="center" style="width:740px">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports2').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 740px;" id="details_reports2">
      <h2><? echo $lib_item_group_name[$trimsGroupId];?></h2>
        <div class="main_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="740">
                <thead>
                    <tr>
                        <th width="100">Color</th>
                        <th width="80">Size</th>
                        <th width="80">Req qty</th>
                        <th width="80">Excess Qty</th>
                        <th width="80">Total Qty</th>
                        <th width="80">Unit</th>
                        <th width="80">OK Rev</th>
                        <th width="80">Rej Rcv</th>
                        <th width="80">Bal Qty</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    foreach ($dataArray as $color => $colordata) 
                    {
                        foreach ($colordata as $size => $row) 
                        {  
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                <td><? echo $lib_color[$color]; ?></td>
                                <td><? echo ($lib_size[$size] !="") ? $lib_size[$size] : "N/A"; ?></td>
                                <td align="right"><? echo fn_number_format($a,0);?></td>
                                <td align="right"><? echo fn_number_format($a,0);?></td>
                                <td align="right"><? echo fn_number_format($a,0);?></td>
                                <td align="right"><? echo $unit_of_measurement[$row['cons_uom']];?></td>
                                <td align="right"><? echo fn_number_format($row['rcv_qty'],0);?></td>
                                <td align="right"><? echo fn_number_format($row['rej_qty'],0);?></td>
                                <td align="right"><? echo fn_number_format($row['rcv_qty'],0);?></td>
                            </tr>
                            <?
                            $i++;
                        }                        
                    }
                    ?>
                </tbody>
            </table>
        </div>
    </div>
    <?
}

if($action=="production_calendar_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_size = return_library_array("select id,size_name from lib_size", "id", "size_name");
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);   
    
    $jobNo = return_library_array("select id,job_no_mst from wo_po_break_down where id in($poIds)", "id", "job_no_mst");
    $jobNo = "'".implode("','",array_unique($jobNo))."'";

    // ====================================== ORDER INFO ==================================
    $sqlOrder = "SELECT a.style_ref_no as STYLE,b.grouping as INT_REF from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in($poIds)";
    //echo $sqlOrder;die();
    $orderInfo = sql_select($sqlOrder);

    //==================================== YARN ALLOCATION ==============================================
    $sqlYarnAllo = "SELECT B.ALLOCATION_DATE AS ADATE,SUM(B.QNTY) AS QNTY from INV_MATERIAL_ALLOCATION_MST A, INV_MATERIAL_ALLOCATION_DTLS B WHERE A.ID=B.MST_ID AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 and B.PO_BREAK_DOWN_ID in($poIds) GROUP BY B.ALLOCATION_DATE order by B.ALLOCATION_DATE";
    // echo $sqlYarnAllo;die(); 
    $yarnRes = sql_select($sqlYarnAllo);
    $dataArray = array();
    foreach ($yarnRes as $val) 
    {
       $dataArray[strtotime($val['ADATE'])]['allo_qty'] = $val['QNTY'];
    }

    // ======================================= Yarn dyed receive ==============================
    
    $sql = "SELECT A.RECEIVE_DATE as RDATE,SUM(B.CONS_QUANTITY) AS QNTY FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B WHERE A.id=B.mst_id and  A.RECEIVE_BASIS=2 AND A.RECEIVE_PURPOSE=2 AND B.TRANSACTION_TYPE=1 and B.job_no in($jobNo) and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND A.ENTRY_FORM=1 AND A.ITEM_CATEGORY=1 GROUP BY A.RECEIVE_DATE order by A.RECEIVE_DATE ";
    //echo $sql;die();
    $sqlYRes = sql_select($sql);
    foreach ($sqlYRes as  $val) 
    {
       $dataArray[strtotime($val['RDATE'])]['dy_qty'] = $val['QNTY'];
    }

    // ======================================= GREY PROD ==============================
   
    $sqlGrey = "SELECT A.RECEIVE_DATE AS RCV_DATE,SUM(C.QUANTITY) AS QNTY FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE=1 and C.PO_BREAKDOWN_ID in($poIds) and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=2 AND A.ITEM_CATEGORY=13 GROUP BY A.RECEIVE_DATE order by A.RECEIVE_DATE ";
    // echo $sqlGrey;die();
    $greyRes = sql_select($sqlGrey);
    foreach ($greyRes as  $val) 
    {
       $dataArray[strtotime($val['RCV_DATE'])]['grey_qty']     = $val['QNTY'];
    }

    // ======================================= DYEING PRODUCTION ==============================
    
    $sqlDye = "SELECT C.PRODUCTION_DATE AS PDATE,SUM(B.BATCH_QNTY) AS QTY FROM PRO_BATCH_CREATE_MST A, PRO_BATCH_CREATE_DTLS B,PRO_FAB_SUBPROCESS C WHERE A.ID=B.MST_ID AND A.ID=C.BATCH_ID and B.PO_ID in($poIds) AND C.LOAD_UNLOAD_ID=2 AND C.PROCESS_ID='31' AND C.RESULT=1 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 GROUP BY C.PRODUCTION_DATE order by C.PRODUCTION_DATE";
    // echo $sqlDye;die();
    $dyeRes = sql_select($sqlDye);
    foreach ($dyeRes as $val) 
    {
       $dataArray[strtotime($val['PDATE'])]['dye_qty'] = $val['QTY'];
    }

    // ======================================= AOP ==============================
   
    $sqlAOP = "SELECT A.RECEIVE_DATE AS RDATE,SUM(CASE WHEN A.ENTRY_FORM=91 THEN B.BATCH_ISSUE_QTY ELSE 0 END) AS ISSUE_QTY,SUM(CASE WHEN A.ENTRY_FORM=92 THEN B.BATCH_ISSUE_QTY ELSE 0 END) AS RCV_QTY FROM INV_RECEIVE_MAS_BATCHROLL A, PRO_GREY_BATCH_DTLS B WHERE A.ID=B.MST_ID and B.ORDER_ID in($poIds) AND B.PROCESS_ID=35 AND A.ENTRY_FORM in(91,92) AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY A.RECEIVE_DATE order by A.RECEIVE_DATE";
    // echo $sqlAOP;die();
    $AOPRes = sql_select($sqlAOP);
    $aopProdArr = array();
    foreach ($AOPRes as $val) 
    {
        $dataArray[strtotime($val['RDATE'])]['aop_rcv'] += $val['RCV_QTY'];
        $dataArray[strtotime($val['RDATE'])]['aop_issue'] += $val['ISSUE_QTY'];       
    }
     // ======================================= FINISH FAB RCV ==============================   
   
    $sqlFinFab = "SELECT A.RECEIVE_DATE AS RCV_DATE,SUM(C.QUANTITY) AS QNTY FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B,ORDER_WISE_PRO_DETAILS C WHERE A.ID=B.MST_ID AND B.ID=C.TRANS_ID AND B.TRANSACTION_TYPE=1 and C.PO_BREAKDOWN_ID in($poIds) and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=7 AND A.ITEM_CATEGORY=2 GROUP BY A.RECEIVE_DATE order by A.RECEIVE_DATE";
    // echo $sqlFinFab;die();
    $finFabRes = sql_select($sqlFinFab);
    foreach ($finFabRes as  $val) 
    {
       $dataArray[strtotime($val['RCV_DATE'])]['fin_fab_qty'] = $val['QNTY'];
    }

    // ======================================= CUTTING QC ==============================  
    
    /*$sqlCutQC = "SELECT A.ENTRY_DATE AS QC_DATE,SUM(B.QC_PASS_QTY) AS QNTY,SUM(B.REPLACE_QTY) AS REPLACE_QTY,SUM(B.REJECT_QTY) AS REJQNTY FROM PRO_GMTS_CUTTING_QC_MST A,PRO_GMTS_CUTTING_QC_DTLS B WHERE A.ID=B.MST_ID and B.ORDER_ID in($poIds) and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 GROUP BY A.ENTRY_DATE";
    // echo $sqlCutQC;die();
    $CutQCRes = sql_select($sqlCutQC);
    foreach ($CutQCRes as  $val) 
    {
       $dataArray[strtotime($val['QC_DATE'])]['qc_qty'] = $val['QNTY'];
    }*/
    // ======================================= GMTS PRODUCTION DATA ==============================
    $poIdsCondGmts = str_replace("po_break_down_id", "A.PO_BREAK_DOWN_ID", $poIdsCond);
    $sqlProd = "SELECT  A.PRODUCTION_DATE AS PROD_DATE, 
    SUM(CASE WHEN A.PRODUCTION_TYPE=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS CUT_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=1 THEN B.REJECT_QTY ELSE 0 END) AS CUT_REJECT_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PRINTING_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=2 AND A.EMBEL_NAME=1 THEN B.PRODUCTION_QNTY ELSE 0 END) AS PRINT_ISS_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=2 THEN B.PRODUCTION_QNTY ELSE 0 END) AS EMB_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=2 AND A.EMBEL_NAME=2 THEN B.PRODUCTION_QNTY ELSE 0 END) AS EMB_ISSUE_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=3 THEN B.PRODUCTION_QNTY ELSE 0 END) AS WASH_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=2 AND A.EMBEL_NAME=3 THEN B.PRODUCTION_QNTY ELSE 0 END) AS WASH_ISSUE_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=4 THEN B.PRODUCTION_QNTY ELSE 0 END) AS INPUT_QTY, 
    SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.PRODUCTION_QNTY ELSE 0 END) AS OUT_QTY, 
    SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.ALTER_QTY ELSE 0 END) AS ALTER_QTY, 
    SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.SPOT_QTY ELSE 0 END) AS SPOT_QTY, 
    SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.REPLACE_QTY ELSE 0 END) AS REPLACE_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=1 THEN B.REJECT_QTY ELSE 0 END) AS PRINT_REJECT_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=2 THEN B.REJECT_QTY ELSE 0 END) AS EMB_REJECT_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=3 AND A.EMBEL_NAME=3 THEN B.REJECT_QTY ELSE 0 END) AS WASH_REJECT_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=5 THEN B.REJECT_QTY ELSE 0 END) AS REJECT_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=8 THEN B.PRODUCTION_QNTY ELSE 0 END) AS FINISH_QTY,
    SUM(CASE WHEN A.PRODUCTION_TYPE=8 THEN B.REJECT_QTY ELSE 0 END) AS FIN_REJECT_QTY
    FROM PRO_GARMENTS_PRODUCTION_MST A, PRO_GARMENTS_PRODUCTION_DTLS B
    WHERE A.ID=B.MST_ID AND A.STATUS_ACTIVE=1 and a.is_deleted=0 and b.is_deleted=0 AND B.STATUS_ACTIVE=1 and a.PO_BREAK_DOWN_ID in($poIds) AND A.PRODUCTION_TYPE IN(1,2,3,4,5,8) and B.PRODUCTION_QNTY > 0 GROUP BY A.PRODUCTION_DATE order by A.PRODUCTION_DATE ASC ";
    // echo $sqlProd;die();
    $prodRes = sql_select($sqlProd);
    foreach ($prodRes as  $val) 
    {
       $dataArray[strtotime($val['PROD_DATE'])]['qc_qty']        = $val['CUT_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['qc_reject_qty'] = $val['CUT_REJECT_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['print_qty']     = $val['PRINTING_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['print_iss_qty'] = $val['PRINT_ISS_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['print_rej_qty'] = $val['PRINT_REJECT_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['emb_qty']       = $val['EMB_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['emb_issue_qty'] = $val['EMB_ISSUE_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['emb_rej_qty']   = $val['EMB_REJECT_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['wash_qty']      = $val['WASH_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['wash_issue_qty']= $val['WASH_ISSWASH_QTYUE_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['wash_rej_qty']  = $val['WASH_REJECT_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['input_qty']     = $val['INPUT_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['out_qty']       = $val['OUT_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['reject_qty']    = $val['REJECT_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['alter_qty']     = $val['ALTER_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['spot_qty']      = $val['SPOT_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['replace_qty']   = $val['REPLACE_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['finish_qty']    = $val['FINISH_QTY'];
       $dataArray[strtotime($val['PROD_DATE'])]['fin_rej_qty']   = $val['FIN_REJECT_QTY'];
    }
    // ======================================= EXFACTORY DATA ==============================
    
    $sqlEx = "SELECT C.EX_FACTORY_DATE AS EX_DATE, SUM(D.PRODUCTION_QNTY) AS EX_FACT_QTY FROM PRO_EX_FACTORY_MST C, PRO_EX_FACTORY_DTLS D, PRO_EX_FACTORY_DELIVERY_MST E WHERE C.ID=D.MST_ID AND E.ID=C.DELIVERY_MST_ID  AND C.STATUS_ACTIVE=1 AND D.STATUS_ACTIVE=1 AND E.STATUS_ACTIVE=1 and c.PO_BREAK_DOWN_ID in($poIds) GROUP BY C.EX_FACTORY_DATE ORDER BY C.EX_FACTORY_DATE"; 
    // echo $sqlEx;die();
    $sqlXRes = sql_select($sqlEx);
    foreach ($sqlXRes as  $val) 
    {
       $dataArray[strtotime($val['EX_DATE'])]['ex_qty']    += $val['EX_FACT_QTY'];
    }    
    ksort($dataArray);
    // echo "<pre>"; print_r($dataArray);
    ?>    
    <div id="data_panel" align="center" style="width:1070px">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports2').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 1070px;" id="details_reports2">
        <style type="text/css">
           table tr th{ word-wrap: break-word;}
        </style>
        <div class="header_part">
            <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1050">
                <caption><h2><b>Production Calender</b></h2></caption>
                <thead>
                    <tr>
                        <td colspan="15" width="100%"><b>Style Name :<? echo $orderInfo[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref :<? echo $orderInfo[0]['INT_REF'];?></b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="main_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1050">
                <thead>
                    <tr>
                        <th width="70">Date</th>
                        <th width="70">Yarn Allo</th>
                        <th width="70">Dyed Yarn Rcv</th>
                        <th width="70">Gray Rcv</th>
                        <th width="70">Dyeing</th>
                        <th width="70">AOP</th>
                        <th width="70">FF Rcv</th>
                        <th width="70">Cutting</th>
                        <th width="70">Printing</th>
                        <th width="70">Embroidery</th>
                        <th width="70">Input</th>
                        <th width="70">Sewing</th>
                        <th width="70">Washing</th>
                        <th width="70">Finishing</th>
                        <th width="70">Shipment</th>
                    </tr>
                </thead>
            </table>
            <div style="width:1070px;overflow:auto;max-height:300px;">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1050">
                    <tbody>
                        <?
                        $i=1;
                        $gr_all_qty     = 0;
                        $gr_dy_qty      = 0;
                        $gr_grey_qty    = 0;
                        $gr_dye_qty     = 0;
                        $gr_aop_qty     = 0;
                        $gr_ff_rcv_qty  = 0;
                        $gr_cutting_qty = 0;
                        $gr_print_qty   = 0;
                        $gr_emb_qty     = 0;
                        $gr_input_qty   = 0;
                        $gr_output_qty  = 0;
                        $gr_wash_qty    = 0;
                        $gr_fin_qty     = 0;
                        $gr_ship_qty    = 0;
                        
                        foreach ($dataArray as $date => $row) 
                        {                         
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                <td width="70"><? echo date('d-M',$date); ?></td>
                                <td width="70" align="right"><? echo fn_number_format($row['allo_qty'],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row['dy_qty'],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row['grey_qty'],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row['dye_qty'],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row['aop_rcv'],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row['fin_fab_qty'],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row['qc_qty'],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row['print_qty'],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row['emb_qty'],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row['input_qty'],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row['out_qty'],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row['wash_qty'],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row['finish_qty'],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row['ex_qty'],0);?></td>
                            </tr>
                            <?
                            $i++;  
                            $gr_all_qty     += $row['allo_qty'];
                            $gr_dy_qty      += $row['dy_qty'];
                            $gr_grey_qty    += $row['grey_qty'];
                            $gr_dye_qty     += $row['dye_qty'];
                            $gr_aop_qty     += $row['aop_rcv'];
                            $gr_ff_rcv_qty  += $row['fin_fab_qty'];
                            $gr_cutting_qty += $row['qc_qty'];
                            $gr_print_qty   += $row['print_qty'];
                            $gr_emb_qty     += $row['emb_qty'];
                            $gr_input_qty   += $row['input_qty'];
                            $gr_output_qty  += $row['out_qty'];
                            $gr_wash_qty    += $row['wash_qty'];
                            $gr_fin_qty     += $row['finish_qty'];
                            $gr_ship_qty    += $row['ex_qty'];
                        }
                        ?>
                    </tbody>
                </table>
            </div>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1050">
                <tfoot>
                    <tr>
                        <th width="70">Gr. Total</th>
                        <th width="70"><? echo fn_number_format($gr_all_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_dy_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_grey_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_dye_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_aop_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_ff_rcv_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_cutting_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_print_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_emb_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_input_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_output_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_wash_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_fin_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_ship_qty,0);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <?
}

if($action=="tna_calendar_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_size = return_library_array("select id,size_name from lib_size", "id", "size_name");
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);   
    
    $jobNo = return_library_array("select id,job_no_mst from wo_po_break_down where id in($poIds)", "id", "job_no_mst");
    $jobNo = "'".implode("','",array_unique($jobNo))."'";

    // ====================================== ORDER INFO ==================================
    $sqlOrder = "SELECT a.style_ref_no as STYLE,b.grouping as INT_REF from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in($poIds)";
    //echo $sqlOrder;die();
    $orderInfo = sql_select($sqlOrder);

    // ======================================= PLAN DATA ==============================
    
    $sql = "SELECT TASK_ID, PLAN_DATE, SUM(PLAN_QTY) AS PLAN_QTY FROM TNA_PLAN_TARGET  WHERE PO_ID in($poIds) AND STATUS_ACTIVE=1 AND IS_DELETED=0 and PLAN_QTY>0  GROUP BY TASK_ID, PLAN_DATE ORDER BY PLAN_DATE asc"; 

    // echo $sql;die();
    $sqlXRes = sql_select($sql);
    foreach ($sqlXRes as  $val) 
    {
       $dataArray[strtotime($val['PLAN_DATE'])][$val['TASK_ID']]  += $val['PLAN_QTY'];
    }    

    // ======================================= EXFACTORY DATA ==============================
    
    $sql = "SELECT ACC_SHIP_DATE AS EX_DATE, SUM(ACC_PO_QTY) AS QTY FROM  WO_PO_ACC_PO_INFO WHERE PO_BREAK_DOWN_ID in($poIds) AND STATUS_ACTIVE=1 AND IS_DELETED=0 and ACC_PO_QTY>0  GROUP BY ACC_SHIP_DATE ORDER BY ACC_SHIP_DATE"; 
    // echo $sql;die();
    $sqlXRes = sql_select($sql);
    foreach ($sqlXRes as  $val) 
    {
       $dataArray[strtotime($val['EX_DATE'])]['ex_qty']    += $val['QTY'];
    }

    ksort($dataArray);
    // echo "<pre>"; print_r($dataArray);
    ?>    
    <div id="data_panel" align="center" style="width:1210px">
        <script>
            function new_window()
            {
                
                document.getElementById('scroll_body').style.maxHeight='none'; 
                let w = window.open("Surprise", "#");
                let d = w.document.open();
                d.write(document.getElementById('details_reports2').innerHTML);
                d.close();
                document.getElementById('scroll_body').style.maxHeight='300px';
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 1210px;" id="details_reports2">
        <style type="text/css">
           table tr th{ word-wrap: break-word;}
        </style>
        <div class="header_part">
            <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1190">
                <caption><h2><b>Plan Calender</b></h2></caption>
                <thead>
                    <tr>
                        <td colspan="17" width="100%" align="center"><b>Style Name :<? echo $orderInfo[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref :<? echo $orderInfo[0]['INT_REF'];?></b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="main_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1190">
                <thead>
                    <tr>
                        <th width="70">Date</th>
                        <th width="70">Yarn Allo</th>
                        <th width="70">Dyed Yarn Rcv</th>
                        <th width="70">Gray Rcv</th>
                        <th width="70">Dyeing</th>
                        <th width="70">AOP</th>
                        <th width="70">FF Rcv</th>
                        <th width="70">Cutting</th>
                        <th width="70">Printing</th>
                        <th width="70">Embroidery</th>
                        <th width="70">Sewing Trims Rcv</th>
                        <th width="70">Sewing Input</th>                        
                        <th width="70">Sewing Output</th>
                        <th width="70">Washing</th>
                        <th width="70">Fin. Trims Rcv</th>
                        <th width="70">Finishing</th>
                        <th width="70">Actual PO Qty</th>
                    </tr>
                </thead>
            </table>
            <div style="width:1210px;overflow:auto;max-height:300px;" id="scroll_body">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1190">
                    <tbody>
                        <?
                        $i=1;
                        $gr_all_qty     = 0;
                        $gr_dy_qty      = 0;
                        $gr_grey_qty    = 0;
                        $gr_dye_qty     = 0;
                        $gr_aop_qty     = 0;
                        $gr_ff_rcv_qty  = 0;
                        $gr_cutting_qty = 0;
                        $gr_print_qty   = 0;
                        $gr_emb_qty     = 0;
                        $gr_sew_trim_qty =0;
                        $gr_input_qty   = 0;
                        $gr_output_qty  = 0;
                        $gr_wash_qty    = 0;
                        $gr_fin_trim_qty =0;
                        $gr_fin_qty     = 0;
                        $gr_ship_qty    = 0;
                        
                        foreach ($dataArray as $date => $row) 
                        {                         
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            $weekday= date("l", $date );
                            $bgcolors = ($weekday=="Friday") ? "red" : $bgcolor;
                            
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                <td bgcolor="<? echo $bgcolors; ?>" width="70"><? echo date('d-M-Y',$date); ?></td>
                                <td width="70" align="right"><? echo fn_number_format($row[48],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row[52],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row[60],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row[61],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row[63],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row[73],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row[84],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row[267],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row[268],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row[70],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row[122],0);?></td>                               
                                <td width="70" align="right"><? echo fn_number_format($row[86],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row[90],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row[71],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row[88],0);?></td>
                                <td width="70" align="right"><? echo fn_number_format($row['ex_qty'],0);?></td>
                            </tr>
                            <?
                            $i++;  
                            $gr_all_qty     += $row[48];
                            $gr_dy_qty      += $row[52];
                            $gr_grey_qty    += $row[60];
                            $gr_dye_qty     += $row[61];
                            $gr_aop_qty     += $row[63];
                            $gr_ff_rcv_qty  += $row[73];
                            $gr_cutting_qty += $row[84];
                            $gr_print_qty   += $row[267];
                            $gr_emb_qty     += $row[268];
                            $gr_sew_trim_qty  += $row[70];
                            $gr_input_qty   += $row[122];                            
                            $gr_output_qty  += $row[86];
                            $gr_wash_qty    += $row[90];
                            $gr_fin_trim_qty += $row[71];
                            $gr_fin_qty     += $row[88];
                            $gr_ship_qty    += $row['ex_qty'];
                            
                        }
                        ?>
                    </tbody>
                </table>
            </div>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1190">
                <tfoot>
                    <tr>
                        <th width="70">Gr. Total</th>
                        <th width="70"><? echo fn_number_format($gr_all_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_dy_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_grey_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_dye_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_aop_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_ff_rcv_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_cutting_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_print_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_emb_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_sew_trim_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_input_qty,0);?></th>                       
                        <th width="70"><? echo fn_number_format($gr_output_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_wash_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_fin_trim_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_fin_qty,0);?></th>
                        <th width="70"><? echo fn_number_format($gr_ship_qty,0);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <?
}

if($action=="plan_monitoring_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);  

    $mod_sql= sql_select("SELECT a.id,a.task_catagory,a.task_name,a.task_short_name,a.task_type,a.completion_percent,a.task_sequence_no,b.task_template_id,b.lead_time 
    from lib_tna_task a,tna_task_template_details b where a.task_name=b.tna_task_id and b.task_type=1 and a.is_deleted = 0 and a.status_active=1 and b.is_deleted = 0 and b.status_active=1 order by a.task_sequence_no asc");

    foreach ($mod_sql as $row)
    {
        $tna_task_name_array[$row[csf("task_name")]] = $row[csf("task_short_name")];
        $tna_task_name_arr[$row[csf("id")]]=$row[csf("task_name")];
    }
    //echo "<pre>";print_r($tna_task_name_array);
    // ====================================== ORDER INFO ==================================
    $sqlOrder = "SELECT a.style_ref_no as STYLE,b.grouping as INT_REF,b.PO_NUMBER from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in($poIds)";
    //echo $sqlOrder;die();
    $orderInfo = sql_select($sqlOrder);

    // ======================================= TNA DATA  ==================================
    
    $sqltna = "SELECT c.task_sequence_no,A.TASK_NUMBER,MAX(A.TASK_START_DATE) AS START_DATE,MAX(A.TASK_FINISH_DATE) AS END_DATE,MAX(A.ACTUAL_START_DATE) AS ACTUAL_START_DATE,MAX(A.ACTUAL_FINISH_DATE) AS ACTUAL_FINISH_DATE FROM TNA_PROCESS_MST A,WO_PO_BREAK_DOWN B,lib_tna_task c WHERE A.PO_NUMBER_ID=B.ID and a.task_number=c.task_name AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.PO_QUANTITY>0 and A.PO_NUMBER_ID in($poIds) AND A.TASK_TYPE=1 group by A.TASK_NUMBER,c.task_sequence_no order by c.task_sequence_no";
    //echo $sqltna;die();
    $tnaRes = sql_select($sqltna);
    $dataArray = array();
    foreach ($tnaRes as $val) 
    {
        $dataArray[$val['TASK_NUMBER']]['start_date']          = $val['START_DATE'];
        $dataArray[$val['TASK_NUMBER']]['end_date']            = $val['END_DATE'];
        $dataArray[$val['TASK_NUMBER']]['actual_start_date']   = $val['ACTUAL_START_DATE'];
        $dataArray[$val['TASK_NUMBER']]['actual_finish_date']  = $val['ACTUAL_FINISH_DATE'];
    }
    ?>    
    <div id="data_panel" align="center" style="width:640px">
        <script>
            function new_window()
            {
                document.getElementById('scroll_body').style.overflow="auto";
                document.getElementById('scroll_body').style.maxHeight="none"; 
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports2').innerHTML);
                d.close();
                document.getElementById('scroll_body').style.overflowY="scroll"; 
                document.getElementById('scroll_body').style.maxHeight="350px";
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 640px;" id="details_reports2">
        <style type="text/css">
           table tr th,table tr td{ word-wrap: break-word;word-break:break-all;}
        </style>
        <div class="header_part">
            <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="640">
                <caption><h2><b>Plan Monitoring</b></h2></caption>
                <thead>
                    <tr>
                        <td colspan="9" width="100%"><b>Style Name :<? echo $orderInfo[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref :<? echo $orderInfo[0]['INT_REF'];?></b>&nbsp;&nbsp;<b>PO No :<? echo $orderInfo[0]['PO_NUMBER'];?></b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="main_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="640">
                <thead>
                    <tr>
                        <th width="120">Task Name</th>
                        <th width="70">Plan Start</th>
                        <th width="70">Actual Start</th>
                        <th width="50">Delay</th>
                        <th width="70">Plan End</th>
                        <th width="70">Actual End</th>
                        <th width="50">Delay</th>
                        <th width="70">Plan Execution Day</th>
                        <th width="70">Actual Execution Day</th>
                    </tr>
                </thead>
            </table>
            <div style="width:660px;overflow:auto;max-height:350px;" id="scroll_body">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="640">
                    <tbody>
                        <?
                        $i=1;
                        
                        foreach ($dataArray as $task_id => $row) 
                        {        
                            $start_date     = new DateTime($row['start_date']);
                            $end_date       = new DateTime($row['end_date']);
                            $ac_start_date  = new DateTime($row['actual_start_date']);
                            $ac_end_date    = new DateTime($row['actual_finish_date']);
                            $delay_start    = $ac_start_date->diff($start_date)->format('%R%a');
                            $delay_end      = $ac_end_date->diff($end_date)->format('%R%a');

                            $pln_exe_delay  = $end_date->diff($start_date)->format('%R%a');
                            $act_exe_delay  = $ac_end_date->diff($ac_start_date)->format('%R%a');

                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                <td width="120" title="<? echo $task_id;?>"><? echo $tna_task_name_array[$task_id]; ?></td>
                                <td width="70" align="right"><? echo change_date_format($row['start_date']);?></td>
                                <td width="70" align="right"><? echo change_date_format($row['actual_start_date']);?></td>
                                <td width="50" align="right"><? echo fn_number_format($delay_start,0);?></td>
                                <td width="70" align="right"><? echo change_date_format($row['end_date']);?></td>
                                <td width="70" align="right"><? echo change_date_format($row['actual_finish_date']);?></td>
                                <td width="50" align="right"><? echo fn_number_format($delay_end,0);?></td>
                                <td width="70" align="right"><? echo ($row['start_date'] !="") ? fn_number_format(($pln_exe_delay+1),0) : 0;?></td>
                                <td width="70" align="right"><? echo ($row['actual_start_date'] !="") ? fn_number_format(($act_exe_delay+1),0) : 0;?></td>
                            </tr>
                            <?
                            $i++;  
                        }
                        ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <?
}

if($action=="garments_wash_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);
    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();      
    $wash= new wash($condition);
    $emblishment_costing_arr_name=$wash->getQtyArray_by_orderGmtsitemAndGmtscolor();
    // echo $wash->getQuery(); die; 
    // echo "<pre>";print_r($emblishment_costing_arr_name);
    $req_qty_array = array();

    foreach ($emblishment_costing_arr_name as $poId => $poData) 
    {
        foreach ($poData as $itemId => $itemData) 
        {
            foreach ($itemData as $colorId => $row) 
            {
                $req_qty_array[$itemId][$colorId] += $row;
            }
        }        
    }
    // echo "<pre>";print_r($req_qty_array);
    // ====================================== ITEM AND COLOR ==================================
    $sqlOrder = "SELECT a.style_ref_no as STYLE,b.grouping as INT_REF,c.color_number_id as COLOR_ID,c.item_number_id as ITEM_ID,sum(c.order_quantity) as QTY from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and b.id in($poIds) group by a.style_ref_no,b.grouping,c.color_number_id,c.item_number_id";
    //echo $sqlOrder;die();
    $sqlOrderRes = sql_select($sqlOrder);
    $dataArray = array();
    foreach ($sqlOrderRes as $val) 
    {
       $dataArray[$val['ITEM_ID']][$val['COLOR_ID']]['qty'] += $val['QTY'];
    }
    //====================================== GMTS PRODUCTION =====================================
    $sqlProd = "SELECT  a.id,a.item_number_id as ITEM_ID,c.color_number_id as COLOR_ID,min(a.production_date) AS PROD_DATE,a.COMPANY_ID, 
    sum(case when a.production_type=2 and a.embel_name=3 then b.production_qnty else 0 end) as WASH_ISSUE_QTY,
    sum(case when a.production_type=3 and a.embel_name=3 then b.production_qnty else 0 end) as WASH_RCV_QTY, 
    sum(case when a.production_type=3 and a.embel_name=3 then b.reject_qty else 0 end) as WASH_REJECT_QTY, 
    sum(case when a.production_type=5 then b.production_qnty else 0 end) as SEWING_QTY 
    from pro_garments_production_mst a, pro_garments_production_dtls b,wo_po_color_size_breakdown c
    where a.id=b.mst_id and c.id=b.color_size_break_down_id and a.po_break_down_id=c.po_break_down_id and a.status_active=1 and b.status_active=1 and a.production_type in(2,3,5) and a.po_break_down_id in($poIds) group by a.item_number_id,c.color_number_id,a.id,a.COMPANY_ID";
    // echo $sqlProd;die();
    $sqlProdRes = sql_select($sqlProd);
    $prodDataArray = array();
    foreach ($sqlProdRes as $val) 
    {
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['company_id']      = $val['COMPANY_ID'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['sewing_qty']      += $val['SEWING_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wash_issue_qty']  += $val['WASH_ISSUE_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wash_rcv_qty']    += $val['WASH_RCV_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wash_reject_qty'] += $val['WASH_REJECT_QTY'];
        if($val['WASH_ISSUE_QTY']>0)
        {
            $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['lst_issue_qty']  = $val['WASH_ISSUE_QTY'];
            $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['issue_date']  = $val['PROD_DATE'];
        }
        if($val['WASH_RCV_QTY']>0)
        {
            $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['lst_rcv_qty']  = $val['WASH_RCV_QTY'];
        }
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['date'] = $val['PROD_DATE'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['color_id'] = $val['COLOR_ID'];

    }
    // echo "<pre>";print_r($prodDataArray);

    // ================================== getting work order data ============================
    // $sqlWo = "SELECT b.gmt_item as ITEM_ID,c.color_number_id as COLOR_ID,b.delivery_date as DDATE,sum(c.requirment) as QTY from wo_booking_mst a,wo_booking_dtls b, wo_emb_book_con_dtls c,wo_pre_cost_embe_cost_dtls d where a.booking_no=b.booking_no and b.id=c.wo_booking_dtls_id and d.id=b.pre_cost_fabric_cost_dtls_id and d.emb_name=3 and b.po_break_down_id in($poIds) and a.item_category=25 and a.entry_form=201 and b.booking_type=6 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by b.gmt_item,c.color_number_id,b.delivery_date";
    $sqlWo = "SELECT a.SUPPLIER_ID,b.gmt_item as ITEM_ID,b.gmts_color_id as COLOR_ID,b.delivery_date as DDATE,sum(b.wo_qnty) as QTY from wo_booking_mst a,wo_booking_dtls b,wo_pre_cost_embe_cost_dtls d where a.booking_no=b.booking_no and d.id=b.pre_cost_fabric_cost_dtls_id and d.emb_name=3 and b.po_break_down_id in($poIds) and a.item_category=25 and b.booking_type=6 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  group by a.supplier_id,b.gmt_item,b.gmts_color_id,b.delivery_date";
    // echo $sqlWo;die();
    $woRes = sql_select($sqlWo);
    // $prodDataArray = array();
    foreach ($woRes as $val) 
    {
       $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wo_qty'] += $val['QTY'];
       $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wo_date'] = $val['DDATE'];
       $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['color_id'] = $val['COLOR_ID'];
    }
    // echo "<pre>";print_r($prodDataArray);die();
    //==================================== getting rowspan no =================================
    $rowspan = array();
    foreach ($prodDataArray as $itemId => $itemData) 
    {
        foreach ($itemData as $colorId => $row) 
        {
            $rowspan[$itemId]++;
        }
    }
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 100%;" id="details_reports">
        <div class="header_part">
            <table class="rpt_table" cellpadding="0" cellspacing="0"  rules="all" width="100%">
                <caption><b>Garments Wash Details</b></caption>
                <thead>
                    <tr>
                        <td colspan="24" width="100%"><b>Style Name:<? echo $sqlOrderRes[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref:<? echo $sqlOrderRes[0]['INT_REF'];?></b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <!-- ===================================== 1st part start ================================== -->
        <div class="first_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="760">
                <thead>
                    <tr>
                        <th width="100">Item</th>
                        <th width="100">Color</th>
                        <th width="80">Req qty</th>
                        <th width="80">Sewing Qty</th>
                        <th width="80">Send Qty</th>
                        <th width="80">Send Bal</th>
                        <th width="80">Ok Rcv Qty</th>
                        <th width="80">Rej Rcv Qty</th>
                        <th width="80">Wash Bal</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    $tot_req_qty = 0;
                    $tot_sew_qty = 0;
                    $tot_iss_qty = 0;
                    $tot_iss_bal = 0;
                    $tot_rcv_qty = 0;
                    $tot_rej_qty = 0;
                    $tot_wqash_bal = 0;
                    foreach ($prodDataArray as $itemId => $itemData) 
                    {
                        ksort($itemData);
                        foreach ($itemData as $colorName => $row) 
                        {  
                            if($req_qty_array[$itemId][$row['color_id']]>0)
                            {
                                $colorId = $row['color_id'];
                                $req_qty = $req_qty_array[$itemId][$colorId]*12;
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                    <td valign="middle"><? echo $garments_item[$itemId]; ?></td>                               
                                    <td><?=$colorName;?></td>
                                    <td align="right"><? echo fn_number_format($req_qty,0);?></td>
                                    <td align="right"><? echo fn_number_format($row['sewing_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_issue_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format(($req_qty-$row['wash_issue_qty']),0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_rcv_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_reject_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format(($req_qty-$row['wash_rcv_qty']),0);?></td>
                                </tr>
                                <?
                                $i++;
                                $tot_req_qty += $req_qty;
                                $tot_sew_qty += $row['sewing_qty'];
                                $tot_iss_qty += $row['wash_issue_qty'];
                                $tot_iss_bal += $req_qty-$row['wash_issue_qty'];
                                $tot_rcv_qty += $row['wash_rcv_qty'];
                                $tot_rej_qty += $row['wash_reject_qty'];
                                $tot_wqash_bal += $req_qty-$row['wash_rcv_qty'];
                            }
                        }
                    }
                    ?>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="2">Total</th>
                        <th><?=fn_number_format($tot_req_qty,0);?></th>
                        <th><?=fn_number_format($tot_sew_qty,0);?></th>
                        <th><?=fn_number_format($tot_iss_qty,0);?></th>
                        <th><?=fn_number_format($tot_iss_bal,0);?></th>
                        <th><?=fn_number_format($tot_rcv_qty,0);?></th>
                        <th><?=fn_number_format($tot_rej_qty,0);?></th>
                        <th><?=fn_number_format($tot_wqash_bal,0);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
        <!-- ===================================== 2nd part start ================================== -->
        <div class="second_part" style="margin-top:10px;">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1180">
                <thead>
                    <tr>
                        <th width="100">Factory</th>
                        <th width="100">Item</th>
                        <th width="100">Color</th>
                        <th width="80">Program Qty</th>
                        <th width="80">Program Date</th>
                        <th width="80">Send Qty</th>
                        <th width="80">Last Snd Date</th>
                        <th width="80">Last Snd Qty</th>
                        <th width="80">Send Bal</th>
                        <th width="80">Ok Rcv Qty </th>
                        <th width="80">Rej Rcv Qty</th>
                        <th width="80">Factory WIP</th>
                        <th width="80">Last Rcv Date</th>
                        <th width="80">Last Rcv Qty</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    $tot_req_qty = 0;
                    $tot_iss_qty = 0;
                    $tot_lst_iss_qty = 0;
                    $tot_iss_bal = 0;
                    $tot_rcv_qty = 0;
                    $tot_rej_qty = 0;
                    $tot_wip = 0;
                    $tot_lst_rcv_qty = 0;
                    foreach ($prodDataArray as $itemId => $itemData) 
                    {
                        $r=0;
                        ksort($itemData);
                        foreach ($itemData as $colorName => $row) 
                        {  
                            if($row['wo_qty']>0)
                            {
                                $colorId = $row['color_id'];
                                $woDznQty = $row['wo_qty']*12;
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                    <? if($r==0){?>
                                    <td valign="middle" rowspan="<? echo $rowspan[$itemId];?>">
    
                                        <a href="javascript:void(0)" onclick="open_gmts_color_popup('<? echo $row['company_id']."_".$poIds."_".$itemId."_".$colorId;?>')">
                                            <? echo $company_short_name_arr[$row['company_id']];?>                                        
                                        </a>
                                        
                                    </td>
                                    <?}?>
                                    <td> <? echo $garments_item[$itemId]; ?> </td>
                                    <td> <? echo $colorName;?> </td>
                                    <td align="right"><? echo fn_number_format($woDznQty,0);?></td>
                                    <td align="center"><? echo change_date_format($row['wo_date']);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_issue_qty'],0);?></td>
                                    <td align="center"><? echo change_date_format($row['issue_date']);?></td>
                                    <td align="right"><? echo fn_number_format($row['lst_issue_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format(($woDznQty - $row['wash_issue_qty']),0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_rcv_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_reject_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format(($row['wash_issue_qty']-$row['wash_rcv_qty']-$row['wash_reject_qty']),0);?></td>
                                    <td align="center"><? echo change_date_format($row['date']);?></td>
                                    <td align="right"><? echo fn_number_format($row['lst_rcv_qty'],0);?></td>
                                </tr>
                                <?
                                $i++;
                                $r++;
                                $tot_req_qty += $woDznQty;
                                $tot_iss_qty += $row['wash_issue_qty'];
                                $tot_lst_iss_qty += $row['lst_issue_qty'];
                                $tot_iss_bal += $woDznQty - $row['wash_issue_qty'];
                                $tot_rcv_qty += $row['wash_rcv_qty'];
                                $tot_rej_qty += $row['wash_reject_qty'];
                                $tot_wip += $row['wash_issue_qty']-$row['wash_rcv_qty']-$row['wash_reject_qty'];
                                $tot_lst_rcv_qty += $row['lst_rcv_qty'];
                            }
                        }
                    }
                    ?>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3">Total</th>
                        <th><?=fn_number_format($tot_req_qty,0);?></th>
                        <th></th>
                        <th><?=fn_number_format($tot_iss_qty,0);?></th>
                        <th></th>
                        <th><?=fn_number_format($tot_lst_iss_qty,0);?></th>
                        <th><?=fn_number_format($tot_iss_bal,0);?></th>
                        <th><?=fn_number_format($tot_rcv_qty,0);?></th>
                        <th><?=fn_number_format($tot_rej_qty,0);?></th>
                        <th><?=fn_number_format($tot_wip,0);?></th>
                        <th></th>
                        <th><?=fn_number_format($tot_lst_rcv_qty,0);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>   
    <script type="text/javascript">
        function open_gmts_color_popup(data)
        {
            var width = window.innerWidth;
            // width = width-30;        
            width = 640;        
            var action = "color_wise_garments_wash_popup";
            emailwindow = dhtmlmodal.open('EmailBox', 'iframe', 'order_monitoring_report_with_tna_controller.php?data=' + data + '&action=' + action, 'Garments Production Details Popup', 'width='+width+'px,height=350px,center=1,resize=0,scrolling=0', '../../');
        }
    </script>
    <?
}

if($action=="color_wise_garments_wash_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_size = return_library_array("select id,size_name from lib_size", "id", "size_name");
    extract($_REQUEST);
    $data = str_replace("'", "", $data);
    $dataEx = explode("_", $data);
    $company_id = $dataEx[0];
    $po_break_down_id = $dataEx[1];
    $itemId = $dataEx[2];
    $colorId = $dataEx[3];
    //====================================== GMTS PRODUCTION =====================================
    $sqlProd = "SELECT c.size_number_id as SIZE_ID,c.color_number_id as COLOR_ID,c.item_number_id as ITEM_ID,c.size_order, 
    sum(case when a.production_type=2 and a.embel_name=3 then b.production_qnty else 0 end) as WASH_ISSUE_QTY,
    sum(case when a.production_type=3 and a.embel_name=3 then b.production_qnty else 0 end) as WASH_RCV_QTY, 
    sum(case when a.production_type=3 and a.embel_name=3 then b.reject_qty else 0 end) as WASH_REJECT_QTY
    from pro_garments_production_mst a, pro_garments_production_dtls b,wo_po_color_size_breakdown c
    where a.id=b.mst_id and c.id=b.color_size_break_down_id and a.po_break_down_id=c.po_break_down_id and c.item_number_id=a.item_number_id and a.status_active=1 and b.status_active=1 and c.status_active=1 and a.production_type in(2,3) and a.po_break_down_id in($po_break_down_id) and a.item_number_id=$itemId and c.color_number_id=$colorId and a.company_id=$company_id group by c.size_number_id,c.color_number_id,c.item_number_id,c.size_order order by c.size_order";
    // echo $sqlProd;die();
    $sqlProdRes = sql_select($sqlProd);
    $prodDataArray = array();
    foreach ($sqlProdRes as $val) 
    {
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]][$val['SIZE_ID']]['wash_issue_qty']    = $val['WASH_ISSUE_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]][$val['SIZE_ID']]['wash_rcv_qty']      = $val['WASH_RCV_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]][$val['SIZE_ID']]['wash_reject_qty']   = $val['WASH_REJECT_QTY'];
    }
    //==================================== getting rowspan no =================================
    $itemrowspan = array();
    $colorrowspan = array();
    foreach ($prodDataArray as $itemId => $itemData) 
    {
        foreach ($itemData as $colorId => $colorData) 
        {
            foreach ($colorData as $sizeId => $row) 
            {
                $itemrowspan[$itemId]++;
                $colorrowspan[$itemId][$colorId]++;
            }
        }
    }
    ?>    
    <div id="data_panel" align="center" style="width:620px">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports2').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 620px;" id="details_reports2">
        <div class="main_part">
            <h2>Company Name : <? echo $company_short_name_arr[$company_id];?></h2>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="600">
                <thead>
                    <tr>
                        <th width="100">Item</th>
                        <th width="100">Color</th>
                        <th width="80">Size</th>
                        <th width="80">Sending Qty</th>
                        <th width="80">Ok Rcv Qty </th>
                        <th width="80">Rej Rcv Qty</th>
                        <th width="80">Factory WIP</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    $total_issue = 0;
                    $total_rcv = 0;
                    $total_rej = 0;
                    $total_wip = 0;
                    foreach ($prodDataArray as $itemId => $itemData) 
                    {
                        foreach ($itemData as $colorName => $colorData) 
                        {
                            foreach ($colorData as $sizeId => $row) 
                            { 
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                    <td><? echo $garments_item[$itemId]; ?></td>
                                    <td><? echo $colorName; ?></td>
                                    <td><? echo $lib_size[$sizeId]; ?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_issue_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_rcv_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_reject_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format(($row['wash_issue_qty']-$row['wash_rcv_qty']-$row['wash_reject_qty']),0);?></td>
                                </tr>
                                <?
                                $i++;
                                $total_issue += $row['wash_issue_qty'];
                                $total_rcv += $row['wash_rcv_qty'];
                                $total_rej += $row['wash_reject_qty'];
                                $total_wip += $row['wash_issue_qty']-$row['wash_rcv_qty']-$row['wash_reject_qty'];  
                            }
                        }                     
                    }
                    ?>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3">Total</th>
                        <th><?=fn_number_format($total_issue,0);?></th>
                        <th><?=fn_number_format($total_rcv,0);?></th>
                        <th><?=fn_number_format($total_rej,0);?></th>
                        <th><?=fn_number_format($total_wip,0);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <?
}

if($action=="garments_emb_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);
    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();      
    $emblishment= new emblishment($condition);
    $emblishment_costing_arr_name=$emblishment->getQtyArray_by_OrderGmtsitemGmtscolorAndEmbName();
    // echo $emblishment->getQuery(); die; 
    // echo "<pre>";print_r($emblishment_costing_arr_name);
    $req_qty_array = array();

    foreach ($emblishment_costing_arr_name as $poId => $poData) 
    {
        foreach ($poData as $itemId => $itemData) 
        {
            foreach ($itemData as $colorId => $row) 
            {
                //print_r($row);
                $req_qty_array[$itemId][$colorId] += $row[2];
            }
        }        
    }
    // echo "<pre>";print_r($req_qty_array);
     // ====================================== ITEM AND COLOR ==================================
    $sqlOrder = "SELECT a.style_ref_no as STYLE,b.grouping as INT_REF,c.color_number_id as COLOR_ID,c.item_number_id as ITEM_ID,sum(c.order_quantity) as QTY from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and b.id in($poIds) group by a.style_ref_no,b.grouping,c.color_number_id,c.item_number_id";
    //echo $sqlOrder;die();
    $sqlOrderRes = sql_select($sqlOrder);
    // ======================================= CUTTING QC ============================== 
    $sqlCutQC = "SELECT b.color_id as COLOR_ID ,c.item_number_id as ITEM_ID,sum(b.qc_pass_qty) as QTY,sum(b.replace_qty) as REPLACE_QTY,sum(b.reject_qty) as REJQNTY from pro_gmts_cutting_qc_mst a,pro_gmts_cutting_qc_dtls b,wo_po_color_size_breakdown c where a.id=b.mst_id and b.order_id=c.po_break_down_id and c.id=b.color_size_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active =1 and b.order_id in($poIds) group by b.color_id ,c.item_number_id";
    // echo $sqlCutQC;die();
    $CutQCRes = sql_select($sqlCutQC);
    $dataArray = array();
    foreach ($CutQCRes as  $val) 
    {
       $dataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['cut_qc_ok']    = $val['QTY'];
       $dataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['color_id']    = $val['COLOR_ID'];
    }
    //====================================== GMTS PRODUCTION =====================================
    $sqlProd = "SELECT  a.id,a.item_number_id as ITEM_ID,c.color_number_id as COLOR_ID,min(a.production_date) AS PROD_DATE,a.SERVING_COMPANY,a.production_source, 
    sum(case when a.production_type=2 and a.embel_name=2 then b.production_qnty else 0 end) as WASH_ISSUE_QTY,
    sum(case when a.production_type=3 and a.embel_name=2 then b.production_qnty else 0 end) as WASH_RCV_QTY, 
    sum(case when a.production_type=3 and a.embel_name=2 then b.reject_qty else 0 end) as WASH_REJECT_QTY
    from pro_garments_production_mst a, pro_garments_production_dtls b,wo_po_color_size_breakdown c
    where a.id=b.mst_id and c.id=b.color_size_break_down_id and a.po_break_down_id=c.po_break_down_id and a.status_active=1 and b.status_active=1 and a.production_type in(2,3) and a.po_break_down_id in($poIds) group by a.item_number_id,c.color_number_id,a.id,a.SERVING_COMPANY,a.production_source";
    // echo $sqlProd;die();
    $sqlProdRes = sql_select($sqlProd);
    $prodDataArray = array();
    foreach ($sqlProdRes as $val) 
    {
        $dataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wash_issue_qty']     += $val['WASH_ISSUE_QTY'];
        $dataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wash_rcv_qty']       += $val['WASH_RCV_QTY'];
        $dataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wash_reject_qty']    += $val['WASH_REJECT_QTY'];
        $dataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['color_id']    = $val['COLOR_ID'];

        if($val['PRODUCTION_SOURCE']==1)
        {
            $s_company = $company_short_name_arr[$val['SERVING_COMPANY']];
        }
        else
        {
            $s_company = $lib_supplier[$val['SERVING_COMPANY']];
        }
        
        $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['company_id']      = $val['COMPANY_ID'];
        $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wash_issue_qty']  += $val['WASH_ISSUE_QTY'];
        $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wash_rcv_qty']    += $val['WASH_RCV_QTY'];
        $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wash_reject_qty'] += $val['WASH_REJECT_QTY'];
        if($val['WASH_ISSUE_QTY']>0)
        {
            $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['lst_issue_qty']  = $val['WASH_ISSUE_QTY'];
            $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['issue_date']  = $val['PROD_DATE'];
        }
        if($val['WASH_RCV_QTY']>0)
        {
            $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['lst_rcv_qty']  = $val['WASH_RCV_QTY'];
        }
        $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['color_id'] = $val['COLOR_ID'];
        $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['s_company'] = $val['SERVING_COMPANY'];

    }
    // echo "<pre>";print_r($prodDataArray);

    // ================================== getting work order data ============================
    // $sqlWo = "SELECT a.SUPPLIER_ID,b.gmt_item as ITEM_ID,c.color_number_id as COLOR_ID,b.delivery_date as DDATE,sum(c.requirment) as QTY from wo_booking_mst a,wo_booking_dtls b, wo_emb_book_con_dtls c,wo_pre_cost_embe_cost_dtls d where a.booking_no=b.booking_no and b.id=c.wo_booking_dtls_id and d.id=b.pre_cost_fabric_cost_dtls_id and d.emb_name=2 and b.po_break_down_id in($poIds) and a.item_category=25 and a.entry_form=201 and b.booking_type=6 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.supplier_id,b.gmt_item,c.color_number_id,b.delivery_date";
    $sqlWo = "SELECT a.SUPPLIER_ID,a.source,b.gmt_item as ITEM_ID,b.gmts_color_id as COLOR_ID,b.delivery_date as DDATE,sum(b.wo_qnty) as QTY from wo_booking_mst a,wo_booking_dtls b,wo_pre_cost_embe_cost_dtls d where a.booking_no=b.booking_no and d.id=b.pre_cost_fabric_cost_dtls_id and d.emb_name=2 and b.po_break_down_id in($poIds) and a.item_category=25 and b.booking_type=6 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.gmts_color_id>0 and b.wo_qnty>0 group by a.supplier_id,a.source,b.gmt_item,b.gmts_color_id,b.delivery_date";
    // echo $sqlWo;die();
    $woRes = sql_select($sqlWo);
    // $prodDataArray = array();
    foreach ($woRes as $val) 
    {
        if($val['SOURCE']==1)
        {
            $s_company = $company_short_name_arr[$val['SUPPLIER_ID']];
        }
        else
        {
            $s_company = $lib_supplier[$val['SUPPLIER_ID']];
        }
       $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wo_qty'] += $val['QTY'];
       $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wo_date'] = $val['DDATE'];
       $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['s_company'] = $val['SUPPLIER_ID'];
    }
    // echo "<pre>";print_r($prodDataArray);die();
    //==================================== getting rowspan no =================================
    $rowspan = array();
    foreach ($prodDataArray as $cId => $comData) 
    {
        foreach ($comData as $itemId => $itemData) 
        {
            foreach ($itemData as $colorId => $row) 
            {
                if($row['wo_qty']>0 || $row['wash_issue_qty']>0 || $row['wash_rcv_qty']>0)
                {
                    $rowspan[$cId][$itemId]++;
                }
            }
        }
    }
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 100%;" id="details_reports">
        <div class="header_part">
            <table class="rpt_table" cellpadding="0" cellspacing="0"  rules="all" width="100%">
                <caption><b>Garments Embroidery Details</b></caption>
                <thead>
                    <tr>
                        <td colspan="24" width="100%"><b>Style Name:<? echo $sqlOrderRes[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref:<? echo $sqlOrderRes[0]['INT_REF'];?></b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <!-- ===================================== 1st part start ================================== -->
        <div class="first_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="760">
                <thead>
                    <tr>
                        <th width="100">Item</th>
                        <th width="100">Color</th>
                        <th width="80">Req qty</th>
                        <th width="80">Cut QC Qty</th>
                        <th width="80">Send Qty</th>
                        <th width="80">Send Bal</th>
                        <th width="80">Ok Rcv Qty</th>
                        <th width="80">Rej Rcv Qty</th>
                        <th width="80">Emb Bal</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    $total_req = 0;
                    $total_qc = 0;
                    $total_issue = 0;
                    $total_issue_bal = 0;
                    $total_rcv = 0;
                    $total_rej = 0;
                    $total_emb_bal = 0;
                    foreach ($dataArray as $itemId => $itemData) 
                    {
                        foreach ($itemData as $colorName => $row) 
                        {  
                            //if($req_qty_array[$itemId][$colorId]>0)
                            //{
                                $colorId = $row['color_id'];
                                $req_qty = $req_qty_array[$itemId][$colorId]*12;
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                    <td valign="middle"><? echo $garments_item[$itemId]; ?></td>                               
                                    <td><? echo $colorName;?></td>
                                    <td align="right"><? echo fn_number_format($req_qty,0);?></td>
                                    <td align="right"><? echo fn_number_format($row['cut_qc_ok'],0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_issue_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format(($req_qty-$row['wash_issue_qty']),0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_rcv_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_reject_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format(($req_qty-$row['wash_rcv_qty']),0);?></td>
                                </tr>
                                <?
                                $i++;
                                $total_req += $req_qty;
                                $total_qc += $row['cut_qc_ok'];
                                $total_issue += $row['wash_issue_qty'];
                                $total_issue_bal += $req_qty-$row['wash_issue_qty'];
                                $total_rcv += $row['wash_rcv_qty'];
                                $total_rej += $row['wash_reject_qty'];
                                $total_emb_bal += $req_qty-$row['wash_rcv_qty'];
                            //}
                        }
                    }
                    ?>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="2">Total</th>
                        <th><?=fn_number_format($total_req,0);?></th>
                        <th><?=fn_number_format($total_qc,0);?></th>
                        <th><?=fn_number_format($total_issue,0);?></th>
                        <th><?=fn_number_format($total_issue_bal,0);?></th>
                        <th><?=fn_number_format($total_rcv,0);?></th>
                        <th><?=fn_number_format($total_rej,0);?></th>
                        <th><?=fn_number_format($total_emb_bal,0);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
        <!-- ===================================== 2nd part start ================================== -->
        <div class="second_part" style="margin-top:10px;">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1180">
                <thead>
                    <tr>
                        <th width="100">Factory</th>
                        <th width="100">Item</th>
                        <th width="100">Color</th>
                        <th width="80">Program Qty</th>
                        <th width="80">Program Date</th>
                        <th width="80">Send Qty</th>
                        <th width="80">Last Snd Date</th>
                        <th width="80">Last Snd Qty</th>
                        <th width="80">Send Bal</th>
                        <th width="80">Ok Rcv Qty </th>
                        <th width="80">Rej Rcv Qty</th>
                        <th width="80">Factory WIP</th>
                        <th width="80">Last Rcv Date</th>
                        <th width="80">Last Rcv Qty</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;     
                    ksort($prodDataArray);
                    foreach ($prodDataArray as $servingComName => $compData) 
                    {
                        foreach ($compData as $itemId => $itemData) 
                        {
                            $r=0;
                            ksort($itemData);
                            foreach ($itemData as $colorName => $row) 
                            {  
                                if($row['wo_qty']>0 || $row['wash_issue_qty']>0 || $row['wash_rcv_qty']>0)
                                {
                                    $servingCom = $row['s_company'];
                                    $colorId = $row['color_id'];
                                    $woDznQty = $row['wo_qty']*12;
                                    $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                    ?>                        
                                    <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                        <? if($r==0){?>
                                        <td valign="middle" rowspan="<? echo $rowspan[$servingComName][$itemId];?>">
        
                                            <a href="javascript:void(0)" onclick="open_gmts_color_popup('<? echo $servingCom."_".$poIds."_".$itemId."_".$colorId;?>')">
                                                <? echo ($company_short_name_arr[$servingCom]!="") ? $company_short_name_arr[$servingCom] : $lib_supplier[$servingCom];?>                                        
                                            </a>
                                            
                                        </td>
                                        <?}?>
                                        <td> <? echo $garments_item[$itemId]; ?> </td>
                                        <td> <? echo $lib_color[$colorId];?> </td>
                                        <td align="right"><? echo fn_number_format($woDznQty,0);?></td>
                                        <td align="center"><? echo change_date_format($row['wo_date']);?></td>
                                        <td align="right"><? echo fn_number_format($row['wash_issue_qty'],0);?></td>
                                        <td align="center"><? echo change_date_format($row['issue_date']);?></td>
                                        <td align="right"><? echo fn_number_format($row['lst_issue_qty'],0);?></td>
                                        <td align="right"><? echo fn_number_format(($woDznQty - $row['wash_issue_qty']),0);?></td>
                                        <td align="right"><? echo fn_number_format($row['wash_rcv_qty'],0);?></td>
                                        <td align="right"><? echo fn_number_format($row['wash_reject_qty'],0);?></td>
                                        <td align="right"><? echo fn_number_format(($row['wash_issue_qty']-$row['wash_rcv_qty']-$row['wash_reject_qty']),0);?></td>
                                        <td align="center"><? echo change_date_format($row['date']);?></td>
                                        <td align="right"><? echo fn_number_format($row['lst_rcv_qty'],0);?></td>
                                    </tr>
                                    <?
                                    $i++;
                                    $r++;
                                    $tot_prog_qty += $woDznQty;
                                    $tot_wash_issue_qty += $row['wash_issue_qty'];
                                    $tot_lst_issue_qty += $row['lst_issue_qty'];
                                    $tot_issue_bal += $woDznQty - $row['wash_issue_qty'];
                                    $tot_wash_rcv_qty += $row['wash_rcv_qty'];
                                    $tot_wash_reject_qty += $row['wash_reject_qty'];
                                    $tot_wip += $row['wash_issue_qty']-$row['wash_rcv_qty']-$row['wash_reject_qty'];
                                    $tot_lst_rcv_qty += $row['lst_rcv_qty'];
                                }
                            }
                        }
                    }
                    ?>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3">Total</th>
                        <th><?=fn_number_format($tot_prog_qty,0);?></th>
                        <th></th>
                        <th><?=fn_number_format($tot_wash_issue_qty,0);?></th>
                        <th></th>
                        <th><?=fn_number_format($tot_lst_issue_qty,0);?></th>
                        <th><?=fn_number_format($tot_issue_bal,0);?></th>
                        <th><?=fn_number_format($tot_wash_rcv_qty,0);?></th>
                        <th><?=fn_number_format($tot_wash_reject_qty,0);?></th>
                        <th><?=fn_number_format($tot_wip,0);?></th>
                        <th></th>
                        <th><?=fn_number_format($tot_lst_rcv_qty,0);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>   
    <script type="text/javascript">
        function open_gmts_color_popup(data)
        {
            var width = window.innerWidth;
            // width = width-30;        
            width = 640;        
            var action = "color_wise_garments_emb_popup";
            emailwindow = dhtmlmodal.open('EmailBox', 'iframe', 'order_monitoring_report_with_tna_controller.php?data=' + data + '&action=' + action, 'Garments Production Details Popup', 'width='+width+'px,height=350px,center=1,resize=0,scrolling=0', '../../');
        }
    </script>
    <?
}

if($action=="color_wise_garments_emb_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_size = return_library_array("select id,size_name from lib_size", "id", "size_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    extract($_REQUEST);
    $data = str_replace("'", "", $data);
    $dataEx = explode("_", $data);
    $company_id = $dataEx[0];
    $po_break_down_id = $dataEx[1];
    $itemId = $dataEx[2];
    $colorId = $dataEx[3];
    //====================================== GMTS PRODUCTION =====================================
    $sqlProd = "SELECT c.size_number_id as SIZE_ID,c.color_number_id as COLOR_ID,c.item_number_id as ITEM_ID,c.size_order, 
    sum(case when a.production_type=2 and a.embel_name=2 then b.production_qnty else 0 end) as WASH_ISSUE_QTY,
    sum(case when a.production_type=3 and a.embel_name=2 then b.production_qnty else 0 end) as WASH_RCV_QTY, 
    sum(case when a.production_type=3 and a.embel_name=2 then b.reject_qty else 0 end) as WASH_REJECT_QTY
    from pro_garments_production_mst a, pro_garments_production_dtls b,wo_po_color_size_breakdown c
    where a.id=b.mst_id and c.id=b.color_size_break_down_id and a.po_break_down_id=c.po_break_down_id and c.item_number_id=a.item_number_id and a.status_active=1 and b.status_active=1 and a.production_type in(2,3) and a.po_break_down_id in($po_break_down_id) and a.item_number_id=$itemId  and a.serving_company=$company_id group by c.size_number_id,c.color_number_id,c.item_number_id,c.size_order order by c.size_order";//and c.color_number_id=$colorId
    // echo $sqlProd;die();
    $sqlProdRes = sql_select($sqlProd);
    $prodDataArray = array();
    foreach ($sqlProdRes as $val) 
    {
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]][$val['SIZE_ID']]['wash_issue_qty']    = $val['WASH_ISSUE_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]][$val['SIZE_ID']]['wash_rcv_qty']      = $val['WASH_RCV_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]][$val['SIZE_ID']]['wash_reject_qty']   = $val['WASH_REJECT_QTY'];
    }
    //==================================== getting rowspan no =================================
    $itemrowspan = array();
    $colorrowspan = array();
    foreach ($prodDataArray as $itemId => $itemData) 
    {
        foreach ($itemData as $colorId => $colorData) 
        {
            foreach ($colorData as $sizeId => $row) 
            {
                $itemrowspan[$itemId]++;
                $colorrowspan[$itemId][$colorId]++;
            }
        }
    }
    ?>    
    <div id="data_panel" align="center" style="width:620px">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports2').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 620px;" id="details_reports2">
        <div class="main_part">
            <h2>Factory Name :  <? echo ($company_short_name_arr[$company_id]!="") ? $company_short_name_arr[$company_id] : $lib_supplier[$company_id];?></h2>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="600">
                <thead>
                    <tr>
                        <th width="100">Item</th>
                        <th width="100">Color</th>
                        <th width="80">Size</th>
                        <th width="80">Sending Qty</th>
                        <th width="80">Ok Rcv Qty </th>
                        <th width="80">Rej Rcv Qty</th>
                        <th width="80">Factory WIP</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    $total_issue = 0;
                    $total_rcv = 0;
                    $total_rej = 0;
                    $total_wip = 0;
                    foreach ($prodDataArray as $itemId => $itemData) 
                    {
                        ksort($itemData);
                        foreach ($itemData as $colorName => $colorData) 
                        {
                            foreach ($colorData as $sizeId => $row) 
                            { 
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                    <td><? echo $garments_item[$itemId]; ?></td>
                                    <td><? echo $colorName; ?></td>
                                    <td><? echo $lib_size[$sizeId]; ?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_issue_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_rcv_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_reject_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format(($row['wash_issue_qty']-$row['wash_rcv_qty']-$row['wash_reject_qty']),0);?></td>
                                </tr>
                                <?
                                $i++; 
                                $total_issue += $row['wash_issue_qty'];
                                $total_rcv += $row['wash_rcv_qty'];
                                $total_rej += $row['wash_reject_qty'];
                                $total_wip += $row['wash_issue_qty']-$row['wash_rcv_qty']-$row['wash_reject_qty'];   
                            }
                        }                     
                    }
                    ?>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3">Total</th>
                        <th><?=fn_number_format($total_issue,0);?></th>
                        <th><?=fn_number_format($total_rcv,0);?></th>
                        <th><?=fn_number_format($total_rej,0);?></th>
                        <th><?=fn_number_format($total_wip,0);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <?
}

if($action=="garments_print_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);
    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();      
    $emblishment= new emblishment($condition);
    $emblishment_costing_arr_name=$emblishment->getQtyArray_by_OrderGmtsitemGmtscolorAndEmbName();
    // echo $emblishment->getQuery(); die; 
    // echo "<pre>";print_r($emblishment_costing_arr_name);
    $req_qty_array = array();

    foreach ($emblishment_costing_arr_name as $poId => $poData) 
    {
        foreach ($poData as $itemId => $itemData) 
        {
            foreach ($itemData as $colorId => $row) 
            {
                $req_qty_array[$itemId][$colorId] += $row[1];
            }
        }        
    }
    // echo "<pre>";print_r($req_qty_array);
     // ====================================== ITEM AND COLOR ==================================
    $sqlOrder = "SELECT a.style_ref_no as STYLE,b.grouping as INT_REF,c.color_number_id as COLOR_ID,c.item_number_id as ITEM_ID,sum(c.order_quantity) as QTY from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.id in($poIds) group by a.style_ref_no,b.grouping,c.color_number_id,c.item_number_id";
    //echo $sqlOrder;die();
    $sqlOrderRes = sql_select($sqlOrder);
    // ======================================= CUTTING QC ============================== 
    $sqlCutQC = "SELECT b.color_id as COLOR_ID ,c.item_number_id as ITEM_ID,sum(b.qc_pass_qty) as QTY,sum(b.replace_qty) as REPLACE_QTY,sum(b.reject_qty) as REJQNTY from pro_gmts_cutting_qc_mst a,pro_gmts_cutting_qc_dtls b,wo_po_color_size_breakdown c where a.id=b.mst_id and b.order_id=c.po_break_down_id and c.id=b.color_size_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and b.order_id in($poIds) group by b.color_id ,c.item_number_id";
    // echo $sqlCutQC;die();
    $CutQCRes = sql_select($sqlCutQC);
    $dataArray = array();
    foreach ($CutQCRes as  $val) 
    {
       $dataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['cut_qc_ok']   = $val['QTY'];
       $dataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['color_id']    = $val['COLOR_ID'];
    }
    //====================================== GMTS PRODUCTION =====================================
    $sqlProd = "SELECT  a.id,a.item_number_id as ITEM_ID,c.color_number_id as COLOR_ID,min(a.production_date) AS PROD_DATE,a.SERVING_COMPANY,a.production_source, 
    sum(case when a.production_type=2 and a.embel_name=1 then b.production_qnty else 0 end) as WASH_ISSUE_QTY,
    sum(case when a.production_type=3 and a.embel_name=1 then b.production_qnty else 0 end) as WASH_RCV_QTY, 
    sum(case when a.production_type=3 and a.embel_name=1 then b.reject_qty else 0 end) as WASH_REJECT_QTY
    from pro_garments_production_mst a, pro_garments_production_dtls b,wo_po_color_size_breakdown c
    where a.id=b.mst_id and c.id=b.color_size_break_down_id and a.po_break_down_id=c.po_break_down_id and a.status_active=1 and b.status_active=1 and c.status_active=1 and a.production_type in(2,3) and a.po_break_down_id in($poIds) group by a.item_number_id,c.color_number_id,a.id,a.serving_company,a.production_source";
    // echo $sqlProd;die();
    $sqlProdRes = sql_select($sqlProd);
    // $prodDataArray = array();
    foreach ($sqlProdRes as $val) 
    {
        $dataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wash_issue_qty']     += $val['WASH_ISSUE_QTY'];
        $dataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wash_rcv_qty']       += $val['WASH_RCV_QTY'];
        $dataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wash_reject_qty']    += $val['WASH_REJECT_QTY'];
        $dataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['color_id']    = $val['COLOR_ID'];

        if($val['PRODUCTION_SOURCE']==1)
        {
            $s_company = $company_short_name_arr[$val['SERVING_COMPANY']];
        }
        else
        {
            $s_company = $lib_supplier[$val['SERVING_COMPANY']];
        }
        
        $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['company_id']      = $val['COMPANY_ID'];
        $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wash_issue_qty']  += $val['WASH_ISSUE_QTY'];
        $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wash_rcv_qty']    += $val['WASH_RCV_QTY'];
        $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wash_reject_qty'] += $val['WASH_REJECT_QTY'];
        if($val['WASH_ISSUE_QTY']>0)
        {
            $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['lst_issue_qty']  = $val['WASH_ISSUE_QTY'];
            $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['issue_date']  = $val['PROD_DATE'];
        }
        if($val['WASH_RCV_QTY']>0)
        {
            $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['lst_rcv_qty']  = $val['WASH_RCV_QTY'];
        }
        $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['date'] = $val['PROD_DATE'];
        $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['color_id'] = $val['COLOR_ID'];
        $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['s_company'] = $val['SERVING_COMPANY'];
        $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['source'] = $val['PRODUCTION_SOURCE'];

    }
    // echo "<pre>";print_r($prodDataArray);

    // ================================== getting work order data ============================
    // $sqlWo = "SELECT a.SUPPLIER_ID,b.gmt_item as ITEM_ID,c.color_number_id as COLOR_ID,b.delivery_date as DDATE,sum(c.requirment) as QTY from wo_booking_mst a,wo_booking_dtls b, wo_emb_book_con_dtls c,wo_pre_cost_embe_cost_dtls d where a.booking_no=b.booking_no and b.id=c.wo_booking_dtls_id and d.id=b.pre_cost_fabric_cost_dtls_id and d.emb_name=1 and b.po_break_down_id in($poIds) and a.item_category=25 and a.entry_form=201 and b.booking_type=6 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.supplier_id,b.gmt_item,c.color_number_id,b.delivery_date";
    $sqlWo = "SELECT a.SUPPLIER_ID,a.SOURCE,b.gmt_item as ITEM_ID,b.gmts_color_id as COLOR_ID,b.delivery_date as DDATE,sum(b.wo_qnty) as QTY from wo_booking_mst a,wo_booking_dtls b,wo_pre_cost_embe_cost_dtls d where a.booking_no=b.booking_no and d.id=b.pre_cost_fabric_cost_dtls_id and d.emb_name=1 and b.po_break_down_id in($poIds) and a.item_category=25 and b.booking_type=6 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.gmts_color_id>0 and b.wo_qnty>0 group by a.supplier_id,a.source,b.gmt_item,b.gmts_color_id,b.delivery_date";
    // echo $sqlWo;die();
    $woRes = sql_select($sqlWo);
    // $prodDataArray = array();
    foreach ($woRes as $val) 
    {
        if($val['SOURCE']==1)
        {
            $s_company = $company_short_name_arr[$val['SUPPLIER_ID']];
        }
        else
        {
            $s_company = $lib_supplier[$val['SUPPLIER_ID']];
        }
       $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wo_qty'] += $val['QTY'];
       $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['wo_date'] = $val['DDATE'];
       $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['color_id'] = $val['COLOR_ID'];
       $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['s_company'] = $val['SUPPLIER_ID'];
       $prodDataArray[$s_company][$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]]['source'] = $val['SOURCE'];
    }
    // echo "<pre>";print_r($prodDataArray);die();
    //==================================== getting rowspan no =================================
    $rowspan = array();
    foreach ($prodDataArray as $cId => $comData) 
    {
        foreach ($comData as $itemId => $itemData) 
        {
            foreach ($itemData as $colorId => $row) 
            {
                if($row['wo_qty']>0 || $row['wash_issue_qty']>0 || $row['wash_rcv_qty']>0)
                {
                    $rowspan[$cId][$itemId]++;
                }
            }
        }
    }
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 100%;" id="details_reports">
        <div class="header_part">
            <table class="rpt_table" cellpadding="0" cellspacing="0"  rules="all" width="100%">
                <caption><b>Garments Printing Details</b></caption>
                <thead>
                    <tr>
                        <td colspan="24" width="100%"><b>Style Name:<? echo $sqlOrderRes[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref:<? echo $sqlOrderRes[0]['INT_REF'];?></b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <!-- ===================================== 1st part start ================================== -->
        <div class="first_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="760">
                <thead>
                    <tr>
                        <th width="100">Item</th>
                        <th width="100">Color</th>
                        <th width="80">Req qty</th>
                        <th width="80">Cut QC Qty</th>
                        <th width="80">Send Qty</th>
                        <th width="80">Send Bal</th>
                        <th width="80">Ok Rcv Qty</th>
                        <th width="80">Rej Rcv Qty</th>
                        <th width="80">Print Bal</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    foreach ($dataArray as $itemId => $itemData) 
                    {
                        ksort($itemData);
                        foreach ($itemData as $colorName => $row) 
                        {  
                            //if($req_qty_array[$itemId][$colorId]>0)
                            //{
                                $colorId = $row['color_id'];
                                $req_qty = $req_qty_array[$itemId][$colorId]*12;
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                    <td valign="middle"><? echo $garments_item[$itemId]; ?></td>                               
                                    <td><? echo $colorName;?></td>
                                    <td align="right"><? echo fn_number_format($req_qty,0);?></td>
                                    <td align="right"><? echo fn_number_format($row['cut_qc_ok'],0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_issue_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format(($req_qty-$row['wash_issue_qty']),0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_rcv_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_reject_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format(($req_qty-$row['wash_rcv_qty']),0);?></td>
                                </tr>
                                <?
                                $i++;
                                $total_req_qty += $req_qty; 
                                $total_cut_qc_ok += $row['cut_qc_ok']; 
                                $total_issue_qty += $row['wash_issue_qty']; 
                                $total_issue_bal += $req_qty-$row['wash_issue_qty'];; 
                                $total_rcv_qty += $row['wash_rcv_qty']; 
                                $total_rej_qty += $row['wash_reject_qty']; 
                                $total_bal_qty += $req_qty-$row['wash_rcv_qty']; 
                            //}
                        }
                    }
                    ?>
                </tbody>
                <tfoot>
                    <tr>
                        <th valign="middle"></th>                               
                        <th>Total</th>
                        <th align="right"><?=fn_number_format($total_req_qty,0);?></th>
                        <th align="right"><?=fn_number_format($total_cut_qc_ok,0);?></th>
                        <th align="right"><?=fn_number_format($total_issue_qty,0);?></th>
                        <th align="right"><?=fn_number_format($total_issue_bal,0);?></th>
                        <th align="right"><?=fn_number_format($total_rcv_qty,0);?></th>
                        <th align="right"><?=fn_number_format($total_rej_qty,0);?></th>
                        <th align="right"><?=fn_number_format($total_bal_qty,0);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
        <!-- ===================================== 2nd part start ================================== -->
        <div class="second_part" style="margin-top:10px;">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1180">
                <thead>
                    <tr>
                        <th width="100">Factory</th>
                        <th width="100">Item</th>
                        <th width="100">Color</th>
                        <th width="80">Program Qty</th>
                        <th width="80">Program Date</th>
                        <th width="80">Send Qty</th>
                        <th width="80">Last Snd Date</th>
                        <th width="80">Last Snd Qty</th>
                        <th width="80">Send Bal</th>
                        <th width="80">Ok Rcv Qty </th>
                        <th width="80">Rej Rcv Qty</th>
                        <th width="80">Factory WIP</th>
                        <th width="80">Last Rcv Date</th>
                        <th width="80">Last Rcv Qty</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    ksort($prodDataArray);
                    foreach ($prodDataArray as $compName => $compData) 
                    {
                        foreach ($compData as $itemId => $itemData) 
                        {
                            $r=0;
                            ksort($itemData);
                            foreach ($itemData as $colorName => $row) 
                            {  
                               if($row['wo_qty']>0 || $row['wash_issue_qty']>0 || $row['wash_rcv_qty']>0)
                               {
                                    $compId = $row['s_company'];
                                    $colorId = $row['color_id'];
                                    $woDznQty = $row['wo_qty']*12;
                                    $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                    ?>                        
                                    <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                        <? if($r==0){?>
                                        <td valign="middle" rowspan="<? echo $rowspan[$compName][$itemId];?>">
        
                                            <a href="javascript:void(0)" onclick="open_gmts_color_popup('<? echo $compId."_".$poIds."_".$itemId."_".$colorId;?>')">
                                                <?=$compName;?>                                      
                                            </a>
                                            
                                        </td>
                                        <?}?>
                                        <td title="<? echo $itemId;?>"> <? echo $garments_item[$itemId]; ?> </td>
                                        <td title="<? echo $colorId;?>"> <? echo $colorName;?> </td>
                                        <td align="right"><? echo fn_number_format($woDznQty,0);?></td>
                                        <td align="center"><? echo change_date_format($row['wo_date']);?></td>
                                        <td align="right"><? echo fn_number_format($row['wash_issue_qty'],0);?></td>
                                        <td align="center"><? echo change_date_format($row['issue_date']);?></td>
                                        <td align="right"><? echo fn_number_format($row['lst_issue_qty'],0);?></td>
                                        <td align="right"><? echo fn_number_format(($woDznQty - $row['wash_issue_qty']),0);?></td>
                                        <td align="right"><? echo fn_number_format($row['wash_rcv_qty'],0);?></td>
                                        <td align="right"><? echo fn_number_format($row['wash_reject_qty'],0);?></td>
                                        <td align="right"><? echo fn_number_format(($row['wash_issue_qty']-$row['wash_rcv_qty']-$row['wash_reject_qty']),0);?></td>
                                        <td align="center"><? echo change_date_format($row['date']);?></td>
                                        <td align="right"><? echo fn_number_format($row['lst_rcv_qty'],0);?></td>
                                    </tr>
                                    <?
                                    $i++;
                                    $r++;
                                    $tot_prog_qty += $woDznQty;
                                    $tot_wash_issue_qty += $row['wash_issue_qty'];
                                    $tot_lst_issue_qty += $row['lst_issue_qty'];
                                    $tot_issue_bal += $woDznQty - $row['wash_issue_qty'];
                                    $tot_wash_rcv_qty += $row['wash_rcv_qty'];
                                    $tot_wash_reject_qty += $row['wash_reject_qty'];
                                    $tot_wip += $row['wash_issue_qty']-$row['wash_rcv_qty']-$row['wash_reject_qty'];
                                    $tot_lst_rcv_qty += $row['lst_rcv_qty'];
                                }
                            }
                        }
                    }
                    ?>
                </tbody>
                <tfoot>
                    <tr>                        
                        <th colspan="3">Total</th>
                        <th><?=fn_number_format($tot_prog_qty,0);?></th>
                        <th></th>
                        <th><?=fn_number_format($tot_wash_issue_qty,0);?></th>
                        <th></th>
                        <th><?=fn_number_format($tot_lst_issue_qty,0);?></th>
                        <th><?=fn_number_format($tot_issue_bal,0);?></th>
                        <th><?=fn_number_format($tot_wash_rcv_qty,0);?></th>
                        <th><?=fn_number_format($tot_wash_reject_qty,0);?></th>
                        <th><?=fn_number_format($tot_wip,0);?></th>
                        <th></th>
                        <th><?=fn_number_format($tot_lst_rcv_qty,0);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>   
    <script type="text/javascript">
        function open_gmts_color_popup(data)
        {
            var width = window.innerWidth;
            // width = width-30;        
            width = 640;        
            var action = "color_wise_garments_print_popup";
            emailwindow = dhtmlmodal.open('EmailBox', 'iframe', 'order_monitoring_report_with_tna_controller.php?data=' + data + '&action=' + action, 'Garments Production Details Popup', 'width='+width+'px,height=350px,center=1,resize=0,scrolling=0', '../../');
        }
    </script>
    <?
}

if($action=="color_wise_garments_print_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_size = return_library_array("select id,size_name from lib_size", "id", "size_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    extract($_REQUEST);
    $data = str_replace("'", "", $data);
    $dataEx = explode("_", $data);
    $company_id = $dataEx[0];
    $po_break_down_id = $dataEx[1];
    $itemId = $dataEx[2];
    $colorId = $dataEx[3];
    //====================================== GMTS PRODUCTION =====================================
    $sqlProd = "SELECT c.size_number_id as SIZE_ID,c.color_number_id as COLOR_ID,c.item_number_id as ITEM_ID,c.SIZE_ORDER, 
    sum(case when a.production_type=2 and a.embel_name=1 then b.production_qnty else 0 end) as WASH_ISSUE_QTY,
    sum(case when a.production_type=3 and a.embel_name=1 then b.production_qnty else 0 end) as WASH_RCV_QTY, 
    sum(case when a.production_type=3 and a.embel_name=1 then b.reject_qty else 0 end) as WASH_REJECT_QTY
    from pro_garments_production_mst a, pro_garments_production_dtls b,wo_po_color_size_breakdown c
    where a.id=b.mst_id and c.id=b.color_size_break_down_id and a.po_break_down_id=c.po_break_down_id and c.item_number_id=a.item_number_id and a.status_active=1 and b.status_active=1 and a.production_type in(2,3) and a.po_break_down_id in($po_break_down_id) and a.item_number_id=$itemId  and a.serving_company=$company_id group by c.size_number_id,c.color_number_id,c.item_number_id,c.size_order order by c.size_order";//and c.color_number_id=$colorId
    // echo $sqlProd;die();
    $sqlProdRes = sql_select($sqlProd);
    $prodDataArray = array();
    foreach ($sqlProdRes as $val) 
    {
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]][$val['SIZE_ID']]['wash_issue_qty']    = $val['WASH_ISSUE_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]][$val['SIZE_ID']]['wash_rcv_qty']      = $val['WASH_RCV_QTY'];
        $prodDataArray[$val['ITEM_ID']][$lib_color[$val['COLOR_ID']]][$val['SIZE_ID']]['wash_reject_qty']   = $val['WASH_REJECT_QTY'];
    }
    //==================================== getting rowspan no =================================
    $itemrowspan = array();
    $colorrowspan = array();
    foreach ($prodDataArray as $itemId => $itemData) 
    {
        foreach ($itemData as $colorId => $colorData) 
        {
            foreach ($colorData as $sizeId => $row) 
            {
                $itemrowspan[$itemId]++;
                $colorrowspan[$itemId][$colorId]++;
            }
        }
    }
    ?>    
    <div id="data_panel" align="center" style="width:620px">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports2').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 620px;" id="details_reports2">
        <div class="main_part">
            <h2>Factory Name :  <? echo ($company_short_name_arr[$company_id]!="") ? $company_short_name_arr[$company_id] : $lib_supplier[$company_id];?></h2>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="600">
                <thead>
                    <tr>
                        <th width="100">Item</th>
                        <th width="100">Color</th>
                        <th width="80">Size</th>
                        <th width="80">Sending Qty</th>
                        <th width="80">Ok Rcv Qty </th>
                        <th width="80">Rej Rcv Qty</th>
                        <th width="80">Factory WIP</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    $total_issue = 0;
                    $total_rcv = 0;
                    $total_rej = 0;
                    $total_wip = 0;
                    foreach ($prodDataArray as $itemId => $itemData) 
                    {
                        foreach ($itemData as $colorName => $colorData) 
                        {
                            foreach ($colorData as $sizeId => $row) 
                            { 
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                    <td><? echo $garments_item[$itemId]; ?></td>
                                    <td><? echo $colorName; ?></td>
                                    <td><? echo $lib_size[$sizeId]; ?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_issue_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_rcv_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format($row['wash_reject_qty'],0);?></td>
                                    <td align="right"><? echo fn_number_format(($row['wash_issue_qty']-$row['wash_rcv_qty']-$row['wash_reject_qty']),0);?></td>
                                </tr>
                                <?
                                $i++; 
                                $total_issue += $row['wash_issue_qty'];
                                $total_rcv += $row['wash_rcv_qty'];
                                $total_rej += $row['wash_reject_qty'];
                                $total_wip += $row['wash_issue_qty']-$row['wash_rcv_qty']-$row['wash_reject_qty']; 
                            }
                        }                     
                    }
                    ?>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3">Total</th>
                        <th><?=fn_number_format($total_issue,0);?></th>
                        <th><?=fn_number_format($total_rcv,0);?></th>
                        <th><?=fn_number_format($total_rej,0);?></th>
                        <th><?=fn_number_format($total_wip,0);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <?
}

if($action=="sample_approval_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);  

    $sample_type_name_array = return_library_array("select id, sample_name from lib_sample", 'id', 'sample_name');
   
    $mod_sql= sql_select("SELECT a.id,a.task_catagory,a.task_name,a.task_short_name,a.task_type,a.completion_percent,a.task_sequence_no,b.task_template_id,b.lead_time 
    from lib_tna_task a,tna_task_template_details b where a.task_name=b.tna_task_id and b.task_type=1 and a.is_deleted = 0 and a.status_active=1 and b.is_deleted = 0 and b.status_active=1 order by a.task_sequence_no asc");

    foreach ($mod_sql as $row)
    {
        $tna_task_name_array[$row[csf("task_name")]] = $row[csf("task_short_name")];
        $tna_task_name_arr[$row[csf("id")]]=$row[csf("task_name")];
    }

    // ====================================== ORDER INFO ==================================
    $sqlOrder = "SELECT a.style_ref_no as STYLE,b.grouping as INT_REF,b.PO_NUMBER from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in($poIds)";
    //echo $sqlOrder;die();
    $orderInfo = sql_select($sqlOrder);

    // ======================================= SAMPLE  ==================================
    $sqlLabSM = "SELECT MAX(A.TASK_START_DATE) AS START_DATE,MAX(A.TASK_FINISH_DATE) AS END_DATE,MAX(B.SUBMITTED_TO_BUYER) AS SUBMITTED_TO_BUYER,b.SAMPLE_TYPE_ID ,b.APPROVAL_STATUS,max(b.approval_status_date) as STATUS_DATE,b.SAMPLE_COMMENTS,a.TASK_NUMBER FROM tna_process_mst a, wo_po_sample_approval_info b WHERE a.job_no=b.job_no_mst and a.po_number_id=b.po_break_down_id and b.po_break_down_id in($poIds) and a.STATUS_ACTIVE=1 AND a.IS_DELETED=0 and b.status_active=1 and b.is_deleted=0  group by b.SAMPLE_TYPE_ID,b.APPROVAL_STATUS,b.SAMPLE_COMMENTS,a.TASK_NUMBER order by b.SAMPLE_TYPE_ID,a.TASK_NUMBER";
    // echo $sqlLabSM;
    $sqlLabSMRes = sql_select($sqlLabSM);
    if(count($sqlLabSMRes)==0)
    {
        ?>
        <div style="font-size:20px;color:red;text-align:center">Data not found!</div>
        <?
        die;
    }
    $dataArray = array();
    foreach ($sqlLabSMRes as $val) 
    {
        if($val['APPROVAL_STATUS']==0 && $val['SUBMITTED_TO_BUYER'] !="" && $val['SAMPLE_TYPE_ID'] ==2 && ($val['TASK_NUMBER'] ==7 || $val['TASK_NUMBER']==13))
        {
            $dataArray[2][1]['status_date']      = $val['SUBMITTED_TO_BUYER'];
            $dataArray[2][1]['sample_comments']  = $val['SAMPLE_COMMENTS'];
            $val['APPROVAL_STATUS']=1;
        }
        if($val['APPROVAL_STATUS']==0 && $val['SUBMITTED_TO_BUYER'] !="" && $val['SAMPLE_TYPE_ID'] ==10 && ($val['TASK_NUMBER'] ==21 || $val['TASK_NUMBER']==22))
        {
            $dataArray[10][1]['status_date']      = $val['SUBMITTED_TO_BUYER'];
            $dataArray[10][1]['sample_comments']  = $val['SAMPLE_COMMENTS'];
            $val['APPROVAL_STATUS']=1;
        }
        if($val['APPROVAL_STATUS']==0 && $val['SUBMITTED_TO_BUYER'] !="" && $val['SAMPLE_TYPE_ID'] ==11 && ($val['TASK_NUMBER'] ==28 || $val['TASK_NUMBER']==29))
        {
            $dataArray[11][1]['status_date']      = $val['SUBMITTED_TO_BUYER'];
            $dataArray[11][1]['sample_comments']  = $val['SAMPLE_COMMENTS'];
            $val['APPROVAL_STATUS']=1;
        }
        if($val['APPROVAL_STATUS']==0 && $val['SUBMITTED_TO_BUYER'] !="" && $val['SAMPLE_TYPE_ID'] ==6 && ($val['TASK_NUMBER'] ==197 || $val['TASK_NUMBER']==198))
        {
            $dataArray[6][1]['status_date']      = $val['SUBMITTED_TO_BUYER'];
            $dataArray[6][1]['sample_comments']  = $val['SAMPLE_COMMENTS'];
            $val['APPROVAL_STATUS']=1;
        }
        if($val['APPROVAL_STATUS']==0 && $val['SUBMITTED_TO_BUYER'] !="" && $val['SAMPLE_TYPE_ID'] ==4 && ($val['TASK_NUMBER'] ==8 || $val['TASK_NUMBER']==12))
        {
            $dataArray[4][1]['status_date']      = $val['SUBMITTED_TO_BUYER'];
            $dataArray[4][1]['sample_comments']  = $val['SAMPLE_COMMENTS'];
            $val['APPROVAL_STATUS']=1;
        }
        if($val['APPROVAL_STATUS']==0 && $val['SUBMITTED_TO_BUYER'] !="" && $val['SAMPLE_TYPE_ID'] ==7 && ($val['TASK_NUMBER'] ==16 || $val['TASK_NUMBER']==17))
        {
            $dataArray[7][1]['status_date']      = $val['SUBMITTED_TO_BUYER'];
            $dataArray[7][1]['sample_comments']  = $val['SAMPLE_COMMENTS'];
            $val['APPROVAL_STATUS']=1;
        }
        if($val['APPROVAL_STATUS']==0 && $val['SUBMITTED_TO_BUYER'] !="" && $val['SAMPLE_TYPE_ID'] ==12 && ($val['TASK_NUMBER'] ==26 || $val['TASK_NUMBER']==27))
        {
            $dataArray[12][1]['status_date']      = $val['SUBMITTED_TO_BUYER'];
            $dataArray[12][1]['sample_comments']  = $val['SAMPLE_COMMENTS'];
            $val['APPROVAL_STATUS']=1;
        }
        if($val['APPROVAL_STATUS']==0 && $val['SUBMITTED_TO_BUYER'] !="" && $val['SAMPLE_TYPE_ID'] ==8 && ($val['TASK_NUMBER'] ==193 || $val['TASK_NUMBER']==194))
        {
            $dataArray[8][1]['status_date']      = $val['SUBMITTED_TO_BUYER'];
            $dataArray[8][1]['sample_comments']  = $val['SAMPLE_COMMENTS'];
            $val['APPROVAL_STATUS']=1;
        }
        if($val['APPROVAL_STATUS']==0 && $val['SUBMITTED_TO_BUYER'] !="" && $val['SAMPLE_TYPE_ID'] ==13 && ($val['TASK_NUMBER'] ==23 || $val['TASK_NUMBER']==24))
        {
            $dataArray[13][1]['status_date']      = $val['SUBMITTED_TO_BUYER'];
            $dataArray[13][1]['sample_comments']  = $val['SAMPLE_COMMENTS'];
            $val['APPROVAL_STATUS']=1;
        }
        if($val['APPROVAL_STATUS']==0 && $val['SUBMITTED_TO_BUYER'] !="" && $val['SAMPLE_TYPE_ID'] ==3 && ($val['TASK_NUMBER'] ==14 || $val['TASK_NUMBER']==15))
        {
            $dataArray[3][1]['status_date']      = $val['SUBMITTED_TO_BUYER'];
            $dataArray[3][1]['sample_comments']  = $val['SAMPLE_COMMENTS'];
            $val['APPROVAL_STATUS']=1;
        }
        if($val['APPROVAL_STATUS']==0 && $val['SUBMITTED_TO_BUYER'] !="" && $val['SAMPLE_TYPE_ID'] ==9 && ($val['TASK_NUMBER'] ==265 || $val['TASK_NUMBER']==266))
        {
            $dataArray[9][1]['status_date']      = $val['SUBMITTED_TO_BUYER'];
            $dataArray[9][1]['sample_comments']  = $val['SAMPLE_COMMENTS'];
            $val['APPROVAL_STATUS']=1;
        }


        //if($val['APPROVAL_STATUS']==0){$val['APPROVAL_STATUS']=1;}

        if($val['SAMPLE_TYPE_ID'] ==2 && $val['TASK_NUMBER']==7)// style
        {
            $dataArray[2][$val['APPROVAL_STATUS']]['sb_start_date'] = $val['START_DATE'];
            $dataArray[2][$val['APPROVAL_STATUS']]['sb_end_date']   = $val['END_DATE'];
            $dataArray[2][$val['APPROVAL_STATUS']]['status_date']      = $val['STATUS_DATE'];
            $dataArray[2][$val['APPROVAL_STATUS']]['sample_comments']  = $val['SAMPLE_COMMENTS'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==2 && $val['TASK_NUMBER']==13) 
        {
            $dataArray[2][$val['APPROVAL_STATUS']]['ap_start_date'] = $val['START_DATE'];
            $dataArray[2][$val['APPROVAL_STATUS']]['ap_end_date']   = $val['END_DATE'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==10 && $val['TASK_NUMBER']==21) // Ware Trial Sample
        {
            $dataArray[10][$val['APPROVAL_STATUS']]['sb_start_date'] = $val['START_DATE'];
            $dataArray[10][$val['APPROVAL_STATUS']]['sb_end_date']   = $val['END_DATE'];
            $dataArray[10][$val['APPROVAL_STATUS']]['status_date']      = $val['STATUS_DATE'];
            $dataArray[10][$val['APPROVAL_STATUS']]['sample_comments']  = $val['SAMPLE_COMMENTS'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==10 && $val['TASK_NUMBER']==22) 
        {
            $dataArray[10][$val['APPROVAL_STATUS']]['ap_start_date'] = $val['START_DATE'];
            $dataArray[10][$val['APPROVAL_STATUS']]['ap_end_date']   = $val['END_DATE'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==11 && $val['TASK_NUMBER']==28) // size set
        {
            $dataArray[11][$val['APPROVAL_STATUS']]['sb_start_date'] = $val['START_DATE'];
            $dataArray[11][$val['APPROVAL_STATUS']]['sb_end_date']   = $val['END_DATE'];
            $dataArray[11][$val['APPROVAL_STATUS']]['status_date']      = $val['STATUS_DATE'];
            $dataArray[11][$val['APPROVAL_STATUS']]['sample_comments']  = $val['SAMPLE_COMMENTS'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==18 && $val['TASK_NUMBER']==29) 
        {
            $dataArray[11][$val['APPROVAL_STATUS']]['ap_start_date'] = $val['START_DATE'];
            $dataArray[11][$val['APPROVAL_STATUS']]['ap_end_date']   = $val['END_DATE'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==6 && $val['TASK_NUMBER']==197) // size set
        {
            $dataArray[6][$val['APPROVAL_STATUS']]['sb_start_date'] = $val['START_DATE'];
            $dataArray[6][$val['APPROVAL_STATUS']]['sb_end_date']   = $val['END_DATE'];
            $dataArray[6][$val['APPROVAL_STATUS']]['status_date']      = $val['STATUS_DATE'];
            $dataArray[6][$val['APPROVAL_STATUS']]['sample_comments']  = $val['SAMPLE_COMMENTS'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==6 && $val['TASK_NUMBER']==198) 
        {
            $dataArray[6][$val['APPROVAL_STATUS']]['ap_start_date'] = $val['START_DATE'];
            $dataArray[6][$val['APPROVAL_STATUS']]['ap_end_date']   = $val['END_DATE'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==4 && $val['TASK_NUMBER']==8) // size set
        {
            $dataArray[4][$val['APPROVAL_STATUS']]['sb_start_date'] = $val['START_DATE'];
            $dataArray[4][$val['APPROVAL_STATUS']]['sb_end_date']   = $val['END_DATE'];
            $dataArray[4][$val['APPROVAL_STATUS']]['status_date']      = $val['STATUS_DATE'];
            $dataArray[4][$val['APPROVAL_STATUS']]['sample_comments']  = $val['SAMPLE_COMMENTS'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==4 && $val['TASK_NUMBER']==12) 
        {
            $dataArray[4][$val['APPROVAL_STATUS']]['ap_start_date'] = $val['START_DATE'];
            $dataArray[4][$val['APPROVAL_STATUS']]['ap_end_date']   = $val['END_DATE'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==7 && $val['TASK_NUMBER']==16) // size set
        {
            $dataArray[7][$val['APPROVAL_STATUS']]['sb_start_date'] = $val['START_DATE'];
            $dataArray[7][$val['APPROVAL_STATUS']]['sb_end_date']   = $val['END_DATE'];
            $dataArray[7][$val['APPROVAL_STATUS']]['status_date']      = $val['STATUS_DATE'];
            $dataArray[7][$val['APPROVAL_STATUS']]['sample_comments']  = $val['SAMPLE_COMMENTS'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==7 && $val['TASK_NUMBER']==17) 
        {
            $dataArray[7][$val['APPROVAL_STATUS']]['ap_start_date'] = $val['START_DATE'];
            $dataArray[7][$val['APPROVAL_STATUS']]['ap_end_date']   = $val['END_DATE'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==12 && $val['TASK_NUMBER']==26) // size set
        {
            $dataArray[12][$val['APPROVAL_STATUS']]['sb_start_date'] = $val['START_DATE'];
            $dataArray[12][$val['APPROVAL_STATUS']]['sb_end_date']   = $val['END_DATE'];
            $dataArray[12][$val['APPROVAL_STATUS']]['status_date']      = $val['STATUS_DATE'];
            $dataArray[12][$val['APPROVAL_STATUS']]['sample_comments']  = $val['SAMPLE_COMMENTS'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==12 && $val['TASK_NUMBER']==27) 
        {
            $dataArray[12][$val['APPROVAL_STATUS']]['ap_start_date'] = $val['START_DATE'];
            $dataArray[12][$val['APPROVAL_STATUS']]['ap_end_date']   = $val['END_DATE'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==8 && $val['TASK_NUMBER']==193) // size set
        {
            $dataArray[8][$val['APPROVAL_STATUS']]['sb_start_date'] = $val['START_DATE'];
            $dataArray[8][$val['APPROVAL_STATUS']]['sb_end_date']   = $val['END_DATE'];
            $dataArray[8][$val['APPROVAL_STATUS']]['status_date']      = $val['STATUS_DATE'];
            $dataArray[8][$val['APPROVAL_STATUS']]['sample_comments']  = $val['SAMPLE_COMMENTS'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==8 && $val['TASK_NUMBER']==194) 
        {
            $dataArray[8][$val['APPROVAL_STATUS']]['ap_start_date'] = $val['START_DATE'];
            $dataArray[8][$val['APPROVAL_STATUS']]['ap_end_date']   = $val['END_DATE'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==13 && $val['TASK_NUMBER']==23) // size set
        {
            $dataArray[13][$val['APPROVAL_STATUS']]['sb_start_date'] = $val['START_DATE'];
            $dataArray[13][$val['APPROVAL_STATUS']]['sb_end_date']   = $val['END_DATE'];
            $dataArray[13][$val['APPROVAL_STATUS']]['status_date']      = $val['STATUS_DATE'];
            $dataArray[13][$val['APPROVAL_STATUS']]['sample_comments']  = $val['SAMPLE_COMMENTS'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==13 && $val['TASK_NUMBER']==24) 
        {
            $dataArray[13][$val['APPROVAL_STATUS']]['ap_start_date'] = $val['START_DATE'];
            $dataArray[13][$val['APPROVAL_STATUS']]['ap_end_date']   = $val['END_DATE'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==3 && $val['TASK_NUMBER']==14) // size set
        {
            $dataArray[3][$val['APPROVAL_STATUS']]['sb_start_date'] = $val['START_DATE'];
            $dataArray[3][$val['APPROVAL_STATUS']]['sb_end_date']   = $val['END_DATE'];
            $dataArray[3][$val['APPROVAL_STATUS']]['status_date']      = $val['STATUS_DATE'];
            $dataArray[3][$val['APPROVAL_STATUS']]['sample_comments']  = $val['SAMPLE_COMMENTS'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==3 && $val['TASK_NUMBER']==15) 
        {
            $dataArray[3][$val['APPROVAL_STATUS']]['ap_start_date'] = $val['START_DATE'];
            $dataArray[3][$val['APPROVAL_STATUS']]['ap_end_date']   = $val['END_DATE'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==9 && $val['TASK_NUMBER']==265) // size set
        {
            $dataArray[9][$val['APPROVAL_STATUS']]['sb_start_date'] = $val['START_DATE'];
            $dataArray[9][$val['APPROVAL_STATUS']]['sb_end_date']   = $val['END_DATE'];
            $dataArray[9][$val['APPROVAL_STATUS']]['status_date']      = $val['STATUS_DATE'];
            $dataArray[9][$val['APPROVAL_STATUS']]['sample_comments']  = $val['SAMPLE_COMMENTS'];
        }
        elseif ($val['SAMPLE_TYPE_ID'] ==9 && $val['TASK_NUMBER']==266) 
        {
            $dataArray[9][$val['APPROVAL_STATUS']]['ap_start_date'] = $val['START_DATE'];
            $dataArray[9][$val['APPROVAL_STATUS']]['ap_end_date']   = $val['END_DATE'];
        }
    }
    
   // echo "<pre>";print_r($dataArray);

    //==================================== getting rowspan no =================================
    $rowspan = array();
    foreach ($dataArray as $task_id => $taskData) 
    {
        foreach ($taskData as $action => $row) 
        {
            $rowspan[$task_id]++;
        }
    }
    ?>    
    <div id="data_panel" align="center" style="width:570px">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports2').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 570px;" id="details_reports2">
        <style type="text/css">
           table tr th,table tr td{ word-wrap: break-word;word-break:break-all;}
        </style>
        <div class="header_part">
            <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="550">
                <caption><h2><b>Sample Approval</b></h2></caption>
                <thead>
                    <tr>
                        <td colspan="6" width="100%"><b>Style Name :<? echo $orderInfo[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref :<? echo $orderInfo[0]['INT_REF'];?></b>&nbsp;&nbsp;<b>PO No :<? echo $orderInfo[0]['PO_NUMBER'];?></b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="main_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="550">
                <thead>
                    <tr>
                        <th width="120">Sample Name</th>
                        <th width="100">Submit Plan</th>
                        <th width="100">Approval Plan</th>
                        <th width="60">Date</th>
                        <th width="70">Event</th>
                        <th width="100">Comments</th>
                    </tr>
                </thead>
            </table>
            <div style="width:570px;overflow:auto;max-height:350px;">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="550">
                    <tbody>
                        <?
                        $i=1;
                        
                        foreach ($dataArray as $task_id => $taskData) 
                        { 
                            $r=0;
                            foreach ($taskData as $action => $row) 
                            {
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">  
                                    <? if($r==0){?>                             
                                    <td title="<? echo $task_id;?>" valing="middle" rowspan="<? echo $rowspan[$task_id];?>" width="120"><? echo $sample_type_name_array[$task_id]; ?></td>
                                    <td valing="middle" rowspan="<? echo $rowspan[$task_id];?>" width="100" align="center"><? if($row['sb_start_date'] !="") {echo date('d M',strtotime($row['sb_start_date']))." - ".date('d M',strtotime($row['sb_end_date']));}?></td>
                                    <td valing="middle" rowspan="<? echo $rowspan[$task_id];?>" width="100" align="center"><? if($row['ap_start_date'] !="") {echo date('d M',strtotime($row['ap_start_date']))." - ".date('d M',strtotime($row['ap_end_date']));}?></td>
                                    <?}?>
                                    <td width="60" align="center"><? echo change_date_format($row['status_date'],0);?></td>
                                    <td width="70"><? echo $approval_status[$action];?></td>
                                    <td width="100"><? echo $row['sample_comments'];?></td>
                                </tr>
                                <?
                                $i++;  
                                $r++;
                            }
                        }
                        ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <?
    exit();
}

if($action=="operation_bulletin_popup")
{
    echo load_html_head_contents("Operation Bulletin", "../../../../", 1, 1,'','','');
    extract($_REQUEST);
    $sql="select a.GMTS_ITEM_ID,b.RESOURCE_GSD,b.LIB_SEWING_ID,b.TOTAL_SMV from ppl_gsd_entry_mst a,ppl_gsd_entry_dtls b where a.id=b.mst_id and STYLE_REF = '".$style."'";
    
    $gsd_sql_arr = sql_select($sql);
    foreach ($gsd_sql_arr as $val) 
    {
        
        $dataArray[$val['GMTS_ITEM_ID']][$val['RESOURCE_GSD']][$val['LIB_SEWING_ID']][TOTAL_SMV] = $val['TOTAL_SMV'];
        $itemSpanArr[$val['GMTS_ITEM_ID']][$val['LIB_SEWING_ID']]=$val['LIB_SEWING_ID'];
        $resorceSpanArr[$val['GMTS_ITEM_ID']][$val['RESOURCE_GSD']][$val['LIB_SEWING_ID']]=$val['LIB_SEWING_ID'];
    }
    
    $operation_arr=return_library_array( "select id,operation_name from lib_sewing_operation_entry", "id","operation_name");
    ?>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="100%">
                <thead>
                    <tr>
                        <th width="180">Item</th>
                        <th width="150">Resource</th>
                        <th width="300">Operation Name</th>
                        <th>Time ( sec )</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=1;
                    
                    foreach ($dataArray as $GMTS_ITEM_ID=>$row1) 
                    { 
                        $itemSpan=count($itemSpanArr[$GMTS_ITEM_ID]);
                        $stage1=1;
                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                        ?>
                        <tr bgcolor="<? echo $bgcolor; ?>">
                            <td align="center" valign="middle" rowspan="<?= $itemSpan;?>"><? echo $garments_item[$GMTS_ITEM_ID];?></td>
                        <?
                        
                        foreach ($row1 as $RESOURCE_GSD=>$row2) 
                        { 
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            $stage2=1;
                            $recSpan=count($resorceSpanArr[$GMTS_ITEM_ID][$RESOURCE_GSD]);
                            if($stage1!=1){echo "<tr bgcolor='".$bgcolor."'>";}
                            ?>
                                <td align="center" valign="middle" rowspan="<?= $recSpan;?>"><? echo $production_resource[$RESOURCE_GSD];?></td>
                            <?
                            
                            foreach ($row2 as $LIB_SEWING_ID=>$row) 
                            { 
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                if($stage2!=1){echo "<tr bgcolor='".$bgcolor."'>";}
                                ?>                        
                                    <td><? echo $operation_arr[$LIB_SEWING_ID];?></td>
                                    <td align='center'><? echo fn_number_format($row['TOTAL_SMV']*60);?></td>
                                </tr>
                                <?
                                $itemTotalArr[$GMTS_ITEM_ID]+=$row['TOTAL_SMV'];
                                $stage1++;
                                $stage2++;
                                $i++;  
                            }
                            
                        }
                        echo "<tr bgcolor='#CCC'><td align='center' colspan='3'><b>Item Total</b></td><td align='center'>".$itemTotalArr[$GMTS_ITEM_ID]." m</td></tr>";
                        
                    }
                    ?>
                  </tbody>
                   <tfoot>
                    <tr><td align='center' colspan='3'><b>Grand Total</b></td><td align='center'><?= array_sum($itemTotalArr);?> m</td></tr>
                  </tfoot>                  
                  
                  
              </table>
                
    
    <?
    
    
}


if($action=="labdip_approval_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);  
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $sample_type_name_array = return_library_array("select id, sample_name from lib_sample", 'id', 'sample_name');
   
    $mod_sql= sql_select("SELECT a.id,a.task_catagory,a.task_name,a.task_short_name,a.task_type,a.completion_percent,a.task_sequence_no,b.task_template_id,b.lead_time 
    from lib_tna_task a,tna_task_template_details b where a.task_name=b.tna_task_id and b.task_type=1 and a.is_deleted = 0 and a.status_active=1 and b.is_deleted = 0 and b.status_active=1 order by a.task_sequence_no asc");

    foreach ($mod_sql as $row)
    {
        $tna_task_name_array[$row[csf("task_name")]] = $row[csf("task_short_name")];
        $tna_task_name_arr[$row[csf("id")]]=$row[csf("task_name")];
    }

    // ====================================== ORDER INFO ==================================
    $sqlOrder = "SELECT a.style_ref_no as STYLE,b.grouping as INT_REF,b.PO_NUMBER from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in($poIds)";
    //echo $sqlOrder;die();
    $orderInfo = sql_select($sqlOrder);

    // ======================================= LABDIP APPROVAL  ==================================
    $sqlLabSM = "SELECT MAX (case when a.task_number=9 then A.TASK_START_DATE end) AS START_DATE,
         MAX (case when a.task_number=9 then A.TASK_FINISH_DATE end) AS END_DATE,
         MAX (case when a.task_number=10 then A.TASK_START_DATE end) AS ACTUAL_START_DATE,
         MAX (case when a.task_number=10 then A.TASK_FINISH_DATE end) AS ACTUAL_FINISH_DATE,b.COLOR_NAME_ID,b.APPROVAL_STATUS,max(b.approval_status_date) as STATUS_DATE,b.submitted_to_buyer as BUYER_SUBMIT_DT,b.LAPDIP_COMMENTS FROM tna_process_mst a, wo_po_lapdip_approval_info b WHERE a.task_number in(9,10) and a.job_no=b.job_no_mst and a.po_number_id=b.po_break_down_id and b.po_break_down_id in($poIds) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.color_name_id,b.approval_status,b.lapdip_comments,b.submitted_to_buyer order by b.APPROVAL_STATUS";
    // echo $sqlLabSM;
    $sqlLabSMRes = sql_select($sqlLabSM);
    $dataArray = array();
    foreach ($sqlLabSMRes as $val) 
    {
        if($val['BUYER_SUBMIT_DT'] !="" && $val['APPROVAL_STATUS']==0)
        {
            $val['APPROVAL_STATUS']=1;
            $val['STATUS_DATE'] = $val['BUYER_SUBMIT_DT'];
        }
        if($val['BUYER_SUBMIT_DT'] !="" && $val['APPROVAL_STATUS']!=1)
        {  
            $dataArray[$val['COLOR_NAME_ID']][1]['start_date']           = $val['START_DATE'];
            $dataArray[$val['COLOR_NAME_ID']][1]['end_date']             = $val['END_DATE'];
            $dataArray[$val['COLOR_NAME_ID']][1]['actual_start_date']    = $val['ACTUAL_START_DATE'];
            $dataArray[$val['COLOR_NAME_ID']][1]['actual_finish_date']   = $val['ACTUAL_FINISH_DATE'];
            $dataArray[$val['COLOR_NAME_ID']][1]['status_date']          = $val['BUYER_SUBMIT_DT'];
            $dataArray[$val['COLOR_NAME_ID']][1]['sample_comments']      = $val['SAMPLE_COMMENTS'];
        }
        $dataArray[$val['COLOR_NAME_ID']][$val['APPROVAL_STATUS']]['start_date']           = $val['START_DATE'];
        $dataArray[$val['COLOR_NAME_ID']][$val['APPROVAL_STATUS']]['end_date']             = $val['END_DATE'];
        $dataArray[$val['COLOR_NAME_ID']][$val['APPROVAL_STATUS']]['actual_start_date']    = $val['ACTUAL_START_DATE'];
        $dataArray[$val['COLOR_NAME_ID']][$val['APPROVAL_STATUS']]['actual_finish_date']   = $val['ACTUAL_FINISH_DATE'];
        $dataArray[$val['COLOR_NAME_ID']][$val['APPROVAL_STATUS']]['status_date']          = $val['STATUS_DATE'];
        $dataArray[$val['COLOR_NAME_ID']][$val['APPROVAL_STATUS']]['sample_comments']      = $val['SAMPLE_COMMENTS'];
    }
    // echo "<pre>";print_r($dataArray);
    //==================================== getting rowspan no =================================
    $rowspan = array();
    foreach ($dataArray as $color_id => $colorData) 
    {
        foreach ($colorData as $action => $row) 
        {
            $rowspan[$color_id]++;
        }
    }
    ?>    
    <div id="data_panel" align="center" style="width:570px">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports2').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 570px;" id="details_reports2">
        <style type="text/css">
           table tr th,table tr td{ word-wrap: break-word;word-break:break-all;}
        </style>
        <div class="header_part">
            <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="550">
                <caption><h2><b>Labdip Approval</b></h2></caption>
                <thead>
                    <tr>
                        <td colspan="6" width="100%"><b>Style Name :<? echo $orderInfo[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref :<? echo $orderInfo[0]['INT_REF'];?></b>&nbsp;&nbsp;<b>PO No :<? echo $orderInfo[0]['PO_NUMBER'];?></b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="main_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="550">
                <thead>
                    <tr>
                        <th width="120">Color</th>
                        <th width="100">Submit Plan</th>
                        <th width="100">Approval Plan</th>
                        <th width="60">Date</th>
                        <th width="70">Event</th>
                        <th width="100">Comments</th>
                    </tr>
                </thead>
            </table>
            <div style="width:570px;overflow:auto;max-height:350px;">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="550">
                    <tbody>
                        <?
                        $i=1;
                        
                        foreach ($dataArray as $color_id => $colorData) 
                        { 
                            $r=0;
                            foreach ($colorData as $action => $row) 
                            {
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">  
                                    <? if($r==0){?>                             
                                    <td valign="middle" rowspan="<? echo $rowspan[$color_id];?>" width="120"><? echo $lib_color[$color_id]; ?></td>
                                    <td valign="middle" rowspan="<? echo $rowspan[$color_id];?>" width="100" align="center"><? echo date('d M',strtotime($row['start_date']))." - ".date('d M',strtotime($row['end_date']));?></td>
                                    <td valign="middle" rowspan="<? echo $rowspan[$color_id];?>" width="100" align="center"><? echo date('d M',strtotime($row['actual_start_date']))." - ".date('d M',strtotime($row['actual_finish_date']));?></td>
                                    <?}?>
                                    <td width="60" align="center"><? echo date('d M',strtotime($row['status_date']));?></td>
                                    <td width="70"><? echo $approval_status[$action];?></td>
                                    <td width="100"><? echo $row['sample_comments'];?></td>
                                </tr>
                                <?
                                $i++;  
                                $r++;
                            }
                        }
                        ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <?
}

if($action=="batch_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_machine = return_library_array("select id,machine_no from lib_machine_name", "id", "machine_no");
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);
    // ====================================== ITEM AND COLOR ==================================
    $sqlOrder = "SELECT a.style_ref_no as STYLE,b.grouping as INT_REF from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in($poIds)";
    //echo $sqlOrder;die();
    $sqlOrderRes = sql_select($sqlOrder);

    
    $sqlBatch = "SELECT a.ID,a.BATCH_NO,a.BATCH_DATE, a.COLOR_ID,SUM(B.BATCH_QNTY) AS QTY,a.EXTENTION_NO,a.RE_DYEING_FROM FROM pro_batch_create_mst a, pro_batch_create_dtls b WHERE a.id=b.mst_id  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.po_id in($poIds) and a.batch_against in(1,2) GROUP BY a.id,a.batch_no,a.batch_date, a.color_id,a.extention_no,a.re_dyeing_from order by a.color_id,a.batch_date";
    // echo $sqlBatch;die();
    $batchRes = sql_select($sqlBatch);
    $dataArray = array();
    $batchIdArray = array();
    $redyeingBatchIdArray = array();
    foreach ($batchRes as $val) 
    {
        /*if($val['EXTENTION_NO']==1)
        {
            $dataArray[$val['COLOR_ID']][$val['RE_DYEING_FROM']]['date']    = $val['BATCH_DATE'];
            $dataArray[$val['COLOR_ID']][$val['RE_DYEING_FROM']]['qty']     = $val['QTY'];
            $dataArray[$val['COLOR_ID']][$val['RE_DYEING_FROM']]['batch_no']= $val['BATCH_NO'];
            $redyeingBatchIdArray[$val['RE_DYEING_FROM']] = $val['ID'];
        }
        else
        {
            $dataArray[$val['COLOR_ID']][$val['ID']]['date']    = $val['BATCH_DATE'];
            $dataArray[$val['COLOR_ID']][$val['ID']]['qty']     = $val['QTY'];
            $dataArray[$val['COLOR_ID']][$val['ID']]['batch_no']= $val['BATCH_NO'];
        }*/

        if($val['EXTENTION_NO']=="")
        {
            $dataArray[$lib_color[$val['COLOR_ID']]][$val['ID']]['date']    = $val['BATCH_DATE'];
            $dataArray[$lib_color[$val['COLOR_ID']]][$val['ID']]['qty']     = $val['QTY'];
            $dataArray[$lib_color[$val['COLOR_ID']]][$val['ID']]['batch_no']= $val['BATCH_NO'];
            $dataArray[$lib_color[$val['COLOR_ID']]][$val['ID']]['color_id']= $val['COLOR_ID'];
        }
        
        $batchIdArray[$val['ID']] = $val['ID'];
    }
    // echo "<pre>";print_r($redyeingBatchIdArray);
    // ================================== dyeing info =========================================
    $batchIds = implode(",", $batchIdArray);
    $sqlDye = "SELECT c.BATCH_ID,c.BATCH_NO,c.MACHINE_ID,c.END_HOURS,c.END_MINUTES,c.LOAD_UNLOAD_ID,MAX(C.PROCESS_END_DATE) AS PDATE,sum(d.batch_qty) as BATCH_QTY from  pro_fab_subprocess c,pro_fab_subprocess_dtls d where c.id=d.mst_id and c.process_id='31' and c.status_active=1 and c.is_deleted=0 and c.batch_id in($batchIds) and d.status_active=1 group by c.batch_id,c.batch_no,c.machine_id,c.end_hours,c.end_minutes,c.load_unload_id order by c.batch_id";
    // echo $sqlDye;die();
    $dyeingRes = sql_select($sqlDye);
    $dyeingArray = array();
    foreach ($dyeingRes as $val) 
    {
        if($val["LOAD_UNLOAD_ID"]==1)
        {
            $start_date = date('Y-m-d H:i:s',strtotime('+'.$val["END_HOURS"].' hour +'.$val["END_MINUTES"].' minutes',strtotime($val['PDATE'])));
        }
        else
        {
            $end_date = date('Y-m-d H:i:s',strtotime('+'.$val["END_HOURS"].' hour +'.$val["END_MINUTES"].' minutes',strtotime($val['PDATE'])));
        }
        $dyeingArray[$val["BATCH_ID"]]['machine_id']    = $val["MACHINE_ID"];
        $dyeingArray[$val["BATCH_ID"]]['dyeing_qty']    = $val["BATCH_QTY"];
        $dyeingArray[$val["BATCH_ID"]]['last_date']     = $val["PDATE"];
        $dyeingArray[$val["BATCH_ID"]]['start_date']    = $start_date;
        $dyeingArray[$val["BATCH_ID"]]['end_date']      = $end_date;
    }
    //=============================== fin fab rcv =======================
    $sqlFinFab = "SELECT b.pi_wo_batch_no as BATCH_ID,max(a.receive_date) AS RCV_DATE,sum(c.grey_used_qty) as GREY_QTY,sum(c.quantity) as FIN_QTY,sum(c.returnable_qnty) as REJECT_QTY from inv_receive_master a,inv_transaction b,order_wise_pro_details c where a.id=b.mst_id and b.id=c.trans_id and b.transaction_type=1 and c.po_breakdown_id in($poIds) and b.pi_wo_batch_no in($batchIds) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=7 and a.item_category=2 group by b.pi_wo_batch_no";
    // echo $sqlFinFab;
    $finFabRes = sql_select($sqlFinFab);
    $finFabArray = array();
    foreach ($finFabRes as $val) 
    {
        $finFabArray[$val['BATCH_ID']]['grey_qty']  = $val['GREY_QTY'];
        $finFabArray[$val['BATCH_ID']]['fin_qty']   = $val['FIN_QTY'];
        $finFabArray[$val['BATCH_ID']]['reject_qty']= $val['REJECT_QTY'];
        $finFabArray[$val['BATCH_ID']]['rcv_date']  = $val['RCV_DATE'];
    }

    // ================== rowspan ====================
    $rowspan = array();
    foreach ($dataArray as $colorId => $colorData) 
    {
        foreach ($colorData as $batchId => $row) 
        {
            $rowspan[$colorId]++;
        }
    }
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 100%;" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="100%">
                <caption style="font-size:20px;"><b>Batch Info</b></caption>
                <tbody>
                    <tr>
                        <td colspan="24" width="100%"><b>Style Name:<? echo $sqlOrderRes[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref:<? echo $sqlOrderRes[0]['INT_REF'];?></b></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- ===================================== 1st part start ================================== -->
        <div class="first_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="960">
                <thead>
                    <tr>
                        <th width="80">Color</th>
                        <th width="80">Batch No</th>
                        <th width="80">Batch Date</th>
                        <th width="80">Batch Qty</th>
                        <th width="80">Dyeing Qty</th>
                        <th width="80">Last Dyeing Date</th>
                        <th width="80">M/C No</th>
                        <th width="80">Total Dyeing Time</th>
                        <th width="80">Used Grey Qty</th>
                        <th width="80">Last Del Date</th>
                        <th width="80">Finish Fabric Qty</th>
                        <th width="80">Rej Del Qty</th>
                        <th width="80">PL %</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    $gr_batchQty   = 0 ;
                    $gr_dyeingQty  = 0 ;
                    $gr_finQty     = 0 ;
                    $gr_delQty     = 0 ;
                    $gr_rejQty     = 0 ;
                    $gr_plQty      = 0 ;
                    ksort($dataArray);
                    foreach ($dataArray as $colorName => $colorData) 
                    {
                        $clr = 0;
                        $batchQty   = 0 ;
                        $dyeingQty  = 0 ;
                        $finQty     = 0 ;
                        $delQty     = 0 ;
                        $rejQty     = 0 ;
                        $plQty      = 0 ;
                        foreach ($colorData as $batchId => $row) 
                        { 
                            $colorId = $row['color_id'];
                            $statrDate = $dyeingArray[$batchId]['start_date'];
                            $endDate = $dyeingArray[$batchId]['end_date'];

                            $datetime1 = new DateTime($statrDate);
                            $datetime2 = new DateTime($endDate);
                            $interval = $datetime1->diff($datetime2);
                            // echo $interval->format('%h')." Hours ".$interval->format('%i')." Minutes<br>";

                            $machine_id = $dyeingArray[$batchId]['machine_id'];
                            $dyeing_qty = $dyeingArray[$batchId]['dyeing_qty'];
                            $last_date = $dyeingArray[$batchId]['last_date'];

                            $grey_qty   = $finFabArray[$batchId]['grey_qty'] + $finFabArray[$redyeingBatchIdArray[$batchId]]['grey_qty'];
                            $fin_qty    = $finFabArray[$batchId]['fin_qty'] + $finFabArray[$redyeingBatchIdArray[$batchId]]['fin_qty'];
                            $reject_qty = $finFabArray[$batchId]['reject_qty'] + $finFabArray[$redyeingBatchIdArray[$batchId]]['reject_qty'];
                            $rcv_date   = $finFabArray[$batchId]['rcv_date'];
                            if($rcv_date=="")
                            {
                                $rcv_date   = $finFabArray[$redyeingBatchIdArray[$batchId]]['rcv_date'];
                            }
                            $pl = (($row['qty'] - $fin_qty)/$row['qty'])*100;

                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                <? if($clr==0){?>                               
                                <td valign="middle" rowspan="<?=$rowspan[$colorName];?>" title="<? echo $colorName;?>"><? echo substr($colorName,0,10);?></td>                             
                                <? $clr++;} ?>
                                <td valign="middle" title="<?=$batchId;?>">
                                    <a href="javascript:void(0)" onclick="open_batch_details_popup('<? echo $batchId;?>')">
                                        <? echo $row['batch_no']; ?>
                                    </a>
                                </td>  
                                <td align="center"><? echo date('d M',strtotime($row['date']));?></td>
                                <td align="right"><? echo fn_number_format($row['qty'],0);?></td>
                                <td align="right"><? echo fn_number_format($dyeing_qty,0);?></td>
                                <td align="center"><? echo ($last_date!='') ? date('d M',strtotime($last_date)) : '';?></td>
                                <td align=""><? echo $lib_machine[$machine_id];?></td>
                                <td align=""><? echo $interval->format('%h')." Hours ".$interval->format('%i')." Min";?></td>
                                <td align="right"><? echo fn_number_format($grey_qty,0);?></td>
                                <td align="right"><? echo ($rcv_date !="") ? date('d M',strtotime($rcv_date)) : '';?></td>
                                <td align="right"><? echo fn_number_format($fin_qty,0);?></td>
                                <td align="right"><? echo fn_number_format($reject_qty,0);?></td>
                                <td align="right"><? echo fn_number_format($pl,2);?></td>
                            </tr>
                            <?
                            $i++;
                            $batchQty   += $row['qty'];
                            $dyeingQty   += $dyeing_qty;
                            $finQty     += $grey_qty ;
                            $delQty     += $fin_qty ;
                            $rejQty     += $reject_qty ;

                            $gr_batchQty   += $row['qty'];
                            $gr_dyeingQty   += $dyeing_qty;
                            $gr_finQty     += $grey_qty ;
                            $gr_delQty     += $fin_qty ;
                            $gr_rejQty     += $reject_qty ;
                            
                        }
                        $plQty      += (($batchQty - $delQty)/$batchQty)*100;
                        ?>
                        <tr class="tbl_footer" style="font-weight:bold;text-align:right;background: #dccdcd">
                            <td></td>
                            <td></td>
                            <td>Total</td>
                            <td><? echo fn_number_format($batchQty,0);?></td>
                            <td><? echo fn_number_format($dyeingQty,0);?></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td><? echo fn_number_format($finQty,0);?></td>
                            <td></td>
                            <td><? echo fn_number_format($delQty,0);?></td>
                            <td><? echo fn_number_format($rejQty,0);?></td>
                            <td><? echo fn_number_format($plQty,2);?></td>
                        </tr>
                        <?
                    }
                    $gr_plQty      += (($gr_batchQty - $gr_delQty)/$gr_batchQty)*100;
                    ?>
                </tbody>
                <tfoot>
                    <tr>
                        <th></th>
                        <th></th>
                        <th>Grand Total</th>
                        <th><? echo fn_number_format($gr_batchQty,0);?></th>
                        <th><? echo fn_number_format($gr_dyeingQty,0);?></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th><? echo fn_number_format($gr_finQty,0);?></th>
                        <th></th>
                        <th><? echo fn_number_format($gr_delQty,0);?></th>
                        <th><? echo fn_number_format($gr_rejQty,0);?></th>
                        <th><? echo fn_number_format($gr_plQty,2);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>   
        <script type="text/javascript">
            function open_batch_details_popup(data)
            {
                var width = window.innerWidth;
                width = 500;        
                // width = width-30;        
                var action = "batch_details_popup";
                emailwindow = dhtmlmodal.open('EmailBox', 'iframe', 'order_monitoring_report_with_tna_controller.php?data=' + data + '&action=' + action, 'Batch Details Popup', 'width='+width+'px,height=350px,center=1,resize=0,scrolling=0', '../../');
            }
        </script>
    </div> 
    <?
}

if($action=="batch_details_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    extract($_REQUEST);
    $batchId = str_replace("'", "", $data);
    $lib_batch = return_library_array("select id,batch_no from pro_batch_create_mst where id in($batchId)", "id", "batch_no");
    $lib_body_part_wise_type = return_library_array("select id,body_part_type from lib_body_part", "id", "body_part_type");

    // ================================ CREATING CONSTRUCTION - COMPOSITION ARRAY ===============================
    $construction_arr=array();
    $composition_arr=array();
    $count_id_arr=array();
    $sql_deter="select a.id, a.construction, b.copmposition_id, b.percent,b.count_id from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
    $sql_deter_res=sql_select($sql_deter);
    if(count($sql_deter_res)>0)
    {
        foreach( $sql_deter_res as $row )
        {
            if(array_key_exists($row[csf('id')],$composition_arr))
            {
                $composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
            }
            else
            {
                // $composition_arr[$row[csf('id')]]=$row[csf('construction')]."*".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
                $composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
                $construction_arr[$row[csf('id')]]=$row[csf('construction')];
            }
            $count_id_arr[$row[csf('id')]] = $row[csf('count_id')];
        }
    }
    
    $sqlBatch = "SELECT b.BODY_PART_ID,d.BODY_PART_TYPE,C.DETERMINATION_ID,C.GSM_WEIGHT,C.DIA,SUM(B.BATCH_QNTY) AS QTY FROM pro_batch_create_mst a, pro_batch_create_dtls b,ppl_planning_entry_plan_dtls c,lib_body_part d WHERE a.id=b.mst_id and c.dtls_id=b.program_no and b.body_part_id=d.id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.id in($batchId) GROUP BY b.body_part_id,d.body_part_type,c.determination_id,c.gsm_weight,c.dia order by d.body_part_type";
    // echo $sqlBatch;die();
    $batchRes = sql_select($sqlBatch);
    $dataArray = array();
    $batchIdArray = array();
    foreach ($batchRes as $val) 
    {
        if($val['BODY_PART_TYPE']==40 || $val['BODY_PART_TYPE']==50)
        {
             $dataArray['Flat'][$val['DETERMINATION_ID']][$val['GSM_WEIGHT']]['dia']    = $val['DIA'];
             $dataArray['Flat'][$val['DETERMINATION_ID']][$val['GSM_WEIGHT']]['qty']    += $val['QTY'];
        }
        else
        {
             $dataArray['Circular'][$val['DETERMINATION_ID']][$val['GSM_WEIGHT']]['dia']    = $val['DIA'];
             $dataArray['Circular'][$val['DETERMINATION_ID']][$val['GSM_WEIGHT']]['qty']    += $val['QTY'];            
        }
    }
    // echo "<pre>";print_r($dataArray);
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 100%;" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="320">
                <caption style="font-size:20px;"><b>Batch Details</b></caption>
                <tbody>
                    <tr>
                        <td colspan="24" width="100%"><b>Batch No:<? echo $lib_batch[$batchId];?></b></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- ===================================== 1st part start ================================== -->
        <div class="first_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="480">
                <thead>
                    <tr>
                        <th width="80">Knit Type</th>
                        <th width="80">Structure</th>
                        <th width="80">GSM</th>
                        <th width="80">Fin. Dia</th>
                        <th width="80">Grey Qty</th>
                        <th width="80">Unit</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    foreach ($dataArray as $type => $typeData) 
                    {
                        foreach ($typeData as $construction => $constructionData) 
                        { 
                            foreach ($constructionData as $gsm => $row) 
                            {
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF";
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                    <td><? echo $type;?></td>  
                                    <td align=""><? echo $construction_arr[$construction];?></td>
                                    <td align="center"><? echo $gsm;?></td>
                                    <td align="center"><? echo $row['dia'];?></td>
                                    <td align="right"><? echo $row['qty'];?></td>
                                    <td align="center"><? ?></td>
                                </tr>
                                <?
                                $i++;
                            }
                        }
                    }
                    ?>
                </tbody>
            </table>
        </div> 
        <!-- ===================================== 2nd part start ================================== -->
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="320">
                <caption style="font-size:20px;"><b>Accessories Details</b></caption>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="first_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="320">
                <thead>
                    <tr>
                        <th width="80">Sl</th>
                        <th width="80">Item Details</th>
                        <th width="80">Weight in Kg</th>
                        <th width="80">Remarks</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $sqlAcc = sql_select("SELECT SAVE_STRING from pro_batch_create_mst where id in($batchId)"); 
                    $i=1;
                    foreach ($sqlAcc as $data) 
                    {
                        // print_r($data);
                        $dataArr = explode("!!", $data['SAVE_STRING']);
                        foreach ($dataArr as $val) 
                        {
                            // print_r($val);
                            $val_ex = explode("_", $val);
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF";
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                <td><? echo $i;?></td>  
                                <td align=""><? echo $val_ex[0];?></td>
                                <td align="center"><? echo $val_ex[1];?></td>
                                <td align="center"><? echo $val_ex[2];?></td>
                            </tr>
                            <?
                            $i++;
                        }
                           
                    }
                    ?>
                </tbody>
            </table>
        </div> 
    </div> 
    <?
}

if($action=="sample_fabric_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color  = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_size   = return_library_array("select id,size_name from lib_size", "id", "size_name");
    $lib_sample = return_library_array( "select id,sample_name from lib_sample", "id", "sample_name"  );
    $lib_yarn_count = return_library_array( "select id,yarn_count from lib_yarn_count", "id", "yarn_count"  );

    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);
    $lib_po_number = return_library_array("select id,po_number from wo_po_break_down where id in($poIds)", "id", "po_number");
     // ====================================== ORDER INFO ==================================
    $sqlOrder = "SELECT a.style_ref_no as STYLE,b.grouping as INT_REF from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in($poIds)";
    //echo $sqlOrder;die();
    $orderInfo = sql_select($sqlOrder);
    // ================================ CREATING CONSTRUCTION - COMPOSITION ARRAY ===============================
    $construction_arr=array();
    $composition_arr=array();
    $count_id_arr=array();
    $sql_deter="select a.id, a.construction, b.copmposition_id, b.percent,b.count_id from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
    $sql_deter_res=sql_select($sql_deter);
    if(count($sql_deter_res)>0)
    {
        foreach( $sql_deter_res as $row )
        {
            if(array_key_exists($row[csf('id')],$composition_arr))
            {
                $composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
            }
            else
            {
                // $composition_arr[$row[csf('id')]]=$row[csf('construction')]."*".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
                $composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
                $construction_arr[$row[csf('id')]]=$row[csf('construction')];
            }
            $count_id_arr[$row[csf('id')]] = $row[csf('count_id')];
        }
    }
    //========================================== main query =================================
    $sql = "SELECT a.ID,b.SAMPLE_COLOR,c.DETERMINATION_ID,c.GSM,c.FIN_FAB_QNTY,c.GREY_FAB_QNTY,d.id as BOOKING_ID,d.BOOKING_NO,e.BOOKING_DATE from sample_development_mst a, sample_development_dtls b,sample_development_fabric_acc c,wo_booking_dtls d,wo_booking_mst e where a.id=b.sample_mst_id and a.id=c.sample_mst_id and a.id=d.style_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and a.entry_form_id=117 and d.entry_form_id=139 and d.booking_type=4 and d.is_short=2 and d.po_break_down_id in($poIds) and e.booking_no=d.booking_no";
    // echo $sql;die();
    $sqlRes = sql_select($sql);
    $dataArray = array();
    $reqIdArray = array();
    $bookingIdArray = array();
    foreach ($sqlRes as $val) 
    {
        $dataArray[$val['BOOKING_NO']][$val['SAMPLE_COLOR']][$val['DETERMINATION_ID']][$val['GSM']]['date'] = $val['BOOKING_DATE'];
        $dataArray[$val['BOOKING_NO']][$val['SAMPLE_COLOR']][$val['DETERMINATION_ID']][$val['GSM']]['grey_fab_qnty'] += $val['GREY_FAB_QNTY'];
        $dataArray[$val['BOOKING_NO']][$val['SAMPLE_COLOR']][$val['DETERMINATION_ID']][$val['GSM']]['fin_fab_qnty'] += $val['FIN_FAB_QNTY'];
        $reqIdArray[$val['ID']] = $val['ID'];
        $bookingIdArray[$val['BOOKING_NO']] = $val['BOOKING_NO'];
    }
    $reqIds = implode(",", $reqIdArray);
    $bookingNo = "'".implode("','", $bookingIdArray)."'";

    // echo "<pre>";print_r($dataArray);
    
    // ================================ grey receive ==================================
    $sqlGrey = "SELECT c.COLOR,c.DETARMINATION_ID,c.GSM,d.BOOKING_NO, max(a.receive_date) AS RCV_DATE,sum(b.cons_quantity) AS QNTY FROM INV_RECEIVE_MASTER A,INV_TRANSACTION B,PRODUCT_DETAILS_MASTER C,ppl_planning_entry_plan_dtls D WHERE A.ID=B.MST_ID AND B.PROD_ID=C.id AND B.TRANSACTION_TYPE=1 and A.STATUS_ACTIVE=1 AND A.IS_DELETED=0 AND B.STATUS_ACTIVE=1 AND B.IS_DELETED=0 AND C.STATUS_ACTIVE=1 AND C.IS_DELETED=0 AND A.ENTRY_FORM=2 AND A.ITEM_CATEGORY=13 and d.po_id in($poIds) and d.booking_no in($bookingNo) and a.booking_id=d.dtls_id group by c.color,c.detarmination_id,c.gsm,d.booking_no";
    // echo $sqlGrey;
    $greyRes = sql_select($sqlGrey);
    foreach ($greyRes as $val) 
    {
        $dataArray[$val['BOOKING_NO']][$val['COLOR']][$val['DETARMINATION_ID']][$val['GSM']]['grey_qnty'] += $val['QNTY'];
        $dataArray[$val['BOOKING_NO']][$val['COLOR']][$val['DETARMINATION_ID']][$val['GSM']]['rcv_date'] = $val['RCV_DATE'];
    }

    //====================================== batch data ================================
    $sqlBatch = "SELECT a.BOOKING_NO,c.BATCH_QNTY,d.COLOR,d.DETARMINATION_ID,d.GSM from ppl_planning_entry_plan_dtls a,pro_batch_create_mst b,pro_batch_create_dtls c,product_details_master d where a.dtls_id=c.program_no and b.id=c.mst_id and c.prod_id=d.id and a.po_id in($poIds) and a.booking_no in($bookingNo) and a.status_active=1 and b.status_active=1 and c.status_active=1 and d.status_active=1 and b.batch_against=3";
    // echo $sqlBatch;
    $batchRes = sql_select($sqlBatch);
    foreach ($batchRes as $val) 
    {
       $dataArray[$val['BOOKING_NO']][$val['COLOR']][$val['DETARMINATION_ID']][$val['GSM']]['batch_qnty'] += $val['BATCH_QNTY'];
    }
    // echo "<pre>";print_r($dataArray);
    //====================================== dyeing data ================================
    $sqlDye = "SELECT a.BOOKING_NO,c.BATCH_QNTY,d.COLOR,d.DETARMINATION_ID,d.GSM,e.PRODUCTION_DATE from ppl_planning_entry_plan_dtls a,pro_batch_create_mst b,pro_batch_create_dtls c,product_details_master d,pro_fab_subprocess e where a.booking_no=b.booking_no and b.id=c.mst_id and c.prod_id=d.id and a.po_id in($poIds) and a.dtls_id=c.program_no and b.id=e.batch_id and e.load_unload_id = 2 and result=1 and a.status_active=1 and b.status_active=1 and c.status_active=1 and d.status_active=1 and e.status_active=1 and e.process_id='31' and b.batch_against=3 and a.booking_no in($bookingNo)";
    // echo $sqlDye;
    $dyeingRes = sql_select($sqlDye);
    foreach ($dyeingRes as $val) 
    {
       $dataArray[$val['BOOKING_NO']][$val['COLOR']][$val['DETARMINATION_ID']][$val['GSM']]['dyeing_qnty'] += $val['BATCH_QNTY'];
       $dataArray[$val['BOOKING_NO']][$val['COLOR']][$val['DETARMINATION_ID']][$val['GSM']]['production_date'] = $val['PRODUCTION_DATE'];
    }

    // =================================== fin fab rcv ==========================================
    $sqlFinFab = "SELECT c.COLOR_ID,c.FABRIC_DESCRIPTION_ID,c.GSM,e.BOOKING_NO,sum(c.receive_qnty) AS QNTY,sum(c.grey_used_qty) AS GREY_QNTY,sum(c.reject_qty) AS REJECT_QTY from inv_receive_master a,inv_transaction b,pro_finish_fabric_rcv_dtls c,pro_batch_create_dtls d, ppl_planning_entry_plan_dtls e where a.id=b.mst_id and b.prod_id=c.prod_id and a.id=c.mst_id and b.id=c.trans_id and d.mst_id=c.batch_id and b.transaction_type=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=7 and a.item_category=2 and d.po_id in($poIds) and d.program_no=e.dtls_id and e.booking_no in($bookingNo) group by c.COLOR_ID,c.fabric_description_id,c.gsm,e.booking_no";
    // echo $sqlFinFab;
    $finRes = sql_select($sqlFinFab);
    foreach ($finRes as $val) 
    {
        $dataArray[$val['BOOKING_NO']][$val['COLOR_ID']][$val['FABRIC_DESCRIPTION_ID']][$val['GSM']]['grey_used_qnty']  = $val['GREY_QNTY'];
        $dataArray[$val['BOOKING_NO']][$val['COLOR_ID']][$val['FABRIC_DESCRIPTION_ID']][$val['GSM']]['fin_rcv_qnty']   = $val['QNTY'];
        $dataArray[$val['BOOKING_NO']][$val['COLOR_ID']][$val['FABRIC_DESCRIPTION_ID']][$val['GSM']]['fin_reject_qty'] = $val['REJECT_QTY'];
    }
    // =================================== fin fab issue/delivery ==========================================
    $sqlDel = "SELECT f.COLOR,f.DETARMINATION_ID,f.GSM,e.BOOKING_NO,sum(c.issue_qnty) AS QNTY,max(a.issue_date) AS ISSUE_DATE from inv_issue_master a,inv_transaction b,inv_finish_fabric_issue_dtls c,pro_batch_create_dtls d, ppl_planning_entry_plan_dtls e,product_details_master f where a.id=b.mst_id and b.prod_id=c.prod_id and f.id=c.prod_id and a.id=c.mst_id and b.id=c.trans_id and d.mst_id=c.batch_id and b.transaction_type=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form=18 and a.item_category=2 and d.po_id in($poIds) and d.program_no=e.dtls_id and a.issue_purpose=4 and e.booking_no in($bookingNo) group by f.COLOR,f.detarmination_id,f.gsm,e.booking_no";
    // echo $sqlDel;
    $delRes = sql_select($sqlDel);
    foreach ($delRes as $val) 
    {
        $dataArray[$val['BOOKING_NO']][$val['COLOR']][$val['DETARMINATION_ID']][$val['GSM']]['fin_del_qnty']   = $val['QNTY'];
        $dataArray[$val['BOOKING_NO']][$val['COLOR']][$val['DETARMINATION_ID']][$val['GSM']]['issue_date'] = $val['ISSUE_DATE'];
    }
  

    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <!-- <div style="color:red;font-size:20px;text-align:center;">This popup is under development!</div> -->
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 100%;" id="details_reports">
        <div class="header_part">
            <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="100%">
                <caption><h3>Sample Fabric Info</h3></caption>
                <thead>
                    <tr>
                        <td colspan="18" width="100%"><b>Style Name:<? echo $orderInfo[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref:<? echo $orderInfo[0]['INT_REF'];?></b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="main_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="100%">
                <thead>
                    <tr>
                        <th width="3.25%">Booking Rcv Date</th>
                        <th width="6.25%">Fabric Booking No</th>
                        <th width="5.25%">Color</th>
                        <th width="5.25%">Fab Structure</th>
                        <th width="2.25%">GSM</th>
                        <th width="9.25%">Fabric Composion</th>
                        <th width="5.25%">Req. Finish Qty</th>
                        <th width="5.25%">Req Gray Qty</th>
                        <th width="5.25%">Gray Rcv</th>
                        <th width="5.25%">Last Rcv Date</th>
                        <th width="5.25%">Batching</th>
                        <th width="5.25%">Dyeing </th>
                        <th width="5.25%">Last Dye Date</th>
                        <th width="5.25%">Finishing</th>
                        <th width="5.25%">Ok Qty</th>
                        <th width="5.25%">Rej Qy</th>
                        <th width="5.25%">Del to Sample</th>
                        <th width="5.25%">Del Bal</th>
                        <th width="5.25%">Last Del Date</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    foreach ($dataArray as $bookingNo => $bookingData) 
                    {
                        foreach ($bookingData as $colorId => $colorData) 
                        { 
                            foreach ($colorData as $deterId => $deterData) 
                            { 
                                foreach ($deterData as $gsm => $row) 
                                {   
                                    if($row['fin_fab_qnty']>0)   
                                    {                               
                                    $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                    ?>                        
                                    <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                        
                                        <td valign="middle"><? echo date('d M',strtotime($row['date'])); ?></td>
                                        <td><? echo $bookingNo;?></td>
                                        <td align=""><? echo $lib_color[$colorId];?></td>
                                        <td align=""><? echo $construction_arr[$deterId];?></td>
                                        <td align=""><? echo $gsm;?></td>
                                        <td align=""><? echo $composition_arr[$deterId];?></td>
                                        <td align="right"><? echo $row['fin_fab_qnty'];?></td>
                                        <td align="right"><? echo $row['grey_fab_qnty'];?></td>
                                        <td align="right"><? echo $row['grey_qnty'];?></td>
                                        <td align="center"><? echo $row['rcv_date'] !="" ? date('d M',strtotime($row['rcv_date'])): "";?></td>
                                        <td align="right"><? echo $row['batch_qnty'];?></td>
                                        <td align="right"><? echo $row['dyeing_qnty'];?></td>
                                        <td align="center"><? echo $row['production_date'] !="" ? date('d M',strtotime($row['production_date'])): "";?></td>
                                        <td align="right"><? echo $row['grey_used_qnty'];?></td>
                                        <td align="right"><? echo $row['fin_rcv_qnty'];?></td>
                                        <td align="right"><? echo $row['fin_reject_qty'];?></td>
                                        <td align="center"><? echo $row['fin_del_qnty'];?></td>
                                        <td align="center"><? echo $row['fin_fab_qnty']-$row['fin_del_qnty'];?></td>
                                        <td align="center"><? echo ($row['issue_date'] !="") ? date('d M',strtotime($row['issue_date'])) : "";?></td>
                                    </tr>
                                    <?
                                    $i++;
                                    }
                                }
                            }
                        } 
                    }
                    ?>
                </tbody>
            </table>
        </div>
        <div style="padding-top:30px;width:100%">
            <div style="float:left;width:30%; padding-left:2.25%;">
                <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="100%">
                    <caption><h3>Yarn Info </h3></caption>
                    <thead>
                        <th width="20%">Composion</th>
                        <th width="20%">Count</th>
                        <th width="20%">Req. Qty</th>
                        <th width="20%">Alloc. Qty</th>
                        <th width="20%">Alloc. Bal</th>
                    </thead>
                    <tbody>
                        <?
                        // ======================================= Yarn Info ===============================
                        $sqlYarn = "SELECT e.DETERMINATION_ID,sum(c.grey_fab_qnty) as QTY,sum(b.QNTY) as ALLO_QNTY from  inv_material_allocation_mst a,inv_material_allocation_dtls b,wo_booking_dtls c,sample_development_mst d,sample_development_fabric_acc e where a.id=b.mst_id and b.booking_no=c.booking_no and b.item_category=1 and  c.style_id=d.id and d.id=e.sample_mst_id and a.status_active=1 and b.status_active=1 and c.status_active=1 and d.status_active=1 and e.status_active=1 and b.po_break_down_id in($poIds) and d.id in($reqIds) group by e.determination_id";
                        // echo $sqlYarn;
                        $yarnRes = sql_select($sqlYarn);
                        foreach ($yarnRes as $val) 
                        {
                            if($val['DETERMINATION_ID'] !="")
                            {
                            ?>
                            <tr>
                                <td><? echo $composition_arr[$val['DETERMINATION_ID']];?></td>
                                <td><? echo $lib_yarn_count[$count_id_arr[$val['DETERMINATION_ID']]];?></td>
                                <td><? echo $val['QTY'];?></td>
                                <td><? echo $val['ALLO_QNTY'];?></td>
                                <td><? echo $val['QTY'] - $val['ALLO_QNTY'];?></td>
                            </tr>
                        <?}}?>
                    </tbody>
                </table>
            </div>
            <div style="float:left;width:30%; padding-left:2.25%;">
                <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="100%">
                    <caption><h3>Yarn Dyeing Info</h3></caption>
                    <thead>
                        <th width="20%">Color</th>
                        <th width="20%">Req. Qty</th>
                        <th width="20%">WO. Qty</th>
                        <th width="20%">Rcv Qty</th>
                        <th width="20%">Bal Qty</th>
                    </thead>
                    <tbody>
                        <tr>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div style="float:left;width:30%; padding-left:2.25%;">
                <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="100%">
                    <caption><h3>AOP Info</h3></caption>
                    <thead>
                        <th width="20%">Color</th>
                        <th width="20%">Req. Qty</th>
                        <th width="20%">WO. Qty</th>
                        <th width="20%">Rcv Qty</th>
                        <th width="20%">Bal Qty</th>
                    </thead>
                    <tbody>
                        <tr>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div
    ></div> 
    <?
}

if($action=="sample_production_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color  = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_size   = return_library_array("select id,size_name from lib_size", "id", "size_name");
    $lib_sample = return_library_array( "select id,sample_name from lib_sample", "id", "sample_name"  );
    $lib_item_group = return_library_array( "select id,item_name from lib_item_group", "id", "item_name"  );

    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);
    $lib_po_number = return_library_array("select id,po_number from wo_po_break_down where id in($poIds)", "id", "po_number");
     // ====================================== ORDER INFO ==================================
    $sqlOrder = "SELECT a.style_ref_no as STYLE,b.grouping as INT_REF from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in($poIds)";
    //echo $sqlOrder;die();
    $orderInfo = sql_select($sqlOrder);
    //========================================== main query =================================
    $sql = "SELECT a.ID,b.SAMPLE_NAME,b.SAMPLE_COLOR,b.GMTS_ITEM_ID,c.TOTAL_QTY,a.REQUISITION_DATE,c.SIZE_ID from sample_development_mst a, sample_development_dtls b,sample_development_size c,wo_booking_dtls d where a.id=b.sample_mst_id and b.id=c.dtls_id and a.id=c.mst_id and a.id=d.style_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and a.entry_form_id=117 and d.entry_form_id=139 and d.booking_type=4 and d.is_short=2 and d.po_break_down_id in($poIds)";
    // echo $sql;
    $sqlRes = sql_select($sql);
    $dataArray = array();
    $reqIdArray = array();
    foreach ($sqlRes as $val) 
    {
        $dataArray[$val['SAMPLE_NAME']][$val['GMTS_ITEM_ID']][$val['SAMPLE_COLOR']][$val['SIZE_ID']]['date'] = $val['REQUISITION_DATE'];
        $dataArray[$val['SAMPLE_NAME']][$val['GMTS_ITEM_ID']][$val['SAMPLE_COLOR']][$val['SIZE_ID']]['total_qty'] += $val['TOTAL_QTY'];
        $reqIdArray[$val['ID']] = $val['ID'];
    }
    $reqIds = implode(",", $reqIdArray);
    //==================================== production quantity ======================================
    $sqlProd = "SELECT b.SAMPLE_NAME,b.ITEM_NUMBER_ID,c.COLOR_ID,c.SIZE_ID,sum(case when b.entry_form_id=338 and b.embel_name=1 then c.size_pass_qty else 0 end) as PRINT_QTY,sum(case when b.entry_form_id=338 and b.embel_name=2 then c.size_pass_qty else 0 end) as EMB_QTY,sum(case when b.entry_form_id=338 and b.embel_name=4 then c.size_pass_qty else 0 end) as SPW_QTY,sum(case when b.entry_form_id=128 and b.embel_name=1 then c.size_pass_qty else 0 end) as PRINT_RCV_QTY,sum(case when b.entry_form_id=128 and b.embel_name=2 then c.size_pass_qty else 0 end) as EMB_RCV_QTY,sum(case when b.entry_form_id=128 and b.embel_name=4 then c.size_pass_qty else 0 end) as SPW_RCV_QTY,sum(case when b.entry_form_id=127 then c.size_pass_qty else 0 end) as CUTTING_QTY,sum(case when b.entry_form_id=337 then c.size_pass_qty else 0 end) as INPUT_QTY,sum(case when b.entry_form_id=130 then c.size_pass_qty else 0 end) as OUTPUT_QTY,sum(case when b.entry_form_id=130 then c.SIZE_REJ_QTY else 0 end) as REJECT_QTY from sample_sewing_output_mst a,sample_sewing_output_dtls b,sample_sewing_output_colorsize c where a.id=b.sample_sewing_output_mst_id and b.id=c.sample_sewing_output_dtls_id and a.id=c.sample_sewing_output_mst_id and a.entry_form_id in(127,128,130,337,338) and a.sample_development_id in($reqIds) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by b.sample_name,b.item_number_id,c.color_id,c.size_id";
    // echo $sqlProd;
    $prodRes = sql_select($sqlProd);
    foreach ($prodRes as $val) 
    {
        $dataArray[$val['SAMPLE_NAME']][$val['ITEM_NUMBER_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['print_qty']     = $val['PRINT_QTY'];
        $dataArray[$val['SAMPLE_NAME']][$val['ITEM_NUMBER_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['print_rcv_qty'] = $val['PRINT_RCV_QTY'];
        $dataArray[$val['SAMPLE_NAME']][$val['ITEM_NUMBER_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['emb_qty']       = $val['EMB_QTY'];
        $dataArray[$val['SAMPLE_NAME']][$val['ITEM_NUMBER_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['emb_rcv_qty']   = $val['EMB_RCV_QTY'];
        $dataArray[$val['SAMPLE_NAME']][$val['ITEM_NUMBER_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['spw_qty']       = $val['SPW_QTY'];
        $dataArray[$val['SAMPLE_NAME']][$val['ITEM_NUMBER_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['spw_rcv_qty']   = $val['SPW_RCV_QTY'];
        $dataArray[$val['SAMPLE_NAME']][$val['ITEM_NUMBER_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['cutting_qty']   = $val['CUTTING_QTY'];
        $dataArray[$val['SAMPLE_NAME']][$val['ITEM_NUMBER_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['input_qty']     = $val['INPUT_QTY'];
        $dataArray[$val['SAMPLE_NAME']][$val['ITEM_NUMBER_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['output_qty']    = $val['OUTPUT_QTY'];
        $dataArray[$val['SAMPLE_NAME']][$val['ITEM_NUMBER_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['reject_qty']    = $val['REJECT_QTY'];
    }

    //==================================== sample exfactory ==============================
    $sqlEx = "SELECT min(b.delivery_date) as FIRST_SND_DATE,max(b.delivery_date) as LAST_SND_DATE,b.SAMPLE_NAME,b.GMTS_ITEM_ID,c.COLOR_ID,c.SIZE_ID,sum(c.size_pass_qty) as DEL_QTY from sample_ex_factory_mst a,sample_ex_factory_dtls b,sample_ex_factory_colorsize c where a.id=b.sample_ex_factory_mst_id and a.id=c.sample_ex_factory_mst_id and b.id=c.sample_ex_factory_dtls_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.sample_development_id in($reqIds) and a.entry_form_id=132 group by b.sample_name,b.gmts_item_id,c.color_id,c.size_id";
    // echo $sqlEx;
    $exRes = sql_select($sqlEx);
    foreach ($exRes as $val) 
    {
        $dataArray[$val['SAMPLE_NAME']][$val['GMTS_ITEM_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['first_snd_date']    = $val['FIRST_SND_DATE'];
        $dataArray[$val['SAMPLE_NAME']][$val['GMTS_ITEM_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['last_snd_date']    = $val['LAST_SND_DATE'];
        $dataArray[$val['SAMPLE_NAME']][$val['GMTS_ITEM_ID']][$val['COLOR_ID']][$val['SIZE_ID']]['del_qty']    = $val['DEL_QTY'];
    }

    // ====================================== sample emblishment =========================================
    $sql_sam="SELECT ID,SAMPLE_MST_ID,SAMPLE_NAME_RE,GMTS_ITEM_ID_RE,NAME_RE,TYPE_RE,REMARKS_RE from sample_development_fabric_acc where sample_mst_id in($reqIds) and form_type=3 and  is_deleted=0  and status_active=1  order by id ASC";
    // echo $sql_sam;
    $sql_res = sql_select($sql_sam);
    $emblishmentArray = array();
    foreach ($sql_res as $val) 
    {
        $emblishmentArray[$val['SAMPLE_NAME_RE']][$val['GMTS_ITEM_ID_RE']] = $val['NAME_RE'];
    }

    // ================================ sample accessories ===============================
    $sql_acc="SELECT c.TRIMS_GROUP_RA,c.DESCRIPTION_RA,c.REQ_QTY_RA from sample_development_mst a,sample_development_dtls b,sample_development_fabric_acc c where a.id=b.sample_mst_id and a.id=c.sample_mst_id and a.id in($reqIds) and form_type=2 and  a.is_deleted=0  and a.status_active=1 order by c.TRIMS_GROUP_RA ASC";
    // echo $sql_acc;
    $accRes = sql_select($sql_acc);
    $accArray = array();
    foreach ($accRes as $val) 
    {
        $accArray[$val['TRIMS_GROUP_RA']][$val['DESCRIPTION_RA']] = $val['REQ_QTY_RA'];
    }
    // print_r($accArray);
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <!-- <div style="color:red;font-size:20px;text-align:center;">This popup is under development!</div> -->
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 100%;" id="details_reports">
        <div class="header_part">
            <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="100%">
                <caption><h3>Sample Production</h3></caption>
                <thead>
                    <tr>
                        <td colspan="18" width="100%"><b>Style Name:<? echo $orderInfo[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref:<? echo $orderInfo[0]['INT_REF'];?></b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="main_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="100%">
                <thead>
                    <tr>
                        <th width="5.5%">Sample Req Rcv Date</th>
                        <th width="6.5%">Name of sample</th>
                        <th width="5.5%">GMT Item</th>
                        <th width="5.5%">Color</th>
                        <th width="5.5%">Size</th>
                        <th width="5.5%">Req Qty</th>
                        <th width="5.5%">Cutting</th>
                        <th width="5.5%">Print Req</th>
                        <th width="5.5%">Print Send</th>
                        <th width="5.5%">Print Rcv </th>
                        <th width="5.5%">Emb Req</th>
                        <th width="5.5%">Emb Send </th>
                        <th width="5.5%">Emb Rcv</th>
                        <th width="5.5%">Ok Sewing</th>
                        <th width="5.5%">Rej Qty</th>
                        <th width="5.5%">Sending Qty</th>
                        <th width="5.5%">Fast Send Date</th>
                        <th width="5.5%">Last Send Date</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    $gr_req_qty         = 0;
                    $gr_cut_qty         = 0;
                    $gr_prnt_req_qty    = 0;
                    $gr_prnt_snd_qty    = 0;
                    $gr_prnt_rcv_qty    = 0;
                    $gr_emb_req_qty     = 0;
                    $gr_emb_snd_qty     = 0;
                    $gr_emb_rcv_qty     = 0;
                    $gr_ok_sew_qty      = 0;
                    $gr_sew_rej_qty     = 0;
                    $gr_del_qty         = 0;
                    foreach ($dataArray as $sampleId => $sampleData) 
                    {
                        foreach ($sampleData as $itemId => $itemData) 
                        { 
                            $itm_req_qty        = 0;
                            $itm_cut_qty        = 0;
                            $itm_prnt_req_qty   = 0;
                            $itm_prnt_snd_qty   = 0;
                            $itm_prnt_rcv_qty   = 0;
                            $itm_emb_req_qty    = 0;
                            $itm_emb_snd_qty    = 0;
                            $itm_emb_rcv_qty    = 0;
                            $itm_ok_sew_qty     = 0;
                            $itm_sew_rej_qty    = 0;
                            $itm_del_qty        = 0; 
                            foreach ($itemData as $colorId => $colorData) 
                            { 
                                foreach ($colorData as $sizeId => $row) 
                                {                                     
                                    $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                    ?>                        
                                    <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                        
                                        <td valign="middle"><? echo date('d M',strtotime($row['date'])); ?></td>
                                        <td><? echo $lib_sample[$sampleId];?></td>
                                        <td align=""><? echo $garments_item[$itemId];?></td>
                                        <td align=""><? echo $lib_color[$colorId];?></td>
                                        <td align=""><? echo $lib_size[$sizeId];?></td>
                                        <td align="right"><? echo $row['total_qty'];?></td>
                                        <td align="right"><? echo $row['cutting_qty'];?></td>
                                        <td align="right"><? echo $row['total_qty'];?></td>
                                        <td align="right"><? echo $row['print_qty'];?></td>
                                        <td align="right"><? echo $row['print_rcv_qty'];?></td>
                                        <td align="right"><? echo $row['total_qty'];?></td>
                                        <td align="right"><? echo $row['emb_qty'];?></td>
                                        <td align="right"><? echo $row['emb_rcv_qty'];?></td>
                                        <td align="right"><? echo $row['output_qty'];?></td>
                                        <td align="right"><? echo $row['reject_qty'];?></td>
                                        <td align="right"><? echo $row['del_qty'];?></td>
                                        <td align="center"><? echo ($row['first_snd_date'] !="") ? date('d M',strtotime($row['first_snd_date'])) : "";?></td>
                                        <td align="center"><? echo ($row['last_snd_date'] !="") ? date('d M',strtotime($row['last_snd_date'])) : "";?></td>
                                    </tr>
                                    <?
                                    $i++;
                                    $gr_req_qty         += $row['total_qty'];
                                    $gr_cut_qty         += $row['cutting_qty'];
                                    $gr_prnt_req_qty    += $row['total_qty'];
                                    $gr_prnt_snd_qty    += $row['print_qty'];
                                    $gr_prnt_rcv_qty    += $row['print_rcv_qty'];
                                    $gr_emb_req_qty     += $row['total_qty'];
                                    $gr_emb_snd_qty     += $row['emb_qty'];
                                    $gr_emb_rcv_qty     += $row['emb_rcv_qty'];
                                    $gr_ok_sew_qty      += $row['output_qty'];
                                    $gr_sew_rej_qty     += $row['reject_qty'];
                                    $gr_del_qty         += $row['del_qty'];

                                    $itm_req_qty        += $row['total_qty'];
                                    $itm_cut_qty        += $row['cutting_qty'];
                                    $itm_prnt_req_qty   += $row['total_qty'];
                                    $itm_prnt_snd_qty   += $row['print_qty'];
                                    $itm_prnt_rcv_qty   += $row['print_rcv_qty'];
                                    $itm_emb_req_qty    += $row['total_qty'];
                                    $itm_emb_snd_qty    += $row['emb_qty'];
                                    $itm_emb_rcv_qty    += $row['emb_rcv_qty'];
                                    $itm_ok_sew_qty     += $row['output_qty'];
                                    $itm_sew_rej_qty    += $row['reject_qty'];
                                    $itm_del_qty        += $row['del_qty'];
                                }
                            }
                        } 
                        ?>
                        <tr style="font-weight:bold;text-align:right;">
                            <td colspan="5">Total</td>
                            <td><? echo fn_number_format($itm_req_qty,0);?></td>
                            <td><? echo fn_number_format($itm_cut_qty,0);?></td>
                            <td><? echo fn_number_format($itm_prnt_req_qty,0);?></td>
                            <td><? echo fn_number_format($itm_prnt_snd_qty,0);?></td>
                            <td><? echo fn_number_format($itm_prnt_rcv_qty,0);?></td>
                            <td><? echo fn_number_format($itm_emb_req_qty,0);?></td>
                            <td><? echo fn_number_format($itm_emb_snd_qty,0);?></td>
                            <td><? echo fn_number_format($itm_emb_rcv_qty,0);?></td>
                            <td><? echo fn_number_format($itm_ok_sew_qty,0);?></td>
                            <td><? echo fn_number_format($itm_sew_rej_qty,0);?></td>
                            <td><? echo fn_number_format($itm_del_qty,0);?></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <?
                    }
                    ?>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="5">Grand Total</th>
                        <th><? echo fn_number_format($gr_req_qty,0);?></th>
                        <th><? echo fn_number_format($gr_cut_qty,0);?></th>
                        <th><? echo fn_number_format($gr_prnt_req_qty,0);?></th>
                        <th><? echo fn_number_format($gr_prnt_snd_qty,0);?></th>
                        <th><? echo fn_number_format($gr_prnt_rcv_qty,0);?></th>
                        <th><? echo fn_number_format($gr_emb_req_qty,0);?></th>
                        <th><? echo fn_number_format($gr_emb_snd_qty,0);?></th>
                        <th><? echo fn_number_format($gr_emb_rcv_qty,0);?></th>
                        <th><? echo fn_number_format($gr_ok_sew_qty,0);?></th>
                        <th><? echo fn_number_format($gr_sew_rej_qty,0);?></th>
                        <th><? echo fn_number_format($gr_del_qty,0);?></th>
                        <th></th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div style="padding-top:30px;">
            <table class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="480">
                <caption><h3>Accessories info</h3></caption>
                <thead>
                    <th width="80">Name of Accessories</th>
                    <th width="80">Description</th>
                    <th width="80">Req Qty</th>
                    <th width="80">Rcv Qty</th>
                    <th width="80">Bal qty</th>
                    <th width="80">Last Rcv Date</th>
                </thead>
                <tbody>
                    <?
                    foreach ($accArray as $tgroup => $tgroupData) 
                    {
                        foreach ($tgroupData as $desc => $row) 
                        {                        
                    
                        ?>
                        <tr>
                            <td><? echo $lib_item_group[$tgroup];?></td>
                            <td><? echo $desc?></td>
                            <td align="right"><? echo $row;?></td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                        </tr>
                    <?}}?>
                </tbody>
            </table>
        </div>
    </div> 
    <?
}

if($action=="exfactory_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_machine = return_library_array("select id,machine_no from lib_machine_name", "id", "machine_no");
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);
    // ====================================== ITEM AND COLOR ==================================
    $sqlOrder = "SELECT a.style_ref_no as STYLE,b.grouping as INT_REF from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in($poIds)";
    //echo $sqlOrder;die();
    $sqlOrderRes = sql_select($sqlOrder);

    
    $sqlExfact = "SELECT a.item_number_id as ITEM_ID,d.color_number_id as COLOR_ID,a.ex_factory_date as EX_DATE,sum(b.production_qnty) AS QTY FROM pro_ex_factory_mst a, pro_ex_factory_dtls b,pro_ex_factory_delivery_mst c,wo_po_color_size_breakdown d WHERE a.id=b.mst_id and c.id=a.delivery_mst_id and a.po_break_down_id=d.po_break_down_id and a.item_number_id=d.item_number_id and d.id=b.color_size_break_down_id and a.po_break_down_id in($poIds)  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active =1 and d.is_deleted=0 GROUP BY a.item_number_id,d.color_number_id,a.ex_factory_date order by a.ex_factory_date DESC";
    // echo $sqlExfact;die();
    $exfactRes = sql_select($sqlExfact);
    $dataArray = array();
    foreach ($exfactRes as $val) 
    {
        $dataArray[$val['EX_DATE']][$val['ITEM_ID']][$val['COLOR_ID']]['qty'] += $val['QTY'];
    }
    //================================ count rowspan =============================
    $rowspan_date = array();
    $rowspan_item = array();
    foreach ($dataArray as $date => $dateData) 
    {
        foreach ($dateData as $item => $itemData) 
        {
            foreach ($itemData as $color => $row) 
            {
                 $rowspan_date[$date]++;
                 $rowspan_item[$date][$item]++;
            }        
        }
    }
    // echo "<pre>";print_r($rowspan_item);
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 100%;" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="360">
                <caption style="font-size:20px;"><b>Ex-Factory Details</b></caption>
                <tbody>
                    <tr>
                        <td colspan="4" width="100%"><b>Style Name:<? echo $sqlOrderRes[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref:<? echo $sqlOrderRes[0]['INT_REF'];?></b></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- ===================================== 1st part start ================================== -->
        <div class="first_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="360">
                <thead>
                    <tr>
                        <th width="80">Ex-Factory Date</th>
                        <th width="100">Item</th>
                        <th width="100">Color</th>
                        <th width="80">Ship qty</th>
                    </tr>
                </thead>
            </table
            ><div style="width:380px;max-height:400px;overflow-y:auto">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="360">
                    <tbody>
                        <?
                        $i=0;
                        $grnd_ex_qty = 0;
                        foreach ($dataArray as $date => $dateData) 
                        {
                            $d=0;
                            $dateShipQty   = 0 ;
                            $itm_count = count($rowspan_item[$date]);
                            foreach ($dateData as $itemId => $itemData) 
                            { 
                                $itm=0;
                                $itemShipQty   = 0 ;
                                foreach ($itemData as $colorId => $row) 
                                { 
                                    $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                    ?>                        
                                    <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">   
                                        <? if($d==0){?>           
                                        <td valign="middle" rowspan="<? echo ($itm_count>1) ? $rowspan_date[$date]+1 : $rowspan_date[$date];?>" width="80" align="center"><? echo date('d M',strtotime($date));?></td> 
                                        <?  $d++;} if($itm==0){?>                
                                        <td valign="middle" rowspan="<? echo $rowspan_item[$date][$itemId];?>" width="100"><? echo $garments_item[$itemId];?></td> 
                                        <? $itm++;}?> 
                                        <td width="100"><? echo $lib_color[$colorId];?></td>  
                                        <td width="80" align="right"><? echo $row['qty'];?></td>
                                    </tr>
                                    <?
                                    $i++;                                   
                                    $dateShipQty   += $row['qty'] ;
                                    $itemShipQty   += $row['qty'] ;
                                    $grnd_ex_qty   += $row['qty'] ;
                                }
                                ?>
                                <tr class="tbl_footer" style="font-weight:bold;text-align:right;">
                                <? if($itm_count==1){?>
                                    <td></td>
                                    <? } $itm_count--;?>
                                    <td></td>
                                    <td align="right">Item Total</td>
                                    <td align="right"><? echo fn_number_format($itemShipQty,0);?></td>
                                </tr>
                                <?
                            }
                            ?>
                            <tr class="tbl_footer" style="font-weight:bold;text-align:right;">
                                <td></td>
                                <td></td>
                                <td align="right">Date Total</td>
                                <td align="right"><? echo fn_number_format($dateShipQty,0);?></td>
                            </tr>
                            <?
                        }
                        ?>
                    </tbody>
                </table>
            </div>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="360">
                <tfoot>
                    <tr>
                        <th width="80"></th>
                        <th width="100"></th>
                        <th width="100" align="right">Grand Total</th>
                        <th width="80" align="right"><? echo fn_number_format($grnd_ex_qty,0);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div> 
    <?
}

if($action=="exfactory_popup_acct_po")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_country = return_library_array("select id,country_name from lib_country", "id", "country_name");
    $lib_size = return_library_array("select id,size_name from lib_size", "id", "size_name");
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);

    // ===================================== act po data ===============================
    $sql = "SELECT (b.unit_price/a.total_set_qnty) as UNIT_PRICE,c.ACC_PO_NO,d.PO_QTY as ACC_PO_QTY,c.ACC_SHIP_DATE,d.po_break_down_id as PO_ID,d.id as ACC_ID,d.COUNTRY_ID,d.GMTS_ITEM,d.gmts_color_id as COLOR_ID,d.gmts_size_id as SIZE_ID from wo_po_details_master a, wo_po_break_down b, wo_po_acc_po_info c,wo_po_acc_po_info_dtls d where a.id=b.job_id and b.id=c.po_break_down_id and c.id=d.mst_id and b.status_active=1 and c.status_active=1 and d.status_active=1 and d.is_deleted=0 and b.id in($poIds) and c.acc_po_status=1 order by c.acc_ship_date,d.country_id,d.gmts_item,d.gmts_color_id,d.gmts_size_id";
    // echo $sql;
    $res = sql_select($sql);
    $data_array = array();
    foreach ($res as $val) 
    {
        $data_array[$val['PO_ID']][strtotime($val['ACC_SHIP_DATE'])][$val['ACC_ID']][$val['COUNTRY_ID']][$val['GMTS_ITEM']][$val['COLOR_ID']][$val['SIZE_ID']]['acc_po_no'] = $val['ACC_PO_NO'];
        $data_array[$val['PO_ID']][strtotime($val['ACC_SHIP_DATE'])][$val['ACC_ID']][$val['COUNTRY_ID']][$val['GMTS_ITEM']][$val['COLOR_ID']][$val['SIZE_ID']]['qty'] += $val['ACC_PO_QTY'];
        $data_array[$val['PO_ID']][strtotime($val['ACC_SHIP_DATE'])][$val['ACC_ID']][$val['COUNTRY_ID']][$val['GMTS_ITEM']][$val['COLOR_ID']][$val['SIZE_ID']]['val'] += $val['ACC_PO_QTY']*$val['UNIT_PRICE'];
        $data_array[$val['PO_ID']][strtotime($val['ACC_SHIP_DATE'])][$val['ACC_ID']][$val['COUNTRY_ID']][$val['GMTS_ITEM']][$val['COLOR_ID']][$val['SIZE_ID']]['unit_price'] = $val['UNIT_PRICE'];
    }

    // echo "<pre>";print_r($data_array);
    // ================================== Start Gmt Finishing data ==================================
    $sqlFin = "SELECT a.id, b.actual_po_id,b.actual_po_dtls_id, b.PROD_QTY as FIN_QTY from PRO_GARMENTS_PRODUCTION_MST a, PRO_GARMENTS_PROD_ACTUAL_PO_DETAILS b, wo_po_break_down c where a.id=b.mst_id and a.po_break_down_id=c.id and a.status_active=1 and b.status_active=1 and a.po_break_down_id in($poIds)";
    //echo $sqlFin; die;
    $finRes = sql_select($sqlFin);
    //var_dump($finRes); die;
    $tot_acc_po_fin_arr = array();
    foreach($finRes as $val){
        $acc_po_id = "";
        if($val['ACTUAL_PO_DTLS_ID']=="")
        {
            $acc_po_id = $val['ACTUAL_PO_ID'];
        }
        else
        {
            $acc_po_id = $val['ACTUAL_PO_DTLS_ID'];
        }
        $tot_acc_po_fin_arr[$val['MST_ID']][$acc_po_id] = $acc_po_id;
    }
    //var_dump($tot_acc_po_fin_arr); die;
    $fin_data_array = array();
    $fin_data_array2 = array();
    foreach ($finRes as $val) 
    {
        $acc_po_id = "";
        if($val['ACTUAL_PO_DTLS_ID']=="")
        {
            $acc_po_id = $val['ACTUAL_PO_ID'];
        }
        else
        {
            $acc_po_id = $val['ACTUAL_PO_DTLS_ID'];
        }
        $fin_data_array2[$acc_po_id]['fin_qty'] += $val['FIN_QTY'];            
    }
    // ================================== END Gmt Finishing data ==================================
    
    // ================================== ex-factory data ==================================
   /*  $sqlExfact = "SELECT a.SHIPING_MODE,a.ACTUAL_PO,a.ex_factory_date as EX_DATE,b.PRODUCTION_QNTY,c.COUNTRY_ID,c.ITEM_NUMBER_ID as ITEM_ID,c.color_number_id as COLOR_ID,c.size_number_id as SIZE_ID FROM pro_ex_factory_mst a, pro_ex_factory_dtls b,wo_po_color_size_breakdown c WHERE a.id=b.mst_id and c.id=b.color_size_break_down_id and a.po_break_down_id in($poIds) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
    // echo $sqlExfact;die();
    $exfactRes = sql_select($sqlExfact);
    $ex_data_array = array();
    $ex_data_array2 = array();
    foreach ($exfactRes as $val) 
    {
        $val_ex = explode(",", $val['ACTUAL_PO']);
        $tot_acct_po = count($val_ex);
        $acct_po_wise_ex_qty = $val['PRODUCTION_QNTY']/$tot_acct_po;
        foreach ($val_ex as $key => $acct_po_id) 
        {
            $ex_data_array2[$acct_po_id]['qty'] += $acct_po_wise_ex_qty;
            $ex_data_array2[$acct_po_id]['shiping_mode'] = $val['SHIPING_MODE'];
            $ex_data_array2[$acct_po_id]['ex_date'] = strtotime($val['EX_DATE']);
        }       
    } */
    // echo "<pre>";print_r($ex_data_array);die();

    $sqlEx = "SELECT a.id as mst_id, b.actual_po_id,b.actual_po_dtls_id, a.SHIPING_MODE,a.ex_factory_date as EX_DATE,b.ex_fact_qty as PRODUCTION_QNTY FROM pro_ex_factory_mst a, pro_ex_factory_actual_po_details b where a.id=b.mst_id and a.status_active=1 and b.status_active=1 and a.po_break_down_id in($poIds)";
    // echo $sqlEx;
    $exfactRes = sql_select($sqlEx);
    $tot_acc_po_arr = array();
    foreach ($exfactRes as $val) 
    {
        $acc_po_id = "";
        if($val['ACTUAL_PO_DTLS_ID']=="")
        {
            $acc_po_id = $val['ACTUAL_PO_ID'];
        }
        else
        {
            $acc_po_id = $val['ACTUAL_PO_DTLS_ID'];
        }
        $tot_acc_po_arr[$val['MST_ID']][$acc_po_id] = $acc_po_id;
    }
    // $acc_po_id_arr = array_unique(explode(",", $tot_acc_po));

    // echo "<pre>";print_r($tot_acc_po);

   

    $ex_data_array = array();
    $ex_data_array2 = array();
    foreach ($exfactRes as $val) 
    {
        $acc_po_id = "";
        if($val['ACTUAL_PO_DTLS_ID']=="")
        {
            $acc_po_id = $val['ACTUAL_PO_ID'];
        }
        else
        {
            $acc_po_id = $val['ACTUAL_PO_DTLS_ID'];
        }
        
        // $acct_po_wise_ex_qty = $val['PRODUCTION_QNTY']/count($tot_acc_po_arr[$val['MST_ID']]);
        // $ex_data_array2[$acc_po_id]['qty'] += $acct_po_wise_ex_qty;
        $ex_data_array2[$acc_po_id]['qty'] += $val['PRODUCTION_QNTY'];
        $ex_data_array2[$acc_po_id]['shiping_mode'] = $val['SHIPING_MODE'];
        $ex_data_array2[$acc_po_id]['ex_date'] = strtotime($val['EX_DATE']);
             
    }
    ?>    
    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }            
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 100%;" id="details_reports">
        <div class="header_part">
            <center><h2>PO Wise Shipment Status</h2></center>
        </div>
        <!-- ===================================== 1st part start ================================== -->
        <div class="first_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1210">
                <caption><b>IR No. : <? echo return_field_value("grouping","wo_po_break_down","id=$poIds","grouping"); ?></b></caption>
                <thead>
                    <tr>
                        <th width="60">Actual PO Ship Date</th>
                        <th width="100">Actual PO No </th>
                        <th width="100">Country </th>
                        <th width="100">Item </th>
                        <th width="100">Color </th>
                        <th width="80">Size</th>
                        <th width="80">Actual PO Qty</th>
                        <th width="80">Actual PO Value </th>
                        <th width="80">Gmt Finishing  </th>
                        <th width="60">Act Ship Date  </th>
                        <th width="50">Delay (day) </th>
                        <th width="80">Ship mode  </th>
                        <th width="80">Act Ship qty </th>
                        <th width="80">Short/excess qty </th>
                        <th width="80">Act Ship Value </th>
                        <th width="80">Short/excess Value</th>
                    </tr>
                </thead>
            </table>
            <div style="width:1230px;max-height:335px;overflow-y:auto">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1210" id="table_body">
                    <tbody>
                        <?
                        $i=0;
                        $grnd_acc_po_qty    = 0;   
                        $grnd_acc_po_val    = 0;   
                        $grnd_acc_fin_qty    = 0;   
                        $grnd_ship_qty      = 0;   
                        $grnd_ship_val      = 0;   
                        $grnd_excess_qty    = 0;   
                        $grnd_excess_val    = 0;   
                        foreach ($data_array as $po_id => $po_data) 
                        {
                            foreach ($po_data as $ship_date => $date_data) 
                            {
                                foreach ($date_data as $acc_po_id => $acc_po_data) 
                                { 
                                    foreach ($acc_po_data as $country_id => $country_data) 
                                    { 
                                        foreach ($country_data as $item_id => $item_data) 
                                        {  
                                            foreach ($item_data as $color_id => $color_data) 
                                            { 
                                                foreach ($color_data as $size_id => $row) 
                                                {                                                
                                                    $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;

                                                    $datediff = ($ex_data_array2[$acc_po_id]['ex_date']!="") ? $ex_data_array2[$acc_po_id]['ex_date'] - $ship_date : time() - $ship_date;
                                                    // echo $ex_data_array2[$acc_po_id]['ex_date'] - $ship_date."<br>";
                                                    $delay = round($datediff / (60 * 60 * 24));
                                                    $acct_fin_qty = $fin_data_array2[$acc_po_id]['fin_qty'];
                                                    $acct_ship_qty = $ex_data_array2[$acc_po_id]['qty'];
                                                    $short_excess = $row['qty'] - $ex_data_array2[$acc_po_id]['qty'];
                                                    $acct_po_val = $ex_data_array2[$acc_po_id]['qty']*$row['unit_price'];
                                                    $short_excess_val = $short_excess*$row['unit_price'];

                                                    ?>                        
                                                    <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>"> 
                                                        <td align="center" width="60"><?= ($ship_date!="") ? date('d-M-y',$ship_date) : '';?></td>
                                                        <td width="100"><p><?= $row['acc_po_no']; ?></p></td>
                                                        <td width="100"><p><?= $lib_country[$country_id]; ?></p></td>
                                                        <td width="100"><p><?= $garments_item[$item_id]; ?></p></td>
                                                        <td width="100"><p><?= $lib_color[$color_id]; ?></p></td>
                                                        <td width="80"><p><?= $lib_size[$size_id]; ?></p></td>
                                                        <td align="right" width="80"><?= fn_number_format($row['qty'],0);?></td>
                                                        <td align="right" width="80"><?= fn_number_format($row['val'],2);?></td>
                                                        <td align="right" width="80"><?= fn_number_format($acct_fin_qty,2);?></td>
                                                        <td align="center" width="60"><?= ($ex_data_array2[$acc_po_id]['ex_date']!="") ? date('d-M-y',$ex_data_array2[$acc_po_id]['ex_date']) : '';?></td>
                                                        <td width="50" align="center"><?= $delay;?></td>
                                                        <td width="80"><?= $shipment_mode[$ex_data_array2[$acc_po_id]['shiping_mode']];?></td>
                                                        <td align="right" width="80"><?= fn_number_format($acct_ship_qty,0);?></td>
                                                        <td align="right" width="80"><?= fn_number_format($short_excess,0);?></td>
                                                        <td align="right" width="80"><?= fn_number_format($acct_po_val,2);?></td>
                                                        <td align="right" width="80"><?= fn_number_format($short_excess_val,2); ?></td>
                                                    </tr>
                                                    <?
                                                    $i++;
                                                    $grnd_acc_po_qty    += $row['qty'];   
                                                    $grnd_acc_po_val    += $row['val'];
                                                    $grnd_acc_fin_qty    += $acct_fin_qty;   
                                                    $grnd_ship_qty      += $acct_ship_qty;   
                                                    $grnd_ship_val      += $acct_po_val;
                                                    $grnd_excess_qty    += $short_excess;   
                                                    $grnd_excess_val    += $short_excess_val;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        ?>
                    </tbody>
                </table>
            </div>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1210">
                <tfoot>
                    <tr>
                        <th width="60"></th>
                        <th width="100"></th>
                        <th width="100"></th>
                        <th width="100"></th>
                        <th width="100"></th>
                        <th width="80">Total</th>
                        <th width="80" id="grnd_acc_po_qty"><?= fn_number_format($grnd_acc_po_qty,0); ?></th>
                        <th width="80" id="value_grnd_acc_po_val"><?= fn_number_format($grnd_acc_po_val,2); ?></th>
                        <th width="80" id="grnd_acc_fin_qty"><?= fn_number_format($grnd_acc_fin_qty,2); ?></th>
                        <th width="60"></th>
                        <th width="50"></th>
                        <th width="80"></th>
                        <th width="80" id="grnd_ship_qty"><?= fn_number_format($grnd_ship_qty,0); ?></th>
                        <th width="80" id="grnd_excess_qty"><?= fn_number_format($grnd_excess_qty,0); ?></th>
                        <th width="80" id="grnd_ship_val"><?= fn_number_format($grnd_ship_val,2); ?></th>
                        <th width="80" id="value_grnd_excess_val"><?= fn_number_format($grnd_excess_val,2); ?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div> 
    <script>
        var tableFilters =
        {
            col_operation: 
            {
                id: ["grnd_acc_po_qty","value_grnd_acc_po_val","grnd_acc_fin_qty","grnd_ship_qty","grnd_excess_qty","grnd_ship_val","value_grnd_excess_val"],
                col: [6,7,8,12,13,14,15],
                operation: ["sum","sum","sum","sum","sum","sum","sum"],
                write_method: ["innerHTML","innerHTML","innerHTML","innerHTML","innerHTML","innerHTML","innerHTML"]
            }
        }
        setFilterGrid("table_body",-1,tableFilters);  
   </script> 
    <?
}

if($action=="aop_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);
    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();
    //$costPerArr=$condition->getCostingPerArr();
    $fabric= new fabric($condition);
    //echo $fabric->getQuery();die;
    $fabric_costing_arr=$fabric->getQtyArray_by_orderColorTypeAndGmtscolor_knitAndwoven_greyAndfinish();
     
    /*echo "<pre>";
    print_r($fabric_costing_arr);
    die;*/

    $service_sql = sql_select("SELECT a.entry_form as ENTRY_FORM, a.dyeing_company as  DYEING_COMPANY, b.order_id as ORDER_ID, b.color_id as COLOR_ID, b.batch_issue_qty as BATCH_ISSUE_QTY, b.grey_used as GREY_USED, a.receive_date as RECEIVE_DATE, b.id as ID, max(b.id) as LAST_ID
        from inv_receive_mas_batchroll a, pro_grey_batch_dtls b
        where a.id = b.mst_id and order_id in ($poIds) and a.entry_form in (91,92) AND B.PROCESS_ID = 35
        group by a.entry_form, a.dyeing_company, b.order_id, b.color_id,  b.batch_issue_qty, b.grey_used, a.receive_date,b.id");

    foreach ($service_sql as  $val) 
    {
        if($val['ENTRY_FORM'] == 91)
        {
            $color_wise[$val['COLOR_ID']]['ISSUE'] += $val['BATCH_ISSUE_QTY'];
            $supplier_color_wise[$val['DYEING_COMPANY']][$lib_color[$val['COLOR_ID']]]['ISSUE'] += $val['BATCH_ISSUE_QTY'];
            if($val['ID'] == $val['LAST_ID'])
            {
                $supplier_color_wise[$val['DYEING_COMPANY']][$lib_color[$val['COLOR_ID']]]['LAST_ISSUE_DATE'] = $val['RECEIVE_DATE'];
                $supplier_color_wise[$val['DYEING_COMPANY']][$lib_color[$val['COLOR_ID']]]['LAST_ISSUE_QNTY'] = $val['BATCH_ISSUE_QTY'];
            }
        }
        else
        {
            if($val['ID'] == $val['LAST_ID'])
            {

                $supplier_color_wise[$val['DYEING_COMPANY']][$lib_color[$val['COLOR_ID']]]['LAST_RECEIVE_DATE'] = $val['RECEIVE_DATE'];
            }
            $color_wise[$val['COLOR_ID']]['RECEIVE'] += $val['BATCH_ISSUE_QTY'];
            $color_wise[$val['COLOR_ID']]['GREY_USED'] += $val['GREY_USED'];
            $supplier_color_wise[$val['DYEING_COMPANY']][$lib_color[$val['COLOR_ID']]]['RECEIVE'] += $val['BATCH_ISSUE_QTY'];
            $supplier_color_wise[$val['DYEING_COMPANY']][$lib_color[$val['COLOR_ID']]]['GREY_USED'] += $val['GREY_USED'];
        }
    }


    $wo_sql = sql_select("SELECT a.booking_no as BOOKING_NO, b.gmts_color_id as GMTS_COLOR_ID, b.po_break_down_id as PO_BREAK_DOWN_ID, a.supplier_id as SUPPLIER_ID, b.wo_qnty as WO_QNTY, min(a.booking_date) as BOOKING_DATE from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.process=35 and b.po_break_down_id in ($poIds) and b.status_active =1 and b.is_deleted =0 group by a.booking_no, b.gmts_color_id, b.po_break_down_id, a.supplier_id, b.wo_qnty");

    foreach ($wo_sql as  $val) 
    {
        $supplier_color_wise[$val['SUPPLIER_ID']][$lib_color[$val['GMTS_COLOR_ID']]]['WO_QNTY'] +=  $val['WO_QNTY'];
        $supplier_color_wise[$val['SUPPLIER_ID']][$lib_color[$val['GMTS_COLOR_ID']]]['BOOKING_DATE'] =  $val['BOOKING_DATE'];
        $color_wise[$val['GMTS_COLOR_ID']]['WO_QNTY'] +=$val['WO_QNTY'];
    }


    $sqlOrder = "SELECT a.style_ref_no as STYLE, b.id as POID, b.grouping as INT_REF,  d.color_number_id as COLOR_NUMBER_ID, c.color_type_id as COLOR_TYPE_ID,e.color_name from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_fabric_cost_dtls c, wo_po_color_size_breakdown d,lib_color e where a.id=b.job_id and a.job_no= c.job_no and b.id = d.po_break_down_id and e.id=d.color_number_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and b.id in ($poIds) and c.color_type_id in (5) group by a.style_ref_no, b.id, b.grouping, d.color_number_id,c.color_type_id,e.color_name order by e.color_name";
    $sqlOrderRes = sql_select($sqlOrder);
    if(count($sqlOrderRes)==0)
    {
        ?>
        <div style="text-align: center;color: red;font-size: 18px;font-weight: bold;">Data Not Found.</div>
        <?
        die();
    }
    
    ?>    
    <div id="data_panel" align="center" style="width:1200px">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: 1200px;" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="1200">
                <caption style="font-size:20px;"><b>AOP Info</b></caption>
                <tbody>
                    <tr>
                        <td colspan="18" width="1000"><b>Style Name:<? echo $sqlOrderRes[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref:<? echo $sqlOrderRes[0]['INT_REF'];?></b></td>
                    </tr>
                </tbody>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1200">
                <thead>
                    <tr>
                        <th width="80">Color/Combo</th>
                        <th width="80">Req Qty (fin )</th>
                        <th width="80">Req Qty (Gray)</th>
                        <th width="80">Excess Qty(Fin)</th>
                        <th width="80">Excss Qty ( Gray )</th>
                        <th width="80">Cal PL%</th>

                        <th width="80">WO Qty (Gray )</th>
                        <th width="80">WO Bal</th>
                        <th width="80">Fabric Sending Qty</th>
                        <th width="80">Sending Bal</th>
                        <th width="80">Rcv As Gray</th>
                        <th width="80">Rcv As Finish(Ok)</th>
                        <th width="80">Rcv As Finish(Rej)</th>
                        <th width="80">Rcv Bal as Fin</th>
                        <th width="80">Act PL%</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    foreach ($sqlOrderRes as $row) 
                    {
                
                        $fab_knit_grey=array_sum($fabric_costing_arr['knit']['grey'][$row['POID']][$row['COLOR_TYPE_ID']][$row['COLOR_NUMBER_ID']]);
                        $fab_knit_finish=array_sum($fabric_costing_arr['knit']['finish'][$row['POID']][$row['COLOR_TYPE_ID']][$row['COLOR_NUMBER_ID']]);
                        
                        $fab_woven_grey=array_sum($fabric_costing_arr['woven']['grey'][$row['POID']]);
                        $fab_woven_finish=array_sum($fabric_costing_arr['woven']['finish'][$row['POID']]);

                        $grey_required =  $fab_knit_grey+$fab_woven_grey;
                        $finish_required =  $fab_knit_finish+$fab_woven_finish;                        

                        if($grey_required>0)
                        {
                            $cal_pl = ($grey_required -$finish_required)/ $grey_required*100;
                        }else{
                            $cal_pl=0;
                        }
                        
                        $grey_balance = $grey_required - $color_wise[$row['COLOR_NUMBER_ID']]['WO_QNTY'];
                        $issue_balance = $grey_required - $color_wise[$row['COLOR_NUMBER_ID']]['ISSUE'];
                        $receive_balance= $finish_required-$color_wise[$row['COLOR_NUMBER_ID']]['RECEIVE'];

                        if($color_wise[$row['COLOR_NUMBER_ID']]['RECEIVE'] >0 ){
                            $act_pl = ($color_wise[$row['COLOR_NUMBER_ID']]['GREY_USED'] - $color_wise[$row['COLOR_NUMBER_ID']]['RECEIVE'])/$color_wise[$row['COLOR_NUMBER_ID']]['GREY_USED']*100;
                        }else{
                            $act_pl =0;
                        }

                        if($finish_required>0 || $grey_required>0 || $color_wise[$row['COLOR_NUMBER_ID']]['WO_QNTY']>0 || $color_wise[$row['COLOR_NUMBER_ID']]['ISSUE'] || $color_wise[$row['COLOR_NUMBER_ID']]['RECEIVE'])
                        {                            
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                                <td><? echo $lib_color[$row['COLOR_NUMBER_ID']];?></td>
                                <td align="right"><? echo fn_number_format($finish_required,2);?></td>
                                <td align="right"><? echo fn_number_format($grey_required,2);?></td>
                                <td align="right" width="80" >&nbsp;</td>
                                <td align="right" width="80" >&nbsp;</td>
                                <td align="right" width="80" ><? echo fn_number_format($cal_pl); ?></td>
                                <td align="right" width="80" ><? echo fn_number_format($color_wise[$row['COLOR_NUMBER_ID']]['WO_QNTY']); ?></td>
                                <td align="right" width="80" ><? echo fn_number_format($grey_balance,2);?></td>
                                <td align="right" width="80" ><? echo fn_number_format($color_wise[$row['COLOR_NUMBER_ID']]['ISSUE'], 2 ); ?></td>
                                <td align="right" width="80" ><? echo fn_number_format($issue_balance,2) ?></td>
                                <td align="right" width="80" ><? echo fn_number_format($color_wise[$row['COLOR_NUMBER_ID']]['GREY_USED']); ?></td>
                                <td align="right" width="80" ><? echo fn_number_format($color_wise[$row['COLOR_NUMBER_ID']]['RECEIVE'], 2 ); ?></td>
                                <td align="right" width="80" ><? echo fn_number_format(0,2) ?></td>
                                <td align="right" width="80" ><? echo fn_number_format($receive_balance,2); ?></td>
                                <td align="right" width="80" ><? echo fn_number_format($act_pl,2); ?></td>
                            </tr>
                            <?
                            $i++; 
                            $tot_finish_required +=$finish_required;      
                            $tot_grey_required +=$grey_required;      
                            $tot_wo_qnty +=$color_wise[$row['COLOR_NUMBER_ID']]['WO_QNTY'];      
                            $tot_grey_balance +=$grey_balance;      
                            $tot_issue +=$color_wise[$row['COLOR_NUMBER_ID']]['ISSUE'];      
                            $tot_issue_balance +=$issue_balance;      
                            $tot_grey_used +=$color_wise[$row['COLOR_NUMBER_ID']]['GREY_USED'];      
                            $tot_receive +=$color_wise[$row['COLOR_NUMBER_ID']]['RECEIVE'];      
                            $tot_receive_balance +=$receive_balance; 
                        }     
                    }

                    if($tot_grey_required>0)
                    {
                        $tot_cal_pl = ($tot_grey_required -$tot_finish_required)/ $tot_grey_required*100;
                    }else{
                        $tot_cal_pl=0;
                    }
                    if($tot_grey_used>0)
                    {
                        $tot_act_pl = ($tot_grey_used -$tot_receive)/ $tot_grey_used*100;
                    }else{
                        $tot_act_pl=0;
                    }
                    ?>
                    
                </tbody>
                <tfoot>
                    <tr style="font-weight:bold;text-align:right;">
                        <th width="80">Grand Total:</th>
                        <th width="80"><? echo fn_number_format($tot_finish_required,2);?></th>
                        <th width="80"><? echo fn_number_format($tot_grey_required,2);?></th>
                        <th width="80"><? //echo fn_number_format($tot_finish_required,2);?></th>
                        <th width="80"><? //echo fn_number_format($tot_finish_required,2);?></th>
                        <th width="80"><? echo fn_number_format($tot_cal_pl,2);?></th>
                        <th width="80"><? echo fn_number_format($tot_wo_qnty,2);?></th>
                        <th width="80"><? echo fn_number_format($tot_grey_balance,2);?></th>
                        <th width="80"><? echo fn_number_format($tot_issue,2);?></th>
                        <th width="80"><? echo fn_number_format($tot_issue_balance,2);?></th>
                        <th width="80"><? echo fn_number_format($tot_grey_used,2);?></th>
                        <th width="80"><? echo fn_number_format($tot_receive,2);?></th>
                        <th width="80"><? //echo fn_number_format($tot_finish_required,2);?></th>
                        <th width="80"><? echo fn_number_format($tot_receive_balance,2);?></th>
                        <th width="80"><? echo fn_number_format($tot_act_pl,2);?></th>
                    </tr>
                </tfoot>
            </table>

            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="1200">
                <tbody>
                    <tr>
                        <td colspan="16" width="1000" align="center"><b>Factory Wise</b></td>
                    </tr>
                </tbody>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1200">
                <thead>
                    <tr>
                        <th width="80">AOP Factory</th>
                        <th width="80">Color/Combo</th>
                        <th width="80">WO Qty (Gray )</th>
                        <th width="80">WO Qty (Fin)</th>
                        <th width="80">Program Date</th>
                        <th width="80">Cal PL%</th>
                        <th width="80">Fabric Sending Qty</th>

                        <th width="80">Last Sending Date</th>
                        <th width="80">Last Send Qty</th>
                        <th width="80">Sending Bal</th>
                        <th width="80">Rcv As Gray</th>
                        <th width="80">Rcv As Finish(Ok)</th>
                        <th width="80">Rcv As Finish(Rej)</th>
                        <th width="80">Rcv Bal as Gray</th>
                        <th width="80">Act PL%</th>
                        <th width="80">Last Rcv Date</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=1;
                    foreach ($supplier_color_wise as $supplier_id => $supplier_data) 
                    {
                        $y=1;
                        ksort($supplier_data);
                        foreach ($supplier_data as $color_id => $row) 
                        {
                            $sc_issue_balance = $row['WO_QNTY']-$row['ISSUE'];
                            $sc_grey_used_balance = $row['WO_QNTY']-$row['GREY_USED'];
                            if($row['GREY_USED'] > 0){
                                $sc_act_pl = ($row['GREY_USED'] - $row['RECEIVE'])/$row['GREY_USED']*100;
                            }
                            else{
                                $sc_act_pl = 0;
                            }
                            //echo $sc_act_pl ."= (".$row['GREY_USED'] ."-". $row['RECEIVE'].")/".$row['GREY_USED']."*100**<br>";
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                <?
                                if($y==1)
                                {
                                    ?>
                                    <td width="80" rowspan="<?= count($supplier_data);?>"><? echo $lib_supplier[$supplier_id];?></td>
                                    <?
                                }
                                ?>

                                <td width="80" align="right"><? echo $color_id;?></td>
                                <td width="80" align="right"><? echo fn_number_format($row['WO_QNTY'],2); ?></td>
                                <td width="80" align="right"><? echo fn_number_format(0,2); ?></td>
                                <td width="80" align="right"><? echo change_date_format($row['BOOKING_DATE']);?></td>
                                <td width="80" align="right"><? echo fn_number_format(0,2); ?></td>
                                <td width="80" align="right"><? echo fn_number_format($row['ISSUE'],2); ?></td>
                                <td width="80" align="right"><? echo change_date_format($row['LAST_ISSUE_DATE']); ?></td>
                                <td width="80" align="right"><? echo fn_number_format($row['LAST_ISSUE_QNTY'],2); ?></td>
                                <td width="80" align="right"><? echo fn_number_format($sc_issue_balance,2); ?></td>
                                <td width="80" align="right"><? echo fn_number_format($row['GREY_USED'],2); ?></td>
                                <td width="80" align="right"><? echo fn_number_format($row['RECEIVE'],2);?></td>
                                <td width="80" align="right">&nbsp;<? ?></td>
                                <td width="80" align="right"><? echo fn_number_format($sc_grey_used_balance,2); ?></td>
                                <td width="80" align="right"><? echo fn_number_format($sc_act_pl,2); ?></td>
                                <td width="80" align="right"><? echo change_date_format($row['LAST_RECEIVE_DATE']);?></td>
                            </tr>
                            <?
                            
                            $sub_wo_qnty +=$row['WO_QNTY'];
                            $sub_issue_qnty +=$row['ISSUE'];
                            $sub_issue_balance +=$sc_issue_balance;
                            $sub_grey_used_qnty +=$row['GREY_USED'];
                            $sub_receive_qnty +=$row['RECEIVE'];
                            $sub_grey_used_balance +=$sc_grey_used_balance;

                            $grand_wo_qnty +=$row['WO_QNTY'];
                            $grand_issue_qnty +=$row['ISSUE'];
                            $grand_issue_balance +=$sc_issue_balance;
                            $grand_grey_used_qnty +=$row['GREY_USED'];
                            $grand_receive_qnty +=$row['RECEIVE'];
                            $grand_grey_used_balance +=$sc_grey_used_balance;

                            $y++;
                            $i++;
                        }

                        if($sub_grey_used_qnty > 0)
                        {
                            $sub_sc_act_pl = ($sub_grey_used_qnty - $sub_receive_qnty)/$sub_grey_used_qnty*100;
                        }
                        else{
                            $sub_sc_act_pl = 0;
                        }
                        //echo  $sub_sc_act_pl ."= (".$sub_grey_used_qnty ."-". $sub_receive_qnty.")/".$sub_grey_used_qnty."*100";
                        ?>
                        <tr class="tbl_footer" style="background: #cddcdc">
                            <td width="80" align="right" colspan="2">Total:</td>
                            <td width="80" align="right"><? echo fn_number_format($sub_wo_qnty,2); ?></td>
                            <td width="80" align="right"><? echo fn_number_format(0,2); ?></td>
                            <td width="80" align="right">&nbsp;<? //echo change_date_format($row['BOOKING_DATE']);?></td>
                            <td width="80" align="right"><? echo fn_number_format(0,2); ?></td>
                            <td width="80" align="right"><? echo fn_number_format($sub_issue_qnty,2); ?></td>
                            <td width="80" align="right">&nbsp;<? //echo change_date_format($row['LAST_ISSUE_DATE']); ?></td>
                            <td width="80" align="right">&nbsp;<? //echo fn_number_format($row['LAST_ISSUE_QNTY'],2); ?></td>
                            <td width="80" align="right"><? echo fn_number_format($sub_issue_balance,2); ?></td>
                            <td width="80" align="right"><? echo fn_number_format($sub_grey_used_qnty,2); ?></td>
                            <td width="80" align="right"><? echo fn_number_format($sub_receive_qnty,2);?></td>
                            <td width="80" align="right">&nbsp;<? ?></td>
                            <td width="80" align="right"><? echo fn_number_format($sub_grey_used_balance,2); ?></td>
                            <td width="80" align="right"><? echo fn_number_format($sub_sc_act_pl,2); ?></td>
                            <td width="80" align="right">&nbsp;</td>
                        </tr>
                        <?
                    }
                    if($grand_grey_used_qnty > 0)
                    {
                        $grand_sc_act_pl = ($grand_grey_used_qnty - $grand_receive_qnty)/$grand_grey_used_qnty*100;
                    }
                    else{
                        $grand_sc_act_pl = 0;
                    }
                    ?>
                </tbody>
                <tfoot>
                    <tr class="tbl_footer" style="background: #F0F0F0">
                        <th width="80" align="right" colspan="2">Grand Total:</th>
                        <th width="80" align="right"><? echo fn_number_format($grand_wo_qnty,2); ?></th>
                        <th width="80" align="right"><? echo fn_number_format(0,2); ?></th>
                        <th width="80" align="right">&nbsp;<? //echo change_date_format($row['BOOKING_DATE']);?></th>
                        <th width="80" align="right"><? echo fn_number_format(0,2); ?></th>
                        <th width="80" align="right"><? echo fn_number_format($grand_issue_qnty,2); ?></th>
                        <th width="80" align="right">&nbsp;<? //echo change_date_format($row['LAST_ISSUE_DATE']); ?></th>
                        <th width="80" align="right">&nbsp;<? //echo fn_number_format($row['LAST_ISSUE_QNTY'],2); ?></th>
                        <th width="80" align="right"><? echo fn_number_format($grand_issue_balance,2); ?></th>
                        <th width="80" align="right"><? echo fn_number_format($grand_grey_used_qnty,2); ?></th>
                        <th width="80" align="right"><? echo fn_number_format($grand_receive_qnty,2);?></th>
                        <th width="80" align="right">&nbsp;<? ?></th>
                        <th width="80" align="right"><? echo fn_number_format($grand_grey_used_balance,2); ?></th>
                        <th width="80" align="right"><? echo fn_number_format($grand_sc_act_pl,2); ?></th>
                        <th width="80" align="right">&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
        </div>               

        <script type="text/javascript">
            /*function open_batch_details_popup(data)
            {
                var width = window.innerWidth;
                width = 500;        
                      
                var action = "batch_details_popup";
                emailwindow = dhtmlmodal.open('EmailBox', 'iframe', 'order_monitoring_report_with_tna_controller.php?data=' + data + '&action=' + action, 'Batch Details Popup', 'width='+width+'px,height=350px,center=1,resize=0,scrolling=0', '../../');
            }*/
        </script>
    </div>
    <?
}

if($action=="finish_popup_bk")//06/03/2022
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);
    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();
    //$costPerArr=$condition->getCostingPerArr();
    $fabric= new fabric($condition);
    //echo $fabric->getQuery();die;
    // $fabric_costing_arr=$fabric->getQtyArray_by_JobAndGmtscolor_knitAndwoven_greyAndfinish();
    $fabric_costing_arr=$fabric->getQtyArray_by_OrderGmtsColorFabricColorAndFabricSouce_greyAndfinish();
    // $fab_data_qty_body_arr=$fabric->getQtyArray_by_OrderFabriccostidFabriccolorAndDiaWidth_knitAndwoven_greyAndfinish();
    // echo "<pre>";print_r($fabric_costing_arr);echo "</pre>";

    $production_source = 1;
    $purchase_source = 2;

    $job_no = return_field_value("job_no_mst","wo_po_break_down","id in($poIds)","job_no_mst");

    $sqlOrder = "SELECT a.company_name as COMPANY_NAME, a.job_no as JOB_NO, a.style_ref_no as STYLE, b.grouping as INT_REF, d.color_number_id as COLOR_NUMBER_ID from wo_po_details_master a, wo_po_break_down b,  wo_po_color_size_breakdown d where a.id=b.job_id and b.id=d.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in ($poIds) group by a.company_name, a.job_no, a.style_ref_no,  b.grouping, d.color_number_id";

    $sqlOrderRes = sql_select($sqlOrder);
    foreach ($sqlOrderRes as $val) 
    {
        $job_color_arr[$val['JOB_NO']][$val['COLOR_NUMBER_ID']]['COLOR_NUMBER_ID'] = $val['COLOR_NUMBER_ID'];
        $job_color_arr[$val['JOB_NO']][$val['COLOR_NUMBER_ID']]['JOB_NO'] = $val['JOB_NO'];
        $int_ref .= $val['INT_REF'].",";
        $COMPANY_NAME = $val['COMPANY_NAME'];
    }

    // ====================================== budget data ===================================
    $sql = "SELECT a.JOB_NO,c.COLOR_NUMBER_ID,a.COLOR_SIZE_SENSITIVE,b.CONTRAST_COLOR_ID,a.FABRIC_SOURCE from wo_pre_cos_fab_co_avg_con_dtls c, wo_pre_cost_fabric_cost_dtls a LEFT JOIN wo_pre_cos_fab_co_color_dtls b ON a.job_no = b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  AND b.status_active = 1
       AND b.is_deleted = 0 where a.id=c.pre_cost_fabric_cost_dtls_id and c.status_active=1 and a.status_active=1 and a.is_deleted=0 and a.job_no='$job_no' and c.cons !=0 group by a.JOB_NO,c.COLOR_NUMBER_ID,a.COLOR_SIZE_SENSITIVE,b.CONTRAST_COLOR_ID,a.FABRIC_SOURCE";
    // echo $sql;die();

    //1=pcs,12=kg,23=mtr,27=yds   
    $sql_res = sql_select($sql);
    $job_color_arr = array();
    $contrust_qty_array = array();
    $chk_array = array();
    $fab_req_qty_array = array();
    foreach ($sql_res as $val) 
    {
        if($val['COLOR_SIZE_SENSITIVE']==3)
        {
            $color_id=$val['CONTRAST_COLOR_ID']."_1";
        }
        else
        {
            $color_id=$val['COLOR_NUMBER_ID'];
        }

        $job_color_arr[$val['JOB_NO']][$color_id]['COLOR_NUMBER_ID'] = $color_id;
        $job_color_arr[$val['JOB_NO']][$color_id]['JOB_NO'] = $val['JOB_NO'];
       /* if($val['COLOR_SIZE_SENSITIVE']!=3)
        {
            $job_color_arr[$val['JOB_NO']][$color_id]['fab_knit_grey']=array_sum($fabric_costing_arr['knit']['grey'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$production_source]);
            $job_color_arr[$val['JOB_NO']][$color_id]['fab_knit_finish']=array_sum($fabric_costing_arr['knit']['finish'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$production_source]);
            
            $job_color_arr[$val['JOB_NO']][$color_id]['fab_woven_grey']=array_sum($fabric_costing_arr['woven']['grey'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$production_source]);
            $job_color_arr[$val['JOB_NO']][$color_id]['fab_woven_finish']=array_sum($fabric_costing_arr['woven']['finish'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$production_source]);
        }*/

        $fab_req_qty_array[$val['JOB_NO']][$color_id][$val['FABRIC_SOURCE']]['fab_knit_finish'] += array_sum($fabric_costing_arr['knit']['finish'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['FABRIC_SOURCE']]);
        $fab_req_qty_array[$val['JOB_NO']][$color_id][$val['FABRIC_SOURCE']]['fab_knit_grey'] += array_sum($fabric_costing_arr['knit']['grey'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['FABRIC_SOURCE']]);


        /*$grey_fab_pur_req_qty = 0;
        $grey_fab_prod_req_qty = 0;
        $fin_fab_prod_req_qty = 0;
        $fin_fab_pur_req_qty = 0;       

        if($val['COLOR_SIZE_SENSITIVE']==3)
        {
            $grey_fab_prod_req_qty = array_sum($fabric_costing_arr['knit']['grey'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][1]);
            $grey_fab_pur_req_qty = array_sum($fabric_costing_arr['knit']['grey'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][2]);

            $fin_fab_prod_req_qty = array_sum($fabric_costing_arr['knit']['finish'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][1]);
            $fin_fab_pur_req_qty = array_sum($fabric_costing_arr['knit']['finish'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][2]);

            $contrust_qty_array[$val['JOB_NO']][$val['COLOR_NUMBER_ID']]['contrast_color_id'] = $val['CONTRAST_COLOR_ID'];
            $contrust_qty_array[$val['JOB_NO']][$val['COLOR_NUMBER_ID']]['grey_fab_prod_req_qty'] = $grey_fab_prod_req_qty;
            $contrust_qty_array[$val['JOB_NO']][$val['COLOR_NUMBER_ID']]['grey_fab_pur_req_qty'] = $grey_fab_pur_req_qty;
            $contrust_qty_array[$val['JOB_NO']][$val['COLOR_NUMBER_ID']]['fin_fab_prod_req_qty']  = $fin_fab_prod_req_qty;
            $contrust_qty_array[$val['JOB_NO']][$val['COLOR_NUMBER_ID']]['fin_fab_pur_req_qty']  = $fin_fab_pur_req_qty;
        }*/
    }
    // echo "<pre>";print_r($fab_req_qty_array);die();

    $gmt_color_library=array();//fabric_cost_dtls_id
    $gmt_color_data=sql_select("SELECT a.body_part_id,b.gmts_color_id, b.contrast_color_id  FROM  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b 
    WHERE a.id=b.pre_cost_fabric_cost_dtls_id  and  a.job_no='$job_no' and a.color_size_sensitive=3");
 
    foreach( $gmt_color_data as $gmt_color_row)
    {
        $gmt_color_library[$gmt_color_row[csf("gmts_color_id")]].= sizeof($gmt_color_library[$gmt_color_row[csf("gmts_color_id")]]) ? ",".$gmt_color_row[csf("contrast_color_id")] : $gmt_color_row[csf("contrast_color_id")];
    }
    // echo "<pre>";print_r($gmt_color_library);die();

    // ===================== get contrust color wise req qty ========================
    $contrust_color_qty_array = array();
    $contrust_color_array = array();
    $gmts_color_array = array();
    foreach ($contrust_qty_array as $jobNo => $job_data) 
    {
        foreach ($job_data as $gmt_color => $row) 
        {            
            // $gmt_color_ex = explode("_", $gmt_color);
            // $contrust_color_array[$gmt_color_ex[0]] .= $row['contrast_color_id'].",";
            $gmts_color_array[$gmt_color] = $gmt_color;
            $gmt_color_ex = array_unique(explode(",", $gmt_color_library[$gmt_color]));
            foreach ($gmt_color_ex as $key => $value) 
            {           
                $contrust_color_qty_array[$jobNo][$value]['grey_fab_prod_req_qty'] += $row['grey_fab_prod_req_qty'];                
                $contrust_color_qty_array[$jobNo][$value]['grey_fab_pur_req_qty'] += $row['grey_fab_pur_req_qty'];                
                $contrust_color_qty_array[$jobNo][$value]['fin_fab_prod_req_qty'] += $row['fin_fab_prod_req_qty'];
                $contrust_color_qty_array[$jobNo][$value]['fin_fab_pur_req_qty'] += $row['fin_fab_pur_req_qty'];
            }                  
            
        }        
    }
    // echo "<pre>";print_r($contrust_color_qty_array);die();


    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");

    $text_store_sql = sql_select("select company_name as COMPANY_NAME, distribute_qnty as DISTRIBUTE_QNTY from variable_settings_production where variable_list=56 and status_active=1 and company_name=$COMPANY_NAME");
    //echo "select company_name as COMPANY_NAME, distribute_qnty as DISTRIBUTE_QNTY from variable_settings_production where variable_list=56 and status_active=1 and company_name=$COMPANY_NAME";
    if(empty($text_store_sql))
    {
        echo "Select Textile Store in Library setup";
        die;
    }
    $text_cond_from_store_or    = $text_cond_from_store_and ="";
    $text_cond_store_id_or      = $text_cond_store_id_and   ="";
    foreach ($text_store_sql as $row) 
    {
        $textile_store_arr[$row['COMPANY_NAME']] =$row["DISTRIBUTE_QNTY"];

        $text_cond_from_store_or .= ' $val["FROM_STORE"] == '.$row["DISTRIBUTE_QNTY"]. ' ||';
        $text_cond_from_store_and .= ' $val["FROM_STORE"] != '.$row["DISTRIBUTE_QNTY"]. ' &&';

        $text_cond_store_id_or .= ' $val["STORE_ID"] == '.$row["DISTRIBUTE_QNTY"]. ' ||';
        $text_cond_store_id_and .= ' $val["STORE_ID"] != '.$row["DISTRIBUTE_QNTY"]. ' &&';

        $textile_store_id = $row["DISTRIBUTE_QNTY"];
    }
    $text_cond_from_store_or = chop($text_cond_from_store_or,'||'); $text_cond_from_store_and = chop($text_cond_from_store_and,'&&');
    $text_cond_store_id_or = chop($text_cond_store_id_or,'||'); $text_cond_store_id_and = chop($text_cond_store_id_and,'&&');

    $lib_store = return_library_array("select b.store_name, b.id from lib_store_location_category a, lib_store_location b where a.store_location_id=b.id and a.category_type=2 and b.company_id in (1,2) and b.status_active=1 and b.id in (166, 16, 14) group by b.store_name, b.id", "id", "store_name");

    //echo $text_cond_store_id_and;die;

    $short_sql = sql_select("select a.job_no as JOB_NO, a.fin_fab_qnty as FIN_FAB_QNTY, a.grey_fab_qnty as GREY_FAB_QNTY, a.fabric_color_id as COLOR_ID, b.fabric_source as FABRIC_SOURCE from wo_booking_dtls a, wo_booking_mst b where a.booking_no = b.booking_no and a.is_short=1 and a.booking_type=1 and a.po_break_down_id in ($poIds) and a.status_active =1 and a.is_deleted=0");
    foreach ($short_sql as $val) 
    {
        $color_short_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['SHORT_FINISH'] += $val['FIN_FAB_QNTY'];
        $color_short_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['SHORT_GREY'] += $val['GREY_FAB_QNTY'];
    }

    $grey_sql = sql_select("select d.job_no_mst as JOB_NO, a.quantity as QUANTITY, b.color_id as COLOR_ID, b.gsm as GSM, b.width as WIDTH, b.uom as UOM, b.febric_description_id as FEBRIC_DESCRIPTION_ID, b.body_part_id as BODY_PART_ID, c.body_part_type as BODY_PART_TYPE from order_wise_pro_details a, pro_grey_prod_entry_dtls b left join lib_body_part c on b.body_part_id = c.id, wo_po_break_down d where a.dtls_id=b.id and a.trans_id=b.trans_id and A.PO_BREAKDOWN_ID=d.id and a.entry_form in (2,22,58) and a.trans_id >0 and a.po_breakdown_id in ($poIds) and a.is_sales=0 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted=0");

    foreach ($grey_sql as $val) 
    {
       $color_wise[$val['JOB_NO']][$val['COLOR_ID']]['GREY_QTY'] += $val['QUANTITY'];
    }

    if($db_type==0) {
        $ext_cond = " and (a.extention_no=0 or a.extention_no='')";
    } else {
        $ext_cond = " and (a.extention_no=0 or a.extention_no is null)";
    }

    $batch_sql = sql_select("select d.job_no_mst as JOB_NO,a.color_id as COLOR_ID, b.batch_qnty as QUANTITY,c.gsm as GSM, c.dia_width as DIA_WIDTH, c.detarmination_id as DETARMINATION_ID, b.body_part_id as BODY_PART_ID, e.fabric_source as FABRIC_SOURCE from pro_batch_create_mst a, pro_batch_create_dtls b, product_details_master c, wo_po_break_down d, wo_booking_mst e where a.booking_no= e.booking_no and a.id=b.mst_id and b.prod_id=c.id and b.po_id=d.id $ext_cond and b.po_id in ($poIds) and b.is_sales =0 and e.fabric_source=1");

    foreach ($batch_sql as $val) 
    {
        $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['BATCH_QTY'] += $val['QUANTITY'];
        $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
        $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['JOB_NO'] = $val['JOB_NO'];
    }


    /*======================================================================================/
    /                                    finish fab transfer                                /
    /======================================================================================*/   
    
    // $finish_transfer_sql = sql_select("SELECT e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID, a.trans_type as TRANS_TYPE, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, f.from_store as FROM_STORE, f.to_store as TO_STORE from order_wise_pro_details a, inv_transaction b, inv_item_transfer_dtls f, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e where A.trans_id=b.id and a.dtls_id=f.id and B.pi_wo_batch_no= c.id and c.booking_no = d.booking_no and A.PO_BREAKDOWN_ID= e.id and a.entry_form in (14) and a.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0");

    $finish_transfer_sql = sql_select("SELECT e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID, a.trans_type as TRANS_TYPE, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, f.from_store as FROM_STORE, f.to_store as TO_STORE,g.transfer_criteria from order_wise_pro_details a, inv_transaction b, inv_item_transfer_dtls f, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e,inv_item_transfer_mst g where A.trans_id=b.id and a.dtls_id=f.id and B.pi_wo_batch_no= c.id and c.booking_no = d.booking_no and A.PO_BREAKDOWN_ID= e.id and a.entry_form in (14) and a.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and g.id=f.mst_id and g.transfer_criteria in(2,4) AND b.item_category = 2 ");// AND b.STORE_ID IN (8, 20, 32)
    
    // echo "SELECT e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID, a.trans_type as TRANS_TYPE, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, f.from_store as FROM_STORE, f.to_store as TO_STORE,g.transfer_criteria from order_wise_pro_details a, inv_transaction b, inv_item_transfer_dtls f, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e,inv_item_transfer_mst g where A.trans_id=b.id and a.dtls_id=f.id and B.pi_wo_batch_no= c.id and c.booking_no = d.booking_no and A.PO_BREAKDOWN_ID= e.id and a.entry_form in (14) and a.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and g.id=f.mst_id and g.transfer_criteria in(2,4) AND b.item_category = 2";die;

    foreach ($finish_transfer_sql as $val) 
    {
        if($trans_arr[$val['TRANS_ID']] == "")
        {            
            if($val['TRANSFER_CRITERIA']==4) // order to order
            {
                if($val['TRANS_TYPE']==5)
                {
                    if($val['FABRIC_SOURCE'] ==1)
                    {
                        //if($val['FROM_STORE'] == 16 || $val['FROM_STORE'] == 14)
                        //if($text_cond_from_store_or)
                        // if(eval("return $text_cond_from_store_or;"))
                        // {
                            //echo $text_cond_from_store_or;
                            //echo $val['FROM_STORE'];
                            $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANS_IN'] += $val['QUANTITY'];
                        // }
                    }
                    else
                    {
                        $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANS_IN'] += $val['QUANTITY'];
                    }
                }
                else
                {
                    if($val['FABRIC_SOURCE'] ==1)
                    {
                        //if($val['FROM_STORE'] != 16 && $val['FROM_STORE'] != 14)
                        //if($text_cond_from_store_and)   
                        // if(eval("return $text_cond_from_store_and;"))
                        // {
                            $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANS_OUT'] += $val['QUANTITY'];
                        // }
                    }
                    else
                    {
                        $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANS_OUT'] += $val['QUANTITY'];
                    }
                }
            }
            else // store to store
            {
                if($val['FROM_STORE'] != $val['TO_STORE'])
                {
                    if($val['TRANS_TYPE']==5)
                    {  
                        // if($val['FABRIC_SOURCE'] =="") { $val['FABRIC_SOURCE']=1;}                     
                        if($val['FABRIC_SOURCE'] ==1)
                        {
                            // if(eval("return $text_cond_from_store_or;"))
                            // {
                                //echo $text_cond_from_store_or;
                                //echo $val['FROM_STORE'];
                                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANSIN'] += $val['QUANTITY'];
                            // }
                        }
                        else
                        {
                            $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANSIN'] += $val['QUANTITY'];
                        }
                    }
                    else
                    {
                        if($val['FABRIC_SOURCE'] ==1)
                        {
                            //if($val['FROM_STORE'] != 16 && $val['FROM_STORE'] != 14)
                            //if($text_cond_from_store_and)   
                            // if(eval("return $text_cond_from_store_and;"))
                            // {
                                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANSOUT'] += $val['QUANTITY'];
                            // }
                        }
                        else
                        {
                            $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANSOUT'] += $val['QUANTITY'];
                        }
                    }
                }
            }
            
            $trans_arr[$val['TRANS_ID']] = $val['TRANS_ID'];

            $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
            $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['JOB_NO'] = $val['JOB_NO'];
        }
    }

    // echo "<pre>";print_r($color_wise);die;

    // ==================================== textile trans rcv =====================================
    $sql = "SELECT e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID, a.trans_type as TRANS_TYPE, b.cons_quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, f.from_store as FROM_STORE, f.to_store as TO_STORE,g.transfer_criteria from order_wise_pro_details a, inv_transaction b, inv_item_transfer_dtls f, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e,inv_item_transfer_mst g where A.trans_id=b.id and a.dtls_id=f.id and B.pi_wo_batch_no= c.id and c.booking_no = d.booking_no and A.PO_BREAKDOWN_ID= e.id and a.entry_form in (14) and a.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and g.id=f.mst_id and g.transfer_criteria in(2,4) AND b.item_category = 2 AND b.STORE_ID IN (16)  AND a.trans_type = 5 ";// AND b.STORE_ID IN (8, 20, 32)
    // echo $sql;
    $res = sql_select($sql);
    $trans_qty_array = array();
    foreach ($res as $val) 
    {
        if($val['FABRIC_SOURCE'] =="") { $val['FABRIC_SOURCE']=1;}  
        if($val['FABRIC_SOURCE'] ==1)
        {          
            $trans_qty_array[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']] += $val['QUANTITY'];
        }
        else
        {
            $trans_qty_array[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']] += $val['QUANTITY'];
        }
        $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
        $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['JOB_NO'] = $val['JOB_NO'];
    }
    // echo "<pre>";print_r($trans_qty_array);die();
    $finish_iss_rcvret_sql = sql_select("select e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, b.store_id as STORE_ID from order_wise_pro_details a, inv_finish_fabric_issue_dtls b, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e where a.dtls_id=b.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.id and a.entry_form in (18,46) and a.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0");

    foreach ($finish_iss_rcvret_sql as $val)
    {
        if($val['ENTRY_FORM']==18)
        {
            //if($val['FABRIC_SOURCE'] ==1 && ($val['STORE_ID']==16 || $val['STORE_ID']==14))
            //if($val['FABRIC_SOURCE'] ==1 &&  ($text_cond_store_id_or) )
            if($val['FABRIC_SOURCE'] ==1 && eval("return $text_cond_store_id_or;") )
            {
                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['ISSUE'] += $val['QUANTITY'];
            }
            else
            {
                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['ISSUE'] += $val['QUANTITY'];
            }
        }
        else if($val['ENTRY_FORM']==46)
        {
            $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['RECV_RETURN'] += $val['QUANTITY'];
        } 
        $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
        $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['JOB_NO'] = $val['JOB_NO'];
    }

    $finish_rcv_issuereturn_sql = sql_select("SELECT e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID, a.returnable_qnty as REJECT_QTY, b.grey_used_qty as GREY_USED_QTY, b.id as DTLS_ID, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, f.store_id as TRANS_STORE, g.store_id as STORE_ID from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join inv_transaction f on b.trans_id=f.id, inv_receive_master g, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e where a.dtls_id = b.id and b.mst_id = g.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.id and a.entry_form in (7,37) and g.entry_form in (7,37) and a.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0");

    foreach ($finish_rcv_issuereturn_sql as $val) 
    {
        if($val['ENTRY_FORM']==7)
        {
            if($dtls_arr[$val['DTLS_ID']] == "")
            {
                $dtls_arr[$val['DTLS_ID']] = $val['DTLS_ID'];
                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['GREY_USED'] += $val['GREY_USED_QTY'];
            }
            $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
            $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['JOB_NO'] = $val['JOB_NO'];
        }
        if($val['TRANS_ID'])
        {
            if($val['FABRIC_SOURCE'] =="") { $val['FABRIC_SOURCE']=1;}
            if($val['FABRIC_SOURCE'] ==1)
            {
                //if($val['STORE_ID'] == 16 || $val['STORE_ID'] == 14)    
                //if($text_cond_store_id_or)
                if(eval("return $text_cond_store_id_or;"))
                {
                    //fixed store for textile receive
                    $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['FINISH_QTY'] += $val['QUANTITY'];
                    $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['REJECT_QTY'] += $val['REJECT_QTY'];
                }
            }
            else
            {
                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['FINISH_QTY'] += $val['QUANTITY'];
                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['REJECT_QTY'] += $val['REJECT_QTY'];
            }
            $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
            $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['JOB_NO'] = $val['JOB_NO'];
        }
    }

    $finish_issue_return = sql_select("SELECT e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID,  a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, f.store_id as STORE_ID FROM order_wise_pro_details a, inv_transaction f, inv_receive_master g, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e WHERE a.trans_id = f.id and f.mst_id = g.id and f.pi_wo_batch_no= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.id and a.entry_form =52 and g.entry_form =52 and a.po_breakdown_id in ($poIds) and a.status_active=1 and a.is_deleted=0 and f.status_active=1 and f.is_deleted=0");
    foreach ($finish_issue_return as $val) 
    {
        if($val['FABRIC_SOURCE'] ==1)
        {
            //if($val['STORE_ID'] != 16 && $val['STORE_ID'] != 14)
            //if( $text_cond_store_id_and)
            if(eval("return $text_cond_store_id_and;"))
            {
                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['ISSUE_RETURN'] += $val['QUANTITY'];
                $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
                $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['JOB_NO'] = $val['JOB_NO'];
            }
        }
        else
        {
            $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['ISSUE_RETURN'] += $val['QUANTITY'];
            $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
            $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['JOB_NO'] = $val['JOB_NO'];
        }
    }

    $dyeing_sql = sql_select("select e.job_no_mst as JOB_NO,a.id as ID, b.id as DYEING_DTLS_ID,c.id as BATCH_DTLS_ID, b.batch_qty as BATCH_QTY, d.color_id as COLOR_ID, f.fabric_source as FABRIC_SOURCE from  pro_fab_subprocess a, pro_fab_subprocess_dtls b,pro_batch_create_dtls c, pro_batch_create_mst d, wo_po_break_down e, wo_booking_mst f where a.id = b.mst_id and a.batch_id=c.mst_id and c.mst_id=d.id and c.po_id=e.id and c.po_id in ($poIds) and d.booking_no=f.booking_no and f.fabric_source=1 and a.entry_form=35 and b.entry_page=35 and a.load_unload_id=2 and a.result=1");
    
    foreach ($dyeing_sql as $val) 
    {
        if($dupliChk[$val['DYEING_DTLS_ID']] =="")
        {
            $dupliChk[$val['DYEING_DTLS_ID']] = $val['DYEING_DTLS_ID'];
            $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['DYE_QTY'] += $val['BATCH_QTY'];
            $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
            $job_color_arr[$val['JOB_NO']][$val['COLOR_ID']]['JOB_NO'] = $val['JOB_NO'];
        }
    }
    
    $acting_width = $screen_size-50;
    $three_percent = $acting_width*0.03;
    $four_percent = $acting_width*0.04;
    $five_percent = $acting_width*0.05;
    $six_percent = $acting_width*0.06;

    
    ?>    
    <div id="data_panel" align="center" style="width:<? echo $acting_width;?>px">
        <script>
            function new_window()
            {
                document.getElementById('scroll_body').style.overflow="auto";
                document.getElementById('scroll_body').style.maxHeight="none";
                document.getElementById('scroll_body_2nd').style.overflow="auto";
                document.getElementById('scroll_body_2nd').style.maxHeight="none";
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
                document.getElementById('scroll_body').style.overflowY="scroll";
                document.getElementById('scroll_body').style.maxHeight="240px";
                document.getElementById('scroll_body_2nd').style.overflowY="scroll";
                document.getElementById('scroll_body_2nd').style.maxHeight="240px";
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: <? echo $acting_width;?>px" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="<? echo $acting_width?>">
                <caption style="font-size:20px;"><b>Finish Fabric Status</b></caption>
                <tbody>
                    <tr>
                        <td colspan="26" width="<? echo $acting_width;?>"><b>Style Name:<? echo $sqlOrderRes[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref:<? echo implode(", ",array_unique(explode(",",chop($int_ref,","))));?></b></td>
                    </tr>
                </tbody>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width?>">
                <thead>
                    <tr>
                        <th align="left" colspan="14">&nbsp;</th>
                        <th colspan="7">Textile Store (<? echo $lib_store[$textile_store_arr[$COMPANY_NAME]]; ?>)</th>
                        <th colspan="6">Garments Store</th>
                    </tr>
                    <tr>
                        <th width="<? echo $five_percent;?>">Color</th>
                        <th width="<? echo $five_percent;?>">Finish Req</th>
                        <th width="<? echo $three_percent;?>">Ex Req</th>
                        <th width="<? echo $three_percent;?>">Gray Req</th>
                        <th width="<? echo $three_percent;?>">PL %</th>
                        <th width="<? echo $three_percent;?>">Gray Rcv</th>

                        <th width="<? echo $three_percent;?>">Gray Bal</th>
                        <th width="<? echo $three_percent;?>">Batch</th>
                        <th width="<? echo $three_percent;?>">Batch Bal</th>
                        <th width="<? echo $three_percent;?>">Dyeing</th>
                        <th width="<? echo $three_percent;?>">Dyeing Bal</th>
                        <th width="<? echo $three_percent;?>">Finish</th>
                        <th width="<? echo $three_percent;?>">Fin Bal</th>
                        <th width="<? echo $three_percent;?>">PL%</th>

                        <th width="<? echo $three_percent;?>">Ok Rcvd</th>
                        <th width="<? echo $three_percent;?>">Rej Rcvd</th>
                        <th width="<? echo $three_percent;?>">Rcv bal</th>
                        <th width="<? echo $three_percent;?>">Ok Stock</th>
                        <th width="<? echo $three_percent;?>">Rej Stock</th>
                        <th width="<? echo $three_percent;?>">FF Del</th>
                        <th width="<? echo $three_percent;?>">Del Bal</th>

                        <th width="<? echo $three_percent;?>">FF Rcvd</th>
                        <th width="<? echo $three_percent;?>">Trans In</th>
                        <th width="<? echo $three_percent;?>">Trans Out</th>
                        <th width="<? echo $three_percent;?>">FF Issue</th>
                        <th width="<? echo $three_percent;?>">Stock</th>
                        <th width="<? echo $three_percent;?>">Issue Bal</th>
                    </tr>
                </thead>
            </table>
            <div style="width:<? echo $acting_width + 18;?>px; max-height:240px;overflow-y:scroll;" id="scroll_body">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width;?>">
                    <tbody>
                        <?
                        $i=0;
                        foreach ($job_color_arr as $job_no=>$job_data) 
                        {
                            foreach ($job_data as $colorId => $row) 
                            {
                                $colorEx = explode("_", $colorId);
                                $color_id = $colorEx[0];
                                $is_contrust_color_id = $colorEx[1];
                                $fab_knit_grey=$fab_req_qty_array[$job_no][$colorId][1]['fab_knit_grey'];
                                $fab_knit_finish=$fab_req_qty_array[$job_no][$colorId][1]['fab_knit_finish'];
                                
                                $fab_woven_grey=$row['fab_woven_grey'];
                                $fab_woven_finish=$row['fab_woven_finish'];

                                $grey_required =  $fab_knit_grey+$fab_woven_grey;
                                $finish_required =  $fab_knit_finish+$fab_woven_finish;

                                $grey_requ_with_addi = $grey_required + $color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_GREY'];

                                if($grey_requ_with_addi >0){
                                    $pl_percentage = ($grey_requ_with_addi - ($finish_required +$color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_FINISH']))/$grey_requ_with_addi*100;
                                }else{
                                    $pl_percentage =0;
                                }
                                

                                $grey_balance = $grey_requ_with_addi- $color_wise[$row['JOB_NO']][$color_id]['GREY_QTY'];

                                $dyeing_balance = $grey_requ_with_addi- $color_wise[$row['JOB_NO']][$color_id][$production_source]['DYE_QTY'];
                                $grey_used_balance = $grey_requ_with_addi- $color_wise[$row['JOB_NO']][$color_id][$production_source]['GREY_USED'];

                                if($color_wise[$row['JOB_NO']][$color_id][$production_source]['GREY_USED'] > 0)
                                {
                                    $pl_percentage_second = ($color_wise[$row['JOB_NO']][$color_id][$production_source]['GREY_USED'] - ($color_wise[$row['JOB_NO']][$color_id][$production_source]['FINISH_QTY'] +$color_wise[$row['JOB_NO']][$color_id][$production_source]['REJECT_QTY']))/$color_wise[$row['JOB_NO']][$color_id][$production_source]['GREY_USED']*100;
                                }
                                else
                                {
                                    $pl_percentage_second =0;
                                }
                                

                                $finish_rcv_balance = ($finish_required +$color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_FINISH']) - $color_wise[$row['JOB_NO']][$color_id][$production_source]['FINISH_QTY'];

                                $text_okay_stock_bal = $color_wise[$row['JOB_NO']][$color_id][$production_source]['FINISH_QTY'] - $color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANSIN'];

                                $text_del_bal = ($finish_required + $color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_FINISH'])- $color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANSIN'];

                                $issue_balance= ($finish_required + $color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_FINISH'])- $color_wise[$row['JOB_NO']][$color_id][$production_source]['ISSUE'];
                                // echo "(".$finish_required ."+". $color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_FINISH'].")- ".$color_wise[$row['JOB_NO']][$color_id][$production_source]['ISSUE']."<br>";

                                $ff_received_garments = $color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANSIN'] + $color_wise[$row['JOB_NO']][$color_id][$production_source]['ISSUE_RETURN'];
                                // $ff_issued_garments = $color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANS_OUT'] + $color_wise[$row['JOB_NO']][$color_id][$production_source]['ISSUE'];
                                $ff_issued_garments = $color_wise[$row['JOB_NO']][$color_id][$production_source]['ISSUE'];

                                $batch_balance = $color_wise[$row['JOB_NO']][$color_id]['GREY_QTY'] - $color_wise[$row['JOB_NO']][$color_id][$production_source]['BATCH_QTY'];

                                $trans_in = $color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANS_IN'];
                                $trans_out = $color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANS_OUT'];

                                $stock = ($ff_received_garments+$trans_in) - ($ff_issued_garments+$trans_out);

                                $trans_qty_in_textile = $trans_qty_array[$row['JOB_NO']][$color_id][$production_source];

                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                // echo $row['JOB_NO']."=".$row['COLOR_NUMBER_ID']."*".$production_source."<br>";
                                ?>                      
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                    <td width="<? echo $five_percent;?>"><a href="##" onclick="color_popup('<? echo $color_id."*".$poIds."*".$job_no."*".$is_contrust_color_id;?>','finish_color_popup')"><? echo $lib_color[$color_id];?></a></td>
                                    <td width="<? echo $five_percent;?>" align="right"><? echo fn_number_format($finish_required,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_FINISH'],0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($grey_requ_with_addi,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($pl_percentage,2); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($color_wise[$row['JOB_NO']][$color_id]['GREY_QTY'],0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($grey_balance,0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($color_wise[$row['JOB_NO']][$color_id][$production_source]['BATCH_QTY'],0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($batch_balance,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($color_wise[$row['JOB_NO']][$color_id][$production_source]['DYE_QTY'],0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($dyeing_balance,0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($color_wise[$row['JOB_NO']][$color_id][$production_source]['GREY_USED'],0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($grey_used_balance,0); ;?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($pl_percentage_second,2);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format(($color_wise[$row['JOB_NO']][$color_id][$production_source]['FINISH_QTY']+$trans_qty_in_textile),0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($color_wise[$row['JOB_NO']][$color_id][$production_source]['REJECT_QTY'],0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($finish_rcv_balance,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($text_okay_stock_bal,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($color_wise[$row['JOB_NO']][$color_id][$production_source]['REJECT_QTY'],0);?></td>

                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANSIN'],0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($text_del_bal,0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($ff_received_garments,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($trans_in,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($trans_out,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($ff_issued_garments,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($stock,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($issue_balance,0); ?></td>
                                </tr>
                                <?
                                $tot_finish_required += $finish_required;
                                $tot_short_finish += $color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_FINISH'];
                                $tot_grey_required +=$grey_requ_with_addi;
                                $tot_grey_qty += $color_wise[$row['JOB_NO']][$color_id]['GREY_QTY'];
                                $tot_grey_balance += $grey_balance;
                                $tot_batch_qty += $color_wise[$row['JOB_NO']][$color_id][$production_source]['BATCH_QTY'];
                                $tot_batch_balance += $batch_balance;
                                $tot_dye_qty += $color_wise[$row['JOB_NO']][$color_id][$production_source]['DYE_QTY'];
                                $tot_dyeing_balance += $dyeing_balance;
                                $tot_grey_used += $color_wise[$row['JOB_NO']][$color_id][$production_source]['GREY_USED'];
                                $tot_grey_used_balance += $grey_used_balance;
                                $tot_finish_rcv += $color_wise[$row['JOB_NO']][$color_id][$production_source]['FINISH_QTY']+$trans_qty_in_textile;
                                $tot_reject_qty += $color_wise[$row['JOB_NO']][$color_id][$production_source]['REJECT_QTY'];
                                $tot_ff_del += $color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANSIN'];
                                $tot_finish_rcv_balance +=$finish_rcv_balance;
                                $tot_text_okay_stock_bal += $text_okay_stock_bal;
                                $finish_rcv_balance;
                                $tot_text_del_bal += $text_del_bal;
                                $tot_finish_trans_in += $ff_received_garments;
                                $tot_finish_issue += $ff_issued_garments;
                                $tot_stock += $stock;
                                $tot_issue_balance += $issue_balance;
                                $tot_trans_in += $trans_in;
                                $tot_trans_out += $trans_out;
                                $i++;      
                            }
                        }

                        if($tot_grey_required >0 ) 
                        {
                            $tot_pl_percentage = ($tot_grey_required - ($tot_finish_required +$tot_short_finish))/$tot_grey_required*100;
                        }else{
                            $tot_pl_percentage =0;
                        }

                        if($tot_grey_used>0){
                            $tot_pl_percentage_second = ($tot_grey_used - ($tot_finish_rcv +$tot_reject_qty))/$tot_grey_used*100;
                        }else{
                            $tot_pl_percentage_second =0;
                        }
                        
                        ?>
                    </tbody>
                </table>
            </div>
             <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width?>">
                <tfoot>
                    <tr>
                        <th width="<? echo $five_percent;?>">&nbsp;</th>
                        <th width="<? echo $five_percent;?>"  align="right"><? echo fn_number_format($tot_finish_required,0); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_short_finish,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_grey_required,0); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_pl_percentage,2); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_grey_qty,0);?></th>

                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_grey_balance); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_batch_qty,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_batch_balance,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_dye_qty,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_dyeing_balance,0); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_grey_used,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_grey_used_balance,0); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_pl_percentage_second,2); ?></th>

                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_finish_rcv,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_reject_qty,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_finish_rcv_balance,0); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_text_okay_stock_bal,0); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_reject_qty,0);?></th>

                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_ff_del,0);?></th>

                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_text_del_bal,0); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_finish_trans_in,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_trans_in,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_trans_out,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_finish_issue,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_stock,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_issue_balance,0) ?></th>
                    </tr>
                </tfoot>
            </table>
        </div> 
        <br>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width*0.4 ?>">
                <thead>
                    <tr>
                        <th>Style name</th>
                        <th colspan="2"></th>
                        <th colspan="6">Garments Store</th>
                    </tr>

                    <tr>
                        <th width="<? echo $five_percent;?>">Color</th>
                        <th width="<? echo $five_percent;?>">Finish Req</th>
                        <th width="<? echo $four_percent;?>">Ex Req</th>

                        <th width="<? echo $four_percent;?>">FF Rcvd</th>
                        <th width="<? echo $four_percent;?>">Trans In</th>
                        <th width="<? echo $four_percent;?>">Trans Out</th>
                        <th width="<? echo $four_percent;?>">FF Issue</th>
                        <th width="<? echo $four_percent;?>">Stock</th>
                        <th width="<? echo $four_percent;?>">Issue Bal</th>
                    </tr>
                </thead>
            </table>
            <div style="width:<? echo $acting_width*0.4 + 18;?>px; max-height:240px;overflow-y:scroll;" id="scroll_body_2nd">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width*0.4;?>">
                    <tbody>
                        <?
                        $tot_finish_required=$tot_short_finish=$tot_finish_recieve=$tot_finish_issue=$tot_stock=$tot_issue_balance=$tot_trans_in=$tot_trans_out=0;
                        foreach ($job_color_arr as $job_no=>$job_data) 
                        {
                            foreach ($job_data as $colorId => $row) 
                            {
                                $colorEx = explode("_", $colorId);
                                $color_id = $colorEx[0];
                                $is_contrust_color_id = $colorEx[1];
                               
                                $fab_knit_grey=$fab_req_qty_array[$job_no][$colorId][2]['fab_knit_grey'];
                                $fab_knit_finish=$fab_req_qty_array[$job_no][$colorId][2]['fab_knit_finish'];
                                
                                $fab_woven_grey=$row['fab_woven_grey'];
                                $fab_woven_finish=$row['fab_woven_finish'];

                                $grey_required =  $fab_knit_grey+$fab_woven_grey;
                                $finish_required =  $fab_knit_finish+$fab_woven_finish;

                                $ff_received_garments = $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['FINISH_QTY'] + $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['TRANS_IN'] + $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['ISSUE_RETURN'];
                                $ff_issued_garments = $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['TRANS_OUT'] + $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['ISSUE'] + $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['RECV_RETURN'] ;

                                $issue_balance = $finish_required + $color_short_wise[$row['JOB_NO']][$color_id][$purchase_source]['SHORT_FINISH']-$ff_issued_garments;
                                $stock = $ff_received_garments - $ff_issued_garments;
                                $trans_in = $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['TRANS_IN'];
                                $trans_out = $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['TRANS_OUT'];
                                
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                    <td width="<? echo $five_percent;?>"><a href="##" onclick="color_popup_purchase('<? echo $color_id."*".$poIds."*".$job_no."*".$is_contrust_color_id;?>')"><? echo $lib_color[$color_id];?></a></td>
                                    <td width="<? echo $five_percent;?>" align="right"><? echo fn_number_format($finish_required,0);?></td>
                                    <td width="<? echo $four_percent;?>" align="right"><? echo fn_number_format($color_short_wise[$row['JOB_NO']][$color_id][$purchase_source]['SHORT_FINISH'],0);?></td>

                                    <td width="<? echo $four_percent;?>" align="right"><? echo fn_number_format($ff_received_garments,0);?></td>
                                    <td width="<? echo $four_percent;?>" align="right"><? echo fn_number_format($trans_in,0);?></td>
                                    <td width="<? echo $four_percent;?>" align="right"><? echo fn_number_format($trans_out,0);?></td>
                                    <td width="<? echo $four_percent;?>" align="right"><? echo fn_number_format($ff_issued_garments,0);?></td>
                                    <td width="<? echo $four_percent;?>" align="right"><? echo fn_number_format($stock,0);?></td>
                                    <td width="<? echo $four_percent;?>" align="right"><? echo fn_number_format($issue_balance,0); ?></td>
                                </tr>
                                <?
                                $i++;
                                $tot_finish_required += $finish_required;
                                $tot_short_finish += $color_short_wise[$row['JOB_NO']][$color_id][$purchase_source]['SHORT_FINISH'];
                                $tot_finish_recieve += $ff_received_garments;
                                $tot_finish_issue +=$ff_issued_garments;
                                $tot_stock += $stock;
                                $tot_issue_balance +=$issue_balance;
                                $tot_trans_in +=$trans_in;
                                $tot_trans_out +=$trans_out;
                            }
                        }
                        ?>
                    </tbody>        
                </table>
            </div>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width*0.4?>">
                <tfoot>
                    <tr>
                        <th width="<? echo $five_percent;?>">&nbsp;</th>
                        <th width="<? echo $five_percent;?>"  align="right"><? echo fn_number_format($tot_finish_required,0); ?></th>
                        <th width="<? echo $four_percent;?>"  align="right"><? echo fn_number_format($tot_short_finish,0);?></th>
                        <th width="<? echo $four_percent;?>"  align="right"><? echo fn_number_format($tot_finish_recieve,0);?></th>
                        <th width="<? echo $four_percent;?>"  align="right"><? echo fn_number_format($tot_trans_in,0);?></th>
                        <th width="<? echo $four_percent;?>"  align="right"><? echo fn_number_format($tot_trans_out,0);?></th>
                        <th width="<? echo $four_percent;?>"  align="right"><? echo fn_number_format($tot_finish_issue,0);?></th>
                        <th width="<? echo $four_percent;?>"  align="right"><? echo fn_number_format($tot_stock,0);?></th>
                        <th width="<? echo $four_percent;?>"  align="right"><? echo fn_number_format($tot_issue_balance,0) ?></th>
                    </tr>
                </tfoot>
            </table>

        <script type="text/javascript">
            function color_popup(data)
            {
                var width = window.innerWidth;
                var screen_size = width-20;  
                var COMPANY_NAME = '<? echo $COMPANY_NAME;?>'      

                var action = "finish_color_popup";
                emailwindow = dhtmlmodal.open('EmailBox', 'iframe', 'order_monitoring_report_with_tna_controller.php?data=' + data + '&action=' + action + '&screen_size='+screen_size+'&COMPANY_NAME='+COMPANY_NAME, 'Color Details', 'width='+width+'px,height=350px,center=1,resize=0,scrolling=0', '../../../');
            }
            function color_popup_purchase(data)
            {
                var width = window.innerWidth;
                var screen_size = width-20;        

                var action = "finish_color_popup_purchase";
                emailwindow = dhtmlmodal.open('EmailBox', 'iframe', 'order_monitoring_report_with_tna_controller.php?data=' + data + '&action=' + action + '&screen_size='+screen_size, 'Color Details', 'width='+width+'px,height=350px,center=1,resize=0,scrolling=0', '../../../');
            }
        </script>
    </div>
    <?
}

if($action=="finish_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);
    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();
    //$costPerArr=$condition->getCostingPerArr();
    $fabric= new fabric($condition);
    //echo $fabric->getQuery();die;
    // $fabric_costing_arr=$fabric->getQtyArray_by_JobAndGmtscolor_knitAndwoven_greyAndfinish();
    $fabric_costing_arr=$fabric->getQtyArray_by_OrderGmtsColorFabricColorAndFabricSouce_greyAndfinish();
    // if($_SESSION['logic_erp']['user_id'] == 1)
    // {
    //     //echo $fabric->getQuery();
    //     //echo "<pre>";print_r($fabric_costing_arr[knit][finish]);echo "</pre>";
    // }
    // $fab_data_qty_body_arr=$fabric->getQtyArray_by_OrderFabriccostidFabriccolorAndDiaWidth_knitAndwoven_greyAndfinish();
    // echo "<pre>";print_r($fabric_costing_arr[knit][finish][16179]);echo "</pre>";

    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");

    $production_source = 1;
    $purchase_source = 2;

    $job_no = return_field_value("job_no_mst","wo_po_break_down","id in($poIds)","job_no_mst");

    $sqlOrder = "SELECT a.company_name as COMPANY_NAME, a.job_no as JOB_NO, a.style_ref_no as STYLE, b.grouping as INT_REF, d.color_number_id as COLOR_NUMBER_ID from wo_po_details_master a, wo_po_break_down b,  wo_po_color_size_breakdown d where a.id=b.job_id and b.id=d.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in ($poIds) group by a.company_name, a.job_no, a.style_ref_no,  b.grouping, d.color_number_id";

    $sqlOrderRes = sql_select($sqlOrder);
    foreach ($sqlOrderRes as $val) 
    {
        $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_NUMBER_ID']]]['COLOR_NUMBER_ID'] = $val['COLOR_NUMBER_ID'];
        $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_NUMBER_ID']]]['JOB_NO'] = $val['JOB_NO'];
        $int_ref .= $val['INT_REF'].",";
        $COMPANY_NAME = $val['COMPANY_NAME'];
    }

    // ====================================== budget data ===================================
    $sql = "SELECT a.JOB_NO,c.COLOR_NUMBER_ID,a.COLOR_SIZE_SENSITIVE,b.CONTRAST_COLOR_ID,a.FABRIC_SOURCE from wo_pre_cos_fab_co_avg_con_dtls c, wo_pre_cost_fabric_cost_dtls a LEFT JOIN wo_pre_cos_fab_co_color_dtls b ON a.job_no = b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  AND b.status_active = 1
       AND b.is_deleted = 0 where a.id=c.pre_cost_fabric_cost_dtls_id and c.status_active=1 and a.status_active=1 and a.is_deleted=0 and a.job_no='$job_no' and c.cons !=0 group by a.JOB_NO,c.COLOR_NUMBER_ID,a.COLOR_SIZE_SENSITIVE,b.CONTRAST_COLOR_ID,a.FABRIC_SOURCE";
   
    // if($_SESSION['logic_erp']['user_id'] == 1)
    // {
    //      //echo $sql;//die();
    // }

    //1=pcs,12=kg,23=mtr,27=yds   
    $sql_res = sql_select($sql);
    $job_color_arr = array();
    $contrust_qty_array = array();
    $contrust_color_id_array = array();
    $chk_array = array();
    $fab_req_qty_array = array();
    $color_in_both_array = array();
    $job_color_arr_const = array();
    foreach ($sql_res as $val) 
    {
        $color_id = "";
        $color_id2 = "";
        if($val['COLOR_SIZE_SENSITIVE']==3)
        {
            $color_id=$lib_color[$val['CONTRAST_COLOR_ID']];
            $color_id2=$val['CONTRAST_COLOR_ID']."_1";
            $contrust_color_id_array[$val['CONTRAST_COLOR_ID']] = $val['CONTRAST_COLOR_ID'];
        }
        else
        {
            $color_id=$lib_color[$val['COLOR_NUMBER_ID']];
            $color_id2=$val['COLOR_NUMBER_ID'];
            if(!empty($contrust_color_id_array[$val['COLOR_NUMBER_ID']]))
            {
                $color_in_both_array[$val['COLOR_NUMBER_ID']] = $val['COLOR_NUMBER_ID'];
                $job_color_arr[$val['JOB_NO']][$color_id]['COLOR_NUMBER_ID'] = $val['COLOR_NUMBER_ID'];
                $job_color_arr_const[$val['JOB_NO']][$color_id]['COLOR_NUMBER_ID'][$val['COLOR_NUMBER_ID']] = $val['COLOR_NUMBER_ID'];

            }
        }

        $job_color_arr[$val['JOB_NO']][$color_id]['COLOR_NUMBER_ID'] = $color_id2;
        $job_color_arr_const[$val['JOB_NO']][$color_id]['COLOR_NUMBER_ID'][$color_id2] = $color_id2;
        $job_color_arr[$val['JOB_NO']][$color_id]['JOB_NO'] = $val['JOB_NO'];

        // echo $color_id2."=".$val['COLOR_SIZE_SENSITIVE']."<br>";
       /* if($val['COLOR_SIZE_SENSITIVE']!=3)
        {
            $job_color_arr[$val['JOB_NO']][$color_id]['fab_knit_grey']=array_sum($fabric_costing_arr['knit']['grey'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$production_source]);
            $job_color_arr[$val['JOB_NO']][$color_id]['fab_knit_finish']=array_sum($fabric_costing_arr['knit']['finish'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$production_source]);
            
            $job_color_arr[$val['JOB_NO']][$color_id]['fab_woven_grey']=array_sum($fabric_costing_arr['woven']['grey'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$production_source]);
            $job_color_arr[$val['JOB_NO']][$color_id]['fab_woven_finish']=array_sum($fabric_costing_arr['woven']['finish'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$production_source]);
        }*/
        
        //  if($_SESSION['logic_erp']['user_id'] == 1)
        // {
        //     //echo "<pre>".$color_id2."=>".$val['COLOR_NUMBER_ID']."__".$val['CONTRAST_COLOR_ID']."=".array_sum($fabric_costing_arr['knit']['finish'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['FABRIC_SOURCE']])."<pre>";
        // }
    

        if($_SESSION['logic_erp']['user_id'] == 1)
        {
            //echo $fabric->getQuery();
            // echo "<pre>";
            // echo $color_id2."=>".$val['COLOR_NUMBER_ID']."__".$val['CONTRAST_COLOR_ID']."=".(array_sum($fabric_costing_arr['knit']['grey'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['FABRIC_SOURCE']]));
            // echo "</pre>";
        }
        
        $fab_req_qty_array[$val['JOB_NO']][$color_id2][$val['FABRIC_SOURCE']]['fab_knit_finish'] += array_sum($fabric_costing_arr['knit']['finish'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['FABRIC_SOURCE']]);
        $fab_req_qty_array[$val['JOB_NO']][$color_id2][$val['FABRIC_SOURCE']]['fab_knit_grey'] += array_sum($fabric_costing_arr['knit']['grey'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['FABRIC_SOURCE']]);

        // $tot += array_sum($fabric_costing_arr['knit']['finish'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['FABRIC_SOURCE']]);

        // echo $poIds."==".$val['COLOR_NUMBER_ID']."==".$val['CONTRAST_COLOR_ID']."==".$val['FABRIC_SOURCE']."<br>";


        /*$grey_fab_pur_req_qty = 0;
        $grey_fab_prod_req_qty = 0;
        $fin_fab_prod_req_qty = 0;
        $fin_fab_pur_req_qty = 0;       

        if($val['COLOR_SIZE_SENSITIVE']==3)
        {
            $grey_fab_prod_req_qty = array_sum($fabric_costing_arr['knit']['grey'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][1]);
            $grey_fab_pur_req_qty = array_sum($fabric_costing_arr['knit']['grey'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][2]);

            $fin_fab_prod_req_qty = array_sum($fabric_costing_arr['knit']['finish'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][1]);
            $fin_fab_pur_req_qty = array_sum($fabric_costing_arr['knit']['finish'][$poIds][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][2]);

            $contrust_qty_array[$val['JOB_NO']][$val['COLOR_NUMBER_ID']]['contrast_color_id'] = $val['CONTRAST_COLOR_ID'];
            $contrust_qty_array[$val['JOB_NO']][$val['COLOR_NUMBER_ID']]['grey_fab_prod_req_qty'] = $grey_fab_prod_req_qty;
            $contrust_qty_array[$val['JOB_NO']][$val['COLOR_NUMBER_ID']]['grey_fab_pur_req_qty'] = $grey_fab_pur_req_qty;
            $contrust_qty_array[$val['JOB_NO']][$val['COLOR_NUMBER_ID']]['fin_fab_prod_req_qty']  = $fin_fab_prod_req_qty;
            $contrust_qty_array[$val['JOB_NO']][$val['COLOR_NUMBER_ID']]['fin_fab_pur_req_qty']  = $fin_fab_pur_req_qty;
        }*/
        $width_add=strlen($color_id);
    }

    // echo "<pre>";print_r($fab_req_qty_array);die();
    //  echo $tot;die;

    $gmt_color_library=array();//fabric_cost_dtls_id
    $gmt_color_data=sql_select("SELECT a.body_part_id,b.gmts_color_id, b.contrast_color_id  FROM  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b 
    WHERE a.id=b.pre_cost_fabric_cost_dtls_id  and  a.job_no='$job_no' and a.color_size_sensitive=3");
 
    foreach( $gmt_color_data as $gmt_color_row)
    {
        $gmt_color_library[$gmt_color_row[csf("gmts_color_id")]].= sizeof($gmt_color_library[$gmt_color_row[csf("gmts_color_id")]]) ? ",".$gmt_color_row[csf("contrast_color_id")] : $gmt_color_row[csf("contrast_color_id")];
    }
    // echo "<pre>";print_r($gmt_color_library);die();

    // ===================== get contrust color wise req qty ========================
    $contrust_color_qty_array = array();
    $contrust_color_array = array();
    $gmts_color_array = array();
    foreach ($contrust_qty_array as $jobNo => $job_data) 
    {
        foreach ($job_data as $gmt_color => $row) 
        {            
            // $gmt_color_ex = explode("_", $gmt_color);
            // $contrust_color_array[$gmt_color_ex[0]] .= $row['contrast_color_id'].",";
            $gmts_color_array[$gmt_color] = $gmt_color;
            $gmt_color_ex = array_unique(explode(",", $gmt_color_library[$gmt_color]));
            foreach ($gmt_color_ex as $key => $value) 
            {           
                $contrust_color_qty_array[$jobNo][$value]['grey_fab_prod_req_qty'] += $row['grey_fab_prod_req_qty'];                
                $contrust_color_qty_array[$jobNo][$value]['grey_fab_pur_req_qty'] += $row['grey_fab_pur_req_qty'];                
                $contrust_color_qty_array[$jobNo][$value]['fin_fab_prod_req_qty'] += $row['fin_fab_prod_req_qty'];
                $contrust_color_qty_array[$jobNo][$value]['fin_fab_pur_req_qty'] += $row['fin_fab_pur_req_qty'];
            }                  
            
        }        
    }
    // echo "<pre>";print_r($contrust_color_qty_array);die();

    $text_store_sql = sql_select("select company_name as COMPANY_NAME, distribute_qnty as DISTRIBUTE_QNTY from variable_settings_production where variable_list=56 and status_active=1 and company_name=$COMPANY_NAME");
    //echo "select company_name as COMPANY_NAME, distribute_qnty as DISTRIBUTE_QNTY from variable_settings_production where variable_list=56 and status_active=1 and company_name=$COMPANY_NAME";
    if(empty($text_store_sql))
    {
        echo "Select Textile Store in Library setup";
        die;
    }
    $text_cond_from_store_or    = $text_cond_from_store_and ="";
    $text_cond_store_id_or      = $text_cond_store_id_and   ="";
    foreach ($text_store_sql as $row) 
    {
        $textile_store_arr[$row['COMPANY_NAME']] =$row["DISTRIBUTE_QNTY"];

        $text_cond_from_store_or .= ' $val["FROM_STORE"] == '.$row["DISTRIBUTE_QNTY"]. ' ||';
        $text_cond_from_store_and .= ' $val["FROM_STORE"] != '.$row["DISTRIBUTE_QNTY"]. ' &&';

        $text_cond_store_id_or .= ' $val["STORE_ID"] == '.$row["DISTRIBUTE_QNTY"]. ' ||';
        $text_cond_store_id_and .= ' $val["STORE_ID"] != '.$row["DISTRIBUTE_QNTY"]. ' &&';

        $textile_store_id = $row["DISTRIBUTE_QNTY"];
    }
    $text_cond_from_store_or = chop($text_cond_from_store_or,'||'); $text_cond_from_store_and = chop($text_cond_from_store_and,'&&');
    $text_cond_store_id_or = chop($text_cond_store_id_or,'||'); $text_cond_store_id_and = chop($text_cond_store_id_and,'&&');

    $lib_store = return_library_array("select b.store_name, b.id from lib_store_location_category a, lib_store_location b where a.store_location_id=b.id and a.category_type=2 and b.company_id in (1,2) and b.status_active=1 and b.id in (166, 16, 14) group by b.store_name, b.id", "id", "store_name");

    //echo $text_cond_store_id_and;die;

    $short_sql = sql_select("select a.job_no as JOB_NO, a.fin_fab_qnty as FIN_FAB_QNTY, a.grey_fab_qnty as GREY_FAB_QNTY, a.fabric_color_id as COLOR_ID, b.fabric_source as FABRIC_SOURCE from wo_booking_dtls a, wo_booking_mst b where a.booking_no = b.booking_no and a.is_short=1 and a.booking_type=1 and a.po_break_down_id in ($poIds) and a.status_active =1 and a.is_deleted=0");
    foreach ($short_sql as $val) 
    {
        $color_short_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['SHORT_FINISH'] += $val['FIN_FAB_QNTY'];
        $color_short_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['SHORT_GREY'] += $val['GREY_FAB_QNTY'];
    }

    $grey_sql = sql_select("select d.job_no_mst as JOB_NO, a.quantity as QUANTITY, b.color_id as COLOR_ID, b.gsm as GSM, b.width as WIDTH, b.uom as UOM, b.febric_description_id as FEBRIC_DESCRIPTION_ID, b.body_part_id as BODY_PART_ID, c.body_part_type as BODY_PART_TYPE from order_wise_pro_details a, pro_grey_prod_entry_dtls b left join lib_body_part c on b.body_part_id = c.id, wo_po_break_down d where a.dtls_id=b.id and a.trans_id=b.trans_id and A.PO_BREAKDOWN_ID=d.id and a.entry_form in (2,22,58) and a.trans_id >0 and a.po_breakdown_id in ($poIds) and a.is_sales=0 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted=0");

    foreach ($grey_sql as $val) 
    {
       $color_wise[$val['JOB_NO']][$val['COLOR_ID']]['GREY_QTY'] += $val['QUANTITY'];
    }

    if($db_type==0) {
        $ext_cond = " and (a.extention_no=0 or a.extention_no='')";
    } else {
        $ext_cond = " and (a.extention_no=0 or a.extention_no is null)";
    }

    $batch_sql = sql_select("SELECT d.job_no_mst as JOB_NO,a.color_id as COLOR_ID, b.batch_qnty as QUANTITY,c.gsm as GSM, c.dia_width as DIA_WIDTH, c.detarmination_id as DETARMINATION_ID, b.body_part_id as BODY_PART_ID, e.fabric_source as FABRIC_SOURCE from pro_batch_create_mst a, pro_batch_create_dtls b, product_details_master c, wo_po_break_down d, wo_booking_mst e where a.booking_no= e.booking_no and a.id=b.mst_id and b.prod_id=c.id and b.po_id=d.id $ext_cond and b.po_id in ($poIds) and b.is_sales =0 and e.fabric_source=1 AND a.batch_against IN (1) and a.status_active = 1 and a.is_deleted = 0 and b.status_active = 1 and b.is_deleted = 0 and c.status_active = 1 and c.is_deleted = 0 and e.status_active = 1 and e.is_deleted = 0 ORDER BY a.color_id ASC");
    foreach ($batch_sql as $val) 
    {
        if($val['FABRIC_SOURCE']=="") $val['FABRIC_SOURCE']=1;
        $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['BATCH_QTY'] += $val['QUANTITY'];
        if(in_array($val['COLOR_ID'],$contrust_color_id_array))
        {
           $color_id2=$val['COLOR_ID']."_1";
           // if(!empty($color_in_both_array[$val['COLOR_ID']]))
           // {
           //     $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
           // }
        }
        else
        {
            $color_id2=$val['COLOR_ID'];
        }
        $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $color_id2;
        $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['JOB_NO'] = $val['JOB_NO'];
    }


    /*======================================================================================/
    /                                    finish fab transfer                                /
    /======================================================================================*/   
    
    // $finish_transfer_sql = sql_select("SELECT e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID, a.trans_type as TRANS_TYPE, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, f.from_store as FROM_STORE, f.to_store as TO_STORE from order_wise_pro_details a, inv_transaction b, inv_item_transfer_dtls f, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e where A.trans_id=b.id and a.dtls_id=f.id and B.pi_wo_batch_no= c.id and c.booking_no = d.booking_no and A.PO_BREAKDOWN_ID= e.id and a.entry_form in (14) and a.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0");
    $finish_transfer_sql = sql_select("SELECT e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID, a.trans_type as TRANS_TYPE, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, f.from_store as FROM_STORE, f.to_store as TO_STORE,g.transfer_criteria from order_wise_pro_details a, inv_transaction b, inv_item_transfer_dtls f, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e,inv_item_transfer_mst g where A.trans_id=b.id and a.dtls_id=f.id and B.pi_wo_batch_no= c.id and c.booking_no = d.booking_no and A.PO_BREAKDOWN_ID= e.id and a.entry_form in (14) and a.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and g.id=f.mst_id and g.transfer_criteria in(2,4) AND b.item_category = 2 AND a.status_active = 1 AND a.po_breakdown_id <> 0 ORDER BY a.color_id ASC");// AND b.STORE_ID IN (8, 20, 32)
    
    // echo "SELECT e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID, a.trans_type as TRANS_TYPE, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, f.from_store as FROM_STORE, f.to_store as TO_STORE,g.transfer_criteria from order_wise_pro_details a, inv_transaction b, inv_item_transfer_dtls f, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e,inv_item_transfer_mst g where A.trans_id=b.id and a.dtls_id=f.id and B.pi_wo_batch_no= c.id and c.booking_no = d.booking_no and A.PO_BREAKDOWN_ID= e.id and a.entry_form in (14) and a.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and g.id=f.mst_id and g.transfer_criteria in(2,4) AND b.item_category = 2 AND a.status_active = 1 AND a.po_breakdown_id <> 0 ORDER BY a.color_id ASC";die;

    foreach ($finish_transfer_sql as $val) 
    {
        if($trans_arr[$val['TRANS_ID']] == "")
        {            
            if($val['TRANSFER_CRITERIA']==4) // order to order
            {
                if($val['TRANS_TYPE']==5)
                {
                    if($val['FABRIC_SOURCE'] =="") { $val['FABRIC_SOURCE']=1;} 
                    if($val['FABRIC_SOURCE'] ==1)
                    {
                        //if($val['FROM_STORE'] == 16 || $val['FROM_STORE'] == 14)
                        //if($text_cond_from_store_or)
                        // if(eval("return $text_cond_from_store_or;"))
                        // {
                            //echo $text_cond_from_store_or;
                            //echo $val['FROM_STORE'];
                            $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANS_IN'] += $val['QUANTITY'];
                        // }
                    }
                    else
                    {
                        $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANS_IN'] += $val['QUANTITY'];
                    }
                }
                else
                {
                    if($val['FABRIC_SOURCE'] ==1)
                    {
                        //if($val['FROM_STORE'] != 16 && $val['FROM_STORE'] != 14)
                        //if($text_cond_from_store_and)   
                        // if(eval("return $text_cond_from_store_and;"))
                        // {
                            $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANS_OUT'] += $val['QUANTITY'];
                        // }
                    }
                    else
                    {
                        $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANS_OUT'] += $val['QUANTITY'];
                    }
                }
            }
            else // store to store
            {
                if($val['FROM_STORE'] != $val['TO_STORE'])
                {
                    if($val['TRANS_TYPE']==5)
                    {
                        if(($val['FROM_STORE']==16 || $val['FROM_STORE']==46 || $val['FROM_STORE']==14 || $val['FROM_STORE']==47) && ($val['TO_STORE']==8 || $val['TO_STORE']==20 || $val['TO_STORE']==32 || $val['TO_STORE']==52))  
                        {
                            if($val['FABRIC_SOURCE'] =="") { $val['FABRIC_SOURCE']=1;}                     
                            if($val['FABRIC_SOURCE'] ==1)
                            {
                                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANSIN'] += $val['QUANTITY'];
                               
                            }
                            else
                            {
                                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANSIN'] += $val['QUANTITY'];
                            }
                            
                        }
                    }
                    else
                    {
                        if($val['FABRIC_SOURCE'] ==1)
                        {
                            //if($val['FROM_STORE'] != 16 && $val['FROM_STORE'] != 14)
                            //if($text_cond_from_store_and)   
                            // if(eval("return $text_cond_from_store_and;"))
                            // {
                                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANSOUT'] += $val['QUANTITY'];
                            // }
                        }
                        else
                        {
                            $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['TRANSOUT'] += $val['QUANTITY'];
                        }
                    }
                }
            }
            
            $trans_arr[$val['TRANS_ID']] = $val['TRANS_ID'];
            if(in_array($val['COLOR_ID'],$contrust_color_id_array))
            {
               $color_id2=$val['COLOR_ID']."_1";
               // if(!empty($color_in_both_array[$val['COLOR_ID']]))
               // {
               //     $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
               // }
            }
            else
            {
                $color_id2=$val['COLOR_ID'];
            }
            $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $color_id2;
            $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['JOB_NO'] = $val['JOB_NO'];
        }
    }

    // echo "<pre>";print_r($color_wise);die;

    // ==================================== textile trans rcv =====================================
    $sql = "SELECT e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID, a.trans_type as TRANS_TYPE, b.cons_quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, f.from_store as FROM_STORE, f.to_store as TO_STORE,g.transfer_criteria from order_wise_pro_details a, inv_transaction b, inv_item_transfer_dtls f, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e,inv_item_transfer_mst g where A.trans_id=b.id and a.dtls_id=f.id and B.pi_wo_batch_no= c.id and c.booking_no = d.booking_no and A.PO_BREAKDOWN_ID= e.id and a.entry_form in (14) and a.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and g.id=f.mst_id and g.transfer_criteria in(2,4) AND b.item_category = 2 AND b.STORE_ID IN (16)  AND a.trans_type = 5 ORDER BY a.color_id ASC";// AND b.STORE_ID IN (8, 20, 32)
    // echo $sql;
    $res = sql_select($sql);
    $trans_qty_array = array();
    foreach ($res as $val) 
    {
        if($val['FABRIC_SOURCE'] =="") { $val['FABRIC_SOURCE']=1;}  
        if($val['FABRIC_SOURCE'] ==1)
        {          
            $trans_qty_array[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']] += $val['QUANTITY'];
        }
        else
        {
            $trans_qty_array[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']] += $val['QUANTITY'];
        }
        if(in_array($val['COLOR_ID'],$contrust_color_id_array))
        {
           $color_id2=$val['COLOR_ID']."_1";
           // if(!empty($color_in_both_array[$val['COLOR_ID']]))
           // {
           //     $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
           // }
        }
        else
        {
            $color_id2=$val['COLOR_ID'];
        }
        $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $color_id2;
        $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['JOB_NO'] = $val['JOB_NO'];
    }
    // echo "<pre>";print_r($trans_qty_array);die();
    $finish_iss_rcvret_sql = sql_select("SELECT e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, b.store_id as STORE_ID from order_wise_pro_details a, inv_finish_fabric_issue_dtls b, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e,inv_issue_master f where a.dtls_id=b.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.id and a.entry_form in (18,46) and f.id=b.mst_id  and a.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and a.trans_id<>0 ORDER BY a.color_id ASC");//AND f.booking_no = d.booking_no

    foreach ($finish_iss_rcvret_sql as $val)
    {
        if($val['ENTRY_FORM']==18)
        {
            if($val['FABRIC_SOURCE']=="") $val['FABRIC_SOURCE'] =1;
            if($val['FABRIC_SOURCE'] ==1 && eval("return $text_cond_store_id_or;") )
            {
                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['ISSUE'] += $val['QUANTITY'];
            }
            else
            {
                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['ISSUE'] += $val['QUANTITY'];
            }
        }
        else if($val['ENTRY_FORM']==46)
        {
            $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['RECV_RETURN'] += $val['QUANTITY'];
        } 

        if(in_array($val['COLOR_ID'],$contrust_color_id_array))
        {
           $color_id2=$val['COLOR_ID']."_1";
           // if(!empty($color_in_both_array[$val['COLOR_ID']]))
           // {
           //     $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
           // }
        }
        else
        {
            $color_id2=$val['COLOR_ID'];
        }
        $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $color_id2;
        $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['JOB_NO'] = $val['JOB_NO'];
    }
    // echo "<pre>";print_r($color_wise);die;

    // $finish_rcv_issuereturn_sql = sql_select("SELECT e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID, a.returnable_qnty as REJECT_QTY, a.grey_used_qty as GREY_USED_QTY, b.id as DTLS_ID, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, f.store_id as TRANS_STORE, g.store_id as STORE_ID from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join inv_transaction f on b.trans_id=f.id  and f.status_active=1 and f.store_id in(46,16,47,14) AND f.transaction_type = 1, inv_receive_master g, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e where a.dtls_id = b.id and b.mst_id = g.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.id and a.entry_form in (7,37) and g.entry_form in (7,37) and a.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and g.store_id in(46,16,47,14) ORDER BY a.color_id ASC");

    $finish_rcv_issuereturn_sql = sql_select("SELECT e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID, a.returnable_qnty as REJECT_QTY, a.grey_used_qty as GREY_USED_QTY, b.id as DTLS_ID, ( case when g.store_id IN (46,16,47,14) then a.quantity else 0 end) as INHOUSE_QUANTITY,( case when g.store_id IN (8,20,49) then a.quantity else 0 end) as PURCHASE_QUANTITY, d.fabric_source as FABRIC_SOURCE, f.store_id as TRANS_STORE, g.store_id as STORE_ID from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join inv_transaction f on b.trans_id=f.id  and f.status_active=1 and f.store_id in(46,16,47,14,8,20,49) AND f.transaction_type = 1, inv_receive_master g, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e where a.dtls_id = b.id and b.mst_id = g.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.id and a.entry_form in (7,37) and g.entry_form in (7,37) and a.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and g.store_id in(46,16,47,14,8,20,49) ORDER BY a.color_id ASC");

    $tot_fin = 0;
    foreach ($finish_rcv_issuereturn_sql as $val) 
    {
        if(in_array($val['COLOR_ID'],$contrust_color_id_array))
        {
           $color_id2=$val['COLOR_ID']."_1";
           //  if(!empty($color_in_both_array[$val['COLOR_ID']]))
           // {
           //     $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
           // }
        }
        else
        {
            $color_id2=$val['COLOR_ID'];
        }

        if($val['ENTRY_FORM']==7)
        {
            if($dtls_arr[$val['DTLS_ID']] == "")
            {
                $dtls_arr[$val['DTLS_ID']] = $val['DTLS_ID'];
                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['GREY_USED'] += $val['GREY_USED_QTY'];
            }
            $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $color_id2;
            $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['JOB_NO'] = $val['JOB_NO'];
        }
        if($val['TRANS_ID'])
        {
            if($val['FABRIC_SOURCE'] =="") { $val['FABRIC_SOURCE']=1;}
            if($val['FABRIC_SOURCE'] ==1)
            {
                // if(eval("return $text_cond_store_id_or;"))
                // {
                    //fixed store for textile receive
                    $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['FINISH_QTY'] += $val['INHOUSE_QUANTITY'];
                    $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['REJECT_QTY'] += $val['REJECT_QTY'];
                    $tot_fin+=$val['INHOUSE_QUANTITY'];
                // }
            }
            else
            {
                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['FINISH_QTY'] += $val['PURCHASE_QUANTITY'];
                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['REJECT_QTY'] += $val['REJECT_QTY'];
            }
            
            $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $color_id2;
            $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['JOB_NO'] = $val['JOB_NO'];
        }
    }
    // echo "<pre>";print_r($color_wise); die();

    $finish_issue_return = sql_select("SELECT e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID,  a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, f.store_id as STORE_ID FROM order_wise_pro_details a, inv_transaction f, inv_receive_master g, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e WHERE a.trans_id = f.id and f.mst_id = g.id and f.pi_wo_batch_no= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.id and a.entry_form =52 and g.entry_form =52 and a.po_breakdown_id in ($poIds) and a.status_active=1 and a.is_deleted=0 and f.status_active=1 and f.is_deleted=0 ORDER BY a.color_id ASC");
    foreach ($finish_issue_return as $val) 
    {
        if(in_array($val['COLOR_ID'],$contrust_color_id_array))
        {
           $color_id2=$val['COLOR_ID']."_1";
           // if(!empty($color_in_both_array[$val['COLOR_ID']]))
           // {
           //     $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
           // }
        }
        else
        {
            $color_id2=$val['COLOR_ID'];
        }

        if($val['FABRIC_SOURCE'] ==1)
        {
            //if($val['STORE_ID'] != 16 && $val['STORE_ID'] != 14)
            //if( $text_cond_store_id_and)
            if(eval("return $text_cond_store_id_and;"))
            {
                $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['ISSUE_RETURN'] += $val['QUANTITY'];
                $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $color_id2;
                $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['JOB_NO'] = $val['JOB_NO'];
            }
        }
        else
        {
            $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['ISSUE_RETURN'] += $val['QUANTITY'];
            $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $color_id2;
            $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['JOB_NO'] = $val['JOB_NO'];
        }
    }

    // $dyeing_sql = sql_select("SELECT e.job_no_mst as JOB_NO,a.id as ID, b.id as DYEING_DTLS_ID,c.id as BATCH_DTLS_ID, b.batch_qty as BATCH_QTY, d.color_id as COLOR_ID, f.fabric_source as FABRIC_SOURCE from  pro_fab_subprocess a, pro_fab_subprocess_dtls b,pro_batch_create_dtls c, pro_batch_create_mst d, wo_po_break_down e, wo_booking_mst f where a.id = b.mst_id and a.batch_id=c.mst_id and c.mst_id=d.id and c.po_id=e.id and c.po_id in ($poIds) and d.booking_no=f.booking_no and f.fabric_source=1 and a.entry_form=35 and b.entry_page=35 and a.load_unload_id=2 and a.result=1");

    $dyeing_sql = sql_select("SELECT e.job_no_mst as JOB_NO,a.id as ID, c.id as BATCH_DTLS_ID, c.batch_qnty as BATCH_QTY, d.color_id as COLOR_ID, f.fabric_source as FABRIC_SOURCE from  pro_fab_subprocess a,pro_batch_create_dtls c, pro_batch_create_mst d, wo_po_break_down e, wo_booking_mst f where a.batch_id=c.mst_id and c.mst_id=d.id and c.po_id=e.id and c.po_id in ($poIds) and d.booking_no=f.booking_no and f.fabric_source=1 and a.entry_form=35 and a.load_unload_id=2 and a.result=1 AND d.batch_against <> 2  and a.status_active = 1 and a.is_deleted = 0 and c.status_active = 1 and c.is_deleted = 0 and d.status_active = 1 and d.is_deleted = 0 and f.status_active = 1 and f.is_deleted = 0 ORDER BY d.color_id ASC");
    foreach ($dyeing_sql as $val) 
    {
        if($dupliChk[$val['DYEING_DTLS_ID']] =="")
        {
            $dupliChk[$val['DYEING_DTLS_ID']] = $val['DYEING_DTLS_ID'];
            $color_wise[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']]['DYE_QTY'] += $val['BATCH_QTY'];

            if(in_array($val['COLOR_ID'],$contrust_color_id_array))
            {
               $color_id2=$val['COLOR_ID']."_1";
               // if(!empty($color_in_both_array[$val['COLOR_ID']]))
               // {
               //     $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
               // }
            }
            else
            {
                $color_id2=$val['COLOR_ID'];
            }

            $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $color_id2;
            $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['JOB_NO'] = $val['JOB_NO'];
        }
    }

    // ========================== outbound dyeing data ==============================
    $sqlDye = "SELECT f.job_no_mst as job_no,d.color_id,e.fabric_source,b.grey_used_qty as QTY 
    from inv_receive_master a,pro_finish_fabric_rcv_dtls b,order_wise_pro_details c,pro_batch_create_mst d,wo_booking_mst e,wo_po_break_down f where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 and c.po_breakdown_id in($poIds) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(37) and c.entry_form in(37) and a.item_category=2 and a.receive_basis=11 and d.booking_no=e.booking_no and d.id=b.batch_id and f.id=c.po_breakdown_id ORDER BY d.color_id ASC";
        // echo $sqlDye;die();
        $dyeRes = sql_select($sqlDye);
        $outbound_dyeing_data_array = array();
        foreach ($dyeRes as $val) 
        {   
            if($val['FABRIC_SOURCE'] =="") { $val['FABRIC_SOURCE']=1;}        
            $outbound_dyeing_data_array[$val['JOB_NO']][$val['COLOR_ID']][$val['FABRIC_SOURCE']] += $val['QTY'];

            if(in_array($val['COLOR_ID'],$contrust_color_id_array))
            {
               $color_id2=$val['COLOR_ID']."_1";
               //  if(!empty($color_in_both_array[$val['COLOR_ID']]))
               // {
               //     $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $val['COLOR_ID'];
               // }
            }
            else
            {
                $color_id2=$val['COLOR_ID'];
            }

            $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['COLOR_NUMBER_ID'] = $color_id2;
            $job_color_arr[$val['JOB_NO']][$lib_color[$val['COLOR_ID']]]['JOB_NO'] = $val['JOB_NO'];
        }
        // echo "<pre>";print_r($job_color_arr);die();
    
    $acting_width = $screen_size-50;
    $three_percent = $acting_width*0.03;
    $four_percent = $acting_width*0.04;
    $five_percent = $acting_width*0.05;
    $six_percent = $acting_width*0.06;
    // echo "<pre>";
    // print_r($job_color_arr);

    if($_SESSION['logic_erp']['user_id'] == 1)
    {
        //echo $fabric->getQuery();
        // echo "<pre>";
        // print_r($fabric_costing_arr[knit][finish]);
        // echo "</pre>";

        // echo "<pre>";
        // print_r($job_color_arr);
        // echo "</pre>";

        // echo "<pre>";
        // print_r($color_in_both_array);
        // echo "</pre>";
    }
    
    ?>    
    <div id="data_panel" align="center" style="width:<? echo $acting_width;?>px">
        <script>
            function new_window()
            {
                document.getElementById('scroll_body').style.overflow="auto";
                document.getElementById('scroll_body').style.maxHeight="none";
                document.getElementById('scroll_body_2nd').style.overflow="auto";
                document.getElementById('scroll_body_2nd').style.maxHeight="none";
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
                document.getElementById('scroll_body').style.overflowY="scroll";
                document.getElementById('scroll_body').style.maxHeight="240px";
                document.getElementById('scroll_body_2nd').style.overflowY="scroll";
                document.getElementById('scroll_body_2nd').style.maxHeight="240px";
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: <? echo $acting_width;?>px" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="<? echo $acting_width?>">
                <caption style="font-size:20px;"><b>Finish Fabric Status</b></caption>
                <tbody>
                    <tr>
                        <td colspan="26" width="<? echo $acting_width;?>"><b>Style Name:<? echo $sqlOrderRes[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref:<? echo implode(", ",array_unique(explode(",",chop($int_ref,","))));?></b></td>
                    </tr>
                </tbody>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width?>">
                <thead>
                    <tr>
                        <th align="left" colspan="14">&nbsp;</th>
                        <th colspan="7">Textile Store (<? echo $lib_store[$textile_store_arr[$COMPANY_NAME]]; ?>)</th>
                        <th colspan="6">Garments Store</th>
                    </tr>
                    <tr>
                        <th width="<? echo $five_percent;?>">Color</th>
                        <th width="<? echo $five_percent;?>">Finish Req</th>
                        <th width="<? echo $three_percent;?>">Ex Req</th>
                        <th width="<? echo $three_percent;?>">Gray Req</th>
                        <th width="<? echo $three_percent;?>">PL %</th>
                        <th width="<? echo $three_percent;?>">Gray Rcv</th>

                        <th width="<? echo $three_percent;?>">Gray Bal</th>
                        <th width="<? echo $three_percent;?>">Batch</th>
                        <th width="<? echo $three_percent;?>">Batch Bal</th>
                        <th width="<? echo $three_percent;?>">Dyeing</th>
                        <th width="<? echo $three_percent;?>">Dyeing Bal</th>
                        <th width="<? echo $three_percent;?>">Finish</th>
                        <th width="<? echo $three_percent;?>">Fin Bal</th>
                        <th width="<? echo $three_percent;?>">PL%</th>

                        <th width="<? echo $three_percent;?>">Ok Rcvd</th>
                        <th width="<? echo $three_percent;?>">Rej Rcvd</th>
                        <th width="<? echo $three_percent;?>">Rcv bal</th>
                        <th width="<? echo $three_percent;?>">Ok Stock</th>
                        <th width="<? echo $three_percent;?>">Rej Stock</th>
                        <th width="<? echo $three_percent;?>">FF Del</th>
                        <th width="<? echo $three_percent;?>">Del Bal</th>

                        <th width="<? echo $three_percent;?>">FF Rcvd</th>
                        <th width="<? echo $three_percent;?>">Trans In</th>
                        <th width="<? echo $three_percent;?>">Trans Out</th>
                        <th width="<? echo $three_percent;?>">Net Issue</th>
                        <th width="<? echo $three_percent;?>">Stock</th>
                        <th width="<? echo $three_percent;?>">Issue Bal</th>
                    </tr>
                </thead>
            </table>
            <div style="width:<? echo $acting_width + 18;?>px; max-height:240px;overflow-y:scroll;" id="scroll_body">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width;?>">
                    <tbody>
                        <?
                        $i=0;

                        foreach ($job_color_arr as $job_no=>$job_data) 
                        {
                            ksort($job_data);
                            foreach ($job_data as $colorId => $row) 
                            {
                                // echo $row['COLOR_NUMBER_ID']."<br>";
                                $colorEx = explode("_", $row['COLOR_NUMBER_ID']);
                                
                                $color_id = $colorEx[0];
                                $is_contrust_color_id = $colorEx[1];
                                
                                // $fab_knit_grey=$fab_req_qty_array[$job_no][$row['COLOR_NUMBER_ID']][1]['fab_knit_grey'];
                                // $fab_knit_finish=$fab_req_qty_array[$job_no][$row['COLOR_NUMBER_ID']][1]['fab_knit_finish'];

                                // sum qmts color and contrust color qty
                                if(count($colorEx)>1)
                                {
                                    $fab_knit_grey=$fab_req_qty_array[$job_no][$color_id][1]['fab_knit_grey']+$fab_req_qty_array[$job_no][$row['COLOR_NUMBER_ID']][1]['fab_knit_grey'];
                                    $fab_knit_finish=$fab_req_qty_array[$job_no][$color_id][1]['fab_knit_finish']+$fab_req_qty_array[$job_no][$row['COLOR_NUMBER_ID']][1]['fab_knit_finish'];
                                }
                                else
                                {
                                    $fab_knit_grey=$fab_req_qty_array[$job_no][$color_id][1]['fab_knit_grey'];
                                    $fab_knit_finish=$fab_req_qty_array[$job_no][$color_id][1]['fab_knit_finish'];
                                }
                                // echo $fab_req_qty_array[$job_no][$color_id][1]['fab_knit_finish']."+".$fab_req_qty_array[$job_no][$row['COLOR_NUMBER_ID']][1]['fab_knit_finish']."<br>";
                                
                                $fab_woven_grey=$row['fab_woven_grey'];
                                $fab_woven_finish=$row['fab_woven_finish'];

                                $grey_required =  $fab_knit_grey+$fab_woven_grey;
                                $finish_required =  $fab_knit_finish+$fab_woven_finish;

                                $grey_requ_with_addi = $grey_required + $color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_GREY'];

                                if($grey_requ_with_addi >0){
                                    $pl_percentage = ($grey_requ_with_addi - ($finish_required +$color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_FINISH']))/$grey_requ_with_addi*100;
                                }else{
                                    $pl_percentage =0;
                                }
                                

                                $grey_balance = $grey_requ_with_addi- $color_wise[$row['JOB_NO']][$color_id]['GREY_QTY'];

                                $dyeing_balance = $grey_requ_with_addi- $color_wise[$row['JOB_NO']][$color_id][$production_source]['DYE_QTY'];
                                $grey_used_balance = $grey_requ_with_addi- $color_wise[$row['JOB_NO']][$color_id][$production_source]['GREY_USED'];

                                if($color_wise[$row['JOB_NO']][$color_id][$production_source]['GREY_USED'] > 0)
                                {
                                    $pl_percentage_second = ($color_wise[$row['JOB_NO']][$color_id][$production_source]['GREY_USED'] - ($color_wise[$row['JOB_NO']][$color_id][$production_source]['FINISH_QTY'] +$color_wise[$row['JOB_NO']][$color_id][$production_source]['REJECT_QTY']))/$color_wise[$row['JOB_NO']][$color_id][$production_source]['GREY_USED']*100;
                                }
                                else
                                {
                                    $pl_percentage_second =0;
                                }
                                

                                $finish_rcv_balance = ($finish_required +$color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_FINISH']) - $color_wise[$row['JOB_NO']][$color_id][$production_source]['FINISH_QTY'];

                                $text_okay_stock_bal = $color_wise[$row['JOB_NO']][$color_id][$production_source]['FINISH_QTY'] - $color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANSIN'];

                                $text_del_bal = ($finish_required + $color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_FINISH'])- $color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANSIN'];

                                $issue_balance= ($finish_required + $color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_FINISH'])- $color_wise[$row['JOB_NO']][$color_id][$production_source]['ISSUE'];
                                // echo "(".$finish_required ."+". $color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_FINISH'].")- ".$color_wise[$row['JOB_NO']][$color_id][$production_source]['ISSUE']."<br>";

                                $ff_received_garments = $color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANSIN'];// + $color_wise[$row['JOB_NO']][$color_id][$production_source]['ISSUE_RETURN'];
                                // $ff_issued_garments = $color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANS_OUT'] + $color_wise[$row['JOB_NO']][$color_id][$production_source]['ISSUE'];
                                $ff_issued_garments = $color_wise[$row['JOB_NO']][$color_id][$production_source]['ISSUE'] - $color_wise[$row['JOB_NO']][$color_id][$production_source]['ISSUE_RETURN'];
                                $ff_issue_title = "FF Isue - Issue Return";

                                //$batch_balance = $color_wise[$row['JOB_NO']][$color_id]['GREY_QTY'] - $color_wise[$row['JOB_NO']][$color_id][$production_source]['BATCH_QTY'];
                                $batch_balance = $grey_requ_with_addi - $color_wise[$row['JOB_NO']][$color_id][$production_source]['BATCH_QTY'];// CHANGED BY MOSHIUR
                                $trans_in = $color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANS_IN'];
                                $trans_out = $color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANS_OUT'];

                                $stock = ($ff_received_garments+$trans_in) - ($ff_issued_garments+$trans_out);
                                $stk_title = "FF Rcv=".$ff_received_garments." + Trans In=".$trans_in." - FF Issue=".$ff_issued_garments." + Trans Out=".$trans_out;

                                $trans_qty_in_textile = $trans_qty_array[$row['JOB_NO']][$color_id][$production_source];
                                $outbound_dyeing_qty = $outbound_dyeing_data_array[$row['JOB_NO']][$color_id][$production_source];

                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                // echo $row['JOB_NO']."=".$row['COLOR_NUMBER_ID']."*".$production_source."<br>";
                                ?>                      
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                    <td title="<?=$color_id;?>" width="<? echo $five_percent;?>"><a href="##" onclick="color_popup('<? echo $color_id."*".$poIds."*".$job_no."*".$is_contrust_color_id;?>','finish_color_popup')"><p><? echo substr($lib_color[$color_id],0,13);?></a></p></td>
                                    <td width="<? echo $five_percent;?>" align="right"><? echo fn_number_format($finish_required,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_FINISH'],0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($grey_requ_with_addi,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($pl_percentage,2); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($color_wise[$row['JOB_NO']][$color_id]['GREY_QTY'],0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($grey_balance,0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format(($color_wise[$row['JOB_NO']][$color_id][$production_source]['BATCH_QTY']+$outbound_dyeing_qty),0);?></td>
                                    <td title="Grey Req - Batch Qty" width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($batch_balance,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format(($color_wise[$row['JOB_NO']][$color_id][$production_source]['DYE_QTY']+$outbound_dyeing_qty),0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($dyeing_balance,0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format(($color_wise[$row['JOB_NO']][$color_id][$production_source]['GREY_USED']+$outbound_dyeing_qty),0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($grey_used_balance,0); ;?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($pl_percentage_second,2);?></td>


                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($color_wise[$row['JOB_NO']][$color_id][$production_source]['FINISH_QTY'],0);?></td>


                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($color_wise[$row['JOB_NO']][$color_id][$production_source]['REJECT_QTY'],0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($finish_rcv_balance,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($text_okay_stock_bal,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($color_wise[$row['JOB_NO']][$color_id][$production_source]['REJECT_QTY'],0);?></td>

                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANSIN'],0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($text_del_bal,0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($ff_received_garments,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($trans_in,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($trans_out,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right" title="<?=$ff_issue_title;?>"><? echo fn_number_format($ff_issued_garments,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right" title="<?=$stk_title;?>"><? echo fn_number_format($stock,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($issue_balance,0); ?></td>
                                </tr>
                                <?
                                $tot_finish_required += $finish_required;
                                $tot_short_finish += $color_short_wise[$row['JOB_NO']][$color_id][$production_source]['SHORT_FINISH'];
                                $tot_grey_required +=$grey_requ_with_addi;
                                $tot_grey_qty += $color_wise[$row['JOB_NO']][$color_id]['GREY_QTY'];
                                $tot_grey_balance += $grey_balance;
                                $tot_batch_qty += $color_wise[$row['JOB_NO']][$color_id][$production_source]['BATCH_QTY']+$outbound_dyeing_qty;
                                $tot_batch_balance += $batch_balance;
                                $tot_dye_qty += $color_wise[$row['JOB_NO']][$color_id][$production_source]['DYE_QTY']+$outbound_dyeing_qty;
                                $tot_dyeing_balance += $dyeing_balance;
                                $tot_grey_used += $color_wise[$row['JOB_NO']][$color_id][$production_source]['GREY_USED']+$outbound_dyeing_qty;
                                $tot_grey_used_balance += $grey_used_balance;
                                $tot_finish_rcv += $color_wise[$row['JOB_NO']][$color_id][$production_source]['FINISH_QTY'];
                                $tot_reject_qty += $color_wise[$row['JOB_NO']][$color_id][$production_source]['REJECT_QTY'];
                                $tot_ff_del += $color_wise[$row['JOB_NO']][$color_id][$production_source]['TRANSIN'];
                                $tot_finish_rcv_balance +=$finish_rcv_balance;
                                $tot_text_okay_stock_bal += $text_okay_stock_bal;
                                $finish_rcv_balance;
                                $tot_text_del_bal += $text_del_bal;
                                $tot_finish_trans_in += $ff_received_garments;
                                $tot_finish_issue += $ff_issued_garments;
                                $tot_stock += $stock;
                                $tot_issue_balance += $issue_balance;
                                $tot_trans_in += $trans_in;
                                $tot_trans_out += $trans_out;
                                $i++;      
                            }
                        }

                        if($tot_grey_required >0 ) 
                        {
                            $tot_pl_percentage = ($tot_grey_required - ($tot_finish_required +$tot_short_finish))/$tot_grey_required*100;
                        }else{
                            $tot_pl_percentage =0;
                        }

                        if($tot_grey_used>0){
                            $tot_pl_percentage_second = ($tot_grey_used - ($tot_finish_rcv +$tot_reject_qty))/$tot_grey_used*100;
                        }else{
                            $tot_pl_percentage_second =0;
                        }
                        
                        ?>
                    </tbody>
                </table>
            </div>
             <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width?>">
                <tfoot>
                    <tr>
                        <th width="<? echo $five_percent;?>">&nbsp;</th>
                        <th width="<? echo $five_percent;?>"  align="right"><? echo fn_number_format($tot_finish_required,0); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_short_finish,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_grey_required,0); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_pl_percentage,2); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_grey_qty,0);?></th>

                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_grey_balance); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_batch_qty,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_batch_balance,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_dye_qty,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_dyeing_balance,0); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_grey_used,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_grey_used_balance,0); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_pl_percentage_second,2); ?></th>

                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_finish_rcv,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_reject_qty,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_finish_rcv_balance,0); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_text_okay_stock_bal,0); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_reject_qty,0);?></th>

                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_ff_del,0);?></th>

                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_text_del_bal,0); ?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_finish_trans_in,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_trans_in,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_trans_out,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_finish_issue,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_stock,0);?></th>
                        <th width="<? echo $three_percent;?>"  align="right"><? echo fn_number_format($tot_issue_balance,0) ?></th>
                    </tr>
                </tfoot>
            </table>
        </div> 
        <br>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width*0.4 ?>">
                <thead>
                    <tr>
                        <th>Style name</th>
                        <th colspan="2"></th>
                        <th colspan="6">Garments Store</th>
                    </tr>

                    <tr>
                        <th width="<? echo $five_percent+$width_add;?>">Color</th>
                        <th width="<? echo $five_percent;?>">Finish Req</th>
                        <th width="<? echo $four_percent;?>">Ex Req</th>

                        <th width="<? echo $four_percent;?>">FF Rcvd</th>
                        <th width="<? echo $four_percent;?>">Trans In</th>
                        <th width="<? echo $four_percent;?>">Trans Out</th>
                        <th width="<? echo $four_percent;?>">FF Net Issue</th>
                        <th width="<? echo $four_percent;?>">Stock</th>
                        <th width="<? echo $four_percent;?>">Issue Bal</th>
                    </tr>
                </thead>
            </table>
            <div style="width:<? echo $acting_width*0.4 + 18;?>px; max-height:240px;overflow-y:scroll;" id="scroll_body_2nd">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width*0.4;?>">
                    <tbody>
                        <?
                         //echo "<pre>";print_r($job_color_arr);
                        $tot_finish_required=$tot_short_finish=$tot_finish_recieve=$tot_finish_issue=$tot_stock=$tot_issue_balance=$tot_trans_in=$tot_trans_out=0;
                        foreach ($job_color_arr as $job_no=>$job_data) 
                        {
                            ksort($job_data);
                            foreach ($job_data as $colorId => $row) 
                            {
                                // echo $row['COLOR_NUMBER_ID']."<br>";
                                $colorEx = explode("_", $row['COLOR_NUMBER_ID']);
                                $color_id = $colorEx[0];
                                $is_contrust_color_id = $colorEx[1];

                                $fab_knit_grey = 0;
                                $fab_knit_finish = 0;
                                foreach($job_color_arr_const[$job_no][$colorId]['COLOR_NUMBER_ID'] as $COLOR_NUMBER_ID=>$COLOR_NValue)
                                {
                                    $fab_knit_grey+=$fab_req_qty_array[$job_no][$COLOR_NUMBER_ID][2]['fab_knit_grey'];
                                    $fab_knit_finish+=$fab_req_qty_array[$job_no][$COLOR_NUMBER_ID][2]['fab_knit_finish'];
                                }
                                /*
                               
                                $fab_knit_grey=$fab_req_qty_array[$job_no][$row['COLOR_NUMBER_ID']][2]['fab_knit_grey'];
                                $fab_knit_finish=$fab_req_qty_array[$job_no][$row['COLOR_NUMBER_ID']][2]['fab_knit_finish'];
                                //echo "<pre>".$row['COLOR_NUMBER_ID']."=>".$fab_knit_finish."</pre>";
                                // echo $fab_knit_finish."<br>";
                                // $fab_knit_grey=$fab_req_qty_array[$color_id][2]['fab_knit_grey']+$fab_req_qty_array[$job_no][$row['COLOR_NUMBER_ID']][2]['fab_knit_grey'];
                                // $fab_knit_finish=$fab_req_qty_array[$job_no][$color_id][2]['fab_knit_finish']+$fab_req_qty_array[$job_no][$row['COLOR_NUMBER_ID']][2]['fab_knit_finish'];
                                
                                */

                                $fab_woven_grey=$row['fab_woven_grey'];
                                $fab_woven_finish=$row['fab_woven_finish'];

                                $grey_required =  $fab_knit_grey+$fab_woven_grey;
                                $finish_required =  $fab_knit_finish+$fab_woven_finish;

                                if($_SESSION['logic_erp']['user_id'] == 1)
                                {
                                    //echo $fabric->getQuery();
                                    // echo "<pre>";
                                    // echo  $finish_required ." = ". $fab_knit_finish."+".$fab_woven_finish;
                                    // echo "</pre>";
                                }

                                $ff_received_garments = $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['FINISH_QTY'];//  + $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['ISSUE_RETURN'] + $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['TRANS_IN']
                                // $ff_issued_garments = $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['TRANS_OUT'] + $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['ISSUE'] + $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['RECV_RETURN'] ;
                                $ff_issued_garments = $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['ISSUE']-$color_wise[$row['JOB_NO']][$color_id][$purchase_source]['ISSUE_RETURN'];
                                $ff_issued_garments_title = "Issue = " . $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['ISSUE'].", Issue Return = ".$color_wise[$row['JOB_NO']][$color_id][$purchase_source]['ISSUE_RETURN'];

                                
                                
                                $trans_in = $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['TRANS_IN'];
                                //$trans_in = $row['JOB_NO']."=".$color_id."=".$purchase_source;
                                $trans_out = $color_wise[$row['JOB_NO']][$color_id][$purchase_source]['TRANS_OUT'];

                                $stock = ($ff_received_garments+$trans_in) - ($ff_issued_garments+$trans_out);
                                // echo "(".$ff_received_garments."+".$trans_in.") - (".$ff_issued_garments."+".$trans_out.")<br>";

                                $issue_balance = ($finish_required + $color_short_wise[$row['JOB_NO']][$color_id][$purchase_source]['SHORT_FINISH'])-$ff_issued_garments;
                                
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                    <td width="<? echo $five_percent+$width_add;?>" title="<?=$lib_color[$color_id];?>">
                                        <a href="##" onclick="color_popup_purchase('<? echo $color_id."*".$poIds."*".$job_no."*".$is_contrust_color_id;?>')"><?=substr($lib_color[$color_id],0,11);?></a>
                                    </td>
                                    <td width="<? echo $five_percent;?>" align="right" title="<?=$finish_required;?>"><? echo fn_number_format($finish_required,0);?></td>
                                    <td width="<? echo $four_percent;?>" align="right"><? echo fn_number_format($color_short_wise[$row['JOB_NO']][$color_id][$purchase_source]['SHORT_FINISH'],0);?></td>

                                    <td width="<? echo $four_percent;?>" align="right"><? echo fn_number_format($ff_received_garments,0);?></td>
                                    <td width="<? echo $four_percent;?>" align="right"><? echo fn_number_format($trans_in,0);?></td>
                                    <td width="<? echo $four_percent;?>" align="right"><? echo fn_number_format($trans_out,0);?></td>
                                    <td width="<? echo $four_percent;?>" align="right" title="<? echo $ff_issued_garments_title; ?>"><? echo fn_number_format($ff_issued_garments,0);?></td>
                                    <td width="<? echo $four_percent;?>" align="right"><? echo fn_number_format($stock,0);?></td>
                                    <td title="Req - Issue" width="<? echo $four_percent;?>" align="right"><? echo fn_number_format($issue_balance,0); ?></td>
                                </tr>
                                <?
                                $i++;
                                $tot_finish_required += $finish_required;
                                $tot_short_finish += $color_short_wise[$row['JOB_NO']][$color_id][$purchase_source]['SHORT_FINISH'];
                                $tot_finish_recieve += $ff_received_garments;
                                $tot_finish_issue +=$ff_issued_garments;
                                $tot_stock += $stock;
                                $tot_issue_balance +=$issue_balance;
                                $tot_trans_in +=$trans_in;
                                $tot_trans_out +=$trans_out;
                            }
                        }
                        ?>
                    </tbody>        
                </table>
            </div>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width*0.4?>">
                <tfoot>
                    <tr>
                        <th width="<? echo $five_percent+$width_add;?>">&nbsp;</th>
                        <th width="<? echo $five_percent;?>"  align="right"><? echo fn_number_format($tot_finish_required,0); ?></th>
                        <th width="<? echo $four_percent;?>"  align="right"><? echo fn_number_format($tot_short_finish,0);?></th>
                        <th width="<? echo $four_percent;?>"  align="right"><? echo fn_number_format($tot_finish_recieve,0);?></th>
                        <th width="<? echo $four_percent;?>"  align="right"><? echo fn_number_format($tot_trans_in,0);?></th>
                        <th width="<? echo $four_percent;?>"  align="right"><? echo fn_number_format($tot_trans_out,0);?></th>
                        <th width="<? echo $four_percent;?>"  align="right"><? echo fn_number_format($tot_finish_issue,0);?></th>
                        <th width="<? echo $four_percent;?>"  align="right"><? echo fn_number_format($tot_stock,0);?></th>
                        <th width="<? echo $four_percent;?>"  align="right"><? echo fn_number_format($tot_issue_balance,0) ?></th>
                    </tr>
                </tfoot>
            </table>

        <script type="text/javascript">
            function color_popup(data)
            {
                var width = window.innerWidth;
                var screen_size = width-20;  
                var COMPANY_NAME = '<? echo $COMPANY_NAME;?>'      

                var action = "finish_color_popup";
                emailwindow = dhtmlmodal.open('EmailBox', 'iframe', 'order_monitoring_report_with_tna_controller.php?data=' + data + '&action=' + action + '&screen_size='+screen_size+'&COMPANY_NAME='+COMPANY_NAME, 'Color Details', 'width='+width+'px,height=350px,center=1,resize=0,scrolling=0', '../../../');
            }
            function color_popup_purchase(data)
            {
                var width = window.innerWidth;
                var screen_size = width-20;        

                var action = "finish_color_popup_purchase";
                emailwindow = dhtmlmodal.open('EmailBox', 'iframe', 'order_monitoring_report_with_tna_controller.php?data=' + data + '&action=' + action + '&screen_size='+screen_size, 'Color Details', 'width='+width+'px,height=350px,center=1,resize=0,scrolling=0', '../../../');
            }
        </script>
    </div>
    <?
}


if($action == "finish_color_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    extract($_REQUEST);
    list($color, $poIds, $job_number,$is_contrust_color) = explode("*",$data);
    // echo "string".$is_contrust_color;
    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();
    //$costPerArr=$condition->getCostingPerArr();
    $fabric= new fabric($condition);
    //echo $fabric->getQuery();die;
    // $fabric_costing_arr=$fabric->getQtyArray_by_JobColorBodyTypeDeterminIdGsmAndDiaWidth_knitAndwoven_greyAndfinish();
    $fabric_costing_arr=$fabric->getQtyArray_by_JobColorFabricColorBodyTypeDeterminIdGsmAndDiaWidth_knitAndwoven_greyAndfinish();
    // echo "<pre>";print_r($fabric_costing_arr);die();
    // echo "<pre>";print_r($fabric_costing_arr[knit][finish]['FAL-21-00425']);die();
    $main_arr = array();
   
    // library setup chk
    $text_store_sql = sql_select("select company_name as COMPANY_NAME, distribute_qnty as DISTRIBUTE_QNTY from variable_settings_production where variable_list=56 and status_active=1 and company_name=$COMPANY_NAME");
    if(empty($text_store_sql))
    {
        echo "Select Textile Store in Library setup";
        die;
    }
    $text_cond_from_store_or    = $text_cond_from_store_and ="";
    $text_cond_store_id_or      = $text_cond_store_id_and   ="";
    foreach ($text_store_sql as $row) 
    {
        $textile_store_arr[$row['COMPANY_NAME']] =$row["DISTRIBUTE_QNTY"];

        $text_cond_from_store_or .= ' $val["FROM_STORE"] == '.$row["DISTRIBUTE_QNTY"]. ' ||';
        $text_cond_from_store_and .= ' $val["FROM_STORE"] != '.$row["DISTRIBUTE_QNTY"]. ' &&';

        $text_cond_store_id_or .= ' $val["STORE_ID"] == '.$row["DISTRIBUTE_QNTY"]. ' ||';
        $text_cond_store_id_and .= ' $val["STORE_ID"] != '.$row["DISTRIBUTE_QNTY"]. ' &&';
    }
    $text_cond_from_store_or = chop($text_cond_from_store_or,'||'); $text_cond_from_store_and = chop($text_cond_from_store_and,'&&');
    $text_cond_store_id_or = chop($text_cond_store_id_or,'||'); $text_cond_store_id_and = chop($text_cond_store_id_and,'&&');

    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");

   
    $short_sql = sql_select("SELECT B.BODY_PART_TYPE, a.fin_fab_qnty as FIN_FAB_QNTY, a.grey_fab_qnty as GREY_FAB_QNTY, a.fabric_color_id as COLOR_ID, b.gsm_weight as GSM_WEIGHT, b.lib_yarn_count_deter_id as DETERMINATION_ID, a.dia_width as DIA_WIDTH, b.uom as UOM, b.job_no as JOB_NO from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b, wo_booking_mst c where a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no = c.booking_no and c.fabric_source=1 and a.is_short=1 and a.booking_type=1 and a.po_break_down_id in ($poIds) and a.fabric_color_id=$color and a.status_active =1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");


    foreach ($short_sql as $val) 
    {
        $short_arr[$val['BODY_PART_TYPE']][$val['DETERMINATION_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][$val['UOM']]['SHORT_FINISH']+=$val['FIN_FAB_QNTY']; 
        $short_arr[$val['BODY_PART_TYPE']][$val['DETERMINATION_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][$val['UOM']]['SHORT_GREY']+=$val['GREY_FAB_QNTY']; 

        $desc_str = $val['DETERMINATION_ID']."*".$val['GSM_WEIGHT']."*".$val['DIA_WIDTH']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }

       $main_arr[$type_name][$desc_str]['SHORT_FINISH']+=$val['FIN_FAB_QNTY'];
       $main_arr[$type_name][$desc_str]['SHORT_GREY']+=$val['GREY_FAB_QNTY'];
    }

    $grey_sql = sql_select("SELECT d.job_no_mst as JOB_NO, a.quantity as QUANTITY, b.color_id as COLOR_ID, b.gsm as GSM, b.width as WIDTH, b.uom as UOM, b.febric_description_id as FEBRIC_DESCRIPTION_ID, b.body_part_id as BODY_PART_ID, c.body_part_type as BODY_PART_TYPE from order_wise_pro_details a, pro_grey_prod_entry_dtls b left join lib_body_part c on b.body_part_id = c.id, wo_po_break_down d where a.dtls_id=b.id and a.trans_id=b.trans_id and A.PO_BREAKDOWN_ID=d.id and a.entry_form in (2,22,58) and a.trans_id >0 and a.po_breakdown_id in ($poIds) and b.color_id=to_char($color) and a.is_sales=0 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted=0");

    foreach ($grey_sql as $val) 
    {
       $grey_arr[$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['GSM']][$val['WIDTH']][$val['UOM']]['GREY_QTY'] += $val['QUANTITY'];
    }

    if($db_type==0) {
        $ext_cond = " and (a.extention_no=0 or a.extention_no='')";
    } else {
        $ext_cond = " and (a.extention_no=0 or a.extention_no is null)";
    }
    
    $batch_sql = sql_select("SELECT a.batch_no, d.job_no_mst as JOB_NO,a.color_id as COLOR_ID, b.batch_qnty as BATCH_QNTY,c.gsm as GSM, c.dia_width as DIA_WIDTH, c.detarmination_id as DETARMINATION_ID, b.body_part_id as BODY_PART_ID, e.body_part_type as BODY_PART_TYPE, c.unit_of_measure as UOM from pro_batch_create_mst a, pro_batch_create_dtls b left join lib_body_part e on b.body_part_id = e.id, product_details_master c, wo_po_break_down d, wo_booking_mst f  where a.id=b.mst_id and b.prod_id=c.id and b.po_id=d.id and a.booking_no=f.booking_no and f.fabric_source=1 $ext_cond and b.po_id in ($poIds) and b.is_sales =0 and a.color_id=$color and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

    foreach ($batch_sql as $val) 
    {
       $batch_arr[$val['BODY_PART_TYPE']][$val['DETARMINATION_ID']][$val['GSM']][$val['DIA_WIDTH']][$val['UOM']] +=$val['BATCH_QNTY'];

       $desc_str = $val['DETARMINATION_ID']."*".$val['GSM']."*".$val['DIA_WIDTH']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }

       $main_arr[$type_name][$desc_str]['BATCH_QTY']+=$val['BATCH_QNTY'];
    }

    //$finish_sql = sql_select("select c.job_no_mst as JOB_NO, a.color_id as COLOR_ID, b.body_part_id as BODY_PART_ID, d.body_part_type as BODY_PART_TYPE, b.gsm as GSM, b.width as WIDTH, b.fabric_description_id as FABRIC_DESCRIPTION_ID, a.entry_form as ENTRY_FORM, a.trans_id as TRANS_ID, a.returnable_qnty as REJECT_QTY, a.quantity as QUANTITY, b.uom as UOM from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join lib_body_part d on b.body_part_id = d.id, wo_po_break_down c, pro_batch_create_mst e, wo_booking_mst f where a.dtls_id=b.id and a.po_breakdown_id=c.id and b.batch_id=e.id and e.booking_no=f.booking_no and f.fabric_source=1 and a.entry_form in (7,37,52) and a.po_breakdown_id in ($poIds) and a.color_id=$color and a.is_sales=0 and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0");

    $finish_sql = sql_select("SELECT c.job_no_mst as JOB_NO, a.color_id as COLOR_ID, b.body_part_id as BODY_PART_ID, d.body_part_type as BODY_PART_TYPE, b.gsm as GSM, b.width as WIDTH, b.fabric_description_id as FABRIC_DESCRIPTION_ID, a.entry_form as ENTRY_FORM, a.trans_id as TRANS_ID, a.returnable_qnty as REJECT_QTY, a.quantity as QUANTITY, b.uom as UOM, g.store_id as STORE_ID,f.fabric_source from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join lib_body_part d on b.body_part_id = d.id, inv_transaction g,  wo_po_break_down c, pro_batch_create_mst e, wo_booking_mst f where a.dtls_id=b.id and b.trans_id = g.id and a.po_breakdown_id=c.id and b.batch_id=e.id and e.booking_no=f.booking_no and a.entry_form in (7,37) and a.po_breakdown_id in ($poIds) and a.color_id=$color and a.is_sales=0 and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0  AND g.store_id IN (46, 16, 47, 14) AND g.transaction_type = 1");

    foreach ($finish_sql as $val) 
    {

        //if($val['STORE_ID'] == 16 || $val['STORE_ID'] == 14)    
        //if($text_cond_store_id_or)
        if(eval("return $text_cond_store_id_or;"))
        {
            if($val['FABRIC_SOURCE']!=2)
            {
                $desc_str = $val['FABRIC_DESCRIPTION_ID']."*".$val['GSM']."*".$val['WIDTH']."*".$val['UOM'];
                if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
                {
                    $type_name = 'FLAT';
                }
                else
                {
                    $type_name = 'CIRCULAR';
                }

                $main_arr[$type_name][$desc_str]['FINISH_QTY'] += $val['QUANTITY'];
                $main_arr[$type_name][$desc_str]['REJECT_QTY'] += $val['REJECT_QTY'];

                // $finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FABRIC_DESCRIPTION_ID']][$val['GSM']][$val['WIDTH']][$val['UOM']]['RECEIVE'] += $val['QUANTITY'];
                // $finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FABRIC_DESCRIPTION_ID']][$val['GSM']][$val['WIDTH']][$val['UOM']]['REJECT'] += $val['REJECT_QTY'];
            }
        }
    }

    $finish_issue_return = sql_select("SELECT c.job_no_mst as JOB_NO, a.color_id as COLOR_ID, b.body_part_id as BODY_PART_ID, d.body_part_type as BODY_PART_TYPE, b.gsm as GSM, b.width as WIDTH, b.fabric_description_id as FABRIC_DESCRIPTION_ID, a.entry_form as ENTRY_FORM, a.trans_id as TRANS_ID, a.returnable_qnty as REJECT_QTY, a.quantity as QUANTITY, b.uom as UOM, g.store_id as STORE_ID from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join lib_body_part d on b.body_part_id = d.id, inv_transaction g,  wo_po_break_down c, pro_batch_create_mst e, wo_booking_mst f where a.trans_id=b.trans_id and b.trans_id=g.id and a.po_breakdown_id=c.id and b.batch_id=e.id and e.booking_no=f.booking_no and f.fabric_source=1 and a.entry_form in (52) and a.po_breakdown_id in ($poIds) and a.color_id=$color and a.is_sales=0 and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0");

    foreach ($finish_issue_return as $val) 
    {
        //if($val['STORE_ID'] != 16 && $val['STORE_ID'] != 14)
        //if($text_cond_store_id_and)
        if(eval("return $text_cond_store_id_and;"))
        {
            $desc_str = $val['FABRIC_DESCRIPTION_ID']."*".$val['GSM']."*".$val['WIDTH']."*".$val['UOM'];
            if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
            {
                $type_name = 'FLAT';
            }
            else
            {
                $type_name = 'CIRCULAR';
            }

            $main_arr[$type_name][$desc_str]['ISSUE_RET_QTY'] += $val['QUANTITY'];
            
            // $finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FABRIC_DESCRIPTION_ID']][$val['GSM']][$val['WIDTH']][$val['UOM']]['ISSUE_RETURN'] += $val['QUANTITY'];
        }
    }

    $trans_sql = sql_select("SELECT b.job_no_mst as JOB_NO, a.color_id as COLOR_ID, e.body_part_type as BODY_PART_TYPE, d.detarmination_id as DETER_ID, d.gsm as GSM, d.dia_width as DIA, d.unit_of_measure as UOM, a.trans_type as TRANS_TYPE, a.quantity as QUANTITY, c.id as TRANS_ID, h.from_store as FROM_STORE, h.to_store as TO_STORE,i.transfer_criteria from order_wise_pro_details a, wo_po_break_down b, inv_transaction c left join lib_body_part e on c.body_part_id=e.id, inv_item_transfer_dtls h, product_details_master d, pro_batch_create_mst f, wo_booking_mst g,inv_item_transfer_mst i where i.id=h.mst_id and i.transfer_criteria in(2,4) and a.po_breakdown_id =b.id and a.trans_id = c.id and a.dtls_id = h.id  and c.prod_id=d.id and c.pi_wo_batch_no=f.id and f.booking_no=g.booking_no  and a.entry_form in (14) and a.po_breakdown_id in ($poIds) and a.color_id=$color and a.status_active =1 and a.is_deleted=0 AND a.po_breakdown_id <> 0 and g.fabric_source!=2");// 

    foreach ($trans_sql as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }

        if($val['TRANSFER_CRITERIA']==4)
        {
            if($val['TRANS_TYPE']==5)
            {                
                $main_arr[$type_name][$desc_str]['TRANS_IN'] += $val['QUANTITY'];
            }
            else
            {
                $main_arr[$type_name][$desc_str]['TRANS_OUT'] += $val['QUANTITY'];
            }
        }
        else // store to store
        {
            if($val['FROM_STORE'] != $val['TO_STORE'])
            {
                if($val['TRANS_TYPE']==5)
                {
                    if(($val['FROM_STORE']==16 || $val['FROM_STORE']==46 || $val['FROM_STORE']==14 || $val['FROM_STORE']==47) && ($val['TO_STORE']==8 || $val['TO_STORE']==20 || $val['TO_STORE']==32 || $val['TO_STORE']==52))  
                    {
                        $main_arr[$type_name][$desc_str]['TRANSIN'] += $val['QUANTITY'];
                    }
                }
                else
                {
                    $main_arr[$type_name][$desc_str]['TRANSOUT'] += $val['QUANTITY'];
                }
            }

        }
        
        
    }

    // echo "<pre>";print_r($main_arr);

    $issue_sql = sql_select("SELECT d.job_no_mst as JOB_NO, a.quantity as QUANTITY, e.body_part_type as BODY_PART_TYPE, c.gsm as GSM, c.detarmination_id as DETER_ID, c.dia_width as DIA, c.unit_of_measure as UOM, b.store_id as STORE_ID from order_wise_pro_details a, inv_finish_fabric_issue_dtls b left join lib_body_part e on b.body_part_id=e.id, product_details_master c, wo_po_break_down d, pro_batch_create_mst f, wo_booking_mst g, inv_issue_master h where  h.id=b.mst_id  and a.trans_id=b.trans_id and b.prod_id= c.id and a.po_breakdown_id= d.id and b.batch_id=f.id and f.booking_no=g.booking_no  and a.entry_form in(18) and a.po_breakdown_id in ($poIds) and a.color_id=$color and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and g.fabric_source!=2 and a.trans_id<>0");//and g.fabric_source=1

    foreach ($issue_sql as $val) 
    {
        //if($val['STORE_ID'] != 16 && $val['FROM_STORE'] != 14)
        //if($text_cond_store_id_and)
        if(eval("return $text_cond_store_id_and;"))
        {
            $desc_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA']."*".$val['UOM'];
            if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
            {
                $type_name = 'FLAT';
            }
            else
            {
                $type_name = 'CIRCULAR';
            }
            $main_arr[$type_name][$desc_str]['ISSUE']+= $val['QUANTITY'];
            // $issue_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']] += $val['QUANTITY'];
        }
    }

    //echo "<pre>";
    //print_r($issue_arr);//die;

    // ============================= get gmts color qty ==============================
    // if($is_contrust_color!=1)
    // {
        
        $sql = "SELECT a.job_no as JOB_NO, a.color_number_id as COLOR_ID, b.lib_yarn_count_deter_id as DETER_ID, b.uom as UOM,b.gsm_weight as GSM, a.dia_width as DIA, b.body_part_type as BODY_PART_TYPE from wo_pre_cos_fab_co_avg_con_dtls a, wo_pre_cost_fabric_cost_dtls b  where a.pre_cost_fabric_cost_dtls_id =b.id and a.job_no ='$job_number' and a.color_number_id = $color and b.fabric_source=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.job_no, a.color_number_id, b.lib_yarn_count_deter_id, b.uom,b.gsm_weight, a.dia_width, b.body_part_type order by b.body_part_type, b.lib_yarn_count_deter_id";
    

        // echo $sql;die();
        $res = sql_select($sql);

        
        foreach ($res as  $val) 
        {
            $desc_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA']."*".$val['UOM'];
            if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
            {
                $type_name = 'FLAT';
            }
            else
            {
                $type_name = 'CIRCULAR';
            }

            // $main_arr[$type_name][$desc_str]['SHORT_FINISH'] += $short_arr[$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['SHORT_FINISH'];
            // $main_arr[$type_name][$desc_str]['SHORT_GREY']   += $short_arr[$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['SHORT_GREY'];

            $main_arr[$type_name][$desc_str]['COLOR_ID'] = $val['COLOR_ID'];
            $main_arr[$type_name][$desc_str]['body_part_type'] = $val['BODY_PART_TYPE'];

            $main_arr[$type_name][$desc_str]['FAB_KNIT_GREY'] += $fabric_costing_arr['knit']['grey'][$val['JOB_NO']][$val['COLOR_ID']][''][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];

            $main_arr[$type_name][$desc_str]['FAB_KNIT_FINISH'] += $fabric_costing_arr['knit']['finish'][$val['JOB_NO']][$val['COLOR_ID']][''][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];
            $main_arr[$type_name][$desc_str]['FAB_WOVEN_GREY'] += $fabric_costing_arr['woven']['grey'][$val['JOB_NO']][$val['COLOR_ID']][''][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];
            $main_arr[$type_name][$desc_str]['FAB_WOVEN_FINISH'] += $fabric_costing_arr['woven']['finish'][$val['JOB_NO']][$val['COLOR_ID']][''][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];

            // $main_arr[$type_name][$desc_str]['GREY_QTY'] += $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['GREY_QTY'];

            // $main_arr[$type_name][$desc_str]['BATCH_QTY'] += $batch_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
            // $main_arr[$type_name][$desc_str]['FINISH_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['RECEIVE'];
            // $main_arr[$type_name][$desc_str]['ISSUE_RET_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['ISSUE_RETURN'];
            // $main_arr[$type_name][$desc_str]['REJECT_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['REJECT'];
            // $main_arr[$type_name][$desc_str]['TRANS_IN'] += $trans_in_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
            // $main_arr[$type_name][$desc_str]['TRANS_OUT'] += $trans_out_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
            // $main_arr[$type_name][$desc_str]['ISSUE'] += $issue_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
        }
    // }

     // ============================= get contrust color qty ==============================
    // if($is_contrust_color==1)
    // {
        $sql = "SELECT a.job_no as JOB_NO, a.color_number_id as COLOR_ID, b.lib_yarn_count_deter_id as DETER_ID, b.uom as UOM,b.gsm_weight as GSM, a.dia_width as DIA, b.body_part_type as BODY_PART_TYPE ,b.COLOR_SIZE_SENSITIVE,c.CONTRAST_COLOR_ID
        from wo_pre_cos_fab_co_avg_con_dtls a, wo_pre_cost_fabric_cost_dtls b LEFT JOIN wo_pre_cos_fab_co_color_dtls c ON b.job_no = c.job_no and b.id=c.pre_cost_fabric_cost_dtls_id  AND c.status_active = 1
        AND c.is_deleted = 0 where a.pre_cost_fabric_cost_dtls_id =b.id and a.job_no ='$job_number' and b.fabric_source=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.contrast_color_id=$color
        group by a.job_no, a.color_number_id, b.lib_yarn_count_deter_id, b.uom,b.gsm_weight, a.dia_width, b.body_part_type,b.color_size_sensitive,c.contrast_color_id 
        order by b.body_part_type, b.lib_yarn_count_deter_id";

        // echo $sql;die;
        $res = sql_select($sql);
        foreach ($res as  $val) 
        {
            $desc_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA']."*".$val['UOM'];
            if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
            {
                $type_name = 'FLAT';
            }
            else
            {
                $type_name = 'CIRCULAR';
            }

            $main_arr[$type_name][$desc_str]['SHORT_FINISH'] += $short_arr[$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['SHORT_FINISH'];
            $main_arr[$type_name][$desc_str]['SHORT_GREY']   += $short_arr[$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['SHORT_GREY'];

            $main_arr[$type_name][$desc_str]['COLOR_ID'] = $val['COLOR_ID'];
            $main_arr[$type_name][$desc_str]['body_part_type'] = $val['BODY_PART_TYPE'];

            $main_arr[$type_name][$desc_str]['FAB_KNIT_GREY'] += $fabric_costing_arr['knit']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];
            $main_arr[$type_name][$desc_str]['FAB_KNIT_FINISH'] += $fabric_costing_arr['knit']['finish'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];
            $main_arr[$type_name][$desc_str]['FAB_WOVEN_GREY'] += $fabric_costing_arr['woven']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];
            $main_arr[$type_name][$desc_str]['FAB_WOVEN_FINISH'] += $fabric_costing_arr['woven']['finish'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];   

            // $main_arr[$type_name][$desc_str]['GREY_QTY'] += $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['GREY_QTY'];
            // $main_arr[$type_name][$desc_str]['BATCH_QTY'] += $batch_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
            // $main_arr[$type_name][$desc_str]['FINISH_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['RECEIVE'];
            // $main_arr[$type_name][$desc_str]['ISSUE_RET_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['ISSUE_RETURN'];
            // $main_arr[$type_name][$desc_str]['REJECT_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['REJECT'];
            // $main_arr[$type_name][$desc_str]['TRANS_IN'] += $trans_in_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
            // $main_arr[$type_name][$desc_str]['TRANS_OUT'] += $trans_out_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
            // $main_arr[$type_name][$desc_str]['ISSUE'] += $issue_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];  
        }
    // }
    
    // echo "<pre>";print_r($main_arr);die();
    $constructtion_arr=array();
    $sql_deter="SELECT a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id order by b.id asc";
    $data_array_deter=sql_select($sql_deter);
    foreach( $data_array_deter as $row )
    {
        $constructtion_arr[$row[csf('id')]]=$row[csf('construction')];
        $composition_arr[$row[csf('id')]].=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ";
      
    }
    unset($data_array_deter);



    // ========================== outbound dyeing data ==============================
    $sqlDye = "SELECT f.job_no_mst as job_no,d.color_id,b.GSM,b.WIDTH,b.UOM,b.fabric_description_id,e.fabric_source,b.grey_used_qty as QTY,g.body_part_type as BODY_PART_TYPE from inv_receive_master a,order_wise_pro_details c,pro_batch_create_mst d,wo_booking_mst e,wo_po_break_down f,pro_finish_fabric_rcv_dtls b left join lib_body_part g on b.body_part_id=g.id where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 and c.po_breakdown_id in($poIds) and d.color_id=$color and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(37) and c.entry_form in(37) and a.item_category=2 and a.receive_basis=11 and d.booking_no=e.booking_no and d.id=b.batch_id and f.id=c.po_breakdown_id";
        // echo $sqlDye;die();
        $dyeRes = sql_select($sqlDye);
        $outbound_dyeing_data_array = array();
        foreach ($dyeRes as $val) 
        {   
            $desc_str = $val['FABRIC_DESCRIPTION_ID']."*".$val['GSM']."*".$val['WIDTH']."*".$val['UOM'];
            if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
            {
                $type_name = 'FLAT';
            }
            else
            {
                $type_name = 'CIRCULAR';
            }
            $outbound_dyeing_data_array[$type_name][$desc_str]+= $val['QTY'];
        }
        // echo "<pre>";print_r($outbound_dyeing_data_array);die();

    $acting_width = $screen_size-10;
    $three_percent = $acting_width*0.03;
    $four_percent = $acting_width*0.04;
    $five_percent = $acting_width*0.05;
    $six_percent = $acting_width*0.06;
    $seven_percent = $acting_width*0.07;
    
    

    $rowspan = array();
    foreach ($main_arr as $type => $type_data) 
    {
        foreach ($type_data as $dSrt => $val) 
        {
            if($val['SHORT_FINISH']>0 || $val['GREY_QTY']>0 || $val['BATCH_QTY']>0 || $val['FINISH_QTY']>0 || $val['TRANSIN']>0 || $val['TRANS_IN']>0 || $val['TRANS_OUT']>0)
            {
                $rowspan[$type]++;
            }
           
        }
    }
    //echo $count_deter_data;
    
    $add= 220;
    //echo $add;
    //echo "<pre>";print_r($rowspan);die();
    ?>
    <style type="text/css">
        .word_break_wrap{
            word-wrap: break-word;
            word-break: break-all;
        }
    </style>
        <div class="main" style="width: <? echo $acting_width;?>px;" id="details_reports">
        <div class="header_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width+$add;?>">
                <caption style="font-size:20px;"><b>Color Info</b></caption>
                <thead>                             
                    <tr>
                        <th>Color:</th>
                        <th colspan="12"><? echo $lib_color[$color];?></th>
                        <th colspan="7">Textile Store</th>
                        <th colspan="7">Garments Store</th>
                    </tr>
                    <tr>
                        <th width="<?  echo $five_percent;?>">Knit Type</th>
                        <th width="<? echo $seven_percent+$add;?>">Structure</th>
                        <th width="<? echo $three_percent;?>">GSM</th>
                        <th width="<? echo $three_percent;?>">F. Dia</th>
                        <th width="<? echo $three_percent;?>">Unit</th>
                        <th width="<? echo $three_percent;?>">Finish Req</th>
                        <th width="<? echo $three_percent;?>">Ex Req</th>
                        <th width="<? echo $three_percent;?>">Gray Req</th>
                        <th width="<? echo $three_percent;?>">PL %</th>
                        <th width="<? echo $three_percent;?>">Gray Rcv</th>
                        <th width="<? echo $three_percent;?>">Gray Bal</th>
                        <th width="<? echo $three_percent;?>">Batch Qty</th>
                        <th width="<? echo $three_percent;?>">Batch Bal</th>
                        <th width="<? echo $three_percent;?>">Ok Rcvd</th>
                        <th width="<? echo $three_percent;?>">Rej Rcvd</th>
                        <th width="<? echo $three_percent;?>">Rcv bal</th>
                        <th width="<? echo $three_percent;?>">Ok Stock</th>
                        <th width="<? echo $three_percent;?>">Rej Stock</th>
                        <th width="<? echo $three_percent;?>">Ok Rcv Del</th>
                        <th width="<? echo $three_percent;?>">Del Bal</th>
                        <th width="<? echo $three_percent;?>">Trans In</th>
                        <th width="<? echo $three_percent;?>">Net Issue</th>
                        <th width="<? echo $three_percent;?>">Trans Out</th>
                        <th width="<? echo $three_percent;?>">Rej Issue</th>
                        <th width="<? echo $three_percent;?>">Ok Stock</th>
                        <th width="<? echo $three_percent;?>">Rej Stock</th>
                        <th width="<? echo $three_percent;?>">Issue Bal</th>                        
                    </tr>
                </thead>
            </table>
            <div style="width:<? echo $acting_width+18+$add;?>px; max-height:240px;overflow-y:scroll;" id="scroll_body">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width+$add;?>">
                <tbody>
                    <?
                    $i=0;
                    foreach ($main_arr as $type => $type_data) 
                    {
                        $y=1;
                        foreach ($type_data as $dSrt => $val) 
                        {
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF";
                            $dSrt_data = explode("*", $dSrt);
                            $DETER_ID = $dSrt_data[0];
                            $GSM = $dSrt_data[1];
                            $DIA = $dSrt_data[2];
                            $UOM = $dSrt_data[3];

                            $grey_qty = $grey_arr[$val['body_part_type']][$DETER_ID][$GSM][$DIA][$UOM]['GREY_QTY'];
                            $batch_qty = $batch_arr[$val['body_part_type']][$DETER_ID][$GSM][$DIA][$UOM];
                            
                            $grey_required = $val['FAB_KNIT_GREY'] + $val['FAB_WOVEN_GREY'];
                            $finish_required = $val['FAB_KNIT_FINISH'] + $val['FAB_WOVEN_FINISH'];
                            $grey_requ_with_addi = $grey_required + $val['SHORT_GREY'];
                            if($grey_requ_with_addi >0)
                            {
                                $pl_percentage = ($grey_requ_with_addi - ($finish_required +$val['SHORT_FINISH']))/$grey_requ_with_addi*100;
                            }else{
                                $pl_percentage =0;
                            }
                            $gray_balance = $grey_requ_with_addi - $grey_qty;
                            //$batch_balance = $grey_qty - $batch_qty;
                            $batch_balance = $grey_requ_with_addi - $batch_qty;//CHANGED BY MOSHIUR
                            $receive_balance = ($finish_required + $val['SHORT_FINISH'] )- $val['FINISH_QTY'];
                            
                            $text_del_bal = ($finish_required+$val['SHORT_FINISH']) -  $val['TRANSIN'];
                            
                            $text_okay_stock_bal =$val['FINISH_QTY'] - $val['TRANSIN'];
                            $garments_issue = $val['ISSUE'] - $val['ISSUE_RET_QTY'];// + $val['TRANSOUT'];
                            $issue_title = "FF Issue=".$val['ISSUE']." - Issue Return=".$val['ISSUE_RET_QTY'];

                            $stock = ($ff_received_garments+$trans_in) - ($ff_issued_garments+$trans_out);

                            // $garments_okay_stock_bal = ($val['TRANSIN'] + $val['TRANS_IN'] + $val['ISSUE_RET_QTY']) - ($val['ISSUE']+ $val['TRANS_OUT']);
                            $garments_okay_stock_bal = ($val['TRANSIN'] + $val['TRANS_IN']) - ($val['ISSUE']+ $val['TRANS_OUT']);

                            $issue_balance = ($finish_required+$val['SHORT_FINISH']) - $val['ISSUE'];

                            $outbound_dyeing_qty = $outbound_dyeing_data_array[$type][$dSrt];

                            if($val['SHORT_FINISH']>0 || $grey_qty>0 || $batch_qty>0 || $val['FINISH_QTY']>0 || $val['TRANSIN']>0 || $val['TRANS_IN']>0 || $val['TRANS_OUT']>0)
                            {
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                    <?
                                    if($y==1)
                                    {
                                        ?>
                                        <td width="<? echo $five_percent;?>" rowspan="<? echo $rowspan[$type];?>"><? echo $type;?></td>
                                        <?
                                    } 
                                    ?>                              
                                    <td width="<? echo $seven_percent+$add;?>" align="left"><p class="word_break_wrap"><? echo $constructtion_arr[$DETER_ID].", ".$composition_arr[$DETER_ID];?></p></td>
                                    <td width="<? echo $three_percent;?>" align="center"><? echo $GSM;?></td>
                                    <td width="<? echo $three_percent;?>" align="center"><? echo $DIA;?></td>
                                    <td width="<? echo $three_percent;?>" align="center"><? echo $unit_of_measurement[$UOM];?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($finish_required,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($val['SHORT_FINISH'],0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($grey_requ_with_addi,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($pl_percentage,2);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($grey_qty,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gray_balance);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format(($batch_qty+$outbound_dyeing_qty),0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($batch_balance);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($val['FINISH_QTY'],0) ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($val['REJECT_QTY'],0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($receive_balance,0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($text_okay_stock_bal);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($val['REJECT_QTY'],0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($val['TRANSIN'],0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($text_del_bal,0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right">&nbsp;<?=fn_number_format($val['TRANS_IN'],0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right" title="<?=$issue_title;?>"><? echo fn_number_format($garments_issue/*$val['ISSUE']*/,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right">&nbsp;<?=fn_number_format($val['TRANS_OUT'],0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right">&nbsp;<??></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($garments_okay_stock_bal,0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right">&nbsp;<??></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($issue_balance,0); ?></td>
                                </tr>
                                <?
                                $i++; 
                                $y++;
                                $tot_finish_required += $finish_required;
                                $tot_ex_finish += $val['SHORT_FINISH'];
                                $tot_grey_requ_with_addi += $grey_requ_with_addi;
                                $tot_grey_qty += $grey_qty;
                                $tot_gray_balance += $gray_balance;
                                $tot_batch_qty += $batch_qty+$outbound_dyeing_qty;
                                $tot_batch_balance += $batch_balance;
                                $tot_finish_rcv += $val['FINISH_QTY'];
                                $tot_reject_qty += $val['REJECT_QTY'];
                                $tot_receive_balance += $receive_balance;
                                $tot_text_okay_stock_bal += $text_okay_stock_bal;
                                $tot_text_del_bal += $text_del_bal;
                                $tot_issue += $garments_issue;//$val['ISSUE'];
                                $tot_garments_okay_stock_bal += $garments_okay_stock_bal;
                                $tot_issue_balance += $issue_balance;
                                $tot_txt_ok_recv_del += $val['TRANSIN'];
                                $tot_trans_in += $val['TRANS_IN'];
                                $tot_trans_out += $val['TRANS_OUT'];

                                $gr_finish_required += $finish_required;
                                $gr_ex_finish += $val['SHORT_FINISH'];
                                $gr_grey_requ_with_addi += $grey_requ_with_addi;
                                $gr_grey_qty += $grey_qty;
                                $gr_gray_balance += $gray_balance;
                                $gr_batch_qty += $batch_qty+$outbound_dyeing_qty;
                                $gr_batch_balance += $batch_balance;
                                $gr_finish_rcv += $val['FINISH_QTY'];
                                $gr_reject_qty += $val['REJECT_QTY'];
                                $gr_receive_balance += $receive_balance;
                                $gr_text_okay_stock_bal += $text_okay_stock_bal;
                                $gr_text_del_bal += $text_del_bal;
                                $gr_issue += $garments_issue;//$val['ISSUE'];
                                $gr_garments_okay_stock_bal += $garments_okay_stock_bal;
                                $gr_issue_balance += $issue_balance;
                                $gr_txt_ok_recv_del += $val['TRANSIN'];
                                $gr_trans_in += $val['TRANS_IN'];
                                $gr_trans_out += $val['TRANS_OUT'];

                            }
                            if($tot_grey_requ_with_addi >0){
                                $tot_pl_percentage = ($tot_grey_requ_with_addi - ($tot_finish_required+$tot_ex_finish))/$tot_grey_requ_with_addi*100;
                            }else{
                                $tot_pl_percentage =0;
                            }
                        }
                        ?>
                        
                        
                        <tr class="tbl_footer" style="background: #cddcdc">
                            <th width="<? echo $five_percent;?>" align="center"><? //echo $DETER_ID;?></th>
                            <th width="<? echo $seven_percent;?>" align="center"><? //echo $DETER_ID;?></th>
                            <th width="<? echo $three_percent;?>" align="center"><? //echo $GSM;?></th>
                            <th width="<? echo $three_percent;?>" align="center">Total:<? //echo $DIA;?></th>
                            <th width="<? echo $three_percent;?>" align="center"><? //echo $unit_of_measurement[$UOM];?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_finish_required,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_ex_finish,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_grey_requ_with_addi,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_pl_percentage,2);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_grey_qty,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_gray_balance);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_batch_qty,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_batch_balance);?></th>

                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_finish_rcv,0) ?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_reject_qty,0); ?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_receive_balance,0); ?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_text_okay_stock_bal);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_reject_qty,0); ?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_txt_ok_recv_del,0); ?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_text_del_bal,0); ?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_trans_in,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_issue,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_trans_out,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right">&nbsp;<??></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_garments_okay_stock_bal,0); ?></th>
                            <th width="<? echo $three_percent;?>" align="right">&nbsp;<??></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_issue_balance,0); ?></th>
                        </tr>
                    </tbody>
                    <?
                    $tot_finish_required=$tot_ex_finish=$tot_grey_requ_with_addi=$tot_pl_percentage=$tot_grey_qty=$tot_gray_balance=$tot_batch_qty=$tot_batch_balance=$tot_finish_rcv=$tot_reject_qty=$tot_receive_balance=$tot_text_okay_stock_bal=$tot_text_del_bal=$tot_issue=$tot_garments_okay_stock_bal=$tot_issue_balance=$tot_txt_ok_recv_del=0;
                }
                ?>
                <tfoot>
                    <tr class="tbl_footer" style="background: #cddcdc">
                        <th width="<? echo $five_percent;?>" align="center"><? //echo $DETER_ID;?></th>
                        <th width="<? echo $seven_percent;?>" align="center"><? //echo $DETER_ID;?></th>
                        <th width="<? echo $three_percent;?>" align="center"><? //echo $GSM;?></th>
                        <th width="<? echo $three_percent;?>" align="center">G.Total:<? //echo $DIA;?></th>
                        <th width="<? echo $three_percent;?>" align="center"><? //echo $unit_of_measurement[$UOM];?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_finish_required,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_ex_finish,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_grey_requ_with_addi,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_pl_percentage,2);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_grey_qty,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_gray_balance);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_batch_qty,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_batch_balance);?></th>

                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_finish_rcv,0) ?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_reject_qty,0); ?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_receive_balance,0); ?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_text_okay_stock_bal);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_reject_qty,0); ?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_txt_ok_recv_del,0); ?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_text_del_bal,0); ?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_trans_in,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_issue,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_trans_out,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right">&nbsp;<??></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_garments_okay_stock_bal,0); ?></th>
                        <th width="<? echo $three_percent;?>" align="right">&nbsp;<??></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_issue_balance,0); ?></th>
                    </tr>
                </tfoot>    
            </table>
            </div>
        </div> 
    <?
}

if($action == "finish_color_popup_bk")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    extract($_REQUEST);
    list($color, $poIds, $job_number,$is_contrust_color) = explode("*",$data);
    // echo "string".$is_contrust_color;
    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();
    //$costPerArr=$condition->getCostingPerArr();
    $fabric= new fabric($condition);
    //echo $fabric->getQuery();die;
    // $fabric_costing_arr=$fabric->getQtyArray_by_JobColorBodyTypeDeterminIdGsmAndDiaWidth_knitAndwoven_greyAndfinish();
    $fabric_costing_arr=$fabric->getQtyArray_by_JobColorFabricColorBodyTypeDeterminIdGsmAndDiaWidth_knitAndwoven_greyAndfinish();
    // echo "<pre>";print_r($fabric_costing_arr);die();
    // echo "<pre>";print_r($fabric_costing_arr[knit][finish]['FAL-21-00425']);die();
    $main_arr = array();
    /* foreach ($fabric_costing_arr as  $gmt_nature => $gmt_nature_data) 
    {
        foreach ($gmt_nature_data as $fab_type => $fab_type_data) 
        {
            foreach ($fab_type_data as $job_key => $job_data) 
            {
                foreach ($job_data as $color_id => $color_data) 
                {
                    foreach ($color_data as $con_color_id => $con_color_data) 
                    {
                        foreach ($con_color_data as $bpart_id => $bpart_data) 
                        {
                            foreach ($bpart_data as $dtr_id => $dtr_data) 
                            {
                                foreach ($dtr_data as $gsm_key => $gsm_data) 
                                {
                                    foreach ($gsm_data as $dia_key => $dia_data) 
                                    {
                                        foreach ($dia_data as $type_id => $type_data) 
                                        {
                                            foreach ($type_data as $uom_id => $val) 
                                            {
                                                $desc_str = $dtr_id."*".$gsm_key."*".$dia_key."*".$uom_id;
                                                if($bpart_id == 40 || $bpart_id == 50) 
                                                {
                                                    $type_name = 'FLAT';
                                                }
                                                else
                                                {
                                                    $type_name = 'CIRCULAR';
                                                }
                                                // echo $is_contrust_color."<br>";
                                               
                                                // echo $color."==".$con_color_id."<br>";
                                                if($color==$con_color_id || $color==$color_id)
                                                {
                                                    // $main_arr[$type_name][$desc_str]['COLOR_ID'] = $con_color_id;

                                                    $main_arr[$type_name][$desc_str]['FAB_KNIT_GREY'] += $fabric_costing_arr['knit']['grey'][$job_key][$color_id][$con_color_id][$bpart_id][$dtr_id][$gsm_key][$dia_key][1][$uom_id];
                                                    $main_arr[$type_name][$desc_str]['FAB_KNIT_FINISH'] += $fabric_costing_arr['knit']['finish'][$job_key][$color_id][$con_color_id][$bpart_id][$dtr_id][$gsm_key][$dia_key][1][$uom_id];
                                                    $main_arr[$type_name][$desc_str]['FAB_WOVEN_GREY'] += $fabric_costing_arr['woven']['grey'][$job_key][$color_id][$con_color_id][$bpart_id][$dtr_id][$gsm_key][$dia_key][1][$uom_id];
                                                    $main_arr[$type_name][$desc_str]['FAB_WOVEN_FINISH'] += $fabric_costing_arr['woven']['finish'][$job_key][$color_id][$con_color_id][$bpart_id][$dtr_id][$gsm_key][$dia_key][1][$uom_id];
                                                }
                                              
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }  
    } */
    // echo "<pre>";print_r($main_arr);die;
    // library setup chk
    $text_store_sql = sql_select("select company_name as COMPANY_NAME, distribute_qnty as DISTRIBUTE_QNTY from variable_settings_production where variable_list=56 and status_active=1 and company_name=$COMPANY_NAME");
    if(empty($text_store_sql))
    {
        echo "Select Textile Store in Library setup";
        die;
    }
    $text_cond_from_store_or    = $text_cond_from_store_and ="";
    $text_cond_store_id_or      = $text_cond_store_id_and   ="";
    foreach ($text_store_sql as $row) 
    {
        $textile_store_arr[$row['COMPANY_NAME']] =$row["DISTRIBUTE_QNTY"];

        $text_cond_from_store_or .= ' $val["FROM_STORE"] == '.$row["DISTRIBUTE_QNTY"]. ' ||';
        $text_cond_from_store_and .= ' $val["FROM_STORE"] != '.$row["DISTRIBUTE_QNTY"]. ' &&';

        $text_cond_store_id_or .= ' $val["STORE_ID"] == '.$row["DISTRIBUTE_QNTY"]. ' ||';
        $text_cond_store_id_and .= ' $val["STORE_ID"] != '.$row["DISTRIBUTE_QNTY"]. ' &&';
    }
    $text_cond_from_store_or = chop($text_cond_from_store_or,'||'); $text_cond_from_store_and = chop($text_cond_from_store_and,'&&');
    $text_cond_store_id_or = chop($text_cond_store_id_or,'||'); $text_cond_store_id_and = chop($text_cond_store_id_and,'&&');

    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");

   
    $short_sql = sql_select("SELECT B.BODY_PART_TYPE, a.fin_fab_qnty as FIN_FAB_QNTY, a.grey_fab_qnty as GREY_FAB_QNTY, a.fabric_color_id as COLOR_ID, b.gsm_weight as GSM_WEIGHT, b.lib_yarn_count_deter_id as DETERMINATION_ID, a.dia_width as DIA_WIDTH, b.uom as UOM, b.job_no as JOB_NO from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b, wo_booking_mst c where a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no = c.booking_no and c.fabric_source=1 and a.is_short=1 and a.booking_type=1 and a.po_break_down_id in ($poIds) and a.fabric_color_id=$color and a.status_active =1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");


    foreach ($short_sql as $val) 
    {
        $short_arr[$val['BODY_PART_TYPE']][$val['DETERMINATION_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][$val['UOM']]['SHORT_FINISH']+=$val['FIN_FAB_QNTY']; 
        $short_arr[$val['BODY_PART_TYPE']][$val['DETERMINATION_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][$val['UOM']]['SHORT_GREY']+=$val['GREY_FAB_QNTY']; 

        $desc_str = $val['DETERMINATION_ID']."*".$val['GSM_WEIGHT']."*".$val['DIA_WIDTH']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }

       $main_arr[$type_name][$desc_str]['SHORT_FINISH']+=$val['FIN_FAB_QNTY'];
       $main_arr[$type_name][$desc_str]['SHORT_GREY']+=$val['GREY_FAB_QNTY'];
    }

    $grey_sql = sql_select("SELECT d.job_no_mst as JOB_NO, a.quantity as QUANTITY, b.color_id as COLOR_ID, b.gsm as GSM, b.width as WIDTH, b.uom as UOM, b.febric_description_id as FEBRIC_DESCRIPTION_ID, b.body_part_id as BODY_PART_ID, c.body_part_type as BODY_PART_TYPE from order_wise_pro_details a, pro_grey_prod_entry_dtls b left join lib_body_part c on b.body_part_id = c.id, wo_po_break_down d where a.dtls_id=b.id and a.trans_id=b.trans_id and A.PO_BREAKDOWN_ID=d.id and a.entry_form in (2,22,58) and a.trans_id >0 and a.po_breakdown_id in ($poIds) and b.color_id=to_char($color) and a.is_sales=0 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted=0");

    foreach ($grey_sql as $val) 
    {
       $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['GSM']][$val['WIDTH']][$val['UOM']]['GREY_QTY'] += $val['QUANTITY'];
    }

    if($db_type==0) {
        $ext_cond = " and (a.extention_no=0 or a.extention_no='')";
    } else {
        $ext_cond = " and (a.extention_no=0 or a.extention_no is null)";
    }
    
    $batch_sql = sql_select("SELECT a.batch_no, d.job_no_mst as JOB_NO,a.color_id as COLOR_ID, b.batch_qnty as BATCH_QNTY,c.gsm as GSM, c.dia_width as DIA_WIDTH, c.detarmination_id as DETARMINATION_ID, b.body_part_id as BODY_PART_ID, e.body_part_type as BODY_PART_TYPE, c.unit_of_measure as UOM from pro_batch_create_mst a, pro_batch_create_dtls b left join lib_body_part e on b.body_part_id = e.id, product_details_master c, wo_po_break_down d, wo_booking_mst f  where a.id=b.mst_id and b.prod_id=c.id and b.po_id=d.id and a.booking_no=f.booking_no and f.fabric_source=1 $ext_cond and b.po_id in ($poIds) and b.is_sales =0 and a.color_id=$color and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

    foreach ($batch_sql as $val) 
    {
       $batch_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETARMINATION_ID']][$val['GSM']][$val['DIA_WIDTH']][$val['UOM']] +=$val['BATCH_QNTY'];

       $desc_str = $val['DETARMINATION_ID']."*".$val['GSM']."*".$val['DIA_WIDTH']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }

       $main_arr[$type_name][$desc_str]['BATCH_QTY']+=$val['BATCH_QNTY'];
    }

    //$finish_sql = sql_select("select c.job_no_mst as JOB_NO, a.color_id as COLOR_ID, b.body_part_id as BODY_PART_ID, d.body_part_type as BODY_PART_TYPE, b.gsm as GSM, b.width as WIDTH, b.fabric_description_id as FABRIC_DESCRIPTION_ID, a.entry_form as ENTRY_FORM, a.trans_id as TRANS_ID, a.returnable_qnty as REJECT_QTY, a.quantity as QUANTITY, b.uom as UOM from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join lib_body_part d on b.body_part_id = d.id, wo_po_break_down c, pro_batch_create_mst e, wo_booking_mst f where a.dtls_id=b.id and a.po_breakdown_id=c.id and b.batch_id=e.id and e.booking_no=f.booking_no and f.fabric_source=1 and a.entry_form in (7,37,52) and a.po_breakdown_id in ($poIds) and a.color_id=$color and a.is_sales=0 and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0");

    $finish_sql = sql_select("SELECT c.job_no_mst as JOB_NO, a.color_id as COLOR_ID, b.body_part_id as BODY_PART_ID, d.body_part_type as BODY_PART_TYPE, b.gsm as GSM, b.width as WIDTH, b.fabric_description_id as FABRIC_DESCRIPTION_ID, a.entry_form as ENTRY_FORM, a.trans_id as TRANS_ID, a.returnable_qnty as REJECT_QTY, a.quantity as QUANTITY, b.uom as UOM, g.store_id as STORE_ID,f.fabric_source from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join lib_body_part d on b.body_part_id = d.id, inv_transaction g,  wo_po_break_down c, pro_batch_create_mst e, wo_booking_mst f where a.dtls_id=b.id and b.trans_id = g.id and a.po_breakdown_id=c.id and b.batch_id=e.id and e.booking_no=f.booking_no and a.entry_form in (7,37) and a.po_breakdown_id in ($poIds) and a.color_id=$color and a.is_sales=0 and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0  AND g.store_id IN (46, 16, 47, 14) AND g.transaction_type = 1");

    foreach ($finish_sql as $val) 
    {

        //if($val['STORE_ID'] == 16 || $val['STORE_ID'] == 14)    
        //if($text_cond_store_id_or)
        if(eval("return $text_cond_store_id_or;"))
        {
            if($val['FABRIC_SOURCE']!=2)
            {
                $desc_str = $val['FABRIC_DESCRIPTION_ID']."*".$val['GSM']."*".$val['WIDTH']."*".$val['UOM'];
                if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
                {
                    $type_name = 'FLAT';
                }
                else
                {
                    $type_name = 'CIRCULAR';
                }

                $main_arr[$type_name][$desc_str]['FINISH_QTY'] += $val['QUANTITY'];
                $main_arr[$type_name][$desc_str]['REJECT_QTY'] += $val['REJECT_QTY'];

                // $finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FABRIC_DESCRIPTION_ID']][$val['GSM']][$val['WIDTH']][$val['UOM']]['RECEIVE'] += $val['QUANTITY'];
                // $finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FABRIC_DESCRIPTION_ID']][$val['GSM']][$val['WIDTH']][$val['UOM']]['REJECT'] += $val['REJECT_QTY'];
            }
        }
    }

    $finish_issue_return = sql_select("SELECT c.job_no_mst as JOB_NO, a.color_id as COLOR_ID, b.body_part_id as BODY_PART_ID, d.body_part_type as BODY_PART_TYPE, b.gsm as GSM, b.width as WIDTH, b.fabric_description_id as FABRIC_DESCRIPTION_ID, a.entry_form as ENTRY_FORM, a.trans_id as TRANS_ID, a.returnable_qnty as REJECT_QTY, a.quantity as QUANTITY, b.uom as UOM, g.store_id as STORE_ID from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join lib_body_part d on b.body_part_id = d.id, inv_transaction g,  wo_po_break_down c, pro_batch_create_mst e, wo_booking_mst f where a.trans_id=b.trans_id and b.trans_id=g.id and a.po_breakdown_id=c.id and b.batch_id=e.id and e.booking_no=f.booking_no and f.fabric_source=1 and a.entry_form in (52) and a.po_breakdown_id in ($poIds) and a.color_id=$color and a.is_sales=0 and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0");

    foreach ($finish_issue_return as $val) 
    {
        //if($val['STORE_ID'] != 16 && $val['STORE_ID'] != 14)
        //if($text_cond_store_id_and)
        if(eval("return $text_cond_store_id_and;"))
        {
            $desc_str = $val['FABRIC_DESCRIPTION_ID']."*".$val['GSM']."*".$val['WIDTH']."*".$val['UOM'];
            if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
            {
                $type_name = 'FLAT';
            }
            else
            {
                $type_name = 'CIRCULAR';
            }

            $main_arr[$type_name][$desc_str]['ISSUE_RET_QTY'] += $val['QUANTITY'];
            
            // $finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FABRIC_DESCRIPTION_ID']][$val['GSM']][$val['WIDTH']][$val['UOM']]['ISSUE_RETURN'] += $val['QUANTITY'];
        }
    }

    $trans_sql = sql_select("SELECT b.job_no_mst as JOB_NO, a.color_id as COLOR_ID, e.body_part_type as BODY_PART_TYPE, d.detarmination_id as DETER_ID, d.gsm as GSM, d.dia_width as DIA, d.unit_of_measure as UOM, a.trans_type as TRANS_TYPE, a.quantity as QUANTITY, c.id as TRANS_ID, h.from_store as FROM_STORE, h.to_store as TO_STORE,i.transfer_criteria from order_wise_pro_details a, wo_po_break_down b, inv_transaction c left join lib_body_part e on c.body_part_id=e.id, inv_item_transfer_dtls h, product_details_master d, pro_batch_create_mst f, wo_booking_mst g,inv_item_transfer_mst i where i.id=h.mst_id and i.transfer_criteria in(2,4) and a.po_breakdown_id =b.id and a.trans_id = c.id and a.dtls_id = h.id  and c.prod_id=d.id and c.pi_wo_batch_no=f.id and f.booking_no=g.booking_no  and a.entry_form in (14) and a.po_breakdown_id in ($poIds) and a.color_id=$color and a.status_active =1 and a.is_deleted=0 AND a.po_breakdown_id <> 0 and g.fabric_source!=2");// 

    foreach ($trans_sql as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }

        if($val['TRANSFER_CRITERIA']==4)
        {
            if($val['TRANS_TYPE']==5)
            {                
                $main_arr[$type_name][$desc_str]['TRANS_IN'] += $val['QUANTITY'];
            }
            else
            {
                $main_arr[$type_name][$desc_str]['TRANS_OUT'] += $val['QUANTITY'];
            }
        }
        else // store to store
        {
            if($val['FROM_STORE'] != $val['TO_STORE'])
            {
                if($val['TRANS_TYPE']==5)
                {
                    if(($val['FROM_STORE']==16 || $val['FROM_STORE']==46 || $val['FROM_STORE']==14 || $val['FROM_STORE']==47) && ($val['TO_STORE']==8 || $val['TO_STORE']==20 || $val['TO_STORE']==32 || $val['TO_STORE']==52))  
                    {
                        $main_arr[$type_name][$desc_str]['TRANSIN'] += $val['QUANTITY'];
                    }
                }
                else
                {
                    $main_arr[$type_name][$desc_str]['TRANSOUT'] += $val['QUANTITY'];
                }
            }

        }
        
        
    }

    // echo "<pre>";print_r($main_arr);

    $issue_sql = sql_select("SELECT d.job_no_mst as JOB_NO, a.quantity as QUANTITY, e.body_part_type as BODY_PART_TYPE, c.gsm as GSM, c.detarmination_id as DETER_ID, c.dia_width as DIA, c.unit_of_measure as UOM, b.store_id as STORE_ID from order_wise_pro_details a, inv_finish_fabric_issue_dtls b left join lib_body_part e on b.body_part_id=e.id, product_details_master c, wo_po_break_down d, pro_batch_create_mst f, wo_booking_mst g, inv_issue_master h where  h.id=b.mst_id  and a.trans_id=b.trans_id and b.prod_id= c.id and a.po_breakdown_id= d.id and b.batch_id=f.id and f.booking_no=g.booking_no  and a.entry_form in(18) and a.po_breakdown_id in ($poIds) and a.color_id=$color and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and g.fabric_source!=2 and a.trans_id<>0");//and g.fabric_source=1

    foreach ($issue_sql as $val) 
    {
        //if($val['STORE_ID'] != 16 && $val['FROM_STORE'] != 14)
        //if($text_cond_store_id_and)
        if(eval("return $text_cond_store_id_and;"))
        {
            $desc_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA']."*".$val['UOM'];
            if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
            {
                $type_name = 'FLAT';
            }
            else
            {
                $type_name = 'CIRCULAR';
            }
            $main_arr[$type_name][$desc_str]['ISSUE']+= $val['QUANTITY'];
            // $issue_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']] += $val['QUANTITY'];
        }
    }

    //echo "<pre>";
    //print_r($issue_arr);//die;

    // ============================= get gmts color qty ==============================
    if($is_contrust_color!=1)
    {
        
        $sql = "SELECT a.job_no as JOB_NO, a.color_number_id as COLOR_ID, b.lib_yarn_count_deter_id as DETER_ID, b.uom as UOM,b.gsm_weight as GSM, a.dia_width as DIA, b.body_part_type as BODY_PART_TYPE from wo_pre_cos_fab_co_avg_con_dtls a, wo_pre_cost_fabric_cost_dtls b  where a.pre_cost_fabric_cost_dtls_id =b.id and a.job_no ='$job_number' and a.color_number_id = $color and b.fabric_source=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.job_no, a.color_number_id, b.lib_yarn_count_deter_id, b.uom,b.gsm_weight, a.dia_width, b.body_part_type order by b.body_part_type, b.lib_yarn_count_deter_id";
    

        // echo $sql;die();
        $res = sql_select($sql);

        
        foreach ($res as  $val) 
        {
            $desc_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA']."*".$val['UOM'];
            if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
            {
                $type_name = 'FLAT';
            }
            else
            {
                $type_name = 'CIRCULAR';
            }

            // $main_arr[$type_name][$desc_str]['SHORT_FINISH'] += $short_arr[$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['SHORT_FINISH'];
            // $main_arr[$type_name][$desc_str]['SHORT_GREY']   += $short_arr[$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['SHORT_GREY'];

            $main_arr[$type_name][$desc_str]['COLOR_ID'] = $val['COLOR_ID'];

            $main_arr[$type_name][$desc_str]['FAB_KNIT_GREY'] += $fabric_costing_arr['knit']['grey'][$val['JOB_NO']][$val['COLOR_ID']][''][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];

            $main_arr[$type_name][$desc_str]['FAB_KNIT_FINISH'] += $fabric_costing_arr['knit']['finish'][$val['JOB_NO']][$val['COLOR_ID']][''][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];
            $main_arr[$type_name][$desc_str]['FAB_WOVEN_GREY'] += $fabric_costing_arr['woven']['grey'][$val['JOB_NO']][$val['COLOR_ID']][''][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];
            $main_arr[$type_name][$desc_str]['FAB_WOVEN_FINISH'] += $fabric_costing_arr['woven']['finish'][$val['JOB_NO']][$val['COLOR_ID']][''][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];

            $main_arr[$type_name][$desc_str]['GREY_QTY'] += $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['GREY_QTY'];
            // $main_arr[$type_name][$desc_str]['BATCH_QTY'] += $batch_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
            // $main_arr[$type_name][$desc_str]['FINISH_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['RECEIVE'];
            // $main_arr[$type_name][$desc_str]['ISSUE_RET_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['ISSUE_RETURN'];
            // $main_arr[$type_name][$desc_str]['REJECT_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['REJECT'];
            // $main_arr[$type_name][$desc_str]['TRANS_IN'] += $trans_in_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
            // $main_arr[$type_name][$desc_str]['TRANS_OUT'] += $trans_out_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
            // $main_arr[$type_name][$desc_str]['ISSUE'] += $issue_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
        }
    }

     // ============================= get contrust color qty ==============================
    if($is_contrust_color==1)
    {
        $sql = "SELECT a.job_no as JOB_NO, a.color_number_id as COLOR_ID, b.lib_yarn_count_deter_id as DETER_ID, b.uom as UOM,b.gsm_weight as GSM, a.dia_width as DIA, b.body_part_type as BODY_PART_TYPE ,b.COLOR_SIZE_SENSITIVE,c.CONTRAST_COLOR_ID
        from wo_pre_cos_fab_co_avg_con_dtls a, wo_pre_cost_fabric_cost_dtls b LEFT JOIN wo_pre_cos_fab_co_color_dtls c ON b.job_no = c.job_no and b.id=c.pre_cost_fabric_cost_dtls_id  AND c.status_active = 1
        AND c.is_deleted = 0 where a.pre_cost_fabric_cost_dtls_id =b.id and a.job_no ='$job_number' and b.fabric_source=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.contrast_color_id=$color
        group by a.job_no, a.color_number_id, b.lib_yarn_count_deter_id, b.uom,b.gsm_weight, a.dia_width, b.body_part_type,b.color_size_sensitive,c.contrast_color_id 
        order by b.body_part_type, b.lib_yarn_count_deter_id";

        // echo $sql;die;
        $res = sql_select($sql);
        foreach ($res as  $val) 
        {
            $desc_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA']."*".$val['UOM'];
            if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
            {
                $type_name = 'FLAT';
            }
            else
            {
                $type_name = 'CIRCULAR';
            }

            $main_arr[$type_name][$desc_str]['SHORT_FINISH'] += $short_arr[$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['SHORT_FINISH'];
            $main_arr[$type_name][$desc_str]['SHORT_GREY']   += $short_arr[$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['SHORT_GREY'];

            $main_arr[$type_name][$desc_str]['COLOR_ID'] = $val['COLOR_ID'];

            $main_arr[$type_name][$desc_str]['FAB_KNIT_GREY'] += $fabric_costing_arr['knit']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];
            $main_arr[$type_name][$desc_str]['FAB_KNIT_FINISH'] += $fabric_costing_arr['knit']['finish'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];
            $main_arr[$type_name][$desc_str]['FAB_WOVEN_GREY'] += $fabric_costing_arr['woven']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];
            $main_arr[$type_name][$desc_str]['FAB_WOVEN_FINISH'] += $fabric_costing_arr['woven']['finish'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][1][$val['UOM']];   

            $main_arr[$type_name][$desc_str]['GREY_QTY'] += $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['GREY_QTY'];
            $main_arr[$type_name][$desc_str]['BATCH_QTY'] += $batch_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
            // $main_arr[$type_name][$desc_str]['FINISH_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['RECEIVE'];
            // $main_arr[$type_name][$desc_str]['ISSUE_RET_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['ISSUE_RETURN'];
            // $main_arr[$type_name][$desc_str]['REJECT_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['REJECT'];
            // $main_arr[$type_name][$desc_str]['TRANS_IN'] += $trans_in_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
            // $main_arr[$type_name][$desc_str]['TRANS_OUT'] += $trans_out_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
            // $main_arr[$type_name][$desc_str]['ISSUE'] += $issue_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];  
        }
    }
    
    // echo "<pre>";print_r($main_arr);die();
    $constructtion_arr=array();
    $sql_deter="SELECT a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id order by b.id asc";
    $data_array_deter=sql_select($sql_deter);
    foreach( $data_array_deter as $row )
    {
        $constructtion_arr[$row[csf('id')]]=$row[csf('construction')];
        $composition_arr[$row[csf('id')]].=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ";
      
    }
    unset($data_array_deter);



    // ========================== outbound dyeing data ==============================
    $sqlDye = "SELECT f.job_no_mst as job_no,d.color_id,b.GSM,b.WIDTH,b.UOM,b.fabric_description_id,e.fabric_source,b.grey_used_qty as QTY,g.body_part_type as BODY_PART_TYPE from inv_receive_master a,order_wise_pro_details c,pro_batch_create_mst d,wo_booking_mst e,wo_po_break_down f,pro_finish_fabric_rcv_dtls b left join lib_body_part g on b.body_part_id=g.id where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 and c.po_breakdown_id in($poIds) and d.color_id=$color and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(37) and c.entry_form in(37) and a.item_category=2 and a.receive_basis=11 and d.booking_no=e.booking_no and d.id=b.batch_id and f.id=c.po_breakdown_id";
        // echo $sqlDye;die();
        $dyeRes = sql_select($sqlDye);
        $outbound_dyeing_data_array = array();
        foreach ($dyeRes as $val) 
        {   
            $desc_str = $val['FABRIC_DESCRIPTION_ID']."*".$val['GSM']."*".$val['WIDTH']."*".$val['UOM'];
            if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
            {
                $type_name = 'FLAT';
            }
            else
            {
                $type_name = 'CIRCULAR';
            }
            $outbound_dyeing_data_array[$type_name][$desc_str]+= $val['QTY'];
        }
        // echo "<pre>";print_r($outbound_dyeing_data_array);die();

    $acting_width = $screen_size-10;
    $three_percent = $acting_width*0.03;
    $four_percent = $acting_width*0.04;
    $five_percent = $acting_width*0.05;
    $six_percent = $acting_width*0.06;
    $seven_percent = $acting_width*0.07;
    
    

    $rowspan = array();
    foreach ($main_arr as $type => $type_data) 
    {
        foreach ($type_data as $dSrt => $val) 
        {
            if($val['SHORT_FINISH']>0 || $val['GREY_QTY']>0 || $val['BATCH_QTY']>0 || $val['FINISH_QTY']>0 || $val['TRANSIN']>0 || $val['TRANS_IN']>0 || $val['TRANS_OUT']>0)
            {
                $rowspan[$type]++;
            }
           
        }
    }
    //echo $count_deter_data;
    
    $add= 220;
    //echo $add;
    //echo "<pre>";print_r($rowspan);die();
    ?>
    <style type="text/css">
        .word_break_wrap{
            word-wrap: break-word;
            word-break: break-all;
        }
    </style>
        <div class="main" style="width: <? echo $acting_width;?>px;" id="details_reports">
        <div class="header_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width+$add;?>">
                <caption style="font-size:20px;"><b>Color Info</b></caption>
                <thead>                             
                    <tr>
                        <th>Color:</th>
                        <th colspan="12"><? echo $lib_color[$color];?></th>
                        <th colspan="7">Textile Store</th>
                        <th colspan="7">Garments Store</th>
                    </tr>
                    <tr>
                        <th width="<?  echo $five_percent;?>">Knit Type</th>
                        <th width="<? echo $seven_percent+$add;?>">Structure</th>
                        <th width="<? echo $three_percent;?>">GSM</th>
                        <th width="<? echo $three_percent;?>">F. Dia</th>
                        <th width="<? echo $three_percent;?>">Unit</th>
                        <th width="<? echo $three_percent;?>">Finish Req</th>
                        <th width="<? echo $three_percent;?>">Ex Req</th>
                        <th width="<? echo $three_percent;?>">Gray Req</th>
                        <th width="<? echo $three_percent;?>">PL %</th>
                        <th width="<? echo $three_percent;?>">Gray Rcv</th>
                        <th width="<? echo $three_percent;?>">Gray Bal</th>
                        <th width="<? echo $three_percent;?>">Batch Qty</th>
                        <th width="<? echo $three_percent;?>">Batch Bal</th>
                        <th width="<? echo $three_percent;?>">Ok Rcvd</th>
                        <th width="<? echo $three_percent;?>">Rej Rcvd</th>
                        <th width="<? echo $three_percent;?>">Rcv bal</th>
                        <th width="<? echo $three_percent;?>">Ok Stock</th>
                        <th width="<? echo $three_percent;?>">Rej Stock</th>
                        <th width="<? echo $three_percent;?>">Ok Rcv Del</th>
                        <th width="<? echo $three_percent;?>">Del Bal</th>
                        <th width="<? echo $three_percent;?>">Trans In</th>
                        <th width="<? echo $three_percent;?>">Ok Issue</th>
                        <th width="<? echo $three_percent;?>">Trans Out</th>
                        <th width="<? echo $three_percent;?>">Rej Issue</th>
                        <th width="<? echo $three_percent;?>">Ok Stock</th>
                        <th width="<? echo $three_percent;?>">Rej Stock</th>
                        <th width="<? echo $three_percent;?>">Issue Bal</th>                        
                    </tr>
                </thead>
            </table>
            <div style="width:<? echo $acting_width+18+$add;?>px; max-height:240px;overflow-y:scroll;" id="scroll_body">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width+$add;?>">
                <tbody>
                    <?
                    $i=0;
                    foreach ($main_arr as $type => $type_data) 
                    {
                        $y=1;
                        foreach ($type_data as $dSrt => $val) 
                        {
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF";
                            $dSrt_data = explode("*", $dSrt);
                            $DETER_ID = $dSrt_data[0];
                            $GSM = $dSrt_data[1];
                            $DIA = $dSrt_data[2];
                            $UOM = $dSrt_data[3];
                            
                            $grey_required = $val['FAB_KNIT_GREY'] + $val['FAB_WOVEN_GREY'];
                            $finish_required = $val['FAB_KNIT_FINISH'] + $val['FAB_WOVEN_FINISH'];
                            $grey_requ_with_addi = $grey_required + $val['SHORT_GREY'];
                            if($grey_requ_with_addi >0)
                            {
                                $pl_percentage = ($grey_requ_with_addi - ($finish_required +$val['SHORT_FINISH']))/$grey_requ_with_addi*100;
                            }else{
                                $pl_percentage =0;
                            }
                            $gray_balance = $grey_requ_with_addi - $val['GREY_QTY'];
                            $batch_balance = $val['GREY_QTY'] - $val['BATCH_QTY'];
                            $receive_balance = ($finish_required + $val['SHORT_FINISH'] )- $val['FINISH_QTY'];
                            
                            $text_del_bal = ($finish_required+$val['SHORT_FINISH']) -  $val['TRANSIN'];
                            
                            $text_okay_stock_bal =$val['FINISH_QTY'] - $val['TRANSIN'];
                            $garments_issue = $val['ISSUE'];// + $val['TRANSOUT'];

                            $stock = ($ff_received_garments+$trans_in) - ($ff_issued_garments+$trans_out);

                            $garments_okay_stock_bal = ($val['TRANSIN'] + $val['TRANS_IN'] + $val['ISSUE_RET_QTY']) - ($val['ISSUE']+ $val['TRANS_OUT']);

                            $issue_balance = ($finish_required+$val['SHORT_FINISH']) - $val['ISSUE'];

                            $outbound_dyeing_qty = $outbound_dyeing_data_array[$type][$dSrt];

                            if($val['SHORT_FINISH']>0 || $val['GREY_QTY']>0 || $val['BATCH_QTY']>0 || $val['FINISH_QTY']>0 || $val['TRANSIN']>0 || $val['TRANS_IN']>0 || $val['TRANS_OUT']>0)
                            {
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                    <?
                                    if($y==1)
                                    {
                                        ?>
                                        <td width="<? echo $five_percent;?>" rowspan="<? echo $rowspan[$type];?>"><? echo $type;?></td>
                                        <?
                                    } 
                                    ?>                              
                                    <td width="<? echo $seven_percent+$add;?>" align="left"><p class="word_break_wrap"><? echo $constructtion_arr[$DETER_ID].", ".$composition_arr[$DETER_ID];?></p></td>
                                    <td width="<? echo $three_percent;?>" align="center"><? echo $GSM;?></td>
                                    <td width="<? echo $three_percent;?>" align="center"><? echo $DIA;?></td>
                                    <td width="<? echo $three_percent;?>" align="center"><? echo $unit_of_measurement[$UOM];?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($finish_required,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($val['SHORT_FINISH'],0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($grey_requ_with_addi,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($pl_percentage,2);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($val['GREY_QTY'],0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gray_balance);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format(($val['BATCH_QTY']+$outbound_dyeing_qty),0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($batch_balance);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($val['FINISH_QTY'],0) ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($val['REJECT_QTY'],0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($receive_balance,0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($text_okay_stock_bal);?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($val['REJECT_QTY'],0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($val['TRANSIN'],0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($text_del_bal,0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right">&nbsp;<?=fn_number_format($val['TRANS_IN'],0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($garments_issue/*$val['ISSUE']*/,0);?></td>
                                    <td width="<? echo $three_percent;?>" align="right">&nbsp;<?=fn_number_format($val['TRANS_OUT'],0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right">&nbsp;<??></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($garments_okay_stock_bal,0); ?></td>
                                    <td width="<? echo $three_percent;?>" align="right">&nbsp;<??></td>
                                    <td width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($issue_balance,0); ?></td>
                                </tr>
                                <?
                                $i++; 
                                $y++;
                                $tot_finish_required += $finish_required;
                                $tot_ex_finish += $val['SHORT_FINISH'];
                                $tot_grey_requ_with_addi += $grey_requ_with_addi;
                                $tot_grey_qty += $val['GREY_QTY'];
                                $tot_gray_balance += $gray_balance;
                                $tot_batch_qty += $val['BATCH_QTY']+$outbound_dyeing_qty;
                                $tot_batch_balance += $batch_balance;
                                $tot_finish_rcv += $val['FINISH_QTY'];
                                $tot_reject_qty += $val['REJECT_QTY'];
                                $tot_receive_balance += $receive_balance;
                                $tot_text_okay_stock_bal += $text_okay_stock_bal;
                                $tot_text_del_bal += $text_del_bal;
                                $tot_issue += $garments_issue;//$val['ISSUE'];
                                $tot_garments_okay_stock_bal += $garments_okay_stock_bal;
                                $tot_issue_balance += $issue_balance;
                                $tot_txt_ok_recv_del += $val['TRANSIN'];
                                $tot_trans_in += $val['TRANS_IN'];
                                $tot_trans_out += $val['TRANS_OUT'];

                                $gr_finish_required += $finish_required;
                                $gr_ex_finish += $val['SHORT_FINISH'];
                                $gr_grey_requ_with_addi += $grey_requ_with_addi;
                                $gr_grey_qty += $val['GREY_QTY'];
                                $gr_gray_balance += $gray_balance;
                                $gr_batch_qty += $val['BATCH_QTY']+$outbound_dyeing_qty;
                                $gr_batch_balance += $batch_balance;
                                $gr_finish_rcv += $val['FINISH_QTY'];
                                $gr_reject_qty += $val['REJECT_QTY'];
                                $gr_receive_balance += $receive_balance;
                                $gr_text_okay_stock_bal += $text_okay_stock_bal;
                                $gr_text_del_bal += $text_del_bal;
                                $gr_issue += $garments_issue;//$val['ISSUE'];
                                $gr_garments_okay_stock_bal += $garments_okay_stock_bal;
                                $gr_issue_balance += $issue_balance;
                                $gr_txt_ok_recv_del += $val['TRANSIN'];
                                $gr_trans_in += $val['TRANS_IN'];
                                $gr_trans_out += $val['TRANS_OUT'];

                            }
                            if($tot_grey_requ_with_addi >0){
                                $tot_pl_percentage = ($tot_grey_requ_with_addi - ($tot_finish_required+$tot_ex_finish))/$tot_grey_requ_with_addi*100;
                            }else{
                                $tot_pl_percentage =0;
                            }
                        }
                        ?>
                        
                        
                        <tr class="tbl_footer" style="background: #cddcdc">
                            <th width="<? echo $five_percent;?>" align="center"><? //echo $DETER_ID;?></th>
                            <th width="<? echo $seven_percent;?>" align="center"><? //echo $DETER_ID;?></th>
                            <th width="<? echo $three_percent;?>" align="center"><? //echo $GSM;?></th>
                            <th width="<? echo $three_percent;?>" align="center">Total:<? //echo $DIA;?></th>
                            <th width="<? echo $three_percent;?>" align="center"><? //echo $unit_of_measurement[$UOM];?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_finish_required,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_ex_finish,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_grey_requ_with_addi,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_pl_percentage,2);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_grey_qty,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_gray_balance);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_batch_qty,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_batch_balance);?></th>

                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_finish_rcv,0) ?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_reject_qty,0); ?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_receive_balance,0); ?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_text_okay_stock_bal);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_reject_qty,0); ?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_txt_ok_recv_del,0); ?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_text_del_bal,0); ?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_trans_in,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_issue,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_trans_out,0);?></th>
                            <th width="<? echo $three_percent;?>" align="right">&nbsp;<??></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_garments_okay_stock_bal,0); ?></th>
                            <th width="<? echo $three_percent;?>" align="right">&nbsp;<??></th>
                            <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($tot_issue_balance,0); ?></th>
                        </tr>
                    </tbody>
                    <?
                    $tot_finish_required=$tot_ex_finish=$tot_grey_requ_with_addi=$tot_pl_percentage=$tot_grey_qty=$tot_gray_balance=$tot_batch_qty=$tot_batch_balance=$tot_finish_rcv=$tot_reject_qty=$tot_receive_balance=$tot_text_okay_stock_bal=$tot_text_del_bal=$tot_issue=$tot_garments_okay_stock_bal=$tot_issue_balance=$tot_txt_ok_recv_del=0;
                }
                ?>
                <tfoot>
                    <tr class="tbl_footer" style="background: #cddcdc">
                        <th width="<? echo $five_percent;?>" align="center"><? //echo $DETER_ID;?></th>
                        <th width="<? echo $seven_percent;?>" align="center"><? //echo $DETER_ID;?></th>
                        <th width="<? echo $three_percent;?>" align="center"><? //echo $GSM;?></th>
                        <th width="<? echo $three_percent;?>" align="center">G.Total:<? //echo $DIA;?></th>
                        <th width="<? echo $three_percent;?>" align="center"><? //echo $unit_of_measurement[$UOM];?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_finish_required,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_ex_finish,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_grey_requ_with_addi,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_pl_percentage,2);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_grey_qty,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_gray_balance);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_batch_qty,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_batch_balance);?></th>

                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_finish_rcv,0) ?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_reject_qty,0); ?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_receive_balance,0); ?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_text_okay_stock_bal);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_reject_qty,0); ?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_txt_ok_recv_del,0); ?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_text_del_bal,0); ?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_trans_in,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_issue,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_trans_out,0);?></th>
                        <th width="<? echo $three_percent;?>" align="right">&nbsp;<??></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_garments_okay_stock_bal,0); ?></th>
                        <th width="<? echo $three_percent;?>" align="right">&nbsp;<??></th>
                        <th width="<? echo $three_percent;?>" align="right"><? echo fn_number_format($gr_issue_balance,0); ?></th>
                    </tr>
                </tfoot>    
            </table>
            </div>
        </div> 
    <?
}

if($action == "finish_color_popup_purchase")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    extract($_REQUEST);
    list($color, $poIds, $job_number,$is_contrust_color) = explode("*",$data);

    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();
    //$costPerArr=$condition->getCostingPerArr();
    $fabric= new fabric($condition);
    //echo $fabric->getQuery();die;
    // $fabric_costing_arr=$fabric->getQtyArray_by_JobColorBodyTypeDeterminIdGsmAndDiaWidth_knitAndwoven_greyAndfinish();
    $fabric_costing_arr=$fabric->getQtyArray_by_JobColorFabricColorBodyTypeDeterminIdGsmAndDiaWidth_knitAndwoven_greyAndfinish();
    // echo "<pre>";print_r($fabric_costing_arr);die();

    $short_sql = sql_select("SELECT B.BODY_PART_TYPE, a.fin_fab_qnty as FIN_FAB_QNTY, a.grey_fab_qnty as GREY_FAB_QNTY, a.fabric_color_id as COLOR_ID, b.gsm_weight as GSM_WEIGHT, b.lib_yarn_count_deter_id as DETERMINATION_ID, a.dia_width as DIA_WIDTH, b.uom as UOM, b.job_no as JOB_NO from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b, wo_booking_mst c where a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no = c.booking_no and c.fabric_source=2 and a.is_short=1 and a.booking_type=1 and a.po_break_down_id in ($poIds) and a.fabric_color_id=$color and a.status_active =1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

    foreach ($short_sql as $val) 
    {
        $short_arr[$val['BODY_PART_TYPE']][$val['DETERMINATION_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][$val['UOM']]['SHORT_FINISH']+=$val['FIN_FAB_QNTY']; 
        $short_arr[$val['BODY_PART_TYPE']][$val['DETERMINATION_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][$val['UOM']]['SHORT_GREY']+=$val['GREY_FAB_QNTY']; 
    }

    $finish_sql = sql_select("SELECT c.job_no_mst as JOB_NO, a.color_id as COLOR_ID, b.body_part_id as BODY_PART_ID, d.body_part_type as BODY_PART_TYPE, b.gsm as GSM, b.width as WIDTH, b.fabric_description_id as FABRIC_DESCRIPTION_ID, a.entry_form as ENTRY_FORM, a.trans_id as TRANS_ID, a.returnable_qnty as REJECT_QTY, a.quantity as QUANTITY, b.uom as UOM from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join lib_body_part d on b.body_part_id = d.id, wo_po_break_down c, pro_batch_create_mst e, wo_booking_mst f where a.dtls_id=b.id and a.po_breakdown_id=c.id and b.batch_id=e.id and e.booking_no=f.booking_no and f.fabric_source=2 and a.entry_form in (37) and a.po_breakdown_id in ($poIds) and a.color_id=$color and a.is_sales=0 and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0");

    foreach ($finish_sql as $val) 
    {
        $finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FABRIC_DESCRIPTION_ID']][$val['GSM']][$val['WIDTH']][$val['UOM']]['RECEIVE'] += $val['QUANTITY'];
        $finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FABRIC_DESCRIPTION_ID']][$val['GSM']][$val['WIDTH']][$val['UOM']]['REJECT'] += $val['REJECT_QTY'];
    }
    // echo "<pre>";  print_r($finish_rcv_arr);

    $finish_issue_return = sql_select("SELECT c.job_no_mst as JOB_NO, a.color_id as COLOR_ID, b.body_part_id as BODY_PART_ID, d.body_part_type as BODY_PART_TYPE, b.gsm as GSM, b.width as WIDTH, b.fabric_description_id as FABRIC_DESCRIPTION_ID, a.entry_form as ENTRY_FORM, a.trans_id as TRANS_ID, a.returnable_qnty as REJECT_QTY, a.quantity as QUANTITY, b.uom as UOM from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join lib_body_part d on b.body_part_id = d.id, wo_po_break_down c, pro_batch_create_mst e, wo_booking_mst f where a.trans_id=b.trans_id and a.po_breakdown_id=c.id and b.batch_id=e.id and e.booking_no=f.booking_no and f.fabric_source=2 and a.entry_form in (52) and a.po_breakdown_id in ($poIds) and a.color_id=$color and a.is_sales=0 and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0");

    foreach ($finish_issue_return as $val) 
    {
        $finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FABRIC_DESCRIPTION_ID']][$val['GSM']][$val['WIDTH']][$val['UOM']]['ISSUE_RETURN'] += $val['QUANTITY'];
    }

    
    $issue_sql = sql_select("SELECT d.job_no_mst as JOB_NO, a.quantity as QUANTITY, e.body_part_type as BODY_PART_TYPE, c.gsm as GSM, c.detarmination_id as DETER_ID, c.dia_width as DIA, c.unit_of_measure as UOM, a.entry_form as ENTRY_FORM from order_wise_pro_details a, inv_finish_fabric_issue_dtls b left join lib_body_part e on b.body_part_id=e.id, product_details_master c, wo_po_break_down d, pro_batch_create_mst f, wo_booking_mst g, inv_issue_master h where b.mst_id=h.id  and  a.trans_id=b.trans_id and b.prod_id= c.id and a.po_breakdown_id= d.id and b.batch_id=f.id and f.booking_no=g.booking_no and g.fabric_source=2 and a.entry_form in (18,46) and a.po_breakdown_id in ($poIds) and a.color_id=$color and g.job_no ='$job_number' and a.trans_id<>0 and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0");

    // $finish_iss_rcvret_sql = sql_select("SELECT e.job_no_mst as JOB_NO, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, a.trans_id as TRANS_ID, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, b.store_id as STORE_ID from order_wise_pro_details a, inv_finish_fabric_issue_dtls b, pro_batch_create_mst c, wo_booking_mst d, wo_po_break_down e,inv_issue_master f where a.dtls_id=b.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.id and a.entry_form in (18,46) and f.id=b.mst_id  and a.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and a.trans_id<>0 ORDER BY a.color_id ASC");//AND f.booking_no = d.booking_no
    $main_arr = array();

    foreach ($issue_sql as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA']."*".$val['UOM'];
        if($val['ENTRY_FORM']==18)
        {
            $issue_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']] += $val['QUANTITY'];
            // $main_arr[$val['BODY_PART_TYPE']][$desc_str]['ISSUE'] += $val['QUANTITY'];
        }
        else
        {
            $rcv_return_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']] += $val['QUANTITY'];
            // $main_arr[$val['BODY_PART_TYPE']][$desc_str]['RECV_RETURN'] += $val['QUANTITY'];
           
        }
    }
    // echo "<pre>";print_r($issue_arr);die;
    $trans_sql = sql_select("SELECT b.job_no_mst as JOB_NO, a.color_id as COLOR_ID, e.body_part_type as BODY_PART_TYPE, d.detarmination_id as DETER_ID, d.gsm as GSM, d.dia_width as DIA, d.unit_of_measure as UOM, a.trans_type as TRANS_TYPE, a.quantity as QUANTITY,c.store_id from order_wise_pro_details a, wo_po_break_down b, inv_transaction c left join lib_body_part e on c.body_part_id=e.id, product_details_master d, pro_batch_create_mst f, wo_booking_mst g where a.po_breakdown_id =b.id and a.trans_id = c.id  and c.prod_id=d.id and c.pi_wo_batch_no=f.id and f.booking_no=g.booking_no and g.fabric_source=2 and a.entry_form in (14) and a.po_breakdown_id in ($poIds) and a.color_id=$color and a.status_active =1 and a.is_deleted=0 and c.store_id in(8,20,49)");
    // $main_arr = array();
    foreach ($trans_sql as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }

        if($val['TRANS_TYPE']==5)
        {
            // $trans_in_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']] += $val['QUANTITY'];
            $main_arr[$val['BODY_PART_TYPE']][$desc_str]['TRANS_IN'] += $val['QUANTITY'];
        }
        else
        {
            // $trans_out_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']] += $val['QUANTITY'];
            $main_arr[$val['BODY_PART_TYPE']][$desc_str]['TRANS_OUT'] += $val['QUANTITY'];
        }

        //$main_arr[$val['BODY_PART_TYPE']][$desc_str]['ISSUE'] += $issue_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
        //$main_arr[$val['BODY_PART_TYPE']][$desc_str]['ISSUE_RET_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['ISSUE_RETURN'];
        
         
    }
    // echo "<pre>";
    // print_r($main_arr);
    // die;
    if($is_contrust_color==1)
    {
        $sql = "SELECT a.job_no as JOB_NO, b.lib_yarn_count_deter_id as DETER_ID, b.uom as UOM,b.gsm_weight as GSM, a.dia_width as DIA, b.body_part_type as BODY_PART_TYPE,a.color_number_id as COLOR_ID, c.CONTRAST_COLOR_ID,b.COLOR_SIZE_SENSITIVE from wo_pre_cos_fab_co_avg_con_dtls a join wo_pre_cost_fabric_cost_dtls b on a.pre_cost_fabric_cost_dtls_id =b.id JOIN wo_pre_cos_fab_co_color_dtls c ON b.job_no = c.job_no and b.id=c.pre_cost_fabric_cost_dtls_id and c.gmts_color_id = a.color_number_id AND c.status_active = 1
       AND c.is_deleted = 0 where  a.job_no ='$job_number' and c.contrast_color_id = $color  and b.fabric_source=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.job_no, b.lib_yarn_count_deter_id, b.uom,b.gsm_weight, a.dia_width, b.body_part_type,a.color_number_id,c.contrast_color_id,b.color_size_sensitive order by b.body_part_type, b.lib_yarn_count_deter_id";
    }
    else
    {
        $sql = "SELECT a.job_no as JOB_NO, a.color_number_id as COLOR_ID, b.lib_yarn_count_deter_id as DETER_ID, b.uom as UOM,b.gsm_weight as GSM, a.dia_width as DIA, b.body_part_type as BODY_PART_TYPE from wo_pre_cos_fab_co_avg_con_dtls a, wo_pre_cost_fabric_cost_dtls b where a.pre_cost_fabric_cost_dtls_id =b.id and a.job_no ='$job_number' and a.color_number_id = $color and b.fabric_source=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.job_no, a.color_number_id, b.lib_yarn_count_deter_id, b.uom,b.gsm_weight, a.dia_width, b.body_part_type order by b.body_part_type, b.lib_yarn_count_deter_id";
    }
    //echo $sql;die();
    $res = sql_select($sql);
    // echo "<pre>";
    // print_r($fabric_costing_arr['knit']['finish'][$job_number]);
    // echo "</pre>";

    foreach ($res as  $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }else{
            $type_name = 'CIRCULAR';
        }

        $main_arr[$val['BODY_PART_TYPE']][$desc_str]['SHORT_FINISH'] += $short_arr[$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['SHORT_FINISH'];
        $main_arr[$val['BODY_PART_TYPE']][$desc_str]['SHORT_GREY']   += $short_arr[$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['SHORT_GREY'];

        $main_arr[$val['BODY_PART_TYPE']][$desc_str]['COLOR_ID'] = $val['COLOR_ID'];

        $main_arr[$val['BODY_PART_TYPE']][$desc_str]['FAB_KNIT_GREY'] += $fabric_costing_arr['knit']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][2][$val['UOM']];

        $main_arr[$val['BODY_PART_TYPE']][$desc_str]['FAB_KNIT_FINISH'] += $fabric_costing_arr['knit']['finish'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][2][$val['UOM']];
        $main_arr[$val['BODY_PART_TYPE']][$desc_str]['FAB_WOVEN_GREY'] += $fabric_costing_arr['woven']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][2][$val['UOM']];
        $main_arr[$val['BODY_PART_TYPE']][$desc_str]['FAB_WOVEN_FINISH'] += $fabric_costing_arr['woven']['finish'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][2][$val['UOM']];
        $main_arr[$val['BODY_PART_TYPE']][$desc_str]['FINISH_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['RECEIVE'];
        $main_arr[$val['BODY_PART_TYPE']][$desc_str]['ISSUE_RET_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['ISSUE_RETURN'];
        $main_arr[$val['BODY_PART_TYPE']][$desc_str]['REJECT_QTY'] +=$finish_rcv_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']]['REJECT'];
        $main_arr[$val['BODY_PART_TYPE']][$desc_str]['TRANS_IN'] += $trans_in_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
        // $main_arr[$val['BODY_PART_TYPE']][$desc_str]['TRANS_OUT'] += $trans_out_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];
        // $main_arr[$val['BODY_PART_TYPE']][$desc_str]['ISSUE'] += $issue_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];

        // echo $val['JOB_NO']."=".$val['BODY_PART_TYPE']."=".$val['DETER_ID']."=".$val['GSM']."=".$val['DIA']."=".$val['UOM']."<br>";

        $main_arr[$val['BODY_PART_TYPE']][$desc_str]['RECV_RETURN'] += $rcv_return_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][$val['UOM']];

        // $width_add+=strlen($val['GSM']);
        // $width_add+=strlen($val['DIA']);
        // $width_add+=strlen($val['UOM']);
        // $width_add+=strlen($val['SHORT_GREY']);
       

    }
    // echo "<pre>";print_r($main_arr);die();
    /*if($is_contrust_color==1)
    {
        $sql = "SELECT a.job_no as JOB_NO, a.color_number_id as COLOR_ID, b.lib_yarn_count_deter_id as DETER_ID, b.uom as UOM,b.gsm_weight as GSM, a.dia_width as DIA, b.body_part_type as BODY_PART_TYPE,c.CONTRAST_COLOR_ID,b.COLOR_SIZE_SENSITIVE from wo_pre_cos_fab_co_avg_con_dtls a, wo_pre_cost_fabric_cost_dtls b LEFT JOIN wo_pre_cos_fab_co_color_dtls c ON b.job_no = c.job_no and b.id=c.pre_cost_fabric_cost_dtls_id  AND c.status_active = 1
       AND c.is_deleted = 0 where a.pre_cost_fabric_cost_dtls_id =b.id and a.job_no ='$job_number'  and b.fabric_source=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.job_no,a.color_number_id, b.lib_yarn_count_deter_id, b.uom,b.gsm_weight, a.dia_width, b.body_part_type,c.contrast_color_id,b.color_size_sensitive order by b.body_part_type, b.lib_yarn_count_deter_id";
        // echo $sql;
       $res = sql_select($sql);
        foreach ($res as  $val) 
        {
            $desc_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA']."*".$val['UOM'];
            if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
            {
                $type_name = 'FLAT';
            }else{
                $type_name = 'CIRCULAR';
            }

            $main_arr[$type_name][$desc_str]['FAB_KNIT_GREY'] += $fabric_costing_arr['knit']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][2][$val['UOM']];

            $main_arr[$type_name][$desc_str]['FAB_KNIT_FINISH'] += $fabric_costing_arr['knit']['finish'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][2][$val['UOM']];
            $main_arr[$type_name][$desc_str]['FAB_WOVEN_GREY'] += $fabric_costing_arr['woven']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][2][$val['UOM']];
            $main_arr[$type_name][$desc_str]['FAB_WOVEN_FINISH'] += $fabric_costing_arr['woven']['finish'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['GSM']][$val['DIA']][2][$val['UOM']];
            
        }
    }*/
   // echo "<pre>";print_r($main_arr);die();

    $constructtion_arr=array();
    $sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id order by b.id asc";
    //echo $sql_deter;
    $data_array_deter=sql_select($sql_deter);
    foreach( $data_array_deter as $row )
    {
        $constructtion_arr[$row[csf('id')]]=$row[csf('construction')];
        $composition_arr[$row[csf('id')]].=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ";
        
    }
    unset($data_array_deter);

    $acting_width = $screen_size-10;
    $three_percent = $acting_width*0.03;
    $four_percent = $acting_width*0.04;
    $five_percent = $acting_width*0.05;
    $six_percent = $acting_width*0.06;
    $seven_percent = $acting_width*0.07;
    // echo "<pre>";
    // print_r($main_arr);
    $width_add=350;
    ?>
    <style type="text/css">
        .word_break_wrap{
            word-wrap: break-word;
            word-break: break-all;
        }
    </style>
        <div class="main" style="width:<?=1030+$width_add?>px;" id="details_reports">
        <div class="header_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<?=1010+$width_add?>">
                <caption style="font-size:20px;"><b>Color Info</b></caption>
                <thead>                             
                    <tr>
                        <th>Color:</th>
                        <th colspan="6"><? echo $lib_color[$color];?></th>
                        <th colspan="7">Garments Store</th>
                    </tr>
                    <tr>
                        <th width="80">Knit Type</th>
                        <th width="<?=150+$width_add?>">Structure</th>
                        <th width="65">GSM</th>
                        <th width="65">F. Dia</th>
                        <th width="65">Unit</th>
                        <th width="65">Finish Req</th>
                        <th width="65">Ex Req</th>
                        <th width="65">Trans In</th>
                        <th width="65">Net Issue</th>
                        <th width="65">Trans Out</th>
                        <th width="65">Rej Issue</th>
                        <th width="65">Net Stock</th>
                        <th width="65">Rej Stock</th>
                        <th width="65">Issue Bal</th>                        
                    </tr>
                </thead>
            </table>
            <div style="width:<?=1030+$width_add?>px;"; max-height:240px;overflow-y:scroll;" id="scroll_body">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<?=1010+$width_add?>">
                <tbody>
                    <?
                    $i=0;
                    foreach ($main_arr as $type => $type_data) 
                    {
                        $y=1;
                        foreach ($type_data as $dSrt => $val) 
                        {
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF";
                            $dSrt_data = explode("*", $dSrt);
                            $DETER_ID = $dSrt_data[0];
                            //echo "<br>".$DETER_ID;
                            $GSM = $dSrt_data[1];
                            $DIA = $dSrt_data[2];
                            $UOM = $dSrt_data[3];
                            
                            $grey_required = $val['FAB_KNIT_GREY'] + $val['FAB_WOVEN_GREY'];
                            $finish_required = $val['FAB_KNIT_FINISH'] + $val['FAB_WOVEN_FINISH'];
                            
                            $garments_rcv = $val['FINISH_QTY'];// + $val['TRANS_OUT'] + $val['RECV_RETURN'];
                            $transferred_fab_issue_rtn = $finish_rcv_arr[$job_number][$type][$DETER_ID][$GSM][$DIA][$UOM]['ISSUE_RETURN'];
                            
                            $transferred_fab_issue = $issue_arr[$job_number][$type][$DETER_ID][$GSM][$DIA][$UOM];
                            $transferred_fab_net_issue = ($transferred_fab_issue-$transferred_fab_issue_rtn);
                            
                            //$garments_issue = ($val['ISSUE']+$transferred_fab_net_issue)-$val['ISSUE_RET_QTY'];
                            $garments_issue = $val['ISSUE']-$val['ISSUE_RET_QTY'];
                            
                            $garments_issue_title = "Issue = ".$garments_issue.", Issue Return = ".$val['ISSUE_RET_QTY'];
                            $garments_okay_stock_bal = ( $val['FINISH_QTY'] + $val['TRANS_IN']) - ($garments_issue+$val['TRANS_OUT']+$val['RECV_RETURN']);
                            // echo "(". $val['FINISH_QTY'] ."+". $val['TRANS_IN'].") - (".$garments_issue . "+".$val['TRANS_OUT']."+".$val['RECV_RETURN'].")<br>";
                            $issue_balance = ($finish_required+$val['SHORT_FINISH']) - $garments_issue;

                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                <?
                                if($y==1)
                                {
                                    ?>
                                    <td width="80" rowspan="<? echo count($type_data)?>"><? echo $type;?></td>
                                    <?
                                } 
                                ?>                              
                                <td width="<?=150+$width_add?>" align="left"><p><? echo $constructtion_arr[$DETER_ID].", ".$composition_arr[$DETER_ID];?></p></td>
                                <td width="65" align="center"><? echo $type;?></td>
                                <td width="65" align="center"><? echo $DIA;?></td>
                                <td width="65" align="center"><? echo $unit_of_measurement[$UOM];?></td>
                                <td width="65" align="right"><? echo fn_number_format($finish_required,0);?></td>
                                <td width="65" align="right"><? echo fn_number_format($val['SHORT_FINISH'],0);?></td>
                                
                                <td width="65>" align="right"><? echo fn_number_format($val['TRANS_IN'],0);?></td>
                                <td width="65>" align="right" title="<? echo $garments_issue_title; ?>"><? echo fn_number_format($garments_issue,0);?></td>
                                <td width="65>" align="right"><? echo fn_number_format($val['TRANS_OUT'],0);?></td>
                                <td width="65" align="right">&nbsp;<??></td>
                                <td width="65" align="right"><? echo fn_number_format($garments_okay_stock_bal,0); ?></td>
                                <td width="65" align="right">&nbsp;<? echo fn_number_format($val['REJECT_QTY'],0);?></td>
                                <td width="65" align="right"><? echo fn_number_format($issue_balance,0); ?></td>
                            </tr>
                            <?
                            $i++; 
                            $y++;
                            $tot_finish_required += $finish_required;
                            $tot_ex_finish += $val['SHORT_FINISH'];
                            
                            $tot_issue += $garments_issue;
                            $tot_garments_okay_stock_bal += $garments_okay_stock_bal;
                            $tot_reject_qty += $val['REJECT_QTY'];
                            $tot_issue_balance += $issue_balance;
                            $tot_trans_in += $val['TRANS_IN'];
                            $tot_trans_out += $val['TRANS_OUT'];
                        }
                        ?>
                    </tbody>
                    <tfoot>
                        <tr class="tbl_footer" style="background: #F0F0F0">
                            <th align="center"><? //echo $DETER_ID;?></th>
                            <th align="center"><? //echo $DETER_ID;?></th>
                            <th align="center"><? //echo $GSM;?></th>
                            <th align="center">Total:<? //echo $DIA;?></th>
                            <th align="center"><? //echo $unit_of_measurement[$UOM];?></th>
                            <th align="right"><? echo fn_number_format($tot_finish_required,0);?></th>
                            <th align="right"><? echo fn_number_format($tot_ex_finish,0);?></th>
                            
                            <th align="right">&nbsp;<? echo fn_number_format($tot_trans_in,0);?></th>
                            <th align="right"><? echo fn_number_format($tot_issue,0);?></th>
                            <th align="right">&nbsp;<? echo fn_number_format($tot_trans_out,0);?></th>
                            <th align="right">&nbsp;<??></th>
                            <th align="right"><? echo fn_number_format($tot_garments_okay_stock_bal,0); ?></th>
                            <th align="right">&nbsp;<? echo fn_number_format($tot_reject_qty,0);?></th>
                            <th align="right"><? echo fn_number_format($tot_issue_balance,0); ?></th>
                        </tr>
                        <?
                        $tot_finish_required = $tot_ex_finish = $tot_issue = $tot_garments_okay_stock_bal = $tot_reject_qty = $tot_issue_balance = 0;
                    }
                    ?>
                </tfoot>
            </table>
            </div>
        </div> 
    <?
}

if($action == "dyed_yarn_req_popup")
{
    echo load_html_head_contents("Dyed Yarn Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    extract($_REQUEST);
    
    list($job_no, $po_ids) = explode("**",$po_break_down_id);

    $sqlOrder = "SELECT a.style_ref_no as style,b.grouping as int_ref FROM wo_po_details_master a, wo_po_break_down b WHERE a.id=b.job_id and a.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in($po_ids) group by a.style_ref_no,b.grouping";
    //echo $sqlOrder;die();
    $sqlOrderRes = sql_select($sqlOrder);
    
    $sql_stripe="SELECT d.stripe_color,d.fabreqtotkg from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no in('$job_no')  and d.job_no in('$job_no') and c.color_type_id in (2,3,4,6,32,33,34)  and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and  b.is_deleted=0  group by d.stripe_color,fabreqtotkg";

    $result_data=sql_select($sql_stripe);

    foreach($result_data as $row)
    {
        $stripe_arr[$lib_color[$row[csf('stripe_color')]]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
        $stripe_arr[$lib_color[$row[csf('stripe_color')]]]['color_id']=$row[csf('stripe_color')];
    }

    $ydw_sql = "SELECT a.supplier_id,a.booking_date,b.mst_id,b.yarn_color, b.yarn_wo_qty  from wo_yarn_dyeing_mst a, wo_yarn_dyeing_dtls b where a.id=b.mst_id and b.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.supplier_id,a.booking_date,b.mst_id,b.yarn_color, b.yarn_wo_qty ";
 
    $ydw_data = sql_select($ydw_sql);

    $yarn_description_arr = array();
    $yarn_dying_wo_summary = array();
    $factorywise_workorder_data_arr = array();
    foreach ($ydw_data as $row) {
        $work_order_ids .= $row[csf('mst_id')].",";  

        $yarn_dying_wo_summary[$row[csf('yarn_color')]] += $row[csf('yarn_wo_qty')];

        $factorywise_workorder_data_arr[$row[csf('supplier_id')]][$lib_color[$row[csf('yarn_color')]]]['yarn_wo_qty'] +=  $row[csf('yarn_wo_qty')];
        $factorywise_workorder_data_arr[$row[csf('supplier_id')]][$lib_color[$row[csf('yarn_color')]]]['booking_date'] =  $row[csf('booking_date')];
        $factorywise_workorder_data_arr[$row[csf('supplier_id')]][$lib_color[$row[csf('yarn_color')]]]['booking_id'] =  $row[csf('mst_id')];
        $factorywise_workorder_data_arr[$row[csf('supplier_id')]][$lib_color[$row[csf('yarn_color')]]]['supplier_id'] =  $row[csf('supplier_id')];
        $factorywise_workorder_data_arr[$row[csf('supplier_id')]][$lib_color[$row[csf('yarn_color')]]]['yarn_color'] =  $row[csf('yarn_color')];

    }

    $work_order_ids = implode(",",array_unique(explode(",",chop($work_order_ids,","))));

    $sql_received = "SELECT a.supplier_id,max(b.receive_date) as receive_date,sum(a.grey_quantity) as grey_used_qnty,sum(a.cons_quantity) as recv_qnty,c.color from inv_transaction a, inv_receive_master b, product_details_master c where a.mst_id=b.id and a.prod_id=c.id and b.entry_form=1 and b.receive_basis=2 and b.receive_purpose=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.item_category=1 and a.transaction_type=1 and a.job_no in('$job_no') and b.booking_id in($work_order_ids) and c.dyed_type=1 group by a.supplier_id,c.color";
    // echo $sql_received;

    $receivedData = sql_select($sql_received);

    $receivedDataArr = array();
    foreach ($receivedData as $row) {
        $receivedDataArr[$row[csf('color')]]['rcv_qty'] += $row[csf('recv_qnty')];
        $receivedDataArr[$row[csf('color')]]['grey_used_qty'] += $row[csf('grey_used_qnty')];

        $factorywiseReceivedDataArr[$row[csf('supplier_id')]][$row[csf('color')]]['rcv_qty'] += $row[csf('recv_qnty')];
        $factorywiseReceivedDataArr[$row[csf('supplier_id')]][$row[csf('color')]]['grey_used_qty'] += $row[csf('grey_used_qnty')];
        $factorywiseReceivedDataArr[$row[csf('supplier_id')]][$row[csf('color')]]['crv_date'] = $row[csf('receive_date')];
    }

    $sql_issue = "SELECT a.knit_dye_company,b.prod_id,sum(b.cons_quantity) as issue_qty,max(a.issue_date) as last_issue_date,c.yarn_comp_type1st,c.yarn_comp_type2nd,c.yarn_count_id from inv_issue_master a, inv_transaction b,product_details_master c where a.id=b.mst_id and b.prod_id=c.id and a.issue_purpose=2 and a.issue_basis=1 and a.item_category=1 and booking_id in ($work_order_ids) and b.item_category=1 and b.transaction_type=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.knit_dye_company,b.prod_id,c.yarn_comp_type1st,c.yarn_comp_type2nd,c.yarn_count_id,b.cons_quantity ";  

    $issue_data = sql_select($sql_issue);

    foreach ($issue_data as $row) {
        $dcompany = $row[csf('knit_dye_company')];
        $comp_type1 = $row[csf('yarn_comp_type1st')]; 
        $comp_type2 = $row[csf('yarn_comp_type2nd')];
        $count_id = $row[csf('yarn_count_id')];

        $factorywiseIssueDataArr[$dcompany][$comp_type1][$comp_type2][$count_id]['issue_qty'] += $row[csf('issue_qty')];

        $factorywiseIssueDataArr[$dcompany][$comp_type1][$comp_type2][$count_id]['last_issue_date'] = $row[csf('last_issue_date')];

        $factorywiseIssueDataArr[$dcompany][$comp_type1][$comp_type2][$count_id]['yarn_comp_type1st'] = $row[csf('yarn_comp_type1st')];
        $factorywiseIssueDataArr[$dcompany][$comp_type1][$comp_type2][$count_id]['yarn_comp_type2nd'] = $row[csf('yarn_comp_type2nd')];
        $factorywiseIssueDataArr[$dcompany][$comp_type1][$comp_type2][$count_id]['yarn_count_id'] = $row[csf('yarn_count_id')];
        $factorywiseIssueDataArr[$dcompany][$comp_type1][$comp_type2][$count_id]['knit_dye_company'] = $row[csf('knit_dye_company')];

        $lastIssueDate = strtotime($row[csf('last_issue_date')]);

        $factMaxDateWiseIssue[$dcompany][$comp_type1][$comp_type2][$count_id][$lastIssueDate] = $lastIssueDate;
        $factDateWiseIssue[$dcompany][$comp_type1][$comp_type2][$count_id][$lastIssueDate]['qty'] += $row[csf('issue_qty')];
    }

    //echo "<pre>";
    //print_r($factDateWiseIssue);
    ?>

    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>

    <div class="main" style="width: 1000px;" id="details_reports">
        <div class="header_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="980" id="myTable">
                <caption style="font-size:20px;"><b>Yarn Dyeing Status</b></caption>
                <thead>                             
                    <tr>
                        <th colspan="4" align="left">Style Name: <? echo $sqlOrderRes[0]['STYLE'];?></th>
                         
                        <th colspan="9" align="left">IR NO: <? echo $sqlOrderRes[0]['INT_REF'];?></th>
                         
                    </tr>
                    <tr>
                        <th width="70">Color</th>
                        <th width="70">Req Qty (fin)</th>
                        <th width="70">Req Qty ( Gray)</th>
                        <th width="70">Excess Qty(Fin)</th>
                        <th width="70">Exc Qty(Gay)</th>
                        <th width="70">Cal PL%</th>
                        <th width="70">WO Qty (Gray)</th>
                        <th width="70">WO Bal</th>
                        <th width="70">Rcv As Gray</th>
                        <th width="70">Rcv As Finish(Ok )</th>
                        <th width="70">Rcv As Finish(Rej)</th>
                        <th width="70">Rcv Bal as Fin</th>
                        <th width="70">Act PL%</th>              
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    $totalPrecost_req_qty = 0;
                    ksort($stripe_arr);
                    foreach($stripe_arr as $strip_color_name=>$s_color_val)
                    {
                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                        $strip_color_id = $s_color_val['color_id'];

                        $fabreqtotkg=$s_color_val['fabreqtotkg'];
                        $wo_qty = $yarn_dying_wo_summary[$strip_color_id];
                        $wo_balance = ($fabreqtotkg-$wo_qty);

                        $rcvQty = $receivedDataArr[$strip_color_id]['rcv_qty'];
                        $greyUsedQty = $receivedDataArr[$strip_color_id]['grey_used_qty'];

                        $acpl = (($wo_qty-$rcvQty)/$wo_qty)*100;
                        
                        ?>                        
                        <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                            <td title="<?=$strip_color_name;?>"><?=substr($strip_color_name,0,9);?></td>
                            <td align="right">0</td>
                            <td align="right"><? echo fn_number_format($fabreqtotkg,0);?></td>
                            <td align="right">0</td>
                            <td align="right">0</td>
                            <td align="right">0</td>
                            <td align="right"><? echo fn_number_format($wo_qty,0);?></td>
                            <td align="right"><? echo fn_number_format($wo_balance,0); ?></td>
                            <td align="right"><? echo fn_number_format($greyUsedQty,0);?></td>
                            <td align="right"><? echo fn_number_format($rcvQty,0);?></td>
                            <td align="right">0</td>
                            <td align="right">0</td>
                            <td align="right"><? echo fn_number_format($acpl,2,'.',''); ?></td>
                        </tr>
                        <?
                        $i++;  
                        $total_fabreqtotkg += $fabreqtotkg ;
                        $total_yarn_wo_qty += $wo_qty;
                        $total_wo_balance += $wo_balance;
                        $total_rcv_qty += $rcvQty;                    
                        $total_grey_used += $greyUsedQty;                    
                    }                  
                    ?>
                </tbody>

                <tfoot>
                    <th>Grand Total</th> 
                    <th align="right">0</th>
                    <th align="right"><? echo fn_number_format($total_fabreqtotkg,0,'.',''); ?></th>
                    <th align="right">0</th>
                    <th align="right">0</th>                    
                    <th align="right">0</th>
                    <th align="right"><? echo fn_number_format($total_yarn_wo_qty,0,'.',''); ?></th>
                    <th align="right"><? echo fn_number_format($total_wo_balance,0,'.',''); ?></th>
                    <th align="right"><? echo fn_number_format($total_grey_used,0,'.',''); ?></th>
                    <th align="right"><? echo fn_number_format($total_rcv_qty,0,'.',''); ?></th>
                    <th align="right">0</th>
                    <th align="right">0</th>
                    <th align="right">
                    <? 
                       $total_acpl =  (($total_yarn_wo_qty-$total_rcv_qty)/$total_yarn_wo_qty)*100;
                       echo fn_number_format($total_acpl,2,'.',''); 
                    ?>
                    </th>
                </tfoot>

            </table>
        </div>

        <div class="header_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="980"  id="myTable2">
                <caption style="font-size:20px;"><b>Factory Wise</b></caption>
                <thead>                                                
                    <tr>
                        <th width="150">Yarn Dyeing Factory</th>
                        <th width="70">Color</th>
                        <th width="70">WO Qty (Gray)</th>
                        <th width="70">WO Qty (Fin)</th>
                        <th width="70">Program Date</th>
                        <th width="70">Cal PL%</th>
                        <th width="70">Rcv As Gray</th>
                        <th width="70">Rcv As Finish(Ok )</th>
                        <th width="70">Rcv As Finish(Rej)</th>
                        <th width="70">Rcv Bal as Gray</th>
                        <th width="70">Act PL%</th>
                        <th width="70">Last Rcv date</th>           
                    </tr>
                </thead>
                <tbody>
                    <?
                    $j=1;
                    $suplier_data_array = array();
                    $grandTotalWorkOrderQty = 0;
                    $grandTotalRcvQty = 0;
                    $grandTotalGreyUsedQty = 0;
                    $grandTotalAcpl = 0;
                    foreach ($factorywise_workorder_data_arr as $supplierId=>$colorDataArr) 
                    {
                        if(!in_array($supplierId,$dyeing_supplierArr))
                        {
                            if($j!=1)
                            {
                                ?>
                                <tr bgcolor="#CCCCCC"> 
                                   <td>&nbsp;</td> 
                                   <td align="right"><b>Sub Total</b></td> 
                                   <td align="right"><? echo fn_number_format($subTotalWorkOrderQty,0,'.',''); ?></td> 
                                   <td>&nbsp;</td>
                                   <td>&nbsp;</td>
                                   <td>&nbsp;</td>
                                   <td align="right"><? echo fn_number_format($subTotalGreyUsedQty,0,'.',''); ?></td> 
                                   <td align="right"><? echo fn_number_format($subTotalRcvQty,0,'.',''); ?></td> 
                                   <td>&nbsp;</td>
                                   <td>&nbsp;</td>
                                   <td align="right">
                                    <? 
                                    $subTotalAcpl = (($subTotalWorkOrderQty-$subTotalRcvQty)/$subTotalWorkOrderQty)*100;;
                                    echo fn_number_format($subTotalAcpl,2,'.',''); 
                                    ?>                                       
                                   </td>
                                   <td>&nbsp;</td>
                                </tr>
                                <?
                                $subTotalWorkOrderQty = 0;
                                $subTotalRcvQty = 0;
                                $subTotalAcpl = 0;
                            }
                            $dyeing_supplierArr[$j]=$supplierId;
                        }
                        $rowspan = count($factorywise_workorder_data_arr[$supplierId]);
                        ?>
                        <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">                               
                            <td rowspan="<? echo $rowspan;?>" ><? echo $lib_supplier[$supplierId];?></td>
                        <?
                        ksort($colorDataArr);
                        foreach ($colorDataArr as $colorName=>$row) 
                        {
                            $colorId=$row['yarn_color'];
                            $greyUsedQty = $factorywiseReceivedDataArr[$supplierId][$colorId]['grey_used_qty'];
                            $rcvQty = $factorywiseReceivedDataArr[$supplierId][$colorId]['rcv_qty'];
                            $rcvDate = $factorywiseReceivedDataArr[$supplierId][$colorId]['crv_date'];
                            $acpl = (($row['yarn_wo_qty']-$rcvQty)/$row['yarn_wo_qty'])*100;

                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                                                    
                                <td title="<?=$colorName;?>"><?=substr($colorName,0,9);?></td>
                                <td align="right"><? echo fn_number_format($row['yarn_wo_qty'],0,'.','');?></td>
                                <td>&nbsp;</td>
                                <td><? echo change_date_format($row['booking_date']);?></td>
                                <td>&nbsp;</td>
                                <td align="right"><?=fn_number_format($greyUsedQty,0);?></td>
                                <td align="right"><? echo fn_number_format($rcvQty,0,'.','');?></td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td align="right"><? echo fn_number_format($acpl,2,'.','');?></td>
                                <td><? echo change_date_format($rcvDate);?></td>
                            </tr>
                            <?
                            $subTotalWorkOrderQty +=$row['yarn_wo_qty'];
                            $subTotalRcvQty +=$rcvQty;
                            $subTotalGreyUsedQty +=$greyUsedQty;
                            $grandTotalWorkOrderQty+=$row['yarn_wo_qty'];
                            $grandTotalRcvQty+=$rcvQty;
                            $grandTotalGreyUsedQty+=$greyUsedQty;
                            $j++;  
                            $i++;  
                        }    
                    }

                    if(!empty($factorywise_workorder_data_arr))
                    {
                        ?>
                        <tr bgcolor="#CCCCCC"> 
                           <td>&nbsp;</td> 
                           <td align="right"><b>Sub Total</b></td> 
                           <td align="right"><? echo fn_number_format($subTotalWorkOrderQty,0,'.',''); ?></td> 
                           <td>&nbsp;</td>
                           <td>&nbsp;</td>
                           <td>&nbsp;</td>
                           <td align="right"><? echo fn_number_format($subTotalGreyUsedQty,0,'.',''); ?></td>
                           <td align="right"><? echo fn_number_format($subTotalRcvQty,0,'.',''); ?></td> 
                           <td>&nbsp;</td>
                           <td>&nbsp;</td>
                           <td align="right">
                            <? 
                            $subTotalAcpl = (($subTotalWorkOrderQty-$subTotalRcvQty)/$subTotalWorkOrderQty)*100;;
                            echo fn_number_format($subTotalAcpl,2,'.',''); 
                            ?>                                       
                           </td>
                           <td>&nbsp;</td>
                        </tr>
                        <?
                    }
                    ?>
                </tbody>
                <tfoot>
                    <th colspan="2">Grand Total</th> 
                    <th align="right"><? echo fn_number_format($grandTotalWorkOrderQty,0,'.',''); ?></th> 
                    <th>&nbsp;</th>
                    <th>&nbsp;</th>
                    <th>&nbsp;</th>
                    <th align="right"><? echo fn_number_format($grandTotalGreyUsedQty,0,'.',''); ?></th> 
                    <th align="right"><? echo fn_number_format($grandTotalRcvQty,0,'.',''); ?></th> 
                    <th>&nbsp;</th>
                    <th>&nbsp;</th>
                    <th align="right">
                        <? 
                        $grandTotalAcpl =  (($grandTotalWorkOrderQty-$grandTotalRcvQty)/$grandTotalWorkOrderQty)*100;
                        echo fn_number_format($grandTotalAcpl,2,'.',''); 
                        ?>   
                    </th>
                    <th>&nbsp;</th>
                </tfoot>
            </table>
        </div> 

        <div class="header_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="980">
                <caption style="font-size:20px;"><b>Yarn Sending Status</b></caption>
                <thead>                                                
                    <tr>
                        <th width="150">Yarn dyeing Factory</th>
                        <th width="70">Composition</th>
                        <th width="70">Count</th>
                        <th width="70">Req Qty</th>
                        <th width="70">Issue Qty</th>
                        <th width="70">Last issue Date</th>
                        <th width="70">Last Issue Qty</th>
                        <th width="70">Issue Bal</th>   
                    </tr>
                </thead>
                <tbody>
                    <? 
                    $count_arr = return_library_array("select id, yarn_count from lib_yarn_count where status_active=1 and is_deleted=0 ", 'id', 'yarn_count');                  
                    $k=1;
                    $grandTotalIssueQty = 0;
                    $dyeing_companyArr = array();
                    foreach ($factorywiseIssueDataArr as $dye_company=>$compType1Arr) 
                    {
                        $issue_rowspan = count($compType1Arr);
                        $r=0;

                        foreach ($compType1Arr as $compType1=>$compType2Arr) 
                        {
                            foreach ($compType2Arr as $compType2=>$countArr) 
                            {                               

                                if(!in_array($dye_company,$dyeing_companyArr))
                                {
                                    if($k!=1)
                                    {
                                        ?>
                                        <tr bgcolor="#CCCCCC">        
                                            <td width="150">&nbsp;</td>
                                           
                                            <td width="70" align="right">Sub Total</td>
                                            <td width="70">&nbsp;</td>
                                            <td width="70">&nbsp;</td>
                                            <td width="70" align="right"><? echo fn_number_format($subTotalIssueQty,0,'.',''); ?></td>
                                            <td width="70">&nbsp;</td>
                                            <td width="70" align="right"><? echo fn_number_format($subTotallastIssueQty,0,'.',''); ?></td>
                                            <td width="70">&nbsp;</td>
                                        </tr>
                                        <?
                                        $subTotalIssueQty = 0;
                                        $subTotallastIssueQty = 0;
                                    }

                                    $dyeing_companyArr[$k]=$dye_company;
                                }
                                ?>

                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $k; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $k; ?>">  
                                <? if($r==0){ ?>
                                    <td rowspan="<? echo $issue_rowspan;?>" ><? echo $lib_supplier[$dye_company];?></td>
                                    <? $r++;   
                                }
                                foreach ($countArr as $countId=>$row) 
                                {
                                    $bgcolor=($k%2==0)?"#E9F3FF":"#FFFFFF";

                                    $compositionStr =  $composition[$compType1];

                                    if($row['yarn_comp_type2nd'] !=0) 
                                    {
                                        $compositionStr .= $composition[$compType2];
                                    }
                                   
                                    //echo $dye_company."==".$compType1."==".$compType2."==".$countId."==".$row['last_issue_date'];

                                    $maxIssueDate = max($factMaxDateWiseIssue[$dye_company][$compType1][$compType2][$countId]);

                                    $last_issue_qty = $factDateWiseIssue[$dye_company][$compType1][$compType2][$countId][$maxIssueDate]['qty'];

                                    //$last_issue_qty = $factDateWiseIssue[$dye_company][$compType1][$compType2][$countId][$row['last_issue_date']];
                                    ?>                                    
                                        <td><? echo $compositionStr;?></td>
                                        <td align="center"><? echo $count_arr[$row['yarn_count_id']];?></td>
                                        <td align="right">0</td>
                                        <td align="right"><? echo fn_number_format($row['issue_qty'],0,'.',''); ?></td>
                                        <td align="center"><?  echo date('d-m-Y',$maxIssueDate);?></td>
                                        <td align="right"><? echo fn_number_format($last_issue_qty,0,'.',''); ?></td>
                                        <td align="right">0</td>
                                    </tr>
                                    <?
                                    $subTotalIssueQty += $row['issue_qty'];
                                    $subTotallastIssueQty += $last_issue_qty; 
                                    $grandTotalIssueQty += $row['issue_qty']; 
                                    $grandTotallastIssueQty += $last_issue_qty; 
                                    $k++;
                                }
                            }
                        }                     
                    }

                    if(!empty($factorywiseIssueDataArr))
                    {
                        ?>
                        <tr bgcolor="#CCCCCC">        
                            <td width="150">&nbsp;</td>
                            <td width="70">&nbsp;</td>
                            <td width="70" align="right">Sub Total</td>
                            <td width="70">&nbsp;</td>
                            <td width="70" align="right"><? echo fn_number_format($subTotalIssueQty,0,'.',''); ?></td>
                            <td width="70">&nbsp;</td>
                            <td width="70" align="right"><? echo fn_number_format($subTotallastIssueQty,0,'.',''); ?></td>
                            <td width="70">&nbsp;</td>                          
                        </tr>
                        <?
                    }
                    ?>
                </tbody>

                <tfoot>
                    <th colspan="3">Grand Total</th> 
                    <th>&nbsp;</th>
                    <th align="right"><? echo fn_number_format($grandTotalIssueQty,0,'.',''); ?></th> 
                    <th>&nbsp;</th>
                    <th align="right"><? echo fn_number_format($grandTotallastIssueQty,0,'.',''); ?></th>
                    <th>&nbsp;</th>
                </tfoot>

            </table>
        </div> 
    </div>
    <?
}

if($action=="grey_popup_bk")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    $lib_company = return_library_array("select id,company_name from lib_company", "id", "company_name");
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);
    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();
    //$costPerArr=$condition->getCostingPerArr();
    $fabric= new fabric($condition);
    //echo $fabric->getQuery();die;
    // $fabric_costing_arr=$fabric->getQtyArray_by_JobColorBodyTypeDeterminIdAndDiaWidth_knitAndwoven_greyAndfinish();

    $fabric_costing_arr=$fabric->getQtyArray_by_JobColorFabColorBodyTypeDeterminIdAndDiaWidth_knitAndwoven_greyAndfinish();
    // echo "<pre>";print_r($fabric_costing_arr);echo "</pre>";
    $main_arr = array();
    $sqlOrderRes = sql_select("SELECT a.job_no as JOB_NO, a.style_ref_no as STYLE, b.grouping as INT_REF from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id  and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in ($poIds) group by a.job_no, a.style_ref_no,  b.grouping");

    $short_sql = sql_select("SELECT B.BODY_PART_TYPE, a.grey_fab_qnty as GREY_FAB_QNTY, a.fabric_color_id as COLOR_ID, b.lib_yarn_count_deter_id as DETERMINATION_ID, a.dia_width as DIA_WIDTH, b.uom as UOM, b.job_no as JOB_NO from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b where a.pre_cost_fabric_cost_dtls_id=b.id and a.is_short=1 and a.booking_type=1 and a.po_break_down_id in ($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

    foreach ($short_sql as $val) 
    {
        $short_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETERMINATION_ID']][$val['COLOR_ID']][$val['DIA_WIDTH']][$val['UOM']]['SHORT_GREY']+=$val['GREY_FAB_QNTY']; 
    }
    // echo "<pre>";print_r($short_arr);echo "</pre>";

    $grey_sql = sql_select("SELECT e.BOOKING_ID,d.job_no_mst as JOB_NO, e.receive_date as RECEIVE_DATE, b.color_id as COLOR_ID, b.width as WIDTH, b.uom as UOM, b.febric_description_id as FEBRIC_DESCRIPTION_ID, c.body_part_type as BODY_PART_TYPE, e.knitting_company as KNITTING_COMPANY, e.knitting_source as KNITTING_SOURCE, b.machine_dia as MACHINE_DIA, sum(a.quantity) as QUANTITY from inv_receive_master e, order_wise_pro_details a, pro_grey_prod_entry_dtls b left join lib_body_part c on b.body_part_id = c.id, wo_po_break_down d where e.id = b.mst_id and e.entry_form in (2,22,58) and a.dtls_id=b.id and a.trans_id=b.trans_id and A.PO_BREAKDOWN_ID=d.id and a.entry_form in (2,22,58) and a.trans_id >0 and a.po_breakdown_id in ($poIds) and a.is_sales=0 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted=0 group by e.booking_id,d.job_no_mst, b.color_id, b.width, b.uom, b.febric_description_id, c.body_part_type, e.knitting_company, e.knitting_source, b.machine_dia, e.receive_date order by e.receive_date asc");

    foreach ($grey_sql as $val) 
    {
        if($grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE'] =="")
        {
            $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_QTY'] = $val['QUANTITY'];
            $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
        }
        else
        {
            if(strtotime($grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE']) == strtotime($val['RECEIVE_DATE']))
            {
                $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_QTY'] += $val['QUANTITY'];
                $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
            }
            else if(strtotime($grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE']) < strtotime($val['RECEIVE_DATE']))
            {
                $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_QTY'] = $val['QUANTITY'];
                $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
            }
        }

        if($factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE'] == "")
        {
            $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_QTY'] = $val['QUANTITY'];
            $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
        }
        else
        {
            if(strtotime($factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE']) == strtotime($val['RECEIVE_DATE']))
            {
                $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_QTY'] += $val['QUANTITY'];
                $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
            } 
            else if(strtotime($factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE']) < strtotime($val['RECEIVE_DATE']))
            {
                $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_QTY'] = $val['QUANTITY'];
                $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
            }
        }

       $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['GREY_QTY'] += $val['QUANTITY'];
       $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['FACT_GREY_QTY'] += $val['QUANTITY'];
    }

    /*echo "<pre>";
    print_r($factory_wise_rcv);
    die;*/


    $program_sql = "SELECT b.id as PROGRAM_NO, d.job_no_mst as JOB_NO, e.body_part_type as BODY_PART_TYPE, b.color_id as COLOR_ID, c.determination_id as DETER_ID, c.dia as DIA, b.knitting_source as KNITTING_SOURCE, b.knitting_party as KNITTING_PARTY, max(b.start_date) as START_DATE, max(b.end_date) as END_DATE, max(b.program_date) as PROGRAM_DATE, b.machine_dia as MACHINE_DIA, sum(c.program_qnty) as PROGRAM_QNTY from ppl_planning_info_entry_mst a left join lib_body_part e on a.body_part_id=e.id, ppl_planning_info_entry_dtls b, ppl_planning_entry_plan_dtls c, wo_po_break_down d where a.id=b.mst_id and b.id =c.dtls_id and a.id=c.mst_id and c.po_id =d.id and c.po_id in ($poIds) and a.status_active=1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by b.id, d.job_no_mst, e.body_part_type, b.color_id, c.determination_id, c.dia, b.knitting_source, b.knitting_party, b.machine_dia";
    // echo $program_sql;
    $program_res = sql_select($program_sql);
    
    foreach ($program_res as $val) 
    {
        $program_nos[$val['PROGRAM_NO']]=$val['PROGRAM_NO'];
        $program_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['COLOR_ID']][$val['DIA']]['PROGRAM_QNTY'] += $val['PROGRAM_QNTY'];
        $program_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['COLOR_ID']][$val['DIA']]['PROGRAM_DATE'] = $val['PROGRAM_DATE'];


        $desc_str = $val['DETER_ID']."*".$val['MACHINE_DIA']."*".$val['DIA']."*".$val['COLOR_ID'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }else{
            $type_name = 'CIRCULAR';
        }

        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['COLOR_ID'] = $val['COLOR_ID'];
        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['START_DATE'] = $val['START_DATE'];
        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['END_DATE'] = $val['END_DATE'];
        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['PROGRAM_DATE'] = $val['PROGRAM_DATE'];
        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['PROGRAM_QNTY'] += $val['PROGRAM_QNTY'];
        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['FACT_GREY_QTY'] += $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_PARTY']][$val['MACHINE_DIA']][$val['DETER_ID']][$val['COLOR_ID']][$val['DIA']][$val['PROGRAM_NO']]['FACT_GREY_QTY'];

        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['LAST_GREY_DATE'] = $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_PARTY']][$val['MACHINE_DIA']][$val['DETER_ID']][$val['COLOR_ID']][$val['DIA']][$val['PROGRAM_NO']]['LAST_GREY_DATE'];

        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['LAST_GREY_QTY'] += $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_PARTY']][$val['MACHINE_DIA']][$val['DETER_ID']][$val['COLOR_ID']][$val['DIA']][$val['PROGRAM_NO']]['LAST_GREY_QTY'];

        //echo "[".$val['JOB_NO']."][".$val['BODY_PART_TYPE']."][".$val['KNITTING_SOURCE']."][".$val['KNITTING_PARTY']."][".$val['DETER_ID']."][".$val['COLOR_ID']."][".$val['DIA']."]<br>";

    }

    // echo "<pre>";  print_r($factory_wise_arr);die;
    $batch_sql = sql_select("SELECT a.batch_no, d.job_no_mst as JOB_NO,a.color_id as COLOR_ID, b.batch_qnty as BATCH_QNTY,c.gsm as GSM, c.dia_width as DIA_WIDTH, c.detarmination_id as DETARMINATION_ID, b.body_part_id as BODY_PART_ID, e.body_part_type as BODY_PART_TYPE, c.unit_of_measure as UOM from pro_batch_create_mst a, pro_batch_create_dtls b left join lib_body_part e on b.body_part_id = e.id, product_details_master c, wo_po_break_down d where a.id=b.mst_id and b.prod_id=c.id and b.po_id=d.id $ext_cond and b.po_id in ($poIds) and b.is_sales =0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

    foreach ($batch_sql as $val) 
    {
        $desc_str = $val['DETARMINATION_ID']."*".$val['COLOR_ID']."*".$val['DIA_WIDTH']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }

        // $batch_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETARMINATION_ID']][$val['COLOR_ID']][$val['DIA_WIDTH']][$val['UOM']] +=$val['BATCH_QNTY'];
        $main_arr[$type_name][$desc_str]['BATCH_QTY'] += $val['BATCH_QNTY'];
    }

    // ====================================================================================

    $sqlGreyRcv = "SELECT c.febric_description_id as DETER_ID, d.quantity as QTY,c.UOM,c.COLOR_ID,c.width as DIA from inv_receive_master a, inv_transaction b,pro_grey_prod_entry_dtls c,order_wise_pro_details d where a.id=b.mst_id and b.id=c.trans_id and a.id=c.mst_id and b.id=d.trans_id and c.id=d.dtls_id and d.trans_type=1 and b.item_category=13 and a.status_active=1 and b.status_active=1 and c.status_active=1 and d.po_breakdown_id in($poIds)";
    // echo $sqlGreyRcv;die();
    $sqlRes = sql_select($sqlGreyRcv);
    $receive_qty_array = array();
    $desc_str="";
    foreach ($sqlRes as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['COLOR_ID']."*".$val['DIA']."*".$val['UOM'];
        $receive_qty_array[$desc_str] += $val['QTY'];
    }

    // ======================================================================================
    $sqlGreyIssue = "SELECT c.detarmination_id as DETER_ID, d.quantity as QTY,c.unit_of_measure as UOM,e.COLOR_ID,c.dia_width as DIA from inv_issue_master a, inv_transaction b,product_details_master c,order_wise_pro_details d,inv_grey_fabric_issue_dtls e where a.id=b.mst_id and c.id=d.prod_id and b.id=d.trans_id and c.id=b.prod_id and e.trans_id=b.id and a.id=e.mst_id and e.prod_id=c.id and d.trans_type=2 and b.item_category=13 and c.item_category_id=13 and a.status_active=1 and b.status_active=1 and c.status_active=1 and d.po_breakdown_id in($poIds)";
    // echo $sqlGreyIssue;die();
    $sqlRes = sql_select($sqlGreyIssue);
    $issue_qty_array = array();
    $desc_str="";
    foreach ($sqlRes as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['COLOR_ID']."*".$val['DIA']."*".$val['UOM'];
        $issue_qty_array[$desc_str] += $val['QTY'];
    }

    $sql = "SELECT a.job_no as JOB_NO, a.color_number_id as COLOR_ID,b.COLOR_SIZE_SENSITIVE, b.lib_yarn_count_deter_id as DETER_ID, b.uom as UOM, a.dia_width as DIA,b.FABRIC_SOURCE, b.body_part_type as BODY_PART_TYPE,c.CONTRAST_COLOR_ID from wo_pre_cos_fab_co_avg_con_dtls a, wo_pre_cost_fabric_cost_dtls b LEFT JOIN wo_pre_cos_fab_co_color_dtls c ON b.job_no = c.job_no and b.id=c.pre_cost_fabric_cost_dtls_id  AND c.status_active = 1 
       AND c.is_deleted = 0 where a.pre_cost_fabric_cost_dtls_id =b.id and a.po_break_down_id in ($poIds) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.cons !=0 group by a.job_no, a.color_number_id, b.lib_yarn_count_deter_id, b.uom, a.dia_width,  b.body_part_type,c.contrast_color_id,b.color_size_sensitive,b.fabric_source order by b.body_part_type, b.lib_yarn_count_deter_id";
    // echo $sql;
    $res = sql_select($sql);

    $desc_str="";//$type_name="";
    $job_no = '';
    $program_chk_arr = array();
    $grey_rcv_chk_arr = array();
    foreach ($res as $val) 
    { 
        if($val['COLOR_SIZE_SENSITIVE']==3)
        {
            $color_id=$val['CONTRAST_COLOR_ID'];
        }
        else
        {
            $color_id=$val['COLOR_ID'];
        }

        $desc_str = $val['DETER_ID']."*".$color_id."*".$val['DIA']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }

        if($val['FABRIC_SOURCE']==1) // only production
        {
            $main_arr[$type_name][$desc_str]['FAB_KNIT_GREY'] += $fabric_costing_arr['knit']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['DIA']][$val['UOM']];
            $main_arr[$type_name][$desc_str]['FAB_WOVEN_GREY'] += $fabric_costing_arr['woven']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['DIA']][$val['UOM']];
        

            $main_arr[$type_name][$desc_str]['COLOR_ID'] = $color_id;

            if($program_chk_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']]=="")
            {
                $main_arr[$type_name][$desc_str]['PROGRAM_QNTY'] += $program_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']]['PROGRAM_QNTY'];
                $program_chk_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']]="porimoni";
            }

            if($grey_rcv_chk_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]=="")
            {
                $main_arr[$type_name][$desc_str]['SHORT_GREY'] += $short_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]['SHORT_GREY'];

                $main_arr[$type_name][$desc_str]['GREY_QTY'] += $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]['GREY_QTY'];
                // $main_arr[$type_name][$desc_str]['BATCH_QTY'] += $batch_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']];
                $grey_rcv_chk_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]="porimoni";
            }
            
            $main_arr[$type_name][$desc_str]['PROGRAM_DATE'] = $program_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']]['PROGRAM_DATE'];
            $main_arr[$type_name][$desc_str]['LAST_GREY_DATE'] = $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]['LAST_GREY_DATE'];
            $main_arr[$type_name][$desc_str]['LAST_GREY_QTY'] = $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]['LAST_GREY_QTY'];
        }

        if($val['COLOR_SIZE_SENSITIVE']==3)
        {
            $grey_fab_req_qty = $fabric_costing_arr['knit']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['DIA']][$val['UOM']];
            $wvn_fab_req_qty = $fabric_costing_arr['woven']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['DIA']][$val['UOM']];

            $contrust_qty_array[$type_name][$val['COLOR_ID']][$desc_str]['contrast_color_id'] = $val['CONTRAST_COLOR_ID'];
            $contrust_qty_array[$type_name][$val['COLOR_ID']][$desc_str]['grey_fab_req_qty'] = $grey_fab_req_qty;
            $contrust_qty_array[$type_name][$val['COLOR_ID']][$desc_str]['wvn_fab_req_qty']  = $wvn_fab_req_qty;
        }
        $job_no = $val['JOB_NO'];
    }

    /*======================================================================================/
    /                                    grey fab transfer                                  /
    /======================================================================================*/

    $sql_in="SELECT a.to_order_id,b.uom,b.transfer_qnty as qnty, e.body_part_type as BODY_PART_TYPE, c.color_id as COLOR_ID, c.id as PROGRAM_NO,f.determination_id as DETER_ID, f.dia as DIA, c.knitting_source as KNITTING_SOURCE, c.knitting_party as KNITTING_PARTY,c.machine_dia as MACHINE_DIA FROM inv_item_transfer_mst a, inv_item_transfer_dtls b, ppl_planning_entry_plan_dtls f, ppl_planning_info_entry_dtls c, ppl_planning_info_entry_mst d left join lib_body_part e on d.body_part_id=e.id WHERE a.id = b.mst_id and d.id=c.mst_id and c.id =f.dtls_id and d.id=f.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=13 and a.entry_form in(13) and a.transfer_criteria=4 and a.to_order_id in($poIds) and c.status_active=1 and c.is_deleted=0 and b.to_program=c.id and b.active_dtls_id_in_transfer=1";
    // echo $sql_in;die();
    $result = sql_select($sql_in);
    foreach ($result as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['COLOR_ID']."*".$val['DIA']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }
        $main_arr[$type_name][$desc_str]['trans_in'] += $val['QNTY'];

        // ===================================================
        $desc_str = $val['DETER_ID']."*".$val['MACHINE_DIA']."*".$val['DIA']."*".$val['COLOR_ID'];

        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['trans_in'] += $val['QNTY'];
    }
    // ========================================================
    $sql_in="SELECT a.from_order_id,b.uom,b.transfer_qnty as qnty, e.body_part_type as BODY_PART_TYPE, c.color_id as COLOR_ID, c.id as PROGRAM_NO,f.determination_id as DETER_ID, f.dia as DIA, c.knitting_source as KNITTING_SOURCE, c.knitting_party as KNITTING_PARTY,c.machine_dia as MACHINE_DIA FROM inv_item_transfer_mst a, inv_item_transfer_dtls b, ppl_planning_entry_plan_dtls f, ppl_planning_info_entry_dtls c, ppl_planning_info_entry_mst d left join lib_body_part e on d.body_part_id=e.id WHERE a.id = b.mst_id and d.id=c.mst_id and c.id =f.dtls_id and d.id=f.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=13 and a.entry_form in(13) and a.transfer_criteria=4 and a.from_order_id in($poIds) and c.status_active=1 and c.is_deleted=0 and b.from_program=c.id and b.active_dtls_id_in_transfer=1";
    // echo $sql_in;die();
    $result = sql_select($sql_in);
    foreach ($result as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['COLOR_ID']."*".$val['DIA']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }
        $main_arr[$type_name][$desc_str]['trans_out'] += $val['QNTY'];

        // ===================================================
        $desc_str = $val['DETER_ID']."*".$val['MACHINE_DIA']."*".$val['DIA']."*".$val['COLOR_ID'];

        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['trans_out'] += $val['QNTY'];
    }
    // echo "<pre>";print_r($main_arr);die();

    // ====================================================================================
    
    // echo "<pre>"; print_r($contrust_qty_array);die;

    $gmt_color_library=array();//fabric_cost_dtls_id
    $gmt_color_data=sql_select("SELECT a.body_part_id,b.gmts_color_id, b.contrast_color_id  FROM  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b 
    WHERE a.id=b.pre_cost_fabric_cost_dtls_id  and  a.job_no='$job_no' and a.color_size_sensitive=3");
 
    foreach( $gmt_color_data as $gmt_color_row)
    {
        $gmt_color_library[$gmt_color_row[csf("gmts_color_id")]].= sizeof($gmt_color_library[$gmt_color_row[csf("gmts_color_id")]]) ? ",".$gmt_color_row[csf("contrast_color_id")] : $gmt_color_row[csf("contrast_color_id")];
    }
    // echo "<pre>";print_r($gmt_color_library);die();

    // ===================== get contrust color wise req qty ========================
    $contrust_color_qty_array = array();
    $gmts_color_array = array();
    foreach ($contrust_qty_array as $btype => $btype_data) 
    {
        foreach ($btype_data as $gmt_color => $color_data) 
        {
            foreach ($color_data as $str_k => $row) 
            {
                // $gmt_color_ex = explode("_", $gmt_color);
                $gmts_color_array[$gmt_color] = $gmt_color;
                $gmt_color_ex = array_unique(explode(",", $gmt_color_library[$gmt_color]));
                foreach ($gmt_color_ex as $key => $value) 
                {           
                    $contrust_color_qty_array[$btype][$value][$str_k]['grey_fab_req_qty'] += $row['grey_fab_req_qty'];                
                    $contrust_color_qty_array[$btype][$value][$str_k]['wvn_fab_req_qty'] += $row['wvn_fab_req_qty'];
                }                                
            }
        }        
    }
    // echo "<pre>";print_r($contrust_color_qty_array);die();

    $constructtion_arr=array();
    $sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id order by b.id asc";
    $data_array_deter=sql_select($sql_deter);
    foreach( $data_array_deter as $row )
    {
        $constructtion_arr[$row[csf('id')]]=$row[csf('construction')];
        $composition_arr[$row[csf('id')]].=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ";
    }
    unset($data_array_deter);
    $acting_width = $screen_size-100;
    $four_percent = $acting_width*0.04;
    $five_percent = $acting_width*0.05;
    $six_percent = $acting_width*0.06;
    ?>
    <!-- ========================================== Grey Fabric Status =============================== -->
    <style type="text/css">
        .word_break_wrap{
            word-wrap: break-word;
            word-break: break-all;
        }
    </style>
    <div id="data_panel" align="center" style="width:<? echo $acting_width;?>px">
        <script>
            function new_window()
            {
                document.getElementById('scroll_body').style.overflow="auto";
                document.getElementById('scroll_body').style.maxHeight="none";
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
                document.getElementById('scroll_body').style.overflowY="scroll";
                document.getElementById('scroll_body').style.maxHeight="240px";
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: <? echo $acting_width;?>px;" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="<? echo $acting_width;?>">
                <caption style="font-size:20px;"><b>Grey Fabric Status</b></caption>
                <tbody>
                    <tr>
                        <td colspan="19" width="<? echo $acting_width;?>"><b>Style Name:<? echo $sqlOrderRes[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref:<? echo $sqlOrderRes[0]['INT_REF'];?></b></td>
                    </tr>
                </tbody>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width;?>">
                <thead>
                    <tr>                                   
                        <th width="<? echo $six_percent;?>">Knit Type</th>
                        <th width="<? echo $six_percent;?>">Fabric Structure</th>
                        <th width="<? echo $six_percent;?>">Color/ Combo</th>
                        <th width="<? echo $four_percent;?>">Finish Dia</th>
                        <th width="<? echo $four_percent;?>">Unit</th>
                        <th width="<? echo $six_percent;?>">Req Qty</th>

                        <th width="<? echo $six_percent;?>">Excess Qty</th>
                        <th width="<? echo $six_percent;?>">Total Req</th>
                        <th width="<? echo $six_percent;?>">Program Qty</th>
                        <th width="<? echo $six_percent;?>">Program Bal</th>
                        <th width="<? echo $six_percent;?>">Last Program Date</th>
                        <th width="<? echo $six_percent;?>">Gray Rcv Qty</th>
                        <th width="<? echo $six_percent;?>">Last Rcv qty</th>
                        <th width="<? echo $six_percent;?>">Last Rcv Date</th>
                        <th width="<? echo $six_percent;?>">Trans In</th>
                        <th width="<? echo $six_percent;?>">Trans Out</th>
                        <th width="<? echo $six_percent;?>">Gray Rcv Bal</th>
                        <th width="<? echo $six_percent;?>">Batch Qty</th>
                        <th width="<? echo $six_percent;?>">Stock At Gray Store</th>
                    </tr>
                </thead>
            </table>
            <div id="scroll_body" style="width:<? echo $acting_width+18;?>px; max-height:240px;overflow-y:scroll;">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width;?>">
                    <tbody>
                        <?

                        $i=0;
                        foreach ($main_arr as $type => $type_data) 
                        {
                            $y=1;
                            foreach ($type_data as $dSrt => $val) 
                            {
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF";
                                $dSrt_data = explode("*", $dSrt);
                                $DETER_ID = $dSrt_data[0];
                                $COLOR = $dSrt_data[1];
                                $DIA = $dSrt_data[2];
                                $UOM = $dSrt_data[3];

                                $grey_required = $val['FAB_KNIT_GREY'] + $val['FAB_WOVEN_GREY'];// + $contrust_color_qty_array[$type][$COLOR][$dSrt]['grey_fab_req_qty'];
                                $total_required = $grey_required+$val['SHORT_GREY'];
                                $program_balance = $total_required - $val['PROGRAM_QNTY'];
                                $grey_rcv_balance = ($total_required+$val['trans_out']) - ($val['GREY_QTY']+$val['trans_in']);

                                $grey_rcv_qty = $receive_qty_array[$dSrt];
                                $grey_issue_qty = $issue_qty_array[$dSrt];
                                $stock_at_store = ($grey_rcv_qty+$val['trans_in']) - ($grey_issue_qty+$val['trans_out']);
                                // echo "(".$grey_rcv_qty."+".$val['trans_in'].") - (".$grey_issue_qty."+".$val['trans_out'].")<br>";
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                    <?
                                    if($y==1)
                                    {
                                        ?>
                                        <td valign="middle" width="<? echo $six_percent;?>" rowspan="<? echo count($type_data)?>"><? echo $type;?></td>
                                        <?
                                    } 
                                    ?>                              
                                    <td width="<? echo $six_percent;?>" align="center"><p class="word_break_wrap"><? echo $constructtion_arr[$DETER_ID];//.", ".$composition_arr[$DETER_ID];?></p></td>
                                    <td width="<? echo $six_percent;?>" align="center"><? echo $lib_color[$COLOR];?></td>
                                    <td width="<? echo $four_percent;?>" align="center"><? echo $DIA;?></td>
                                    <td width="<? echo $four_percent;?>" align="center"><? echo $unit_of_measurement[$UOM];?></td>
                                    <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($grey_required,0);?></td>
                                    <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['SHORT_GREY'],0);?></td>
                                    <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($total_required,0);?></td>
                                    <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['PROGRAM_QNTY'],0);?></td>
                                    <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($program_balance,0);?></td>
                                    <td width="<? echo $six_percent;?>" align="center"><? echo change_date_format($val['PROGRAM_DATE']);?></td>
                                    <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['GREY_QTY'],0);?></td>
                                    <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['LAST_GREY_QTY'],0);?></td>
                                    <td width="<? echo $six_percent;?>" align="center"><? echo change_date_format($val['LAST_GREY_DATE']);?></td>
                                    <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['trans_in'],0);?></td>
                                    <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['trans_out'],0);?></td>
                                    <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($grey_rcv_balance,0); ?></td>
                                    <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['BATCH_QTY'],0) ?></td>
                                    <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($stock_at_store,0);?></td>
                                </tr>
                                <?
                                $i++; 
                                $y++;
                                $tot_grey_required +=$grey_required;
                                $tot_short_grey +=$val['SHORT_GREY'];
                                $tot_total_required +=$total_required;
                                $tot_program_qnty += $val['PROGRAM_QNTY'];
                                $tot_program_balance +=$program_balance;
                                $tot_grey_qnty +=$val['GREY_QTY'];
                                $tot_last_grey_qty += $val['LAST_GREY_QTY'];
                                $tot_grey_rcv_balance +=$grey_rcv_balance;
                                $tot_batch_qty +=$val['BATCH_QTY'];
                                $tot_stock_at_store +=$stock_at_store;
                                $tot_trans_in +=$val['trans_in'];
                                $tot_trans_out +=$val['trans_out'];

                                $sub_grey_required +=$grey_required;
                                $sub_short_grey +=$val['SHORT_GREY'];
                                $sub_total_required +=$total_required;
                                $sub_program_qnty += $val['PROGRAM_QNTY'];
                                $sub_program_balance +=$program_balance;
                                $sub_grey_qnty +=$val['GREY_QTY'];
                                $sub_last_grey_qty += $val['LAST_GREY_QTY'];
                                $sub_grey_rcv_balance +=$grey_rcv_balance;
                                $sub_batch_qty +=$val['BATCH_QTY'];
                                $sub_stock_at_store +=$stock_at_store;
                                $sub_trans_in +=$val['trans_in'];
                                $sub_trans_out +=$val['trans_out'];
                            }
                            ?>
                                <tr bgcolor="#ccc">
                                    <td align="right" width="<? echo $six_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $six_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $six_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $four_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $four_percent;?>"><strong>Total:</strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_grey_required,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_short_grey,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_total_required,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_program_qnty,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_program_balance,0);?></td>
                                    <td align="right" width="<? echo $six_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_grey_qnty,0);?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_last_grey_qty,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $six_percent;?>"><? echo fn_number_format($sub_trans_in,0); ?></td>
                                    <td align="right" width="<? echo $six_percent;?>"><? echo fn_number_format($sub_trans_out,0); ?></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_grey_rcv_balance,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_batch_qty,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><? echo fn_number_format($sub_stock_at_store,0); ?></td>
                                </tr>
                            <?
                            $sub_grey_required=$sub_short_grey=$sub_total_required=$sub_program_qnty=$sub_program_balance=$sub_grey_qnty=$sub_last_grey_qty=$sub_grey_rcv_balance=$sub_batch_qty=$sub_stock_at_store=$sub_trans_in=$sub_trans_out=0;
                        }
                        ?>
                        
                    </tbody>
                </table>
            </div>
            <!-- <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width;?>">
                <tfoot>
                    <tr style="font-weight:bold;text-align:right;">
                        <th width="<? echo $six_percent;?>">&nbsp;</th>
                        <th width="<? echo $eight_percent;?>">&nbsp;</th>
                        <th width="<? echo $six_percent;?>">&nbsp;</th>
                        <th width="<? echo $four_percent;?>">&nbsp;</th>
                        <th width="<? echo $four_percent;?>"><strong>Grand Total:</strong></th>
                        <th width="<? echo $six_percent;?>"><? echo fn_number_format($tot_grey_required,2); ?></th>
                        <th width="<? echo $six_percent;?>"><? echo fn_number_format($tot_short_grey,2); ?></th>
                        <th width="<? echo $six_percent;?>"><? echo fn_number_format($tot_total_required,2); ?></th>
                        <th width="<? echo $six_percent;?>"><? echo fn_number_format($tot_program_qnty,2); ?></th>
                        <th width="<? echo $six_percent;?>"><? echo fn_number_format($tot_program_balance,2);?></th>
                        <th width="<? echo $six_percent;?>">&nbsp;</th>
                        <th width="<? echo $six_percent;?>"><? echo fn_number_format($tot_grey_qnty,2);?></th>
                        <th width="<? echo $six_percent;?>"><? echo fn_number_format($tot_last_grey_qty,2); ?></th>
                        <th width="<? echo $six_percent;?>">&nbsp;</th>
                        <th width="<? echo $six_percent;?>"><? echo fn_number_format($tot_grey_rcv_balance,2); ?></th>
                        <th width="<? echo $six_percent;?>"><? echo fn_number_format($tot_batch_qty,2); ?></th>
                        <th width="<? echo $six_percent;?>">&nbsp;</th>
                    </tr>
                </tfoot>
            </table> -->
            <br>
            <!-- =======================================  Factory Wise ================================-->
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="1150">
                <tbody>
                    <tr>
                        <td colspan="15" width="1000" align="center"><h3>Factory Wise</h3></td>
                    </tr>
                </tbody>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1225">
                <thead>
                    <tr>
                        <th width="65">Knit Type</th>
                        <th width="65">Knitting Factory</th>
                        <th width="65">Fabric Structure</th>
                        <th width="65">M/c Dia</th>
                        <th width="65">Finish Dia</th>
                        <th width="65">Color</th>
                        <th width="65">Program No</th>
                        <th width="65">Program qty</th>

                        <th width="65">Last Prog Date</th>
                        <th width="65">Rcv Qty</th>
                        <th width="65">Last rcv qty</th>
                        <th width="65">Last Rcv Date</th>
                        <th width="65">Trans In</th>
                        <th width="65">Trans Out</th>
                        <th width="65">Start Date</th>
                        <th width="65">End Date</th>
                        <th width="65">Rcv Backlog</th>
                        <th width="65">Rcv Bal</th>
                    </tr>
                </thead>
            </table>
            <div id="scroll_body" style="width:1245px; max-height:240px;overflow-y:scroll;">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1225">
                    <tbody>
                        <?
                        $type_span_arr = array();
                        $party_span_arr = array();
                        foreach ($factory_wise_arr as $type_name => $type_data) 
                        {
                            $type_span=1;
                            foreach ($type_data as $knitSourceParty => $knitSourcePartyData) 
                            {
                                $type_span_arr[$type_name]++;
                                foreach ($knitSourcePartyData as $dSrt => $dSrt_val) 
                                {
                                    foreach ($dSrt_val as $progId => $val) 
                                    {
                                        $type_span_arr[$type_name]++;
                                        $type_source_span_arr[$type_name][$knitSourceParty]++;
                                    }
                                }
                            }
                        }
                        // echo "<pre>";    print_r($type_span_arr);
                        $i=1;
                        $toDay = new DateTime('now');
                        $today_str = date('Y-m-d',strtotime('now'));
                        foreach ($factory_wise_arr as $type_name => $type_data) 
                        {
                            $f=0;
                            foreach ($type_data as $knitSourceParty => $knitSourcePartyData) 
                            {
                                $s=0;
                                foreach ($knitSourcePartyData as $dSrt => $dSrt_val) 
                                {
                                    foreach ($dSrt_val as $progId => $val) 
                                    {
                                        // echo $type_name."**".$knitSourceParty."**".$progId."**".$dSrt."=<br>";
                                        $dSrt_data = explode("*", $dSrt);
                                        $DETER_ID = $dSrt_data[0];
                                        $MACHINE_DIA = $dSrt_data[1];
                                        $DIA = $dSrt_data[2];
                                        $COLOR_ID = $dSrt_data[3];
                                        $PROGRAM_NO = $dSrt_data[4];
                                        $receive_balance = ($val['PROGRAM_QNTY']+$val['trans_out']) - ($val['FACT_GREY_QTY']+$val['trans_in']);


                                        $s_date=date('Y-m-d',strtotime($val['START_DATE']));
                                        $e_date=date('Y-m-d',strtotime($val['END_DATE']));
                                        /*01.if(Today Date<=Program Start Date)
                                        then data will be Zero.

                                        02.if(Today Date>Program End Date)
                                        then formula=Program qnty - Rcv qnty.
                                        03.if(Today Date>Progam Start Date & Today Date <Progam End Date) 
                                        then formula= [{(Program qnty/ Number of Days as per planing info start and end date)* (Number of Days before current day)} - Program qnty)].*/

                                        $start_date  = new DateTime($val['START_DATE']);
                                        $end_date    = new DateTime($val['END_DATE']);

                                        $lbdpSbBackLog=0;
                                        //if($toDay <= $start_date)
                                        if($today_str <= $s_date)
                                        {
                                            $lbdpSbBackLog = 0;
                                        }
                                        //elseif($toDay > $end_date)
                                        elseif($today_str > $e_date)
                                        {
                                            $lbdpSbBackLog = $receive_balance;
                                        }
                                        elseif ($today_str > $s_date && $today_str <= $e_date) 
                                        {
                                            $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;
                                            $todayDaysDif= $start_date->diff($toDay)->format('%a');
                                            $lbdpSbBackLog = (($val['PROGRAM_QNTY']/$tnaDaysDif)*$todayDaysDif) - $val['FACT_GREY_QTY'];
                                        }

                                        if($lbdpSbBackLog<0){
                                            $lbdpSbBackLog=0;
                                        }
                                        if ($val['START_DATE']=="" && $val['START_DATE']=="") 
                                        {
                                            $lbdpSbBackLog=0;
                                        }

                                        $bgcolor=($s%2==0)?"#E9F3FF":"#FFFFFF";
                                        ?>
                                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trp_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trp_<? echo $i; ?>">
                                            <?
                                            if($f==0)
                                            {
                                                ?>
                                                 <td width="65" rowspan="<? echo $type_span_arr[$type_name]+1;?>"><? echo $type_name;?></td>
                                                <?
                                            }
                                            if($s==0)
                                            {
                                                $knit_source_arr = explode("*", $knitSourceParty);
                                                if($knit_source_arr[0]==1){
                                                    $source_name = $lib_company[$knit_source_arr[1]];
                                                }else{
                                                    $source_name = $lib_supplier[$knit_source_arr[1]];
                                                }
                                                ?>
                                                <td width="65" rowspan="<? echo $type_source_span_arr[$type_name][$knitSourceParty];?>" align="center"><? echo $source_name;?></td>
                                                <?

                                            }
                                         ?>
                                            
                                            <td width="65" align="center"><p class="word_break_wrap"><? echo $constructtion_arr[$DETER_ID];//.", ".$composition_arr[$DETER_ID];?></p></td>
                                            <td width="65" align="center"><? echo $MACHINE_DIA; ?></td>
                                            <td width="65" align="center"><? echo $DIA; ?></td>
                                            <td width="65" align="center"><? echo $lib_color[$COLOR_ID]; ?></td>
                                            <td width="65" align="center"><? echo $progId; ?></td>
                                            <td width="65" align="right"><? echo fn_number_format($val['PROGRAM_QNTY'],0) ?></td>
                                            <td width="65" align="center"><? echo change_date_format($val['PROGRAM_DATE']); ?></td>
                                            <td width="65" align="right"><? echo fn_number_format($val['FACT_GREY_QTY'],0) ?></td>
                                            <td width="65" align="right"><? echo fn_number_format($val['LAST_GREY_QTY'],0) ?></td>
                                            <td width="65" align="center"><? echo change_date_format($val['LAST_GREY_DATE']) ?></td>
                                            <td width="65" align="right"><? echo fn_number_format($val['trans_in'],0) ?></td>
                                            <td width="65" align="right"><? echo fn_number_format($val['trans_out'],0) ?></td>
                                            <td width="65" align="center"><? echo change_date_format($val['START_DATE']) ?></td>
                                            <td width="65" align="center"><? echo change_date_format($val['END_DATE']) ?></td>
                                            <td width="65" align="right"><? echo fn_number_format($lbdpSbBackLog,0) ?></td>
                                            <td width="65" align="right"><? echo fn_number_format($receive_balance,0); ?></td>
                                        </tr>
                                        <?
                                       $f++;$s++;$i++;
                                       $sub_program_qnty += $val['PROGRAM_QNTY'];
                                       $sub_fact_grey_qty += $val['FACT_GREY_QTY'];
                                       $sub_last_grey_qty += $val['LAST_GREY_QTY'];
                                       $sub_trans_in_qty += $val['trans_in'];
                                       $sub_trans_out_qty += $val['trans_out'];
                                       $sub_lbdpSbBackLog += $lbdpSbBackLog;
                                       $sub_receive_balance += $receive_balance;

                                       $grand_program_qnty += $val['PROGRAM_QNTY'];
                                       $grand_fact_grey_qty += $val['FACT_GREY_QTY'];
                                       $grand_last_grey_qty += $val['LAST_GREY_QTY'];
                                       $grand_trans_in_qty += $val['trans_in'];
                                       $grand_trans_out_qty += $val['trans_out'];
                                       $grand_lbdpSbBackLog += $lbdpSbBackLog;
                                       $grand_receive_balance += $receive_balance;
                                    }
                                }
                                ?>
                                <tr bgcolor="#ccc">
                                    <td align="right" colspan="6"><strong> Total</strong></td>
                                    <td align="right" ><strong><? echo fn_number_format($sub_program_qnty,0); ?></strong></td>
                                    <td align="right" ><strong> </strong></td>
                                    <td align="right" ><strong><? echo fn_number_format($sub_fact_grey_qty,0); ?> </strong></td>
                                    <td align="right" ><strong><? echo fn_number_format($sub_last_grey_qty,0); ?></strong></td>
                                    
                                    <td align="right" ><strong> </strong></td>
                                    <td align="right" ><strong> <? echo fn_number_format($sub_trans_in_qty,0); ?></strong></td>
                                    <td align="right" ><strong> <? echo fn_number_format($sub_trans_out_qty,0); ?></strong></td>
                                    <td align="right" ><strong> </strong></td>
                                    <td align="right" ><strong> </strong></td>
                                    <td align="right" ><strong><? echo fn_number_format($sub_lbdpSbBackLog,0); ?></strong></td>
                                    <td align="right" ><strong><? echo fn_number_format($sub_receive_balance,0); ?></strong></td>
                                </tr>
                                <? 
                                $sub_program_qnty=$sub_fact_grey_qty=$sub_last_grey_qty=$sub_lbdpSbBackLog=$sub_receive_balance=0;
                            }
                            ?>
                        </tbody>
                    </table>
               
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1225">
                    <tfoot>
                        <tr bgcolor="#ccc">
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong> Grand Total</strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_program_qnty,0); ?></strong></td>
                            <td width="65" align="right" ><strong> </strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_fact_grey_qty,0); ?> </strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_last_grey_qty,0); ?></strong></td>
                            
                            <td width="65" align="right" ><strong> </strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_trans_in_qty,0); ?> </strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_trans_out_qty,0); ?> </strong></td>
                            <td width="65" align="right" ><strong> </strong></td>
                            <td width="65" align="right" ><strong> </strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_lbdpSbBackLog,0); ?></strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_receive_balance,0); ?></strong></td>
                        </tr>
                        <? 
                        $grand_program_qnty=$grand_fact_grey_qty=$grand_last_grey_qty=$grand_lbdpSbBackLog=$grand_receive_balance=0;
                    }
                    ?>
                </tfoot>
            </table>
             </div>
            <br>
            <!-- ======================================= Yarn Sending Status ============================================= -->
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="905">
                <tbody>
                    <tr>
                        <td colspan="12" width="900" align="center"><h3>Yarn Sending Status</h3></td>
                    </tr>
                </tbody>
            </table>
            <?
            if(!empty($program_nos))
            {
                $lib_yarn_count = return_library_array("select id , yarn_count from lib_yarn_count","id","yarn_count");
                $lib_brand = return_library_array("select id , brand_name from lib_brand","id","brand_name");
                $all_program_id_cond="";
                $progCond="";
                if($db_type==2 && count($program_nos)>999)
                {
                    $all_program_arr_chunk=array_chunk($program_nos,999) ;
                    foreach($all_program_arr_chunk as $chunk_arr)
                    {
                        $chunk_arr_value=implode(",",$chunk_arr);
                        $progCond.=" a.knit_id in($chunk_arr_value) or ";
                    }

                    $all_program_id_cond.=" and (".chop($progCond,'or ').")";
                }
                else
                {
                    $all_program_id_cond=" and a.knit_id in(".implode(',', $program_nos).")";
                }

                /*$requ_sql = sql_select("select b.supplier_id as SUPPLIER_ID, B.yarn_count_id as YARN_COUNT_ID, b.brand as BRAND, b.lot as LOT, sum(a.yarn_qnty) as YARN_QNTY, yarn_comp_type1st as YARN_COMP_TYPE1ST, yarn_comp_percent1st as YARN_COMP_PERCENT1ST, yarn_comp_type2nd as YARN_COMP_TYPE2ND, yarn_comp_percent2nd as YARN_COMP_PERCENT2ND, b.color as COLOR, a.prod_id as PROD_ID, a.requisition_no as REQUISITION_NO from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id= b.id and a.status_active=1 and a.is_deleted=0 $all_program_id_cond group by b.supplier_id, B.yarn_count_id, b.brand, b.lot, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd , b.color , a.prod_id , a.requisition_no");*/
                $requ_sql = sql_select("SELECT c.knitting_source as KNITTING_SOURCE, c.knitting_party as KNITTING_PARTY, b.yarn_count_id as YARN_COUNT_ID, b.brand as BRAND, b.lot as LOT, sum(a.yarn_qnty) as YARN_QNTY, yarn_comp_type1st as YARN_COMP_TYPE1ST, yarn_comp_percent1st as YARN_COMP_PERCENT1ST, yarn_comp_type2nd as YARN_COMP_TYPE2ND, yarn_comp_percent2nd as YARN_COMP_PERCENT2ND, b.color as COLOR, a.prod_id as PROD_ID, a.requisition_no as REQUISITION_NO from ppl_yarn_requisition_entry a, product_details_master b, ppl_planning_info_entry_dtls c where a.prod_id= b.id and a.knit_id =c.id and a.status_active=1 and a.is_deleted=0 and c.status_active=1 and c.is_deleted=0 $all_program_id_cond group by c.knitting_source, c.knitting_party,B.yarn_count_id, b.brand, b.lot, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, b.color, a.prod_id, a.requisition_no");


                foreach ($requ_sql as $val) 
                {
                    $compos = '';
                    if ($val['YARN_COMP_PERCENT2ND'] != 0) {
                        $compos = $composition[$val['YARN_COMP_TYPE1ST']] . " " . $val['YARN_COMP_PERCENT1ST'] . "%" . " " . $composition[$val['YARN_COMP_TYPE2ND']] . " " . $val['YARN_COMP_PERCENT2ND'] . "%";
                    } else {
                        $compos = $composition[$val['YARN_COMP_TYPE1ST']] . " " . $val['YARN_COMP_PERCENT1ST'] . "%" . " " . $composition[$val['YARN_COMP_TYPE2ND']];
                    }

                    $prod_arr[$val['PROD_ID']] =$val['PROD_ID'];
                    $requ_arr[$val['REQUISITION_NO']] =$val['REQUISITION_NO'];

                    if($val['KNITTING_SOURCE'] == 1){
                        $KNITTING_PARTY = $lib_company[$val['KNITTING_PARTY']];
                    }else{
                        $KNITTING_PARTY = $lib_supplier[$val['KNITTING_PARTY']];
                    }

                    $requ_data_arr[$KNITTING_PARTY][$val['PROD_ID']]['COLOR'] = $val['COLOR'];
                    $requ_data_arr[$KNITTING_PARTY][$val['PROD_ID']]['DESC'] = $compos;
                    $requ_data_arr[$KNITTING_PARTY][$val['PROD_ID']]['YARN_COUNT_ID'] = $val['YARN_COUNT_ID'];
                    $requ_data_arr[$KNITTING_PARTY][$val['PROD_ID']]['BRAND'] = $val['BRAND'];
                    $requ_data_arr[$KNITTING_PARTY][$val['PROD_ID']]['LOT'] = $val['LOT'];
                    $requ_data_arr[$KNITTING_PARTY][$val['PROD_ID']]['YARN_QNTY'] += $val['YARN_QNTY'];
                    $requ_data_arr[$KNITTING_PARTY][$val['PROD_ID']]['PARTY'] = $val['KNITTING_PARTY'];
                }

                if(!empty($prod_arr))
                {
                    $all_prod_id_cond="";
                    $prodCond="";
                    if($db_type==2 && count($prod_arr)>999)
                    {
                        $all_prod_arr_chunk=array_chunk($prod_arr,999) ;
                        foreach($all_prod_arr_chunk as $chunk_arr)
                        {
                            $chunk_arr_value=implode(",",$chunk_arr);
                            $prodCond.="  b.prod_id in($chunk_arr_value) or ";
                        }

                        $all_prod_id_cond.=" and (".chop($prodCond,'or ').")";
                    }
                    else
                    {
                        $all_prod_id_cond=" and b.prod_id in(".implode(',', $prod_arr).")";
                    }
                    //print_r( $requ_arr);die;
                    
                    $issue_sql = sql_select("SELECT a.knit_dye_company as KNIT_DYE_COMPANY, a.knit_dye_source as KNIT_DYE_SOURCE, b.receive_basis as RECEIVE_BASIS, b.requisition_no as REQUISITION_NO, b.prod_id as PROD_ID, c.quantity as QUANTITY, a.issue_date as ISSUE_DATE from inv_issue_master a, inv_transaction b, order_wise_pro_details c, product_details_master d where a.id = b.mst_id and b.id=c.trans_id and b.prod_id = d.id and a.entry_form =3 and b.transaction_type=2 and b.item_category=1 $all_prod_id_cond order by b.id asc");
                    
                    foreach ($issue_sql as $val) 
                    {
                        if($val['RECEIVE_BASIS'] ==3 && $requ_arr[$val['REQUISITION_NO']] !="")
                        {
                            if($val['KNIT_DYE_SOURCE'] == 1){
                                $KNITTING_PARTY = $lib_company[$val['KNIT_DYE_COMPANY']];
                            }else{
                                $KNITTING_PARTY = $lib_supplier[$val['KNIT_DYE_COMPANY']];
                            }

                            if($last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['ISSUE_DATE'] =="")
                            {
                                $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['QUANTITY'] = $val['QUANTITY'];
                                $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['ISSUE_DATE'] = $val['ISSUE_DATE'];
                            }
                            else
                            {
                                if(strtotime($last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['ISSUE_DATE']) == strtotime($val['ISSUE_DATE']))
                                {
                                    $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['QUANTITY'] += $val['QUANTITY'];
                                    $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['ISSUE_DATE'] = $val['ISSUE_DATE'];
                                }
                                else if(strtotime($last_yarn_issue_info[$val['PROD_ID']]['ISSUE_DATE']) < strtotime($val['ISSUE_DATE']))
                                {
                                    $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['QUANTITY'] = $val['QUANTITY'];
                                    $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['ISSUE_DATE'] = $val['ISSUE_DATE'];
                                }
                            }

                            $issue_requ_qty[$KNITTING_PARTY][$val['PROD_ID']] += $val['QUANTITY'];
                        }
                        $yarn_issue_qty[$val['PROD_ID']] += $val['QUANTITY'];
                    }
                    //print_r( $issue_requ_qty);die;
                    //die;
                    $rcv_sql = sql_select("SELECT a.SUPPLIER_ID,b.prod_id as PROD_ID,b.transaction_type as TTYPE,a.KNITTING_COMPANY,a.KNITTING_SOURCE, sum(b.cons_quantity) as QUANTITY,sum(b.cons_reject_qnty) as REJ_QUANTITY from inv_receive_master a, inv_transaction b,order_wise_pro_details c where a.id = b.mst_id and b.id=c.trans_id and c.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and a.entry_form in(1,9) and b.transaction_type in(1,4) and b.item_category=1 and a.status_active =1 and b.status_active =1 $all_prod_id_cond group by a.supplier_id,b.prod_id,b.transaction_type,a.knitting_company,a.knitting_source");


                    foreach ($rcv_sql as $val) 
                    {
                        if($val['KNITTING_SOURCE'] == 1)
                        {
                                $KNITTING_PARTY = $lib_company[$val['KNITTING_COMPANY']];
                        }
                        else
                        {
                            $KNITTING_PARTY = $lib_supplier[$val['KNITTING_COMPANY']];
                        }

                        $yarn_rcv_qty[$KNITTING_PARTY][$val['PROD_ID']][$val['TTYPE']] += $val['QUANTITY']+$val['REJ_QUANTITY'];
                    }

                }

            }
            // echo "<pre>";print_r($yarn_rcv_qty);
            ?>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="900">
                <thead>
                    <tr>
                        <th width="75">Knitting Factory</th>
                        <th width="75">Solid/dyed</th>
                        <th width="75">Yarn Composition</th>
                        <th width="75">Count</th>
                        <th width="75">Brand</th>
                        <th width="75">Lot</th>
                        <th width="75">Req Qty</th>

                        <th width="75">Issue Qty</th>
                        <th width="75">Last issue Date</th>
                        <th width="75">Last Issue Qty</th>
                        <th width="75">Issue Bal</th>
                        <!-- <th width="75">Stock At Yarn Store</th> -->
                    </tr>
                </thead>
            </table>
            <div id="scroll_body" style="width:920px; max-height:240px;overflow-y:scroll;">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="900">
                    <tbody>
                        <?
                            if(!empty($requ_data_arr))
                            {
                                $i=0;
                                foreach ($requ_data_arr as $supplier_name=>$supplier_data) 
                                {
                                    $z=0;
                                    foreach ($supplier_data as $product_id => $row) 
                                    {
                                        $stock = $yarn_rcv_qty[$supplier_name][$product_id][1] - $yarn_issue_qty[$product_id];
                                        // $issue_balance = $row['YARN_QNTY'] - $issue_requ_qty[$supplier_name][$product_id];
                                        $issue_balance = $issue_requ_qty[$supplier_name][$product_id] - $yarn_rcv_qty[$supplier_name][$product_id][4];

                                        // echo "string".$supplier_name."==".$product_id."<br>";
                                        // echo $issue_requ_qty[$supplier_name][$product_id]."-".$yarn_rcv_qty[$supplier_name][$product_id][4]."<br>";

                                        $bgcolor=($z%2==0)?"#E9F3FF":"#FFFFFF";
                                        ?>
                                        <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('try_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="try_<? echo $i; ?>">
                                            <?
                                            if($z==0)
                                            {
                                                ?>
                                                <td width="75" rowspan="<? echo count($supplier_data)?>"><? echo $supplier_name;?></a></td>
                                                <?
                                            }
                                            ?>
                                            <td width="70" align="right"><? echo $lib_color[$row['COLOR']];?></td>
                                            <td width="70" align="right"><p class="word_break_wrap"><? echo $row['DESC'];?></p></td>
                                            <td width="70" align="right"><? echo $lib_yarn_count[$row['YARN_COUNT_ID']];?></td>
                                            <td width="70" align="right"><? echo $lib_brand[$row['BRAND']];?></td>
                                            <td width="70" align="right"><? echo $row['LOT'];?></td>
                                            <td width="70" align="right"><? echo $row['YARN_QNTY'];?></td>
                                            <td width="70" align="right" title="<?=$product_id."=".$issue_requ_qty[$supplier_name][$product_id] ."-". $yarn_rcv_qty[$supplier_name][$product_id][4];?>"><? echo fn_number_format(($issue_requ_qty[$supplier_name][$product_id] - $yarn_rcv_qty[$supplier_name][$product_id][4]),0);?></td>
                                            <td width="70" align="right"><? echo change_date_format($last_yarn_issue_info[$supplier_name][$product_id]['ISSUE_DATE']);?></td>
                                            <td width="70" align="right"><? echo fn_number_format($last_yarn_issue_info[$supplier_name][$product_id]['QUANTITY'],0);?></td>
                                            <td width="70" align="right"><? echo fn_number_format($issue_balance,0);?></td>
                                            <!-- <td width="70" align="right"><? //echo fn_number_format($stock,0);?></td> -->
                                        </tr>
                                        <?
                                        $z++;$i++;
                                        $tot_yarn_requ += $row['YARN_QNTY'];
                                        $tot_yarn_issue += $issue_requ_qty[$supplier_name][$product_id] - $yarn_rcv_qty[$supplier_name][$product_id][4];
                                        $last_yarn_issue += $last_yarn_issue_info[$supplier_name][$product_id]['QUANTITY'];
                                        $yarn_issue_balance += $issue_balance;
                                        $tot_yarn_stock += $stock;
                                    }
                                    ?>
                                    <tr bgcolor="#ccc">
                                        <td align="right" colspan="6"><strong>Total:</strong></td>
                                        <td align="right"><strong><? echo fn_number_format($tot_yarn_requ,0); ?></strong></td>
                                        <td align="right"><strong><? echo fn_number_format($tot_yarn_issue,0); ?></strong></td>
                                        <td align="right"><strong><? //echo fn_number_format($skdslj,0); ?></strong></td>
                                        <td align="right"><strong><? echo fn_number_format($last_yarn_issue,0); ?></strong></td>
                                        <td align="right"><strong><? echo fn_number_format($yarn_issue_balance,0); ?></strong></td>
                                        <!-- <td align="right"><strong><? echo fn_number_format($tot_yarn_stock,0); ?></strong></td> -->
                                    </tr>
                                    <?
                                    $tot_yarn_requ=$tot_yarn_issue=$last_yarn_issue=$yarn_issue_balance=$tot_yarn_stock=0;
                                }
                            }
                        ?>
                    </tbody>
                </table> 
            </div> 
        </div>        
    </div>
    <?
}

if($action=="grey_popup_bk2")// 23/03/2022
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    $lib_company = return_library_array("select id,company_name from lib_company", "id", "company_name");
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);
    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();
    //$costPerArr=$condition->getCostingPerArr();
    $fabric= new fabric($condition);
    //echo $fabric->getQuery();die;
    // $fabric_costing_arr=$fabric->getQtyArray_by_JobColorBodyTypeDeterminIdAndDiaWidth_knitAndwoven_greyAndfinish();

    $fabric_costing_arr=$fabric->getQtyArray_by_JobColorFabColorBodyTypeDeterminIdAndDiaWidth_knitAndwoven_greyAndfinish();
    // echo "<pre>";print_r($fabric_costing_arr);echo "</pre>";
    $main_arr = array();
    $sqlOrderRes = sql_select("SELECT a.job_no as JOB_NO, a.style_ref_no as STYLE, b.grouping as INT_REF from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id  and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in ($poIds) group by a.job_no, a.style_ref_no,  b.grouping");

    $short_sql = sql_select("SELECT B.BODY_PART_TYPE, a.grey_fab_qnty as GREY_FAB_QNTY, a.fabric_color_id as COLOR_ID, b.lib_yarn_count_deter_id as DETERMINATION_ID, a.dia_width as DIA_WIDTH, b.uom as UOM, b.job_no as JOB_NO from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b where a.pre_cost_fabric_cost_dtls_id=b.id and a.is_short=1 and a.booking_type=1 and a.po_break_down_id in ($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

    foreach ($short_sql as $val) 
    {
        $short_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETERMINATION_ID']][$val['COLOR_ID']][$val['DIA_WIDTH']][$val['UOM']]['SHORT_GREY']+=$val['GREY_FAB_QNTY']; 
    }
    // echo "<pre>";print_r($short_arr);echo "</pre>";

    $grey_sql = sql_select("SELECT e.BOOKING_ID,d.job_no_mst as JOB_NO, e.receive_date as RECEIVE_DATE, b.color_id as COLOR_ID, b.width as WIDTH, b.uom as UOM, b.febric_description_id as FEBRIC_DESCRIPTION_ID, c.body_part_type as BODY_PART_TYPE, e.knitting_company as KNITTING_COMPANY, e.knitting_source as KNITTING_SOURCE, b.machine_dia as MACHINE_DIA, sum(a.quantity) as QUANTITY from inv_receive_master e, order_wise_pro_details a, pro_grey_prod_entry_dtls b left join lib_body_part c on b.body_part_id = c.id, wo_po_break_down d where e.id = b.mst_id and e.entry_form in (2,22,58) and a.dtls_id=b.id and a.trans_id=b.trans_id and A.PO_BREAKDOWN_ID=d.id and a.entry_form in (2,22,58) and a.trans_id >0 and a.po_breakdown_id in ($poIds) and a.is_sales=0 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted=0 group by e.booking_id,d.job_no_mst, b.color_id, b.width, b.uom, b.febric_description_id, c.body_part_type, e.knitting_company, e.knitting_source, b.machine_dia, e.receive_date order by e.receive_date asc");

    foreach ($grey_sql as $val) 
    {
        $desc_str = $val['FEBRIC_DESCRIPTION_ID']."*".$val['COLOR_ID']."*".$val['WIDTH']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }
        $main_arr[$type_name][$lib_color[$val['COLOR_ID']]][$desc_str]['GREY_QTY'] += $val['QUANTITY'];
        if($grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE'] =="")
        {
            $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_QTY'] = $val['QUANTITY'];
            $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
        }
        else
        {
            if(strtotime($grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE']) == strtotime($val['RECEIVE_DATE']))
            {
                $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_QTY'] += $val['QUANTITY'];
                $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
            }
            else if(strtotime($grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE']) < strtotime($val['RECEIVE_DATE']))
            {
                $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_QTY'] = $val['QUANTITY'];
                $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
            }
        }

        if($factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE'] == "")
        {
            $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_QTY'] = $val['QUANTITY'];
            $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
        }
        else
        {
            if(strtotime($factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE']) == strtotime($val['RECEIVE_DATE']))
            {
                $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_QTY'] += $val['QUANTITY'];
                $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
            } 
            else if(strtotime($factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE']) < strtotime($val['RECEIVE_DATE']))
            {
                $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_QTY'] = $val['QUANTITY'];
                $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
            }
        }

       $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['GREY_QTY'] += $val['QUANTITY'];
       $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['FACT_GREY_QTY'] += $val['QUANTITY'];
    }

    /*echo "<pre>";
    print_r($factory_wise_rcv);
    die;*/


    $program_sql = "SELECT b.id as PROGRAM_NO, d.job_no_mst as JOB_NO, e.body_part_type as BODY_PART_TYPE, b.color_id as COLOR_ID, c.determination_id as DETER_ID, c.dia as DIA, b.knitting_source as KNITTING_SOURCE, b.knitting_party as KNITTING_PARTY, max(b.start_date) as START_DATE, max(b.end_date) as END_DATE, max(b.program_date) as PROGRAM_DATE, b.machine_dia as MACHINE_DIA, sum(c.program_qnty) as PROGRAM_QNTY from ppl_planning_info_entry_mst a left join lib_body_part e on a.body_part_id=e.id, ppl_planning_info_entry_dtls b, ppl_planning_entry_plan_dtls c, wo_po_break_down d where a.id=b.mst_id and b.id =c.dtls_id and a.id=c.mst_id and c.po_id =d.id and c.po_id in ($poIds) and a.status_active=1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by b.id, d.job_no_mst, e.body_part_type, b.color_id, c.determination_id, c.dia, b.knitting_source, b.knitting_party, b.machine_dia";
    // echo $program_sql;
    $program_res = sql_select($program_sql);
    
    foreach ($program_res as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['COLOR_ID']."*".$val['DIA']."*12";
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }
        $main_arr[$type_name][$lib_color[$val['COLOR_ID']]][$desc_str]['PROGRAM_QNTY'] += $val['PROGRAM_QNTY'];
        $program_nos[$val['PROGRAM_NO']]=$val['PROGRAM_NO'];
        $program_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['COLOR_ID']][$val['DIA']]['PROGRAM_QNTY'] += $val['PROGRAM_QNTY'];
        $program_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['COLOR_ID']][$val['DIA']]['PROGRAM_DATE'] = $val['PROGRAM_DATE'];


        $desc_str = $val['DETER_ID']."*".$val['MACHINE_DIA']."*".$val['DIA']."*".$val['COLOR_ID'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }else{
            $type_name = 'CIRCULAR';
        }

        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['COLOR_ID'] = $val['COLOR_ID'];
        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['START_DATE'] = $val['START_DATE'];
        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['END_DATE'] = $val['END_DATE'];
        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['PROGRAM_DATE'] = $val['PROGRAM_DATE'];
        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['PROGRAM_QNTY'] += $val['PROGRAM_QNTY'];
        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['FACT_GREY_QTY'] += $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_PARTY']][$val['MACHINE_DIA']][$val['DETER_ID']][$val['COLOR_ID']][$val['DIA']][$val['PROGRAM_NO']]['FACT_GREY_QTY'];

        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['LAST_GREY_DATE'] = $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_PARTY']][$val['MACHINE_DIA']][$val['DETER_ID']][$val['COLOR_ID']][$val['DIA']][$val['PROGRAM_NO']]['LAST_GREY_DATE'];

        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['LAST_GREY_QTY'] += $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_PARTY']][$val['MACHINE_DIA']][$val['DETER_ID']][$val['COLOR_ID']][$val['DIA']][$val['PROGRAM_NO']]['LAST_GREY_QTY'];

        //echo "[".$val['JOB_NO']."][".$val['BODY_PART_TYPE']."][".$val['KNITTING_SOURCE']."][".$val['KNITTING_PARTY']."][".$val['DETER_ID']."][".$val['COLOR_ID']."][".$val['DIA']."]<br>";

    }

    // echo "<pre>";  print_r($factory_wise_arr);die;
    $batch_sql = sql_select("SELECT a.batch_no, d.job_no_mst as JOB_NO,a.color_id as COLOR_ID, b.batch_qnty as BATCH_QNTY,c.gsm as GSM, c.dia_width as DIA_WIDTH, c.detarmination_id as DETARMINATION_ID, b.body_part_id as BODY_PART_ID, e.body_part_type as BODY_PART_TYPE, c.unit_of_measure as UOM from pro_batch_create_mst a, pro_batch_create_dtls b left join lib_body_part e on b.body_part_id = e.id, product_details_master c, wo_po_break_down d where a.id=b.mst_id and b.prod_id=c.id and b.po_id=d.id $ext_cond and b.po_id in ($poIds) AND a.batch_against IN (1) and b.is_sales =0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

    foreach ($batch_sql as $val) 
    {
        $desc_str = $val['DETARMINATION_ID']."*".$val['COLOR_ID']."*".$val['DIA_WIDTH']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }

        // $batch_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETARMINATION_ID']][$val['COLOR_ID']][$val['DIA_WIDTH']][$val['UOM']] +=$val['BATCH_QNTY'];
        $main_arr[$type_name][$lib_color[$val['COLOR_ID']]][$desc_str]['BATCH_QTY'] += $val['BATCH_QNTY'];
    }

    // ====================================================================================

    $sqlGreyRcv = "SELECT c.febric_description_id as DETER_ID, d.quantity as QTY,c.UOM,c.COLOR_ID,c.width as DIA from inv_receive_master a, inv_transaction b,pro_grey_prod_entry_dtls c,order_wise_pro_details d where a.id=b.mst_id and b.id=c.trans_id and a.id=c.mst_id and b.id=d.trans_id and c.id=d.dtls_id and d.trans_type=1 and b.item_category=13 and a.status_active=1 and b.status_active=1 and c.status_active=1 and d.po_breakdown_id in($poIds)";
    // echo $sqlGreyRcv;die();
    $sqlRes = sql_select($sqlGreyRcv);
    $receive_qty_array = array();
    $desc_str="";
    foreach ($sqlRes as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['COLOR_ID']."*".$val['DIA']."*".$val['UOM'];
        $receive_qty_array[$desc_str] += $val['QTY'];
    }

    // ======================================================================================
    $sqlGreyIssue = "SELECT c.detarmination_id as DETER_ID, d.quantity as QTY,c.unit_of_measure as UOM,e.COLOR_ID,c.dia_width as DIA from inv_issue_master a, inv_transaction b,product_details_master c,order_wise_pro_details d,inv_grey_fabric_issue_dtls e where a.id=b.mst_id and c.id=d.prod_id and b.id=d.trans_id and c.id=b.prod_id and e.trans_id=b.id and a.id=e.mst_id and e.prod_id=c.id and d.trans_type=2 and b.item_category=13 and c.item_category_id=13 and a.status_active=1 and b.status_active=1 and c.status_active=1 and d.po_breakdown_id in($poIds)";
    // echo $sqlGreyIssue;die();
    $sqlRes = sql_select($sqlGreyIssue);
    $issue_qty_array = array();
    $desc_str="";
    foreach ($sqlRes as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['COLOR_ID']."*".$val['DIA']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }
        $main_arr[$type_name][$lib_color[$val['COLOR_ID']]][$desc_str]['grey_issue_qty_array'] += $val['QTY'];
        $main_arr[$type_name][$lib_color[$val['COLOR_ID']]][$desc_str]['COLOR_ID'] += $val['COLOR_ID'];
        $issue_qty_array[$desc_str] += $val['QTY'];
    }

    $sql = "SELECT a.job_no as JOB_NO, a.color_number_id as COLOR_ID,b.COLOR_SIZE_SENSITIVE, b.lib_yarn_count_deter_id as DETER_ID, b.uom as UOM, a.dia_width as DIA,b.FABRIC_SOURCE, b.body_part_type as BODY_PART_TYPE,c.CONTRAST_COLOR_ID from wo_pre_cos_fab_co_avg_con_dtls a, wo_pre_cost_fabric_cost_dtls b LEFT JOIN wo_pre_cos_fab_co_color_dtls c ON b.job_no = c.job_no and b.id=c.pre_cost_fabric_cost_dtls_id  AND c.status_active = 1 
       AND c.is_deleted = 0 where a.pre_cost_fabric_cost_dtls_id =b.id and a.po_break_down_id in ($poIds) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.cons !=0 group by a.job_no, a.color_number_id, b.lib_yarn_count_deter_id, b.uom, a.dia_width,  b.body_part_type,c.contrast_color_id,b.color_size_sensitive,b.fabric_source order by b.body_part_type, b.lib_yarn_count_deter_id";
    // echo $sql;
    $res = sql_select($sql);

    $desc_str="";//$type_name="";
    $job_no = '';
    $program_chk_arr = array();
    $grey_rcv_chk_arr = array();
    foreach ($res as $val) 
    { 
        if($val['COLOR_SIZE_SENSITIVE']==3)
        {
            $color_id=$val['CONTRAST_COLOR_ID'];
        }
        else
        {
            $color_id=$val['COLOR_ID'];
        }

        $desc_str = $val['DETER_ID']."*".$color_id."*".$val['DIA']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }

        if($val['FABRIC_SOURCE']==1) // only production
        {
            $main_arr[$type_name][$lib_color[$color_id]][$desc_str]['FAB_KNIT_GREY'] += $fabric_costing_arr['knit']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['DIA']][$val['UOM']];
            $main_arr[$type_name][$lib_color[$color_id]][$desc_str]['FAB_WOVEN_GREY'] += $fabric_costing_arr['woven']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['DIA']][$val['UOM']];
        

            $main_arr[$type_name][$lib_color[$color_id]][$desc_str]['COLOR_ID'] = $color_id;

            if($program_chk_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']]=="")
            {
                // $main_arr[$type_name][$desc_str]['PROGRAM_QNTY'] += $program_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']]['PROGRAM_QNTY'];
                $program_chk_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']]="kakku";
            }

            if($grey_rcv_chk_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]=="")
            {
                $main_arr[$type_name][$lib_color[$color_id]][$desc_str]['SHORT_GREY'] += $short_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]['SHORT_GREY'];

                // $main_arr[$type_name][$desc_str]['GREY_QTY'] += $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]['GREY_QTY'];
                // $main_arr[$type_name][$desc_str]['BATCH_QTY'] += $batch_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']];
                $grey_rcv_chk_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]="kakku";
            }
            
            $main_arr[$type_name][$lib_color[$color_id]][$desc_str]['PROGRAM_DATE'] = $program_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']]['PROGRAM_DATE'];
            $main_arr[$type_name][$lib_color[$color_id]][$desc_str]['LAST_GREY_DATE'] = $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]['LAST_GREY_DATE'];
            $main_arr[$type_name][$lib_color[$color_id]][$desc_str]['LAST_GREY_QTY'] = $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]['LAST_GREY_QTY'];
        }

        if($val['COLOR_SIZE_SENSITIVE']==3)
        {
            $grey_fab_req_qty = $fabric_costing_arr['knit']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['DIA']][$val['UOM']];
            $wvn_fab_req_qty = $fabric_costing_arr['woven']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['DIA']][$val['UOM']];

            $contrust_qty_array[$type_name][$val['COLOR_ID']][$desc_str]['contrast_color_id'] = $val['CONTRAST_COLOR_ID'];
            $contrust_qty_array[$type_name][$val['COLOR_ID']][$desc_str]['grey_fab_req_qty'] = $grey_fab_req_qty;
            $contrust_qty_array[$type_name][$val['COLOR_ID']][$desc_str]['wvn_fab_req_qty']  = $wvn_fab_req_qty;
        }
        $job_no = $val['JOB_NO'];
    }

    /*======================================================================================/
    /                                    grey fab transfer                                  /
    /======================================================================================*/

    $sql_in="SELECT a.to_order_id,b.uom,b.transfer_qnty as qnty, e.body_part_type as BODY_PART_TYPE, c.color_id as COLOR_ID, c.id as PROGRAM_NO,f.determination_id as DETER_ID, f.dia as DIA, c.knitting_source as KNITTING_SOURCE, c.knitting_party as KNITTING_PARTY,c.machine_dia as MACHINE_DIA FROM inv_item_transfer_mst a, inv_item_transfer_dtls b, ppl_planning_entry_plan_dtls f, ppl_planning_info_entry_dtls c, ppl_planning_info_entry_mst d left join lib_body_part e on d.body_part_id=e.id WHERE a.id = b.mst_id and d.id=c.mst_id and c.id =f.dtls_id and d.id=f.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=13 and a.entry_form in(13) and a.transfer_criteria=4 and a.to_order_id in($poIds) and c.status_active=1 and c.is_deleted=0 and b.to_program=c.id and b.active_dtls_id_in_transfer=1";
    // echo $sql_in;die();
    $result = sql_select($sql_in);
    foreach ($result as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['COLOR_ID']."*".$val['DIA']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }
        $main_arr[$type_name][$lib_color[$val['COLOR_ID']]][$desc_str]['trans_in'] += $val['QNTY'];

        // ===================================================
        $desc_str = $val['DETER_ID']."*".$val['MACHINE_DIA']."*".$val['DIA']."*".$val['COLOR_ID'];

        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['trans_in'] += $val['QNTY'];
    }
    // ========================================================
    $sql_in="SELECT a.from_order_id,b.uom,b.transfer_qnty as qnty, e.body_part_type as BODY_PART_TYPE, c.color_id as COLOR_ID, c.id as PROGRAM_NO,f.determination_id as DETER_ID, f.dia as DIA, c.knitting_source as KNITTING_SOURCE, c.knitting_party as KNITTING_PARTY,c.machine_dia as MACHINE_DIA FROM inv_item_transfer_mst a, inv_item_transfer_dtls b, ppl_planning_entry_plan_dtls f, ppl_planning_info_entry_dtls c, ppl_planning_info_entry_mst d left join lib_body_part e on d.body_part_id=e.id WHERE a.id = b.mst_id and d.id=c.mst_id and c.id =f.dtls_id and d.id=f.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=13 and a.entry_form in(13) and a.transfer_criteria=4 and a.from_order_id in($poIds) and c.status_active=1 and c.is_deleted=0 and b.from_program=c.id and b.active_dtls_id_in_transfer=1";
    // echo $sql_in;die();
    $result = sql_select($sql_in);
    foreach ($result as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['COLOR_ID']."*".$val['DIA']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }
        $main_arr[$type_name][$lib_color[$val['COLOR_ID']]][$desc_str]['trans_out'] += $val['QNTY'];

        // ===================================================
        $desc_str = $val['DETER_ID']."*".$val['MACHINE_DIA']."*".$val['DIA']."*".$val['COLOR_ID'];

        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$desc_str][$val['PROGRAM_NO']]['trans_out'] += $val['QNTY'];
    }
    // echo "<pre>";print_r($main_arr);die();

    // ====================================================================================
    
    // echo "<pre>"; print_r($contrust_qty_array);die;

    $gmt_color_library=array();//fabric_cost_dtls_id
    $gmt_color_data=sql_select("SELECT a.body_part_id,b.gmts_color_id, b.contrast_color_id  FROM  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b 
    WHERE a.id=b.pre_cost_fabric_cost_dtls_id  and  a.job_no='$job_no' and a.color_size_sensitive=3");
 
    foreach( $gmt_color_data as $gmt_color_row)
    {
        $gmt_color_library[$gmt_color_row[csf("gmts_color_id")]].= sizeof($gmt_color_library[$gmt_color_row[csf("gmts_color_id")]]) ? ",".$gmt_color_row[csf("contrast_color_id")] : $gmt_color_row[csf("contrast_color_id")];
    }
    // echo "<pre>";print_r($gmt_color_library);die();

    // ===================== get contrust color wise req qty ========================
    $contrust_color_qty_array = array();
    $gmts_color_array = array();
    foreach ($contrust_qty_array as $btype => $btype_data) 
    {
        foreach ($btype_data as $gmt_color => $color_data) 
        {
            foreach ($color_data as $str_k => $row) 
            {
                // $gmt_color_ex = explode("_", $gmt_color);
                $gmts_color_array[$gmt_color] = $gmt_color;
                $gmt_color_ex = array_unique(explode(",", $gmt_color_library[$gmt_color]));
                foreach ($gmt_color_ex as $key => $value) 
                {           
                    $contrust_color_qty_array[$btype][$value][$str_k]['grey_fab_req_qty'] += $row['grey_fab_req_qty'];                
                    $contrust_color_qty_array[$btype][$value][$str_k]['wvn_fab_req_qty'] += $row['wvn_fab_req_qty'];
                }                                
            }
        }        
    }
    // echo "<pre>";print_r($main_arr);die();
    $r_span_arr = array();
    foreach ($main_arr as $type => $type_data) 
    {
        foreach ($type_data as $colorName => $color_data) 
        {
            foreach ($color_data as $dSrt => $val) 
            {
                $r_span_arr[$type]++;
            }
        }
    }

    $constructtion_arr=array();
    $sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id order by b.id asc";
    $data_array_deter=sql_select($sql_deter);
    foreach( $data_array_deter as $row )
    {
        $constructtion_arr[$row[csf('id')]]=$row[csf('construction')];
        $composition_arr[$row[csf('id')]].=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ";
    }
    unset($data_array_deter);
    $acting_width = $screen_size-100;
    $four_percent = $acting_width*0.04;
    $five_percent = $acting_width*0.05;
    $six_percent = $acting_width*0.06;
    ?>
    <!-- ========================================== Grey Fabric Status =============================== -->
    <style type="text/css">
        .word_break_wrap{
            word-wrap: break-word;
            word-break: break-all;
        }
    </style>
    <div id="data_panel" align="center" style="width:<? echo $acting_width;?>px">
        <script>
            function new_window()
            {
                document.getElementById('scroll_body').style.overflow="auto";
                document.getElementById('scroll_body').style.maxHeight="none";
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
                document.getElementById('scroll_body').style.overflowY="scroll";
                document.getElementById('scroll_body').style.maxHeight="240px";
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: <? echo $acting_width;?>px;" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="<? echo $acting_width;?>">
                <caption style="font-size:20px;"><b>Grey Fabric Status</b></caption>
                <tbody>
                    <tr>
                        <td colspan="19" width="<? echo $acting_width;?>"><b>Style Name:<? echo $sqlOrderRes[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref:<? echo $sqlOrderRes[0]['INT_REF'];?></b></td>
                    </tr>
                </tbody>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width;?>">
                <thead>
                    <tr>                                   
                        <th width="<? echo $six_percent;?>"><p>Knit Type</p></th>
                        <th width="<? echo $six_percent;?>"><p>Fabric Structure</p></th>
                        <th width="<? echo $six_percent;?>"><p>Color/ Combo</p></th>
                        <th width="<? echo $four_percent;?>"><p>Finish Dia</p></th>
                        <th width="<? echo $four_percent;?>"><p>Unit</p></th>
                        <th width="<? echo $six_percent;?>"><p>Req Qty</p></th>

                        <th width="<? echo $six_percent;?>"><p>Excess Qty</p></th>
                        <th width="<? echo $six_percent;?>"><p>Total Req</p></th>
                        <th width="<? echo $six_percent;?>"><p>Program Qty</p></th>
                        <th width="<? echo $six_percent;?>"><p>Program Bal</p></th>
                        <th width="<? echo $six_percent;?>"><p>Last Program Date</p></th>
                        <th width="<? echo $six_percent;?>"><p>Gray Rcv Qty</p></th>
                        <th width="<? echo $six_percent;?>"><p>Last Rcv qty</p></th>
                        <th width="<? echo $six_percent;?>"><p>Last Rcv Date</p></th>
                        <th width="<? echo $six_percent;?>"><p>Trans In</p></th>
                        <th width="<? echo $six_percent;?>"><p>Trans Out</p></th>
                        <th width="<? echo $six_percent;?>"><p>Gray Rcv Bal</p></th>
                        <th width="<? echo $six_percent;?>"><p>Batch Qty</p></th>
                        <th width="<? echo $six_percent;?>"><p>Stock At Gray Store</p></th>
                    </tr>
                </thead>
            </table>
            <div id="scroll_body" style="width:<? echo $acting_width+18;?>px; max-height:240px;overflow-y:scroll;">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width;?>">
                    <tbody>
                        <?

                        $i=0;
                        foreach ($main_arr as $type => $type_data) 
                        {
                            $y=1;
                            ksort($type_data);
                            foreach ($type_data as $colorName => $color_data) 
                            {
                                foreach ($color_data as $dSrt => $val) 
                                {
                                    $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF";
                                    $dSrt_data = explode("*", $dSrt);
                                    $DETER_ID = $dSrt_data[0];
                                    $COLOR = $dSrt_data[1];
                                    $DIA = $dSrt_data[2];
                                    $UOM = $dSrt_data[3];

                                    $grey_required = $val['FAB_KNIT_GREY'] + $val['FAB_WOVEN_GREY'];// + $contrust_color_qty_array[$type][$COLOR][$dSrt]['grey_fab_req_qty'];
                                    $total_required = $grey_required+$val['SHORT_GREY'];
                                    $program_balance = $total_required - $val['PROGRAM_QNTY'];
                                    $grey_rcv_balance = ($total_required+$val['trans_out']) - ($val['GREY_QTY']+$val['trans_in']);

                                    $grey_rcv_qty = $receive_qty_array[$dSrt];
                                    $grey_issue_qty = $issue_qty_array[$dSrt];
                                    $stock_at_store = ($grey_rcv_qty+$val['trans_in']) -  ($grey_issue_qty+$val['trans_out']);
                                    $issue_tot+=$grey_issue_qty;
                                    ?>                        
                                    <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                        <?
                                        if($y==1)
                                        {
                                            ?>
                                            <td valign="middle" width="<? echo $six_percent;?>" rowspan="<? echo $r_span_arr[$type];?>"><p><? echo $type;?></p></td>
                                            <?
                                        } 
                                        ?>                              
                                        <td width="<? echo $six_percent;?>" align="left"><p><? echo $constructtion_arr[$DETER_ID];//.", ".$composition_arr[$DETER_ID];?></p></td>
                                        <td width="<? echo $six_percent;?>" align="left" title="<?=$colorName;?>"><p><?=substr($colorName,0,9);?></p></td>
                                        <td width="<? echo $four_percent;?>" align="center"><? echo $DIA;?></td>
                                        <td width="<? echo $four_percent;?>" align="center"><? echo $unit_of_measurement[$UOM];?></td>
                                        <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($grey_required,0);?></td>
                                        <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['SHORT_GREY'],0);?></td>
                                        <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($total_required,0);?></td>
                                        <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['PROGRAM_QNTY'],0);?></td>
                                        <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($program_balance,0);?></td>
                                        <td width="<? echo $six_percent;?>" align="center"><? echo change_date_format($val['PROGRAM_DATE']);?></td>
                                        <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['GREY_QTY'],0);?></td>
                                        <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['LAST_GREY_QTY'],0);?></td>
                                        <td width="<? echo $six_percent;?>" align="center"><? echo change_date_format($val['LAST_GREY_DATE']);?></td>
                                        <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['trans_in'],0);?></td>
                                        <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['trans_out'],0);?></td>
                                        <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($grey_rcv_balance,0); ?></td>
                                        <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['BATCH_QTY'],0) ?></td>
                                        <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($stock_at_store,0);?></td>
                                    </tr>
                                    <?
                                    $i++; 
                                    $y++;
                                    $tot_grey_required +=$grey_required;
                                    $tot_short_grey +=$val['SHORT_GREY'];
                                    $tot_total_required +=$total_required;
                                    $tot_program_qnty += $val['PROGRAM_QNTY'];
                                    $tot_program_balance +=$program_balance;
                                    $tot_grey_qnty +=$val['GREY_QTY'];
                                    $tot_last_grey_qty += $val['LAST_GREY_QTY'];
                                    $tot_grey_rcv_balance +=$grey_rcv_balance;
                                    $tot_batch_qty +=$val['BATCH_QTY'];
                                    $tot_stock_at_store +=$stock_at_store;
                                    $tot_trans_in +=$val['trans_in'];
                                    $tot_trans_out +=$val['trans_out'];

                                    $sub_grey_required +=$grey_required;
                                    $sub_short_grey +=$val['SHORT_GREY'];
                                    $sub_total_required +=$total_required;
                                    $sub_program_qnty += $val['PROGRAM_QNTY'];
                                    $sub_program_balance +=$program_balance;
                                    $sub_grey_qnty +=$val['GREY_QTY'];
                                    $sub_last_grey_qty += $val['LAST_GREY_QTY'];
                                    $sub_grey_rcv_balance +=$grey_rcv_balance;
                                    $sub_batch_qty +=$val['BATCH_QTY'];
                                    $sub_stock_at_store +=$stock_at_store;
                                    $sub_trans_in +=$val['trans_in'];
                                    $sub_trans_out +=$val['trans_out'];
                                }
                            }
                            ?>
                                <tr bgcolor="#ccc">
                                    <td align="right" width="<? echo $six_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $six_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $six_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $four_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $four_percent;?>"><strong>Total:</strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_grey_required,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_short_grey,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_total_required,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_program_qnty,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_program_balance,0);?></td>
                                    <td align="right" width="<? echo $six_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_grey_qnty,0);?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_last_grey_qty,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $six_percent;?>"><? echo fn_number_format($sub_trans_in,0); ?></td>
                                    <td align="right" width="<? echo $six_percent;?>"><? echo fn_number_format($sub_trans_out,0); ?></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_grey_rcv_balance,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_batch_qty,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><? echo fn_number_format($sub_stock_at_store,0); ?></td>
                                </tr>
                            <?
                            $sub_grey_required=$sub_short_grey=$sub_total_required=$sub_program_qnty=$sub_program_balance=$sub_grey_qnty=$sub_last_grey_qty=$sub_grey_rcv_balance=$sub_batch_qty=$sub_stock_at_store=$sub_trans_in=$sub_trans_out=0;
                        }
                        ?>
                        
                    </tbody>
                </table>
            </div>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width;?>">
                <tfoot>
                    <tr style="font-weight:bold;text-align:right;">
                        <th align="right" width="<? echo $six_percent;?>">&nbsp;</th>
                        <th align="right" width="<? echo $six_percent;?>">&nbsp;</th>
                        <th align="right" width="<? echo $six_percent;?>">&nbsp;</th>
                        <th align="right" width="<? echo $four_percent;?>">&nbsp;</th>
                        <th align="right" width="<? echo $four_percent;?>"><strong>G.Total:</strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_grey_required,0); ?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_short_grey,0); ?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_total_required,0); ?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_program_qnty,0); ?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_program_balance,0);?></th>
                        <th align="right" width="<? echo $six_percent;?>">&nbsp;</th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_grey_qnty,0);?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_last_grey_qty,0); ?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>">&nbsp;</th>
                        <th align="right" width="<? echo $six_percent;?>"><? echo fn_number_format($tot_trans_in,0); ?></th>
                        <th align="right" width="<? echo $six_percent;?>"><? echo fn_number_format($tot_trans_out,0); ?></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_grey_rcv_balance,0); ?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_batch_qty,0); ?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><? echo fn_number_format($tot_stock_at_store,0); ?></th>
                    </tr>
                </tfoot>
            </table>
            <br>
            <!-- =======================================  Factory Wise ================================-->
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="1150">
                <tbody>
                    <tr>
                        <td colspan="15" width="1000" align="center"><h3>Factory Wise</h3></td>
                    </tr>
                </tbody>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1225">
                <thead>
                    <tr>
                        <th width="65">Knit Type</th>
                        <th width="65">Knitting Factory</th>
                        <th width="65">Fabric Structure</th>
                        <th width="65">M/c Dia</th>
                        <th width="65">Finish Dia</th>
                        <th width="65">Color</th>
                        <th width="65">Program No</th>
                        <th width="65">Program qty</th>

                        <th width="65">Last Prog Date</th>
                        <th width="65">Rcv Qty</th>
                        <th width="65">Last rcv qty</th>
                        <th width="65">Last Rcv Date</th>
                        <th width="65">Trans In</th>
                        <th width="65">Trans Out</th>
                        <th width="65">Start Date</th>
                        <th width="65">End Date</th>
                        <th width="65">Rcv Backlog</th>
                        <th width="65">Rcv Bal</th>
                    </tr>
                </thead>
            </table>
            <div id="scroll_body" style="width:1245px; max-height:240px;overflow-y:scroll;">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1225">
                    <tbody>
                        <?
                        $type_span_arr = array();
                        $party_span_arr = array();
                        foreach ($factory_wise_arr as $type_name => $type_data) 
                        {
                            $type_span=1;
                            foreach ($type_data as $knitSourceParty => $knitSourcePartyData) 
                            {
                                $type_span_arr[$type_name]++;
                                foreach ($knitSourcePartyData as $dSrt => $dSrt_val) 
                                {
                                    foreach ($dSrt_val as $progId => $val) 
                                    {
                                        $type_span_arr[$type_name]++;
                                        $type_source_span_arr[$type_name][$knitSourceParty]++;
                                    }
                                }
                            }
                        }
                        // echo "<pre>";    print_r($type_span_arr);
                        $i=1;
                        $toDay = new DateTime('now');
                        $today_str = date('Y-m-d',strtotime('now'));
                        foreach ($factory_wise_arr as $type_name => $type_data) 
                        {
                            $f=0;
                            foreach ($type_data as $knitSourceParty => $knitSourcePartyData) 
                            {
                                $s=0;
                                foreach ($knitSourcePartyData as $dSrt => $dSrt_val) 
                                {
                                    foreach ($dSrt_val as $progId => $val) 
                                    {
                                        // echo $type_name."**".$knitSourceParty."**".$progId."**".$dSrt."=<br>";
                                        $dSrt_data = explode("*", $dSrt);
                                        $DETER_ID = $dSrt_data[0];
                                        $MACHINE_DIA = $dSrt_data[1];
                                        $DIA = $dSrt_data[2];
                                        $COLOR_ID = $dSrt_data[3];
                                        $PROGRAM_NO = $dSrt_data[4];
                                        $receive_balance = ($val['PROGRAM_QNTY']+$val['trans_out']) - ($val['FACT_GREY_QTY']+$val['trans_in']);


                                        $s_date=date('Y-m-d',strtotime($val['START_DATE']));
                                        $e_date=date('Y-m-d',strtotime($val['END_DATE']));
                                        /*01.if(Today Date<=Program Start Date)
                                        then data will be Zero.

                                        02.if(Today Date>Program End Date)
                                        then formula=Program qnty - Rcv qnty.
                                        03.if(Today Date>Progam Start Date & Today Date <Progam End Date) 
                                        then formula= [{(Program qnty/ Number of Days as per planing info start and end date)* (Number of Days before current day)} - Program qnty)].*/

                                        $start_date  = new DateTime($val['START_DATE']);
                                        $end_date    = new DateTime($val['END_DATE']);

                                        $lbdpSbBackLog=0;
                                        //if($toDay <= $start_date)
                                        if($today_str <= $s_date)
                                        {
                                            $lbdpSbBackLog = 0;
                                        }
                                        //elseif($toDay > $end_date)
                                        elseif($today_str > $e_date)
                                        {
                                            $lbdpSbBackLog = $receive_balance;
                                        }
                                        elseif ($today_str > $s_date && $today_str <= $e_date) 
                                        {
                                            $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;
                                            $todayDaysDif= $start_date->diff($toDay)->format('%a');
                                            $lbdpSbBackLog = (($val['PROGRAM_QNTY']/$tnaDaysDif)*$todayDaysDif) - $val['FACT_GREY_QTY'];
                                        }

                                        if($lbdpSbBackLog<0){
                                            $lbdpSbBackLog=0;
                                        }
                                        if ($val['START_DATE']=="" && $val['START_DATE']=="") 
                                        {
                                            $lbdpSbBackLog=0;
                                        }

                                        $bgcolor=($s%2==0)?"#E9F3FF":"#FFFFFF";
                                        ?>
                                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trp_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trp_<? echo $i; ?>">
                                            <?
                                            if($f==0)
                                            {
                                                ?>
                                                 <td width="65" rowspan="<? echo $type_span_arr[$type_name]+1;?>"><? echo $type_name;?></td>
                                                <?
                                            }
                                            if($s==0)
                                            {
                                                $knit_source_arr = explode("*", $knitSourceParty);
                                                if($knit_source_arr[0]==1){
                                                    $source_name = $lib_company[$knit_source_arr[1]];
                                                }else{
                                                    $source_name = $lib_supplier[$knit_source_arr[1]];
                                                }
                                                ?>
                                                <td width="65" rowspan="<? echo $type_source_span_arr[$type_name][$knitSourceParty];?>" align="center"><? echo $source_name;?></td>
                                                <?

                                            }
                                         ?>
                                            
                                            <td width="65" align="center"><p class="word_break_wrap"><? echo $constructtion_arr[$DETER_ID];//.", ".$composition_arr[$DETER_ID];?></p></td>
                                            <td width="65" align="center"><? echo $MACHINE_DIA; ?></td>
                                            <td width="65" align="center"><? echo $DIA; ?></td>
                                            <td width="65" align="center"><? echo $lib_color[$COLOR_ID]; ?></td>
                                            <td width="65" align="center"><? echo $progId; ?></td>
                                            <td width="65" align="right"><? echo fn_number_format($val['PROGRAM_QNTY'],0) ?></td>
                                            <td width="65" align="center"><? echo change_date_format($val['PROGRAM_DATE']); ?></td>
                                            <td width="65" align="right"><? echo fn_number_format($val['FACT_GREY_QTY'],0) ?></td>
                                            <td width="65" align="right"><? echo fn_number_format($val['LAST_GREY_QTY'],0) ?></td>
                                            <td width="65" align="center"><? echo change_date_format($val['LAST_GREY_DATE']) ?></td>
                                            <td width="65" align="right"><? echo fn_number_format($val['trans_in'],0) ?></td>
                                            <td width="65" align="right"><? echo fn_number_format($val['trans_out'],0) ?></td>
                                            <td width="65" align="center"><? echo change_date_format($val['START_DATE']) ?></td>
                                            <td width="65" align="center"><? echo change_date_format($val['END_DATE']) ?></td>
                                            <td width="65" align="right"><? echo fn_number_format($lbdpSbBackLog,0) ?></td>
                                            <td width="65" align="right"><? echo fn_number_format($receive_balance,0); ?></td>
                                        </tr>
                                        <?
                                       $f++;$s++;$i++;
                                       $sub_program_qnty += $val['PROGRAM_QNTY'];
                                       $sub_fact_grey_qty += $val['FACT_GREY_QTY'];
                                       $sub_last_grey_qty += $val['LAST_GREY_QTY'];
                                       $sub_trans_in_qty += $val['trans_in'];
                                       $sub_trans_out_qty += $val['trans_out'];
                                       $sub_lbdpSbBackLog += $lbdpSbBackLog;
                                       $sub_receive_balance += $receive_balance;

                                       $grand_program_qnty += $val['PROGRAM_QNTY'];
                                       $grand_fact_grey_qty += $val['FACT_GREY_QTY'];
                                       $grand_last_grey_qty += $val['LAST_GREY_QTY'];
                                       $grand_trans_in_qty += $val['trans_in'];
                                       $grand_trans_out_qty += $val['trans_out'];
                                       $grand_lbdpSbBackLog += $lbdpSbBackLog;
                                       $grand_receive_balance += $receive_balance;
                                    }
                                }
                                ?>
                                <tr bgcolor="#ccc">
                                    <td align="right" colspan="6"><strong> Total</strong></td>
                                    <td align="right" ><strong><? echo fn_number_format($sub_program_qnty,0); ?></strong></td>
                                    <td align="right" ><strong> </strong></td>
                                    <td align="right" ><strong><? echo fn_number_format($sub_fact_grey_qty,0); ?> </strong></td>
                                    <td align="right" ><strong><? echo fn_number_format($sub_last_grey_qty,0); ?></strong></td>
                                    
                                    <td align="right" ><strong> </strong></td>
                                    <td align="right" ><strong> <? echo fn_number_format($sub_trans_in_qty,0); ?></strong></td>
                                    <td align="right" ><strong> <? echo fn_number_format($sub_trans_out_qty,0); ?></strong></td>
                                    <td align="right" ><strong> </strong></td>
                                    <td align="right" ><strong> </strong></td>
                                    <td align="right" ><strong><? echo fn_number_format($sub_lbdpSbBackLog,0); ?></strong></td>
                                    <td align="right" ><strong><? echo fn_number_format($sub_receive_balance,0); ?></strong></td>
                                </tr>
                                <? 
                                $sub_program_qnty=$sub_fact_grey_qty=$sub_last_grey_qty=$sub_lbdpSbBackLog=$sub_receive_balance=0;
                            }
                            ?>
                        </tbody>
                    </table>
               
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1225">
                    <tfoot>
                        <tr bgcolor="#ccc">
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong> Grand Total</strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_program_qnty,0); ?></strong></td>
                            <td width="65" align="right" ><strong> </strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_fact_grey_qty,0); ?> </strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_last_grey_qty,0); ?></strong></td>
                            
                            <td width="65" align="right" ><strong> </strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_trans_in_qty,0); ?> </strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_trans_out_qty,0); ?> </strong></td>
                            <td width="65" align="right" ><strong> </strong></td>
                            <td width="65" align="right" ><strong> </strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_lbdpSbBackLog,0); ?></strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_receive_balance,0); ?></strong></td>
                        </tr>
                        <? 
                        $grand_program_qnty=$grand_fact_grey_qty=$grand_last_grey_qty=$grand_lbdpSbBackLog=$grand_receive_balance=0;
                    }
                    ?>
                </tfoot>
            </table>
             </div>
            <br>
            <!-- ======================================= Yarn Sending Status ============================================= -->
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="905">
                <tbody>
                    <tr>
                        <td colspan="12" width="900" align="center"><h3>Yarn Sending Status</h3></td>
                    </tr>
                </tbody>
            </table>
            <?
            if(!empty($program_nos))
            {
                $lib_yarn_count = return_library_array("select id , yarn_count from lib_yarn_count","id","yarn_count");
                $lib_brand = return_library_array("select id , brand_name from lib_brand","id","brand_name");
                $all_program_id_cond="";
                $progCond="";
                if($db_type==2 && count($program_nos)>999)
                {
                    $all_program_arr_chunk=array_chunk($program_nos,999) ;
                    foreach($all_program_arr_chunk as $chunk_arr)
                    {
                        $chunk_arr_value=implode(",",$chunk_arr);
                        $progCond.=" a.knit_id in($chunk_arr_value) or ";
                    }

                    $all_program_id_cond.=" and (".chop($progCond,'or ').")";
                }
                else
                {
                    $all_program_id_cond=" and a.knit_id in(".implode(',', $program_nos).")";
                }

                /*$requ_sql = sql_select("select b.supplier_id as SUPPLIER_ID, B.yarn_count_id as YARN_COUNT_ID, b.brand as BRAND, b.lot as LOT, sum(a.yarn_qnty) as YARN_QNTY, yarn_comp_type1st as YARN_COMP_TYPE1ST, yarn_comp_percent1st as YARN_COMP_PERCENT1ST, yarn_comp_type2nd as YARN_COMP_TYPE2ND, yarn_comp_percent2nd as YARN_COMP_PERCENT2ND, b.color as COLOR, a.prod_id as PROD_ID, a.requisition_no as REQUISITION_NO from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id= b.id and a.status_active=1 and a.is_deleted=0 $all_program_id_cond group by b.supplier_id, B.yarn_count_id, b.brand, b.lot, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd , b.color , a.prod_id , a.requisition_no");*/
                $requ_sql = sql_select("SELECT c.knitting_source as KNITTING_SOURCE, c.knitting_party as KNITTING_PARTY, b.yarn_count_id as YARN_COUNT_ID, b.brand as BRAND, b.lot as LOT, sum(a.yarn_qnty) as YARN_QNTY, yarn_comp_type1st as YARN_COMP_TYPE1ST, yarn_comp_percent1st as YARN_COMP_PERCENT1ST, yarn_comp_type2nd as YARN_COMP_TYPE2ND, yarn_comp_percent2nd as YARN_COMP_PERCENT2ND, b.color as COLOR, a.prod_id as PROD_ID, a.requisition_no as REQUISITION_NO from ppl_yarn_requisition_entry a, product_details_master b, ppl_planning_info_entry_dtls c where a.prod_id= b.id and a.knit_id =c.id and a.status_active=1 and a.is_deleted=0 and c.status_active=1 and c.is_deleted=0 $all_program_id_cond group by c.knitting_source, c.knitting_party,B.yarn_count_id, b.brand, b.lot, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, b.color, a.prod_id, a.requisition_no");


                foreach ($requ_sql as $val) 
                {
                    $compos = '';
                    if ($val['YARN_COMP_PERCENT2ND'] != 0) {
                        $compos = $composition[$val['YARN_COMP_TYPE1ST']] . " " . $val['YARN_COMP_PERCENT1ST'] . "%" . " " . $composition[$val['YARN_COMP_TYPE2ND']] . " " . $val['YARN_COMP_PERCENT2ND'] . "%";
                    } else {
                        $compos = $composition[$val['YARN_COMP_TYPE1ST']] . " " . $val['YARN_COMP_PERCENT1ST'] . "%" . " " . $composition[$val['YARN_COMP_TYPE2ND']];
                    }

                    $prod_arr[$val['PROD_ID']] =$val['PROD_ID'];
                    $requ_arr[$val['REQUISITION_NO']] =$val['REQUISITION_NO'];

                    if($val['KNITTING_SOURCE'] == 1){
                        $KNITTING_PARTY = $lib_company[$val['KNITTING_PARTY']];
                    }else{
                        $KNITTING_PARTY = $lib_supplier[$val['KNITTING_PARTY']];
                    }

                    $requ_data_arr[$KNITTING_PARTY][$val['PROD_ID']]['COLOR'] = $val['COLOR'];
                    $requ_data_arr[$KNITTING_PARTY][$val['PROD_ID']]['DESC'] = $compos;
                    $requ_data_arr[$KNITTING_PARTY][$val['PROD_ID']]['YARN_COUNT_ID'] = $val['YARN_COUNT_ID'];
                    $requ_data_arr[$KNITTING_PARTY][$val['PROD_ID']]['BRAND'] = $val['BRAND'];
                    $requ_data_arr[$KNITTING_PARTY][$val['PROD_ID']]['LOT'] = $val['LOT'];
                    $requ_data_arr[$KNITTING_PARTY][$val['PROD_ID']]['YARN_QNTY'] += $val['YARN_QNTY'];
                    $requ_data_arr[$KNITTING_PARTY][$val['PROD_ID']]['PARTY'] = $val['KNITTING_PARTY'];
                }

                if(!empty($prod_arr))
                {
                    $all_prod_id_cond="";
                    $prodCond="";
                    if($db_type==2 && count($prod_arr)>999)
                    {
                        $all_prod_arr_chunk=array_chunk($prod_arr,999) ;
                        foreach($all_prod_arr_chunk as $chunk_arr)
                        {
                            $chunk_arr_value=implode(",",$chunk_arr);
                            $prodCond.="  b.prod_id in($chunk_arr_value) or ";
                        }

                        $all_prod_id_cond.=" and (".chop($prodCond,'or ').")";
                    }
                    else
                    {
                        $all_prod_id_cond=" and b.prod_id in(".implode(',', $prod_arr).")";
                    }
                    //print_r( $requ_arr);die;
                    
                    $issue_sql = sql_select("SELECT a.knit_dye_company as KNIT_DYE_COMPANY, a.knit_dye_source as KNIT_DYE_SOURCE, b.receive_basis as RECEIVE_BASIS, b.requisition_no as REQUISITION_NO, b.prod_id as PROD_ID, c.quantity as QUANTITY, a.issue_date as ISSUE_DATE from inv_issue_master a, inv_transaction b, order_wise_pro_details c, product_details_master d where a.id = b.mst_id and b.id=c.trans_id and b.prod_id = d.id and a.entry_form =3 and b.transaction_type=2 and b.item_category=1 $all_prod_id_cond order by b.id asc");
                    
                    foreach ($issue_sql as $val) 
                    {
                        if($val['RECEIVE_BASIS'] ==3 && $requ_arr[$val['REQUISITION_NO']] !="")
                        {
                            if($val['KNIT_DYE_SOURCE'] == 1){
                                $KNITTING_PARTY = $lib_company[$val['KNIT_DYE_COMPANY']];
                            }else{
                                $KNITTING_PARTY = $lib_supplier[$val['KNIT_DYE_COMPANY']];
                            }

                            if($last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['ISSUE_DATE'] =="")
                            {
                                $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['QUANTITY'] = $val['QUANTITY'];
                                $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['ISSUE_DATE'] = $val['ISSUE_DATE'];
                            }
                            else
                            {
                                if(strtotime($last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['ISSUE_DATE']) == strtotime($val['ISSUE_DATE']))
                                {
                                    $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['QUANTITY'] += $val['QUANTITY'];
                                    $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['ISSUE_DATE'] = $val['ISSUE_DATE'];
                                }
                                else if(strtotime($last_yarn_issue_info[$val['PROD_ID']]['ISSUE_DATE']) < strtotime($val['ISSUE_DATE']))
                                {
                                    $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['QUANTITY'] = $val['QUANTITY'];
                                    $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['ISSUE_DATE'] = $val['ISSUE_DATE'];
                                }
                            }

                            $issue_requ_qty[$KNITTING_PARTY][$val['PROD_ID']] += $val['QUANTITY'];
                        }
                        $yarn_issue_qty[$val['PROD_ID']] += $val['QUANTITY'];
                    }
                    //print_r( $issue_requ_qty);die;
                    //die;
                    $rcv_sql = sql_select("SELECT a.SUPPLIER_ID,b.prod_id as PROD_ID,b.transaction_type as TTYPE,a.KNITTING_COMPANY,a.KNITTING_SOURCE, sum(b.cons_quantity) as QUANTITY,sum(b.cons_reject_qnty) as REJ_QUANTITY from inv_receive_master a, inv_transaction b,order_wise_pro_details c where a.id = b.mst_id and b.id=c.trans_id and c.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and a.entry_form in(1,9) and b.transaction_type in(1,4) and b.item_category=1 and a.status_active =1 and b.status_active =1 $all_prod_id_cond group by a.supplier_id,b.prod_id,b.transaction_type,a.knitting_company,a.knitting_source");
                    

                    foreach ($rcv_sql as $val) 
                    {
                        if($val['KNITTING_SOURCE'] == 1)
                        {
                                $KNITTING_PARTY = $lib_company[$val['KNITTING_COMPANY']];
                        }
                        else
                        {
                            $KNITTING_PARTY = $lib_supplier[$val['KNITTING_COMPANY']];
                        }

                        $yarn_rcv_qty[$KNITTING_PARTY][$val['PROD_ID']][$val['TTYPE']] += $val['QUANTITY']+$val['REJ_QUANTITY'];
                    }

                }

            }
            // echo "<pre>";print_r($yarn_rcv_qty);
            ?>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="900">
                <thead>
                    <tr>
                        <th width="75">Knitting Factory</th>
                        <th width="75">Solid/dyed</th>
                        <th width="75">Yarn Composition</th>
                        <th width="75">Count</th>
                        <th width="75">Brand</th>
                        <th width="75">Lot</th>
                        <th width="75">Req Qty</th>

                        <th width="75">Issue Qty</th>
                        <th width="75">Last issue Date</th>
                        <th width="75">Last Issue Qty</th>
                        <th width="75">Issue Bal</th>
                        <!-- <th width="75">Stock At Yarn Store</th> -->
                    </tr>
                </thead>
            </table>
            <div id="scroll_body" style="width:920px; max-height:240px;overflow-y:scroll;">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="900">
                    <tbody>
                        <?
                            if(!empty($requ_data_arr))
                            {
                                $i=0;
                                $gr_tot_yarn_requ=$gr_tot_yarn_issue=$gr_last_yarn_issue=$gr_yarn_issue_balance=$gr_tot_yarn_stock=0;
                                foreach ($requ_data_arr as $supplier_name=>$supplier_data) 
                                {
                                    $z=0;
                                    foreach ($supplier_data as $product_id => $row) 
                                    {
                                        $stock = $yarn_rcv_qty[$supplier_name][$product_id][1] - $yarn_issue_qty[$product_id];
                                        // $issue_balance = $row['YARN_QNTY'] - $issue_requ_qty[$supplier_name][$product_id];
                                        $issue_balance = $issue_requ_qty[$supplier_name][$product_id] - $yarn_rcv_qty[$supplier_name][$product_id][4];

                                        // echo "string".$supplier_name."==".$product_id."<br>";
                                        // echo $issue_requ_qty[$supplier_name][$product_id]."-".$yarn_rcv_qty[$supplier_name][$product_id][4]."<br>";

                                        $bgcolor=($z%2==0)?"#E9F3FF":"#FFFFFF";
                                        ?>
                                        <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('try_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="try_<? echo $i; ?>">
                                            <?
                                            if($z==0)
                                            {
                                                ?>
                                                <td width="75" rowspan="<? echo count($supplier_data)?>"><? echo $supplier_name;?></a></td>
                                                <?
                                            }
                                            ?>
                                            <td width="70" align="right"><? echo $lib_color[$row['COLOR']];?></td>
                                            <td width="70" align="right"><p class="word_break_wrap"><? echo $row['DESC'];?></p></td>
                                            <td width="70" align="right"><? echo $lib_yarn_count[$row['YARN_COUNT_ID']];?></td>
                                            <td width="70" align="right"><? echo $lib_brand[$row['BRAND']];?></td>
                                            <td width="70" align="right"><? echo $row['LOT'];?></td>
                                            <td width="70" align="right"><? echo $row['YARN_QNTY'];?></td>
                                            <td width="70" align="right" title="<?=$product_id."=".$issue_requ_qty[$supplier_name][$product_id] ."-". $yarn_rcv_qty[$supplier_name][$product_id][4];?>"><? echo fn_number_format(($issue_requ_qty[$supplier_name][$product_id] - $yarn_rcv_qty[$supplier_name][$product_id][4]),0);?></td>
                                            <td width="70" align="right"><? echo change_date_format($last_yarn_issue_info[$supplier_name][$product_id]['ISSUE_DATE']);?></td>
                                            <td width="70" align="right"><? echo fn_number_format($last_yarn_issue_info[$supplier_name][$product_id]['QUANTITY'],0);?></td>
                                            <td width="70" align="right"><? echo fn_number_format($issue_balance,0);?></td>
                                            <!-- <td width="70" align="right"><? //echo fn_number_format($stock,0);?></td> -->
                                        </tr>
                                        <?
                                        $z++;$i++;
                                        $tot_yarn_requ += $row['YARN_QNTY'];
                                        $tot_yarn_issue += $issue_requ_qty[$supplier_name][$product_id] - $yarn_rcv_qty[$supplier_name][$product_id][4];
                                        $last_yarn_issue += $last_yarn_issue_info[$supplier_name][$product_id]['QUANTITY'];
                                        $yarn_issue_balance += $issue_balance;
                                        $tot_yarn_stock += $stock;


                                        $gr_tot_yarn_requ += $row['YARN_QNTY'];
                                        $gr_tot_yarn_issue += $issue_requ_qty[$supplier_name][$product_id] - $yarn_rcv_qty[$supplier_name][$product_id][4];
                                        $gr_last_yarn_issue += $last_yarn_issue_info[$supplier_name][$product_id]['QUANTITY'];
                                        $gr_yarn_issue_balance += $issue_balance;
                                        $gr_tot_yarn_stock += $stock;
                                    }
                                    ?>
                                    <tr bgcolor="#ccc">
                                        <td align="right" colspan="6"><strong>Total:</strong></td>
                                        <td align="right"><strong><? echo fn_number_format($tot_yarn_requ,0); ?></strong></td>
                                        <td align="right"><strong><? echo fn_number_format($tot_yarn_issue,0); ?></strong></td>
                                        <td align="right"><strong><? //echo fn_number_format($skdslj,0); ?></strong></td>
                                        <td align="right"><strong><? echo fn_number_format($last_yarn_issue,0); ?></strong></td>
                                        <td align="right"><strong><? echo fn_number_format($yarn_issue_balance,0); ?></strong></td>
                                        <!-- <td align="right"><strong><? echo fn_number_format($tot_yarn_stock,0); ?></strong></td> -->
                                    </tr>
                                    <?
                                    $tot_yarn_requ=$tot_yarn_issue=$last_yarn_issue=$yarn_issue_balance=$tot_yarn_stock=0;
                                }
                            }
                        ?>
                    </tbody>
                    <tfoot>                        
                        <tr>
                            <th align="right" colspan="6"><strong>Grand Total:</strong></th>
                            <th align="right"><strong><? echo fn_number_format($gr_tot_yarn_requ,0); ?></strong></th>
                            <th align="right"><strong><? echo fn_number_format($gr_tot_yarn_issue,0); ?></strong></th>
                            <th align="right"><strong><? //echo fn_number_format($skdslj,0); ?></strong></th>
                            <th align="right"><strong><? echo fn_number_format($gr_last_yarn_issue,0); ?></strong></th>
                            <th align="right"><strong><? echo fn_number_format($gr_yarn_issue_balance,0); ?></strong></th>
                            <!-- <td align="right"><strong><? echo fn_number_format($tot_yarn_stock,0); ?></strong></td> -->
                        </tr>
                    </tfoot>
                </table> 
            </div> 
        </div>        
    </div>
    <?
}

if($action=="grey_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    $lib_company = return_library_array("select id,company_name from lib_company", "id", "company_name");
    extract($_REQUEST);
    $poIds = str_replace("'", "", $po_break_down_id);
    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();
    //$costPerArr=$condition->getCostingPerArr();
    $fabric= new fabric($condition);
    //echo $fabric->getQuery();die;
    // $fabric_costing_arr=$fabric->getQtyArray_by_JobColorBodyTypeDeterminIdAndDiaWidth_knitAndwoven_greyAndfinish();

    // $fabric_costing_arr=$fabric->getQtyArray_by_JobColorFabColorBodyTypeDeterminIdAndDiaWidth_knitAndwoven_greyAndfinish();
    $fabric_costing_arr=$fabric->getQtyArray_by_JobFabSourceColorFabColorBodyTypeDeterminIdAndDiaWidth_knitAndwoven_greyAndfinish();
    // echo "<pre>";print_r($fabric_costing_arr);echo "</pre>";


    $constructtion_arr=array();
    $sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id order by b.id asc";
    $data_array_deter=sql_select($sql_deter);
    foreach( $data_array_deter as $row )
    {
        $constructtion_arr[$row[csf('id')]]=$row[csf('construction')];
        $composition_arr[$row[csf('id')]].=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ";
    }
    unset($data_array_deter);
    $main_arr = array();
    $sqlOrderRes = sql_select("SELECT a.job_no as JOB_NO, a.style_ref_no as STYLE, b.grouping as INT_REF from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id  and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in ($poIds) group by a.job_no, a.style_ref_no,  b.grouping");

    $short_sql = sql_select("SELECT B.BODY_PART_TYPE, a.grey_fab_qnty as GREY_FAB_QNTY, a.fabric_color_id as COLOR_ID, b.lib_yarn_count_deter_id as DETERMINATION_ID, a.dia_width as DIA_WIDTH, b.uom as UOM, b.job_no as JOB_NO from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b where a.pre_cost_fabric_cost_dtls_id=b.id and a.is_short=1 and a.booking_type=1 and a.po_break_down_id in ($poIds) and a.status_active =1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

    foreach ($short_sql as $val) 
    {
        $short_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETERMINATION_ID']][$val['COLOR_ID']][$val['DIA_WIDTH']][$val['UOM']]['SHORT_GREY']+=$val['GREY_FAB_QNTY']; 
    }
    // echo "<pre>";print_r($short_arr);echo "</pre>";

    $grey_sql = sql_select("SELECT e.BOOKING_ID,d.job_no_mst as JOB_NO, e.receive_date as RECEIVE_DATE, b.color_id as COLOR_ID, b.width as WIDTH, b.uom as UOM, b.febric_description_id as FEBRIC_DESCRIPTION_ID, c.body_part_type as BODY_PART_TYPE, e.knitting_company as KNITTING_COMPANY, e.knitting_source as KNITTING_SOURCE, b.machine_dia as MACHINE_DIA, sum(a.quantity) as QUANTITY from inv_receive_master e, order_wise_pro_details a, pro_grey_prod_entry_dtls b left join lib_body_part c on b.body_part_id = c.id, wo_po_break_down d where e.id = b.mst_id and e.entry_form in (2,22,58) and a.dtls_id=b.id and a.trans_id=b.trans_id and A.PO_BREAKDOWN_ID=d.id and a.entry_form in (2,22,58) and a.trans_id >0 and a.po_breakdown_id in ($poIds) and a.is_sales=0 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted=0 group by e.booking_id,d.job_no_mst, b.color_id, b.width, b.uom, b.febric_description_id, c.body_part_type, e.knitting_company, e.knitting_source, b.machine_dia, e.receive_date order by e.receive_date asc");

    foreach ($grey_sql as $val) 
    {
        $desc_str = $val['FEBRIC_DESCRIPTION_ID']."*".$val['COLOR_ID']."*".$val['WIDTH']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }
        $main_arr[$type_name][$constructtion_arr[$val['FEBRIC_DESCRIPTION_ID']]][$lib_color[$val['COLOR_ID']]][$desc_str]['GREY_QTY'] += $val['QUANTITY'];
        if($grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE'] =="")
        {
            $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_QTY'] = $val['QUANTITY'];
            $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
        }
        else
        {
            if(strtotime($grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE']) == strtotime($val['RECEIVE_DATE']))
            {
                $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_QTY'] += $val['QUANTITY'];
                $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
            }
            else if(strtotime($grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE']) < strtotime($val['RECEIVE_DATE']))
            {
                $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_QTY'] = $val['QUANTITY'];
                $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
            }
        }

        if($factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE'] == "")
        {
            $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_QTY'] = $val['QUANTITY'];
            $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
        }
        else
        {
            if(strtotime($factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE']) == strtotime($val['RECEIVE_DATE']))
            {
                $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_QTY'] += $val['QUANTITY'];
                $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
            } 
            else if(strtotime($factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE']) < strtotime($val['RECEIVE_DATE']))
            {
                $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_QTY'] = $val['QUANTITY'];
                $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['LAST_GREY_DATE'] = $val['RECEIVE_DATE'];
            }
        }

       $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['UOM']]['GREY_QTY'] += $val['QUANTITY'];
       $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']][$val['MACHINE_DIA']][$val['FEBRIC_DESCRIPTION_ID']][$val['COLOR_ID']][$val['WIDTH']][$val['BOOKING_ID']]['FACT_GREY_QTY'] += $val['QUANTITY'];
    }

    // echo "<pre>"; print_r($main_arr);die;


    $program_sql = "SELECT b.id as PROGRAM_NO, d.job_no_mst as JOB_NO, e.body_part_type as BODY_PART_TYPE, b.color_id as COLOR_ID, c.determination_id as DETER_ID, c.dia as DIA, b.knitting_source as KNITTING_SOURCE, b.knitting_party as KNITTING_PARTY, max(b.start_date) as START_DATE, max(b.end_date) as END_DATE, max(b.program_date) as PROGRAM_DATE, b.machine_dia as MACHINE_DIA, sum(c.program_qnty) as PROGRAM_QNTY from ppl_planning_info_entry_mst a left join lib_body_part e on a.body_part_id=e.id, ppl_planning_info_entry_dtls b, ppl_planning_entry_plan_dtls c, wo_po_break_down d where a.id=b.mst_id and b.id =c.dtls_id and a.id=c.mst_id and c.po_id =d.id and c.po_id in ($poIds) and a.status_active=1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by b.id, d.job_no_mst, e.body_part_type, b.color_id, c.determination_id, c.dia, b.knitting_source, b.knitting_party, b.machine_dia";
    // echo $program_sql;
    $program_res = sql_select($program_sql);
    
    foreach ($program_res as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['COLOR_ID']."*".$val['DIA']."*12";
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }
        $main_arr[$type_name][$constructtion_arr[$val['DETER_ID']]][$lib_color[$val['COLOR_ID']]][$desc_str]['PROGRAM_QNTY'] += $val['PROGRAM_QNTY'];
        $program_nos[$val['PROGRAM_NO']]=$val['PROGRAM_NO'];
        $program_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['COLOR_ID']][$val['DIA']]['PROGRAM_QNTY'] += $val['PROGRAM_QNTY'];
        $program_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['COLOR_ID']][$val['DIA']]['PROGRAM_DATE'] = $val['PROGRAM_DATE'];


        $desc_str = $val['DETER_ID']."*".$val['MACHINE_DIA']."*".$val['DIA']."*".$val['COLOR_ID'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }else{
            $type_name = 'CIRCULAR';
        }

        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$constructtion_arr[$val['DETER_ID']]][$desc_str][$val['PROGRAM_NO']]['COLOR_ID'] = $val['COLOR_ID'];
        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$constructtion_arr[$val['DETER_ID']]][$desc_str][$val['PROGRAM_NO']]['START_DATE'] = $val['START_DATE'];
        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$constructtion_arr[$val['DETER_ID']]][$desc_str][$val['PROGRAM_NO']]['END_DATE'] = $val['END_DATE'];
        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$constructtion_arr[$val['DETER_ID']]][$desc_str][$val['PROGRAM_NO']]['PROGRAM_DATE'] = $val['PROGRAM_DATE'];
        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$constructtion_arr[$val['DETER_ID']]][$desc_str][$val['PROGRAM_NO']]['PROGRAM_QNTY'] += $val['PROGRAM_QNTY'];
        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$constructtion_arr[$val['DETER_ID']]][$desc_str][$val['PROGRAM_NO']]['FACT_GREY_QTY'] += $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_PARTY']][$val['MACHINE_DIA']][$val['DETER_ID']][$val['COLOR_ID']][$val['DIA']][$val['PROGRAM_NO']]['FACT_GREY_QTY'];

        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$constructtion_arr[$val['DETER_ID']]][$desc_str][$val['PROGRAM_NO']]['LAST_GREY_DATE'] = $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_PARTY']][$val['MACHINE_DIA']][$val['DETER_ID']][$val['COLOR_ID']][$val['DIA']][$val['PROGRAM_NO']]['LAST_GREY_DATE'];

        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$constructtion_arr[$val['DETER_ID']]][$desc_str][$val['PROGRAM_NO']]['LAST_GREY_QTY'] += $factory_wise_rcv[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['KNITTING_SOURCE']][$val['KNITTING_PARTY']][$val['MACHINE_DIA']][$val['DETER_ID']][$val['COLOR_ID']][$val['DIA']][$val['PROGRAM_NO']]['LAST_GREY_QTY'];

        //echo "[".$val['JOB_NO']."][".$val['BODY_PART_TYPE']."][".$val['KNITTING_SOURCE']."][".$val['KNITTING_PARTY']."][".$val['DETER_ID']."][".$val['COLOR_ID']."][".$val['DIA']."]<br>";

    }

    // echo "<pre>";  print_r($factory_wise_arr);die;
    $batch_sql = sql_select("SELECT a.batch_no, d.job_no_mst as JOB_NO,a.color_id as COLOR_ID, b.batch_qnty as BATCH_QNTY,c.gsm as GSM, c.dia_width as DIA_WIDTH, c.detarmination_id as DETARMINATION_ID, b.body_part_id as BODY_PART_ID, e.body_part_type as BODY_PART_TYPE, c.unit_of_measure as UOM from pro_batch_create_mst a, pro_batch_create_dtls b left join lib_body_part e on b.body_part_id = e.id, product_details_master c, wo_po_break_down d where a.id=b.mst_id and b.prod_id=c.id and b.po_id=d.id $ext_cond and b.po_id in ($poIds) AND a.batch_against IN (1) and b.is_sales =0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

    foreach ($batch_sql as $val) 
    {
        $desc_str = $val['DETARMINATION_ID']."*".$val['COLOR_ID']."*".$val['DIA_WIDTH']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }

        // $batch_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETARMINATION_ID']][$val['COLOR_ID']][$val['DIA_WIDTH']][$val['UOM']] +=$val['BATCH_QNTY'];
        $main_arr[$type_name][$constructtion_arr[$val['DETARMINATION_ID']]][$lib_color[$val['COLOR_ID']]][$desc_str]['BATCH_QTY'] += $val['BATCH_QNTY'];
    }

    // ====================================================================================

    $sqlGreyRcv = "SELECT c.febric_description_id as DETER_ID, d.quantity as QTY,c.UOM,c.COLOR_ID,c.width as DIA from inv_receive_master a, inv_transaction b,pro_grey_prod_entry_dtls c,order_wise_pro_details d where a.id=b.mst_id and b.id=c.trans_id and a.id=c.mst_id and b.id=d.trans_id and c.id=d.dtls_id and d.trans_type=1 and b.item_category=13 and a.status_active=1 and b.status_active=1 and c.status_active=1 and d.po_breakdown_id in($poIds)";
    // echo $sqlGreyRcv;die();
    $sqlRes = sql_select($sqlGreyRcv);
    $receive_qty_array = array();
    $desc_str="";
    foreach ($sqlRes as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['COLOR_ID']."*".$val['DIA']."*".$val['UOM'];
        $receive_qty_array[$desc_str] += $val['QTY'];
    }

    // ======================================================================================
    $sqlGreyIssue = "SELECT c.detarmination_id as DETER_ID, d.quantity as QTY,c.unit_of_measure as UOM,e.COLOR_ID,c.dia_width as DIA from inv_issue_master a, inv_transaction b,product_details_master c,order_wise_pro_details d,inv_grey_fabric_issue_dtls e where a.id=b.mst_id and c.id=d.prod_id and b.id=d.trans_id and c.id=b.prod_id and e.trans_id=b.id and a.id=e.mst_id and e.prod_id=c.id and d.trans_type=2 and b.item_category=13 and c.item_category_id=13 and a.status_active=1 and b.status_active=1 and c.status_active=1 and d.po_breakdown_id in($poIds)";
    // echo $sqlGreyIssue;die();
    $sqlRes = sql_select($sqlGreyIssue);
    $issue_qty_array = array();
    $desc_str="";
    foreach ($sqlRes as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['COLOR_ID']."*".$val['DIA']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }
        $main_arr[$type_name][$constructtion_arr[$val['DETER_ID']]][$lib_color[$val['COLOR_ID']]][$desc_str]['grey_issue_qty'] += $val['QTY'];
        $main_arr[$type_name][$constructtion_arr[$val['DETER_ID']]][$lib_color[$val['COLOR_ID']]][$desc_str]['COLOR_ID'] += $val['COLOR_ID'];
        $issue_qty_array[$desc_str] += $val['QTY'];
    }
    // print_r($main_arr);die();
    $sql = "SELECT a.job_no as JOB_NO, a.color_number_id as COLOR_ID,b.COLOR_SIZE_SENSITIVE, b.lib_yarn_count_deter_id as DETER_ID, b.uom as UOM, a.dia_width as DIA,b.FABRIC_SOURCE, b.body_part_type as BODY_PART_TYPE,c.CONTRAST_COLOR_ID from wo_pre_cos_fab_co_avg_con_dtls a, wo_pre_cost_fabric_cost_dtls b LEFT JOIN wo_pre_cos_fab_co_color_dtls c ON b.job_no = c.job_no and b.id=c.pre_cost_fabric_cost_dtls_id  AND c.status_active = 1 
       AND c.is_deleted = 0 where a.pre_cost_fabric_cost_dtls_id =b.id and a.po_break_down_id in ($poIds) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.cons !=0 group by a.job_no, a.color_number_id, b.lib_yarn_count_deter_id, b.uom, a.dia_width,  b.body_part_type,c.contrast_color_id,b.color_size_sensitive,b.fabric_source order by b.body_part_type, b.lib_yarn_count_deter_id";
    // echo $sql;
    $res = sql_select($sql);

    $desc_str="";//$type_name="";
    $job_no = '';
    $program_chk_arr = array();
    $grey_rcv_chk_arr = array();
    foreach ($res as $val) 
    { 
        if($val['COLOR_SIZE_SENSITIVE']==3)
        {
            $color_id=$val['CONTRAST_COLOR_ID'];
        }
        else
        {
            $color_id=$val['COLOR_ID'];
        }

        $desc_str = $val['DETER_ID']."*".$color_id."*".$val['DIA']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }

        if($val['FABRIC_SOURCE']==1) // only production
        {
            $main_arr[$type_name][$constructtion_arr[$val['DETER_ID']]][$lib_color[$color_id]][$desc_str]['FAB_KNIT_GREY'] += $fabric_costing_arr['knit']['grey'][$val['JOB_NO']][1][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['DIA']][$val['UOM']];
            // echo $fabric_costing_arr['knit']['grey'][$val['JOB_NO']][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['DIA']][$val['UOM']]."<br>";
            $main_arr[$type_name][$constructtion_arr[$val['DETER_ID']]][$lib_color[$color_id]][$desc_str]['FAB_WOVEN_GREY'] += $fabric_costing_arr['woven']['grey'][$val['JOB_NO']][1][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['DIA']][$val['UOM']];
        

            $main_arr[$type_name][$constructtion_arr[$val['DETER_ID']]][$lib_color[$color_id]][$desc_str]['COLOR_ID'] = $color_id;

            if($program_chk_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']]=="")
            {
                // $main_arr[$type_name][$desc_str]['PROGRAM_QNTY'] += $program_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']]['PROGRAM_QNTY'];
                $program_chk_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']]="kakku";
            }

            if($grey_rcv_chk_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]=="")
            {
                $main_arr[$type_name][$constructtion_arr[$val['DETER_ID']]][$lib_color[$color_id]][$desc_str]['SHORT_GREY'] += $short_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]['SHORT_GREY'];

                // $main_arr[$type_name][$desc_str]['GREY_QTY'] += $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]['GREY_QTY'];
                // $main_arr[$type_name][$desc_str]['BATCH_QTY'] += $batch_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']];
                $grey_rcv_chk_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]="kakku";
            }
            
            $main_arr[$type_name][$constructtion_arr[$val['DETER_ID']]][$lib_color[$color_id]][$desc_str]['PROGRAM_DATE'] = $program_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']]['PROGRAM_DATE'];
            $main_arr[$type_name][$constructtion_arr[$val['DETER_ID']]][$lib_color[$color_id]][$desc_str]['LAST_GREY_DATE'] = $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]['LAST_GREY_DATE'];
            $main_arr[$type_name][$constructtion_arr[$val['DETER_ID']]][$lib_color[$color_id]][$desc_str]['LAST_GREY_QTY'] = $grey_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$color_id][$val['DIA']][$val['UOM']]['LAST_GREY_QTY'];
        }

        if($val['COLOR_SIZE_SENSITIVE']==3)
        {
            $grey_fab_req_qty = $fabric_costing_arr['knit']['grey'][$val['JOB_NO']][1][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['DIA']][$val['UOM']];
            $wvn_fab_req_qty = $fabric_costing_arr['woven']['grey'][$val['JOB_NO']][1][$val['COLOR_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['DETER_ID']][$val['DIA']][$val['UOM']];

            $contrust_qty_array[$type_name][$val['COLOR_ID']][$desc_str]['contrast_color_id'] = $val['CONTRAST_COLOR_ID'];
            $contrust_qty_array[$type_name][$val['COLOR_ID']][$desc_str]['grey_fab_req_qty'] = $grey_fab_req_qty;
            $contrust_qty_array[$type_name][$val['COLOR_ID']][$desc_str]['wvn_fab_req_qty']  = $wvn_fab_req_qty;
        }
        $job_no = $val['JOB_NO'];
    }

    /*======================================================================================/
    /                                    grey fab transfer                                  /
    /======================================================================================*/

    $sql_in="SELECT a.to_order_id,b.uom,b.transfer_qnty as qnty, e.body_part_type as BODY_PART_TYPE, c.color_id as COLOR_ID, c.id as PROGRAM_NO,f.determination_id as DETER_ID, f.dia as DIA, c.knitting_source as KNITTING_SOURCE, c.knitting_party as KNITTING_PARTY,c.machine_dia as MACHINE_DIA FROM inv_item_transfer_mst a, inv_item_transfer_dtls b, ppl_planning_entry_plan_dtls f, ppl_planning_info_entry_dtls c, ppl_planning_info_entry_mst d left join lib_body_part e on d.body_part_id=e.id WHERE a.id = b.mst_id and d.id=c.mst_id and c.id =f.dtls_id and d.id=f.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=13 and a.entry_form in(13) and a.transfer_criteria=4 and a.to_order_id in($poIds) and c.status_active=1 and c.is_deleted=0 and b.to_program=c.id and b.active_dtls_id_in_transfer=1";
    // echo $sql_in;die();
    $result = sql_select($sql_in);
    foreach ($result as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['COLOR_ID']."*".$val['DIA']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }
        $main_arr[$type_name][$constructtion_arr[$val['DETER_ID']]][$lib_color[$val['COLOR_ID']]][$desc_str]['trans_in'] += $val['QNTY'];

        // ===================================================
        $desc_str = $val['DETER_ID']."*".$val['MACHINE_DIA']."*".$val['DIA']."*".$val['COLOR_ID'];

        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$constructtion_arr[$val['DETER_ID']]][$desc_str][$val['PROGRAM_NO']]['trans_in'] += $val['QNTY'];
    }
    // ========================================================
    $sql_in="SELECT a.from_order_id,b.uom,b.transfer_qnty as qnty, e.body_part_type as BODY_PART_TYPE, c.color_id as COLOR_ID, c.id as PROGRAM_NO,f.determination_id as DETER_ID, f.dia as DIA, c.knitting_source as KNITTING_SOURCE, c.knitting_party as KNITTING_PARTY,c.machine_dia as MACHINE_DIA FROM inv_item_transfer_mst a, inv_item_transfer_dtls b, ppl_planning_entry_plan_dtls f, ppl_planning_info_entry_dtls c, ppl_planning_info_entry_mst d left join lib_body_part e on d.body_part_id=e.id WHERE a.id = b.mst_id and d.id=c.mst_id and c.id =f.dtls_id and d.id=f.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.item_category=13 and a.entry_form in(13) and a.transfer_criteria=4 and a.from_order_id in($poIds) and c.status_active=1 and c.is_deleted=0 and b.from_program=c.id and b.active_dtls_id_in_transfer=1";
    // echo $sql_in;die();
    $result = sql_select($sql_in);
    foreach ($result as $val) 
    {
        $desc_str = $val['DETER_ID']."*".$val['COLOR_ID']."*".$val['DIA']."*".$val['UOM'];
        if($val['BODY_PART_TYPE'] == 40 || $val['BODY_PART_TYPE'] == 50) 
        {
            $type_name = 'FLAT';
        }
        else
        {
            $type_name = 'CIRCULAR';
        }
        $main_arr[$type_name][$constructtion_arr[$val['DETER_ID']]][$lib_color[$val['COLOR_ID']]][$desc_str]['trans_out'] += $val['QNTY'];

        // ===================================================
        $desc_str = $val['DETER_ID']."*".$val['MACHINE_DIA']."*".$val['DIA']."*".$val['COLOR_ID'];

        $factory_wise_arr[$type_name][$val['KNITTING_SOURCE']."*".$val['KNITTING_PARTY']][$constructtion_arr[$val['DETER_ID']]][$desc_str][$val['PROGRAM_NO']]['trans_out'] += $val['QNTY'];
    }
    // echo "<pre>";print_r($main_arr);die();

    // ====================================================================================
    
    // echo "<pre>"; print_r($contrust_qty_array);die;

    $gmt_color_library=array();//fabric_cost_dtls_id
    $gmt_color_data=sql_select("SELECT a.body_part_id,b.gmts_color_id, b.contrast_color_id  FROM  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b 
    WHERE a.id=b.pre_cost_fabric_cost_dtls_id  and  a.job_no='$job_no' and a.color_size_sensitive=3");
 
    foreach( $gmt_color_data as $gmt_color_row)
    {
        $gmt_color_library[$gmt_color_row[csf("gmts_color_id")]].= sizeof($gmt_color_library[$gmt_color_row[csf("gmts_color_id")]]) ? ",".$gmt_color_row[csf("contrast_color_id")] : $gmt_color_row[csf("contrast_color_id")];
    }
    // echo "<pre>";print_r($gmt_color_library);die();

    // ===================== get contrust color wise req qty ========================
    $contrust_color_qty_array = array();
    $gmts_color_array = array();
    foreach ($contrust_qty_array as $btype => $btype_data) 
    {
        foreach ($btype_data as $gmt_color => $color_data) 
        {
            foreach ($color_data as $str_k => $row) 
            {
                // $gmt_color_ex = explode("_", $gmt_color);
                $gmts_color_array[$gmt_color] = $gmt_color;
                $gmt_color_ex = array_unique(explode(",", $gmt_color_library[$gmt_color]));
                foreach ($gmt_color_ex as $key => $value) 
                {           
                    $contrust_color_qty_array[$btype][$value][$str_k]['grey_fab_req_qty'] += $row['grey_fab_req_qty'];                
                    $contrust_color_qty_array[$btype][$value][$str_k]['wvn_fab_req_qty'] += $row['wvn_fab_req_qty'];
                }                                
            }
        }        
    }
    // echo "<pre>";print_r($main_arr);die();
    $r_span_arr = array();
    foreach ($main_arr as $type => $type_data) 
    {
        foreach ($type_data as $const_name => $const_data) 
        {
            foreach ($const_data as $colorName => $color_data) 
            {
                foreach ($color_data as $dSrt => $val) 
                {
                    $grey_required = $val['FAB_KNIT_GREY'] + $val['FAB_WOVEN_GREY'];// + $contrust_color_qty_array[$type][$COLOR][$dSrt]['grey_fab_req_qty'];
                    $total_required = $grey_required+$val['SHORT_GREY'];
                    // $grey_issue_qty = $issue_qty_array[$dSrt];
                    $grey_issue_qty = $val['grey_issue_qty'];
                    if($total_required>0 || $val['PROGRAM_QNTY']>0 || $val['GREY_QTY']>0 || $val['BATCH_QTY']>0 || $val['trans_in']>0 || $val['trans_out']>0 || $grey_issue_qty>0)
                    {                        
                        $r_span_arr[$type]++;
                    }
                }
            }
        }
    }
    $acting_width = $screen_size-100;
    $four_percent = $acting_width*0.04;
    $five_percent = $acting_width*0.05;
    $six_percent = $acting_width*0.06;
    ?>
    <!-- ========================================== Grey Fabric Status =============================== -->
    <style type="text/css">
        .word_break_wrap{
            word-wrap: break-word;
            word-break: break-all;
        }
    </style>
    <div id="data_panel" align="center" style="width:<? echo $acting_width;?>px">
        <script>
            function new_window()
            {
                document.getElementById('scroll_body').style.overflow="auto";
                document.getElementById('scroll_body').style.maxHeight="none";
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
                document.getElementById('scroll_body').style.overflowY="scroll";
                document.getElementById('scroll_body').style.maxHeight="240px";
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>
    <div class="main" style="width: <? echo $acting_width;?>px;" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="<? echo $acting_width;?>">
                <caption style="font-size:20px;"><b>Grey Fabric Status</b></caption>
                <tbody>
                    <tr>
                        <td colspan="19" width="<? echo $acting_width;?>"><b>Style Name:<? echo $sqlOrderRes[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref:<? echo $sqlOrderRes[0]['INT_REF'];?></b></td>
                    </tr>
                </tbody>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width;?>">
                <thead>
                    <tr>                                   
                        <th width="<? echo $six_percent;?>"><p>Knit Type</p></th>
                        <th width="<? echo $six_percent;?>"><p>Fabric Structure</p></th>
                        <th width="<? echo $six_percent;?>"><p>Color/ Combo</p></th>
                        <th width="<? echo $four_percent;?>"><p>Finish Dia</p></th>
                        <th width="<? echo $four_percent;?>"><p>Unit</p></th>
                        <th width="<? echo $six_percent;?>"><p>Req Qty</p></th>

                        <th width="<? echo $six_percent;?>"><p>Excess Qty</p></th>
                        <th width="<? echo $six_percent;?>"><p>Total Req</p></th>
                        <th width="<? echo $six_percent;?>"><p>Program Qty</p></th>
                        <th width="<? echo $six_percent;?>"><p>Program Bal</p></th>
                        <th width="<? echo $six_percent;?>"><p>Last Program Date</p></th>
                        <th width="<? echo $six_percent;?>"><p>Gray Rcv Qty</p></th>
                        <th width="<? echo $six_percent;?>"><p>Last Rcv qty</p></th>
                        <th width="<? echo $six_percent;?>"><p>Last Rcv Date</p></th>
                        <th width="<? echo $six_percent;?>"><p>Trans In</p></th>
                        <th width="<? echo $six_percent;?>"><p>Trans Out</p></th>
                        <th width="<? echo $six_percent;?>"><p>Gray Rcv Bal</p></th>
                        <th width="<? echo $six_percent;?>"><p>Issue Qty</p></th>
                        <th width="<? echo $six_percent;?>"><p>Batch Qty</p></th>
                        <th width="<? echo $six_percent;?>"><p>Stock At Gray Store</p></th>
                    </tr>
                </thead>
            </table>
            <div id="scroll_body" style="width:<? echo $acting_width+18;?>px; max-height:240px;overflow-y:scroll;">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width;?>">
                    <tbody>
                        <?

                        $i=0;
                        foreach ($main_arr as $type => $type_data) 
                        {
                            $y=1;
                            ksort($type_data);
                            foreach ($type_data as $const_name => $const_data) 
                            {
                                ksort($const_data);
                                foreach ($const_data as $colorName => $color_data) 
                                {
                                    foreach ($color_data as $dSrt => $val) 
                                    {
                                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF";
                                        $dSrt_data = explode("*", $dSrt);
                                        $DETER_ID = $dSrt_data[0];
                                        $COLOR = $dSrt_data[1];
                                        $DIA = $dSrt_data[2];
                                        $UOM = $dSrt_data[3];

                                        $grey_required = $val['FAB_KNIT_GREY'] + $val['FAB_WOVEN_GREY'];// + $contrust_color_qty_array[$type][$COLOR][$dSrt]['grey_fab_req_qty'];
                                        $total_required = $grey_required+$val['SHORT_GREY'];
                                        $program_balance = $total_required - $val['PROGRAM_QNTY'];
                                        $grey_rcv_balance = ($total_required+$val['trans_out']) - ($val['GREY_QTY']+$val['trans_in']);

                                        // $grey_rcv_qty = $receive_qty_array[$dSrt];
                                        $grey_rcv_qty = $val['GREY_QTY'];
                                        // $grey_issue_qty = $issue_qty_array[$dSrt];
                                        $grey_issue_qty = $val['grey_issue_qty'];
                                        $stock_at_store = ($grey_rcv_qty+$val['trans_in']) -  ($grey_issue_qty+$val['trans_out']);

                                        $issue_tot+=$grey_issue_qty;
                                        if($total_required>0 || $val['PROGRAM_QNTY']>0 || $val['GREY_QTY']>0 || $val['BATCH_QTY']>0 || $val['trans_in']>0 || $val['trans_out']>0 || $grey_issue_qty>0)
                                        {
                                            ?>                        
                                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">
                                                <?
                                                if($y==1)
                                                {
                                                    ?>
                                                    <td valign="middle" width="<? echo $six_percent;?>" rowspan="<? echo $r_span_arr[$type];?>"><p><? echo $type;?></p></td>
                                                    <?
                                                } 
                                                ?>                              
                                                <td width="<? echo $six_percent;?>" align="left"><p><? echo $constructtion_arr[$DETER_ID];//.", ".$composition_arr[$DETER_ID];?></p></td>
                                                <td width="<? echo $six_percent;?>" align="left" title="<?=$colorName;?>"><p><?=substr($colorName,0,9);?></p></td>
                                                <td width="<? echo $four_percent;?>" align="center"><? echo $DIA;?></td>
                                                <td width="<? echo $four_percent;?>" align="center"><? echo $unit_of_measurement[$UOM];?></td>
                                                <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($grey_required,0);?></td>
                                                <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['SHORT_GREY'],0);?></td>
                                                <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($total_required,0);?></td>
                                                <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['PROGRAM_QNTY'],0);?></td>
                                                <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($program_balance,0);?></td>
                                                <td width="<? echo $six_percent;?>" align="center"><? echo change_date_format($val['PROGRAM_DATE']);?></td>
                                                <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['GREY_QTY'],0);?></td>
                                                <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['LAST_GREY_QTY'],0);?></td>
                                                <td width="<? echo $six_percent;?>" align="center"><? echo change_date_format($val['LAST_GREY_DATE']);?></td>
                                                <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['trans_in'],0);?></td>
                                                <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['trans_out'],0);?></td>
                                                <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($grey_rcv_balance,0); ?></td>
                                                <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($grey_issue_qty,0) ?></td>
                                                <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($val['BATCH_QTY'],0) ?></td>
                                                <td width="<? echo $six_percent;?>" align="right"><? echo fn_number_format($stock_at_store,0);?></td>
                                            </tr>
                                            <?
                                            $i++; 
                                            $y++;
                                            $tot_grey_required +=$grey_required;
                                            $tot_short_grey +=$val['SHORT_GREY'];
                                            $tot_total_required +=$total_required;
                                            $tot_program_qnty += $val['PROGRAM_QNTY'];
                                            $tot_program_balance +=$program_balance;
                                            $tot_grey_qnty +=$val['GREY_QTY'];
                                            $tot_last_grey_qty += $val['LAST_GREY_QTY'];
                                            $tot_grey_rcv_balance +=$grey_rcv_balance;
                                            $tot_issue_qty +=$grey_issue_qty;
                                            $tot_batch_qty +=$val['BATCH_QTY'];
                                            $tot_stock_at_store +=$stock_at_store;
                                            $tot_trans_in +=$val['trans_in'];
                                            $tot_trans_out +=$val['trans_out'];

                                            $sub_grey_required +=$grey_required;
                                            $sub_short_grey +=$val['SHORT_GREY'];
                                            $sub_total_required +=$total_required;
                                            $sub_program_qnty += $val['PROGRAM_QNTY'];
                                            $sub_program_balance +=$program_balance;
                                            $sub_grey_qnty +=$val['GREY_QTY'];
                                            $sub_last_grey_qty += $val['LAST_GREY_QTY'];
                                            $sub_grey_rcv_balance +=$grey_rcv_balance;
                                            $sub_issue_qty +=$grey_issue_qty;
                                            $sub_batch_qty +=$val['BATCH_QTY'];
                                            $sub_stock_at_store +=$stock_at_store;
                                            $sub_trans_in +=$val['trans_in'];
                                            $sub_trans_out +=$val['trans_out'];
                                        }
                                    }
                                }
                            }
                            ?>
                                <tr bgcolor="#ccc">
                                    <td align="right" width="<? echo $six_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $six_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $six_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $four_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $four_percent;?>"><strong>Total:</strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_grey_required,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_short_grey,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_total_required,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_program_qnty,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_program_balance,0);?></td>
                                    <td align="right" width="<? echo $six_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_grey_qnty,0);?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_last_grey_qty,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $six_percent;?>"><? echo fn_number_format($sub_trans_in,0); ?></td>
                                    <td align="right" width="<? echo $six_percent;?>"><? echo fn_number_format($sub_trans_out,0); ?></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_grey_rcv_balance,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_issue_qty,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($sub_batch_qty,0); ?></strong></td>
                                    <td align="right" width="<? echo $six_percent;?>"><? echo fn_number_format($sub_stock_at_store,0); ?></td>
                                </tr>
                            <?
                            $sub_grey_required=$sub_short_grey=$sub_total_required=$sub_program_qnty=$sub_program_balance=$sub_grey_qnty=$sub_last_grey_qty=$sub_grey_rcv_balance=$sub_batch_qty=$sub_stock_at_store=$sub_trans_in=$sub_trans_out=0;
                        }
                        ?>
                        
                    </tbody>
                </table>
            </div>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="<? echo $acting_width;?>">
                <tfoot>
                    <tr style="font-weight:bold;text-align:right;">
                        <th align="right" width="<? echo $six_percent;?>">&nbsp;</th>
                        <th align="right" width="<? echo $six_percent;?>">&nbsp;</th>
                        <th align="right" width="<? echo $six_percent;?>">&nbsp;</th>
                        <th align="right" width="<? echo $four_percent;?>">&nbsp;</th>
                        <th align="right" width="<? echo $four_percent;?>"><strong>G.Total:</strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_grey_required,0); ?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_short_grey,0); ?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_total_required,0); ?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_program_qnty,0); ?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_program_balance,0);?></th>
                        <th align="right" width="<? echo $six_percent;?>">&nbsp;</th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_grey_qnty,0);?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_last_grey_qty,0); ?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>">&nbsp;</th>
                        <th align="right" width="<? echo $six_percent;?>"><? echo fn_number_format($tot_trans_in,0); ?></th>
                        <th align="right" width="<? echo $six_percent;?>"><? echo fn_number_format($tot_trans_out,0); ?></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_grey_rcv_balance,0); ?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_issue_qty,0); ?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><strong><? echo fn_number_format($tot_batch_qty,0); ?></strong></th>
                        <th align="right" width="<? echo $six_percent;?>"><? echo fn_number_format($tot_stock_at_store,0); ?></th>
                    </tr>
                </tfoot>
            </table>
            <br>
            <!-- =======================================  Factory Wise ================================-->
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="1150">
                <tbody>
                    <tr>
                        <td colspan="15" width="1000" align="center"><h3>Factory Wise</h3></td>
                    </tr>
                </tbody>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1225">
                <thead>
                    <tr>
                        <th width="65">Knit Type</th>
                        <th width="65">Knitting Factory</th>
                        <th width="65">Fabric Structure</th>
                        <th width="65">M/c Dia</th>
                        <th width="65">Finish Dia</th>
                        <th width="65">Color</th>
                        <th width="65">Program No</th>
                        <th width="65">Program qty</th>

                        <th width="65">Last Prog Date</th>
                        <th width="65">Rcv Qty</th>
                        <th width="65">Last rcv qty</th>
                        <th width="65">Last Rcv Date</th>
                        <th width="65">Trans In</th>
                        <th width="65">Trans Out</th>
                        <th width="65">Start Date</th>
                        <th width="65">End Date</th>
                        <th width="65">Rcv Backlog</th>
                        <th width="65">Rcv Bal</th>
                    </tr>
                </thead>
            </table>
            <div id="scroll_body" style="width:1245px; max-height:240px;overflow-y:scroll;">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1225">
                    <tbody>
                        <?
                        $type_span_arr = array();
                        $party_span_arr = array();
                        foreach ($factory_wise_arr as $type_name => $type_data) 
                        {
                            $type_span=1;
                            foreach ($type_data as $knitSourceParty => $knitSourcePartyData) 
                            {
                                $type_span_arr[$type_name]++;
                                foreach ($knitSourcePartyData as $const_name => $const_val) 
                                {
                                    foreach ($const_val as $dSrt => $dSrt_val) 
                                    {
                                        foreach ($dSrt_val as $progId => $val) 
                                        {
                                            $type_span_arr[$type_name]++;
                                            $type_source_span_arr[$type_name][$knitSourceParty]++;
                                        }
                                    }
                                }
                            }
                        }
                        // echo "<pre>";    print_r($type_span_arr);
                        $i=1;
                        $toDay = new DateTime('now');
                        $today_str = date('Y-m-d',strtotime('now'));
                        $grand_program_qnty = 0;
                        $grand_fact_grey_qty = 0;
                        $grand_last_grey_qty = 0;
                        $grand_trans_in_qty = 0;
                        $grand_trans_out_qty = 0;
                        $grand_lbdpSbBackLog = 0;
                        $grand_receive_balance = 0;

                        foreach ($factory_wise_arr as $type_name => $type_data) 
                        {
                            $f=0;
                            foreach ($type_data as $knitSourceParty => $knitSourcePartyData) 
                            {
                                $s=0;
                                ksort($knitSourcePartyData);
                                $sub_program_qnty = 0;
                                $sub_fact_grey_qty = 0;
                                $sub_last_grey_qty = 0;
                                $sub_trans_in_qty = 0;
                                $sub_trans_out_qty = 0;
                                $sub_lbdpSbBackLog = 0;
                                $sub_receive_balance = 0;
                                foreach ($knitSourcePartyData as $const_name => $const_val) 
                                {
                                    foreach ($const_val as $dSrt => $dSrt_val) 
                                    {
                                        foreach ($dSrt_val as $progId => $val) 
                                        {
                                            // echo $type_name."**".$knitSourceParty."**".$progId."**".$dSrt."=<br>";
                                            $dSrt_data = explode("*", $dSrt);
                                            $DETER_ID = $dSrt_data[0];
                                            $MACHINE_DIA = $dSrt_data[1];
                                            $DIA = $dSrt_data[2];
                                            $COLOR_ID = $dSrt_data[3];
                                            $PROGRAM_NO = $dSrt_data[4];
                                            $receive_balance = ($val['PROGRAM_QNTY']+$val['trans_out']) - ($val['FACT_GREY_QTY']+$val['trans_in']);


                                            $s_date=date('Y-m-d',strtotime($val['START_DATE']));
                                            $e_date=date('Y-m-d',strtotime($val['END_DATE']));
                                            /*01.if(Today Date<=Program Start Date)
                                            then data will be Zero.

                                            02.if(Today Date>Program End Date)
                                            then formula=Program qnty - Rcv qnty.
                                            03.if(Today Date>Progam Start Date & Today Date <Progam End Date) 
                                            then formula= [{(Program qnty/ Number of Days as per planing info start and end date)* (Number of Days before current day)} - Program qnty)].*/

                                            $start_date  = new DateTime($val['START_DATE']);
                                            $end_date    = new DateTime($val['END_DATE']);

                                            $lbdpSbBackLog=0;
                                            //if($toDay <= $start_date)
                                            if($today_str <= $s_date)
                                            {
                                                $lbdpSbBackLog = 0;
                                            }
                                            //elseif($toDay > $end_date)
                                            elseif($today_str > $e_date)
                                            {
                                                $lbdpSbBackLog = $receive_balance;
                                            }
                                            elseif ($today_str > $s_date && $today_str <= $e_date) 
                                            {
                                                $tnaDaysDif  = $end_date->diff($start_date)->format('%a')+1;
                                                $todayDaysDif= $start_date->diff($toDay)->format('%a');
                                                $lbdpSbBackLog = (($val['PROGRAM_QNTY']/$tnaDaysDif)*$todayDaysDif) - $val['FACT_GREY_QTY'];
                                            }

                                            if($lbdpSbBackLog<0){
                                                $lbdpSbBackLog=0;
                                            }
                                            if ($val['START_DATE']=="" && $val['START_DATE']=="") 
                                            {
                                                $lbdpSbBackLog=0;
                                            }

                                            $bgcolor=($s%2==0)?"#E9F3FF":"#FFFFFF";
                                            ?>
                                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trp_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trp_<? echo $i; ?>">
                                                <?
                                                if($f==0)
                                                {
                                                    ?>
                                                     <td width="65" rowspan="<? echo $type_span_arr[$type_name]+1;?>"><? echo $type_name;?></td>
                                                    <?
                                                }
                                                if($s==0)
                                                {
                                                    $knit_source_arr = explode("*", $knitSourceParty);
                                                    if($knit_source_arr[0]==1){
                                                        $source_name = $lib_company[$knit_source_arr[1]];
                                                    }else{
                                                        $source_name = $lib_supplier[$knit_source_arr[1]];
                                                    }
                                                    ?>
                                                    <td width="65" rowspan="<? echo $type_source_span_arr[$type_name][$knitSourceParty];?>" align="center"><? echo $source_name;?></td>
                                                    <?

                                                }
                                             ?>
                                                
                                                <td width="65" align="center"><p class="word_break_wrap"><? echo $constructtion_arr[$DETER_ID];//.", ".$composition_arr[$DETER_ID];?></p></td>
                                                <td width="65" align="center"><? echo $MACHINE_DIA; ?></td>
                                                <td width="65" align="center"><? echo $DIA; ?></td>
                                                <td width="65" align="center"><? echo $lib_color[$COLOR_ID]; ?></td>
                                                <td width="65" align="center"><? echo $progId; ?></td>
                                                <td width="65" align="right"><? echo fn_number_format($val['PROGRAM_QNTY'],0) ?></td>
                                                <td width="65" align="center"><? echo change_date_format($val['PROGRAM_DATE']); ?></td>
                                                <td width="65" align="right"><? echo fn_number_format($val['FACT_GREY_QTY'],0) ?></td>
                                                <td width="65" align="right"><? echo fn_number_format($val['LAST_GREY_QTY'],0) ?></td>
                                                <td width="65" align="center"><? echo change_date_format($val['LAST_GREY_DATE']) ?></td>
                                                <td width="65" align="right"><? echo fn_number_format($val['trans_in'],0) ?></td>
                                                <td width="65" align="right"><? echo fn_number_format($val['trans_out'],0) ?></td>
                                                <td width="65" align="center"><? echo change_date_format($val['START_DATE']) ?></td>
                                                <td width="65" align="center"><? echo change_date_format($val['END_DATE']) ?></td>
                                                <td width="65" align="right"><? echo fn_number_format($lbdpSbBackLog,0) ?></td>
                                                <td width="65" align="right"><? echo fn_number_format($receive_balance,0); ?></td>
                                            </tr>
                                            <?
                                           $f++;$s++;$i++;
                                           $sub_program_qnty += $val['PROGRAM_QNTY'];
                                           $sub_fact_grey_qty += $val['FACT_GREY_QTY'];
                                           $sub_last_grey_qty += $val['LAST_GREY_QTY'];
                                           $sub_trans_in_qty += $val['trans_in'];
                                           $sub_trans_out_qty += $val['trans_out'];
                                           $sub_lbdpSbBackLog += $lbdpSbBackLog;
                                           $sub_receive_balance += $receive_balance;

                                           $grand_program_qnty += $val['PROGRAM_QNTY'];
                                           $grand_fact_grey_qty += $val['FACT_GREY_QTY'];
                                           $grand_last_grey_qty += $val['LAST_GREY_QTY'];
                                           $grand_trans_in_qty += $val['trans_in'];
                                           $grand_trans_out_qty += $val['trans_out'];
                                           $grand_lbdpSbBackLog += $lbdpSbBackLog;
                                           $grand_receive_balance += $receive_balance;
                                        }
                                    }
                                }
                                ?>
                                <tr bgcolor="#ccc">
                                    <td align="right" colspan="6"><strong> Total</strong></td>
                                    <td align="right" ><strong><? echo fn_number_format($sub_program_qnty,0); ?></strong></td>
                                    <td align="right" ><strong> </strong></td>
                                    <td align="right" ><strong><? echo fn_number_format($sub_fact_grey_qty,0); ?> </strong></td>
                                    <td align="right" ><strong><? echo fn_number_format($sub_last_grey_qty,0); ?></strong></td>
                                    
                                    <td align="right" ><strong> </strong></td>
                                    <td align="right" ><strong> <? echo fn_number_format($sub_trans_in_qty,0); ?></strong></td>
                                    <td align="right" ><strong> <? echo fn_number_format($sub_trans_out_qty,0); ?></strong></td>
                                    <td align="right" ><strong> </strong></td>
                                    <td align="right" ><strong> </strong></td>
                                    <td align="right" ><strong><? echo fn_number_format($sub_lbdpSbBackLog,0); ?></strong></td>
                                    <td align="right" ><strong><? echo fn_number_format($sub_receive_balance,0); ?></strong></td>
                                </tr>
                                <? 
                                $sub_program_qnty=$sub_fact_grey_qty=$sub_last_grey_qty=$sub_lbdpSbBackLog=$sub_receive_balance=0;
                            }
                            ?>
                        </tbody>
                    </table>
               
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1225">
                    <tfoot>
                        <tr bgcolor="#ccc">
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong></strong></td>
                            <td width="65" align="right"><strong> Grand Total</strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_program_qnty,0); ?></strong></td>
                            <td width="65" align="right" ><strong> </strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_fact_grey_qty,0); ?> </strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_last_grey_qty,0); ?></strong></td>
                            
                            <td width="65" align="right" ><strong> </strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_trans_in_qty,0); ?> </strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_trans_out_qty,0); ?> </strong></td>
                            <td width="65" align="right" ><strong> </strong></td>
                            <td width="65" align="right" ><strong> </strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_lbdpSbBackLog,0); ?></strong></td>
                            <td width="65" align="right" ><strong><? echo fn_number_format($grand_receive_balance,0); ?></strong></td>
                        </tr>
                        <? 
                        $grand_program_qnty=$grand_fact_grey_qty=$grand_last_grey_qty=$grand_lbdpSbBackLog=$grand_receive_balance=0;
                    }
                    ?>
                </tfoot>
            </table>
             </div>
            <br>
            <!-- ======================================= Yarn Sending Status ============================================= -->
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="905">
                <tbody>
                    <tr>
                        <td colspan="12" width="900" align="center"><h3>Yarn Sending Status</h3></td>
                    </tr>
                </tbody>
            </table>
            <?
            if(!empty($program_nos))
            {
                $lib_yarn_count = return_library_array("select id , yarn_count from lib_yarn_count","id","yarn_count");
                $lib_brand = return_library_array("select id , brand_name from lib_brand","id","brand_name");
                $all_program_id_cond="";
                $progCond="";
                if($db_type==2 && count($program_nos)>999)
                {
                    $all_program_arr_chunk=array_chunk($program_nos,999) ;
                    foreach($all_program_arr_chunk as $chunk_arr)
                    {
                        $chunk_arr_value=implode(",",$chunk_arr);
                        $progCond.=" a.knit_id in($chunk_arr_value) or ";
                    }

                    $all_program_id_cond.=" and (".chop($progCond,'or ').")";
                }
                else
                {
                    $all_program_id_cond=" and a.knit_id in(".implode(',', $program_nos).")";
                }

                /*$requ_sql = sql_select("select b.supplier_id as SUPPLIER_ID, B.yarn_count_id as YARN_COUNT_ID, b.brand as BRAND, b.lot as LOT, sum(a.yarn_qnty) as YARN_QNTY, yarn_comp_type1st as YARN_COMP_TYPE1ST, yarn_comp_percent1st as YARN_COMP_PERCENT1ST, yarn_comp_type2nd as YARN_COMP_TYPE2ND, yarn_comp_percent2nd as YARN_COMP_PERCENT2ND, b.color as COLOR, a.prod_id as PROD_ID, a.requisition_no as REQUISITION_NO from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id= b.id and a.status_active=1 and a.is_deleted=0 $all_program_id_cond group by b.supplier_id, B.yarn_count_id, b.brand, b.lot, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd , b.color , a.prod_id , a.requisition_no");*/
                $requ_sql = sql_select("SELECT c.knitting_source as KNITTING_SOURCE, c.knitting_party as KNITTING_PARTY, b.yarn_count_id as YARN_COUNT_ID, b.brand as BRAND, b.lot as LOT, sum(a.yarn_qnty) as YARN_QNTY, yarn_comp_type1st as YARN_COMP_TYPE1ST, yarn_comp_percent1st as YARN_COMP_PERCENT1ST, yarn_comp_type2nd as YARN_COMP_TYPE2ND, yarn_comp_percent2nd as YARN_COMP_PERCENT2ND, b.color as COLOR, a.prod_id as PROD_ID, a.requisition_no as REQUISITION_NO from ppl_yarn_requisition_entry a, product_details_master b, ppl_planning_info_entry_dtls c where a.prod_id= b.id and a.knit_id =c.id and a.status_active=1 and a.is_deleted=0 and c.status_active=1 and c.is_deleted=0 $all_program_id_cond group by c.knitting_source, c.knitting_party,B.yarn_count_id, b.brand, b.lot, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, b.color, a.prod_id, a.requisition_no");


                foreach ($requ_sql as $val) 
                {
                    $compos = '';
                    if ($val['YARN_COMP_PERCENT2ND'] != 0) {
                        $compos = $composition[$val['YARN_COMP_TYPE1ST']] . " " . $val['YARN_COMP_PERCENT1ST'] . "%" . " " . $composition[$val['YARN_COMP_TYPE2ND']] . " " . $val['YARN_COMP_PERCENT2ND'] . "%";
                    } else {
                        $compos = $composition[$val['YARN_COMP_TYPE1ST']] . " " . $val['YARN_COMP_PERCENT1ST'] . "%" . " " . $composition[$val['YARN_COMP_TYPE2ND']];
                    }

                    $prod_arr[$val['PROD_ID']] =$val['PROD_ID'];
                    $requ_arr[$val['REQUISITION_NO']] =$val['REQUISITION_NO'];

                    if($val['KNITTING_SOURCE'] == 1){
                        $KNITTING_PARTY = $lib_company[$val['KNITTING_PARTY']];
                    }else{
                        $KNITTING_PARTY = $lib_supplier[$val['KNITTING_PARTY']];
                    }

                    $requ_data_arr[$KNITTING_PARTY][$lib_color[$val['COLOR']]][$val['PROD_ID']]['COLOR'] = $val['COLOR'];
                    $requ_data_arr[$KNITTING_PARTY][$lib_color[$val['COLOR']]][$val['PROD_ID']]['DESC'] = $compos;
                    $requ_data_arr[$KNITTING_PARTY][$lib_color[$val['COLOR']]][$val['PROD_ID']]['YARN_COUNT_ID'] = $val['YARN_COUNT_ID'];
                    $requ_data_arr[$KNITTING_PARTY][$lib_color[$val['COLOR']]][$val['PROD_ID']]['BRAND'] = $val['BRAND'];
                    $requ_data_arr[$KNITTING_PARTY][$lib_color[$val['COLOR']]][$val['PROD_ID']]['LOT'] = $val['LOT'];
                    $requ_data_arr[$KNITTING_PARTY][$lib_color[$val['COLOR']]][$val['PROD_ID']]['YARN_QNTY'] += $val['YARN_QNTY'];
                    $requ_data_arr[$KNITTING_PARTY][$lib_color[$val['COLOR']]][$val['PROD_ID']]['PARTY'] = $val['KNITTING_PARTY'];
                }

                if(!empty($prod_arr))
                {
                    $all_prod_id_cond="";
                    $prodCond="";
                    if($db_type==2 && count($prod_arr)>999)
                    {
                        $all_prod_arr_chunk=array_chunk($prod_arr,999) ;
                        foreach($all_prod_arr_chunk as $chunk_arr)
                        {
                            $chunk_arr_value=implode(",",$chunk_arr);
                            $prodCond.="  b.prod_id in($chunk_arr_value) or ";
                        }

                        $all_prod_id_cond.=" and (".chop($prodCond,'or ').")";
                    }
                    else
                    {
                        $all_prod_id_cond=" and b.prod_id in(".implode(',', $prod_arr).")";
                    }
                    //print_r( $requ_arr);die;
                    
                    $issue_sql = sql_select("SELECT a.knit_dye_company as KNIT_DYE_COMPANY, a.knit_dye_source as KNIT_DYE_SOURCE, b.receive_basis as RECEIVE_BASIS, b.requisition_no as REQUISITION_NO, b.prod_id as PROD_ID, c.quantity as QUANTITY, a.issue_date as ISSUE_DATE from inv_issue_master a, inv_transaction b, order_wise_pro_details c, product_details_master d where a.id = b.mst_id and b.id=c.trans_id and b.prod_id = d.id and a.entry_form =3 and b.transaction_type=2 and b.item_category=1 $all_prod_id_cond  and c.po_breakdown_id in($poIds) order by b.id asc");
                    
                    foreach ($issue_sql as $val) 
                    {
                        if($val['RECEIVE_BASIS'] ==3 && $requ_arr[$val['REQUISITION_NO']] !="")
                        {
                            if($val['KNIT_DYE_SOURCE'] == 1){
                                $KNITTING_PARTY = $lib_company[$val['KNIT_DYE_COMPANY']];
                            }else{
                                $KNITTING_PARTY = $lib_supplier[$val['KNIT_DYE_COMPANY']];
                            }

                            if($last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['ISSUE_DATE'] =="")
                            {
                                $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['QUANTITY'] = $val['QUANTITY'];
                                $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['ISSUE_DATE'] = $val['ISSUE_DATE'];
                            }
                            else
                            {
                                if(strtotime($last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['ISSUE_DATE']) == strtotime($val['ISSUE_DATE']))
                                {
                                    $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['QUANTITY'] += $val['QUANTITY'];
                                    $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['ISSUE_DATE'] = $val['ISSUE_DATE'];
                                }
                                else if(strtotime($last_yarn_issue_info[$val['PROD_ID']]['ISSUE_DATE']) < strtotime($val['ISSUE_DATE']))
                                {
                                    $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['QUANTITY'] = $val['QUANTITY'];
                                    $last_yarn_issue_info[$KNITTING_PARTY][$val['PROD_ID']]['ISSUE_DATE'] = $val['ISSUE_DATE'];
                                }
                            }

                            $issue_requ_qty[$KNITTING_PARTY][$val['PROD_ID']] += $val['QUANTITY'];
                        }
                        $yarn_issue_qty[$val['PROD_ID']] += $val['QUANTITY'];
                    }
                    //print_r( $issue_requ_qty);die;
                    //die;
                    $rcv_sql = sql_select("SELECT a.SUPPLIER_ID,b.prod_id as PROD_ID,b.transaction_type as TTYPE,a.KNITTING_COMPANY,a.KNITTING_SOURCE, sum(b.cons_quantity) as QUANTITY,sum(b.cons_reject_qnty) as REJ_QUANTITY from inv_receive_master a, inv_transaction b,order_wise_pro_details c where a.id = b.mst_id and b.id=c.trans_id and c.po_breakdown_id in($poIds) and a.status_active =1 and a.is_deleted=0 and a.entry_form in(1,9) and b.transaction_type in(1,4) and b.item_category=1 and a.status_active =1 and b.status_active =1 $all_prod_id_cond group by a.supplier_id,b.prod_id,b.transaction_type,a.knitting_company,a.knitting_source");
                    

                    foreach ($rcv_sql as $val) 
                    {
                        if($val['KNITTING_SOURCE'] == 1)
                        {
                                $KNITTING_PARTY = $lib_company[$val['KNITTING_COMPANY']];
                        }
                        else
                        {
                            $KNITTING_PARTY = $lib_supplier[$val['KNITTING_COMPANY']];
                        }

                        $yarn_rcv_qty[$KNITTING_PARTY][$val['PROD_ID']][$val['TTYPE']] += $val['QUANTITY']+$val['REJ_QUANTITY'];
                    }

                }

            }
            // echo "<pre>";print_r($yarn_rcv_qty);
            $r_span_arr = array();
            foreach ($requ_data_arr as $supplier_name=>$supplier_data) 
            {
                foreach ($supplier_data as $color_name => $color_data) 
                {
                    foreach ($color_data as $product_id => $row) 
                    {
                        $r_span_arr[$supplier_name]++;
                    }
                }
            }
            ?>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1100">
                <thead>
                    <tr>
                        <th width="75">Knitting Factory</th>
                        <th width="75">Solid/dyed</th>
                        <th width="275">Yarn Composition</th>
                        <th width="75">Count</th>
                        <th width="75">Brand</th>
                        <th width="75">Lot</th>
                        <th width="75">Req Qty</th>

                        <th width="75">Issue Qty</th>
                        <th width="75">Last issue Date</th>
                        <th width="75">Last Issue Qty</th>
                        <th width="75">Issue Bal</th>
                        <!-- <th width="75">Stock At Yarn Store</th> -->
                    </tr>
                </thead>
            </table>
            <div id="scroll_body" style="width:1120px; max-height:240px;overflow-y:scroll;">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1100">
                    <tbody>
                        <?
                            if(!empty($requ_data_arr))
                            {
                                $i=0;
                                $gr_tot_yarn_requ=$gr_tot_yarn_issue=$gr_last_yarn_issue=$gr_yarn_issue_balance=$gr_tot_yarn_stock=0;
                                foreach ($requ_data_arr as $supplier_name=>$supplier_data) 
                                {
                                    $z=0;
                                    ksort($supplier_data);
                                    foreach ($supplier_data as $color_name => $color_data) 
                                    {
                                        foreach ($color_data as $product_id => $row) 
                                        {
                                            $stock = $yarn_rcv_qty[$supplier_name][$product_id][1] - $yarn_issue_qty[$product_id];
                                            $issue_balance = $row['YARN_QNTY'] - ($issue_requ_qty[$supplier_name][$product_id] - $yarn_rcv_qty[$supplier_name][$product_id][4]);
                                            // $issue_balance = $issue_requ_qty[$supplier_name][$product_id] - $yarn_rcv_qty[$supplier_name][$product_id][4];

                                            // echo "string".$supplier_name."==".$product_id."<br>";
                                            // echo $row['YARN_QNTY'] ."-". $issue_requ_qty[$supplier_name][$product_id]."-".$yarn_rcv_qty[$supplier_name][$product_id][4]."<br>";

                                            $bgcolor=($z%2==0)?"#E9F3FF":"#FFFFFF";
                                            ?>
                                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('try_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="try_<? echo $i; ?>">
                                                <?
                                                if($z==0)
                                                {
                                                    ?>
                                                    <td width="75" rowspan="<?=$r_span_arr[$supplier_name];?>"><? echo $supplier_name;?></a></td>
                                                    <?
                                                }
                                                ?>
                                                <td width="75" align="left" title="<?=$lib_color[$row['COLOR']];?>"><? echo substr($lib_color[$row['COLOR']],0,10);?></td>
                                                <td width="275" align="left"><p class="word_break_wrap"><? echo $row['DESC'];?></p></td>
                                                <td width="75" align="left"><? echo $lib_yarn_count[$row['YARN_COUNT_ID']];?></td>
                                                <td width="75" align="left"><? echo $lib_brand[$row['BRAND']];?></td>
                                                <td width="75" align="left"><? echo $row['LOT'];?></td>
                                                <td width="75" align="right"><? echo $row['YARN_QNTY'];?></td>
                                                <td width="75" align="right" title="<?=$product_id."=".$row['YARN_QNTY']."-".$issue_requ_qty[$supplier_name][$product_id] ."-". $yarn_rcv_qty[$supplier_name][$product_id][4];?>"><? echo fn_number_format(($issue_requ_qty[$supplier_name][$product_id] - $yarn_rcv_qty[$supplier_name][$product_id][4]),0);?></td>
                                                <td width="75" align="right"><? echo change_date_format($last_yarn_issue_info[$supplier_name][$product_id]['ISSUE_DATE']);?></td>
                                                <td width="75" align="right"><? echo fn_number_format($last_yarn_issue_info[$supplier_name][$product_id]['QUANTITY'],0);?></td>
                                                <td width="75" align="right"><? echo fn_number_format($issue_balance,0);?></td>
                                                <!-- <td width="75" align="right"><? //echo fn_number_format($stock,0);?></td> -->
                                            </tr>
                                            <?
                                            $z++;$i++;
                                            $tot_yarn_requ += $row['YARN_QNTY'];
                                            $tot_yarn_issue += $issue_requ_qty[$supplier_name][$product_id] - $yarn_rcv_qty[$supplier_name][$product_id][4];
                                            $last_yarn_issue += $last_yarn_issue_info[$supplier_name][$product_id]['QUANTITY'];
                                            $yarn_issue_balance += $issue_balance;
                                            $tot_yarn_stock += $stock;


                                            $gr_tot_yarn_requ += $row['YARN_QNTY'];
                                            $gr_tot_yarn_issue += $issue_requ_qty[$supplier_name][$product_id] - $yarn_rcv_qty[$supplier_name][$product_id][4];
                                            $gr_last_yarn_issue += $last_yarn_issue_info[$supplier_name][$product_id]['QUANTITY'];
                                            $gr_yarn_issue_balance += $issue_balance;
                                            $gr_tot_yarn_stock += $stock;
                                        }
                                    }
                                    ?>
                                    <tr bgcolor="#ccc">
                                        <td align="right" colspan="6"><strong>Total:</strong></td>
                                        <td align="right"><strong><? echo fn_number_format($tot_yarn_requ,0); ?></strong></td>
                                        <td align="right"><strong><? echo fn_number_format($tot_yarn_issue,0); ?></strong></td>
                                        <td align="right"><strong><? //echo fn_number_format($skdslj,0); ?></strong></td>
                                        <td align="right"><strong><? echo fn_number_format($last_yarn_issue,0); ?></strong></td>
                                        <td align="right"><strong><? echo fn_number_format($yarn_issue_balance,0); ?></strong></td>
                                        <!-- <td align="right"><strong><? echo fn_number_format($tot_yarn_stock,0); ?></strong></td> -->
                                    </tr>
                                    <?
                                    $tot_yarn_requ=$tot_yarn_issue=$last_yarn_issue=$yarn_issue_balance=$tot_yarn_stock=0;
                                }
                            }
                        ?>
                    </tbody>
                    <tfoot>                        
                        <tr>
                            <th align="right" colspan="6"><strong>Grand Total:</strong></th>
                            <th align="right"><strong><? echo fn_number_format($gr_tot_yarn_requ,0); ?></strong></th>
                            <th align="right"><strong><? echo fn_number_format($gr_tot_yarn_issue,0); ?></strong></th>
                            <th align="right"><strong><? //echo fn_number_format($skdslj,0); ?></strong></th>
                            <th align="right"><strong><? echo fn_number_format($gr_last_yarn_issue,0); ?></strong></th>
                            <th align="right"><strong><? echo fn_number_format($gr_yarn_issue_balance,0); ?></strong></th>
                            <!-- <td align="right"><strong><? echo fn_number_format($tot_yarn_stock,0); ?></strong></td> -->
                        </tr>
                    </tfoot>
                </table> 
            </div> 
        </div>        
    </div>
    <?
}

if ($action == "yarn_allocatio_popup_bk") // 19/05/2022
{   
    /**
    MD Didar 
    Date : 5/5/2020
    **/

    echo load_html_head_contents("Allocation Info", "../../../../", 1, 1,'','','');
    list($job_no, $po_ids) = explode("**",$po_break_down_id);

    $count_array = return_library_array("select id,yarn_count from  lib_yarn_count where is_deleted=0 and status_active=1", "id", "yarn_count");

    $sqlOrder = "SELECT a.style_ref_no as style,b.grouping as int_ref FROM wo_po_details_master a, wo_po_break_down b WHERE a.id=b.job_id and a.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in($po_ids) group by a.style_ref_no,b.grouping";
    //echo $sqlOrder;die();

    $sqlOrderRes = sql_select($sqlOrder);

    $pre_cost_alloc_sql = "SELECT a.fabric_cost_dtls_id,a.count_id,a.copm_one_id,a.copm_two_id, 0 allocation_qnty, sum(a.cons_qnty) as cons_qnty, b.job_plan_cut_qty as plan_cut_qty,b.uom FROM wo_pre_cost_fab_yarn_cost_dtls a,wo_pre_cost_fabric_cost_dtls b ,wo_po_details_master c, wo_po_break_down d WHERE a.fabric_cost_dtls_id=b.id and c.id=d.job_id and c.job_no='$job_no' and d.id in($po_ids) and a.job_no='$job_no' and a.count_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 GROUP BY a.fabric_cost_dtls_id,a.count_id,a.copm_one_id,a.copm_two_id,b.uom,b.job_plan_cut_qty order by a.fabric_cost_dtls_id,a.count_id,a.copm_one_id,a.copm_two_id";
    //echo $pre_cost_alloc_sql;
    $resultArray = sql_select($pre_cost_alloc_sql);

    $dataArray = array();
    foreach ($resultArray as $row) 
    {
        $dataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['uom'] = $row[csf('uom')]; 
        $dataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['fabric_cost_dtls_id'] = $row[csf('fabric_cost_dtls_id')]; 
        $dataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['cons_qnty'] += $row[csf('cons_qnty')];
        $dataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['plan_cut_qty'] = $row[csf('plan_cut_qty')];
    }

    $sql_allocation = "SELECT a.yarn_count_id as count_id,a.yarn_comp_type1st as copm_one_id,a.yarn_comp_type2nd as copm_two_id, sum(b.qnty) as allocation_qnty,min(b.allocation_date) as first_allocation_date ,max(b.allocation_date) as last_allocation_date FROM product_details_master a, inv_material_allocation_dtls b,wo_booking_mst c WHERE a.id = b.item_id and b.booking_no=c.booking_no and booking_type=1 and b.job_no='$job_no' and b.po_break_down_id in($po_ids) and b.is_dyied_yarn!=1 and a.dyed_type!=1 and a.item_category_id=1 and b.item_category=1 and a.yarn_count_id >0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 GROUP BY a.yarn_count_id ,a.yarn_comp_type1st,a.yarn_comp_type2nd";
    //echo $sql_allocation;
    $resultAllocation = sql_select($sql_allocation);
    $aldataArray = array();
    foreach ($resultAllocation as $row) 
    {
        $aldataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['first_allocation_date'] = $row[csf('first_allocation_date')];
        $aldataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['last_allocation_date'] = $row[csf('last_allocation_date')];
        $aldataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['allocation_qnty'] += $row[csf('allocation_qnty')]; 
    }

   // echo "<pre>";
   // print_r( $aldataArray);

    $shoprt_booking_sql="SELECT MIN (a.id) AS id,a.count_id,a.copm_one_id,a.percent_one,a.copm_two_id,a.percent_two,
        a.type_id,SUM (a.cons_qnty) AS yarn_required,AVG (a.rate) AS rate,
        listagg (CAST (a.fabric_cost_dtls_id AS VARCHAR2 (4000)), ',') WITHIN GROUP (ORDER BY   a.fabric_cost_dtls_id)
            AS cost_dtls,
        AVG (a.cons_ratio) AS cons_ratio,
        sum (b.grey_fab_qnty*a.cons_ratio/100) AS grey_qty
        FROM wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b
        WHERE a.job_no = '$job_no' and b.po_break_down_id in($po_ids) 
        and b.is_short!=2 and a.status_active = 1 and a.is_deleted = 0
        and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id 
        and a.job_no=b.job_no and b.status_active=1 and b.is_deleted=0   
        GROUP BY a.count_id,a.copm_one_id,a.percent_one,a.copm_two_id,a.percent_two,a.type_id";
        //echo $shoprt_booking_sql;
    $shortResultArr = sql_select($shoprt_booking_sql);

    $shortBookingData = array();
    foreach ($shortResultArr as $row) 
    {
        
        $shortBookingData[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['grey_qty'] += $row[csf('grey_qty')];
        $shortBookingData[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['cons_ratio'] = $row[csf('cons_ratio')];
    }
    
   //echo "<pre>";
   //print_r($shortBookingData);
    
    ?>

    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>

    <div class="main" style="width: 100%;" id="details_reports">
        <div class="header_part">
            <table class="rpt_table" cellpadding="0" cellspacing="0"  rules="all" width="850">
                <caption><b>Yarn Allocation Status</b></caption>
                <thead>
                    <tr>
                        <td colspan="10" width="100%"><b>Style Name: <? echo $sqlOrderRes[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref: <? echo $sqlOrderRes[0]['INT_REF'];?></b></td>
                    </tr>
                </thead>
            </table>
        </div>

        <!-- ===================================== 1st part start ==================================-->
        <div class="first_part">
            <table cellspacing="0" width="850" class="rpt_table" border="0" rules="all" id="myTable">
                <thead>
                    <th width="260">Composition</th>
                    <th width="60">Count</th>
                    <th width="60">Initial Yarn</th>
                    <th width="60">Excess Yarn</th>
                    <th width="60">Total Yarn</th>
                    <th width="60">1st Allo Date</th>
                    <th width="60">Last Allo Date </th>
                    <th width="60">Allo Qty</th>
                    <th width="60">Backlog Qty</th>
                    <th width="60">Bal Qty</th>
                </thead>
                <?
                $i = 1;
                $total_required_qnty = 0;
                $total_allocation_qnty = 0;
                $precost_required_qnty = 0;

                foreach ($dataArray as $count_id=>$componeArr) 
                {
                    foreach ($componeArr as $copm_one_id=>$comptwoArr) 
                    {
                        foreach ($comptwoArr as $copm_two_id=>$row) 
                        {
                            
                                if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";

                                $precost_required_qnty  = ($row["plan_cut_qty"]/$row["uom"])*$row["cons_qnty"];
                               
                                $greayQnty = $shortBookingData[$count_id][$copm_one_id][$copm_two_id]['grey_qty'];
                                $consRatioStr = $shortBookingData[$count_id][$copm_one_id][$copm_two_id]['cons_ratio'];

                                $consRatioArr = explode(",", $consRatioStr);
                                $consRatio = max($consRatioArr);

                                $excess_yearn_kg = $greayQnty; 
                                $total_yarn = ($precost_required_qnty+$excess_yearn_kg);

                                $total_yarn = ($total_yarn>0)?$total_yarn:0;

                                $first_al_date = $aldataArray[$count_id][$copm_one_id][$copm_two_id]['first_allocation_date'];
                                $last_al_date = $aldataArray[$count_id][$copm_one_id][$copm_two_id]['last_allocation_date'];
                                $allocation_qnty = $aldataArray[$count_id][$copm_one_id][$copm_two_id]['allocation_qnty'];
                                $allocation_check[$count_id][$copm_one_id][$copm_two_id] = $allocation_qnty;
                                
                                ?>
                                <tr bgcolor="<? echo $bgcolor; ?>">
                                    <td title="<? echo $copm_one_id;?>">
                                        <?
                                        if ($copm_one_id != 0 || $copm_one_id != "") {
                                            echo $composition[$copm_one_id];
                                        }

                                        if ($copm_two_id != 0) {
                                            echo $composition[$copm_two_id] . "";
                                        }
                                        ?>
                                    </td>

                                    <td align="center" title="<? echo $count_id;?>"><? echo $count_array[$count_id];?></td>
                                    <td align="right">
                                        <? 
                                        $required_qnty = ($precost_required_qnty>0)?$precost_required_qnty:0;
                                        echo fn_number_format($required_qnty,0,'.','');?>  
                                    </td>
                                    <td align="right" title="<? echo $greayQnty; ?>"><? echo fn_number_format($excess_yearn_kg,0);?></td>
                                    <td align="right"><? echo fn_number_format($total_yarn,0);?></td>
                                    <td align="center"><? echo change_date_format($first_al_date); ?></td>
                                    <td align="center"><? echo change_date_format($last_al_date); ?></td>
                                    <td align="right"><? echo fn_number_format($allocation_qnty, 0); ?></td>
                                    <td>&nbsp;</td>
                                    <td align="right">
                                        <?
                                        $bal_qnty = ($total_yarn-$allocation_qnty);
                                        //$bal_qnty = ($bal_qnty>0)?$bal_qnty:0;
                                        echo fn_number_format($bal_qnty,0);
                                        ?>
                                    </td>
                                </tr>
                                <?
                                $i++;
                                $total_required_qnty += $required_qnty;
                                $total_allocation_qnty += $allocation_qnty;
                                $total_excess += $excess_yearn_kg;
                                $grand_total_yarn += $total_yarn;
                                $total_bal_qty += $bal_qnty;
                        }
                    }
                }
                ?>
                <tfoot>
                    <tr>
                        <th></th>
                        <th>Grand Total</th>
                        <th><? echo fn_number_format($total_required_qnty,0)?></th>
                        <th><? echo fn_number_format($total_excess,0)?></th>
                        <th><? echo fn_number_format($grand_total_yarn,0)?></th>
                        <th>&nbsp;</th>
                        <th>&nbsp;</th>
                        <th><? echo fn_number_format($total_allocation_qnty,0)?></th>
                        <th>&nbsp;</th>
                        <th><? echo fn_number_format($total_bal_qty,0)?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <script type="text/javascript">
        function sortTable() {
          var table, rows, switching, i, x, y, shouldSwitch;
          table = document.getElementById("myTable");
          switching = true;
          /*Make a loop that will continue until
          no switching has been done:*/
          while (switching) {
            //start by saying: no switching is done:
            switching = false;
            rows = table.rows;
            /*Loop through all table rows (except the
            first, which contains table headers):*/
            for (i = 1; i < (rows.length - 1); i++) {
              //start by saying there should be no switching:
              shouldSwitch = false;
              /*Get the two elements you want to compare,
              one from current row and one from the next:*/
              x = rows[i].getElementsByTagName("TD")[0];
              y = rows[i + 1].getElementsByTagName("TD")[0];
              //check if the two rows should switch place:
              if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                //if so, mark as a switch and break the loop:
                shouldSwitch = true;
                break;
              }
            }
            if (shouldSwitch) {
              /*If a switch has been marked, make the switch
              and mark that a switch has been done:*/
              rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
              switching = true;
            }
          }
        }
        sortTable();
    </script>
    <?
    exit();
}

if ($action == "yarn_allocatio_popup") 
{
    echo load_html_head_contents("Allocation Info", "../../../../", 1, 1,'','','');
    list($job_no, $po_ids) = explode("**",$po_break_down_id);

	$current_date = date("j-M-Y");

    $count_array = return_library_array("select id,yarn_count from  lib_yarn_count where is_deleted=0 and status_active=1", "id", "yarn_count");

    $sqlOrder = "SELECT a.style_ref_no as style,b.grouping as int_ref FROM wo_po_details_master a, wo_po_break_down b WHERE a.id=b.job_id and a.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,2) and b.is_deleted=0 and b.id in($po_ids) group by a.style_ref_no,b.grouping";
    //echo $sqlOrder;die();

    $sqlOrderRes = sql_select($sqlOrder);

    $pre_cost_alloc_sql = "SELECT a.fabric_cost_dtls_id,a.count_id,a.copm_one_id,a.copm_two_id, 0 allocation_qnty, sum(a.cons_qnty) as cons_qnty, b.job_plan_cut_qty as plan_cut_qty,b.uom FROM wo_pre_cost_fab_yarn_cost_dtls a,wo_pre_cost_fabric_cost_dtls b ,wo_po_details_master c, wo_po_break_down d WHERE a.fabric_cost_dtls_id=b.id and c.id=d.job_id and c.job_no='$job_no' and d.id in($po_ids) and a.job_no='$job_no' and a.count_id>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 GROUP BY a.fabric_cost_dtls_id,a.count_id,a.copm_one_id,a.copm_two_id,b.uom,b.job_plan_cut_qty order by a.fabric_cost_dtls_id,a.count_id,a.copm_one_id,a.copm_two_id";
    //echo $pre_cost_alloc_sql;
    $resultArray = sql_select($pre_cost_alloc_sql);

    $dataArray = array();
    foreach ($resultArray as $row) 
    {
        $dataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['uom'] = $row[csf('uom')]; 
        $dataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['fabric_cost_dtls_id'] = $row[csf('fabric_cost_dtls_id')]; 
        $dataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['cons_qnty'] += $row[csf('cons_qnty')];
        $dataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['plan_cut_qty'] = $row[csf('plan_cut_qty')];
    }

    $sql_allocation = "SELECT a.yarn_count_id as count_id,a.yarn_comp_type1st as copm_one_id,a.yarn_comp_type2nd as copm_two_id, sum(b.qnty) as allocation_qnty,min(b.allocation_date) as first_allocation_date ,max(b.allocation_date) as last_allocation_date,sum(case when b.allocation_date < '$current_date' then b.qnty else 0 end) as prev_allocation_qnty FROM product_details_master a, inv_material_allocation_dtls b,wo_booking_mst c WHERE a.id = b.item_id and b.booking_no=c.booking_no and booking_type=1 and b.job_no='$job_no' and b.po_break_down_id in($po_ids) and b.is_dyied_yarn!=1 and a.dyed_type!=1 and a.item_category_id=1 and b.item_category=1 and a.yarn_count_id >0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 GROUP BY a.yarn_count_id ,a.yarn_comp_type1st,a.yarn_comp_type2nd";
    //echo $sql_allocation;
    $resultAllocation = sql_select($sql_allocation);
    $aldataArray = array();
    foreach ($resultAllocation as $row) 
    {
        $dataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['first_allocation_date'] = $row[csf('first_allocation_date')];
        $dataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['last_allocation_date'] = $row[csf('last_allocation_date')];
        $dataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['allocation_qnty'] += $row[csf('allocation_qnty')]; 
        $dataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['prev_allocation_qnty'] += $row[csf('prev_allocation_qnty')]; 
    }

    
	$sqltna = "SELECT a.COUNT_ID,a.COMPOSITION_ID,a.PLAN_QTY from tna_plan_target a,wo_po_break_down b where a.PO_ID=b.id and b.status_active=1 and b.is_deleted=0 and a.status_active=1 and a.is_deleted=0  and a.PLAN_QTY>0 and a.task_type=1 and a.TASK_ID=48 and a.PLAN_DATE is not null and a.plan_date < '$current_date' and b.id in($po_ids)";
    // echo $sqltna;
    $tnaRes = sql_select($sqltna);
    $tnaplanArray = array();
    foreach ($tnaRes as $row) 
    {
        $tnaplanArray[$row[csf('count_id')]][$row[csf('composition_id')]] += $row[csf('plan_qty')];
    }

    //echo "<pre>";
    //print_r( $aldataArray);

    $shoprt_booking_sql="SELECT MIN (a.id) AS id,a.count_id,a.copm_one_id,a.percent_one,a.copm_two_id,a.percent_two,
        a.type_id,SUM (a.cons_qnty) AS yarn_required,AVG (a.rate) AS rate,
        listagg (CAST (a.fabric_cost_dtls_id AS VARCHAR2 (4000)), ',') WITHIN GROUP (ORDER BY   a.fabric_cost_dtls_id)
            AS cost_dtls,
        AVG (a.cons_ratio) AS cons_ratio,
        sum (b.grey_fab_qnty*a.cons_ratio/100) AS grey_qty
        FROM wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b
        WHERE a.job_no = '$job_no' and b.po_break_down_id in($po_ids) 
        and b.is_short!=2 and a.status_active = 1 and a.is_deleted = 0
        and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id 
        and a.job_no=b.job_no and b.status_active=1 and b.is_deleted=0   
        GROUP BY a.count_id,a.copm_one_id,a.percent_one,a.copm_two_id,a.percent_two,a.type_id";
        //echo $shoprt_booking_sql;
    $shortResultArr = sql_select($shoprt_booking_sql);

    $shortBookingData = array();
    foreach ($shortResultArr as $row) 
    {
        
        $dataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['grey_qty'] += $row[csf('grey_qty')];
        $dataArray[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('copm_two_id')]]['cons_ratio'] = $row[csf('cons_ratio')];
    }
    
    //echo "<pre>";
    //print_r($shortBookingData);
    $condition= new condition();     
    $condition->po_id_in($po_ids);   
    $condition->init();
    $yarn= new yarn($condition);
    $yarns_req_qty_arr=$yarn->getOrderCountAndCompositionWiseYarnQtyArray();
    // echo "<pre>"; print_r($yarns_req_qty_arr);
    
    ?>

    <div id="data_panel" align="center" style="width:100%">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
        <input type="button" value="Print" id="print" class="formbutton" style="width:100px;margin: 5px;" onclick="new_window()" />
    </div>

    <div class="main" style="width: 100%;" id="details_reports">
        <div class="header_part">
            <table class="rpt_table" cellpadding="0" cellspacing="0"  rules="all" width="850">
                <caption><b>Yarn Allocation Status</b></caption>
                <thead>
                    <tr>
                        <td colspan="10" width="100%"><b>Style Name: <? echo $sqlOrderRes[0]['STYLE'];?></b>,&nbsp;&nbsp;<b>Internal Ref: <? echo $sqlOrderRes[0]['INT_REF'];?></b></td>
                    </tr>
                </thead>
            </table>
        </div>

        <!-- ===================================== 1st part start ==================================-->
        <div class="first_part">
            <table cellspacing="0" width="850" class="rpt_table" border="0" rules="all" id="myTable">
                <thead>
                    <th width="260">Composition</th>
                    <th width="60">Count</th>
                    <th width="60">Initial Yarn</th>
                    <th width="60">Excess Yarn</th>
                    <th width="60">Total Yarn</th>
                    <th width="60">1st Allo Date</th>
                    <th width="60">Last Allo Date </th>
                    <th width="60">Allo Qty</th>
                    <th width="60">Backlog Qty</th>
                    <th width="60">Bal Qty</th>
                </thead>
                <?
                $i = 1;
                $total_required_qnty = 0;
                $total_allocation_qnty = 0;
                $precost_required_qnty = 0;
                $tot_backLog = 0;

                foreach ($dataArray as $count_id=>$componeArr) 
                {
                    foreach ($componeArr as $copm_one_id=>$comptwoArr) 
                    {
                        foreach ($comptwoArr as $copm_two_id=>$row) 
                        {
                            
                                if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";

                                // $precost_required_qnty  = ($row["plan_cut_qty"]/$row["uom"])*$row["cons_qnty"];
                                $precost_required_qnty  = $yarns_req_qty_arr[$po_ids][$count_id][$copm_one_id];
                                $plan_qnty  = $tnaplanArray[$count_id][$copm_one_id];
                               
                                $greayQnty = $row['grey_qty'];
                                $consRatioStr = $row['cons_ratio'];

                                $consRatioArr = explode(",", $consRatioStr);
                                $consRatio = max($consRatioArr);

                                $excess_yearn_kg = $greayQnty; 
                                $total_yarn = ($precost_required_qnty+$excess_yearn_kg);

                                $total_yarn = ($total_yarn>0)?$total_yarn:0;

                                $first_al_date = $row['first_allocation_date'];
                                $last_al_date = $row['last_allocation_date'];
                                $allocation_qnty = $row['allocation_qnty'];
                                $backLog = $plan_qnty - $row['prev_allocation_qnty'];
                                $allocation_check[$count_id][$copm_one_id][$copm_two_id] = $allocation_qnty;
                                
                                ?>
                                <tr bgcolor="<? echo $bgcolor; ?>">
                                    <td title="<? echo $copm_one_id;?>">
                                        <?
                                        if ($copm_one_id != 0 || $copm_one_id != "") {
                                            echo $composition[$copm_one_id];
                                        }

                                        if ($copm_two_id != 0) {
                                            echo $composition[$copm_two_id] . "";
                                        }
                                        ?>
                                    </td>

                                    <td align="center" title="<? echo $count_id;?>"><? echo $count_array[$count_id];?></td>
                                    <td align="right">
                                        <? 
                                        $required_qnty = ($precost_required_qnty>0)?$precost_required_qnty:0;
                                        echo fn_number_format($required_qnty,0,'.','');?>  
                                    </td>
                                    <td align="right" title="<? echo $greayQnty; ?>"><? echo fn_number_format($excess_yearn_kg,0);?></td>
                                    <td align="right"><? echo fn_number_format($total_yarn,0);?></td>
                                    <td align="center"><? echo change_date_format($first_al_date); ?></td>
                                    <td align="center"><? echo change_date_format($last_al_date); ?></td>
                                    <td align="right"><? echo fn_number_format($allocation_qnty, 0); ?></td>
                                    <td align="right" title="plan qty=<?=fn_number_format($plan_qnty,0);?>"><?=fn_number_format($backLog,0);?></td>
                                    <td align="right">
                                        <?
                                        $bal_qnty = ($total_yarn-$allocation_qnty);
                                        //$bal_qnty = ($bal_qnty>0)?$bal_qnty:0;
                                        echo fn_number_format($bal_qnty,0);
                                        ?>
                                    </td>
                                </tr>
                                <?
                                $i++;
                                $total_required_qnty += $required_qnty;
                                $total_allocation_qnty += $allocation_qnty;
                                $total_excess += $excess_yearn_kg;
                                $grand_total_yarn += $total_yarn;
                                $total_bal_qty += $bal_qnty;
                                $tot_backLog += $backLog;
                        }
                    }
                }
                ?>
                <tfoot>
                    <tr>
                        <th></th>
                        <th>Grand Total</th>
                        <th><? echo fn_number_format($total_required_qnty,0)?></th>
                        <th><? echo fn_number_format($total_excess,0)?></th>
                        <th><? echo fn_number_format($grand_total_yarn,0)?></th>
                        <th>&nbsp;</th>
                        <th>&nbsp;</th>
                        <th><? echo fn_number_format($total_allocation_qnty,0)?></th>
                        <th><? echo fn_number_format($tot_backLog,0)?></th>
                        <th><? echo fn_number_format($total_bal_qty,0)?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <script type="text/javascript">
        function sortTable() {
          var table, rows, switching, i, x, y, shouldSwitch;
          table = document.getElementById("myTable");
          switching = true;
          /*Make a loop that will continue until
          no switching has been done:*/
          while (switching) {
            //start by saying: no switching is done:
            switching = false;
            rows = table.rows;
            /*Loop through all table rows (except the
            first, which contains table headers):*/
            for (i = 1; i < (rows.length - 1); i++) {
              //start by saying there should be no switching:
              shouldSwitch = false;
              /*Get the two elements you want to compare,
              one from current row and one from the next:*/
              x = rows[i].getElementsByTagName("TD")[0];
              y = rows[i + 1].getElementsByTagName("TD")[0];
              //check if the two rows should switch place:
              if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                //if so, mark as a switch and break the loop:
                shouldSwitch = true;
                break;
              }
            }
            if (shouldSwitch) {
              /*If a switch has been marked, make the switch
              and mark that a switch has been done:*/
              rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
              switching = true;
            }
          }
        }
        sortTable();
    </script>
    <?
    exit();
}

if($action=="buyer_summary_popup")
{
    echo load_html_head_contents("Buyer Summary Info", "../../../../", 1, 1,'','','');
    extract($_REQUEST); 
    list($company_id,$buyer_name,$season_name,$merchant,$int_ref_no,$style_ref,$location_name,$shipment_status,$order_status,$status,$item_id,$date_from,$date_to,$search_by,$client) = explode("**", $sqlcond);
    
    $season_library = return_library_array("select id, season_name from lib_buyer_season where status_active =1 and is_deleted=0", "id", "season_name");
    
    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    $sqlCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    $sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($client !=0) ? " and a.client_id=$client" : "";
    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active in($status)" : "";
    $sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }  
    // echo $sqlCond;
    
    /*======================================================================================/
    /                                    main query                                         /
    /======================================================================================*/
    // $sql = "SELECT a.season_buyer_wise as season,b.id as PO_ID,to_char(b.shipment_date,'MON-YYYY') as MONTH_YEAR,b.PO_TOTAL_PRICE,(b.po_quantity*a.total_set_qnty) as PO_QUANTITY from wo_po_details_master a,wo_po_break_down b where a.id=b.job_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.buyer_name=$buyer_id $sqlCond order by b.shipment_date";
    $sql = "SELECT a.id as job_id,a.job_no,a.season_buyer_wise as season,b.id as PO_ID,b.PO_TOTAL_PRICE,b.UNIT_PRICE,a.SET_SMV,(b.po_quantity*a.total_set_qnty) as PO_QNTY,sum(c.ORDER_QUANTITY) as PO_QUANTITY from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  and a.buyer_name=$buyer_id $sqlCond group by a.id,a.job_no,a.season_buyer_wise,b.id,b.PO_TOTAL_PRICE,b.UNIT_PRICE,a.SET_SMV,b.po_quantity,a.total_set_qnty order by b.po_quantity desc";
    // echo $sql;die();
    $sqlRes = sql_select($sql);
    if(count($sqlRes)==0)
    {
        echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
    }
    $poIdArray = array();
    $jobIdArray = array();
    $data_array = array();
    $po_wise_job_arr = array();
    $po_wise_season_arr = array();
    foreach ($sqlRes as $row) 
    {
        $data_array[$season_library[$row['SEASON']]]['po_quantity'] += $row['PO_QUANTITY'];          
        $data_array[$season_library[$row['SEASON']]]['total_price'] += $row['PO_TOTAL_PRICE'];      
        
        $data_array[$season_library[$row['SEASON']]]['season_id']= $row['SEASON'];      
                    
        $poIdArray[$row['PO_ID']] = $row['PO_ID'];
        $jobIdArray[$row['JOB_ID']] = $row['JOB_ID'];
        $po_wise_job_arr[$row['PO_ID']] = $row['JOB_NO'];
        $po_wise_season_arr[$row['PO_ID']] = $row['SEASON'];
    }
    $poIDS = implode(",", $poIdArray);
    $jobIDS = implode(",", $jobIdArray);
    // echo "<pre>";print_r($data_array);die();
    $po_id_list_arr=array_chunk($poIdArray,999);

    $poCon = " and ";$poCon2 = " and ";$poCon3 = " and ";$poCon4 = " and ";$poCon5 = " and ";$poCon6 = " and ";$poCon7 = " and ";$poCon8 = " and ";
    $p=1;
    foreach($po_id_list_arr as $po_process)
    {
        if($p==1) $poCon .="  ( a.po_break_down_id in(".implode(',',$po_process).")"; 
        else  $poCon .=" or a.po_break_down_id in(".implode(',',$po_process).")";
        
        if($p==1) $poCon2 .="  ( b.po_id in(".implode(',',$po_process).")"; 
        else  $poCon2 .=" or b.po_id in(".implode(',',$po_process).")";
        
        if($p==1) $poCon3 .="  ( a.po_break_down_id in(".implode(',',$po_process).")"; 
        else  $poCon3 .=" or a.po_break_down_id in(".implode(',',$po_process).")";
        
        if($p==1) $poCon4 .="  ( a.po_breakdown_id in(".implode(',',$po_process).")"; 
        else  $poCon4 .=" or a.po_breakdown_id in(".implode(',',$po_process).")";            
        
        if($p==1) $poCon5 .="  ( po_breakdown_id in(".implode(',',$po_process).")"; 
        else  $poCon5 .=" or po_breakdown_id in(".implode(',',$po_process).")";
        
        if($p==1) $poCon6 .="  ( b.order_id in(".implode(',',$po_process).")"; 
        else  $poCon6 .=" or b.order_id in(".implode(',',$po_process).")";

        if($p==1) $poCon7 .="  ( b.po_breakdown_id in(".implode(',',$po_process).")"; 
        else  $poCon7 .=" or b.po_breakdown_id in(".implode(',',$po_process).")";

        if($p==1) $poCon8 .="  ( b.po_break_down_id in(".implode(',',$po_process).")"; 
        else  $poCon8 .=" or b.po_break_down_id in(".implode(',',$po_process).")";            
        
        $p++;
    }
    $poCon .=")";$poCon2 .=")";$poCon3 .=")";$poCon4 .=")";$poCon5 .=")";$poCon6 .=")";$poCon7 .=")";$poCon8 .=")";
    /*======================================================================================/
    /                                    fin fab qty                                        /
    /======================================================================================*/
    $fab_sql="SELECT d.season_buyer_wise as season,to_char(c.shipment_date,'MON-YYYY') as MONTH_YEAR ,b.GREY_FAB_QNTY,a.booking_no_prefix_num,a.booking_no,a.fabric_source,
    (CASE WHEN b.booking_type=1 THEN b.fin_fab_qnty END) as FIN_FAB_QNTY
    from wo_booking_mst a, wo_booking_dtls b,wo_po_break_down c,wo_po_details_master d where a.booking_no=b.booking_no and  b.po_break_down_id=c.id and d.id=c.job_id  and b.booking_type=1 and b.status_active=1 and b.is_deleted=0 $poCon8 order by d.season_buyer_wise";//and a.fabric_source=1
    // echo $fab_sql;
    $fab_result = sql_select($fab_sql);// or die(mysql_error());
    $ff_qnty_array = array();
    $gf_qnty_array = array(); 
    foreach($fab_result as $row)
    { 
        $ff_qnty_array[$row['SEASON']][$row['FABRIC_SOURCE']] += $row['FIN_FAB_QNTY'];

        if($row['FABRIC_SOURCE']==1)
        {
            $gf_qnty_array[$row['SEASON']] += $row['GREY_FAB_QNTY'];       
        }
        
    }
    unset($fab_result);

    /*======================================================================================/
    /                                   grey fab qty                                        /
    /======================================================================================*/
    $gp_qty_array = array();
    $recvData=sql_select("SELECT d.season_buyer_wise as season,to_char(c.shipment_date,'MON-YYYY') as MONTH_YEAR, sum(quantity) as GREY_PROD_QNTY from order_wise_pro_details a, pro_grey_prod_entry_dtls b,wo_po_break_down c,wo_po_details_master d where d.id=c.job_id and a.dtls_id=b.id and a.prod_id=b.prod_id and a.po_breakdown_id=c.id and a.entry_form =2 and a.is_deleted=0 and a.status_active=1 $poCon4 group by d.season_buyer_wise,c.shipment_date");
    foreach($recvData as $row)
    {
        $gp_qty_array[$row['SEASON']] += $row['GREY_PROD_QNTY'];
    }
    unset($recvData);
    /*======================================================================================/
    /                                    grey fab issue                                     /
    /======================================================================================*/
    $dataArrayYarnIssuesQty = array();
     $sqlsTrans="SELECT  d.season_buyer_wise as season,to_char(c.shipment_date,'MON-YYYY') as MONTH_YEAR, sum(b.quantity) as QNTY from inv_transaction a, order_wise_pro_details b,wo_po_break_down c,wo_po_details_master d where c.job_id=d.id and a.id=b.trans_id and b.po_breakdown_id=c.id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.entry_form in(16,19,61) and a.item_category=13 and a.transaction_type in(2) and b.trans_type in(2) $poCon7 group by  d.season_buyer_wise,c.shipment_date";
    $results_trans=sql_select( $sqlsTrans );
    foreach ($results_trans as $row)
    {
        $dataArrayYarnIssuesQty[$row['SEASON']]['qnty'] += $row['QNTY'];
    }
    /*======================================================================================/
    /                                    yarn allocation                                    /
    /======================================================================================*/
    $sql_yarn = sql_select("SELECT c.season_buyer_wise as season,to_char(b.shipment_date,'MON-YYYY') as MONTH_YEAR, sum(a.qnty) as QNTY from inv_material_allocation_dtls a,wo_po_break_down b,wo_po_details_master c where c.id=b.job_id and a.item_category = 1 and a.po_break_down_id=b.id and  a.status_active = 1 and a.is_deleted=0 $poCon3 group by c.season_buyer_wise,b.shipment_date");
    $yarn_allocation_arr = array();
    foreach ($sql_yarn as $val) 
    {
        $yarn_allocation_arr[$val['SEASON']] += $val['QNTY'];
    }
    // print_r($yarn_allocation_arr);
    /*======================================================================================/
    /                                    yarn issue                                         /
    /======================================================================================*/
    $yarn_issue=sql_select( "SELECT c.season_buyer_wise as season,to_char(b.shipment_date,'MON-YYYY') as MONTH_YEAR,sum(case when a.entry_form=3 then a.quantity else 0 end) - sum(case when a.entry_form=9 then a.quantity else 0 end) as QUANTITY from order_wise_pro_details a,wo_po_break_down b,wo_po_details_master c where c.id=b.job_id and a.entry_form in(3,9) $poCon5 and a.status_active=1 and a.is_deleted=0 and a.is_sales !=1 group by c.season_buyer_wise,b.shipment_date");
    $yarn_issue_array = array();
    foreach ($yarn_issue as $row) 
    {
        $yarn_issue_array[$val['SEASON']] += $val['QUANTITY'];
    }

    /*======================================================================================/
    /                                    yarn issue rtn                                     /
    /======================================================================================*/
    $issue_return=sql_select("SELECT d.season_buyer_wise as season,to_char(c.shipment_date,'MON-YYYY') as MONTH_YEAR,a.QUANTITY 
        from order_wise_pro_details a,inv_transaction b,wo_po_break_down c,wo_po_details_master d where d.id=c.job_id and a.trans_id=b.id and a.trans_type=4 and a.po_breakdown_id=c.id and b.transaction_type in(4) and a.entry_form=9 and a.status_active=1 and a.is_deleted=0  and b.status_active=1 and b.is_deleted=0 $poCon4 ");
    foreach ($issue_return as $row)
    {
        $dataArrayYarnIssues_ret_arr[$row['SEASON']] += $row['QUANTITY'];
    }
    /*======================================================================================/
    /                                    fab dyeing qty                                     /
    /======================================================================================*/
    $daying=sql_select( "SELECT e.season_buyer_wise as season,to_char(d.shipment_date,'MON-YYYY') as MONTH_YEAR,sum(b.batch_qnty) as BATCH_QNTY from pro_batch_create_mst a,pro_batch_create_dtls b, pro_fab_subprocess c,wo_po_break_down d,wo_po_details_master e where e.id=d.job_id and a.id=b.mst_id and a.id=c.batch_id and c.load_unload_id=2 and c.entry_form=35 and b.po_id=d.id and a.batch_against<>2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $poCon2  group by e.season_buyer_wise,d.shipment_date");
    $daying_qnty_array = array();
    foreach ($daying as $row) 
    {
       $daying_qnty_array[$row['SEASON']] += $row['BATCH_QNTY'];
    }
        
    // ======================================= DYEING PRODUCTION (Outbound) ==============================   
    $poIdsCondFin = str_replace("a.po_break_down_id", "c.po_breakdown_id", $poCon);
    $sqlDyeing = "SELECT d.season_buyer_wise as season,b.grey_used_qty as QNTY from inv_receive_master a,pro_finish_fabric_rcv_dtls b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 and e.id=c.po_breakdown_id and e.job_id=d.id $poIdsCondFin and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(37) and c.entry_form in(37) and a.item_category=2 and a.receive_basis=11";
     // echo $sqlDyeing;die();
    $dyeingRes = sql_select($sqlDyeing);
    $dyeingProdOutArr = array();
    foreach ($dyeingRes as  $val) 
    {
        $dyeingProdOutArr[$val['SEASON']] += $val['QNTY'];
    }

    /*======================================================================================/
    /                                    fab available qty                                  /
    /======================================================================================*/
    /*if(return_field_value("auto_update","variable_settings_production","company_name=$company_id and variable_list=15 and item_category_id=2 order by id","auto_update")==2)
    {
        $fabrics_sql="SELECT to_char(b.shipment_date,'MON-YYYY') as MONTH_YEAR, sum(a.quantity) as quantity from order_wise_pro_details a,wo_po_break_down b where a.entry_form in(17,37) and a.po_breakdown_id=b.id $poCon5 and a.status_active=1 and a.is_deleted=0 group by b.shipment_date"; 
    }
    else
    {
        $fabrics_sql="SELECT to_char(b.shipment_date,'MON-YYYY') as MONTH_YEAR, sum(a.quantity) as QUANTITY from order_wise_pro_details a,wo_po_break_down b where a.entry_form=7 and a.po_breakdown_id=b.id $poCon5 and a.status_active=1 and a.is_deleted=0 group by b.shipment_date
        union all
        select to_char(c.shipment_date,'MON-YYYY') as MONTH_YEAR, sum(a.quantity) as QUANTITY from order_wise_pro_details a, inv_transaction b,wo_po_break_down c where  a.trans_id = b.id and c.id=a.po_breakdown_id and  a.entry_form in(37,17) $poCon5 and b.receive_basis in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  group by c.shipment_date";

    }*/
    // echo $fabrics_sql;
    $poIdsCondFin = str_replace("po_breakdown_id", "e.id", $poCon5);
    $sqlFinFab = "SELECT a.receive_basis, d.season_buyer_wise as season,to_char(e.shipment_date,'MON-YYYY') as MONTH_YEAR, c.quantity as QNTY from inv_receive_master a,inv_transaction b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e where a.id=b.mst_id and b.id=c.trans_id and b.transaction_type=1 and e.id=c.po_breakdown_id and e.job_id=d.id $poIdsCondFin and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(7,37) and a.item_category=2 and a.receive_basis in(1,2,11,5)";
     // echo $sqlFinFab;die();
    $finFabRes = sql_select($sqlFinFab);
    $fabrics_avl_qnty_array = array();
    foreach ($finFabRes as $row) 
    {
        if($row['RECEIVE_BASIS']==1 || $row['RECEIVE_BASIS']==2)
        {
            $fabrics_avl_qnty_array[$row['SEASON']][2] += $row['QNTY'];
        }
        else
        {
            $fabrics_avl_qnty_array[$row['SEASON']][1] += $row['QNTY'];
        }
    }
    /*======================================================================================/
    /                                    fab lay qty                                       /
    /======================================================================================*/
    $lay_sql="SELECT d.season_buyer_wise as season,to_char(c.shipment_date,'MON-YYYY') as MONTH_YEAR,sum(b.size_qty) as QNTY from ppl_cut_lay_dtls a,ppl_cut_lay_bundle b, wo_po_break_down c,wo_po_details_master d where d.id=c.job_id and a.id=b.dtls_id and c.id=b.order_id and a.status_active=1 and b.status_active=1 $poCon6 group by d.season_buyer_wise,c.shipment_date ";
    $lay_cut_data_array = array();
    foreach(sql_select($lay_sql) as $rows)
    {
        $lay_cut_data_array[$rows["SEASON"]]   += $rows["QNTY"];
    }

    /*======================================================================================/
    /                          print,embro req qty from budget                              /
    /======================================================================================*/
    $condition= new condition();     
    $condition->po_id_in($poIDS);          
    $condition->jobid_in($jobIDS); 
    $condition->init();
    $costPerArr=$condition->getCostingPerArr();
    $emblishment= new emblishment($condition);
    $emblishment_costing_arr=$emblishment->getQtyArray_by_orderAndEmbname();
    // echo"<pre>";print_r($emblishment_costing_arr);die();
    $emReqQtyArr = array();
    foreach ($emblishment_costing_arr as $po_id => $val) 
    {
        // echo $val[1]."dfgsdf";
        $costingPer = $costPerArr[$po_wise_job_arr[$po_id]];
        $emReqQtyArr[$po_wise_season_arr[$po_id]][1] = $val[1]*$costingPer;
        $emReqQtyArr[$po_wise_season_arr[$po_id]][2] = $val[2]*$costingPer;
    }
    // echo"<pre>";print_r($costPerArr);die();

    /*$budgetPoCon = str_replace("a.po_break_down_id", "b.id", $poCon);

    $costing_per_sql=sql_select("SELECT JOB_NO,COSTING_PER from wo_pre_cost_mst");
    $costing_per_arr=array();
    foreach($costing_per_sql as $cost_val)
    {
        $costing_per_arr[$cost_val['JOB_NO']] = $cost_val['COSTING_PER'];
    }
    unset($costing_per_sql);

    $gmtsitemRatioArray = array();
    $gmtsitemRatioSql=sql_select('SELECT a.job_no AS JOB_NO,b.gmts_item_id AS GMTS_ITEM_ID ,b.set_item_ratio AS SET_ITEM_RATIO from wo_po_details_master a, wo_po_details_mas_set_details b where 1=1 and a.id=b.job_id');
    foreach($gmtsitemRatioSql as $gmtsitemRatioSqlRow)
    {
        $gmtsitemRatioArray[$gmtsitemRatioSqlRow['JOB_NO']][$gmtsitemRatioSqlRow['GMTS_ITEM_ID']]=$gmtsitemRatioSqlRow['SET_ITEM_RATIO'];    
    }
    unset($gmtsitemRatioSql);

    $emReqSql = "SELECT a.season_buyer_wise as season, a.job_no AS JOB_NO,a.BUYER_NAME,a.total_set_qnty AS TOTAL_SET_QNTY,b.id AS ID,to_char(b.shipment_date,'MON-YYYY') as MONTH_YEAR,b.grouping as INT_REF,c.item_number_id AS ITEM_NUMBER_ID,c.order_quantity AS ORDER_QUANTITY ,c.plan_cut_qnty AS PLAN_CUT_QNTY,d.id AS EMBLISHMENT_ID,d.emb_name AS EMB_NAME,d.emb_type AS EMB_TYPE,d.cons_dzn_gmts AS CONS_DZN_GMTS_MST,d.rate AS RATE_MST,e.requirment AS CONS_DZN_GMTS from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_embe_cost_dtls d , wo_pre_cos_emb_co_avg_con_dtls e where 1=1  and d.emb_name in(1,2,4,5,99) and cons_dzn_gmts>0 and  a.id=b.job_id and a.id=c.job_id and a.id=d.job_id and a.id=e.job_id  and b.id=c.po_break_down_id and b.id=e.po_break_down_id and c.item_number_id= e.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.size_number_id and d.id=e.pre_cost_emb_cost_dtls_id    and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1 $budgetPoCon";
    // echo $emReqSql;die();

    $emReqRes = sql_select($emReqSql);  
    $emReqQtyArr = array();       
    foreach ($emReqRes as $key => $row) 
    {
        $costingPer = $costing_per_arr[$row['JOB_NO']];
        if($costingPer==1) $pcs_value=1*12;
        else if($costingPer==2) $pcs_value=1*1;
        else if($costingPer==3) $pcs_value=2*12;
        else if($costingPer==4) $pcs_value=3*12;
        else if($costingPer==5) $pcs_value=4*12;
        $gmtsitemRatio = $gmtsitemRatioArray[$row['JOB_NO']][$row['ITEM_NUMBER_ID']];
        $requirment=$row['CONS_DZN_GMTS_MST'];
        $reqQty = ($row['PLAN_CUT_QNTY']/$gmtsitemRatio)*($requirment/$pcs_value);
        // echo "(".$row['PLAN_CUT_QNTY']."/".$gmtsitemRatio.")*(".$requirment."/".$pcs_value.")<br>";

        $emReqQtyArr[$row['SEASON']][$row['EMB_NAME']] += $reqQty*12;
    }*/
    /*======================================================================================/
    /                                    gmts prod qty                                      /
    /======================================================================================*/
    $sql="SELECT d.season_buyer_wise as season,to_char(c.shipment_date,'MON-YYYY') as MONTH_YEAR,
    SUM(CASE WHEN a.production_type=1 THEN b.production_qnty END) as TOTALCUT,
    SUM(CASE WHEN a.production_type=4 THEN b.production_qnty END) as TOTALINPUT,
    SUM(CASE WHEN a.production_type=3 and a.embel_name=1 THEN b.production_qnty ELSE 0 END) as TOTALSPRINTING,
    SUM(CASE WHEN a.production_type=3 and a.embel_name=2 THEN b.production_qnty ELSE 0 END) as TOTALSEMBRO,
    SUM(CASE WHEN a.production_type=3 and a.embel_name=1 THEN b.reject_qty ELSE 0 END) as PRINTINGREJ,
    SUM(CASE WHEN a.production_type=3 and a.embel_name=2 THEN b.reject_qty ELSE 0 END) as EMBROREJ,
    SUM(CASE WHEN a.production_type=5 THEN b.production_qnty ELSE 0 END) as TOTALSEWING,
    SUM(CASE WHEN a.production_type=8 THEN b.production_qnty ELSE 0 END) as TOTALFINISH,
    SUM(CASE WHEN a.production_type=2 THEN b.production_qnty ELSE 0 END) as TOTAEMBISSUE,
    SUM(CASE WHEN a.production_type=3 THEN b.production_qnty ELSE 0 END) as TOTAEMBREC
    from pro_garments_production_mst a,pro_garments_production_dtls b,wo_po_break_down c,wo_po_details_master d
    WHERE d.id=c.job_id and a.id=b.mst_id and a.po_break_down_id=c.id and a.status_active=1 and a.is_deleted=0 and b.status_active=1  and b.is_deleted=0 $poCon group by d.season_buyer_wise,c.shipment_date";
    // echo $sql;
    $dataArray=sql_select($sql);
    $prod_data_array = array();
    foreach($dataArray as $row)
    {  
        $prod_data_array[$row['SEASON']]['cut_qty']     += $row['TOTALCUT'];
        $prod_data_array[$row['SEASON']]['input_qty']   += $row['TOTALINPUT'];
        $prod_data_array[$row['SEASON']]['sewing_qty']  += $row['TOTALSEWING'];
        $prod_data_array[$row['SEASON']]['finish_qty']  += $row['TOTALFINISH'];
        $prod_data_array[$row['SEASON']]['emb_issue']   += $row['TOTAEMBISSUE'];
        $prod_data_array[$row['SEASON']]['emb_rcv']     += $row['TOTAEMBREC'];
        $prod_data_array[$row['SEASON']]['print_qty']   += $row['TOTALSPRINTING'];
        $prod_data_array[$row['SEASON']]['embro_qty']   += $row['TOTALSEMBRO'];
        $prod_data_array[$row['SEASON']]['print_rej']   += $row['PRINTINGREJ'];
        $prod_data_array[$row['SEASON']]['embro_rej']   += $row['EMBROREJ'];
    
    }
    unset($dataArray);
    /*======================================================================================/
    /                                    ex-factory qty                                     /
    /======================================================================================*/
    $ex=sql_select( "SELECT c.season_buyer_wise as season,to_char(b.shipment_date,'MON-YYYY') as MONTH_YEAR, sum(a.ex_factory_qnty) as EX_FACTORY_QNTY from pro_ex_factory_mst a,wo_po_break_down b,wo_po_details_master c where c.id=b.job_id and b.id=a.po_break_down_id and a.status_active=1 $poCon3 and a.is_deleted=0 group by c.season_buyer_wise,b.shipment_date order by b.shipment_date");
    $ex_qnty_array = array();
    foreach ($ex as $row) 
    {
        $ex_qnty_array[$row['SEASON']]  += $row['EX_FACTORY_QNTY'];
    }    
   
    
    ob_start();
    ?>
    <div class="tableContainer"> 
        <style type="text/css">        
            .GridViewScrollHeader TH, .GridViewScrollHeader TD 
            {
                padding: 2px 4px;
                font-weight: normal;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                text-align: left;
                vertical-align: middle;
            }

            .GridViewScrollHeader TH{
                background-image: -webkit-linear-gradient( rgb(194,220,255) 10%, rgb(136,170,214) 96%);
                border: 1px solid #8DAFDA;
                color:#444;
                font-size: 13px;
                font-weight: bold;
                text-align: center;
                line-height: 12px;
                height: 25px;
            }

            .GridViewScrollItem TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
               /* background-color: #FFFFFF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollItemFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #E9F3FF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollFooterFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-top: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                vertical-align: middle;
                font-weight: 700;
                background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB));
            }
            tr.GridViewScrollItemFreeze:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            tr.footerTr:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            html {
              --scrollbarBG: #CFD8DC;
              --thumbBG: #8ec5fc;
            }
            body::-webkit-scrollbar {
              width: 11px;
            }
            body {
              scrollbar-width: thin;
              scrollbar-color: var(--thumbBG) var(--scrollbarBG);
            }
            body::-webkit-scrollbar-track {
              background: var(--scrollbarBG);
            }
            body::-webkit-scrollbar-thumb {
              background-color: var(--thumbBG) ;
              border-radius: 6px;
              border: 3px solid var(--scrollbarBG);
            }
        </style>         
        <fieldset style="width:96%;">
            <table width="100%" cellpadding="0" cellspacing="0">
                <tr><td colspan="28" align="center" style="font-size:22px;">Buyer : <? echo $buyer_short_name_arr[$buyer_id]; ?></td></tr>
                <!-- <tr><td colspan="28" align="center" style="font-size:16px;">Month : <? echo $date_from." to ".$date_to;?></td></tr> -->
            </table>
            <table style="width: 100%; border-collapse: collapse;" border="1" rules="all"  class="rpt_table" id="gvMain"> 
                <thead>
                    <tr class="GridViewScrollHeader"> 
                        <th>Sl</th>
                        <th>Season</th>
                        <th>QTY</th>
                        <th>Grey Req</th>
                        <th>Yarn Alloc</th>
                        <th>Alloc Bal</th>
                        <th>Grey Prod.</th>
                        <th>Grey Bal</th>
                        <th>Dyeing</th>
                        <th>Dyeing Bal</th>
                        <th>Fab Req Prod</th> 
                        <th>Fab Rcvd Prod</th>
                        <th>Balance</th>
                        <th>Fab Req Pur</th> 
                        <th>Fab Rcvd Pur</th>
                        <th>Balance</th>
                        <th>Cut Qc</th>
                        <th>Cut Bal</th>
                        <th>Print Req</th>
                        <th>Print Bal</th>
                        <th>Embo Req</th>
                        <th>Embo Bal</th>
                        <th>Sew Input</th>
                        <th>Input Bal</th>
                        <th>Output</th>
                        <th>Output Bal</th>
                        <th>Fin Qty</th>
                        <th>Fin Bal</th>
                        <th>Ship Qty</th>
                        <th>Ship Bal</th>
                   </tr>
                </thead>
                <tbody>
                    <? 
                    $i=1;
                    $gr_order_qty   = 0;
                    $gr_order_val   = 0;
                    $gr_grey_req    = 0;
                    $gr_yarn_alloc  = 0;
                    $gr_alloc_bal   = 0;
                    $gr_grey_qty    = 0;
                    $gr_grey_bal    = 0;
                    $gr_dyeing_qty  = 0;
                    $gr_dyeing_bal  = 0;
                    $gr_fab_req     = 0;
                    $gr_fab_rcvd    = 0;
                    $gr_fab_bal     = 0;
                    $gr_fab_req_pur = 0;
                    $gr_fab_rcvd_pur= 0;
                    $gr_fab_bal_pur = 0;
                    $gr_cuting_qc   = 0;
                    $gr_cuting_bal  = 0;
                    $gr_print_req   = 0;
                    $gr_print_bal   = 0;
                    $gr_embro_req   = 0;
                    $gr_embro_bal   = 0;
                    $gr_input_qty   = 0;
                    $gr_input_bal   = 0;
                    $gr_output_qty  = 0;
                    $gr_output_bal  = 0;
                    $gr_fin_qty     = 0;
                    $gr_fin_bal     = 0;
                    $gr_ship_qty    = 0;
                    $gr_ship_bal    = 0;
                    
                    
                    ksort($data_array);
                    foreach ($data_array as $season => $row) 
                    
                    { 
                        $season_id      = $row['season_id'];                      
                        $po_qty         = $row['po_quantity'];
                        $grey_req       = $gf_qnty_array[$season_id];
                        $yarn_alloc     = $yarn_allocation_arr[$season_id];
                        $alloc_bal      = $grey_req - $yarn_alloc;
                        $grey_prod      = $gp_qty_array[$season_id];
                        $grey_bal       = $grey_req - $grey_prod;
                        $fav_avable_qty = $fabrics_avl_qnty_array[$season_id][1];
                        $ff_qty         = $ff_qnty_array[$season_id][1];
                        $fab_bal        = $ff_qty - $fav_avable_qty;
                        $fav_avable_qty_pur = $fabrics_avl_qnty_array[$season_id][2];
                        $ff_qty_pur     = $ff_qnty_array[$season_id][2];
                        $fab_bal_pur    = $ff_qty_pur - $fav_avable_qty_pur;
                        $dyeing_qty     = $daying_qnty_array[$season_id];
                        $dyeing_out_qty = $dyeingProdOutArr[$season_id];
                        $dyeing_bal     = $grey_req - ($dyeing_qty+$dyeing_out_qty);
                        $lay_cut_qty    = $lay_cut_data_array[$season_id];
                        $cutting_bal    = $row['po_quantity'] - $lay_cut_qty;

                        $print_req      = $emReqQtyArr[$season_id][1];
                        $print_qty      = $prod_data_array[$season_id]['print_qty'];
                        $print_rej      = $prod_data_array[$season_id]['print_rej'];
                        $print_bal      = $print_req - ($print_qty - $print_rej);
                        $embro_req      = $emReqQtyArr[$season_id][2];
                        $embro_qty      = $prod_data_array[$season_id]['embro_qty'];
                        $embro_rej      = $prod_data_array[$season_id]['embro_rej'];
                        $embro_bal      = $embro_req - ($embro_qty - $embro_rej);
                        $sewing_in      = $prod_data_array[$season_id]['input_qty'];
                        $sewing_out     = $prod_data_array[$season_id]['sewing_qty'];
                        $input_bal      = $row['po_quantity'] - $sewing_in;
                        $output_bal     = $row['po_quantity'] - $sewing_out;
                        $finish_qty     = $prod_data_array[$season_id]['finish_qty'];
                        $finish_bal     = $row['po_quantity'] - $finish_qty;
                        $ship_qty       = $ex_qnty_array[$season_id];
                        $ship_bal       = $row['po_quantity'] - $ship_qty;

                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ; 
                        ?>
                        <tr class="GridViewScrollItem" bgcolor="<? echo $bgcolor; ?>" onclick="change_color('str_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="str_<? echo $i; ?>" style="font-size:12px;" valign="middle">
                            <td><? echo $i; ?></td>
                            <td> 
                                <a href="javascript:void(0)" onClick="open_buyer_summary_popup_by_season('<? echo $sqlcond;?>','<? echo $buyer_id; ?>','<? echo $season_id; ?>' ,'<? echo $date_from; ?>' ,'<? echo $date_to; ?>','buyer_summary_popup_by_season')">
                                    <? echo $season;?> 
                                </a>
                            </td>
                            <td align="right"><? echo fn_number_format($row['po_quantity'],0); ?></td>
                            <td align="right"><? echo fn_number_format($grey_req,0); ?></td>
                            <td align="right"><? echo fn_number_format($yarn_alloc,0); ?></td>
                            <td align="right"><? echo fn_number_format($alloc_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($grey_prod,0); ?></td>
                            <td align="right"><? echo fn_number_format($grey_bal,0); ?></td>
                            <td align="right" title="Inhouse=<?=$dyeing_qty.',Outbound='.$dyeing_out_qty;?>">
                                <? echo fn_number_format(($dyeing_qty+$dyeing_out_qty),0); ?>
                            </td>
                            <td align="right"><? echo fn_number_format($dyeing_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($ff_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($fav_avable_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($fab_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($ff_qty_pur,0); ?></td>
                            <td align="right"><? echo fn_number_format($fav_avable_qty_pur,0); ?></td>
                            <td align="right"><? echo fn_number_format($fab_bal_pur,0); ?></td>
                            <td align="right"><? echo fn_number_format($lay_cut_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($cutting_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($print_req,0); ?></td>
                            <td align="right"><? echo fn_number_format($print_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($embro_req,0); ?></td>
                            <td align="right"><? echo fn_number_format($embro_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($sewing_in,0); ?></td>
                            <td align="right"><? echo fn_number_format($input_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($sewing_out,0); ?></td>
                            <td align="right"><? echo fn_number_format($output_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($finish_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($finish_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($ship_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($ship_bal,0); ?></td>
                        </tr>
                        <? 
                        $i++;
                        $gr_order_qty   += $row['po_quantity'];
                        $gr_order_val   += $row['total_price'];
                        $gr_grey_req    += $grey_req;
                        $gr_yarn_alloc  += $yarn_alloc;
                        $gr_alloc_bal   += $alloc_bal;
                        $gr_grey_qty    += $grey_prod;
                        $gr_grey_bal    += $grey_bal;
                        $gr_dyeing_qty  += ($dyeing_qty+$dyeing_out_qty);
                        $gr_dyeing_bal  += $dyeing_bal;
                        $gr_fab_req     += $ff_qty;
                        $gr_fab_rcvd    += $fav_avable_qty;
                        $gr_fab_bal     += $fab_bal;
                        $gr_fab_req_pur += $ff_qty_pur;
                        $gr_fab_rcvd_pur+= $fav_avable_qty_pur;
                        $gr_fab_bal_pur += $fab_bal_pur;
                        $gr_cuting_qc   += $lay_cut_qty;
                        $gr_cuting_bal  += $cutting_bal;
                        $gr_print_req   += $print_req;
                        $gr_print_bal   += $print_bal;
                        $gr_embro_req   += $embro_req;
                        $gr_embro_bal   += $embro_bal;
                        $gr_input_qty   += $sewing_in;
                        $gr_input_bal   += $input_bal;
                        $gr_output_qty  += $sewing_out;
                        $gr_output_bal  += $output_bal;
                        $gr_fin_qty     += $finish_qty;
                        $gr_fin_bal     += $finish_bal;
                        $gr_ship_qty    += $ship_qty;
                        $gr_ship_bal    += $ship_bal;
                    }
                    
                   ?>
                </tbody>
                <tr class="GridViewScrollItem footerTr">
                    <td align="right"><div class="gridViewScrollHelper"></div></td>   
                    <td align="right">Total </td>   
                    <td align="right"><? echo fn_number_format($gr_order_qty,0);?></td>
                    <td align="right"><? echo fn_number_format($gr_grey_req,0);?></td> 
                    <td align="right"><? echo fn_number_format($gr_yarn_alloc,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_alloc_bal,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_grey_qty,0);?></td>    
                    <td align="right"><? echo fn_number_format($gr_grey_bal,0);?></td>  
                    <td align="right"><? echo fn_number_format($gr_dyeing_qty,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_dyeing_bal,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_fab_req,0);?></td> 
                    <td align="right"><? echo fn_number_format($gr_fab_rcvd,0);?></td> 
                    <td align="right"><? echo fn_number_format($gr_fab_bal,0);?></td>  
                    <td align="right"><? echo fn_number_format($gr_fab_req_pur,0);?></td> 
                    <td align="right"><? echo fn_number_format($gr_fab_rcvd_pur,0);?></td> 
                    <td align="right"><? echo fn_number_format($gr_fab_bal_pur,0);?></td>
                    <td align="right"><? echo fn_number_format($gr_cuting_qc,0);?></td> 
                    <td align="right"><? echo fn_number_format($gr_cuting_bal,0);?></td>
                    <td align="right"><? echo fn_number_format($gr_print_req,0);?></td>    
                    <td align="right"><? echo fn_number_format($gr_print_bal,0);?></td>    
                    <td align="right"><? echo fn_number_format($gr_embro_req,0);?></td>    
                    <td align="right"><? echo fn_number_format($gr_embro_bal,0);?></td>  
                    <td align="right"><? echo fn_number_format($gr_input_qty,0);?></td>    
                    <td align="right"><? echo fn_number_format($gr_input_bal,0);?></td>    
                    <td align="right"><? echo fn_number_format($gr_output_qty,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_output_bal,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_fin_qty,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_fin_bal,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_ship_qty,0);?></td>  
                    <td align="right"><? echo fn_number_format($gr_ship_bal,0);?></td>    
                </tr>
                
            </table>
        </fieldset>
        <script type="text/javascript">
            function open_buyer_summary_popup_by_season(sqlcond,buyer_id,season,date_from,date_to,action)
            {
                var width = window.innerWidth;
                // width = 1270;
                width = width-20;
                emailwindow = dhtmlmodal.open('EmailBox', 'iframe', 'order_monitoring_report_with_tna_controller.php?buyer_id=' + buyer_id+'&season=' + season+'&date_from=' + date_from+'&date_to=' + date_to+'&width=' + width+'&sqlcond=' + sqlcond+ '&action='+action, 'Buyer Summary Internal Reference Wise Popup', 'width='+width+',height=350px,center=1,resize=0,scrolling=0', '../../../');
            }
        </script>
        <script type="text/javascript" src="../../../../js/gridviewscroll.js"></script>
        <script type="text/javascript">
            var gridViewScroll = null;
            fnGridView = function () {
                gridViewScroll = new GridViewScroll({
                    elementID: "gvMain",
                    width: screen.width-50,
                    // width: 1335,
                    height: 380,
                    freezeColumn: true,
                    freezeFooter: true,
                    freezeColumnCssClass: "GridViewScrollItemFreeze",
                    freezeFooterCssClass: "GridViewScrollFooterFreeze",
                    freezeHeaderRowCount: 1,
                    freezeColumnCount: 3,
                    onscroll: function (scrollTop, scrollLeft) {
                        console.log(scrollTop + " - " + scrollLeft);
                    }
                });
                gridViewScroll.enhance();
            }
            function getScrollPosition() {
                var position = gridViewScroll.scrollPosition;
                alert("scrollTop: " + position.scrollTop + ", scrollLeft: " + position.scrollLeft);
            }
            function setScrollPosition() {
                var scrollPosition = { scrollTop: 50, scrollLeft: 50};

                gridViewScroll.scrollPosition = scrollPosition;
            }
            fnGridView();
            //=================================================
            
        </script>
    </div>
    <?
}

if($action=="buyer_summary_popup_by_season")
{
    echo load_html_head_contents("Buyer Summary Info", "../../../../", 1, 1,'','','');
    extract($_REQUEST); 
    list($company_id,$buyer_name,$season_name,$merchant,$int_ref_no,$style_ref,$location_name,$shipment_status,$order_status,$status,$item_id,$date_from,$date_to,$search_by,$client) = explode("**", $sqlcond);
    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    $sqlCond .= ($season != "")   ? " and a.season_buyer_wise=$season"         : "";
    $sqlCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    $sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($client !=0) ? " and a.client_id=$client" : "";
    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active in($status)" : "";
    $sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }  
    // echo $sqlCond;
    
    /*======================================================================================/
    /                                    main query                                         /
    /======================================================================================*/
    // $sql = "SELECT b.grouping, a.season_buyer_wise as season,b.id as PO_ID,to_char(b.shipment_date,'MON-YYYY') as MONTH_YEAR,b.PO_TOTAL_PRICE,(b.po_quantity*a.total_set_qnty) as PO_QUANTITY from wo_po_details_master a,wo_po_break_down b where a.id=b.job_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.buyer_name=$buyer_id $sqlCond order by b.shipment_date";
    $sql = "SELECT a.id as job_id,a.job_no,b.grouping, a.season_buyer_wise as season,b.id as PO_ID,to_char(b.shipment_date,'MON-YYYY') as MONTH_YEAR,b.PO_TOTAL_PRICE,(b.po_quantity*a.total_set_qnty) as PO_QNTY,sum(c.ORDER_QUANTITY) as PO_QUANTITY from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  and a.buyer_name=$buyer_id $sqlCond group by a.id,a.job_no,b.grouping, a.season_buyer_wise,b.id, b.shipment_date,b.PO_TOTAL_PRICE,b.po_quantity,a.total_set_qnty order by b.po_quantity desc";
    // echo $sql;die();
    $sqlRes = sql_select($sql);
    if(count($sqlRes)==0)
    {
        echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
    }
    $poIdArray = array();
    $jobIdArray = array();
    $data_array = array();
    $po_wise_job_arr = array();
    $po_wise_int_ref_arr = array();
    foreach ($sqlRes as $row) 
    {
        $data_array[$row['GROUPING']]['po_quantity'] += $row['PO_QUANTITY'];          
        $data_array[$row['GROUPING']]['total_price'] += $row['PO_TOTAL_PRICE'];            
        $poIdArray[$row['PO_ID']] = $row['PO_ID'];
        $jobIdArray[$row['JOB_ID']] = $row['JOB_ID'];
        $po_wise_job_arr[$row['PO_ID']] = $row['JOB_NO'];
        $po_wise_int_ref_arr[$row['PO_ID']] = $row['GROUPING'];
    }
    $poIDS = implode(",", $poIdArray);
    $jobIDS = implode(",", $jobIdArray);
    // echo "<pre>";print_r($data_array);
    $po_id_list_arr=array_chunk($poIdArray,999);

    $poCon = " and ";$poCon2 = " and ";$poCon3 = " and ";$poCon4 = " and ";$poCon5 = " and ";$poCon6 = " and ";$poCon7 = " and ";$poCon8 = " and ";
    $p=1;
    foreach($po_id_list_arr as $po_process)
    {
        if($p==1) $poCon .="  ( a.po_break_down_id in(".implode(',',$po_process).")"; 
        else  $poCon .=" or a.po_break_down_id in(".implode(',',$po_process).")";
        
        if($p==1) $poCon2 .="  ( b.po_id in(".implode(',',$po_process).")"; 
        else  $poCon2 .=" or b.po_id in(".implode(',',$po_process).")";
        
        if($p==1) $poCon3 .="  ( a.po_break_down_id in(".implode(',',$po_process).")"; 
        else  $poCon3 .=" or a.po_break_down_id in(".implode(',',$po_process).")";
        
        if($p==1) $poCon4 .="  ( a.po_breakdown_id in(".implode(',',$po_process).")"; 
        else  $poCon4 .=" or a.po_breakdown_id in(".implode(',',$po_process).")";            
        
        if($p==1) $poCon5 .="  ( po_breakdown_id in(".implode(',',$po_process).")"; 
        else  $poCon5 .=" or po_breakdown_id in(".implode(',',$po_process).")";
        
        if($p==1) $poCon6 .="  ( b.order_id in(".implode(',',$po_process).")"; 
        else  $poCon6 .=" or b.order_id in(".implode(',',$po_process).")";

        if($p==1) $poCon7 .="  ( b.po_breakdown_id in(".implode(',',$po_process).")"; 
        else  $poCon7 .=" or b.po_breakdown_id in(".implode(',',$po_process).")";

        if($p==1) $poCon8 .="  ( b.po_break_down_id in(".implode(',',$po_process).")"; 
        else  $poCon8 .=" or b.po_break_down_id in(".implode(',',$po_process).")";            
        
        $p++;
    }
    $poCon .=")";$poCon2 .=")";$poCon3 .=")";$poCon4 .=")";$poCon5 .=")";$poCon6 .=")";$poCon7 .=")";$poCon8 .=")";
    /*======================================================================================/
    /                                    fin fab qty                                        /
    /======================================================================================*/
    $fab_sql="SELECT c.grouping,d.season_buyer_wise as season,to_char(c.shipment_date,'MON-YYYY') as MONTH_YEAR ,b.GREY_FAB_QNTY,a.booking_no_prefix_num,a.booking_no,
    (CASE WHEN b.booking_type=1 THEN b.fin_fab_qnty END) as FIN_FAB_QNTY,a.fabric_source
    from wo_booking_mst a, wo_booking_dtls b,wo_po_break_down c,wo_po_details_master d where a.booking_no=b.booking_no and  b.po_break_down_id=c.id and d.id=c.job_id  and b.booking_type=1 and b.status_active=1 and b.is_deleted=0 $poCon8";//and a.fabric_source=1
    // echo $fab_sql;
    
    $fab_result = sql_select($fab_sql);// or die(mysql_error());
    $ff_qnty_array = array();
    $gf_qnty_array = array(); 
    foreach($fab_result as $row)
    { 
        $ff_qnty_array[$row['GROUPING']][$row['FABRIC_SOURCE']] += $row['FIN_FAB_QNTY'];
        if($row['FABRIC_SOURCE']==1)
        {
            $gf_qnty_array[$row['GROUPING']] += $row['GREY_FAB_QNTY']; 
        }
              
    }
    unset($fab_result);

    /*======================================================================================/
    /                                   grey fab qty                                        /
    /======================================================================================*/
    $gp_qty_array = array();
    $recvData=sql_select("SELECT c.grouping,d.season_buyer_wise as season,to_char(c.shipment_date,'MON-YYYY') as MONTH_YEAR, sum(quantity) as GREY_PROD_QNTY from order_wise_pro_details a, pro_grey_prod_entry_dtls b,wo_po_break_down c,wo_po_details_master d where d.id=c.job_id and a.dtls_id=b.id and a.prod_id=b.prod_id and a.po_breakdown_id=c.id and a.entry_form =2 and a.is_deleted=0 and a.status_active=1 $poCon4 group by c.grouping,d.season_buyer_wise,c.shipment_date");
    foreach($recvData as $row)
    {
        $gp_qty_array[$row['GROUPING']] += $row['GREY_PROD_QNTY'];
    }
    unset($recvData);
    /*======================================================================================/
    /                                    grey fab issue                                     /
    /======================================================================================*/
    $dataArrayYarnIssuesQty = array();
     $sqlsTrans="SELECT  c.grouping,d.season_buyer_wise as season,to_char(c.shipment_date,'MON-YYYY') as MONTH_YEAR, sum(b.quantity) as QNTY from inv_transaction a, order_wise_pro_details b,wo_po_break_down c,wo_po_details_master d where c.job_id=d.id and a.id=b.trans_id and b.po_breakdown_id=c.id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.entry_form in(16,19,61) and a.item_category=13 and a.transaction_type in(2) and b.trans_type in(2) $poCon7 group by  c.grouping,d.season_buyer_wise,c.shipment_date";
    $results_trans=sql_select( $sqlsTrans );
    foreach ($results_trans as $row)
    {
        $dataArrayYarnIssuesQty[$row['GROUPING']]['qnty'] += $row['QNTY'];
    }
    /*======================================================================================/
    /                                    yarn allocation                                    /
    /======================================================================================*/
    $sql_yarn = sql_select("SELECT b.grouping,c.season_buyer_wise as season,to_char(b.shipment_date,'MON-YYYY') as MONTH_YEAR, sum(a.qnty) as QNTY from inv_material_allocation_dtls a,wo_po_break_down b,wo_po_details_master c where c.id=b.job_id and a.item_category = 1 and a.po_break_down_id=b.id and  a.status_active = 1 and a.is_deleted=0 $poCon3 group by b.grouping,c.season_buyer_wise,b.shipment_date");
    $yarn_allocation_arr = array();
    foreach ($sql_yarn as $val) 
    {
        $yarn_allocation_arr[$val['GROUPING']] += $val['QNTY'];
    }
    // print_r($yarn_allocation_arr);
    /*======================================================================================/
    /                                    yarn issue                                         /
    /======================================================================================*/
    $yarn_issue=sql_select( "SELECT b.grouping,c.season_buyer_wise as season,to_char(b.shipment_date,'MON-YYYY') as MONTH_YEAR,sum(case when a.entry_form=3 then a.quantity else 0 end) - sum(case when a.entry_form=9 then a.quantity else 0 end) as QUANTITY from order_wise_pro_details a,wo_po_break_down b,wo_po_details_master c where c.id=b.job_id and a.entry_form in(3,9) $poCon5 and a.status_active=1 and a.is_deleted=0 and a.is_sales !=1 group by b.grouping,c.season_buyer_wise,b.shipment_date");
    $yarn_issue_array = array();
    foreach ($yarn_issue as $row) 
    {
        $yarn_issue_array[$val['GROUPING']] += $val['QUANTITY'];
    }

    /*======================================================================================/
    /                                    yarn issue rtn                                     /
    /======================================================================================*/
    $issue_return=sql_select("SELECT c.grouping,d.season_buyer_wise as season,to_char(c.shipment_date,'MON-YYYY') as MONTH_YEAR,a.QUANTITY 
        from order_wise_pro_details a,inv_transaction b,wo_po_break_down c,wo_po_details_master d where d.id=c.job_id and a.trans_id=b.id and a.trans_type=4 and a.po_breakdown_id=c.id and b.transaction_type in(4) and a.entry_form=9 and a.status_active=1 and a.is_deleted=0  and b.status_active=1 and b.is_deleted=0 $poCon4 ");
    foreach ($issue_return as $row)
    {
        $dataArrayYarnIssues_ret_arr[$row['GROUPING']] += $row['QUANTITY'];
    }
    /*======================================================================================/
    /                                    fab dyeing qty                                     /
    /======================================================================================*/
    $daying=sql_select( "SELECT d.grouping,e.season_buyer_wise as season,to_char(d.shipment_date,'MON-YYYY') as MONTH_YEAR,sum(b.batch_qnty) as BATCH_QNTY from pro_batch_create_mst a,pro_batch_create_dtls b, pro_fab_subprocess c,wo_po_break_down d,wo_po_details_master e where e.id=d.job_id and a.id=b.mst_id and a.id=c.batch_id and c.load_unload_id=2 and c.entry_form=35 and b.po_id=d.id and a.batch_against<>2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $poCon2  group by d.grouping,e.season_buyer_wise,d.shipment_date");
    $daying_qnty_array = array();
    foreach ($daying as $row) 
    {
       $daying_qnty_array[$row['GROUPING']] += $row['BATCH_QNTY'];
    }

    // ======================================= DYEING PRODUCTION (Outbound) ==============================   
    $poIdsCondFin = str_replace("a.po_break_down_id", "c.po_breakdown_id", $poCon);
    $sqlDyeing = "SELECT e.grouping as INT_REF,b.grey_used_qty as QNTY from inv_receive_master a,pro_finish_fabric_rcv_dtls b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 and e.id=c.po_breakdown_id and e.job_id=d.id $poIdsCondFin and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(37) and c.entry_form in(37) and a.item_category=2 and a.receive_basis=11";
     // echo $sqlDyeing;die();
    $dyeingRes = sql_select($sqlDyeing);
    $dyeingProdOutArr = array();
    foreach ($dyeingRes as  $val) 
    {
        $dyeingProdOutArr[$val['INT_REF']] += $val['QNTY'];
    }
    /*======================================================================================/
    /                                    fab available qty                                  /
    /======================================================================================*/
    /*if(return_field_value("auto_update","variable_settings_production","company_name=$company_id and variable_list=15 and item_category_id=2 order by id","auto_update")==2)
    {
        $fabrics_sql="SELECT to_char(b.shipment_date,'MON-YYYY') as MONTH_YEAR, sum(a.quantity) as quantity from order_wise_pro_details a,wo_po_break_down b where a.entry_form in(17,37) and a.po_breakdown_id=b.id $poCon5 and a.status_active=1 and a.is_deleted=0 group by b.shipment_date"; 
    }
    else
    {
        $fabrics_sql="SELECT to_char(b.shipment_date,'MON-YYYY') as MONTH_YEAR, sum(a.quantity) as QUANTITY from order_wise_pro_details a,wo_po_break_down b where a.entry_form=7 and a.po_breakdown_id=b.id $poCon5 and a.status_active=1 and a.is_deleted=0 group by b.shipment_date
        union all
        select to_char(c.shipment_date,'MON-YYYY') as MONTH_YEAR, sum(a.quantity) as QUANTITY from order_wise_pro_details a, inv_transaction b,wo_po_break_down c where  a.trans_id = b.id and c.id=a.po_breakdown_id and  a.entry_form in(37,17) $poCon5 and b.receive_basis in (1,2) and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  group by c.shipment_date";

    }*/
    // echo $fabrics_sql;
    $poIdsCondFin = str_replace("po_breakdown_id", "e.id", $poCon5);
    $sqlFinFab = "SELECT a.receive_basis,e.grouping,d.season_buyer_wise as season,to_char(e.shipment_date,'MON-YYYY') as MONTH_YEAR, c.quantity as QNTY from inv_receive_master a,inv_transaction b,order_wise_pro_details c,wo_po_details_master d,wo_po_break_down e where a.id=b.mst_id and b.id=c.trans_id and b.transaction_type=1 and e.id=c.po_breakdown_id and e.job_id=d.id $poIdsCondFin and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in(7,37) and a.item_category=2 and a.receive_basis in(1,2,11,5)";
     // echo $sqlFinFab;die();
    $finFabRes = sql_select($sqlFinFab);
    $fabrics_avl_qnty_array = array();
    foreach ($finFabRes as $row) 
    {
        if($row['RECEIVE_BASIS']==1 || $row['RECEIVE_BASIS']==2)
        {
            $fabrics_avl_qnty_array[$row['GROUPING']][2] += $row['QNTY'];
        }
        else
        {
            $fabrics_avl_qnty_array[$row['GROUPING']][1] += $row['QNTY'];
        }
    }
    /*======================================================================================/
    /                                    fab lay qty                                       /
    /======================================================================================*/
    $lay_sql="SELECT c.grouping,d.season_buyer_wise as season,to_char(c.shipment_date,'MON-YYYY') as MONTH_YEAR,sum(b.size_qty) as QNTY from ppl_cut_lay_dtls a,ppl_cut_lay_bundle b, wo_po_break_down c,wo_po_details_master d where d.id=c.job_id and a.id=b.dtls_id and c.id=b.order_id and a.status_active=1 and b.status_active=1 $poCon6 group by c.grouping,d.season_buyer_wise,c.shipment_date ";
    $lay_cut_data_array = array();
    foreach(sql_select($lay_sql) as $rows)
    {
        $lay_cut_data_array[$rows["GROUPING"]]   += $rows["QNTY"];
    }

    /*======================================================================================/
    /                          print,embro req qty from budget                              /
    /======================================================================================*/
    $condition= new condition();     
    $condition->po_id_in($poIDS);     
    $condition->jobid_in($jobIDS);     
    $condition->init();
    $costPerArr=$condition->getCostingPerArr();
    $emblishment= new emblishment($condition);
    $emblishment_costing_arr=$emblishment->getQtyArray_by_orderAndEmbname();
    // echo"<pre>";print_r($emblishment_costing_arr);die();
    $emReqQtyArr = array();
    foreach ($emblishment_costing_arr as $po_id => $val) 
    {
        // echo $val[1]."dfgsdf";
        $costingPer = $costPerArr[$po_wise_job_arr[$po_id]];
        $emReqQtyArr[$po_wise_int_ref_arr[$po_id]][1] = $val[1]*$costingPer;
        $emReqQtyArr[$po_wise_int_ref_arr[$po_id]][2] = $val[2]*$costingPer;
    }
    // echo"<pre>";print_r($costPerArr);die();

    /*$budgetPoCon = str_replace("a.po_break_down_id", "b.id", $poCon);

    $costing_per_sql=sql_select("SELECT JOB_NO,COSTING_PER from wo_pre_cost_mst");
    $costing_per_arr=array();
    foreach($costing_per_sql as $cost_val)
    {
        $costing_per_arr[$cost_val['JOB_NO']] = $cost_val['COSTING_PER'];
    }
    unset($costing_per_sql);

    $gmtsitemRatioArray = array();
    $gmtsitemRatioSql=sql_select('SELECT a.job_no AS JOB_NO,b.gmts_item_id AS GMTS_ITEM_ID ,b.set_item_ratio AS SET_ITEM_RATIO from wo_po_details_master a, wo_po_details_mas_set_details b where 1=1 and a.id=b.job_id');
    foreach($gmtsitemRatioSql as $gmtsitemRatioSqlRow)
    {
        $gmtsitemRatioArray[$gmtsitemRatioSqlRow['JOB_NO']][$gmtsitemRatioSqlRow['GMTS_ITEM_ID']]=$gmtsitemRatioSqlRow['SET_ITEM_RATIO'];    
    }
    unset($gmtsitemRatioSql);

    $emReqSql = "SELECT a.season_buyer_wise as season, a.job_no AS JOB_NO,a.BUYER_NAME,a.total_set_qnty AS TOTAL_SET_QNTY,b.id AS ID,to_char(b.shipment_date,'MON-YYYY') as MONTH_YEAR,b.grouping as INT_REF,c.item_number_id AS ITEM_NUMBER_ID,c.order_quantity AS ORDER_QUANTITY ,c.plan_cut_qnty AS PLAN_CUT_QNTY,d.id AS EMBLISHMENT_ID,d.emb_name AS EMB_NAME,d.emb_type AS EMB_TYPE,d.cons_dzn_gmts AS CONS_DZN_GMTS_MST,d.rate AS RATE_MST,e.requirment AS CONS_DZN_GMTS from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_embe_cost_dtls d , wo_pre_cos_emb_co_avg_con_dtls e where 1=1  and d.emb_name in(1,2,4,5,99) and cons_dzn_gmts>0 and  a.id=b.job_id and a.id=c.job_id and a.id=d.job_id and a.id=e.job_id  and b.id=c.po_break_down_id and b.id=e.po_break_down_id and c.item_number_id= e.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.size_number_id and d.id=e.pre_cost_emb_cost_dtls_id    and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1 $budgetPoCon";
    // echo $emReqSql;die();

    $emReqRes = sql_select($emReqSql);  
    $emReqQtyArr = array();       
    foreach ($emReqRes as $key => $row) 
    {
        $costingPer = $costing_per_arr[$row['JOB_NO']];
        if($costingPer==1) $pcs_value=1*12;
        else if($costingPer==2) $pcs_value=1*1;
        else if($costingPer==3) $pcs_value=2*12;
        else if($costingPer==4) $pcs_value=3*12;
        else if($costingPer==5) $pcs_value=4*12;
        $gmtsitemRatio = $gmtsitemRatioArray[$row['JOB_NO']][$row['ITEM_NUMBER_ID']];
        $requirment=$row['CONS_DZN_GMTS_MST'];
        $reqQty = ($row['PLAN_CUT_QNTY']/$gmtsitemRatio)*($requirment/$pcs_value);
        // echo "(".$row['PLAN_CUT_QNTY']."/".$gmtsitemRatio.")*(".$requirment."/".$pcs_value.")<br>";

        $emReqQtyArr[$row['INT_REF']][$row['EMB_NAME']] += $reqQty*12;
    }*/
    /*======================================================================================/
    /                                    gmts prod qty                                      /
    /======================================================================================*/
    $sql="SELECT c.grouping,d.season_buyer_wise as season,to_char(c.shipment_date,'MON-YYYY') as MONTH_YEAR,
    SUM(CASE WHEN a.production_type=1 THEN b.production_qnty END) as TOTALCUT,
    SUM(CASE WHEN a.production_type=4 THEN b.production_qnty END) as TOTALINPUT,
    SUM(CASE WHEN a.production_type=3 and a.embel_name=1 THEN b.production_qnty ELSE 0 END) as TOTALSPRINTING,
    SUM(CASE WHEN a.production_type=3 and a.embel_name=2 THEN b.production_qnty ELSE 0 END) as TOTALSEMBRO,
    SUM(CASE WHEN a.production_type=3 and a.embel_name=1 THEN b.reject_qty ELSE 0 END) as PRINTINGREJ,
    SUM(CASE WHEN a.production_type=3 and a.embel_name=2 THEN b.reject_qty ELSE 0 END) as EMBROREJ,
    SUM(CASE WHEN a.production_type=5 THEN b.production_qnty ELSE 0 END) as TOTALSEWING,
    SUM(CASE WHEN a.production_type=8 THEN b.production_qnty ELSE 0 END) as TOTALFINISH,
    SUM(CASE WHEN a.production_type=2 THEN b.production_qnty ELSE 0 END) as TOTAEMBISSUE,
    SUM(CASE WHEN a.production_type=3 THEN b.production_qnty ELSE 0 END) as TOTAEMBREC
    from pro_garments_production_mst a,pro_garments_production_dtls b,wo_po_break_down c,wo_po_details_master d
    WHERE d.id=c.job_id and a.id=b.mst_id and a.po_break_down_id=c.id and a.status_active=1 and a.is_deleted=0 and b.status_active=1  and b.is_deleted=0 $poCon group by c.grouping,d.season_buyer_wise,c.shipment_date";
    // echo $sql;
    $dataArray=sql_select($sql);
    $prod_data_array = array();
    foreach($dataArray as $row)
    {  
        $prod_data_array[$row['GROUPING']]['cut_qty']     += $row['TOTALCUT'];
        $prod_data_array[$row['GROUPING']]['input_qty']   += $row['TOTALINPUT'];
        $prod_data_array[$row['GROUPING']]['sewing_qty']  += $row['TOTALSEWING'];
        $prod_data_array[$row['GROUPING']]['finish_qty']  += $row['TOTALFINISH'];
        $prod_data_array[$row['GROUPING']]['emb_issue']   += $row['TOTAEMBISSUE'];
        $prod_data_array[$row['GROUPING']]['emb_rcv']     += $row['TOTAEMBREC'];
        $prod_data_array[$row['GROUPING']]['print_qty']   += $row['TOTALSPRINTING'];
        $prod_data_array[$row['GROUPING']]['embro_qty']   += $row['TOTALSEMBRO'];
        $prod_data_array[$row['GROUPING']]['print_rej']   += $row['PRINTINGREJ'];
        $prod_data_array[$row['GROUPING']]['embro_rej']   += $row['EMBROREJ'];
    
    }
    unset($dataArray);
    /*======================================================================================/
    /                                    ex-factory qty                                     /
    /======================================================================================*/
    $ex=sql_select( "SELECT b.grouping,c.season_buyer_wise as season,to_char(b.shipment_date,'MON-YYYY') as MONTH_YEAR, sum(a.ex_factory_qnty) as EX_FACTORY_QNTY from pro_ex_factory_mst a,wo_po_break_down b,wo_po_details_master c where c.id=b.job_id and b.id=a.po_break_down_id and a.status_active=1 $poCon3 and a.is_deleted=0 group by b.grouping,c.season_buyer_wise,b.shipment_date order by b.shipment_date");
    $ex_qnty_array = array();
    foreach ($ex as $row) 
    {
        $ex_qnty_array[$row['GROUPING']]  += $row['EX_FACTORY_QNTY'];
    }    
    $season_library = return_library_array("select id, season_name from lib_buyer_season where status_active =1 and is_deleted=0", "id", "season_name");
    
    ob_start();
    ?>
    <div style="width:100%;"> 
        <style type="text/css">        
            .GridViewScrollHeader TH, .GridViewScrollHeader TD 
            {
                padding: 2px 4px;
                font-weight: normal;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                text-align: left;
                vertical-align: middle;
            }

            .GridViewScrollHeader TH{
                background-image: -webkit-linear-gradient( rgb(194,220,255) 10%, rgb(136,170,214) 96%);
                border: 1px solid #8DAFDA;
                color:#444;
                font-size: 13px;
                font-weight: bold;
                text-align: center;
                line-height: 12px;
                height: 25px;
            }

            .GridViewScrollItem TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
               /* background-color: #FFFFFF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollItemFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #E9F3FF;*/
                color: #000000;
                vertical-align: middle;
            }

            .GridViewScrollFooterFreeze TD {
                 padding: 2px 4px;
                white-space: nowrap;
                border-right: 1px solid #e6e6e6;
                border-top: 1px solid #e6e6e6;
                border-bottom: 1px solid #e6e6e6;
                /*background-color: #F4F4F4;*/
                color: #000000;
                vertical-align: middle;
                font-weight: 700;
                background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB));
            }
            tr.GridViewScrollItemFreeze:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            tr.footerTr:last-child TD{ background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #F0F0F0), color-stop(100%, #DBDBDB)); }
            html {
              --scrollbarBG: #CFD8DC;
              --thumbBG: #8ec5fc;
            }
            body::-webkit-scrollbar {
              width: 11px;
            }
            body {
              scrollbar-width: thin;
              scrollbar-color: var(--thumbBG) var(--scrollbarBG);
            }
            body::-webkit-scrollbar-track {
              background: var(--scrollbarBG);
            }
            body::-webkit-scrollbar-thumb {
              background-color: var(--thumbBG) ;
              border-radius: 6px;
              border: 3px solid var(--scrollbarBG);
            }
        </style>          
        <fieldset>
            <table width="100%" cellpadding="0" cellspacing="0">
                <tr><td colspan="31" align="center" style="font-size:22px;">Buyer : <? echo $buyer_short_name_arr[$buyer_id]; ?></td></tr>
                <tr><td colspan="31" align="center" style="font-size:16px;">Season : <? echo $season_library[$season];?></td></tr>
            </table>
            <table id="gvMain" style="width: 100%; border-collapse: collapse;" border="1" rules="all"  class="rpt_table"> 
                <thead>
                    <tr class="GridViewScrollHeader"> 
                        <th>Sl</th>
                        <th>Int. Ref.</th>
                        <th>QTY</th>
                        <th>Grey Req</th>
                        <th>Yarn Alloc</th>
                        <th>Alloc Bal</th>
                        <th>Grey Prod.</th>
                        <th>Grey Bal</th>
                        <th>Dyeing</th>
                        <th>Dyeing Bal</th>
                        <th>Fab Req Prod</th> 
                        <th>Fab Rcvd Prod</th>
                        <th>Balance</th>
                        <th>Fab Req Pur</th> 
                        <th>Fab Rcvd Pur</th>
                        <th>Balance</th>
                        <th>Cut Qc</th>
                        <th>Cut Bal</th>
                        <th>Print Req</th>
                        <th>Print Bal</th>
                        <th>Embo Req</th>
                        <th>Embo Bal</th>
                        <th>Sew Input</th>
                        <th>Input Bal</th>
                        <th>Output</th>
                        <th>Output Bal</th>
                        <th>Fin Qty</th>
                        <th>Fin Bal</th>
                        <th>Ship Qty</th>
                        <th>Ship Bal</th>
                   </tr>
                </thead>
                <tbody>
                    <? 
                    $i=1;
                    $gr_order_qty   = 0;
                    $gr_order_val   = 0;
                    $gr_grey_req    = 0;
                    $gr_yarn_alloc  = 0;
                    $gr_alloc_bal   = 0;
                    $gr_grey_qty    = 0;
                    $gr_grey_bal    = 0;
                    $gr_dyeing_qty  = 0;
                    $gr_dyeing_bal  = 0;
                    $gr_fab_req     = 0;
                    $gr_fab_rcvd    = 0;
                    $gr_fab_bal     = 0;
                    $gr_fab_req_pur = 0;
                    $gr_fab_rcvd_pur= 0;
                    $gr_fab_bal_pur = 0;
                    $gr_cuting_qc   = 0;
                    $gr_cuting_bal  = 0;
                    $gr_print_req   = 0;
                    $gr_print_bal   = 0;
                    $gr_embro_req   = 0;
                    $gr_embro_bal   = 0;
                    $gr_input_qty   = 0;
                    $gr_input_bal   = 0;
                    $gr_output_qty  = 0;
                    $gr_output_bal  = 0;
                    $gr_fin_qty     = 0;
                    $gr_fin_bal     = 0;
                    $gr_ship_qty    = 0;
                    $gr_ship_bal    = 0;
                    foreach ($data_array as $int_ref => $row) 
                    {                        
                        $po_qty         = $row['po_quantity'];
                        $grey_req       = $gf_qnty_array[$int_ref];
                        $yarn_alloc     = $yarn_allocation_arr[$int_ref];
                        $alloc_bal      = $grey_req - $yarn_alloc;
                        $grey_prod      = $gp_qty_array[$int_ref];
                        $grey_bal       = $grey_req - $grey_prod;
                        $fav_avable_qty = $fabrics_avl_qnty_array[$int_ref][1];
                        $ff_qty         = $ff_qnty_array[$int_ref][1];
                        $fab_bal        = $ff_qty - $fav_avable_qty;
                        $fav_avable_qty_pur= $fabrics_avl_qnty_array[$int_ref][2];
                        $ff_qty_pur     = $ff_qnty_array[$int_ref][2];
                        $fab_bal_pur    = $ff_qty_pur - $fav_avable_qty_pur;
                        $dyeing_qty     = $daying_qnty_array[$int_ref];
                        $dyeing_out_qty = $dyeingProdOutArr[$int_ref];
                        $dyeing_bal     = $grey_req - ($dyeing_qty+$dyeing_out_qty);
                        $lay_cut_qty    = $lay_cut_data_array[$int_ref];
                        $cutting_bal    = $row['po_quantity'] - $lay_cut_qty;

                        $print_req      = $emReqQtyArr[$int_ref][1];
                        $print_qty      = $prod_data_array[$int_ref]['print_qty'];
                        $print_rej      = $prod_data_array[$int_ref]['print_rej'];
                        $print_bal      = $print_req - ($print_qty - $print_rej);
                        $embro_req      = $emReqQtyArr[$int_ref][2];
                        $embro_qty      = $prod_data_array[$int_ref]['embro_qty'];
                        $embro_rej      = $prod_data_array[$int_ref]['embro_rej'];
                        $embro_bal      = $embro_req - ($embro_qty - $embro_rej);
                        $sewing_in      = $prod_data_array[$int_ref]['input_qty'];
                        $sewing_out     = $prod_data_array[$int_ref]['sewing_qty'];
                        $input_bal      = $row['po_quantity'] - $sewing_in;
                        $output_bal     = $row['po_quantity'] - $sewing_out;
                        $finish_qty     = $prod_data_array[$int_ref]['finish_qty'];
                        $finish_bal     = $row['po_quantity'] - $finish_qty;
                        $ship_qty       = $ex_qnty_array[$int_ref];
                        $ship_bal       = $row['po_quantity'] - $ship_qty;

                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                        ?>
                        <tr class="GridViewScrollItem" bgcolor="<? echo $bgcolor; ?>" onclick="change_color('str_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="str_<? echo $i; ?>" style="font-size:12px;" valign="middle">
                            <td><? echo $i; ?></td>
                            <td> <? echo $int_ref;?> </td>
                            <td align="right"><? echo fn_number_format($row['po_quantity'],0); ?></td>
                            <td align="right"><? echo fn_number_format($grey_req,0); ?></td>
                            <td align="right"><? echo fn_number_format($yarn_alloc,0); ?></td>
                            <td align="right"><? echo fn_number_format($alloc_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($grey_prod,0); ?></td>
                            <td align="right"><? echo fn_number_format($grey_bal,0); ?></td>
                            <td align="right" title="Inhouse=<?=$dyeing_qty.',Outbound='.$dyeing_out_qty;?>">
                                <? echo fn_number_format(($dyeing_qty+$dyeing_out_qty),0); ?>
                            </td>
                            <td align="right"><? echo fn_number_format($dyeing_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($ff_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($fav_avable_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($fab_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($ff_qty_pur,0); ?></td>
                            <td align="right"><? echo fn_number_format($fav_avable_qty_pur,0); ?></td>
                            <td align="right"><? echo fn_number_format($fab_bal_pur,0); ?></td>
                            <td align="right"><? echo fn_number_format($lay_cut_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($cutting_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($print_req,0); ?></td>
                            <td align="right"><? echo fn_number_format($print_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($embro_req,0); ?></td>
                            <td align="right"><? echo fn_number_format($embro_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($sewing_in,0); ?></td>
                            <td align="right"><? echo fn_number_format($input_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($sewing_out,0); ?></td>
                            <td align="right"><? echo fn_number_format($output_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($finish_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($finish_bal,0); ?></td>
                            <td align="right"><? echo fn_number_format($ship_qty,0); ?></td>
                            <td align="right"><? echo fn_number_format($ship_bal,0); ?></td>
                        </tr>
                        <? 
                        $i++;
                        $gr_order_qty   += $row['po_quantity'];
                        $gr_order_val   += $row['total_price'];
                        $gr_grey_req    += $grey_req;
                        $gr_yarn_alloc  += $yarn_alloc;
                        $gr_alloc_bal   += $alloc_bal;
                        $gr_grey_qty    += $grey_prod;
                        $gr_grey_bal    += $grey_bal;
                        $gr_dyeing_qty  += $dyeing_qty+$dyeing_out_qty;
                        $gr_dyeing_bal  += $dyeing_bal;
                        $gr_fab_req     += $ff_qty;
                        $gr_fab_rcvd    += $fav_avable_qty;
                        $gr_fab_bal     += $fab_bal;
                        $gr_fab_req_pur += $ff_qty_pur;
                        $gr_fab_rcvd_pur+= $fav_avable_qty_pur;
                        $gr_fab_bal_pur += $fab_bal_pur;
                        $gr_cuting_qc   += $lay_cut_qty;
                        $gr_cuting_bal  += $cutting_bal;
                        $gr_print_req   += $print_req;
                        $gr_print_bal   += $print_bal;
                        $gr_embro_req   += $embro_req;
                        $gr_embro_bal   += $embro_bal;
                        $gr_input_qty   += $sewing_in;
                        $gr_input_bal   += $input_bal;
                        $gr_output_qty  += $sewing_out;
                        $gr_output_bal  += $output_bal;
                        $gr_fin_qty     += $finish_qty;
                        $gr_fin_bal     += $finish_bal;
                        $gr_ship_qty    += $ship_qty;
                        $gr_ship_bal    += $ship_bal;
                    }
                    
                   ?>
                </tbody>
                <tr class="GridViewScrollItem footerTr">
                    <td><div class="gridViewScrollHelper"></div></td>   
                    <td align="right">Total </td>   
                    <td align="right"><? echo fn_number_format($gr_order_qty,0);?></td> 
                    <td align="right"><? echo fn_number_format($gr_grey_req,0);?></td> 
                    <td align="right"><? echo fn_number_format($gr_yarn_alloc,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_alloc_bal,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_grey_qty,0);?></td>    
                    <td align="right"><? echo fn_number_format($gr_grey_bal,0);?></td>  
                    <td align="right"><? echo fn_number_format($gr_dyeing_qty,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_dyeing_bal,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_fab_req,0);?></td> 
                    <td align="right"><? echo fn_number_format($gr_fab_rcvd,0);?></td> 
                    <td align="right"><? echo fn_number_format($gr_fab_bal,0);?></td>  
                    <td align="right"><? echo fn_number_format($gr_fab_req_pur,0);?></td> 
                    <td align="right"><? echo fn_number_format($gr_fab_rcvd_pur,0);?></td> 
                    <td align="right"><? echo fn_number_format($gr_fab_bal_pur,0);?></td>
                    <td align="right"><? echo fn_number_format($gr_cuting_qc,0);?></td> 
                    <td align="right"><? echo fn_number_format($gr_cuting_bal,0);?></td>
                    <td align="right"><? echo fn_number_format($gr_print_req,0);?></td>    
                    <td align="right"><? echo fn_number_format($gr_print_bal,0);?></td>    
                    <td align="right"><? echo fn_number_format($gr_embro_req,0);?></td>    
                    <td align="right"><? echo fn_number_format($gr_embro_bal,0);?></td>  
                    <td align="right"><? echo fn_number_format($gr_input_qty,0);?></td>    
                    <td align="right"><? echo fn_number_format($gr_input_bal,0);?></td>    
                    <td align="right"><? echo fn_number_format($gr_output_qty,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_output_bal,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_fin_qty,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_fin_bal,0);?></td>   
                    <td align="right"><? echo fn_number_format($gr_ship_qty,0);?></td>  
                    <td align="right"><? echo fn_number_format($gr_ship_bal,0);?></td>    
                </tr>
                
            </table>
        </fieldset>
    </div>
    <script type="text/javascript" src="../../../../js/gridviewscroll.js"></script>
        <script type="text/javascript">
            var gridViewScroll = null;
            fnGridView = function () {
                gridViewScroll = new GridViewScroll({
                    elementID: "gvMain",
                    width: screen.width-75,
                    // width: 1335,
                    height: 380,
                    freezeColumn: true,
                    freezeFooter: true,
                    freezeColumnCssClass: "GridViewScrollItemFreeze",
                    freezeFooterCssClass: "GridViewScrollFooterFreeze",
                    freezeHeaderRowCount: 1,
                    freezeColumnCount: 3,
                    onscroll: function (scrollTop, scrollLeft) {
                        console.log(scrollTop + " - " + scrollLeft);
                    }
                });
                gridViewScroll.enhance();
            }
            function getScrollPosition() {
                var position = gridViewScroll.scrollPosition;
                alert("scrollTop: " + position.scrollTop + ", scrollLeft: " + position.scrollLeft);
            }
            function setScrollPosition() {
                var scrollPosition = { scrollTop: 50, scrollLeft: 50};

                gridViewScroll.scrollPosition = scrollPosition;
            }
            fnGridView();
            //=================================================
            
        </script>
    <?
}

if($action=="open_actual_po_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_country = return_library_array("select id,country_name from lib_country", "id", "country_name");
    extract($_REQUEST);
    
    // ====================================== ITEM AND COLOR ==================================
    $sql = "SELECT a.job_no,a.ID, a.ACC_PO_NO, b.GMTS_ITEM, b.GMTS_COLOR_ID, b.PO_QTY as ACC_PO_QTY,b.unit_value, a.ACC_SHIP_DATE,b.COUNTRY_ID from wo_po_acc_po_info a, wo_po_acc_po_info_dtls b where a.id=b.mst_id and b.po_break_down_id=$po_id and a.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.gmts_item <> 0 and a.acc_po_status=1 order by a.ACC_SHIP_DATE";
    // echo $sql;die();
    $sqlRes = sql_select($sql);
    $countryDataArray = array();
    $shipDataArray = array();
    $ItemDataArray = array();
    $job_no = '';
    foreach ($sqlRes as $val) 
    {
       $countryDataArray[strtotime($val['ACC_SHIP_DATE'])][$val['ACC_PO_NO']][$val['COUNTRY_ID']]['qty'] += $val['ACC_PO_QTY'];
       $countryDataArray[strtotime($val['ACC_SHIP_DATE'])][$val['ACC_PO_NO']][$val['COUNTRY_ID']]['value'] += $val['UNIT_VALUE'];
       $countryDataArray[strtotime($val['ACC_SHIP_DATE'])][$val['ACC_PO_NO']][$val['COUNTRY_ID']]['id'] .= $val['ID'].",";

       $shipDataArray[strtotime($val['ACC_SHIP_DATE'])][$val['ACC_PO_NO']][$val['GMTS_ITEM']][$lib_color[$val['GMTS_COLOR_ID']]]['qty'] += $val['ACC_PO_QTY'];
       $shipDataArray[strtotime($val['ACC_SHIP_DATE'])][$val['ACC_PO_NO']][$val['GMTS_ITEM']][$lib_color[$val['GMTS_COLOR_ID']]]['color_id'] = $val['GMTS_COLOR_ID'];
       $ItemDataArray[$val['GMTS_ITEM']][$lib_color[$val['GMTS_COLOR_ID']]][strtotime($val['ACC_SHIP_DATE'])][$val['ACC_PO_NO']]['qty'] += $val['ACC_PO_QTY'];
       $ItemDataArray[$val['GMTS_ITEM']][$lib_color[$val['GMTS_COLOR_ID']]][strtotime($val['ACC_SHIP_DATE'])][$val['ACC_PO_NO']]['color_id'] = $val['GMTS_COLOR_ID'];

       $job_no = $val['JOB_NO'];
    }
    // echo "<pre>";print_r($countryDataArray);echo "</pre>";

    // =================================== gmts fin data ===================================
    $sql = "SELECT a.id,c.COUNTRY_ID, b.ACTUAL_PO_ID,b.prod_qty,b.reject_qty from pro_garments_production_mst a, pro_garments_prod_actual_po_details b,wo_po_acc_po_info_dtls c where a.id=b.mst_id and c.id=b.ACTUAL_PO_DTLS_ID and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.po_break_down_id=$po_id and b.prod_qty>0 and a.production_type=8";
    // echo $sql;die;
    $res = sql_select($sql);
    $gmts_qty_array = array();
    foreach ($res as $val) 
    {
        $gmts_qty_array[$val['ACTUAL_PO_ID']][$val['COUNTRY_ID']]['qty'] += $val['PROD_QTY'];
        $gmts_qty_array[$val['ACTUAL_PO_ID']][$val['COUNTRY_ID']]['reject_qty'] += $val['REJECT_QTY'];
       
    }
    // echo $qty;die;
    // echo "<pre>";print_r($gmts_qty_array);echo "</pre>";

    // =================================== inspection data ===================================
    $sql = "SELECT a.inspection_level,a.inspected_by,b.ACTUAL_PO_ID,b.ACTUAL_PO_QNTY,b.COUNTRY_ID,b.FINISHING_QNTY,b.CUML_INSPECTION_QNTY,b.CURRENT_INSPECTION_QNTY,b.MINOR_QNTY,b.MAJOR_QNTY,b.CRITICAL_QNTY,b.ACCEPTABLE_QNTY,b.INSPECTION_STATUS from pro_buyer_inspection a, pro_buyer_inspection_dtls b where a.id=b.mst_id  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$job_no' ";
    // echo $sql;die;
    $res = sql_select($sql);
    $insp_qty_array = array();
    foreach ($res as $val) 
    {
        $insp_qty_array[$val['ACTUAL_PO_ID']][$val['COUNTRY_ID']][$val['INSPECTION_LEVEL']][$val['INSPECTION_STATUS']]['qty'] += $val['PROD_QTY'];
       
    }
    // echo $qty;die;
    // echo "<pre>";print_r($gmts_qty_array);echo "</pre>";

    // =================================== ex-factory data ===================================
    $sql = "SELECT a.ID,c.COUNTRY_ID, b.ACTUAL_PO_ID,b.EX_FACT_QTY from pro_ex_factory_mst a, pro_ex_factory_actual_po_details b,wo_po_acc_po_info_dtls c where a.id=b.mst_id and c.id=b.ACTUAL_PO_DTLS_ID and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.po_break_down_id=$po_id and a.ex_factory_qnty is not null";
    //echo $sql;
    $res = sql_select($sql);
    $ex_qty_array = array();
    $mst_id_chk_array = array();
    $qty = 0;
    foreach ($res as $val) 
    {
        $ex_qty_array[$val['ACTUAL_PO_ID']][$val['COUNTRY_ID']] += $val['EX_FACT_QTY'];
        $qty += $val['EX_FACT_QTY'];
    }
    // echo $qty;die;
    // echo "<pre>";print_r($ex_qty_array);echo "</pre>";

    //==================================== getting rowspan no =================================
    $rowspan = array();
    $po_rowspan = array();
    $po_rowspan2 = array();
    $itm_rowspan = array();
    $itm_rowspan2 = array();
    foreach ($shipDataArray as $ship_date => $ship_dateData) 
    {
        foreach ($ship_dateData as $poId => $poData) 
        {
            foreach ($poData as $itemId => $itemData) 
            {
                foreach ($itemData as $colorId => $row) 
                {
                    $rowspan[$ship_date]++;
                    $itm_rowspan[$ship_date][$poId][$itemId] = $itemId;
                    $itm_rowspan2[$ship_date][$poId][$itemId]++;
                    $po_rowspan[$ship_date][$poId] = $poId;
                    $po_rowspan2[$ship_date][$poId]++;
                }
            }
        }
    }
    // echo "<pre>";print_r($itm_rowspan);die();
    $shipdate_wise_item_count = array();
    $po_wise_item_count = array();
    // ================================
    foreach ($itm_rowspan as $dt => $dt_val) 
    {
        foreach ($dt_val as $po => $po_val) 
        {
            foreach ($po_val as $item => $row) 
            {
                $shipdate_wise_item_count[$dt]++;
                $po_wise_item_count[$dt][$po]++;
            }
        }
    }
    // echo "<pre>";print_r($po_wise_item_count);die();
    // =============================
    $rowspansd = array();
    $item_rowspan = array();
    $color_rowspan = array();
    $color_rowspan2 = array();
    foreach ($ItemDataArray as $itemId => $itemData) 
    {
        foreach ($itemData as $colorId => $colorData) 
        {
            foreach ($colorData as $shipDate => $shipDateData) 
            {
                foreach ($shipDateData as $po => $row) 
                {
                    $rowspansd[$itemId][$colorId][$shipDate]++;
                    $item_rowspan[$itemId]++;
                    $color_rowspan[$itemId][$colorId] = $colorId;
                    $color_rowspan2[$itemId][$colorId]++;
                }
            }
        }
    }
    // echo "<pre>";print_r($color_rowspan);echo "</pre>";

    // ==================================================
    $ship_date_rowspan = array();
    $ship_date_po_rowspan = array();
    foreach ($countryDataArray as $ship_date => $ship_dateData) 
    {
        foreach ($ship_dateData as $poId => $poData) 
        {
            foreach ($poData as $countryId => $countryData) 
            {                
                $ship_date_rowspan[$ship_date]++;
                $ship_date_po_rowspan[$ship_date][$poId]++;
            }
        }
    }
    ?>  
    <style type="text/css">
        th,td{
            word-wrap: break-word;
            word-break: break-all;
        }
    </style>  
    
    <fieldset class="main" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0" border="0"  rules="all" width="100%">
                <caption style="font-size: 18px"><b>IR No: <? echo $ir; ?></b></caption>
                <thead>                    
                    <tr>
                        <td colspan="12" width="100%" style="font-size: 18px"><hr></td>
                    </tr>
                    <tr>
                        <td colspan="12" width="100%" style="font-size: 18px;text-align: center;"><b>PO Details by Date</b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <!-- ===================================== 1st part start ================================== -->
        <div class="first_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1160">
                <thead>
                    <tr>
                        <th width="70">Ship Date</th>
                        <th width="150">PO No</th>
                        <th width="100">Country</th>
                        <th width="60">PO Qty</th>
                        <th width="60">Rate</th>
                        <th width="60">Amount</th>
                        <th width="60">Fin Qty</th>
                        <th width="60">Fin Rej Qty</th>
                        <th width="60">Fin. Bal.</th>
                        <th width="60">Pre Final</th>
                        <th width="60">Pre Final Bal</th>
                        <th width="60">Final</th>
                        <th width="60">Final Bal</th>
                        <th width="60">Ex-factory</th>
                        <th width="60">Ex Value</th>
                        <th width="60">Ex-factory Bal</th>
                        <th >Ex Bal Value</th>
                    </tr>
                </thead>
            </table>
            <div style="max-height: 200px; overflow-y: scroll;width: 1180px">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1160">
                    <tbody>
                        <?
                        $i=0;
                        $gr_po_tot = 0;
                        $ex_tot = 0;
                        $ex_bal_tot = 0;
                        $grand_total = array();
                        foreach ($countryDataArray as $shipDate => $shipData) 
                        {
                            $ship_date_tot = 0;
                            $ex_date_tot = 0;
                            $ex_date_bal_tot = 0;
                            $dt=0;
                            $date_wise_total = array();
                            foreach ($shipData as $poName => $poData) 
                            {
                                $pp=0;
                                foreach ($poData as $countryId => $row) 
                                { 
                                    $accids = array_unique(array_filter(explode(",", $row['id'])));
                                    $ex_qty = 0;
                                    $fin_qty = 0;
                                    $fin_rej_qty = 0;
                                    $pre_final_qty = 0;
                                    $final_qty = 0;
                                    $final_bal = 0;
                                    $pre_final_bal = 0;
                                    foreach ($accids as $val) 
                                    {
                                        $ex_qty += $ex_qty_array[$val][$countryId];
                                        //echo "<pre>".$val."__".$countryId."=".$ex_qty_array[$val][$countryId]."</pre>";
                                        $fin_qty += $gmts_qty_array[$val][$countryId]['qty'];
                                        $fin_rej_qty += $gmts_qty_array[$val][$countryId]['reject_qty'];

                                        $pre_final_qty += $insp_qty_array[$val][$countryId][1][1]['qty'];
                                        $final_qty += $insp_qty_array[$val][$countryId][2][1]['qty'];
                                    }

                                    $ex_bal = $row['qty'] - $ex_qty;
                                    $avg_unit_price = $row['value']/$row['qty'];                                    
                                    
                                    $req_qty = $req_qty_array[$itemId][$colorId]*12;
                                    $fin_bal = $row['qty'] - $fin_qty;

                                    $pre_final_bal = $fin_bal - $pre_final_qty;
                                    $final_bal = $fin_qty - $final_qty;
                                    $exf_value = $ex_qty*$avg_unit_price;
                                    $exf_value_balance = $row['value'] - $exf_value;
                                    
                                    $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                    ?>                        
                                    <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">     
                                        <? if($dt==0){?>                                      
                                        <td valign="middle" rowspan="<?=$ship_date_rowspan[$shipDate];?>" align="center" width="70" ><p><? echo date('d-M-Y',$shipDate); ?></td>
                                        <? $dt++;} if($pp==0){?>
                                        <td valign="middle" rowspan="<?=$ship_date_po_rowspan[$shipDate][$poName];?>" width="150" align="left"><?=$poName;?></td>
                                        <? $pp++;}?>
                                        <td width="100" title="<?=$countryId;?>" align="left"><?=$lib_country[$countryId];?></td>
                                        <td width="60" align="right"><? echo fn_number_format($row['qty'],0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($avg_unit_price,2);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($row['value'],0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($fin_qty,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($fin_rej_qty,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($fin_bal,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($pre_final_qty,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($pre_final_bal,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($final_qty,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($final_bal,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($ex_qty,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($exf_value,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($ex_bal,0);?></td>
                                        <td  align="right"><? echo fn_number_format($row['value']-$exf_value,0);?></td>
                                    </tr>
                                    <?
                                    $i++; 
                                    $ship_date_tot += $row['qty'];
                                    $gr_po_tot += $row['qty'];
                                    $ex_tot += $ex_qty;
                                    $ex_bal_tot += $ex_bal;
                                    $ex_date_tot += $ex_qty;
                                    $ex_date_bal_tot += $ex_bal;

                                    $date_wise_total['po_qty']        += fn_number_format($row['qty'],4,".","");
                                    $date_wise_total['value']         += fn_number_format($row['value'],4,".","");
                                    $date_wise_total['fin_qty']       += fn_number_format($fin_qty,4,".","");
                                    $date_wise_total['fin_rej_qty']   += fn_number_format($fin_rej_qty,4,".","");
                                    $date_wise_total['pre_final_qty'] += fn_number_format($row['pre_final_qty'],4,".","");
                                    $date_wise_total['final_qty']     += fn_number_format($final_qty,4,".","");
                                    $date_wise_total['ex_qty']        += fn_number_format($ex_qty,4,".","");
                                    $date_wise_total['exf_value']     += fn_number_format($exf_value,4,".","");


                                    $grand_total['po_qty']        += fn_number_format($row['qty'],4,".","");
                                    $grand_total['value']         += fn_number_format($row['value'],4,".","");
                                    $grand_total['fin_qty']       += fn_number_format($fin_qty,4,".","");
                                    $grand_total['fin_rej_qty']   += fn_number_format($fin_rej_qty,4,".","");
                                    $grand_total['pre_final_qty'] += fn_number_format($row['pre_final_qty'],4,".","");
                                    $grand_total['final_qty']     += fn_number_format($final_qty,4,".","");

                                    $grand_total['ex_qty']        += fn_number_format($ex_qty,4,".","");
                                    $grand_total['exf_value']     += fn_number_format($exf_value,4,".","");
                                }                         
                            }  
                            ?>
                            <tr style="background: #cddcdc;font-weight: bold;text-align: right;">
                                <td></td>
                                <td></td>
                                <td>Date Total</td>
                                <td><?=fn_number_format($ship_date_tot,0);?></td>
                                <td></td>
                                <td><?=fn_number_format($date_wise_total['value'],0);?></td>
                                <td><?=fn_number_format($date_wise_total['fin_qty'],0);?></td>
                                <td><?=fn_number_format($date_wise_total['fin_rej_qty'],0);?></td>
                                <td><?=fn_number_format($date_wise_total['po_qty']-$date_wise_total['fin_qty'],0);?></td>
                                <td><?=fn_number_format($date_wise_total['pre_final_qty'],0);?></td>
                                <td><?=fn_number_format($date_wise_total['fin_qty']-$date_wise_total['pre_final_qty'],0);?></td>
                                <td><?=fn_number_format($date_wise_total['final_qty'],0);?></td>
                                <td><?=fn_number_format($date_wise_total['fin_qty']-$date_wise_total['final_qty'],0);?></td>
                                <td><?=fn_number_format($date_wise_total['ex_qty'],0);?></td>
                                <td><?=fn_number_format($date_wise_total['exf_value'],0);?></td>
                                <td><?=fn_number_format($date_wise_total['po_qty']-$date_wise_total['ex_qty'],0);?></td>
                                <td><?=fn_number_format($date_wise_total['value']-$date_wise_total['exf_value'],0);?></td>
                            </tr>
                            <?                                     
                        }
                        ?>
                    </tbody>
                </table>
            </div>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1160">
                <tfoot>
                    <tr>
                        <th width="70"></th>
                        <th width="150"></th>
                        <th width="100">Grand Total</th>
                        <th width="60"><? echo fn_number_format($gr_po_tot,0);?></th>
                        <th width="60"></th>
                        <th width="60"><?=fn_number_format($grand_total['value'],0);?></th>
                        <th width="60"><?=fn_number_format($grand_total['fin_qty'],0);?></th>
                        <th width="60"><?=fn_number_format($grand_total['fin_rej_qty'],0);?></th>
                        <th width="60"><?=fn_number_format($grand_total['po_qty']-$grand_total['fin_qty'],0);?></th>
                        <th width="60"><?=fn_number_format($grand_total['pre_final_qty'],0);?></th>
                        <th width="60"><?=fn_number_format($grand_total['fin_qty']-$grand_total['pre_final_qty'],0);?></th>
                        <th width="60"><?=fn_number_format($grand_total['final_qty'],0);?></th>
                        <th width="60"><?=fn_number_format($grand_total['fin_qty']-$grand_total['final_qty'],0);?></th>
                        <th width="60"><?=fn_number_format($grand_total['ex_qty'],0);?></th>
                        <th width="60"><?=fn_number_format($grand_total['exf_value'],0);?></th>
                        <th width="60"><?=fn_number_format($grand_total['po_qty']-$grand_total['ex_qty'],0);?></th>
                        <th><?=fn_number_format($grand_total['value']-$grand_total['exf_value'],0);?></th>
                    </tr>
                
                </tfoot>
                
            </table>
        </div>
        <!-- ===================================== 2nd part start ================================== -->
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0" border="0"  rules="all" width="530">
                <thead> 
                    <tr>
                        <td colspan="5" width="100%" style="font-size: 18px;text-align: center;"><b>Item Wise Distribution</b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="second_part" style="margin-top:10px;">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="530">
                <thead>
                    <tr>
                        <th width="100">Ship Date</th>
                        <th width="100">PO No</th>
                        <th width="100">Item Name</th>
                        <th width="150">Color</th>
                        <th width="80">Gmts Qty</th>
                    </tr>
                </thead>
            </table>
            <div style="max-height: 200px; overflow-y: scroll;width: 550px">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="530">
                    <tbody>
                        <?
                        $i=0;
                        $gr_tot = 0;
                        $spd = 0;
                        $spd_chk = array();
                        $po_count = 0;
                        foreach ($shipDataArray as $shipDate => $shipData) 
                        {
                            if(!in_array($shipDate, $spd_chk))
                            {
                                $spd_chk[$shipDate] = $shipDate;
                                $spd = 0;
                            }
                            $ship_date_tot = 0;
                            foreach ($shipData as $poName => $poData) 
                            {
                                $po_count++;
                                $p=0;
                                $po_tot = 0;
                                foreach ($poData as $itemId => $itemData) 
                                {  
                                    $item_tot = 0;
                                    $it = 0;
                                    ksort($itemData);
                                    foreach ($itemData as $color_name => $row) 
                                    {
                                        $colorId = $row['color_id'];
                                        $req_qty = $req_qty_array[$itemId][$colorId]*12;
                                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                        ?>                        
                                        <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">        
                                            <?
                                            if($spd==0){
                                            $tot_row_span = $rowspan[$shipDate]+count($po_rowspan[$shipDate])+$shipdate_wise_item_count[$shipDate]+1;
                                            // echo $shipdate_wise_item_count[$shipDate];
                                            ?>
                                            <td valign="middle" rowspan="<? echo $tot_row_span; ?>" width="100"><? echo date('d-M-Y',$shipDate); ?></td> 
                                            <? 
                                            $spd++;} 

                                            if($p==0)
                                            {
                                                if(count($po_rowspan[$shipDate])==$po_count)
                                                {
                                                    $rc = 2;
                                                    $po_count = 0;
                                                }
                                                else
                                                {
                                                    $rc = 1;
                                                }
                                                $tot_row_span = $po_rowspan2[$shipDate][$poName]+$po_wise_item_count[$shipDate][$poName]+$rc;
                                                // echo $po_rowspan2[$shipDate][$poName]."+".$po_wise_item_count[$shipDate][$poName]."+".$rc."<br>";
                                            ?>                              
                                            <td valign="middle" rowspan="<? echo $tot_row_span; ?>" width="100"><p><? echo $poName;?></p></td>
                                            <? $p++;} 
                                            if($it==0){?>
                                            <td valign="middle" rowspan="<? echo $itm_rowspan2[$shipDate][$poName][$itemId]; ?>" width="100"><p><? echo $garments_item[$itemId];?></p></td>
                                            <? $it++;} ?>
                                            <td width="100" title="<?=$color_name;?>" ><p><?=substr($color_name,0,22);?></p></td>
                                            <td width="80" align="right"><? echo fn_number_format($row['qty'],0);?></td>
                                        </tr>
                                        <?
                                        $i++;     
                                        $item_tot += $row['qty'];                               
                                        $po_tot += $row['qty'];                               
                                        $ship_date_tot += $row['qty'];                               
                                        $gr_tot += $row['qty'];                               
                                    }
                                    ?>
                                    <tr style="background: #dccdcd; font-weight: bold;text-align: right;">
                                        <!-- <td width="100"></td> -->
                                        <!-- <td width="100"></td> -->
                                        <td width="100"></td>
                                        <td width="150"> Item Total</td>
                                        <td width="80"><? echo fn_number_format($item_tot,0);?></td>
                                    </tr>
                                    <?
                                }
                                ?>
                                <tr style="background: #dccdcd; font-weight: bold;text-align: right;">
                                    <!-- <td width="100"></td> -->
                                    <!-- <td width="100"></td> -->
                                    <td width="100"></td>
                                    <td width="150"> PO Total</td>
                                    <td width="80"><? echo fn_number_format($po_tot,0);?></td>
                                </tr>
                                <?
                                        
                            }
                            ?>
                            <tr style="background: #cdcddc; font-weight: bold;text-align: right;">
                                <!-- <td width="100"></td> -->
                                <!-- <td width="100"></td> -->
                                <td width="100"></td>
                                <td width="150"> Ship Date Total</td>
                                <td width="80"><? echo fn_number_format($ship_date_tot,0);?></td>
                            </tr>
                            <?
                        }
                        ?>
                    </tbody>
                </table>
            </div>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="530">
                <tfoot>
                    <tr>
                        <th width="100"></th>
                        <th width="100"></th>
                        <th width="100"></th>
                        <th width="150"> Grand Total</th>
                        <th width="80"><? echo fn_number_format($gr_tot,0);?></th>
                    </tr>
                </tfoot>
                
            </table>
        </div>
        <!-- ===================================== 3rd part start ================================== -->
        <div class="third_part" style="margin-top:10px;width: 500px;">
            <div class="header_part">
                <table class="" cellpadding="0" cellspacing="0"  rules="all" width="100%">
                    <caption style="font-size: 18px"><b>Color Wise Distribution</b></caption>
                    <thead>
                        <tr>
                            <td colspan="5" width="100%"></td>
                        </tr>
                    </thead>
                </table>
            </div>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="530" align="left">
                <thead>
                    <tr>
                        <th width="100">Item Name</th>
                        <th width="150">Color</th>
                        <th width="100">Ship Date</th>
                        <th width="100">PO No</th>
                        <th width="80">Gmts Qty</th>
                    </tr>
                </thead>
            </table>
            <div style="max-height: 200px; overflow-y: scroll;width: 550px;float: left;">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="530" align="left">
                    <tbody>
                        <?
                        // $i=0;
                        $gr_tot = 0;
                        $itm=0;
                        $chk_array = array();
                        $col_count = 0;
                        foreach ($ItemDataArray as $itemId => $itemData) 
                        {
                            if(!in_array($itemId, $chk_array))
                            {
                                $chk_array[$itemId] = $itemId;
                                $itm = 0;
                            }
                            $item_tot = 0;
                            ksort($itemData);
                            foreach ($itemData as $color_name => $colorData) 
                            {
                                $col_count++;
                                $color_tot = 0;
                                $c=0;
                                foreach ($colorData as $shipDate => $shipData) 
                                {  
                                    $spd = 0;
                                    foreach ($shipData as $poName => $row) 
                                    {
                                        $colorId = $row['color_id'];
                                        $req_qty = $req_qty_array[$itemId][$colorId]*12;
                                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                        ?>                        
                                        <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">   
                                            <?
                                            if($itm==0){
                                            $tot_row_span = $item_rowspan[$itemId]+count($color_rowspan[$itemId])+1;

                                            ?>
                                            <td valign="middle" rowspan="<? echo $tot_row_span; ?>" width="100" title="<? echo $itemId;?>" ><p><? echo $garments_item[$itemId];?></p></td>
                                            <? $itm++;} if($c==0){
                                                if(count($color_rowspan[$itemId])==$col_count)
                                                {
                                                    $rc = 2;
                                                    $col_count = 0;
                                                }
                                                else
                                                {
                                                    $rc = 1;
                                                }
                                                $tot_row_span = $color_rowspan2[$itemId][$color_name]+$rc;
                                            ?>
                                            <td valign="middle" title="<?=$color_name;?>" rowspan="<? echo $tot_row_span;?>" width="150" ><p><? echo substr($color_name,0,22);?></p></td>     
                                            <? $c++;} if($spd==0){?>
                                                <td rowspan="<? echo $rowspansd[$itemId][$color_name][$shipDate]; ?>" width="100" valign="middle"><? echo date('d-M-Y',$shipDate); ?></td> 
                                            <? $spd++;} ?>                              
                                            <td width="100"><p><? echo $poName;?></p></td>
                                            <td width="80" align="right"><? echo fn_number_format($row['qty'],0);?></td>
                                        </tr>
                                        <?
                                        $i++;       
                                        $color_tot += $row['qty'];                            
                                        $item_tot += $row['qty'];                            
                                        $gr_tot += $row['qty'];                            
                                    }
                                }
                                ?>
                                <tr style="background: #dccdcd; font-weight: bold;text-align: right;">
                                    <!-- <td width="100"></td> -->
                                    <!-- <td width="100"></td> -->
                                    <td width="100"></td>
                                    <td width="100"> Color Total</td>
                                    <td width="80"><? echo fn_number_format($color_tot,0);?></td>
                                </tr>
                                <?
                                        
                            }
                            ?>
                            <tr style="background: #dccdcd; font-weight: bold;text-align: right;">
                                <!-- <td width="100"></td> -->
                                <!-- <td width="100"></td> -->
                                <td width="100"></td>
                                <td width="100"> Item Total</td>
                                <td width="80"><? echo fn_number_format($item_tot,0);?></td>
                            </tr>
                            <?
                        }
                        ?>
                    </tbody>
                </table>
            </div>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="530" align="left">
                <tfoot>
                    <tr>
                        <th width="100"></th>
                        <th width="150"></th>
                        <th width="100"></th>
                        <th width="100"> Grand Total</th>
                        <th width="80"><? echo fn_number_format($gr_tot,0);?></th>
                    </tr>
                </tfoot>
                
            </table>
        </div>
    </fieldset>
    <?
}

if($action=="open_actual_po_popup__")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_country = return_library_array("select id,country_name from lib_country", "id", "country_name");
    extract($_REQUEST);
    
    // ====================================== ITEM AND COLOR ==================================
    $sql = "SELECT a.job_no,a.ID, a.ACC_PO_NO, b.GMTS_ITEM, b.GMTS_COLOR_ID, b.PO_QTY as ACC_PO_QTY,b.unit_value, a.ACC_SHIP_DATE,b.COUNTRY_ID from wo_po_acc_po_info a, wo_po_acc_po_info_dtls b where a.id=b.mst_id and b.po_break_down_id=$po_id and a.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.gmts_item <> 0 and a.acc_po_status=1 order by a.ACC_SHIP_DATE";
    // echo $sql;die();
    $sqlRes = sql_select($sql);
    $countryDataArray = array();
    $shipDataArray = array();
    $ItemDataArray = array();
    $job_no = '';
    foreach ($sqlRes as $val) 
    {
       $countryDataArray[strtotime($val['ACC_SHIP_DATE'])][$val['ACC_PO_NO']][$val['COUNTRY_ID']]['qty'] += $val['ACC_PO_QTY'];
       $countryDataArray[strtotime($val['ACC_SHIP_DATE'])][$val['ACC_PO_NO']][$val['COUNTRY_ID']]['value'] += $val['UNIT_VALUE'];
       $countryDataArray[strtotime($val['ACC_SHIP_DATE'])][$val['ACC_PO_NO']][$val['COUNTRY_ID']]['id'] .= $val['ID'].",";

       $shipDataArray[strtotime($val['ACC_SHIP_DATE'])][$val['ACC_PO_NO']][$val['GMTS_ITEM']][$lib_color[$val['GMTS_COLOR_ID']]]['qty'] += $val['ACC_PO_QTY'];
       $shipDataArray[strtotime($val['ACC_SHIP_DATE'])][$val['ACC_PO_NO']][$val['GMTS_ITEM']][$lib_color[$val['GMTS_COLOR_ID']]]['color_id'] = $val['GMTS_COLOR_ID'];
       $ItemDataArray[$val['GMTS_ITEM']][$lib_color[$val['GMTS_COLOR_ID']]][strtotime($val['ACC_SHIP_DATE'])][$val['ACC_PO_NO']]['qty'] += $val['ACC_PO_QTY'];
       $ItemDataArray[$val['GMTS_ITEM']][$lib_color[$val['GMTS_COLOR_ID']]][strtotime($val['ACC_SHIP_DATE'])][$val['ACC_PO_NO']]['color_id'] = $val['GMTS_COLOR_ID'];

       $job_no = $val['JOB_NO'];
    }
    // echo "<pre>";print_r($countryDataArray);echo "</pre>";

    // =================================== gmts fin data ===================================
    $sql = "SELECT a.id,c.COUNTRY_ID, b.ACTUAL_PO_ID,b.prod_qty,b.reject_qty from pro_garments_production_mst a, pro_garments_prod_actual_po_details b,wo_po_acc_po_info_dtls c where a.id=b.mst_id and c.id=b.ACTUAL_PO_DTLS_ID and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.po_break_down_id=$po_id and b.prod_qty>0 and a.production_type=8";
    // echo $sql;die;
    $res = sql_select($sql);
    $gmts_qty_array = array();
    foreach ($res as $val) 
    {
        $gmts_qty_array[$val['ACTUAL_PO_ID']][$val['COUNTRY_ID']]['qty'] += $val['PROD_QTY'];
        $gmts_qty_array[$val['ACTUAL_PO_ID']][$val['COUNTRY_ID']]['reject_qty'] += $val['REJECT_QTY'];
       
    }
    // echo $qty;die;
    // echo "<pre>";print_r($gmts_qty_array);echo "</pre>";

    // =================================== inspection data ===================================
    $sql = "SELECT a.inspection_level,a.inspected_by,b.ACTUAL_PO_ID,b.ACTUAL_PO_QNTY,b.COUNTRY_ID,b.FINISHING_QNTY,b.CUML_INSPECTION_QNTY,b.CURRENT_INSPECTION_QNTY,b.MINOR_QNTY,b.MAJOR_QNTY,b.CRITICAL_QNTY,b.ACCEPTABLE_QNTY,b.INSPECTION_STATUS from pro_buyer_inspection a, pro_buyer_inspection_dtls b where a.id=b.mst_id  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.job_no='$job_no' ";
    // echo $sql;die;
    $res = sql_select($sql);
    $insp_qty_array = array();
    foreach ($res as $val) 
    {
        $insp_qty_array[$val['ACTUAL_PO_ID']][$val['COUNTRY_ID']][$val['INSPECTION_LEVEL']][$val['INSPECTION_STATUS']]['qty'] += $val['PROD_QTY'];
       
    }
    // echo $qty;die;
    // echo "<pre>";print_r($gmts_qty_array);echo "</pre>";

    // =================================== ex-factory data ===================================
    $sql = "SELECT a.id,c.COUNTRY_ID, b.ACTUAL_PO_ID,a.ex_factory_qnty from pro_ex_factory_mst a, pro_ex_factory_actual_po_details b,wo_po_acc_po_info_dtls c where a.id=b.mst_id and c.id=b.ACTUAL_PO_DTLS_ID and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.po_break_down_id=$po_id and a.ex_factory_qnty is not null";
    // echo $sql;
    $res = sql_select($sql);
    $ex_qty_array = array();
    $mst_id_chk_array = array();
    $qty = 0;
    foreach ($res as $val) 
    {
        if($mst_id_chk_array[$val['ID']]=="")
        {
            $ex_qty_array[$val['ACTUAL_PO_ID']][$val['COUNTRY_ID']] += $val['EX_FACTORY_QNTY'];
            $mst_id_chk_array[$val['ID']] = $val['ID'];
            $qty += $val['EX_FACTORY_QNTY'];
        }
    }
    // echo $qty;die;
    // echo "<pre>";print_r($ex_qty_array);echo "</pre>";

    //==================================== getting rowspan no =================================
    $rowspan = array();
    $po_rowspan = array();
    $po_rowspan2 = array();
    $itm_rowspan = array();
    $itm_rowspan2 = array();
    foreach ($shipDataArray as $ship_date => $ship_dateData) 
    {
        foreach ($ship_dateData as $poId => $poData) 
        {
            foreach ($poData as $itemId => $itemData) 
            {
                foreach ($itemData as $colorId => $row) 
                {
                    $rowspan[$ship_date]++;
                    $itm_rowspan[$ship_date][$poId][$itemId] = $itemId;
                    $itm_rowspan2[$ship_date][$poId][$itemId]++;
                    $po_rowspan[$ship_date][$poId] = $poId;
                    $po_rowspan2[$ship_date][$poId]++;
                }
            }
        }
    }
    // echo "<pre>";print_r($itm_rowspan);die();
    $shipdate_wise_item_count = array();
    $po_wise_item_count = array();
    // ================================
    foreach ($itm_rowspan as $dt => $dt_val) 
    {
        foreach ($dt_val as $po => $po_val) 
        {
            foreach ($po_val as $item => $row) 
            {
                $shipdate_wise_item_count[$dt]++;
                $po_wise_item_count[$dt][$po]++;
            }
        }
    }
    // echo "<pre>";print_r($po_wise_item_count);die();
    // =============================
    $rowspansd = array();
    $item_rowspan = array();
    $color_rowspan = array();
    $color_rowspan2 = array();
    foreach ($ItemDataArray as $itemId => $itemData) 
    {
        foreach ($itemData as $colorId => $colorData) 
        {
            foreach ($colorData as $shipDate => $shipDateData) 
            {
                foreach ($shipDateData as $po => $row) 
                {
                    $rowspansd[$itemId][$colorId][$shipDate]++;
                    $item_rowspan[$itemId]++;
                    $color_rowspan[$itemId][$colorId] = $colorId;
                    $color_rowspan2[$itemId][$colorId]++;
                }
            }
        }
    }
    // echo "<pre>";print_r($color_rowspan);echo "</pre>";

    // ==================================================
    $ship_date_rowspan = array();
    $ship_date_po_rowspan = array();
    foreach ($countryDataArray as $ship_date => $ship_dateData) 
    {
        foreach ($ship_dateData as $poId => $poData) 
        {
            foreach ($poData as $countryId => $countryData) 
            {                
                $ship_date_rowspan[$ship_date]++;
                $ship_date_po_rowspan[$ship_date][$poId]++;
            }
        }
    }
    ?>    
    
    <fieldset class="main" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0" border="0"  rules="all" width="100%">
                <caption style="font-size: 18px"><b>IR No: <? echo $ir; ?></b></caption>
                <thead>                    
                    <tr>
                        <td colspan="12" width="100%" style="font-size: 18px"><hr></td>
                    </tr>
                    <tr>
                        <td colspan="12" width="100%" style="font-size: 18px;text-align: center;"><b>PO Details by Date</b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <!-- ===================================== 1st part start ================================== -->
        <div class="first_part">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1160">
                <thead>
                    <tr>
                        <th width="70">Ship Date</th>
                        <th width="100">PO No</th>
                        <th width="150">Country</th>
                        <th width="60">PO Qty</th>
                        <th width="60">Rate</th>
                        <th width="60">Amount</th>
                        <th width="60">Fin Qty</th>
                        <th width="60">Fin Rej Qty</th>
                        <th width="60">Fin. Bal.</th>
                        <th width="60">Pre Final</th>
                        <th width="60">Pre Final Bal</th>
                        <th width="60">Final</th>
                        <th width="60">Final Bal</th>
                        <th width="60">Ex-factory</th>
                        <th width="60">Ex Value</th>
                        <th width="60">Ex-factory Bal</th>
                        <th width="60">Ex Bal Value</th>
                    </tr>
                </thead>
            </table>
            <div style="max-height: 200px; overflow-y: scroll;width: 1180px">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1160">
                    <tbody>
                        <?
                        $i=0;
                        $gr_po_tot = 0;
                        $ex_tot = 0;
                        $ex_bal_tot = 0;
                        foreach ($countryDataArray as $shipDate => $shipData) 
                        {
                            $ship_date_tot = 0;
                            $ex_date_tot = 0;
                            $ex_date_bal_tot = 0;
                            $dt=0;
                            foreach ($shipData as $poName => $poData) 
                            {
                                $pp=0;
                                foreach ($poData as $countryId => $row) 
                                { 
                                    $accids = array_unique(array_filter(explode(",", $row['id'])));
                                    $ex_qty = 0;
                                    $fin_qty = 0;
                                    $fin_rej_qty = 0;
                                    $pre_final_qty = 0;
                                    $final_qty = 0;
                                    $final_bal = 0;
                                    $pre_final_bal = 0;
                                    foreach ($accids as $val) 
                                    {
                                        $ex_qty += $ex_qty_array[$val][$countryId];
                                        $fin_qty += $gmts_qty_array[$val][$countryId]['qty'];
                                        $fin_rej_qty += $gmts_qty_array[$val][$countryId]['reject_qty'];

                                        $pre_final_qty += $insp_qty_array[$val][$countryId][1][1]['qty'];
                                        $final_qty += $insp_qty_array[$val][$countryId][2][1]['qty'];
                                    }

                                    $ex_bal = $row['qty'] - $ex_qty;
                                    $avg_unit_price = $row['value']/$row['qty'];                                    
                                    
                                    $req_qty = $req_qty_array[$itemId][$colorId]*12;
                                    $fin_bal = $row['qty'] - $fin_qty;

                                    $pre_final_bal = $fin_bal - $pre_final_qty;
                                    $final_bal = $fin_qty - $final_qty;
                                    $exf_value = $ex_qty*$avg_unit_price;
                                    $exf_value_balance = $row['value'] - $exf_value;
                                    
                                    $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                    ?>                        
                                    <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">     
                                        <? if($dt==0){?>                                      
                                        <td valign="middle" rowspan="<?=$ship_date_rowspan[$shipDate];?>" align="center" width="70" ><p><? echo date('d-M-Y',$shipDate); ?></td>
                                        <? $dt++;} if($pp==0){?>
                                        <td valign="middle" rowspan="<?=$ship_date_po_rowspan[$shipDate][$poName];?>" width="100" align="left"><?=$poName;?></td>
                                        <? $pp++;}?>
                                        <td width="150" title="<?=$countryId;?>" align="left"><?=$lib_country[$countryId];?></td>
                                        <td width="60" align="right"><? echo fn_number_format($row['qty'],0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($avg_unit_price,2);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($row['value'],2);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($fin_qty,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($fin_rej_qty,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($fin_bal,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($pre_final_qty,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($pre_final_bal,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($final_qty,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($final_bal,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($ex_qty,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($exf_value,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($ex_bal,0);?></td>
                                        <td width="60" align="right"><? echo fn_number_format($a,0);?></td>
                                    </tr>
                                    <?
                                    $i++; 
                                    $ship_date_tot += $row['qty'];
                                    $gr_po_tot += $row['qty'];
                                    $ex_tot += $ex_qty;
                                    $ex_bal_tot += $ex_bal;
                                    $ex_date_tot += $ex_qty;
                                    $ex_date_bal_tot += $ex_bal;
                                }                         
                            }  
                            ?>
                            <tr style="background: #cddcdc;font-weight: bold;text-align: right;">
                                <td></td>
                                <td></td>
                                <td>Date Total</td>
                                <td><?=fn_number_format($ship_date_tot,0);?></td>
                                <td></td>
                                <td><?=fn_number_format($a,0);?></td>
                                <td><?=fn_number_format($a,0);?></td>
                                <td><?=fn_number_format($a,0);?></td>
                                <td><?=fn_number_format($a,0);?></td>
                                <td><?=fn_number_format($a,0);?></td>
                                <td><?=fn_number_format($a,0);?></td>
                                <td><?=fn_number_format($a,0);?></td>
                                <td><?=fn_number_format($a,0);?></td>
                                <td><?=fn_number_format($ex_date_tot,0);?></td>
                                <td><?=fn_number_format($a,0);?></td>
                                <td><?=fn_number_format($ex_date_bal_tot,0);?></td>
                                <td><?=fn_number_format($a,0);?></td>
                            </tr>
                            <?                                     
                        }
                        ?>
                    </tbody>
                </table>
            </div>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="1160">
                <tfoot>
                    <tr>
                        <th width="70"></th>
                        <th width="100"></th>
                        <th width="150">Grand Total</th>
                        <th width="60"><? echo fn_number_format($gr_po_tot,0);?></th>
                        <th width="60"></th>
                        <th width="60"><? echo fn_number_format($gr_tot,0);?></th>
                        <th width="60"><? echo fn_number_format($gr_tot,0);?></th>
                        <th width="60"><? echo fn_number_format($gr_tot,0);?></th>
                        <th width="60"><? echo fn_number_format($gr_tot,0);?></th>
                        <th width="60"><? echo fn_number_format($gr_tot,0);?></th>
                        <th width="60"><? echo fn_number_format($gr_tot,0);?></th>
                        <th width="60"><? echo fn_number_format($gr_tot,0);?></th>
                        <th width="60"><? echo fn_number_format($gr_tot,0);?></th>
                        <th width="60"><? echo fn_number_format($ex_tot,0);?></th>
                        <th width="60"><? echo fn_number_format($gr_tot,0);?></th>
                        <th width="60"><? echo fn_number_format($ex_bal_tot,0);?></th>
                        <th width="60"><? echo fn_number_format($gr_tot,0);?></th>
                    </tr>
                </tfoot>
                
            </table>
        </div>
        <!-- ===================================== 2nd part start ================================== -->
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0" border="0"  rules="all" width="530">
                <thead> 
                    <tr>
                        <td colspan="5" width="100%" style="font-size: 18px;text-align: center;"><b>Item Wise Distribution</b></td>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="second_part" style="margin-top:10px;">
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="530">
                <thead>
                    <tr>
                        <th width="100">Ship Date</th>
                        <th width="100">PO No</th>
                        <th width="100">Item Name</th>
                        <th width="150">Color</th>
                        <th width="80">Gmts Qty</th>
                    </tr>
                </thead>
            </table>
            <div style="max-height: 200px; overflow-y: scroll;width: 550px">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="530">
                    <tbody>
                        <?
                        $i=0;
                        $gr_tot = 0;
                        $spd = 0;
                        $spd_chk = array();
                        $po_count = 0;
                        foreach ($shipDataArray as $shipDate => $shipData) 
                        {
                            if(!in_array($shipDate, $spd_chk))
                            {
                                $spd_chk[$shipDate] = $shipDate;
                                $spd = 0;
                            }
                            $ship_date_tot = 0;
                            foreach ($shipData as $poName => $poData) 
                            {
                                $po_count++;
                                $p=0;
                                $po_tot = 0;
                                foreach ($poData as $itemId => $itemData) 
                                {  
                                    $item_tot = 0;
                                    $it = 0;
                                    ksort($itemData);
                                    foreach ($itemData as $color_name => $row) 
                                    {
                                        $colorId = $row['color_id'];
                                        $req_qty = $req_qty_array[$itemId][$colorId]*12;
                                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                        ?>                        
                                        <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">        
                                            <?
                                            if($spd==0){
                                            $tot_row_span = $rowspan[$shipDate]+count($po_rowspan[$shipDate])+$shipdate_wise_item_count[$shipDate]+1;
                                            // echo $shipdate_wise_item_count[$shipDate];
                                            ?>
                                            <td valign="middle" rowspan="<? echo $tot_row_span; ?>" width="100"><? echo date('d-M-Y',$shipDate); ?></td> 
                                            <? 
                                            $spd++;} 

                                            if($p==0)
                                            {
                                                if(count($po_rowspan[$shipDate])==$po_count)
                                                {
                                                    $rc = 2;
                                                    $po_count = 0;
                                                }
                                                else
                                                {
                                                    $rc = 1;
                                                }
                                                $tot_row_span = $po_rowspan2[$shipDate][$poName]+$po_wise_item_count[$shipDate][$poName]+$rc;
                                                // echo $po_rowspan2[$shipDate][$poName]."+".$po_wise_item_count[$shipDate][$poName]."+".$rc."<br>";
                                            ?>                              
                                            <td valign="middle" rowspan="<? echo $tot_row_span; ?>" width="100"><p><? echo $poName;?></p></td>
                                            <? $p++;} 
                                            if($it==0){?>
                                            <td valign="middle" rowspan="<? echo $itm_rowspan2[$shipDate][$poName][$itemId]; ?>" width="100"><p><? echo $garments_item[$itemId];?></p></td>
                                            <? $it++;} ?>
                                            <td width="100" title="<?=$color_name;?>" ><p><?=substr($color_name,0,22);?></p></td>
                                            <td width="80" align="right"><? echo fn_number_format($row['qty'],0);?></td>
                                        </tr>
                                        <?
                                        $i++;     
                                        $item_tot += $row['qty'];                               
                                        $po_tot += $row['qty'];                               
                                        $ship_date_tot += $row['qty'];                               
                                        $gr_tot += $row['qty'];                               
                                    }
                                    ?>
                                    <tr style="background: #dccdcd; font-weight: bold;text-align: right;">
                                        <!-- <td width="100"></td> -->
                                        <!-- <td width="100"></td> -->
                                        <td width="100"></td>
                                        <td width="150"> Item Total</td>
                                        <td width="80"><? echo fn_number_format($item_tot,0);?></td>
                                    </tr>
                                    <?
                                }
                                ?>
                                <tr style="background: #dccdcd; font-weight: bold;text-align: right;">
                                    <!-- <td width="100"></td> -->
                                    <!-- <td width="100"></td> -->
                                    <td width="100"></td>
                                    <td width="150"> PO Total</td>
                                    <td width="80"><? echo fn_number_format($po_tot,0);?></td>
                                </tr>
                                <?
                                        
                            }
                            ?>
                            <tr style="background: #cdcddc; font-weight: bold;text-align: right;">
                                <!-- <td width="100"></td> -->
                                <!-- <td width="100"></td> -->
                                <td width="100"></td>
                                <td width="150"> Ship Date Total</td>
                                <td width="80"><? echo fn_number_format($ship_date_tot,0);?></td>
                            </tr>
                            <?
                        }
                        ?>
                    </tbody>
                </table>
            </div>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="530">
                <tfoot>
                    <tr>
                        <th width="100"></th>
                        <th width="100"></th>
                        <th width="100"></th>
                        <th width="150"> Grand Total</th>
                        <th width="80"><? echo fn_number_format($gr_tot,0);?></th>
                    </tr>
                </tfoot>
                
            </table>
        </div>
        <!-- ===================================== 3rd part start ================================== -->
        <div class="third_part" style="margin-top:10px;width: 500px;">
            <div class="header_part">
                <table class="" cellpadding="0" cellspacing="0"  rules="all" width="100%">
                    <caption style="font-size: 18px"><b>Color Wise Distribution</b></caption>
                    <thead>
                        <tr>
                            <td colspan="5" width="100%"></td>
                        </tr>
                    </thead>
                </table>
            </div>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="530" align="left">
                <thead>
                    <tr>
                        <th width="100">Item Name</th>
                        <th width="150">Color</th>
                        <th width="100">Ship Date</th>
                        <th width="100">PO No</th>
                        <th width="80">Gmts Qty</th>
                    </tr>
                </thead>
            </table>
            <div style="max-height: 200px; overflow-y: scroll;width: 550px;float: left;">
                <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="530" align="left">
                    <tbody>
                        <?
                        // $i=0;
                        $gr_tot = 0;
                        $itm=0;
                        $chk_array = array();
                        $col_count = 0;
                        foreach ($ItemDataArray as $itemId => $itemData) 
                        {
                            if(!in_array($itemId, $chk_array))
                            {
                                $chk_array[$itemId] = $itemId;
                                $itm = 0;
                            }
                            $item_tot = 0;
                            ksort($itemData);
                            foreach ($itemData as $color_name => $colorData) 
                            {
                                $col_count++;
                                $color_tot = 0;
                                $c=0;
                                foreach ($colorData as $shipDate => $shipData) 
                                {  
                                    $spd = 0;
                                    foreach ($shipData as $poName => $row) 
                                    {
                                        $colorId = $row['color_id'];
                                        $req_qty = $req_qty_array[$itemId][$colorId]*12;
                                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                        ?>                        
                                        <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('trs_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="trs_<? echo $i; ?>">   
                                            <?
                                            if($itm==0){
                                            $tot_row_span = $item_rowspan[$itemId]+count($color_rowspan[$itemId])+1;

                                            ?>
                                            <td valign="middle" rowspan="<? echo $tot_row_span; ?>" width="100" title="<? echo $itemId;?>" ><p><? echo $garments_item[$itemId];?></p></td>
                                            <? $itm++;} if($c==0){
                                                if(count($color_rowspan[$itemId])==$col_count)
                                                {
                                                    $rc = 2;
                                                    $col_count = 0;
                                                }
                                                else
                                                {
                                                    $rc = 1;
                                                }
                                                $tot_row_span = $color_rowspan2[$itemId][$color_name]+$rc;
                                            ?>
                                            <td valign="middle" title="<?=$color_name;?>" rowspan="<? echo $tot_row_span;?>" width="150" ><p><? echo substr($color_name,0,22);?></p></td>     
                                            <? $c++;} if($spd==0){?>
                                                <td rowspan="<? echo $rowspansd[$itemId][$color_name][$shipDate]; ?>" width="100" valign="middle"><? echo date('d-M-Y',$shipDate); ?></td> 
                                            <? $spd++;} ?>                              
                                            <td width="100"><p><? echo $poName;?></p></td>
                                            <td width="80" align="right"><? echo fn_number_format($row['qty'],0);?></td>
                                        </tr>
                                        <?
                                        $i++;       
                                        $color_tot += $row['qty'];                            
                                        $item_tot += $row['qty'];                            
                                        $gr_tot += $row['qty'];                            
                                    }
                                }
                                ?>
                                <tr style="background: #dccdcd; font-weight: bold;text-align: right;">
                                    <!-- <td width="100"></td> -->
                                    <!-- <td width="100"></td> -->
                                    <td width="100"></td>
                                    <td width="100"> Color Total</td>
                                    <td width="80"><? echo fn_number_format($color_tot,0);?></td>
                                </tr>
                                <?
                                        
                            }
                            ?>
                            <tr style="background: #dccdcd; font-weight: bold;text-align: right;">
                                <!-- <td width="100"></td> -->
                                <!-- <td width="100"></td> -->
                                <td width="100"></td>
                                <td width="100"> Item Total</td>
                                <td width="80"><? echo fn_number_format($item_tot,0);?></td>
                            </tr>
                            <?
                        }
                        ?>
                    </tbody>
                </table>
            </div>
            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="530" align="left">
                <tfoot>
                    <tr>
                        <th width="100"></th>
                        <th width="150"></th>
                        <th width="100"></th>
                        <th width="100"> Grand Total</th>
                        <th width="80"><? echo fn_number_format($gr_tot,0);?></th>
                    </tr>
                </tfoot>
                
            </table>
        </div>
    </fieldset>
    <?
}

if($action == "finish_fab_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_size_arr = return_library_array("select id,size_name from lib_size", "id", "size_name");
    extract($_REQUEST);
    $data = explode("__", $po_break_down_id);
    $job_no = $data[0];
    $po_id = $data[1];

    $condition= new condition();     
    $condition->po_id_in($po_id);     
    $condition->init();
    $fabric= new fabric($condition);
    // echo $fabric->getQuery();die;
    // $fabric_data_arr=$fabric->getQtyArray_by_JobColorBodyTypeDeterminIdGsmAndDiaWidth_knitAndwoven_greyAndfinish();
    $fabric_data_arr=$fabric->getQtyArray_by_JobColorFabricColorBodyTypeDeterminIdGsmAndDiaWidth_knitAndwoven_greyAndfinish();
    // $fabric_data_arr=$fabric->getQtyArray_by_OrderFabriccostidFabriccolorAndDiaWidth_knitAndwoven_greyAndfinish();
    // echo "<pre>"; print_r($fabric_data_arr); echo "</pre>";die;
    
    // ====================================== budget data ===================================
    $sql = "SELECT c.COLOR_NUMBER_ID,c.GMTS_SIZES,c.DIA_WIDTH,a.LIB_YARN_COUNT_DETER_ID,a.BODY_PART_ID,a.FABRIC_DESCRIPTION,a.GSM_WEIGHT,a.COLOR_SIZE_SENSITIVE,a.BODY_PART_TYPE,b.CONTRAST_COLOR_ID,a.WIDTH_DIA_TYPE,a.UOM,a.FABRIC_SOURCE from wo_pre_cos_fab_co_avg_con_dtls  c join 
       wo_pre_cost_fabric_cost_dtls    a on a.id = c.pre_cost_fabric_cost_dtls_id
       LEFT JOIN wo_pre_cos_fab_co_color_dtls b
           ON     a.job_no = b.job_no
              AND a.id = b.pre_cost_fabric_cost_dtls_id
              AND b.GMTS_COLOR_ID = c.COLOR_NUMBER_ID
              AND b.status_active = 1
              AND b.is_deleted = 0
        where c.status_active=1 and a.status_active=1 and a.is_deleted=0 and a.job_no='$job_no' and c.cons !=0";
    //echo $sql;die();

    //1=pcs,12=kg,23=mtr,27=yds   
    $sql_res = sql_select($sql);
    $data_array = array();
    $contrust_qty_array = array();
    $chk_array = array();
    $color_size_construct_array = array();
    $construst_color_against_gmt_color = array();
    foreach ($sql_res as $val) 
    {
       $cons_color_key =  $val['LIB_YARN_COUNT_DETER_ID'].",".$val['GSM_WEIGHT'].",".$val['DIA_WIDTH'].",".$val['COLOR_NUMBER_ID'].",".$val['GMTS_SIZES'].",".$val['COLOR_SIZE_SENSITIVE'];
       $construst_color_against_gmt_color[$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']] = $val['CONTRAST_COLOR_ID'];
       //echo "<pre>".$val['COLOR_NUMBER_ID']."=>".$val['CONTRAST_COLOR_ID']."</pre>";
        if($val['BODY_PART_TYPE']==40 || $val['BODY_PART_TYPE']==50)
        {
            $body_part_type='Flat';
        }
        else
        {
            if($val['UOM']==12)
            {
                $body_part_type='Circular__(Kg)';
            }
            else
            {
                $body_part_type='Circular__(Yds/Meter)';
            }
        }

        if($val['COLOR_SIZE_SENSITIVE']==3)
        {
            $color_id=$val['CONTRAST_COLOR_ID'];
            $color_name=$lib_color[$val['CONTRAST_COLOR_ID']];
        }
        else
        {
            $color_id=$val['COLOR_NUMBER_ID'];
            $color_name=$lib_color[$val['COLOR_NUMBER_ID']];
        }
        $grey_fab_req_qty = 0;
        if($val['FABRIC_SOURCE']==1) // only production
        {
            $grey_fab_req_qty = array_sum($fabric_data_arr['knit']['grey'][$job_no][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['LIB_YARN_COUNT_DETER_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][1]);
        }

        $fin_fab_req_qty = 0;
        $fin_fab_pur_req_qty = 0;
        $fin_fab_req_qty = array_sum($fabric_data_arr['knit']['finish'][$job_no][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['LIB_YARN_COUNT_DETER_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][1]);

        $fin_fab_pur_req_qty = array_sum($fabric_data_arr['knit']['finish'][$job_no][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['LIB_YARN_COUNT_DETER_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][2]);

        // echo $fin_fab_req_qty ."+". $fin_fab_pur_req_qty.$body_part_type.",".$color_id.",".$str.$val['BODY_PART_TYPE']."<br>";

        $str = $val['LIB_YARN_COUNT_DETER_ID'].",".$val['GSM_WEIGHT'].",".$val['DIA_WIDTH'];
        $color_size_construct_array[$color_id][$val['GMTS_SIZES']] = $str;

        if($chk_array[$body_part_type][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$str][$val['BODY_PART_TYPE']]=="")
        {
            $data_array[$body_part_type][$color_name][$str]['color_id'] = $color_id;
			$data_array[$body_part_type][$color_name][$str]['gmt_color_id'] = $val['COLOR_NUMBER_ID'];
			$data_array[$body_part_type][$color_name][$str]['contrast_color_id'] = $val['CONTRAST_COLOR_ID'];
			$data_array[$body_part_type][$color_name][$str]['sensivity'] = $val['COLOR_SIZE_SENSITIVE'];
            $data_array[$body_part_type][$color_name][$str]['fabric'] = $val['FABRIC_DESCRIPTION'];
            $data_array[$body_part_type][$color_name][$str]['grey_fab_req_qty'] += $grey_fab_req_qty;
            $data_array[$body_part_type][$color_name][$str]['fin_fab_req_qty']  += $fin_fab_req_qty + $fin_fab_pur_req_qty;
            if($grey_fab_req_qty>0 || $fin_fab_req_qty>0 || $fin_fab_pur_req_qty>0)
            {
                $chk_array[$body_part_type][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$str][$val['BODY_PART_TYPE']]="kakku";
            }
            else
            {
                $chk_array[$body_part_type][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$str][$val['BODY_PART_TYPE']]="";
            }
        }

        if($val['COLOR_SIZE_SENSITIVE']==3)
        {
            $grey_fab_req_qty = array_sum($fabric_data_arr['knit']['grey'][$job_no][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['LIB_YARN_COUNT_DETER_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][1]) + array_sum($fabric_data_arr['knit']['grey'][$job_no][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['LIB_YARN_COUNT_DETER_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][2]);
            $fin_fab_req_qty = array_sum($fabric_data_arr['knit']['finish'][$job_no][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['LIB_YARN_COUNT_DETER_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][1])+array_sum($fabric_data_arr['knit']['finish'][$job_no][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['LIB_YARN_COUNT_DETER_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][2]);

            $contrust_qty_array[$body_part_type][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$str]['contrast_color_id'] = $val['CONTRAST_COLOR_ID'];
            $contrust_qty_array[$body_part_type][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$str]['grey_fab_req_qty'] = $grey_fab_req_qty;
            $contrust_qty_array[$body_part_type][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$str]['fin_fab_req_qty']  = $fin_fab_req_qty;
        }
    }
    // echo "<pre>";print_r($color_size_construct_array);die();
    // echo "<pre>";print_r($data_array);die();

    $gmt_color_library=array();//fabric_cost_dtls_id
    $gmt_color_data=sql_select("SELECT a.body_part_id,b.gmts_color_id, b.contrast_color_id  FROM  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b ,wo_pre_cos_fab_co_avg_con_dtls c
    WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.id=c.pre_cost_fabric_cost_dtls_id and  a.job_no='$job_no' and a.color_size_sensitive=3 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and c.cons!=0 ");
    
    foreach( $gmt_color_data as $gmt_color_row)
    {
        $gmt_color_library[$gmt_color_row[csf("gmts_color_id")]].= sizeof($gmt_color_library[$gmt_color_row[csf("gmts_color_id")]]) ? ",".$gmt_color_row[csf("contrast_color_id")] : $gmt_color_row[csf("contrast_color_id")];
    }
    // echo "<pre>";print_r($contrust_qty_array);die();


    // ===================== get contrust color wise req qty ========================
    $contrust_color_qty_array = array();
    $contrust_color_array = array();
    $gmts_color_array = array();
    foreach ($contrust_qty_array as $btype => $btype_data) 
    {
        foreach ($btype_data as $gmt_color => $gmts_color_data) 
        {
            foreach ($gmts_color_data as $contrust_color => $contrust_color_data) 
            {
                
                foreach ($contrust_color_data as $str_k => $row) 
                {
                    $gmts_color_array[$gmt_color] = $gmt_color;
                    // $gmt_color_ex = array_unique(explode(",", $gmt_color_library[$gmt_color]));
                    // foreach ($gmt_color_ex as $key => $value) 
                    // {           
                        $contrust_color_qty_array[$btype][$contrust_color][$str_k]['grey_fab_req_qty'] += $row['grey_fab_req_qty'];                
                        $contrust_color_qty_array[$btype][$contrust_color][$str_k]['fin_fab_req_qty'] += $row['fin_fab_req_qty'];
                    // }
                                    
                }
            }
        }        
    }
    // echo "<pre>";print_r($gmts_color_array);echo "</pre>";  

    // ================================ origi po qty==========================   
    $sql = "SELECT COLOR_NUMBER_ID,SIZE_NUMBER_ID, sum(ORDER_QUANTITY) as ORDER_QUANTITY from wo_po_color_size_breakdown where job_no_mst='$job_no' and status_active=1 and is_deleted=0  group by COLOR_NUMBER_ID,size_number_id";
     // echo $sql;
    $res = sql_select($sql);
    $orgGmtsQty_ = array();
    $orgContrustGmtsQty_ = array();
    foreach ($res as $val) 
    {
        $orgGmtsQty_[$val['COLOR_NUMBER_ID']][$val['SIZE_NUMBER_ID']] += $val['ORDER_QUANTITY']; 

        $gmt_color_ex = array_unique(explode(",", $gmt_color_library[$val['COLOR_NUMBER_ID']]));
        foreach ($gmt_color_ex as $key => $value) 
        {   
            if($val['COLOR_NUMBER_ID']!=$value) // check for gmts color and contrust color is same         
            {
                $orgContrustGmtsQty_[$value][$val['SIZE_NUMBER_ID']] += $val['ORDER_QUANTITY'];
            }
        }       
    }
    // echo "<pre>";print_r($orgGmtsQty_);echo "</pre>";
    
    // ============================================= acc po qty ============================================
    /* $sql = "SELECT sum(d.po_qty) AS ACC_PO_QTY, c.acc_ship_date  AS ACC_SHIP_DATE, d.GMTS_COLOR_ID, e.DIA_WIDTH, f.LIB_YARN_COUNT_DETER_ID, f.BODY_PART_ID, f.GSM_WEIGHT 
    FROM wo_po_acc_po_info c, wo_po_acc_po_info_dtls d, wo_pre_cos_fab_co_avg_con_dtls e, wo_pre_cost_fabric_cost_dtls  f 
    WHERE  c.id = d.mst_id AND f.id = e.pre_cost_fabric_cost_dtls_id AND e.po_break_down_id = c.po_break_down_id and d.GMTS_COLOR_ID=e.COLOR_NUMBER_ID and d.GMTS_SIZE_ID=e.GMTS_SIZES AND  e.cons != 0 AND c.status_active = 1 AND c.is_deleted = 0 AND d.status_active = 1 AND d.is_deleted = 0 AND d.status_active = 1 AND d.is_deleted = 0 AND c.acc_ship_date IS NOT NULL AND c.job_no = '$job_no'AND f.job_no = '$job_no'AND d.gmts_color_id <> 0 AND c.acc_po_status = 1 AND d.status_active = 1 AND f.status_active = 1 AND f.is_deleted = 0 group by c.acc_ship_date, d.GMTS_COLOR_ID, e.DIA_WIDTH, f.LIB_YARN_COUNT_DETER_ID, f.BODY_PART_ID, f.GSM_WEIGHT 
    ORDER BY c.acc_ship_date ASC"; */

    $sqlbudg = "SELECT e.COLOR_NUMBER_ID,e.GMTS_SIZES, e.DIA_WIDTH, f.LIB_YARN_COUNT_DETER_ID, f.BODY_PART_ID, f.GSM_WEIGHT 
    FROM wo_pre_cos_fab_co_avg_con_dtls e, wo_pre_cost_fabric_cost_dtls  f 
    WHERE   f.id = e.pre_cost_fabric_cost_dtls_id AND  e.cons != 0 AND f.job_no = '$job_no' AND  f.status_active = 1 AND f.is_deleted = 0 group by  e.COLOR_NUMBER_ID,e.GMTS_SIZES, e.DIA_WIDTH, f.LIB_YARN_COUNT_DETER_ID, f.BODY_PART_ID, f.GSM_WEIGHT";
    // echo $sqlbudg;
    $budRes = sql_select($sqlbudg);
    $budget_data = array();
    foreach ($budRes as $v) 
    {
        $str = $v['LIB_YARN_COUNT_DETER_ID'].",".$v['GSM_WEIGHT'].",".$v['DIA_WIDTH'].",".$v['COLOR_NUMBER_ID'].",".$v['GMTS_SIZES'];
        $str2 = $v['LIB_YARN_COUNT_DETER_ID'].",".$v['GSM_WEIGHT'].",".$v['DIA_WIDTH'];
        $budget_data[$str] = $str2;
    }
    // echo "<pre>";print_r($budget_data);echo "</pre>";
    $sql = "SELECT  d.po_qty as ACC_PO_QTY, c.acc_ship_date as  ACC_SHIP_DATE,d.GMTS_COLOR_ID,d.gmts_size_id from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join wo_po_acc_po_info c on b.id=c.po_break_down_id join wo_po_acc_po_info_dtls d on c.id=d.mst_id  where  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and c.acc_ship_date IS NOT NULL and a.job_no='$job_no' and d.gmts_color_id <> 0 and c.acc_po_status=1 order by c.acc_ship_date ASC";

    //echo $sql;die();
    $res = sql_select($sql);
    $gmtsDataArray = array();
    $shipDateArray = array();
    $colSizeShipDateArray = array();
    $colSizeAccQtyArray = array();
    $colSizeGmtQtyArray = array();
    $actContrustGmtsQty = array();
    $chk_array = array();
    foreach ($res as $val) 
    {   
        $str = $budget_data[$val['GMTS_COLOR_ID']][$val['GMTS_SIZE_ID']];
        $gmtsDataArray[$val['GMTS_COLOR_ID']][strtotime($val['ACC_SHIP_DATE'])][$str] += $val['ACC_PO_QTY'];
       $colSizeGmtQtyArray[$val['GMTS_COLOR_ID']][$val['GMTS_SIZE_ID']][strtotime($val['ACC_SHIP_DATE'])] += $val['ACC_PO_QTY'];
		// $colSizeGmtQtyArray[$val['GMTS_COLOR_ID']][$val['GMTS_SIZE_ID']][$val['ACC_SHIP_DATE']] += $val['ACC_PO_QTY'];
        $shipDateArray[strtotime($val['ACC_SHIP_DATE'])] = strtotime($val['ACC_SHIP_DATE']);
        $colSizeShipDateArray[$val['GMTS_COLOR_ID']][$val['GMTS_SIZE_ID']].= strtotime($val['ACC_SHIP_DATE']).',';

        if(in_array($val['GMTS_COLOR_ID'], $gmts_color_array))
        {
            $gmt_color_ex = array_unique(explode(",", $gmt_color_library[$val['GMTS_COLOR_ID']]));
            foreach ($gmt_color_ex as $key => $value) 
            {          
                if($val['GMTS_COLOR_ID']!=$value) // check for gmts color and contrust color is same       
                { 
                    $actContrustGmtsQty[$value][strtotime($val['ACC_SHIP_DATE'])][$str] += $val['ACC_PO_QTY'];
                    $colSizeAccQtyArray[$value][$val['GMTS_SIZE_ID']][strtotime($val['ACC_SHIP_DATE'])] += $val['ACC_PO_QTY'];
                }
            }
        }        
    }
    // echo "<pre>";
    // print_r($colSizeGmtQtyArray);
    $acc_po_qty_arr = array();
    $orgGmtsQty = array();
    $orgContrustGmtsQty = array();
	//$str = $v['LIB_YARN_COUNT_DETER_ID'].",".$v['GSM_WEIGHT'].",".$v['DIA_WIDTH'].",".$v['COLOR_NUMBER_ID'].",".$v['GMTS_SIZES'];
      //  $str2 = $v['LIB_YARN_COUNT_DETER_ID'].",".$v['GSM_WEIGHT'].",".$v['DIA_WIDTH'];
       // $budget_data[$str] = $str2;
    foreach ($budget_data as $str_key => $v) 
    {
       $ex_data = explode(",", $str_key);
        //    echo "<pre>"; print_r($ex_data);
		$totQty=$orgGmtsQty_[$ex_data[3]][$ex_data[4]]+$orgContrustGmtsQty_[$ex_data[3]][$ex_data[4]];
		//echo $totQty.'d';
		if($totQty>0)
		{
    		$orgGmtsQty[$ex_data[3]][$v] += $totQty;
            if(!empty($construst_color_against_gmt_color[$ex_data[3]]))
            {

               foreach($construst_color_against_gmt_color[$ex_data[3]] as $construst_color_id=>$const_value)
               {
                    $orgGmtsQty[$construst_color_id][$v] += $totQty;
               }
            }
		}
		
		$ac_date=rtrim($colSizeShipDateArray[$ex_data[3]][$ex_data[4]],',');
		$ac_dateArr=array_unique(explode(",",$ac_date));
		foreach($ac_dateArr as $acc_date)
		{
            $cons_color_key = $ex_data[3];
            if(!empty($construst_color_against_gmt_color[$cons_color_key]))
            {

               foreach($construst_color_against_gmt_color[$cons_color_key] as $construst_color_id=>$const_value)
               {
                    $acc_po_qty_arr[$construst_color_id][$v][$acc_date] += $colSizeGmtQtyArray[$ex_data[3]][$ex_data[4]][$acc_date];
               }
                
            }
            $acc_po_qty_arr[$ex_data[3]][$v][$acc_date] += $colSizeGmtQtyArray[$ex_data[3]][$ex_data[4]][$acc_date];
            
			// $DateStr=date('d-m-Y',$colSizeShipDateArray[$ex_data[3]][$ex_data[4]]);
			 
       	 	
		}
		
       
		

    }
    // echo "<pre>"; print_r($orgGmtsQty);die;

    /* foreach ($res as $val) 
    {
        $str = $val['LIB_YARN_COUNT_DETER_ID'].",".$val['GSM_WEIGHT'].",".$val['DIA_WIDTH'];
        if($chk_array[$val['GMTS_COLOR_ID']][strtotime($val['ACC_SHIP_DATE'])][$str]=="")
        {
            $chk_array[$val['GMTS_COLOR_ID']][strtotime($val['ACC_SHIP_DATE'])][$str] = $str;

           
            $gmtsDataArray[$val['GMTS_COLOR_ID']][strtotime($val['ACC_SHIP_DATE'])][$str] += $val['ACC_PO_QTY'];
            $shipDateArray[strtotime($val['ACC_SHIP_DATE'])] = strtotime($val['ACC_SHIP_DATE']);

            if(in_array($val['GMTS_COLOR_ID'], $gmts_color_array))
            {
                $gmt_color_ex = array_unique(explode(",", $gmt_color_library[$val['GMTS_COLOR_ID']]));
                foreach ($gmt_color_ex as $key => $value) 
                {          
                    if($val['GMTS_COLOR_ID']!=$value) // check for gmts color and contrust color is same       
                    { 
                        $actContrustGmtsQty[$value][strtotime($val['ACC_SHIP_DATE'])][$str] += $val['ACC_PO_QTY'];
                    }
                }
            }
        }
    } */
    unset($res);
    // echo "<pre>";print_r($orgGmtsQty);die();  
    

    // echo "<pre>";print_r($orgContrustGmtsQty);die();
    // ============================= grey rcv ============================
    $sql ="SELECT b.COLOR_ID,b.FEBRIC_DESCRIPTION_ID,b.GSM,b.WIDTH,b.BODY_PART_ID, c.QUANTITY 
        from inv_receive_master a, pro_grey_prod_entry_dtls b, order_wise_pro_details c 
        where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and c.po_breakdown_id=$po_id and b.color_id is not null";
    // echo $sql; 
    $sql_res = sql_select($sql);   
    $grey_rcv_array = array();
    foreach ($sql_res as $val) 
    {
        $str = $val['FEBRIC_DESCRIPTION_ID'].",".$val['GSM'].",".$val['WIDTH'];
        $grey_rcv_array[$val['COLOR_ID']][$str] += $val['QUANTITY'];
    }
    // echo "<pre>";print_r($grey_rcv_array);die();

    // ============================= batch qty ============================
    $sql ="SELECT a.COLOR_ID, b.BATCH_QNTY,c.DETARMINATION_ID,c.DIA_WIDTH,c.GSM
        from pro_batch_create_mst a, pro_batch_create_dtls b, product_details_master c 
        where a.id=b.mst_id and b.prod_id=c.id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.po_id=$po_id and a.color_id is not null and a.entry_form not in(37) and a.batch_against=1 and c.status_active=1";//
    // echo $sql; 
    $sql_res = sql_select($sql);   
    $batch_qty_array = array();
    foreach ($sql_res as $val) 
    {
        $str = $val['DETARMINATION_ID'].",".$val['GSM'].",".$val['DIA_WIDTH'];
        $batch_qty_array[$val['COLOR_ID']][$str] += $val['BATCH_QNTY'];
    }
    // echo "<pre>";print_r($batch_qty_array);die();

    // ============================= dyeing qty ============================
    $sqlDye = "SELECT a.COLOR_ID,sum(b.batch_qnty) as QTY,d.DETARMINATION_ID,d.DIA_WIDTH,d.GSM from pro_batch_create_mst a, pro_batch_create_dtls b,pro_fab_subprocess c,product_details_master d where a.id=b.mst_id and a.id=c.batch_id and b.po_id=$po_id and c.load_unload_id=2 and c.process_id='31' and c.result=1 and d.id=b.prod_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 group by a.color_id,d.detarmination_id,d.dia_width,d.gsm";
    // echo $sqlDye; 
    $sql_res = sql_select($sqlDye);   
    $dyeing_qty_array = array();
    foreach ($sql_res as $val) 
    {
        $str = $val['DETARMINATION_ID'].",".$val['GSM'].",".$val['DIA_WIDTH'];
        $dyeing_qty_array[$val['COLOR_ID']][$str] += $val['QTY'];
    }
    // echo "<pre>";print_r($dyeing_qty_array);die();    

    // ============================= finish fab qty ============================
     $sql ="SELECT b.COLOR_ID,b.FABRIC_DESCRIPTION_ID,b.GSM,b.WIDTH, c.QUANTITY 
        from inv_receive_master a, pro_finish_fabric_rcv_dtls b, order_wise_pro_details c 
        where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and c.po_breakdown_id=$po_id and b.color_id is not null and c.entry_form in (37,68)";
    // echo $sql; 
    $sql_res = sql_select($sql);   
    $fin_fab_rcv_array = array();
    foreach ($sql_res as $val) 
    {
        $str = $val['FABRIC_DESCRIPTION_ID'].",".$val['GSM'].",".$val['WIDTH'];
        $fin_fab_rcv_array[$val['COLOR_ID']][$str] += $val['QUANTITY'];
    }
    // echo "<pre>";print_r($fin_fab_rcv_array);die();

    $rowspan_fab_type = array();
    $rowspan_color = array();
    $rowspan_fab = array();
    foreach ($data_array as $ftype => $fab_val) 
    {
        foreach ($fab_val as $color_id => $color_val) 
        {
            foreach ($color_val as $dtrId => $row) 
            {
                $fab_req_qty = $row['grey_fab_req_qty'];//+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['grey_fab_req_qty'];    
                $fin_fab_req_qty = $row['fin_fab_req_qty'];//+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['fin_fab_req_qty'];   
                if($fab_req_qty >0 || $fin_fab_req_qty>0)
                {
                    $rowspan_fab_type[$ftype]++;
                    $rowspan_color[$ftype][$color_id]++;
                    $rowspan_fab[$ftype][$color_id][$dtrId]++;    
                }            
            }
        }
    }
    // echo "<pre>";print_r($grey_rcv_array);die();

    // ====================== clculate running slot blance ===============================
    $running_slot_bal_array = array();
    foreach ($data_array as $ftype => $ftype_val) 
    { 
        foreach ($ftype_val as $color_id => $color_val) 
        {
            foreach ($color_val as $str => $row) 
            {
                $color_id = $row['color_id'];
                $gmt_color_id = $row['gmt_color_id'];
                $contrast_color_id = $row['contrast_color_id'];
                $sensivity = $row['sensivity'];
                if($sensivity==3)
                {
                    $color_id=$gmt_color_id;	
                }

                // echo $color_id."=".$str."=".$grey_rcv_array[$color_id][$str]."<br>";
                $grey_rcv_qty = $grey_rcv_array[$color_id][$str];  
                $tot_grey_rcv_qty = $grey_rcv_array[$color_id][$str];
                $batch_qty_req = $batch_qty_array[$color_id][$str];     
                $tot_batch_qty_req = $batch_qty_array[$color_id][$str];     
                $dyeing_qty_req = $dyeing_qty_array[$color_id][$str]; 
                $tot_dyeing_qty_req = $dyeing_qty_array[$color_id][$str]; 
                $fin_fab_rcv_qty = $fin_fab_rcv_array[$color_id][$str];       
                $tot_fin_fab_rcv_qty = $fin_fab_rcv_array[$color_id][$str];       
                
                $grey_qty_slot = 0;
                $batch_qty_slot = 0;
                $dyeing_qty_slot = 0;
                $fin_fab_slot = 0;
                foreach ($shipDateArray as $dtkey => $dtlue) 
                {
                    $fab_req_qty = $row['grey_fab_req_qty'];//+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['grey_fab_req_qty'];
                    $orgGmtQty = $orgGmtsQty[$row['color_id']][$str]+$orgContrustGmtsQty[$color_id];
                    // $acc_po_gmts_qty = $gmtsDataArray[$color_id][$dtkey][$str]+$actContrustGmtsQty[$color_id][$dtkey][$str];
                    $acc_po_gmts_qty = $acc_po_qty_arr[$row['color_id']][$str][$dtkey];
                    $grey_qty = ($orgGmtQty>0) ? ($fab_req_qty/$orgGmtQty)*$acc_po_gmts_qty : 0;

                    $fab_req_qty = $row['fin_fab_req_qty'];//+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['fin_fab_req_qty'];
                    $orgGmtQty = $orgGmtsQty[$row['color_id']][$str]+$orgContrustGmtsQty[$color_id];
                    // $acc_po_gmts_qty = $gmtsDataArray[$color_id][$dtkey][$str]+$actContrustGmtsQty[$color_id][$dtkey][$str];
                    $acc_po_gmts_qty = $acc_po_qty_arr[$color_id][$str][$dtkey];
                    $fin_fab_qty = ($orgGmtQty>0) ? ($fab_req_qty/$orgGmtQty)*$acc_po_gmts_qty : 0;

                    if($grey_qty>0)
                    {
                        if ($grey_rcv_qty>0) 
                        {
                            $grey_qty_slot += $grey_qty;
                            $grey_rcv_qty -= $grey_qty;
                        }

                        if ($batch_qty_req>0) 
                        {
                            $batch_qty_slot += $grey_qty;
                            $batch_qty_req -= $grey_qty;
                        }

                        if ($dyeing_qty_req>0) 
                        {
                            $dyeing_qty_slot += $grey_qty;
                            $dyeing_qty_req -= $grey_qty;
                        }
                    }

                    if($fin_fab_qty>0)
                    {
                        if ($fin_fab_rcv_qty>0) 
                        {
                            $fin_fab_slot += $fin_fab_qty;
                            $fin_fab_rcv_qty -= $fin_fab_qty;
                        }
                    }
                    
                }
                $running_slot_bal_array[$ftype][$color_id][$str][1]['q'] += $grey_qty_slot - $tot_grey_rcv_qty;
                $running_slot_bal_array[$ftype][$color_id][$str][2]['q'] += $batch_qty_slot - $tot_batch_qty_req;
                $running_slot_bal_array[$ftype][$color_id][$str][3]['q'] += $dyeing_qty_slot - $tot_dyeing_qty_req;
                $running_slot_bal_array[$ftype][$color_id][$str][4]['q'] += $fin_fab_slot - $tot_fin_fab_rcv_qty;

                $running_slot_bal_array[$ftype][$color_id][$str][1]['m'] +=  $tot_grey_rcv_qty;
                $running_slot_bal_array[$ftype][$color_id][$str][2]['m'] +=  $tot_batch_qty_req;
                $running_slot_bal_array[$ftype][$color_id][$str][3]['m'] +=  $tot_dyeing_qty_req;
                $running_slot_bal_array[$ftype][$color_id][$str][4]['m'] +=  $tot_fin_fab_rcv_qty;
            }
        }
    }
    if($_SESSION['logic_erp']['user_id'] == 1)
    {
        // echo "<pre>";
        // print_r($acc_po_qty_arr);
        // echo "</pre>";
    }
    // echo "<pre>";print_r($running_slot_bal_array);die;

    // echo "<pre>";print_r($contrust_color_qty_array);echo "</pre>";
    $tbl_width = 580+(count($shipDateArray)*50);
    ob_start(); 
    ?>
    <fieldset class="first_part" style="width:<? echo $tbl_width+30;?>px;margin:15px 0;">
        <div id="buyer_wise_details_report">
            <h3>Int Ref. : <?= $intref = return_field_value("grouping", "wo_po_break_down", "id=$po_id", "grouping");;?></h3>
            <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0">            
                <thead>
                    <tr>
                        <th width="80">Fabric Type</th>
                        <th width="80">Fabric Color</th>
                        <th width="180">Fabrication</th>
                        <th width="80">Operation</th>
                        <th width="80" title="Production - Total Distribute Qty">Running Slot Bal</th>
                        <? 
                        foreach ($shipDateArray as $dtkey => $dtlue) 
                        {
                            ?>
                            <th width="50"><?= date('d-M',$dtkey); ?></th>
                            <? 
                        } 
                        ?>
                    </tr>
                </thead>
            </table>
            
            <div style="max-height: 350px; overflow-y: scroll;width: <? echo $tbl_width+20;?>px;">
                <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0"> 
                    <tbody>
                        <? 
                        $i=1;
                        foreach ($data_array as $ftype => $fab_val) 
                        {
                            ksort($fab_val);
                            $ft = 0;
                            foreach ($fab_val as $color_name => $color_val) 
                            {
                                $clr = 0;
                                foreach ($color_val as $dtrId => $row) 
                                {
                                    $fb = 0;
                                    $color_id = $row['color_id'];
                                    $orginal_con_color_id = $row['color_id'];
									$gmt_color_id = $row['gmt_color_id'];
									$contrast_color_id = $row['contrast_color_id'];
									 $sensivity = $row['sensivity'];
									if($sensivity==3)
									{
									$color_id=$gmt_color_id;	
									}
									

                                    if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";  
                                    $fab_req_qty = $row['grey_fab_req_qty'];//+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['grey_fab_req_qty'];    
                                    // echo $ftype."**".$color_id."**".$dtrId."**".$fab_req_qty."<br>";
                                    $fin_fab_req_qty = $row['fin_fab_req_qty'];//+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['fin_fab_req_qty'];   
                                    if($fab_req_qty >0 || $fin_fab_req_qty>0)
                                    {               
                                        ?>
                                        <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                            <? if($ft==0){?>
                                            <td valign="middle" width="80" align="left" rowspan="<?= $rowspan_fab_type[$ftype]*4;?>"><p><?= implode(" ", explode("__",$ftype));?></p></td>
                                            <? $ft++;} if($clr==0){ ?>
                                           
                                            <td width="80" align="left" valign="middle" title="<?=$color_name;?>" rowspan="<?= $rowspan_color[$ftype][$color_name]*4;?>"><p><?=substr($color_name,0,12);?></p></td>
                                            <? $clr++;}if($fb==0){?>
                                           
                                            <td width="180" align="left" valign="middle" rowspan="<?= $rowspan_fab[$ftype][$color_name][$dtrId]*4;?>"><p>
                                                <? 
                                                    $dtrId_ex = explode(",", $dtrId);
                                                    echo $row['fabric'].",".$dtrId_ex[1].",".$dtrId_ex[2];
                                                ?>                                                
                                            </p></td>
                                            <? $fb++;} ?>
                                            
                                            <td width="80" align="left">Gray Rcv</td>
                                            <td width="80" align="right" title="<?= fn_number_format($running_slot_bal_array[$ftype][$color_id][$dtrId][1]['m'],2);?>"><?= fn_number_format($running_slot_bal_array[$ftype][$color_id][$dtrId][1]['q'],2);?></td>
                                            <? 
                                            $grey_rcv_qty = $grey_rcv_array[$color_id][$dtrId];

                                            foreach ($shipDateArray as $dtkey => $dtlue) 
                                            {
                                                // $fab_req_qty = $row['grey_fab_req_qty']+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['grey_fab_req_qty'];
                                                $orgGmtQty = $orgGmtsQty[$row['color_id']][$dtrId];//+$orgContrustGmtsQty[$color_id];
                                                 // echo $color_id."==".$dtkey."=".$orgGmtQty."<br>";
                                                // $acc_po_gmts_qty = $gmtsDataArray[$color_id][$dtkey][$dtrId]+$actContrustGmtsQty[$color_id][$dtkey][$dtrId];
                                                //$acc_po_gmts_qty = $acc_po_qty_arr[$color_id][$dtrId][$dtkey];
                                                $acc_po_gmts_qty = $acc_po_qty_arr[$row['color_id']][$dtrId][$dtkey];
                                                if($_SESSION['logic_erp']['user_id'] == 1)
                                                {
                                                    // echo "<pre>";
                                                    // echo $orginal_con_color_id."__".$dtrId."__".$dtkey."=>".$acc_po_qty_arr[$orginal_con_color_id][$dtrId][$dtkey];
                                                    // echo "</pre>";
                                                }
                                                //  echo $color_name."==".$color_id."==".$gmtsDataArray[$color_id][$dtkey]."+".$actContrustGmtsQty[$color_id][$dtkey]."<br>";
                                                $grey_qty = ($orgGmtQty>0) ? ($fab_req_qty/$orgGmtQty)*$acc_po_gmts_qty : 0;

                                                $tdcolor="white";
                                                if($grey_rcv_qty>0)
                                                {
                                                    if($grey_qty <= $grey_rcv_qty)
                                                    {
                                                        $tdcolor = "#00d6ff";
                                                    }
                                                    elseif ($grey_qty > $grey_rcv_qty && $grey_rcv_qty>0) 
                                                    {
                                                        $tdcolor = "yellow";
                                                    }
                                                    $grey_rcv_qty -= $grey_qty;
                                                    // echo "<br>";
                                                    if(!$fab_req_qty) $tdcolor="white";
                                                }
                                                ?>
                                                <td title="Budget Qty = <?= $fab_req_qty."/ Gmt Qty=".$orgGmtQty."*Acc Gmt Qty=".$acc_po_gmts_qty.',ColorId='.$color_id.'-'.$dtrId;?>" bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= fn_number_format($grey_qty,0); ?> </td>
                                                <? 
                                                $ship_date_total[$dtkey] += $grey_qty;
                                            }
                                            $i++; 
                                            if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                            ?>
                                        </tr>
                                        <!-- =========================== Batch ===================== -->
                                        <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                            <td width="80" align="left">Batch</td>
                                            <td width="80" align="right" title="<?= fn_number_format($running_slot_bal_array[$ftype][$color_id][$dtrId][2]['m'],0);?>"><?= fn_number_format($running_slot_bal_array[$ftype][$color_id][$dtrId][2]['q'],0);?></td>
                                            <? 
                                            $batch_qty_req = $batch_qty_array[$color_id][$dtrId];
                                            foreach ($shipDateArray as $dtkey => $dtlue) 
                                            {
                                                // $fab_req_qty = $row['grey_fab_req_qty']+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['grey_fab_req_qty'];
                                                $orgGmtQty = $orgGmtsQty[$row['color_id']][$dtrId];//+$orgContrustGmtsQty[$color_id];
                                                // $acc_po_gmts_qty = $gmtsDataArray[$color_id][$dtkey][$dtrId]+$actContrustGmtsQty[$color_id][$dtkey][$dtrId];
                                                $acc_po_gmts_qty = $acc_po_qty_arr[$row['color_id']][$dtrId][$dtkey];
                                                $batch_qty = ($orgGmtQty>0) ? ($fab_req_qty/$orgGmtQty)*$acc_po_gmts_qty : 0;

                                                $tdcolor="white";
                                                if($batch_qty_req>0)
                                                {
                                                    if($batch_qty <= $batch_qty_req)
                                                    {
                                                        $tdcolor = "#00d6ff";
                                                    }
                                                    elseif ($batch_qty > $batch_qty_req && $batch_qty_req>0) 
                                                    {
                                                        $tdcolor = "yellow";
                                                    }
                                                    $batch_qty_req -= $batch_qty;
                                                    // echo "<br>";
                                                    if(!$fab_req_qty) $tdcolor="white";
                                                }
                                                ?>
                                                <td bgcolor="<?= $tdcolor;?>" title="AccQty=<? echo $acc_po_gmts_qty.'='.$orgGmtQty.'='.$fab_req_qty;?>" width="50" align="right"><?= fn_number_format($batch_qty,0); ?></td>
                                                <? 
                                            } 
                                            $i++; 
                                            if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                            ?>
                                        </tr>
                                        <!-- =========================== Dyeing ===================== -->
                                        <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                            <td width="80" align="left">Dyeing</td>
                                            <td width="80" align="right" title="<?= fn_number_format($running_slot_bal_array[$ftype][$color_id][$dtrId][3]['m'],0);?>"><?= fn_number_format($running_slot_bal_array[$ftype][$color_id][$dtrId][3]['q'],0);?></td>
                                            <? 
                                            $dyeing_qty_req = $dyeing_qty_array[$color_id][$dtrId];
                                            foreach ($shipDateArray as $dtkey => $dtlue) 
                                            {
                                                // $fab_req_qty = $row['grey_fab_req_qty']+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['grey_fab_req_qty'];
                                                $orgGmtQty = $orgGmtsQty[$row['color_id']][$dtrId];//+$orgContrustGmtsQty[$color_id];
                                                // $acc_po_gmts_qty = $gmtsDataArray[$color_id][$dtkey][$dtrId]+$actContrustGmtsQty[$color_id][$dtkey][$dtrId];
                                                $acc_po_gmts_qty = $acc_po_qty_arr[$row['color_id']][$dtrId][$dtkey];
                                                $dyeing_qty = ($orgGmtQty>0) ? ($fab_req_qty/$orgGmtQty)*$acc_po_gmts_qty : 0;

                                                $tdcolor="white";
                                                if($dyeing_qty_req>0)
                                                {
                                                    if($dyeing_qty <= $dyeing_qty_req)
                                                    {
                                                        $tdcolor = "#00d6ff";
                                                    }
                                                    elseif ($dyeing_qty > $dyeing_qty_req && $dyeing_qty_req>0) 
                                                    {
                                                        $tdcolor = "yellow";
                                                    }
                                                    $dyeing_qty_req -= $dyeing_qty;
                                                    // echo "<br>";
                                                    if(!$fab_req_qty) $tdcolor="white";
                                                }
                                                ?>
                                                <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= fn_number_format($dyeing_qty,0); ?></td>
                                                <? 
                                            } 
                                            $i++; 
                                            if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                            ?>
                                        </tr>
                                        <!-- =========================== Finish Fab ===================== -->
                                        <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                            <td width="80" align="left">Finish Fab Rcv</td>
                                            <td width="80" align="right" title="<?= fn_number_format($running_slot_bal_array[$ftype][$color_id][$dtrId][4]['m'],0);?>"><?= fn_number_format($running_slot_bal_array[$ftype][$color_id][$dtrId][4]['q'],0);?></td>
                                            <? 
                                            $fin_fab_rcv_qty = $fin_fab_rcv_array[$color_id][$dtrId];
                                            foreach ($shipDateArray as $dtkey => $dtlue) 
                                            {
                                                // $fin_fab_req_qty = $row['fin_fab_req_qty']+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['fin_fab_req_qty'];
												
                                                $orgGmtQty = $orgGmtsQty[$row['color_id']][$dtrId];//+$orgContrustGmtsQty[$color_id];
                                                // $acc_po_gmts_qty = $gmtsDataArray[$color_id][$dtkey][$dtrId]+$actContrustGmtsQty[$color_id][$dtkey][$dtrId];
                                                $acc_po_gmts_qty = $acc_po_qty_arr[$row['color_id']][$dtrId][$dtkey];
                                                $fin_fab_qty = ($orgGmtQty>0) ? ($fin_fab_req_qty/$orgGmtQty)*$acc_po_gmts_qty : 0;
											 //	echo $fin_fab_rcv_qty.'='.$color_id.'='.$contrast_color_id.'<br>';;
                                                $tdcolor="white";
                                                if($fin_fab_rcv_qty>0)
                                                {
                                                    if($fin_fab_qty <= $fin_fab_rcv_qty)
                                                    {
                                                        $tdcolor = "#00d6ff";
                                                    }
                                                    elseif ($fin_fab_qty > $fin_fab_rcv_qty && $fin_fab_rcv_qty>0) 
                                                    {
                                                        $tdcolor = "yellow";
                                                    }
                                                    $fin_fab_rcv_qty -= $fin_fab_qty;
                                                    // echo "<br>";
                                                    if(!$fin_fab_req_qty) $tdcolor="white";
                                                }
                                                ?>
                                                <td title="<?= $fin_fab_req_qty."/".$orgGmtQty."*".$acc_po_gmts_qty;?>" bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= fn_number_format($fin_fab_qty,0); ?></td>
                                                <? 
                                            } 
                                            $i++; 
                                            ?>
                                        </tr>
                                        <?
                                    }
                                }
                            }
                        } 
                        ?>
                    </tbody>
                </table>   
            </div> 
        </div>    
    </fieldset>
    <?
    unset($data_array);
    exit();

}

if($action == "finish_fab_popup__bk")//17-11-2022
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    extract($_REQUEST);
    $data = explode("__", $po_break_down_id);
    $job_no = $data[0];
    $po_id = $data[1];

    $condition= new condition();     
    $condition->po_id_in($po_id);     
    $condition->init();
    $fabric= new fabric($condition);
    // echo $fabric->getQuery();die;
    // $fabric_data_arr=$fabric->getQtyArray_by_JobColorBodyTypeDeterminIdGsmAndDiaWidth_knitAndwoven_greyAndfinish();
    $fabric_data_arr=$fabric->getQtyArray_by_JobColorFabricColorBodyTypeDeterminIdGsmAndDiaWidth_knitAndwoven_greyAndfinish();
    // $fabric_data_arr=$fabric->getQtyArray_by_OrderFabriccostidFabriccolorAndDiaWidth_knitAndwoven_greyAndfinish();
    // echo "<pre>"; print_r($fabric_data_arr); echo "</pre>";die;
    
    // ====================================== budget data ===================================
    $sql = "SELECT c.COLOR_NUMBER_ID,c.DIA_WIDTH,a.LIB_YARN_COUNT_DETER_ID,a.BODY_PART_ID,a.FABRIC_DESCRIPTION,a.GSM_WEIGHT,a.COLOR_SIZE_SENSITIVE,a.BODY_PART_TYPE,b.CONTRAST_COLOR_ID,a.WIDTH_DIA_TYPE,a.UOM,a.FABRIC_SOURCE from wo_pre_cos_fab_co_avg_con_dtls c, wo_pre_cost_fabric_cost_dtls a LEFT JOIN wo_pre_cos_fab_co_color_dtls b ON a.job_no = b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  AND b.status_active = 1
       AND b.is_deleted = 0 where a.id=c.pre_cost_fabric_cost_dtls_id and c.status_active=1 and a.status_active=1 and a.is_deleted=0 and a.job_no='$job_no' and c.cons !=0";
    // echo $sql;die();

    //1=pcs,12=kg,23=mtr,27=yds   
    $sql_res = sql_select($sql);
    $data_array = array();
    $contrust_qty_array = array();
    $chk_array = array();
    foreach ($sql_res as $val) 
    {
        if($val['BODY_PART_TYPE']==40 || $val['BODY_PART_TYPE']==50)
        {
            $body_part_type='Flat';
        }
        else
        {
            if($val['UOM']==12)
            {
                $body_part_type='Circular__(Kg)';
            }
            else
            {
                $body_part_type='Circular__(Yds/Meter)';
            }
        }

        if($val['COLOR_SIZE_SENSITIVE']==3)
        {
            $color_id=$val['CONTRAST_COLOR_ID'];
            $color_name=$lib_color[$val['CONTRAST_COLOR_ID']];
        }
        else
        {
            $color_id=$val['COLOR_NUMBER_ID'];
            $color_name=$lib_color[$val['COLOR_NUMBER_ID']];
        }
        $grey_fab_req_qty = 0;
        if($val['FABRIC_SOURCE']==1) // only production
        {
            $grey_fab_req_qty = array_sum($fabric_data_arr['knit']['grey'][$job_no][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['LIB_YARN_COUNT_DETER_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][1]);
        }

        $fin_fab_req_qty = 0;
        $fin_fab_pur_req_qty = 0;
        $fin_fab_req_qty = array_sum($fabric_data_arr['knit']['finish'][$job_no][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['LIB_YARN_COUNT_DETER_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][1]);

        $fin_fab_pur_req_qty = array_sum($fabric_data_arr['knit']['finish'][$job_no][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['LIB_YARN_COUNT_DETER_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][2]);

        // echo $fin_fab_req_qty ."+". $fin_fab_pur_req_qty.$body_part_type.",".$color_id.",".$str.$val['BODY_PART_TYPE']."<br>";

        $str = $val['LIB_YARN_COUNT_DETER_ID'].",".$val['GSM_WEIGHT'].",".$val['DIA_WIDTH'];

        if($chk_array[$body_part_type][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$str][$val['BODY_PART_TYPE']]=="")
        {
            $data_array[$body_part_type][$color_name][$str]['color_id'] = $color_id;
            $data_array[$body_part_type][$color_name][$str]['fabric'] = $val['FABRIC_DESCRIPTION'];
            $data_array[$body_part_type][$color_name][$str]['grey_fab_req_qty'] += $grey_fab_req_qty;
            $data_array[$body_part_type][$color_name][$str]['fin_fab_req_qty']  += $fin_fab_req_qty + $fin_fab_pur_req_qty;
            if($grey_fab_req_qty>0 || $fin_fab_req_qty>0 || $fin_fab_pur_req_qty>0)
            {
                $chk_array[$body_part_type][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$str][$val['BODY_PART_TYPE']]="kakku";
            }
            else
            {
                $chk_array[$body_part_type][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$str][$val['BODY_PART_TYPE']]="";
            }
        }

        if($val['COLOR_SIZE_SENSITIVE']==3)
        {
            $grey_fab_req_qty = array_sum($fabric_data_arr['knit']['grey'][$job_no][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['LIB_YARN_COUNT_DETER_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][1]) + array_sum($fabric_data_arr['knit']['grey'][$job_no][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['LIB_YARN_COUNT_DETER_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][2]);
            $fin_fab_req_qty = array_sum($fabric_data_arr['knit']['finish'][$job_no][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['LIB_YARN_COUNT_DETER_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][1])+array_sum($fabric_data_arr['knit']['finish'][$job_no][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$val['BODY_PART_TYPE']][$val['LIB_YARN_COUNT_DETER_ID']][$val['GSM_WEIGHT']][$val['DIA_WIDTH']][2]);

            $contrust_qty_array[$body_part_type][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$str]['contrast_color_id'] = $val['CONTRAST_COLOR_ID'];
            $contrust_qty_array[$body_part_type][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$str]['grey_fab_req_qty'] = $grey_fab_req_qty;
            $contrust_qty_array[$body_part_type][$val['COLOR_NUMBER_ID']][$val['CONTRAST_COLOR_ID']][$str]['fin_fab_req_qty']  = $fin_fab_req_qty;
        }
    }
    // echo "<pre>";print_r($data_array);die();

    $gmt_color_library=array();//fabric_cost_dtls_id
    $gmt_color_data=sql_select("SELECT a.body_part_id,b.gmts_color_id, b.contrast_color_id  FROM  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b ,wo_pre_cos_fab_co_avg_con_dtls c
    WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.id=c.pre_cost_fabric_cost_dtls_id and  a.job_no='$job_no' and a.color_size_sensitive=3 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and c.cons!=0 ");
    
    foreach( $gmt_color_data as $gmt_color_row)
    {
        $gmt_color_library[$gmt_color_row[csf("gmts_color_id")]].= sizeof($gmt_color_library[$gmt_color_row[csf("gmts_color_id")]]) ? ",".$gmt_color_row[csf("contrast_color_id")] : $gmt_color_row[csf("contrast_color_id")];
    }
    // echo "<pre>";print_r($contrust_qty_array);die();

    // ===================== get contrust color wise req qty ========================
    $contrust_color_qty_array = array();
    $contrust_color_array = array();
    $gmts_color_array = array();
    foreach ($contrust_qty_array as $btype => $btype_data) 
    {
        foreach ($btype_data as $gmt_color => $gmts_color_data) 
        {
            foreach ($gmts_color_data as $contrust_color => $contrust_color_data) 
            {
                
                foreach ($contrust_color_data as $str_k => $row) 
                {
                    $gmts_color_array[$gmt_color] = $gmt_color;
                    // $gmt_color_ex = array_unique(explode(",", $gmt_color_library[$gmt_color]));
                    // foreach ($gmt_color_ex as $key => $value) 
                    // {           
                        $contrust_color_qty_array[$btype][$contrust_color][$str_k]['grey_fab_req_qty'] += $row['grey_fab_req_qty'];                
                        $contrust_color_qty_array[$btype][$contrust_color][$str_k]['fin_fab_req_qty'] += $row['fin_fab_req_qty'];
                    // }
                                    
                }
            }
        }        
    }
    // echo "<pre>";print_r($gmts_color_array);echo "</pre>";
    
    // ============================================= acc po qty ============================================
    $sql = "SELECT  d.po_qty as ACC_PO_QTY, c.acc_ship_date as  ACC_SHIP_DATE,d.GMTS_COLOR_ID from wo_po_details_master a  join wo_po_break_down b on a.id=b.job_id join wo_po_acc_po_info c on b.id=c.po_break_down_id join wo_po_acc_po_info_dtls d on c.id=d.mst_id  where  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and c.acc_ship_date IS NOT NULL and a.job_no='$job_no' and d.gmts_color_id <> 0 and c.acc_po_status=1 order by c.acc_ship_date ASC";
    // echo $sql;die();
    $res = sql_select($sql);
    $gmtsDataArray = array();
    $shipDateArray = array();
    $actContrustGmtsQty = array();
    foreach ($res as $val) 
    {
        $gmtsDataArray[$val['GMTS_COLOR_ID']][strtotime($val['ACC_SHIP_DATE'])] += $val['ACC_PO_QTY'];
        $shipDateArray[strtotime($val['ACC_SHIP_DATE'])] = strtotime($val['ACC_SHIP_DATE']);

        if(in_array($val['GMTS_COLOR_ID'], $gmts_color_array))
        {
            $gmt_color_ex = array_unique(explode(",", $gmt_color_library[$val['GMTS_COLOR_ID']]));
            foreach ($gmt_color_ex as $key => $value) 
            {          
                if($val['GMTS_COLOR_ID']!=$value) // check for gmts color and contrust color is same       
                { 
                    $actContrustGmtsQty[$value][strtotime($val['ACC_SHIP_DATE'])] += $val['ACC_PO_QTY'];
                }
            }
        }
    }
    unset($res);
    // echo "<pre>";print_r($gmtsDataArray);die();    

    // ================================ origi po qty==========================   
    $sql = "SELECT COLOR_NUMBER_ID, sum(ORDER_QUANTITY) as ORDER_QUANTITY from wo_po_color_size_breakdown where job_no_mst='$job_no' and status_active=1 and is_deleted=0  group by COLOR_NUMBER_ID";
    // echo $sql;
    $res = sql_select($sql);
    $orgGmtsQty = array();
    $orgContrustGmtsQty = array();
    foreach ($res as $val) 
    {
        $orgGmtsQty[$val['COLOR_NUMBER_ID']] += $val['ORDER_QUANTITY']; 

        $gmt_color_ex = array_unique(explode(",", $gmt_color_library[$val['COLOR_NUMBER_ID']]));
        foreach ($gmt_color_ex as $key => $value) 
        {   
            if($val['COLOR_NUMBER_ID']!=$value) // check for gmts color and contrust color is same         
            {
                $orgContrustGmtsQty[$value] += $val['ORDER_QUANTITY'];
            }
        }       
    }
    

    // echo "<pre>";print_r($orgContrustGmtsQty);die();
    // ============================= grey rcv ============================
    $sql ="SELECT b.COLOR_ID,b.FEBRIC_DESCRIPTION_ID,b.GSM,b.WIDTH,b.BODY_PART_ID, c.QUANTITY 
        from inv_receive_master a, pro_grey_prod_entry_dtls b, order_wise_pro_details c 
        where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and c.po_breakdown_id=$po_id and b.color_id is not null";
    // echo $sql; 
    $sql_res = sql_select($sql);   
    $grey_rcv_array = array();
    foreach ($sql_res as $val) 
    {
        $str = $val['FEBRIC_DESCRIPTION_ID'].",".$val['GSM'].",".$val['WIDTH'];
        $grey_rcv_array[$val['COLOR_ID']][$str] += $val['QUANTITY'];
    }
    // echo "<pre>";print_r($grey_rcv_array);die();

    // ============================= batch qty ============================
    $sql ="SELECT a.COLOR_ID, b.BATCH_QNTY,c.DETARMINATION_ID,c.DIA_WIDTH,c.GSM
        from pro_batch_create_mst a, pro_batch_create_dtls b, product_details_master c 
        where a.id=b.mst_id and b.prod_id=c.id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.po_id=$po_id and a.color_id is not null and a.entry_form not in(37) and a.batch_against=1 and c.status_active=1";//
    // echo $sql; 
    $sql_res = sql_select($sql);   
    $batch_qty_array = array();
    foreach ($sql_res as $val) 
    {
        $str = $val['DETARMINATION_ID'].",".$val['GSM'].",".$val['DIA_WIDTH'];
        $batch_qty_array[$val['COLOR_ID']][$str] += $val['BATCH_QNTY'];
    }
    // echo "<pre>";print_r($batch_qty_array);die();

    // ============================= dyeing qty ============================
    $sqlDye = "SELECT a.COLOR_ID,sum(b.batch_qnty) as QTY,d.DETARMINATION_ID,d.DIA_WIDTH,d.GSM from pro_batch_create_mst a, pro_batch_create_dtls b,pro_fab_subprocess c,product_details_master d where a.id=b.mst_id and a.id=c.batch_id and b.po_id=$po_id and c.load_unload_id=2 and c.process_id='31' and c.result=1 and d.id=b.prod_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 group by a.color_id,d.detarmination_id,d.dia_width,d.gsm";
    // echo $sqlDye; 
    $sql_res = sql_select($sqlDye);   
    $dyeing_qty_array = array();
    foreach ($sql_res as $val) 
    {
        $str = $val['DETARMINATION_ID'].",".$val['GSM'].",".$val['DIA_WIDTH'];
        $dyeing_qty_array[$val['COLOR_ID']][$str] += $val['QTY'];
    }
    // echo "<pre>";print_r($dyeing_qty_array);die();    

    // ============================= finish fab qty ============================
     $sql ="SELECT b.COLOR_ID,b.FABRIC_DESCRIPTION_ID,b.GSM,b.WIDTH, c.QUANTITY 
        from inv_receive_master a, pro_finish_fabric_rcv_dtls b, order_wise_pro_details c 
        where a.id=b.mst_id and b.id=c.dtls_id and c.trans_type=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and c.po_breakdown_id=$po_id and b.color_id is not null and c.entry_form in (37,68)";
    // echo $sql; 
    $sql_res = sql_select($sql);   
    $fin_fab_rcv_array = array();
    foreach ($sql_res as $val) 
    {
        $str = $val['FABRIC_DESCRIPTION_ID'].",".$val['GSM'].",".$val['WIDTH'];
        $fin_fab_rcv_array[$val['COLOR_ID']][$str] += $val['QUANTITY'];
    }
    // echo "<pre>";print_r($fin_fab_rcv_array);die();

    $rowspan_fab_type = array();
    $rowspan_color = array();
    $rowspan_fab = array();
    foreach ($data_array as $ftype => $fab_val) 
    {
        foreach ($fab_val as $color_id => $color_val) 
        {
            foreach ($color_val as $dtrId => $row) 
            {
                $fab_req_qty = $row['grey_fab_req_qty'];//+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['grey_fab_req_qty'];    
                $fin_fab_req_qty = $row['fin_fab_req_qty'];//+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['fin_fab_req_qty'];   
                if($fab_req_qty >0 || $fin_fab_req_qty>0)
                {
                    $rowspan_fab_type[$ftype]++;
                    $rowspan_color[$ftype][$color_id]++;
                    $rowspan_fab[$ftype][$color_id][$dtrId]++;    
                }            
            }
        }
    }
    // echo "<pre>";print_r($data_array);die();

    // ====================== clculate running slot blance ===============================
    $running_slot_bal_array = array();
    foreach ($data_array as $ftype => $ftype_val) 
    { 
        foreach ($ftype_val as $color_id => $color_val) 
        {
            foreach ($color_val as $str => $row) 
            {
                // echo $color_id.$str.$grey_rcv_array[$color_id][$str]."<br>";
                $grey_rcv_qty = $grey_rcv_array[$color_id][$str];  
                $tot_grey_rcv_qty = $grey_rcv_array[$color_id][$str];  
                $batch_qty_req = $batch_qty_array[$color_id][$str];     
                $tot_batch_qty_req = $batch_qty_array[$color_id][$str];     
                $dyeing_qty_req = $dyeing_qty_array[$color_id][$str]; 
                $tot_dyeing_qty_req = $dyeing_qty_array[$color_id][$str]; 
                $fin_fab_rcv_qty = $fin_fab_rcv_array[$color_id][$str];       
                $tot_fin_fab_rcv_qty = $fin_fab_rcv_array[$color_id][$str];       
                
                $grey_qty_slot = 0;
                $batch_qty_slot = 0;
                $dyeing_qty_slot = 0;
                $fin_fab_slot = 0;
                foreach ($shipDateArray as $dtkey => $dtlue) 
                {
                    $fab_req_qty = $row['grey_fab_req_qty'];//+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['grey_fab_req_qty'];
                    $orgGmtQty = $orgGmtsQty[$color_id]+$orgContrustGmtsQty[$color_id];
                    $acc_po_gmts_qty = $gmtsDataArray[$color_id][$dtkey]+$actContrustGmtsQty[$color_id][$dtkey];
                    $grey_qty = ($orgGmtQty>0) ? ($fab_req_qty/$orgGmtQty)*$acc_po_gmts_qty : 0;

                    $fab_req_qty = $row['fin_fab_req_qty'];//+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['fin_fab_req_qty'];
                    $orgGmtQty = $orgGmtsQty[$color_id]+$orgContrustGmtsQty[$color_id];
                    $acc_po_gmts_qty = $gmtsDataArray[$color_id][$dtkey]+$actContrustGmtsQty[$color_id][$dtkey];
                    $fin_fab_qty = ($orgGmtQty>0) ? ($fab_req_qty/$orgGmtQty)*$acc_po_gmts_qty : 0;

                    if($grey_qty>0)
                    {
                        if ($grey_rcv_qty>0) 
                        {
                            $grey_qty_slot += $grey_qty;
                            $grey_rcv_qty -= $grey_qty;
                        }

                        if ($batch_qty_req>0) 
                        {
                            $batch_qty_slot += $grey_qty;
                            $batch_qty_req -= $grey_qty;
                        }

                        if ($dyeing_qty_req>0) 
                        {
                            $dyeing_qty_slot += $grey_qty;
                            $dyeing_qty_req -= $grey_qty;
                        }
                    }

                    if($fin_fab_qty>0)
                    {
                        if ($fin_fab_rcv_qty>0) 
                        {
                            $fin_fab_slot += $fin_fab_qty;
                            $fin_fab_rcv_qty -= $fin_fab_qty;
                        }
                    }
                    
                }
                $running_slot_bal_array[$ftype][$color_id][$str][1] += max(0,$grey_qty_slot - $tot_grey_rcv_qty);
                $running_slot_bal_array[$ftype][$color_id][$str][2] += max(0,$batch_qty_slot - $tot_batch_qty_req);
                $running_slot_bal_array[$ftype][$color_id][$str][3] += max(0,$dyeing_qty_slot - $tot_dyeing_qty_req);
                $running_slot_bal_array[$ftype][$color_id][$str][4] += max(0,$fin_fab_slot - $tot_fin_fab_rcv_qty);
            }
        }
    }
    // echo "<pre>";print_r($running_slot_bal_array);

    // echo "<pre>";print_r($contrust_color_qty_array);echo "</pre>";
    $tbl_width = 580+(count($shipDateArray)*50);
    ob_start(); 
    ?>
    <fieldset class="first_part" style="width:<? echo $tbl_width+30;?>px;margin:15px 0;">
        <div id="buyer_wise_details_report">
            <h3>Int Ref. : <?= $intref = return_field_value("grouping", "wo_po_break_down", "id=$po_id", "grouping");;?></h3>
            <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0">            
                <thead>
                    <tr>
                        <th width="80">Fabric Type</th>
                        <th width="80">Fabric Color</th>
                        <th width="180">Fabrication</th>
                        <th width="80">Operation</th>
                        <th width="80">Running Slot Bal</th>
                        <? 
                        foreach ($shipDateArray as $dtkey => $dtlue) 
                        {
                            ?>
                            <th width="50"><?= date('d-M',$dtkey); ?></th>
                            <? 
                        } 
                        ?>
                    </tr>
                </thead>
            </table>
            
            <div style="max-height: 350px; overflow-y: scroll;width: <? echo $tbl_width+20;?>px;">
                <table border="1" rules="all" class="rpt_table" width="<? echo $tbl_width;?>" cellpadding="0" cellspacing="0"> 
                    <tbody>
                        <? 
                        $i=1;
                        foreach ($data_array as $ftype => $fab_val) 
                        {
                            ksort($fab_val);
                            $ft = 0;
                            foreach ($fab_val as $color_name => $color_val) 
                            {
                                $clr = 0;
                                foreach ($color_val as $dtrId => $row) 
                                {
                                    $fb = 0;
                                    $color_id = $row['color_id'];

                                    if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";  
                                    $fab_req_qty = $row['grey_fab_req_qty'];//+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['grey_fab_req_qty'];    
                                    // echo $ftype."**".$color_id."**".$dtrId."**".$fab_req_qty."<br>";
                                    $fin_fab_req_qty = $row['fin_fab_req_qty'];//+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['fin_fab_req_qty'];   
                                    if($fab_req_qty >0 || $fin_fab_req_qty>0)
                                    {               
                                        ?>
                                        <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                            <? if($ft==0){?>
                                            <td valign="middle" width="80" align="left" rowspan="<?= $rowspan_fab_type[$ftype]*4;?>"><p><?= implode(" ", explode("__",$ftype));?></p></td>
                                            <? $ft++;} if($clr==0){ ?>
                                           
                                            <td width="80" align="left" valign="middle" title="<?=$color_name;?>" rowspan="<?= $rowspan_color[$ftype][$color_name]*4;?>"><p><?=substr($color_name,0,12);?></p></td>
                                            <? $clr++;}if($fb==0){?>
                                           
                                            <td width="180" align="left" valign="middle" rowspan="<?= $rowspan_fab[$ftype][$color_name][$dtrId]*4;?>"><p>
                                                <? 
                                                    $dtrId_ex = explode(",", $dtrId);
                                                    echo $row['fabric'].",".$dtrId_ex[1].",".$dtrId_ex[2];
                                                ?>                                                
                                            </p></td>
                                            <? $fb++;} ?>
                                            
                                            <td width="80" align="left">Gray Rcv</td>
                                            <td width="80" align="right"><?= fn_number_format($running_slot_bal_array[$ftype][$color_id][$dtrId][1],0);?></td>
                                            <? 
                                            $grey_rcv_qty = $grey_rcv_array[$color_id][$dtrId];

                                            foreach ($shipDateArray as $dtkey => $dtlue) 
                                            {
                                                // $fab_req_qty = $row['grey_fab_req_qty']+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['grey_fab_req_qty'];
                                                $orgGmtQty = $orgGmtsQty[$color_id]+$orgContrustGmtsQty[$color_id];
                                                // echo $color_id."==".$orgGmtsQty[$color_id]."+".$orgContrustGmtsQty[$color_id]."<br>";
                                                $acc_po_gmts_qty = $gmtsDataArray[$color_id][$dtkey]+$actContrustGmtsQty[$color_id][$dtkey];
                                                //  echo $color_name."==".$color_id."==".$gmtsDataArray[$color_id][$dtkey]."+".$actContrustGmtsQty[$color_id][$dtkey]."<br>";
                                                $grey_qty = ($orgGmtQty>0) ? ($fab_req_qty/$orgGmtQty)*$acc_po_gmts_qty : 0;

                                                $tdcolor="white";
                                                if($grey_rcv_qty>0)
                                                {
                                                    if($grey_qty <= $grey_rcv_qty)
                                                    {
                                                        $tdcolor = "#00d6ff";
                                                    }
                                                    elseif ($grey_qty > $grey_rcv_qty && $grey_rcv_qty>0) 
                                                    {
                                                        $tdcolor = "yellow";
                                                    }
                                                    $grey_rcv_qty -= $grey_qty;
                                                    // echo "<br>";
                                                    if(!$fab_req_qty) $tdcolor="white";
                                                }
                                                ?>
                                                <td title="Budget Qty = <?= $fab_req_qty."/ Gmt Qty=".$orgGmtQty."*Acc Gmt Qty=".$acc_po_gmts_qty;?>" bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= fn_number_format($grey_qty,0); ?></td>
                                                <? 
                                                $ship_date_total[$dtkey] += $grey_qty;
                                            }
                                            $i++; 
                                            if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                            ?>
                                        </tr>
                                        <!-- =========================== Batch ===================== -->
                                        <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                            <td width="80" align="left">Batch</td>
                                            <td width="80" align="right"><?= fn_number_format($running_slot_bal_array[$ftype][$color_id][$dtrId][2],0);?></td>
                                            <? 
                                            $batch_qty_req = $batch_qty_array[$color_id][$dtrId];
                                            foreach ($shipDateArray as $dtkey => $dtlue) 
                                            {
                                                // $fab_req_qty = $row['grey_fab_req_qty']+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['grey_fab_req_qty'];
                                                $orgGmtQty = $orgGmtsQty[$color_id]+$orgContrustGmtsQty[$color_id];
                                                $acc_po_gmts_qty = $gmtsDataArray[$color_id][$dtkey]+$actContrustGmtsQty[$color_id][$dtkey];
                                                $batch_qty = ($orgGmtQty>0) ? ($fab_req_qty/$orgGmtQty)*$acc_po_gmts_qty : 0;

                                                $tdcolor="white";
                                                if($batch_qty_req>0)
                                                {
                                                    if($batch_qty <= $batch_qty_req)
                                                    {
                                                        $tdcolor = "#00d6ff";
                                                    }
                                                    elseif ($batch_qty > $batch_qty_req && $batch_qty_req>0) 
                                                    {
                                                        $tdcolor = "yellow";
                                                    }
                                                    $batch_qty_req -= $batch_qty;
                                                    // echo "<br>";
                                                    if(!$fab_req_qty) $tdcolor="white";
                                                }
                                                ?>
                                                <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= fn_number_format($batch_qty,0); ?></td>
                                                <? 
                                            } 
                                            $i++; 
                                            if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                            ?>
                                        </tr>
                                        <!-- =========================== Dyeing ===================== -->
                                        <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                            <td width="80" align="left">Dyeing</td>
                                            <td width="80" align="right"><?= fn_number_format($running_slot_bal_array[$ftype][$color_id][$dtrId][3],0);?></td>
                                            <? 
                                            $dyeing_qty_req = $dyeing_qty_array[$color_id][$dtrId];
                                            foreach ($shipDateArray as $dtkey => $dtlue) 
                                            {
                                                // $fab_req_qty = $row['grey_fab_req_qty']+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['grey_fab_req_qty'];
                                                $orgGmtQty = $orgGmtsQty[$color_id]+$orgContrustGmtsQty[$color_id];
                                                $acc_po_gmts_qty = $gmtsDataArray[$color_id][$dtkey]+$actContrustGmtsQty[$color_id][$dtkey];
                                                $dyeing_qty = ($orgGmtQty>0) ? ($fab_req_qty/$orgGmtQty)*$acc_po_gmts_qty : 0;

                                                $tdcolor="white";
                                                if($dyeing_qty_req>0)
                                                {
                                                    if($dyeing_qty <= $dyeing_qty_req)
                                                    {
                                                        $tdcolor = "#00d6ff";
                                                    }
                                                    elseif ($dyeing_qty > $dyeing_qty_req && $dyeing_qty_req>0) 
                                                    {
                                                        $tdcolor = "yellow";
                                                    }
                                                    $dyeing_qty_req -= $dyeing_qty;
                                                    // echo "<br>";
                                                    if(!$fab_req_qty) $tdcolor="white";
                                                }
                                                ?>
                                                <td bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= fn_number_format($dyeing_qty,0); ?></td>
                                                <? 
                                            } 
                                            $i++; 
                                            if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                                            ?>
                                        </tr>
                                        <!-- =========================== Finish Fab ===================== -->
                                        <tr bgcolor="<? echo $bgcolor;?>" onclick="change_color('tr_1nd<? echo $i; ?>','<? echo $bgcolor; ?>')" id="tr_1nd<? echo $i; ?>" >
                                            <td width="80" align="left">Finish Fab Rcv</td>
                                            <td width="80" align="right"><?= fn_number_format($running_slot_bal_array[$ftype][$color_id][$dtrId][4],0);?></td>
                                            <? 
                                            $fin_fab_rcv_qty = $fin_fab_rcv_array[$color_id][$dtrId];
                                            foreach ($shipDateArray as $dtkey => $dtlue) 
                                            {
                                                // $fin_fab_req_qty = $row['fin_fab_req_qty']+$contrust_color_qty_array[$ftype][$color_id][$dtrId]['fin_fab_req_qty'];
                                                $orgGmtQty = $orgGmtsQty[$color_id]+$orgContrustGmtsQty[$color_id];
                                                $acc_po_gmts_qty = $gmtsDataArray[$color_id][$dtkey]+$actContrustGmtsQty[$color_id][$dtkey];
                                                $fin_fab_qty = ($orgGmtQty>0) ? ($fin_fab_req_qty/$orgGmtQty)*$acc_po_gmts_qty : 0;

                                                $tdcolor="white";
                                                if($fin_fab_rcv_qty>0)
                                                {
                                                    if($fin_fab_qty <= $fin_fab_rcv_qty)
                                                    {
                                                        $tdcolor = "#00d6ff";
                                                    }
                                                    elseif ($fin_fab_qty > $fin_fab_rcv_qty && $fin_fab_rcv_qty>0) 
                                                    {
                                                        $tdcolor = "yellow";
                                                    }
                                                    $fin_fab_rcv_qty -= $fin_fab_qty;
                                                    // echo "<br>";
                                                    if(!$fin_fab_req_qty) $tdcolor="white";
                                                }
                                                ?>
                                                <td title="<?= $fin_fab_req_qty."/".$orgGmtQty."*".$acc_po_gmts_qty;?>" bgcolor="<?= $tdcolor;?>" width="50" align="right"><?= fn_number_format($fin_fab_qty,0); ?></td>
                                                <? 
                                            } 
                                            $i++; 
                                            ?>
                                        </tr>
                                        <?
                                    }
                                }
                            }
                        } 
                        ?>
                    </tbody>
                </table>   
            </div> 
        </div>    
    </fieldset>
    <?
    unset($data_array);
    exit();

}



if($action=="report_generate_circular")
{
    $company_id     = str_replace("'", "", $cbo_company_name);
    $location_name  = str_replace("'", "", $cbo_location_name);
    $buyer_name     = str_replace("'", "", $cbo_buyer_name);
    $season_name    = str_replace("'", "", $cbo_season_name);
    $year           = str_replace("'", "", $cbo_year_selection);
    $shipment_status= str_replace("'", "", $cbo_shipment_status);
    $order_status   = str_replace("'", "", $cbo_order_status);
    $status         = str_replace("'", "", $cbo_status);
    $client         = str_replace("'", "", $cbo_client);
    $search_by      = str_replace("'", "", $cbo_search_by);
    $int_ref_no     = str_replace("'", "", $txt_int_ref_no);
    $emblishment    = str_replace("'", "", $cbo_emblishment);
    $start_alarm    = str_replace("'", "", $cbo_start_alarm);
    $end_alarm      = str_replace("'", "", $cbo_end_alarm);
    $backLog        = str_replace("'", "", $cbo_backlog);
    $date_from      = str_replace("'", "", $txt_date_from);
    $date_to        = str_replace("'", "", $txt_date_to);
    $merchant       = str_replace("'", "", $cbo_merchant);

    $search_data = $company_id."*".$location_name."*".$buyer_name."*".$season_name."*".$client."*".$merchant."*".$int_ref_no."*".$shipment_status."*".$order_status."*".$status."*".$search_by."*".$date_from."*".$date_to;

    //$item_id        = str_replace("'", "", $cbo_item_name);
    //$style_ref      = str_replace("'", "", $txt_style_ref);

    $client_array = return_library_array("SELECT a.id,a.buyer_name from lib_buyer a, lib_buyer_tag_company b where a.status_active =1 and a.is_deleted=0 and b.buyer_id=a.id and b.tag_company='$company_id' and a.id in (select  buyer_id from  lib_buyer_party_type where party_type in (7))  order by buyer_name", "id", "buyer_name");

    // Circular Fabric button


    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    // $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    $sqlCond .= ($merchant != 0)     ? " and a.factory_marchant=$merchant"            : "";
    $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    //$sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";

    if($buyer_name==0)
    {
        if($_SESSION['logic_erp']["data_level_secured"]==1)
        {
            if($_SESSION['logic_erp']["buyer_id"]!="")
            {   
                $sqlCond.=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")";
            }
        }
    }
    else
    {
        $sqlCond.=" and a.buyer_name=$buyer_name";
    }

    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active = $status" : "";
    //$sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }

    $sql = "SELECT a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT,e.dia_width as DIA_WIDTH, e.color_number_id as FABRIC_COLOR_ID 
    from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and a.company_name=$company_id $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and d.color_size_sensitive!=3  and d.body_part_type in (1,20,30) and d.fabric_source=1
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, e.dia_width, e.color_number_id
    union all
    select a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT,e.dia_width as DIA_WIDTH, f.contrast_color_id as FABRIC_COLOR_ID
    from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e, wo_pre_cos_fab_co_color_dtls f
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id 
    and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id and a.id=f.job_id and e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and a.company_name=$company_id $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and f.status_active=1 and f.is_deleted=0 and d.color_size_sensitive=3  and d.body_part_type in (1,20,30) and d.fabric_source=1
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, e.dia_width, f.contrast_color_id";
    //echo $sql;
    $sqlRes = sql_select($sql);
    if(count($sqlRes)==0)
    {
        echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
    }

    $poIdArray = array();

    if(!empty($sqlRes))  
    {
        $con = connect();
        $r_id=execute_query("delete from tmp_poid where userid=$user_id");
        if($r_id)
        {
            oci_commit($con);
        }
    }
    foreach ($sqlRes as $row) 
    {
        
        if(!$poIdArray[$row['PO_ID']])
        {
            $poIdArray[$row['PO_ID']] = $row['PO_ID'];
            $poIds .= $row['PO_ID'].",";
            $rID=execute_query("insert into tmp_poid (userid, poid) values ($user_id,".$row['PO_ID'].")");
        }

        $poBuyer[$row['PO_ID']] = $row['BUYER_NAME'];
        $poClient[$row['PO_ID']] = $row['CLIENT_ID'];
        $intRefClient[$row['PO_ID']] = $row['GROUPING'];
        
        $COMPANY_NAME = $row['COMPANY_NAME'];
    }

    // $body_part_type = array( 1 => "Top", 20 => "Bottom",30 => "Others", 40 => "Flat Knit", 50 => "Cuff",); 

    if($rID)
    {
        oci_commit($con);
    }

    $poIds = chop($poIds,",");
    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();
    //$costPerArr=$condition->getCostingPerArr();
    $fabric= new fabric($condition);
    //echo $fabric->getQuery();die;

    if($rptType==1 || $rptType==2 || $rptType==3)
    {
        $fabric_costing_arr=$fabric->getQtyArray_by_OrderFabricSourceAndBodyType_knitAndwoven_greyAndfinish();
    }
    else if($rptType==4)
    {
        $fabric_costing_arr=$fabric->getQtyArray_by_OrderFabricSourceAndBodyTypeFabColor_knitAndwoven_greyAndfinish();
    }
    else if($rptType==5)
    {
        $fabric_costing_arr=$fabric->getQtyArray_by_OrderFabricSourceBodyTypeFabColorDeterminIdGsmAndDiaWidth_knitAndwoven_greyAndfinish();
    }

    //getQtyArray_by_OrderFabricSourceAndBodyTypeFabColor_knitAndwoven_greyAndfinish
    /*echo "<pre>";
    print_r($fabric_costing_arr);
    die;*/
    
    foreach ($sqlRes as $row) 
    {
        if( $rptType==1 || $rptType==2 || $rptType==3 )
        {
            if($po_lvl_req_chk[$row['PO_ID']] =="")
            {
                $po_lvl_req_chk[$row['PO_ID']]=$row['PO_ID'];

                $buyer_wise_required=0;
                $buyer_wise_required = array_sum($fabric_costing_arr['knit']['finish'][$row['PO_ID']][1][1]) + array_sum($fabric_costing_arr['knit']['finish'][$row['PO_ID']][1][20]) + array_sum($fabric_costing_arr['knit']['finish'][$row['PO_ID']][1][30]);
                if( $buyer_wise_required >0)
                {
                    $buyerDataArray[$row['BUYER_NAME']]['REQ_QTY'] += $buyer_wise_required ;
                    $clientDataArray[$row['CLIENT_ID']]['REQ_QTY'] += $buyer_wise_required ;
                    $buyerIntRefDataArray[$row['BUYER_NAME']][$row['GROUPING']]['REQ_QTY'] += $buyer_wise_required;

                    $buyerDataArray[$row['BUYER_NAME']]['BUYER'] = $row['BUYER_NAME'];
                }
            }
        }

        if( $rptType==5 )
        {
            if($po_deter_lvl_req_chk[$row['PO_ID']."*".$row['FABRIC_COLOR_ID']."*".$row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH']] =="")
            {
                $po_deter_lvl_req_chk[$row['PO_ID']."*".$row['FABRIC_COLOR_ID']."*".$row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH']] = $row['BUYER_NAME'];
                
                $deter_str = $row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH'];

                $buyerColorDeterGsmDiaRequired=0;
                $buyerColorDeterGsmDiaRequired = array_sum($fabric_costing_arr['knit']['finish'][$row['PO_ID']][1][1][$row['FABRIC_COLOR_ID']][$row['LIB_YARN_COUNT_DETER_ID']][$row['GSM_WEIGHT']][$row['DIA_WIDTH']]) + 
                array_sum($fabric_costing_arr['knit']['finish'][$row['PO_ID']][1][20][$row['FABRIC_COLOR_ID']][$row['LIB_YARN_COUNT_DETER_ID']][$row['GSM_WEIGHT']][$row['DIA_WIDTH']]) + 
                array_sum($fabric_costing_arr['knit']['finish'][$row['PO_ID']][1][30][$row['FABRIC_COLOR_ID']][$row['LIB_YARN_COUNT_DETER_ID']][$row['GSM_WEIGHT']][$row['DIA_WIDTH']]);

                if($buyerColorDeterGsmDiaRequired >0)
                {
                    $buyerColorDeterGsmDiaArr[$row['BUYER_NAME']][$row['GROUPING']][$row['FABRIC_COLOR_ID']][$deter_str]['REQ_QTY'] += $buyerColorDeterGsmDiaRequired;

                    $deter_str = $row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH'];
                    $buyerColorDeterGsmDiaArr[$row['BUYER_NAME']][$row['GROUPING']][$row['FABRIC_COLOR_ID']][$deter_str]['BUYER_NAME'] = $row['BUYER_NAME'];
                }
                
            }
        }

        if($rptType ==4)
        {
            if($po_color_lvl_req_chk[$row['PO_ID']."*".$row['FABRIC_COLOR_ID']] =="")
            {
                $po_color_lvl_req_chk[$row['PO_ID']."*".$row['FABRIC_COLOR_ID']] = $row['BUYER_NAME'];

                $buyerColorRequired=0;
                $buyerColorRequired = array_sum($fabric_costing_arr['knit']['finish'][$row['PO_ID']][1][1][$row['FABRIC_COLOR_ID']]) + 
                array_sum($fabric_costing_arr['knit']['finish'][$row['PO_ID']][1][20][$row['FABRIC_COLOR_ID']]) + 
                array_sum($fabric_costing_arr['knit']['finish'][$row['PO_ID']][1][30][$row['FABRIC_COLOR_ID']]);

                if( $buyerColorRequired >0)
                {
                    $buyerColorArr[$row['BUYER_NAME']][$row['GROUPING']][$row['FABRIC_COLOR_ID']]['REQ_QTY'] +=  $buyerColorRequired;
                }
            }
        }
    }

    $short_sql = sql_select("SELECT a.po_break_down_id, c.buyer_id as BUYER_ID, d.client_id as CLIENT_ID, e.grouping as GROUPING, B.BODY_PART_TYPE, a.grey_fab_qnty as GREY_FAB_QNTY, a.fin_fab_qnty as FIN_FAB_QNTY, a.fabric_color_id as COLOR_ID, b.lib_yarn_count_deter_id as DETERMINATION_ID, b.gsm_weight as GSM_WEIGHT, a.dia_width as DIA_WIDTH, b.uom as UOM, b.job_no as JOB_NO from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b, wo_booking_mst c, wo_po_details_master d, wo_po_break_down e, tmp_poid f where a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no=c.booking_no and b.job_id=d.id and a.po_break_down_id=e.id and a.po_break_down_id=f.poid and f.userid=$user_id and c.fabric_source=1 and a.is_short=1 and a.booking_type=1 and a.status_active =1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

    foreach ($short_sql as $val) 
    {
        $short_arr[$val['JOB_NO']][$val['BODY_PART_TYPE']][$val['DETERMINATION_ID']][$val['COLOR_ID']][$val['DIA_WIDTH']][$val['UOM']]['SHORT_GREY']+=$val['FIN_FAB_QNTY']; 

        $buyerDataArray[$val['BUYER_ID']]['SHORT_QTY'] +=$val['FIN_FAB_QNTY'];
        $clientDataArray[$val['CLIENT_ID']]['SHORT_QTY'] +=$val['FIN_FAB_QNTY'];
        $buyerIntRefDataArray[$val['BUYER_ID']][$val['GROUPING']]['SHORT_QTY'] +=$val['FIN_FAB_QNTY'];

        $deter_str = $val['DETERMINATION_ID']."*".$val['GSM_WEIGHT']."*".$val['DIA_WIDTH'];
        $buyerColorDeterGsmDiaArr[$val['BUYER_ID']][$val['GROUPING']][$val['COLOR_ID']][$deter_str]['SHORT_QTY'] +=$val['FIN_FAB_QNTY'];

        $buyerColorArr[$val['BUYER_ID']][$val['GROUPING']][$val['COLOR_ID']]['SHORT_QTY'] +=$val['FIN_FAB_QNTY'];
    }

    $sqlGreyRcv = "SELECT d.po_breakdown_id as PO_BREAKDOWN_ID, c.febric_description_id as DETER_ID, d.quantity as QTY,c.UOM,c.COLOR_ID, c.gsm as GSM, c.width as DIA from inv_receive_master a, inv_transaction b,pro_grey_prod_entry_dtls c,order_wise_pro_details d, tmp_poid e where a.id=b.mst_id and b.id=c.trans_id and a.id=c.mst_id and b.id=d.trans_id and c.id=d.dtls_id and d.po_breakdown_id=e.poid and e.userid=$user_id and d.trans_type=1 and b.item_category=13 and a.status_active=1 and b.status_active=1 and c.status_active=1 ";
    //and d.po_breakdown_id in($poIds)
    // echo $sqlGreyRcv;die();
    $sqlRes = sql_select($sqlGreyRcv);
    $receive_qty_array = array();
    $desc_str="";
    foreach ($sqlRes as $val) 
    {
        $BUYER = $poBuyer[$val['PO_BREAKDOWN_ID']];
        $buyerDataArray[$BUYER]['GREY_RCV'] +=$val['QTY'];

        $CLIENT = $poClient[$val['PO_BREAKDOWN_ID']];
        $clientDataArray[$CLIENT]['GREY_RCV'] +=$val['QTY'];

        $INT_REF = $intRefClient[$val['PO_BREAKDOWN_ID']];
        $buyerIntRefDataArray[$BUYER][$INT_REF]['GREY_RCV'] +=$val['QTY'];

        $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];
        $buyerColorDeterGsmDiaArr[$BUYER ][$INT_REF][$val['COLOR_ID']][$deter_str]['GREY_RCV'] +=$val['QTY'];

        $buyerColorArr[$BUYER ][$INT_REF][$val['COLOR_ID']]['GREY_RCV'] +=$val['QTY'];
    }

    $sqlGreyIssue = "SELECT d.po_breakdown_id as PO_BREAKDOWN_ID, c.detarmination_id as DETER_ID, d.quantity as QTY,c.unit_of_measure as UOM,g.COLOR_ID, c.gsm as GSM, c.dia_width as DIA from inv_issue_master a, inv_transaction b,product_details_master c,order_wise_pro_details d,inv_grey_fabric_issue_dtls e, tmp_poid f, ppl_planning_info_entry_dtls g where a.id=b.mst_id and c.id=d.prod_id and b.id=d.trans_id and c.id=b.prod_id and e.trans_id=b.id and a.id=e.mst_id and e.prod_id=c.id and d.trans_type=2 and b.item_category=13 and c.item_category_id=13 and a.status_active=1 and b.status_active=1 and c.status_active=1 and d.po_breakdown_id=f.poid and f.userid=$user_id and e.program_no=g.id";
    // echo $sqlGreyIssue;die();
    $sqlRes = sql_select($sqlGreyIssue);
    $issue_qty_array = array();
    $desc_str="";
    foreach ($sqlRes as $val) 
    {
        $BUYER = $poBuyer[$val['PO_BREAKDOWN_ID']];
        $buyerDataArray[$BUYER]['GREY_ISSUE'] +=$val['QTY'];

        $CLIENT = $poClient[$val['PO_BREAKDOWN_ID']];
        $clientDataArray[$CLIENT]['GREY_ISSUE'] +=$val['QTY'];

        $INT_REF = $intRefClient[$val['PO_BREAKDOWN_ID']];
        $buyerIntRefDataArray[$BUYER][$INT_REF]['GREY_ISSUE'] +=$val['QTY'];


        $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];
        $buyerColorDeterGsmDiaArr[$BUYER ][$INT_REF][$val['COLOR_ID']][$deter_str]['GREY_ISSUE'] +=$val['QTY'];

        $buyerColorArr[$BUYER ][$INT_REF][$val['COLOR_ID']]['GREY_ISSUE'] +=$val['QTY'];
    }

    /*$sqlGreyTransReturn =sql_select("SELECT b.po_breakdown_id as PO_BREAKDOWN_ID, c.color as COLOR_ID, c.detarmination_id as DETER_ID, c.dia_width as DIA, c.gsm as GSM, b.quantity as QTY, a.transaction_type as TRANSACTION_TYPE from inv_transaction a, order_wise_pro_details b , product_details_master c, tmp_poid d where a.id=b.trans_id and b.po_breakdown_id=d.poid and d.userid=$user_id and b.prod_id=c.id and a.item_category=13 and a.transaction_type in (3,4,5,6) and b.trans_type in (3,4,5,6) and b.entry_form in (13,45,51) and a.status_active=1 and b.status_active=1");*/
   
    $sqlGreyTransReturn =sql_select("SELECT b.po_breakdown_id as PO_BREAKDOWN_ID, (case when a.transaction_type in (5,6) then cast(e.color_id as varchar2(100)) else cast(c.color as varchar2(100)) end) as COLOR_ID, c.detarmination_id as DETER_ID, c.dia_width as DIA, c.gsm as GSM, b.quantity as QTY, a.transaction_type as TRANSACTION_TYPE from inv_transaction a left join ppl_planning_info_entry_dtls e on a.program_no=e.id and a.transaction_type in (5,6), order_wise_pro_details b , product_details_master c, tmp_poid d where a.id=b.trans_id and b.po_breakdown_id=d.poid and d.userid=$user_id and b.prod_id=c.id and a.item_category=13 and a.transaction_type in (3,5,6) and b.trans_type in (3,5,6) and b.entry_form in (13,45) and a.status_active=1 and b.status_active=1
        union all

        SELECT b.po_breakdown_id as PO_BREAKDOWN_ID, cast(e.color_id as varchar2(100)) as COLOR_ID, c.detarmination_id as DETER_ID, c.dia_width as DIA, c.gsm as GSM, b.quantity as QTY, a.transaction_type as TRANSACTION_TYPE from inv_transaction a, order_wise_pro_details b , product_details_master c, inv_receive_master d, ppl_planning_info_entry_dtls e, tmp_poid f where a.id=b.trans_id and b.po_breakdown_id=f.poid and f.userid=$user_id   and b.prod_id=c.id and a.mst_id=d.id and d.booking_no=e.id and d.entry_form=51 and a.item_category=13 and a.transaction_type in (4) and b.trans_type in (4) and b.entry_form in (51) and a.status_active=1 and b.status_active=1");

    foreach ($sqlGreyTransReturn as $val) 
    {
        $BUYER = $poBuyer[$val['PO_BREAKDOWN_ID']];
        $CLIENT = $poClient[$val['PO_BREAKDOWN_ID']];
        $INT_REF = $intRefClient[$val['PO_BREAKDOWN_ID']];
        $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];
        if($val['TRANSACTION_TYPE'] ==6)
        {
            $buyerDataArray[$BUYER]['GREY_TROUT'] +=$val['QTY'];
            $clientDataArray[$CLIENT]['GREY_TROUT'] +=$val['QTY'];
            $buyerIntRefDataArray[$BUYER][$INT_REF]['GREY_TROUT'] +=$val['QTY'];

            $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['GREY_TROUT'] +=$val['QTY'];
            $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['GREY_TROUT'] +=$val['QTY'];
        } 
        else if($val['TRANSACTION_TYPE'] ==5)
        {
            $buyerDataArray[$BUYER]['GREY_TRIN'] +=$val['QTY'];
            $clientDataArray[$CLIENT]['GREY_TRIN'] +=$val['QTY'];
            $buyerIntRefDataArray[$BUYER][$INT_REF]['GREY_TRIN'] +=$val['QTY'];
            $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['GREY_TRIN'] +=$val['QTY'];
            $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['GREY_TRIN'] +=$val['QTY'];
        }
        else if($val['TRANSACTION_TYPE'] ==4)
        {
            $buyerDataArray[$BUYER]['GREY_ISSRETURN'] +=$val['QTY'];
            $clientDataArray[$CLIENT]['GREY_ISSRETURN'] +=$val['QTY'];
            $buyerIntRefDataArray[$BUYER][$INT_REF]['GREY_ISSRETURN'] +=$val['QTY'];
            $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['GREY_ISSRETURN'] +=$val['QTY'];
            $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['GREY_ISSRETURN'] +=$val['QTY'];
        }
        else if($val['TRANSACTION_TYPE'] ==3)
        {
            $buyerDataArray[$BUYER]['GREY_RCVRETURN'] +=$val['QTY'];
            $clientDataArray[$CLIENT]['GREY_RCVRETURN'] +=$val['QTY'];
            $buyerIntRefDataArray[$BUYER][$INT_REF]['GREY_RCVRETURN'] +=$val['QTY'];
            $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['GREY_RCVRETURN'] +=$val['QTY'];
            $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['GREY_RCVRETURN'] +=$val['QTY'];
        }
    }

    if($db_type==0) {
        $ext_cond = " and (c.extention_no=0 or c.extention_no='')";
    } else {
        $ext_cond = " and (c.extention_no=0 or c.extention_no is null)";
    }


    $sqlDyeUnload =sql_select("SELECT b.id as ID, e.po_break_down_id as PO_BREAKDOWN_ID, c.COLOR_ID as COLOR_ID, f.detarmination_id as DETER_ID, f.dia_width as DIA, f.gsm as GSM, b.batch_qty as BATCH_QTY from pro_fab_subprocess a, pro_fab_subprocess_dtls b, pro_batch_create_mst c, wo_booking_mst d, wo_booking_dtls e, product_details_master f, tmp_poid g where a.id=b.mst_id and b.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.batch_id=c.id and c.booking_no=d.booking_no and d.booking_no=e.booking_no and e.po_break_down_id=g.poid and g.userid=$user_id and b.prod_id=f.id $ext_cond group by b.id, e.po_break_down_id, b.batch_qty, c.COLOR_ID, f.detarmination_id, f.dia_width, f.gsm");

    foreach ($sqlDyeUnload as $val) 
    {
        if($dyeDtlsArr[$val['ID']] =="")
        {
            $dyeDtlsArr[$val['ID']] = $val['ID'];
            $BUYER = $poBuyer[$val['PO_BREAKDOWN_ID']];
            $buyerDataArray[$BUYER]['DYE_UNLOAD'] +=$val['BATCH_QTY'];

            $CLIENT = $poClient[$val['PO_BREAKDOWN_ID']];
            $clientDataArray[$CLIENT]['DYE_UNLOAD'] +=$val['BATCH_QTY'];

            $INT_REF = $intRefClient[$val['PO_BREAKDOWN_ID']];
            $buyerIntRefDataArray[$BUYER][$INT_REF]['DYE_UNLOAD'] +=$val['BATCH_QTY'];

            $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];
            $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['DYE_UNLOAD'] +=$val['BATCH_QTY'];
            $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['DYE_UNLOAD'] +=$val['BATCH_QTY'];
        }
    }

    //$text_store_sql = sql_select("select company_name as COMPANY_NAME, distribute_qnty as DISTRIBUTE_QNTY from variable_settings_production where variable_list=56 and status_active=1 and company_name=$COMPANY_NAME");

	$text_store_sql = sql_select("SELECT a.id as STORE_ID, a.store_name from lib_store_location a, lib_store_location_category b where a.id= b.store_location_id and company_id=$COMPANY_NAME and status_active=1 and b.category_type=2 and a.is_textile_store=1 group by a.id, a.store_name");

    if(empty($text_store_sql))
    {
        echo "Select Textile Store in Library setup";
        die;
    }

    foreach ($text_store_sql as $row) 
    {
        $textile_store_id[$row["STORE_ID"]] = $row["STORE_ID"];
    }

    $finish_rcv_issuereturn_sql = sql_select("SELECT a.po_breakdown_id as PO_BREAKDOWN_ID,  a.color_id as COLOR_ID, b.fabric_description_id as DETER_ID, b.width as  DIA, b.gsm as GSM, b.grey_used_qty as GREY_USED_QTY, a.id as DTLS_ID, b.id as PROP_ID, f.id as TRANS_ID, a.quantity as QUANTITY, f.store_id as TRANS_STORE, a.entry_form as ENTRY_FORM,  d.booking_type as BOOKING_TYPE, g.receive_basis as RECEIVE_BASIS, d.process as PROCESS, h.fabric_source as FABRIC_SOURCE from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join inv_transaction f on b.trans_id=f.id, inv_receive_master g, pro_batch_create_mst c, wo_booking_dtls d, tmp_poid e, wo_booking_mst h where a.dtls_id = b.id and b.mst_id = g.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and a.entry_form in (7,37) and g.entry_form in (7,37) and d.booking_no=h.booking_no and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 group by a.po_breakdown_id, a.color_id, b.fabric_description_id, b.width, b.gsm, b.grey_used_qty, a.id, b.id, f.id, a.quantity, f.store_id, a.entry_form, d.booking_type, g.receive_basis, d.process, h.fabric_source");

    foreach ($finish_rcv_issuereturn_sql as $val) 
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==1 ) || $val['BOOKING_TYPE']==3)
        {
            $BUYER = $poBuyer[$val['PO_BREAKDOWN_ID']];
            $CLIENT = $poClient[$val['PO_BREAKDOWN_ID']];
            $INT_REF = $intRefClient[$val['PO_BREAKDOWN_ID']];
            $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];

            if($prop_arr[$val['PROP_ID']] == "")
            {
                $prop_arr[$val['PROP_ID']] = $val['PROP_ID'];

                if($val['ENTRY_FORM']==7)
                {
                    if($dtls_arr[$val['DTLS_ID']] == "")
                    {
                        $dtls_arr[$val['DTLS_ID']] = $val['DTLS_ID'];
                        $buyerDataArray[$BUYER]['GREY_USED_PRODUCTION'] +=$val['GREY_USED_QTY'];
                        $clientDataArray[$CLIENT]['GREY_USED_PRODUCTION'] +=$val['GREY_USED_QTY'];
                        $buyerIntRefDataArray[$BUYER][$INT_REF]['GREY_USED_PRODUCTION'] +=$val['GREY_USED_QTY'];
                        $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['GREY_USED_PRODUCTION'] +=$val['GREY_USED_QTY'];
                        $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['GREY_USED_PRODUCTION'] +=$val['GREY_USED_QTY'];
                    }
                }
                //if($val['TRANS_ID'] && ($val['TRANS_STORE']==$textile_store_id))
                if($val['TRANS_ID'] && ($textile_store_id[$val['TRANS_STORE']] !=""))
                {
                    $buyerDataArray[$BUYER]['FINISH_QTY'] +=$val['QUANTITY'];  
                    $clientDataArray[$CLIENT]['FINISH_QTY'] +=$val['QUANTITY'];  
                    $buyerIntRefDataArray[$BUYER][$INT_REF]['FINISH_QTY'] +=$val['QUANTITY'];  
                    $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['FINISH_QTY'] +=$val['QUANTITY'];  
                    $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['FINISH_QTY'] +=$val['QUANTITY'];  
                }
            }

            if($val['ENTRY_FORM']==37 && $val['RECEIVE_BASIS']==11 && ($val['PROCESS'] ==31 || $val['PROCESS'] ==158))
            {
                if($dtls_arr[$val['DTLS_ID']] == "")
                {
                    $dtls_arr[$val['DTLS_ID']] = $val['DTLS_ID'];
                    $buyerDataArray[$BUYER]['GREY_USED_FIN'] +=$val['GREY_USED_QTY'];
                    $clientDataArray[$CLIENT]['GREY_USED_FIN'] +=$val['GREY_USED_QTY'];
                    $buyerIntRefDataArray[$BUYER][$INT_REF]['GREY_USED_FIN'] +=$val['GREY_USED_QTY'];
                    $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['GREY_USED_FIN'] +=$val['GREY_USED_QTY'];
                    $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['GREY_USED_FIN'] +=$val['GREY_USED_QTY'];
                }
            }
        }
    }

    $finish_iss_rcvret_sql = sql_select("SELECT a.po_breakdown_id as PO_BREAKDOWN_ID, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, g.detarmination_id as DETER_ID, g.dia_width as DIA, g.gsm as GSM, a.trans_id as TRANS_ID, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, d.booking_type as BOOKING_TYPE, b.store_id as STORE_ID , f.issue_purpose as ISSUE_PURPOSE from order_wise_pro_details a, inv_finish_fabric_issue_dtls b, pro_batch_create_mst c, wo_booking_mst d, tmp_poid e, inv_issue_master f , product_details_master g where a.dtls_id=b.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and b.mst_id=f.id and b.prod_id=g.id and a.entry_form in (18,46) and f.entry_form in (18,46) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and d.booking_type in (1,3)");

    foreach ($finish_iss_rcvret_sql as $val)
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==1 ) || $val['BOOKING_TYPE']==3)
        {
            $BUYER = $poBuyer[$val['PO_BREAKDOWN_ID']];
            $CLIENT = $poClient[$val['PO_BREAKDOWN_ID']];
            $INT_REF = $intRefClient[$val['PO_BREAKDOWN_ID']];
            $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];
            if($val['ENTRY_FORM']==18)
            {
                if($val['ISSUE_PURPOSE']==26 || $val['ISSUE_PURPOSE']==29 || $val['ISSUE_PURPOSE']==30 || $val['ISSUE_PURPOSE']==31)
                {
                    //if($val['STORE_ID']==$textile_store_id)
                    if($textile_store_id[$val['STORE_ID']] !="")
                    {
                        $buyerDataArray[$BUYER]['TEXT_ISSUE_LEFTOVER'] +=$val['QUANTITY'];
                        $clientDataArray[$CLIENT]['TEXT_ISSUE_LEFTOVER'] +=$val['QUANTITY'];
                        $buyerIntRefDataArray[$BUYER][$INT_REF]['TEXT_ISSUE_LEFTOVER'] +=$val['QUANTITY'];
                        $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['TEXT_ISSUE_LEFTOVER'] +=$val['QUANTITY'];
                        $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['TEXT_ISSUE_LEFTOVER'] +=$val['QUANTITY'];
                    }
                    else
                    {
                        $buyerDataArray[$BUYER]['GMTS_ISSUE_LEFTOVER'] +=$val['QUANTITY'];
                        $clientDataArray[$CLIENT]['GMTS_ISSUE_LEFTOVER'] +=$val['QUANTITY'];
                        $buyerIntRefDataArray[$BUYER][$INT_REF]['GMTS_ISSUE_LEFTOVER'] +=$val['QUANTITY'];
                        $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['GMTS_ISSUE_LEFTOVER'] +=$val['QUANTITY'];
                        $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['GMTS_ISSUE_LEFTOVER'] +=$val['QUANTITY'];
                    }
                }
                else if($val['ISSUE_PURPOSE']==9)
                {
                    
                    //if($val['STORE_ID']==$textile_store_id)
                    if($textile_store_id[$val['STORE_ID']] !="")
                    {
                        $buyerDataArray[$BUYER]['TEXT_FIN_ISSUE'] +=$val['QUANTITY'];
                        $clientDataArray[$CLIENT]['TEXT_FIN_ISSUE'] +=$val['QUANTITY'];
                        $buyerIntRefDataArray[$BUYER][$INT_REF]['TEXT_FIN_ISSUE'] +=$val['QUANTITY'];
                        $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['TEXT_FIN_ISSUE'] +=$val['QUANTITY'];
                        $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['TEXT_FIN_ISSUE'] +=$val['QUANTITY'];
                    }
                    else
                    {
                        $buyerDataArray[$BUYER]['GMTS_FIN_ISSUE'] +=$val['QUANTITY'];
                        $clientDataArray[$CLIENT]['GMTS_FIN_ISSUE'] +=$val['QUANTITY'];
                        $buyerIntRefDataArray[$BUYER][$INT_REF]['GMTS_FIN_ISSUE'] +=$val['QUANTITY'];
                        $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['GMTS_FIN_ISSUE'] +=$val['QUANTITY'];
                        $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['GMTS_FIN_ISSUE'] +=$val['QUANTITY'];
                    }
                }
                
            }
            //else if($val['ENTRY_FORM']==46 && ($val['STORE_ID']==$textile_store_id))
            else if($val['ENTRY_FORM']==46 && ($textile_store_id[$val['STORE_ID']] !=""))
            {
                $buyerDataArray[$BUYER]['FIN_RECV_RETURN'] +=$val['QUANTITY'];
                $clientDataArray[$CLIENT]['FIN_RECV_RETURN'] +=$val['QUANTITY'];
                $buyerIntRefDataArray[$BUYER][$INT_REF]['FIN_RECV_RETURN'] +=$val['QUANTITY'];
                $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['FIN_RECV_RETURN'] +=$val['QUANTITY'];
                $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['FIN_RECV_RETURN'] +=$val['QUANTITY'];
            } 
        }
    }

    $finish_transfer_sql = sql_select("SELECT a.transfer_criteria as TRANSFER_CRITERIA, d.po_breakdown_id as PO_BREAKDOWN_ID, d.id as ID, d.quantity as QUANTITY, d.trans_type as TRANS_TYPE, c.store_id as STORE_ID, b.from_store as FROM_STORE, b.to_store as TO_STORE, h.color as COLOR_ID, h.detarmination_id as DETER_ID, h.dia_width as DIA, h.gsm as GSM, f.fabric_source as FABRIC_SOURCE, f.booking_type as BOOKING_TYPE from inv_item_transfer_mst a, inv_item_transfer_dtls b, inv_transaction c, order_wise_pro_details d, pro_batch_create_mst e, wo_booking_mst f, tmp_poid g, product_details_master h where a.id = b.mst_id and b.id = d.dtls_id and d.trans_type in (5,6) and c.id=d.trans_id and a.entry_form=14 and d.entry_form=14 and c.pi_wo_batch_no= e.id and e.booking_no = f.booking_no and f.booking_type in (1,3) and d.po_breakdown_id=g.poid and g.userid=$user_id and c.prod_id=h.id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0");

    foreach ($finish_transfer_sql as $val) 
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==1 ) || $val['BOOKING_TYPE']==3)
        {
            $BUYER = $poBuyer[$val['PO_BREAKDOWN_ID']];
            $CLIENT = $poClient[$val['PO_BREAKDOWN_ID']];
            $INT_REF = $intRefClient[$val['PO_BREAKDOWN_ID']];
            $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];
            if($prop_arr[$val['ID']] == "")
            {
                if($val['TRANSFER_CRITERIA']==2)
                {
                    //if($val['TRANS_TYPE']==6 && $val['STORE_ID']==$textile_store_id  /*$val['FROM_STORE']==$textile_store_id*/)
                    //if($val['TRANS_TYPE']==6 && $textile_store_id[$val['STORE_ID']]!="" )
					if($val['TRANS_TYPE']==6 && $textile_store_id[$val['FROM_STORE']] !="")
                    {
                        $buyerDataArray[$BUYER]['TEXT_OUT'] +=$val['QUANTITY'];
                        $clientDataArray[$CLIENT]['TEXT_OUT'] +=$val['QUANTITY'];
                        $buyerIntRefDataArray[$BUYER][$INT_REF]['TEXT_OUT'] +=$val['QUANTITY'];
                        $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['TEXT_OUT'] +=$val['QUANTITY'];
                        $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['TEXT_OUT'] +=$val['QUANTITY'];
                    }
                    //if($val['TRANS_TYPE']==5 && $val['STORE_ID']==$textile_store_id /*$val['TO_STORE']==$textile_store_id*/)
                    if($val['TRANS_TYPE']==5 && $textile_store_id[$val['TO_STORE']]!="")
                    {
                        $buyerDataArray[$BUYER]['TEXT_IN'] +=$val['QUANTITY'];
                        $clientDataArray[$CLIENT]['TEXT_IN'] +=$val['QUANTITY'];
                        $buyerIntRefDataArray[$BUYER][$INT_REF]['TEXT_IN'] +=$val['QUANTITY'];
                        $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['TEXT_IN'] +=$val['QUANTITY'];
                        $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['TEXT_IN'] +=$val['QUANTITY'];
                    }
                    //if($val['TRANS_TYPE']==5 && $val['STORE_ID']!=$textile_store_id /*$val['TO_STORE']==$textile_store_id*/)
                    //if($val['TRANS_TYPE']==5 && $textile_store_id[$val['STORE_ID']]=="")
					if($val['TRANS_TYPE']==5 && $textile_store_id[$val['FROM_STORE']]!="" && $textile_store_id[$val['TO_STORE']]=="")
                    {
                        //Garments Store receive
                        $buyerDataArray[$BUYER]['RECV_FROM_TEXT'] +=$val['QUANTITY'];
                        $clientDataArray[$CLIENT]['RECV_FROM_TEXT'] +=$val['QUANTITY'];
                        $buyerIntRefDataArray[$BUYER][$INT_REF]['RECV_FROM_TEXT'] +=$val['QUANTITY'];
                        $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['RECV_FROM_TEXT'] +=$val['QUANTITY'];
                        $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['RECV_FROM_TEXT'] +=$val['QUANTITY'];
                    }
                }
                else
                {
                    if($val['TRANS_TYPE'] ==5)
                    {
                        $buyerDataArray[$BUYER]['GMTS_IN'] +=$val['QUANTITY'];
                        $clientDataArray[$CLIENT]['GMTS_IN'] +=$val['QUANTITY'];
                        $buyerIntRefDataArray[$BUYER][$INT_REF]['GMTS_IN'] +=$val['QUANTITY'];
                        $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['GMTS_IN'] +=$val['QUANTITY'];
                        $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['GMTS_IN'] +=$val['QUANTITY'];
                    }else{
                        $buyerDataArray[$BUYER]['GMTS_OUT'] +=$val['QUANTITY'];
                        $clientDataArray[$CLIENT]['GMTS_OUT'] +=$val['QUANTITY'];
                        $buyerIntRefDataArray[$BUYER][$INT_REF]['GMTS_OUT'] +=$val['QUANTITY'];
                        $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['GMTS_OUT'] +=$val['QUANTITY'];
                        $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['GMTS_OUT'] +=$val['QUANTITY'];
                    }
                }

                $prop_arr[$val['ID']] = $val['ID'];
            }
        }
    }

    $finish_issue_return = sql_select("SELECT a.po_breakdown_id as PO_BREAKDOWN_ID, a.entry_form as ENTRY_FORM, a.trans_id as TRANS_ID,  a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, d.booking_type as BOOKING_TYPE, f.store_id as STORE_ID, b.color as COLOR_ID, b.detarmination_id as DETER_ID, b.dia_width as DIA, b.gsm as GSM FROM order_wise_pro_details a, inv_transaction f, inv_receive_master g, pro_batch_create_mst c, wo_booking_mst d, tmp_poid e, product_details_master b WHERE a.trans_id = f.id and f.mst_id = g.id and f.pi_wo_batch_no= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and f.prod_id=b.id and a.entry_form =52 and g.entry_form =52  and a.status_active=1 and a.is_deleted=0 and f.status_active=1 and f.is_deleted=0 and d.booking_type in (1,3)");

    foreach ($finish_issue_return as $val) 
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==1 ) || $val['BOOKING_TYPE']==3)
        {
            $BUYER = $poBuyer[$val['PO_BREAKDOWN_ID']];
            $CLIENT = $poClient[$val['PO_BREAKDOWN_ID']];
            $INT_REF = $intRefClient[$val['PO_BREAKDOWN_ID']];
            $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];
            //if($val['STORE_ID'] ==$textile_store_id)
            if($textile_store_id[$val['STORE_ID']]!="")
            {
                $buyerDataArray[$BUYER]['TEXT_ISS_RET']+=$val['QUANTITY'];
                $clientDataArray[$CLIENT]['TEXT_ISS_RET']+=$val['QUANTITY'];
                $buyerIntRefDataArray[$BUYER][$INT_REF]['TEXT_ISS_RET']+=$val['QUANTITY'];
                $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['TEXT_ISS_RET']+=$val['QUANTITY'];
                $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['TEXT_ISS_RET']+=$val['QUANTITY'];
            }else{
                $buyerDataArray[$BUYER]['GMTS_ISS_RET']+=$val['QUANTITY'];
                $clientDataArray[$CLIENT]['GMTS_ISS_RET']+=$val['QUANTITY'];
                $buyerIntRefDataArray[$BUYER][$INT_REF]['GMTS_ISS_RET']+=$val['QUANTITY'];
                $buyerColorDeterGsmDiaArr[$BUYER][$INT_REF][$val['COLOR_ID']][$deter_str]['GMTS_ISS_RET']+=$val['QUANTITY'];
                $buyerColorArr[$BUYER][$INT_REF][$val['COLOR_ID']]['GMTS_ISS_RET']+=$val['QUANTITY'];
            }
        }
    }

    if($rptType==4 || $rptType==5)
    {
        $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
        if($rptType==5)
        {
            $constructtion_arr=array();
            $sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id order by b.id asc";
            $data_array_deter=sql_select($sql_deter);
            foreach( $data_array_deter as $row )
            {
                $constructtion_arr[$row[csf('id')]]=$row[csf('construction')];
                $composition_arr[$row[csf('id')]].=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ";
            }
            unset($data_array_deter);
        }
    }

    /*echo "<pre>";
    print_r($buyerColorDeterGsmDiaArr);
    echo "<pre>";
    die;*/

    $r_id2=execute_query("delete from tmp_poid where userid=$user_id");
    if($r_id2)
    {
        oci_commit($con);
    }
    
    ob_start();
    ?>
    <div class="tableContainer">  
        <style type="text/css">
        .rpt_table tr th, .rpt_table tr td,.rpt_table tfoot th{font-size:13px;}
        .word_break_wrap{
            word-wrap: break-word;
            word-break: break-all;
        }
        </style>

        <fieldset style="width:1310px;">
            <table width="100%" cellpadding="0" cellspacing="0">
                <tr><td colspan="28" align="center" style="font-size:22px;">Circular Fabric </td></tr>
                <tr>
            <td colspan="28" align="center" style="font-size:14px;">
                <input type="button" id="show_button" class="formbutton" style="width:90px;" value="Buyerwise" onClick="fn_circular_report_generated(1)" />
                <input type="button" id="show_button" class="formbutton" style="width:90px;" value="Sbuwise" onClick="fn_circular_report_generated(2)" />
                <input type="button" id="show_button" class="formbutton" style="width:90px;" value="Refwise" onClick="fn_circular_report_generated(3)" />
                <input type="button" id="show_button" class="formbutton" style="width:90px;" value="Colorwise" onClick="fn_circular_report_generated(4)" />
                <input type="button" id="show_button" class="formbutton" style="width:90px;" value="Structurewise" onClick="fn_circular_report_generated(5)" />
            </td>
                </tr>
                <tr><td colspan="28" align="center" style="font-size:17px;">SBU <span style="color: black;font-size: 18px;font-weight: bold;"> <?=($client) ? ": ".$client_array[$client] : ": All"; ?></span></td></tr>
            </table>
            <? 
            if($rptType==1 || $rptType==2 || $rptType==3)
            {
                $acting_width = $screen_size-50;
                $three_percent = $acting_width*0.03;
                $four_percent = $acting_width*0.04;
                $five_percent = $acting_width*0.05;
                ?>
                <table width="<? echo $acting_width;?>" border="1" rules="all"  class="rpt_table" align="left" > 
                    <thead>                                                                    
                        <tr>
                            <? 
                            if($rptType==1) 
                            {
                                echo "<th colspan='4'>Buyer Wise</th>";
                            }else if($rptType==2) {
                                echo "<th colspan='4'>SBU Wise</th>";
                            }
                            else if($rptType==3) {
                                echo "<th colspan='5'>Ref No Wise</th>";
                            }
                            ?>
                            
                            <th>Grey Store</th>
                            <th>Dyeing House</th>
                            <th>Finishing Floor</th>
                            <th colspan="4">Textile store</th>
                            <th colspan="6">Rmg store</th>
                            <th></th>
                            <th></th>
                            <th colspan="2">cutting</th>
                        </tr>


                        <tr>
                            <? 
                            if($rptType==1) 
                            {
                                $vari_percentage = $five_percent;
                            ?>
                                <th width="<? echo $five_percent;?>">Buyer</th>
                            <?
                            }
                            else if($rptType==2) 
                            {
                                $vari_percentage = $five_percent;
                            ?>
                                <th width="<? echo $five_percent;?>">Client</th>
                            <?
                            }
                            else 
                            {
                                $vari_percentage = $four_percent;
                            ?>
                                <th width="<? echo $five_percent;?>">Buyer</th>
                                <th width="<? echo $four_percent;?>">Ref No</th>
                            <?
                            }
                            ?>
                            <th width="<? echo $five_percent;?>">Req qty</th>
                            <th width="<? echo $four_percent;?>">Ex qty</th>
                            <th width="<? echo $five_percent;?>">Total qty</th>
                            <th width="<? echo $five_percent;?>">Stock</th>
                            <th width="<? echo $five_percent;?>">Stock</th>
                            <th width="<? echo $five_percent;?>">Stock</th>
                            <th width="<? echo $five_percent;?>">Recv From dyeing</th>
                            <th width="<? echo $five_percent;?>">Recv Bal</th>
                            <th width="<? echo $four_percent;?>">Leftover</th>
                            <th width="<? echo $five_percent;?>">stock</th> 
                            <th width="<? echo $five_percent;?>">Recv from Tex</th>
                            <th width="<? echo $vari_percentage;?>">Trans in</th>
                            <th width="<? echo $vari_percentage;?>">Trans out</th> 
                            <th width="<? echo $four_percent;?>">Leftover</th>
                            <th width="<? echo $five_percent;?>">Rcv bal</th>
                            <th width="<? echo $five_percent;?>">Stock</th>
                            <th width="<? echo $four_percent;?>">Backlog</th>
                            <th width="<? echo $four_percent;?>">Excess</th>
                            <th width="<? echo $vari_percentage;?>">Issue to cut</th>
                            <th width="<? echo $vari_percentage;?>">Issue bal</th>
                       </tr>
                    </thead>
                </table>
                <div style="max-height:425px; overflow-y:scroll; width:<? echo $acting_width + 18;?>px;" id="scroll_body">
                    <table width="<? echo $acting_width?>" border="1" rules="all"  class="rpt_table">
                        <tbody>
                            <? 
                            if($rptType==1){
                                $refDataArray = $buyerDataArray;
                            }else if($rptType==2){
                                $refDataArray = $clientDataArray;
                            }

                            if($rptType==1 || $rptType==2)
                            {
                                foreach ($refDataArray as $buyerOrClient => $row) 
                                {
                                    $total_qnty = $row['REQ_QTY'] + $row['SHORT_QTY'];
                                    $GREY_STOCK =($row['GREY_RCV'] + $row['GREY_TRIN'] + $row['GREY_ISSRETURN'])- ($row['GREY_ISSUE'] + $row['GREY_TROUT']);
                                    $DYE_HOUSE_STOCK = ($row['GREY_ISSUE']  + $row['GREY_RCVRETURN'] ) - ($row['DYE_UNLOAD'] + $row['GREY_USED_FIN'] +$row['GREY_ISSRETURN']); 
                                    $finishing_floor_stock = $row['DYE_UNLOAD'] - $row['GREY_USED_PRODUCTION'];
                                    $rcv_from_dyeing = $row['FINISH_QTY'] - $row['FIN_RECV_RETURN'];
                                    $rcv_bal = $total_qnty-$rcv_from_dyeing;
                                    $text_issue_leftover= $row['TEXT_ISSUE_LEFTOVER'];
                                    $text_stock = $rcv_from_dyeing + $row['TEXT_IN'] - ($row['TEXT_OUT'] + $text_issue_leftover);
                                    $recv_from_text = $row['RECV_FROM_TEXT'];//$row['TEXT_OUT'];
                                    $gmts_in = $row['GMTS_IN'];
                                    $gmts_out = $row['GMTS_OUT'];
                                    $rmg_issue_leftover = $row['GMTS_ISSUE_LEFTOVER'];
                                    $gmts_rcv_bal = $total_qnty - ($recv_from_text + $gmts_in - $gmts_out);
                                    $gmts_fin_issue =$row['GMTS_FIN_ISSUE'];
                                    $gmts_iss_ret =$row['GMTS_ISS_RET'];
                                    $issue_to_cut =$gmts_fin_issue - $gmts_iss_ret;
                                    //Stock= [(Recv From Tex + Trans In + Issue Return from Cutting)- (Issue to Cut+ Trans out + Leftover)]
                                    //echo "($recv_from_text + $gmts_in + $gmts_iss_ret) - ($gmts_fin_issue + $gmts_out + $rmg_issue_leftover)";
                                    $gmts_stock = ($recv_from_text + $gmts_in + $gmts_iss_ret) - ($gmts_fin_issue + $gmts_out + $rmg_issue_leftover);
                                    $issue_bal = $total_qnty - $issue_to_cut;
                                    
                                    $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                    ?>
                                    <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('str_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="str_<? echo $i; ?>" style="" valign="middle">
                                        <td align="center" width="<? echo $five_percent;?>"><? echo ($rptType==1) ? $buyer_short_name_arr[$buyerOrClient]:$client_array[$buyerOrClient];?></td>
                                        <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($row['REQ_QTY'],9,"");?></td>
                                        <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($row['SHORT_QTY'],9,"");?></td>
                                        <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($total_qnty,9,"");?></td>
                                        <td align="right" width="<? echo $five_percent;?>" title="<? echo 'rcv='.$row['GREY_RCV'] . ', tr in='.$row['GREY_TRIN'] .', iss return='.$row['GREY_ISSRETURN']. ', tr out='.$row['GREY_TROUT'] .', issue='.$row['GREY_ISSUE'];?>">
                                            <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','grey_stock_popup')" >
                                            <? 
                                                echo decimal_format($GREY_STOCK,9,"");
                                            ?>
                                            </a>
                                        </td>
                                        
                                        <td align="right" width="<? echo $five_percent;?>" title="<? echo "(grey issue= ".$row['GREY_ISSUE']  .", + rcv return=". $row['GREY_RCVRETURN'] .") - (dye unload= ".$row['DYE_UNLOAD'] .", + grey used". $row['GREY_USED_FIN'].", issue return=".$row['GREY_ISSRETURN'].")";?>">
                                            <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','dye_house_popup')" >
                                                    <? echo decimal_format($DYE_HOUSE_STOCK,9,"");?>
                                            </a>
                                            
                                        </td>

                                        <td align="right" width="<? echo $five_percent;?>">
                                            <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','finishing_floor_popup')" >
                                                <? 
                                                echo decimal_format($finishing_floor_stock,9,"");
                                                ?>
                                            </a>
                                        </td>
                                        <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($rcv_from_dyeing,9,"");?></td>
                                        <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($rcv_bal,9,"");?></td>
                                        <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($text_issue_leftover,9,"");?></td>
                                        <td align="right" width="<? echo $five_percent;?>">
                                            <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','textile_stock_popup')" >
                                                <? echo decimal_format($text_stock,9,"");?>
                                            </a>
                                        </td> 
                                        <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($recv_from_text,9,"");?></td>
                                        <td align="right" width="<? echo $vari_percentage;?>"><? echo decimal_format($gmts_in,9,"");?></td>
                                        <td align="right" width="<? echo $vari_percentage;?>"><? echo decimal_format($gmts_out,9,"");?></td> 
                                        <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($rmg_issue_leftover,9,"");?></td>
                                        <td align="right" width="<? echo $five_percent;?>" title="Rcv Bal= [Total Qty-(Recv from Tex + Trans In - Trans out)]"><? echo decimal_format($gmts_rcv_bal,9,"");?></td>
                                        <td align="right" width="<? echo $five_percent;?>" title="Stock= [(Recv From Tex + Trans In + Issue Return from Cutting)- (Issue to Cut+ Trans out + Leftover)]">
                                            <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','garments_stock_popup')" >
                                                <? echo decimal_format($gmts_stock,9,"");?>
                                            </a>
                                        </td>
                                        <td align="right" width="<? echo $four_percent;?>">&nbsp;</td>
                                        <td align="right" width="<? echo $four_percent;?>">&nbsp;</td>
                                        <td align="right" width="<? echo $vari_percentage;?>">
                                            <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','cutting_floor_issue_popup')" >
                                                <? echo decimal_format($issue_to_cut,9,"");?>
                                            </a>
                                        </td>
                                        <td align="right" width="<? echo $vari_percentage;?>"><? echo decimal_format($issue_bal,9,"");?></td>
                                    </tr>
                                    <? 
                                    $i++;

                                    $grand_req_qnty += $row['REQ_QTY'];
                                    $grand_ex_qnty  += $row['SHORT_QTY'];
                                    $grand_total_qnty += $total_qnty;
                                    $grand_grey_stock += $GREY_STOCK;
                                    $grand_house_stock +=$DYE_HOUSE_STOCK;
                                    $grand_finishing_floor_stock +=$finishing_floor_stock;
                                    $grand_rcv_from_dyeing +=$rcv_from_dyeing;
                                    $grand_rcv_bal +=$rcv_bal;
                                    $grand_text_issue_leftover += $text_issue_leftover;
                                    $grand_text_stock += $text_stock;
                                    $grand_recv_from_text += $recv_from_text;
                                    $grand_gmts_in += $gmts_in;
                                    $grand_gmts_out += $gmts_out;
                                    $grand_rmg_issue_leftover += $rmg_issue_leftover;
                                    $grand_gmts_rcv_bal += $gmts_rcv_bal;
                                    $grand_gmts_stock += $gmts_stock;
                                    $grand_issue_to_cut +=$issue_to_cut;
                                    $grand_issue_bal +=$issue_bal;
                                }
                            }
                            else if($rptType==3)
                            {
                                $i=1;
                                foreach ($buyerIntRefDataArray as $buyerID => $buyerData) 
                                {
                                    $y=1;
                                    foreach ($buyerData as $intRef => $row) 
                                    {
                                        $total_qnty = $row['REQ_QTY'] + $row['SHORT_QTY'];
                                        $GREY_STOCK =($row['GREY_RCV'] + $row['GREY_TRIN'] + $row['GREY_ISSRETURN'])- ($row['GREY_ISSUE'] + $row['GREY_TROUT']);
                                        $DYE_HOUSE_STOCK = ($row['GREY_ISSUE']  + $row['GREY_RCVRETURN'] ) - ($row['DYE_UNLOAD'] + $row['GREY_USED_FIN'] +$row['GREY_ISSRETURN']); 
                                        $finishing_floor_stock = $row['DYE_UNLOAD'] - $row['GREY_USED_PRODUCTION'];
                                        $rcv_from_dyeing = $row['FINISH_QTY'] - $row['FIN_RECV_RETURN'];
                                        $rcv_bal = $total_qnty-$rcv_from_dyeing;
                                        $text_issue_leftover= $row['TEXT_ISSUE_LEFTOVER'];
                                        $text_stock = $rcv_from_dyeing + $row['TEXT_IN'] - ($row['TEXT_OUT'] + $text_issue_leftover);
                                        $recv_from_text = $row['RECV_FROM_TEXT'];//$row['TEXT_OUT'];
                                        $gmts_in = $row['GMTS_IN'];
                                        $gmts_out = $row['GMTS_OUT'];
                                        $rmg_issue_leftover = $row['GMTS_ISSUE_LEFTOVER'];
                                        $gmts_rcv_bal = $total_qnty - ($recv_from_text + $gmts_in - $gmts_out);
                                        $gmts_fin_issue =$row['GMTS_FIN_ISSUE'];
                                        $gmts_iss_ret =$row['GMTS_ISS_RET'];
                                        $issue_to_cut =$gmts_fin_issue - $gmts_iss_ret;
                                        //Stock= [(Recv From Tex + Trans In + Issue Return from Cutting)- (Issue to Cut+ Trans out + Leftover)]
                                        $gmts_stock = ($recv_from_text + $gmts_in + $gmts_iss_ret) - ($gmts_fin_issue + $gmts_out + $rmg_issue_leftover);
                                        $issue_bal = $total_qnty - $issue_to_cut;
                                        
                                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                        ?>
                                        <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('str_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="str_<? echo $i; ?>" style="" valign="middle">
                                            <? 
                                            if($y==1)
                                            {
                                             ?>
                                                <td align="center" width="<? echo $five_percent;?>" rowspan="<? echo count($buyerData)?>"><? echo $buyer_short_name_arr[$buyerID];?></td>
                                            <?
                                            }
                                            ?>
                                            <td align="center" width="<? echo $four_percent;?>"><? echo $intRef;?></td>

                                            <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($row['REQ_QTY'],9,"");?></td>
                                            <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($row['SHORT_QTY'],9,"");?></td>
                                            <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($total_qnty,9,"");?></td>
                                            <td align="right" width="<? echo $five_percent;?>" title="<? echo 'rcv='.$row['GREY_RCV'] . ', tr in='.$row['GREY_TRIN'] .', iss return='.$row['GREY_ISSRETURN'] . ', tr out='.$row['GREY_TROUT'] .', issue='.$row['GREY_ISSUE'];?>">
                                                <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','grey_stock_popup')" >
                                                    <? echo decimal_format($GREY_STOCK,9,"");?>
                                                </a>
                                            </td>
                                            
                                            <td align="right" width="<? echo $five_percent;?>" title="<? echo "(grey issue= ".$row['GREY_ISSUE']  .", + rcv return=". $row['GREY_RCVRETURN'] .") - (dye unload= ".$row['DYE_UNLOAD'] .", + grey used= ". $row['GREY_USED_FIN']." + issue return=".$row['GREY_ISSRETURN'].")";?>">
                                                <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','dye_house_popup')" >
                                                    <? echo decimal_format($DYE_HOUSE_STOCK,9,"");?>
                                                </a>
                                                
                                            </td>

                                            <td align="right" width="<? echo $five_percent;?>">
                                                <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','finishing_floor_popup')" >
                                                    <? echo decimal_format($finishing_floor_stock,9,"");?>
                                                </a>
                                            </td>
                                            <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($rcv_from_dyeing,9,"");?></td>
                                            <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($rcv_bal,9,"");?></td>
                                            <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($text_issue_leftover,9,"");?></td>
                                            <td align="right" width="<? echo $five_percent;?>">
                                                <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','textile_stock_popup')" >
                                                    <? echo decimal_format($text_stock,9,"");?>
                                                </a>
                                            </td> 
                                            <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($recv_from_text,9,"");?></td>
                                            <td align="right" width="<? echo $vari_percentage;?>"><? echo decimal_format($gmts_in,9,"");?></td>
                                            <td align="right" width="<? echo $vari_percentage;?>"><? echo decimal_format($gmts_out,9,"");?></td> 
                                            <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($rmg_issue_leftover,9,"");?></td>
                                            <td align="right" width="<? echo $five_percent;?>" title="Rcv Bal= [Total Qty-(Recv from Tex + Trans In - Trans out)]"><? echo decimal_format($gmts_rcv_bal,9,"");?></td>
                                            <td align="right" width="<? echo $five_percent;?>" title="Stock= [(Recv From Tex + Trans In + Issue Return from Cutting)- (Issue to Cut+ Trans out + Leftover)]">
                                                <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','garments_stock_popup')" >
                                                    <? echo decimal_format($gmts_stock,9,"");?>
                                                </a>
                                            </td>
                                            <td align="right" width="<? echo $four_percent;?>">Backlog</td>
                                            <td align="right" width="<? echo $four_percent;?>">Excess</td>
                                            <td align="right" width="<? echo $vari_percentage;?>">
                                                <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','cutting_floor_issue_popup')" >
                                                    <? echo decimal_format($issue_to_cut,9,"");?>
                                                </a>
                                            </td>
                                            <td align="right" width="<? echo $vari_percentage;?>"><? echo decimal_format($issue_bal,9,"");?></td>
                                        </tr>
                                        <? 
                                        $i++;$y++;

                                        $sub_req_qnty += $row['REQ_QTY'];
                                        $sub_ex_qnty  += $row['SHORT_QTY'];
                                        $sub_total_qnty += $total_qnty;
                                        $sub_grey_stock += $GREY_STOCK;
                                        $sub_house_stock +=$DYE_HOUSE_STOCK;
                                        $sub_finishing_floor_stock +=$finishing_floor_stock;
                                        $sub_rcv_from_dyeing +=$rcv_from_dyeing;
                                        $sub_rcv_bal +=$rcv_bal;
                                        $sub_text_issue_leftover += $text_issue_leftover;
                                        $sub_text_stock += $text_stock;
                                        $sub_recv_from_text += $recv_from_text;
                                        $sub_gmts_in += $gmts_in;
                                        $sub_gmts_out += $gmts_out;
                                        $sub_rmg_issue_leftover += $rmg_issue_leftover;
                                        $sub_gmts_rcv_bal += $gmts_rcv_bal;
                                        $sub_gmts_stock += $gmts_stock;
                                        $sub_issue_to_cut +=$issue_to_cut;
                                        $sub_issue_bal +=$issue_bal;

                                        $grand_req_qnty += $row['REQ_QTY'];
                                        $grand_ex_qnty  += $row['SHORT_QTY'];
                                        $grand_total_qnty += $total_qnty;
                                        $grand_grey_stock += $GREY_STOCK;
                                        $grand_house_stock +=$DYE_HOUSE_STOCK;
                                        $grand_finishing_floor_stock +=$finishing_floor_stock;
                                        $grand_rcv_from_dyeing +=$rcv_from_dyeing;
                                        $grand_rcv_bal +=$rcv_bal;
                                        $grand_text_issue_leftover += $text_issue_leftover;
                                        $grand_text_stock += $text_stock;
                                        $grand_recv_from_text += $recv_from_text;
                                        $grand_gmts_in += $gmts_in;
                                        $grand_gmts_out += $gmts_out;
                                        $grand_rmg_issue_leftover += $rmg_issue_leftover;
                                        $grand_gmts_rcv_bal += $gmts_rcv_bal;
                                        $grand_gmts_stock += $gmts_stock;
                                        $grand_issue_to_cut +=$issue_to_cut;
                                        $grand_issue_bal +=$issue_bal;
                                    }

                                    ?>
                                    <tr bgcolor="#ccc">
                                        <td align="center" width="<? echo $five_percent +$four_percent;?>" colspan="2">Buyer Total</td>
                                        <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_req_qnty,9,"");?></td>
                                        <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_ex_qnty,9,"");?></td>
                                        <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_total_qnty,9,"");?></td>
                                        <td align="right" width="<? echo $five_percent;?>" ><? echo decimal_format($sub_grey_stock,9,"");?></td>
                                        
                                        <td align="right" width="<? echo $five_percent;?>" ><? echo decimal_format($sub_house_stock,9,"");?></td>

                                        <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_finishing_floor_stock,9,"");?></td>
                                        <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_rcv_from_dyeing,9,"");?></td>
                                        <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_rcv_bal,9,"");?></td>
                                        <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_text_issue_leftover,9,"");?></td>
                                        <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_text_stock,9,"");?></td> 
                                        <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_recv_from_text,9,"");?></td>
                                        <td align="right" width="<? echo $vari_percentage;?>"><? echo decimal_format($sub_gmts_in,9,"");?></td>
                                        <td align="right" width="<? echo $vari_percentage;?>"><? echo decimal_format($sub_gmts_out,9,"");?></td> 
                                        <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_rmg_issue_leftover,9,"");?></td>
                                        <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_gmts_rcv_bal,9,"");?></td>
                                        <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_gmts_stock,9,"");?></td>
                                        <td align="right" width="<? echo $four_percent;?>">&nbsp;</td>
                                        <td align="right" width="<? echo $four_percent;?>">&nbsp;</td>
                                        <td align="right" width="<? echo $vari_percentage;?>"><? echo decimal_format($sub_issue_to_cut,9,"");?></td>
                                        <td align="right" width="<? echo $vari_percentage;?>"><? echo decimal_format($sub_issue_bal,9,"");?></td>
                                    </tr>

                                    <?
                                    $sub_req_qnty =$sub_ex_qnty=$sub_total_qnty =$sub_grey_stock=$sub_house_stock=$sub_finishing_floor_stock=$sub_rcv_from_dyeing=$sub_rcv_bal=$sub_text_issue_leftover=$sub_text_stock=$sub_recv_from_text=$sub_gmts_in=$sub_gmts_out=$sub_rmg_issue_leftover=$sub_gmts_rcv_bal=$sub_gmts_stock=$sub_issue_to_cut=$sub_issue_bal=0;
                                }
                            }

                           ?>
                        </tbody>
                    </table>
                </div>
                <table width="<? echo $acting_width?>" border="1" rules="all"  class="rpt_table" align="left">
                    <tfoot>
                        <tr>
                            <? 
                            if($rptType==1) 
                            {
                                $vari_percentage = $five_percent;
                            ?>
                                <th width="<? echo $five_percent;?>">&nbsp;</th>
                            <?
                            }
                            else if($rptType==2) 
                            {
                                $vari_percentage = $five_percent;
                            ?>
                                <th width="<? echo $five_percent;?>">&nbsp;</th>
                            <?
                            }
                            else 
                            {
                                $vari_percentage = $four_percent;
                            ?>
                                <th width="<? echo $five_percent;?>">&nbsp;</th>
                                <th width="<? echo $four_percent;?>">&nbsp;</th>
                            <?
                            }
                            ?>
                            <th align="right" width="<? echo $five_percent;?>"><? echo decimal_format($grand_req_qnty,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_ex_qnty,9,"");?></th>
                            <th align="right" width="<? echo $five_percent;?>"><? echo decimal_format($grand_total_qnty,9,"");?></th>
                            <th align="right" width="<? echo $five_percent;?>"><? echo decimal_format($grand_grey_stock,9,"");?></th>
                            <th align="right" width="<? echo $five_percent;?>"><? echo decimal_format($grand_house_stock,9,"");?></th>
                            <th align="right" width="<? echo $five_percent;?>"><? echo decimal_format($grand_finishing_floor_stock,9,"");?></th>
                            <th align="right" width="<? echo $five_percent;?>"><? echo decimal_format($grand_rcv_from_dyeing,9,"");?></th>
                            <th align="right" width="<? echo $five_percent;?>"><? echo decimal_format($grand_rcv_bal,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_text_issue_leftover,9,"");?></th>
                            <th align="right" width="<? echo $five_percent;?>"><? echo decimal_format($grand_text_stock,9,"");?></th> 
                            <th align="right" width="<? echo $five_percent;?>"><? echo decimal_format($grand_recv_from_text,9,"");?></th>
                            <th align="right" width="<? echo $vari_percentage;?>"><? echo decimal_format($grand_gmts_in,9,"");?></th>
                            <th align="right" width="<? echo $vari_percentage;?>"><? echo decimal_format($grand_gmts_out,9,"");?></th> 
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_rmg_issue_leftover,9,"");?></th>
                            <th align="right" width="<? echo $five_percent;?>"><? echo decimal_format($grand_gmts_rcv_bal,9,"");?></th>
                            <th align="right" width="<? echo $five_percent;?>"><? echo decimal_format($grand_gmts_stock,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? //echo ;?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? //echo ;?></th>
                            <th align="right" width="<? echo $vari_percentage;?>"><? echo decimal_format($grand_issue_to_cut,9,"");?></th>
                            <th align="right" width="<? echo $vari_percentage;?>"><? echo decimal_format($grand_issue_bal,9,"");?></th>
                        </tr>
                    </tfoot>
                </table>
                <?
            }
            else if($rptType==4)
            {
                $acting_width = $screen_size-50;
                $three_percent = $acting_width*0.03;
                $four_percent = $acting_width*0.04;
                $five_percent = $acting_width*0.05;
                $six_percent = $acting_width*0.06;
                ?>
                <table width="<? echo $acting_width;?>" border="1" rules="all"  class="rpt_table" align="left" > 
                    <thead>                                                                    
                        <tr>
                            <th colspan='6'>Color Wise</th>
                            <th>Grey Store</th>
                            <th>Dyeing House</th>
                            <th>Finishing Floor</th>
                            <th colspan="4">Textile store</th>
                            <th colspan="6">Rmg store</th>
                            <th></th>
                            <th></th>
                            <th colspan="2">cutting</th>
                        </tr>

                        <tr>
                            <th width="<? echo $six_percent;?>">Buyer</th>
                            <th width="<? echo $six_percent;?>">Ref No</th>
                            <th width="<? echo $six_percent;?>">color</th>
                            <th width="<? echo $four_percent;?>">Req qty</th>
                            <th width="<? echo $four_percent;?>">Ex qty</th>
                            <th width="<? echo $four_percent;?>">Total qty</th>
                            <th width="<? echo $six_percent;?>">Stock</th>
                            <th width="<? echo $four_percent;?>">Stock</th>
                            <th width="<? echo $four_percent;?>">Stock</th>
                            <th width="<? echo $four_percent;?>">Recv From dyeing</th>
                            <th width="<? echo $four_percent;?>">Recv Bal</th>
                            <th width="<? echo $four_percent;?>">Leftover</th>
                            <th width="<? echo $four_percent;?>">stock</th> 
                            <th width="<? echo $four_percent;?>">Recv from Tex</th>
                            <th width="<? echo $four_percent;?>">Trans in</th>
                            <th width="<? echo $four_percent;?>">Trans out</th> 
                            <th width="<? echo $four_percent;?>">Leftover</th>
                            <th width="<? echo $four_percent;?>">Rcv bal</th>
                            <th width="<? echo $four_percent;?>">Stock</th>
                            <th width="<? echo $four_percent;?>">Backlog</th>
                            <th width="<? echo $four_percent;?>">Excess</th>
                            <th width="<? echo $four_percent;?>">Issue to cut</th>
                            <th width="<? echo $four_percent;?>">Issue bal</th>
                       </tr>
                    </thead>
                </table>
                <div style="max-height:425px; overflow-y:scroll; width:<? echo $acting_width + 18;?>px;" id="scroll_body">
                    <table width="<? echo $acting_width?>" border="1" rules="all"  class="rpt_table">
                        <tbody>
                            <? 
                            foreach ($buyerColorArr as $buyerID => $buyerData) 
                            {
                                foreach ($buyerData as $intRef => $intRefData) 
                                {
                                    foreach ($intRefData as $COLORID => $row) 
                                    {
                                        $td_span_buyer_ref_arr[$buyerID][$intRef]++;
                                        $td_span_buyer_arr[$buyerID]++;
                                    }
                                }
                            }

                            $i=1;
                            foreach ($buyerColorArr as $buyerID => $buyerData) 
                            {
                                $y=1;
                                foreach ($buyerData as $intRef => $intRefData) 
                                {
                                    $r=1;
                                    foreach ($intRefData as $COLORID => $row) 
                                    {
                                        $deterArr = explode("*", $deterString);
                                        $deter_id = $deterArr[0];
                                        $gsm = $deterArr[1];
                                        $dia = $deterArr[2];

                                        $total_qnty = $row['REQ_QTY'] + $row['SHORT_QTY'];
                                        $GREY_STOCK =($row['GREY_RCV'] + $row['GREY_TRIN'] + $row['GREY_ISSRETURN'])- ($row['GREY_ISSUE'] + $row['GREY_TROUT']);
                                        $DYE_HOUSE_STOCK = ($row['GREY_ISSUE']  + $row['GREY_RCVRETURN'] ) - ($row['DYE_UNLOAD'] + $row['GREY_USED_FIN'] + $row['GREY_ISSRETURN']); 

                                        $finishing_floor_stock = $row['DYE_UNLOAD'] - $row['GREY_USED_PRODUCTION'];
                                        $rcv_from_dyeing = $row['FINISH_QTY'] - $row['FIN_RECV_RETURN'];
                                        $rcv_bal = $total_qnty-$rcv_from_dyeing;
                                        $text_issue_leftover= $row['TEXT_ISSUE_LEFTOVER'];
                                        $text_stock = $rcv_from_dyeing + $row['TEXT_IN'] - ($row['TEXT_OUT'] + $text_issue_leftover);
                                        $recv_from_text = $row['RECV_FROM_TEXT'];//$row['TEXT_OUT'];
                                        $gmts_in = $row['GMTS_IN'];
                                        $gmts_out = $row['GMTS_OUT'];
                                        $rmg_issue_leftover = $row['GMTS_ISSUE_LEFTOVER'];
                                        $gmts_rcv_bal = $total_qnty - ($recv_from_text + $gmts_in - $gmts_out);
                                        $gmts_fin_issue =$row['GMTS_FIN_ISSUE'];
                                        $gmts_iss_ret =$row['GMTS_ISS_RET'];
                                        $issue_to_cut =$gmts_fin_issue - $gmts_iss_ret;
                                        //Stock= [(Recv From Tex + Trans In + Issue Return from Cutting)- (Issue to Cut+ Trans out + Leftover)]
                                        $gmts_stock = ($recv_from_text + $gmts_in + $gmts_iss_ret) - ($gmts_fin_issue + $gmts_out + $rmg_issue_leftover);
                                        $issue_bal = $total_qnty - $issue_to_cut;
                                        
                                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                        ?>
                                        <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('str_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="str_<? echo $i; ?>" style="" valign="middle">
                                            <? 
                                            if($y==1)
                                            {
                                             ?>
                                                <td align="center" width="<? echo $six_percent;?>" rowspan="<? echo $td_span_buyer_arr[$buyerID]?>"><? echo $buyer_short_name_arr[$buyerID];?></td>
                                            <?
                                            }
                                            if($r==1)
                                            {
                                            ?>
                                            <td align="center" width="<? echo $six_percent;?>" rowspan="<? echo $td_span_buyer_ref_arr[$buyerID][$intRef];?>"><? echo $intRef;?></td>
                                            <?
                                            }
                                            
                                            ?>
                                            <td align="center" class="word_break_wrap" width="<? echo $six_percent;?>" title="<? echo $lib_color[$COLORID];?>"><? echo substr($lib_color[$COLORID],0,7);?></td>
                                            

                                            <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($row['REQ_QTY'],9,"");?></td>
                                            <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($row['SHORT_QTY'],9,"");?></td>
                                            <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($total_qnty,9,"");?></td>
                                            <td align="right" width="<? echo $six_percent;?>" title="<? echo 'rcv='.$row['GREY_RCV'] . ', tr in='.$row['GREY_TRIN'] .', iss return='.$row['GREY_ISSRETURN'] . ', tr out='.$row['GREY_TROUT'] .', issue='.$row['GREY_ISSUE'];?>">
                                                <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','grey_stock_popup')" >
                                                    <? echo decimal_format($GREY_STOCK,9,"");?>
                                                </a>
                                            </td>
                                            
                                            <td align="right" width="<? echo $four_percent;?>" title="<? echo "(grey issue= ".$row['GREY_ISSUE']  .", + rcv return=". $row['GREY_RCVRETURN'] .") - (dye unload= ".$row['DYE_UNLOAD'] .", + grey used=". $row['GREY_USED_FIN'].", + issue return=".$row['GREY_ISSRETURN'].")";?>">
                                                <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','dye_house_popup')" >
                                                    <? echo decimal_format($DYE_HOUSE_STOCK,9,"");?>
                                                </a>
                                                
                                            </td>

                                            <td align="right" width="<? echo $four_percent;?>" title="<? echo 'unload='.$row['DYE_UNLOAD'] .'-used production='. $row['GREY_USED_PRODUCTION'];?>">
                                                <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','finishing_floor_popup')" >
                                                    <? echo decimal_format($finishing_floor_stock,9,"");?>
                                                </a>
                                            </td>
                                            <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($rcv_from_dyeing,9,"");?></td>
                                            <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($rcv_bal,9,"");?></td>
                                            <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($text_issue_leftover,9,"");?></td>
                                            <td align="right" width="<? echo $four_percent;?>">
                                                <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','textile_stock_popup')" >
                                                    <? echo decimal_format($text_stock,9,"");?>
                                                </a>
                                            </td> 
                                            <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($recv_from_text,9,"");?></td>
                                            <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($gmts_in,9,"");?></td>
                                            <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($gmts_out,9,"");?></td> 
                                            <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($rmg_issue_leftover,9,"");?></td>
                                            <td align="right" width="<? echo $four_percent;?>" title="Rcv Bal= [Total Qty-(Recv from Tex + Trans In - Trans out)]"><? echo decimal_format($gmts_rcv_bal,9,"");?></td>
                                            <td align="right" width="<? echo $four_percent;?>" title="Stock= [(Recv From Tex + Trans In + Issue Return from Cutting)- (Issue to Cut+ Trans out + Leftover)]">
                                                <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','garments_stock_popup')" >
                                                    <? echo decimal_format($gmts_stock,9,"");?>
                                                </a>
                                            </td>
                                            <td align="right" width="<? echo $four_percent;?>">&nbsp;</td>
                                            <td align="right" width="<? echo $four_percent;?>">&nbsp;</td>
                                            <td align="right" width="<? echo $four_percent;?>">
                                                <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','cutting_floor_issue_popup')" >
                                                    <? echo decimal_format($issue_to_cut,9,"");?>
                                                </a>
                                            </td>
                                            <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($issue_bal,9,"");?></td>
                                        </tr>
                                        <? 
                                        $i++;$y++;$r++;

                                        $sub_req_qnty += $row['REQ_QTY'];
                                        $sub_ex_qnty  += $row['SHORT_QTY'];
                                        $sub_total_qnty += $total_qnty;
                                        $sub_grey_stock += $GREY_STOCK;
                                        $sub_house_stock +=$DYE_HOUSE_STOCK;
                                        $sub_finishing_floor_stock +=$finishing_floor_stock;
                                        $sub_rcv_from_dyeing +=$rcv_from_dyeing;
                                        $sub_rcv_bal +=$rcv_bal;
                                        $sub_text_issue_leftover += $text_issue_leftover;
                                        $sub_text_stock += $text_stock;
                                        $sub_recv_from_text += $recv_from_text;
                                        $sub_gmts_in += $gmts_in;
                                        $sub_gmts_out += $gmts_out;
                                        $sub_rmg_issue_leftover += $rmg_issue_leftover;
                                        $sub_gmts_rcv_bal += $gmts_rcv_bal;
                                        $sub_gmts_stock += $gmts_stock;
                                        $sub_issue_to_cut +=$issue_to_cut;
                                        $sub_issue_bal +=$issue_bal;

                                        $grand_req_qnty += $row['REQ_QTY'];
                                        $grand_ex_qnty  += $row['SHORT_QTY'];
                                        $grand_total_qnty += $total_qnty;
                                        $grand_grey_stock += $GREY_STOCK;
                                        $grand_house_stock +=$DYE_HOUSE_STOCK;
                                        $grand_finishing_floor_stock +=$finishing_floor_stock;
                                        $grand_rcv_from_dyeing +=$rcv_from_dyeing;
                                        $grand_rcv_bal +=$rcv_bal;
                                        $grand_text_issue_leftover += $text_issue_leftover;
                                        $grand_text_stock += $text_stock;
                                        $grand_recv_from_text += $recv_from_text;
                                        $grand_gmts_in += $gmts_in;
                                        $grand_gmts_out += $gmts_out;
                                        $grand_rmg_issue_leftover += $rmg_issue_leftover;
                                        $grand_gmts_rcv_bal += $gmts_rcv_bal;
                                        $grand_gmts_stock += $gmts_stock;
                                        $grand_issue_to_cut +=$issue_to_cut;
                                        $grand_issue_bal +=$issue_bal;
                                    }
                                }

                                ?>
                                <tr bgcolor="#ccc">
                                    <td align="center" width="<? echo $six_percent +$six_percent+$six_percent;?>" colspan="3">Buyer Total</td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_req_qnty,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_ex_qnty,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_total_qnty,9,"");?></td>
                                    <td align="right" width="<? echo $six_percent;?>" ><? echo decimal_format($sub_grey_stock,9,"");?></td>
                                    
                                    <td align="right" width="<? echo $four_percent;?>" ><? echo decimal_format($sub_house_stock,9,"");?></td>

                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_finishing_floor_stock,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_rcv_from_dyeing,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_rcv_bal,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_text_issue_leftover,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_text_stock,9,"");?></td> 
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_recv_from_text,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_gmts_in,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_gmts_out,9,"");?></td> 
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_rmg_issue_leftover,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_gmts_rcv_bal,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_gmts_stock,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $four_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_issue_to_cut,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_issue_bal,9,"");?></td>
                                </tr>

                                <?
                                $sub_req_qnty =$sub_ex_qnty=$sub_total_qnty =$sub_grey_stock=$sub_house_stock=$sub_finishing_floor_stock=$sub_rcv_from_dyeing=$sub_rcv_bal=$sub_text_issue_leftover=$sub_text_stock=$sub_recv_from_text=$sub_gmts_in=$sub_gmts_out=$sub_rmg_issue_leftover=$sub_gmts_rcv_bal=$sub_gmts_stock=$sub_issue_to_cut=$sub_issue_bal=0;
                            }

                           ?>
                        </tbody>
                    </table>
                </div>
                <table width="<? echo $acting_width?>" border="1" rules="all"  class="rpt_table" align="left">
                    <tfoot>
                        <tr>
                            <th width="<? echo $six_percent;?>">&nbsp;</th>
                            <th width="<? echo $six_percent;?>">&nbsp;</th>
                            <th width="<? echo $six_percent;?>">&nbsp;</th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_req_qnty,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_ex_qnty,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_total_qnty,9,"");?></th>
                            <th align="right" width="<? echo $six_percent;?>"><? echo decimal_format($grand_grey_stock,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_house_stock,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_finishing_floor_stock,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_rcv_from_dyeing,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_rcv_bal,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_text_issue_leftover,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_text_stock,9,"");?></th> 
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_recv_from_text,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_gmts_in,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_gmts_out,9,"");?></th> 
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_rmg_issue_leftover,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_gmts_rcv_bal,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_gmts_stock,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? //echo ;?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? //echo ;?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_issue_to_cut,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_issue_bal,9,"");?></th>
                        </tr>
                    </tfoot>
                </table>
                <?
            }
            else if($rptType==5)
            {
                $acting_width = $screen_size-50;
                $three_percent = $acting_width*0.03;
                $four_percent = $acting_width*0.04;
                $five_percent = $acting_width*0.05;
                ?>
                <table width="<? echo $acting_width;?>" border="1" rules="all"  class="rpt_table" align="left" > 
                    <thead>                                                                    
                        <tr>
                            <th colspan='9'>Structure Wise</th>
                            <th>Grey Store</th>
                            <th>Dyeing House</th>
                            <th>Finishing Floor</th>
                            <th colspan="4">Textile store</th>
                            <th colspan="6">Rmg store</th>
                            <th></th>
                            <th></th>
                            <th colspan="2">cutting</th>
                        </tr>

                        <tr>
                            <th width="<? echo $four_percent;?>">Buyer</th>
                            <th width="<? echo $four_percent;?>">Ref No</th>
                            <th width="<? echo $four_percent;?>">color</th>
                            <th width="<? echo $four_percent;?>">Structure</th>
                            <th width="<? echo $three_percent;?>">GSM</th>
                            <th width="<? echo $three_percent;?>">Finish Dia</th>
                            <th width="<? echo $four_percent;?>">Req qty</th>
                            <th width="<? echo $three_percent;?>">Ex qty</th>
                            <th width="<? echo $four_percent;?>">Total qty</th>
                            <th width="<? echo $four_percent;?>">Stock</th>
                            <th width="<? echo $four_percent;?>">Stock</th>
                            <th width="<? echo $four_percent;?>">Stock</th>
                            <th width="<? echo $four_percent;?>">Recv From dyeing</th>
                            <th width="<? echo $four_percent;?>">Recv Bal</th>
                            <th width="<? echo $four_percent;?>">Leftover</th>
                            <th width="<? echo $four_percent;?>">stock</th> 
                            <th width="<? echo $four_percent;?>">Recv from Tex</th>
                            <th width="<? echo $four_percent;?>">Trans in</th>
                            <th width="<? echo $four_percent;?>">Trans out</th> 
                            <th width="<? echo $four_percent;?>">Leftover</th>
                            <th width="<? echo $four_percent;?>">Rcv bal</th>
                            <th width="<? echo $four_percent;?>">Stock</th>
                            <th width="<? echo $four_percent;?>">Backlog</th>
                            <th width="<? echo $four_percent;?>">Excess</th>
                            <th width="<? echo $four_percent;?>">Issue to cut</th>
                            <th width="<? echo $three_percent;?>">Issue bal</th>
                       </tr>
                    </thead>
                </table>
                <div style="max-height:425px; overflow-y:scroll; width:<? echo $acting_width + 18;?>px;" id="scroll_body">
                    <table width="<? echo $acting_width?>" border="1" rules="all"  class="rpt_table">
                        <tbody>
                            <? 
                            foreach ($buyerColorDeterGsmDiaArr as $buyerID => $buyerData) 
                            {
                               //$td_span_buyer=0;
                                foreach ($buyerData as $intRef => $intRefData) 
                                {
                                    foreach ($intRefData as $COLORID => $colorData) 
                                    {
                                        foreach ($colorData as $deterString => $row) 
                                        {
                                            $td_span_buyer_ref_color_arr[$buyerID][$intRef][$COLORID]++;
                                            $td_span_buyer_ref_arr[$buyerID][$intRef]++;
                                            $td_span_buyer_arr[$buyerID]++;
                                        }
                                    }
                                }
                            }

                            $i=1;
                            foreach ($buyerColorDeterGsmDiaArr as $buyerID => $buyerData) 
                            {
                                $y=1;
                                foreach ($buyerData as $intRef => $intRefData) 
                                {
                                    $r=1;
                                    foreach ($intRefData as $COLORID => $colorData) 
                                    {
                                        $c=1;
                                        foreach ($colorData as $deterString => $row) 
                                        {
                                            $deterArr = explode("*", $deterString);
                                            $deter_id = $deterArr[0];
                                            $gsm = $deterArr[1];
                                            $dia = $deterArr[2];

                                            $total_qnty = $row['REQ_QTY'] + $row['SHORT_QTY'];
                                            $GREY_STOCK =($row['GREY_RCV'] + $row['GREY_TRIN'] + $row['GREY_ISSRETURN'])- ($row['GREY_ISSUE'] + $row['GREY_TROUT']);
                                            $DYE_HOUSE_STOCK = ($row['GREY_ISSUE']  + $row['GREY_RCVRETURN'] ) - ($row['DYE_UNLOAD'] + $row['GREY_USED_FIN'] + $row['GREY_ISSRETURN']); 
                                            $finishing_floor_stock = $row['DYE_UNLOAD'] - $row['GREY_USED_PRODUCTION'];
                                            $rcv_from_dyeing = $row['FINISH_QTY'] - $row['FIN_RECV_RETURN'];
                                            $rcv_bal = $total_qnty-$rcv_from_dyeing;
                                            $text_issue_leftover= $row['TEXT_ISSUE_LEFTOVER'];
                                            $text_stock = $rcv_from_dyeing + $row['TEXT_IN'] - ($row['TEXT_OUT'] + $text_issue_leftover);
                                            $recv_from_text = $row['RECV_FROM_TEXT'];//$row['TEXT_OUT'];
                                            $gmts_in = $row['GMTS_IN'];
                                            $gmts_out = $row['GMTS_OUT'];
                                            $rmg_issue_leftover = $row['GMTS_ISSUE_LEFTOVER'];
                                            $gmts_rcv_bal = $total_qnty - ($recv_from_text + $gmts_in - $gmts_out);
                                            $gmts_fin_issue =$row['GMTS_FIN_ISSUE'];
                                            $gmts_iss_ret =$row['GMTS_ISS_RET'];
                                            $issue_to_cut =$gmts_fin_issue - $gmts_iss_ret;
                                            //Stock= [(Recv From Tex + Trans In + Issue Return from Cutting)- (Issue to Cut+ Trans out + Leftover)]
                                            $gmts_stock = ($recv_from_text + $gmts_in + $gmts_iss_ret) - ($gmts_fin_issue + $gmts_out + $rmg_issue_leftover);
                                            $issue_bal = $total_qnty - $issue_to_cut;
                                            
                                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                            ?>
                                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('str_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="str_<? echo $i; ?>" style="" valign="middle">
                                                <? 
                                                if($y==1)
                                                {
                                                 ?>
                                                    <td title="<? echo $buyerID;?>" align="center" width="<? echo $four_percent;?>" rowspan="<? echo $td_span_buyer_arr[$buyerID]?>"><? echo $buyer_short_name_arr[$buyerID];?></td>
                                                <?
                                                }
                                                if($r==1)
                                                {
                                                ?>
                                                <td align="center" width="<? echo $four_percent;?>" rowspan="<? echo $td_span_buyer_ref_arr[$buyerID][$intRef];?>"><? echo $intRef;?></td>
                                                <?
                                                }
                                                if($c==1){
                                                ?>
                                                <td align="center" class="word_break_wrap" width="<? echo $four_percent;?>" rowspan="<? echo $td_span_buyer_ref_color_arr[$buyerID][$intRef][$COLORID] ;?>" title="<? echo $lib_color[$COLORID];?>"><? echo substr($lib_color[$COLORID],0,7);?></td>
                                                <?}?>

                                                <td align="center" class="word_break_wrap" width="<? echo $four_percent;?>" title="<? echo $constructtion_arr[$deter_id];?>"><? echo  substr($constructtion_arr[$deter_id],0,10);?></td>
                                                <td align="center" width="<? echo $three_percent;?>"><? echo $gsm;?></td>
                                                <td align="center" width="<? echo $three_percent;?>"><? echo $dia;?></td>

                                                <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($row['REQ_QTY'],9,"");?></td>
                                                <td align="right" width="<? echo $three_percent;?>"><? echo decimal_format($row['SHORT_QTY'],9,"");?></td>
                                                <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($total_qnty,9,"");?></td>
                                                <td align="right" width="<? echo $four_percent;?>" title="<? echo 'rcv='.$row['GREY_RCV'] . ', tr in='.$row['GREY_TRIN'] .', iss return='.$row['GREY_ISSRETURN'] . ', tr out='.$row['GREY_TROUT'] .', issue='.$row['GREY_ISSUE'];?>">
                                                    <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','grey_stock_popup')" >
                                                    <? echo decimal_format($GREY_STOCK,9,"");?>
                                                    </a>
                                                </td>
                                                
                                                <td align="right" width="<? echo $four_percent;?>" title="<? echo "(grey issue= ".$row['GREY_ISSUE']  .", + rcv return=". $row['GREY_RCVRETURN'] .") - (dye unload= ".$row['DYE_UNLOAD'] .", + grey used=". $row['GREY_USED_FIN'].", issue return=".$row['GREY_ISSRETURN'].")";?>">
                                                    <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','dye_house_popup')" >
                                                    <? echo decimal_format($DYE_HOUSE_STOCK,9,"");?>
                                                    </a>
                                                </td>
                                                
                                                

                                                <td align="right" width="<? echo $four_percent;?>" title="<? echo "unload=".$row['DYE_UNLOAD'] .", - grey use production=". $row['GREY_USED_PRODUCTION'];?>" >
                                                    <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','finishing_floor_popup')" >
                                                    <? echo decimal_format($finishing_floor_stock,9,"");?>
                                                    </a>
                                                </td>
                                                <td align="right" width="<? echo $four_percent;?>" title="<? echo "rcv=".$row['FINISH_QTY'] .",- return=". $row['FIN_RECV_RETURN'];?>"><? echo decimal_format($rcv_from_dyeing,9,"");?></td>
                                                <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($rcv_bal,9,"");?></td>
                                                <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($text_issue_leftover,9,"");?></td>
                                                <td align="right" width="<? echo $four_percent;?>">
                                                    <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','textile_stock_popup')" >
                                                        <? echo decimal_format($text_stock,9,"");?>
                                                    </a>
                                                </td> 
                                                <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($recv_from_text,9,"");?></td>
                                                <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($gmts_in,9,"");?></td>
                                                <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($gmts_out,9,"");?></td> 
                                                <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($rmg_issue_leftover,9,"");?></td>
                                                <td align="right" width="<? echo $four_percent;?>" title="Rcv Bal= [Total Qty-(Recv from Tex + Trans In - Trans out)]"><? echo decimal_format($gmts_rcv_bal,9,"");?></td>
                                                <td align="right" width="<? echo $four_percent;?>" title="Stock= [(Recv From Tex + Trans In + Issue Return from Cutting)- (Issue to Cut+ Trans out + Leftover)]">
                                                    <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','garments_stock_popup')" >
                                                        <? echo decimal_format($gmts_stock,9,"");?>
                                                    </a>
                                                </td>
                                                <td align="right" width="<? echo $four_percent;?>">&nbsp;</td>
                                                <td align="right" width="<? echo $four_percent;?>">&nbsp;</td>
                                                <td align="right" width="<? echo $four_percent;?>">
                                                    <a href="##" onclick="circular_popup('<? echo $search_data."*".$buyerID."*".$intRef."*".$COLORID."*".$deterString;?>','cutting_floor_issue_popup')" >
                                                    <? 
                                                        echo decimal_format($issue_to_cut,9,"");
                                                    ?>
                                                    </a>
                                                </td>
                                                <td align="right" width="<? echo $three_percent;?>"><? echo decimal_format($issue_bal,9,"");?></td>
                                            </tr>
                                            <? 
                                            $i++;$y++;$r++;$c++;

                                            $sub_req_qnty += $row['REQ_QTY'];
                                            $sub_ex_qnty  += $row['SHORT_QTY'];
                                            $sub_total_qnty += $total_qnty;
                                            $sub_grey_stock += $GREY_STOCK;
                                            $sub_house_stock +=$DYE_HOUSE_STOCK;
                                            $sub_finishing_floor_stock +=$finishing_floor_stock;
                                            $sub_rcv_from_dyeing +=$rcv_from_dyeing;
                                            $sub_rcv_bal +=$rcv_bal;
                                            $sub_text_issue_leftover += $text_issue_leftover;
                                            $sub_text_stock += $text_stock;
                                            $sub_recv_from_text += $recv_from_text;
                                            $sub_gmts_in += $gmts_in;
                                            $sub_gmts_out += $gmts_out;
                                            $sub_rmg_issue_leftover += $rmg_issue_leftover;
                                            $sub_gmts_rcv_bal += $gmts_rcv_bal;
                                            $sub_gmts_stock += $gmts_stock;
                                            $sub_issue_to_cut +=$issue_to_cut;
                                            $sub_issue_bal +=$issue_bal;

                                            $grand_req_qnty += $row['REQ_QTY'];
                                            $grand_ex_qnty  += $row['SHORT_QTY'];
                                            $grand_total_qnty += $total_qnty;
                                            $grand_grey_stock += $GREY_STOCK;
                                            $grand_house_stock +=$DYE_HOUSE_STOCK;
                                            $grand_finishing_floor_stock +=$finishing_floor_stock;
                                            $grand_rcv_from_dyeing +=$rcv_from_dyeing;
                                            $grand_rcv_bal +=$rcv_bal;
                                            $grand_text_issue_leftover += $text_issue_leftover;
                                            $grand_text_stock += $text_stock;
                                            $grand_recv_from_text += $recv_from_text;
                                            $grand_gmts_in += $gmts_in;
                                            $grand_gmts_out += $gmts_out;
                                            $grand_rmg_issue_leftover += $rmg_issue_leftover;
                                            $grand_gmts_rcv_bal += $gmts_rcv_bal;
                                            $grand_gmts_stock += $gmts_stock;
                                            $grand_issue_to_cut +=$issue_to_cut;
                                            $grand_issue_bal +=$issue_bal;
                                        }
                                    }
                                }

                                ?>
                                <tr bgcolor="#ccc">
                                    <td align="center" width="<? echo $four_percent +$four_percent+$three_percent+$three_percent;?>" colspan="6">Buyer Total</td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_req_qnty,9,"");?></td>
                                    <td align="right" width="<? echo $three_percent;?>"><? echo decimal_format($sub_ex_qnty,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_total_qnty,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>" ><? echo decimal_format($sub_grey_stock,9,"");?></td>
                                    
                                    <td align="right" width="<? echo $four_percent;?>" ><? echo decimal_format($sub_house_stock,9,"");?></td>

                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_finishing_floor_stock,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_rcv_from_dyeing,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_rcv_bal,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_text_issue_leftover,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_text_stock,9,"");?></td> 
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_recv_from_text,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_gmts_in,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_gmts_out,9,"");?></td> 
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_rmg_issue_leftover,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_gmts_rcv_bal,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_gmts_stock,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $four_percent;?>">&nbsp;</td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_issue_to_cut,9,"");?></td>
                                    <td align="right" width="<? echo $three_percent;?>"><? echo decimal_format($sub_issue_bal,9,"");?></td>
                                </tr>

                                <?
                                $sub_req_qnty =$sub_ex_qnty=$sub_total_qnty =$sub_grey_stock=$sub_house_stock=$sub_finishing_floor_stock=$sub_rcv_from_dyeing=$sub_rcv_bal=$sub_text_issue_leftover=$sub_text_stock=$sub_recv_from_text=$sub_gmts_in=$sub_gmts_out=$sub_rmg_issue_leftover=$sub_gmts_rcv_bal=$sub_gmts_stock=$sub_issue_to_cut=$sub_issue_bal=0;
                            }
                        
                           ?>
                        </tbody>
                    </table>
                </div>
                <table width="<? echo $acting_width?>" border="1" rules="all"  class="rpt_table" align="left">
                    <tfoot>
                        <tr>
                            <th width="<? echo $four_percent;?>">&nbsp;</th>
                            <th width="<? echo $four_percent;?>">&nbsp;</th>
                            <th width="<? echo $four_percent;?>">&nbsp;</th>
                            <th width="<? echo $four_percent;?>">&nbsp;</th>
                            <th width="<? echo $three_percent;?>">&nbsp;</th>
                            <th width="<? echo $three_percent;?>">&nbsp;</th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_req_qnty,9,"");?></th>
                            <th align="right" width="<? echo $three_percent;?>"><? echo decimal_format($grand_ex_qnty,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_total_qnty,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_grey_stock,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_house_stock,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_finishing_floor_stock,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_rcv_from_dyeing,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_rcv_bal,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_text_issue_leftover,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_text_stock,9,"");?></th> 
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_recv_from_text,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_gmts_in,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_gmts_out,9,"");?></th> 
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_rmg_issue_leftover,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_gmts_rcv_bal,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_gmts_stock,9,"");?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? //echo ;?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? //echo ;?></th>
                            <th align="right" width="<? echo $four_percent;?>"><? echo decimal_format($grand_issue_to_cut,9,"");?></th>
                            <th align="right" width="<? echo $three_percent;?>"><? echo decimal_format($grand_issue_bal,9,"");?></th>
                        </tr>
                    </tfoot>
                </table>
                <?
            }
            ?>
        </fieldset>
    </div>
    <?
    foreach (glob("$user_id*.xls") as $filename) 
    {
        if( @filemtime($filename) < (time()-$seconds_old) )
        @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename="tmp/".$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');
    $is_created = fwrite($create_new_doc,ob_get_contents());
   // $filename=$user_id."_".$name.".xls";
    echo "$total_data####$filename";
    exit();
}

if($action=="dye_house_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    extract($_REQUEST);
    
    $data_arr = explode("*", $data_str);
    
    //below search criteria datas
    $company_id=   $data_arr[0];
    $location_name=   $data_arr[1];
    $buyer_name=   $data_arr[2];
    $season_name=   $data_arr[3];
    $client=   $data_arr[4];
    $merchant=   $data_arr[5];
    $int_ref_no=   $data_arr[6];
    $shipment_status=   $data_arr[7];
    $order_status=   $data_arr[8];
    $status=   $data_arr[9];
    $search_by=   $data_arr[10];
    $date_from=   $data_arr[11];
    $date_to=   $data_arr[12];

    //ref data
    $buyer_id=      $data_arr[13];
    $internal_ref=  $data_arr[14];
    $color=         $data_arr[15];
    $deter_id=      $data_arr[16];
    $gsm=           $data_arr[17];
    $dia=           $data_arr[18];


    // Circular Fabric button


    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    //$sqlCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";
    $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    //$sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";
    
    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active = $status" : "";
    //$sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }

    $sqlCond .= ($internal_ref !="")  ? " and b.grouping ='$internal_ref'"      : "";
    $sqlCond .= ($buyer_id != 0)   ? " and a.buyer_name=$buyer_id"         : "";

    $sql = "SELECT a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT,e.dia_width as DIA_WIDTH, e.color_number_id as FABRIC_COLOR_ID 
    from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and d.color_size_sensitive!=3  and d.body_part_type in (1,20,30) and d.fabric_source=1
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, e.dia_width, e.color_number_id
    union all
    select a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT,e.dia_width as DIA_WIDTH, f.contrast_color_id as FABRIC_COLOR_ID
    from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e, wo_pre_cos_fab_co_color_dtls f
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id 
    and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id and a.id=f.job_id and e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and f.status_active=1 and f.is_deleted=0 and d.color_size_sensitive=3  and d.body_part_type in (1,20,30) and d.fabric_source=1
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, e.dia_width, f.contrast_color_id";

    $sqlRes = sql_select($sql);

    if(count($sqlRes)==0)
    {
        echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
    }

    $poIdArray = array();

    if(!empty($sqlRes))  
    {
        $con = connect();
        $r_id=execute_query("delete from tmp_poid where userid=$user_id");
        if($r_id)
        {
            oci_commit($con);
        }
    }
    foreach ($sqlRes as $row) 
    {
        
        if(!$poIdArray[$row['PO_ID']])
        {
            $poIdArray[$row['PO_ID']] = $row['PO_ID'];
            $poIds .= $row['PO_ID'].",";
            $rID=execute_query("insert into tmp_poid (userid, poid) values ($user_id,".$row['PO_ID'].")");
        }

        $poBuyer[$row['PO_ID']] = $row['BUYER_NAME'];
        $poClient[$row['PO_ID']] = $row['CLIENT_ID'];
        $intRefClient[$row['PO_ID']] = $row['GROUPING'];
        $buyerDataArray[$row['BUYER_NAME']]['BUYER'] = $row['BUYER_NAME'];

        $COMPANY_NAME = $row['COMPANY_NAME'];
        $deter_str = $row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH'];
        $buyerColorDeterGsmDiaArr[$row['BUYER_NAME']][$row['GROUPING']][$row['FABRIC_COLOR_ID']][$deter_str]['BUYER_NAME'] = $row['BUYER_NAME'];
    }


    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and g.COLOR_ID='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and c.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and c.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and c.dia_width='$dia'";  
    }

    $grey_iss_sql = sql_select("SELECT a.knit_dye_source as KNIT_DYE_SOURCE, a.knit_dye_company as KNIT_DYE_COMPANY, sum(d.quantity) as QTY from inv_issue_master a, inv_transaction b,product_details_master c,order_wise_pro_details d,inv_grey_fabric_issue_dtls e, tmp_poid f, ppl_planning_info_entry_dtls g where a.id=b.mst_id and c.id=d.prod_id and b.id=d.trans_id and c.id=b.prod_id and e.trans_id=b.id and a.id=e.mst_id and e.prod_id=c.id and d.trans_type=2 and b.item_category=13 and c.item_category_id=13 and a.status_active=1 and b.status_active=1 and c.status_active=1 and d.po_breakdown_id=f.poid and f.userid=$user_id and e.program_no=g.id $ref_data_cond group by a.knit_dye_source, a.knit_dye_company");

    foreach ($grey_iss_sql as  $val) 
    {
        $factory_wise[$val['KNIT_DYE_SOURCE']][$val['KNIT_DYE_COMPANY']]['ISSUE'] += $val['QTY'];
    }

    if($db_type==0) {
        $ext_cond = " and (c.extention_no=0 or c.extention_no='')";
    } else {
        $ext_cond = " and (c.extention_no=0 or c.extention_no is null)";
    }
    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and c.COLOR_ID='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and f.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and f.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and f.dia_width='$dia'";  
    }
    
    $sqlDyeUnload =sql_select("SELECT b.id as ID, a.service_source as SERVICE_SOURCE, a.service_company as SERVICE_COMPANY, b.batch_qty as BATCH_QTY from pro_fab_subprocess a, pro_fab_subprocess_dtls b, pro_batch_create_mst c, wo_booking_mst d, wo_booking_dtls e, product_details_master f, tmp_poid g where a.id=b.mst_id and b.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.batch_id=c.id and c.booking_no=d.booking_no and d.booking_no=e.booking_no and e.po_break_down_id=g.poid and g.userid=$user_id and b.prod_id=f.id $ext_cond $ref_data_cond group by b.id, a.service_source, a.service_company, b.batch_qty");

    foreach ($sqlDyeUnload as $val) 
    {
        if($dyeDtlsArr[$val['ID']] =="")
        {
            $dyeDtlsArr[$val['ID']]=$val['ID'];
            $factory_wise[$val['SERVICE_SOURCE']][$val['SERVICE_COMPANY']]['UNLOAD'] += $val['BATCH_QTY'];
        }
    }

    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and a.color_id='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and b.fabric_description_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and b.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and b.width='$dia'";  
    }

    $finish_rcv_issuereturn_sql = sql_select("SELECT g.knitting_source as KNITTING_SOURCE, g.knitting_company as KNITTING_COMPANY, b.grey_used_qty as GREY_USED_QTY, a.id as DTLS_ID, b.id as PROP_ID, f.id as TRANS_ID, a.quantity as QUANTITY, f.store_id as TRANS_STORE, a.entry_form as ENTRY_FORM,  d.booking_type as BOOKING_TYPE, g.receive_basis as RECEIVE_BASIS, d.process as PROCESS, h.fabric_source as FABRIC_SOURCE from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join inv_transaction f on b.trans_id=f.id, inv_receive_master g, pro_batch_create_mst c, wo_booking_dtls d, tmp_poid e, wo_booking_mst h where a.dtls_id = b.id and b.mst_id = g.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id $ref_data_cond and a.entry_form in (37) and g.entry_form in (37) and d.booking_no=h.booking_no and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 group by g.knitting_source, g.knitting_company, b.grey_used_qty, a.id, b.id, f.id, a.quantity, f.store_id, a.entry_form, d.booking_type, g.receive_basis, d.process, h.fabric_source");

    foreach ($finish_rcv_issuereturn_sql as $val) 
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==1 ) || $val['BOOKING_TYPE']==3)
        {
            if($val['ENTRY_FORM']==37 && $val['RECEIVE_BASIS']==11 && ($val['PROCESS'] ==31 || $val['PROCESS'] ==158)) 
            {
                if($prop_arr[$val['PROP_ID']] == "")
                {
                    $prop_arr[$val['PROP_ID']] = $val['PROP_ID'];
                    if($dtls_arr[$val['DTLS_ID']] == "")
                    {
                        $dtls_arr[$val['DTLS_ID']] = $val['DTLS_ID'];
                        $factory_wise[$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']]['GREY_USED'] += $val['GREY_USED_QTY'];
                    }
                }
            }
        }
    }

    $ref_data_cond="";$ref_data_cond_1="";
    if($color !=""){
        $ref_data_cond =" and f.color_id='$color'";
        $ref_data_cond_1 =" and c.color='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and c.detarmination_id=$deter_id";  
        $ref_data_cond_1 .=" and c.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and c.gsm=$gsm";  
        $ref_data_cond_1 .=" and c.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and c.dia_width='$dia'";  
        $ref_data_cond_1 .=" and c.dia_width='$dia'";  
    }

    $sqlGreyTransReturn =sql_select("SELECT e.knitting_source as KNITTING_SOURCE, e.knitting_company as KNITTING_COMPANY, b.quantity as QTY, a.transaction_type as TRANSACTION_TYPE from inv_transaction a, order_wise_pro_details b , product_details_master c, tmp_poid d, inv_receive_master e, ppl_planning_info_entry_dtls f where a.id=b.trans_id and b.po_breakdown_id=d.poid and d.userid=$user_id $ref_data_cond and a.mst_id=e.id and b.prod_id=c.id and e.booking_no=f.id and a.item_category=13 and a.transaction_type in (4) and b.trans_type in (4) and b.entry_form in (51) and b.entry_form in (51) and a.status_active=1 and b.status_active=1 
        union all 
    SELECT e.knit_dye_source as KNITTING_SOURCE, e.knit_dye_company as KNITTING_COMPANY,  b.quantity as QTY, a.transaction_type as TRANSACTION_TYPE from inv_transaction a, order_wise_pro_details b , product_details_master c, tmp_poid d, inv_issue_master e where a.id=b.trans_id and b.po_breakdown_id=d.poid and d.userid=$user_id $ref_data_cond_1 and a.mst_id=e.id and b.prod_id=c.id and a.item_category=13 and a.transaction_type in (3) and b.trans_type in (3) and b.entry_form in (45) and e.entry_form in (45) and a.status_active=1 and b.status_active=1");

    foreach ($sqlGreyTransReturn as $val) 
    {
        if($val['TRANSACTION_TYPE'] ==4)
        {
            $factory_wise[$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']]['GREY_ISSRETURN'] +=$val['QTY'];
        }
        else if($val['TRANSACTION_TYPE'] ==3)
        {
            $factory_wise[$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']]['GREY_RCVRETURN'] +=$val['QTY'];
        }
    }

    $r_id2=execute_query("delete from tmp_poid where userid=$user_id");
    if($r_id2)
    {
        oci_commit($con);
    }

    $company_name_arr = return_library_array("select id,company_name from lib_company", 'id', 'company_name');
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    ?>    
    <div id="data_panel" align="center" style="width:1200px">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
    </div>
    <div class="main" style="width: 420px;" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="480">
                <caption style="font-size:18px;"><b>Dye house stock</b></caption>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="420">
                <thead>
                    <tr>
                        <th width="300">Name of Floor/Factory/</th>
                        <th width="100">Qty</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    foreach ($factory_wise as $source=>$sourceData) 
                    {
                        foreach ($sourceData as $factory=>$row) 
                        {
                            $DYE_HOUSE_STOCK = ($row['ISSUE']  + $row['GREY_RCVRETURN'] ) - ($row['UNLOAD'] + $row['GREY_USED'] + $row['GREY_ISSRETURN']);
                            //echo "(".$row['ISSUE']  ."+". $row['GREY_RCVRETURN'] .") - (". $row['UNLOAD'] ."+". $row['GREY_USED'] ."+". $row['GREY_ISSRETURN'].")<br>";
                            $factory_name="";
                            if($source==1){
                                $factory_name = $company_name_arr[$factory];
                            }
                            else if($source==3)
                            {
                                $factory_name = $lib_supplier[$factory];
                            }

                            if($DYE_HOUSE_STOCK)
                            {
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                                ?>                        
                                <tr bgcolor="<? echo $bgcolor; ?>" >                               
                                    <td align="center" width="300"><? echo $factory_name;?></td>
                                    <td align="right" width="100" ><? echo decimal_format($DYE_HOUSE_STOCK ,9,""); ?></td>
                                </tr>
                                <?
                                $i++; 
                                $tot_finish_required +=$DYE_HOUSE_STOCK;
                            }
                        }
                    }

                    ?>
                    
                </tbody>
                <tfoot>
                    <tr style="font-weight:bold;text-align:right;">
                        <th width="300">Grand Total:</th>
                        <th width="100"><? echo fn_number_format($tot_finish_required,2);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <?
}

if($action=="grey_stock_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    extract($_REQUEST);

    $data_arr = explode("*", $data_str);

    //below search criteria datas
    $company_id=   $data_arr[0];
    $location_name=   $data_arr[1];
    $buyer_name=   $data_arr[2];
    $season_name=   $data_arr[3];
    $client=   $data_arr[4];
    $merchant=   $data_arr[5];
    $int_ref_no=   $data_arr[6];
    $shipment_status=   $data_arr[7];
    $order_status=   $data_arr[8];
    $status=   $data_arr[9];
    $search_by=   $data_arr[10];
    $date_from=   $data_arr[11];
    $date_to=   $data_arr[12];

    //ref data
    $buyer_id=      $data_arr[13];
    $internal_ref=  $data_arr[14];
    $color=         $data_arr[15];
    $deter_id=      $data_arr[16];
    $gsm=           $data_arr[17];
    $dia=           $data_arr[18];

    // Circular Fabric button

    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    //$sqlCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";
    $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    //$sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";
    
    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active = $status" : "";
    //$sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }

    $sqlCond .= ($internal_ref !="")  ? " and b.grouping ='$internal_ref'"      : "";
    $sqlCond .= ($buyer_id != 0)   ? " and a.buyer_name=$buyer_id"         : "";

    $sql = "SELECT a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT,e.dia_width as DIA_WIDTH, e.color_number_id as FABRIC_COLOR_ID 
    from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and d.color_size_sensitive!=3  and d.body_part_type in (1,20,30) and d.fabric_source=1
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, e.dia_width, e.color_number_id
    union all
    select a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT,e.dia_width as DIA_WIDTH, f.contrast_color_id as FABRIC_COLOR_ID
    from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e, wo_pre_cos_fab_co_color_dtls f
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id 
    and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id and a.id=f.job_id and e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and f.status_active=1 and f.is_deleted=0 and d.color_size_sensitive=3  and d.body_part_type in (1,20,30) and d.fabric_source=1
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, e.dia_width, f.contrast_color_id";

    $sqlRes = sql_select($sql);

    if(count($sqlRes)==0)
    {
        echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
    }

    $poIdArray = array();

    if(!empty($sqlRes))  
    {
        $con = connect();
        $r_id=execute_query("delete from tmp_poid where userid=$user_id");
        if($r_id)
        {
            oci_commit($con);
        }
    }
    foreach ($sqlRes as $row) 
    {
        if(!$poIdArray[$row['PO_ID']])
        {
            $poIdArray[$row['PO_ID']] = $row['PO_ID'];
            $poIds .= $row['PO_ID'].",";
            $rID=execute_query("insert into tmp_poid (userid, poid) values ($user_id,".$row['PO_ID'].")");
        }

        $poBuyer[$row['PO_ID']] = $row['BUYER_NAME'];
        $poClient[$row['PO_ID']] = $row['CLIENT_ID'];
        $intRefClient[$row['PO_ID']] = $row['GROUPING'];
        $buyerDataArray[$row['BUYER_NAME']]['BUYER'] = $row['BUYER_NAME'];

        $COMPANY_NAME = $row['COMPANY_NAME'];
        $deter_str = $row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH'];
        $buyerColorDeterGsmDiaArr[$row['BUYER_NAME']][$row['GROUPING']][$row['FABRIC_COLOR_ID']][$deter_str]['BUYER_NAME'] = $row['BUYER_NAME'];
    }

    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and g.COLOR_ID='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and c.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and c.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and c.dia_width='$dia'";  
    }

    $grey_iss_sql = sql_select("SELECT b.store_id as STORE_ID, sum(d.quantity) as QTY from inv_issue_master a, inv_transaction b,product_details_master c,order_wise_pro_details d,inv_grey_fabric_issue_dtls e, tmp_poid f, ppl_planning_info_entry_dtls g where a.id=b.mst_id and c.id=d.prod_id and b.id=d.trans_id and c.id=b.prod_id and e.trans_id=b.id and a.id=e.mst_id and e.prod_id=c.id and d.trans_type=2 and b.item_category=13 and c.item_category_id=13 and a.status_active=1 and b.status_active=1 and c.status_active=1 and d.po_breakdown_id=f.poid and f.userid=$user_id and e.program_no=g.id $ref_data_cond group by b.store_id");

    foreach ($grey_iss_sql as  $val) 
    {
        $store_wise[$val['STORE_ID']]['ISSUE'] += $val['QTY'];
    }

    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and c.COLOR_ID='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and c.febric_description_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and c.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and c.width='$dia'";  
    }
    $sqlGreyRcv = "SELECT b.store_id as STORE_ID, d.quantity as QTY from inv_receive_master a, inv_transaction b,pro_grey_prod_entry_dtls c,order_wise_pro_details d, tmp_poid e where a.id=b.mst_id and b.id=c.trans_id and a.id=c.mst_id and b.id=d.trans_id and c.id=d.dtls_id and d.po_breakdown_id=e.poid and e.userid=$user_id and d.trans_type=1 and b.item_category=13 and a.status_active=1 and b.status_active=1 and c.status_active=1 $ref_data_cond";

    $sqlRes = sql_select($sqlGreyRcv);
    $receive_qty_array = array();
    $desc_str="";
    foreach ($sqlRes as $val) 
    {
        $store_wise[$val['STORE_ID']]["RCV"] +=$val['QTY'];
    }

    $ref_data_cond="";
    $ref_data_cond_1="";
    if($color !=""){
        $ref_data_cond =" and f.color_id='$color'";
        $ref_data_cond_1 =" and c.color='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and c.detarmination_id=$deter_id";  
        $ref_data_cond_1 .=" and c.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and c.gsm=$gsm";  
        $ref_data_cond_1 .=" and c.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and c.dia_width='$dia'";  
        $ref_data_cond_1 .=" and c.dia_width='$dia'";  
    }

    $sqlGreyTransReturn =sql_select("SELECT a.store_id as STORE_ID, b.quantity as QTY, a.transaction_type as TRANSACTION_TYPE 
    from inv_transaction a, order_wise_pro_details b , product_details_master c, tmp_poid d , ppl_planning_info_entry_dtls f 
    where a.id=b.trans_id and b.po_breakdown_id=d.poid and d.userid=$user_id and b.prod_id=c.id and a.program_no=f.id and a.item_category=13 
    and a.transaction_type in (5,6) and b.trans_type in (5,6) and b.entry_form in (13) and a.status_active=1 and b.status_active=1 $ref_data_cond
    union all
    SELECT a.store_id as STORE_ID, b.quantity as QTY, a.transaction_type as TRANSACTION_TYPE 
    from inv_transaction a, order_wise_pro_details b , product_details_master c, tmp_poid d, inv_receive_master e, ppl_planning_info_entry_dtls f 
    where a.id=b.trans_id and b.po_breakdown_id=d.poid and d.userid=$user_id and a.mst_id=e.id and b.prod_id=c.id and e.booking_no=f.id and a.item_category=13 
    and a.transaction_type in (4) and b.trans_type in (4) and b.entry_form in (51) and b.entry_form in (51) and a.status_active=1 and b.status_active=1 $ref_data_cond 
    union all
    SELECT a.store_id as STORE_ID, b.quantity as QTY, a.transaction_type as TRANSACTION_TYPE 
    from inv_transaction a, order_wise_pro_details b, product_details_master c, tmp_poid d 
    where a.id=b.trans_id and b.po_breakdown_id=d.poid and d.userid=$user_id and b.prod_id=c.id and a.item_category=13 
    and a.transaction_type in (3) and b.trans_type in (3) and b.entry_form in (45) and a.status_active=1 and b.status_active=1 $ref_data_cond_1");

    foreach ($sqlGreyTransReturn as $val) 
    {
        if($val['TRANSACTION_TYPE'] ==6)
        {
            $store_wise[$val['STORE_ID']]['GREY_TROUT'] +=$val['QTY'];
        } 
        else if($val['TRANSACTION_TYPE'] ==5)
        {
            $store_wise[$val['STORE_ID']]['GREY_TRIN'] +=$val['QTY'];
        }
        else if($val['TRANSACTION_TYPE'] ==4)
        {
            $store_wise[$val['STORE_ID']]['GREY_ISSRETURN'] +=$val['QTY'];
        }
        else if($val['TRANSACTION_TYPE'] ==3)
        {
            $store_wise[$val['STORE_ID']]['GREY_RCVRETURN'] +=$val['QTY'];
        }
    }

    $r_id2=execute_query("delete from tmp_poid where userid=$user_id");
    if($r_id2)
    {
        oci_commit($con);
    }

    $lib_store = return_library_array("select b.store_name, b.id from lib_store_location_category a, lib_store_location b where a.store_location_id=b.id and a.category_type=13 and b.status_active=1 group by b.store_name, b.id", "id", "store_name");
    ?>    
    <div id="data_panel" align="center" style="width:1200px">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
    </div>
    <div class="main" style="width: 420px;" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="480">
                <caption style="font-size:18px;"><b>Grey stock</b></caption>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="420">
                <thead>
                    <tr>
                        <th width="300">Store</th>
                        <th width="100">Quantity</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    foreach ( $store_wise as $store_id=>$row) 
                    {
                        $GREY_STOCK = ($row['RCV'] + $row['GREY_TRIN'] + $row['GREY_ISSRETURN'] ) - ($row['ISSUE'] + $row['GREY_TROUT'] + $row['GREY_RCVRETURN']);
                        //echo "(".$row['RCV']  ."+". $row['GREY_TRIN'] ."+". $row['GREY_ISSRETURN'] .") - (". $row['ISSUE'] ."+". $row['GREY_TROUT'] ."+". $row['GREY_RCVRETURN'].")<br>";

                        $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                        ?>                        
                        <tr bgcolor="<? echo $bgcolor; ?>" >                               
                            <td align="center" width="300"><? echo $lib_store[$store_id];?></td>
                            <td align="right" width="100" ><? echo decimal_format($GREY_STOCK ,9,""); ?></td>
                        </tr>
                        <?
                        $i++; 
                        $tot_grey_required +=$GREY_STOCK;
                    }
                    ?>
                </tbody>
                <tfoot>
                    <tr style="font-weight:bold;text-align:right;">
                        <th width="300">Grand Total:</th>
                        <th width="100"><? echo fn_number_format($tot_grey_required,2);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <?
}

if($action=="finishing_floor_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    extract($_REQUEST);
    
    $data_arr = explode("*", $data_str);
    
    //below search criteria datas
    $company_id=   $data_arr[0];
    $location_name=   $data_arr[1];
    $buyer_name=   $data_arr[2];
    $season_name=   $data_arr[3];
    $client=   $data_arr[4];
    $merchant=   $data_arr[5];
    $int_ref_no=   $data_arr[6];
    $shipment_status=   $data_arr[7];
    $order_status=   $data_arr[8];
    $status=   $data_arr[9];
    $search_by=   $data_arr[10];
    $date_from=   $data_arr[11];
    $date_to=   $data_arr[12];

    //ref data
    $buyer_id=      $data_arr[13];
    $internal_ref=  $data_arr[14];
    $color=         $data_arr[15];
    $deter_id=      $data_arr[16];
    $gsm=           $data_arr[17];
    $dia=           $data_arr[18];

    // Circular Fabric button

    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    //$sqlCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";
    $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    //$sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";
    
    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active = $status" : "";
    //$sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }

    $sqlCond .= ($internal_ref !="")  ? " and b.grouping ='$internal_ref'"      : "";
    $sqlCond .= ($buyer_id != 0)   ? " and a.buyer_name=$buyer_id"         : "";

    $sql = "SELECT a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT,e.dia_width as DIA_WIDTH, e.color_number_id as FABRIC_COLOR_ID 
    from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and d.color_size_sensitive!=3  and d.body_part_type in (1,20,30) and d.fabric_source=1
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, e.dia_width, e.color_number_id
    union all
    select a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT,e.dia_width as DIA_WIDTH, f.contrast_color_id as FABRIC_COLOR_ID
    from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e, wo_pre_cos_fab_co_color_dtls f
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id 
    and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id and a.id=f.job_id and e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and f.status_active=1 and f.is_deleted=0 and d.color_size_sensitive=3  and d.body_part_type in (1,20,30) and d.fabric_source=1
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, e.dia_width, f.contrast_color_id";

    $sqlRes = sql_select($sql);

    if(count($sqlRes)==0)
    {
        echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
    }

    $poIdArray = array();

    if(!empty($sqlRes))  
    {
        $con = connect();
        $r_id=execute_query("delete from tmp_poid where userid=$user_id");
        if($r_id)
        {
            oci_commit($con);
        }
    }
    foreach ($sqlRes as $row) 
    {
        if(!$poIdArray[$row['PO_ID']])
        {
            $poIdArray[$row['PO_ID']] = $row['PO_ID'];
            $poIds .= $row['PO_ID'].",";
            $rID=execute_query("insert into tmp_poid (userid, poid) values ($user_id,".$row['PO_ID'].")");
        }

        $poBuyer[$row['PO_ID']] = $row['BUYER_NAME'];
        $poClient[$row['PO_ID']] = $row['CLIENT_ID'];
        $intRefClient[$row['PO_ID']] = $row['GROUPING'];
        $buyerDataArray[$row['BUYER_NAME']]['BUYER'] = $row['BUYER_NAME'];

        $COMPANY_NAME = $row['COMPANY_NAME'];
        $deter_str = $row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH'];
        $buyerColorDeterGsmDiaArr[$row['BUYER_NAME']][$row['GROUPING']][$row['FABRIC_COLOR_ID']][$deter_str]['BUYER_NAME'] = $row['BUYER_NAME'];
    }


    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and g.COLOR_ID='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and c.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and c.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and c.dia_width='$dia'";  
    }

    $grey_iss_sql = sql_select("SELECT a.knit_dye_source as KNIT_DYE_SOURCE, a.knit_dye_company as KNIT_DYE_COMPANY, sum(d.quantity) as QTY from inv_issue_master a, inv_transaction b,product_details_master c,order_wise_pro_details d,inv_grey_fabric_issue_dtls e, tmp_poid f, ppl_planning_info_entry_dtls g where a.id=b.mst_id and c.id=d.prod_id and b.id=d.trans_id and c.id=b.prod_id and e.trans_id=b.id and a.id=e.mst_id and e.prod_id=c.id and d.trans_type=2 and b.item_category=13 and c.item_category_id=13 and a.status_active=1 and b.status_active=1 and c.status_active=1 and d.po_breakdown_id=f.poid and f.userid=$user_id and e.program_no=g.id $ref_data_cond group by a.knit_dye_source, a.knit_dye_company");

    foreach ($grey_iss_sql as  $val) 
    {
        $factory_wise[$val['KNIT_DYE_SOURCE']][$val['KNIT_DYE_COMPANY']]['ISSUE'] += $val['QTY'];
    }

    if($db_type==0) {
        $ext_cond = " and (c.extention_no=0 or c.extention_no='')";
    } else {
        $ext_cond = " and (c.extention_no=0 or c.extention_no is null)";
    }
    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and c.COLOR_ID='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and f.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and f.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and f.dia_width='$dia'";  
    }
    
    $sqlDyeUnload =sql_select("SELECT b.id as ID, a.service_source as SERVICE_SOURCE, a.service_company as SERVICE_COMPANY, b.batch_qty as BATCH_QTY from pro_fab_subprocess a, pro_fab_subprocess_dtls b, pro_batch_create_mst c, wo_booking_mst d, wo_booking_dtls e, product_details_master f, tmp_poid g where a.id=b.mst_id and b.load_unload_id=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.batch_id=c.id and c.booking_no=d.booking_no and d.booking_no=e.booking_no and e.po_break_down_id=g.poid and g.userid=$user_id and b.prod_id=f.id $ext_cond $ref_data_cond group by b.id, a.service_source, a.service_company, b.batch_qty");

    foreach ($sqlDyeUnload as $val) 
    {
        if($dyeDtlsArr[$val['ID']] =="")
        {
            $dyeDtlsArr[$val['ID']]=$val['ID'];
            $factory_wise[$val['SERVICE_SOURCE']][$val['SERVICE_COMPANY']]['UNLOAD'] += $val['BATCH_QTY'];
        }
    }

    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and a.color_id='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and b.fabric_description_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and b.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and b.width='$dia'";  
    }
    $finish_rcv_issuereturn_sql = sql_select("SELECT g.knitting_source as KNITTING_SOURCE, g.knitting_company as KNITTING_COMPANY, b.grey_used_qty as GREY_USED_QTY, a.id as DTLS_ID, b.id as PROP_ID from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join inv_transaction f on b.trans_id=f.id, inv_receive_master g, pro_batch_create_mst c, wo_booking_dtls d, tmp_poid e where a.dtls_id = b.id and b.mst_id = g.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and a.entry_form in (7) and g.entry_form in (7) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 $ref_data_cond group by g.knitting_source, g.knitting_company, b.grey_used_qty, a.id, b.id");
    foreach ($finish_rcv_issuereturn_sql as $val) 
    {
        if($prop_arr[$val['PROP_ID']] == "")
        {
            $prop_arr[$val['PROP_ID']] = $val['PROP_ID'];
            if($dtls_arr[$val['DTLS_ID']] == "")
            {
                $dtls_arr[$val['DTLS_ID']] = $val['DTLS_ID'];
                $factory_wise[$val['KNITTING_SOURCE']][$val['KNITTING_COMPANY']]['GREY_USED_PRODUCTION'] +=$val['GREY_USED_QTY'];
            }
        }
    }

    $r_id2=execute_query("delete from tmp_poid where userid=$user_id");
    if($r_id2)
    {
        oci_commit($con);
    }

    $company_name_arr = return_library_array("select id,company_name from lib_company", 'id', 'company_name');
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    ?>    
    <div id="data_panel" align="center" style="width:1200px">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
    </div>
    <div class="main" style="width: 420px;" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="480">
                <caption style="font-size:18px;"><b>Dye house stock</b></caption>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="420">
                <thead>
                    <tr>
                        <th width="300">Name of Floor/Factory/</th>
                        <th width="100">Qty</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    foreach ($factory_wise as $source=>$sourceData) 
                    {
                        foreach ($sourceData as $factory=>$row) 
                        {
                            $finishing_floor_stock = $row['UNLOAD']  - $row['GREY_USED_PRODUCTION'];
                            //echo $row['UNLOAD'] ." - ". $row['GREY_USED_PRODUCTION']."<br>";
                            $factory_name="";
                            if($source==1){
                                $factory_name = $company_name_arr[$factory];
                            }
                            else if($source==3)
                            {
                                $factory_name = $lib_supplier[$factory];
                            }

                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" >                               
                                <td align="center" width="300"><? echo $factory_name;?></td>
                                <td align="right" width="100" ><? echo decimal_format($finishing_floor_stock ,9,""); ?></td>
                            </tr>
                            <?
                            $i++; 
                            $tot_finishing_floor_stock +=$finishing_floor_stock;
                        }
                    }

                    ?>
                </tbody>
                <tfoot>
                    <tr style="font-weight:bold;text-align:right;">
                        <th width="300">Grand Total:</th>
                        <th width="100"><? echo fn_number_format($tot_finishing_floor_stock,2);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <?
}

if($action=="textile_stock_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    extract($_REQUEST);
    
    $data_arr = explode("*", $data_str);
    
    //below search criteria datas
    $company_id=   $data_arr[0];
    $location_name=   $data_arr[1];
    $buyer_name=   $data_arr[2];
    $season_name=   $data_arr[3];
    $client=   $data_arr[4];
    $merchant=   $data_arr[5];
    $int_ref_no=   $data_arr[6];
    $shipment_status=   $data_arr[7];
    $order_status=   $data_arr[8];
    $status=   $data_arr[9];
    $search_by=   $data_arr[10];
    $date_from=   $data_arr[11];
    $date_to=   $data_arr[12];

    //ref data
    $buyer_id=      $data_arr[13];
    $internal_ref=  $data_arr[14];
    $color=         $data_arr[15];
    $deter_id=      $data_arr[16];
    $gsm=           $data_arr[17];
    $dia=           $data_arr[18];

    // Circular Fabric button

    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    //$sqlCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";
    $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    //$sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";
    
    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active = $status" : "";
    //$sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }

    $sqlCond .= ($internal_ref !="")  ? " and b.grouping ='$internal_ref'"      : "";
    $sqlCond .= ($buyer_id != 0)   ? " and a.buyer_name=$buyer_id"         : "";

    $sql = "SELECT a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT,e.dia_width as DIA_WIDTH, e.color_number_id as FABRIC_COLOR_ID 
    from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and d.color_size_sensitive!=3  and d.body_part_type in (1,20,30) and d.fabric_source=1
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, e.dia_width, e.color_number_id
    union all
    select a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT,e.dia_width as DIA_WIDTH, f.contrast_color_id as FABRIC_COLOR_ID
    from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e, wo_pre_cos_fab_co_color_dtls f
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id 
    and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id and a.id=f.job_id and e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and f.status_active=1 and f.is_deleted=0 and d.color_size_sensitive=3  and d.body_part_type in (1,20,30) and d.fabric_source=1
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, e.dia_width, f.contrast_color_id";

    $sqlRes = sql_select($sql);

    if(count($sqlRes)==0)
    {
        echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
    }

    $poIdArray = array();

    if(!empty($sqlRes))  
    {
        $con = connect();
        $r_id=execute_query("delete from tmp_poid where userid=$user_id");
        if($r_id)
        {
            oci_commit($con);
        }
    }
    foreach ($sqlRes as $row) 
    {
        
        if(!$poIdArray[$row['PO_ID']])
        {
            $poIdArray[$row['PO_ID']] = $row['PO_ID'];
            $poIds .= $row['PO_ID'].",";
            $rID=execute_query("insert into tmp_poid (userid, poid) values ($user_id,".$row['PO_ID'].")");
        }

        $poBuyer[$row['PO_ID']] = $row['BUYER_NAME'];
        $poClient[$row['PO_ID']] = $row['CLIENT_ID'];
        $intRefClient[$row['PO_ID']] = $row['GROUPING'];
        $buyerDataArray[$row['BUYER_NAME']]['BUYER'] = $row['BUYER_NAME'];

        $COMPANY_NAME = $row['COMPANY_NAME'];
        $deter_str = $row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH'];
        $buyerColorDeterGsmDiaArr[$row['BUYER_NAME']][$row['GROUPING']][$row['FABRIC_COLOR_ID']][$deter_str]['BUYER_NAME'] = $row['BUYER_NAME'];
    }

    //$text_store_sql = sql_select("select company_name as COMPANY_NAME, distribute_qnty as DISTRIBUTE_QNTY from variable_settings_production where variable_list=56 and status_active=1 and company_name=$COMPANY_NAME");

    $text_store_sql = sql_select("SELECT a.id as STORE_ID, a.store_name from lib_store_location a, lib_store_location_category b where a.id= b.store_location_id and company_id=$COMPANY_NAME and status_active=1 and b.category_type=2 and a.is_textile_store=1 group by a.id, a.store_name");

    if(empty($text_store_sql))
    {
        echo "Select Textile Store in Library setup";
        die;
    }

    foreach ($text_store_sql as $row) 
    {
        $textile_store_id[$row["STORE_ID"]] = $row["STORE_ID"];
    }

    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and a.color_id='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and b.fabric_description_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and b.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and b.width='$dia'";  
    }


    $finish_rcv_issuereturn_sql = sql_select("SELECT b.id as PROP_ID, f.id as TRANS_ID, a.quantity as QUANTITY, f.store_id as TRANS_STORE, d.booking_type as BOOKING_TYPE, h.fabric_source as FABRIC_SOURCE
        from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join inv_transaction f on b.trans_id=f.id, inv_receive_master g, pro_batch_create_mst c, wo_booking_dtls d, tmp_poid e, wo_booking_mst h where a.dtls_id = b.id and b.mst_id = g.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and a.entry_form in (7,37) and g.entry_form in (7,37) and d.booking_no=h.booking_no and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 $ref_data_cond group by b.id, f.id, a.quantity, f.store_id, d.booking_type, h.fabric_source");

    foreach ($finish_rcv_issuereturn_sql as $val) 
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==1 ) || $val['BOOKING_TYPE']==3)
        {
            if($prop_arr[$val['PROP_ID']] == "")
            {
                $prop_arr[$val['PROP_ID']] = $val['PROP_ID'];
                //if($val['TRANS_ID'] && $val['TRANS_STORE']==$textile_store_id)
                if($val['TRANS_ID'] && $textile_store_id[$val['TRANS_STORE']] !="")
                { 
                    $store_wise[$val['TRANS_STORE']]['FINISH_QTY'] +=$val['QUANTITY'];  
                }
            }
        }
    }

    

    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and a.color_id='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and g.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and g.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and g.dia_width='$dia'";  
    }

    $finish_iss_rcvret_sql = sql_select("SELECT a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, g.detarmination_id as DETER_ID, g.dia_width as DIA, g.gsm as GSM, a.trans_id as TRANS_ID, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, d.booking_type as BOOKING_TYPE, b.store_id as STORE_ID , f.issue_purpose as ISSUE_PURPOSE from order_wise_pro_details a, inv_finish_fabric_issue_dtls b, pro_batch_create_mst c, wo_booking_mst d, tmp_poid e, inv_issue_master f, product_details_master g where a.dtls_id=b.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and b.mst_id=f.id and b.prod_id=g.id and a.entry_form in (18,46) and f.entry_form in (18,46) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and d.booking_type in (1,3) $ref_data_cond");

    foreach ($finish_iss_rcvret_sql as $val)
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==1 ) || $val['BOOKING_TYPE']==3)
        {
            if($val['ENTRY_FORM']==18)
            {
                if($val['ISSUE_PURPOSE']==26 || $val['ISSUE_PURPOSE']==29 || $val['ISSUE_PURPOSE']==30 || $val['ISSUE_PURPOSE']==31)
                {
                    //if($val['STORE_ID']==$textile_store_id)
                    if($textile_store_id[$val['STORE_ID']] !="")
                    {
                        $store_wise[$val['STORE_ID']]['TEXT_ISSUE_LEFTOVER'] +=$val['QUANTITY'];
                    }
                    else
                    {
                        $store_wise[$val['STORE_ID']]['GMTS_ISSUE_LEFTOVER'] +=$val['QUANTITY'];
                    }
                }
            }
            //else if($val['ENTRY_FORM']==46 && $val['STORE_ID']==$textile_store_id)
            else if($val['ENTRY_FORM']==46 && $textile_store_id[$val['STORE_ID']] !="")
            {
                $store_wise[$val['STORE_ID']]['FIN_RECV_RETURN'] +=$val['QUANTITY'];
            }
        }
    }


    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and h.color='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and h.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and h.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and h.dia_width='$dia'";  
    }
    
    $finish_transfer_sql = sql_select("SELECT a.transfer_criteria as TRANSFER_CRITERIA, d.po_breakdown_id as PO_BREAKDOWN_ID, d.id as ID, d.quantity as QUANTITY, d.trans_type as TRANS_TYPE, c.store_id as STORE_ID, b.from_store as FROM_STORE, b.to_store as TO_STORE, h.color as COLOR_ID, h.detarmination_id as DETER_ID, h.dia_width as DIA, h.gsm as GSM, f.fabric_source as FABRIC_SOURCE, f.booking_type as BOOKING_TYPE from inv_item_transfer_mst a, inv_item_transfer_dtls b, inv_transaction c, order_wise_pro_details d, pro_batch_create_mst e, wo_booking_mst f, tmp_poid g, product_details_master h where a.id = b.mst_id and b.id = d.dtls_id and d.trans_type in (5,6) and c.id=d.trans_id and a.entry_form=14 and d.entry_form=14 and c.pi_wo_batch_no= e.id and e.booking_no = f.booking_no and f.booking_type in (1,3) and d.po_breakdown_id=g.poid and g.userid=$user_id and c.prod_id=h.id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 $ref_data_cond");

    foreach ($finish_transfer_sql as $val) 
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==1 ) || $val['BOOKING_TYPE']==3)
        {
            if($prop_arr[$val['ID']] == "")
            {
                if($val['TRANSFER_CRITERIA']==2)
                {
                    //if($val['TRANS_TYPE']==6 && $val['STORE_ID']==$textile_store_id)
                    /* if($val['TRANS_TYPE']==6 && $textile_store_id[$val['STORE_ID']] !="")
                    {
                        $store_wise[$val['STORE_ID']]['TEXT_OUT'] +=$val['QUANTITY'];
                    }
                    //if($val['TRANS_TYPE']==5 && $val['STORE_ID']==$textile_store_id)
                    if($val['TRANS_TYPE']==5 && $textile_store_id[$val['STORE_ID']] !="")
                    {
                        $store_wise[$val['STORE_ID']]['TEXT_IN'] +=$val['QUANTITY'];
                    } */

					if($val['TRANS_TYPE']==6 && $textile_store_id[$val['FROM_STORE']] !="" )
                    {
                        $store_wise[$val['FROM_STORE']]['TEXT_OUT'] +=$val['QUANTITY'];
                    }

                    if($val['TRANS_TYPE']==5 &&  $textile_store_id[$val['TO_STORE']] !="")
                    {
                        $store_wise[$val['TO_STORE']]['TEXT_IN'] +=$val['QUANTITY'];
                    }
                }
                else
                {
                    if($val['TRANS_TYPE'] ==5)
                    {
                        $store_wise[$val['STORE_ID']]['GMTS_IN'] +=$val['QUANTITY'];
                    }
                    else
                    {
                        $store_wise[$val['STORE_ID']]['GMTS_OUT'] +=$val['QUANTITY'];
                    }
                }
                $prop_arr[$val['ID']] = $val['ID'];
            }
        }
    }


    $r_id2=execute_query("delete from tmp_poid where userid=$user_id");
    if($r_id2)
    {
        oci_commit($con);
    }

    $lib_store = return_library_array("select b.store_name, b.id from lib_store_location_category a, lib_store_location b where a.store_location_id=b.id and a.category_type=2 and b.status_active=1 group by b.store_name, b.id", "id", "store_name");
    ?>    
    <div id="data_panel" align="center" style="width:1200px">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
    </div>
    <div class="main" style="width: 420px;" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="480">
                <caption style="font-size:18px;"><b>Textile Store stock</b></caption>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="420">
                <thead>
                    <tr>
                        <th width="300">Store</th>
                        <th width="100">Qty</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;

                    foreach ($store_wise as $store_id=>$row) 
                    {

                        $rcv_from_dyeing = $row['FINISH_QTY'] - $row['FIN_RECV_RETURN'];
                        $text_issue_leftover= $row['TEXT_ISSUE_LEFTOVER'];
                        $text_stock = ($rcv_from_dyeing + $row['TEXT_IN']) - ($row['TEXT_OUT'] + $text_issue_leftover);

                        //echo "(".$row['FINISH_QTY'] ." - ". $row['FIN_RECV_RETURN'] .") - (".$row['TEXT_OUT'] ."+ $text_issue_leftover)";

                        if($text_stock)
                        {
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" >                               
                                <td align="center" width="300"><? echo $lib_store[$store_id];?></td>
                                <td align="right" width="100" ><? echo decimal_format($text_stock ,9,""); ?></td>
                            </tr>
                            <?
                            $i++; 
                            $tot_text_stock +=$text_stock;
                        }
                    }
                    
                    ?>
                </tbody>
                <tfoot>
                    <tr style="font-weight:bold;text-align:right;">
                        <th width="300">Grand Total:</th>
                        <th width="100"><? echo fn_number_format($tot_text_stock,2);?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <?
}

if($action=="garments_stock_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    extract($_REQUEST);
    
    $data_arr = explode("*", $data_str);
    
    //below search criteria datas
    $company_id=   $data_arr[0];
    $location_name=   $data_arr[1];
    $buyer_name=   $data_arr[2];
    $season_name=   $data_arr[3];
    $client=   $data_arr[4];
    $merchant=   $data_arr[5];
    $int_ref_no=   $data_arr[6];
    $shipment_status=   $data_arr[7];
    $order_status=   $data_arr[8];
    $status=   $data_arr[9];
    $search_by=   $data_arr[10];
    $date_from=   $data_arr[11];
    $date_to=   $data_arr[12];

    //ref data
    $buyer_id=      $data_arr[13];
    $internal_ref=  $data_arr[14];
    $color=         $data_arr[15];
    $deter_id=      $data_arr[16];
    $gsm=           $data_arr[17];
    $dia=           $data_arr[18];

    // Circular Fabric button

    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    //$sqlCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";
    $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    //$sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";
    
    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active = $status" : "";
    //$sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }

    $sqlCond .= ($internal_ref !="")  ? " and b.grouping ='$internal_ref'"      : "";
    $sqlCond .= ($buyer_id != 0)   ? " and a.buyer_name=$buyer_id"         : "";

    $sql = "SELECT a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT,e.dia_width as DIA_WIDTH, e.color_number_id as FABRIC_COLOR_ID 
    from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and d.color_size_sensitive!=3  and d.body_part_type in (1,20,30) and d.fabric_source=1
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, e.dia_width, e.color_number_id
    union all
    select a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT,e.dia_width as DIA_WIDTH, f.contrast_color_id as FABRIC_COLOR_ID
    from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e, wo_pre_cos_fab_co_color_dtls f
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id 
    and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id and a.id=f.job_id and e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and f.status_active=1 and f.is_deleted=0 and d.color_size_sensitive=3  and d.body_part_type in (1,20,30) and d.fabric_source=1
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, e.dia_width, f.contrast_color_id";

    $sqlRes = sql_select($sql);

    if(count($sqlRes)==0)
    {
        echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
    }

    $poIdArray = array();

    if(!empty($sqlRes))  
    {
        $con = connect();
        $r_id=execute_query("delete from tmp_poid where userid=$user_id");
        if($r_id)
        {
            oci_commit($con);
        }
    }
    foreach ($sqlRes as $row) 
    {
        if(!$poIdArray[$row['PO_ID']])
        {
            $poIdArray[$row['PO_ID']] = $row['PO_ID'];
            $poIds .= $row['PO_ID'].",";
            $rID=execute_query("insert into tmp_poid (userid, poid) values ($user_id,".$row['PO_ID'].")");
        }

        $poBuyer[$row['PO_ID']] = $row['BUYER_NAME'];
        $poClient[$row['PO_ID']] = $row['CLIENT_ID'];
        $intRefClient[$row['PO_ID']] = $row['GROUPING'];
        $buyerDataArray[$row['BUYER_NAME']]['BUYER'] = $row['BUYER_NAME'];

        $COMPANY_NAME = $row['COMPANY_NAME'];
        $deter_str = $row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH'];
        $buyerColorDeterGsmDiaArr[$row['BUYER_NAME']][$row['GROUPING']][$row['FABRIC_COLOR_ID']][$deter_str]['BUYER_NAME'] = $row['BUYER_NAME'];
    }


    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and a.color_id='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and b.fabric_description_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and b.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and b.width='$dia'";  
    }


    $finish_rcv_issuereturn_sql = sql_select("SELECT b.id as PROP_ID, f.id as TRANS_ID, a.quantity as QUANTITY, f.store_id as TRANS_STORE, d.booking_type as BOOKING_TYPE, h.fabric_source as FABRIC_SOURCE
        from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join inv_transaction f on b.trans_id=f.id, inv_receive_master g, pro_batch_create_mst c, wo_booking_dtls d, tmp_poid e, wo_booking_mst h where a.dtls_id = b.id and b.mst_id = g.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and a.entry_form in (7,37) and g.entry_form in (7,37) and d.booking_no=h.booking_no and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 $ref_data_cond group by b.id, f.id, a.quantity, f.store_id, d.booking_type, h.fabric_source");

    foreach ($finish_rcv_issuereturn_sql as $val) 
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==1 ) || $val['BOOKING_TYPE']==3)
        {
            if($prop_arr[$val['PROP_ID']] == "")
            {
                $prop_arr[$val['PROP_ID']] = $val['PROP_ID'];
                if($val['TRANS_ID'])
                { 
                    $store_wise[$val['TRANS_STORE']]['FINISH_QTY'] +=$val['QUANTITY'];  
                }
            }
        }
    }

    //$text_store_sql = sql_select("select company_name as COMPANY_NAME, distribute_qnty as DISTRIBUTE_QNTY from variable_settings_production where variable_list=56 and status_active=1 and company_name=$COMPANY_NAME");
    $text_store_sql = sql_select("SELECT a.id as STORE_ID, a.store_name from lib_store_location a, lib_store_location_category b where a.id= b.store_location_id and company_id=$COMPANY_NAME and status_active=1 and b.category_type=2 and a.is_textile_store=1 group by a.id, a.store_name");

    if(empty($text_store_sql))
    {
        echo "Select Textile Store in Library setup";
        die;
    }

    foreach ($text_store_sql as $row) 
    {
        $textile_store_id[$row["STORE_ID"]] = $row["STORE_ID"];
    }

    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and a.color_id='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and g.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and g.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and g.dia_width='$dia'";  
    }

    $finish_iss_rcvret_sql = sql_select("SELECT a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, g.detarmination_id as DETER_ID, g.dia_width as DIA, g.gsm as GSM, a.trans_id as TRANS_ID, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, d.booking_type as BOOKING_TYPE, b.store_id as STORE_ID , f.issue_purpose as ISSUE_PURPOSE from order_wise_pro_details a, inv_finish_fabric_issue_dtls b, pro_batch_create_mst c, wo_booking_mst d, tmp_poid e, inv_issue_master f, product_details_master g where a.dtls_id=b.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and b.mst_id=f.id and b.prod_id=g.id and a.entry_form in (18,46) and f.entry_form in (18,46) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and d.booking_type in (1,3) $ref_data_cond");

    foreach ($finish_iss_rcvret_sql as $val)
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==1 ) || $val['BOOKING_TYPE']==3)
        {
            if($val['ENTRY_FORM']==18)
            {
                if($val['ISSUE_PURPOSE']==26 || $val['ISSUE_PURPOSE']==29 || $val['ISSUE_PURPOSE']==30 || $val['ISSUE_PURPOSE']==31)
                {
                    //if($val['STORE_ID']==$textile_store_id)
                    if($textile_store_id[$val["STORE_ID"]] !="")
                    {
                        $store_wise[$val['STORE_ID']]['TEXT_ISSUE_LEFTOVER'] +=$val['QUANTITY'];
                    }
                    else
                    {
                        $store_wise[$val['STORE_ID']]['GMTS_ISSUE_LEFTOVER'] +=$val['QUANTITY'];
                    }
                }
                else if($val['ISSUE_PURPOSE']==9)
                {
                    //if($val['STORE_ID']==$textile_store_id)
                    if($textile_store_id[$val["STORE_ID"]] !="")
                    {
                        $store_wise[$val['STORE_ID']]['TEXT_FIN_ISSUE'] +=$val['QUANTITY'];
                    }
                    else
                    {
                        $store_wise[$val['STORE_ID']]['GMTS_FIN_ISSUE'] +=$val['QUANTITY'];
                    }
                }
            }
            else if($val['ENTRY_FORM']==46)
            {
                $store_wise[$val['STORE_ID']]['FIN_RECV_RETURN'] +=$val['QUANTITY'];
            }
        }
    }


    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and h.color='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and h.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and h.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and h.dia_width='$dia'";  
    }
    
    $finish_transfer_sql = sql_select("SELECT a.transfer_criteria as TRANSFER_CRITERIA, d.po_breakdown_id as PO_BREAKDOWN_ID, d.id as ID, d.quantity as QUANTITY, d.trans_type as TRANS_TYPE, c.store_id as STORE_ID, b.from_store as FROM_STORE, b.to_store as TO_STORE, h.color as COLOR_ID, h.detarmination_id as DETER_ID, h.dia_width as DIA, h.gsm as GSM, f.fabric_source as FABRIC_SOURCE, f.booking_type as BOOKING_TYPE from inv_item_transfer_mst a, inv_item_transfer_dtls b, inv_transaction c, order_wise_pro_details d, pro_batch_create_mst e, wo_booking_mst f, tmp_poid g, product_details_master h where a.id = b.mst_id and b.id = d.dtls_id and d.trans_type in (5,6) and c.id=d.trans_id and a.entry_form=14 and d.entry_form=14 and c.pi_wo_batch_no= e.id and e.booking_no = f.booking_no and f.booking_type in (1,3) and d.po_breakdown_id=g.poid and g.userid=$user_id and c.prod_id=h.id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 $ref_data_cond");

    foreach ($finish_transfer_sql as $val) 
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==1 ) || $val['BOOKING_TYPE']==3)
        {
            if($prop_arr[$val['ID']] == "")
            {
                if($val['TRANSFER_CRITERIA']==2)
                {
                    /*if($val['TRANS_TYPE']==6 && $val['FROM_STORE']==$textile_store_id)
                    {
                        //$store_wise[$val['FROM_STORE']]['TEXT_OUT'] +=$val['QUANTITY'];
                        $store_wise[$val['TO_STORE']]['RCV_FROM_TEXT'] +=$val['QUANTITY'];
                    }
                    if($val['TRANS_TYPE']==5 && $val['STORE_ID']==$textile_store_id)
                    {
                        $store_wise[$val['TO_STORE']]['TEXT_IN'] +=$val['QUANTITY'];
                    }*/

                    //if($val['TRANS_TYPE']==5 && $val['STORE_ID'] !=$textile_store_id)
                    if($val['TRANS_TYPE']==5 && $textile_store_id[$val["FROM_STORE"]] !="" && $textile_store_id[$val["TO_STORE"]] =="")
                    {
                        $store_wise[$val['STORE_ID']]['RCV_FROM_TEXT'] +=$val['QUANTITY'];
                    }
                }
                else
                {
                    if($val['TRANS_TYPE'] ==5)
                    {
                        $store_wise[$val['TO_STORE']]['GMTS_IN'] +=$val['QUANTITY'];
                    }
                    else
                    {
                        $store_wise[$val['FROM_STORE']]['GMTS_OUT'] +=$val['QUANTITY'];
                    }
                }
                $prop_arr[$val['ID']] = $val['ID'];
            }
        }
    }


    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and b.color='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and b.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and b.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and b.dia_width='$dia'";  
    }

    $finish_issue_return = sql_select("SELECT a.po_breakdown_id as PO_BREAKDOWN_ID, a.entry_form as ENTRY_FORM, a.trans_id as TRANS_ID,  a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, d.booking_type as BOOKING_TYPE, f.store_id as STORE_ID, b.color as COLOR_ID, b.detarmination_id as DETER_ID, b.dia_width as DIA, b.gsm as GSM FROM order_wise_pro_details a, inv_transaction f, inv_receive_master g, pro_batch_create_mst c, wo_booking_mst d, tmp_poid e, product_details_master b WHERE a.trans_id = f.id and f.mst_id = g.id and f.pi_wo_batch_no= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and f.prod_id=b.id and a.entry_form =52 and g.entry_form =52  and a.status_active=1 and a.is_deleted=0 and f.status_active=1 and f.is_deleted=0 and d.booking_type in (1,3) $ref_data_cond");


    foreach ($finish_issue_return as $val) 
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==1 ) || $val['BOOKING_TYPE']==3)
        {
            //if($val['STORE_ID'] ==$textile_store_id)
            if($textile_store_id[$val["STORE_ID"]] !="")
            {
                $store_wise[$val['STORE_ID']]['TEXT_ISS_RET']+=$val['QUANTITY'];
            }else{
                $store_wise[$val['STORE_ID']]['GMTS_ISS_RET']+=$val['QUANTITY'];
            }
        }
    }


    $r_id2=execute_query("delete from tmp_poid where userid=$user_id");
    if($r_id2)
    {
        oci_commit($con);
    }

    $lib_store = return_library_array("select b.store_name, b.id from lib_store_location_category a, lib_store_location b where a.store_location_id=b.id and a.category_type=2 and b.status_active=1 group by b.store_name, b.id", "id", "store_name");
    ?>    
    <div id="data_panel" align="center" style="width:1200px">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
    </div>
    <div class="main" style="width: 420px;" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="480">
                <caption style="font-size:18px;"><b>RMG Store stock</b></caption>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="420">
                <thead>
                    <tr>
                        <th width="300">Store</th>
                        <th width="100">Qty</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    foreach ($store_wise as $store_id=>$row) 
                    {
                        $recv_from_text = $row['RCV_FROM_TEXT'];
                        $gmts_in = $row['GMTS_IN'];
                        $gmts_out = $row['GMTS_OUT'];
                        $rmg_issue_leftover = $row['GMTS_ISSUE_LEFTOVER'];
                        $gmts_rcv_bal = $total_qnty - ($recv_from_text + $gmts_in - $gmts_out);
                        $gmts_fin_issue =$row['GMTS_FIN_ISSUE'];
                        $gmts_iss_ret =$row['GMTS_ISS_RET'];
                        $issue_to_cut =$gmts_fin_issue - $gmts_iss_ret;
                        //Stock= [(Recv From Tex + Trans In + Issue Return from Cutting)- (Issue to Cut+ Trans out + Leftover)]
                        $gmts_stock = ($recv_from_text + $gmts_in + $gmts_iss_ret) - ($gmts_fin_issue + $gmts_out + $rmg_issue_leftover);

                        //echo "($recv_from_text + $gmts_in + $gmts_iss_ret) - ($gmts_fin_issue + $gmts_out + $rmg_issue_leftover)<br>";

                        if($gmts_stock)
                        {
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" >                               
                                <td align="center" width="300"><? echo $lib_store[$store_id];?></td>
                                <td align="right" width="100" ><? echo decimal_format($gmts_stock ,9,""); ?></td>
                            </tr>
                            <?
                            $i++; 
                            $tot_gmts_stock +=$gmts_stock;
                        }
                    }
                    
                    ?>
                </tbody>
                <tfoot>
                    <tr style="font-weight:bold;text-align:right;">
                        <th width="300">Grand Total:</th>
                        <th width="100"><? echo decimal_format($tot_gmts_stock,9,"");?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <?
}

if($action=="cutting_floor_issue_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    extract($_REQUEST);
    
    $data_arr = explode("*", $data_str);
    
    //below search criteria datas
    $company_id=   $data_arr[0];
    $location_name=   $data_arr[1];
    $buyer_name=   $data_arr[2];
    $season_name=   $data_arr[3];
    $client=   $data_arr[4];
    $merchant=   $data_arr[5];
    $int_ref_no=   $data_arr[6];
    $shipment_status=   $data_arr[7];
    $order_status=   $data_arr[8];
    $status=   $data_arr[9];
    $search_by=   $data_arr[10];
    $date_from=   $data_arr[11];
    $date_to=   $data_arr[12];

    //ref data
    $buyer_id=      $data_arr[13];
    $internal_ref=  $data_arr[14];
    $color=         $data_arr[15];
    $deter_id=      $data_arr[16];
    $gsm=           $data_arr[17];
    $dia=           $data_arr[18];

    // Circular Fabric button

    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    //$sqlCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";
    $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    //$sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";
    
    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active = $status" : "";
    //$sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }

    $sqlCond .= ($internal_ref !="")  ? " and b.grouping ='$internal_ref'"      : "";
    $sqlCond .= ($buyer_id != 0)   ? " and a.buyer_name=$buyer_id"         : "";

    $sql = "SELECT a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT,e.dia_width as DIA_WIDTH, e.color_number_id as FABRIC_COLOR_ID 
    from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and d.color_size_sensitive!=3  and d.body_part_type in (1,20,30) and d.fabric_source=1
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, e.dia_width, e.color_number_id
    union all
    select a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT,e.dia_width as DIA_WIDTH, f.contrast_color_id as FABRIC_COLOR_ID
    from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e, wo_pre_cos_fab_co_color_dtls f
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id 
    and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id and a.id=f.job_id and e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and f.status_active=1 and f.is_deleted=0 and d.color_size_sensitive=3  and d.body_part_type in (1,20,30) and d.fabric_source=1
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, e.dia_width, f.contrast_color_id";

    $sqlRes = sql_select($sql);

    if(count($sqlRes)==0)
    {
        echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
    }

    $poIdArray = array();

    if(!empty($sqlRes))  
    {
        $con = connect();
        $r_id=execute_query("delete from tmp_poid where userid=$user_id");
        if($r_id)
        {
            oci_commit($con);
        }
    }
    foreach ($sqlRes as $row) 
    {
        
        if(!$poIdArray[$row['PO_ID']])
        {
            $poIdArray[$row['PO_ID']] = $row['PO_ID'];
            $poIds .= $row['PO_ID'].",";
            $rID=execute_query("insert into tmp_poid (userid, poid) values ($user_id,".$row['PO_ID'].")");
        }

        $poBuyer[$row['PO_ID']] = $row['BUYER_NAME'];
        $poClient[$row['PO_ID']] = $row['CLIENT_ID'];
        $intRefClient[$row['PO_ID']] = $row['GROUPING'];
        $buyerDataArray[$row['BUYER_NAME']]['BUYER'] = $row['BUYER_NAME'];

        $COMPANY_NAME = $row['COMPANY_NAME'];
        $deter_str = $row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH'];
        $buyerColorDeterGsmDiaArr[$row['BUYER_NAME']][$row['GROUPING']][$row['FABRIC_COLOR_ID']][$deter_str]['BUYER_NAME'] = $row['BUYER_NAME'];
    }


    //$text_store_sql = sql_select("select company_name as COMPANY_NAME, distribute_qnty as DISTRIBUTE_QNTY from variable_settings_production where variable_list=56 and status_active=1 and company_name=$COMPANY_NAME");
    $text_store_sql = sql_select("SELECT a.id as STORE_ID, a.store_name from lib_store_location a, lib_store_location_category b where a.id= b.store_location_id and company_id=$COMPANY_NAME and status_active=1 and b.category_type=2 and a.is_textile_store=1 group by a.id, a.store_name");

    if(empty($text_store_sql))
    {
        echo "Select Textile Store in Library setup";
        die;
    }

    foreach ($text_store_sql as $row) 
    {
        $textile_store_id[$row["STORE_ID"]] = $row["STORE_ID"];
    }

    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and a.color_id='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and g.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and g.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and g.dia_width='$dia'";  
    }

    $finish_iss_rcvret_sql = sql_select("SELECT a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, g.detarmination_id as DETER_ID, g.dia_width as DIA, g.gsm as GSM, a.trans_id as TRANS_ID, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, d.booking_type as BOOKING_TYPE, b.store_id as STORE_ID , f.issue_purpose as ISSUE_PURPOSE, b.cutting_unit as CUTTING_UNIT, b.batch_id as BATCH_ID, b.prod_id as PROD_ID, f.id as ISSUE_ID from order_wise_pro_details a, inv_finish_fabric_issue_dtls b, pro_batch_create_mst c, wo_booking_mst d, tmp_poid e, inv_issue_master f, product_details_master g where a.dtls_id=b.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and b.mst_id=f.id and b.prod_id=g.id and a.entry_form in (18) and f.entry_form in (18) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and d.booking_type in (1,3) and f.issue_purpose=9 $ref_data_cond");


    foreach ($finish_iss_rcvret_sql as $val)
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==1 ) || $val['BOOKING_TYPE']==3)
        {
             if($val['ISSUE_PURPOSE']==9)
            {
                //if($val['STORE_ID']==$textile_store_id)
                if($textile_store_id[$val['STORE_ID']] !="")
                {
                    //$store_wise[$val['STORE_ID']]['TEXT_FIN_ISSUE'] +=$val['QUANTITY'];
                }
                else
                {
                    $cutting_wise[$val['CUTTING_UNIT']]['GMTS_FIN_ISSUE'] +=$val['QUANTITY'];

                    $batchProdStoreWiseIssCuttingUnitArr[$val['ISSUE_ID']][$val['STORE_ID']][$val['PROD_ID']][$val['BATCH_ID']] = $val['CUTTING_UNIT'];
                }
            }
        }
    }

    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and b.color='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and b.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and b.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and b.dia_width='$dia'";  
    }

    $finish_issue_return = sql_select("SELECT a.po_breakdown_id as PO_BREAKDOWN_ID, a.entry_form as ENTRY_FORM, a.trans_id as TRANS_ID,  a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, d.booking_type as BOOKING_TYPE, f.store_id as STORE_ID, b.color as COLOR_ID, b.detarmination_id as DETER_ID, b.dia_width as DIA, b.gsm as GSM, f.prod_id as PROD_ID,f.pi_wo_batch_no as BATCH_ID, g.issue_id as ISSUE_ID FROM order_wise_pro_details a, inv_transaction f, inv_receive_master g, pro_batch_create_mst c, wo_booking_mst d, tmp_poid e, product_details_master b WHERE a.trans_id = f.id and f.mst_id = g.id and f.pi_wo_batch_no= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and f.prod_id=b.id and a.entry_form =52 and g.entry_form =52  and a.status_active=1 and a.is_deleted=0 and f.status_active=1 and f.is_deleted=0 and d.booking_type in (1,3) $ref_data_cond");


    foreach ($finish_issue_return as $val) 
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==1 ) || $val['BOOKING_TYPE']==3)
        {
            //if($val['STORE_ID'] ==$textile_store_id)
            if($textile_store_id[$val['STORE_ID']] !="")
            {
                //$store_wise[$val['STORE_ID']]['TEXT_ISS_RET']+=$val['QUANTITY'];
            }else{
                $cutting_floor = $batchProdStoreWiseIssCuttingUnitArr[$val['ISSUE_ID']][$val['STORE_ID']][$val['PROD_ID']][$val['BATCH_ID']];
                $cutting_wise[$cutting_floor]['GMTS_ISS_RET']+=$val['QUANTITY'];
            }
        }
    }


    $r_id2=execute_query("delete from tmp_poid where userid=$user_id");
    if($r_id2)
    {
        oci_commit($con);
    }

    $cutting_unit_arr = return_library_array("select id,floor_name from lib_prod_floor where production_process=1 and status_active=1 and is_deleted=0", "id", "floor_name"); //company_id=$data and 
    ?>    
    <div id="data_panel" align="center" style="width:1200px">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
    </div>
    <div class="main" style="width: 420px;" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="480">
                <caption style="font-size:18px;"><b>Cutting floor issue</b></caption>
            </table>

            <table valign="middle" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" width="420">
                <thead>
                    <tr>
                        <th width="300">Store</th>
                        <th width="100">Qty</th>
                    </tr>
                </thead>
                <tbody>
                    <?
                    $i=0;
                    foreach ($cutting_wise as $cutFloor=>$row) 
                    {
                        $gmts_fin_issue =$row['GMTS_FIN_ISSUE'];
                        $gmts_iss_ret =$row['GMTS_ISS_RET'];
                        $issue_to_cut =$gmts_fin_issue - $gmts_iss_ret;
                        //echo "$gmts_fin_issue - $gmts_iss_ret <br>";
                        if($issue_to_cut)
                        {
                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF" ;
                            ?>                        
                            <tr bgcolor="<? echo $bgcolor; ?>" >                               
                                <td align="center" width="300"><? echo $cutting_unit_arr[$cutFloor];?></td>
                                <td align="right" width="100" ><? echo decimal_format($issue_to_cut ,9,""); ?></td>
                            </tr>
                            <?
                            $i++; 
                            $tot_issue_to_cut +=$issue_to_cut;
                        }
                    }
                    ?>
                </tbody>
                <tfoot>
                    <tr style="font-weight:bold;text-align:right;">
                        <th width="300">Grand Total:</th>
                        <th width="100"><? echo decimal_format($tot_issue_to_cut,9,"");?></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <?
}

if($action=="report_generate_circular_purchased")
{
    $company_id     = str_replace("'", "", $cbo_company_name);
    $location_name  = str_replace("'", "", $cbo_location_name);
    $buyer_name     = str_replace("'", "", $cbo_buyer_name);
    $season_name    = str_replace("'", "", $cbo_season_name);
    $year           = str_replace("'", "", $cbo_year_selection);
    $shipment_status= str_replace("'", "", $cbo_shipment_status);
    $order_status   = str_replace("'", "", $cbo_order_status);
    $status         = str_replace("'", "", $cbo_status);
    $client         = str_replace("'", "", $cbo_client);
    $search_by      = str_replace("'", "", $cbo_search_by);
    $int_ref_no     = str_replace("'", "", $txt_int_ref_no);
    $emblishment    = str_replace("'", "", $cbo_emblishment);
    $start_alarm    = str_replace("'", "", $cbo_start_alarm);
    $end_alarm      = str_replace("'", "", $cbo_end_alarm);
    $backLog        = str_replace("'", "", $cbo_backlog);
    $date_from      = str_replace("'", "", $txt_date_from);
    $date_to        = str_replace("'", "", $txt_date_to);
    $merchant       = str_replace("'", "", $cbo_merchant);

    $search_data = $company_id."*".$location_name."*".$buyer_name."*".$season_name."*".$client."*".$merchant."*".$int_ref_no."*".$shipment_status."*".$order_status."*".$status."*".$search_by."*".$date_from."*".$date_to;

    //$item_id        = str_replace("'", "", $cbo_item_name);
    //$style_ref      = str_replace("'", "", $txt_style_ref);

    $client_array = return_library_array("SELECT a.id,a.buyer_name from lib_buyer a, lib_buyer_tag_company b where a.status_active =1 and a.is_deleted=0 and b.buyer_id=a.id and b.tag_company='$company_id' and a.id in (select  buyer_id from  lib_buyer_party_type where party_type in (7))  order by buyer_name", "id", "buyer_name");

    // Circular Fabric button

    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    // $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    $sqlCond .= ($merchant != 0)     ? " and a.factory_marchant=$merchant"            : "";
    $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    //$sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";

    if($buyer_name==0)
    {
        if($_SESSION['logic_erp']["data_level_secured"]==1)
        {
            if($_SESSION['logic_erp']["buyer_id"]!="")
            {   
                $sqlCond.=" and a.buyer_name in (".$_SESSION['logic_erp']["buyer_id"].")";
            }
        }
    }
    else
    {
        $sqlCond.=" and a.buyer_name=$buyer_name";
    }
    
    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active = $status" : "";
    //$sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }

    $sql = "SELECT a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT, d.uom as UOM, e.dia_width as DIA_WIDTH, e.color_number_id as FABRIC_COLOR_ID 
    from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and a.company_name=$company_id $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and d.color_size_sensitive!=3  and d.body_part_type in (1,20,30) and d.fabric_source=2
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, d.uom, e.dia_width, e.color_number_id
    union all
    select a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT, d.uom as UOM, e.dia_width as DIA_WIDTH, f.contrast_color_id as FABRIC_COLOR_ID
    from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e, wo_pre_cos_fab_co_color_dtls f
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id 
    and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id and a.id=f.job_id and e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 and a.company_name=$company_id $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and f.status_active=1 and f.is_deleted=0 and d.color_size_sensitive=3  and d.body_part_type in (1,20,30) and d.fabric_source=2
    group by a.company_name, a.buyer_name, a.client_id, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, d.uom, e.dia_width, f.contrast_color_id";
    //echo $sql; die;
    $sqlRes = sql_select($sql);
    if(count($sqlRes)==0)
    {
        echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
    }

    $poIdArray = array();

    if(!empty($sqlRes))  
    {
        $con = connect();
        $r_id=execute_query("delete from tmp_poid where userid=$user_id");
        if($r_id)
        {
            oci_commit($con);
        }
    }
    foreach ($sqlRes as $row) 
    {
        
        if(!$poIdArray[$row['PO_ID']])
        {
            $poIdArray[$row['PO_ID']] = $row['PO_ID'];
            $poIds .= $row['PO_ID'].",";
            $rID=execute_query("insert into tmp_poid (userid, poid) values ($user_id,".$row['PO_ID'].")");
        }

        $poBuyer[$row['PO_ID']] = $row['BUYER_NAME'];
        $poClient[$row['PO_ID']] = $row['CLIENT_ID'];
        $intRefClient[$row['PO_ID']] = $row['GROUPING'];
        
        $COMPANY_NAME = $row['COMPANY_NAME'];
    }

    // $body_part_type = array( 1 => "Top", 20 => "Bottom",30 => "Others", 40 => "Flat Knit", 50 => "Cuff",); 

    if($rID)
    {
        oci_commit($con);
    }

    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $constructtion_arr=array();
    $sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id order by b.id asc";
    $data_array_deter=sql_select($sql_deter);
    foreach( $data_array_deter as $row )
    {
        $constructtion_arr[$row[csf('id')]]=$row[csf('construction')];
        $composition_arr[$row[csf('id')]].=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ";
    }
    unset($data_array_deter);

    $poIds = chop($poIds,",");
    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();
    //$costPerArr=$condition->getCostingPerArr();
    $fabric= new fabric($condition);
    //echo $fabric->getQuery();die;

    if($rptType==6)
    {
        $fabric_costing_arr=$fabric->getQtyArray_by_OrderFabricSourceBodyTypeFabColorDeterminIdGsmAndDiaWidth_knitAndwoven_greyAndfinish();
    }

    //getQtyArray_by_OrderFabricSourceAndBodyTypeFabColor_knitAndwoven_greyAndfinish
    //echo "<pre>";
    //print_r($fabric_costing_arr);
    //die;
    
    foreach ($sqlRes as $row) 
    {
        if( $rptType==6 )
        {
            if($po_deter_lvl_req_chk[$row['PO_ID']."*".$row['FABRIC_COLOR_ID']."*".$row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH']."*".$row['UOM']] =="")
            {
                $po_deter_lvl_req_chk[$row['PO_ID']."*".$row['FABRIC_COLOR_ID']."*".$row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH']."*".$row['UOM']] = $row['BUYER_NAME'];
                
                $deter_str = $row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH'];


                //$buyerColorDeterGsmDiaRequired=0;
                $buyerColorDeterGsmDiaRequired = $fabric_costing_arr['knit']['finish'][$row['PO_ID']][2][1][$row['FABRIC_COLOR_ID']][$row['LIB_YARN_COUNT_DETER_ID']][$row['GSM_WEIGHT']][$row['DIA_WIDTH']][$row['UOM']] + $fabric_costing_arr['knit']['finish'][$row['PO_ID']][2][20][$row['FABRIC_COLOR_ID']][$row['LIB_YARN_COUNT_DETER_ID']][$row['GSM_WEIGHT']][$row['DIA_WIDTH']][$row['UOM']] + $fabric_costing_arr['knit']['finish'][$row['PO_ID']][2][30][$row['FABRIC_COLOR_ID']][$row['LIB_YARN_COUNT_DETER_ID']][$row['GSM_WEIGHT']][$row['DIA_WIDTH']][$row['UOM']];


                if($buyerColorDeterGsmDiaRequired >0)
                {
                    /*$buyerColorDeterGsmDiaArr[$row['UOM']][$row['LIB_YARN_COUNT_DETER_ID']][$row['FABRIC_COLOR_ID']][$deter_str]['REQ_QTY'] += $buyerColorDeterGsmDiaRequired;

                    $buyerColorDeterGsmDiaArr[$row['UOM']][$row['LIB_YARN_COUNT_DETER_ID']][$row['FABRIC_COLOR_ID']][$deter_str]['BUYER_NAME'] = $row['BUYER_NAME'];*/

                    $deterValueNiD = $constructtion_arr[$row['LIB_YARN_COUNT_DETER_ID']]." , ".$composition_arr[$row['LIB_YARN_COUNT_DETER_ID']]."=".$row['LIB_YARN_COUNT_DETER_ID'];
                    $colorValueNiD = $lib_color[$row['FABRIC_COLOR_ID']]."=".$row['FABRIC_COLOR_ID'];

                    $buyerColorDeterGsmDiaArr[$row['UOM']][$deterValueNiD][$colorValueNiD][$deter_str]['REQ_QTY'] += $buyerColorDeterGsmDiaRequired;

                    $buyerColorDeterGsmDiaArr[$row['UOM']][$deterValueNiD][$colorValueNiD][$deter_str]['BUYER_NAME'] = $row['BUYER_NAME'];
                }
                
            }
        }
    }

    //wo quantity (short + main)
    $short_sql = sql_select("SELECT a.po_break_down_id, c.buyer_id as BUYER_ID, d.client_id as CLIENT_ID, e.grouping as GROUPING, B.BODY_PART_TYPE, a.grey_fab_qnty as GREY_FAB_QNTY, a.fin_fab_qnty as FIN_FAB_QNTY, a.fabric_color_id as COLOR_ID, b.lib_yarn_count_deter_id as DETERMINATION_ID, b.gsm_weight as GSM_WEIGHT, a.dia_width as DIA_WIDTH, b.uom as UOM, b.job_no as JOB_NO,a.is_short as IS_SHORT from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b, wo_booking_mst c, wo_po_details_master d, wo_po_break_down e, tmp_poid f where a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no=c.booking_no and b.job_id=d.id and a.po_break_down_id=e.id and a.po_break_down_id=f.poid and f.userid=$user_id and c.fabric_source=2  and a.booking_type=1 and a.status_active =1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0"); //and a.is_short=1

    foreach ($short_sql as $val) 
    {
        $deter_str = $val['DETERMINATION_ID']."*".$val['GSM_WEIGHT']."*".$val['DIA_WIDTH'];

        $deterValueNiD = $constructtion_arr[$val['DETERMINATION_ID']]." , ".$composition_arr[$val['DETERMINATION_ID']]."=".$val['DETERMINATION_ID'];
        $colorValueNiD = $lib_color[$val['COLOR_ID']]."=".$val['COLOR_ID'];

        if($val['IS_SHORT'] ==1)
        {
            $buyerColorDeterGsmDiaArr[$val['UOM']][$deterValueNiD][$colorValueNiD][$deter_str]['SHORT_QTY'] +=$val['FIN_FAB_QNTY'];
        }
        $buyerColorDeterGsmDiaArr[$val['UOM']][$deterValueNiD][$colorValueNiD][$deter_str]['WO_QTY'] +=$val['FIN_FAB_QNTY'];
    }

    

    $text_store_sql = sql_select("select company_name as COMPANY_NAME, distribute_qnty as DISTRIBUTE_QNTY from variable_settings_production where variable_list=56 and status_active=1 and company_name=$COMPANY_NAME");

    if(empty($text_store_sql))
    {
        echo "Select Textile Store in Library setup";
        die;
    }

    foreach ($text_store_sql as $row) 
    {
        $textile_store_id = $row["DISTRIBUTE_QNTY"];
    }

    $finish_rcv_issuereturn_sql = sql_select("SELECT a.po_breakdown_id as PO_BREAKDOWN_ID,  a.color_id as COLOR_ID, b.fabric_description_id as DETER_ID, b.width as  DIA, b.gsm as GSM, b.grey_used_qty as GREY_USED_QTY, a.id as DTLS_ID, b.id as PROP_ID, f.id as TRANS_ID, a.quantity as QUANTITY, f.store_id as TRANS_STORE, a.entry_form,  d.booking_type as BOOKING_TYPE, g.receive_basis as RECEIVE_BASIS, d.process as PROCESS, h.fabric_source as FABRIC_SOURCE, b.uom as UOM, b.reject_qty as REJECT_QTY from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join inv_transaction f on b.trans_id=f.id, inv_receive_master g, pro_batch_create_mst c, wo_booking_dtls d, tmp_poid e, wo_booking_mst h where a.dtls_id = b.id and b.mst_id = g.id and b.batch_id= c.id and c.booking_no = d.booking_no and d.booking_type=1 and h.fabric_source=2 and a.po_breakdown_id= e.poid and e.userid=$user_id and a.entry_form in (7,37) and g.entry_form in (7,37) and d.booking_no=h.booking_no and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 group by a.po_breakdown_id, a.color_id, b.fabric_description_id, b.width, b.gsm, b.grey_used_qty, a.id, b.id, f.id, a.quantity, f.store_id, a.entry_form, d.booking_type, g.receive_basis, d.process, h.fabric_source, b.uom, b.reject_qty");

    foreach ($finish_rcv_issuereturn_sql as $val) 
    {
        //if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==2 ))
        //{
            if($prop_arr[$val['PROP_ID']] == "")
            {
                $prop_arr[$val['PROP_ID']] = $val['PROP_ID'];
                $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];

                $deterValueNiD = $constructtion_arr[$val['DETER_ID']]." , ".$composition_arr[$val['DETER_ID']]."=".$val['DETER_ID'];
                $colorValueNiD = $lib_color[$val['COLOR_ID']]."=".$val['COLOR_ID'];

                if($val['TRANS_ID'])
                {
                    $buyerColorDeterGsmDiaArr[$val['UOM']][$deterValueNiD][$colorValueNiD][$deter_str]['FINISH_QTY'] +=$val['QUANTITY'];
                    $buyerColorDeterGsmDiaArr[$val['UOM']][$deterValueNiD][$colorValueNiD][$deter_str]['REJECT_QTY'] +=$val['REJECT_QTY'];
                }
            }
        //}
    }

    $finish_iss_rcvret_sql = sql_select("SELECT a.po_breakdown_id as PO_BREAKDOWN_ID, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, g.detarmination_id as DETER_ID, g.dia_width as DIA, g.gsm as GSM, a.trans_id as TRANS_ID, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, d.booking_type as BOOKING_TYPE, b.store_id as STORE_ID , f.issue_purpose as ISSUE_PURPOSE, b.uom as UOM from order_wise_pro_details a, inv_finish_fabric_issue_dtls b, pro_batch_create_mst c, wo_booking_mst d, tmp_poid e, inv_issue_master f , product_details_master g where a.dtls_id=b.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and b.mst_id=f.id and b.prod_id=g.id and a.entry_form in (18,46) and f.entry_form in (18,46) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and d.booking_type in (1) and d.fabric_source=2");

    foreach ($finish_iss_rcvret_sql as $val)
    {
        //if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==2 ))
        //{
            $BUYER = $poBuyer[$val['UOM']];
            $CLIENT = $poClient[$val['PO_BREAKDOWN_ID']];
            $INT_REF = $intRefClient[$val['PO_BREAKDOWN_ID']];
            $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];

            $deterValueNiD = $constructtion_arr[$val['DETER_ID']]." , ".$composition_arr[$val['DETER_ID']]."=".$val['DETER_ID'];
            $colorValueNiD = $lib_color[$val['COLOR_ID']]."=".$val['COLOR_ID'];

            if($val['ENTRY_FORM']==18)
            {

                /*if($val['STORE_ID']==$textile_store_id)
                {
                    //$buyerColorDeterGsmDiaArr[$val['UOM']][$val['COLOR_ID']][$deter_str]['TEXT_FIN_ISSUE'] +=$val['QUANTITY'];
                }
                else
                {
                    $buyerColorDeterGsmDiaArr[$val['UOM']][$deterValueNiD][$colorValueNiD][$deter_str]['GMTS_FIN_ISSUE'] +=$val['QUANTITY'];
                }*/
                
                $buyerColorDeterGsmDiaArr[$val['UOM']][$deterValueNiD][$colorValueNiD][$deter_str]['GMTS_FIN_ISSUE'] +=$val['QUANTITY'];
            }
            else if($val['ENTRY_FORM']==46)
            {
                $buyerColorDeterGsmDiaArr[$val['UOM']][$deterValueNiD][$colorValueNiD][$deter_str]['FIN_RECV_RETURN'] +=$val['QUANTITY'];
            } 
        //}
    }

    $finish_transfer_sql = sql_select("SELECT a.transfer_criteria as TRANSFER_CRITERIA, d.po_breakdown_id as PO_BREAKDOWN_ID, d.id as ID, d.quantity as QUANTITY, d.trans_type as TRANS_TYPE, c.store_id as STORE_ID, b.from_store as FROM_STORE, b.to_store as TO_STORE, h.color as COLOR_ID, h.detarmination_id as DETER_ID, h.dia_width as DIA, h.gsm as GSM, f.fabric_source as FABRIC_SOURCE, f.booking_type as BOOKING_TYPE, b.uom as UOM from inv_item_transfer_mst a, inv_item_transfer_dtls b, inv_transaction c, order_wise_pro_details d, pro_batch_create_mst e, wo_booking_mst f, tmp_poid g, product_details_master h where a.id = b.mst_id and b.id = d.dtls_id and d.trans_type in (5,6) and c.id=d.trans_id and a.entry_form=14 and d.entry_form=14 and c.pi_wo_batch_no= e.id and e.booking_no = f.booking_no and f.booking_type in (1) and d.po_breakdown_id=g.poid and g.userid=$user_id and c.prod_id=h.id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0");

    foreach ($finish_transfer_sql as $val) 
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==2))
        {
            $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];

            $deterValueNiD = $constructtion_arr[$val['DETER_ID']]." , ".$composition_arr[$val['DETER_ID']]."=".$val['DETER_ID'];
            $colorValueNiD = $lib_color[$val['COLOR_ID']]."=".$val['COLOR_ID'];

            if($prop_arr[$val['ID']] == "")
            {
                /*if($val['TRANSFER_CRITERIA']==2)
                {
                    //if($val['TRANS_TYPE']==6 && $val['FROM_STORE']==$textile_store_id)
                    //{
                    //    $buyerColorDeterGsmDiaArr[$val['UOM']][$val['COLOR_ID']][$deter_str]['TEXT_OUT'] +=$val['QUANTITY'];
                    //}
                    //if($val['TRANS_TYPE']==5 && $val['TO_STORE']==$textile_store_id)
                    //{
                    //    $buyerColorDeterGsmDiaArr[$val['UOM']][$val['COLOR_ID']][$deter_str]['TEXT_IN'] +=$val['QUANTITY'];
                    //}
                }
                else
                {
                    if($val['TRANS_TYPE'] ==5)
                    {
                        $buyerColorDeterGsmDiaArr[$val['UOM']][$deterValueNiD][$colorValueNiD][$deter_str]['GMTS_IN'] +=$val['QUANTITY'];
                    }else{
                        $buyerColorDeterGsmDiaArr[$val['UOM']][$deterValueNiD][$colorValueNiD][$deter_str]['GMTS_OUT'] +=$val['QUANTITY'];
                    }
                }*/

                if($val['TRANS_TYPE'] ==5)
                {
                    $buyerColorDeterGsmDiaArr[$val['UOM']][$deterValueNiD][$colorValueNiD][$deter_str]['GMTS_IN'] +=$val['QUANTITY'];
                }else{
                    $buyerColorDeterGsmDiaArr[$val['UOM']][$deterValueNiD][$colorValueNiD][$deter_str]['GMTS_OUT'] +=$val['QUANTITY'];
                }

                $prop_arr[$val['ID']] = $val['ID'];
            }
        }
    }

    $finish_issue_return = sql_select("SELECT a.po_breakdown_id as PO_BREAKDOWN_ID, a.entry_form as ENTRY_FORM, a.trans_id as TRANS_ID,  a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, d.booking_type as BOOKING_TYPE, f.store_id as STORE_ID, b.color as COLOR_ID, b.detarmination_id as DETER_ID, b.dia_width as DIA, b.gsm as GSM, b.unit_of_measure as UOM FROM order_wise_pro_details a, inv_transaction f, inv_receive_master g, pro_batch_create_mst c, wo_booking_mst d, tmp_poid e, product_details_master b WHERE a.trans_id = f.id and f.mst_id = g.id and f.pi_wo_batch_no= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and f.prod_id=b.id and a.entry_form =52 and g.entry_form =52 and a.status_active=1 and a.is_deleted=0 and f.status_active=1 and f.is_deleted=0 and d.booking_type in (1)");

    foreach ($finish_issue_return as $val) 
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==2 ))
        {
            $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];

            $deterValueNiD = $constructtion_arr[$val['DETER_ID']]." , ".$composition_arr[$val['DETER_ID']]."=".$val['DETER_ID'];
            $colorValueNiD = $lib_color[$val['COLOR_ID']]."=".$val['COLOR_ID'];

            /*if($val['STORE_ID'] ==$textile_store_id)
            {
                //$buyerColorDeterGsmDiaArr[$val['UOM']][$val['COLOR_ID']][$deter_str]['TEXT_ISS_RET']+=$val['QUANTITY'];
            }else{
                $buyerColorDeterGsmDiaArr[$val['UOM']][$deterValueNiD][$colorValueNiD][$deter_str]['GMTS_ISS_RET']+=$val['QUANTITY'];
            }*/

            $buyerColorDeterGsmDiaArr[$val['UOM']][$deterValueNiD][$colorValueNiD][$deter_str]['GMTS_ISS_RET']+=$val['QUANTITY'];
        }
    }

    /*echo "<pre>";
    print_r($buyerColorDeterGsmDiaArr);
    echo "<pre>";
    die;*/

    $r_id2=execute_query("delete from tmp_poid where userid=$user_id");
    if($r_id2)
    {
        oci_commit($con);
    }
    
    ob_start();
    ?>
    <div class="tableContainer">  
        <style type="text/css">
        .rpt_table tr th, .rpt_table tr td,.rpt_table tfoot th{font-size:13px;}
        .word_break_wrap{
            word-wrap: break-word;
            word-break: break-all;
        }
        </style>

        <fieldset style="width:1310px;">
            <table width="100%" cellpadding="0" cellspacing="0">
                <tr><td colspan="18" align="center" style="font-size:22px;">Purchased Circular Fabric </td></tr>
                <tr>
                <tr><td colspan="18" align="center" style="font-size:17px;">SBU <span style="color: black;font-size: 18px;font-weight: bold;"> <?=($client) ? ": ".$client_array[$client] : ": All"; ?></span></td></tr>
            </table>
            <?
            if($rptType==6)
            {
                $acting_width = $screen_size-50;
                $three_percent = $acting_width*0.03;
                $four_percent = $acting_width*0.04;
                $five_percent = $acting_width*0.05;
                $six_percent = $acting_width*0.06;
                $seven_percent = $acting_width*0.07;
                ?>
                <table width="<? echo $acting_width;?>" border="1" rules="all"  class="rpt_table" align="left" > 
                    <thead>
                        <tr>
                            <th width="<? echo $seven_percent;?>">UOM</th>
                            <th width="<? echo $seven_percent;?>">Structure</th>
                            <th width="<? echo $seven_percent;?>">Fab Composition</th>
                            <th width="<? echo $seven_percent;?>">Fab Color</th>
                            <th width="<? echo $five_percent;?>">GSM</th>
                            <th width="<? echo $five_percent;?>">Finish Dia</th>
                            <th width="<? echo $five_percent;?>">Req qty</th>
                            <th width="<? echo $five_percent;?>">Ex qty</th>
                            <th width="<? echo $five_percent;?>">Total qty</th>

                            <th width="<? echo $six_percent;?>">WO Qty</th>
                            <th width="<? echo $six_percent;?>">WO Bal</th>
                            <th width="<? echo $five_percent;?>">Receive Qty</th>

                            <th width="<? echo $five_percent;?>">Rcv Rej Qty</th>
                            <th width="<? echo $five_percent;?>">Receive Bal</th>
                            <th width="<? echo $five_percent;?>">Trans in</th>
                            <th width="<? echo $five_percent;?>">Trans out</th> 

                            <th width="<? echo $five_percent;?>">Overall bal</th>
                            <th width="<? echo $five_percent;?>">stock</th>
                       </tr>
                    </thead>
                </table>
                <div style="max-height:425px; overflow-y:scroll; width:<? echo $acting_width + 18;?>px;" id="scroll_body">
                    <table width="<? echo $acting_width?>" border="1" rules="all"  class="rpt_table">
                        <tbody>
                            <? 
                            ksort($buyerColorDeterGsmDiaArr);
                            foreach ($buyerColorDeterGsmDiaArr as $UOM => $UOMData) 
                            {
                                ksort($UOMData);
                                foreach ($UOMData as $DeterID => $DeterData) 
                                {
                                    ksort($DeterData);
                                    foreach ($DeterData as $COLORID => $colorData) 
                                    {
                                        foreach ($colorData as $deterString => $row) 
                                        {
                                            $td_span_uom_arr[$UOM]++;
                                        }
                                    }
                                }
                            }

                            $i=1;ksort($buyerColorDeterGsmDiaArr);
                            foreach ($buyerColorDeterGsmDiaArr as $UOM => $UOMData) 
                            {
                                $y=1;ksort($UOMData);
                                foreach ($UOMData as $DeterID => $DeterData) 
                                {
                                    ksort($DeterData);
                                    foreach ($DeterData as $COLORID => $colorData) 
                                    {
                                        foreach ($colorData as $deterString => $row) 
                                        {
                                            $deterArr = explode("*", $deterString);
                                            $deter_id = $deterArr[0];
                                            $gsm = $deterArr[1];
                                            $dia = $deterArr[2];


                                            $COLORIDArr = explode("=", $COLORID);
                                            $COLOR_ID = $COLORIDArr[1];

                                            $total_qnty = $row['REQ_QTY'] + $row['SHORT_QTY'];

                                            $rcv_from_dyeing = $row['FINISH_QTY'] - $row['FIN_RECV_RETURN'];
                                            $rcv_bal = $total_qnty-$rcv_from_dyeing;
                                            $reject_qty = $row['REJECT_QTY'];
                                            $wo_qty = $row['WO_QTY'];
                                            $wo_bal = $total_qnty-$wo_qty;
                                            $gmts_in = $row['GMTS_IN'];
                                            $gmts_out = $row['GMTS_OUT'];
                                            $gmts_fin_issue =$row['GMTS_FIN_ISSUE'];
                                            $gmts_iss_ret =$row['GMTS_ISS_RET'];

                                            //Formula=[Total Qty -(Receive qty + Transfer In - Transfer Out)]
                                            $overall_bal = $total_qnty - ($rcv_from_dyeing + $gmts_in- $gmts_out);

                                            //Formula=(Rcv qty+Issue Return qty+Trans In)-(Issue Qty+Receive Return qty+Trans Out)
                                            $gmts_stock = ($rcv_from_dyeing + $gmts_iss_ret + $gmts_in) -($gmts_fin_issue + $gmts_out);
                                            
                                            $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF";
                                            ?>
                                            <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('str_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="str_<? echo $i; ?>" style="" valign="middle">
                                                <? 
                                                if($y==1)
                                                {
                                                 ?>
                                                    <td title="<? echo $UOM;?>" align="center" width="<? echo $seven_percent;?>" rowspan="<? echo $td_span_uom_arr[$UOM]+1?>"><? echo $unit_of_measurement[$UOM];?></td>
                                                <?
                                                }
                                                ?>
                                                <td align="center" class="word_break_wrap" width="<? echo $seven_percent;?>" title="<? echo $constructtion_arr[$deter_id];?>"><? echo  substr($constructtion_arr[$deter_id],0,15);?></td>
                                                <td align="center" class="word_break_wrap" width="<? echo $seven_percent;?>" title="<? echo $composition_arr[$deter_id];?>">
                                                    <a href="##" onclick="circular_popup('<? echo $search_data."*".$UOM."**".$COLOR_ID."*".$deterString;?>','purchased_circular_ref_wise_popup')" >
                                                    <? 
                                                        echo substr($composition_arr[$deter_id],0,15);
                                                    ?>
                                                    </a>
                                                </td>
                                                 <td align="center" class="word_break_wrap" width="<? echo $seven_percent;?>" title="<? echo $lib_color[$COLOR_ID];?>"><? echo substr($lib_color[$COLOR_ID],0,10);?></td>
                                                <td align="center" width="<? echo $five_percent;?>"><? echo $gsm;?></td>
                                                <td align="center" width="<? echo $five_percent;?>"><? echo $dia;?></td> 

                                                <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($row['REQ_QTY'],9,"");?></td>
                                                <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($row['SHORT_QTY'],9,"");?></td>
                                                <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($total_qnty,9,"");?></td>

                                                <td align="right" width="<? echo $six_percent;?>"><? echo decimal_format($wo_qty,9,"");?></td>
                                                <td align="right" width="<? echo $six_percent;?>"><? echo decimal_format($wo_bal,9,"");?></td>
                                                <td align="right" width="<? echo $five_percent;?>" title="<? echo "rcv=".$row['FINISH_QTY'] .",- return=". $row['FIN_RECV_RETURN'];?>"><? echo decimal_format($rcv_from_dyeing,9,"");?></td>
                                                <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($reject_qty,9,"");?></td>
                                                <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($rcv_bal,9,"");?></td>
                                                <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($gmts_in,9,"");?></td>
                                                <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($gmts_out,9,"");?></td> 
                                                <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($overall_bal,9,"");?></td>
                                                <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($gmts_stock ,9,"");?></td>
                                            </tr>
                                            <? 
                                            $i++;$y++;

                                            $sub_req_qnty += $row['REQ_QTY'];
                                            $sub_ex_qnty  += $row['SHORT_QTY'];
                                            $sub_total_qnty += $total_qnty;
                                            $sub_rcv_from_dyeing +=$rcv_from_dyeing;
                                            $sub_rcv_bal +=$rcv_bal;
                                            $sub_wo_qty += $wo_qty;
                                            $sub_wo_bal += $wo_bal;
                                            $sub_reject_qty += $reject_qty;
                                            $sub_gmts_in += $gmts_in;
                                            $sub_gmts_out += $gmts_out;
                                            $sub_overall_bal += $overall_bal;
                                            $sub_gmts_stock += $gmts_stock;


                                            $grand_req_qnty += $row['REQ_QTY'];
                                            $grand_ex_qnty  += $row['SHORT_QTY'];
                                            $grand_total_qnty += $total_qnty;
                                            $grand_rcv_from_dyeing +=$rcv_from_dyeing;
                                            $grand_rcv_bal +=$rcv_bal;
                                            $grand_wo_qty += $wo_qty;
                                            $grand_wo_bal += $wo_bal;
                                            $grand_reject_qty += $reject_qty;
                                            $grand_gmts_in += $gmts_in;
                                            $grand_gmts_out += $gmts_out;
                                            $grand_overall_bal += $overall_bal;
                                            $grand_gmts_stock += $gmts_stock;
                                        }
                                    }
                                }
                                
                                ?>
                                <tr bgcolor="#ccc">
                                    <td align="center" width="<? echo $seven_percent+$seven_percent+$seven_percent+$five_percent+$five_percent;?>" colspan="5"> Total</td>
                                    <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_req_qnty,9,"");?></td>
                                    <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_ex_qnty,9,"");?></td>
                                    <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_total_qnty,9,"");?></td>
                                    <td align="right" width="<? echo $six_percent;?>" ><? echo decimal_format($sub_wo_qty,9,"");?></td>
                                    <td align="right" width="<? echo $six_percent;?>" ><? echo decimal_format($sub_wo_bal,9,"");?></td>
                                    <td align="right" width="<? echo $four_percent;?>"><? echo decimal_format($sub_rcv_from_dyeing,9,"");?></td>
                                    <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_reject_qty,9,"");?></td>
                                    <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_rcv_bal,9,"");?></td>
                                    <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_gmts_in,9,"");?></td>
                                    <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_gmts_out,9,"");?></td> 
                                    <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_overall_bal,9,"");?></td>
                                    <td align="right" width="<? echo $five_percent;?>"><? echo decimal_format($sub_gmts_stock,9,"");?></td>

                                </tr>

                                <?
                                $sub_req_qnty=$sub_ex_qnty= $sub_total_qnty=$sub_rcv_from_dyeing=$sub_rcv_bal=$sub_wo_qty=$sub_wo_bal= $sub_reject_qty=$sub_gmts_in=$sub_gmts_out=$sub_overall_bal=$sub_gmts_stock=0;
                            }
                        
                           ?>
                        </tbody>
                    </table>
                </div>
                <?
            }
            ?>
        </fieldset>
    </div>
    <?
    foreach (glob("$user_id*.xls") as $filename) 
    {
        if( @filemtime($filename) < (time()-$seconds_old) )
        @unlink($filename);
    }
    //---------end------------//
    $name=time();
    $filename="tmp/".$user_id."_".$name.".xls";
    $create_new_doc = fopen($filename, 'w');
    $is_created = fwrite($create_new_doc,ob_get_contents());
   // $filename=$user_id."_".$name.".xls";
    echo "$total_data####$filename";
    exit();
}

if($action=="purchased_circular_ref_wise_popup")
{
    echo load_html_head_contents("Job Info", "../../../../", 1, 1,'','','');
    $lib_color = return_library_array("select id,color_name from lib_color", "id", "color_name");
    $lib_supplier = return_library_array("select id,supplier_name from lib_supplier", "id", "supplier_name");
    extract($_REQUEST);
    
    $data_arr = explode("*", $data_str);
    
    //below search criteria datas
    $company_id=   $data_arr[0];
    $location_name=   $data_arr[1];
    $buyer_name=   $data_arr[2];
    $season_name=   $data_arr[3];
    $client=   $data_arr[4];
    $merchant=   $data_arr[5];
    $int_ref_no=   $data_arr[6];
    $shipment_status=   $data_arr[7];
    $order_status=   $data_arr[8];
    $status=   $data_arr[9];
    $search_by=   $data_arr[10];
    $date_from=   $data_arr[11];
    $date_to=   $data_arr[12];

    //ref data
    $UOM=           $data_arr[13];
    $internal_ref=  $data_arr[14];
    $color=         $data_arr[15];
    $deter_id=      $data_arr[16];
    $gsm=           $data_arr[17];
    $dia=           $data_arr[18];

    // Circular Fabric button

    $sqlCond = "";
    $sqlCond .= " and a.company_name=$company_id";
    $sqlCond .= ($buyer_name != 0)   ? " and a.buyer_name=$buyer_name"         : "";
    $sqlCond .= ($location_name !=0) ? " and a.location_name in($location_name)" : "";
    $sqlCond .= ($season_name != 0)   ? " and a.season_buyer_wise=$season_name"         : "";
    //$sqlCond .= ($merchant != 0)     ? " and a.team_leader=$merchant"            : "";
    $sqlCond .= ($client != 0)       ? " and a.client_id=$client"            : "";
    $sqlCond .= ($int_ref_no !="")  ? " and b.grouping ='$int_ref_no'"      : "";
    //$sqlCond .= ($style_ref !="")   ? " and a.style_ref_no like '%$style_ref%'" : "";
    
    if($shipment_status==1)
    {
        $sqlCond .= " and b.shiping_status in(1,2)";
    }
    elseif ($shipment_status==2) {
        $sqlCond .= " and b.shiping_status in(3)";
    }
    $sqlCond .= ($order_status == 1) ? " and b.is_confirmed in(1)" : " and b.is_confirmed in(2)";
    $sqlCond .= ($status !=0) ? " and b.status_active = $status" : "";
    //$sqlCond .= ($item_id !=0) ? " and c.item_number_id in($item_id)" : "";
    // $sqlCond .= ($year !="") ? " and to_char(b.insert_date,'YYYY')=$year" : "";
    if($date_from !="" && $date_to !="")
    {
        if($db_type==0)
        {
            $start_date=change_date_format($date_from,"yyyy-mm-dd","");
            $end_date=change_date_format($date_to,"yyyy-mm-dd","");
        }
        else
        {
            $start_date=date("j-M-Y",strtotime($date_from));
            $end_date=date("j-M-Y",strtotime($date_to));
        }
        
        switch ($search_by) 
        {
            case 2:
                $sqlCond .= " and b.PUB_SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
            case 3:
               $sqlCond .= " and b.po_received_date between '$start_date' and '$end_date'";
               break;
            case 4:
                $sqlCond .= " and c.country_ship_date between '$start_date' and '$end_date'";
                break;
            case 5:
                $sqlCond .= " and b.insert_date between '$start_date' and '$end_date'";
                break;
           
            default:
                $sqlCond .= " and b.SHIPMENT_DATE between '$start_date' and '$end_date'";
                break;
        }
    }

    $sqlCond .= ($internal_ref !="")  ? " and b.grouping ='$internal_ref'"      : "";
    $sqlCond .= ($buyer_id != 0)   ? " and a.buyer_name=$buyer_id"         : "";
    //$sqlCond .= ($UOM != 0)   ? " and d.uom=$UOM"         : "";
    //$sqlCond .= ($gsm)   ? " and d.gsm_weight=$gsm"         : "";
    //$sqlCond .= ($dia)   ? " and e.dia_width=$dia"         : "";
    
    //$colorCond_1 = ($color != 0)   ? " and e.color_number_id=$color"         : "";
    //$colorCond_2 = ($color != 0)   ? " and f.contrast_color_id=$color"         : "";


   $sql = "SELECT a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, a.style_ref_no as STYLE_REF_NO, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT, d.uom as UOM, e.dia_width as DIA_WIDTH, e.color_number_id as FABRIC_COLOR_ID 
    from wo_po_details_master a,wo_po_break_down b,wo_po_color_size_breakdown c , wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and d.color_size_sensitive!=3  and d.body_part_type in (1,20,30) and d.fabric_source=2 $colorCond_1
    group by a.company_name, a.buyer_name, a.client_id, a.style_ref_no, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, d.uom, e.dia_width, e.color_number_id
    union all
    select a.company_name as COMPANY_NAME, a.buyer_name as BUYER_NAME, a.client_id as CLIENT_ID, a.style_ref_no as STYLE_REF_NO, b.grouping as GROUPING, b.id as PO_ID, d.lib_yarn_count_deter_id as LIB_YARN_COUNT_DETER_ID,d.gsm_weight as GSM_WEIGHT, d.uom as UOM, e.dia_width as DIA_WIDTH, f.contrast_color_id as FABRIC_COLOR_ID
    from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e, wo_pre_cos_fab_co_color_dtls f
    where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id and a.id=d.job_id 
    and d.id=e.pre_cost_fabric_cost_dtls_id and c.id=e.color_size_table_id and b.id=e.po_break_down_id and a.id=f.job_id and e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id
    and a.status_active=1 and a.is_deleted=0 and b.is_deleted=0 and c.status_active =1 and c.is_deleted=0 $sqlCond and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 and f.status_active=1 and f.is_deleted=0 and d.color_size_sensitive=3  and d.body_part_type in (1,20,30) and d.fabric_source=2 $colorCond_2
    group by a.company_name, a.buyer_name, a.client_id, a.style_ref_no, b.grouping, b.id , d.lib_yarn_count_deter_id, d.gsm_weight, d.uom, e.dia_width, f.contrast_color_id";

    $sqlRes = sql_select($sql);

    if(count($sqlRes)==0)
    {
        echo '<div style="text-align: center;color: red;font-weight: bold;font-size: 20px;">Data not found.</div>';die();
    }

    $poIdArray = array();

    if(!empty($sqlRes))  
    {
        $con = connect();
        $r_id=execute_query("delete from tmp_poid where userid=$user_id");
        if($r_id)
        {
            oci_commit($con);
        }
    }

    foreach ($sqlRes as $row) 
    {
        
        if(!$poIdArray[$row['PO_ID']])
        {
            $poIdArray[$row['PO_ID']] = $row['PO_ID'];
            $poIds .= $row['PO_ID'].",";
            $rID=execute_query("insert into tmp_poid (userid, poid) values ($user_id,".$row['PO_ID'].")");
        }
        $intRefClient[$row['PO_ID']] = $row['GROUPING'];
        $poStyleRef[$row['PO_ID']] = $row['STYLE_REF_NO'];
    }

    if($rID)
    {
        oci_commit($con);
    }

    $poIds = chop($poIds,",");
    $condition= new condition();     
    $condition->po_id_in($poIds);     
    $condition->init();
    //$costPerArr=$condition->getCostingPerArr();
    $fabric= new fabric($condition);
    //echo $fabric->getQuery();die;

    $fabric_costing_arr=$fabric->getQtyArray_by_OrderFabricSourceBodyTypeFabColorDeterminIdGsmAndDiaWidth_knitAndwoven_greyAndfinish();

    foreach ($sqlRes as $row) 
    {
        if($row['FABRIC_COLOR_ID']==$color && $row['LIB_YARN_COUNT_DETER_ID'] == $deter_id  && $row['GSM_WEIGHT']==$gsm &&  $row['DIA_WIDTH'] == $dia && $row['UOM'] == $UOM)
        {
            if($po_deter_lvl_req_chk[$row['PO_ID']."*".$row['FABRIC_COLOR_ID']."*".$row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH']."*".$row['UOM']] =="")
            {
                $po_deter_lvl_req_chk[$row['PO_ID']."*".$row['FABRIC_COLOR_ID']."*".$row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH']."*".$row['UOM']] = $row['BUYER_NAME'];
                
                $deter_str = $row['LIB_YARN_COUNT_DETER_ID']."*".$row['GSM_WEIGHT']."*".$row['DIA_WIDTH'];

                $buyerColorDeterGsmDiaRequired=0;
                $buyerColorDeterGsmDiaRequired = $fabric_costing_arr['knit']['finish'][$row['PO_ID']][2][1][$row['FABRIC_COLOR_ID']][$row['LIB_YARN_COUNT_DETER_ID']][$row['GSM_WEIGHT']][$row['DIA_WIDTH']][$row['UOM']] + 
                $fabric_costing_arr['knit']['finish'][$row['PO_ID']][2][20][$row['FABRIC_COLOR_ID']][$row['LIB_YARN_COUNT_DETER_ID']][$row['GSM_WEIGHT']][$row['DIA_WIDTH']][$row['UOM']] + 
                $fabric_costing_arr['knit']['finish'][$row['PO_ID']][2][30][$row['FABRIC_COLOR_ID']][$row['LIB_YARN_COUNT_DETER_ID']][$row['GSM_WEIGHT']][$row['DIA_WIDTH']][$row['UOM']];

                if($buyerColorDeterGsmDiaRequired >0)
                {
                    //$buyerColorDeterGsmDiaArr[$row['GROUPING']][$row['STYLE_REF_NO']][$row['FABRIC_COLOR_ID']][$deter_str]['REQ_QTY'] += $buyerColorDeterGsmDiaRequired;

                    $buyerColorDeterGsmDiaArr[$row['GROUPING']][$row['STYLE_REF_NO']]['REQ_QTY'] += $buyerColorDeterGsmDiaRequired;
                }
            }
        }
    }


    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and a.fabric_color_id='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and b.lib_yarn_count_deter_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and b.gsm_weight=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and a.dia_width='$dia'";  
    }
    if($UOM !=""){
        $ref_data_cond .=" and b.uom='$UOM'";  
    }

    $short_sql = sql_select("SELECT a.po_break_down_id, c.buyer_id as BUYER_ID, d.client_id as CLIENT_ID, e.grouping as GROUPING, B.BODY_PART_TYPE, a.grey_fab_qnty as GREY_FAB_QNTY, a.fin_fab_qnty as FIN_FAB_QNTY, a.fabric_color_id as COLOR_ID, b.lib_yarn_count_deter_id as DETERMINATION_ID, b.gsm_weight as GSM_WEIGHT, a.dia_width as DIA_WIDTH, b.uom as UOM, b.job_no as JOB_NO,a.is_short as IS_SHORT, d.style_ref_no as STYLE_REF_NO from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b, wo_booking_mst c, wo_po_details_master d, wo_po_break_down e, tmp_poid f where a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no=c.booking_no and b.job_id=d.id and a.po_break_down_id=e.id and a.po_break_down_id=f.poid and f.userid=$user_id and c.fabric_source=2  and a.booking_type=1 and a.status_active =1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $ref_data_cond"); //and a.is_short=1

    foreach ($short_sql as $val) 
    {
        $deter_str = $val['DETERMINATION_ID']."*".$val['GSM_WEIGHT']."*".$val['DIA_WIDTH'];
        if($val['IS_SHORT'] ==1)
        {
            //$buyerColorDeterGsmDiaArr[$val['GROUPING']][$val['STYLE_REF_NO']][$val['COLOR_ID']][$deter_str]['SHORT_QTY'] +=$val['FIN_FAB_QNTY'];
            $buyerColorDeterGsmDiaArr[$val['GROUPING']][$val['STYLE_REF_NO']]['SHORT_QTY'] +=$val['FIN_FAB_QNTY'];
        }
        //$buyerColorDeterGsmDiaArr[$val['GROUPING']][$val['STYLE_REF_NO']][$val['COLOR_ID']][$deter_str]['WO_QTY'] +=$val['FIN_FAB_QNTY'];
        $buyerColorDeterGsmDiaArr[$val['GROUPING']][$val['STYLE_REF_NO']]['WO_QTY'] +=$val['FIN_FAB_QNTY'];
    }

    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and a.color_id='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and b.fabric_description_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and b.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and b.width='$dia'";  
    }
    if($UOM !=""){
        $ref_data_cond .=" and b.uom='$UOM'";  
    }


    $finish_rcv_issuereturn_sql = sql_select("SELECT a.po_breakdown_id as PO_BREAKDOWN_ID,  a.color_id as COLOR_ID, b.fabric_description_id as DETER_ID, b.width as  DIA, b.gsm as GSM, b.grey_used_qty as GREY_USED_QTY, a.id as DTLS_ID, b.id as PROP_ID, f.id as TRANS_ID, a.quantity as QUANTITY, f.store_id as TRANS_STORE, a.entry_form,  d.booking_type as BOOKING_TYPE, g.receive_basis as RECEIVE_BASIS, d.process as PROCESS, h.fabric_source as FABRIC_SOURCE, b.uom as UOM, b.reject_qty as REJECT_QTY from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join inv_transaction f on b.trans_id=f.id, inv_receive_master g, pro_batch_create_mst c, wo_booking_dtls d, tmp_poid e, wo_booking_mst h where a.dtls_id = b.id and b.mst_id = g.id and b.batch_id= c.id and c.booking_no = d.booking_no and d.booking_type=1 and h.fabric_source=2 and a.po_breakdown_id= e.poid and e.userid=$user_id and a.entry_form in (7,37) and g.entry_form in (7,37) and d.booking_no=h.booking_no and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 $ref_data_cond group by a.po_breakdown_id, a.color_id, b.fabric_description_id, b.width, b.gsm, b.grey_used_qty, a.id, b.id, f.id, a.quantity, f.store_id, a.entry_form, d.booking_type, g.receive_basis, d.process, h.fabric_source, b.uom, b.reject_qty");

    /*echo "SELECT a.po_breakdown_id as PO_BREAKDOWN_ID,  a.color_id as COLOR_ID, b.fabric_description_id as DETER_ID, b.width as  DIA, b.gsm as GSM, b.grey_used_qty as GREY_USED_QTY, a.id as DTLS_ID, b.id as PROP_ID, f.id as TRANS_ID, a.quantity as QUANTITY, f.store_id as TRANS_STORE, a.entry_form,  d.booking_type as BOOKING_TYPE, g.receive_basis as RECEIVE_BASIS, d.process as PROCESS, h.fabric_source as FABRIC_SOURCE, b.uom as UOM, b.reject_qty as REJECT_QTY from order_wise_pro_details a, pro_finish_fabric_rcv_dtls b left join inv_transaction f on b.trans_id=f.id, inv_receive_master g, pro_batch_create_mst c, wo_booking_dtls d, tmp_poid e, wo_booking_mst h where a.dtls_id = b.id and b.mst_id = g.id and b.batch_id= c.id and c.booking_no = d.booking_no and d.booking_type=1 and h.fabric_source=2 and a.po_breakdown_id= e.poid and e.userid=$user_id and a.entry_form in (7,37) and g.entry_form in (7,37) and d.booking_no=h.booking_no and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 $ref_data_cond group by a.po_breakdown_id, a.color_id, b.fabric_description_id, b.width, b.gsm, b.grey_used_qty, a.id, b.id, f.id, a.quantity, f.store_id, a.entry_form, d.booking_type, g.receive_basis, d.process, h.fabric_source, b.uom, b.reject_qty";die;*/

    foreach ($finish_rcv_issuereturn_sql as $val) 
    {
        if($prop_arr[$val['PROP_ID']] == "")
        {
            $prop_arr[$val['PROP_ID']] = $val['PROP_ID'];
            $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];

            $INT_REF = $intRefClient[$val['PO_BREAKDOWN_ID']];
            $STYLE_REF = $poStyleRef[$val['PO_BREAKDOWN_ID']];
            if($val['TRANS_ID'])
            {
                //$buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF][$val['COLOR_ID']][$deter_str]['FINISH_QTY'] +=$val['QUANTITY'];
                //$buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF][$val['COLOR_ID']][$deter_str]['REJECT_QTY'] +=$val['REJECT_QTY'];

                $buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF]['FINISH_QTY'] +=$val['QUANTITY'];
                $buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF]['REJECT_QTY'] +=$val['REJECT_QTY'];
            }
        }
    }

    $text_store_sql = sql_select("select company_name as COMPANY_NAME, distribute_qnty as DISTRIBUTE_QNTY from variable_settings_production where variable_list=56 and status_active=1 and company_name=$company_id");

    if(empty($text_store_sql))
    {
        echo "Select Textile Store in Library setup";
        die;
    }

    foreach ($text_store_sql as $row) 
    {
        $textile_store_id = $row["DISTRIBUTE_QNTY"];
    }

    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and a.color_id='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and g.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and g.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and g.dia_width='$dia'";  
    }
    if($UOM !=""){
        $ref_data_cond .=" and b.uom='$UOM'";  
    }

    $finish_iss_rcvret_sql = sql_select("SELECT a.po_breakdown_id as PO_BREAKDOWN_ID, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, g.detarmination_id as DETER_ID, g.dia_width as DIA, g.gsm as GSM, a.trans_id as TRANS_ID, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, d.booking_type as BOOKING_TYPE, b.store_id as STORE_ID , f.issue_purpose as ISSUE_PURPOSE, b.uom as UOM from order_wise_pro_details a, inv_finish_fabric_issue_dtls b, pro_batch_create_mst c, wo_booking_mst d, tmp_poid e, inv_issue_master f, product_details_master g where a.dtls_id=b.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and b.mst_id=f.id and b.prod_id=g.id and a.entry_form in (18,46) and f.entry_form in (18,46) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and d.booking_type in (1) and d.fabric_source=2 $ref_data_cond");
    /*echo "SELECT a.po_breakdown_id as PO_BREAKDOWN_ID, a.entry_form as ENTRY_FORM, a.color_id as COLOR_ID, g.detarmination_id as DETER_ID, g.dia_width as DIA, g.gsm as GSM, a.trans_id as TRANS_ID, a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, d.booking_type as BOOKING_TYPE, b.store_id as STORE_ID , f.issue_purpose as ISSUE_PURPOSE, b.uom as UOM from order_wise_pro_details a, inv_finish_fabric_issue_dtls b, pro_batch_create_mst c, wo_booking_mst d, tmp_poid e, inv_issue_master f, product_details_master g where a.dtls_id=b.id and b.batch_id= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and b.mst_id=f.id and b.prod_id=g.id and a.entry_form in (18,46) and f.entry_form in (18,46) and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and d.booking_type in (1) and d.fabric_source=2 $ref_data_cond";*/

    foreach ($finish_iss_rcvret_sql as $val)
    {
        $INT_REF = $intRefClient[$val['PO_BREAKDOWN_ID']];
        $STYLE_REF = $poStyleRef[$val['PO_BREAKDOWN_ID']];
        $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];
        if($val['ENTRY_FORM']==18)
        {
            /*if($val['STORE_ID']==$textile_store_id)
            {
                //$buyerColorDeterGsmDiaArr[$val['UOM']][$val['COLOR_ID']][$deter_str]['TEXT_FIN_ISSUE'] +=$val['QUANTITY'];
            }
            else
            {
                //$buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF][$val['COLOR_ID']][$deter_str]['GMTS_FIN_ISSUE'] +=$val['QUANTITY'];
                $buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF]['GMTS_FIN_ISSUE'] +=$val['QUANTITY'];
            }*/

            $buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF]['GMTS_FIN_ISSUE'] +=$val['QUANTITY'];
        }
        else if($val['ENTRY_FORM']==46)
        {
            //$buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF][$val['COLOR_ID']][$deter_str]['FIN_RECV_RETURN'] +=$val['QUANTITY'];
            $buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF]['FIN_RECV_RETURN'] +=$val['QUANTITY'];
        }
    }


    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and h.color='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and h.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and h.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and h.dia_width='$dia'";  
    }
    if($dia !=""){
        $ref_data_cond .=" and h.dia_width='$dia'";  
    }
    if($UOM !=""){
        $ref_data_cond .=" and b.uom='$UOM'";  
    }
    
    $finish_transfer_sql = sql_select("SELECT a.transfer_criteria as TRANSFER_CRITERIA, d.po_breakdown_id as PO_BREAKDOWN_ID, d.id as ID, d.quantity as QUANTITY, d.trans_type as TRANS_TYPE, c.store_id as STORE_ID, b.from_store as FROM_STORE, b.to_store as TO_STORE, h.color as COLOR_ID, h.detarmination_id as DETER_ID, h.dia_width as DIA, h.gsm as GSM, f.fabric_source as FABRIC_SOURCE, f.booking_type as BOOKING_TYPE from inv_item_transfer_mst a, inv_item_transfer_dtls b, inv_transaction c, order_wise_pro_details d, pro_batch_create_mst e, wo_booking_mst f, tmp_poid g, product_details_master h where a.id = b.mst_id and b.id = d.dtls_id and d.trans_type in (5,6) and c.id=d.trans_id and a.entry_form=14 and d.entry_form=14 and c.pi_wo_batch_no= e.id and e.booking_no = f.booking_no and f.booking_type in (1) and d.po_breakdown_id=g.poid and g.userid=$user_id and c.prod_id=h.id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 $ref_data_cond");


    foreach ($finish_transfer_sql as $val) 
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==2))
        {
            $INT_REF = $intRefClient[$val['PO_BREAKDOWN_ID']];
            $STYLE_REF = $poStyleRef[$val['PO_BREAKDOWN_ID']];
            $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];
            if($prop_arr[$val['ID']] == "")
            {
                /*if($val['TRANSFER_CRITERIA']==2)
                {
                    //if($val['TRANS_TYPE']==6 && $val['FROM_STORE']==$textile_store_id)
                    //{
                    //    $buyerColorDeterGsmDiaArr[$val['UOM']][$val['COLOR_ID']][$deter_str]['TEXT_OUT'] +=$val['QUANTITY'];
                    //}
                    //if($val['TRANS_TYPE']==5 && $val['TO_STORE']==$textile_store_id)
                    //{
                    //    $buyerColorDeterGsmDiaArr[$val['UOM']][$val['COLOR_ID']][$deter_str]['TEXT_IN'] +=$val['QUANTITY'];
                    //}
                }
                else
                {
                    if($val['TRANS_TYPE'] ==5)
                    {
                        //$buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF][$val['COLOR_ID']][$deter_str]['GMTS_IN'] +=$val['QUANTITY'];
                        $buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF]['GMTS_IN'] +=$val['QUANTITY'];
                    }else{
                        //$buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF][$val['COLOR_ID']][$deter_str]['GMTS_OUT'] +=$val['QUANTITY'];
                        $buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF]['GMTS_OUT'] +=$val['QUANTITY'];
                    }
                }*/

                if($val['TRANS_TYPE'] ==5)
                {
                    //$buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF][$val['COLOR_ID']][$deter_str]['GMTS_IN'] +=$val['QUANTITY'];
                    $buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF]['GMTS_IN'] +=$val['QUANTITY'];
                }else{
                    //$buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF][$val['COLOR_ID']][$deter_str]['GMTS_OUT'] +=$val['QUANTITY'];
                    $buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF]['GMTS_OUT'] +=$val['QUANTITY'];
                }

                $prop_arr[$val['ID']] = $val['ID'];
            }
        }
    }


    $ref_data_cond="";
    if($color !=""){
        $ref_data_cond =" and b.color='$color'";
    }
    if($deter_id !=""){
        $ref_data_cond .=" and b.detarmination_id=$deter_id";  
    }
    if($gsm !=""){
        $ref_data_cond .=" and b.gsm=$gsm";  
    }
    if($dia !=""){
        $ref_data_cond .=" and b.dia_width='$dia'";  
    }
    if($UOM !=""){
        $ref_data_cond .=" and b.unit_of_measure='$UOM'";  
    }

    $finish_issue_return = sql_select("SELECT a.po_breakdown_id as PO_BREAKDOWN_ID, a.entry_form as ENTRY_FORM, a.trans_id as TRANS_ID,  a.quantity as QUANTITY, d.fabric_source as FABRIC_SOURCE, d.booking_type as BOOKING_TYPE, f.store_id as STORE_ID, b.color as COLOR_ID, b.detarmination_id as DETER_ID, b.dia_width as DIA, b.gsm as GSM FROM order_wise_pro_details a, inv_transaction f, inv_receive_master g, pro_batch_create_mst c, wo_booking_mst d, tmp_poid e, product_details_master b WHERE a.trans_id = f.id and f.mst_id = g.id and f.pi_wo_batch_no= c.id and c.booking_no = d.booking_no and a.po_breakdown_id= e.poid and e.userid=$user_id and f.prod_id=b.id and a.entry_form =52 and g.entry_form =52  and a.status_active=1 and a.is_deleted=0 and f.status_active=1 and f.is_deleted=0 and d.booking_type in (1) $ref_data_cond");


    foreach ($finish_issue_return as $val) 
    {
        if( ($val['BOOKING_TYPE'] ==1 && $val['FABRIC_SOURCE'] ==2 ))
        {
            $INT_REF = $intRefClient[$val['PO_BREAKDOWN_ID']];
            $STYLE_REF = $poStyleRef[$val['PO_BREAKDOWN_ID']];
            $deter_str = $val['DETER_ID']."*".$val['GSM']."*".$val['DIA'];
            /*if($val['STORE_ID'] ==$textile_store_id)
            {
                //$buyerColorDeterGsmDiaArr[$val['UOM']][$val['COLOR_ID']][$deter_str]['TEXT_ISS_RET']+=$val['QUANTITY'];
            }else{
                //$buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF][$val['COLOR_ID']][$deter_str]['GMTS_ISS_RET']+=$val['QUANTITY'];
                $buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF]['GMTS_ISS_RET']+=$val['QUANTITY'];
            }*/

            $buyerColorDeterGsmDiaArr[$INT_REF][$STYLE_REF]['GMTS_ISS_RET']+=$val['QUANTITY'];
        }
    }

    /*echo "<pre>";
    print_r($buyerColorDeterGsmDiaArr);
    echo "</pre>";*/
    //die;

    $r_id2=execute_query("delete from tmp_poid where userid=$user_id");
    if($r_id2)
    {
        oci_commit($con);
    }

    $cutting_unit_arr = return_library_array("select id,floor_name from lib_prod_floor where production_process=1 and status_active=1 and is_deleted=0", "id", "floor_name"); //company_id=$data and 

    $lib_color = return_library_array("select id,color_name from lib_color where id=$color", "id", "color_name");
    $constructtion_arr=array();
    $sql_deter="select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=$deter_id order by b.id asc";
    $data_array_deter=sql_select($sql_deter);
    foreach( $data_array_deter as $row )
    {
        $constructtion_arr[$row[csf('id')]]=$row[csf('construction')];
        $composition_arr[$row[csf('id')]].=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ";
    }
    unset($data_array_deter);

    $acting_width = $screen_size-350;
    $three_percent = $acting_width*0.03;
    $four_percent = $acting_width*0.04;
    $five_percent = $acting_width*0.05;
    $six_percent = $acting_width*0.06;
    $seven_percent = $acting_width*0.07;
    $eight_percent = $acting_width*0.08;


    ?>    
    <div id="data_panel" align="center"  style="width:<? echo $acting_width;?>px">
        <script>
            function new_window()
            {
                var w = window.open("Surprise", "#");
                var d = w.document.open();
                d.write(document.getElementById('details_reports').innerHTML);
                d.close();
            }
        </script>
    </div>
    <div class="main" style="width: 420px;" id="details_reports">
        <div class="header_part">
            <table class="" cellpadding="0" cellspacing="0"  rules="all" width="<? echo $acting_width;?>">
                <caption style="font-size:18px;"><? echo "<b>Structure : </b>".$constructtion_arr[$deter_id].", <b>Fab Composition :</b>".$composition_arr[$deter_id].", <b>Fabric Color:</b>".$lib_color[$color].", <b>GSM:</b>".$gsm.", <b>Finish Dia:</b>".$dia;?></caption>
            </table>
            <?
            
            ?>
            <table width="<? echo $acting_width;?>" border="1" rules="all"  class="rpt_table" align="left" > 
                <thead>
                    <tr>
                        <th width="<? echo $eight_percent;?>">Ref No</th>
                        <th width="<? echo $eight_percent;?>">Style No</th>
                        <th width="<? echo $seven_percent;?>">Req qty</th>
                        <th width="<? echo $seven_percent;?>">Ex qty</th>
                        <th width="<? echo $seven_percent;?>">Total qty</th>

                        <th width="<? echo $seven_percent;?>">WO Qty</th>
                        <th width="<? echo $seven_percent;?>">WO Bal</th>
                        <th width="<? echo $seven_percent;?>">Receive Qty</th>

                        <th width="<? echo $seven_percent;?>">Rcv Rej Qty</th>
                        <th width="<? echo $seven_percent;?>">Receive Bal</th>
                        <th width="<? echo $seven_percent;?>">Trans in</th>
                        <th width="<? echo $seven_percent;?>">Trans out</th> 

                        <th width="<? echo $seven_percent;?>">Overall bal</th>
                        <th width="<? echo $seven_percent;?>">stock</th>
                   </tr>
                </thead>
            </table>
            <div style="max-height:425px; overflow-y:scroll; width:<? echo $acting_width + 18;?>px;" id="scroll_body">
                <table width="<? echo $acting_width?>" border="1" rules="all"  class="rpt_table">
                    <tbody>
                        <?
                        $i=1;
                        foreach ($buyerColorDeterGsmDiaArr as $INT_REF => $INT_REF_Data) 
                        {
                            foreach ($INT_REF_Data as $Style_Ref => $row) 
                            {
                                $deterArr = explode("*", $deterString);
                                $deter_id = $deterArr[0];
                                $gsm = $deterArr[1];
                                $dia = $deterArr[2];

                                $total_qnty = $row['REQ_QTY'] + $row['SHORT_QTY'];

                                $rcv_from_dyeing = $row['FINISH_QTY'] - $row['FIN_RECV_RETURN'];
                                $rcv_bal = $total_qnty-$rcv_from_dyeing;
                                $reject_qty = $row['REJECT_QTY'];
                                $wo_qty = $row['WO_QTY'];
                                $wo_bal = $total_qnty-$wo_qty;
                                $gmts_in = $row['GMTS_IN'];
                                $gmts_out = $row['GMTS_OUT'];
                                $gmts_fin_issue =$row['GMTS_FIN_ISSUE'];
                                $gmts_iss_ret =$row['GMTS_ISS_RET'];

                                //Formula=[Total Qty -(Receive qty + Transfer In - Transfer Out)]
                                $overall_bal = $total_qnty - ($rcv_from_dyeing + $gmts_in- $gmts_out);

                                //Formula=(Rcv qty+Issue Return qty+Trans In)-(Issue Qty+Receive Return qty+Trans Out)


                                $gmts_stock = ($rcv_from_dyeing + $gmts_iss_ret + $gmts_in) -($gmts_fin_issue + $gmts_out);
                                
                                $bgcolor=($i%2==0)?"#E9F3FF":"#FFFFFF";
                                ?>
                                <tr bgcolor="<? echo $bgcolor; ?>" onclick="change_color('str_<? echo $i; ?>','<? echo $bgcolor; ?>')" id="str_<? echo $i; ?>" style="" valign="middle">

                                    <td align="center" width="<? echo $eight_percent;?>"><? echo $INT_REF;?></td>
                                    <td align="center" width="<? echo $eight_percent;?>"><? echo $Style_Ref;?></td> 

                                    <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($row['REQ_QTY'],9,"");?></td>
                                    <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($row['SHORT_QTY'],9,"");?></td>
                                    <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($total_qnty,9,"");?></td>

                                    <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($wo_qty,9,"");?></td>
                                    <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($wo_bal,9,"");?></td>
                                    <td align="right" width="<? echo $seven_percent;?>" title="<? echo "rcv=".$row['FINISH_QTY'] .",- return=". $row['FIN_RECV_RETURN'];?>"><? echo decimal_format($rcv_from_dyeing,9,"");?></td>
                                    <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($reject_qty,9,"");?></td>
                                    <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($rcv_bal,9,"");?></td>
                                    <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($gmts_in,9,"");?></td>
                                    <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($gmts_out,9,"");?></td> 
                                    <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($overall_bal,9,"");?></td>
                                    <td align="right" width="<? echo $seven_percent;?>" title="<? echo "($rcv_from_dyeing + $gmts_iss_ret + $gmts_in) -($gmts_fin_issue + $gmts_out)";?>"><? echo decimal_format($gmts_stock ,9,"");?></td>
                                </tr>
                                <? 
                                $i++;

                                $sub_req_qnty += $row['REQ_QTY'];
                                $sub_ex_qnty  += $row['SHORT_QTY'];
                                $sub_total_qnty += $total_qnty;
                                $sub_rcv_from_dyeing +=$rcv_from_dyeing;
                                $sub_rcv_bal +=$rcv_bal;
                                $sub_wo_qty += $wo_qty;
                                $sub_wo_bal += $wo_bal;
                                $sub_reject_qty += $reject_qty;
                                $sub_gmts_in += $gmts_in;
                                $sub_gmts_out += $gmts_out;
                                $sub_overall_bal += $overall_bal;
                                $sub_gmts_stock += $gmts_stock;


                                $grand_req_qnty += $row['REQ_QTY'];
                                $grand_ex_qnty  += $row['SHORT_QTY'];
                                $grand_total_qnty += $total_qnty;
                                $grand_rcv_from_dyeing +=$rcv_from_dyeing;
                                $grand_rcv_bal +=$rcv_bal;
                                $grand_wo_qty += $wo_qty;
                                $grand_wo_bal += $wo_bal;
                                $grand_reject_qty += $reject_qty;
                                $grand_gmts_in += $gmts_in;
                                $grand_gmts_out += $gmts_out;
                                $grand_overall_bal += $overall_bal;
                                $grand_gmts_stock += $gmts_stock;
                            }
                            ?>
                            <tr bgcolor="#ccc">
                                <td align="center" width="<? echo $eight_percent+$eight_percent;?>" colspan="2"> Total</td>
                                <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($sub_req_qnty,9,"");?></td>
                                <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($sub_ex_qnty,9,"");?></td>
                                <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($sub_total_qnty,9,"");?></td>
                                <td align="right" width="<? echo $seven_percent;?>" ><? echo decimal_format($sub_wo_qty,9,"");?></td>
                                <td align="right" width="<? echo $seven_percent;?>" ><? echo decimal_format($sub_wo_bal,9,"");?></td>
                                <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($sub_rcv_from_dyeing,9,"");?></td>
                                <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($sub_reject_qty,9,"");?></td>
                                <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($sub_rcv_bal,9,"");?></td>
                                <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($sub_gmts_in,9,"");?></td>
                                <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($sub_gmts_out,9,"");?></td> 
                                <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($sub_overall_bal,9,"");?></td>
                                <td align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($sub_gmts_stock,9,"");?></td>

                            </tr>

                            <?
                            $sub_req_qnty=$sub_ex_qnty= $sub_total_qnty=$sub_rcv_from_dyeing=$sub_rcv_bal=$sub_wo_qty=$sub_wo_bal= $sub_reject_qty=$sub_gmts_in=$sub_gmts_out=$sub_overall_bal=$sub_gmts_stock=0;
                        }
                    
                       ?>
                    </tbody>
                </table>
            </div>
            <table width="<? echo $acting_width?>" border="1" rules="all"  class="rpt_table" align="left">
                <tfoot>
                    <tr>
                        <th width="<? echo $eight_percent;?>">&nbsp;</th>
                        <th width="<? echo $eight_percent;?>">&nbsp;</th>
                        <th align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($grand_req_qnty,9,"");?></th>
                        <th align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($grand_ex_qnty,9,"");?></th>
                        <th align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($grand_total_qnty,9,"");?></th>
                        <th align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($grand_wo_qty,9,"");?></th>
                        <th align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($grand_wo_bal,9,"");?></th>
                        <th align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($grand_rcv_from_dyeing,9,"");?></th>
                        <th align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($grand_reject_qty,9,"");?></th>
                        <th align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($grand_rcv_bal,9,"");?></th>
                        <th align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($grand_gmts_in,9,"");?></th>
                        <th align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($grand_gmts_out,9,"");?></th> 
                        <th align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($grand_overall_bal,9,"");?></th>
                        <th align="right" width="<? echo $seven_percent;?>"><? echo decimal_format($grand_gmts_stock,9,"");?></th>
                    </tr>
                </tfoot>
            </table>
            <?
            ?>
        </div>
    </div>
    <?
}


?>  
