<?
header('Content-type:text/html; charset=utf-8');
session_start();

if ( $_SESSION['logic_erp']['user_id'] == "") header("location:login.php");
include('../../includes/common.php');
$userid=$_SESSION['logic_erp']['user_id'];
$data = $_REQUEST['data'];
$action = $_REQUEST['action'];
$action_from = $_REQUEST['action_from'];
$permission = $_SESSION['page_permission'];

//========== user credential start ========
$user_id=$_SESSION['logic_erp']['user_id'];
$userCredential = sql_select("SELECT unit_id as company_id, store_location_id, item_cate_id, company_location_id as location_id FROM user_passwd where id=$user_id");
$company_id = $userCredential[0][csf('company_id')];
$store_location_id = $userCredential[0][csf('store_location_id')];
$item_cate_id = $userCredential[0][csf('item_cate_id')];
$location_id = $userCredential[0][csf('location_id')];

$company_credential_cond = "";

if ($company_id >0) {
    $company_credential_cond = " and comp.id in($company_id)";
}

if (!empty($store_location_id)) {
    $store_location_credential_cond = " and a.id in($store_location_id)";
}

if ($location_id !='') {
    $location_credential_cond = " and id in($location_id)";
}

if($item_cate_id !='') {
    $item_cate_credential_cond = $item_cate_id ;
}

//$user_lib_name=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

//========== user credential end ==========

$distribiution_method = array(1 => "Distribute Based On Lowest Shipment Date", 2 => "Manually");

/*$sql_deter = "select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
$data_array = sql_select($sql_deter);
foreach ($data_array as $row)
{
	$constructtion_arr[$row[csf('id')]] = $row[csf('construction')];
	$composition_arr[$row[csf('id')]] .= $composition[$row[csf('copmposition_id')]] . " " . $row[csf('percent')] . "% ";
}*/

if ($action=="weight_machine_set_api")
{
		//==============start==========Get Api Link================================================
		$api_data=sql_select("select company_id,user_id,api_link,api_link_2,id from lib_weight_machine_setup where user_id=$user_id and company_id=$data and  status=1 and status_active=1 and is_deleted=0");
	
		$_SESSION["user_machine_api"]=$api_data[0]['API_LINK'];
		$_SESSION["user_machine_api_print"]=$api_data[0]['API_LINK_2'];
   
		//=================end===========Get Api Link================================================
}


if ($action=="load_weight_machine_data")
{

	//$api_data=sql_select("select norsel_weight_api from lib_machine_name where id=$machine_id  and status_active=1 and is_deleted=0");
	$api_data=sql_select("select norsel_weight_api from user_passwd where id=$userid and status_active=1 ");

	$url = "http://".$api_data[0][csf("norsel_weight_api")];		

	//$api=$_SESSION["user_machine_api"];
	//$url = "$api";
	//$url = "http://192.168.10.233";

		
	$curl_handle=curl_init();
	curl_setopt($curl_handle, CURLOPT_URL,"$url");
	curl_setopt($curl_handle, CURLOPT_SSL_VERIFYPEER, false );
	curl_setopt($curl_handle, CURLOPT_RETURNTRANSFER, true);
	curl_setopt($curl_handle, CURLOPT_HEADER, false);
	$postoffice_data = curl_exec($curl_handle);
	curl_close($curl_handle); 
	$postoffice_data = json_decode($postoffice_data);
	echo json_encode($postoffice_data);
	exit;
}



if ($action=="load_room_rack_self_bin")
{
	load_room_rack_self_bin($action_from,$data);
}

if ($action == "load_drop_down_buyer")
{
	$data = explode("_", $data);
	echo create_drop_down("cbo_buyer_name", 152, "select buy.id, buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$data[1]' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) group by buy.id,buy.buyer_name order by buy.buyer_name", "id,buyer_name", 1, "-- Select Buyer --", $selected, "", '');
	exit();
}

if ($action == "load_drop_down_location") 
{
	echo create_drop_down("cbo_location_name", 152, "select id,location_name from lib_location where company_id='$data' $location_credential_cond and status_active =1 and is_deleted=0 order by location_name", "id,location_name", 1, "-- Select Location --", 0, "load_floor();store_load(this.value);");
	exit();
}
//load_room_rack_self_bin('requires/grey_production_entry_controller_v2*13', 'store','store_td', '$data',this.value);
if ($action == "load_drop_down_com_location") 
{

	echo create_drop_down("cbo_com_location_name", 152, "select id,location_name from lib_location where company_id='$data' $location_credential_cond and status_active =1 and is_deleted=0 order by location_name", "id,location_name", 1, "-- Select Location --", 0, "store_load(this.value);");
	exit();
}

if ($action == "load_drop_down_store")
{
	$data_ref=explode("_",$data);
	echo "select a.id, a.store_name from lib_store_location a, lib_store_location_category b where a.id= b.store_location_id and a.company_id='$data_ref[0]' and a.location_id='$data_ref[1]'  $store_location_credential_cond and b.category_type=13 and a.status_active=1 and a.is_deleted=0 group by a.id, a.store_name order by a.store_name";
	//echo create_drop_down("cbo_store_name", 152, "select a.id, a.store_name from lib_store_location a, lib_store_location_category b where a.id= b.store_location_id and a.company_id='$data_ref[0]' and a.location_id='$data_ref[1]'  $store_location_credential_cond and b.category_type=13 and a.status_active=1 and a.is_deleted=0 group by a.id, a.store_name order by a.store_name", "id,store_name", 1, "--Select Store--", 0, "", '');
	exit();
}

if ($action == "load_drop_down_floor")
{
	$data = explode("_", $data);
	$company_id = $data[0];
	$location_id = $data[1];
	if ($location_id == 0 || $location_id == "") $location_cond = ""; else $location_cond = " and b.location_id=$location_id";

		echo create_drop_down("cbo_floor_id", 132, "select a.id, a.floor_name from lib_prod_floor a, lib_machine_name b where a.id=b.floor_id and b.category_id=1 and b.company_id=$company_id and b.status_active=1 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and a.production_process=2 $location_cond group by a.id, a.floor_name order by a.floor_name", "id,floor_name", 1, "-- Select Floor --", 0, "load_machine();", "");//load_drop_down( 'requires/grey_production_entry_controller_v2',document.getElementById('cbo_company_id').value+'_'+this.value, 'load_drop_machine', 'machine_td' );
		exit();
	}

	if ($action == "load_drop_machine")
	{
		$data = explode("_", $data);
		$company_id = $data[0];
		$floor_id = $data[1];
		$machine_id = $data[2];
		$program_no = $data[3];
		if ($floor_id == 0 || $floor_id == "") $floor_cond = ""; else $floor_cond = " and a.id=$floor_id";
		if ($machine_id == 0 || $machine_id == "") $machine_cond = ""; else $machine_cond = " and b.id in ($machine_id)";

		//echo create_drop_down("cbo_machine_name", 132, "select id, machine_no as machine_name from lib_machine_name where category_id=1 and company_id=$company_id and status_active=1 and is_deleted=0 and is_locked=0 and is_subcon =2 $floor_cond $machine_cond order by seq_no", "id,machine_name", 1, "-- Select Machine --", 0, "change_machine(this.value);", "");

		echo create_drop_down("cbo_machine_name", 132, "select b.id, b.machine_no from lib_prod_floor a, lib_machine_name b, ppl_planning_info_machine_dtls c where a.id=b.floor_id and b.category_id=1 and b.company_id=$company_id and b.status_active=1 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and a.production_process=2 $floor_cond $machine_cond and b.id=c.machine_id and c.dtls_id=$program_no group by b.id, b.machine_no order by b.machine_no", "id,machine_no", 1, "-- Select Machine --", 0, "change_machine(this.value);", "");
		exit();
	}

	if ($action == "load_drop_machine_out_bound")
	{
		$data = explode("_", $data);
		$company_id = $data[0];
		$program_no = $data[1];
		
		//echo create_drop_down("cbo_machine_name", 132, "select id, machine_no as machine_name from lib_machine_name where category_id=1 and company_id=$data and status_active=1 and is_deleted=0 and is_locked=0 and is_subcon =1 order by seq_no", "id,machine_name", 1, "-- Select Machine --", 0, "change_machine(this.value);", "");

		echo create_drop_down("cbo_machine_name", 132, "select b.id, b.machine_no from lib_prod_floor a, lib_machine_name b, ppl_planning_info_machine_dtls c where a.id=b.floor_id and b.category_id=1 and b.company_id=$company_id and b.status_active=1 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and a.production_process=2 and b.id=c.machine_id and c.dtls_id=$program_no group by b.id, b.machine_no order by b.machine_no", "id,machine_name", 1, "-- Select Machine --", 0, "change_machine(this.value);", "");
		exit();
	}

	/*if ($action == "load_drop_operator")
	{
		$data = explode("_", $data);
		echo create_drop_down("cbo_operator_name", 132, "select id, first_name from lib_employee where  company_id=$data[0] and floor_id='$data[1]' and status_active=1 and is_deleted=0 order by first_name", "id,first_name", 1, "-- Select Operator --", 0, "", "");
		exit();
	}*/

	if ($action == "load_drop_down_knitting_com")
	{
		$data = explode("_", $data);
		$company_id = $data[1];

	//$company_id
		if ($data[0] == 1) {
			echo create_drop_down("cbo_knitting_company", 152, "select comp.id, comp.company_name from lib_company comp where comp.status_active=1 and comp.is_deleted=0 $company_cond order by comp.company_name", "id,company_name", 1, "--Select Knit Company--", "", "load_location();load_drop_down( 'requires/grey_production_entry_controller_v2', this.value, 'load_drop_down_floor', 'prod_floor_td' );load_drop_down( 'requires/grey_production_entry_controller_v2', this.value, 'load_drop_machine', 'machine_td');", "");
		} else if ($data[0] == 3) {
			echo create_drop_down("cbo_knitting_company", 152, "select a.id,a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type=20 and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id,supplier_name", 1, "--Select Knit Company--", 0, "load_location();");
		} else {
			echo create_drop_down("cbo_knitting_company", 152, $blank_array, "", 1, "--Select Knit Company--", 0, "load_location();");
		}
		exit();
	}

	if ($action == "next_process_check")
	{

		$roll_number_arr = return_library_array("select id,barcode_no  from pro_roll_details where mst_id=$data and entry_form=2 and status_active =1 and is_deleted=0", "id", "barcode_no");

		$next_process_roll_number_arr= return_library_array("select id,barcode_no  from pro_roll_details where barcode_no in (".implode(",",$roll_number_arr).") and entry_form!=2 and status_active =1 and is_deleted=0", "id", "barcode_no");

		if(count($next_process_roll_number_arr)>0) echo 1;
		else echo 0;
		exit();
	}



	if ($action == "issue_num_check")
	{
		$issue_no = return_field_value("issue_number_prefix_num as issue_number_prefix_num", "inv_issue_master", "status_active=1 and is_deleted=0 and entry_form=3 and issue_number_prefix_num=$data", "issue_number_prefix_num");
		echo $issue_no;
		exit();
	}
	
if ($action == "serviceBooking_popup")
{
	echo load_html_head_contents("WO Info", "../../", 1, 1, '', '', '');
	extract($_REQUEST);
	//if($recieve_basis==1) $width=1045; else $width=1055;
	$width = 1055;
	//echo $cbo_knitting_source;
	?>
	<script>

		function js_set_value(id, booking_no, type_id, knit_company) {
			$('#service_hidden_booking_id').val(id);
			$('#service_hidden_booking_no').val(booking_no);
			$('#service_booking_without_order').val(type_id);

			$('#hidden_knitting_company').val(knit_company);
			parent.emailwindow.hide();
		}
	</script>
	</head>
	<body>
		<div align="center" style="width:1030px;">
			<form name="searchwofrm" id="searchwofrm">
				<fieldset style="width:1030px; margin-left:3px">
					<legend>Enter search words</legend>
					<table cellpadding="0" cellspacing="0" border="1" rules="all" width="720" class="rpt_table">
						<thead>
							<th>Search By</th>
							<th width="240">Enter WO/PI/Production No</th>
							<th>
								<input type="reset" name="reset" id="reset" value="Reset" style="width:100px"
								class="formbutton"/>
								<input type="hidden" name="txt_company_id" id="txt_company_id" class="text_boxes"
								value="<? echo $cbo_company_id; ?>">
								<input type="hidden" name="service_hidden_booking_id" id="service_hidden_booking_id"
								class="text_boxes" value="">
								<input type="hidden" name="service_hidden_booking_no" id="service_hidden_booking_no"
								class="text_boxes" value="">
								<input type="hidden" name="service_booking_without_order" id="service_booking_without_order"
								class="text_boxes" value="">

								<input type="hidden" name="hidden_knitting_company" id="hidden_knitting_company"
								class="text_boxes" value="">
							</th>
						</thead>
						<tr>
							<td align="center">
								<?
								if($cbo_knitting_source == 1){
									$receive_basis_arr = array(0 => "Independent", 1 => "Fabric Booking", 2 => "Knitting Plan", 4 => "Sales Order");
								}else{
									$receive_basis_arr = array(0 => "Service Booking");
								}
								echo create_drop_down("cbo_receive_basis", 152, $receive_basis_arr, "", 1, "-- Select --", $recieve_basis, "", "1", "");
								?>
							</td>
							<td align="center" id="search_by_td">
								<input type="text" style="width:130px" class="text_boxes" name="txt_search_common"
								id="txt_search_common"/>
							</td>
							<td align="center">
								<input type="button" name="button2" class="formbutton" value="Show"	onClick="show_list_view ( document.getElementById('txt_search_common').value +'_'+document.getElementById('cbo_receive_basis').value +'_'+ document.getElementById('txt_company_id').value+'_'+'<? echo $cbo_knitting_source; ?>'+'_'+'<? echo $cbo_knitting_company; ?>'+'_'+'<? echo $txt_booking_no_id; ?>'+'_'+'<? echo $recieve_basis; ?>'+'_'+'<? echo $is_service_booking_mandatory; ?>', 'create_wo_no_production_search_list_view', 'search_div', 'grey_production_entry_controller_v2', 'setFilterGrid(\'tbl_list_search\',-1);')"
								style="width:100px;"/>
							</td>
						</tr>
					</table>
					<div style="margin-top:10px;" id="search_div" align="left"></div>
				</fieldset>
			</form>
		</div>
	</body>
	<script src="../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
}
if ($action == "create_wo_no_production_search_list_view") 
{
	$data = explode("_", $data);
	$company_arr = return_library_array("select id, company_name from lib_company", "id", "company_name");
	$supplier_arr = return_library_array("select id, supplier_name from lib_supplier", "id", "supplier_name");

	$search_string = "%" . trim($data[0]) . "%";
	$recieve_basis = $data[1];
	$company_id = $data[2];
	$knitting_source = $data[3];
	$knitting_company = $data[4];
	$booking_program_no = $data[5];
	$main_rcv_basis = $data[6];
	$is_service_booking_mandatory = $data[7];

	if($knitting_source==1)
	{
		$paymodeCondition = "and a.pay_mode in(3,5)";
		$paymodeWoNonordCondition = "and s.pay_mode in(3,5)";
	}else {
		$paymodeCondition = "and a.pay_mode not in(3,5)";
		$paymodeWoNonordCondition = "and s.pay_mode not in(3,5)";
	}

	//echo $program_cond ."  $recieve_basis and c.program_no= $booking_program_no";die;
	if($main_rcv_basis ==2 && $knitting_source ==3 && $is_service_booking_mandatory ==1){
		$program_cond =" and c.program_no like '%$booking_program_no%'";
	}

	$buyer_short_arr = return_library_array("select id, short_name from lib_buyer", "id", "short_name");
	$po_arr = array();
	$po_data = sql_select("select b.id, b.po_number, b.pub_shipment_date, b.po_quantity, b.grouping, b.file_no, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst");
	foreach ($po_data as $row) {
		$po_arr[$row[csf('id')]] = $row[csf('po_number')] . "**" . $row[csf('pub_shipment_date')] . "**" . $row[csf('po_quantity')] . "**" . $row[csf('po_qnty_in_pcs')] . "**" . $row[csf('grouping')] . "**" . $row[csf('file_no')];
	}

	if (trim($data[0]) != "") {
		//$search_field_cond="and a.booking_no like '$search_string'";
		$search_field_cond = "and a.booking_no like '$search_string'";
		$search_field_cond_sample = "and s.booking_no like '$search_string'";
	} else {
		$search_field_cond = "";
	}

	if ($knitting_company != 0) $supplier_con = "and a.supplier_id=$knitting_company"; else $supplier_con = "";

	$sql="SELECT a.id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.supplier_id, a.po_break_down_id, a.item_category, a.delivery_date, a.job_no as job_no_mst, c.program_no, 0 as type_id from wo_booking_dtls c,wo_booking_mst a, wo_po_break_down b 
	where c.booking_no=a.booking_no and c.job_no=b.job_no_mst and a.company_id=$company_id and a.item_category=12 and a.booking_type=3 and c.process=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $search_field_cond $supplier_con $paymodeCondition $program_cond 
	group by a.id, a.booking_no_prefix_num, a.booking_no, a.booking_date, a.buyer_id, a.po_break_down_id, a.item_category, a.delivery_date, a.job_no, a.supplier_id, c.program_no
	UNION ALL
	SELECT s.id, s.prefix_num as booking_no_prefix_num, s.booking_no, s.booking_date, s.buyer_id, s.supplier_id, null as po_break_down_id, s.item_category, null as delivery_date, null as job_no_mst, null as program_no, 1 as type_id 
	from wo_non_ord_knitdye_booking_mst s, wo_non_ord_knitdye_booking_dtl b 
	where s.booking_no=b.booking_no and s.company_id=$company_id and s.item_category in(1,0)  and b.process_id=1 and s.status_active=1 and s.is_deleted=0 $paymodeWoNonordCondition $search_field_cond_sample
	group by s.id, s.prefix_num, s.booking_no, s.booking_date, s.buyer_id, s.supplier_id, s.item_category order by type_id, id";

	//echo $sql;
	$result = sql_select($sql);
	?>
	<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1010" class="rpt_table">
		<thead>
			<tr>
				<th colspan="13">
				<? echo create_drop_down( "cbo_string_search_type", 150, $string_search_type,'', 1, "-- Searching Type --",4 ); ?>
				</th>
			</tr>
			<tr>
				<th width="30">SL</th>
				<th width="105">Booking No</th>
				<th width="100">Program No</th>
				<th width="75">Booking Date</th>
				<th width="60">Buyer</th>
				<th width="87">Item Category</th>
				<th width="75">Delivary date</th>
				<th width="80">Job No</th>
				<th width="80">Order Qnty</th>
				<th width="75">Shipment Date</th>
				<th width="100">Internal Ref.</th>
				<th width="90">File No</th>
				<th>Order No</th>
			</tr>
		</thead>
	</table>
	<div style="width:1028px; max-height:280px; overflow-y:scroll" id="list_container_batch" align="left">
		<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1010" class="rpt_table"
		id="tbl_list_search">
		<?
		$i = 1;
		foreach ($result as $row) 
		{
			if ($i % 2 == 0)
				$bgcolor = "#E9F3FF";
			else
				$bgcolor = "#FFFFFF";

			$po_qnty_in_pcs = '';
			$po_no = '';
			$min_shipment_date = '';
			$internal_ref = '';
			$file_no = '';

			$po_id = explode(",", $row[csf('po_break_down_id')]);
			foreach ($po_id as $id) 
			{
				$po_data = explode("**", $po_arr[$id]);
				$po_number = $po_data[0];
				$pub_shipment_date = $po_data[1];
				$po_qnty = $po_data[2];
				$poQntyPcs = $po_data[3];
				$internalRef = $po_data[4];
				$fileNo = $po_data[5];

				if ($po_no == "") $po_no = $po_number; else $po_no .= "," . $po_number;
				if ($internal_ref == '') $internal_ref = $internalRef; else $internal_ref .= "," . $internalRef;
				if ($file_no == '') $file_no = $fileNo; else $file_no .= "," . $fileNo;

				if ($min_shipment_date == '') {
					$min_shipment_date = $pub_shipment_date;
				} else {
					if ($pub_shipment_date < $min_shipment_date) $min_shipment_date = $pub_shipment_date; else $min_shipment_date = $min_shipment_date;
				}

				$po_qnty_in_pcs += $poQntyPcs;
			}

			$internal_ref = implode(",", array_unique(explode(",", $internal_ref)));
			$file_no = implode(",", array_unique(explode(",", $file_no)));
			?>
			<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
				onClick="js_set_value(<? echo $row[csf('id')]; ?>,'<? echo $row[csf('booking_no')]; ?>',<? echo $row[csf('type_id')]; ?>,'<? echo $row[csf('supplier_id')]; ?>');">
				<td width="30"><? echo $i; ?></td>
				<td width="105"><p><? echo $row[csf('booking_no')]; ?></p></td>
				<td width="100"><p><? echo $row[csf('program_no')]; ?></p></td>
				<td width="75" align="center"><? echo change_date_format($row[csf('booking_date')]); ?>&nbsp;</td>
				<td width="60"><p><? echo $buyer_short_arr[$row[csf('buyer_id')]]; ?>&nbsp;</p></td>
				<?
				if ($row[csf('type')] == 0) {
					$category_name = $item_category[$row[csf('item_category')]];
				} else {
					$category_name = $conversion_cost_head_array[$row[csf('item_category')]];
				}
				?>
				<td width="87"><p><? echo $category_name; ?></p></td>
				<td width="75" align="center"><? echo change_date_format($row[csf('delivery_date')]); ?>&nbsp;</td>
				<td width="80"><p><? echo $row[csf('job_no_mst')]; ?>&nbsp;</p></td>
				<td width="80" align="right"><? echo $po_qnty_in_pcs; ?>&nbsp;</td>
				<td width="75" align="center"><? echo change_date_format($min_shipment_date); ?>&nbsp;</td>
				<td width="100"><p><? echo $internal_ref; ?>&nbsp;</p></td>
				<td width="90"><p><? echo $file_no; ?>&nbsp;</p></td>
				<td><p><? echo $po_no; ?>&nbsp;</p></td>
			</tr>
			<?
			$i++;
		}
		?>
		</table>
	</div>
	<?
}

if ($action == "fabricBooking_popup") {
	echo load_html_head_contents("WO Info", "../../", 1, 1, '', '', '');
	extract($_REQUEST);
	//if($recieve_basis==1) $width=1045; else $width=1055;
	$width = 1055;
	?>
	<script src="../../includes/functions_bottom.js" type="text/javascript"></script>
	<script>
		<?
		if(isset($_SESSION['logic_erp']['data_arr'][98]))
		{
			$data_arr = json_encode($_SESSION['logic_erp']['data_arr'][98]);
			echo "var field_level_data= " . $data_arr . ";\n";
		}
		?>
		window.onload = function () {
			set_field_level_access( <? echo $cbo_company_id; ?> );
		}
		
		function js_set_value(id, booking_no, type, salesData, entry_form) {
			$('#hidden_booking_id').val(id);
			$('#hidden_booking_no').val(booking_no);
			$('#booking_without_order').val(type);
			$('#salesData').val(salesData);
			$('#entry_form').val(entry_form);
			parent.emailwindow.hide();
		}

		function fnc_disable(str) {
			$("#cbo_buyer_name").val(0);
			if (str == 1) {
				$('#cbo_buyer_name').attr('disabled', 'disabled');
				$('#cbo_booking_type').val(1).attr('disabled', 'disabled');
			}
			else {
				$('#cbo_buyer_name').removeAttr('disabled', 'disabled');
				$('#cbo_booking_type').val(1).removeAttr('disabled', 'disabled');
			}
		}
	</script>
</head>
<body>
	<div align="center" style="width:<? echo $width; ?>px;">
		<form name="searchwofrm" id="searchwofrm" autocomplete=off>
			<fieldset style="width:<? echo $width - 5; ?>px; margin-left:2px">
				<legend>Enter search words</legend>
				<table cellpadding="0" cellspacing="0" border="1" rules="all" width="850" class="rpt_table">
					<thead>
						<?
						if ($recieve_basis == 2)
						{
							$year_style = 'style="display:none"';
							echo '<th>Sales Order</th>';
							echo '<th>Booking Type</th>';
						}
						?>
						<th <? echo $year_style; ?>>Year</th>
						<th>Buyer</th>
						<th>Search By</th>
						<th id="search_by_td_up"
						width="200"><? if ($recieve_basis == 1) echo "Enter Booking No"; else if ($recieve_basis == 4) echo "Enter Sales Order No"; else echo "Enter Program No"; ?></th>
						<th>
							<input type="reset" name="reset" id="reset" value="Reset" style="width:100px"
							class="formbutton"/>
							<input type="hidden" name="txt_company_id" id="txt_company_id" class="text_boxes"
							value="<? echo $cbo_company_id; ?>">
							<input type="hidden" name="hidden_booking_id" id="hidden_booking_id" class="text_boxes"
							value="">
							<input type="hidden" name="hidden_booking_no" id="hidden_booking_no" class="text_boxes"
							value="">
							<input type="hidden" name="booking_without_order" id="booking_without_order" class="text_boxes"
							value="">
							<input type="hidden" name="salesData" id="salesData" class="text_boxes" value="">
							<input type="hidden" name="entry_form" id="entry_form" class="text_boxes" value="">
						</th>
					</thead>
					<tr>
						<?
						$bookingTypeArr=array(0=>'-- All --', 1=>'With', 2=>'Without');
						if ($recieve_basis != 2)
						{
							$style = 'style="display:none"';
						}
						echo '<td align="center" ' . $style . '>' . create_drop_down("cbo_sales_order", 100, $yes_no, "", 0, "-- Select --", 2, "fnc_disable(this.value);", '', '') . '</td>';
						echo '<td align="center" ' . $style . '>' . create_drop_down("cbo_booking_type", 100, $bookingTypeArr, '', 0, '', 1, '', '', '') . '</td>';
						?>
						<td align="center" <? echo $year_style; ?>>
							<?
							echo create_drop_down( "cbo_year", 60, create_year_array(),"", 1,"-- All --", date("Y",time()), "",0,"" );
							?>
						</td>
						<td align="center">
							<?
							if ($recieve_basis == 1) {
								$search_by_arr = array(1 => "Booking No", 2 => "Buyer Order", 3 => "Job No", 4 => "Booking Date", 5 => "Internal Ref", 6 => "File No");
								$dd = "change_search_event(this.value, '0*0*0*3*0*0', '0*0*0*2*0*0', '../../') ";
								$selected = 1;
								$disable = 0;
							} else if ($recieve_basis == 4) {
								$search_by_arr = array(1 => "Sales Order No", 2 => "Sales / Booking No", 3 => "Style Ref.");
								$dd = "change_search_event(this.value, '0*0*0*3*0*0', '0*0*0*2*0*0', '../../') ";
								$selected = 1;
								$disable = 1;
							} else {
								$search_by_arr = array(1 => "Booking No", 2 => "Buyer Order", 3 => "Job No", 4 => "Fabric Desc.", 5 => "Program No", 6 => "Internal Ref", 7 => "File No");
								$dd = "change_search_event(this.value, '0*0*0*0*0*0*0', '0*0*0*0*0*0*0', '../../') ";
								$selected = 5;
								$disable = 0;
							}

							echo create_drop_down("cbo_buyer_name", 170, "select buy.id, buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$cbo_company_id' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buy.buyer_name", "id,buyer_name", 1, "-- All Buyer --", '', "", $disable);
							?>
						</td>
						<td align="center">
							<? echo create_drop_down("cbo_search_by", 150, $search_by_arr, "", 0, "--Select--", $selected, $dd, 0); ?>
						</td>
						<td align="center" id="search_by_td">
							<input type="text" style="width:130px" class="text_boxes" name="txt_search_common"
							id="txt_search_common"/>
						</td>
						<td align="center">
							<input type="button" name="button2" class="formbutton" value="Show"
							onClick="show_list_view ( document.getElementById('txt_search_common').value+'_'+document.getElementById('cbo_search_by').value+'_'+document.getElementById('txt_company_id').value+'_'+document.getElementById('cbo_buyer_name').value+'_<? echo $recieve_basis; ?>_'+document.getElementById('cbo_sales_order').value+'_'+document.getElementById('cbo_year').value+'_'+document.getElementById('cbo_booking_type').value, 'create_booking_search_list_view', 'search_div', 'grey_production_entry_controller_v2', 'setFilterGrid(\'tbl_list_search\',-1);')"
							style="width:100px;"/>
						</td>
					</tr>
				</table>
				<div style="margin-top:10px;" id="search_div" align="left"></div>
			</fieldset>
		</form>
	</div>
</body>
</html>
<?
}

/*
|--------------------------------------------------------------------------
| create_booking_search_list_view
|--------------------------------------------------------------------------
|
*/
if ($action == "create_booking_search_list_view")
{
	$data = explode("_", $data);
	$search_string = "%" . trim($data[0]) . "%";
	$search_by = $data[1];
	$company_id = $data[2];
	$buyer_id = $data[3];
	$recieve_basis = $data[4];
	$sales_order = $data[5];
	$booking_year = $data[6];
	$bookingType = $data[7];

	$buyer_arr = return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');

	if ($buyer_id == 0) $buyer_id = "%%";

	if ($recieve_basis == 1)
	{
		if (trim($data[0]) != "") {
			if ($search_by == 1) {
				$search_field_cond = "and a.booking_no like '$search_string'";
				$search_field_cond_sample = "and s.booking_no_prefix_num='".trim($data[0])."'";
			} else if ($search_by == 2) {
				$search_field_cond = "and b.po_number like '$search_string'";
				$search_field_cond_sample = "";
			} else if ($search_by == 3) {
				$search_field_cond = "and b.job_no_mst like '$search_string'";
				$search_field_cond_sample = "";
			} else if ($search_by == 5) {
				$search_field_cond = "and b.grouping like '$search_string'";
				$search_field_cond_sample = "";
			} else if ($search_by == 6) {
				$search_field_cond = "and b.file_no like '$search_string'";
				$search_field_cond_sample = "";
			} else {
				if ($db_type == 0) {
					$search_field_cond = "and a.booking_date like '" . change_date_format(trim($data[0]), "yyyy-mm-dd", "-") . "'";
					$search_field_cond_sample = "and s.booking_date like '" . change_date_format(trim($data[0]), "yyyy-mm-dd", "-") . "'";
				} else {
					$search_field_cond = "and a.booking_date like '" . change_date_format(trim($data[0]), '', '', 1) . "'";
					$search_field_cond_sample = "and s.booking_date like '" . change_date_format(trim($data[0]), '', '', 1) . "'";
				}
			}
		} else {
			$search_field_cond = "";
			$search_field_cond_sample = "";
		}
		$po_arr = array();
		$po_data = sql_select("select b.id, b.po_number, b.pub_shipment_date, b.grouping, b.file_no, b.po_quantity, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
		foreach ($po_data as $row) {
			$po_arr[$row[csf('id')]] = $row[csf('po_number')] . "**" . $row[csf('pub_shipment_date')] . "**" . $row[csf('po_quantity')] . "**" . $row[csf('po_qnty_in_pcs')] . "**" . $row[csf('grouping')] . "**" . $row[csf('file_no')];
		}
		$year_cond = "";
		$year_cond_non_order = "";
		$booking_year_condition="";
		$booking_year_non_order_condition="";
	
		if ($db_type == 0)
		{
			$year_cond = "YEAR(a.insert_date) as year";
			$year_cond_non_order = "YEAR(s.insert_date) as year";
			if($booking_year>0)
			{
				$booking_year_condition=" and YEAR(a.insert_date)=$booking_year";
				$booking_year_non_order_condition=" and YEAR(s.insert_date)=$booking_year";
			}
		}
		else if ($db_type == 2)
		{
			$year_cond = "to_char(a.insert_date,'YYYY') as year";
			$year_cond_non_order = "to_char(s.insert_date,'YYYY') as year";
			if($booking_year>0)
			{
				$booking_year_condition=" and to_char(a.insert_date,'YYYY')=$booking_year";
				$booking_year_non_order_condition=" and to_char(s.insert_date,'YYYY')=$booking_year";
			}
		}
	
	
		// check variable settings if allocation is available or not
		$variable_set_allocation = return_field_value("allocation", "variable_settings_inventory", "company_name=$company_id and variable_list=18 and item_category_id = 1");
		$booking_type_cond = ($variable_set_allocation==1)?" and a.booking_type not in(1,4)":"";
		if (trim($data[0]) != "" && ($search_by == 2 || $search_by == 3 || $search_by == 5 || $search_by == 6)) {
			$sql = "select a.id, a.booking_no,a.booking_no_prefix_num, a.booking_date, a.buyer_id,a.entry_form,c.po_break_down_id, a.item_category, a.delivery_date, c.job_no as job_no_mst, 0 as type,a.booking_type, a.is_short, $year_cond from wo_booking_mst a,wo_booking_dtls c, wo_po_break_down b where a.booking_no=c.booking_no and c.po_break_down_id=b.id and a.company_id=$company_id and a.buyer_id like '$buyer_id' and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 $booking_type_cond $search_field_cond $booking_year_condition group by a.id,a.booking_no, a.booking_date, a.buyer_id,a.entry_form,c.po_break_down_id,a.item_category, a.delivery_date, c.job_no,a.insert_date,a.booking_no_prefix_num, a.booking_type,a.is_short order by a.id";
		} else {
			$sql = "select a.id, a.booking_no,a.booking_no_prefix_num, a.booking_date, a.buyer_id,a.entry_form,c.po_break_down_id, a.item_category, a.delivery_date, c.job_no as job_no_mst, 0 as type,a.booking_type, a.is_short, $year_cond from wo_booking_mst a,wo_booking_dtls c, wo_po_break_down b where a.booking_no=c.booking_no and c.po_break_down_id=b.id and a.company_id=$company_id and a.buyer_id like '$buyer_id' and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 $booking_type_cond $search_field_cond $booking_year_condition group by a.id,a.booking_no, a.booking_date, a.buyer_id,a.entry_form,c.po_break_down_id,a.item_category, a.delivery_date, c.job_no,a.insert_date,a.booking_no_prefix_num,a.booking_type, a.is_short
			union all
			SELECT s.id, s.booking_no,s.booking_no_prefix_num, s.booking_date, s.buyer_id,s.entry_form_id as entry_form, null as po_break_down_id, s.item_category, s.delivery_date, null as job_no_mst, 1 as type, 0 as booking_type, 0 as is_short, $year_cond_non_order
			FROM wo_non_ord_samp_booking_mst s, wo_non_ord_samp_booking_dtls t
			WHERE s.booking_no=t.booking_no and s.company_id=$company_id and s.buyer_id like '$buyer_id' and s.status_active =1 and s.is_deleted=0 and t.status_active=1 and t.is_deleted=0 and s.item_category=2 and (s.fabric_source=1 OR t.fabric_source=1) $search_field_cond_sample $booking_year_non_order_condition
			group by s.id, s.booking_no, s.booking_no_prefix_num, s.booking_date, s.buyer_id,s.entry_form_id, s.item_category, s.delivery_date, s.insert_date
			order by id,type desc";
		}
		//echo $sql;
		$result = sql_select($sql);
		$po_id_arr = $booking_arr = array();
		$job_ids = "";
		foreach ($result  as $value) {
			$po_id_arr[$value[csf("booking_no")]] .= $value[csf("po_break_down_id")] . ",";
			$booking_arr[$value[csf("booking_no")]] = $value[csf("id")] . "**" . $value[csf("booking_no")] . "**" . $value[csf("booking_no_prefix_num")] . "**" . $value[csf("booking_date")] . "**" . $value[csf("buyer_id")] . "**" . $value[csf("item_category")] . "**" . $value[csf("delivery_date")] . "**" . $value[csf("job_no_mst")] . "**" . $value[csf("type")] . "**" . $value[csf("booking_type")] . "**" . $value[csf("is_short")] . "**" . $value[csf("year")]. "**" . $value[csf("entry_form")];
		}
		?>
		<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1030" class="rpt_table">
			<thead>
				<th width="30">SL</th>
				<th width="60">Booking No</th>
				<th width="70">Type</th>
				<th width="50">Year</th>
				<th width="75">Booking Date</th>
				<th width="60">Buyer</th>
				<th width="88">Item Category</th>
				<th width="75">Delivary date</th>
				<th width="80">Job No</th>
				<th width="70">Order Qnty</th>
				<th width="75">Shipment Date</th>
				<th width="130">Order No</th>
				<th width="70">Internal Ref</th>
				<th>File No</th>
			</thead>
		</table>
		<div style="width:1050px; max-height:280px; overflow-y:scroll" id="list_container_batch" align="left">
			<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1030" class="rpt_table"
			id="tbl_list_search">
			<?
			$i = 1;
			foreach ($booking_arr as $row) {
				$data = explode("**",$row);
				if ($i % 2 == 0)
					$bgcolor = "#E9F3FF";
				else
					$bgcolor = "#FFFFFF";
	
				$booking_type = '';
				if ($data[9] == 0) {
					$booking_type = 'Sample Without Order';
				} else if ($data[9] == 4) {
					$booking_type = 'Sample';
				} else {
					if ($data[10] == 1) $booking_type = 'Short'; else $booking_type = 'Main';
				}
	
				$po_qnty_in_pcs = '';
				$po_no = '';
				$min_shipment_date = '';
				$internal_ref = '';
				$file_nos = '';
				if ($data[1] != "" && $data[8] == 0) {
					$po_id = explode(",", rtrim($po_id_arr[$data[1]],","));
					foreach ($po_id as $id) {
						$po_data = explode("**", $po_arr[$id]);
						$po_number = $po_data[0];
						$pub_shipment_date = $po_data[1];
						$po_qnty = $po_data[2];
						$poQntyPcs = $po_data[3];
						$grouping = $po_data[4];
						$file_no = $po_data[5];
	
						if ($po_no == "") $po_no = $po_number; else $po_no .= "," . $po_number;
						if ($grouping != "") {
							if ($internal_ref == "") $internal_ref = $grouping; else $internal_ref .= "," . $grouping;
						}
						if ($file_no != "") {
							if ($file_nos == "") $file_nos = $file_no; else $file_nos .= "," . $file_no;
						}
	
						if ($min_shipment_date == '') {
							$min_shipment_date = $pub_shipment_date;
						} else {
							if ($pub_shipment_date < $min_shipment_date) $min_shipment_date = $pub_shipment_date; else $min_shipment_date = $min_shipment_date;
						}
	
						$po_qnty_in_pcs += $poQntyPcs;
					}
				}
	
				$internal_ref = implode(",", array_unique(explode(",", $internal_ref)));
				$file_nos = implode(",", array_unique(explode(",", $file_nos)));
				?>
				<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
					onClick="js_set_value(<? echo $data[0]; ?>,'<? echo $data[1]; ?>','<? echo $data[8]; ?>','','<? echo $data[12]; ?>');">
					<td width="30"><? echo $i; ?></td>
					<td width="60" align="left"><p><? echo $data[2]; ?></p>
					</td>
					<td width="70" align="center"><p><? echo $booking_type; ?></p></td>
					<td width="50" align="center"><p><? echo $data[11]; ?></p></td>
					<td width="75" align="center"><? echo change_date_format($data[3]); ?></td>
					<td width="60"><p><? echo $buyer_arr[$data[4]]; ?></p></td>
					<td width="88"><p><? echo $item_category[$data[5]]; ?></p></td>
					<td width="75" align="center"><? echo change_date_format($data[6]); ?></td>
					<td width="80"><p><? echo $data[7]; ?></p></td>
					<td width="70" align="right"><? echo $po_qnty_in_pcs; ?></td>
					<td width="75" align="center"><? echo change_date_format($min_shipment_date); ?></td>
					<td width="130"><p><? echo $po_no; ?></p></td>
					<td width="70"><p><? echo $internal_ref; ?></p></td>
					<td><p><? echo $file_nos; ?></p></td>
				</tr>
				<?
				$i++;
			}
			?>
		</table>
	</div>
	<?
	}
	else if ($recieve_basis == 4)
	{
		$company_arr = return_library_array("select id,company_short_name from lib_company", 'id', 'company_short_name');
		$location_arr = return_library_array("select id, location_name from lib_location", 'id', 'location_name');
	
		$search_field_cond = "";
		if (trim($data[0]) != "") {
			if ($search_by == 1) {
				$search_field_cond = "and job_no like '$search_string'";
			} else if ($search_by == 2) {
				$search_field_cond = "and sales_booking_no like '$search_string'";
			} else {
				$search_field_cond = "and style_ref_no like '$search_string'";
			}
		}
	
		$year_field = ""; $year_cond="";
		if ($db_type == 0)
		{
			$year_field = "YEAR(insert_date) as year";
			if($booking_year>0)
			{
				$year_cond=" and YEAR(booking_date)=$booking_year";
			}
		}
		else if ($db_type == 2)
		{
			$year_field = "to_char(insert_date,'YYYY') as year";
			if($booking_year>0)
			{
				$year_cond=" and to_char(booking_date,'YYYY')=$booking_year";
			}
		}
	
		$sql = "select id, $year_field, job_no_prefix_num, job_no, within_group, sales_booking_no, booking_date, delivery_date, buyer_id, style_ref_no, location_id from fabric_sales_order_mst where status_active=1 and is_deleted=0 and company_id=$company_id $search_field_cond $year_cond and fso_status=1 order by id";
			//echo $sql;
		$result = sql_select($sql);
		?>
		<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1040" class="rpt_table">
			<thead>
				<th width="40">SL</th>
				<th width="130">Sales Order No.</th>
				<th width="80">Within Group</th>
				<th width="140">Buyer</th>
				<th width="150">Sales/ Booking No</th>
				<th width="90">Booking date</th>
				<th width="90">Delivery date</th>
				<th width="140">Style Ref.</th>
				<th>Location</th>
			</thead>
		</table>
		<div style="width:1040px; max-height:280px; overflow-y:scroll" id="list_container_batch" align="left">
			<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1020" class="rpt_table"
			id="tbl_list_search">
				<?
				$i = 1;
				foreach ($result as $row) {
					if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
		
					if ($row[csf('within_group')] == 1)
						$buyer = $company_arr[$row[csf('buyer_id')]];
					else
						$buyer = $buyer_arr[$row[csf('buyer_id')]];
		
					$salesData = $row[csf('within_group')] . "**" . $row[csf('buyer_id')] . "**" . $buyer;
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
						onClick="js_set_value(<? echo $row[csf('id')]; ?>,'<? echo $row[csf('job_no')]; ?>','1','<? echo $salesData; ?>','');">
						<td width="40"><? echo $i; ?></td>
						<td width="130"><p>&nbsp;<? echo $row[csf('job_no')]; ?></p></td>
						<td width="80"><p><? echo $yes_no[$row[csf('within_group')]]; ?>&nbsp;</p></td>
						<td width="140"><p><? echo $buyer; ?>&nbsp;</p></td>
						<td width="150"><p><? echo $row[csf('sales_booking_no')]; ?></p></td>
						<td width="90" align="center"><? echo change_date_format($row[csf('booking_date')]); ?></td>
						<td width="90" align="center"><? echo change_date_format($row[csf('delivery_date')]); ?></td>
						<td width="140"><p><? echo $row[csf('style_ref_no')]; ?></p></td>
						<td><p><? echo $location_arr[$row[csf('location_id')]]; ?></p></td>
					</tr>
					<?
					$i++;
				}
				?>
			</table>
		</div>
		<?
	}
	else
	{
		$body_part_type_arr = return_library_array("select id, body_part_type from lib_body_part", 'id', 'body_part_type');
		if ($sales_order == 1)
		{
			$company_arr = return_library_array("select id, company_short_name from lib_company", 'id', 'company_short_name');
			$rqsn_array = array();
			if ($db_type == 0) {
				$reqsn_dataArray = sql_select("select a.knit_id, a.requisition_no, group_concat(distinct(yarn_count_id)) as yarn_count_id,
					group_concat(distinct(brand)) as brand,
					group_concat(distinct(lot)) as lot , group_concat(distinct(b.id)) as yarn_prod_id from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.status_active=1 and a.is_deleted=0 group by a.knit_id, a.requisition_no");
			} else {
				$reqsn_dataArray = sql_select("select a.knit_id, a.requisition_no,
					LISTAGG(CAST(brand AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY brand) as brand,
					LISTAGG(CAST(yarn_count_id AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY yarn_count_id) as yarn_count_id,
					LISTAGG(CAST(lot AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY lot) as lot, LISTAGG(b.id, ',') WITHIN GROUP (ORDER BY b.id) as yarn_prod_id from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.status_active=1 and a.is_deleted=0 group by a.knit_id, a.requisition_no");
			}
			foreach ($reqsn_dataArray as $row) {
				$rqsn_array[$row[csf('knit_id')]]['rqsn_no'] = $row[csf('requisition_no')];
				$rqsn_array[$row[csf('knit_id')]]['count'] = $row[csf('yarn_count_id')];
				$rqsn_array[$row[csf('knit_id')]]['lot'] = $row[csf('lot')];
				$rqsn_array[$row[csf('knit_id')]]['brand'] = $row[csf('brand')];
				$rqsn_array[$row[csf('knit_id')]]['yarn_prod_id'] = $row[csf('yarn_prod_id')];
			}
	
			if ($db_type == 0) {
				$plan_details_array = return_library_array("select dtls_id, group_concat(distinct(po_id)) as po_id from ppl_planning_entry_plan_dtls where company_id=$company_id and is_sales=1 group by dtls_id", "dtls_id", "po_id");
			} else {
				$plan_details_array = return_library_array("select dtls_id, LISTAGG(po_id, ',') WITHIN GROUP (ORDER BY po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company_id and is_sales=1 group by dtls_id", "dtls_id", "po_id");
			}
	
			if (trim($data[0]) != "") {
				if ($search_by == 1) {
					$search_field_cond = "and a.booking_no like '$search_string'";
				} else if ($search_by == 3) {
					$search_field_cond = "and d.job_no like '$search_string'";
				} else if ($search_by == 4) {
					$search_field_cond = "and a.fabric_desc like '$search_string'";
				} else {
					$search_field_cond = "and b.id='" . trim($data[0]) . "'";
				}
			} else {
				$search_field_cond = "";
			}
			
			if($recieve_basis == 2 )
			{
				$is_plan_revised_cond="and c.is_revised=0";
				$fso_status_cond=" and d.fso_status=1";
			}
			else
			{
				$is_plan_revised_cond="";
				$fso_status_cond="";
			}
			$sql = "select a.id, a.booking_no, d.job_no, a.within_group, d.style_ref_no, d.buyer_id,d.po_buyer as buy_name, c.body_part_id, a.determination_id, a.fabric_desc, a.gsm_weight, a.dia, b.fabric_dia, b.color_range, b.color_id, b.id as knit_id, b.knitting_source, b.knitting_party, b.stitch_length, b.machine_dia, b.machine_gg,b.is_sales from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_planning_entry_plan_dtls c, fabric_sales_order_mst d where a.id=b.mst_id and b.id=c.dtls_id and c.po_id=d.id and a.company_id=$company_id and a.buyer_id like '$buyer_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and b.is_sales=1 $search_field_cond $is_plan_revised_cond $fso_status_cond group by b.id, a.within_group, d.style_ref_no, d.job_no, b.knitting_source, b.knitting_party, b.stitch_length, b.color_range, b.color_id, b.fabric_dia, b.machine_dia, b.machine_gg, a.id, a.booking_no, d.buyer_id,d.po_buyer, c.body_part_id, a.determination_id, a.fabric_desc, a.gsm_weight, a.dia,b.is_sales order by b.id desc";
			//echo $sql;die;
			//b.machine_dia,
			$result = sql_select($sql);
			?>
			<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1030" class="rpt_table">
				<thead>
					<th width="40">SL</th>
					<th width="60">Plan Id</th>
					<th width="60">Program Id</th>
					<th width="60">Reqsn. No</th>
					<th width="120">Sales / Booking No</th>
					<th width="70">Buyer</th>
					<th width="110">Job No</th>
					<th width="110">Style Ref.</th>
					<th width="150">Fabric Desc</th>
					<th width="60">Gsm</th>
					<th width="60">Finish Dia</th>
					<th>Color Range</th>
				</thead>
			</table>
				<div style="width:1050px; max-height:280px; overflow-y:scroll" id="list_container_batch" align="left">
					<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1030" class="rpt_table"
					id="tbl_list_search">
					<?
					$i = 1;
					foreach ($result as $row) {
						if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
		
						$reqn_no = $rqsn_array[$row[csf('knit_id')]]['rqsn_no'];
						$job_no = $row[csf('job_no')];
						$style_ref = $row[csf('style_ref_no')];
						$within_group=$row[csf('within_group')];
		
						if ($row[csf('within_group')] == 1) {
							$buyer = $row[csf('buy_name')];
						} else {
							$buyer = $row[csf('buyer_id')];
						}
		
						$color = '';
						$color_id = explode(",", $row[csf('color_id')]);
						foreach ($color_id as $val) {
							if ($val > 0) $color .= $color_arr[$val] . ",";
						}
						$color = chop($color, ',');
						$count = implode(",", array_unique(explode(",", $rqsn_array[$row[csf('knit_id')]]['count'])));
						$body_part_type_id=$body_part_type_arr[$row[csf('body_part_id')]];
						$data = $row[csf('body_part_id')] . "**" . $row[csf('determination_id')] . "**" . $row[csf('fabric_desc')] . "**" . $row[csf('gsm_weight')] . "**" . $row[csf('fabric_dia')] . "**" . $job_no . "**" . $buyer . "**" . $plan_details_array[$row[csf('knit_id')]] . "**" . $row[csf('knitting_source')] . "**" . $row[csf('knitting_party')] . "**" . $row[csf('stitch_length')] . "**" . $row[csf('color_range')] . "**" . $count . "**" . $rqsn_array[$row[csf('knit_id')]]['lot'] . "**" . $brand_arr[$rqsn_array[$row[csf('knit_id')]]['brand']] . "**" . $color . "**" . $row[csf('color_id')] . "**" . $row[csf('machine_dia')] . "**" . $row[csf('machine_gg')] . "**" . $row[csf('within_group')] . "**" . $buyer_arr[$buyer] . "**" . $reqn_no. "**" . $rqsn_array[$row[csf('knit_id')]]['yarn_prod_id']. "**" . $sales_order. "**" . $body_part_type_id;
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
							onClick="js_set_value(<? echo $row[csf('knit_id')]; ?>,'<? echo $data; ?>','0','','');">
							<td width="40"><? echo $i; ?></td>
							<td width="60" align="center"><? echo $row[csf('id')]; ?></td>
							<td width="60" align="center"><? echo $row[csf('knit_id')]; ?></td>
							<td width="60" align="center"><? echo $reqn_no; ?>&nbsp;</td>
							<td width="120"><p><? echo $row[csf('booking_no')]; ?></p></td>
							<td width="70"><p><? echo $buyer_arr[$buyer]; ?></p></td>
							<td width="110"><p><? echo $job_no; ?></p></td>
							<td width="110"><p><? echo $style_ref; ?></p></td>
							<td width="150"><p><? echo $row[csf('fabric_desc')]; ?></p></td>
							<td width="60"><p><? echo $row[csf('gsm_weight')]; ?></p></td>
							<td width="60"><p><? echo $row[csf('fabric_dia')]; ?></p></td>
							<td><p><? echo $color_range[$row[csf('color_range')]]; ?></p></td>
						</tr>
						<?
						$i++;
					}
					?>
				</table>
			</div>
			<?
		}
		else
		{
			//for booking type both with and without
			if($bookingType == 0)
			{
				$rqsn_array = array();
				if ($db_type == 0) {
					$reqsn_dataArray = sql_select("select a.knit_id, a.requisition_no, group_concat(distinct(yarn_count_id)) as yarn_count_id,
						group_concat(distinct(brand)) as brand,
						group_concat(distinct(lot)) as lot , group_concat(distinct(b.id)) as yarn_prod_id from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.status_active=1 and a.is_deleted=0 group by a.knit_id, a.requisition_no");
				} else {
					$reqsn_dataArray = sql_select("select a.knit_id, a.requisition_no,
						LISTAGG(CAST(brand AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY brand) as brand,
						LISTAGG(CAST(yarn_count_id AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY yarn_count_id) as yarn_count_id,
						LISTAGG(CAST(lot AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY lot) as lot , LISTAGG(b.id, ',') WITHIN GROUP (ORDER BY b.id) as yarn_prod_id from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.status_active=1 and a.is_deleted=0 group by a.knit_id, a.requisition_no");
				}
				
				foreach ($reqsn_dataArray as $row) {
					$rqsn_array[$row[csf('knit_id')]]['rqsn_no'] = $row[csf('requisition_no')];
					$rqsn_array[$row[csf('knit_id')]]['count'] = $row[csf('yarn_count_id')];
					$rqsn_array[$row[csf('knit_id')]]['lot'] = $row[csf('lot')];
					$rqsn_array[$row[csf('knit_id')]]['brand'] = $row[csf('brand')];
					$rqsn_array[$row[csf('knit_id')]]['yarn_prod_id'] = $row[csf('yarn_prod_id')];
				}
			
				if ($db_type == 0) {
					$plan_details_array = return_library_array("select dtls_id, group_concat(distinct(po_id)) as po_id from ppl_planning_entry_plan_dtls where company_id=$company_id group by dtls_id", "dtls_id", "po_id");
				} else {
					$plan_details_array = return_library_array("select dtls_id, LISTAGG(po_id, ',') WITHIN GROUP (ORDER BY po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company_id group by dtls_id", "dtls_id", "po_id");
				}
			
				if (trim($data[0]) != "") {
					if ($search_by == 1) {
						$search_field_cond = "and a.booking_no like '$search_string'";
					} else if ($search_by == 2 || $search_by == 3 || $search_by == 6 || $search_by == 7) {
						if ($search_by == 2) $search_field = 'po_number';
						else if ($search_by == 6) $search_field = 'grouping';
						else if ($search_by == 7) $search_field = 'file_no';
						else $search_field = 'job_no_mst';
			
						if ($db_type == 0) {
							$po_id = return_field_value("group_concat(id) as po_id", "wo_po_break_down", "$search_field like '$search_string' and status_active=1 and is_deleted=0", "po_id");
						} else {
							$po_id = return_field_value("LISTAGG(id, ',') WITHIN GROUP (ORDER BY id) as po_id", "wo_po_break_down", "$search_field like '$search_string' and status_active=1 and is_deleted=0", "po_id");
						}
						$search_field_cond = "and c.po_id in(" . $po_id . ")";
					} else if ($search_by == 4) {
						$search_field_cond = "and a.fabric_desc like '$search_string'";
					} else {
						if (trim($data[0]) == "") $search_field_cond = ""; else $search_field_cond = "and b.id='" . trim($data[0]) . "'";
					}
				} else {
					$search_field_cond = "";
				}
			
				//b.is_sales!=1
				$sql = "select a.id, a.booking_no, a.buyer_id, c.body_part_id, a.determination_id, a.fabric_desc, a.gsm_weight, a.dia, b.fabric_dia, b.color_range,
				b.color_id, b.id as knit_id, b.knitting_source, b.knitting_party, b.stitch_length, b.machine_dia, b.machine_gg,c.po_id,b.is_sales from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_planning_entry_plan_dtls c where a.id=b.mst_id and b.id=c.dtls_id and a.company_id=$company_id and a.buyer_id like '$buyer_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.is_sales != 1 $search_field_cond group by b.id, b.knitting_source, b.knitting_party, b.stitch_length, b.color_range, b.color_id, b.fabric_dia, b.machine_dia, b.machine_gg, a.id, a.booking_no, a.buyer_id, c.body_part_id, a.determination_id, a.fabric_desc, a.gsm_weight, a.dia,c.po_id,b.is_sales order by b.id desc";
				//echo $sql; //b.machine_dia,
				$result = sql_select($sql);
				foreach ($result as $row) {
					$po_nos[] = $row[csf("po_id")];
				}
				$po_array = array();
				$po_cond = " and id in(".implode(",",$po_nos).")";
				if($po_nos!="")
				{
					$po_sql = sql_select("select id,job_no_mst,po_number, grouping,file_no from wo_po_break_down where status_active=1 and is_deleted=0 $po_cond");
				}
				foreach ($po_sql as $row) {
					$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
					$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no_mst')];
					$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
					$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
				}
				?>
				<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1030" class="rpt_table">
					<thead>
						<th width="30">SL</th>
						<th width="55">Plan Id</th>
						<th width="55">Program Id</th>
						<th width="50">Reqsn. No</th>
						<th width="110">Booking No</th>
						<th width="60">Buyer</th>
						<th width="100">PO No</th>
						<th width="80">Job No</th>
						<th width="70">Internal Ref</th>
						<th width="70">File No</th>
						<th width="130">Fabric Desc</th>
						<th width="55">Gsm</th>
						<th width="55">Finish Dia</th>
						<th>Color Range</th>
					</thead>
				</table>
				<div style="width:1050px; max-height:280px; overflow-y:scroll" id="list_container_batch" align="left">
					<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1030" class="rpt_table"
					id="tbl_list_search">
					<?
					$i = 1;
					foreach ($result as $row) {
						if ($i % 2 == 0)
							$bgcolor = "#E9F3FF";
						else
							$bgcolor = "#FFFFFF";
			
						$reqn_no = $rqsn_array[$row[csf('knit_id')]]['rqsn_no'];
						$po_id = array_unique(explode(",", $plan_details_array[$row[csf('knit_id')]]));
						$po_no = '';
						$job_no = '';
						$internal_ref = '';
						$file_nos = '';
						foreach ($po_id as $val) {
							if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= "," . $po_array[$val]['no'];
							if ($job_no == '') $job_no = $po_array[$val]['job_no'];
							if ($po_array[$val]['grouping'] != "") {
								if ($internal_ref == "") $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
							}
							if ($po_array[$val]['file_no'] != "") {
								if ($file_nos == "") $file_nos = $po_array[$val]['file_no']; else $file_nos .= "," . $po_array[$val]['file_no'];
							}
						}
			
						$internal_ref = implode(",", array_unique(explode(",", $internal_ref)));
						$file_nos = implode(",", array_unique(explode(",", $file_nos)));
			
						$brand = '';
						$brand_id = explode(",", $rqsn_array[$row[csf('knit_id')]]['brand']);
						foreach ($brand_id as $val) {
							if ($val > 0) $brand .= $brand_arr[$val] . ",";
						}
			
			
						$color = '';
						$color_id = explode(",", $row[csf('color_id')]);
						foreach ($color_id as $val) {
							if ($val > 0) $color .= $color_arr[$val] . ",";
						}
						$color = chop($color, ',');
						$count = implode(",", array_unique(explode(",", $rqsn_array[$row[csf('knit_id')]]['count'])));
						$body_part_type_id=$body_part_type_arr[$row[csf('body_part_id')]];
						$data = $row[csf('body_part_id')] . "**" . $row[csf('determination_id')] . "**" . $row[csf('fabric_desc')] . "**" . $row[csf('gsm_weight')] . "**" . $row[csf('fabric_dia')] . "**" . $job_no . "**" . $row[csf('buyer_id')] . "**" . $plan_details_array[$row[csf('knit_id')]] . "**" . $row[csf('knitting_source')] . "**" . $row[csf('knitting_party')] . "**" . $row[csf('stitch_length')] . "**" . $row[csf('color_range')] . "**" . $count . "**" . $rqsn_array[$row[csf('knit_id')]]['lot'] . "**" . $brand_arr[$rqsn_array[$row[csf('knit_id')]]['brand']] . "**" . $color . "**" . $row[csf('color_id')] . "**" . $row[csf('machine_dia')] . "**" . $row[csf('machine_gg')] . "**0**" . $buyer_arr[$row[csf('buyer_id')]] . "**" . $reqn_no. "**" . $rqsn_array[$row[csf('knit_id')]]['yarn_prod_id'] . "**" . $sales_order . "**" . $body_part_type_id;
						
						//
						$bookinWithoutOrder = 0;
						if($row[csf('is_sales')] ==2)
						{
							$bookinWithoutOrder = 1;
						}
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
							onClick="js_set_value(<? echo $row[csf('knit_id')]; ?>,'<? echo $data; ?>','<?php echo $bookinWithoutOrder; ?>','','');">
							<td width="30"><? echo $i; ?></td>
							<td width="55" align="center"><? echo $row[csf('id')]; ?></td>
							<td width="55" align="center"><? echo $row[csf('knit_id')]; ?></td>
							<td width="50" align="center"><? echo $reqn_no; ?>&nbsp;</td>
							<td width="110"><p><? echo $row[csf('booking_no')]; ?></p></td>
							<td width="60"><p><? echo $buyer_arr[$row[csf('buyer_id')]]; ?></p></td>
							<td width="100"><p><? echo $po_no; ?></p></td>
							<td width="80"><p><? echo $job_no; ?></p></td>
							<td width="70"><p><? echo $internal_ref; ?>&nbsp;</p></td>
							<td width="70"><p><? echo $file_nos; ?>&nbsp;</p></td>
							<td width="130"><p><? echo $row[csf('fabric_desc')]; ?></p></td>
							<td width="55"><p><? echo $row[csf('gsm_weight')]; ?></p></td>
							<td width="55"><p><? echo $row[csf('fabric_dia')]; ?></p></td>
							<td><p><? echo $color_range[$row[csf('color_range')]]; ?></p></td>
						</tr>
						<?
						$i++;
					}
					?>
				</table>
                </div>
                <?
            }
			
			//for booking type with
			else if($bookingType == 1)
			{
				$rqsn_array = array();
				if ($db_type == 0) {
					$reqsn_dataArray = sql_select("select a.knit_id, a.requisition_no, group_concat(distinct(yarn_count_id)) as yarn_count_id,
						group_concat(distinct(brand)) as brand,
						group_concat(distinct(lot)) as lot , group_concat(distinct(b.id)) as yarn_prod_id from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.status_active=1 and a.is_deleted=0 group by a.knit_id, a.requisition_no");
				} else {
					$reqsn_dataArray = sql_select("select a.knit_id, a.requisition_no,
						LISTAGG(CAST(brand AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY brand) as brand,
						LISTAGG(CAST(yarn_count_id AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY yarn_count_id) as yarn_count_id,
						LISTAGG(CAST(lot AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY lot) as lot , LISTAGG(b.id, ',') WITHIN GROUP (ORDER BY b.id) as yarn_prod_id from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.status_active=1 and a.is_deleted=0 group by a.knit_id, a.requisition_no");
				}
				
				foreach ($reqsn_dataArray as $row) {
					$rqsn_array[$row[csf('knit_id')]]['rqsn_no'] = $row[csf('requisition_no')];
					$rqsn_array[$row[csf('knit_id')]]['count'] = $row[csf('yarn_count_id')];
					$rqsn_array[$row[csf('knit_id')]]['lot'] = $row[csf('lot')];
					$rqsn_array[$row[csf('knit_id')]]['brand'] = $row[csf('brand')];
					$rqsn_array[$row[csf('knit_id')]]['yarn_prod_id'] = $row[csf('yarn_prod_id')];
				}
			
				if ($db_type == 0) {
					$plan_details_array = return_library_array("select dtls_id, group_concat(distinct(po_id)) as po_id from ppl_planning_entry_plan_dtls where company_id=$company_id group by dtls_id", "dtls_id", "po_id");
				} else {
					$plan_details_array = return_library_array("select dtls_id, LISTAGG(po_id, ',') WITHIN GROUP (ORDER BY po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company_id group by dtls_id", "dtls_id", "po_id");
				}
			
				if (trim($data[0]) != "") {
					if ($search_by == 1) {
						$search_field_cond = "and a.booking_no like '$search_string'";
					} else if ($search_by == 2 || $search_by == 3 || $search_by == 6 || $search_by == 7) {
						if ($search_by == 2) $search_field = 'po_number';
						else if ($search_by == 6) $search_field = 'grouping';
						else if ($search_by == 7) $search_field = 'file_no';
						else $search_field = 'job_no_mst';
			
						if ($db_type == 0) {
							$po_id = return_field_value("group_concat(id) as po_id", "wo_po_break_down", "$search_field like '$search_string' and status_active=1 and is_deleted=0", "po_id");
						} else {
							$po_id = return_field_value("LISTAGG(id, ',') WITHIN GROUP (ORDER BY id) as po_id", "wo_po_break_down", "$search_field like '$search_string' and status_active=1 and is_deleted=0", "po_id");
						}
						$search_field_cond = "and c.po_id in(" . $po_id . ")";
					} else if ($search_by == 4) {
						$search_field_cond = "and a.fabric_desc like '$search_string'";
					} else {
						if (trim($data[0]) == "") $search_field_cond = ""; else $search_field_cond = "and b.id='" . trim($data[0]) . "'";
					}
				} else {
					$search_field_cond = "";
				}
			
				//b.is_sales!=1
				$sql = "select a.id, a.booking_no, a.buyer_id, c.body_part_id, a.determination_id, a.fabric_desc, a.gsm_weight, a.dia, b.fabric_dia, b.color_range,
				b.color_id, b.id as knit_id, b.knitting_source, b.knitting_party, b.stitch_length, b.machine_dia, b.machine_gg,c.po_id from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_planning_entry_plan_dtls c where a.id=b.mst_id and b.id=c.dtls_id and a.company_id=$company_id and a.buyer_id like '$buyer_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.is_sales = 0 $search_field_cond group by b.id, b.knitting_source, b.knitting_party, b.stitch_length, b.color_range, b.color_id, b.fabric_dia, b.machine_dia, b.machine_gg, a.id, a.booking_no, a.buyer_id, c.body_part_id, a.determination_id, a.fabric_desc, a.gsm_weight, a.dia,c.po_id order by b.id desc";
				//echo $sql; //b.machine_dia,
				$result = sql_select($sql);
				foreach ($result as $row) {
					$po_nos[] = $row[csf("po_id")];
				}
				$po_array = array();
				$po_cond = " and id in(".implode(",",$po_nos).")";
				if($po_nos!="")
				{
					$po_sql = sql_select("select id,job_no_mst,po_number, grouping,file_no from wo_po_break_down where status_active=1 and is_deleted=0 $po_cond");
				}
				foreach ($po_sql as $row) {
					$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
					$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no_mst')];
					$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
					$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
				}
				?>
				<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1030" class="rpt_table">
					<thead>
						<th width="30">SL</th>
						<th width="55">Plan Id</th>
						<th width="55">Program Id</th>
						<th width="50">Reqsn. No</th>
						<th width="110">Booking No</th>
						<th width="60">Buyer</th>
						<th width="100">PO No</th>
						<th width="80">Job No</th>
						<th width="70">Internal Ref</th>
						<th width="70">File No</th>
						<th width="130">Fabric Desc</th>
						<th width="55">Gsm</th>
						<th width="55">Finish Dia</th>
						<th>Color Range</th>
					</thead>
				</table>
				<div style="width:1050px; max-height:280px; overflow-y:scroll" id="list_container_batch" align="left">
					<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1030" class="rpt_table"
					id="tbl_list_search">
					<?
					$i = 1;
					foreach ($result as $row) {
						if ($i % 2 == 0)
							$bgcolor = "#E9F3FF";
						else
							$bgcolor = "#FFFFFF";
			
						$reqn_no = $rqsn_array[$row[csf('knit_id')]]['rqsn_no'];
						$po_id = array_unique(explode(",", $plan_details_array[$row[csf('knit_id')]]));
						$po_no = '';
						$job_no = '';
						$internal_ref = '';
						$file_nos = '';
						foreach ($po_id as $val) {
							if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= "," . $po_array[$val]['no'];
							if ($job_no == '') $job_no = $po_array[$val]['job_no'];
							if ($po_array[$val]['grouping'] != "") {
								if ($internal_ref == "") $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
							}
							if ($po_array[$val]['file_no'] != "") {
								if ($file_nos == "") $file_nos = $po_array[$val]['file_no']; else $file_nos .= "," . $po_array[$val]['file_no'];
							}
						}
			
						$internal_ref = implode(",", array_unique(explode(",", $internal_ref)));
						$file_nos = implode(",", array_unique(explode(",", $file_nos)));
			
						$brand = '';
						$brand_id = explode(",", $rqsn_array[$row[csf('knit_id')]]['brand']);
						foreach ($brand_id as $val) {
							if ($val > 0) $brand .= $brand_arr[$val] . ",";
						}
			
			
						$color = '';
						$color_id = explode(",", $row[csf('color_id')]);
						foreach ($color_id as $val) {
							if ($val > 0) $color .= $color_arr[$val] . ",";
						}
						$color = chop($color, ',');
						$count = implode(",", array_unique(explode(",", $rqsn_array[$row[csf('knit_id')]]['count'])));
						$body_part_type_id=$body_part_type_arr[$row[csf('body_part_id')]];
						$data = $row[csf('body_part_id')] . "**" . $row[csf('determination_id')] . "**" . $row[csf('fabric_desc')] . "**" . $row[csf('gsm_weight')] . "**" . $row[csf('fabric_dia')] . "**" . $job_no . "**" . $row[csf('buyer_id')] . "**" . $plan_details_array[$row[csf('knit_id')]] . "**" . $row[csf('knitting_source')] . "**" . $row[csf('knitting_party')] . "**" . $row[csf('stitch_length')] . "**" . $row[csf('color_range')] . "**" . $count . "**" . $rqsn_array[$row[csf('knit_id')]]['lot'] . "**" . $brand_arr[$rqsn_array[$row[csf('knit_id')]]['brand']] . "**" . $color . "**" . $row[csf('color_id')] . "**" . $row[csf('machine_dia')] . "**" . $row[csf('machine_gg')] . "**0**" . $buyer_arr[$row[csf('buyer_id')]] . "**" . $reqn_no. "**" . $rqsn_array[$row[csf('knit_id')]]['yarn_prod_id'] . "**" . $sales_order . "**" . $body_part_type_id;
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
							onClick="js_set_value(<? echo $row[csf('knit_id')]; ?>,'<? echo $data; ?>','0','','');">
							<td width="30"><? echo $i; ?></td>
							<td width="55" align="center"><? echo $row[csf('id')]; ?></td>
							<td width="55" align="center"><? echo $row[csf('knit_id')]; ?></td>
							<td width="50" align="center"><? echo $reqn_no; ?>&nbsp;</td>
							<td width="110"><p><? echo $row[csf('booking_no')]; ?></p></td>
							<td width="60"><p><? echo $buyer_arr[$row[csf('buyer_id')]]; ?></p></td>
							<td width="100"><p><? echo $po_no; ?></p></td>
							<td width="80"><p><? echo $job_no; ?></p></td>
							<td width="70"><p><? echo $internal_ref; ?>&nbsp;</p></td>
							<td width="70"><p><? echo $file_nos; ?>&nbsp;</p></td>
							<td width="130"><p><? echo $row[csf('fabric_desc')]; ?></p></td>
							<td width="55"><p><? echo $row[csf('gsm_weight')]; ?></p></td>
							<td width="55"><p><? echo $row[csf('fabric_dia')]; ?></p></td>
							<td><p><? echo $color_range[$row[csf('color_range')]]; ?></p></td>
						</tr>
						<?
						$i++;
					}
					?>
				</table>
                </div>
                <?
            }

			//for booking type without
			else
			{
				$rqsn_array = array();
				if ($db_type == 0)
				{
					$reqsn_dataArray = sql_select("select a.knit_id, a.requisition_no, group_concat(distinct(yarn_count_id)) as yarn_count_id,
						group_concat(distinct(brand)) as brand,
						group_concat(distinct(lot)) as lot , group_concat(distinct(b.id)) as yarn_prod_id from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.status_active=1 and a.is_deleted=0 group by a.knit_id, a.requisition_no");
				}
				else
				{
					$reqsn_dataArray = sql_select("select a.knit_id, a.requisition_no,
						LISTAGG(CAST(brand AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY brand) as brand,
						LISTAGG(CAST(yarn_count_id AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY yarn_count_id) as yarn_count_id,
						LISTAGG(CAST(lot AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY lot) as lot , LISTAGG(b.id, ',') WITHIN GROUP (ORDER BY b.id) as yarn_prod_id from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.status_active=1 and a.is_deleted=0 group by a.knit_id, a.requisition_no");
				}
				
				foreach ($reqsn_dataArray as $row)
				{
					$rqsn_array[$row[csf('knit_id')]]['rqsn_no'] = $row[csf('requisition_no')];
					$rqsn_array[$row[csf('knit_id')]]['count'] = $row[csf('yarn_count_id')];
					$rqsn_array[$row[csf('knit_id')]]['lot'] = $row[csf('lot')];
					$rqsn_array[$row[csf('knit_id')]]['brand'] = $row[csf('brand')];
					$rqsn_array[$row[csf('knit_id')]]['yarn_prod_id'] = $row[csf('yarn_prod_id')];
				}
			
			
				if ($db_type == 0)
				{
					$plan_details_array = return_library_array("select dtls_id, group_concat(distinct(po_id)) as po_id from ppl_planning_entry_plan_dtls where company_id=$company_id group by dtls_id", "dtls_id", "po_id");
				}
				else
				{
					$plan_details_array = return_library_array("select dtls_id, LISTAGG(po_id, ',') WITHIN GROUP (ORDER BY po_id) as po_id from ppl_planning_entry_plan_dtls where company_id=$company_id group by dtls_id", "dtls_id", "po_id");
				}
			
				if (trim($data[0]) != "")
				{
					if ($search_by == 1)
					{
						$search_field_cond = "and a.booking_no like '$search_string'";
					}
					else if ($search_by == 2 || $search_by == 3 || $search_by == 6 || $search_by == 7)
					{
						if ($search_by == 2)
							$search_field = 'po_number';
						else if ($search_by == 6)
							$search_field = 'grouping';
						else if ($search_by == 7)
							$search_field = 'file_no';
						else
							$search_field = 'job_no_mst';
			
						if ($db_type == 0)
						{
							$po_id = return_field_value("group_concat(id) as po_id", "wo_po_break_down", "$search_field like '$search_string' and status_active=1 and is_deleted=0", "po_id");
						}
						else
						{
							$po_id = return_field_value("LISTAGG(id, ',') WITHIN GROUP (ORDER BY id) as po_id", "wo_po_break_down", "$search_field like '$search_string' and status_active=1 and is_deleted=0", "po_id");
						}
						$search_field_cond = "and c.po_id in(" . $po_id . ")";
					}
					else if ($search_by == 4)
					{
						$search_field_cond = "and a.fabric_desc like '$search_string'";
					}
					else
					{
						if (trim($data[0]) == "") $search_field_cond = ""; else $search_field_cond = "and b.id='" . trim($data[0]) . "'";
					}
				}
				else
				{
					$search_field_cond = "";
				}

				$sql = "
					select
						a.id, a.booking_no, a.buyer_id, c.body_part_id, a.determination_id, a.fabric_desc, a.gsm_weight, a.dia, b.fabric_dia, b.color_range,
						b.color_id, b.id as knit_id, b.knitting_source, b.knitting_party, b.stitch_length, b.machine_dia, b.machine_gg,
						c.po_id 
					from
						ppl_planning_info_entry_mst a,
						ppl_planning_info_entry_dtls b,
						ppl_planning_entry_plan_dtls c
					where
						a.id=b.mst_id and b.id=c.dtls_id and a.company_id = ".$company_id." and a.buyer_id like '".$buyer_id."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.is_sales = 2 $search_field_cond 
					group by
						b.id, b.knitting_source, b.knitting_party, b.stitch_length, b.color_range, b.color_id, b.fabric_dia, b.machine_dia, b.machine_gg, a.id, a.booking_no, a.buyer_id, c.body_part_id, a.determination_id, a.fabric_desc, a.gsm_weight, a.dia,c.po_id 
					order by
						b.id desc";
				//echo $sql; //b.machine_dia,
				$result = sql_select($sql);
				?>
				<table cellspacing="0" cellpadding="0" border="1" rules="all" width="880" class="rpt_table">
					<thead>
						<th width="30">SL</th>
						<th width="55">Plan Id</th>
						<th width="55">Program Id</th>
						<th width="50">Reqsn. No</th>
						<th width="110">Booking No</th>
						<th width="120">Buyer</th>
						<th width="200">Fabric Desc</th>
						<th width="55">Gsm</th>
						<th width="55">Finish Dia</th>
						<th>Color Range</th>
					</thead>
				</table>
				<div style="width:900px; max-height:280px; overflow-y:scroll" id="list_container_batch" align="left">
					<table cellspacing="0" cellpadding="0" border="1" rules="all" width="880" class="rpt_table"
					id="tbl_list_search">
					<?
					$i = 1;
					foreach ($result as $row) {
						if ($i % 2 == 0)
							$bgcolor = "#E9F3FF";
						else
							$bgcolor = "#FFFFFF";
			
						$reqn_no = $rqsn_array[$row[csf('knit_id')]]['rqsn_no'];
						$job_no = '';

						$brand = '';
						$brand_id = explode(",", $rqsn_array[$row[csf('knit_id')]]['brand']);
						foreach ($brand_id as $val) {
							if ($val > 0) $brand .= $brand_arr[$val] . ",";
						}
			
						$color = '';
						$color_id = explode(",", $row[csf('color_id')]);
						foreach ($color_id as $val) {
							if ($val > 0) $color .= $color_arr[$val] . ",";
						}
						
						$color = chop($color, ',');
						$count = implode(",", array_unique(explode(",", $rqsn_array[$row[csf('knit_id')]]['count'])));
						$body_part_type_id=$body_part_type_arr[$row[csf('body_part_id')]];
						$data = $row[csf('body_part_id')] . "**" . $row[csf('determination_id')] . "**" . $row[csf('fabric_desc')] . "**" . $row[csf('gsm_weight')] . "**" . $row[csf('fabric_dia')] . "**" . $job_no . "**" . $row[csf('buyer_id')] . "**" . $plan_details_array[$row[csf('knit_id')]] . "**" . $row[csf('knitting_source')] . "**" . $row[csf('knitting_party')] . "**" . $row[csf('stitch_length')] . "**" . $row[csf('color_range')] . "**" . $count . "**" . $rqsn_array[$row[csf('knit_id')]]['lot'] . "**" . $brand_arr[$rqsn_array[$row[csf('knit_id')]]['brand']] . "**" . $color . "**" . $row[csf('color_id')] . "**" . $row[csf('machine_dia')] . "**" . $row[csf('machine_gg')] . "**0**" . $buyer_arr[$row[csf('buyer_id')]] . "**" . $reqn_no. "**" . $rqsn_array[$row[csf('knit_id')]]['yarn_prod_id'] . "**" . $sales_order . "**" . $body_part_type_id;
						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
							onClick="js_set_value(<? echo $row[csf('knit_id')]; ?>,'<? echo $data; ?>','1','','');">
							<td width="30"><? echo $i; ?></td>
							<td width="55" align="center"><? echo $row[csf('id')]; ?></td>
							<td width="55" align="center"><? echo $row[csf('knit_id')]; ?></td>
							<td width="50" align="center"><? echo $reqn_no; ?>&nbsp;</td>
							<td width="110"><p><? echo $row[csf('booking_no')]; ?></p></td>
							<td width="120"><p><? echo $buyer_arr[$row[csf('buyer_id')]]; ?></p></td>
							<td width="200"><p><? echo $row[csf('fabric_desc')]; ?></p></td>
							<td width="55" align="center"><p><? echo $row[csf('gsm_weight')]; ?></p></td>
							<td width="55" align="center"><p><? echo $row[csf('fabric_dia')]; ?></p></td>
							<td><p><? echo $color_range[$row[csf('color_range')]]; ?></p></td>
						</tr>
						<?
						$i++;
					}
					?>
				</table>
			</div>
			<?
			}
		}
	}
	exit();
}
if($action=="populate_barcode_data")
{
	$data=explode("**", $data);
	//$company_id=$data[0];
	$cbo_receive_basis=$data[0];
	$program_id=$data[1];
	//$working_company_id=$data[3];
	//$machine_id=$data[4];
	//$location_id=$data[5];

	$rqsn_array = array();
	if ($db_type == 0) {
		$reqsn_dataArray = sql_select("select a.knit_id, a.requisition_no, group_concat(distinct(yarn_count_id)) as yarn_count_id,
			group_concat(distinct(brand)) as brand,
			group_concat(distinct(lot)) as lot , group_concat(distinct(b.id)) as yarn_prod_id from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.status_active=1 and a.is_deleted=0 and a.knit_id=$program_id group by a.knit_id, a.requisition_no");
	} else {
		$reqsn_dataArray = sql_select("select a.knit_id, a.requisition_no,
			LISTAGG(CAST(brand AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY brand) as brand,
			LISTAGG(CAST(yarn_count_id AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY yarn_count_id) as yarn_count_id,
			LISTAGG(CAST(lot AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY lot) as lot , LISTAGG(b.id, ',') WITHIN GROUP (ORDER BY b.id) as yarn_prod_id from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.status_active=1 and a.is_deleted=0 and a.knit_id=$program_id group by a.knit_id, a.requisition_no");
	}
	
	foreach ($reqsn_dataArray as $row) {
		$rqsn_array[$row[csf('knit_id')]]['rqsn_no'] = $row[csf('requisition_no')];
		$rqsn_array[$row[csf('knit_id')]]['count'] = $row[csf('yarn_count_id')];
		$rqsn_array[$row[csf('knit_id')]]['lot'] = $row[csf('lot')];
		$rqsn_array[$row[csf('knit_id')]]['brand'] = $row[csf('brand')];
		$rqsn_array[$row[csf('knit_id')]]['yarn_prod_id'] = $row[csf('yarn_prod_id')];
	}

	if ($db_type == 0) {
		$plan_details_array = return_library_array("select dtls_id, group_concat(distinct(po_id)) as po_id from ppl_planning_entry_plan_dtls where dtls_id=$program_id group by dtls_id", "dtls_id", "po_id"); //company_id=$company_id and 
	} else {
		$plan_details_array = return_library_array("select dtls_id, LISTAGG(po_id, ',') WITHIN GROUP (ORDER BY po_id) as po_id from ppl_planning_entry_plan_dtls where dtls_id=$program_id group by dtls_id", "dtls_id", "po_id"); //company_id=$company_id and 
	}

	$machine_floor_arr = return_library_array("select id, floor_id from lib_machine_name where status_active=1", "id", "floor_id");
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');

	$shift_duration_entry_arr = sql_select("select shift_name, start_time, end_time, cross_date from shift_duration_entry where production_type=1 and status_active=1 order by shift_name");
	$shift_name="";$cross_date = 0;$shift_end_time = "";
	foreach ($shift_duration_entry_arr as $val) 
	{
		$curr_time = new DateTime('now');
		$s_time = new DateTime($val[csf('start_time')]);
		$e_time = new DateTime($val[csf('end_time')]);

		$current_time = $curr_time->format('Y-m-d H:i:s a');
		$start_time = $s_time->format('Y-m-d H:i:s a');
		$end_time = $e_time->format('Y-m-d H:i:s a');

		if($start_time > $end_time){
			$end_time = $e_time->modify('+1 day')->format('Y-m-d H:i:s a');
			$start_time = $s_time->modify('-1 day')->format('Y-m-d H:i:s a');
			//if($current_time<$start_time)
		}
		//echo $current_time."=".$start_time."=".$end_time."<br>";
		if( $current_time >= $start_time && $current_time <= $end_time && $shift_name=="")
		{
			$shift_name = $val[csf('shift_name')];

			if($val[csf('cross_date')] ==1)
			{
				$cross_date = $val[csf('cross_date')];
				$shift_end_time = $val[csf('end_time')];
			}else{
				$cross_date =0;
				$shift_end_time = "";
			}
		}

		//$current_time."=".$start_time."=".$end_time.
		//2022-03-28 00:31:42 =  2022-03-28 22:01:00 =  2022-03-29 06:00:00
	}


	$curr_time = new DateTime('now', new DateTimezone('Asia/Dhaka'));
	if($cross_date == 0){
		$production_date = $curr_time->format('d-m-Y');
	}
	else
	{
		$e_time = new DateTime($shift_end_time);

		$current_time = $curr_time->format('Y-m-d H:i:s a');
		$end_time = $e_time->format('Y-m-d H:i:s a');

        if($current_time > $end_time)
        {
        	$production_date = $curr_time->format('d-m-Y');
        }else{
        	$production_date = $curr_time->modify('-1 day')->format('d-m-Y');
        }
	}
	//echo $cross_date."=".$production_date;die;

	//b.is_sales!=1
	
	$sql = "SELECT a.company_id, a.id, a.booking_no, a.buyer_id, c.body_part_id, a.determination_id, a.fabric_desc, a.gsm_weight, a.dia, b.fabric_dia, b.color_range, b.color_id, b.id as knit_id, b.knitting_source, b.knitting_party, b.stitch_length, b.machine_dia, b.machine_gg,c.po_id, b.is_sales, b.machine_id, d.po_buyer, d.buyer_id as sales_buyer, d.within_group, b.location_id, d.fso_status from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, ppl_planning_entry_plan_dtls c left join fabric_sales_order_mst d on c.po_id=d.id and c.is_sales=1 where a.id=b.mst_id and b.id=c.dtls_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.id=$program_id group by a.company_id,b.id, b.knitting_source, b.knitting_party, b.stitch_length, b.color_range, b.color_id, b.fabric_dia, b.machine_dia, b.machine_gg, a.id, a.booking_no, a.buyer_id, c.body_part_id, a.determination_id, a.fabric_desc, a.gsm_weight, a.dia,c.po_id, b.is_sales, b.machine_id, d.po_buyer, d.buyer_id, d.within_group, b.location_id, d.fso_status";

	//echo $sql; //b.machine_dia,
	//and a.company_id=$company_id  
	$result = sql_select($sql);
	foreach ($result as $row) {
		if( $row[csf("is_sales")]==1 )
		{
			if($row[csf("fso_status")] !=1)
			{
				echo "Cancelled##Sales order is cancelled";
				die;
			}

		}

		$po_nos[$row[csf("po_id")]] = $row[csf("po_id")];
		$is_sales = $row[csf("is_sales")];
	}
	$po_nos = array_filter($po_nos);

	$po_array = array();
	$po_cond = " and a.id in(".implode(",",$po_nos).")";
	if(!empty($po_nos) && $is_sales ==0)
	{
		$po_sql = sql_select("select a.id, a.job_no_mst, a.po_number, a.grouping, a.file_no, b.location_name from wo_po_break_down a, wo_po_details_master b where a.job_id=b.id and a.status_active=1 and a.is_deleted=0 $po_cond");
		foreach ($po_sql as $row) 
		{
			$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
			$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no_mst')];
			$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
			$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
			$po_array[$row[csf('id')]]['location_name'] = $row[csf('location_name')];
		}
		$booking_without_order=0;
	}

	if($is_sales==1)
	{
		$po_sql = sql_select("select a.id, a.job_no, a.location_id from fabric_sales_order_mst a where a.status_active=1 and a.is_deleted=0 $po_cond");
		foreach ($po_sql as $row) 
		{
			$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
			$po_array[$row[csf('id')]]['location_name'] = $row[csf('location_id')];
		}
		$booking_without_order=0;
	}

	if($is_sales ==2)
	{
		//select a.booking_no from wo_non_ord_samp_booking_mst a where a.booking_no = 'FAL-SMN-21-00103'
		$booking_without_order=1;
	}
	
	$buyer_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');
	
	$i = 1;
	foreach ($result as $row) 
	{
		if ($i % 2 == 0)
			$bgcolor = "#E9F3FF";
		else
			$bgcolor = "#FFFFFF";

		$reqn_no = $rqsn_array[$row[csf('knit_id')]]['rqsn_no'];
		$po_id = array_unique(explode(",", $plan_details_array[$row[csf('knit_id')]]));
		$po_no = '';
		$job_no = '';
		$internal_ref = '';
		$file_nos = '';
		foreach ($po_id as $val) {
			if ($po_no == '') $po_no = $po_array[$val]['no']; else $po_no .= "," . $po_array[$val]['no'];
			if ($job_no == '') $job_no = $po_array[$val]['job_no'];
			if ($po_array[$val]['grouping'] != "") {
				if ($internal_ref == "") $internal_ref = $po_array[$val]['grouping']; else $internal_ref .= "," . $po_array[$val]['grouping'];
			}
			if ($po_array[$val]['file_no'] != "") {
				if ($file_nos == "") $file_nos = $po_array[$val]['file_no']; else $file_nos .= "," . $po_array[$val]['file_no'];
			}

			if ($po_array[$val]['location_name'] != "") {
				$location_name = $po_array[$val]['location_name'];
			}
		}

		$internal_ref = implode(",", array_unique(explode(",", $internal_ref)));
		$file_nos = implode(",", array_unique(explode(",", $file_nos)));

		$brand = '';
		$brand_id = array_unique(explode(",", $rqsn_array[$row[csf('knit_id')]]['brand']));
		foreach ($brand_id as $val) {
			if ($val > 0) $brand .= $brand_arr[$val] . ",";
		}

		$brand = chop($brand,",");

		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');
		$count = implode(",", array_unique(explode(",", $rqsn_array[$row[csf('knit_id')]]['count'])));
		$body_part_type_id=$body_part_type_arr[$row[csf('body_part_id')]];
		$data_str = $row[csf('knit_id')]."##".$row[csf('body_part_id')] . "**" . $row[csf('determination_id')] . "**" . $row[csf('fabric_desc')] . "**" . $row[csf('gsm_weight')] . "**" . $row[csf('fabric_dia')] . "**" . $job_no . "**" . $row[csf('buyer_id')] . "**" . $plan_details_array[$row[csf('knit_id')]] . "**" . $row[csf('knitting_source')] . "**" . $row[csf('knitting_party')] . "**" . $row[csf('stitch_length')] . "**" . $row[csf('color_range')] . "**" . $count . "**" . $rqsn_array[$row[csf('knit_id')]]['lot'] . "**" . $brand/*$brand_arr[$rqsn_array[$row[csf('knit_id')]]['brand']]*/ . "**" . $color . "**" . $row[csf('color_id')] . "**" . $row[csf('machine_dia')] . "**" . $row[csf('machine_gg')] . "**0**" . $buyer_arr[$row[csf('buyer_id')]] . "**" . $reqn_no. "**" . $rqsn_array[$row[csf('knit_id')]]['yarn_prod_id'] . "**" . $is_sales . "**" . $body_part_type_id . "**" . $row[csf("company_id")]. "**" . $row[csf("machine_id")]. "**" . $location_name. "**" . $machine_floor_arr[$row[csf("machine_id")]]. "**" . $shift_name. "**" . $booking_without_order. "**" . $row[csf('within_group')]. "**" . $row[csf('sales_buyer')] . "**" . $buyer_arr[$row[csf('sales_buyer')]] . "**" . $row[csf('po_buyer')] ."**".$buyer_arr[$row[csf('po_buyer')]]."**".$row[csf('location_id')]."**".$production_date;     
		echo $data_str;
		break;
	}
						
}

if($action=="populate_operator_name")
{
	$data=explode("_", $data);
	$operator_code=$data[0];
	$cbo_knitting_company=$data[1];
	$cbo_location_name=$data[2];

	$result = sql_select("select id, first_name from lib_employee where emp_code='$operator_code' and company_id=$cbo_knitting_company and location_id=$cbo_location_name and status_active=1 and is_deleted=0 order by first_name");
	
	foreach ($result as $row) 
	{ 
		echo $row[csf('id')]."##".$row[csf('first_name')];
		break;
	}				
}

if ($action == 'populate_data_from_plan') //No Need
{
	$sql_prev_production = "select sum(b.grey_receive_qnty) as grey_receive_qnty from inv_receive_master a,  pro_grey_prod_entry_dtls b where a.id=b.mst_id and booking_id=$data and a.receive_basis=2 and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";

	$prev_production_data = sql_select($sql_prev_production);
	echo "document.getElementById('previous_book_plan_production').value 				= '" . $prev_production_data[0][csf("grey_receive_qnty")] . "';\n";

	$program_qnty_array = sql_select("select sum(a.program_qnty) as qnty,location_id from ppl_planning_info_entry_dtls a where a.id=$data and a.status_active=1 and a.is_deleted=0 group by location_id");
	echo "document.getElementById('required_qnty').value 				= '" . $program_qnty_array[0][csf("qnty")] . "';\n";
	echo "$('#cbo_location_name').val('".$program_qnty_array[0][csf("location_id")]."');\n";
	exit();
}

if ($action == 'populate_data_from_booking2')
{
	$dataArr = explode('_', $data);
	/*
		$sql_progqty_data = sql_select("select id,program_qnty,location_id, is_sales from ppl_planning_info_entry_dtls where id=".$dataArr[0]." and status_active=1 and is_deleted=0");
		$program_qnty = $sql_progqty_data[0][csf("program_qnty")];
		$location_id = $sql_progqty_data[0][csf("location_id")];
		$is_sales = $sql_progqty_data[0][csf("is_sales")];
	*/

	$is_service_booking_mandatory= return_field_value("chemical_issue","variable_settings_production","company_name ='$dataArr[1]' and variable_list=64 and is_deleted=0 and status_active=1");
	echo "document.getElementById('is_service_booking_mandatory').value = '" . $is_service_booking_mandatory . "';\n";

	$sql_progqty_data = sql_select("SELECT a.id,a.program_qnty,a.location_id, a.is_sales , b.po_id, a.knitting_source, a.knitting_party, a.machine_id FROM ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b WHERE a.id=".$dataArr[0]." and a.status_active=1 and a.is_deleted=0 and a.id = b.dtls_id and b.status_active=1 and b.is_deleted=0 group by a.id,a.program_qnty,a.location_id, a.is_sales,b.po_id, a.knitting_source, a.knitting_party, a.machine_id ");
	foreach ($sql_progqty_data as  $val) 
	{
		$program_qnty = $val[csf("program_qnty")];
		$knitting_source = $val[csf("knitting_source")];
		$knitting_party = $val[csf("knitting_party")];
		$machine_id = $val[csf("machine_id")];
		$location_id = $val[csf("location_id")];
		$is_sales = $val[csf("is_sales")];
		$orderIDs.=$val[csf('po_id')].",";
	}
	
	$sql_rcvqty_data = sql_select("select a.booking_id,sum(b.grey_receive_qnty) as grey_receive_qnty,order_id from inv_receive_master a,  pro_grey_prod_entry_dtls b where a.id=b.mst_id and a.booking_id=" . $dataArr[0] . " and a.receive_basis=2 and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.booking_id,order_id");

	$recv_qnty=0;
	foreach ($sql_rcvqty_data as $row)
	{
		$recv_qnty+=$row[csf('grey_receive_qnty')];
	}
	$orderIDs=chop($orderIDs,",");
	$orderID=implode(",",array_filter(array_unique(explode(",", $orderIDs))));
	//$recv_qnty = $sql_rcvqty_data[0][csf("grey_receive_qnty")];
	//$orderID = $sql_rcvqty_data[0][csf("order_id")];

	if($orderID !="" )
	{
		$prog_job_no = return_field_value("job_no_mst", "wo_po_break_down", "id in(". $orderID.") and status_active=1 and is_deleted=0", "job_no_mst");
		echo "document.getElementById('txt_job_no').value = '" . $prog_job_no . "';\n";
		if($is_sales == 1)
		{
			echo "document.getElementById('txt_job_no').value = '';\n";
		}
	}

	$over_receive_limit = 0;
	$variable_set_invent = sql_select("select category,over_rcv_status,over_rcv_percent,over_rcv_payment from variable_inv_ile_standard where company_name=".$dataArr[1]." and variable_list=23 and category = 13 order by id");
	$over_receive_limit = !empty($variable_set_invent) ? $variable_set_invent[0][csf('over_rcv_percent')] : 0;

	$allowedQty = $program_qnty;
	$result = ($over_receive_limit / 100) * $allowedQty;
	$allow_total_val = $allowedQty + $result;

	if ($over_receive_limit != '')
	{
		$over_receive_limit = $over_receive_limit;
		$totallow_qty = $allowedQty + $result;
		echo "$('#allowedQty').text('" . number_format($allowedQty, 2, '.', '') . " + " . $over_receive_limit . "%" . " = " . number_format($allow_total_val, 2, '.', '') . "');\n";
		$tot_balance = $allow_total_val - $recv_qnty;
	}
	else
	{
		$over_receive_limit = 0;
		$allowedQty = $program_qnty;
		$tot_balance = $allowedQty - $recv_qnty;
		echo "$('#allowedQty').text('=" . number_format($allowedQty, 2, '.', '') . "');\n";
	}

	//$tot_balance = $allow_total_val - $recv_qnty;
	$txt_title = "Over receive is allowed up to" . ' ' . $over_receive_limit . ' %';
	echo "$('#td_title').attr('title','$txt_title');\n";
	echo "$('#totalProduction').text('" . number_format($recv_qnty, 2, '.', '') . "');\n";
	echo "$('#balance').text('" . number_format($tot_balance, 2, '.', '') . "');\n";
	echo "document.getElementById('allowedQtyTotal').value = '" . number_format($allow_total_val, 2, '.', '') . "';\n";

	echo "document.getElementById('previous_book_plan_production').value 				= '" .$recv_qnty . "';\n";
	echo "document.getElementById('required_qnty').value 				= '" .$program_qnty . "';\n";

	$company_id = $dataArr[1];


	//Load and select Machine
	if($knitting_source==1)
	{
		if ($floor_id == 0 || $floor_id == "") $floor_cond = ""; else $floor_cond = " and floor_id=$floor_id";
		if ($machine_id == 0 || $machine_id == "") $machine_cond = ""; else $machine_cond = " and id in ($machine_id)";

		$machine_td= create_drop_down("cbo_machine_name", 132, "select id, machine_no as machine_name from lib_machine_name where category_id=1 and company_id=$knitting_party and status_active=1 and is_deleted=0 and is_locked=0  $floor_cond $machine_cond order by seq_no", "id,machine_name", 1, "-- Select Machine --", 0, "change_machine(this.value);", ""); //and is_subcon =2
	}
	else
	{
		if ($floor_id == 0 || $floor_id == "") $floor_cond = ""; else $floor_cond = " and floor_id=$floor_id";
		if ($machine_id == 0 || $machine_id == "") $machine_cond = ""; else $machine_cond = " and id in ($machine_id)";

		$machine_td= create_drop_down("cbo_machine_name", 132, "select id, machine_no as machine_name from lib_machine_name where category_id=1 and company_id=$company_id and status_active=1 and is_deleted=0 and is_locked=0  $floor_cond $machine_cond order by seq_no", "id,machine_name", 1, "-- Select Machine --", 0, "change_machine(this.value);", ""); //and is_subcon =2
	}

	echo "document.getElementById('machine_td').innerHTML = '".$machine_td."';\n";
	echo "$('#cbo_machine_name').val(".$machine_id.");\n";

	//Load and select Knitting company
	if ($knitting_source == 1) {
		$knitting_com_td =  create_drop_down("cbo_knitting_company", 152, "select comp.id, comp.company_name from lib_company comp where comp.status_active=1 and comp.is_deleted=0 $company_cond order by comp.company_name", "id,company_name", 1, "--Select Knit Company--", "", "load_location();load_drop_down( \"requires/grey_production_entry_controller_v2\", this.value, \"load_drop_down_floor\", \"prod_floor_td\" );load_drop_down( \"requires/grey_production_entry_controller_v2\", this.value, \"load_drop_machine\", \"machine_td\");", "");
	} else if ($knitting_source == 3) {
		$knitting_com_td = create_drop_down("cbo_knitting_company", 152, "select a.id,a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type=20 and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id,supplier_name", 1, "--Select Knit Company--", 0, "load_location();");
	} else {
		$knitting_com_td = create_drop_down("cbo_knitting_company", 152, $blank_array, "", 1, "--Select Knit Company--", 0, "load_location();");
	}
		
	
	echo "document.getElementById('knitting_com').innerHTML = '".$knitting_com_td."';\n";
	echo "$('#cbo_knitting_company').val(".$knitting_party.");\n";

	// //Load and select Knitting location 
	/*$location_td = create_drop_down("cbo_location_name", 152, "select id,location_name from lib_location where company_id='$company_id' $location_credential_cond and status_active =1 and is_deleted=0 order by location_name", "id,location_name", 1, "-- Select Location --", 0, "load_floor();store_load(this.value);");
	echo "document.getElementById('location_td').innerHTML = '".$location_td."';\n";*/

	if ($knitting_source == 1) {
		$location_td = create_drop_down("cbo_location_name", 152, "select id,location_name from lib_location where company_id='$knitting_party' $location_credential_cond and status_active =1 and is_deleted=0 order by location_name", "id,location_name", 1, "-- Select Location --", 0, "load_floor();store_load(this.value);");
		echo "document.getElementById('location_td').innerHTML = '".$location_td."';\n";
		echo "$('#cbo_location_name').val('".$location_id."');\n";
	}

	// //Load and select production floor
	if($knitting_source==1)
	{
		if ($machine_id == 0 || $machine_id == "") $machine_cond = ""; else $machine_cond = " and b.id in ($machine_id)";
		//if ($location_id == 0 || $location_id == "") $location_cond = ""; else $location_cond = " and b.location_id=$location_id";
		$prod_floor_td= create_drop_down("cbo_floor_id", 132, "select a.id, a.floor_name from lib_prod_floor a, lib_machine_name b where a.id=b.floor_id and b.category_id=1 and b.company_id=$knitting_party and b.status_active=1 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and a.production_process=2 $location_cond $machine_cond group by a.id, a.floor_name order by a.floor_name", "id,floor_name", 1, "-- Select Floor --", 0, "load_machine();", "");
	}
	else
	{
		if ($machine_id == 0 || $machine_id == "") $machine_cond = ""; else $machine_cond = " and b.id in ($machine_id)";
		//if ($location_id == 0 || $location_id == "") $location_cond = ""; else $location_cond = " and b.location_id=$location_id";
		$prod_floor_td= create_drop_down("cbo_floor_id", 132, "select a.id, a.floor_name from lib_prod_floor a, lib_machine_name b where a.id=b.floor_id and b.category_id=1 and b.company_id=$company_id and b.status_active=1 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and a.production_process=2 $location_cond $machine_cond group by a.id, a.floor_name order by a.floor_name", "id,floor_name", 1, "-- Select Floor --", 0, "load_machine();", "");
	}
	echo "document.getElementById('prod_floor_td').innerHTML = '".$prod_floor_td."';\n";

	$machine_floor_arr = return_library_array("select id, floor_id from lib_machine_name where status_active=1", "id", "floor_id");
	$production_floor = $machine_floor_arr[$machine_id];
	echo "$('#cbo_floor_id').val('".$production_floor."');\n";

	// //Outbound machine load
	if($knitting_source ==3)
	{
		$machine_td = create_drop_down("cbo_machine_name", 132, "select id, machine_no as machine_name from lib_machine_name where category_id=1 and company_id=$company_id and status_active=1 and is_deleted=0 and is_locked=0 and is_subcon =1 order by seq_no", "id,machine_name", 1, "-- Select Machine --", 0, "change_machine(this.value);", "");
		echo "document.getElementById('machine_td').innerHTML = '".$machine_td."';\n";
		echo "$('#cbo_location_name').val(0);\n";
		echo "$('#cbo_location_name').attr('disabled','disabled');\n";
	}
}

if ($action == 'populate_data_from_service_booking') {
	//echo $data;die;
	$data = explode("**", $data);
	$booking_no = $data[0];
	$without_order = $data[1];
	$supplier_id = $data[2];
	$company_id = $data[3];
	$knitting_source = $data[4];

	if ($supplier_id != 0) $supplier_cond = "and a.knitting_company=$supplier_id"; else $supplier_cond = "";
	$booking_arr = array();
	if ($without_order == 0) {
		$sql_chk_prog_no = sql_select("select program_no from wo_booking_dtls where booking_no='$booking_no' group by program_no");
		$row_prog = "";
		foreach ($sql_chk_prog_no as $row_prog) {
			$row_prog = $row_prog[csf('program_no')];
		}

		$sql_chk_prog_no_2 = sql_select("select id,program_qnty from ppl_planning_info_entry_dtls where id='$row_prog' group by id");
		$row_prog_2 = "";
		foreach ($sql_chk_prog_no_2 as $row_prog_2) {
			$row_prog_2 = $row_prog_2[csf('id')];
		}

		if ($row_prog_2 != "") {
			$sql = "select a.program_no,a.booking_no, sum(a.wo_qnty) as qnty from wo_booking_dtls a, wo_pre_cost_fab_conv_cost_dtls c, wo_pre_cost_fabric_cost_dtls b,ppl_planning_info_entry_dtls d where a.pre_cost_fabric_cost_dtls_id=c.id and c.fabric_description=b.id and a.booking_no='$booking_no' and a.job_no=b.job_no and a.status_active=1 and a.is_deleted=0 and a.program_no=d.id  group by a.program_no,a.booking_no"; //new

		} else {
			$sql = "select a.booking_no,a.wo_qnty as qnty from wo_booking_dtls a, wo_pre_cost_fab_conv_cost_dtls c, wo_pre_cost_fabric_cost_dtls b where a.pre_cost_fabric_cost_dtls_id=c.id and c.fabric_description=b.id and a.booking_no='$booking_no' and a.job_no=b.job_no and a.status_active=1 and a.is_deleted=0 "; //old
		}

	} else {
		$sql = "select a.booking_no, b.wo_qty as qnty
		from wo_non_ord_knitdye_booking_mst a, wo_non_ord_knitdye_booking_dtl b, wo_non_ord_samp_booking_dtls c
		where a.id=b.mst_id and b.fab_des_id=c.id and b.fabric_source=1 and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='$booking_no'";

	}

	$book_result = sql_select($sql);
	foreach ($book_result as $row) {
		$booking_arr[$row[csf('booking_no')]] += $row[csf('qnty')];
		$sb_qnty += $row[csf('qnty')];
	}

	//print_r($booking_arr);
	//$over_receive_limit = 0;
	$variable_set_invent = sql_select("select category,over_rcv_status,over_rcv_percent,over_rcv_payment from variable_inv_ile_standard where company_name=$company_id and variable_list=23 and category = 13 order by id");

	$over_receive_limit = !empty($variable_set_invent) ? $variable_set_invent[0][csf('over_rcv_percent')] : 0;

	$receive_arr = array();
	$recv_sql = ("SELECT a.service_booking_no,a.knitting_company as supplier_id, sum(b.grey_receive_qnty) grey_receive_qnty
		FROM inv_receive_master a INNER JOIN pro_grey_prod_entry_dtls b ON a.id = b.mst_id and b.status_active=1 and b.is_deleted=0 WHERE a.service_booking_no ='$booking_no' and a.knitting_source=$knitting_source  $supplier_cond
		GROUP BY a.service_booking_no,a.knitting_company");

	$result = sql_select($recv_sql);

	$grey_receive_qnty = 0;
	if(!empty($result)){

		foreach ($result as $row) {

			$grey_receive_qnty = $row[csf('grey_receive_qnty')];
			$allowedQty = 0;
			$allowedQty = $booking_arr[$row[csf('service_booking_no')]];
			$result = ($over_receive_limit / 100) * $allowedQty;
			$allow_total_val = $allowedQty + $result;

			if ($over_receive_limit>0) {
				$over_receive_limit = $over_receive_limit;
				$totallow_qty = $allowedQty + $result;
				echo "$('#allowedQty').text('" . number_format($allowedQty, 2, '.', '') . " + " . $over_receive_limit . " %" . "=" . number_format($allow_total_val, 2, '.', '') . "');\n";
			} else {
				$over_receive_limit = 0;
				echo "$('#allowedQty').text('=" . number_format($allowedQty, 2, '.', '') . "');\n";
			}

			$tot_balance = $allow_total_val - $grey_receive_qnty;
			$txt_title = "Over receive is allowed up to" . ' ' . $over_receive_limit . ' %';
			echo "$('#td_title').attr('title','$txt_title');\n";
			echo "$('#totalProduction').text('" . number_format($grey_receive_qnty, 2, '.', '') . "');\n";
			echo "$('#balance').text('" . number_format($tot_balance, 2, '.', '') . "');\n";
			echo "document.getElementById('allowedQtyTotal').value 		= '" . number_format($allow_total_val, 2, '.', '') . "';\n";
			//echo "document.getElementById('service_booking_id').value 		= '" . number_format($allow_total_val, 2, '.', '') . "';\n";
		}
	}else{
		$allowedQty = $sb_qnty;
		$result = ($over_receive_limit / 100) * $allowedQty;
		$allow_total_val = $allowedQty + $result;

		if ($over_receive_limit != '') {
			$over_receive_limit = $over_receive_limit;
			$totallow_qty = $allowedQty + $result;
			echo "$('#allowedQty').text('" . number_format($allowedQty, 2, '.', '') . " + " . $over_receive_limit . "%" . " = " . number_format($allow_total_val, 2, '.', '') . "');\n";
			$tot_balance = $allow_total_val;
		} else {
			$over_receive_limit = 0;
			$allowedQty = $sb_qnty;
			$tot_balance = $sb_qnty;
			echo "$('#allowedQty').text('=" . number_format($sb_qnty, 2, '.', '') . "');\n";
		}
		echo "$('#balance').text('" . number_format($tot_balance, 2, '.', '') . "');\n";
		echo "document.getElementById('allowedQtyTotal').value 		= '" . number_format($tot_balance, 2, '.', '') . "';\n";
	}
}

if ($action == 'populate_data_from_booking') {
	//echo $data;die;
	$data = explode("**", $data);
	$booking_id = $data[0];
	$is_sample = $data[1];
	$roll_maintained = $data[2];

	if ($is_sample == 0) {
		$sql = "select booking_no, buyer_id, job_no from wo_booking_mst where id='$booking_id'";
		$sql_prev_production = "select sum(b.grey_receive_qnty) as grey_receive_qnty from inv_receive_master a,  pro_grey_prod_entry_dtls b where a.id=b.mst_id and a.booking_without_order=0 and booking_id=$booking_id and a.receive_basis=1 and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 ";
		$bookingData = sql_select("select sum(b.grey_fab_qnty) as qnty from  wo_booking_mst a, wo_booking_dtls b
			where a.booking_no=b.booking_no and a.booking_type=1 and a.id=$booking_id and a.status_active=1  and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

	} else {
		$sql = "select booking_no, buyer_id, '' as job_no from wo_non_ord_samp_booking_mst where id='$booking_id'";
		$sql_prev_production = "select sum(b.grey_receive_qnty) as grey_receive_qnty from inv_receive_master a,  pro_grey_prod_entry_dtls b where a.id=b.mst_id and a.booking_without_order=1 and booking_id=$booking_id and a.receive_basis=1 and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
		$bookingData = sql_select("select sum(b.grey_fabric) as qnty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b
			where a.booking_no=b.booking_no and a.booking_type=4 and a.id=$booking_id and b.fabric_source=1 and a.status_active=1  and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

	}


	$prev_production_data = sql_select($sql_prev_production);//No Need
	echo "document.getElementById('previous_book_plan_production').value 				= '" . $prev_production_data[0][csf("grey_receive_qnty")] . "';\n";
	echo "document.getElementById('required_qnty').value 				= '" . $bookingData[0][csf("qnty")] . "';\n";


	$data_array = sql_select($sql);
	foreach ($data_array as $row) {
		echo "document.getElementById('txt_booking_no').value 				= '" . $row[csf("booking_no")] . "';\n";
		echo "document.getElementById('txt_booking_no_id').value 			= '" . $booking_id . "';\n";
		echo "document.getElementById('cbo_buyer_name').value 				= '" . $row[csf("buyer_id")] . "';\n";
		echo "document.getElementById('txt_job_no').value 					= '" . $row[csf("job_no")] . "';\n";
		echo "document.getElementById('booking_without_order').value 		= '" . $is_sample . "';\n";

		$yarn_issued = return_field_value("sum(b.cons_quantity) as qnty", "inv_issue_master a, inv_transaction b", "a.id=b.mst_id and a.entry_form=3 and a.item_category=1 and a. 	booking_no='" . $row[csf("booking_no")] . "' and b.item_category=1 and b.transaction_type=2 and a.status_active=1 and a.is_deleted=0", "qnty");

		echo "document.getElementById('txt_yarn_issued').value 				= '" . $yarn_issued . "';\n";

		if ($is_sample == 1 && $roll_maintained == 0) {
			echo "$('#txt_receive_qnty').removeAttr('readonly','readonly');\n";
			echo "$('#txt_receive_qnty').removeAttr('onClick','onClick');\n";
			echo "$('#txt_receive_qnty').removeAttr('placeholder','Single Click');\n";
			echo "$('#txt_coller_cuff_size').attr('disabled',false);\n";


			echo "$('#txt_reject_fabric_recv_qnty').removeAttr('readonly','readonly');\n";
			echo "$('#txt_reject_fabric_recv_qnty').removeAttr('placeholder','Write');\n";
		} else {
			echo "$('#txt_receive_qnty').attr('readonly','readonly');\n";
			echo "$('#txt_receive_qnty').attr('onClick','openmypage_po();');\n";
			echo "$('#txt_receive_qnty').attr('placeholder','Single Click');\n";
			echo "$('#txt_coller_cuff_size').attr('disabled','disabled');\n";
			echo "$('#txt_reject_fabric_recv_qnty').attr('readonly','readonly');\n";
			echo "$('#txt_reject_fabric_recv_qnty').attr('placeholder','Display');\n";
		}
		exit();
	}
}

if ($action == 'show_fabric_desc_listview') {
	$data = explode("**", $data);
	$booking_no = $data[0];
	$is_sample = $data[1];
	$entry_form= $data[2];
	$body_part_type_arr = return_library_array("select id, body_part_type from lib_body_part", 'id', 'body_part_type');
	//$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');

	$composition_arr = array();
	$sql_deter = "select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
	$data_array = sql_select($sql_deter);
	if (count($data_array) > 0) {
		foreach ($data_array as $row) {
			if (array_key_exists($row[csf('id')], $composition_arr)) {
				$composition_arr[$row[csf('id')]] = $composition_arr[$row[csf('id')]] . " " . $composition[$row[csf('copmposition_id')]] . " " . $row[csf('percent')] . "%";
			} else {
				$composition_arr[$row[csf('id')]] = $row[csf('construction')] . ", " . $composition[$row[csf('copmposition_id')]] . " " . $row[csf('percent')] . "%";
			}
		}
	}


	if ($is_sample == 0) {
		$sql = "select b.lib_yarn_count_deter_id, b.body_part_id, b.gsm_weight, a.dia_width, sum(a.grey_fab_qnty) as qnty from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b where a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no='$booking_no' and a.job_no=b.job_no and a.status_active=1 and a.is_deleted=0 group by b.lib_yarn_count_deter_id, b.body_part_id, b.gsm_weight, a.dia_width";
	} else {
		$sql = "select b.lib_yarn_count_deter_id, b.body_part as body_part_id, b.gsm_weight, b.dia_width, b.construction, b.composition,color_type_id,fabric_color, sum(b.grey_fabric) as qnty, b.style_id, b.color_all_data from wo_non_ord_samp_booking_mst a,wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.booking_no='$booking_no' and (a.fabric_source=1 OR b.fabric_source=1) and b.status_active=1 and b.is_deleted=0 and b.grey_fabric>0  group by b.lib_yarn_count_deter_id, b.body_part, b.gsm_weight, b.dia_width, b.construction, b.composition,color_type_id,fabric_color,b.style_id, b.color_all_data";
	}
	//echo $sql;
	$data_array = sql_select($sql);
	foreach ($data_array as $row)
	{
		$style_id_rquisition=$row[csf('style_id')];
	}
	if($is_sample == 1 && $entry_form==140)
	{
		$sql_sampRequisition=sql_select("SELECT a.sample_mst_id,a.sample_name,a.determination_id,a.gmts_item_id,b.color_id,b.contrast,b.qnty,a.fabric_description,a.body_part_id, a.fabric_source,a.gsm,a.dia, a.color_type_id,a.width_dia_id,a.uom_id,b.fabric_color from sample_development_fabric_acc a,sample_development_rf_color b where a.id=b.dtls_id and  a.sample_mst_id=b.mst_id and a.form_type=1 and b.qnty>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.sample_mst_id=$style_id_rquisition and b.mst_id=$style_id_rquisition");

		foreach ($sql_sampRequisition as $row)
		{
			$determination_id_requistion[$row[csf('sample_mst_id')]][$row[csf('body_part_id')]][$row[csf('determination_id')]]["determination_id"]=$row[csf('determination_id')];

			$determination_id_requistion[$row[csf('sample_mst_id')]][$row[csf('body_part_id')]][$row[csf('determination_id')]]["body_part_id"]=$row[csf('body_part_id')];
			$determination_id_requistion[$row[csf('sample_mst_id')]][$row[csf('body_part_id')]][$row[csf('determination_id')]]["fabric_description"]=$row[csf('fabric_description')];
			$determination_id_requistion[$row[csf('sample_mst_id')]][$row[csf('body_part_id')]][$row[csf('determination_id')]]["gsm"]=$row[csf('gsm')];
		}

	}

	?>
	<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="300">
		<thead>
			<th>SL</th>
			<th>Fabric Description</th>
			<th width="60">Qnty</th>
			<!-- <th width="100">Color</th>
			<th width="100">Color Type</th> -->
		</thead>
		<tbody>
			<?
			$i = 1;
			foreach ($data_array as $row) {
				if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";

				$cons_composition = '';

				if ($is_sample == 1 && ($row[csf('lib_yarn_count_deter_id')] == 0 || $row[csf('lib_yarn_count_deter_id')] == "")) {

					$fabric_desc = $body_part[$row[csf('body_part_id')]] . ", " . $row[csf('construction')] . ", " . $row[csf('composition')] . ", " . $row[csf('gsm_weight')];
					$cons_composition = $row[csf('construction')] . ", " . $row[csf('composition')];
				}
				else if ($is_sample == 1 && $entry_form==140)
				{
					if($row[csf('fabric_color')]==0)
					{
						$excolordata=explode("_",$row[csf('color_all_data')]);
						$row[csf('fabric_color')]=$excolordata[8];
					}
					$fabric_desc = $body_part[$row[csf('body_part_id')]] . ", " .  $determination_id_requistion[$row[csf('style_id')]][$row[csf('body_part_id')]][$row[csf('lib_yarn_count_deter_id')]]["fabric_description"]. ", " .$determination_id_requistion[$row[csf('style_id')]][$row[csf('body_part_id')]][$row[csf('lib_yarn_count_deter_id')]]["gsm"];

					$cons_composition = $composition_arr[$determination_id_requistion[$row[csf('style_id')]][$row[csf('body_part_id')]][$row[csf('lib_yarn_count_deter_id')]]["determination_id"]];

				}
				else {
					$fabric_desc = $body_part[$row[csf('body_part_id')]] . ", " . $composition_arr[$row[csf('lib_yarn_count_deter_id')]] . ", " . $row[csf('gsm_weight')];
					$cons_composition = $composition_arr[$row[csf('lib_yarn_count_deter_id')]];
				}

				if ($row[csf('dia_width')] != "") {
					$fabric_desc .= ", " . $row[csf('dia_width')];
				}
				$body_part_type_id=$body_part_type_arr[$row[csf('body_part_id')]];
				?>
				<tr bgcolor="<? echo $bgcolor; ?>"
					onClick='set_form_data("<? echo $row[csf('body_part_id')] . "**" . $cons_composition . "**" . $row[csf('gsm_weight')] . "**" . $row[csf('dia_width')] . "**" . $row[csf('lib_yarn_count_deter_id')]. "**" . $body_part_type_id; ?>")'
					style="cursor:pointer">
					<td><? echo $i; ?></td>
					<td><? echo $fabric_desc; ?></td>
					<td align="right"><? echo number_format($row[csf('qnty')], 2); ?></td>
					<!-- <td><? //echo $color_arr[$row[csf('fabric_color')]]; ?></td>
					<td><? //echo $color_type[$row[csf('color_type_id')]]; ?></td> -->
				</tr>
				<?
				$i++;
			}
			?>
		</tbody>
	</table>
	<?
	exit();
}

/*
|--------------------------------------------------------------------------
| show_fabric_desc_listview_plan
|--------------------------------------------------------------------------
|
*/
if ($action == 'show_fabric_desc_listview_plan') {
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$body_part_type_arr = return_library_array("select id, body_part_type from lib_body_part", 'id', 'body_part_type');

	$count = '';
	$lot = '';
	if ($db_type == 0) {
		$reqsn_dataArray = sql_select("select group_concat(brand) as brand, group_concat(yarn_count_id) as yarn_count_id, group_concat(lot) as lot from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.knit_id=$data");
	} else {
		$reqsn_dataArray = sql_select("select LISTAGG(CAST(brand AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY brand) as brand, LISTAGG(CAST(yarn_count_id AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY yarn_count_id) as yarn_count_id, LISTAGG(CAST(lot AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY lot) as lot from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  and a.knit_id=$data");
	}
	$count = implode(",", array_unique(explode(",", $reqsn_dataArray[0][csf('yarn_count_id')])));
	$lot = implode(",", array_unique(explode(",", $reqsn_dataArray[0][csf('lot')])));
	$brand = implode(",", array_unique(explode(",", $reqsn_dataArray[0][csf('brand')])));

	$sql = "select c.body_part_id, c.determination_id, c.fabric_desc, c.gsm_weight, c.dia, b.fabric_dia, b.color_range, b.stitch_length, b.color_id, b.machine_dia, b.machine_gg from ppl_planning_info_entry_dtls b, ppl_planning_entry_plan_dtls c where b.id=c.dtls_id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.id=$data group by c.body_part_id, c.determination_id, c.fabric_desc, c.gsm_weight, c.dia, b.fabric_dia, b.color_range, b.stitch_length, b.color_id, b.machine_dia, b.machine_gg";
	//echo $sql;
	$data_array = sql_select($sql);

	?>
	<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="300">
		<thead>
			<th>SL</th>
			<th width="70">Body Part</th>
			<th>Fabric Description</th>
		</thead>
		<tbody>
			<?
			$i = 1;
			foreach ($data_array as $row) {
				if ($i % 2 == 0)
					$bgcolor = "#E9F3FF";
				else


					$bgcolor = "#FFFFFF";

				$bgcolor = "#008000";

				$color = '';
				$color_id = explode(",", $row[csf('color_id')]);
				foreach ($color_id as $val) {
					if ($val > 0) $color .= $color_arr[$val] . ",";
				}
				$color = chop($color, ',');
				$body_part_type_id=$body_part_type_arr[$row[csf('body_part_id')]];
				?>
				<tr bgcolor="<? echo $bgcolor; ?>"
					onClick='set_form_data_plan("<? echo $row[csf('body_part_id')] . "**" . $row[csf('fabric_desc')] . "**" . $row[csf('gsm_weight')] . "**" . $row[csf('fabric_dia')] . "**" . $row[csf('determination_id')] . "**" . $row[csf('color_range')] . "**" . $row[csf('stitch_length')] . "**" . $count . "**" . $lot . "**" . $brand_arr[$brand] . "**" . $color . "**" . $row[csf('color_id')] . "**" . $row[csf('machine_dia')] . "**" . $row[csf('machine_gg')]. "**" . $body_part_type_id; ?>")'
					style="cursor:pointer">
					<td><? echo $i; ?></td>
					<td><? echo $body_part[$row[csf('body_part_id')]]; ?></td>
					<td><? echo $row[csf('fabric_desc')]; ?></td>
				</tr>
				<?
				$i++;
			}
			?>
		</tbody>
	</table>
	<?
	exit();
}

if ($action == 'show_fabric_desc_listview_salesOrder') {
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$body_part_type_arr = return_library_array("select id, body_part_type from lib_body_part", 'id', 'body_part_type');
	if ($db_type == 0) {
		$color_fld = "group_concat(color_id) as color_id";
	} else {
		$color_fld = "LISTAGG(color_id, ',') WITHIN GROUP (ORDER BY color_id) as color_id";
	}

	$sql = "select determination_id, fabric_desc, body_part_id, gsm_weight, dia, color_range_id, $color_fld, sum(grey_qty) as qnty from fabric_sales_order_dtls where mst_id='$data' and status_active=1 and is_deleted=0 group by determination_id, fabric_desc, body_part_id, gsm_weight, dia, color_range_id";
	//echo $sql;
	$data_array = sql_select($sql);

	?>
	<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="300">
		<thead>
			<th>SL</th>
			<th width="70">Body Part</th>
			<th>Fabric Description</th>
		</thead>
		<tbody>
			<?
			$i = 1;
			foreach ($data_array as $row) {
				if ($i % 2 == 0)
					$bgcolor = "#E9F3FF";
				else
					$bgcolor = "#FFFFFF";

				$fabric_desc = $row[csf('fabric_desc')] . ", " . $row[csf('gsm_weight')];
				if ($row[csf('dia')] != "") {
					$fabric_desc .= ", " . $row[csf('dia')];
				}

				$color = '';
				$color_id = array_unique(explode(",", $row[csf('color_id')]));
				foreach ($color_id as $val) {
					if ($val > 0) $color .= $color_arr[$val] . ",";
				}
				$color = chop($color, ',');
				$body_part_type_id=$body_part_type_arr[$row[csf('body_part_id')]];
				?>
				<tr bgcolor="<? echo $bgcolor; ?>"
					onClick='set_sales_form_data("<? echo $row[csf('body_part_id')] . "**" . $row[csf('fabric_desc')] . "**" . $row[csf('gsm_weight')] . "**" . $row[csf('dia')] . "**" . $row[csf('determination_id')] . "**" . implode(",", $color_id) . "**" . $color . "**" . $row[csf('color_range_id')]. "**" . $body_part_type_id; ?>")'
					style="cursor:pointer">
					<td><? echo $i; ?></td>
					<td><? echo $body_part[$row[csf('body_part_id')]]; ?></td>
					<td><? echo $fabric_desc; ?></td>
				</tr>
				<?
				$i++;
			}
			?>
		</tbody>
	</table>
	<?
	exit();
}

if ($action == 'show_service_booking_programlist') {
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$body_part_type_arr = return_library_array("select id, body_part_type from lib_body_part", 'id', 'body_part_type');
	$count = '';
	$lot = '';
	$rqsn_arr = array();
	if ($db_type == 0) {
		$reqsn_dataArray = sql_select("select group_concat(brand) as brand, group_concat(yarn_count_id) as yarn_count_id, group_concat(lot) as lot from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.status_active=1 and a.is_deleted=0 and a.knit_id=$data");
	} else {
		$reqsn_dataArray = sql_select("select LISTAGG(CAST(brand AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY brand) as brand, LISTAGG(CAST(yarn_count_id AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY yarn_count_id) as yarn_count_id, LISTAGG(CAST(lot AS VARCHAR2(4000)), ',') WITHIN GROUP (ORDER BY lot) as lot from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.status_active=1 and a.is_deleted=0");
	}
	foreach($reqsn_dataArray as $rqsn_row){
		$rqsn_arr[$rqsn_row[csf("knit_id")]]["brand"] = implode(",", array_unique(explode(",", $rqsn_row[csf("knit_id")])));
		$rqsn_arr[$rqsn_row[csf("knit_id")]]["count"] = implode(",", array_unique(explode(",", $rqsn_row[csf("knit_id")])));
		$rqsn_arr[$rqsn_row[csf("knit_id")]]["lot"] = implode(",", array_unique(explode(",", $rqsn_row[csf("knit_id")])));
	}

	if ($db_type == 0) {
		$color_fld = "group_concat(c.color_id) as color_id";
		$group_by = "b.program_no";
	} else {
		$color_fld = "LISTAGG(c.color_id, ',') WITHIN GROUP (ORDER BY c.color_id) as color_id";
		$group_by = "a.booking_no, b.description,b.program_no,d.fabric_desc,d.gsm_weight,b.dia_width,c.machine_dia,c.machine_gg,c.machine_id,c.spandex_stitch_length,c.color_range,c.color_id,c.stitch_length,c.knitting_source,c.knitting_party,d.buyer_id,d.body_part_id,d.determination_id";
	}
	$sql = "select a.booking_no, b.description,b.program_no,d.fabric_desc,d.gsm_weight,b.dia_width,c.machine_dia,c.machine_gg,c.machine_id,c.spandex_stitch_length,c.color_range,$color_fld,c.stitch_length,c.knitting_source,c.knitting_party,d.buyer_id,d.body_part_id,d.determination_id from wo_booking_mst a,wo_booking_dtls b,ppl_planning_info_entry_dtls c,ppl_planning_info_entry_mst d where a.booking_no=b.booking_no and b.program_no=c.id and c.mst_id=d.id and a.id=$data and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by $group_by";
	$data_array = sql_select($sql);
	?>
	<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="300">
		<thead>
			<th>SL</th>
			<th width="70">Program</th>
			<th width="70">Body Part</th>
			<th>Fabric Description</th>
		</thead>
		<tbody>
			<?
			$i = 1;
			foreach ($data_array as $row) {
				if ($i % 2 == 0)
					$bgcolor = "#E9F3FF";
				else
					$bgcolor = "#FFFFFF";

				$fabric_desc = $row[csf('fabric_desc')] . ", " . $row[csf('gsm_weight')];
				if ($row[csf('dia_width')] != "") {
					$fabric_desc .= ", " . $row[csf('dia_width')];
				}

				$color = '';
				$color_id = array_unique(explode(",", $row[csf('color_id')]));
				foreach ($color_id as $val) {
					if ($val > 0) $color .= $color_arr[$val] . ",";
				}
				$color = chop($color, ',');
				$count = $rqsn_arr[$row[csf('program_no')]]["brand"];
				$lot = $rqsn_arr[$row[csf('program_no')]]["brand"];
				$brand = $brand_arr[$rqsn_arr[$row[csf('program_no')]]["brand"]];
				$body_part_type_id=$body_part_type_arr[$row[csf('body_part_id')]];
				?>
				<tr bgcolor="<? echo $bgcolor; ?>"
					onClick='set_form_data_sb("<? echo $row[csf('body_part_id')] . "**" . $row[csf('fabric_desc')] . "**" . $row[csf('gsm_weight')] . "**" . $row[csf('dia_width')] . "**" . $row[csf('determination_id')] . "**" . $row[csf('color_range')] . "**" . $row[csf('stitch_length')] . "**" . $color . "**" . $row[csf('color_id')] . "**" . $row[csf('machine_dia')] . "**" . $row[csf('machine_gg')]. "**" . $row[csf('program_no')]. "**" . $row[csf('knitting_source')]. "**" . $row[csf('knitting_party')]. "**" . $count. "**" . $lot. "**" . $brand. "**" . $row[csf('buyer_id')]. "**" . $body_part_type_id; ?>")'
					style="cursor:pointer">
					<td><? echo $i; ?></td>
					<td align="center"><? echo $row[csf('program_no')]; ?></td>
					<td><? echo $body_part[$row[csf('body_part_id')]]; ?></td>
					<td><? echo $fabric_desc; ?></td>
				</tr>
				<?
				$i++;
			}
			?>
		</tbody>
	</table>
	<?
	exit();
}

if ($action == "fabricDescription_popup") {
	echo load_html_head_contents("Fabric Description Info", "../../", 1, 1, '', '', '');
	extract($_REQUEST);
	?>

	<script>

		$(document).ready(function (e) {
			setFilterGrid('tbl_list_search', -1);
		});

		function js_set_value(id, comp, gsm) {
			$('#hidden_desc_id').val(id);
			$('#hidden_desc_no').val(comp);
			$('#hidden_gsm').val(gsm);
			parent.emailwindow.hide();
		}

	</script>

</head>

<body>
	<form name="searchdescfrm" id="searchdescfrm">
		<fieldset style="width:720px;margin-left:10px">
			<?
			$composition_arr = array();
			$compositionData = sql_select("select mst_id, copmposition_id, percent from lib_yarn_count_determina_dtls where status_active=1 and is_deleted=0");
			foreach ($compositionData as $row) {
				$composition_arr[$row[csf('mst_id')]] .= $composition[$row[csf('copmposition_id')]] . " " . $row[csf('percent')] . "% ";
			}
			?>
			<input type="hidden" name="hidden_desc_id" id="hidden_desc_id" class="text_boxes" value="">
			<input type="hidden" name="hidden_desc_no" id="hidden_desc_no" class="text_boxes" value="">
			<input type="hidden" name="hidden_gsm" id="hidden_gsm" class="text_boxes" value="">

			<div style="margin-left:10px; margin-top:10px">
				<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="680">
					<thead>
						<th width="50">SL</th>
						<th width="100">Fabric Nature</th>
						<th width="150">Construction</th>
						<th>Composition</th>
						<th width="100">GSM/Weight</th>
					</thead>
				</table>
				<div style="width:700px; max-height:300px; overflow-y:scroll" id="list_container" align="left">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="680"
					id="tbl_list_search">
					<?
					$i = 1;
					$data_array = sql_select("select id, construction, fab_nature_id, gsm_weight from lib_yarn_count_determina_mst where fab_nature_id=2 and status_active=1 and is_deleted=0");
					foreach ($data_array as $row) {
						if ($i % 2 == 0)
							$bgcolor = "#E9F3FF";
						else
							$bgcolor = "#FFFFFF";

							/*if($row[csf('construction')]!="")
							{
                            	$comp=$row[csf('construction')].", ";
							}
                            $determ_sql=sql_select("select copmposition_id, percent from lib_yarn_count_determina_dtls where mst_id=".$row[csf('id')]." and status_active=1 and is_deleted=0");
                            foreach( $determ_sql as $d_row )
                            {
                                $comp.=$composition[$d_row[csf('copmposition_id')]]." ".$d_row[csf('percent')]."% ";
                            }*/
                            if ($row[csf('construction')] != "") {
                            	$comp = $row[csf('construction')] . ", ";
                            }
                            $comp .= $composition_arr[$row[csf('id')]];

                            ?>
                            <tr bgcolor="<? echo $bgcolor; ?>"
                            	onClick="js_set_value(<? echo $row[csf('id')]; ?>,'<? echo $comp; ?>','<? echo $row[csf('gsm_weight')]; ?>')"
                            	style="cursor:pointer">
                            	<td width="50"><? echo $i; ?></td>
                            	<td width="100"><? echo $item_category[$row[csf('fab_nature_id')]]; ?></td>
                            	<td width="150"><p><? echo $row[csf('construction')]; ?></p></td>
                            	<td><p><? echo $comp; ?></p></td>
                            	<td width="100"><? echo $row[csf('gsm_weight')]; ?></td>
                            </tr>
                            <?
                            $i++;
                        }
                        ?>
                    </table>
                </div>
            </div>
        </fieldset>
    </form>
</body>
<script src="../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if ($action == "po_popup")
{
	echo load_html_head_contents("PO Info", "../../", 1, 1, '', '', '');
	extract($_REQUEST);

	$data = explode("_", $data);
	$po_id = $data[0];
	$type = $data[1];
	//echo $booking_without_order;
	//echo "**".$type;die;

	$max_roll_weight = return_field_value("max_roll_weight", "variable_settings_production", "status_active=1 and company_name=$cbo_company_id and variable_list=49");

	//if ($receive_basis == 0 || $receive_basis == 2) {
	if ($receive_basis == 0) {
		$booking_without_order = 0;
	}

	$is_salesOrder = 0;
	if ($receive_basis == 4)
	{
		$is_salesOrder = 1;
	}
	else if ($receive_basis == 2)
	{
		$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=$booking_id");
		if ($is_salesOrder == "")
			$is_salesOrder = 0;
	}

	if ($type == 1) {
		$dtls_id = $data[2];
		$roll_maintained = $data[3];
		$save_data = $data[4];
		$prev_distribution_method = $data[5];
		$receive_basis = $data[6];
		$txt_deleted_id = $data[7];
		$txt_reject_fabric_recv_qnty = $data[8];
		$production_control = $data[9];
		$cbo_body_part = $data[10];
		$booking_without_order = 0;

	}
	//$cbo_body_part=503;
	//echo $cbo_body_part.'ddd';
	$recv_qnty_array = array();
	if ($receive_basis == 1 || $receive_basis == 2 || $receive_basis == 4)
	{
		if ($booking_without_order == 1 && $receive_basis == 1)
		{
			if ($dtls_id == "") $dtls_id_cond = ""; else $dtls_id_cond = "and b.id<>$dtls_id";
			$recvData = sql_select("select sum(b.grey_receive_qnty) as grey_prod_qnty from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and a.booking_no='$booking_no' and a.booking_without_order=1 and b.febric_description_id='$fabric_desc_id' and b.gsm='$txt_gsm' and b.width='$txt_width' and b.body_part_id='$cbo_body_part' and a.entry_form=2 and b.is_deleted=0 and b.status_active=1 $dtls_id_cond");
			$recv_qnty = $recvData[0][csf('grey_prod_qnty')];
		}
		else
		{
			if ($dtls_id == "") $dtls_id_cond = ""; else $dtls_id_cond = "and a.dtls_id<>$dtls_id";
			$recvData = sql_select("select a.po_breakdown_id, sum(quantity) as grey_prod_qnty from order_wise_pro_details a, pro_grey_prod_entry_dtls b where a.dtls_id=b.id and a.prod_id=b.prod_id and b.febric_description_id='$fabric_desc_id' and b.gsm='$txt_gsm' and b.width='$txt_width' and b.body_part_id='$cbo_body_part' and a.entry_form=2 and a.is_deleted=0 and a.status_active=1 and a.is_sales=$is_salesOrder $dtls_id_cond group by a.po_breakdown_id");
			/*echo "select a.po_breakdown_id, sum(quantity) as grey_prod_qnty from order_wise_pro_details a, pro_grey_prod_entry_dtls b where a.dtls_id=b.id and a.prod_id=b.prod_id and b.febric_description_id='$fabric_desc_id' and b.gsm='$txt_gsm' and b.width='$txt_width' and b.body_part_id='$cbo_body_part' and a.entry_form=2 and a.is_deleted=0 and a.status_active=1 and a.is_sales=$is_salesOrder $dtls_id_cond group by a.po_breakdown_id";*/
			foreach ($recvData as $row)
			{
				$recv_qnty_array[$row[csf('po_breakdown_id')]] = $row[csf('grey_prod_qnty')];
			}
		}
	}

	if ($production_control == 1)
	{
		$yarn_balance_qty_arr = array();

		if ($dtls_id == "") $dtls_id_cond2 = ""; else $dtls_id_cond2 = "and dtls_id<>$dtls_id";
		if($receive_basis==2)
		{
			$yarn_issue_sql = sql_select("select distinct (d.id), (d.quantity) as issue_qnty,c.id as issue_id, d.po_breakdown_id from ppl_yarn_requisition_entry a, inv_transaction b, inv_issue_master c, order_wise_pro_details d where a.requisition_no= b.requisition_no and b.item_category =1 and b.transaction_type =2 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted =0 and d.status_active =1 and d.is_deleted = 0 and b.company_id = $cbo_company_id and  a.knit_id=$booking_id and b.mst_id = c.id and c.entry_form =3 and c.issue_basis in (3,8) and b.receive_basis in (3,8) and b.id=d.trans_id and d.entry_form =3 ");

			$yarn_issue_qnty=0; $yarn_issue_return_qnty =0;
			foreach ($yarn_issue_sql as $val)
			{
				$yarn_issue_qnty_arr[$val[csf('po_breakdown_id')]] += $val[csf("issue_qnty")];
				$yarn_balance_qty_arr[$val[csf('po_breakdown_id')]] += $val[csf("issue_qnty")];
				$yarn_issue_id_arr[$val[csf("issue_id")]] = $val[csf("issue_id")];
			}

			$yarn_issue_id_arr =array_filter($yarn_issue_id_arr);

			if(count($yarn_issue_id_arr)>0)
			{
				$yarn_issue_ids = implode(",", $yarn_issue_id_arr);
				$all_yarn_issue_cond=""; $barCond="";
				if($db_type==2 && count($yarn_issue_id_arr)>999)
				{
					$yarn_issue_id_arr_chunk=array_chunk($yarn_issue_id_arr,999) ;
					foreach($yarn_issue_id_arr_chunk as $chunk_arr)
					{
						$chunk_arr_value=implode(",",$chunk_arr);
						$issCond.="  a.issue_id in($chunk_arr_value) or ";
					}
					$all_yarn_issue_cond.=" and (".chop($issCond,'or ').")";
				}
				else
				{
					$all_yarn_issue_cond=" and a.issue_id in($yarn_issue_ids)";
				}

				$yarn_issue_return_sql = sql_select("select d.id, d.quantity, d.po_breakdown_id from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c, order_wise_pro_details d where a.id = b.mst_id and a.entry_form =  9 and a.receive_basis = 3 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_id = c.requisition_no and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.id = d.trans_id and d.entry_form =9 and b.status_active=1 and c.status_active=1 and d.status_active=1 group by d.id, d.quantity, d.po_breakdown_id
					union all
					select d.id, d.quantity, d.po_breakdown_id 
					from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c, order_wise_pro_details d 
					where a.id=b.mst_id and a.entry_form =9 and a.receive_basis =8 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_no=c.requisition_no and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.id=d.trans_id and d.entry_form =9 and b.status_active=1 and c.status_active=1 and d.status_active=1 group by d.id, d.quantity, d.po_breakdown_id ");

				foreach ($yarn_issue_return_sql as $val)
				{
					$yarn_balance_qty_arr[$val[csf('po_breakdown_id')]] -= $val[csf("quantity")];
					$yarn_issue_return_qnty_arr[$val[csf('po_breakdown_id')]] += $val[csf("quantity")];
				}
			}

			$prod_qnty_arr = sql_select("select c.quantity, c.po_breakdown_id,b.id from inv_receive_master a, pro_grey_prod_entry_dtls b, order_wise_pro_details c where a.id =b.mst_id and b.id = c.dtls_id and a.receive_basis =2 and a.entry_form =2 and c.entry_form =2 and a.booking_id = $booking_id and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted =0 and c.status_active =1 and c.is_deleted=0 and a.company_id= $cbo_company_id");


			$production_qnty=0;
			foreach ($prod_qnty_arr as $val)
			{
				$production_qnty += $val[csf("quantity")];
				$yarn_balance_qty_arr[$val[csf('po_breakdown_id')]] -= $val[csf("quantity")];
				$this_challan_rcv[$val[csf('id')]][$val[csf('po_breakdown_id')]] += $val[csf("quantity")];
				$grey_production_qnty_arr[$val[csf('po_breakdown_id')]] += $val[csf("quantity")];
			}
		}
		else
		{
			$sqlControl = "select po_breakdown_id,
			sum(CASE WHEN entry_form ='3' THEN quantity ELSE 0 END) AS issue_qnty,
			sum(CASE WHEN entry_form ='9' THEN quantity ELSE 0 END) AS return_qnty,
			sum(CASE WHEN entry_form ='11' and trans_type=6 THEN quantity ELSE 0 END) AS transfer_out_qnty,
			sum(CASE WHEN entry_form ='11' and trans_type=5 THEN quantity ELSE 0 END) AS transfer_in_qnty,
			sum(CASE WHEN entry_form=2 $dtls_id_cond2 THEN quantity ELSE 0 END) AS knit_qnty
			from order_wise_pro_details where status_active=1 and is_deleted=0 group by po_breakdown_id";
			$dataArray = sql_select($sqlControl);

			foreach ($dataArray as $row) {
				$yarn_balance_qty_arr[$row[csf('po_breakdown_id')]] = $row[csf('issue_qnty')] - $row[csf('return_qnty')] + $row[csf('transfer_in_qnty')] - $row[csf('transfer_out_qnty')] - $row[csf('knit_qnty')];


				$yarn_issue_qnty_arr[$row[csf('po_breakdown_id')]] += $row[csf("issue_qnty")];
				$grey_production_qnty_arr[$row[csf('po_breakdown_id')]] += $row[csf("knit_qnty")];
				$yarn_issue_return_qnty_arr[$row[csf('po_breakdown_id')]] += $row[csf("return_qnty")];

				$this_challan_rcv[$dtls_id][$row[csf('po_breakdown_id')]] += $row[csf("knit_qnty")];
			}
		}

		unset($dataArray);
		//print_r($yarn_balance_qty_arr);


		$over_production_percentage= return_field_value("distribute_qnty","variable_settings_production","company_name ='$cbo_company_id' and variable_list=51 and item_category_id=1 and is_deleted=0 and status_active=1");
		$over_production_percentage = $over_production_percentage*1;
	}

	if ($roll_maintained == 1) {
		$width = "1020";
		
	}
	else $width = "930";

	$body_part_type=return_library_array("select id, body_part_type from lib_body_part where status_active=1",'id','body_part_type');
	//echo $cbo_body_part;
	//echo $body_part_type[$cbo_body_part];die;
	if($body_part_type[$cbo_body_part] == 40 || $body_part_type[$cbo_body_part] == 50){
		$disable_td = "";
	} else {
		$disable_td = "disabled";
	}
	//echo $fabric_store_auto_update.test;die;

	/*if ($cbo_body_part == 2 || $cbo_body_part == 3 || $cbo_body_part == 133 || $cbo_body_part == 197 || $cbo_body_part == 285 || $cbo_body_part == 203 || $cbo_body_part == 212 || $cbo_body_part == 266) {*/
	?>
	<script>
		var receive_basis =<? echo $receive_basis; ?>;
		var roll_maintained =<? echo $roll_maintained; ?>;
		var barcode_generation =<? echo $barcode_generation; ?>;
		var production_control =<? echo $production_control; ?>;
		//var fabric_store_auto_update ='<?// echo $fabric_store_auto_update;?>';
		//var store_update_upto =<?//  echo $store_update_upto;?>;
		//alert(roll_maintained + "=" + fabric_store_auto_update + "=" + store_update_upto);return;

		function fn_check_max_roll_weight(inpurId){
			var inpurWeigh =$('#'+inpurId).val()*1;
			var max_roll_weight =<? echo $max_roll_weight*1; ?>;
			if(inpurWeigh > max_roll_weight && max_roll_weight>0 ){
				alert(" Maximum Roll Weight Not Allow.\n You can change this weight qty from library.\n Maxamum allowed Weight "+max_roll_weight);
				$('#'+inpurId).val('');
			}
		}


		function fn_show_check() {
			if (form_validation('cbo_buyer_name', 'Buyer Name') == false) {
				return;
			}
			show_list_view(document.getElementById('txt_search_common').value + '_' + document.getElementById('cbo_search_by').value + '_<? echo $cbo_company_id; ?>_' + document.getElementById('cbo_buyer_name').value + '_' + '<? echo $all_po_id; ?>' + '_' + '<? echo $cbo_body_part; ?>', 'create_po_search_list_view', 'search_div', 'grey_production_entry_controller_v2', 'setFilterGrid(\'tbl_list_search\',-1);hidden_field_reset();');
			set_all();
		}

		function distribute_qnty(str) {
			if (str == 1) {
				$('#txt_prop_grey_qnty').attr('disabled', false);
				var txt_prop_grey_qnty = $('#txt_prop_grey_qnty').val() * 1;
				var over_production_percentage = $('#over_production_percentage').val() * 1;
				var tblRow = $("#tbl_list_search tr").length;
				var balance = txt_prop_grey_qnty;
				var len = totalGrey = 0;

				if (production_control == 1 && txt_prop_grey_qnty > 0) {
					var tot_yarn_bl_qty = 0;
					$("#tbl_list_search").find('tr').each(function () {
						var balance_qty = $(this).find('input[name="balanceQty[]"]').val();
						tot_yarn_bl_qty = tot_yarn_bl_qty * 1 + balance_qty * 1;
					});

					//tot_yarn_bl_qty = (tot_yarn_bl_qty*over_production_percentage/100) + tot_yarn_bl_qty;

					if (txt_prop_grey_qnty > tot_yarn_bl_qty) 
					{
						alert("Total Grey Qty Exceeds Total Yarn Balance Qty;\nyarn balance with over %: "+tot_yarn_bl_qty);
						$('#txt_prop_grey_qnty').val('');

						$("#tbl_list_search").find('tr').each(function () {
							$(this).find('input[name="txtGreyQnty[]"]').val('');
						});
						calculate_tot_qnty();
						return;
					}
				}

				$("#tbl_list_search").find('tr').each(function () {
					len = len + 1;

					var txtOrginal = $(this).find('input[name="txtOrginal[]"]').val() * 1;
					var isDisbled = $(this).find('input[name="txtGreyQnty[]"]').is(":disabled");
					var placeholder_value = $(this).find('input[name="txtGreyQnty[]"]').attr('placeholder') * 1;

					if (txtOrginal == 0) {
						$(this).remove();
					}
					else if (isDisbled == false && txtOrginal == 1) 
					{
						if (balance > 0) {
							if (placeholder_value < 0) placeholder_value = 0;
							if (balance > placeholder_value) {
								var grey_qnty = placeholder_value;
								balance = balance - placeholder_value;
							}
							else {
								var grey_qnty = balance;
								balance = 0;
							}

							if (tblRow == len) {
								var grey_qnty = txt_prop_grey_qnty - totalGrey;
							}

							totalGrey = totalGrey * 1 + grey_qnty * 1;

							$(this).find('input[name="txtGreyQnty[]"]').val(grey_qnty.toFixed(2));
						}
						else {
							$(this).find('input[name="txtGreyQnty[]"]').val('');
						}
					}
				});
			}
			else {
				$('#txt_prop_grey_qnty').val('');
				$('#txt_prop_grey_qnty').attr('disabled', true);

				$("#tbl_list_search").find('tr').each(function () {
					if ($(this).find('input[name="txtGreyQnty[]"]').is(":disabled") == false) {
						$(this).find('input[name="txtGreyQnty[]"]').val('');
					}
				});
			}

			calculate_tot_qnty();
		}

		/*
			function distribute_qnty(str)
			{
			if(str==1)
			{
			var tot_po_qnty=$('#tot_po_qnty').val()*1;
			var txt_prop_grey_qnty=$('#txt_prop_grey_qnty').val()*1;
			var tblRow = $("#tbl_list_search tr").length;
			var len=totalGrey=0;

			$("#tbl_list_search").find('tr').each(function()
			{
			len=len+1;

			var txtOrginal=$(this).find('input[name="txtOrginal[]"]').val()*1;
			var isDisbled=$(this).find('input[name="txtGreyQnty[]"]').is(":disabled");

			if(txtOrginal==0)
			{
			$(this).remove();
			}
			else if(isDisbled==false && txtOrginal==1)
			{
			var po_qnty=$(this).find('input[name="txtPoQnty[]"]').val()*1;
			var perc=(po_qnty/tot_po_qnty)*100;

			var grey_qnty=(perc*txt_prop_grey_qnty)/100;
			totalGrey = totalGrey*1+grey_qnty*1;
			totalGrey = totalGrey.toFixed(2);

			if(tblRow==len)
			{
			var balance = txt_prop_grey_qnty-totalGrey;
			if(balance!=0) grey_qnty=grey_qnty+(balance);
			}

			$(this).find('input[name="txtGreyQnty[]"]').val(grey_qnty.toFixed(2));
			}
			});
			}
			else
			{
			$('#txt_prop_grey_qnty').val('');
			$("#tbl_list_search").find('tr').each(function()
			{
			if($(this).find('input[name="txtGreyQnty[]"]').is(":disabled")==false)
			{
			$(this).find('input[name="txtGreyQnty[]"]').val('');
			}
			});
			}
			}
		*/

		function roll_duplication_check(row_id)
		{
			var row_num = $('#tbl_list_search tr').length;
			var po_id = $('#txtPoId_' + row_id).val();
			var roll_no = $('#txtRoll_' + row_id).val();

			if (roll_no * 1 > 0) {
				for (var j = 1; j <= row_num; j++) {
					if (j == row_id) {
						continue;
					}
					else {
						var po_id_check = $('#txtPoId_' + j).val();
						var roll_no_check = $('#txtRoll_' + j).val();

						if (po_id == po_id_check && roll_no == roll_no_check) {
							alert("Duplicate Roll No.");
							$('#txtRoll_' + row_id).val('');
							return;
						}
					}
				}

				var txtRollTableId = $('#txtRollTableId_' + row_id).val();
				var data = po_id + "**" + roll_no + "**" + txtRollTableId;
				var response = return_global_ajax_value(data, 'roll_duplication_check', '', 'grey_production_entry_controller_v2');
				var response = response.split("_");

				if (response[0] != 0) {
					var po_number = $('#tr_' + row_id).find('td:first').text();
					alert("This Roll Already Used. Duplicate Not Allowed");
					$('#txtRoll_' + row_id).val('');
					return;
				}
			}
		}

		function add_break_down_tr(i)
		{
			var cbo_distribiution_method = $('#cbo_distribiution_method').val();

			if (cbo_distribiution_method == 2 )
			{
			//var row_num=$('#tbl_list_search tr').length;
			var row_num = $('#txt_tot_row').val();
			row_num++;

			var clone = $("#tr_" + i).clone();
			clone.attr({
				id: "tr_" + row_num,
			});

			clone.find("input,select").each(function () {

				$(this).attr({
					'id': function (_, id) {
						var id = id.split("_");
						return id[0] + "_" + row_num
					},
					'name': function (_, name) {
						return name
					},
					'value': function (_, value) {
						return value
					}
				});

			}).end();

			//$('#req_qnty_'+

			$("#tr_" + i).after(clone);

			$('#txtOrginal_' + row_num).removeAttr("value").attr("value", "0");

			$('#txtRoll_' + row_num).removeAttr("value").attr("value", "");
			$('#txtGreyQnty_' + row_num).removeAttr("value").attr("value", "");
			$('#txtGreyQntyPcs_' + row_num).removeAttr("value").attr("value", "");

			$('#txtRejectQnty_' + row_num).removeAttr("value").attr("value", "");
			$('#txtRoll_' + row_num).removeAttr("onBlur").attr("onBlur", "roll_duplication_check(" + row_num + ");");
			$('#txtGreyQnty_' + row_num).removeAttr("onKeyUp").attr("onKeyUp", "fn_check_balance(" + row_num + ");calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_"+ row_num +"');");
			$('#txtGreyQntyPcs_' + row_num).removeAttr("onKeyUp").attr("onKeyUp", "fn_check_balance(" + row_num + ");calculate_tot_qnty();");
			
			$('#txtGreyQnty_' + row_num).removeAttr("onclick").attr("onclick", "get_weight_from_weight_machine(" + row_num + ");");
			$('#txtCollerCuffSize_' + row_num).removeAttr("ondblclick").attr("ondblclick", "func_onDblClick_finishSize(" + row_num + ");");
			
			//$('#txtCollerCuffSize_' + row_num).removeAttr("onKeyUp").attr("onKeyUp", "calculate_tot_qnty();");
			$('#txtRollTableId_' + row_num).val('');
			$('#txtBarcodeNo_' + row_num).val('');
			$('#txtRFId_' + row_num).val('');
			// $('#txtCollerCuffSize_' + row_num).val('');

			$('#increase_' + row_num).removeAttr("value").attr("value", "+");
			$('#decrease_' + row_num).removeAttr("value").attr("value", "-");
			$('#increase_' + row_num).removeAttr("onclick").attr("onclick", "add_break_down_tr(" + row_num + ");");
			$('#decrease_' + row_num).removeAttr("onclick").attr("onclick", "fn_deleteRow(" + row_num + ");");


			$('#txtGreyQnty_' + row_num).removeAttr("disabled");

			$('#txtRejectQnty_' + row_num).removeAttr("disabled");

			$('#txt_tot_row').val(row_num);
			set_all_onclick();
			}
		}

		function fn_deleteRow(rowNo) {
			var cbo_distribiution_method = $('#cbo_distribiution_method').val();

			if (cbo_distribiution_method == 2) {
				var txtOrginal = $('#txtOrginal_' + rowNo).val() * 1;
				var txtBarcodeNo = $('#txtBarcodeNo_' + rowNo).val();
				var txtRollId = $('#txtRollTableId_' + rowNo).val();
				var txt_deleted_id = $('#hide_deleted_id').val();
				var selected_id = '';
				if (txtOrginal == 0) {
					if (txtBarcodeNo != '') {
						if (txt_deleted_id == '') selected_id = txtRollId; else selected_id = txt_deleted_id + ',' + txtRollId;
						$('#hide_deleted_id').val(selected_id);
					}

					$("#tr_" + rowNo).remove();
				}
			}

			calculate_tot_qnty();
		}

		function fn_check_balance(rowNo)
		{
			if (production_control == 1)
			{
				var greyQty = '';
				var greyQtyPcs = '';
				if (roll_maintained == 1) 
				{
					var row_num = $('#tbl_list_search tr').length;
					var po_id = $('#txtPoId_' + rowNo).val();

					/*for (var j = 1; j <= row_num; j++) {
						var po_id_check = $('#txtPoId_' + j).val();
						if (po_id == po_id_check) {
							greyQty = greyQty * 1 + $('#txtGreyQnty_' + j).val() * 1;
							greyQtyPcs = greyQtyPcs * 1 + $('#txtGreyQntyPcs_' + j).val() * 1;
						}
					}*/

					$("#tbl_list_search").find('tbody tr').each(function()
					{
						var po_id_check=$(this).find('input[name="txtPoId[]"]').val();
						if(po_id == po_id_check)
						{
							greyQty= greyQty *1 + $(this).find('input[name="txtGreyQnty[]"]').val() * 1;
							greyQtyPcs = greyQtyPcs * 1 + $(this).find('input[name="txtGreyQntyPcs[]"]').val() * 1;
						}
					});
				}
				else 
				{
					greyQty = $('#txtGreyQnty_' + rowNo).val() * 1;
					greyQtyPcs = $('#txtGreyQntyPcs_' + rowNo).val() * 1;
				}

				var balanceQty = $('#balanceQty_' + rowNo).val() * 1;
				//var over_production_percentage = $('#over_production_percentage').val() * 1;
				//balanceQty = (balanceQty*over_production_percentage/100) + balanceQty;
				if (greyQty > balanceQty) {
					alert("QC Pass Qty. Exceeds Yarn Issued Qty.");
					$('#txtGreyQnty_' + rowNo).val('');
					return;
				}
			}
			var txtQcBarcode=0; var txtBarcodeNo=0;
			if (roll_maintained == 1) 
			{
				var txtQcBarcode = $('#txtQcBarcode_' + rowNo).val()*1;
				var txtBarcodeNo = $('#txtBarcodeNo_' + rowNo).val()*1;
				var txyPreQCPassQty = $('#preQCPassQty_' + rowNo).val()*1;
				// alert(txtQcBarcode+'='+txtBarcodeNo);
				if (txtQcBarcode == txtBarcodeNo && txtQcBarcode!=0) 
				{
					alert("This roll already QC, quantity change not allowed.");
					$('#txtGreyQnty_' + rowNo).val('');
					$('#txtGreyQnty_' + rowNo).val(txyPreQCPassQty);
					return;
				}
			}
		}

		function calculate_tot_qnty() 
		{
			var tot_grey_qnty = '';
			var tot_reject_qnty = '';
			var tot_grey_qnty_pcs = '';
			//var tot_size_qty = '';

			$("#tbl_list_search").find('tr').each(function () {
				var txtGreyQnty = $(this).find('input[name="txtGreyQnty[]"]').val() * 1;
				tot_grey_qnty = tot_grey_qnty * 1 + txtGreyQnty * 1;

				var txtGreyQnty_pcs = $(this).find('input[name="txtGreyQntyPcs[]"]').val() * 1;
				tot_grey_qnty_pcs = tot_grey_qnty_pcs * 1 + txtGreyQnty_pcs * 1;

				var txtRejectQnty = $(this).find('input[name="txtRejectQnty[]"]').val() * 1;
				tot_reject_qnty = tot_reject_qnty * 1 + txtRejectQnty * 1;

				//var txtCollerCuffSize = $(this).find('input[name="txtCollerCuffSize[]"]').val() * 1;
				//alert(txtCollerCuffSize)
				//tot_size_qty = tot_size_qty * 1 + txtCollerCuffSize * 1;
			});
			//alert(tot_grey_qnty_pcs);
			$('#txt_tot_grey_qnty').val(tot_grey_qnty.toFixed(2));
			$('#txt_tot_grey_qnty_pcs').val(tot_grey_qnty_pcs.toFixed(2));
			$('#txt_tot_reject_qnty').val(tot_reject_qnty.toFixed(2));
			//$('#txt_tot_size_qty').val(tot_size_qty.toFixed(2));
		}

		var selected_id = new Array();

		function check_all_data() {
			var tbl_row_count = document.getElementById('tbl_list_search').rows.length;

			tbl_row_count = tbl_row_count - 1;
			for (var i = 1; i <= tbl_row_count; i++) {
				js_set_value(i, 1);
			}
		}

		function toggle(x, origColor) {
			var newColor = 'yellow';
			if (x.style) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor ) ? origColor : newColor;
			}
		}

		function set_all() {
			var old = document.getElementById('txt_po_row_id').value;
			if (old != "") {
				old = old.split(",");
				for (var i = 0; i < old.length; i++) {
					js_set_value(old[i], 0)
				}
			}
		}

		function js_set_value(str, check_or_not) {
			if (check_or_not == 1) {
				var roll_used = $('#roll_used' + str).val();
				if (roll_used == 1) {
					var po_number = $('#search' + str).find("td:eq(3)").text();
					alert("Batch Roll Found Against PO- " + po_number);
					return;
				}
			}

			toggle(document.getElementById('search' + str), '#FFFFCC');

			if (jQuery.inArray($('#txt_individual_id' + str).val(), selected_id) == -1) {
				selected_id.push($('#txt_individual_id' + str).val());

			}
			else {
				for (var i = 0; i < selected_id.length; i++) {
					if (selected_id[i] == $('#txt_individual_id' + str).val()) break;
				}
				selected_id.splice(i, 1);
			}
			var id = '';
			for (var i = 0; i < selected_id.length; i++) {
				id += selected_id[i] + ',';
			}
			id = id.substr(0, id.length - 1);

			$('#po_id').val(id);
		}

		function show_grey_prod_recv() {
			var po_id = $('#po_id').val();
			show_list_view(po_id + '_' + '1' + '_' + '<? echo $dtls_id; ?>' + '_' + '<? echo $roll_maintained; ?>' + '_' + '<? echo $save_data; ?>' + '_' + '<? echo $prev_distribution_method; ?>' + '_' + '<? echo $receive_basis; ?>' + '_' + '<? echo $txt_deleted_id; ?>' + '_' + '<? echo $txt_reject_fabric_recv_qnty; ?>' + '_' + '<? echo $production_control; ?>' + '_' + '<? echo $cbo_body_part; ?>' + '_' + '<? echo $cbo_company_id; ?>' + '_' + '<? echo $cbo_com_location_name; ?>' + '_' + '<? echo $cbo_store_name; ?>', 'po_popup', 'search_div', 'grey_production_entry_controller_v2', '');
		}

		function hidden_field_reset() {
			$('#po_id').val('');
			$('#save_string').val('');
			$('#tot_grey_qnty').val('');
			$('#txtGreyQntyPcs').val('');
			$('#tot_reject_qnty').val('');
			$('#number_of_roll').val('');
			selected_id = new Array();
		}

		function fnc_close() {
			var save_string = '';
			var tot_grey_qnty = '';
			var tot_grey_qnty_pcs = '';
			var tot_reject_qnty = '';
			var size_qnty_string = '';
			var no_of_roll = '';
			var po_id_array = new Array();
			var rfid_array = new Array();
			var breakOut = true;
			var diplicat_rfid = 0;
			var rfId_flag=0;

			$("#tbl_list_search").find('tr').each(function () {

				var txtPoId = $(this).find('input[name="txtPoId[]"]').val();
				var txtGreyQnty = $(this).find('input[name="txtGreyQnty[]"]').val();
				var txtGreyQnty_pcs = $(this).find('input[name="txtGreyQntyPcs[]"]').val();
				var txtRejectQnty = $(this).find('input[name="txtRejectQnty[]"]').val();
				var txtSizeQty = $(this).find('input[name="txtCollerCuffSize[]"]').val();
				var txtRoll = $(this).find('input[name="txtRoll[]"]').val();
				var txtRollId = $(this).find('input[name="txtRollId[]"]').val();
				var txtRollTableId = $(this).find('input[name="txtRollTableId[]"]').val();
				var txtRFId = $(this).find('input[name="txtRFId[]"]').val();

				if(txtRFId!=undefined && txtRFId!=""){
					var txtRFId_length=txtRFId.length; 
					if(txtRFId_length!=9)
					{
						rfId_flag=1;
					}
					if (jQuery.inArray(txtRFId, rfid_array) == -1) {
						rfid_array.push(txtRFId);
					}else{
						diplicat_rfid = 1;
					}
				}

				tot_grey_qnty 		= tot_grey_qnty * 1 + txtGreyQnty * 1;
				tot_grey_qnty_pcs 	= tot_grey_qnty_pcs * 1 + txtGreyQnty_pcs * 1;

				tot_reject_qnty 	= tot_reject_qnty * 1 + txtRejectQnty * 1;
				if(size_qnty_string!="") 	size_qnty_string=size_qnty_string+','+txtSizeQty;
				else 					 	size_qnty_string=txtSizeQty;

				var txtBarcodeNo = ''; var txtRFId = '';
				if (roll_maintained == 0) {
					txtRoll = 0;
				}
				else {
					txtBarcodeNo = $(this).find('input[name="txtBarcodeNo[]"]').val();
					txtRFId = $(this).find('input[name="txtRFId[]"]').val();
				}

				if (txtGreyQnty*1 >0 || txtRejectQnty*1 >0) {
					if (roll_maintained == 1) {
						no_of_roll = no_of_roll * 1 + 1;
					}

					if (save_string == "") {
						save_string = txtPoId + "**" + txtGreyQnty + "**" + txtRejectQnty + "**" + txtRoll + "**" + txtRollId + "**" + txtRollTableId + "**" + txtBarcodeNo + "**" + txtGreyQnty_pcs+ "**" + txtSizeQty + "**" + txtRFId;
					}
					else {
						save_string += "," + txtPoId + "**" + txtGreyQnty + "**" + txtRejectQnty + "**" + txtRoll + "**" + txtRollId + "**" + txtRollTableId + "**" + txtBarcodeNo + "**" + txtGreyQnty_pcs+ "**" + txtSizeQty + "**" + txtRFId;
					}

					if (jQuery.inArray(txtPoId, po_id_array) == -1) {
						po_id_array.push(txtPoId);
					}
				}
			});

			if(diplicat_rfid == 1)
			{
				alert("Same RFID is not Allowed Multiple Times.");
				return;
			}
			if(rfId_flag==1)
			{
				alert("RFID must be 9 digits long");
				return;
			}

			$('#save_string').val(save_string);
			$('#tot_grey_qnty').val(tot_grey_qnty.toFixed(2));
			$('#tot_grey_qnty_pcs').val(tot_grey_qnty_pcs.toFixed(2));
			$('#tot_reject_qnty').val(tot_reject_qnty.toFixed(2));
			$('#string_size_qty').val(size_qnty_string);
			$('#number_of_roll').val(no_of_roll);
			$('#all_po_id').val(po_id_array);
			$('#distribution_method').val($('#cbo_distribiution_method').val());

			parent.emailwindow.hide();
		}

		function check_all_report() {
			$("input[name=chkBundle]").each(function (index, element) {

				if ($('#check_all').prop('checked') == true)
					$(this).attr('checked', 'true');
				else
					$(this).removeAttr('checked');
			});
		}

		function fnc_send_printer_text() {
			var dtls_id = '<? echo $dtls_id; ?>';
			if (dtls_id == "") {
				alert("Save First");
				return;
			}
			var data = "";
			var error = 1;
			$("input[name=chkBundle]").each(function (index, element) {
				if ($(this).prop('checked') == true) {
					error = 0;
					var idd = $(this).attr('id').split("_");
					var roll_id = $('#txtRollTableId_' + idd[1]).val();
					if (roll_id != "") {
						if (data == "") data = $('#txtRollTableId_' + idd[1]).val(); else data = data + "," + $('#txtRollTableId_' + idd[1]).val();
					}
					else {
						$(this).prop('checked', false);
					}
				}
			});

			if (error == 1) {
				alert('No data selected');
				return;
			}

			data = data + "***" + dtls_id;
			var url = return_ajax_request_value(data, "report_barcode_text_file", "grey_production_entry_controller_v2");
			window.open(url + ".zip", "##");
		}

		function fnc_barcode_generation() {
			var dtls_id = '<? echo $dtls_id; ?>';
			if (dtls_id == "") {
				alert("Save First");
				return;
			}
			var data = "";
			var error = 1;
			$("input[name=chkBundle]").each(function (index, element) {
				if ($(this).prop('checked') == true) {
					error = 0;
					var idd = $(this).attr('id').split("_");
					var roll_id = $('#txtRollTableId_' + idd[1]).val();
					if (roll_id != "") {
						if (data == "") data = $('#txtRollTableId_' + idd[1]).val(); else data = data + "," + $('#txtRollTableId_' + idd[1]).val();
					}
					else {
						$(this).prop('checked', false);
					}
				}
			});

			if (error == 1) {
				alert('No data selected');
				return;
			}

			data = data + "***" + dtls_id;
			window.open("grey_production_entry_controller_v2.php?data=" + data + '&action=report_barcode_generation', true);
		}
		
		function get_weight_from_weight_machine(i){

			$.post( "grey_production_entry_controller_v2.php", { action: "load_weight_machine_data"})
			.done(function( data ) {
				var obj = JSON.parse(data); 
				$( "#txtGreyQnty_" +i).val( obj.weight );
				fn_check_balance(i);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_'+i);
			});	

		}

		//func_onDblClick_finishSize
		function func_onDblClick_finishSize(rowNo)
		{
        	//var page_link = 'grey_production_entry_controller_v2.php?action=action_finishSize&program_no=' + '<? //echo $booking_no; ?>';
        	var page_link = 'grey_production_entry_controller_v2.php?action=action_finishSize&program_no=' + '<? echo $booking_no; ?>&rowNo=' + rowNo;
        	var title = 'Program Wise Size Popup';
        	emailwindow = dhtmlmodal.open('EmailBox', 'iframe', page_link, title, 'width=220px,height=250px,center=1,resize=1,scrolling=0', '../');
        	emailwindow.onclose = function ()
			{
        		var theform = this.contentDoc.forms[0];
        		var item_size = this.contentDoc.getElementById("hdn_item_size").value;
        		//alert(item_size);
        		var item_size2=item_size.split('__');
        		//alert('size popup close='+item_size2[1]+'='+item_size2[0]);
				$('#txtCollerCuffSize_' + item_size2[1]).val(item_size2[0]);
        	}
		}
	</script>
	</head>

	<body>
	<?
	if ($type != 1)
	{
		?>
		<form name="searchdescfrm" id="searchdescfrm">
		<fieldset style="width:<? echo $width; ?>px;margin-left:5px">
		<input type="hidden" name="save_string" id="save_string" value="">
		<input type="hidden" name="tot_grey_qnty" id="tot_grey_qnty" value="">
		<input type="hidden" name="tot_grey_qnty_pcs" id="tot_grey_qnty_pcs" value="">
		<input type="hidden" name="tot_reject_qnty" id="tot_reject_qnty" value="">
		<input type="hidden" name="string_size_qty" id="string_size_qty" value="">
		<input type="hidden" name="number_of_roll" id="number_of_roll" value="">
		<input type="hidden" name="all_po_id" id="all_po_id" value="">
		<input type="hidden" name="distribution_method" id="distribution_method" value="">
		<input type="hidden" name="hide_deleted_id" id="hide_deleted_id" value="<? echo $txt_deleted_id; ?>">
        <input type="hidden" name="cbo_company_id" id="cbo_company_id" value="<? echo $cbo_company_id; ?>">
		<input type="hidden" name="cbo_location" id="cbo_location" value="<? echo $cbo_com_location_name; ?>">
		<input type="hidden" name="cbo_store_name" id="cbo_store_name"  value="<? echo $cbo_store_name; ?>">
		<?
	} 
	if ($receive_basis == 0 && $type != 1)
	{
		?>
		<table style="margin-left:90px" cellpadding="0" cellspacing="0" width="620" border="1" rules="all" class="rpt_table">
			<thead>
				<th class="must_entry_caption">Buyer</th>
				<th>Search By</th>
				<th>Search</th>
				<th>
					<input type="reset" name="reset" id="reset" value="Reset" style="width:100px"
					class="formbutton"/>
					<input type="hidden" name="po_id" id="po_id" value="">
				</th>
			</thead>
			<tr class="general">
				<td align="center">
					<?
					echo create_drop_down("cbo_buyer_name", 170, "select buy.id, buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$cbo_company_id' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buy.buyer_name", "id,buyer_name", 1, "-- Select Buyer --", $selected, "", $data[0]);
					?>
				</td>
				<td align="center">
					<?
					$search_by_arr = array(1 => "PO No", 2 => "Job No", 3 => "Internal Ref", 4 => "File No");
					echo create_drop_down("cbo_search_by", 170, $search_by_arr, "", 0, "--Select--", "", $dd, 0);
					?>
				</td>
				<td align="center">
					<input type="text" style="width:130px" class="text_boxes" name="txt_search_common"
					id="txt_search_common"/>
				</td>
				<td align="center">
					<input type="button" name="button2" class="formbutton" value="Show"
					onClick="fn_show_check();" style="width:100px;"/>
				</td>
			</tr>
		</table>
		<div id="search_div" style="margin-top:2px">
			<?
			if ($save_data != "")
			{
				?>
				<div style="width:<? echo $width - 20; ?>px; margin-top:5px" align="center">
					<table style="margin-bottom:2px" class="rpt_table" border="1" cellpadding="0"
					cellspacing="0" rules="all" width="300" align="center">
					<thead>
						<th>Total QC Pass Qty.</th>
						<th>Distribution Method</th>
					</thead>
					<tr class="general">
						<td><input type="text" name="txt_prop_grey_qnty" id="txt_prop_grey_qnty"
							class="text_boxes_numeric" value="<? echo $txt_receive_qnty; ?>"
							style="width:120px"
							onBlur="distribute_qnty(document.getElementById('cbo_distribiution_method').value)"
							disabled></td>
							<td>
								<?
								echo create_drop_down("cbo_distribiution_method", 250, $distribiution_method, "", 0, "", 2, "distribute_qnty(this.value);", 1);
								?>
							</td>
						</tr>
					</table>
				</div>
				<div style="margin-left:5px; margin-top:2px">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all"
					width="<? echo $width + 200; ?>">
					<thead>
						<th width="110">PO No</th>
						<th width="60">Internal Ref.</th>
						<th width="80">PO Qnty</th>
						<th width="70">Ship. Date</th>
						<th width="80">Cumulative Production Qty.</th>
						<th width="80">Balance Qty.</th>
						<th width="80">QC Pass Qty.</th>
						<th width="80">Qty in Pcs</th>
						<th width="60">Size</th>
						<th width="80">Reject Qty.</th>
						<?
						if ($roll_maintained == 1) {
							?>
							<!--
                            //######decision pending, develop leter. ###########//
                            <th width="80">Floor</th>
							<th width="80">Room</th>
							<th width="80">Rack</th>
							<th width="80">Shelf</th>-->
							<th width="60">Roll</th>
							<th width="70">Barcode No.</th>
							<th width="70">RFID</th>
							<th width="65"></th>
							<?
						}
						?>
					</thead>
				</table>
				<div style="width:<? echo $width+220; ?>px; max-height:200px; overflow-y:scroll" id="list_container" align="left">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="<? echo $width + 200; ?>" id="tbl_list_search">
						<?
						$i = 1;
						$tot_po_qnty = 0;
						$tot_grey_qnty = 0;
						$tot_grey_qnty_pcs = 0;
						$tot_reject_qnty = 0;
						$po_array = array();

						$explSaveData = explode(",", $save_data);
						for ($z = 0; $z < count($explSaveData); $z++)
						{
							if ($i % 2 == 0)
								$bgcolor = "#E9F3FF";
							else
								$bgcolor = "#FFFFFF";

							$po_wise_data = explode("**", $explSaveData[$z]);
							$order_id = $po_wise_data[0];
							$grey_qnty = $po_wise_data[1];
							$reject_qnty = $po_wise_data[2];
							$roll_no = $po_wise_data[3];
							$roll_not_delete_id = $po_wise_data[4];
							$roll_id = $po_wise_data[5];
							$barcode_no = $po_wise_data[6];
							$grey_qnty_pcs = $po_wise_data[7];
							$rft_id = $po_wise_data[9];

											//echo $order_id."**".$grey_qnty;
							$po_data = sql_select("select b.id,b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id=$order_id order by b.pub_shipment_date");



							$allPoId="";
							foreach ($po_data as $row) {
								$allPoId.= "'".$row[csf('id')]."'".',';
							}
							$allPoId=chop($allPoId,",");
							$greyRecvQty =sql_select("select po_breakdown_id,sum(quantity) as prod_quantity from order_wise_pro_details where po_breakdown_id in($allPoId) and entry_form=2 and status_active=1 and is_deleted=0 group by po_breakdown_id");
							foreach ($greyRecvQty as $row) {
								$grey_receive_qnty_arr[$row[csf("po_breakdown_id")]]["prod_quantity"]=$row[csf("prod_quantity")];
							}



							if ($roll_maintained == 1) {
								$roll_used = return_field_value("roll_used", "pro_roll_details", "id='$roll_id'");

								if (!(in_array($order_id, $po_array))) {
									if ($roll_not_delete_id == 0) $tot_po_qnty += $po_data[0][csf('po_qnty_in_pcs')];
									$orginal_val = 1;
									$po_array[] = $order_id;
								} else {
									if ($roll_used == 1) $orginal_val = 1; else $orginal_val = 0;
								}

								if ($roll_used == 1) {
									$disable = "disabled='disabled'";
									$roll_not_delete_id = $roll_not_delete_id;
								} else {
									$disable = "";
									$roll_not_delete_id = 0;
								}
							} else {
								if (!(in_array($order_id, $po_array))) {
									$tot_po_qnty += $po_data[0][csf('po_qnty_in_pcs')];
									$orginal_val = 1;
									$po_array[] = $order_id;
								} else {
									$orginal_val = 0;
								}

								$roll_not_delete_id = 0;
								$roll_id = 0;
								$disable = "";
							}

							$tot_grey_qnty += $grey_qnty;
							$tot_grey_qnty_pcs += $grey_qnty_pcs;
							$tot_reject_qnty += $reject_qnty;
							//$balanceQty = number_format($yarn_balance_qty_arr[$order_id],2,".","");


							$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$order_id],2,".","");
							$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
							$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$order_id] - $grey_production_qnty_arr[$order_id];
							$balanceQty = number_format($yarn_over_balance,2,".","");

							//echo $order_id."__".$grey_qnty;
							?>
							<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
								<td width="110">
									<p><? echo $po_data[0][csf('po_number')]; ?></p>
									<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>"
									value="<? echo $order_id; ?>">
									<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>"
									value="<? echo $orginal_val; ?>">
									<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>"
									value="<? echo $roll_not_delete_id; ?>">
									<!--txtRollId is used for not delete row which is used in Delivery -->
									<input type="hidden" name="txtRollTableId[]"
									id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
									<!--txtRollTableId is used for Duplication Check -->
									<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>"
									value="<? echo $balanceQty; ?>">
								</td>
								<td width="60"><p><? echo $po_data[0][csf('grouping')]; ?>&nbsp;</p></td>
								<td width="80" align="right">
									<? echo $po_data[0][csf('po_qnty_in_pcs')]; ?>
									<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>"
									value="<? echo $po_data[0][csf('po_qnty_in_pcs')]; ?>">
								</td>
								<td width="70" align="center"><? echo change_date_format($po_data[0][csf('pub_shipment_date')]); ?></td>
								<td width="80" align="right"><? echo $grey_receive_qnty_arr[$po_data[0][csf('id')]]["prod_quantity"]; ?></td>
								<td width="80" align="right"><? echo $po_data[0][csf('po_qnty_in_pcs')]-$grey_receive_qnty_arr[$po_data[0][csf('id')]]["prod_quantity"]; ?></td>
								<td align="center" >
									<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
								</td>
								<td align="center">
									<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?> onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
								</td>
								<td align="center" width="60">
									<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?> >
								</td>

								<td width="80" align="center">
									<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>" <? echo $disable; ?> onKeyUp="calculate_tot_qnty();">
								</td>
								<?
								if ($roll_maintained == 1)
								{
									/*
									//######decision pending, develop leter. ###########//
									?>
									<td id="floor_td" width="80">
										<? echo create_drop_down( "cbo_floor_$i", 80,$lib_floor_arr,"", 1, "--Select--", 0, "load_room_rack_self_bin('grey_production_entry_controller_v2*13*cbo_room_to_$i*$i', 'room',this.value, '".$cbo_company_id."','".$cbo_com_location_name."','".$cbo_store_name."',this.value);",0,"","","","","","","cbo_floor_to[]" ); ?>
									</td>
									<td id="room_td" width="80">
										<? echo create_drop_down( "cbo_room_$i", 80,$blank_array,"", 1, "--Select--", 0, "",0,"","","","","","","cbo_room_to[]" ); ?>
									</td>
									<td id="rack_td" width="80">
										<? echo create_drop_down( "txt_rack_$i", 80,$blank_array,"", 1, "--Select--", 0, "",0,"","","","","","","txt_rack_to[]" ); ?>
									</td>
									<td id="shelf_td" width="80">
										<? echo create_drop_down( "txt_shelf_$i", 80,$blank_array,"", 1, "--Select--", 0, "",0,"","","","","","","txt_shelf_to[]" ); ?>
									</td>
                                    <?
									*/
									?>
									<td align="center" width="60">
										<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?> placeholder="<? //echo $roll_arr[$order_id]+1; ?>" onBlur="roll_duplication_check(<? echo $i; ?>);"  readonly/>
									</td>
									<td width="70">
										<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>"  class="text_boxes_numeric" style="width:55px" value="<? echo $barcode_no; ?>" disabled/>
									</td>
									<td width="70">
										<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>"  class="text_boxes" style="width:55px" value="<? echo $rft_id; ?>" />
									</td>
									<td width="65">
										<input type="button" id="increase_<? echo $i; ?>" name="increase[]"
										style="width:30px" class="formbuttonplasminus" value="+"
										onClick="add_break_down_tr( <? echo $i; ?> )"/>
										<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]"
										style="width:30px" class="formbuttonplasminus" value="-"
										onClick="fn_deleteRow(<? echo $i; ?>);"/>
									</td>
									<?
								}
								?>
							</tr>
							<?
							$i++;
						}
						?>
						<input type="hidden" name="tot_po_qnty" id="tot_po_qnty" class="text_boxes" value="<? echo $tot_po_qnty; ?>">
						<input type="hidden" name="txt_tot_row" id="txt_tot_row" class="text_boxes" value="<? echo $i - 1; ?>">
					</table>
				</div>
				<table width="<? echo $width + 200; ?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="tbl_bottom">
					<tr>
						<td width="110"></td>
						<td width="60"></td>
						<td width="80"></td>
						<td width="70" align="right"></td>
						<td width="80" align="right"></td>
						<td width="80" align="right"><b>Total</b></td>
						<td style="text-align:center">
						<input type="text" name="txt_tot_grey_qnty" id="txt_tot_grey_qnty" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_grey_qnty, 2); ?>" disabled>
						</td>
						<td style="text-align:center"><input type="text" name="txt_tot_grey_qnty_pcs" id="txt_tot_grey_qnty_pcs" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_grey_qnty_pcs, 2); ?>" disabled>
						</td>
						<td align="center" width="80"></td>
						<td width="80" style="text-align:center"><input type="text" name="txt_tot_reject_qnty" id="txt_tot_reject_qnty" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_reject_qnty, 2); ?>"
						disabled></td>
						<?
						if ($roll_maintained == 1) {
							echo '</td><td width="60"></td><td width="70"></td><td width="70"></td><td width="65"></td>';
						}
						?>
					</tr>
					</table>
					<table width="<? echo $width; ?>">
						<tr>
							<td align="center">
								<input type="button" name="close" class="formbutton" value="Close"  id="main_close" onClick="fnc_close();" style="width:100px"/>
							</td>
						</tr>
					</table>
				</div>
				<?
			}
			?>
		</div>
		<? 
	}
	else
	{ 
		//echo $booking_without_order;die;
		if ($booking_without_order == 1 && $receive_basis != 2) // sample and without program
		{ 
			$prev_distribution_method = 2;
			$disabled = "disabled='disabled'";
			$disabled_dropdown = 1;
			?>
			<div style="width:<? echo $width - 20; ?>px; margin-top:5px;" align="center">
				<table style="margin-bottom:5px;" class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="300" align="center">
					<thead>
						<th>Total QC Pass Qty.</th>
						<th>Distribution Method</th>
					</thead>
					<tr class="general">
						<td><input type="text" name="txt_prop_grey_qnty" id="txt_prop_grey_qnty"
							class="text_boxes_numeric" value="<? echo $txt_receive_qnty; ?>" style="width:120px" onBlur="distribute_qnty(document.getElementById('cbo_distribiution_method').value)" <? echo $disabled; ?> >
							<input type="hidden" name="over_production_percentage" id="over_production_percentage" value="<? echo $over_production_percentage;?>">
						</td>
						<td>
							<?
							echo create_drop_down("cbo_distribiution_method", 250, $distribiution_method, "", 0, "", $prev_distribution_method, "distribute_qnty(this.value);", $disabled_dropdown);
							?>
						</td>
					</tr>
				</table>
			</div>
			<div style="margin-left:5px; margin-top:10px">
				<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="<? echo $width + 180; ?>">
					<caption style="font-weight: bold;color: red;">Over Production Percentage: <? echo $over_production_percentage; ?>%</caption>
					<thead>
						<?
						if ($receive_basis == 4) {
							echo '<th width="130">Sales Order No</th><th width="80">Sales Order Qty.</th>';
						} else {
							echo '<th width="130">Booking No</th><th width="80">Booking Qty.</th>';
						}
						?>
						<th width="80">Cumulative Production Qty.</th>
						<th width="80">Balance Qty</th>
						<th width="80">QC Pass Qty</th>
						<th width="80">Qty. In Pcs</th>
						<th width="80">Size</th>
						<th width="80">Reject Qty.</th>
						<th width="80">Roll</th>
						<th width="100">Barcode No.</th>
						<th width="65"></th>
					</thead>
				</table>
				<div style="width:<? echo $width+200; ?>px; max-height:200px; overflow-y:scroll" id="list_container" align="left">
                <table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="<? echo $width + 180; ?>" id="tbl_list_search">
                    <?
                    $i = 0;
                    $tot_po_qnty = 0;
                    $tot_grey_qnty = 0;
                    $tot_reject_qnty = 0;
                    $orginal_val = 1;
                    $roll_id = 0;
                    $roll_not_delete_id = 0;
                    $balanceQty = 0;
                	//echo $save_data;
                    if ($receive_basis == 4) {
                        if($txt_width) $dia_width_cond = " and dia='$txt_width'";
                        $bookingData = sql_select("select mst_id as po_ids,sum(grey_qty) as qnty from fabric_sales_order_dtls where job_no_mst='$booking_no' and determination_id='$fabric_desc_id' and body_part_id='$cbo_body_part' and gsm_weight='$txt_gsm' $dia_width_cond and status_active=1 and is_deleted=0 group by mst_id");

                        $allPoId="";
                        foreach ($bookingData as $row) {
                            $allPoId.= "'".$row[csf('po_ids')]."'".',';
                        }
                        $allPoId=chop($allPoId,",");
                        if($dtls_id!="") $dtls_id_cond = " and dtls_id <> $dtls_id";
                        $greyRecvQty =sql_select("select po_breakdown_id,sum(quantity) as prod_quantity from order_wise_pro_details where po_breakdown_id in($allPoId) and entry_form=2 and status_active=1 and is_deleted=0 and is_sales=1 $dtls_id_cond group by po_breakdown_id");

                        foreach ($greyRecvQty as $row) {
                            $grey_receive_qnty_arr[$row[csf("po_breakdown_id")]]["prod_quantity"]=$row[csf("prod_quantity")];
                        }
                    }
					else
					{
						//$bookingData = sql_select("select sum(grey_fabric) as qnty from wo_non_ord_samp_booking_dtls where booking_no='$booking_no' and  	lib_yarn_count_deter_id='$fabric_desc_id' and body_part='$cbo_body_part' and gsm_weight='$txt_gsm' and dia_width='$txt_width' and fabric_source=1 and status_active=1 and is_deleted=0");
						if($txt_width) $dia_width_cond = " and b.dia_width='$txt_width'";
						$bookingData = sql_select("select a.id as po_ids,sum(b.grey_fabric) as qnty from wo_non_ord_samp_booking_mst a,wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and b.booking_no='$booking_no' and b.lib_yarn_count_deter_id='$fabric_desc_id' and b.body_part='$cbo_body_part' and b.gsm_weight='$txt_gsm' $dia_width_cond and (a.fabric_source=1 OR b.fabric_source=1) and b.status_active=1 and b.is_deleted=0 group by a.id");

						$allNonOrdBookingId="";
						foreach ($bookingData as $row) {
							$allNonOrdBookingId.= "'".$row[csf('po_ids')]."'".',';
						}
						$allNonOrdBookingId=chop($allNonOrdBookingId,",");

						if($allNonOrdBookingId!="")
						{
							if($dtls_id!="") $dtls_id_cond = " and a.id <> $dtls_id";
							$greyRecvQty =sql_select(" select b.booking_id as po_breakdown_id, sum(a.grey_receive_qnty) as prod_quantity from pro_grey_prod_entry_dtls a, inv_receive_master b where a.mst_id = b.id and b.entry_form = 2 and b.booking_id in ($allNonOrdBookingId) and a.febric_description_id='$fabric_desc_id' and a.body_part_id='$cbo_body_part' and a.gsm='$txt_gsm' and b.booking_without_order=1 and a.status_active=1 and b.status_active=1  $dtls_id_cond group by b.booking_id");
							foreach ($greyRecvQty as $row) {
								$grey_receive_qnty_arr[$row[csf("po_breakdown_id")]]["prod_quantity"]=$row[csf("prod_quantity")];
							}
						}
					}

					$req_qnty = $bookingData[0][csf('qnty')];
					//$bl_qnty = $req_qnty - $recv_qnty;
					$production_balance = $req_qnty-$grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"];

					$req_qnty_with_over_perc = ($req_qnty*$over_production_percentage)/100 + $req_qnty;
					$balanceQty = $req_qnty_with_over_perc - $grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"];
					$balanceQty = number_format($balanceQty,2,".","");

					if ($save_data == "")
					{
						$i++;
						?>
						<tr bgcolor="#FFFFFF" id="tr_1">
							<td width="130">
								<p><? echo $booking_no; ?></p>
								<input type="hidden" name="txtPoId[]" id="txtPoId_1" value="<? echo $booking_id; ?>">
								<input type="hidden" name="txtOrginal[]" id="txtOrginal_1" value="<? echo $orginal_val; ?>">
								<input type="hidden" name="txtRollId[]" id="txtRollId_1" value="<? echo $roll_not_delete_id; ?>">
								<!--This is used for not delete row which is used in batch -->
								<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_1" value="<? echo $roll_id; ?>">
								<!--This is used for Duplication Check -->
								<input type="hidden" name="balanceQty[]" id="balanceQty_1" value="<? echo number_format($balanceQty, 2, '.', '');//echo $balanceQty; ?>">
							</td>
							<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
							<td width="80" align="right"><? echo number_format($grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"], 2, '.', ''); ?></td>
							<td width="80" align="right"><? echo number_format($req_qnty-$grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"], 2, '.', ''); ?></td>
							<td align="center" width="80">
								<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_1" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($production_balance, 2, '.', ''); ?>" onKeyUp="fn_check_balance(1);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
							</td>
							<td align="center" width="80">
								<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_1" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="calculate_tot_qnty();" <? echo $disable_td; ?>>
							</td>
							<td align="center" width="80">
								<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:60px" value="<? echo $size_qty; ?>" <? echo $disable_td; ?>>
							</td>
							<td align="center" width="80">
								<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_1" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="calculate_tot_qnty();">
							</td>
							<td align="center" width="80">
								<input type="text" name="txtRoll[]" id="txtRoll_1" class="text_boxes_numeric" style="width:60px" value="" readonly/>
							</td>
							<td width="100" align="center">
                            <input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_1" class="text_boxes_numeric" style="width:80px" value="" disabled/>
							</td>
							<td width="65">
								<input type="button" id="increase_1" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr(1)"/>
								<input type="button" id="decrease_1" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(1);"/>
							</td>
						</tr>
						<?
					}
					else
					{
						$explSaveData = explode(",", $save_data);
						for ($z = 0; $z < count($explSaveData); $z++) {
							$po_wise_data = explode("**", $explSaveData[$z]);
							$roll_ids[$po_wise_data[5]] = $po_wise_data[5];
							$barcode_num[$po_wise_data[6]] = $po_wise_data[6];
						}
						$roll_ids = implode(',',array_keys($roll_ids));
						$barcode_nums = rtrim(implode(',',array_keys($barcode_num)),',') ;

						if($roll_ids!="")
						{
							$sqlroll = sql_select("select barcode_no,roll_used from pro_roll_details where status_active=1 and is_deleted=0 and id in($roll_ids)");
							foreach ($sqlroll as $row) {
								$rollData[$row[csf("barcode_no")]]['roll_used'] = $row[csf("roll_used")];
							}
						}

						if($barcode_nums!="")
						{
							$qcRollSql = sql_select("SELECT barcode_no from PRO_QC_RESULT_MST where status_active=1 and is_deleted=0 and barcode_no in($barcode_nums)");
							$qcRollData=array();
							foreach ($qcRollSql as $row) 
							{
								$qcRollData[$row[csf("barcode_no")]] = $row[csf("barcode_no")];
							}
						}

						for ($z = 0; $z < count($explSaveData); $z++) 
						{
							$i++;

							if ($i % 2 == 0)
								$bgcolor = "#E9F3FF";
							else
								$bgcolor = "#FFFFFF";

							$po_wise_data = explode("**", $explSaveData[$z]);
							$order_id = $po_wise_data[0];
							$grey_qnty = $po_wise_data[1];
							$reject_qnty = $po_wise_data[2];
							$roll_no = $po_wise_data[3];
							$roll_not_delete_id = $po_wise_data[4];
							$roll_id = $po_wise_data[5];
							$barcode_no = $po_wise_data[6];
							$grey_qnty_pcs = $po_wise_data[7];
							$r_floor_id = $po_wise_data[10];
							$r_room_id = $po_wise_data[11];
							$r_rack_id = $po_wise_data[12];
							$r_self_id = $po_wise_data[12];

							$bl_qnty = $req_qnty - $recv_qnty;
							$size_data=$po_wise_data[8];

							$roll_used = $rollData[$barcode_no]['roll_used'];//return_field_value("roll_used", "pro_roll_details", "id='$roll_id'");
							$qc_barcode_no = $qcRollData[$barcode_no];

							if ($roll_used == 1) {
								$orginal_val = 1;
								$disable = "disabled='disabled'";
							} else {
								$disable = "";
								$roll_not_delete_id = 0;
								$orginal_val = 0;
							}

							$tot_grey_qnty += $grey_qnty;
							$tot_grey_qnty_pcs += $grey_qnty_pcs;
							$tot_reject_qnty += $reject_qnty;
							$balanceQty = 0;

							//echo $grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"];die;

							$production_balance = $req_qnty-$grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"];

							$req_qnty_with_over_perc = ($req_qnty*$over_production_percentage)/100 + $req_qnty;
							$balanceQty = $req_qnty_with_over_perc - $grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"];
							$balanceQty = number_format($balanceQty,2,".","");

							?>
							<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
								<td width="130">
									<p><? echo $booking_no; ?></p>
									<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $booking_id; ?>">
									<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
									<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
									<!--This is used for not delete row which is used in batch -->
									<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
									<!--This is used for Duplication Check -->
									<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo number_format($balanceQty, 2, '.', ''); ?>">

									<input type="hidden" name="txtQcBarcode[]" id="txtQcBarcode_<? echo $i; ?>" value="<? echo $qc_barcode_no; ?>">
									<input type="hidden" name="preQCPassQty[]" id="preQCPassQty_<? echo $i; ?>" value="<? echo $grey_qnty; ?>"><!-- after qc roll qty not change -->
								</td>
								<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
								<td width="80" align="right"><input type="text" name="txtGreyQntyCumulative[]" id="txtGreyQntyCumulative_<? echo $i; ?>" class="text_boxes_numeric" style="width:70px;" value="<? echo number_format($grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"],2,'.','')//$grey_qnty; ?>" <? echo $disable; ?> disabled></td>
                                <td width="80" align="right"><? echo number_format($req_qnty-$grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"], 2, '.', '');//echo number_format($req_qnty-$grey_receive_qnty_arr[$row[csf("po_id")]]["prod_quantity"], 2, '.', ''); ?></td>
                                <td align="center" width="80">
                                    <input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i;?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
                                </td>
                                <td align="center" width="80">
                                    <input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="calculate_tot_qnty();">
                                </td>
                                <td align="center" width="80">
                                    <input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes"  style="width:60px" value="<? echo $size_data; ?>" <? echo $disable_td; ?>>
                                </td>
                                <td align="center" width="80">
                                    <input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>" <? echo $disable; ?> onKeyUp="calculate_tot_qnty();">
                                </td>
                                <td align="center" width="80">
                                    <input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?> readonly/>
                                </td>
                                <td width="100" align="center"><input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:80px" value="<? echo $barcode_no; ?>" disabled/></td>
                                    <td width="65">
                                        <input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
                                        <input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
                                    </td>
                                </tr>
                                <?
						}
					}
				?>
				<input type="hidden" name="tot_po_qnty" id="tot_po_qnty" class="text_boxes" value="<? echo $tot_po_qnty; ?>">
				<input type="hidden" name="txt_tot_row" id="txt_tot_row" class="text_boxes" value="<? echo $i; ?>">
			</table>
			</div>
				<table width="<? echo $width + 180; ?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="tbl_bottom">
					<tr>
						<td width="130"></td>
						<td width="80"></td>
						<td width="80"></td>
						<td width="80" align="right"><b>Total</b></td>
						<td width="80" style="text-align:center">
							<input type="text" name="txt_tot_grey_qnty" id="txt_tot_grey_qnty" class="text_boxes_numeric" style="width:80px" value="<? echo number_format($tot_grey_qnty, 2); ?>" disabled>
						</td>
						<td width="80" style="text-align:center"><input type="text" name="txt_tot_grey_qnty_pcs" id="txt_tot_grey_qnty_pcs" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_grey_qnty_pcs, 2); ?>" disabled></td>
						<td align="center" width="80">

						</td>
						<td width="80" style="text-align:center"><input type="text" name="txt_tot_reject_qnty" id="txt_tot_reject_qnty" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_reject_qnty, 2); ?>"
						disabled></td>
						<td width="80"></td>
						<td width="100"></td>
						<td width="65"></td>
					</tr>
				</table>
				<table width="<? echo $width; ?>">
					<tr>
						<td align="center">
							<input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="fnc_close();" style="width:100px"/>
						</td>
					</tr>
				</table>
			</div>
			<? 
		}
		else
		{
			// echo $is_salesOrder;
			if($is_salesOrder != 2)
			{
				$disabled = "";
				$disabled_dropdown = 0;
				if ($receive_basis == 0 || $roll_maintained == 1) {
					$prev_distribution_method = 2;
					$disabled = "disabled='disabled'";
					$disabled_dropdown = 1;
				}
				?>
				<div style="width:<? echo $width - 20; ?>px; margin-top:5px;" align="center">
					<table style="margin-bottom:5px;" class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="300" align="center">
						<thead>
							<th>Total QC Pass Qty.</th>
							<th>Distribution Method</th>
						</thead>
						<tr class="general">
							<td>
								<input type="text" name="txt_prop_grey_qnty" id="txt_prop_grey_qnty" class="text_boxes_numeric" value="<? echo $txt_receive_qnty; ?>" style="width:120px" onBlur="distribute_qnty(document.getElementById('cbo_distribiution_method').value)" <? echo $disabled; ?> >
								<input type="hidden" name="over_production_percentage" id="over_production_percentage" value="<? echo $over_production_percentage;?>">
							</td>
							<td>
								<?
								echo create_drop_down("cbo_distribiution_method", 250, $distribiution_method, "", 0, "", $prev_distribution_method, "distribute_qnty(this.value);", $disabled_dropdown);
								?>
							</td>
						</tr>
					</table>
				</div>
				<div style="margin-left:5px; margin-top:10px">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="<? echo $width + 220; ?>">
						<caption style="font-weight: bold;color: red;">Over Production Percentage: <? echo $over_production_percentage; ?>%</caption>
						<thead>
							<th width="110"><? echo ($is_salesOrder == 1) ? "Sales Order No" : "PO No"; ?></th>
							<th width="60">Internal Ref.</th>
							<th width="80">PO Qnty</th>
							<th width="70">Ship. Date</th>
							<?
							if ($receive_basis == 1 || $receive_basis == 2) {
								echo '<th width="80">Req. Qty.</th>';
							}
							?>
							<th width="80">Cumulative Production Qty.</th>
							<th width="80">Balance Qty</th>
							<th width="80">QC Pass Qty.</th>
							<th width="80">Qty. In Pcs</th>
							<th width="60">Size</th>
							<th width="80">Reject Qty.</th>
							<?
							if ($roll_maintained == 1) {
								?>
								<th width="60">Roll</th>
								<th width="70">Barcode No.</th>
								<th width="70">RFID</th>
								<th width="65"></th>
								<?
							}
							?>
						</thead>
					</table>
					<div style="width:<? echo $width+240; ?>px; max-height:200px; overflow-y:scroll" id="list_container" align="left">
						<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="<? echo $width + 220; ?>" id="tbl_list_search">
							<?
							$i = 1;
							$tot_po_qnty = 0;
							$tot_grey_qnty = 0;
							$tot_grey_qnty_pcs = 0;
							$tot_reject_qnty = 0;
							$po_array = array();
	
							if ($save_data != "" && $receive_basis == 0)//Independent
							{
	
								$po_id = explode(",", $po_id);
								$explSaveData = explode(",", $save_data);
								for ($z = 0; $z < count($explSaveData); $z++) {
									if ($i % 2 == 0)
										$bgcolor = "#E9F3FF";
									else
										$bgcolor = "#FFFFFF";
	
									$po_wise_data = explode("**", $explSaveData[$z]);
									$order_id = $po_wise_data[0];
									$grey_qnty = $po_wise_data[1];
									$reject_qnty = $po_wise_data[2];
									$roll_no = $po_wise_data[3];
									$roll_not_delete_id = $po_wise_data[4];
									$roll_id = $po_wise_data[5];
									$barcode_no = $po_wise_data[6];
									$grey_qnty_pcs = $po_wise_data[7];
									$rft_id = $po_wise_data[9];
									$r_floor_id = $po_wise_data[10];
									$r_room_id = $po_wise_data[11];
									$r_rack_id = $po_wise_data[12];
									$r_self_id = $po_wise_data[12];
	
									if (in_array($order_id, $po_id)) {
										$po_data = sql_select("select b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id=$order_id");
	
										if ($roll_maintained == 1) {
											$roll_used = return_field_value("roll_used", "pro_roll_details", "id='$roll_id'");
	
											if (!(in_array($order_id, $po_array))) {
												if ($roll_not_delete_id == 0) $tot_po_qnty += $po_data[0][csf('po_qnty_in_pcs')];
												$orginal_val = 1;
												$po_array[] = $order_id;
											} else {
												if ($roll_used == 1) $orginal_val = 1; else $orginal_val = 0;
											}
	
											if ($roll_used == 1) {
												$disable = "disabled='disabled'";
												$roll_not_delete_id = $roll_not_delete_id;
											} else {
												$disable = "";
												$roll_not_delete_id = 0;
											}
	
										} else {
											if (!(in_array($order_id, $po_array))) {
												$tot_po_qnty += $po_data[0][csf('po_qnty_in_pcs')];
												$orginal_val = 1;
												$po_array[] = $order_id;
											} else {
												$orginal_val = 0;
											}
	
											$roll_id = 0;
											$roll_not_delete_id = 0;
											$disable = "";
										}
	
										$tot_grey_qnty += $grey_qnty;
										$tot_grey_qnty_pcs += $grey_qnty_pcs;
										$tot_reject_qnty += $reject_qnty;
										//$balanceQty = number_format($yarn_balance_qty_arr[$order_id],2,".","");


										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$order_id],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$order_id] - $grey_production_qnty_arr[$order_id];
										$balanceQty = number_format($yarn_over_balance,2,".","");

										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $po_data[0][csf('po_number')]; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $order_id; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
											</td>
											<td width="60"><p><? echo $po_data[0][csf('grouping')]; ?>&nbsp;</p>
											</td>
											<td width="80" align="right">
												<? echo $po_data[0][csf('po_qnty_in_pcs')] ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $po_data[0][csf('po_qnty_in_pcs')]; ?>">
											</td>
											<td width="70" align="center"><? echo change_date_format($po_data[0][csf('pub_shipment_date')]); ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>
											<td width="80" align="right"><? echo ""; ?></td>
											<td width="80" align="right"><? echo ""; ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();" <? echo $disable_td; ?>>
											</td>
											<td align="center" width="80">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:60px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?>>
											</td>
											<td width="100" align="center">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:80px" value="<? echo $reject_qnty; ?>" <? echo $disable; ?> onKeyUp="calculate_tot_qnty();">
											</td>
											<?
											if ($roll_maintained == 1) {
	
												?>
												<td align="center" width="60">
													<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?> placeholder="<? //echo $roll_arr[$order_id]+1; ?>" onBlur="roll_duplication_check(<? echo $i; ?>);" readonly/>
											   </td>
											   <td width="70">
												<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:55px" value="<? echo $barcode_no; ?>" disabled/>
											   </td>
											   <td width="70">
												<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>" class="text_boxes_numeric" style="width:55px" value="<? echo $rft_id; ?>" />
											   </td>
											   <td width="65">
												<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
												<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
											   </td>
											   <?
										   }
										   ?>
									   </tr>
									   <?
									   $i++;
								   }
								}
	
								if (count($po_array) < 1) 
								{
								   $result = implode(",", $po_id);
								} 
								else 
								{
									$result = implode(",", array_diff($po_id, $po_array));
								}
								if ($result != "") 
								{
									$po_sql = "select b.id, b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in ($result) order by b.pub_shipment_date, b.id";
									$nameArray = sql_select($po_sql);
									foreach ($nameArray as $row) 
									{
										if ($i % 2 == 0)
											$bgcolor = "#E9F3FF";
										else
											$bgcolor = "#FFFFFF";
	
										$orginal_val = 1;
										$roll_id = 0;
										$roll_not_delete_id = 0;
	
										$tot_po_qnty += $row[csf('po_qnty_in_pcs')];
										//$balanceQty = number_format($yarn_balance_qty_arr[$row[csf('id')]],2,".","");

										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$row[csf('id')]],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$row[csf('id')]] - $grey_production_qnty_arr[$row[csf('id')]];
										$balanceQty = number_format($yarn_over_balance,2,".","");

										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $row[csf('po_number')]; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
											</td>
											<td width="60"><p><? echo $row[csf('grouping')]; ?>&nbsp;</p></td>
											<td width="80" align="right">
												<? echo $row[csf('po_qnty_in_pcs')]; ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $row[csf('po_qnty_in_pcs')]; ?>">
											</td>
											<td width="70" align="center"><? echo change_date_format($row[csf('pub_shipment_date')]); ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>
											<td width="80" align="right"><? echo "" ?> </td>
											<td width="80" align="right"><? echo ""; ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
											</td>
											<td align="center" width="80">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?>>
											</td>
											<td width="80" align="center">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="calculate_tot_qnty();">
											</td>
											<?
											if ($roll_maintained == 1) 
											{
												/*
												//######decision pending, develop leter. ###########//
												?>
												<td id="floor_td_to" width="80" align="center">
													<? echo create_drop_down( "cbo_floor_to_$i", 80,$lib_floor_arr,"", 1, "--Select--", 0, "load_room_rack_self_bin('grey_production_entry_controller_v2*13*cbo_room_to_$i*$i', 'room',this.value, document.getElementById('cbo_company_id').value,document.getElementById('cbo_location').value,document.getElementById('cbo_store_name').value,this.value,'','','','','','80','H');",0,"","","","","","","cbo_floor_to[]" ,"onchange_void"); ?>
												</td>
												<td id="room_td_to" width="80" align="center">
													<? echo create_drop_down( "cbo_room_to_$i", 80,$blank_array,"", 1, "--Select--", 0, "",0,"","","","","","","cbo_room_to[]","onchange_void" ); ?>
												</td>
												<td id="rack_td_to" width="80" align="center">
													<? echo create_drop_down( "txt_rack_to_$i", 80,$blank_array,"", 1, "--Select--", 0, "",0,"","","","","","","txt_rack_to[]","onchange_void" ); ?>
												</td>
												<td id="shelf_td_to" width="80" align="center">
													<? echo create_drop_down( "txt_shelf_to_$i", 80,$blank_array,"", 1, "--Select--", 0, "",0,"","","","","","","txt_shelf_to[]","onchange_void" ); ?>
												</td>
												<?
												*/
												?>
												<td align="center" width="60">
													<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:65px" value="" onBlur="roll_duplication_check(<? echo $i; ?>);" placeholder="<? //echo $roll_arr[$row[csf('id')]]+1; ?>" readonly/>
											   </td>
											   <td width="70"><input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:70px" value="" disabled/></td>
												<td width="65">
													<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
													<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
												</td>
												<?
											}
											?>
										</tr>
										<?
										$i++;
									}
								}
							}
							else if ($save_data != "" && $receive_basis == 1)//Fabrick Booking
							{
								//echo $save_data;
								$booking_qnty_array = return_library_array("select a.po_break_down_id, sum(a.grey_fab_qnty) as qnty from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b where a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no='$booking_no' and b.lib_yarn_count_deter_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and b.gsm_weight='$txt_gsm' and a.dia_width='$txt_width' and a.job_no=b.job_no and a.status_active=1 and a.is_deleted=0 group by a.po_break_down_id", "po_break_down_id", "qnty");
	
								if ($roll_maintained == 1)
								{
									$all_po_id = explode(",", $all_po_id);
									$explSaveData = explode(",", $save_data);

									for ($z = 0; $z < count($explSaveData); $z++) {
	
										$po_wise_data = explode("**", $explSaveData[$z]);
	
										for ($y = 0; $y < count($po_wise_data); $y++) {

											$barcode_num[$po_wise_data[6]] = $po_wise_data[6];
	
										}
									}
									$barcode_nums = rtrim(implode(',',array_keys($barcode_num)),',') ;
									if($barcode_nums!="")
									{
										$qcRollSql = sql_select("SELECT barcode_no from PRO_QC_RESULT_MST where status_active=1 and is_deleted=0 and barcode_no in($barcode_nums)");
										$qcRollData=array();
										foreach ($qcRollSql as $row) 
										{
											$qcRollData[$row[csf("barcode_no")]] = $row[csf("barcode_no")];
										}
									}

									for ($z = 0; $z < count($explSaveData); $z++)
									{
										if ($i % 2 == 0)
											$bgcolor = "#E9F3FF";
										else
											$bgcolor = "#FFFFFF";
	
										$po_wise_data = explode("**", $explSaveData[$z]);
										//print_r($po_wise_data);
										$order_id = $po_wise_data[0];
										$grey_qnty = $po_wise_data[1];
										$reject_qnty = $po_wise_data[2];
										$roll_no = $po_wise_data[3];
										$roll_not_delete_id = $po_wise_data[4];
										$roll_id = $po_wise_data[5];
										$barcode_no = $po_wise_data[6];
										$grey_qnty_pcs = $po_wise_data[7];
										$size_qty = $po_wise_data[8];
										$rft_id = $po_wise_data[9];
										$r_floor_id = $po_wise_data[10];
										$r_room_id = $po_wise_data[11];
										$r_rack_id = $po_wise_data[12];
										$r_self_id = $po_wise_data[12];
										//echo $grey_qnty_pcs.'ddds';
										$req_qnty = $booking_qnty_array[$order_id];
										$bl_qnty = $req_qnty - $recv_qnty_array[$order_id];

										$qc_barcode_no = $qcRollData[$barcode_no];
	
										$po_data = sql_select("select b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id=$order_id");
	
										$roll_used = return_field_value("roll_used", "pro_roll_details", "id='$roll_id'");
	
										if (!(in_array($order_id, $po_array))) {
											if ($roll_not_delete_id == 0) $tot_po_qnty += $po_data[0][csf('po_qnty_in_pcs')];
											$orginal_val = 1;
											$po_array[] = $order_id;
										} else {
											if ($roll_used == 1) $orginal_val = 1; else $orginal_val = 0;
										}
	
										if ($roll_used == 1) {
											$disable = "disabled='disabled'";
											$roll_not_delete_id = $roll_not_delete_id;
										} else {
											$disable = "";
											$roll_not_delete_id = 0;
										}
	
										$tot_grey_qnty += $grey_qnty;
										$tot_grey_qnty_pcs += $grey_qnty_pcs;
										$tot_reject_qnty += $reject_qnty;
										//$balanceQty = number_format($yarn_balance_qty_arr[$order_id],2,".","");
	
										$production_balance = $req_qnty - $recv_qnty_array[$row[csf('po_breakdown_id')]];

										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$order_id],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$order_id] - $grey_production_qnty_arr[$order_id];
										$balanceQty = number_format($yarn_over_balance,2,".","");

										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $po_data[0][csf('po_number')]; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $order_id; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
												<input type="hidden" name="txtQcBarcode[]" id="txtQcBarcode_<? echo $i; ?>" value="<? echo $qc_barcode_no; ?>">
												<input type="hidden" name="preQCPassQty[]" id="preQCPassQty_<? echo $i; ?>" value="<? echo $grey_qnty; ?>"><!-- after qc roll qty not change -->
											</td>
											<td width="60"><p><? echo $po_data[0][csf('grouping')]; ?>&nbsp;</p>
											</td>
											<td width="80" align="right">
												<? echo $po_data[0][csf('po_qnty_in_pcs')] ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $po_data[0][csf('po_qnty_in_pcs')]; ?>">
											</td>
											<td width="70" align="center"><? echo change_date_format($po_data[0][csf('pub_shipment_date')]); ?></td>
											<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
											<td width="80" align="right"><? echo $recv_qnty_array[$row[csf('po_breakdown_id')]]; ?></td>
											<td width="80" align="right"><? echo  number_format($production_balance, 2, '.', ''); ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
											</td>
											<td align="center" width="60">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? echo $size_qty; ?>" <? echo $disable_td; ?>>
											</td>
											<td align="center" width="80">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>" <? echo $disable; ?> onKeyUp="calculate_tot_qnty();">
											</td>
											<td align="center" width="60">
												<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?>  placeholder="<? //echo $roll_arr[$order_id]+1; ?>" onBlur="roll_duplication_check(<? echo $i; ?>);" readonly/>
										   </td>
										   <td width="70">
											<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:55px" value="<? echo $barcode_no; ?>" disabled/>
										   </td>
										   <td width="70">
											<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>" class="text_boxes" style="width:55px" value="<? echo $rft_id; ?>" />
										   </td>
										   <td width="65">
											<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
											<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
										   </td>
									   </tr>
									   <?
									   $i++;
								   	}
	
								   	if ($db_type == 0) {
										$booking_po_id = return_field_value("group_concat(distinct(po_break_down_id)) as po_id", "wo_booking_dtls", "booking_no='$booking_no' and status_active=1 and is_deleted=0", "po_id");
								   	} else {
										$booking_po_id = return_field_value("LISTAGG(po_break_down_id, ',') WITHIN GROUP (ORDER BY po_break_down_id) as po_id", "wo_booking_dtls", "booking_no='$booking_no' and status_active=1 and is_deleted=0", "po_id");
								   	}
								   	$booking_po_id = array_unique(explode(",", $booking_po_id));
								   	$result = implode(",", array_diff($booking_po_id, $all_po_id));
	
								   	if ($result != "") 
								   	{
										$po_sql = "select b.id, b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in ($result) order by b.pub_shipment_date, b.id";
										$nameArray = sql_select($po_sql);
										foreach ($nameArray as $row)
										{
											if ($i % 2 == 0)
												$bgcolor = "#E9F3FF";
											else
												$bgcolor = "#FFFFFF";
		
											$orginal_val = 1;
											$roll_id = 0;
											$roll_not_delete_id = 0;
											$disable = "";
											$tot_po_qnty += $row[csf('po_qnty_in_pcs')];
		
											$req_qnty = $booking_qnty_array[$row[csf('id')]];
											$bl_qnty = $req_qnty - $recv_qnty_array[$row[csf('id')]];
											//$balanceQty = number_format($yarn_balance_qty_arr[$row[csf('id')]],2,".","");

											$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$row[csf('id')]],2,".","");
											$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
											$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$row[csf('id')]] - $grey_production_qnty_arr[$row[csf('id')]];
											$balanceQty = number_format($yarn_over_balance,2,".","");

											?>
											<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
												<td width="110">
													<p><? echo $row[csf('po_number')]; ?></p>
													<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
													<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
													<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
													<!--This is used for not delete row which is used in batch -->
													<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
													<!--This is used for Duplication Check -->
													<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
												</td>
												<td width="60"><p><? echo $row[csf('grouping')]; ?>&nbsp;</p></td>
												<td width="80" align="right">
													<? echo $row[csf('po_qnty_in_pcs')]; ?>
													<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $row[csf('po_qnty_in_pcs')]; ?>">
												</td>
												<td width="70" align="center"><? echo change_date_format($row[csf('pub_shipment_date')]); ?></td>
												<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
												<td width="80" align="right"><? echo ""; ?></td>
												<td width="80" align="right"><? echo ""; ?></td>
												<td align="center" width="80">
													<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>); calculate_tot_qnty(); fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
												</td>
												<td align="center" width="80">
													<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
												</td>
												<td align="center" width="60">
													<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?>>
												</td>
												<td align="center" width="80">
													<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="calculate_tot_qnty();">
												</td>
												<td align="center" width="60">
													<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="" onBlur="roll_duplication_check(<? echo $i; ?>);" placeholder="<? //echo $roll_arr[$row[csf('id')]]+1; ?>" readonly/>
												   </td>
												   <td width="70">
													<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>"  class="text_boxes_numeric" style="width:55px" value="" disabled/>
												   </td>
												   <td width="70">
													<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>"  class="text_boxes" style="width:55px" value="" />
												   </td>
												   <td width="65">
													<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
													<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
												   </td>
											   </tr>
											   <?
											   $i++;
										}
									}
								}
								else
								{
									$prev_po_qnty_arr = array();
									$prev_po_qnty_pcs_arr = array();
									$prev_reject_qnty_arr = array();
									$explSaveData = explode(",", $save_data);
									for ($z = 0; $z < count($explSaveData); $z++) 
									{
										$po_wise_data = explode("**", $explSaveData[$z]);
										$order_id = $po_wise_data[0];
										$grey_qnty = $po_wise_data[1];
										$reject_qnty = $po_wise_data[2];
										$grey_qnty_pcs = $po_wise_data[7];
										$size_qty = $po_wise_data[8];
	
										$prev_po_qnty_arr[$order_id] = $grey_qnty;
										$prev_po_qnty_pcs_arr[$order_id] = $grey_qnty_pcs;
										$prev_reject_qnty_arr[$order_id] = $reject_qnty;
									}
	
									$po_sql = "select b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b, wo_booking_dtls c where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and c.booking_no='$booking_no' and c.status_active=1 and c.is_deleted=0 group by b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping order by b.pub_shipment_date, b.id";
									$nameArray = sql_select($po_sql);
									foreach ($nameArray as $row)
									{
	
										if ($i % 2 == 0)
											$bgcolor = "#E9F3FF";
										else
											$bgcolor = "#FFFFFF";
	
										$orginal_val = 1;
										$roll_id = 0;
										$roll_not_delete_id = 0;
										$disable = "";
	
										$po_qnty_in_pcs = $row[csf('po_quantity')] * $row[csf('total_set_qnty')];
										$tot_po_qnty += $po_qnty_in_pcs;
	
										$grey_qnty = $prev_po_qnty_arr[$row[csf('id')]];
										$grey_qnty_pcs = $prev_po_qnty_pcs_arr[$row[csf('id')]];
										$req_qnty = $booking_qnty_array[$row[csf('id')]];
										$reject_qnty = $prev_reject_qnty_arr[$row[csf('id')]];
										$tot_grey_qnty += $grey_qnty;
										$tot_grey_qnty_pcs += $grey_qnty_pcs;
										$tot_reject_qnty += $reject_qnty;
										$production_balance = $req_qnty - $recv_qnty_array[$row[csf('id')]];
										//$balanceQty = number_format($yarn_balance_qty_arr[$row[csf('id')]],2,".","");


										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$row[csf('id')]],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$row[csf('id')]] - $grey_production_qnty_arr[$row[csf('id')]];
										$balanceQty = number_format($yarn_over_balance,2,".","");

	
										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $row[csf('po_number')]; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
											</td>
											<td width="60"><p><? echo $row[csf('grouping')]; ?>&nbsp;</p></td>
											<td width="80" align="right">
												<? echo $po_qnty_in_pcs; ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $po_qnty_in_pcs; ?>">
											</td>
											<td width="70" align="center"><? echo change_date_format($row[csf('pub_shipment_date')]); ?></td>
											<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
											<td width="80" align="right"><? echo ""; ?></td>
											<td width="80" align="right"><? echo ""; ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" placeholder="<? if ($roll_maintained == 0) echo number_format($production_balance, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
											</td>
											<td align="center" width="80">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:60px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?>>
											</td>
											<td width="80" align="center">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>"
												onKeyUp="calculate_tot_qnty();">
											</td>
										</tr>
										<?
										$i++;
									}
								}
							}
							else if ($save_data != "" && $receive_basis == 2) //Kniting plan
							{
								$program_qnty_array = return_library_array("select b.po_id, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b where a.id=b.dtls_id and b.dtls_id='$booking_no' and b.determination_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and b.status_active=1 and b.is_deleted=0 group by b.po_id", "po_id", "qnty");
	
								if ($roll_maintained == 1)
								{
									$all_po_id = explode(",", $all_po_id);
									$explSaveData = explode(",", $save_data);
	
									for ($z = 0; $z < count($explSaveData); $z++) {
	
										$po_wise_data = explode("**", $explSaveData[$z]);
	
										for ($y = 0; $y < count($po_wise_data); $y++) {
	
											$order_id[$po_wise_data[0]] = $po_wise_data[0];
											$roll_id[$po_wise_data[5]] = $po_wise_data[5];
											$barcode_num[$po_wise_data[6]] = $po_wise_data[6];
	
										}
									}
	
									$order_ids = implode(',',array_keys($order_id));
									$roll_ids = implode(',',array_keys($roll_id));
									$barcode_nums = rtrim(implode(',',array_keys($barcode_num)),',') ;
	
									if($order_ids!="")
									{
										if ($is_salesOrder == 1) {
											$po_data = sql_select("select a.id,a.job_no as po_number, sum(b.grey_qty) as po_qnty_in_pcs from fabric_sales_order_mst a, fabric_sales_order_dtls b where a.id=b.mst_id and a.id in ($order_ids) group by a.id, a.job_no");
										} else {
											$po_data = sql_select("select b.id,b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping,b.po_quantity from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_ids)");
										}
									}
	
									$allPoId="";
									$po_data_arr = array();
									foreach ($po_data as $row) {
										$allPoId.= "'".$row[csf('id')]."'".',';
										$po_data_arr[$row[csf('id')]]['po_id'] 				=  $row[csf('id')];
										$po_data_arr[$row[csf('id')]]['po_number'] 			=  $row[csf('po_number')];
										$po_data_arr[$row[csf('id')]]['po_qnty_in_pcs'] 	=  $row[csf('po_qnty_in_pcs')];
										$po_data_arr[$row[csf('id')]]['pub_shipment_date'] 	=  $row[csf('pub_shipment_date')];
										$po_data_arr[$row[csf('id')]]['grouping'] 			=  $row[csf('grouping')];
										$po_data_arr[$row[csf('id')]]['po_quantity'] 		=  $row[csf('po_quantity')];
									}
	
									$allPoId=chop($allPoId,",");
									$greyRecvQty =sql_select("select po_breakdown_id,sum(quantity) as prod_quantity from order_wise_pro_details where po_breakdown_id in($allPoId) and entry_form=2 and status_active=1 and is_deleted=0 group by po_breakdown_id");
	
									foreach ($greyRecvQty as $row) {
										$grey_receive_qnty_arr[$row[csf("po_breakdown_id")]]["prod_quantity"] = $row[csf("prod_quantity")];
									}
	
									if($roll_ids!="")
									{
										$sqlroll = sql_select("select barcode_no,roll_used from pro_roll_details where status_active=1 and is_deleted=0 and id in($roll_ids)");
										foreach ($sqlroll as $row) {
											$rollData[$row[csf("barcode_no")]]['roll_used'] = $row[csf("roll_used")];
										}
									}

									if($barcode_nums!="")
									{
										$qcRollSql = sql_select("SELECT barcode_no from PRO_QC_RESULT_MST where status_active=1 and is_deleted=0 and barcode_no in($barcode_nums)");
										$qcRollData=array();
										foreach ($qcRollSql as $row) 
										{
											$qcRollData[$row[csf("barcode_no")]] = $row[csf("barcode_no")];
										}
									}
	
								   	for ($z = 0; $z < count($explSaveData); $z++)
								   	{
										if ($i % 2 == 0)
											$bgcolor = "#E9F3FF";
										else
											$bgcolor = "#FFFFFF";
	
										$po_wise_data = explode("**", $explSaveData[$z]);
										$order_id = $po_wise_data[0];
										$grey_qnty = $po_wise_data[1];
										$reject_qnty = $po_wise_data[2];
										$roll_no = $po_wise_data[3];
										$roll_not_delete_id = $po_wise_data[4];
										$roll_id = $po_wise_data[5];
										$barcode_no = $po_wise_data[6];
										$grey_qnty_pcs = $po_wise_data[7];
										$size_qty = $po_wise_data[8];
										$rft_id = $po_wise_data[9];
										$r_floor_id = $po_wise_data[10];
										$r_room_id = $po_wise_data[11];
										$r_rack_id = $po_wise_data[12];
										$r_self_id = $po_wise_data[12];
	
										$req_qnty = $program_qnty_array[$order_id];
										$bl_qnty = $req_qnty - $recv_qnty_array[$order_id];

										//echo $req_qnty."=".$recv_qnty_array[$order_id]."<br>";
	
										$roll_used = $rollData[$barcode_no]['roll_used'];
										$qc_barcode_no = $qcRollData[$barcode_no];
	
										if (!(in_array($order_id, $po_array))) {
											if ($roll_not_delete_id == 0) $tot_po_qnty += $po_data_arr[$order_id]['po_qnty_in_pcs'];
											$orginal_val = 1;
											$po_array[] = $order_id;
										} else {
											if ($roll_used == 1) $orginal_val = 1; else $orginal_val = 0;
										}
	
										if ($roll_used == 1) {
											$disable = "disabled='disabled'";
											$roll_not_delete_id = $roll_not_delete_id;
										} else {
											$disable = "";
											$roll_not_delete_id = 0;
										}
	
										$tot_grey_qnty += $grey_qnty;
										$tot_grey_qnty_pcs += $grey_qnty_pcs;
										$tot_reject_qnty += $reject_qnty;
	
										$prev_own_rcv = $this_challan_rcv[$dtls_id][$order_id];
										//$balanceQty = number_format($yarn_balance_qty_arr[$order_id]+$prev_own_rcv,2,".","");

										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$order_id],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance =$yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$order_id] - $grey_production_qnty_arr[$order_id] + $prev_own_rcv;

										$balanceQty = number_format($yarn_over_balance,2,".","");

										if($production_control == 1)
										{
											$balanceQty = $balanceQty;
										}else{
											$balanceQty = $bl_qnty;
										}

										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $po_data_arr[$order_id]['po_number']; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $order_id; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtQcBarcode[]" id="txtQcBarcode_<? echo $i; ?>" value="<? echo $qc_barcode_no; ?>">
												<input type="hidden" name="preQCPassQty[]" id="preQCPassQty_<? echo $i; ?>" value="<? echo $grey_qnty; ?>"><!-- after qc roll qty not change -->
												
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
											</td>
											<td width="60"><p><? echo $po_data_arr[$order_id]['grouping']; ?>&nbsp;</p>
											</td>
											<td width="80" align="right">
												<? echo $po_data_arr[$order_id]['po_qnty_in_pcs']; ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $po_data_arr[$order_id]['po_qnty_in_pcs']; ?>">
											</td>
											<td width="70" align="center"><? if ($is_salesOrder != 1) {
												echo change_date_format($po_data_arr[$order_id]['pub_shipment_date']);
											} ?>&nbsp;</td>
											<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?> </td>
											<td width="80" align="right"><input type="text" name="txtGreyQntyCumulative[]" id="txtGreyQntyCumulative_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px;" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> disabled></td>
											<td width="80" align="right"><? echo number_format(($balanceQty-$grey_qnty),2,".","");//echo number_format($req_qnty-$grey_receive_qnty_arr[$row[csf("po_id")]]["prod_quantity"], 2, '.', ''); ?></td>
											
											<td align="center" width="80">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>

											<td align="center" width="80">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
											</td>
											<td align="center" width="60">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? echo $size_qty; ?>" <? echo $disable_td; ?> placeholder="B/W" onDblClick="func_onDblClick_finishSize(<? echo $i; ?>);" />
											</td>
											<td width="80" align="center">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>" <? echo $disable; ?> onKeyUp="calculate_tot_qnty();">
											</td>
											<td align="center" width="60">
											<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?> placeholder="<? //echo $roll_arr[$order_id]+1; ?>" onBlur="roll_duplication_check(<? echo $i; ?>);" readonly/>
										   </td>
										   <td width="70">
											<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:55px" value="<? echo $barcode_no; ?>" disabled/>
										   </td>
										   <td width="70">
											<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>" class="text_boxes" style="width:55px" value="<? echo $rft_id; ?>" />
										   </td>
										   <td width="65">
											<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
											<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
										   </td>
									   	</tr>
									   <?
									   $i++;
								   	}
	
								   	if ($is_salesOrder == 1)
								   	{
										$result = '';
								   	} 
								   	else 
								   	{
										if ($db_type == 0) {
											$plan_po_id = return_field_value("group_concat(distinct(po_id)) as po_id", "ppl_planning_entry_plan_dtls", "dtls_id='$booking_no' and status_active=1 and is_deleted=0", "po_id");
										} else {
											$plan_po_id = return_field_value("LISTAGG(po_id, ',') WITHIN GROUP (ORDER BY po_id) as po_id", "ppl_planning_entry_plan_dtls", "dtls_id='$booking_no' and status_active=1 and is_deleted=0", "po_id");
										}
										$plan_po_id = array_unique(explode(",", $plan_po_id));
										$result = implode(",", array_diff($plan_po_id, $all_po_id));
								   	}
	
								   	if ($result != "")
								   	{
										
										$po_sql = "select b.id, b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in ($result) order by b.pub_shipment_date, b.id";
										$nameArray = sql_select($po_sql);
										foreach ($nameArray as $row)
										{
											if ($i % 2 == 0)
												$bgcolor = "#E9F3FF";
											else
												$bgcolor = "#FFFFFF";
	
											$orginal_val = 1;
											$roll_id = 0;
											$roll_not_delete_id = 0;
											$disable = "";
											$tot_po_qnty += $row[csf('po_qnty_in_pcs')];
	
											$req_qnty = $program_qnty_array[$row[csf('id')]];
											$bl_qnty = $req_qnty - $recv_qnty_array[$row[csf('id')]];
											$balanceQty = number_format($yarn_balance_qty_arr[$row[csf('id')]],2,".","");
	
											?>
											<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
												<td width="110">
													<p><? echo $row[csf('po_number')]; ?></p>
													<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
													<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
													<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
													<!--This is used for not delete row which is used in batch -->
													<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
													<!--This is used for Duplication Check -->
													<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
												</td>
												<td width="60"><p><? echo $row[csf('grouping')]; ?>&nbsp;</p></td>
												<td width="80" align="right">
													<? echo $row[csf('po_qnty_in_pcs')]; ?>
													<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $row[csf('po_qnty_in_pcs')]; ?>">
												</td>
												<td width="70" align="center"><? echo change_date_format($row[csf('pub_shipment_date')]); ?></td>
												<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
												<td width="80" align="right"><? echo ""; ?></td>
												<td width="80" align="right"><? echo ""; ?></td>
												
												<td align="center" width="80">
													<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
												</td>

												<td align="center" width="80">
													<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
												</td>
												<td align="center" width="60">
													<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?>>
												</td>
												<td width="80" align="center">
													<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="calculate_tot_qnty();">
												</td>
												<td align="center" width="60">
													<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="" onBlur="roll_duplication_check(<? echo $i; ?>);" placeholder="<? //echo $roll_arr[$row[csf('id')]]+1; ?>" readonly/>
												</td>
												<td width="70">
													<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:55px" value="" disabled/>
												</td>
												<td width="70">
													<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>" class="text_boxes" style="width:55px" value="" />
												</td>
												<td width="65">
													<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
													<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
												</td>
											</tr>
											<?
											$i++;
										}
									}
								}
								else
								{
									$prev_po_qnty_arr = array();
									$prev_po_qnty_pcs_arr = array();
									$prev_reject_qnty_arr = array();
									$explSaveData = explode(",", $save_data);
									for ($z = 0; $z < count($explSaveData); $z++) 
									{
										$po_wise_data = explode("**", $explSaveData[$z]);
										/*echo "<pre>";
										print_r($po_wise_data);*/
										$order_id = $po_wise_data[0];
										$grey_qnty = $po_wise_data[1];
										$grey_qnty_pcs = $po_wise_data[7];
										$reject_qnty = $po_wise_data[2];
										$size = $po_wise_data[8];
										$prev_po_qnty_arr[$order_id] = $grey_qnty;
										$prev_po_qnty_pcs_arr[$order_id] = $grey_qnty_pcs;
										$prev_reject_qnty_arr[$order_id] = $reject_qnty;
										$prev_size_arr[$order_id] = $size;
									}
	
									$i = 1;
									$orginal_val = 1;
									$roll_id = 0;
									$roll_not_delete_id = 0;
	
									if ($is_salesOrder == 1) {
										$po_data = sql_select("select a.id, a.job_no as po_number, sum(b.grey_qty) as po_quantity, 1 as total_set_qnty from fabric_sales_order_mst a, fabric_sales_order_dtls b, ppl_planning_entry_plan_dtls c where a.id=b.mst_id and b.mst_id=c.po_id and c.dtls_id=$booking_no group by a.id, a.job_no");
									} else {
										$po_data = sql_select("select b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b, ppl_planning_entry_plan_dtls c where a.job_no=b.job_no_mst and b.id=c.po_id and c.dtls_id=$booking_no group by b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping order by b.pub_shipment_date, b.id");
									}
	
									$allPoId="";
									foreach ($po_data as $row) {
										$allPoId.= "'".$row[csf('id')]."'".',';
									}
									$allPoId=chop($allPoId,",");
	
									if($dtls_id) $dtls_id_cond = " and b.id<>$dtls_id";
									$program_recv_qnty_array = return_library_array("select c.po_breakdown_id, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c where a.id=b.mst_id and b.id=c.dtls_id and a.status_active=1 and a.entry_form=2  and a.receive_basis=2  and c.entry_form=2 and a.booking_no='$booking_no' and b.febric_description_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and  c.po_breakdown_id in($allPoId) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 $dtls_id_cond group by c.po_breakdown_id", "po_breakdown_id", "recv_qnty");
								
									foreach ($po_data as $row) {
										$po_qnty_in_pcs = $row[csf('po_quantity')] * $row[csf('total_set_qnty')];
										$tot_po_qnty += $po_qnty_in_pcs;
										$req_qnty = $program_qnty_array[$row[csf('id')]];
										//$bl_qnty = $req_qnty - $recv_qnty_array[$row[csf('id')]];
	
										$grey_qnty = $prev_po_qnty_arr[$row[csf('id')]];
										$grey_qnty_pcs = $prev_po_qnty_pcs_arr[$row[csf('id')]];
										$grey_size = $prev_size_arr[$row[csf('id')]];
										$tot_grey_qnty += $grey_qnty;
										$tot_grey_qnty_pcs += $grey_qnty_pcs;
										$reject_qnty = $prev_reject_qnty_arr[$row[csf('id')]];
										$tot_reject_qnty += $reject_qnty;
										$prev_own_rcv = $this_challan_rcv[$dtls_id][$row[csf('id')]];
	
										//$balanceQty = number_format($yarn_balance_qty_arr[$row[csf('id')]]+$prev_own_rcv,2,".","");
	
										//$balanceQty = number_format($yarn_balance_qty_arr[$row[csf('id')]],2,".","");
										//$yarn_over_balance = ($balanceQty*$over_production_percentage/100) + $balanceQty;
	
										$production_balance = $req_qnty - $program_recv_qnty_array[$row[csf('id')]];
										$req_qnty_with_over_perc = ($req_qnty*$over_production_percentage)/100 + $req_qnty;
										$production_over_balance = $req_qnty_with_over_perc - $program_recv_qnty_array[$row[csf('id')]];

										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$row[csf('id')]],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$row[csf('id')]] - $grey_production_qnty_arr[$row[csf('id')]] + $prev_own_rcv;
										$balanceQty = number_format($yarn_over_balance,2,".","");

	
										if ($i % 2 == 0)
											$bgcolor = "#E9F3FF";
										else
											$bgcolor = "#FFFFFF";
										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $row[csf('po_number')]; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
											</td>
											<td width="60"><p><? echo $row[csf('grouping')]; ?>&nbsp;</p></td>
											<td width="80" align="right">
												<? echo $po_qnty_in_pcs; ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $po_qnty_in_pcs; ?>">
											</td>
											<td width="70" align="center"><? if ($is_salesOrder != 1) echo change_date_format($row[csf('pub_shipment_date')]); ?> &nbsp;</td>
											<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
	
											<td width="80" align="right"><input type="text" name="txtGreyQntyCumulative[]" id="txtGreyQntyCumulative_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px;" value="<? echo $program_recv_qnty_array[$row[csf('id')]]; ?>" <? echo $disable; ?> disabled></td>
	
											<td width="80" align="right" title="with over production %  balance: <? echo $production_over_balance ?> and Yarn balance: <? echo $yarn_over_balance;?>"><? echo number_format($production_balance,2,".",""); ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" placeholder="<? if ($roll_maintained == 0) echo number_format($production_balance, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
											</td>
											<td align="center" width="60">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? echo $grey_size;//echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?>>
											</td>
											<td width="80" align="center">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>" onKeyUp="calculate_tot_qnty();">
											</td>
										</tr>
										<?
										$i++;
									}
								}
							}
							else
							{
								if ($receive_basis == 2) //Kniting plan un-save data
								{
									$i = 1;
									$orginal_val = 1;
									$roll_id = 0;
									$roll_not_delete_id = 0;
									$disable = "";
	
									$program_qnty_array = return_library_array("select b.po_id, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b where a.id=b.dtls_id and b.dtls_id='$booking_no' and b.determination_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and b.status_active=1 and b.is_deleted=0 group by b.po_id", "po_id", "qnty"); // and b.gsm_weight='$txt_gsm' and a.fabric_dia='$txt_width'
									if ($is_salesOrder == 1) {
										$po_data = sql_select("select a.id, a.job_no as po_number, sum(b.grey_qty) as po_quantity, 1 as total_set_qnty from fabric_sales_order_mst a, fabric_sales_order_dtls b, ppl_planning_entry_plan_dtls c where a.id=b.mst_id and b.mst_id=c.po_id and c.dtls_id=$booking_no group by a.id, a.job_no");
									} else {
										$po_data = sql_select("select b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping,c.po_id from wo_po_details_master a, wo_po_break_down b, ppl_planning_entry_plan_dtls c where a.job_no=b.job_no_mst and b.id=c.po_id and c.dtls_id=$booking_no group by b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping,c.po_id order by b.pub_shipment_date, b.id");
	
									}
									$allPoId="";
									foreach ($po_data as $row) {
										$allPoId.= "'".$row[csf('id')]."'".',';
									}
									$allPoId=chop($allPoId,",");
	
									/*$greyRecvQty =sql_select("select po_breakdown_id,sum(quantity) as prod_quantity from order_wise_pro_details where po_breakdown_id in($allPoId) and entry_form=2 and status_active=1 and is_deleted=0 group by po_breakdown_id");
									foreach ($greyRecvQty as $row) {
										$grey_receive_qnty_arr[$row[csf("po_breakdown_id")]]["prod_quantity"]=$row[csf("prod_quantity")];
									}*/
	
									$program_recv_qnty_array = return_library_array("  select c.po_breakdown_id, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c where a.id=b.mst_id and b.id=c.dtls_id and a.status_active=1 and a.entry_form=2  and a.receive_basis=2  and c.entry_form=2 and a.booking_no='$booking_no' and b.febric_description_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and  c.po_breakdown_id in($allPoId) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 group by c.po_breakdown_id", "po_breakdown_id", "recv_qnty");
	
									foreach ($po_data as $row)
									{
										$po_qnty_in_pcs = $row[csf('po_quantity')] * $row[csf('total_set_qnty')];
										$tot_po_qnty += $po_qnty_in_pcs;
	
										//===================
										
										//echo $row[csf('id')];
										$req_qnty = $program_qnty_array[$row[csf('id')]];
										$bl_qnty = $req_qnty - $recv_qnty_array[$row[csf('id')]];
										
										//$grey_qnty = $prev_po_qnty_arr[$row[csf('id')]];
	
										$production_balance =$req_qnty-$program_recv_qnty_array[$row[csf('id')]];

										$req_qnty_with_over_perc = ($req_qnty*$over_production_percentage)/100 + $req_qnty;
										$production_over_balance = $req_qnty_with_over_perc - $recv_qnty_array[$row[csf('id')]];
										
										//------------------------------------------------------


										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$row[csf('id')]],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$row[csf('id')]] - $grey_production_qnty_arr[$row[csf('id')]];

										$balanceQty = number_format($yarn_over_balance,2,".","");
										//$yarn_over_balance = ($balanceQty*$over_production_percentage)/100 + $balanceQty;
	
										if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $row[csf('po_number')]; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>"><!-- =kp save= -->
											</td>
											<td width="60"><p><? echo $row[csf('grouping')]; ?>&nbsp;</p></td>
											<td width="80" align="right">
												<? echo ($is_salesOrder == 1) ? "" : $po_qnty_in_pcs; ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $po_qnty_in_pcs; ?>">
											</td>
											<td width="70" align="center"><p><? if ($is_salesOrder != 1) echo change_date_format($row[csf('pub_shipment_date')]); ?>&nbsp;</p></td>
											<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
											<td width="80" align="right">
												<input type="text" name="txtGreyQntyCumulative[]" id="txtGreyQntyCumulative_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px;" value="<? echo $program_recv_qnty_array[$row[csf('id')]]; ?>" <? echo $disable; ?> disabled>
											</td>
											<td width="80" align="right" title="with over production %  balance: <? echo $production_over_balance ?> and Yarn balance: <? echo $yarn_over_balance;?>">
												<? //echo $balanceQty;
													echo number_format($production_balance, 2, '.', ''); 
												?>
											</td>
											<td width="80" align="center">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" <? echo $disable; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($production_balance, 2, '.', ''); ?>" onClick="get_weight_from_weight_machine(<? echo $i; ?>)" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>
											<td width="80" align="center">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" <? echo $disable_td; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
											</td>
											<td align="center" width="60">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?> placeholder="B/W" onDblClick="func_onDblClick_finishSize(<? echo $i; ?>);" />
											</td>
											<td width="80" align="center">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="calculate_tot_qnty();">
											</td>
											<?
											if ($roll_maintained == 1)
											{
												?>
												<td align="center" width="60">
													<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?> placeholder="<? //echo $roll_arr[$row[csf('id')]]+1; ?>" onBlur="roll_duplication_check(<? echo $i; ?>);" readonly/>
												</td>
												<td width="70">
													<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:55px" value="" disabled/>
												</td>
												<td width="70">
													<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>" class="text_boxes" style="width:55px" value="" />
												</td>
												<td width="65">
													<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
													<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
												</td>
												<?
											}
											?>
										</tr>
										<?
										$i++;
									}
								}
								else // without knitting plan
								{
								
									if ($type == 1) {
										if ($po_id != "") {
											$po_sql = "select b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in ($po_id) order by b.pub_shipment_date, b.id";
										}
									} else {
										$po_sql = "select b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b, wo_booking_dtls c where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and c.booking_no='$booking_no' and c.status_active=1 and c.is_deleted=0 group by b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping order by b.pub_shipment_date, b.id";
	
										$booking_qnty_array = return_library_array("select a.po_break_down_id, sum(a.grey_fab_qnty) as qnty from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b where a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no='$booking_no' and b.lib_yarn_count_deter_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and b.gsm_weight='$txt_gsm' and a.dia_width='$txt_width' and a.job_no=b.job_no and a.status_active=1 and a.is_deleted=0 group by a.po_break_down_id", "po_break_down_id", "qnty");
									}
	
	
									$nameArray = sql_select($po_sql);
									$allPoId="";
									foreach ($nameArray as $row) {
										$allPoId.= "'".$row[csf('id')]."'".',';
									}
									$allPoId=chop($allPoId,",");
									/*$greyRecvQty =sql_select("select po_breakdown_id,sum(quantity) as prod_quantity from order_wise_pro_details where po_breakdown_id in($allPoId) and entry_form=2 and status_active=1 and is_deleted=0 group by po_breakdown_id");
	
									foreach ($greyRecvQty as $row) {
										$grey_receive_qnty_arr[$row[csf("po_breakdown_id")]]["prod_quantity"]=$row[csf("prod_quantity")];
									}*/
	
									foreach ($nameArray as $row)
									{
										if ($i % 2 == 0)
											$bgcolor = "#E9F3FF";
										else
											$bgcolor = "#FFFFFF";
	
										$orginal_val = 1;
										$roll_id = 0;
										$roll_not_delete_id = 0;
										$disable = "";//$disable_td="";
	
										$po_qnty_in_pcs = $row[csf('po_quantity')] * $row[csf('total_set_qnty')];
										$tot_po_qnty += $po_qnty_in_pcs;
										//$balanceQty = $yarn_balance_qty_arr[$row[csf('id')]];

										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$row[csf('id')]],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$row[csf('id')]] - $grey_production_qnty_arr[$row[csf('id')]];

										$balanceQty = number_format($yarn_over_balance,2,".","");

										//echo $cbo_body_part.'ddd';
										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $row[csf('po_number')]; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
											</td>
											<td width="60"><p><? echo $row[csf('grouping')]; ?>&nbsp;</p></td>
											<td width="80" align="right">
												<? echo $po_qnty_in_pcs; ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $po_qnty_in_pcs; ?>">
											</td>
											<td width="70" align="center"><? echo change_date_format($row[csf('pub_shipment_date')]); ?></td>
											<?
											if ($receive_basis == 1) {
												$req_qnty = $booking_qnty_array[$row[csf('id')]];
												$production_balance = $req_qnty - $recv_qnty_array[$row[csf('id')]];
												echo '<td width="80" align="right">' . number_format($req_qnty, 2, '.', '') . '</td>';
											} else {
												$production_balance = '';
												$req_qnty = '';
											}
											?>
											<td width="80" align="right"><? echo number_format($recv_qnty_array[$row[csf('id')]], 2, '.', ''); ?></td>
											<td width="80" align="right"><? echo number_format($production_balance, 2, '.', ''); ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" <? echo $disable; ?> placeholder="<? if ($receive_basis == 1 && $roll_maintained == 0) echo number_format($production_balance, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($receive_basis == 1 && $roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();" <? echo $disable_td; ?> >
											</td>
											<td align="center" width="60">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?>>
											</td>
											<td width="80" align="center">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="calculate_tot_qnty();">
											</td>
											<?
											if ($roll_maintained == 1)
											{
												?>
												<td align="center" width="60">
													<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?> placeholder="<? //echo $roll_arr[$row[csf('id')]]+1; ?>" onBlur="roll_duplication_check(<? echo $i; ?>);" readonly/>
												</td>
												<td width="70">
													<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:55px" value="" disabled/>
												</td>
												<td width="70">
													<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>"  class="text_boxes" style="width:55px" value="" />
												</td>
												<td width="65">
													<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
													<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
												</td>
												<?
											}
											?>
										</tr>
										<?
										$i++;
									}
								}
							}
						?>
						<input type="hidden" name="tot_po_qnty" id="tot_po_qnty" class="text_boxes" value="<? echo $tot_po_qnty; ?>">
						<input type="hidden" name="txt_tot_row" id="txt_tot_row" class="text_boxes" value="<? echo $i - 1; ?>">
					</table>
					</div>
					<table width="<? echo $width + 220; ?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="tbl_bottom">
						<tr>
							<td width="110"></td>
							<td width="60"></td>
							<td width="80"></td>
							<td width="70"></td>
							<td width="80"></td>
	
							<?
							if ($receive_basis == 1 || $receive_basis == 2)
							{
								echo '<td width="80"></td>';
							}
							?>
							<td width="80" align="right"><b>Total</b></td>
							<td style="text-align:center" width="80"><input type="text" name="txt_tot_grey_qnty" id="txt_tot_grey_qnty" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_grey_qnty, 2); ?>" disabled></td>
							<td style="text-align:center" width="80"><input type="text" name="txt_tot_grey_qnty_pcs" id="txt_tot_grey_qnty_pcs" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_grey_qnty_pcs, 2); ?>" disabled></td>
							<td align="center" width="60"> </td>
							<td width="80" style="text-align:center"><input type="text" name="txt_tot_reject_qnty" id="txt_tot_reject_qnty" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_reject_qnty, 2); ?>" disabled >
							</td>
							<?
							if ($roll_maintained == 1) {
								//<td width="80"></td><td width="80"></td><td width="80"></td><td width="80">
								echo '<td width="60"></td><td width="70"></td><td width="70"></td><td width="65"></td>';
							}
							?>
						</tr>
					</table>
					<table width="<? echo $width; ?>">
						<tr>
							<td align="center">
								<input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="fnc_close();" style="width:100px"/>
							</td>
						</tr>
					</table>
				</div>
				<? 
				// echo "string.$is_salesOrder";die;
			}
			else // sample program
			{
				if ($receive_basis == 2)
				{
					$disabled = "";
					$disabled_dropdown = 0;
					if ($receive_basis == 0 || $roll_maintained == 1)
					{
						$prev_distribution_method = 2;
						$disabled = "disabled='disabled'";
						$disabled_dropdown = 1;
					
					}
					$width = 950;
					?>
					<div style="width:<? echo $width; ?>px; margin-top:5px;" align="center">
                        <table style="margin-bottom:5px;" class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="300" align="center">
                            <thead>
                                <th>Total QC Pass Qty.</th>
                                <th>Distribution Method</th>
                            </thead>
                            <tr class="general">
                                <td><input type="text" name="txt_prop_grey_qnty" id="txt_prop_grey_qnty"
                                    class="text_boxes_numeric" value="<? echo $txt_receive_qnty; ?>" style="width:120px" onBlur="distribute_qnty(document.getElementById('cbo_distribiution_method').value)" <? echo $disabled; ?> >
                                    <input type="hidden" name="over_production_percentage" id="over_production_percentage" value="<? echo $over_production_percentage;?>">
                                </td>
                                <td>
                                    <?
                                    echo create_drop_down("cbo_distribiution_method", 250, $distribiution_method, "", 0, "", $prev_distribution_method, "distribute_qnty(this.value);", $disabled_dropdown);
                                    ?>
                                </td>
                            </tr>
                        </table>
					</div>
                    <table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="<? echo $width; ?>">
                        <caption style="font-weight:bold;color:red;">Over Production Percentage: <? echo $over_production_percentage; ?>%</caption>
                        <thead>
                            <th width="130">Program No</th>
                            <th width="80">Program Qty.</th>
                            <th width="80">Cumulative Production Qty.</th>
                            <th width="80">Balance Qty</th>
                            <th width="80">QC Pass Qty</th>
                            <th width="80">Qty. In Pcs</th>
                            <th width="80">Size</th>
                            <th width="80">Reject Qty.</th>
                            <th width="80">Roll</th>
                            <th width="100">Barcode No.</th>
                            <th></th>
                        </thead>
                    </table>
                    <div style="width:<? echo $width+20; ?>px; max-height:200px; overflow-y:scroll" id="list_container" align="left">
                    	<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="<? echo $width; ?>" id="tbl_list_search">
							<?php
							//for yarn issue check
							if ($production_control == 1)
							{
								$yarn_balance_qty_arr = array();
								if ($dtls_id == "")
									$dtls_id_cond2 = "";
								else
									$dtls_id_cond2 = "and dtls_id<>$dtls_id";

								/*
								|--------------------------------------------------------------------------
								| for yarn issue
								|--------------------------------------------------------------------------
								|
								*/
								$yarn_issue_sql = sql_select("select (b.cons_quantity) as issue_qnty, c.id as issue_id 
								from ppl_yarn_requisition_entry a, inv_transaction b, inv_issue_master c 
								where a.requisition_no= b.requisition_no and b.item_category =1 and b.transaction_type =2 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted =0 and b.company_id = $cbo_company_id and  a.knit_id=$booking_id and b.mst_id = c.id and c.entry_form =3 and c.issue_basis in (3,8) and b.receive_basis in (3,8)");
								$yarn_issue_qnty=0;
								$yarn_issue_return_qnty =0;
								foreach ($yarn_issue_sql as $val)
								{
									$yarn_issue_qnty_arr += $val[csf("issue_qnty")];
									//$yarn_balance_qty_arr += $val[csf("issue_qnty")];
									$yarn_issue_id_arr[$val[csf("issue_id")]] = $val[csf("issue_id")];
								}
						
								if($yarn_issue_id_arr>0)
								{
									$yarn_issue_ids = implode(",", $yarn_issue_id_arr);
									$all_yarn_issue_cond="";
									$barCond="";
									if($db_type==2 && count($yarn_issue_id_arr)>999)
									{
										$yarn_issue_id_arr_chunk=array_chunk($yarn_issue_id_arr,999) ;
										foreach($yarn_issue_id_arr_chunk as $chunk_arr)
										{
											$chunk_arr_value=implode(",",$chunk_arr);
											$issCond.="  a.issue_id in($chunk_arr_value) or ";
										}
										$all_yarn_issue_cond.=" and (".chop($issCond,'or ').")";
									}
									else
									{
										$all_yarn_issue_cond=" and a.issue_id in($yarn_issue_ids)";
									}
						
									/*
									|--------------------------------------------------------------------------
									| for yarn issue return
									|--------------------------------------------------------------------------
									|
									*/
									$yarn_issue_return_sql = sql_select("select b.cons_quantity as quantity
									from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c 
									where a.id = b.mst_id and a.entry_form =  9 and a.receive_basis = 3 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_id = c.requisition_no and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.status_active=1 and c.status_active=1
									union all
									select b.cons_quantity as quantity 
									from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c 
									where a.id=b.mst_id and a.entry_form =9 and a.receive_basis =8 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_no=c.requisition_no and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.status_active=1 and c.status_active=1");
						
									foreach ($yarn_issue_return_sql as $val)
									{
										//$yarn_balance_qty_arr -= $val[csf("quantity")];
										$yarn_issue_return_qnty_arr += $val[csf("quantity")];
									}
								}
							}

                            $i = 0;
                            $tot_po_qnty = 0;
                            $tot_grey_qnty = 0;
                            $tot_grey_qnty_pcs = 0;
                            $tot_reject_qnty = 0;
                            $po_array = array();
                            
                            $orginal_val = 1;
                            $roll_id = 0;
                            $roll_not_delete_id = 0;
                            $disable = "";

                            /*
							|--------------------------------------------------------------------------
							| for program qty
							|--------------------------------------------------------------------------
							|
							*/
							$programSql = "
                                SELECT
                                    b.dtls_id as program_id, sum(b.program_qnty) as qnty, c.id as booking_id 
                                FROM
                                    ppl_planning_info_entry_dtls a,
                                    ppl_planning_entry_plan_dtls b,
									wo_non_ord_samp_booking_mst c
									
                                WHERE
                                    a.id=b.dtls_id
									AND b.booking_no=c.booking_no 
                                    AND b.dtls_id='".$booking_no."' 
                                    AND b.determination_id='".$fabric_desc_id."' 
                                    AND b.body_part_id='".$cbo_body_part."' 
                                    AND b.status_active=1 
                                    AND b.is_deleted=0
                                GROUP BY
                                    b.dtls_id, c.id
                            ";
                            // and b.gsm_weight='$txt_gsm' and a.fabric_dia='$txt_width'
                            //echo $programSql;
							$programArr = sql_select($programSql);
                            //echo "<pre>";
                            //print_r($programArr);
                            
                            $programIdArr = array();
							$sampleBookingId = 0;
                            foreach ($programArr as $row)
                            {
                                $sampleBookingId = $row[csf('booking_id')];
								$programIdArr[$row[csf('program_id')]] = $row[csf('program_id')];
                            }
                            $programIdString = implode(",", $programIdArr);
                            //echo $programIdString;
                            
                            /*
							|--------------------------------------------------------------------------
							| for production qty
							|--------------------------------------------------------------------------
							|
							*/
							$productionQtyArr = array();
                            if($programIdString != '')
                            {									
                                if($dtls_id!="")
                                    $dtls_id_cond = " AND a.id <> ".$dtls_id."";
                                    
                                $productionSql ="
                                    SELECT
                                        b.booking_id AS program_id, SUM(a.grey_receive_qnty) AS prod_quantity 
                                    FROM
                                        pro_grey_prod_entry_dtls a,
                                        inv_receive_master b 
                                    WHERE
                                        a.mst_id = b.id 
                                        AND b.entry_form = 2 
                                        AND b.booking_id IN (".$programIdString.") 
                                        AND a.febric_description_id = '".$fabric_desc_id."' 
                                        AND a.body_part_id='".$cbo_body_part."' 
                                        AND a.gsm='".$txt_gsm."' 
                                        AND a.status_active=1 
                                        AND b.status_active=1 
                                        ".$dtls_id_cond." 
                                    GROUP BY
                                        b.booking_id
                                ";
                                //echo $productionSql;
                                $productionSqlArr =sql_select($productionSql);
                                foreach ($productionSqlArr as $row)
                                {
                                    $productionQtyArr[$row[csf('program_id')]]['prod_quantity']=$row[csf('prod_quantity')];
                                }
                            }
                            
                            $programQty = $programArr[0][csf('qnty')];
                            $productionQty = 0;
                            if(!empty($productionQtyArr))
                            {
                                $productionQty = $productionQtyArr[$programArr[0][csf('program_id')]]['prod_quantity'];
                            }
                            //$productionBalance = $programQty - $productionQty;
							
							$req_qnty_with_over_perc = ($programQty*$over_production_percentage)/100 + $programQty;
							$production_over_balance = $req_qnty_with_over_perc - $productionQty;
							$yarn_issue_quantity = number_format($yarn_issue_qnty_arr,2,".","");
							$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
							$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr*1 - $productionQty;
							$productionBalance = number_format($yarn_over_balance,2,".","");
							
                            if($save_data == "")
                            {
                                $i++;
                                ?>
                                <tr bgcolor="#FFFFFF" id="tr_1">
                                    <td width="130">
                                        <p><? echo $booking_no; ?></p>
                                        <input type="hidden" name="txtPoId[]" id="txtPoId_1" value="<? echo $sampleBookingId; ?>">
                                        <input type="hidden" name="txtOrginal[]" id="txtOrginal_1" value="<? echo $orginal_val; ?>">
                                        <input type="hidden" name="txtRollId[]" id="txtRollId_1" value="<? echo $roll_not_delete_id; ?>">
                                        <!--This is used for not delete row which is used in batch -->
                                        <input type="hidden" name="txtRollTableId[]" id="txtRollTableId_1" value="<? echo $roll_id; ?>">
                                        <!--This is used for Duplication Check -->
                                        <input type="hidden" name="balanceQty[]" id="balanceQty_1" value="<? echo number_format($productionBalance, 2, '.', '');//echo $balanceQty; ?>">
                                    </td>
                                    <td width="80" align="right"><? echo number_format($programQty, 2, '.', ''); ?></td>
                                    <td width="80" align="right"><? echo number_format($productionQty, 2, '.', ''); ?></td>
                                    <td width="80" align="right"><? echo number_format($productionBalance, 2, '.', ''); ?></td>
                                    <td align="center" width="80">
                                        <input type="text" name="txtGreyQnty[]" id="txtGreyQnty_1" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($productionBalance, 2, '.', ''); ?>" onKeyUp="fn_check_balance(1);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
                                    </td>
                                    <td align="center" width="80">
                                        <input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_1" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="calculate_tot_qnty();" <? echo $disable_td; ?>>
                                    </td>
                                    <td align="center" width="80">
                                        <input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:60px" value="<? echo $size_qty; ?>" <? echo $disable_td; ?>  placeholder="B/W" onDblClick="func_onDblClick_finishSize(<? echo $i; ?>);" />
                                    </td>
                                    <td align="center" width="80">
                                        <input type="text" name="txtRejectQnty[]" id="txtRejectQnty_1" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="calculate_tot_qnty();">
                                    </td>
                                    <td align="center" width="80">
                                        <input type="text" name="txtRoll[]" id="txtRoll_1" class="text_boxes_numeric" style="width:60px" value="" readonly/>
                                    </td>
                                    <td width="100" align="center">
                                    <input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_1" class="text_boxes_numeric" style="width:80px" value="" disabled/>
                                    </td>
                                    <td>
                                        <input type="button" id="increase_1" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr(1)"/>
                                        <input type="button" id="decrease_1" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(1);"/>
                                    </td>
                                </tr>
                                <?
                            }
                            else
							{
								$explSaveData = explode(",", $save_data);
								for ($z = 0; $z < count($explSaveData); $z++)
								{
									$po_wise_data = explode("**", $explSaveData[$z]);
									$roll_ids[$po_wise_data[5]] = $po_wise_data[5];
								}
								$roll_ids = implode(',',array_keys($roll_ids));
		
								if($roll_ids!="")
								{
									$sqlroll = sql_select("select barcode_no,roll_used from pro_roll_details where status_active=1 and is_deleted=0 and id in(".$roll_ids.")");
									foreach ($sqlroll as $row)
									{
										$rollData[$row[csf("barcode_no")]]['roll_used'] = $row[csf("roll_used")];
									}
								}
		
								for ($z = 0; $z < count($explSaveData); $z++) 
								{
									$i++;
		
									if ($i % 2 == 0)
										$bgcolor = "#E9F3FF";
									else
										$bgcolor = "#FFFFFF";
		
									$po_wise_data = explode("**", $explSaveData[$z]);
									$order_id = $po_wise_data[0];
									$grey_qnty = $po_wise_data[1];
									$reject_qnty = $po_wise_data[2];
									$roll_no = $po_wise_data[3];
									$roll_not_delete_id = $po_wise_data[4];
									$roll_id = $po_wise_data[5];
									$barcode_no = $po_wise_data[6];
									$grey_qnty_pcs = $po_wise_data[7];
									$r_floor_id = $po_wise_data[10];
									$r_room_id = $po_wise_data[11];
									$r_rack_id = $po_wise_data[12];
									$r_self_id = $po_wise_data[12];
		
									$bl_qnty = $req_qnty - $recv_qnty;
									$size_data=$po_wise_data[8];
		
									$roll_used = $rollData[$barcode_no]['roll_used'];//return_field_value("roll_used", "pro_roll_details", "id='$roll_id'");
		
									if ($roll_used == 1)
									{
										$orginal_val = 1;
										$disable = "disabled='disabled'";
									}
									else
									{
										$disable = "";
										$roll_not_delete_id = 0;
										$orginal_val = 0;
									}
		
									$tot_grey_qnty += $grey_qnty;
									$tot_grey_qnty_pcs += $grey_qnty_pcs;
									$tot_reject_qnty += $reject_qnty;
									$balanceQty = 0;
									//$productionBalance = $grey_qnty - $productionQty;

									$yarn_issue_quantity = number_format($yarn_issue_qnty_arr,2,".","");
									$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
									$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr - $grey_qnty;
									$productionBalance = number_format($yarn_over_balance,2,".","");
									?>
									<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
										<td width="130">
											<p><? echo $booking_no; ?></p>
											<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $sampleBookingId; ?>">
											<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
											<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
											<!--This is used for not delete row which is used in batch -->
											<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
											<!--This is used for Duplication Check -->
											<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo number_format($productionBalance, 2, '.', ''); ?>">
										</td>
										<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
										<td width="80" align="right"><input type="text" name="txtGreyQntyCumulative[]" id="txtGreyQntyCumulative_<? echo $i; ?>" class="text_boxes_numeric" style="width:70px;" value="<? echo number_format($productionQty,2,'.',''); ?>" <? echo $disable; ?> disabled></td>
										<td width="80" align="right"><? echo number_format($productionBalance, 2, '.', ''); ?></td>
										<td align="center" width="80">
											<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i;?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
										</td>
										<td align="center" width="80">
											<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="calculate_tot_qnty();">
										</td>
										<td align="center" width="80">
											<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes"  style="width:60px" value="<? echo $size_data; ?>" <? echo $disable_td; ?>  placeholder="B/W" onDblClick="func_onDblClick_finishSize(<? echo $i; ?>);" />
										</td>
										<td align="center" width="80">
											<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>" <? echo $disable; ?> onKeyUp="calculate_tot_qnty();">
										</td>
										<td align="center" width="80">
											<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?> readonly/>
										</td>
										<td width="100" align="center"><input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:80px" value="<? echo $barcode_no; ?>" disabled/></td>
                                        <td>
                                            <input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
                                            <input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
                                        </td>
                                    </tr>
                                    <?
                                }
                            }
                            ?>
                            <input type="hidden" name="tot_po_qnty" id="tot_po_qnty" class="text_boxes" value="<? echo $tot_po_qnty; ?>">
                            <input type="hidden" name="txt_tot_row" id="txt_tot_row" class="text_boxes" value="<? echo $i - 1; ?>">
                        </table>
                    </div>
                    <table width="<? echo $width; ?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="tbl_bottom">
                        <tr>
                            <td width="130"></td>
                            <td width="80"></td>
                            <td width="80"></td>
                            <td width="80" align="right"><b>Total</b></td>
                            <td style="text-align:center" width="80"><input type="text" name="txt_tot_grey_qnty" id="txt_tot_grey_qnty" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_grey_qnty, 2); ?>" disabled></td>
                            <td style="text-align:center" width="80"><input type="text" name="txt_tot_grey_qnty_pcs" id="txt_tot_grey_qnty_pcs" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_grey_qnty_pcs, 2); ?>" disabled></td>
                            <td align="center" width="80"> </td>
                            <td width="80" style="text-align:center"><input type="text" name="txt_tot_reject_qnty" id="txt_tot_reject_qnty" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_reject_qnty, 2); ?>" disabled >
                            </td>
                            <?
                            if ($roll_maintained == 1) {
                                //<td width="80"></td><td width="80"></td><td width="80"></td><td width="80">
                                echo '<td width="80"></td><td width="100"></td><td></td>';
                            }
                            ?>
                        </tr>
                    </table>
                    <table width="<? echo $width; ?>">
                        <tr>
                            <td align="center">
                                <input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="fnc_close();" style="width:100px"/>
                            </td>
                        </tr>
                    </table>
					</div>
					<?
				}
			}
		}
	}
	if ($type != 1)
	{
		?>
		</fieldset>
		</form>
		<?
	}
		?>
	</body>
	<script src="../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if ($action == "po_popup_stylewise")
{
	echo load_html_head_contents("PO Info", "../../", 1, 1, '', '', '');
	extract($_REQUEST);

	$data = explode("_", $data);
	$po_id = $data[0];
	$type = $data[1];
	//echo $booking_without_order;
	//echo "**".$type;die;

	$max_roll_weight = return_field_value("max_roll_weight", "variable_settings_production", "status_active=1 and company_name=$cbo_company_id and variable_list=49");

	if ($receive_basis == 0) {
		$booking_without_order = 0;
	}

	$is_salesOrder = 0;
	if ($receive_basis == 4)
	{
		$is_salesOrder = 1;
	}
	else if ($receive_basis == 2)
	{
		$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=$booking_id");
		if ($is_salesOrder == "")
			$is_salesOrder = 0;
	}

	if ($type == 1) {
		$dtls_id = $data[2];
		$roll_maintained = $data[3];
		$save_data = $data[4];
		$prev_distribution_method = $data[5];
		$receive_basis = $data[6];
		$txt_deleted_id = $data[7];
		$txt_reject_fabric_recv_qnty = $data[8];
		$production_control = $data[9];
		$cbo_body_part = $data[10];
		$booking_without_order = 0;

	}
	//$cbo_body_part=503;
	//echo $cbo_body_part.'ddd';
	$recv_qnty_array = array();
	if ($receive_basis == 1 || $receive_basis == 2 || $receive_basis == 4)
	{
		if ($booking_without_order == 1 && $receive_basis == 1)
		{
			if ($dtls_id == "") $dtls_id_cond = ""; else $dtls_id_cond = "and b.id<>$dtls_id";
			$recvData = sql_select("select sum(b.grey_receive_qnty) as grey_prod_qnty from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and a.booking_no='$booking_no' and a.booking_without_order=1 and b.febric_description_id='$fabric_desc_id' and b.gsm='$txt_gsm' and b.width='$txt_width' and b.body_part_id='$cbo_body_part' and a.entry_form=2 and b.is_deleted=0 and b.status_active=1 $dtls_id_cond");
			$recv_qnty = $recvData[0][csf('grey_prod_qnty')];
		}
		else
		{
			if ($dtls_id == "") $dtls_id_cond = ""; else $dtls_id_cond = "and a.dtls_id<>$dtls_id";
			/*$recvData = sql_select("select a.po_breakdown_id, sum(quantity) as grey_prod_qnty from order_wise_pro_details a, pro_grey_prod_entry_dtls b where a.dtls_id=b.id and a.prod_id=b.prod_id and b.febric_description_id='$fabric_desc_id' and b.gsm='$txt_gsm' and b.width='$txt_width' and b.body_part_id='$cbo_body_part' and a.entry_form=2 and a.is_deleted=0 and a.status_active=1 and a.is_sales=$is_salesOrder $dtls_id_cond group by a.po_breakdown_id");*/
			$recvData = sql_select("select d.job_no, sum(quantity) as grey_prod_qnty from order_wise_pro_details a, pro_grey_prod_entry_dtls b, wo_po_break_down c, wo_po_details_master d where a.dtls_id=b.id and a.prod_id=b.prod_id and a.po_breakdown_id=c.id and c.job_id=d.id and b.febric_description_id='$fabric_desc_id' and b.gsm='$txt_gsm' and b.width='$txt_width' and b.body_part_id='$cbo_body_part' and a.entry_form=2 and a.is_deleted=0 and a.status_active=1 and a.is_sales=$is_salesOrder $dtls_id_cond group by d.job_no");


			foreach ($recvData as $row)
			{
				$recv_qnty_array[$row[csf('po_breakdown_id')]] = $row[csf('grey_prod_qnty')];
			}
		}
	}

	if ($production_control == 1)
	{
		$yarn_balance_qty_arr = array();

		if ($dtls_id == "") $dtls_id_cond2 = ""; else $dtls_id_cond2 = "and dtls_id<>$dtls_id";
		if($receive_basis==2)
		{
			/*$yarn_issue_sql = sql_select("select distinct (d.id), (d.quantity) as issue_qnty,c.id as issue_id, d.po_breakdown_id from ppl_yarn_requisition_entry a, inv_transaction b, inv_issue_master c, order_wise_pro_details d where a.requisition_no= b.requisition_no and b.item_category =1 and b.transaction_type =2 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted =0 and d.status_active =1 and d.is_deleted = 0 and b.company_id = $cbo_company_id and  a.knit_id=$booking_id and b.mst_id = c.id and c.entry_form =3 and c.issue_basis in (3,8) and b.receive_basis in (3,8) and b.id=d.trans_id and d.entry_form =3 ");*/
			if($is_salesOrder == 1)
			{
				$yarn_issue_sql = sql_select("select distinct (d.id), (d.quantity) as issue_qnty,c.id as issue_id, e.job_no from ppl_yarn_requisition_entry a, inv_transaction b, inv_issue_master c, order_wise_pro_details d, fabric_sales_order_mst e where a.requisition_no= b.requisition_no and b.item_category =1 and b.transaction_type =2 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted =0 and d.status_active =1 and d.is_deleted = 0 and b.company_id = $cbo_company_id and a.knit_id=$booking_id and b.mst_id = c.id and c.entry_form =3 and c.issue_basis in (3,8) and b.receive_basis in (3,8) and b.id=d.trans_id and d.entry_form =3 and d.po_breakdown_id=e.id and d.is_sales=1");
			}
			else
			{
				$yarn_issue_sql = sql_select("select distinct (d.id), (d.quantity) as issue_qnty,c.id as issue_id, f.job_no from ppl_yarn_requisition_entry a, inv_transaction b, inv_issue_master c, order_wise_pro_details d, wo_po_break_down e, wo_po_details_master f where a.requisition_no= b.requisition_no and b.item_category =1 and b.transaction_type =2 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted =0 and d.status_active =1 and d.is_deleted = 0 and b.company_id = $cbo_company_id and  a.knit_id=$booking_id and b.mst_id = c.id and c.entry_form =3 and c.issue_basis in (3,8) and b.receive_basis in (3,8) and b.id=d.trans_id and d.entry_form =3 and d.po_breakdown_id=e.id and e.job_id=f.id and d.is_sales=0");
			}
			
			

			$yarn_issue_qnty=0; $yarn_issue_return_qnty =0;
			foreach ($yarn_issue_sql as $val)
			{
				$yarn_issue_qnty_arr[$val[csf('job_no')]] += $val[csf("issue_qnty")];
				$yarn_balance_qty_arr[$val[csf('job_no')]] += $val[csf("issue_qnty")];
				$yarn_issue_id_arr[$val[csf("issue_id")]] = $val[csf("issue_id")];
			}

			$yarn_issue_id_arr =array_filter($yarn_issue_id_arr);

			if(count($yarn_issue_id_arr)>0)
			{
				$yarn_issue_ids = implode(",", $yarn_issue_id_arr);
				$all_yarn_issue_cond=""; $barCond="";
				if($db_type==2 && count($yarn_issue_id_arr)>999)
				{
					$yarn_issue_id_arr_chunk=array_chunk($yarn_issue_id_arr,999) ;
					foreach($yarn_issue_id_arr_chunk as $chunk_arr)
					{
						$chunk_arr_value=implode(",",$chunk_arr);
						$issCond.="  a.issue_id in($chunk_arr_value) or ";
					}
					$all_yarn_issue_cond.=" and (".chop($issCond,'or ').")";
				}
				else
				{
					$all_yarn_issue_cond=" and a.issue_id in($yarn_issue_ids)";
				}

				/*$yarn_issue_return_sql = sql_select("select d.id, d.quantity, d.po_breakdown_id from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c, order_wise_pro_details d where a.id = b.mst_id and a.entry_form =  9 and a.receive_basis = 3 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_id = c.requisition_no and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.id = d.trans_id and d.entry_form =9 and b.status_active=1 and c.status_active=1 and d.status_active=1 group by d.id, d.quantity, d.po_breakdown_id
					union all
					select d.id, d.quantity, d.po_breakdown_id 
					from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c, order_wise_pro_details d 
					where a.id=b.mst_id and a.entry_form =9 and a.receive_basis =8 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_no=c.requisition_no and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.id=d.trans_id and d.entry_form =9 and b.status_active=1 and c.status_active=1 and d.status_active=1 group by d.id, d.quantity, d.po_breakdown_id ");*/

				if($is_salesOrder==1)
				{
					$yarn_issue_return_sql = sql_select("SELECT d.id, d.quantity, e.job_no from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c, order_wise_pro_details d, fabric_sales_order_mst e 
					where a.id = b.mst_id and a.entry_form =  9 and a.receive_basis = 3 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_id = c.requisition_no and d.po_breakdown_id=e.id and d.is_sales=1 and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.id = d.trans_id and d.entry_form =9 and b.status_active=1 and c.status_active=1 and d.status_active=1 group by d.id, d.quantity, e.job_no
					union all
					select d.id, d.quantity, e.job_no 
					from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c, order_wise_pro_details d, fabric_sales_order_mst e
					where a.id=b.mst_id and a.entry_form =9 and a.receive_basis =8 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id 
					and a.booking_no=cast(c.requisition_no as varchar(200)) and d.po_breakdown_id=e.id and d.is_sales=1 and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.id=d.trans_id and d.entry_form =9 and b.status_active=1 and c.status_active=1 and d.status_active=1 group by d.id, d.quantity, e.job_no");
				}
				else
				{
					$yarn_issue_return_sql = sql_select("SELECT d.id, d.quantity, f.job_no 
						from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c, order_wise_pro_details d, wo_po_break_down e, wo_po_details_master f 
						where a.id = b.mst_id and a.entry_form =  9 and a.receive_basis = 3 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_id = c.requisition_no and d.po_breakdown_id=e.id and e.job_id=f.id and d.is_sales=0 and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.id = d.trans_id and d.entry_form =9 and b.status_active=1 and c.status_active=1 and d.status_active=1 group by d.id, d.quantity, f.job_no
					union all
					select d.id, d.quantity, f.job_no 
					from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c, order_wise_pro_details d, wo_po_break_down e, wo_po_details_master f
					where a.id=b.mst_id and a.entry_form =9 and a.receive_basis =8 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_no=cast(c.requisition_no as varchar(200)) and d.po_breakdown_id=e.id and e.job_id=f.id and d.is_sales=0 and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.id=d.trans_id and d.entry_form =9 and b.status_active=1 and c.status_active=1 and d.status_active=1 group by d.id, d.quantity, f.job_no ");
				}

				foreach ($yarn_issue_return_sql as $val)
				{
					$yarn_balance_qty_arr[$val[csf('job_no')]] -= $val[csf("quantity")];
					$yarn_issue_return_qnty_arr[$val[csf('job_no')]] += $val[csf("quantity")];
				}
			}

			/*$prod_qnty_arr = sql_select("select c.quantity, c.po_breakdown_id,b.id from inv_receive_master a, pro_grey_prod_entry_dtls b, order_wise_pro_details c where a.id =b.mst_id and b.id = c.dtls_id and a.receive_basis =2 and a.entry_form =2 and c.entry_form =2 and a.booking_id = $booking_id and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted =0 and c.status_active =1 and c.is_deleted=0 and a.company_id= $cbo_company_id");*/
			if($is_salesOrder==1)
			{
				$prod_qnty_arr = sql_select("select c.quantity, d.job_no, b.id from inv_receive_master a, pro_grey_prod_entry_dtls b, order_wise_pro_details c ,fabric_sales_order_mst d where a.id =b.mst_id and b.id = c.dtls_id and c.po_breakdown_id=d.id and c.is_sales=1 and a.receive_basis =2 and a.entry_form =2 and c.entry_form =2 and a.booking_id =$booking_id and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted =0 and c.status_active =1 and c.is_deleted=0 and a.company_id= $cbo_company_id");
			}else{
				$prod_qnty_arr = sql_select("select c.quantity, e.job_no, b.id from inv_receive_master a, pro_grey_prod_entry_dtls b, order_wise_pro_details c ,wo_po_break_down d, wo_po_details_master e where a.id =b.mst_id and b.id = c.dtls_id and c.po_breakdown_id=d.id and d.job_id=e.id and c.is_sales=0 and a.receive_basis =2 and a.entry_form =2 and c.entry_form =2 and a.booking_id =$booking_id and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted =0 and c.status_active =1 and c.is_deleted=0 and a.company_id= $cbo_company_id");
			}

			

			$production_qnty=0;
			foreach ($prod_qnty_arr as $val)
			{
				$production_qnty += $val[csf("quantity")];
				$yarn_balance_qty_arr[$val[csf('job_no')]] -= $val[csf("quantity")];
				$this_challan_rcv[$val[csf('id')]][$val[csf('job_no')]] += $val[csf("quantity")];
				$grey_production_qnty_arr[$val[csf('job_no')]] += $val[csf("quantity")];
			}
		}
		else
		{
			/*$sqlControl = "select po_breakdown_id,
			sum(CASE WHEN entry_form ='3' THEN quantity ELSE 0 END) AS issue_qnty,
			sum(CASE WHEN entry_form ='9' THEN quantity ELSE 0 END) AS return_qnty,
			sum(CASE WHEN entry_form ='11' and trans_type=6 THEN quantity ELSE 0 END) AS transfer_out_qnty,
			sum(CASE WHEN entry_form ='11' and trans_type=5 THEN quantity ELSE 0 END) AS transfer_in_qnty,
			sum(CASE WHEN entry_form=2 $dtls_id_cond2 THEN quantity ELSE 0 END) AS knit_qnty
			from order_wise_pro_details where status_active=1 and is_deleted=0 group by po_breakdown_id";*/

			if($is_salesOrder==1){
				$sqlControl = "SELECT b.job_no,
				sum(CASE WHEN a.entry_form ='3' THEN a.quantity ELSE 0 END) AS issue_qnty,
				sum(CASE WHEN a.entry_form ='9' THEN a.quantity ELSE 0 END) AS return_qnty,
				sum(CASE WHEN a.entry_form ='11' and a.trans_type=6 THEN a.quantity ELSE 0 END) AS transfer_out_qnty,
				sum(CASE WHEN a.entry_form ='11' and a.trans_type=5 THEN a.quantity ELSE 0 END) AS transfer_in_qnty,
				sum(CASE WHEN a.entry_form=2 $dtls_id_cond2 THEN a.quantity ELSE 0 END) AS knit_qnty
				from order_wise_pro_details a, fabric_sales_order_mst b 
				where a.status_active=1 and a.is_deleted=0 and a.po_breakdown_id=b.id and a.is_sales=1 group by b.job_no";
			}else{
				$sqlControl = "SELECT c.job_no,
				sum(CASE WHEN a.entry_form ='3' THEN a.quantity ELSE 0 END) AS issue_qnty,
				sum(CASE WHEN a.entry_form ='9' THEN a.quantity ELSE 0 END) AS return_qnty,
				sum(CASE WHEN a.entry_form ='11' and a.trans_type=6 THEN a.quantity ELSE 0 END) AS transfer_out_qnty,
				sum(CASE WHEN a.entry_form ='11' and a.trans_type=5 THEN a.quantity ELSE 0 END) AS transfer_in_qnty,
				sum(CASE WHEN a.entry_form=2 $dtls_id_cond2 THEN a.quantity ELSE 0 END) AS knit_qnty
				from order_wise_pro_details a, wo_po_break_down b, wo_po_details_master c 
				where a.status_active=1 and a.is_deleted=0 and a.po_breakdown_id=b.id and b.job_id=c.id and a.is_sales=0 group by c.job_no";
			}

			

			$dataArray = sql_select($sqlControl);

			foreach ($dataArray as $row) {
				$yarn_balance_qty_arr[$row[csf('job_no')]] = $row[csf('issue_qnty')] - $row[csf('return_qnty')] + $row[csf('transfer_in_qnty')] - $row[csf('transfer_out_qnty')] - $row[csf('knit_qnty')];


				$yarn_issue_qnty_arr[$row[csf('job_no')]] += $row[csf("issue_qnty")];
				$grey_production_qnty_arr[$row[csf('job_no')]] += $row[csf("knit_qnty")];
				$yarn_issue_return_qnty_arr[$row[csf('job_no')]] += $row[csf("return_qnty")];

				$this_challan_rcv[$dtls_id][$row[csf('job_no')]] += $row[csf("knit_qnty")];
			}
		}

		unset($dataArray);
		//print_r($yarn_balance_qty_arr);


		$over_production_percentage= return_field_value("distribute_qnty","variable_settings_production","company_name ='$cbo_company_id' and variable_list=51 and item_category_id=1 and is_deleted=0 and status_active=1");
		$over_production_percentage = $over_production_percentage*1;
	}

	if ($roll_maintained == 1) {
		$width = "1020";
	}
	else $width = "930";

	$body_part_type=return_library_array("select id, body_part_type from lib_body_part where status_active=1",'id','body_part_type');
	//echo $cbo_body_part;
	//echo $body_part_type[$cbo_body_part];die;
	if($body_part_type[$cbo_body_part] == 40 || $body_part_type[$cbo_body_part] == 50){
		$disable_td = "";
	} else {
		$disable_td = "disabled";
	}
	//echo $fabric_store_auto_update.test;die;
	?>
	<script>
		var receive_basis =<? echo $receive_basis; ?>;
		var roll_maintained =<? echo $roll_maintained; ?>;
		var barcode_generation =<? echo $barcode_generation; ?>;
		var production_control =<? echo $production_control; ?>;

		function fn_check_max_roll_weight(inpurId){
			var inpurWeigh =$('#'+inpurId).val()*1;
			var max_roll_weight =<? echo $max_roll_weight*1; ?>;
			if(inpurWeigh > max_roll_weight && max_roll_weight>0 ){
				alert(" Maximum Roll Weight Not Allow.\n You can change this weight qty from library.\n Maxamum allowed Weight "+max_roll_weight);
				$('#'+inpurId).val('');
			}
		}

		function fn_show_check() {
			if (form_validation('cbo_buyer_name', 'Buyer Name') == false) {
				return;
			}
			show_list_view(document.getElementById('txt_search_common').value + '_' + document.getElementById('cbo_search_by').value + '_<? echo $cbo_company_id; ?>_' + document.getElementById('cbo_buyer_name').value + '_' + '<? echo $all_po_id; ?>' + '_' + '<? echo $cbo_body_part; ?>', 'create_po_search_list_view', 'search_div', 'grey_production_entry_controller_v2', 'setFilterGrid(\'tbl_list_search\',-1);hidden_field_reset();');
			set_all();
		}

		function distribute_qnty(str) 
		{
			if (str == 1) {
				$('#txt_prop_grey_qnty').attr('disabled', false);
				var txt_prop_grey_qnty = $('#txt_prop_grey_qnty').val() * 1;
				var over_production_percentage = $('#over_production_percentage').val() * 1;
				var tblRow = $("#tbl_list_search tr").length;
				var balance = txt_prop_grey_qnty;
				var len = totalGrey = 0;

				if (production_control == 1 && txt_prop_grey_qnty > 0) {
					var tot_yarn_bl_qty = 0;
					$("#tbl_list_search").find('tr').each(function () {
						var balance_qty = $(this).find('input[name="balanceQty[]"]').val();
						tot_yarn_bl_qty = tot_yarn_bl_qty * 1 + balance_qty * 1;
					});

					//tot_yarn_bl_qty = (tot_yarn_bl_qty*over_production_percentage/100) + tot_yarn_bl_qty;

					if (txt_prop_grey_qnty > tot_yarn_bl_qty) 
					{
						alert("Total Grey Qty Exceeds Total Yarn Balance Qty;\nyarn balance with over %: "+tot_yarn_bl_qty);
						$('#txt_prop_grey_qnty').val('');

						$("#tbl_list_search").find('tr').each(function () {
							$(this).find('input[name="txtGreyQnty[]"]').val('');
						});
						calculate_tot_qnty();
						return;
					}
				}

				$("#tbl_list_search").find('tr').each(function () {
					len = len + 1;

					var txtOrginal = $(this).find('input[name="txtOrginal[]"]').val() * 1;
					var isDisbled = $(this).find('input[name="txtGreyQnty[]"]').is(":disabled");
					var placeholder_value = $(this).find('input[name="txtGreyQnty[]"]').attr('placeholder') * 1;

					if (txtOrginal == 0) {
						$(this).remove();
					}
					else if (isDisbled == false && txtOrginal == 1) 
					{
						if (balance > 0) {
							if (placeholder_value < 0) placeholder_value = 0;
							if (balance > placeholder_value) {
								var grey_qnty = placeholder_value;
								balance = balance - placeholder_value;
							}
							else {
								var grey_qnty = balance;
								balance = 0;
							}

							if (tblRow == len) {
								var grey_qnty = txt_prop_grey_qnty - totalGrey;
							}

							totalGrey = totalGrey * 1 + grey_qnty * 1;

							$(this).find('input[name="txtGreyQnty[]"]').val(grey_qnty.toFixed(2));
						}
						else {
							$(this).find('input[name="txtGreyQnty[]"]').val('');
						}
					}
				});
			}
			else {
				$('#txt_prop_grey_qnty').val('');
				$('#txt_prop_grey_qnty').attr('disabled', true);

				$("#tbl_list_search").find('tr').each(function () {
					if ($(this).find('input[name="txtGreyQnty[]"]').is(":disabled") == false) {
						$(this).find('input[name="txtGreyQnty[]"]').val('');
					}
				});
			}

			calculate_tot_qnty();
		}

		function roll_duplication_check(row_id)
		{
			var row_num = $('#tbl_list_search tr').length;
			var po_id = $('#txtPoId_' + row_id).val();
			var roll_no = $('#txtRoll_' + row_id).val();

			if (roll_no * 1 > 0) {
				for (var j = 1; j <= row_num; j++) {
					if (j == row_id) {
						continue;
					}
					else {
						var po_id_check = $('#txtPoId_' + j).val();
						var roll_no_check = $('#txtRoll_' + j).val();

						if (po_id == po_id_check && roll_no == roll_no_check) {
							alert("Duplicate Roll No.");
							$('#txtRoll_' + row_id).val('');
							return;
						}
					}
				}

				var txtRollTableId = $('#txtRollTableId_' + row_id).val();
				var data = po_id + "**" + roll_no + "**" + txtRollTableId;
				var response = return_global_ajax_value(data, 'roll_duplication_check', '', 'grey_production_entry_controller_v2');
				var response = response.split("_");

				if (response[0] != 0) {
					var po_number = $('#tr_' + row_id).find('td:first').text();
					alert("This Roll Already Used. Duplicate Not Allowed");
					$('#txtRoll_' + row_id).val('');
					return;
				}
			}
		}

		function add_break_down_tr(i)
		{
			var cbo_distribiution_method = $('#cbo_distribiution_method').val();

			if (cbo_distribiution_method == 2 )
			{
			//var row_num=$('#tbl_list_search tr').length;
			var row_num = $('#txt_tot_row').val();
			row_num++;

			var clone = $("#tr_" + i).clone();
			clone.attr({
				id: "tr_" + row_num,
			});

			clone.find("input,select").each(function () {

				$(this).attr({
					'id': function (_, id) {
						var id = id.split("_");
						return id[0] + "_" + row_num
					},
					'name': function (_, name) {
						return name
					},
					'value': function (_, value) {
						return value
					}
				});

			}).end();

			//$('#req_qnty_'+

			$("#tr_" + i).after(clone);

			$('#txtOrginal_' + row_num).removeAttr("value").attr("value", "0");

			$('#txtRoll_' + row_num).removeAttr("value").attr("value", "");
			$('#txtGreyQnty_' + row_num).removeAttr("value").attr("value", "");
			$('#txtGreyQntyPcs_' + row_num).removeAttr("value").attr("value", "");

			$('#txtRejectQnty_' + row_num).removeAttr("value").attr("value", "");
			$('#txtRoll_' + row_num).removeAttr("onBlur").attr("onBlur", "roll_duplication_check(" + row_num + ");");
			$('#txtGreyQnty_' + row_num).removeAttr("onKeyUp").attr("onKeyUp", "fn_check_balance(" + row_num + ");calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_"+ row_num +"');");
			$('#txtGreyQntyPcs_' + row_num).removeAttr("onKeyUp").attr("onKeyUp", "fn_check_balance(" + row_num + ");calculate_tot_qnty();");
			
			$('#txtGreyQnty_' + row_num).removeAttr("onclick").attr("onclick", "get_weight_from_weight_machine(" + row_num + ");");
			$('#txtCollerCuffSize_' + row_num).removeAttr("ondblclick").attr("ondblclick", "func_onDblClick_finishSize(" + row_num + ");");
			
			//$('#txtCollerCuffSize_' + row_num).removeAttr("onKeyUp").attr("onKeyUp", "calculate_tot_qnty();");
			$('#txtRollTableId_' + row_num).val('');
			$('#txtBarcodeNo_' + row_num).val('');
			$('#txtRFId_' + row_num).val('');
			// $('#txtCollerCuffSize_' + row_num).val('');

			$('#increase_' + row_num).removeAttr("value").attr("value", "+");
			$('#decrease_' + row_num).removeAttr("value").attr("value", "-");
			$('#increase_' + row_num).removeAttr("onclick").attr("onclick", "add_break_down_tr(" + row_num + ");");
			$('#decrease_' + row_num).removeAttr("onclick").attr("onclick", "fn_deleteRow(" + row_num + ");");


			$('#txtGreyQnty_' + row_num).removeAttr("disabled");

			$('#txtRejectQnty_' + row_num).removeAttr("disabled");

			$('#txt_tot_row').val(row_num);
			set_all_onclick();
			}
		}

		function fn_deleteRow(rowNo) 
		{
			var cbo_distribiution_method = $('#cbo_distribiution_method').val();

			if (cbo_distribiution_method == 2) {
				var txtOrginal = $('#txtOrginal_' + rowNo).val() * 1;
				var txtBarcodeNo = $('#txtBarcodeNo_' + rowNo).val();
				var txtRollId = $('#txtRollTableId_' + rowNo).val();
				var txt_deleted_id = $('#hide_deleted_id').val();
				var selected_id = '';
				if (txtOrginal == 0) {
					if (txtBarcodeNo != '') {
						if (txt_deleted_id == '') selected_id = txtRollId; else selected_id = txt_deleted_id + ',' + txtRollId;
						$('#hide_deleted_id').val(selected_id);
					}

					$("#tr_" + rowNo).remove();
				}
			}

			calculate_tot_qnty();
		}

		function fn_check_balance(rowNo)
		{
			if (production_control == 1)
			{
				var greyQty = '';
				var greyQtyPcs = '';
				if (roll_maintained == 1) 
				{
					var row_num = $('#tbl_list_search tr').length;
					var po_id = $('#txtPoId_' + rowNo).val();

					$("#tbl_list_search").find('tbody tr').each(function()
					{
						var po_id_check=$(this).find('input[name="txtPoId[]"]').val();
						if(po_id == po_id_check)
						{
							greyQty= greyQty *1 + $(this).find('input[name="txtGreyQnty[]"]').val() * 1;
							greyQtyPcs = greyQtyPcs * 1 + $(this).find('input[name="txtGreyQntyPcs[]"]').val() * 1;
						}
					});
				}
				else 
				{
					greyQty = $('#txtGreyQnty_' + rowNo).val() * 1;
					greyQtyPcs = $('#txtGreyQntyPcs_' + rowNo).val() * 1;
				}

				var balanceQty = $('#balanceQty_' + rowNo).val() * 1;
				if (greyQty > balanceQty) {
					alert("QC Pass Qty. Exceeds Yarn Issued Qty.");
					$('#txtGreyQnty_' + rowNo).val('');
					return;
				}
			}
			var txtQcBarcode=0; var txtBarcodeNo=0;
			if (roll_maintained == 1) 
			{
				var txtQcBarcode = $('#txtQcBarcode_' + rowNo).val()*1;
				var txtBarcodeNo = $('#txtBarcodeNo_' + rowNo).val()*1;
				var txyPreQCPassQty = $('#preQCPassQty_' + rowNo).val()*1;
				// alert(txtQcBarcode+'='+txtBarcodeNo);
				if (txtQcBarcode == txtBarcodeNo && txtQcBarcode!=0) 
				{
					alert("This roll already QC, quantity change not allowed.");
					$('#txtGreyQnty_' + rowNo).val('');
					$('#txtGreyQnty_' + rowNo).val(txyPreQCPassQty);
					return;
				}
			}
		}

		function calculate_tot_qnty() 
		{
			var tot_grey_qnty = '';
			var tot_reject_qnty = '';
			var tot_grey_qnty_pcs = '';
			//var tot_size_qty = '';

			$("#tbl_list_search").find('tr').each(function () {
				var txtGreyQnty = $(this).find('input[name="txtGreyQnty[]"]').val() * 1;
				tot_grey_qnty = tot_grey_qnty * 1 + txtGreyQnty * 1;

				var txtGreyQnty_pcs = $(this).find('input[name="txtGreyQntyPcs[]"]').val() * 1;
				tot_grey_qnty_pcs = tot_grey_qnty_pcs * 1 + txtGreyQnty_pcs * 1;

				var txtRejectQnty = $(this).find('input[name="txtRejectQnty[]"]').val() * 1;
				tot_reject_qnty = tot_reject_qnty * 1 + txtRejectQnty * 1;

			});
			//alert(tot_grey_qnty_pcs);
			$('#txt_tot_grey_qnty').val(tot_grey_qnty.toFixed(2));
			$('#txt_tot_grey_qnty_pcs').val(tot_grey_qnty_pcs.toFixed(2));
			$('#txt_tot_reject_qnty').val(tot_reject_qnty.toFixed(2));
			//$('#txt_tot_size_qty').val(tot_size_qty.toFixed(2));
		}

		var selected_id = new Array();

		function check_all_data() {
			var tbl_row_count = document.getElementById('tbl_list_search').rows.length;

			tbl_row_count = tbl_row_count - 1;
			for (var i = 1; i <= tbl_row_count; i++) {
				js_set_value(i, 1);
			}
		}

		function toggle(x, origColor) {
			var newColor = 'yellow';
			if (x.style) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor ) ? origColor : newColor;
			}
		}

		function set_all() {
			var old = document.getElementById('txt_po_row_id').value;
			if (old != "") {
				old = old.split(",");
				for (var i = 0; i < old.length; i++) {
					js_set_value(old[i], 0)
				}
			}
		}

		function js_set_value(str, check_or_not) {
			if (check_or_not == 1) {
				var roll_used = $('#roll_used' + str).val();
				if (roll_used == 1) {
					var po_number = $('#search' + str).find("td:eq(3)").text();
					alert("Batch Roll Found Against PO- " + po_number);
					return;
				}
			}

			toggle(document.getElementById('search' + str), '#FFFFCC');

			if (jQuery.inArray($('#txt_individual_id' + str).val(), selected_id) == -1) {
				selected_id.push($('#txt_individual_id' + str).val());

			}
			else {
				for (var i = 0; i < selected_id.length; i++) {
					if (selected_id[i] == $('#txt_individual_id' + str).val()) break;
				}
				selected_id.splice(i, 1);
			}
			var id = '';
			for (var i = 0; i < selected_id.length; i++) {
				id += selected_id[i] + ',';
			}
			id = id.substr(0, id.length - 1);

			$('#po_id').val(id);
		}

		function show_grey_prod_recv() {
			var po_id = $('#po_id').val();
			show_list_view(po_id + '_' + '1' + '_' + '<? echo $dtls_id; ?>' + '_' + '<? echo $roll_maintained; ?>' + '_' + '<? echo $save_data; ?>' + '_' + '<? echo $prev_distribution_method; ?>' + '_' + '<? echo $receive_basis; ?>' + '_' + '<? echo $txt_deleted_id; ?>' + '_' + '<? echo $txt_reject_fabric_recv_qnty; ?>' + '_' + '<? echo $production_control; ?>' + '_' + '<? echo $cbo_body_part; ?>' + '_' + '<? echo $cbo_company_id; ?>' + '_' + '<? echo $cbo_com_location_name; ?>' + '_' + '<? echo $cbo_store_name; ?>', 'po_popup', 'search_div', 'grey_production_entry_controller_v2', '');
		}

		function hidden_field_reset() {
			$('#po_id').val('');
			$('#save_string').val('');
			$('#tot_grey_qnty').val('');
			$('#txtGreyQntyPcs').val('');
			$('#tot_reject_qnty').val('');
			$('#number_of_roll').val('');
			selected_id = new Array();
		}

		function fnc_close() 
		{
			var save_string = '';
			var tot_grey_qnty = '';
			var tot_grey_qnty_pcs = '';
			var tot_reject_qnty = '';
			var size_qnty_string = '';
			var no_of_roll = '';
			var po_id_array = new Array();
			var rfid_array = new Array();
			var breakOut = true;
			var diplicat_rfid = 0;
			var rfId_flag=0;

			$("#tbl_list_search").find('tr').each(function () {

				var txtPoId = $(this).find('input[name="txtPoId[]"]').val();
				var txtGreyQnty = $(this).find('input[name="txtGreyQnty[]"]').val();
				var txtGreyQnty_pcs = $(this).find('input[name="txtGreyQntyPcs[]"]').val();
				var txtRejectQnty = $(this).find('input[name="txtRejectQnty[]"]').val();
				var txtSizeQty = $(this).find('input[name="txtCollerCuffSize[]"]').val();
				var txtRoll = $(this).find('input[name="txtRoll[]"]').val();
				var txtRollId = $(this).find('input[name="txtRollId[]"]').val();
				var txtRollTableId = $(this).find('input[name="txtRollTableId[]"]').val();
				var txtRFId = $(this).find('input[name="txtRFId[]"]').val();

				if(txtRFId!=undefined && txtRFId!=""){
					var txtRFId_length=txtRFId.length; 
					if(txtRFId_length!=9)
					{
						rfId_flag=1;
					}
					if (jQuery.inArray(txtRFId, rfid_array) == -1) {
						rfid_array.push(txtRFId);
					}else{
						diplicat_rfid = 1;
					}
				}

				tot_grey_qnty 		= tot_grey_qnty * 1 + txtGreyQnty * 1;
				tot_grey_qnty_pcs 	= tot_grey_qnty_pcs * 1 + txtGreyQnty_pcs * 1;

				tot_reject_qnty 	= tot_reject_qnty * 1 + txtRejectQnty * 1;
				if(size_qnty_string!="") 	size_qnty_string=size_qnty_string+','+txtSizeQty;
				else 					 	size_qnty_string=txtSizeQty;

				var txtBarcodeNo = ''; var txtRFId = '';
				if (roll_maintained == 0) {
					txtRoll = 0;
				}
				else {
					txtBarcodeNo = $(this).find('input[name="txtBarcodeNo[]"]').val();
					txtRFId = $(this).find('input[name="txtRFId[]"]').val();
				}

				if (txtGreyQnty*1 >0 || txtRejectQnty*1 >0) {
					if (roll_maintained == 1) {
						no_of_roll = no_of_roll * 1 + 1;
					}

					if (save_string == "") {
						save_string = txtPoId + "**" + txtGreyQnty + "**" + txtRejectQnty + "**" + txtRoll + "**" + txtRollId + "**" + txtRollTableId + "**" + txtBarcodeNo + "**" + txtGreyQnty_pcs+ "**" + txtSizeQty + "**" + txtRFId;
					}
					else {
						save_string += "," + txtPoId + "**" + txtGreyQnty + "**" + txtRejectQnty + "**" + txtRoll + "**" + txtRollId + "**" + txtRollTableId + "**" + txtBarcodeNo + "**" + txtGreyQnty_pcs+ "**" + txtSizeQty + "**" + txtRFId;
					}

					if (jQuery.inArray(txtPoId, po_id_array) == -1) {
						po_id_array.push(txtPoId);
					}
				}
			});

			if(diplicat_rfid == 1)
			{
				alert("Same RFID is not Allowed Multiple Times.");
				return;
			}
			if(rfId_flag==1)
			{
				alert("RFID must be 9 digits long");
				return;
			}

			$('#save_string').val(save_string);
			$('#tot_grey_qnty').val(tot_grey_qnty.toFixed(2));
			$('#tot_grey_qnty_pcs').val(tot_grey_qnty_pcs.toFixed(2));
			$('#tot_reject_qnty').val(tot_reject_qnty.toFixed(2));
			$('#string_size_qty').val(size_qnty_string);
			$('#number_of_roll').val(no_of_roll);
			$('#all_po_id').val(po_id_array);
			$('#distribution_method').val($('#cbo_distribiution_method').val());

			parent.emailwindow.hide();
		}

		function check_all_report() 
		{
			$("input[name=chkBundle]").each(function (index, element) {

				if ($('#check_all').prop('checked') == true)
					$(this).attr('checked', 'true');
				else
					$(this).removeAttr('checked');
			});
		}

		function fnc_send_printer_text() 
		{
			var dtls_id = '<? echo $dtls_id; ?>';
			if (dtls_id == "") {
				alert("Save First");
				return;
			}
			var data = "";
			var error = 1;
			$("input[name=chkBundle]").each(function (index, element) {
				if ($(this).prop('checked') == true) {
					error = 0;
					var idd = $(this).attr('id').split("_");
					var roll_id = $('#txtRollTableId_' + idd[1]).val();
					if (roll_id != "") {
						if (data == "") data = $('#txtRollTableId_' + idd[1]).val(); else data = data + "," + $('#txtRollTableId_' + idd[1]).val();
					}
					else {
						$(this).prop('checked', false);
					}
				}
			});

			if (error == 1) {
				alert('No data selected');
				return;
			}

			data = data + "***" + dtls_id;
			var url = return_ajax_request_value(data, "report_barcode_text_file", "grey_production_entry_controller_v2");
			window.open(url + ".zip", "##");
		}

		function fnc_barcode_generation() 
		{
			var dtls_id = '<? echo $dtls_id; ?>';
			if (dtls_id == "") {
				alert("Save First");
				return;
			}
			var data = "";
			var error = 1;
			$("input[name=chkBundle]").each(function (index, element) {
				if ($(this).prop('checked') == true) {
					error = 0;
					var idd = $(this).attr('id').split("_");
					var roll_id = $('#txtRollTableId_' + idd[1]).val();
					if (roll_id != "") {
						if (data == "") data = $('#txtRollTableId_' + idd[1]).val(); else data = data + "," + $('#txtRollTableId_' + idd[1]).val();
					}
					else {
						$(this).prop('checked', false);
					}
				}
			});

			if (error == 1) {
				alert('No data selected');
				return;
			}

			data = data + "***" + dtls_id;
			window.open("grey_production_entry_controller_v2.php?data=" + data + '&action=report_barcode_generation', true);
		}
		
		function get_weight_from_weight_machine(i)
		{
			$.post( "grey_production_entry_controller_v2.php", { action: "load_weight_machine_data"})
			.done(function( data ) {
				var obj = JSON.parse(data); 
				if(obj){
					$( "#txtGreyQnty_" +i).val( obj.weight );
				}
				
				fn_check_balance(i);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_'+i);
			});	
		}

		//func_onDblClick_finishSize
		function func_onDblClick_finishSize(rowNo)
		{
        	//var page_link = 'grey_production_entry_controller_v2.php?action=action_finishSize&program_no=' + '<? //echo $booking_no; ?>';
        	var page_link = 'grey_production_entry_controller_v2.php?action=action_finishSize&program_no=' + '<? echo $booking_no; ?>&rowNo=' + rowNo;
        	var title = 'Program Wise Size Popup';
        	emailwindow = dhtmlmodal.open('EmailBox', 'iframe', page_link, title, 'width=220px,height=250px,center=1,resize=1,scrolling=0', '../');
        	emailwindow.onclose = function ()
			{
        		var theform = this.contentDoc.forms[0];
        		var item_size = this.contentDoc.getElementById("hdn_item_size").value;
        		//alert(item_size);
        		var item_size2=item_size.split('__');
        		//alert('size popup close='+item_size2[1]+'='+item_size2[0]);
				$('#txtCollerCuffSize_' + item_size2[1]).val(item_size2[0]);
        	}
		}
	</script>
	</head>

	<body>
	<?
	if ($type != 1)
	{
		?>
		<form name="searchdescfrm" id="searchdescfrm">
		<fieldset style="width:<? echo $width; ?>px;margin-left:5px">
		<input type="hidden" name="save_string" id="save_string" value="">
		<input type="hidden" name="tot_grey_qnty" id="tot_grey_qnty" value="">
		<input type="hidden" name="tot_grey_qnty_pcs" id="tot_grey_qnty_pcs" value="">
		<input type="hidden" name="tot_reject_qnty" id="tot_reject_qnty" value="">
		<input type="hidden" name="string_size_qty" id="string_size_qty" value="">
		<input type="hidden" name="number_of_roll" id="number_of_roll" value="">
		<input type="hidden" name="all_po_id" id="all_po_id" value="">
		<input type="hidden" name="distribution_method" id="distribution_method" value="">
		<input type="hidden" name="hide_deleted_id" id="hide_deleted_id" value="<? echo $txt_deleted_id; ?>">
        <input type="hidden" name="cbo_company_id" id="cbo_company_id" value="<? echo $cbo_company_id; ?>">
		<input type="hidden" name="cbo_location" id="cbo_location" value="<? echo $cbo_com_location_name; ?>">
		<input type="hidden" name="cbo_store_name" id="cbo_store_name"  value="<? echo $cbo_store_name; ?>">
		<?
	} 
	if ($receive_basis == 0 && $type != 1)
	{
		?>
		<table style="margin-left:90px" cellpadding="0" cellspacing="0" width="620" border="1" rules="all" class="rpt_table">
			<thead>
				<th class="must_entry_caption">Buyer</th>
				<th>Search By</th>
				<th>Search</th>
				<th>
					<input type="reset" name="reset" id="reset" value="Reset" style="width:100px"
					class="formbutton"/>
					<input type="hidden" name="po_id" id="po_id" value="">
				</th>
			</thead>
			<tr class="general">
				<td align="center">
					<?
					echo create_drop_down("cbo_buyer_name", 170, "select buy.id, buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$cbo_company_id' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buy.buyer_name", "id,buyer_name", 1, "-- Select Buyer --", $selected, "", $data[0]);
					?>
				</td>
				<td align="center">
					<?
					$search_by_arr = array(1 => "PO No", 2 => "Job No", 3 => "Internal Ref", 4 => "File No");
					echo create_drop_down("cbo_search_by", 170, $search_by_arr, "", 0, "--Select--", "", $dd, 0);
					?>
				</td>
				<td align="center">
					<input type="text" style="width:130px" class="text_boxes" name="txt_search_common"
					id="txt_search_common"/>
				</td>
				<td align="center">
					<input type="button" name="button2" class="formbutton" value="Show"
					onClick="fn_show_check();" style="width:100px;"/>
				</td>
			</tr>
		</table>
		<div id="search_div" style="margin-top:2px">
			<?
			if ($save_data != "")
			{
				?>
				<div style="width:<? echo $width - 20; ?>px; margin-top:5px" align="center">
					<table style="margin-bottom:2px" class="rpt_table" border="1" cellpadding="0"
					cellspacing="0" rules="all" width="300" align="center">
					<thead>
						<th>Total QC Pass Qty.</th>
						<th>Distribution Method</th>
					</thead>
					<tr class="general">
						<td><input type="text" name="txt_prop_grey_qnty" id="txt_prop_grey_qnty"
							class="text_boxes_numeric" value="<? echo $txt_receive_qnty; ?>"
							style="width:120px"
							onBlur="distribute_qnty(document.getElementById('cbo_distribiution_method').value)"
							disabled></td>
							<td>
								<?
								echo create_drop_down("cbo_distribiution_method", 250, $distribiution_method, "", 0, "", 2, "distribute_qnty(this.value);", 1);
								?>
							</td>
						</tr>
					</table>
				</div>
				<div style="margin-left:5px; margin-top:2px">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all"
					width="<? echo $width + 200; ?>">
					<thead>
						<th width="110">PO No</th>
						<th width="60">Internal Ref.</th>
						<th width="80">PO Qnty</th>
						<th width="70">Ship. Date</th>
						<th width="80">Cumulative Production Qty.</th>
						<th width="80">Balance Qty.</th>
						<th width="80">QC Pass Qty.</th>
						<th width="80">Qty in Pcs</th>
						<th width="60">Size</th>
						<th width="80">Reject Qty.</th>
						<?
						if ($roll_maintained == 1) {
							?>
							<th width="60">Roll</th>
							<th width="70">Barcode No.</th>
							<th width="70">RFID</th>
							<th width="65"></th>
							<?
						}
						?>
					</thead>
				</table>
				<div style="width:<? echo $width+220; ?>px; max-height:200px; overflow-y:scroll" id="list_container" align="left">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="<? echo $width + 200; ?>" id="tbl_list_search">
						<?
						$i = 1;
						$tot_po_qnty = 0;
						$tot_grey_qnty = 0;
						$tot_grey_qnty_pcs = 0;
						$tot_reject_qnty = 0;
						$po_array = array();

						$explSaveData = explode(",", $save_data);
						for ($z = 0; $z < count($explSaveData); $z++)
						{
							if ($i % 2 == 0)
								$bgcolor = "#E9F3FF";
							else
								$bgcolor = "#FFFFFF";

							$po_wise_data = explode("**", $explSaveData[$z]);
							$order_id = $po_wise_data[0];
							$grey_qnty = $po_wise_data[1];
							$reject_qnty = $po_wise_data[2];
							$roll_no = $po_wise_data[3];
							$roll_not_delete_id = $po_wise_data[4];
							$roll_id = $po_wise_data[5];
							$barcode_no = $po_wise_data[6];
							$grey_qnty_pcs = $po_wise_data[7];
							$rft_id = $po_wise_data[9];

											//echo $order_id."**".$grey_qnty;
							$po_data = sql_select("select b.id,b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id=$order_id order by b.pub_shipment_date");



							$allPoId="";
							foreach ($po_data as $row) {
								$allPoId.= "'".$row[csf('id')]."'".',';
							}
							$allPoId=chop($allPoId,",");
							$greyRecvQty =sql_select("select po_breakdown_id,sum(quantity) as prod_quantity from order_wise_pro_details where po_breakdown_id in($allPoId) and entry_form=2 and status_active=1 and is_deleted=0 group by po_breakdown_id");
							foreach ($greyRecvQty as $row) {
								$grey_receive_qnty_arr[$row[csf("po_breakdown_id")]]["prod_quantity"]=$row[csf("prod_quantity")];
							}



							if ($roll_maintained == 1) {
								$roll_used = return_field_value("roll_used", "pro_roll_details", "id='$roll_id'");

								if (!(in_array($order_id, $po_array))) {
									if ($roll_not_delete_id == 0) $tot_po_qnty += $po_data[0][csf('po_qnty_in_pcs')];
									$orginal_val = 1;
									$po_array[] = $order_id;
								} else {
									if ($roll_used == 1) $orginal_val = 1; else $orginal_val = 0;
								}

								if ($roll_used == 1) {
									$disable = "disabled='disabled'";
									$roll_not_delete_id = $roll_not_delete_id;
								} else {
									$disable = "";
									$roll_not_delete_id = 0;
								}
							} else {
								if (!(in_array($order_id, $po_array))) {
									$tot_po_qnty += $po_data[0][csf('po_qnty_in_pcs')];
									$orginal_val = 1;
									$po_array[] = $order_id;
								} else {
									$orginal_val = 0;
								}

								$roll_not_delete_id = 0;
								$roll_id = 0;
								$disable = "";
							}

							$tot_grey_qnty += $grey_qnty;
							$tot_grey_qnty_pcs += $grey_qnty_pcs;
							$tot_reject_qnty += $reject_qnty;
							//$balanceQty = number_format($yarn_balance_qty_arr[$order_id],2,".","");


							$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$order_id],2,".","");
							$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
							$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$order_id] - $grey_production_qnty_arr[$order_id];
							$balanceQty = number_format($yarn_over_balance,2,".","");

							//echo $order_id."__".$grey_qnty;
							?>
							<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
								<td width="110">
									<p><? echo $po_data[0][csf('po_number')]; ?></p>
									<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>"
									value="<? echo $order_id; ?>">
									<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>"
									value="<? echo $orginal_val; ?>">
									<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>"
									value="<? echo $roll_not_delete_id; ?>">
									<!--txtRollId is used for not delete row which is used in Delivery -->
									<input type="hidden" name="txtRollTableId[]"
									id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
									<!--txtRollTableId is used for Duplication Check -->
									<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>"
									value="<? echo $balanceQty; ?>">
								</td>
								<td width="60"><p><? echo $po_data[0][csf('grouping')]; ?>&nbsp;</p></td>
								<td width="80" align="right">
									<? echo $po_data[0][csf('po_qnty_in_pcs')]; ?>
									<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>"
									value="<? echo $po_data[0][csf('po_qnty_in_pcs')]; ?>">
								</td>
								<td width="70" align="center"><? echo change_date_format($po_data[0][csf('pub_shipment_date')]); ?></td>
								<td width="80" align="right"><? echo $grey_receive_qnty_arr[$po_data[0][csf('id')]]["prod_quantity"]; ?></td>
								<td width="80" align="right"><? echo $po_data[0][csf('po_qnty_in_pcs')]-$grey_receive_qnty_arr[$po_data[0][csf('id')]]["prod_quantity"]; ?></td>
								<td align="center" >
									<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
								</td>
								<td align="center">
									<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?> onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
								</td>
								<td align="center" width="60">
									<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?> >
								</td>

								<td width="80" align="center">
									<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>" <? echo $disable; ?> onKeyUp="calculate_tot_qnty();">
								</td>
								<?
								if ($roll_maintained == 1)
								{
									?>
									<td align="center" width="60">
										<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?> placeholder="<? //echo $roll_arr[$order_id]+1; ?>" onBlur="roll_duplication_check(<? echo $i; ?>);"  readonly/>
									</td>
									<td width="70">
										<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>"  class="text_boxes_numeric" style="width:55px" value="<? echo $barcode_no; ?>" disabled/>
									</td>
									<td width="70">
										<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>"  class="text_boxes" style="width:55px" value="<? echo $rft_id; ?>" />
									</td>
									<td width="65">
										<input type="button" id="increase_<? echo $i; ?>" name="increase[]"
										style="width:30px" class="formbuttonplasminus" value="+"
										onClick="add_break_down_tr( <? echo $i; ?> )"/>
										<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]"
										style="width:30px" class="formbuttonplasminus" value="-"
										onClick="fn_deleteRow(<? echo $i; ?>);"/>
									</td>
									<?
								}
								?>
							</tr>
							<?
							$i++;
						}
						?>
						<input type="hidden" name="tot_po_qnty" id="tot_po_qnty" class="text_boxes" value="<? echo $tot_po_qnty; ?>">
						<input type="hidden" name="txt_tot_row" id="txt_tot_row" class="text_boxes" value="<? echo $i - 1; ?>">
					</table>
				</div>
				<table width="<? echo $width + 200; ?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="tbl_bottom">
					<tr>
						<td width="110"></td>
						<td width="60"></td>
						<td width="80"></td>
						<td width="70" align="right"></td>
						<td width="80" align="right"></td>
						<td width="80" align="right"><b>Total</b></td>
						<td style="text-align:center">
						<input type="text" name="txt_tot_grey_qnty" id="txt_tot_grey_qnty" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_grey_qnty, 2); ?>" disabled>
						</td>
						<td style="text-align:center"><input type="text" name="txt_tot_grey_qnty_pcs" id="txt_tot_grey_qnty_pcs" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_grey_qnty_pcs, 2); ?>" disabled>
						</td>
						<td align="center" width="80"></td>
						<td width="80" style="text-align:center"><input type="text" name="txt_tot_reject_qnty" id="txt_tot_reject_qnty" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_reject_qnty, 2); ?>"
						disabled></td>
						<?
						if ($roll_maintained == 1) {
							echo '</td><td width="60"></td><td width="70"></td><td width="70"></td><td width="65"></td>';
						}
						?>
					</tr>
					</table>
					<table width="<? echo $width; ?>">
						<tr>
							<td align="center">
								<input type="button" name="close" class="formbutton" value="Close"  id="main_close" onClick="fnc_close();" style="width:100px"/>
							</td>
						</tr>
					</table>
				</div>
				<?
			}
			?>
		</div>
		<? 
	}
	else
	{
		if ($booking_without_order == 1 && $receive_basis != 2) // sample and without program
		{ 
			$prev_distribution_method = 2;
			$disabled = "disabled='disabled'";
			$disabled_dropdown = 1;
			?>
			<div style="width:<? echo $width - 20; ?>px; margin-top:5px;" align="center">
				<table style="margin-bottom:5px;" class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="300" align="center">
					<thead>
						<th>Total QC Pass Qty.</th>
						<th>Distribution Method</th>
					</thead>
					<tr class="general">
						<td><input type="text" name="txt_prop_grey_qnty" id="txt_prop_grey_qnty"
							class="text_boxes_numeric" value="<? echo $txt_receive_qnty; ?>" style="width:120px" onBlur="distribute_qnty(document.getElementById('cbo_distribiution_method').value)" <? echo $disabled; ?> >
							<input type="hidden" name="over_production_percentage" id="over_production_percentage" value="<? echo $over_production_percentage;?>">
						</td>
						<td>
							<?
							echo create_drop_down("cbo_distribiution_method", 250, $distribiution_method, "", 0, "", $prev_distribution_method, "distribute_qnty(this.value);", $disabled_dropdown);
							?>
						</td>
					</tr>
				</table>
			</div>
			<div style="margin-left:5px; margin-top:10px">
				<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="<? echo $width + 180; ?>">
					<caption style="font-weight: bold;color: red;">Over Production Percentage: <? echo $over_production_percentage; ?>%</caption>
					<thead>
						<?
						if ($receive_basis == 4) {
							echo '<th width="130">Sales Order No</th><th width="80">Sales Order Qty.</th>';
						} else {
							echo '<th width="130">Booking No</th><th width="80">Booking Qty.</th>';
						}
						?>
						<th width="80">Cumulative Production Qty.</th>
						<th width="80">Balance Qty</th>
						<th width="80">QC Pass Qty</th>
						<th width="80">Qty. In Pcs</th>
						<th width="80">Size</th>
						<th width="80">Reject Qty.</th>
						<th width="80">Roll</th>
						<th width="100">Barcode No.</th>
						<th width="65"></th>
					</thead>
				</table>
				<div style="width:<? echo $width+200; ?>px; max-height:200px; overflow-y:scroll" id="list_container" align="left">
                <table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="<? echo $width + 180; ?>" id="tbl_list_search">
                    <?
                    $i = 0;
                    $tot_po_qnty = 0;
                    $tot_grey_qnty = 0;
                    $tot_reject_qnty = 0;
                    $orginal_val = 1;
                    $roll_id = 0;
                    $roll_not_delete_id = 0;
                    $balanceQty = 0;
                	//echo $save_data;
                    if ($receive_basis == 4) {
                        if($txt_width) $dia_width_cond = " and dia='$txt_width'";
                        $bookingData = sql_select("select mst_id as po_ids,sum(grey_qty) as qnty from fabric_sales_order_dtls where job_no_mst='$booking_no' and determination_id='$fabric_desc_id' and body_part_id='$cbo_body_part' and gsm_weight='$txt_gsm' $dia_width_cond and status_active=1 and is_deleted=0 group by mst_id");

                        $allPoId="";
                        foreach ($bookingData as $row) {
                            $allPoId.= "'".$row[csf('po_ids')]."'".',';
                        }
                        $allPoId=chop($allPoId,",");
                        if($dtls_id!="") $dtls_id_cond = " and dtls_id <> $dtls_id";
                        $greyRecvQty =sql_select("select po_breakdown_id,sum(quantity) as prod_quantity from order_wise_pro_details where po_breakdown_id in($allPoId) and entry_form=2 and status_active=1 and is_deleted=0 and is_sales=1 $dtls_id_cond group by po_breakdown_id");

                        foreach ($greyRecvQty as $row) {
                            $grey_receive_qnty_arr[$row[csf("po_breakdown_id")]]["prod_quantity"]=$row[csf("prod_quantity")];
                        }
                    }
					else
					{
						if($txt_width) $dia_width_cond = " and b.dia_width='$txt_width'";
						$bookingData = sql_select("select a.id as po_ids,sum(b.grey_fabric) as qnty from wo_non_ord_samp_booking_mst a,wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and b.booking_no='$booking_no' and b.lib_yarn_count_deter_id='$fabric_desc_id' and b.body_part='$cbo_body_part' and b.gsm_weight='$txt_gsm' $dia_width_cond and (a.fabric_source=1 OR b.fabric_source=1) and b.status_active=1 and b.is_deleted=0 group by a.id");

						$allNonOrdBookingId="";
						foreach ($bookingData as $row) {
							$allNonOrdBookingId.= "'".$row[csf('po_ids')]."'".',';
						}
						$allNonOrdBookingId=chop($allNonOrdBookingId,",");

						if($allNonOrdBookingId!="")
						{
							if($dtls_id!="") $dtls_id_cond = " and a.id <> $dtls_id";
							$greyRecvQty =sql_select(" select b.booking_id as po_breakdown_id, sum(a.grey_receive_qnty) as prod_quantity from pro_grey_prod_entry_dtls a, inv_receive_master b where a.mst_id = b.id and b.entry_form = 2 and b.booking_id in ($allNonOrdBookingId) and a.febric_description_id='$fabric_desc_id' and a.body_part_id='$cbo_body_part' and a.gsm='$txt_gsm' and b.booking_without_order=1 and a.status_active=1 and b.status_active=1  $dtls_id_cond group by b.booking_id");
							foreach ($greyRecvQty as $row) {
								$grey_receive_qnty_arr[$row[csf("po_breakdown_id")]]["prod_quantity"]=$row[csf("prod_quantity")];
							}
						}
					}

					$req_qnty = $bookingData[0][csf('qnty')];
					//$bl_qnty = $req_qnty - $recv_qnty;
					$production_balance = $req_qnty-$grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"];

					$req_qnty_with_over_perc = ($req_qnty*$over_production_percentage)/100 + $req_qnty;
					$balanceQty = $req_qnty_with_over_perc - $grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"];
					$balanceQty = number_format($balanceQty,2,".","");

					if ($save_data == "")
					{
						$i++;
						?>
						<tr bgcolor="#FFFFFF" id="tr_1">
							<td width="130">
								<p><? echo $booking_no; ?></p>
								<input type="hidden" name="txtPoId[]" id="txtPoId_1" value="<? echo $booking_id; ?>">
								<input type="hidden" name="txtOrginal[]" id="txtOrginal_1" value="<? echo $orginal_val; ?>">
								<input type="hidden" name="txtRollId[]" id="txtRollId_1" value="<? echo $roll_not_delete_id; ?>">
								<!--This is used for not delete row which is used in batch -->
								<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_1" value="<? echo $roll_id; ?>">
								<!--This is used for Duplication Check -->
								<input type="hidden" name="balanceQty[]" id="balanceQty_1" value="<? echo number_format($balanceQty, 2, '.', '');//echo $balanceQty; ?>">
							</td>
							<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
							<td width="80" align="right"><? echo number_format($grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"], 2, '.', ''); ?></td>
							<td width="80" align="right"><? echo number_format($req_qnty-$grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"], 2, '.', ''); ?></td>
							<td align="center" width="80">
								<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_1" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($production_balance, 2, '.', ''); ?>" onKeyUp="fn_check_balance(1);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
							</td>
							<td align="center" width="80">
								<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_1" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="calculate_tot_qnty();" <? echo $disable_td; ?>>
							</td>
							<td align="center" width="80">
								<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:60px" value="<? echo $size_qty; ?>" <? echo $disable_td; ?>>
							</td>
							<td align="center" width="80">
								<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_1" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="calculate_tot_qnty();">
							</td>
							<td align="center" width="80">
								<input type="text" name="txtRoll[]" id="txtRoll_1" class="text_boxes_numeric" style="width:60px" value="" readonly/>
							</td>
							<td width="100" align="center">
                            <input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_1" class="text_boxes_numeric" style="width:80px" value="" disabled/>
							</td>
							<td width="65">
								<input type="button" id="increase_1" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr(1)"/>
								<input type="button" id="decrease_1" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(1);"/>
							</td>
						</tr>
						<?
					}
					else
					{
						$explSaveData = explode(",", $save_data);
						for ($z = 0; $z < count($explSaveData); $z++) {
							$po_wise_data = explode("**", $explSaveData[$z]);
							$roll_ids[$po_wise_data[5]] = $po_wise_data[5];
							$barcode_num[$po_wise_data[6]] = $po_wise_data[6];
						}
						$roll_ids = implode(',',array_keys($roll_ids));
						$barcode_nums = rtrim(implode(',',array_keys($barcode_num)),',') ;

						if($roll_ids!="")
						{
							$sqlroll = sql_select("select barcode_no,roll_used from pro_roll_details where status_active=1 and is_deleted=0 and id in($roll_ids)");
							foreach ($sqlroll as $row) {
								$rollData[$row[csf("barcode_no")]]['roll_used'] = $row[csf("roll_used")];
							}
						}

						if($barcode_nums!="")
						{
							$qcRollSql = sql_select("SELECT barcode_no from PRO_QC_RESULT_MST where status_active=1 and is_deleted=0 and barcode_no in($barcode_nums)");
							$qcRollData=array();
							foreach ($qcRollSql as $row) 
							{
								$qcRollData[$row[csf("barcode_no")]] = $row[csf("barcode_no")];
							}
						}

						for ($z = 0; $z < count($explSaveData); $z++) 
						{
							$i++;

							if ($i % 2 == 0)
								$bgcolor = "#E9F3FF";
							else
								$bgcolor = "#FFFFFF";

							$po_wise_data = explode("**", $explSaveData[$z]);
							$order_id = $po_wise_data[0];
							$grey_qnty = $po_wise_data[1];
							$reject_qnty = $po_wise_data[2];
							$roll_no = $po_wise_data[3];
							$roll_not_delete_id = $po_wise_data[4];
							$roll_id = $po_wise_data[5];
							$barcode_no = $po_wise_data[6];
							$grey_qnty_pcs = $po_wise_data[7];
							$r_floor_id = $po_wise_data[10];
							$r_room_id = $po_wise_data[11];
							$r_rack_id = $po_wise_data[12];
							$r_self_id = $po_wise_data[12];

							$bl_qnty = $req_qnty - $recv_qnty;
							$size_data=$po_wise_data[8];

							$roll_used = $rollData[$barcode_no]['roll_used'];//return_field_value("roll_used", "pro_roll_details", "id='$roll_id'");
							$qc_barcode_no = $qcRollData[$barcode_no];

							if ($roll_used == 1) {
								$orginal_val = 1;
								$disable = "disabled='disabled'";
							} else {
								$disable = "";
								$roll_not_delete_id = 0;
								$orginal_val = 0;
							}

							$tot_grey_qnty += $grey_qnty;
							$tot_grey_qnty_pcs += $grey_qnty_pcs;
							$tot_reject_qnty += $reject_qnty;
							$balanceQty = 0;

							//echo $grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"];die;

							$production_balance = $req_qnty-$grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"];

							$req_qnty_with_over_perc = ($req_qnty*$over_production_percentage)/100 + $req_qnty;
							$balanceQty = $req_qnty_with_over_perc - $grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"];
							$balanceQty = number_format($balanceQty,2,".","");

							?>
							<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
								<td width="130">
									<p><? echo $booking_no; ?></p>
									<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $booking_id; ?>">
									<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
									<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
									<!--This is used for not delete row which is used in batch -->
									<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
									<!--This is used for Duplication Check -->
									<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo number_format($balanceQty, 2, '.', ''); ?>">

									<input type="hidden" name="txtQcBarcode[]" id="txtQcBarcode_<? echo $i; ?>" value="<? echo $qc_barcode_no; ?>">
									<input type="hidden" name="preQCPassQty[]" id="preQCPassQty_<? echo $i; ?>" value="<? echo $grey_qnty; ?>"><!-- after qc roll qty not change -->
								</td>
								<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
								<td width="80" align="right"><input type="text" name="txtGreyQntyCumulative[]" id="txtGreyQntyCumulative_<? echo $i; ?>" class="text_boxes_numeric" style="width:70px;" value="<? echo number_format($grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"],2,'.','')//$grey_qnty; ?>" <? echo $disable; ?> disabled></td>
                                <td width="80" align="right"><? echo number_format($req_qnty-$grey_receive_qnty_arr[$bookingData[0][csf('po_ids')]]["prod_quantity"], 2, '.', '');//echo number_format($req_qnty-$grey_receive_qnty_arr[$row[csf("po_id")]]["prod_quantity"], 2, '.', ''); ?></td>
                                <td align="center" width="80">
                                    <input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i;?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
                                </td>
                                <td align="center" width="80">
                                    <input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="calculate_tot_qnty();">
                                </td>
                                <td align="center" width="80">
                                    <input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes"  style="width:60px" value="<? echo $size_data; ?>" <? echo $disable_td; ?>>
                                </td>
                                <td align="center" width="80">
                                    <input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>" <? echo $disable; ?> onKeyUp="calculate_tot_qnty();">
                                </td>
                                <td align="center" width="80">
                                    <input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?> readonly/>
                                </td>
                                <td width="100" align="center"><input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:80px" value="<? echo $barcode_no; ?>" disabled/></td>
                                    <td width="65">
                                        <input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
                                        <input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
                                    </td>
                                </tr>
                                <?
						}
					}
				?>
				<input type="hidden" name="tot_po_qnty" id="tot_po_qnty" class="text_boxes" value="<? echo $tot_po_qnty; ?>">
				<input type="hidden" name="txt_tot_row" id="txt_tot_row" class="text_boxes" value="<? echo $i; ?>">
			</table>
			</div>
				<table width="<? echo $width + 180; ?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="tbl_bottom">
					<tr>
						<td width="130"></td>
						<td width="80"></td>
						<td width="80"></td>
						<td width="80" align="right"><b>Total</b></td>
						<td width="80" style="text-align:center">
							<input type="text" name="txt_tot_grey_qnty" id="txt_tot_grey_qnty" class="text_boxes_numeric" style="width:80px" value="<? echo number_format($tot_grey_qnty, 2); ?>" disabled>
						</td>
						<td width="80" style="text-align:center"><input type="text" name="txt_tot_grey_qnty_pcs" id="txt_tot_grey_qnty_pcs" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_grey_qnty_pcs, 2); ?>" disabled></td>
						<td align="center" width="80">

						</td>
						<td width="80" style="text-align:center"><input type="text" name="txt_tot_reject_qnty" id="txt_tot_reject_qnty" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_reject_qnty, 2); ?>"
						disabled></td>
						<td width="80"></td>
						<td width="100"></td>
						<td width="65"></td>
					</tr>
				</table>
				<table width="<? echo $width; ?>">
					<tr>
						<td align="center">
							<input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="fnc_close();" style="width:100px"/>
						</td>
					</tr>
				</table>
			</div>
			<? 
		}
		else
		{
			// echo $is_salesOrder;
			if($is_salesOrder != 2)
			{
				$disabled = "";
				$disabled_dropdown = 0;
				if ($receive_basis == 0 || $roll_maintained == 1) {
					$prev_distribution_method = 2;
					$disabled = "disabled='disabled'";
					$disabled_dropdown = 1;
				}
				?>
				<div style="width:<? echo $width - 20; ?>px; margin-top:5px;" align="center">
					<table style="margin-bottom:5px;" class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="300" align="center">
						<thead>
							<th>Total QC Pass Qty.</th>
							<th>Distribution Method</th>
						</thead>
						<tr class="general">
							<td>
								<input type="text" name="txt_prop_grey_qnty" id="txt_prop_grey_qnty" class="text_boxes_numeric" value="<? echo $txt_receive_qnty; ?>" style="width:120px" onBlur="distribute_qnty(document.getElementById('cbo_distribiution_method').value)" <? echo $disabled; ?> >
								<input type="hidden" name="over_production_percentage" id="over_production_percentage" value="<? echo $over_production_percentage;?>">
							</td>
							<td>
								<?
								echo create_drop_down("cbo_distribiution_method", 250, $distribiution_method, "", 0, "", $prev_distribution_method, "distribute_qnty(this.value);", $disabled_dropdown);
								?>
							</td>
						</tr>
					</table>
				</div>
				<div style="margin-left:5px; margin-top:10px">
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="<? echo $width + 220; ?>">
						<caption style="font-weight: bold;color: red;">Over Production Percentage: <? echo $over_production_percentage; ?>%</caption>
						<thead>
							<th width="110"><? echo ($is_salesOrder == 1) ? "Sales Order No" : "Job No"; ?></th>
							<th width="60">Style Ref.</th>
							<th width="80">PO Qnty</th>
							<?
							if ($receive_basis == 1 || $receive_basis == 2) {
								echo '<th width="80">Req. Qty.</th>';
							}
							?>
							<th width="80">Cumulative Production Qty.</th>
							<th width="80">Balance Qty</th>
							<th width="80">QC Pass Qty.</th>
							<th width="80">Qty. In Pcs</th>
							<th width="60">Size</th>
							<th width="80">Reject Qty.</th>
							<?
							if ($roll_maintained == 1) {
								?>
								<th width="60">Roll</th>
								<th width="70">Barcode No.</th>
								<th width="70">RFID</th>
								<th width="65"></th>
								<?
							}
							?>
						</thead>
					</table>
					<div style="width:<? echo $width+240; ?>px; max-height:200px; overflow-y:scroll" id="list_container" align="left">
						<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="<? echo $width + 220; ?>" id="tbl_list_search">
							<?
							$i = 1;
							$tot_po_qnty = 0;
							$tot_grey_qnty = 0;
							$tot_grey_qnty_pcs = 0;
							$tot_reject_qnty = 0;
							$po_array = array();
	
							if ($save_data != "" && $receive_basis == 0)//Independent
							{
	
								$po_id = explode(",", $po_id);
								$explSaveData = explode(",", $save_data);
								for ($z = 0; $z < count($explSaveData); $z++) {
									if ($i % 2 == 0)
										$bgcolor = "#E9F3FF";
									else
										$bgcolor = "#FFFFFF";
	
									$po_wise_data = explode("**", $explSaveData[$z]);
									$order_id = $po_wise_data[0];
									$grey_qnty = $po_wise_data[1];
									$reject_qnty = $po_wise_data[2];
									$roll_no = $po_wise_data[3];
									$roll_not_delete_id = $po_wise_data[4];
									$roll_id = $po_wise_data[5];
									$barcode_no = $po_wise_data[6];
									$grey_qnty_pcs = $po_wise_data[7];
									$rft_id = $po_wise_data[9];
									$r_floor_id = $po_wise_data[10];
									$r_room_id = $po_wise_data[11];
									$r_rack_id = $po_wise_data[12];
									$r_self_id = $po_wise_data[12];
	
									if (in_array($order_id, $po_id)) {
										$po_data = sql_select("select b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id=$order_id");
	
										if ($roll_maintained == 1) {
											$roll_used = return_field_value("roll_used", "pro_roll_details", "id='$roll_id'");
	
											if (!(in_array($order_id, $po_array))) {
												if ($roll_not_delete_id == 0) $tot_po_qnty += $po_data[0][csf('po_qnty_in_pcs')];
												$orginal_val = 1;
												$po_array[] = $order_id;
											} else {
												if ($roll_used == 1) $orginal_val = 1; else $orginal_val = 0;
											}
	
											if ($roll_used == 1) {
												$disable = "disabled='disabled'";
												$roll_not_delete_id = $roll_not_delete_id;
											} else {
												$disable = "";
												$roll_not_delete_id = 0;
											}
	
										} else {
											if (!(in_array($order_id, $po_array))) {
												$tot_po_qnty += $po_data[0][csf('po_qnty_in_pcs')];
												$orginal_val = 1;
												$po_array[] = $order_id;
											} else {
												$orginal_val = 0;
											}
	
											$roll_id = 0;
											$roll_not_delete_id = 0;
											$disable = "";
										}
	
										$tot_grey_qnty += $grey_qnty;
										$tot_grey_qnty_pcs += $grey_qnty_pcs;
										$tot_reject_qnty += $reject_qnty;
										//$balanceQty = number_format($yarn_balance_qty_arr[$order_id],2,".","");


										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$order_id],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$order_id] - $grey_production_qnty_arr[$order_id];
										$balanceQty = number_format($yarn_over_balance,2,".","");

										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $po_data[0][csf('po_number')]; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $order_id; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
											</td>
											<td width="60"><p><? echo $po_data[0][csf('grouping')]; ?>&nbsp;</p>
											</td>
											<td width="80" align="right">
												<? echo $po_data[0][csf('po_qnty_in_pcs')] ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $po_data[0][csf('po_qnty_in_pcs')]; ?>">
											</td>
											<td width="70" align="center"><? echo change_date_format($po_data[0][csf('pub_shipment_date')]); ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>
											<td width="80" align="right"><? echo ""; ?></td>
											<td width="80" align="right"><? echo ""; ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();" <? echo $disable_td; ?>>
											</td>
											<td align="center" width="80">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:60px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?>>
											</td>
											<td width="100" align="center">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:80px" value="<? echo $reject_qnty; ?>" <? echo $disable; ?> onKeyUp="calculate_tot_qnty();">
											</td>
											<?
											if ($roll_maintained == 1) {
	
												?>
												<td align="center" width="60">
													<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?> placeholder="<? //echo $roll_arr[$order_id]+1; ?>" onBlur="roll_duplication_check(<? echo $i; ?>);" readonly/>
											   </td>
											   <td width="70">
												<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:55px" value="<? echo $barcode_no; ?>" disabled/>
											   </td>
											   <td width="70">
												<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>" class="text_boxes_numeric" style="width:55px" value="<? echo $rft_id; ?>" />
											   </td>
											   <td width="65">
												<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
												<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
											   </td>
											   <?
										   }
										   ?>
									   </tr>
									   <?
									   $i++;
								   }
								}
	
								if (count($po_array) < 1) 
								{
								   $result = implode(",", $po_id);
								} 
								else 
								{
									$result = implode(",", array_diff($po_id, $po_array));
								}
								if ($result != "") 
								{
									$po_sql = "select b.id, b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in ($result) order by b.pub_shipment_date, b.id";
									$nameArray = sql_select($po_sql);
									foreach ($nameArray as $row) 
									{
										if ($i % 2 == 0)
											$bgcolor = "#E9F3FF";
										else
											$bgcolor = "#FFFFFF";
	
										$orginal_val = 1;
										$roll_id = 0;
										$roll_not_delete_id = 0;
	
										$tot_po_qnty += $row[csf('po_qnty_in_pcs')];
										//$balanceQty = number_format($yarn_balance_qty_arr[$row[csf('id')]],2,".","");

										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$row[csf('id')]],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$row[csf('id')]] - $grey_production_qnty_arr[$row[csf('id')]];
										$balanceQty = number_format($yarn_over_balance,2,".","");

										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $row[csf('po_number')]; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
											</td>
											<td width="60"><p><? echo $row[csf('grouping')]; ?>&nbsp;</p></td>
											<td width="80" align="right">
												<? echo $row[csf('po_qnty_in_pcs')]; ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $row[csf('po_qnty_in_pcs')]; ?>">
											</td>
											<td width="70" align="center"><? echo change_date_format($row[csf('pub_shipment_date')]); ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>
											<td width="80" align="right"><? echo "" ?> </td>
											<td width="80" align="right"><? echo ""; ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
											</td>
											<td align="center" width="80">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?>>
											</td>
											<td width="80" align="center">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="calculate_tot_qnty();">
											</td>
											<?
											if ($roll_maintained == 1) 
											{
												?>
												<td align="center" width="60">
													<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:65px" value="" onBlur="roll_duplication_check(<? echo $i; ?>);" placeholder="<? //echo $roll_arr[$row[csf('id')]]+1; ?>" readonly/>
											   </td>
											   <td width="70"><input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:70px" value="" disabled/></td>
												<td width="65">
													<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
													<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
												</td>
												<?
											}
											?>
										</tr>
										<?
										$i++;
									}
								}
							}
							else if ($save_data != "" && $receive_basis == 1)//Fabrick Booking
							{
								//echo $save_data;
								$booking_qnty_array = return_library_array("select a.po_break_down_id, sum(a.grey_fab_qnty) as qnty from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b where a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no='$booking_no' and b.lib_yarn_count_deter_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and b.gsm_weight='$txt_gsm' and a.dia_width='$txt_width' and a.job_no=b.job_no and a.status_active=1 and a.is_deleted=0 group by a.po_break_down_id", "po_break_down_id", "qnty");
	
								if ($roll_maintained == 1)
								{
									$all_po_id = explode(",", $all_po_id);
									$explSaveData = explode(",", $save_data);

									for ($z = 0; $z < count($explSaveData); $z++) {
	
										$po_wise_data = explode("**", $explSaveData[$z]);
	
										for ($y = 0; $y < count($po_wise_data); $y++) {

											$barcode_num[$po_wise_data[6]] = $po_wise_data[6];
	
										}
									}
									$barcode_nums = rtrim(implode(',',array_keys($barcode_num)),',') ;
									if($barcode_nums!="")
									{
										$qcRollSql = sql_select("SELECT barcode_no from PRO_QC_RESULT_MST where status_active=1 and is_deleted=0 and barcode_no in($barcode_nums)");
										$qcRollData=array();
										foreach ($qcRollSql as $row) 
										{
											$qcRollData[$row[csf("barcode_no")]] = $row[csf("barcode_no")];
										}
									}

									for ($z = 0; $z < count($explSaveData); $z++)
									{
										if ($i % 2 == 0)
											$bgcolor = "#E9F3FF";
										else
											$bgcolor = "#FFFFFF";
	
										$po_wise_data = explode("**", $explSaveData[$z]);
										//print_r($po_wise_data);
										$order_id = $po_wise_data[0];
										$grey_qnty = $po_wise_data[1];
										$reject_qnty = $po_wise_data[2];
										$roll_no = $po_wise_data[3];
										$roll_not_delete_id = $po_wise_data[4];
										$roll_id = $po_wise_data[5];
										$barcode_no = $po_wise_data[6];
										$grey_qnty_pcs = $po_wise_data[7];
										$size_qty = $po_wise_data[8];
										$rft_id = $po_wise_data[9];
										$r_floor_id = $po_wise_data[10];
										$r_room_id = $po_wise_data[11];
										$r_rack_id = $po_wise_data[12];
										$r_self_id = $po_wise_data[12];
										//echo $grey_qnty_pcs.'ddds';
										$req_qnty = $booking_qnty_array[$order_id];
										$bl_qnty = $req_qnty - $recv_qnty_array[$order_id];

										$qc_barcode_no = $qcRollData[$barcode_no];
	
										$po_data = sql_select("select b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id=$order_id");
	
										$roll_used = return_field_value("roll_used", "pro_roll_details", "id='$roll_id'");
	
										if (!(in_array($order_id, $po_array))) {
											if ($roll_not_delete_id == 0) $tot_po_qnty += $po_data[0][csf('po_qnty_in_pcs')];
											$orginal_val = 1;
											$po_array[] = $order_id;
										} else {
											if ($roll_used == 1) $orginal_val = 1; else $orginal_val = 0;
										}
	
										if ($roll_used == 1) {
											$disable = "disabled='disabled'";
											$roll_not_delete_id = $roll_not_delete_id;
										} else {
											$disable = "";
											$roll_not_delete_id = 0;
										}
	
										$tot_grey_qnty += $grey_qnty;
										$tot_grey_qnty_pcs += $grey_qnty_pcs;
										$tot_reject_qnty += $reject_qnty;
										//$balanceQty = number_format($yarn_balance_qty_arr[$order_id],2,".","");
	
										$production_balance = $req_qnty - $recv_qnty_array[$row[csf('po_breakdown_id')]];

										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$order_id],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$order_id] - $grey_production_qnty_arr[$order_id];
										$balanceQty = number_format($yarn_over_balance,2,".","");

										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $po_data[0][csf('po_number')]; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $order_id; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
												<input type="hidden" name="txtQcBarcode[]" id="txtQcBarcode_<? echo $i; ?>" value="<? echo $qc_barcode_no; ?>">
												<input type="hidden" name="preQCPassQty[]" id="preQCPassQty_<? echo $i; ?>" value="<? echo $grey_qnty; ?>"><!-- after qc roll qty not change -->
											</td>
											<td width="60"><p><? echo $po_data[0][csf('grouping')]; ?>&nbsp;</p>
											</td>
											<td width="80" align="right">
												<? echo $po_data[0][csf('po_qnty_in_pcs')] ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $po_data[0][csf('po_qnty_in_pcs')]; ?>">
											</td>
											<td width="70" align="center"><? echo change_date_format($po_data[0][csf('pub_shipment_date')]); ?></td>
											<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
											<td width="80" align="right"><? echo $recv_qnty_array[$row[csf('po_breakdown_id')]]; ?></td>
											<td width="80" align="right"><? echo  number_format($production_balance, 2, '.', ''); ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
											</td>
											<td align="center" width="60">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? echo $size_qty; ?>" <? echo $disable_td; ?>>
											</td>
											<td align="center" width="80">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>" <? echo $disable; ?> onKeyUp="calculate_tot_qnty();">
											</td>
											<td align="center" width="60">
												<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?>  placeholder="<? //echo $roll_arr[$order_id]+1; ?>" onBlur="roll_duplication_check(<? echo $i; ?>);" readonly/>
										   </td>
										   <td width="70">
											<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:55px" value="<? echo $barcode_no; ?>" disabled/>
										   </td>
										   <td width="70">
											<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>" class="text_boxes" style="width:55px" value="<? echo $rft_id; ?>" />
										   </td>
										   <td width="65">
											<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
											<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
										   </td>
									   </tr>
									   <?
									   $i++;
								   	}
	
								   	if ($db_type == 0) {
										$booking_po_id = return_field_value("group_concat(distinct(po_break_down_id)) as po_id", "wo_booking_dtls", "booking_no='$booking_no' and status_active=1 and is_deleted=0", "po_id");
								   	} else {
										$booking_po_id = return_field_value("LISTAGG(po_break_down_id, ',') WITHIN GROUP (ORDER BY po_break_down_id) as po_id", "wo_booking_dtls", "booking_no='$booking_no' and status_active=1 and is_deleted=0", "po_id");
								   	}
								   	$booking_po_id = array_unique(explode(",", $booking_po_id));
								   	$result = implode(",", array_diff($booking_po_id, $all_po_id));
	
								   	if ($result != "") 
								   	{
										$po_sql = "select b.id, b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in ($result) order by b.pub_shipment_date, b.id";
										$nameArray = sql_select($po_sql);
										foreach ($nameArray as $row)
										{
											if ($i % 2 == 0)
												$bgcolor = "#E9F3FF";
											else
												$bgcolor = "#FFFFFF";
		
											$orginal_val = 1;
											$roll_id = 0;
											$roll_not_delete_id = 0;
											$disable = "";
											$tot_po_qnty += $row[csf('po_qnty_in_pcs')];
		
											$req_qnty = $booking_qnty_array[$row[csf('id')]];
											$bl_qnty = $req_qnty - $recv_qnty_array[$row[csf('id')]];
											//$balanceQty = number_format($yarn_balance_qty_arr[$row[csf('id')]],2,".","");

											$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$row[csf('id')]],2,".","");
											$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
											$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$row[csf('id')]] - $grey_production_qnty_arr[$row[csf('id')]];
											$balanceQty = number_format($yarn_over_balance,2,".","");

											?>
											<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
												<td width="110">
													<p><? echo $row[csf('po_number')]; ?></p>
													<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
													<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
													<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
													<!--This is used for not delete row which is used in batch -->
													<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
													<!--This is used for Duplication Check -->
													<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
												</td>
												<td width="60"><p><? echo $row[csf('grouping')]; ?>&nbsp;</p></td>
												<td width="80" align="right">
													<? echo $row[csf('po_qnty_in_pcs')]; ?>
													<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $row[csf('po_qnty_in_pcs')]; ?>">
												</td>
												<td width="70" align="center"><? echo change_date_format($row[csf('pub_shipment_date')]); ?></td>
												<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
												<td width="80" align="right"><? echo ""; ?></td>
												<td width="80" align="right"><? echo ""; ?></td>
												<td align="center" width="80">
													<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>); calculate_tot_qnty(); fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
												</td>
												<td align="center" width="80">
													<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
												</td>
												<td align="center" width="60">
													<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?>>
												</td>
												<td align="center" width="80">
													<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="calculate_tot_qnty();">
												</td>
												<td align="center" width="60">
													<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="" onBlur="roll_duplication_check(<? echo $i; ?>);" placeholder="<? //echo $roll_arr[$row[csf('id')]]+1; ?>" readonly/>
												   </td>
												   <td width="70">
													<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>"  class="text_boxes_numeric" style="width:55px" value="" disabled/>
												   </td>
												   <td width="70">
													<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>"  class="text_boxes" style="width:55px" value="" />
												   </td>
												   <td width="65">
													<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
													<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
												   </td>
											   </tr>
											   <?
											   $i++;
										}
									}
								}
								else
								{
									$prev_po_qnty_arr = array();
									$prev_po_qnty_pcs_arr = array();
									$prev_reject_qnty_arr = array();
									$explSaveData = explode(",", $save_data);
									for ($z = 0; $z < count($explSaveData); $z++) 
									{
										$po_wise_data = explode("**", $explSaveData[$z]);
										$order_id = $po_wise_data[0];
										$grey_qnty = $po_wise_data[1];
										$reject_qnty = $po_wise_data[2];
										$grey_qnty_pcs = $po_wise_data[7];
										$size_qty = $po_wise_data[8];
	
										$prev_po_qnty_arr[$order_id] = $grey_qnty;
										$prev_po_qnty_pcs_arr[$order_id] = $grey_qnty_pcs;
										$prev_reject_qnty_arr[$order_id] = $reject_qnty;
									}
	
									$po_sql = "select b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b, wo_booking_dtls c where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and c.booking_no='$booking_no' and c.status_active=1 and c.is_deleted=0 group by b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping order by b.pub_shipment_date, b.id";
									$nameArray = sql_select($po_sql);
									foreach ($nameArray as $row)
									{
	
										if ($i % 2 == 0)
											$bgcolor = "#E9F3FF";
										else
											$bgcolor = "#FFFFFF";
	
										$orginal_val = 1;
										$roll_id = 0;
										$roll_not_delete_id = 0;
										$disable = "";
	
										$po_qnty_in_pcs = $row[csf('po_quantity')] * $row[csf('total_set_qnty')];
										$tot_po_qnty += $po_qnty_in_pcs;
	
										$grey_qnty = $prev_po_qnty_arr[$row[csf('id')]];
										$grey_qnty_pcs = $prev_po_qnty_pcs_arr[$row[csf('id')]];
										$req_qnty = $booking_qnty_array[$row[csf('id')]];
										$reject_qnty = $prev_reject_qnty_arr[$row[csf('id')]];
										$tot_grey_qnty += $grey_qnty;
										$tot_grey_qnty_pcs += $grey_qnty_pcs;
										$tot_reject_qnty += $reject_qnty;
										$production_balance = $req_qnty - $recv_qnty_array[$row[csf('id')]];
										//$balanceQty = number_format($yarn_balance_qty_arr[$row[csf('id')]],2,".","");


										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$row[csf('id')]],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$row[csf('id')]] - $grey_production_qnty_arr[$row[csf('id')]];
										$balanceQty = number_format($yarn_over_balance,2,".","");

	
										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $row[csf('po_number')]; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
											</td>
											<td width="60"><p><? echo $row[csf('grouping')]; ?>&nbsp;</p></td>
											<td width="80" align="right">
												<? echo $po_qnty_in_pcs; ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $po_qnty_in_pcs; ?>">
											</td>
											<td width="70" align="center"><? echo change_date_format($row[csf('pub_shipment_date')]); ?></td>
											<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
											<td width="80" align="right"><? echo ""; ?></td>
											<td width="80" align="right"><? echo ""; ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" placeholder="<? if ($roll_maintained == 0) echo number_format($production_balance, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
											</td>
											<td align="center" width="80">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:60px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?>>
											</td>
											<td width="80" align="center">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>"
												onKeyUp="calculate_tot_qnty();">
											</td>
										</tr>
										<?
										$i++;
									}
								}
							}
							else if ($save_data_stylewise != "" && $receive_basis == 2) //Kniting plan
							{
								/*$program_qnty_array = return_library_array("select b.po_id, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b where a.id=b.dtls_id and b.dtls_id='$booking_no' and b.determination_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and b.status_active=1 and b.is_deleted=0 group by b.po_id", "po_id", "qnty");*/
								
								//echo $save_data_stylewise;die;
								//echo $roll_maintained."===";die;
								if ($roll_maintained == 1)
								{
									$all_po_id = explode(",", $all_po_id);
									$explSaveData = explode(",", $save_data_stylewise);
	
									for ($z = 0; $z < count($explSaveData); $z++) {
	
										$po_wise_data = explode("**", $explSaveData[$z]);
	
										for ($y = 0; $y < count($po_wise_data); $y++) {
	
											//$order_id[$po_wise_data[0]] = $po_wise_data[0];
											$job_no_arr[$po_wise_data[0]] = $po_wise_data[0];
											$roll_id[$po_wise_data[5]] = $po_wise_data[5];
											$barcode_num[$po_wise_data[6]] = $po_wise_data[6];
	
										}
									}
	
									$job_nos = "'".implode("','",array_keys($job_no_arr))."'";
									$order_ids = implode(',',array_keys($order_id));
									$roll_ids = implode(',',array_keys($roll_id));
									$barcode_nums = rtrim(implode(',',array_keys($barcode_num)),',') ;
	
									if($job_nos!="")
									{
										if ($is_salesOrder == 1) 
										{
											//$po_data = sql_select("select a.id,a.job_no as po_number, sum(b.grey_qty) as po_qnty_in_pcs from fabric_sales_order_mst a, fabric_sales_order_dtls b where a.id=b.mst_id and a.id in ($order_ids) group by a.id, a.job_no");

											$po_data = sql_select("select a.id as pos, a.job_no, a.style_ref_no, sum(b.grey_qty) as po_qnty_in_pcs from fabric_sales_order_mst a, fabric_sales_order_dtls b, ppl_planning_entry_plan_dtls c where a.id=b.mst_id and b.mst_id=c.po_id and c.dtls_id=$booking_no group by a.id, a.job_no, a.style_ref_no");
											$allPoId="";
											$po_data_arr = array();
											foreach ($po_data as $row) 
											{
												$allPoId.= $row[csf('pos')].',';
												$job_data_arr[$row[csf('job_no')]]['po_qnty_in_pcs'] 		=  $row[csf('po_qnty_in_pcs')];
												$job_data_arr[$row[csf('job_no')]]['style_ref_no'] 		=  $row[csf('style_ref_no')];
												$job_data_arr[$row[csf('job_no')]]['job_no'] 		=  $row[csf('job_no')];
											}
											$allPoId=chop($allPoId,",");

											//echo "=============";die;

											$greyRecvQty = sql_select("select d.job_no, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c, fabric_sales_order_mst d where a.id=b.mst_id and b.id=c.dtls_id and a.status_active=1 and a.entry_form=2  and a.receive_basis=2  and c.entry_form=2 and a.booking_no='$booking_no' and c.po_breakdown_id in($allPoId) and c.po_breakdown_id=d.id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 group by d.job_no");

											$program_qnty_array = return_library_array("select d.job_no, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b, fabric_sales_order_mst c where a.id=b.dtls_id and b.po_id=c.id and b.dtls_id='$booking_no' and b.status_active=1 and b.is_deleted=0 group by d.job_no", "job_no", "qnty");
										} 
										else 
										{
											//$po_data = sql_select("select b.id,b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping,b.po_quantity from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_ids)");

											if($db_type == 0){
												$pos_select= "group_concat(b.id) as pos,";
											}else{
												$pos_select= "listagg(cast(b.id as varchar(4000)) ,',' ) within group (order by b.id) as pos,";
											}
											$po_data = sql_select("select $pos_select a.job_no, a.style_ref_no, sum(a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs from wo_po_details_master a, wo_po_break_down b, ppl_planning_entry_plan_dtls c where a.id=b.job_id and b.id=c.po_id and c.dtls_id=$booking_no and a.job_no in ($job_nos) group by a.job_no, a.style_ref_no");

											$allPoId="";
											$po_data_arr = array();
											foreach ($po_data as $row) 
											{
												$allPoId.= $row[csf('pos')].',';
												$job_data_arr[$row[csf('job_no')]]['po_qnty_in_pcs'] 		=  $row[csf('po_qnty_in_pcs')];
												$job_data_arr[$row[csf('job_no')]]['style_ref_no'] 		=  $row[csf('style_ref_no')];
												$job_data_arr[$row[csf('job_no')]]['job_no'] 		=  $row[csf('job_no')];
											}
											$allPoId=chop($allPoId,",");

											$greyRecvQty = sql_select("select e.job_no, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c, wo_po_break_down d, wo_po_details_master e where a.id=b.mst_id and b.id=c.dtls_id and c.po_breakdown_id=d.id and d.job_id=e.id and a.status_active=1 and a.entry_form=2 and a.receive_basis=2 and c.entry_form=2 and a.booking_no='$booking_no' and c.po_breakdown_id in($allPoId) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 group by e.job_no");
											$program_qnty_array = return_library_array("select d.job_no, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b, wo_po_break_down c, wo_po_details_master d where a.id=b.dtls_id and b.po_id=c.id and c.job_id=d.id and b.dtls_id='$booking_no' and b.status_active=1 and b.is_deleted=0 group by d.job_no", "job_no", "qnty");
										}
									}

									/*$greyRecvQty =sql_select("select po_breakdown_id,sum(quantity) as prod_quantity from order_wise_pro_details where po_breakdown_id in($allPoId) and entry_form=2 and status_active=1 and is_deleted=0 group by po_breakdown_id");*/
	
									foreach ($greyRecvQty as $row) {
										$grey_receive_qnty_arr[$row[csf("job_no")]]["prod_quantity"] = $row[csf("recv_qnty")];
									}
	
									if($roll_ids!="")
									{
										$sqlroll = sql_select("select barcode_no,roll_used from pro_roll_details where status_active=1 and is_deleted=0 and id in($roll_ids)");
										foreach ($sqlroll as $row) {
											$rollData[$row[csf("barcode_no")]]['roll_used'] = $row[csf("roll_used")];
										}
									}

									if($barcode_nums!="")
									{
										$qcRollSql = sql_select("SELECT barcode_no from PRO_QC_RESULT_MST where status_active=1 and is_deleted=0 and barcode_no in($barcode_nums)");
										$qcRollData=array();
										foreach ($qcRollSql as $row) 
										{
											$qcRollData[$row[csf("barcode_no")]] = $row[csf("barcode_no")];
										}
									}
									
									//echo count($explSaveData)."===";die;
								   	for ($z = 0; $z < count($explSaveData); $z++)
								   	{
										if ($i % 2 == 0)
											$bgcolor = "#E9F3FF";
										else
											$bgcolor = "#FFFFFF";
	
										$job_wise_data = explode("**", $explSaveData[$z]);
										//$order_id = $po_wise_data[0];
										$job_no = $job_wise_data[0];
										$grey_qnty = $job_wise_data[1];
										$reject_qnty = $job_wise_data[2];
										$roll_no = $job_wise_data[3];
										$roll_not_delete_id = $job_wise_data[4];
										$roll_id = $job_wise_data[5];
										$barcode_no = $job_wise_data[6];
										$grey_qnty_pcs = $job_wise_data[7];
										$size_qty = $job_wise_data[8];
										$rft_id = $job_wise_data[9];
										$r_floor_id = $job_wise_data[10];
										$r_room_id = $job_wise_data[11];
										$r_rack_id = $job_wise_data[12];
										$r_self_id = $job_wise_data[12];
	
										$req_qnty = $program_qnty_array[$job_no];
										$bl_qnty = $req_qnty - $recv_qnty_array[$job_no];

										//echo $req_qnty."=".$recv_qnty_array[$order_id]."<br>";
	
										$roll_used = $rollData[$barcode_no]['roll_used'];
										$qc_barcode_no = $qcRollData[$barcode_no];
	
										if (!(in_array($job_no, $job_no_array))) {
											if ($roll_not_delete_id == 0) $tot_po_qnty += $job_wise_data[$job_no]['po_qnty_in_pcs'];
											$orginal_val = 1;
											$job_no_array[] = $job_no;
										} else {
											if ($roll_used == 1) $orginal_val = 1; else $orginal_val = 0;
										}
	
										if ($roll_used == 1) {
											$disable = "disabled='disabled'";
											$roll_not_delete_id = $roll_not_delete_id;
										} else {
											$disable = "";
											$roll_not_delete_id = 0;
										}
	
										$tot_grey_qnty += $grey_qnty;
										$tot_grey_qnty_pcs += $grey_qnty_pcs;
										$tot_reject_qnty += $reject_qnty;
	
										$prev_own_rcv = $this_challan_rcv[$dtls_id][$job_no];
										//$balanceQty = number_format($yarn_balance_qty_arr[$order_id]+$prev_own_rcv,2,".","");

										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$job_no],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance =$yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$job_no] - $grey_production_qnty_arr[$job_no] + $prev_own_rcv;

										$balanceQty = number_format($yarn_over_balance,2,".","");

										if($production_control == 1)
										{
											$balanceQty = $balanceQty;
										}else{
											$balanceQty = $bl_qnty;
										}

										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $job_no//$po_data_arr[$order_id]['po_number']; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $job_no; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtQcBarcode[]" id="txtQcBarcode_<? echo $i; ?>" value="<? echo $qc_barcode_no; ?>">
												<input type="hidden" name="preQCPassQty[]" id="preQCPassQty_<? echo $i; ?>" value="<? echo $grey_qnty; ?>"><!-- after qc roll qty not change -->
												
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
											</td>
											<td width="60"><p><? echo $job_data_arr[$job_no]['style_ref_no'] ; ?>&nbsp;</p>
											</td>
											<td width="80" align="right">
												<? echo $job_data_arr[$job_no]['po_qnty_in_pcs']; ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $job_data_arr[$job_no]['po_qnty_in_pcs']; ?>">
											</td>

											<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?> </td>
											<td width="80" align="right"><input type="text" name="txtGreyQntyCumulative[]" id="txtGreyQntyCumulative_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px;" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> disabled></td>
											<td width="80" align="right"><? echo number_format(($balanceQty-$grey_qnty),2,".","");//echo number_format($req_qnty-$grey_receive_qnty_arr[$row[csf("po_id")]]["prod_quantity"], 2, '.', ''); ?></td>
											
											<td align="center" width="80">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>

											<td align="center" width="80">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
											</td>
											<td align="center" width="60">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? echo $size_qty; ?>" <? echo $disable_td; ?> placeholder="B/W" onDblClick="func_onDblClick_finishSize(<? echo $i; ?>);" />
											</td>
											<td width="80" align="center">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>" <? echo $disable; ?> onKeyUp="calculate_tot_qnty();">
											</td>
											<td align="center" width="60">
											<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?> placeholder="<? //echo $roll_arr[$order_id]+1; ?>" onBlur="roll_duplication_check(<? echo $i; ?>);" readonly/>
										   </td>
										   <td width="70">
											<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:55px" value="<? echo $barcode_no; ?>" disabled/>
										   </td>
										   <td width="70">
											<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>" class="text_boxes" style="width:55px" value="<? echo $rft_id; ?>" />
										   </td>
										   <td width="65">
											<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
											<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
										   </td>
									   	</tr>
									   <?
									   $i++;
								   	}
									/*
									   	if ($is_salesOrder == 1)
									   	{
											$result = '';
									   	} 
									   	else 
									   	{
											if ($db_type == 0) {
												$plan_po_id = return_field_value("group_concat(distinct(po_id)) as po_id", "ppl_planning_entry_plan_dtls", "dtls_id='$booking_no' and status_active=1 and is_deleted=0", "po_id");
											} else {
												$plan_po_id = return_field_value("LISTAGG(po_id, ',') WITHIN GROUP (ORDER BY po_id) as po_id", "ppl_planning_entry_plan_dtls", "dtls_id='$booking_no' and status_active=1 and is_deleted=0", "po_id");
											}
											$plan_po_id = array_unique(explode(",", $plan_po_id));
											$result = implode(",", array_diff($plan_po_id, $all_po_id));
									   	}
		
									   	if ($result != "")
									   	{
											
											$po_sql = "select b.id, b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in ($result) order by b.pub_shipment_date, b.id";
											$nameArray = sql_select($po_sql);
											foreach ($nameArray as $row)
											{
												if ($i % 2 == 0)
													$bgcolor = "#E9F3FF";
												else
													$bgcolor = "#FFFFFF";
		
												$orginal_val = 1;
												$roll_id = 0;
												$roll_not_delete_id = 0;
												$disable = "";
												$tot_po_qnty += $row[csf('po_qnty_in_pcs')];
		
												$req_qnty = $program_qnty_array[$row[csf('id')]];
												$bl_qnty = $req_qnty - $recv_qnty_array[$row[csf('id')]];
												$balanceQty = number_format($yarn_balance_qty_arr[$row[csf('id')]],2,".","");
		
												?>
												<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
													<td width="110">
														<p><? echo $row[csf('po_number')]; ?></p>
														<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
														<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
														<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
														<!--This is used for not delete row which is used in batch -->
														<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
														<!--This is used for Duplication Check -->
														<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
													</td>
													<td width="60"><p><? echo $row[csf('grouping')]; ?>&nbsp;</p></td>
													<td width="80" align="right">
														<? echo $row[csf('po_qnty_in_pcs')]; ?>
														<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $row[csf('po_qnty_in_pcs')]; ?>">
													</td>
													<td width="70" align="center"><? echo change_date_format($row[csf('pub_shipment_date')]); ?></td>
													<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
													<td width="80" align="right"><? echo ""; ?></td>
													<td width="80" align="right"><? echo ""; ?></td>
													
													<td align="center" width="80">
														<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
													</td>

													<td align="center" width="80">
														<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
													</td>
													<td align="center" width="60">
														<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?>>
													</td>
													<td width="80" align="center">
														<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="calculate_tot_qnty();">
													</td>
													<td align="center" width="60">
														<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="" onBlur="roll_duplication_check(<? echo $i; ?>);" placeholder="<? //echo $roll_arr[$row[csf('id')]]+1; ?>" readonly/>
													</td>
													<td width="70">
														<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:55px" value="" disabled/>
													</td>
													<td width="70">
														<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>" class="text_boxes" style="width:55px" value="" />
													</td>
													<td width="65">
														<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
														<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
													</td>
												</tr>
												<?
												$i++;
											}
										}
									*/
								}
								else
								{
									$program_qnty_array = return_library_array("select b.po_id, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b where a.id=b.dtls_id and b.dtls_id='$booking_no' and b.determination_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and b.status_active=1 and b.is_deleted=0 group by b.po_id", "po_id", "qnty");

									$prev_po_qnty_arr = array();
									$prev_po_qnty_pcs_arr = array();
									$prev_reject_qnty_arr = array();
									$explSaveData = explode(",", $save_data);
									for ($z = 0; $z < count($explSaveData); $z++) 
									{
										$po_wise_data = explode("**", $explSaveData[$z]);
										/*echo "<pre>";
										print_r($po_wise_data);*/
										$order_id = $po_wise_data[0];
										$grey_qnty = $po_wise_data[1];
										$grey_qnty_pcs = $po_wise_data[7];
										$reject_qnty = $po_wise_data[2];
										$size = $po_wise_data[8];
										$prev_po_qnty_arr[$order_id] = $grey_qnty;
										$prev_po_qnty_pcs_arr[$order_id] = $grey_qnty_pcs;
										$prev_reject_qnty_arr[$order_id] = $reject_qnty;
										$prev_size_arr[$order_id] = $size;
									}
	
									$i = 1;
									$orginal_val = 1;
									$roll_id = 0;
									$roll_not_delete_id = 0;
	
									if ($is_salesOrder == 1) {
										$po_data = sql_select("select a.id, a.job_no as po_number, sum(b.grey_qty) as po_quantity, 1 as total_set_qnty from fabric_sales_order_mst a, fabric_sales_order_dtls b, ppl_planning_entry_plan_dtls c where a.id=b.mst_id and b.mst_id=c.po_id and c.dtls_id=$booking_no group by a.id, a.job_no");
									} else {
										$po_data = sql_select("select b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b, ppl_planning_entry_plan_dtls c where a.job_no=b.job_no_mst and b.id=c.po_id and c.dtls_id=$booking_no group by b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping order by b.pub_shipment_date, b.id");
									}
	
									$allPoId="";
									foreach ($po_data as $row) {
										$allPoId.= "'".$row[csf('id')]."'".',';
									}
									$allPoId=chop($allPoId,",");
	
									if($dtls_id) $dtls_id_cond = " and b.id<>$dtls_id";
									$program_recv_qnty_array = return_library_array("select c.po_breakdown_id, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c where a.id=b.mst_id and b.id=c.dtls_id and a.status_active=1 and a.entry_form=2  and a.receive_basis=2  and c.entry_form=2 and a.booking_no='$booking_no' and b.febric_description_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and  c.po_breakdown_id in($allPoId) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 $dtls_id_cond group by c.po_breakdown_id", "po_breakdown_id", "recv_qnty");
								
									foreach ($po_data as $row) {
										$po_qnty_in_pcs = $row[csf('po_quantity')] * $row[csf('total_set_qnty')];
										$tot_po_qnty += $po_qnty_in_pcs;
										$req_qnty = $program_qnty_array[$row[csf('id')]];
										//$bl_qnty = $req_qnty - $recv_qnty_array[$row[csf('id')]];
	
										$grey_qnty = $prev_po_qnty_arr[$row[csf('id')]];
										$grey_qnty_pcs = $prev_po_qnty_pcs_arr[$row[csf('id')]];
										$grey_size = $prev_size_arr[$row[csf('id')]];
										$tot_grey_qnty += $grey_qnty;
										$tot_grey_qnty_pcs += $grey_qnty_pcs;
										$reject_qnty = $prev_reject_qnty_arr[$row[csf('id')]];
										$tot_reject_qnty += $reject_qnty;
										$prev_own_rcv = $this_challan_rcv[$dtls_id][$row[csf('id')]];
	
										$production_balance = $req_qnty - $program_recv_qnty_array[$row[csf('id')]];
										$req_qnty_with_over_perc = ($req_qnty*$over_production_percentage)/100 + $req_qnty;
										$production_over_balance = $req_qnty_with_over_perc - $program_recv_qnty_array[$row[csf('id')]];

										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$row[csf('id')]],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$row[csf('id')]] - $grey_production_qnty_arr[$row[csf('id')]] + $prev_own_rcv;
										$balanceQty = number_format($yarn_over_balance,2,".","");

	
										if ($i % 2 == 0)
											$bgcolor = "#E9F3FF";
										else
											$bgcolor = "#FFFFFF";
										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $row[csf('po_number')]; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
											</td>
											<td width="60"><p><? echo $row[csf('grouping')]; ?>&nbsp;</p></td>
											<td width="80" align="right">
												<? echo $po_qnty_in_pcs; ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $po_qnty_in_pcs; ?>">
											</td>
											<td width="70" align="center"><? if ($is_salesOrder != 1) echo change_date_format($row[csf('pub_shipment_date')]); ?> &nbsp;</td>
											<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
	
											<td width="80" align="right"><input type="text" name="txtGreyQntyCumulative[]" id="txtGreyQntyCumulative_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px;" value="<? echo $program_recv_qnty_array[$row[csf('id')]]; ?>" <? echo $disable; ?> disabled></td>
	
											<td width="80" align="right" title="with over production %  balance: <? echo $production_over_balance ?> and Yarn balance: <? echo $yarn_over_balance;?>"><? echo number_format($production_balance,2,".",""); ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" placeholder="<? if ($roll_maintained == 0) echo number_format($production_balance, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
											</td>
											<td align="center" width="60">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? echo $grey_size;//echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?>>
											</td>
											<td width="80" align="center">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>" onKeyUp="calculate_tot_qnty();">
											</td>
										</tr>
										<?
										$i++;
									}
								}
							}
							else
							{
								if ($receive_basis == 2) //Kniting plan un-save data
								{
									$i = 1;
									$orginal_val = 1;
									$roll_id = 0;
									$roll_not_delete_id = 0;
									$disable = "";
	
									/*$program_qnty_array = return_library_array("select b.po_id, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b where a.id=b.dtls_id and b.dtls_id='$booking_no' and b.determination_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and b.status_active=1 and b.is_deleted=0 group by b.po_id", "po_id", "qnty"); */

									

									// and b.gsm_weight='$txt_gsm' and a.fabric_dia='$txt_width'
									if ($is_salesOrder == 1) {
										//$po_data = sql_select("select a.id, a.job_no as po_number, sum(b.grey_qty) as po_quantity, 1 as total_set_qnty from fabric_sales_order_mst a, fabric_sales_order_dtls b, ppl_planning_entry_plan_dtls c where a.id=b.mst_id and b.mst_id=c.po_id and c.dtls_id=$booking_no group by a.id, a.job_no");

										$po_data = sql_select("select a.id as pos, a.job_no, a.style_ref_no, sum(b.grey_qty) as po_qnty_in_pcs from fabric_sales_order_mst a, fabric_sales_order_dtls b, ppl_planning_entry_plan_dtls c where a.id=b.mst_id and b.mst_id=c.po_id and c.dtls_id=$booking_no group by a.id, a.job_no, a.style_ref_no");

										$program_qnty_array = return_library_array("select c.job_no, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b, fabric_sales_order_mst c where a.id=b.dtls_id and b.dtls_id='$booking_no' and b.determination_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and b.status_active=1 and b.is_deleted=0 and b.po_id=c.id group by c.job_no", "job_no", "qnty");
										$allPoId="";
										foreach ($po_data as $row) {
											$allPoId.= "'".$row[csf('pos')]."'".',';
										}
										$allPoId=chop($allPoId,",");
										$program_recv_qnty_array = return_library_array("  select d.job_no, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c, fabric_sales_order_mst d where a.id=b.mst_id and b.id=c.dtls_id and a.status_active=1 and a.entry_form=2  and a.receive_basis=2  and c.entry_form=2 and a.booking_no='$booking_no' and b.febric_description_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and  c.po_breakdown_id in($allPoId) and c.po_breakdown_id=d.id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 group by d.job_no", "job_no", "recv_qnty");

									} else {
										/*$po_data = sql_select("select b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping,c.po_id from wo_po_details_master a, wo_po_break_down b, ppl_planning_entry_plan_dtls c where a.job_no=b.job_no_mst and b.id=c.po_id and c.dtls_id=$booking_no group by b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping,c.po_id order by b.pub_shipment_date, b.id");*/
										if($db_type == 0){
											$pos_select= "group_concat(b.id) as pos,";
										}else{
											$pos_select= "listagg(cast(b.id as varchar(4000)) ,',' ) within group (order by b.id) as pos,";
										}
										$po_data = sql_select("select $pos_select a.job_no, a.style_ref_no, sum(a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs from wo_po_details_master a, wo_po_break_down b, ppl_planning_entry_plan_dtls c where a.id=b.job_id and b.id=c.po_id and c.dtls_id=$booking_no group by a.job_no, a.style_ref_no");

										$program_qnty_array = return_library_array("select d.job_no, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b, wo_po_break_down c, wo_po_details_master d where a.id=b.dtls_id and b.dtls_id='$booking_no' and b.determination_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and b.status_active=1 and b.is_deleted=0 and b.po_id=c.id and c.job_id=d.id group by d.job_no", "job_no", "qnty");

										$allPoId="";
										foreach ($po_data as $row) {
											$allPoId.= "'".$row[csf('pos')]."'".',';
										}
										$allPoId=chop($allPoId,",");

										$program_recv_qnty_array = return_library_array("select e.job_no, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c, wo_po_break_down d, wo_po_details_master e where a.id=b.mst_id and b.id=c.dtls_id and c.po_breakdown_id=d.id and d.job_id=e.id and a.status_active=1 and a.entry_form=2 and a.receive_basis=2 and c.entry_form=2 and a.booking_no='$booking_no' and b.febric_description_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and c.po_breakdown_id in($allPoId) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 group by e.job_no", "job_no", "recv_qnty");
									}
									
									foreach ($po_data as $row)
									{
										$po_qnty_in_pcs =  $row[csf('po_qnty_in_pcs')];//  $row[csf('po_quantity')] * $row[csf('total_set_qnty')];
										$tot_po_qnty += $po_qnty_in_pcs;
	
										//===================
										
										//echo $row[csf('id')];
										$req_qnty = $program_qnty_array[$row[csf('job_no')]];
										$bl_qnty = $req_qnty - $recv_qnty_array[$row[csf('job_no')]];
										
										//$grey_qnty = $prev_po_qnty_arr[$row[csf('id')]];
	
										$production_balance =$req_qnty-$program_recv_qnty_array[$row[csf('job_no')]];

										$req_qnty_with_over_perc = ($req_qnty*$over_production_percentage)/100 + $req_qnty;
										$production_over_balance = $req_qnty_with_over_perc - $recv_qnty_array[$row[csf('job_no')]];
										
										//------------------------------------------------------


										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$row[csf('job_no')]],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$row[csf('job_no')]] - $grey_production_qnty_arr[$row[csf('job_no')]];
										//echo $row[csf('job_no')]."=".$yarn_issue_quantity."=".$yarn_issue_with_over_perc."=".$yarn_issue_return_qnty_arr[$row[csf('job_no')]]."=".$grey_production_qnty_arr[$row[csf('job_no')]];
										//echo $yarn_issue_with_over_perc;
										$balanceQty = number_format($yarn_over_balance,2,".","");
										//$yarn_over_balance = ($balanceQty*$over_production_percentage)/100 + $balanceQty;
	
										if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $row[csf('job_no')]; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('job_no')]; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>"><!-- =kp save= -->
											</td>
											<td width="60"><p><? echo $row[csf('style_ref_no')]; ?>&nbsp;</p></td>
											<td width="80" align="right">
												<? echo ($is_salesOrder == 1) ? "" : $po_qnty_in_pcs; ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $po_qnty_in_pcs; ?>">
											</td>
											<td width="80" align="right"><? echo decimal_format($req_qnty,1);//number_format($req_qnty, 2, '.', ''); ?></td>
											<td width="80" align="right">
												<input type="text" name="txtGreyQntyCumulative[]" id="txtGreyQntyCumulative_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px;" value="<? echo $program_recv_qnty_array[$row[csf('job_no')]]; ?>" <? echo $disable; ?> disabled>
											</td>
											<td width="80" align="right" title="with over production %  balance: <? echo $production_over_balance ?> and Yarn balance: <? echo $yarn_over_balance;?>">
												<? //echo $balanceQty;
													echo number_format($production_balance, 2, '.', ''); 
												?>
											</td>
											<td width="80" align="center">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" <? echo $disable; ?> placeholder="<? if ($roll_maintained == 0) echo decimal_format($production_balance, 1); ?>" onClick="get_weight_from_weight_machine(<? echo $i; ?>)" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>
											<td width="80" align="center">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" <? echo $disable_td; ?> placeholder="<? if ($roll_maintained == 0) echo decimal_format($bl_qnty_pcs, 0); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
											</td>
											<td align="center" width="60">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?> placeholder="B/W" onDblClick="func_onDblClick_finishSize(<? echo $i; ?>);" />
											</td>
											<td width="80" align="center">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="calculate_tot_qnty();">
											</td>
											<?
											if ($roll_maintained == 1)
											{
												?>
												<td align="center" width="60">
													<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?> placeholder="<? //echo $roll_arr[$row[csf('id')]]+1; ?>" onBlur="roll_duplication_check(<? echo $i; ?>);" readonly/>
												</td>
												<td width="70">
													<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:55px" value="" disabled/>
												</td>
												<td width="70">
													<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>" class="text_boxes" style="width:55px" value="" />
												</td>
												<td width="65">
													<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
													<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
												</td>
												<?
											}
											?>
										</tr>
										<?
										$i++;
									}
								}
								else // without knitting plan
								{
								
									if ($type == 1) {
										if ($po_id != "") {
											$po_sql = "select b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in ($po_id) order by b.pub_shipment_date, b.id";
										}
									} else {
										$po_sql = "select b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b, wo_booking_dtls c where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and c.booking_no='$booking_no' and c.status_active=1 and c.is_deleted=0 group by b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping order by b.pub_shipment_date, b.id";
	
										$booking_qnty_array = return_library_array("select a.po_break_down_id, sum(a.grey_fab_qnty) as qnty from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b where a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no='$booking_no' and b.lib_yarn_count_deter_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and b.gsm_weight='$txt_gsm' and a.dia_width='$txt_width' and a.job_no=b.job_no and a.status_active=1 and a.is_deleted=0 group by a.po_break_down_id", "po_break_down_id", "qnty");
									}
	
	
									$nameArray = sql_select($po_sql);
									$allPoId="";
									foreach ($nameArray as $row) {
										$allPoId.= "'".$row[csf('id')]."'".',';
									}
									$allPoId=chop($allPoId,",");
	
									foreach ($nameArray as $row)
									{
										if ($i % 2 == 0)
											$bgcolor = "#E9F3FF";
										else
											$bgcolor = "#FFFFFF";
	
										$orginal_val = 1;
										$roll_id = 0;
										$roll_not_delete_id = 0;
										$disable = "";//$disable_td="";
	
										$po_qnty_in_pcs = $row[csf('po_quantity')] * $row[csf('total_set_qnty')];
										$tot_po_qnty += $po_qnty_in_pcs;
										//$balanceQty = $yarn_balance_qty_arr[$row[csf('id')]];

										$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$row[csf('id')]],2,".","");
										$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
										$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$row[csf('id')]] - $grey_production_qnty_arr[$row[csf('id')]];

										$balanceQty = number_format($yarn_over_balance,2,".","");

										//echo $cbo_body_part.'ddd';
										?>
										<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
											<td width="110">
												<p><? echo $row[csf('po_number')]; ?></p>
												<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
												<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
												<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
												<!--This is used for not delete row which is used in batch -->
												<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
												<!--This is used for Duplication Check -->
												<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
											</td>
											<td width="60"><p><? echo $row[csf('grouping')]; ?>&nbsp;</p></td>
											<td width="80" align="right">
												<? echo $po_qnty_in_pcs; ?>
												<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $po_qnty_in_pcs; ?>">
											</td>
											<td width="70" align="center"><? echo change_date_format($row[csf('pub_shipment_date')]); ?></td>
											<?
											if ($receive_basis == 1) {
												$req_qnty = $booking_qnty_array[$row[csf('id')]];
												$production_balance = $req_qnty - $recv_qnty_array[$row[csf('id')]];
												echo '<td width="80" align="right">' . number_format($req_qnty, 2, '.', '') . '</td>';
											} else {
												$production_balance = '';
												$req_qnty = '';
											}
											?>
											<td width="80" align="right"><? echo number_format($recv_qnty_array[$row[csf('id')]], 2, '.', ''); ?></td>
											<td width="80" align="right"><? echo number_format($production_balance, 2, '.', ''); ?></td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" <? echo $disable; ?> placeholder="<? if ($receive_basis == 1 && $roll_maintained == 0) echo number_format($production_balance, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
											</td>
											<td align="center" width="80">
												<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($receive_basis == 1 && $roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();" <? echo $disable_td; ?> >
											</td>
											<td align="center" width="60">
												<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? //echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?>>
											</td>
											<td width="80" align="center">
												<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="calculate_tot_qnty();">
											</td>
											<?
											if ($roll_maintained == 1)
											{
												?>
												<td align="center" width="60">
													<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?> placeholder="<? //echo $roll_arr[$row[csf('id')]]+1; ?>" onBlur="roll_duplication_check(<? echo $i; ?>);" readonly/>
												</td>
												<td width="70">
													<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:55px" value="" disabled/>
												</td>
												<td width="70">
													<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>"  class="text_boxes" style="width:55px" value="" />
												</td>
												<td width="65">
													<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
													<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
												</td>
												<?
											}
											?>
										</tr>
										<?
										$i++;
									}
								}
							}
						?>
						<input type="hidden" name="tot_po_qnty" id="tot_po_qnty" class="text_boxes" value="<? echo $tot_po_qnty; ?>">
						<input type="hidden" name="txt_tot_row" id="txt_tot_row" class="text_boxes" value="<? echo $i - 1; ?>">
					</table>
					</div>
					<table width="<? echo $width + 220; ?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="tbl_bottom">
						<tr>
							<td width="110"></td>
							<td width="60"></td>
							<td width="80"></td>
							<td width="80"></td>
	
							<?
							if ($receive_basis == 1 || $receive_basis == 2)
							{
								echo '<td width="80"></td>';
							}
							?>
							<td width="80" align="right"><b>Total</b></td>
							<td style="text-align:center" width="80"><input type="text" name="txt_tot_grey_qnty" id="txt_tot_grey_qnty" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_grey_qnty, 2); ?>" disabled></td>
							<td style="text-align:center" width="80"><input type="text" name="txt_tot_grey_qnty_pcs" id="txt_tot_grey_qnty_pcs" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_grey_qnty_pcs, 2); ?>" disabled></td>
							<td align="center" width="60"> </td>
							<td width="80" style="text-align:center"><input type="text" name="txt_tot_reject_qnty" id="txt_tot_reject_qnty" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_reject_qnty, 2); ?>" disabled >
							</td>
							<?
							if ($roll_maintained == 1) {
								//<td width="80"></td><td width="80"></td><td width="80"></td><td width="80">
								echo '<td width="60"></td><td width="70"></td><td width="70"></td><td width="65"></td>';
							}
							?>
						</tr>
					</table>
					<table width="<? echo $width; ?>">
						<tr>
							<td align="center">
								<input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="fnc_close();" style="width:100px"/>
							</td>
						</tr>
					</table>
				</div>
				<? 
				// echo "string.$is_salesOrder";die;
			}
			else // sample program
			{
				if ($receive_basis == 2)
				{
					$disabled = "";
					$disabled_dropdown = 0;
					if ($receive_basis == 0 || $roll_maintained == 1)
					{
						$prev_distribution_method = 2;
						$disabled = "disabled='disabled'";
						$disabled_dropdown = 1;
					
					}
					$width = 950;
					?>
					<div style="width:<? echo $width; ?>px; margin-top:5px;" align="center">
                        <table style="margin-bottom:5px;" class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="300" align="center">
                            <thead>
                                <th>Total QC Pass Qty.</th>
                                <th>Distribution Method</th>
                            </thead>
                            <tr class="general">
                                <td><input type="text" name="txt_prop_grey_qnty" id="txt_prop_grey_qnty"
                                    class="text_boxes_numeric" value="<? echo $txt_receive_qnty; ?>" style="width:120px" onBlur="distribute_qnty(document.getElementById('cbo_distribiution_method').value)" <? echo $disabled; ?> >
                                    <input type="hidden" name="over_production_percentage" id="over_production_percentage" value="<? echo $over_production_percentage;?>">
                                </td>
                                <td>
                                    <?
                                    echo create_drop_down("cbo_distribiution_method", 250, $distribiution_method, "", 0, "", $prev_distribution_method, "distribute_qnty(this.value);", $disabled_dropdown);
                                    ?>
                                </td>
                            </tr>
                        </table>
					</div>
                    <table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="<? echo $width; ?>">
                        <caption style="font-weight:bold;color:red;">Over Production Percentage: <? echo $over_production_percentage; ?>%</caption>
                        <thead>
                            <th width="130">Program No</th>
                            <th width="80">Program Qty.</th>
                            <th width="80">Cumulative Production Qty.</th>
                            <th width="80">Balance Qty</th>
                            <th width="80">QC Pass Qty</th>
                            <th width="80">Qty. In Pcs</th>
                            <th width="80">Size</th>
                            <th width="80">Reject Qty.</th>
                            <th width="80">Roll</th>
                            <th width="100">Barcode No.</th>
                            <th></th>
                        </thead>
                    </table>
                    <div style="width:<? echo $width+20; ?>px; max-height:200px; overflow-y:scroll" id="list_container" align="left">
                    	<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="<? echo $width; ?>" id="tbl_list_search">
							<?php
							//for yarn issue check
							if ($production_control == 1)
							{
								$yarn_balance_qty_arr = array();
								if ($dtls_id == "")
									$dtls_id_cond2 = "";
								else
									$dtls_id_cond2 = "and dtls_id<>$dtls_id";

								/*
								|--------------------------------------------------------------------------
								| for yarn issue
								|--------------------------------------------------------------------------
								|
								*/
								$yarn_issue_sql = sql_select("select (b.cons_quantity) as issue_qnty, c.id as issue_id 
								from ppl_yarn_requisition_entry a, inv_transaction b, inv_issue_master c 
								where a.requisition_no= b.requisition_no and b.item_category =1 and b.transaction_type =2 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted =0 and b.company_id = $cbo_company_id and  a.knit_id=$booking_id and b.mst_id = c.id and c.entry_form =3 and c.issue_basis in (3,8) and b.receive_basis in (3,8)");
								$yarn_issue_qnty=0;
								$yarn_issue_return_qnty =0;
								foreach ($yarn_issue_sql as $val)
								{
									$yarn_issue_qnty_arr += $val[csf("issue_qnty")];
									//$yarn_balance_qty_arr += $val[csf("issue_qnty")];
									$yarn_issue_id_arr[$val[csf("issue_id")]] = $val[csf("issue_id")];
								}
						
								if($yarn_issue_id_arr>0)
								{
									$yarn_issue_ids = implode(",", $yarn_issue_id_arr);
									$all_yarn_issue_cond="";
									$barCond="";
									if($db_type==2 && count($yarn_issue_id_arr)>999)
									{
										$yarn_issue_id_arr_chunk=array_chunk($yarn_issue_id_arr,999) ;
										foreach($yarn_issue_id_arr_chunk as $chunk_arr)
										{
											$chunk_arr_value=implode(",",$chunk_arr);
											$issCond.="  a.issue_id in($chunk_arr_value) or ";
										}
										$all_yarn_issue_cond.=" and (".chop($issCond,'or ').")";
									}
									else
									{
										$all_yarn_issue_cond=" and a.issue_id in($yarn_issue_ids)";
									}
						
									/*
									|--------------------------------------------------------------------------
									| for yarn issue return
									|--------------------------------------------------------------------------
									|
									*/
									$yarn_issue_return_sql = sql_select("select b.cons_quantity as quantity
									from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c 
									where a.id = b.mst_id and a.entry_form =  9 and a.receive_basis = 3 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_id = c.requisition_no and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.status_active=1 and c.status_active=1
									union all
									select b.cons_quantity as quantity 
									from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c 
									where a.id=b.mst_id and a.entry_form =9 and a.receive_basis =8 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_no=c.requisition_no and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.status_active=1 and c.status_active=1");
						
									foreach ($yarn_issue_return_sql as $val)
									{
										//$yarn_balance_qty_arr -= $val[csf("quantity")];
										$yarn_issue_return_qnty_arr += $val[csf("quantity")];
									}
								}
							}

                            $i = 0;
                            $tot_po_qnty = 0;
                            $tot_grey_qnty = 0;
                            $tot_grey_qnty_pcs = 0;
                            $tot_reject_qnty = 0;
                            $po_array = array();
                            
                            $orginal_val = 1;
                            $roll_id = 0;
                            $roll_not_delete_id = 0;
                            $disable = "";

                            /*
							|--------------------------------------------------------------------------
							| for program qty
							|--------------------------------------------------------------------------
							|
							*/
							$programSql = "
                                SELECT
                                    b.dtls_id as program_id, sum(b.program_qnty) as qnty, c.id as booking_id 
                                FROM
                                    ppl_planning_info_entry_dtls a,
                                    ppl_planning_entry_plan_dtls b,
									wo_non_ord_samp_booking_mst c
									
                                WHERE
                                    a.id=b.dtls_id
									AND b.booking_no=c.booking_no 
                                    AND b.dtls_id='".$booking_no."' 
                                    AND b.determination_id='".$fabric_desc_id."' 
                                    AND b.body_part_id='".$cbo_body_part."' 
                                    AND b.status_active=1 
                                    AND b.is_deleted=0
                                GROUP BY
                                    b.dtls_id, c.id
                            ";
                            // and b.gsm_weight='$txt_gsm' and a.fabric_dia='$txt_width'
                            //echo $programSql;
							$programArr = sql_select($programSql);
                            //echo "<pre>";
                            //print_r($programArr);
                            
                            $programIdArr = array();
							$sampleBookingId = 0;
                            foreach ($programArr as $row)
                            {
                                $sampleBookingId = $row[csf('booking_id')];
								$programIdArr[$row[csf('program_id')]] = $row[csf('program_id')];
                            }
                            $programIdString = implode(",", $programIdArr);
                            //echo $programIdString;
                            
                            /*
							|--------------------------------------------------------------------------
							| for production qty
							|--------------------------------------------------------------------------
							|
							*/
							$productionQtyArr = array();
                            if($programIdString != '')
                            {									
                                if($dtls_id!="")
                                    $dtls_id_cond = " AND a.id <> ".$dtls_id."";
                                    
                                $productionSql ="
                                    SELECT
                                        b.booking_id AS program_id, SUM(a.grey_receive_qnty) AS prod_quantity 
                                    FROM
                                        pro_grey_prod_entry_dtls a,
                                        inv_receive_master b 
                                    WHERE
                                        a.mst_id = b.id 
                                        AND b.entry_form = 2 
                                        AND b.booking_id IN (".$programIdString.") 
                                        AND a.febric_description_id = '".$fabric_desc_id."' 
                                        AND a.body_part_id='".$cbo_body_part."' 
                                        AND a.gsm='".$txt_gsm."' 
                                        AND a.status_active=1 
                                        AND b.status_active=1 
                                        ".$dtls_id_cond." 
                                    GROUP BY
                                        b.booking_id
                                ";
                                //echo $productionSql;
                                $productionSqlArr =sql_select($productionSql);
                                foreach ($productionSqlArr as $row)
                                {
                                    $productionQtyArr[$row[csf('program_id')]]['prod_quantity']=$row[csf('prod_quantity')];
                                }
                            }
                            
                            $programQty = $programArr[0][csf('qnty')];
                            $productionQty = 0;
                            if(!empty($productionQtyArr))
                            {
                                $productionQty = $productionQtyArr[$programArr[0][csf('program_id')]]['prod_quantity'];
                            }
                            //$productionBalance = $programQty - $productionQty;
							
							$req_qnty_with_over_perc = ($programQty*$over_production_percentage)/100 + $programQty;
							$production_over_balance = $req_qnty_with_over_perc - $productionQty;
							$yarn_issue_quantity = number_format($yarn_issue_qnty_arr,2,".","");
							$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
							$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr*1 - $productionQty;
							$productionBalance = number_format($yarn_over_balance,2,".","");
							
                            if($save_data_stylewise == "")
                            {
                                $i++;
                                ?>
                                <tr bgcolor="#FFFFFF" id="tr_1">
                                    <td width="130">
                                        <p><? echo $booking_no; ?></p>
                                        <input type="hidden" name="txtPoId[]" id="txtPoId_1" value="<? echo $sampleBookingId; ?>">
                                        <input type="hidden" name="txtOrginal[]" id="txtOrginal_1" value="<? echo $orginal_val; ?>">
                                        <input type="hidden" name="txtRollId[]" id="txtRollId_1" value="<? echo $roll_not_delete_id; ?>">
                                        <!--This is used for not delete row which is used in batch -->
                                        <input type="hidden" name="txtRollTableId[]" id="txtRollTableId_1" value="<? echo $roll_id; ?>">
                                        <!--This is used for Duplication Check -->
                                        <input type="hidden" name="balanceQty[]" id="balanceQty_1" value="<? echo number_format($productionBalance, 2, '.', '');//echo $balanceQty; ?>">
                                    </td>
                                    <td width="80" align="right"><? echo number_format($programQty, 2, '.', ''); ?></td>
                                    <td width="80" align="right"><? echo number_format($productionQty, 2, '.', ''); ?></td>
                                    <td width="80" align="right"><? echo number_format($productionBalance, 2, '.', ''); ?></td>
                                    <td align="center" width="80">
                                        <input type="text" name="txtGreyQnty[]" id="txtGreyQnty_1" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($productionBalance, 2, '.', ''); ?>" onKeyUp="fn_check_balance(1);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
                                    </td>
                                    <td align="center" width="80">
                                        <input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_1" class="text_boxes_numeric" style="width:60px" value="" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="calculate_tot_qnty();" <? echo $disable_td; ?>>
                                    </td>
                                    <td align="center" width="80">
                                        <input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:60px" value="<? echo $size_qty; ?>" <? echo $disable_td; ?>  placeholder="B/W" onDblClick="func_onDblClick_finishSize(<? echo $i; ?>);" />
                                    </td>
                                    <td align="center" width="80">
                                        <input type="text" name="txtRejectQnty[]" id="txtRejectQnty_1" class="text_boxes_numeric" style="width:60px" value="" onKeyUp="calculate_tot_qnty();">
                                    </td>
                                    <td align="center" width="80">
                                        <input type="text" name="txtRoll[]" id="txtRoll_1" class="text_boxes_numeric" style="width:60px" value="" readonly/>
                                    </td>
                                    <td width="100" align="center">
                                    <input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_1" class="text_boxes_numeric" style="width:80px" value="" disabled/>
                                    </td>
                                    <td>
                                        <input type="button" id="increase_1" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr(1)"/>
                                        <input type="button" id="decrease_1" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(1);"/>
                                    </td>
                                </tr>
                                <?
                            }
                            else
							{
								$explSaveData = explode(",", $save_data_stylewise);
								for ($z = 0; $z < count($explSaveData); $z++)
								{
									$po_wise_data = explode("**", $explSaveData[$z]);
									$roll_ids[$po_wise_data[5]] = $po_wise_data[5];
								}
								$roll_ids = implode(',',array_keys($roll_ids));
		
								if($roll_ids!="")
								{
									$sqlroll = sql_select("select barcode_no,roll_used from pro_roll_details where status_active=1 and is_deleted=0 and id in(".$roll_ids.")");
									foreach ($sqlroll as $row)
									{
										$rollData[$row[csf("barcode_no")]]['roll_used'] = $row[csf("roll_used")];
									}
								}
		
								for ($z = 0; $z < count($explSaveData); $z++) 
								{
									$i++;
		
									if ($i % 2 == 0)
										$bgcolor = "#E9F3FF";
									else
										$bgcolor = "#FFFFFF";
		
									$po_wise_data = explode("**", $explSaveData[$z]);
									$order_id = $po_wise_data[0];
									$grey_qnty = $po_wise_data[1];
									$reject_qnty = $po_wise_data[2];
									$roll_no = $po_wise_data[3];
									$roll_not_delete_id = $po_wise_data[4];
									$roll_id = $po_wise_data[5];
									$barcode_no = $po_wise_data[6];
									$grey_qnty_pcs = $po_wise_data[7];
									$r_floor_id = $po_wise_data[10];
									$r_room_id = $po_wise_data[11];
									$r_rack_id = $po_wise_data[12];
									$r_self_id = $po_wise_data[12];
		
									$bl_qnty = $req_qnty - $recv_qnty;
									$size_data=$po_wise_data[8];
		
									$roll_used = $rollData[$barcode_no]['roll_used'];//return_field_value("roll_used", "pro_roll_details", "id='$roll_id'");
		
									if ($roll_used == 1)
									{
										$orginal_val = 1;
										$disable = "disabled='disabled'";
									}
									else
									{
										$disable = "";
										$roll_not_delete_id = 0;
										$orginal_val = 0;
									}
		
									$tot_grey_qnty += $grey_qnty;
									$tot_grey_qnty_pcs += $grey_qnty_pcs;
									$tot_reject_qnty += $reject_qnty;
									$balanceQty = 0;
									//$productionBalance = $grey_qnty - $productionQty;

									$yarn_issue_quantity = number_format($yarn_issue_qnty_arr,2,".","");
									$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
									$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr - $grey_qnty;
									$productionBalance = number_format($yarn_over_balance,2,".","");
									?>
									<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
										<td width="130">
											<p><? echo $booking_no; ?></p>
											<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $sampleBookingId; ?>">
											<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
											<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
											<!--This is used for not delete row which is used in batch -->
											<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
											<!--This is used for Duplication Check -->
											<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo number_format($productionBalance, 2, '.', ''); ?>">
										</td>
										<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>
										<td width="80" align="right"><input type="text" name="txtGreyQntyCumulative[]" id="txtGreyQntyCumulative_<? echo $i; ?>" class="text_boxes_numeric" style="width:70px;" value="<? echo number_format($productionQty,2,'.',''); ?>" <? echo $disable; ?> disabled></td>
										<td width="80" align="right"><? echo number_format($productionBalance, 2, '.', ''); ?></td>
										<td align="center" width="80">
											<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i;?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
										</td>
										<td align="center" width="80">
											<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="calculate_tot_qnty();">
										</td>
										<td align="center" width="80">
											<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes"  style="width:60px" value="<? echo $size_data; ?>" <? echo $disable_td; ?>  placeholder="B/W" onDblClick="func_onDblClick_finishSize(<? echo $i; ?>);" />
										</td>
										<td align="center" width="80">
											<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>" <? echo $disable; ?> onKeyUp="calculate_tot_qnty();">
										</td>
										<td align="center" width="80">
											<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?> readonly/>
										</td>
										<td width="100" align="center"><input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:80px" value="<? echo $barcode_no; ?>" disabled/></td>
                                        <td>
                                            <input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
                                            <input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
                                        </td>
                                    </tr>
                                    <?
                                }
                            }
                            ?>
                            <input type="hidden" name="tot_po_qnty" id="tot_po_qnty" class="text_boxes" value="<? echo $tot_po_qnty; ?>">
                            <input type="hidden" name="txt_tot_row" id="txt_tot_row" class="text_boxes" value="<? echo $i - 1; ?>">
                        </table>
                    </div>
                    <table width="<? echo $width; ?>" border="1" cellpadding="0" cellspacing="0" rules="all" class="tbl_bottom">
                        <tr>
                            <td width="130"></td>
                            <td width="80"></td>
                            <td width="80"></td>
                            <td width="80" align="right"><b>Total</b></td>
                            <td style="text-align:center" width="80"><input type="text" name="txt_tot_grey_qnty" id="txt_tot_grey_qnty" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_grey_qnty, 2); ?>" disabled></td>
                            <td style="text-align:center" width="80"><input type="text" name="txt_tot_grey_qnty_pcs" id="txt_tot_grey_qnty_pcs" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_grey_qnty_pcs, 2); ?>" disabled></td>
                            <td align="center" width="80"> </td>
                            <td width="80" style="text-align:center"><input type="text" name="txt_tot_reject_qnty" id="txt_tot_reject_qnty" class="text_boxes_numeric" style="width:60px" value="<? echo number_format($tot_reject_qnty, 2); ?>" disabled >
                            </td>
                            <?
                            if ($roll_maintained == 1) {
                                //<td width="80"></td><td width="80"></td><td width="80"></td><td width="80">
                                echo '<td width="80"></td><td width="100"></td><td></td>';
                            }
                            ?>
                        </tr>
                    </table>
                    <table width="<? echo $width; ?>">
                        <tr>
                            <td align="center">
                                <input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="fnc_close();" style="width:100px"/>
                            </td>
                        </tr>
                    </table>
					</div>
					<?
				}
			}
		}
	}
	if ($type != 1)
	{
		?>
		</fieldset>
		</form>
		<?
	}
		?>
	</body>
	<script src="../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}


if($action == 'action_finishSize')
{
	echo load_html_head_contents("Finish Size", "../../", 1, 1, '', '', '');
	extract($_REQUEST);
	?>
	<script>
		var selected_id = new Array;

		function js_set_value(str)
		{
			//alert('size popup='+str);
			$('#hdn_item_size').val(str);
			parent.emailwindow.hide();
		}
	</script>
	</head>
	<body>
    <input type="hidden" id="hdn_item_size" name="hdn_item_size" />
    <div style="margin-top:15px" id="search_div"></div>
	</body>
	<script>
        show_list_view ('<? echo $program_no; ?>'+'**'+'<? echo $rowNo; ?>', 'action_finishSize_listview', 'search_div', 'grey_production_entry_controller_v2', 'setFilterGrid(\'tbl_list_search\',-1)');
    </script>	
    <script src="../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
	<?
	exit();
}

//action_create_season_listview
if ($action == "action_finishSize_listview")
{
	//print_r($data);
	$data = explode('**', $data);
	$sql="SELECT a.id, a.collar_cuff_data as item_size FROM ppl_planning_info_entry_dtls a WHERE a.id in(".$data[0].") and a.status_active=1 and a.is_deleted=0 group by a.id, a.collar_cuff_data";
	$item_size_data=sql_select($sql);
	foreach ($item_size_data as $key => $value) 
	{
		$item_size=$value[csf('item_size')];
		$item_size_arr=explode(',', $item_size);
		/*echo "<pre>";
		print_r($item_size_arr);*/
	}
	foreach ($item_size_arr as $key => $row) 
	{
		$item_size_count=explode('_', $row);
		if(count($item_size_count[2]) == 0 )
		{
			echo "Data not found";die;
		}
	}
	//echo create_list_view("tbl_list_search", "Item Size", "150", "250", "350", 0, $sql, "js_set_value", "item_size", "", 1, "0", $arr, "item_size", "", '', '0', '', 0);

	?>
	<div align="center">
		<table cellspacing="0" cellpadding="0" border="1" rules="all" width="200" class="rpt_table">
			<thead>
				<th width="40">SL</th>
				<th>Item Size</th>
			</thead>
		</table>
		<div style="width:200px; overflow-y:scroll; max-height:240px;" id="buyer_list_view" align="center">
			<table cellspacing="0" cellpadding="0" border="1" rules="all" width="180" class="rpt_table"
			id="tbl_list_search">
			<?
			$i = 1;
			foreach ($item_size_arr as $row) 
			{
				if ($i % 2 == 0)
					$bgcolor = "#E9F3FF";
				else
					$bgcolor = "#FFFFFF";
				$item_size_arr2=explode('_', $row);
				//echo $item_size_arr2[2].'<br>';
				?>
				<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
					id="search<? echo $i; ?>" onClick="js_set_value('<? echo $item_size_arr2[2].'__'.$data[1]; ?>')">
					<td width="40" align="center"><? echo $i; ?></td>
					<td width=""><p><? echo $item_size_arr2[2]; ?></p></td>
				</tr>
				<?
				$i++;
			}
			?>
			</table>
		</div>
	</div>
	<?
	exit();
}

		if ($action == "create_po_search_list_view") {
			$data = explode("_", $data);

			$search_string = "%" . trim($data[0]) . "%";
			$search_by = $data[1];
			//echo $data[5];
			if ($search_by == 1)
				$search_field = 'b.po_number';
			else if ($search_by == 3)
				$search_field = 'b.grouping';
			else if ($search_by == 4)
				$search_field = 'b.file_no';
			else
				$search_field = 'a.job_no';

			$company_id = $data[2];
			$buyer_id = $data[3];

			$all_po_id = $data[4];

			if ($all_po_id != "")
				$po_id_cond = " or b.id in($all_po_id)";
			else
				$po_id_cond = "";

			$hidden_po_id = explode(",", $all_po_id);

			if ($buyer_id == 0) {
				echo "Please Select Buyer First.";
				die;
			}

			$sql = "select a.job_no, a.style_ref_no, a.order_uom, b.id, b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping, b.file_no from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.company_name=$company_id and a.buyer_name=$buyer_id and $search_field like '$search_string' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";

			?>
			<div align="center">
				<table cellspacing="0" cellpadding="0" border="1" rules="all" width="800" class="rpt_table">
					<thead>
						<th width="40">SL</th>
						<th width="100">Job No</th>
						<th width="110">Style No</th>
						<th width="110">PO No</th>
						<th width="90">Internal Ref.</th>
						<th width="90">File No</th>
						<th width="90">PO Quantity</th>
						<th width="50">UOM</th>
						<th>Shipment Date</th>
					</thead>
				</table>
				<div style="width:800px; overflow-y:scroll; max-height:240px;" id="buyer_list_view" align="center">
					<table cellspacing="0" cellpadding="0" border="1" rules="all" width="780" class="rpt_table"
					id="tbl_list_search">
					<?
					$i = 1;
					$po_row_id = '';
					$nameArray = sql_select($sql);
					foreach ($nameArray as $selectResult) {
						if ($i % 2 == 0)
							$bgcolor = "#E9F3FF";
						else
							$bgcolor = "#FFFFFF";

						$roll_used = 0;

						if (in_array($selectResult[csf('id')], $hidden_po_id)) {
							if ($po_row_id == "") $po_row_id = $i; else $po_row_id .= "," . $i;

							$roll_data_array = sql_select("select roll_no from pro_roll_details where po_breakdown_id=" . $selectResult[csf('id')] . " and roll_used=1 and entry_form=2 and status_active=1 and is_deleted=0");
							if (count($roll_data_array) > 0) {
								$roll_used = 1;
							} else
							$roll_used = 0;
						}

						?>
						<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
							id="search<? echo $i; ?>" onClick="js_set_value(<? echo $i; ?>,1)">
							<td width="40" align="center">
								<? echo $i; ?>
								<input type="hidden" name="txt_individual_id" id="txt_individual_id<? echo $i ?>"
								value="<? echo $selectResult[csf('id')]; ?>"/>
								<input type="hidden" name="roll_used" id="roll_used<? echo $i ?>"
								value="<? echo $roll_used; ?>"/>
							</td>
							<td width="100"><p><? echo $selectResult[csf('job_no')]; ?></p></td>
							<td width="110"><p><? echo $selectResult[csf('style_ref_no')]; ?></p></td>
							<td width="110"><p><? echo $selectResult[csf('po_number')]; ?></p></td>
							<td width="90"><p><? echo $selectResult[csf('grouping')]; ?>&nbsp;</p></td>
							<td width="90"><p><? echo $selectResult[csf('file_no')]; ?>&nbsp;</p></td>
							<td width="90" align="right"><? echo $selectResult[csf('po_qnty_in_pcs')]; ?></td>
							<td width="50" align="center">
								<p><? echo $unit_of_measurement[$selectResult[csf('order_uom')]]; ?></p></td>
								<td align="center"><? echo change_date_format($selectResult[csf('pub_shipment_date')]); ?></td>
							</tr>
							<?
							$i++;
						}
						?>
						<input type="hidden" name="txt_po_row_id" id="txt_po_row_id" value="<? echo $po_row_id; ?>"/>
					</table>
				</div>
				<table width="620" cellspacing="0" cellpadding="0" style="border:none" align="center">
					<tr>
						<td align="center" height="30" valign="bottom">
							<div style="width:100%">
								<div style="width:50%; float:left" align="left">
									<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()"/> Check /
									Uncheck All
								</div>
								<div style="width:50%; float:left" align="left">
									<input type="button" name="close" onClick="show_grey_prod_recv();" class="formbutton"
									value="Close" style="width:100px"/>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>
			<?

			exit();
		}
		if($action == "check_production_qnty")
		{
			$data = explode("_", $data);
			if ($data[2] == 0) {
				$data[1] = 0;
			}
			if ($data[2] == 1) {
				if ($data[1] == 1) {
					$sql_prev_production = "select sum(b.grey_receive_qnty) as grey_receive_qnty from inv_receive_master a,  pro_grey_prod_entry_dtls b where a.id=b.mst_id and a.booking_without_order=1 and booking_id=" . $data[0] . " and a.receive_basis=1 and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
					$bookingData = sql_select("select sum(b.grey_fabric) as qnty from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.booking_type in(1,4) and a.id=" . $data[0] . " and b.fabric_source=1 and a.status_active=1  and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

				} else {
					$sql_prev_production = "select sum(b.grey_receive_qnty) as grey_receive_qnty from inv_receive_master a,  pro_grey_prod_entry_dtls b where a.id=b.mst_id and a.booking_without_order=0 and booking_id=" . $data[1] . " and a.receive_basis=1 and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 ";
					$bookingData = sql_select("select sum(b.grey_fab_qnty) as qnty from  wo_booking_mst a, wo_booking_dtls b
						where a.booking_no=b.booking_no and a.booking_type=1 and a.id=" . $data[0] . " and a.status_active=1  and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
				}
				$current_production = "select b.id, sum(b.grey_receive_qnty) as grey_receive_qnty from inv_receive_master a,  pro_grey_prod_entry_dtls b where a.id=b.mst_id and booking_id=" . $data[0] . "  and b.id =" . $data[5] . " and a.receive_basis=2 and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.id;";

				$prev_production_data = sql_select($sql_prev_production);
				$current_production_data = sql_select($current_production);
				$previous_grey_receive_qnty = $prev_production_data[0][csf("grey_receive_qnty")];
				$current_grey_receive_qnty = $current_production_data[0][csf("grey_receive_qnty")];
				$required_qnty = $bookingData[0][csf("qnty")];
			} else if ($data[2] == 2) {
				$dtls_cond = ($data[4]!=0)?"  and b.id !=$data[5]":"";
				$sql_prev_production = "select sum(b.grey_receive_qnty) as grey_receive_qnty from inv_receive_master a,  pro_grey_prod_entry_dtls b where a.id=b.mst_id and booking_id=" . $data[0] . "  $dtls_cond and a.receive_basis=2 and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
				$prev_production_data = sql_select($sql_prev_production);
				$current_production = "select sum(b.grey_receive_qnty) as grey_receive_qnty from inv_receive_master a,  pro_grey_prod_entry_dtls b where a.id=b.mst_id and booking_id=" . $data[0] . "  and b.id =" . $data[5] . " and a.receive_basis=2 and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";

				$current_production_data = sql_select($current_production);

				$program_qnty_array = sql_select("select sum(a.program_qnty) as qnty from ppl_planning_info_entry_dtls a where a.id=" . $data[0] . " and a.status_active=1 and a.is_deleted=0");

				$previous_grey_receive_qnty = $prev_production_data[0][csf("grey_receive_qnty")];
				$current_grey_receive_qnty = $current_production_data[0][csf("grey_receive_qnty")];
				$required_qnty = $program_qnty_array[0][csf("qnty")];
			}
//echo $previous_grey_receive_qnty ."+". $current_grey_receive_qnty."-".$data[3]; die;
			if($data[4]==0){
				$tot_prod = $previous_grey_receive_qnty + $data[3];
			}
			else if($data[4]==1){
				if($current_grey_receive_qnty-$data[3] > 0){
					$tot_prod = $previous_grey_receive_qnty + ($current_grey_receive_qnty-$data[3]);
				}else{
					$tot_prod = $previous_grey_receive_qnty + $data[3];
				}

			}

			if ($tot_prod > $required_qnty) {
				echo "1**".$tot_prod."**".$previous_grey_receive_qnty."**".$required_qnty;
			}else{
				echo "0**".$tot_prod."**".$previous_grey_receive_qnty."**".$required_qnty;
			}
			exit;
		}

if ($action == "save_update_delete")
{	//echo "10**";die;
	$process = array(&$_POST);
	extract(check_magic_quote_gpc($process));
	$con = connect();
	$brand_arr = return_library_array("select id, brand_name from lib_brand where status_active=1", 'id', 'brand_name');
	$fabricLibraryData = sql_select("select auto_update from variable_settings_production where company_name =$cbo_company_id and variable_list in(15) and item_category_id=13 and is_deleted=0 and status_active=1");
	$fabric_store_auto_update=$fabricLibraryData[0][csf("auto_update")];
	//INV_REFERENCE_CLOSING
	
	$receive_basis=str_replace("'", "", $cbo_receive_basis);
	if($receive_basis==2)
	{
		$prog_no_id=str_replace("'", "", $txt_booking_no_id);
		//$sql_ref="select inv_pur_req_mst_id from inv_reference_closing where inv_pur_req_mst_id=$txt_booking_no_id and  reference_type==2";
		$sql_ref="select ref_closing_status,id as prog_no from ppl_planning_info_entry_dtls where id=$prog_no_id  and status_active=1";
		$prod_result=sql_select($sql_ref,1);
		$ref_closing_status=$prod_result[0][csf('ref_closing_status')];
		if($ref_closing_status==1)
		{
			echo "23**This Prog No is closed";
			disconnect($con);
			die;
		}
	}
	//echo "10**";die;
	//====----Ref Closeing End==============
	$vari_knit_charge_source_arr = sql_select("select editable from variable_order_tracking where company_name='$cbo_company_id' and variable_list=70 and status_active=1");
	if($vari_knit_charge_source_arr[0][csf("editable")] == 2)
	{
		$vari_knit_charge_source = $vari_knit_charge_source_arr[0][csf("editable")];
	}
	else
	{
		$vari_knit_charge_source = 1;
	}
	
	/*
	| if production basis is knitting plan and
	| over production variable settings is no then
	| production qty can not greater then program qty
	| 
	| if production qty equal to program qty then
	| program status will be closed
	*/
	$is_status_closed = 0;
	if(str_replace("'", "", $cbo_receive_basis) == 2)
	{
		$up_cond="";
		if (str_replace("'", "", $update_id) != "")
		{
			$up_cond = " and a.id != ".$update_id;
		}
		
		$sql_prev_production = sql_select("select sum(b.grey_receive_qnty) as grey_receive_qnty from inv_receive_master a,  pro_grey_prod_entry_dtls b where a.id=b.mst_id and booking_id=$txt_booking_no_id and a.receive_basis=2 and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $up_cond");
		$sql_prev_production[0][csf("grey_receive_qnty")];

		$program_qnty_array = sql_select("select sum(a.program_qnty) as qnty,location_id from ppl_planning_info_entry_dtls a where a.id=$txt_booking_no_id  and a.status_active=1 and a.is_deleted=0 group by location_id");
		$program_qnty_array[0][csf("qnty")];
		
		if(($sql_prev_production[0][csf("grey_receive_qnty")] + str_replace("'", "", $txt_receive_qnty)) >= $program_qnty_array[0][csf("qnty")])
		{
			$is_status_closed = 1;
		}
	}
	//end

	/* $over_production_variable_sql = sql_select("select auto_update from variable_settings_production where company_name =$cbo_company_id and variable_list in(51) and item_category_id=1 and is_deleted=0 and status_active=1");
	$over_production_variable =  $over_production_variable_sql[0][csf("auto_update")]; */

	$over_production_variable_sql = sql_select("select auto_update, distribute_qnty from variable_settings_production where company_name =$cbo_company_id and variable_list in(35) and item_category_id=13 and is_deleted=0 and status_active=1");
	$over_production_variable =  $over_production_variable_sql[0][csf("auto_update")];
	$over_production_percentage =  $over_production_variable_sql[0][csf("distribute_qnty")]*1;

	// echo "10**".$over_production_variable;die;
	//if ($over_production_variable ==2)
	//{
		if(str_replace("'", "", $cbo_receive_basis) == 2)
		{
			$program_qnty_with_over_perc = ($program_qnty_array[0][csf("qnty")]*$over_production_percentage)/100 + $program_qnty_array[0][csf("qnty")];
			if($over_production_percentage){
				$addi_msg = "\nwith over percentage =".$program_qnty_with_over_perc;
			}

			//if(($sql_prev_production[0][csf("grey_receive_qnty")] + str_replace("'", "", $txt_receive_qnty)) > $program_qnty_array[0][csf("qnty")])
			if(($sql_prev_production[0][csf("grey_receive_qnty")] + str_replace("'", "", $txt_receive_qnty)) > $program_qnty_with_over_perc)
			{
				echo "30**Production quantity cannot be greater than Program quantity \nPrevious production quantity= ".$sql_prev_production[0][csf("grey_receive_qnty")].".\nCurrent quantity= ".str_replace("'", "", $txt_receive_qnty)."\nProgram quantity= ".$program_qnty_array[0][csf("qnty")].$addi_msg;
				disconnect($con);
				die;
			}
		}
		else if (str_replace("'", "", $cbo_receive_basis) == 1)
		{
			$up_cond="";
			if (str_replace("'", "", $update_id) != "") {
				$up_cond = " and a.id != ".$update_id;
			}

			if(str_replace("'", "", $booking_without_order) == 1)
			{
				$booking_required_sql = sql_select("select sum(b.grey_fabric) as qnty,b.lib_yarn_count_deter_id,b.body_part from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=4  and b.fabric_source=1 and a.status_active=1  and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.booking_no = $txt_booking_no group by  b.lib_yarn_count_deter_id,b.body_part");

				foreach ($booking_required_sql as $val)
				{
					$booking_required_arr[$val[csf("body_part")]][$val[csf("lib_yarn_count_deter_id")]] += $val[csf("qnty")];
				}

				$sql_prev_production = sql_select("select sum(b.grey_receive_qnty) as grey_receive_qnty from inv_receive_master a,  pro_grey_prod_entry_dtls b where a.id=b.mst_id and a.booking_without_order=1 and booking_id=$txt_booking_no_id and a.receive_basis=1 and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $up_cond");
			}
			else
			{

				$booking_required_sql = sql_select("select a.body_part_id , b.booking_no, a.lib_yarn_count_deter_id, sum(b.grey_fab_qnty) as grey_fab_qnty
					from wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b
					where a.job_no=b.job_no and a.status_active=1 and a.is_deleted=0  and b.status_active = 1 and b.is_deleted = 0 and b.pre_cost_fabric_cost_dtls_id = a.id and b.booking_type =1 and b.booking_no = $txt_booking_no
					group by a.body_part_id , b.booking_no, a.lib_yarn_count_deter_id
					union all
					select b.body_part_id , c.booking_no, b.lib_yarn_count_deter_id, sum(c.grey_fab_qnty) as grey_fab_qnty
					from wo_pre_cost_fab_conv_cost_dtls a, wo_pre_cost_fabric_cost_dtls b, wo_booking_dtls c
					where b.job_no=c.job_no and a.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.pre_cost_fabric_cost_dtls_id = a.id  and a.fabric_description = b.id and c.booking_type = 4 and c.booking_no = $txt_booking_no
					group by b.body_part_id , c.booking_no, b.lib_yarn_count_deter_id");
				foreach ($booking_required_sql as $val)
				{
					$booking_required_arr[$val[csf("body_part_id")]][$val[csf("lib_yarn_count_deter_id")]] += $val[csf("grey_fab_qnty")];
				}

				$sql_prev_production = sql_select("select sum(b.grey_receive_qnty) as grey_receive_qnty from inv_receive_master a,  pro_grey_prod_entry_dtls b where a.id=b.mst_id and a.booking_without_order=0 and booking_id=$txt_booking_no_id and a.receive_basis=1 and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 $up_cond");
			}

			$booking_required_qnty = $booking_required_arr[str_replace("'", "", $cbo_body_part)][str_replace("'", "", $fabric_desc_id)];

			$booking_qnty_with_over_perc = ($booking_required_qnty*$over_production_percentage)/100 + $booking_required_qnty;
			if($over_production_percentage){
				$addi_msg = "\nwith over percentage =".$booking_qnty_with_over_perc;
			}

			//if(($sql_prev_production[0][csf("grey_receive_qnty")] + str_replace("'", "", $txt_receive_qnty)) > $booking_required_qnty)
			if(($sql_prev_production[0][csf("grey_receive_qnty")] + str_replace("'", "", $txt_receive_qnty)) > $booking_qnty_with_over_perc)
			{
				echo "30**Booking quantity cannot be greater than production quantity \nPrevious production quantity= ".$sql_prev_production[0][csf("grey_receive_qnty")]."\nCurrent quantity= ".str_replace("'", "", $txt_receive_qnty)."\nBooking quantity= ".$booking_required_qnty.$addi_msg;
				disconnect($con);
				die;
			}

		}
	//}

	$txt_rack 			= str_replace("'", "", $txt_rack);
	$txt_shelf 			= str_replace("'", "", $txt_shelf);
	$cbo_room 			= str_replace("'", "", $cbo_room);
	$cbo_floor 			= str_replace("'", "", $cbo_floor);

	if($txt_rack==""){$txt_rack=0;}
	if($txt_shelf==""){$txt_shelf=0;}
	if($cbo_room==""){$cbo_room=0;}
	if($cbo_floor==""){$cbo_floor=0;}

	if ($operation == 0)  // Insert Here
	{
		if ($db_type == 0) {
			mysql_query("BEGIN");
		}
		$receive_basis = str_replace("'", "", $cbo_receive_basis);
		$booking_without_order = str_replace("'", "", $booking_without_order);
		$booking_no_id = str_replace("'", "", $txt_booking_no_id);
		$receive_qnty = str_replace("'", "", $txt_receive_qnty);
		if ($receive_basis == 0) {
			$booking_without_order = 0;
		}

		$grey_recv_num = '';
		$grey_update_id = '';
		$flag = 1;

		//Knitting Plan
		if(str_replace("'", "", $cbo_receive_basis) == 2)
		{
			if(str_replace("'", "", $booking_without_order) == 0)
			{
				$currency_ref = sql_select("select c.currency_id from  ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, wo_booking_mst c where b.id = $txt_booking_no_id and a.id =b.mst_id and a.booking_no = c.booking_no and b.status_active =1 and a.status_active =1");
			}
			else
			{
				$currency_ref = sql_select("select c.currency_id from  ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b, wo_non_ord_samp_booking_mst c where b.id = $txt_booking_no_id and a.id =b.mst_id and a.booking_no = c.booking_no and b.status_active =1 and a.status_active =1");
			}
			$currency_ref_id = $currency_ref[0][csf("currency_id")];
		}
		else if(str_replace("'", "", $cbo_receive_basis) == 1)
		{
			if(str_replace("'", "", $booking_without_order) == 0)
			{
				$currency_ref = sql_select("select currency_id from wo_booking_mst where id = $txt_booking_no_id ");
			}
			else
			{
				$currency_ref = sql_select("select currency_id from wo_non_ord_samp_booking_mst where id =$txt_booking_no_id");
			}
			$currency_ref_id = $currency_ref[0][csf("currency_id")];
		}
		else
		{
			$currency_ref_id = 2;
		}
		if($currency_ref_id!="")
		{
			$exchange_rate_ref = sql_select("select conversion_rate,max(con_date) con_date from currency_conversion_rate where con_date<=$txt_receive_date and currency=$currency_ref_id group by conversion_rate,con_date order by con_date desc");
		}
		else
		{
			$currency_ref_id = "";
		}

		if (str_replace("'", "", $update_id) == "")
		{

			$id = return_next_id_by_sequence("INV_RECEIVE_MASTER_PK_SEQ", "inv_receive_master", $con);
			//print_r($id); die;
			$new_grey_recv_system_id = explode("*", return_next_id_by_sequence("INV_RECEIVE_MASTER_PK_SEQ", "inv_receive_master",$con,1,$cbo_company_id,'GPE',2,date("Y",time()),13 ));
			//print_r($new_grey_recv_system_id); die;
			//echo "10**".$new_grey_recv_system_id[2]; die;

			$field_array = "id, recv_number_prefix, recv_number_prefix_num, recv_number, entry_form, item_category, receive_basis, company_id, receive_date, challan_no, booking_id, booking_no, booking_without_order, store_id, location_id, knitting_source, knitting_company,knitting_location_id, buyer_id, yarn_issue_challan_no, sub_contract, remarks, roll_maintained, within_group,service_booking_without_order,service_booking_no, exchange_rate, currency_id, inserted_by, insert_date";

			$data_array = "(" . $id . ",'" . $new_grey_recv_system_id[1] . "'," . $new_grey_recv_system_id[2] . ",'" . $new_grey_recv_system_id[0] . "',2,13," . $cbo_receive_basis . "," . $cbo_company_id . "," . $txt_receive_date . "," . $txt_receive_chal_no . "," . $txt_booking_no_id . "," . $txt_booking_no . "," . $booking_without_order . "," . $cbo_store_name . "," . $cbo_com_location_name . "," . $cbo_knitting_source . "," . $cbo_knitting_company . ",".$cbo_location_name."," . $cbo_buyer_name . "," . $txt_yarn_issue_challan_no . "," . $cbo_sub_contract . "," . $txt_remarks . "," . $roll_maintained . "," . $within_group . "," . $service_booking_without_order . "," . $txt_service_booking . ",'" .$exchange_rate_ref[0][csf('conversion_rate')]. "','" .$currency_ref_id . "'," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "')";

			$grey_recv_num = $new_grey_recv_system_id[0];
			$grey_update_id = $id;
		}
		else
		{
			$original_receive_basis = sql_select(" select receive_basis, booking_id from inv_receive_master where id=$update_id");
			if (str_replace("'", "", $cbo_receive_basis) != $original_receive_basis[0][csf('receive_basis')])
			{
				echo "30**Multiple Production Basis Not Allow In Same Production ID";
				disconnect($con);
				die;
			}
			else
			{
				if (str_replace("'", "", $cbo_receive_basis) == 1 || str_replace("'", "", $cbo_receive_basis) == 2 || str_replace("'", "", $cbo_receive_basis) == 4)
				{
					if (str_replace("'", "", $txt_booking_no_id) != $original_receive_basis[0][csf('booking_id')])
					{
						echo "30**Multiple F. Booking/Knit Plan Not Allow In Same Production ID";
						disconnect($con);
						die;
					}
				}
			}

			$field_array_update = "receive_basis*receive_date*challan_no*booking_id*booking_no*booking_without_order*store_id*knitting_location_id*knitting_source*knitting_company*buyer_id*yarn_issue_challan_no*sub_contract*remarks*within_group*service_booking_without_order*service_booking_no*updated_by*update_date";

			$data_array_update = $cbo_receive_basis . "*" . $txt_receive_date . "*" . $txt_receive_chal_no . "*" . $txt_booking_no_id . "*" . $txt_booking_no . "*" . $booking_without_order . "*" . $cbo_store_name . "*" . $cbo_location_name . "*" . $cbo_knitting_source . "*" . $cbo_knitting_company . "*" . $cbo_buyer_name . "*" . $txt_yarn_issue_challan_no . "*" . $cbo_sub_contract . "*" . $txt_remarks . "*" . $within_group . "*" . $service_booking_without_order . "*" . $txt_service_booking . "*" . $_SESSION['logic_erp']['user_id'] . "*'" . $pc_date_time . "'";

			$grey_recv_num = str_replace("'", "", $txt_recieved_id);
			$grey_update_id = str_replace("'", "", $update_id);
		}

		/*$brand_id = return_id($txt_brand, $brand_arr, "lib_brand", "id,brand_name");
		if ($brand_id == "")
			$brand_id = 0;*/

		if(str_replace("'","",$txt_brand)!="")
		{
			if (!in_array(str_replace("'","",$txt_brand),$new_array_brand))
			{
				$brand_id = return_id( str_replace("'","",$txt_brand), $brand_arr, "lib_brand", "id,brand_name","2");
				//echo $$txtColorName.'='.$color_id.'<br>';
				$new_array_brand[$brand_id]=str_replace("'","",$txt_brand);

			}
			else $brand_id =  array_search(str_replace("'","",$txt_brand), $new_array_brand);
		}
		else
		{
			$brand_id=0;
		}

		if (str_replace("'", "", $fabric_desc_id) == "")
			$fabric_desc_id = 0;

		if (str_replace("'", "", $cbo_receive_basis) == 2 && str_replace("'", "", $booking_without_order) == 1 && str_replace("'", "", $fabric_desc_id) == 0)
		{
			$fabric_description = trim(str_replace("'", "", $txt_fabric_description));
			$row_prod = sql_select("select id, current_stock, stock_value from product_details_master where company_id=$cbo_company_id and item_category_id=13 and detarmination_id=$fabric_desc_id and item_description='$fabric_description' and gsm=$txt_gsm and dia_width=$txt_width and status_active=1 and is_deleted=0");
		} else {
			$row_prod = sql_select("select id, current_stock, stock_value from product_details_master where company_id=$cbo_company_id and item_category_id=13 and detarmination_id=$fabric_desc_id and gsm=$txt_gsm and dia_width=$txt_width and status_active=1 and is_deleted=0");
		}

		// ******** Add For Accountce **************************************************

		$knitting_charge_data = explode("*", str_replace("'", "", $knitting_charge_string));
		$knitting_charge_taka = number_format($knitting_charge_data[0], 2, ".", "");
		$knitting_charge_usd = number_format($knitting_charge_data[1], 4, ".", "");
		$yarn_rate_taka = number_format($knitting_charge_data[2], 2, ".", "");
		$yarn_rate_usd = number_format($knitting_charge_data[3], 4, ".", "");
		//*********************************************************************************

		//Knitting charge validation with variable settings
		if($knitting_charge_taka <= 0 && str_replace("'", "", $process_costing_maintain) == 1 &&  $vari_knit_charge_source ==2)
		{
			echo "30**Knitting Charge Needed";
			disconnect($con);
			die;
		}


		if (count($row_prod) > 0)
		{
			$prod_id = $row_prod[0][csf('id')];
			if (str_replace("'", "", $fabric_store_auto_update) == 1)
			{
				$stock_qnty = $row_prod[0][csf('current_stock')];
				$stock_value = $row_prod[0][csf('stock_value')];
				$curr_stock_qnty = $stock_qnty + $receive_qnty;

				$curr_value = ($yarn_rate_taka + $knitting_charge_taka) * $receive_qnty;
				$curr_stock_value = $stock_value+ $curr_value;

				$avg_rate_per_unit = 0;
				if($curr_stock_qnty > 0)
				{
					$avg_rate_per_unit = $curr_stock_value/$curr_stock_qnty;
				}

				$field_array_prod_update = "store_id*avg_rate_per_unit*last_purchased_qnty*current_stock*stock_value*brand*lot*updated_by*update_date";

				$data_array_prod_update = $cbo_store_name . "*" . $avg_rate_per_unit . "*" . $receive_qnty . "*" . $curr_stock_qnty . "*" . $curr_stock_value . "*" . $brand_id . "*" . $txt_yarn_lot . "*" . $_SESSION['logic_erp']['user_id'] . "*'" . $pc_date_time . "'";
			}
		}
		else
		{
			$prod_id = return_next_id_by_sequence("PRODUCT_DETAILS_MASTER_PK_SEQ", "product_details_master", $con);

			if (str_replace("'", "", $fabric_store_auto_update) == 1) {
				$stock_qnty = $receive_qnty;
				$last_purchased_qnty = $receive_qnty;
				$avg_rate_per_unit = ($yarn_rate_taka + $knitting_charge_taka);
				$stock_value = ($yarn_rate_taka + $knitting_charge_taka) * $receive_qnty;
			} else {
				$stock_qnty = 0;
				$last_purchased_qnty = 0;
				$avg_rate_per_unit =0;
				$stock_value=0;
			}

			$prod_name_dtls = trim(str_replace("'", "", $txt_fabric_description)) . ", " . trim(str_replace("'", "", $txt_gsm)) . ", " . trim(str_replace("'", "", $txt_width));
			$field_array_prod = "id, company_id, store_id, item_category_id, detarmination_id, item_description, product_name_details, unit_of_measure, avg_rate_per_unit, last_purchased_qnty, current_stock, stock_value, brand, gsm, dia_width, lot, inserted_by, insert_date";

			$data_array_prod = "(" . $prod_id . "," . $cbo_company_id . "," . $cbo_store_name . ",13," . $fabric_desc_id . "," . $txt_fabric_description . ",'" . $prod_name_dtls . "'," . $cbo_uom . ",'" . $avg_rate_per_unit . "'," . $last_purchased_qnty . "," . $stock_qnty . "," . $stock_value . "," . $brand_id . "," . $txt_gsm . "," . $txt_width . "," . $txt_yarn_lot . "," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "')";
		}
		
		if (str_replace("'", "", $fabric_store_auto_update) == 1)
		{
			$id_trans = return_next_id_by_sequence("INV_TRANSACTION_PK_SEQ", "inv_transaction", $con);
			$order_rate=0;
			if($exchange_rate_ref[0][csf("conversion_rate")] > 0)
			{
				$order_rate = ($yarn_rate_taka + $knitting_charge_taka) / $exchange_rate_ref[0][csf("conversion_rate")];
			}
			$order_rate = number_format($order_rate,4,".","");

			$order_amount = $order_rate * $receive_qnty;
			$order_amount = number_format($order_amount,4,".","");

			$cons_rate = ($yarn_rate_taka + $knitting_charge_taka);
			$cons_rate = number_format($cons_rate,4,".","");

			$cons_amount = $cons_rate*$receive_qnty;
			$cons_amount = number_format($cons_amount,4,".","");

			//echo "10**($yarn_rate_taka + $knitting_charge_taka) , ex=".$exchange_rate_ref[0][csf("conversion_rate")];die;

			$field_array_trans = "id, mst_id, receive_basis, pi_wo_batch_no, booking_without_order, company_id, prod_id, item_category, transaction_type, transaction_date, store_id, brand_id, order_uom, order_qnty, order_rate, order_amount, cons_uom, cons_quantity, cons_reject_qnty, cons_rate, cons_amount, balance_qnty, balance_amount, floor_id, machine_id, room, rack, self,production_floor, inserted_by, insert_date";

			$data_array_trans = "(" . $id_trans . "," . $grey_update_id . "," . $cbo_receive_basis . "," . $txt_booking_no_id . "," . $booking_without_order . "," . $cbo_company_id . "," . $prod_id . ",13,1," . $txt_receive_date . "," . $cbo_store_name . "," . $brand_id . "," . $cbo_uom . "," . $receive_qnty . "," . $order_rate . "," . $order_amount . "," . $cbo_uom . "," . $receive_qnty . "," . $txt_reject_fabric_recv_qnty . "," . $cons_rate . "," . $cons_amount . "," . $receive_qnty . "," . $cons_amount . "," . $cbo_floor . "," . $cbo_machine_name . "," . $cbo_room . "," . $txt_rack . "," . $txt_shelf . "," . $cbo_floor_id . "," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "')";

		} else {
			$id_trans = 0;
			$cons_rate=0;
			$cons_amount=0;
		}

		$id_dtls = return_next_id_by_sequence("PRO_GREY_PROD_DTLS_PK_SEQ", "pro_grey_prod_entry_dtls", $con);

		$cbo_yarn_count = explode(",", str_replace("'", "", $cbo_yarn_count));
		asort($cbo_yarn_count);
		$cbo_yarn_count = implode(",", $cbo_yarn_count);

		$txt_yarn_lot = explode(",", str_replace("'", "", $txt_yarn_lot));
		//asort($txt_yarn_lot);
		$txt_yarn_lot = implode(",", $txt_yarn_lot);

		$yarn_prod_id = explode(",", str_replace("'", "", $yarn_prod_id));
		asort($yarn_prod_id);
		$yarn_prod_id = implode(",", $yarn_prod_id);
		$operator_name = str_replace("'", "", $txt_operator_id);
		$rate = $cons_rate;
		$amount = $cons_amount;


		$is_salesOrder = 0;
		if (str_replace("'", "", $cbo_receive_basis) == 4)
		{
			$is_salesOrder = 1;
		}
		else if (str_replace("'", "", $cbo_receive_basis) == 2)
		{
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=$txt_booking_no_id");
			if ($is_salesOrder == "")
				$is_salesOrder = 0;
		}
		if (str_replace("'", "", $cbo_receive_basis) == 2)
		{
			if ($is_salesOrder == 1) 
			{
				$po_sql = sql_select("select c.id, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b, fabric_sales_order_mst c where a.id=b.dtls_id and b.dtls_id=$txt_booking_no_id and b.status_active=1 and b.is_deleted=0 and b.po_id=c.id group by c.id");

				$program_recv_qnty_array = return_library_array("select d.id, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c, fabric_sales_order_mst d where a.id=b.mst_id and b.id=c.dtls_id and a.status_active=1 and a.entry_form=2  and a.receive_basis=2  and c.entry_form=2 and a.booking_no=$txt_booking_no_id and b.febric_description_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and c.po_breakdown_id=d.id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 group by d.id", "id", "recv_qnty");

			} 
			else if ($is_salesOrder == 2)
			{
				//Non order sample booking program
				$po_sql = sql_select("select c.id, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b, wo_non_ord_samp_booking_mst c where a.id=b.dtls_id and b.dtls_id=$txt_booking_no_id and b.status_active=1 and b.is_deleted=0 and b.booking_no=c.booking_no group by c.id");
				$program_recv_qnty_array = array();
			}
			else 
			{

				$po_sql = sql_select("select c.id, c.shipment_date, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b, wo_po_break_down c, wo_po_details_master d where a.id=b.dtls_id and b.po_id=c.id and c.job_id=d.id and b.dtls_id=$txt_booking_no_id and b.status_active=1 and b.is_deleted=0 group by c.id, c.shipment_date order by c.shipment_date asc");

				$program_recv_qnty_array = return_library_array("select d.id, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c, wo_po_break_down d, wo_po_details_master e where a.id=b.mst_id and b.id=c.dtls_id and c.po_breakdown_id=d.id and d.job_id=e.id and a.status_active=1 and a.entry_form=2 and a.receive_basis=2 and c.entry_form=2 and a.booking_no='$txt_booking_no_id' and b.status_active=1 and b.is_deleted=0 and c.status_active=1 group by d.id", "id", "recv_qnty");
			}

			foreach ($po_sql as $val) 
			{
				$all_po_id_arr[$val[csf("id")]] = $val[csf("id")];
			}

			/*if ($is_salesOrder != 2){
				//Non order program hoile all_po_id hisebe front end theke booking er id tai hobe
				$all_po_id = implode(",", $all_po_id_arr);
			} */
			$all_po_id = implode(",", $all_po_id_arr);

			if (str_replace("'", "", $roll_maintained) == 1) 
			{
				if (str_replace("'", "", $booking_without_order) == "")
				{
					$booking_without_order = 0;
				}
				if ($is_salesOrder == 1)
				{
					$roll_arr = return_library_array("select po_breakdown_id,max(roll_no) as roll_no from pro_roll_details where entry_form in(2,22,62)  and po_breakdown_id in (".str_replace("'","",$all_po_id).") and is_sales=$is_salesOrder group by po_breakdown_id", 'po_breakdown_id', 'roll_no');
				}
				else
				{
					$roll_arr = return_library_array("select po_breakdown_id,max(roll_no) as roll_no from pro_roll_details where entry_form in(2,22,62) and po_breakdown_id in (".str_replace("'","",$all_po_id).") and booking_without_order=$booking_without_order and is_sales=$is_salesOrder group by po_breakdown_id", 'po_breakdown_id', 'roll_no');
				}
			}
		}

		$field_array_dtls = "id, mst_id, trans_id, prod_id, body_part_id, febric_description_id, gsm, width, no_of_roll, order_id, grey_receive_qnty,grey_receive_qnty_pcs,coller_cuff_size, reject_fabric_receive, rate, amount, uom, yarn_lot, yarn_count, brand_id, shift_name, floor_id, machine_no_id, room, rack, self, store_floor, color_id, color_range_id, stitch_length,machine_dia,machine_gg,order_yarn_rate,order_knitting_charge,yarn_rate,kniting_charge, inserted_by, insert_date,operator_name,yarn_prod_id";

		$data_array_dtls = "(" . $id_dtls . "," . $grey_update_id . "," . $id_trans . "," . $prod_id . "," . $cbo_body_part . "," . $fabric_desc_id . "," . $txt_gsm . "," . $txt_width . "," . $txt_roll_no . ",'" . str_replace("'","",$all_po_id) . "'," . $txt_receive_qnty . "," . $txt_receive_qnty_pcs . ",".$txt_coller_cuff_size."," . $txt_reject_fabric_recv_qnty . "," . $rate . "," . $amount . "," . $cbo_uom . ",'" . $txt_yarn_lot . "','" . $cbo_yarn_count . "'," . $brand_id . "," . $txt_shift_name . "," . $cbo_floor_id . "," . $cbo_machine_name . "," . $cbo_room . "," . $txt_rack . "," . $txt_shelf . "," . $cbo_floor . "," . $color_id . "," . $cbo_color_range . "," . $txt_stitch_length . "," . $txt_machine_dia . "," . $txt_machine_gg . ",'" . $yarn_rate_usd . "','" . $knitting_charge_usd . "','" . $yarn_rate_taka . "','" . $knitting_charge_taka . "'," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "','" . $operator_name . "','" . $yarn_prod_id . "')";


		if (str_replace("'", "", $process_string) != "") {
			// ***************************************For Accounting Balance *******************************************************
			$field_array_material = "id,mst_id,dtls_id,entry_form,prod_id,item_category,used_qty,rate,amount, yarn_percentage, porcess_loss, inserted_by, insert_date,status_active,is_deleted";

			$process_string = explode("__", str_replace("'", "", $process_string));
			for ($sl = 0; $sl < count($process_string); $sl++) {
				$id_material_used = return_next_id_by_sequence("PRO_MATERIAL_USED_DTLS_PK_SEQ", "pro_material_used_dtls", $con);
				$product_dtls = explode("*", $process_string[$sl]);

				$used_prod_id = $product_dtls[0];
				$net_used = number_format($product_dtls[1], 4, ".", "");
				$yarn_rate = number_format($product_dtls[2], 4, ".", "");
				$used_amount = number_format($yarn_rate * $net_used, 4, ".", "");
				$txt_yarn_percentage = $product_dtls[4];
				$txt_process_loss = $product_dtls[5];

				if ($sl == 0) $add_comma = ""; else $add_comma = ",";
				$data_array_material_used .= "$add_comma(" . $id_material_used . "," . $grey_update_id . "," . $id_dtls . ",2,'" . $used_prod_id . "',1,'" . $net_used . "','" . $yarn_rate . "','" . $used_amount . "','" . $txt_yarn_percentage . "','" . $txt_process_loss . "'," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "',1,0)";
			}
		}
		// ********************************Finish For Accounting Balance *******************************************************


		$barcode_year = date("y");
		$field_array_roll = "id, barcode_year,barcode_suffix_no,barcode_no, mst_id, dtls_id, po_breakdown_id, entry_form, qnty,qc_pass_qnty,qc_pass_qnty_pcs,coller_cuff_size, reject_qnty, roll_no, rate, amount, booking_no, booking_without_order, receive_basis, is_sales, rf_id, inserted_by, insert_date";

		$save_string = explode(",", str_replace("'", "", $save_data));
		$save_data_stylewise = explode(",", str_replace("'", "", $save_data_stylewise));

		

		/*if (str_replace("'", "", $roll_maintained) == 1) 
		{
			if (str_replace("'", "", $booking_without_order) == "")
			{
				$booking_without_order = 0;
			}
			if ($is_salesOrder == 1)
			{
				$roll_arr = return_library_array("select po_breakdown_id,max(roll_no) as roll_no from pro_roll_details where entry_form in(2,22,62)  and po_breakdown_id in (".str_replace("'","",$all_po_id).") and is_sales=$is_salesOrder group by po_breakdown_id", 'po_breakdown_id', 'roll_no');
			}
			else
			{
				$roll_arr = return_library_array("select po_breakdown_id,max(roll_no) as roll_no from pro_roll_details where entry_form in(2,22,62) and po_breakdown_id in (".str_replace("'","",$all_po_id).") and booking_without_order=$booking_without_order and is_sales=$is_salesOrder group by po_breakdown_id", 'po_breakdown_id', 'roll_no');
			}
		}*/
		$po_array = array();
		$po_reject_qty_array = array();
		$roll_rate = $yarn_rate_taka + $knitting_charge_taka;

		/*for ($i = 0; $i < count($save_string); $i++) 
		{
			$order_dtls = explode("**", $save_string[$i]);

			$order_id = trim($order_dtls[0]);
			$order_qnty_roll_wise = $order_dtls[1];
			$order_qnty_roll_wise_pcs = $order_dtls[7];
			$coller_cuff_size_roll_wise = $order_dtls[8];
			$rf_id = $order_dtls[9];
			$roll_reject_qty = $order_dtls[2];
			$roll_amount = $order_qnty_roll_wise * $roll_rate;
			$roll_no = $roll_arr[$order_id] + 1;
			$roll_arr[$order_id] += 1;

			if ($order_id <= 0) {
				$order_id = '';
			}
			$id_roll = return_next_id_by_sequence("PRO_ROLL_DTLS_PK_SEQ", "pro_roll_details", $con);

			$barcode_suffix_no = explode("*", return_next_id_by_sequence("ROLL_BARCODE_SUFFIX_NO_SEQ", "pro_roll_details",$con,1,0,'',2,date("Y",time()),13 ));
			$barcode_no = $barcode_year . "02" . str_pad($barcode_suffix_no[2], 7, "0", STR_PAD_LEFT);

			if ($i == 0) $add_comma = ""; else $add_comma = ",";
			$data_array_roll .= "$add_comma(" . $id_roll . "," . $barcode_year . "," . $barcode_suffix_no[2] . "," . $barcode_no . "," . $grey_update_id . "," . $id_dtls . "," . $order_id . ",2,'" . $order_qnty_roll_wise . "','" . $order_qnty_roll_wise . "','" . $order_qnty_roll_wise_pcs . "','" . $coller_cuff_size_roll_wise . "','" . $roll_reject_qty . "','" . $roll_no . "','" . $roll_rate . "','" . $roll_amount . "','" . str_replace("'", "", $txt_booking_no) . "','" . str_replace("'", "", $booking_without_order) . "'," . $cbo_receive_basis . ",'" . $is_salesOrder . "','" . $rf_id . "'," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "')";

			$all_barcode_no .= str_replace("'", "", $barcode_no) . ",";

			if (array_key_exists($order_id, $po_array)) {
				$po_array[$order_id] += $order_qnty_roll_wise;
				$po_array_pcs[$order_id] += $order_qnty_roll_wise_pcs;
				$po_reject_qty_array[$order_id] += $roll_reject_qty;
			} else {
				$po_array[$order_id] = $order_qnty_roll_wise;
				$po_array_pcs[$order_id] = $order_qnty_roll_wise_pcs;
				$po_reject_qty_array[$order_id] += $roll_reject_qty;
			}
			if($po_array_coller_cuff_size[$order_id]!="") $po_array_coller_cuff_size[$order_id] .=",". $coller_cuff_size_roll_wise;
			else 										  $po_array_coller_cuff_size[$order_id] = $coller_cuff_size_roll_wise;
		}*/

		$save_data_stylewise_str="";
		for ($i = 0; $i < count($save_data_stylewise); $i++) 
		{
			$order_dtls = explode("**", $save_data_stylewise[$i]);

			$barcode_suffix_no = explode("*", return_next_id_by_sequence("ROLL_BARCODE_SUFFIX_NO_SEQ", "pro_roll_details",$con,1,0,'',2,date("Y",time()),13 ));
			$barcode_no = $barcode_year . "02" . str_pad($barcode_suffix_no[2], 7, "0", STR_PAD_LEFT);

			$save_data_stylewise_arr[$barcode_no] =$order_dtls[0]."**".$order_dtls[1]."**".$order_dtls[2]."**".$order_dtls[3]."**".$order_dtls[4]."**".$order_dtls[5]."**".$barcode_no."**".$order_dtls[7]."**".$order_dtls[8]."**".$order_dtls[9]."**".$barcode_suffix_no[2];
		}
		//$save_data_stylewise_str = chop($save_data_stylewise_str,",");

		//$save_data_stylewise = explode(",", $save_data_stylewise_str);


		foreach ($po_sql as $val) 
		{
			$po_qnty_with_over_perc = ($val[csf("qnty")]*$over_production_percentage)/100 + $val[csf("qnty")];

			//$remain_required = $val[csf("qnty")] - $program_recv_qnty_array[$val[csf('id')]];
			$remain_required = $po_qnty_with_over_perc - $program_recv_qnty_array[$val[csf('id')]];
			foreach ($save_data_stylewise_arr as $BARCODE=>$row_srt) 
			{
				$order_dtls = explode("**", $row_srt);
				if($remain_required > 0)
				{
					//echo $BARCODE."<br>";
					if($barcode_po_ref[$BARCODE] =="")
					{
						$remain_required= $remain_required-$order_dtls[1]*1;
						$barcode_po_ref[$BARCODE] = $val[csf("id")];

						$order_id = $val[csf("id")]; 
						$order_qnty_roll_wise = $order_dtls[1];
						$order_qnty_roll_wise_pcs = $order_dtls[7];
						$coller_cuff_size_roll_wise = $order_dtls[8];
						$rf_id = $order_dtls[9];
						$roll_reject_qty = $order_dtls[2];
						$roll_amount = $order_qnty_roll_wise * $roll_rate;
						$roll_no = $roll_arr[$order_id] + 1;
						$roll_arr[$order_id] += 1;

						$barcode_suffix_number = $order_dtls[10];

						if ($order_id <= 0) {
							$order_id = '';
						}

						$id_roll = return_next_id_by_sequence("PRO_ROLL_DTLS_PK_SEQ", "pro_roll_details", $con);
						if ($data_array_roll == "") $add_comma = ""; else $add_comma = ",";
						$data_array_roll .= "$add_comma(" . $id_roll . "," . $barcode_year . "," . $barcode_suffix_number . "," . $BARCODE . "," . $grey_update_id . "," . $id_dtls . "," . $order_id . ",2,'" . $order_qnty_roll_wise . "','" . $order_qnty_roll_wise . "','" . $order_qnty_roll_wise_pcs . "','" . $coller_cuff_size_roll_wise . "','" . $roll_reject_qty . "','" . $roll_no . "','" . $roll_rate . "','" . $roll_amount . "','" . str_replace("'", "", $txt_booking_no) . "','" . str_replace("'", "", $booking_without_order) . "'," . $cbo_receive_basis . ",'" . $is_salesOrder . "','" . $rf_id . "'," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "')";

						$all_barcode_no .= str_replace("'", "", $BARCODE) . ",";

						if (array_key_exists($order_id, $po_array)) 
						{
							$po_array[$order_id] += $order_qnty_roll_wise;
							$po_array_pcs[$order_id] += $order_qnty_roll_wise_pcs;
							$po_reject_qty_array[$order_id] += $roll_reject_qty;
						} else {
							$po_array[$order_id] = $order_qnty_roll_wise;
							$po_array_pcs[$order_id] = $order_qnty_roll_wise_pcs;
							$po_reject_qty_array[$order_id] += $roll_reject_qty;
						}
						if($po_array_coller_cuff_size[$order_id]!="") 
						{
							$po_array_coller_cuff_size[$order_id] .=",". $coller_cuff_size_roll_wise;
						}
						else
						{
							$po_array_coller_cuff_size[$order_id] = $coller_cuff_size_roll_wise;
						}
					}
				}
			}
		}

		/*echo "10**<pre>";
		print_r($data_array_roll);
		die;*/


		$field_array_proportionate = "id, trans_id, trans_type, entry_form, dtls_id, po_breakdown_id, prod_id, quantity,quantity_pcs, returnable_qnty, is_sales,coller_cuff_size, inserted_by, insert_date";
		foreach ($po_array as $key => $val) {
			$id_prop = return_next_id_by_sequence("ORDER_WISE_PROP_PK_SEQ", "order_wise_pro_details", $con);
			$order_id = $key;
			$order_qnty = $val;
			$reject_qty = $po_reject_qty_array[$key];
			$order_qnty_pcs = $po_array_pcs[$key];
			$order_coller_cuff=$po_array_coller_cuff_size[$key];

			if ($data_array_prop != "") $data_array_prop .= ",";
			$data_array_prop .= "(" . $id_prop . "," . $id_trans . ",1,2," . $id_dtls . "," . $order_id . ",'" . $prod_id . "','" . $order_qnty . "','" . $order_qnty_pcs . "','" . $reject_qty . "','" . $is_salesOrder . "','" . $order_coller_cuff . "'," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "')";

		}

		if (str_replace("'", "", $cbo_receive_basis) == 4) {
			$id_prop = return_next_id_by_sequence("ORDER_WISE_PROP_PK_SEQ", "order_wise_pro_details", $con);
			$data_array_prop = "(" . $id_prop . "," . $id_trans . ",1,2," . $id_dtls . "," . $txt_booking_no_id . ",'" . $prod_id . "'," . $txt_receive_qnty . "," . $txt_receive_qnty_pcs . "," . $txt_reject_fabric_recv_qnty . ",'1','" . $order_coller_cuff . "'," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "')";
		}

		/*######### barcode check before operation  start  ############ */
		if ($data_array_roll != "" && str_replace("'", "", $roll_maintained) == 1) 
		{
			$all_barcode_no = chop($all_barcode_no, ",");
		}

		/*######### barcode check before operation  end  ############ */

		if (str_replace("'", "", $update_id) == "") {
			$rID = sql_insert("inv_receive_master", $field_array, $data_array, 0);
			if ($rID) $flag = 1; else $flag = 0;
		} else {
			$rID = sql_update("inv_receive_master", $field_array_update, $data_array_update, "id", $update_id, 1);
			if ($rID) $flag = 1; else $flag = 0;
		}

		//echo "10**".count($row_prod)."*".str_replace("'", "", $fabric_store_auto_update);  die;
		if (count($row_prod) > 0) {
			if (str_replace("'", "", $fabric_store_auto_update) == 1) {
				$rID2 = sql_update("product_details_master", $field_array_prod_update, $data_array_prod_update, "id", $prod_id, 0);
				if ($flag == 1) {
					if ($rID2) $flag = 1; else $flag = 0;
				}
			}
		} else {
			$rID2 = sql_insert("product_details_master", $field_array_prod, $data_array_prod, 0);
			if ($flag == 1) {
				if ($rID2) $flag = 1; else $flag = 0;
			}
		}

		//echo "10** $fabric_store_auto_update insert into inv_transaction (".$field_array_trans.") values ".$data_array_trans;die;

		if (str_replace("'", "", $fabric_store_auto_update) == 1) {
			$rID3 = sql_insert("inv_transaction", $field_array_trans, $data_array_trans, 0);
			if ($flag == 1) {
				if ($rID3) $flag = 1; else $flag = 0;
			}
		}
		//echo $data_array_dtls;
		//echo "10**insert into pro_grey_prod_entry_dtls (".$field_array_dtls.") values ".$data_array_dtls;oci_rollback($con);die;
		$rID4 = sql_insert("pro_grey_prod_entry_dtls", $field_array_dtls, $data_array_dtls, 0);
		if ($flag == 1) {
			if ($rID4) $flag = 1; else $flag = 0;
		}
		//echo "10**".$data_array_roll;
		//echo "10**insert into pro_grey_prod_entry_dtls (".$field_array_dtls.") values ".$data_array_dtls;die;
		$rID5=1;
		if ($data_array_roll != "" && str_replace("'", "", $roll_maintained) == 1)// && str_replace("'","",$booking_without_order)!=1
		{
			$rID5 = sql_insert("pro_roll_details", $field_array_roll, $data_array_roll, 0);
			if ($flag == 1) {
				if ($rID5) $flag = 1; else $flag = 0;
			}
		}
		//echo "10**insert into pro_roll_details (".$field_array_roll.") values ".$data_array_roll."**".$flag;die;
		$rID6=1;
		if ($data_array_prop != "" && (str_replace("'", "", $booking_without_order) != 1 || str_replace("'", "", $cbo_receive_basis) == 4)) {
			$rID6 = sql_insert("order_wise_pro_details", $field_array_proportionate, $data_array_prop, 0);
			if ($flag == 1) {
				if ($rID6) $flag = 1; else $flag = 0;
			}
		}
		$rID7=1;
		if ($data_array_material_used != "" && str_replace("'", "", $process_costing_maintain) == 1) {
			$rID7 = sql_insert("pro_material_used_dtls", $field_array_material, $data_array_material_used, 0);
			if ($flag == 1) {
				if ($rID7) $flag = 1; else $flag = 0;
			}
		}

		if(str_replace("'","",$cbo_receive_basis)==2)
		{
			//for program status
			$update_status = '';
			if($is_status_closed == 1)
			{
				$update_status = ', status = 4';
			}
			
			$rID8 = execute_query("update ppl_planning_info_entry_dtls set is_posted_sql = 2".$update_status." where id = ".$txt_booking_no_id."");
			if ($flag == 1)
			{
				if ($rID8)
					$flag = 1;
				else
					$flag = 0;
			}
		}

		//echo "10**".$rID7."**".$rID6."**".$rID5."**".$rID4."**".$rID3."**".$rID2."**".$rID;oci_rollback($con);die;
		if ($db_type == 0) {
			if ($flag == 1) {
				mysql_query("COMMIT");
				echo "0**" . $grey_update_id . "**" . $grey_recv_num . "**0**" . $id_dtls . "**" . $rr;
			} else {
				mysql_query("ROLLBACK");
				echo "5**0**" . "&nbsp;" . "**0";
			}
		} else if ($db_type == 2 || $db_type == 1) {
			if ($flag == 1) {
				oci_commit($con);
				echo "0**" . $grey_update_id . "**" . $grey_recv_num . "**0**" . $id_dtls . "**" . $rr;
			} else {
				oci_rollback($con);
				echo "5**0**" . "&nbsp;" . "**0";
			}
		}


		//check_table_status($_SESSION['menu_id'], 0);
		disconnect($con);
		die;
	}
	else if ($operation == 1)   // Update Here
	{
		$con = connect();
		if ($db_type == 0) {
			mysql_query("BEGIN");
		}

		//previous_receive_qnty
		$receive_basis = str_replace("'", "", $cbo_receive_basis);
		$booking_without_order = str_replace("'", "", $booking_without_order);
		$booking_no_id = str_replace("'", "", $txt_booking_no_id);
		$receive_qnty = str_replace("'", "", $txt_receive_qnty);
		$txt_receive_qnty=str_replace("'", "", $txt_receive_qnty);
		$txt_receive_qnty=str_replace(",", '', $txt_receive_qnty);

		$previous_receive_qnty = str_replace("'", "", $previous_receive_qnty);
		$save_string = explode(",", str_replace("'", "", $save_data));
		$save_data_stylewise = explode(",", str_replace("'", "", $save_data_stylewise));

		$program_no = return_field_value("booking_id booking_id", "inv_receive_master", "entry_form=2 and status_active=1 and is_deleted=0 and id=$update_id", "booking_id");
		if($program_no != $booking_no_id){
			echo "30**You can not change Knitting Plan";
			disconnect($con);
			die;
		}

		

		$original_receive_basis = sql_select("select a.id,a.receive_basis,a.booking_id,count(b.id) as dtls_row from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and a.id=$update_id and b.id!=$update_dtls_id group by a.id, a.receive_basis, a.booking_id");
		if ($original_receive_basis[0][csf('dtls_row')] > 0) {
			if (str_replace("'", "", $cbo_receive_basis) != $original_receive_basis[0][csf('receive_basis')]) {
				echo "30**Multiple Production Basis Not Allow In Same Production ID";
			//check_table_status($_SESSION['menu_id'], 0);
				disconnect($con);
				die;
			} else {
				if (str_replace("'", "", $cbo_receive_basis) == 1 || str_replace("'", "", $cbo_receive_basis) == 2 || str_replace("'", "", $cbo_receive_basis) == 4) {
					if (str_replace("'", "", $txt_booking_no_id) != $original_receive_basis[0][csf('booking_id')]) {
						echo "30**Multiple F. Booking/Knit Plan Not Allow In Same Production ID";
					//check_table_status($_SESSION['menu_id'], 0);
						disconnect($con);
						die;
					}
				}
			}
		}
		//echo "10**==".$txt_yarn_lot;
		//Check Another Users Entry Start---------------------------------------
		if (str_replace("'", "", $roll_maintained) == 1)
		{
			$database_roll_info_sql = sql_select("select id, barcode_no, qnty, is_deleted from pro_roll_details where mst_id = $update_id and dtls_id = $update_dtls_id and entry_form = 2 and status_active =1 and is_deleted =0");

			$database_hidden_qnty=0;
			foreach ($database_roll_info_sql as  $val)
			{
				$database_roll_info_arr[$val[csf("id")]] = $val[csf("id")];
				$barcode_no_from_id_arr[$val[csf("id")]] = $val[csf("barcode_no")];
			}

			$roll_id_exists="";
			for ($i = 0; $i < count($save_string); $i++) {
				$order_dtls = explode("**", $save_string[$i]);
				$roll_id_exists = $order_dtls[5];
				$barcode_no_exists = $order_dtls[6];
				if ($roll_id_exists == "" || $roll_id_exists == 0)
				{

				}
				else
				{
					if($database_roll_info_arr[$roll_id_exists] == "")
					{
						echo "30** $barcode_no_exists is already deleted by another user. Please reload the System ID again.";
						disconnect($con);
						die;
					}
					unset($database_roll_info_arr[$roll_id_exists]);
				}
			}

			$txt_deleted_id = str_replace("'", "", $txt_deleted_id);
			if($txt_deleted_id != "")
			{
				$deleted_bar_id_arr = explode(",", $txt_deleted_id);
				foreach ($deleted_bar_id_arr as $dbarid)
				{
					unset($database_roll_info_arr[$dbarid]);


					$deleted_barcode .=  $barcode_no_from_id_arr[$dbarid].",";
				}

				$deleted_barcode = chop($deleted_barcode,",");

				$delivery_roll_chk_sql = sql_select("select  a.barcode_no,b.sys_number  from pro_roll_details a, pro_grey_prod_delivery_mst b where a.mst_id = b.id and barcode_no in ($deleted_barcode) and a.entry_form = 56 and b.entry_form =56 and a.status_active =1 and a.is_deleted =0");
				if(!empty($delivery_roll_chk_sql))
				{
					echo "30**Barcode already delivered to store.\nDelivery challan no ".$delivery_roll_chk_sql[0][csf("sys_number")];
					disconnect($con);
					die;
				}
			}

			if(count(array_filter($database_roll_info_arr)) >0)
			{
				echo "30**Another user already changes some information of this System ID. Please reload the System ID and try again.";
				disconnect($con);
				die;
			}
		}
		//echo "10**Fail";die;

		//End--------------------------------------------------------------


		if (str_replace("'", "", $roll_maintained) == 1) 
		{
			/*if ($db_type == 0) {
				$barcode_nos = return_field_value("group_concat(barcode_no order by id desc) as barcode_nos", "pro_roll_details", "entry_form=2 and status_active=1 and is_deleted=0 and mst_id=$update_id and dtls_id=$update_dtls_id", "barcode_nos");
			} else if ($db_type == 2) {
				$barcode_nos = return_field_value("LISTAGG(barcode_no, ',') WITHIN GROUP (ORDER BY id desc) as barcode_nos", "pro_roll_details", "entry_form=2 and status_active=1 and is_deleted=0 and mst_id=$update_id and dtls_id=$update_dtls_id", "barcode_nos");
			}

			$delivery_no = '';
			$deliveryData = sql_select("select a.sys_number from pro_grey_prod_delivery_mst a, pro_grey_prod_delivery_dtls b, pro_roll_details c where a.id=b.mst_id and b.id=c.dtls_id and b.grey_sys_id=$update_id and a.entry_form=56 and b.entry_form=56 and c.barcode_no in(" . $barcode_nos . ") and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.sys_number");
			if (count($deliveryData) > 0) {
				foreach ($deliveryData as $row) {
					if ($delivery_no == "") $delivery_no = $row[csf('sys_number')]; else $delivery_no .= ",\n" . $row[csf('sys_number')];
				}

				echo "13**" . $delivery_no;
				//check_table_status($_SESSION['menu_id'], 0);
				disconnect($con);
				die;
			}*/
		} 
		else 
		{
			$recv_qty = return_field_value("sum(grey_receive_qnty) as qty", "pro_grey_prod_entry_dtls", "grey_prod_dtls_id=$update_dtls_id and status_active=1 and is_deleted=0", "qty");
			if ($recv_qty > str_replace("'", "", $txt_receive_qnty)) {
				echo "30**Production Qty cannot be less than Receive Qty.";
				//check_table_status($_SESSION['menu_id'], 0);
				disconnect($con);
				die;
			}
		}

		$field_array_update= "receive_basis*receive_date*challan_no*booking_id*booking_no*booking_without_order*store_id*knitting_location_id*knitting_source*knitting_company*buyer_id*yarn_issue_challan_no*remarks*roll_maintained*within_group*service_booking_without_order*service_booking_no*updated_by*update_date";

		$data_array_update = $cbo_receive_basis . "*" . $txt_receive_date . "*" . $txt_receive_chal_no . "*" . $txt_booking_no_id . "*" . $txt_booking_no . "*" . $booking_without_order . "*" . $cbo_store_name . "*" . $cbo_location_name . "*" . $cbo_knitting_source . "*" . $cbo_knitting_company . "*" . $cbo_buyer_name . "*" . $txt_yarn_issue_challan_no . "*" . $txt_remarks . "*" . $roll_maintained . "*" . $within_group . "*" . $service_booking_without_order . "*" . $txt_service_booking . "*" . $_SESSION['logic_erp']['user_id'] . "*'" . $pc_date_time . "'";

		/*$rID=sql_update("inv_receive_master",$field_array_update,$data_array_update,"id",$update_id,0);
		if($rID) $flag=1; else $flag=0; */
		// ******** Add For Accountce **************************************************

		$knitting_charge_data = explode("*", str_replace("'", "", $knitting_charge_string));
		$knitting_charge_taka = number_format($knitting_charge_data[0], 2, ".", "");
		$knitting_charge_usd = number_format($knitting_charge_data[1], 4, ".", "");
		$yarn_rate_taka = number_format($knitting_charge_data[2], 2, ".", "");
		$yarn_rate_usd = number_format($knitting_charge_data[3], 4, ".", "");
		$material_deleted_id = $knitting_charge_data[7];
		//echo "10**".$knitting_charge_taka."**".$yarn_rate_taka;die;
		//*********************************************************************************

		if($knitting_charge_taka <= 0 && str_replace("'", "", $process_costing_maintain) == 1 && $vari_knit_charge_source ==2)
		{
			echo "30**Knitting Charge Needed";
			disconnect($con);
			die;
		}


		/*$brand_id = return_id($txt_brand, $brand_arr, "lib_brand", "id,brand_name");
		if ($brand_id == "") $brand_id = 0;*/

		if(str_replace("'","",$txt_brand)!="")
		{
			if (!in_array(str_replace("'","",$txt_brand),$new_array_brand))
			{
				$brand_id = return_id( str_replace("'","",$txt_brand), $brand_arr, "lib_brand", "id,brand_name","2");
				//echo $$txtColorName.'='.$color_id.'<br>';
				$new_array_brand[$brand_id]=str_replace("'","",$txt_brand);

			}
			else $brand_id =  array_search(str_replace("'","",$txt_brand), $new_array_brand);
		}
		else
		{
			$brand_id=0;
		}

		$prod_id = '';

		if (str_replace("'", "", $fabric_desc_id) == "") $fabric_desc_id = 0;

		if (str_replace("'", "", $cbo_receive_basis) == 2 && str_replace("'", "", $booking_without_order) == 1 && str_replace("'", "", $fabric_desc_id) == 0) {
			$fabric_description = trim(str_replace("'", "", $txt_fabric_description));
			$row_prod = sql_select("select id, current_stock, stock_value, avg_rate_per_unit from product_details_master where company_id=$cbo_company_id and item_category_id=13 and detarmination_id=$fabric_desc_id and item_description='$fabric_description' and gsm=$txt_gsm and dia_width=$txt_width and status_active=1 and is_deleted=0");
		} else {
			$row_prod = sql_select("select id, current_stock, stock_value, avg_rate_per_unit from product_details_master where company_id=$cbo_company_id and item_category_id=13 and detarmination_id=$fabric_desc_id and gsm=$txt_gsm and dia_width=$txt_width and status_active=1 and is_deleted=0");
		}
		//echo "10**".count($row_prod);die;
		if (count($row_prod) > 0)
		{
			$prod_id = $row_prod[0][csf('id')];
			if ($prod_id == str_replace("'", "", $previous_prod_id)) {
				if (str_replace("'", "", $fabric_store_auto_update) == 1) {
					$stock_qnty = $row_prod[0][csf('current_stock')];
					$curr_stock_qnty = $stock_qnty + str_replace("'", '', $txt_receive_qnty) - str_replace("'", '', $hidden_receive_qnty);

					$curr_amount = str_replace("'", '', $txt_receive_qnty) * ($yarn_rate_taka + $knitting_charge_taka);
					$previous_amount = str_replace("'", '', $hidden_receive_rate)*str_replace("'", '', $hidden_receive_qnty);
					$curr_stock_value = $row_prod[0][csf('stock_value')] + $curr_amount - $previous_amount;

					if($curr_stock_qnty>0)
					{
						$avg_rate_per_unit=$curr_stock_value/$curr_stock_qnty;
					}

					$field_array_prod_update = "store_id*avg_rate_per_unit*last_purchased_qnty*current_stock*stock_value*brand*lot*updated_by*update_date";
					//$txt_receive_qnty=str_replace(",", '', $txt_receive_qnty);
					$data_array_prod_update = $cbo_store_name . "*" . $avg_rate_per_unit . "*" . $txt_receive_qnty . "*" . $curr_stock_qnty . "*" . $curr_stock_value . "*" . $brand_id . "*" . $txt_yarn_lot . "*" . $_SESSION['logic_erp']['user_id'] . "*'" . $pc_date_time . "'";

					if ($curr_stock_qnty < 0) {
						echo "30**Stock cannot be less than zero.";
						//check_table_status($_SESSION['menu_id'], 0);
						disconnect($con);
						die;
					}
					/*$rID2=sql_update("product_details_master",$field_array_prod_update,$data_array_prod_update,"id",$prod_id,0);
					if($flag==1)
					{
						if($rID2) $flag=1; else $flag=0;
					}*/
				}
			} 
			else 
			{
				if (str_replace("'", "", $fabric_store_auto_update) == 1) {
					//$stock = return_field_value("current_stock", "product_details_master", "id=$previous_prod_id");

					$pre_prod_ref = sql_select("select current_stock, stock_value from product_details_master where id=$previous_prod_id");
					$stock = $pre_prod_ref[0][csf("current_stock")];
					$pre_stock_value = $pre_prod_ref[0][csf("stock_value")];



					$adjust_curr_stock = $stock - str_replace("'", '', $hidden_receive_qnty);
					$adjust_curr_value = $pre_stock_value - (str_replace("'", '', $hidden_receive_qnty)*str_replace("'", '', $hidden_receive_rate));

					if($adjust_curr_stock>0)
					{
						$cur_st_rate = $adjust_curr_value/$adjust_curr_stock;
					}
					else
					{
						$cur_st_rate = 0;
					}

					$field_array_adjust = "current_stock*avg_rate_per_unit*stock_value";
					$data_array_adjust = $adjust_curr_stock . "*" . $cur_st_rate . "*" . $adjust_curr_value;

					if ($adjust_curr_stock < 0) {
						echo "30**Stock cannot be less than zero.";
						//check_table_status($_SESSION['menu_id'], 0);
						disconnect($con);
						die;
					}
					/*$rID_adjust=sql_update("product_details_master",$field_array_adjust,$data_array_adjust,"id",$previous_prod_id,0);
					if($flag==1)
					{
						if($rID_adjust) $flag=1; else $flag=0;
					} */

					$stock_qnty = $row_prod[0][csf('current_stock')];
					$curr_stock_qnty = $stock_qnty + str_replace("'", '', $txt_receive_qnty);

					$stock_value = $row_prod[0][csf('stock_value')] + str_replace("'", '', $txt_receive_qnty) * ($yarn_rate_taka + $knitting_charge_taka);

					if($stock_qnty >0)
					{
						$avg_rate_per_unit = $stock_value/$stock_qnty;
					}else{
						$avg_rate_per_unit=0;
					}


					$field_array_prod_update = "store_id*avg_rate_per_unit*last_purchased_qnty*current_stock*stock_value*brand*lot*updated_by*update_date";

					$data_array_prod_update = $cbo_store_name . "*" . $avg_rate_per_unit . "*" . $txt_receive_qnty . "*" . $curr_stock_qnty . "*" . $stock_value . "*" . $brand_id . "*" . $txt_yarn_lot . "*" . $_SESSION['logic_erp']['user_id'] . "*'" . $pc_date_time . "'";
				}
			}
		}
		else
		{
			if (str_replace("'", "", $fabric_store_auto_update) == 1)
			{

				$pre_prod_ref = sql_select("select current_stock, stock_value from product_details_master where id=$previous_prod_id");
				$stock = $pre_prod_ref[0][csf("current_stock")];
				$pre_stock_value = $pre_prod_ref[0][csf("stock_value")];

				$adjust_curr_stock = $stock - str_replace("'", '', $hidden_receive_qnty);
				$adjust_curr_value = $pre_stock_value - (str_replace("'", '', $hidden_receive_qnty)*str_replace("'", '', $hidden_receive_rate));

				if($adjust_curr_stock>0){
					$cur_st_rate = $adjust_curr_value/$adjust_curr_stock;
				}else{
					$cur_st_rate=0;
				}

				$field_array_adjust = "current_stock*avg_rate_per_unit*stock_value";
				$data_array_adjust = $adjust_curr_stock . "*" . $cur_st_rate . "*" . $adjust_curr_value;

				if ($adjust_curr_stock < 0)
				{
					echo "30**Stock cannot be less than zero.";
					disconnect($con);
					die;
				}
			}

			//$prod_id = return_next_id("id", "product_details_master", 1);
			$prod_id = return_next_id_by_sequence("PRODUCT_DETAILS_MASTER_PK_SEQ", "product_details_master", $con);

			if (str_replace("'", "", $fabric_store_auto_update) == 1) {
				$stock_qnty = $txt_receive_qnty;
				$last_purchased_qnty = $txt_receive_qnty;
				$avg_rate_per_unit = ($yarn_rate_taka + $knitting_charge_taka);
				$stock_value = $avg_rate_per_unit*$txt_receive_qnty;
			} else {
				$stock_qnty = 0;
				$last_purchased_qnty = 0;
				$avg_rate_per_unit = 0;
				$stock_value = 0;
			}


			$prod_name_dtls = trim(str_replace("'", "", $txt_fabric_description)) . ", " . trim(str_replace("'", "", $txt_gsm)) . ", " . trim(str_replace("'", "", $txt_width));
			$field_array_prod = "id, company_id, store_id, item_category_id, detarmination_id, item_description, product_name_details, unit_of_measure, avg_rate_per_unit, last_purchased_qnty, current_stock, stock_value, brand, gsm, dia_width, lot, inserted_by, insert_date";

			$data_array_prod = "(" . $prod_id . "," . $cbo_company_id . "," . $cbo_store_name . ",13," . $fabric_desc_id . "," . $txt_fabric_description . ",'" . $prod_name_dtls . "'," . $cbo_uom . "," . $avg_rate_per_unit . "," . $last_purchased_qnty . "," . $stock_qnty . "," . $stock_value . "," . $brand_id . "," . $txt_gsm . "," . $txt_width . "," . $txt_yarn_lot . "," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "')";

			/*$rID2=sql_insert("product_details_master",$field_array_prod,$data_array_prod,0);
			if($flag==1)
			{
				if($rID2) $flag=1; else $flag=0;
			} */
		}

		//=================================Order, Store, Program wise Check start====================================

		if ($receive_basis == 2 && str_replace("'","",$fabric_store_auto_update)==1 && str_replace("'", "", $roll_maintained) != 1) 
		{
			$pre_ref_sql = sql_select("select a.booking_id, c.prod_id, c.po_breakdown_id, a.store_id, sum(c.quantity) as qnty from inv_receive_master a, pro_grey_prod_entry_dtls b, order_wise_pro_details c where a.id =b.mst_id and b.id =c.dtls_id and a.entry_form =2 and c.entry_form =2 and b.trans_id>0 and b.id = $update_dtls_id and a.status_active =1 and b.status_active =1 and c.status_active =1 group by a.booking_id, c.prod_id, c.po_breakdown_id,a.store_id");
			foreach ($pre_ref_sql as $val) 
			{
				$pre_po_ref_data[$val[csf("po_breakdown_id")]] += $val[csf("qnty")];
				$pre_store_id = $val[csf("store_id")];
				$pre_prod_id = $val[csf("prod_id")];
			}
			
			$received_sql = sql_select("select a.booking_id, c.prod_id, c.po_breakdown_id, a.store_id, sum(c.quantity) as qnty from inv_receive_master a, pro_grey_prod_entry_dtls b, order_wise_pro_details c where a.id=b.mst_id and b.id=c.dtls_id and a.entry_form =2 and c.entry_form =2 and b.trans_id>0 and a.store_id=$pre_store_id and a.booking_id =$booking_no_id and b.prod_id =$pre_prod_id and a.status_active =1 and b.status_active =1 and c.status_active =1 group by a.booking_id, c.prod_id, c.po_breakdown_id,a.store_id");
			foreach ($received_sql as $val) 
			{
				$received_data[$val[csf("po_breakdown_id")]] += $val[csf("qnty")];
			}

			$issued_sql = sql_select("select b.program_no, b.prod_id, c.po_breakdown_id,b.store_name, sum(c.quantity) as qnty
			from inv_issue_master a, inv_grey_fabric_issue_dtls b, order_wise_pro_details c where a.id =b.mst_id and b.id = c.dtls_id and a.entry_form =16 and c.entry_form =16 and a.status_active =1 and b.status_active =1 and c.status_active =1 and a.issue_basis =3 and b.program_no= $booking_no_id and b.prod_id =$pre_prod_id group by b.program_no, b.prod_id, c.po_breakdown_id,b.store_name");
			foreach ($issued_sql as $val) 
			{
				$issued_data[$val[csf("po_breakdown_id")]] += $val[csf("qnty")];
			}

			$transfered_sql = sql_select("select b.from_program, b.to_program, c.po_breakdown_id, c.prod_id, b.from_store, b.to_store, c.trans_type, sum(c.quantity) as qnty from inv_item_transfer_mst a, inv_item_transfer_dtls b, order_wise_pro_details c
			where a.id=b.mst_id and b.id=c.dtls_id and a.entry_form =13 and c.entry_form =13 and a.status_active =1 and b.status_active =1 and c.status_active =1 and c.prod_id =$pre_prod_id and (b.from_program= $booking_no_id or b.to_program=$booking_no_id) group by b.from_program, b.to_program, c.po_breakdown_id, c.prod_id,b.from_store,b.to_store, c.trans_type");
			foreach ($transfered_sql as $val) 
			{
				if($val[csf("trans_type")] == 5)
				{
					$transfered_data[$val[csf("to_store")]][$val[csf("to_program")]][$val[csf("po_breakdown_id")]]["in"] +=$val[csf("qnty")];
				}
				else
				{
					$transfered_data[$val[csf("from_store")]][$val[csf("from_program")]][$val[csf("po_breakdown_id")]]["out"] += $val[csf("qnty")];
				}
			}

			$issue_returned_sql = sql_select("select a.booking_id, b.store_id, c.po_breakdown_id, c.prod_id, c.quantity from inv_receive_master a, inv_transaction b, order_wise_pro_details c where a.id=b.mst_id and b.id =c.trans_id and a.entry_form =51 and c.prod_id =$pre_prod_id and a.booking_id= $booking_no_id and a.status_active =1 and b.status_active =1 and c.status_active =1");
			foreach ($issue_returned_sql as $val) 
			{
				$issue_returned_data[$val[csf("po_breakdown_id")]] += $val[csf("quantity")];
			}

			foreach($save_string as $po_row)
			{
				$po_qnty_arr = explode("**", $po_row);
				$po_breakdown_id = $po_qnty_arr[0];
				$po_wise_qnty = $po_qnty_arr[1];

				$to_save_po_qnty_arr[$po_breakdown_id] += $po_wise_qnty;
				$to_save_store_po_qnty_arr[$prod_id][str_replace("'", "", $cbo_store_name)][$po_breakdown_id] += $po_wise_qnty;
			}

			if($pre_store_id != str_replace("'", "", $cbo_store_name)  || ($pre_prod_id !=$prod_id) || ($pre_po_ref_data != $to_save_po_qnty_arr))
			{
				foreach ($pre_po_ref_data as $pre_po => $pre_po_qnty) 
				{
					$pre_rcv = $received_data[$pre_po];
					$pre_issue = $issued_data[$pre_po];
					$pre_issue_ret = $issue_returned_data[$pre_po];
					$pre_trans_out = $transfered_data[$pre_store_id][$booking_no_id][$pre_po]["out"];
					$pre_trans_in = $transfered_data[$pre_store_id][$booking_no_id][$pre_po]["in"];
					$pre_stock_qnty = ($pre_rcv + $pre_trans_in + $pre_issue_ret) - ($pre_issue + $pre_trans_out);

					$validate_stock = $pre_stock_qnty - $pre_po_ref_data[$pre_po] + $to_save_store_po_qnty_arr[$pre_prod_id][$pre_store_id][$pre_po];
					
					if($validate_stock<0)
					{
						echo "30**Stock Not Available in previous store and order\nPrevious stock : $pre_stock_qnty";
						disconnect($con);
						die;
						//echo "30**Stock Not Available in following store and order\n ($pre_rcv + $pre_trans_in + $pre_issue_ret) - ($pre_issue + $pre_trans_out) \n\n pre stock=($pre_stock_qnty) - pre qnty=($pre_po_ref_data[$pre_po]) + save qnty = (".$to_save_store_po_qnty_arr[$pre_prod_id][$pre_store_id][$pre_po].")";
					}
				}
			}
		}
		//================================================End========================================================

		//echo "10**Here";die;
		if (str_replace("'", "", $fabric_store_auto_update) == 1)
		{
			/*$order_rate = 0;
			$order_amount = 0;
			$cons_rate = 0;
			$cons_amount = 0;*/
			$receive_qnty = str_replace("'", "", $txt_receive_qnty);
			$exchange_rate = return_field_value("exchange_rate", "inv_receive_master", "id=$update_id");

			$cons_rate = ($yarn_rate_taka + $knitting_charge_taka);
			$cons_rate = number_format($cons_rate,4,".","");

			$cons_amount = $receive_qnty * $cons_rate;
			$cons_amount = number_format($cons_amount,4,".","");

			$order_rate = $cons_rate/$exchange_rate;
			$order_rate = number_format($order_rate,4,".","");

			$order_amount = $order_rate*$receive_qnty;
			$order_amount = number_format($order_amount,4,".","");

			$sqlBl = sql_select("select cons_quantity,cons_amount,balance_qnty,balance_amount from inv_transaction where id=$update_trans_id");
			$before_receive_qnty = $sqlBl[0][csf("cons_quantity")];
			$beforeAmount = $sqlBl[0][csf("cons_amount")];
			$beforeBalanceQnty = $sqlBl[0][csf("balance_qnty")];
			$beforeBalanceAmount = $sqlBl[0][csf("balance_amount")];

			$adjBalanceQnty = $beforeBalanceQnty - $before_receive_qnty + str_replace("'", '', $txt_receive_qnty);
			$adjBalanceAmount = $beforeBalanceAmount - $beforeAmount + $con_amount;

			$field_array_trans_update = "receive_basis*pi_wo_batch_no*prod_id*transaction_date*store_id*brand_id*order_qnty*order_rate*order_amount*cons_quantity*cons_quantity_pcs*cons_reject_qnty*cons_rate*cons_amount*balance_qnty*balance_amount*floor_id*machine_id*room*rack*self*production_floor*updated_by*update_date";

			$data_array_trans_update = $cbo_receive_basis . "*" . $txt_booking_no_id . "*" . $prod_id . "*" . $txt_receive_date . "*" . $cbo_store_name . "*" . $brand_id . "*" . $txt_receive_qnty . "*" . $order_rate . "*" . $order_amount . "*" . $txt_receive_qnty . "*" . $txt_receive_qnty_pcs . "*" . $txt_reject_fabric_recv_qnty . "*" . $cons_rate . "*" . $cons_amount . "*" . $adjBalanceQnty . "*" . $adjBalanceAmount . "*" . $cbo_floor . "*" . $cbo_machine_name . "*" . $cbo_room . "*" . $txt_rack . "*" . $txt_shelf . "*" . $cbo_floor_id . "*" . $_SESSION['logic_erp']['user_id'] . "*'" . $pc_date_time . "'";

			/*$rID4=sql_update("inv_transaction",$field_array_trans_update,$data_array_trans_update,"id",$update_trans_id,0);
			if($flag==1)
			{
				if($rID4) $flag=1; else $flag=0;
			} */
		}

		//echo "10**here";

		/*$duplicate = is_duplicate_field("b.id","inv_receive_master a, pro_grey_prod_entry_dtls b","a.id=b.mst_id and b.mst_id=$update_id and b.id<>$update_dtls_id and b.prod_id=$prod_id and a.item_category=13 and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
		if($duplicate==1)
		{
			//check_table_status( $_SESSION['menu_id'],0);
			echo "20**Duplicate Product is Not Allow in Same Production Number.";
			die;
		}*/

		$cbo_yarn_count = explode(",", str_replace("'", "", $cbo_yarn_count));
		//asort($cbo_yarn_count);
		$cbo_yarn_count = implode(",", $cbo_yarn_count);

		$txt_yarn_lot = explode(",", str_replace("'", "", $txt_yarn_lot));
		//asort($txt_yarn_lot);
		$txt_yarn_lot = implode(",", $txt_yarn_lot);

		$yarn_prod_id = explode(",", str_replace("'", "", $yarn_prod_id));
		asort($yarn_prod_id);
		$yarn_prod_id = implode(",", $yarn_prod_id);
		$operator_name = str_replace("'", "", $txt_operator_id);
		$rate = $cons_rate;
		$amount = $cons_amount;


		$is_salesOrder = 0;
		if (str_replace("'", "", $cbo_receive_basis) == 4) {
			$is_salesOrder = 1;
		} else if (str_replace("'", "", $cbo_receive_basis) == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=$txt_booking_no_id");
			if ($is_salesOrder == "") $is_salesOrder = 0;
		}

		//================================
		if (str_replace("'", "", $cbo_receive_basis) == 2)
		{
			if ($is_salesOrder == 1) 
			{

				//$po_sql = sql_select("select a.id, a.job_no as po_number, sum(b.grey_qty) as po_quantity, 1 as total_set_qnty from fabric_sales_order_mst a, fabric_sales_order_dtls b, ppl_planning_entry_plan_dtls c where a.id=b.mst_id and b.mst_id=c.po_id and c.dtls_id=$txt_booking_no_id group by a.id, a.job_no");
				$po_sql = sql_select("select c.id, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b, fabric_sales_order_mst c where a.id=b.dtls_id and b.dtls_id=$txt_booking_no_id and b.status_active=1 and b.is_deleted=0 and b.po_id=c.id group by c.id");

				$program_recv_qnty_array = return_library_array("select d.id, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c, fabric_sales_order_mst d where a.id=b.mst_id and b.id=c.dtls_id and a.status_active=1 and a.entry_form=2  and a.receive_basis=2  and c.entry_form=2 and a.booking_no=$txt_booking_no_id and b.febric_description_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and c.po_breakdown_id=d.id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and b.id != $update_dtls_id group by d.id", "id", "recv_qnty");

			} 
			else if ($is_salesOrder == 2) 
			{
				$po_sql = sql_select("select c.id, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b, wo_non_ord_samp_booking_mst c where a.id=b.dtls_id and b.dtls_id=$txt_booking_no_id and b.status_active=1 and b.is_deleted=0 and b.booking_no=c.booking_no group by c.id");
				$program_recv_qnty_array=array();
			}
			else 
			{

				$po_sql = sql_select("select c.id, c.shipment_date, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b, wo_po_break_down c, wo_po_details_master d where a.id=b.dtls_id and b.po_id=c.id and c.job_id=d.id and b.dtls_id=$txt_booking_no_id and b.status_active=1 and b.is_deleted=0 group by c.id, c.shipment_date order by c.shipment_date asc");

				$program_recv_qnty_array = return_library_array("select d.id, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c, wo_po_break_down d, wo_po_details_master e where a.id=b.mst_id and b.id=c.dtls_id and c.po_breakdown_id=d.id and d.job_id=e.id and a.status_active=1 and a.entry_form=2 and a.receive_basis=2 and c.entry_form=2 and a.booking_no=$txt_booking_no_id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and b.id != $update_dtls_id group by d.id", "id", "recv_qnty");
			}

			foreach ($po_sql as $val) 
			{
				$all_po_id_arr[$val[csf("id")]] = $val[csf("id")];
			}

			$all_po_id = implode(",", $all_po_id_arr);
		}

		if (str_replace("'", "", $roll_maintained) == 1) 
		{
			if (str_replace("'", "", $booking_without_order) == "")
			{
				$booking_without_order = 0;
			}
			if ($is_salesOrder == 1)
			{
				$roll_arr = return_library_array("select po_breakdown_id,max(roll_no) as roll_no from pro_roll_details where entry_form in(2,22,62)  and po_breakdown_id in (".str_replace("'","",$all_po_id).") and is_sales=$is_salesOrder group by po_breakdown_id", 'po_breakdown_id', 'roll_no');
			}
			else
			{
				$roll_arr = return_library_array("select po_breakdown_id,max(roll_no) as roll_no from pro_roll_details where entry_form in(2,22,62) and po_breakdown_id in (".str_replace("'","",$all_po_id).") and booking_without_order=$booking_without_order and is_sales=$is_salesOrder group by po_breakdown_id", 'po_breakdown_id', 'roll_no');
			}
		}


		$field_array_dtls_update = "prod_id*body_part_id*febric_description_id*gsm*width*no_of_roll*order_id*grey_receive_qnty*grey_receive_qnty_pcs*coller_cuff_size*reject_fabric_receive*rate*amount*uom*yarn_lot*yarn_count*brand_id*shift_name*floor_id*machine_no_id*room*rack*self*store_floor*color_id*color_range_id*stitch_length*machine_dia*machine_gg*order_yarn_rate*order_knitting_charge*yarn_rate*kniting_charge*updated_by*update_date*operator_name*yarn_prod_id";

		$data_array_dtls_update = $prod_id . "*" . $cbo_body_part . "*" . $fabric_desc_id . "*" . $txt_gsm . "*" . $txt_width . "*" . $txt_roll_no . "*'" . str_replace("'","",$all_po_id) . "'*" . $txt_receive_qnty . "*" . $txt_receive_qnty_pcs . "*" . $txt_coller_cuff_size . "*" . $txt_reject_fabric_recv_qnty . "*'" . $rate . "'*'" . $amount . "'*" . $cbo_uom . "*'" . $txt_yarn_lot . "'*'" . $cbo_yarn_count . "'*" . $brand_id . "*" . $txt_shift_name . "*" . $cbo_floor_id . "*" . $cbo_machine_name . "*" . $cbo_room . "*" . $txt_rack . "*" . $txt_shelf . "*" . $cbo_floor . "*" . $color_id . "*" . $cbo_color_range . "*" . $txt_stitch_length . "*" . $txt_machine_dia . "*" . $txt_machine_gg . "*'" . $yarn_rate_usd . "'*'" . $knitting_charge_usd . "'*'" . $yarn_rate_taka . "'*'" . $knitting_charge_taka . "'*" . $_SESSION['logic_erp']['user_id'] . "*'" . $pc_date_time . "'*'".$operator_name. "'*'".$yarn_prod_id."'";


		//echo "10**".$data_array_dtls_update;die;
		/*$rID5=sql_update("pro_grey_prod_entry_dtls",$field_array_dtls_update,$data_array_dtls_update,"id",$update_dtls_id,0);
		if($flag==1)
		{
			if($rID5) $flag=1; else $flag=0;
		} */

		if (str_replace("'", "", $process_string) != "") 
		{
			//****************************** for account Process rate  ************************************************************
			$field_array_material = "id,mst_id,dtls_id,entry_form,prod_id,item_category,used_qty,rate,amount, yarn_percentage, porcess_loss, inserted_by, insert_date,status_active, is_deleted";
			$field_array_material_update = "used_qty*rate*amount*yarn_percentage*porcess_loss*updated_by*update_date";
			//$id_material_used = return_next_id("id", "pro_material_used_dtls", 1);

			$process_string = explode("__", str_replace("'", "", $process_string));
			for ($sl = 0; $sl < count($process_string); $sl++) {
				$id_material_used = return_next_id_by_sequence("PRO_MATERIAL_USED_DTLS_PK_SEQ", "pro_material_used_dtls", $con);
				$product_dtls = explode("*", $process_string[$sl]);

				$used_prod_id = $product_dtls[0];
				$net_used = number_format($product_dtls[1], 4, ".", "");
				$yarn_rate = number_format($product_dtls[2], 4, ".", "");
				$used_amount = number_format($yarn_rate * $net_used, 4, ".", "");
				$material_update_id = $product_dtls[3];
				$txt_yarn_percentage = $product_dtls[4];
				$txt_process_loss = $product_dtls[5];
				if ($material_update_id > 0) {

					$material_id_arr[] = $material_update_id;
					$material_data_array_update[$material_update_id] = explode("*", ("'" . $net_used . "'*'" . $yarn_rate . "'* '" . $used_amount . "'*'" . $txt_yarn_percentage . "'* '" . $txt_process_loss . "'*" . $_SESSION['logic_erp']['user_id'] . "*'" . $pc_date_time . "'"));
				} else {
					if ($sl == 0) $add_comma = ""; else $add_comma = ",";
					$data_array_material_used .= "$add_comma(" . $id_material_used . "," . $update_id . "," . $update_dtls_id . ",2," . $used_prod_id . ",1,'" . $net_used . "','" . $yarn_rate . "','" . $used_amount . "','" . $txt_yarn_percentage . "','" . $txt_process_loss . "'," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "',1,0)";
					//$id_material_used++;
				}
			}
		}
		//****************************** for account Process rate finish ************************************************************

		$barcode_year = date("y");
		//$barcode_suffix_no = return_field_value("max(barcode_suffix_no) as suffix_no", "pro_roll_details", "barcode_year=$barcode_year", "suffix_no") + 1;// and entry_form=2
		//$barcode_suffix_no = return_next_id("barcode_suffix_no", "pro_roll_details", 1);

		$barcode_no = $barcode_year . "02" . str_pad($barcode_suffix_no, 7, "0", STR_PAD_LEFT);

		$field_array_roll = "id, barcode_year,barcode_suffix_no,barcode_no, mst_id, dtls_id, po_breakdown_id, entry_form, qnty,qc_pass_qnty,qc_pass_qnty_pcs,coller_cuff_size, reject_qnty, roll_no,rate, amount,booking_no, booking_without_order, receive_basis, is_sales, rf_id, inserted_by, insert_date";
		$field_array_roll_update = "po_breakdown_id*booking_no*booking_without_order*qnty*qc_pass_qnty*qc_pass_qnty_pcs*coller_cuff_size*reject_qnty*roll_no*rate*amount*rf_id*updated_by*update_date";

		//$id_roll = return_next_id("id", "pro_roll_details", 1);

		


		//$save_data_stylewise

		foreach ($save_string as $val) 
		{
			//save_string = txtPoId + "**" + txtGreyQnty + "**" + txtRejectQnty + "**" + txtRoll + "**" + txtRollId + "**" + txtRollTableId + "**" + txtBarcodeNo + "**" + txtGreyQnty_pcs+ "**" + txtSizeQty + "**" + txtRFId;

			$Bar_str_arr = explode("**", $val);
			if($Bar_str_arr[6]){
				$saved_barcode_qnty_arr[$Bar_str_arr[6]] = $Bar_str_arr[1]; //[barcode no ] = quantity
				$saved_barcode_order_arr[$Bar_str_arr[6]] = $Bar_str_arr[0]; //[barcode no ] = order no
			}
		}

		$Bar_str_arr=array();

		$po_array = array();
		$po_reject_qty_array = array();
		$not_delete_roll_table_id = '';
		$roll_rate = $yarn_rate_taka + $knitting_charge_taka;
		$all_barcode_no = "";

		foreach ($save_data_stylewise as $value) 
		{
			//save_string = txtPoId + "**" + txtGreyQnty + "**" + txtRejectQnty + "**" + txtRoll + "**" + txtRollId + "**" + txtRollTableId + "**" + txtBarcodeNo + "**" + txtGreyQnty_pcs+ "**" + txtSizeQty + "**" + txtRFId;

			$order_dtls = explode("**", $value);
			if($order_dtls[6]=="")
			{
				/*
				|
				|	Here new barcode are creating for unsaved quantity
				|	
				*/
				$barcode_suffix_no= explode("*", return_next_id_by_sequence("ROLL_BARCODE_SUFFIX_NO_SEQ", "pro_roll_details",$con,1,0,'',2,date("Y",time()),13 ));
				$barcode_no = $barcode_year . "02" . str_pad($barcode_suffix_no[2], 7, "0", STR_PAD_LEFT);

				$save_data_stylewise_arr[$barcode_no] =$order_dtls[0]."**".$order_dtls[1]."**".$order_dtls[2]."**".$order_dtls[3]."**".$order_dtls[4]."**".$order_dtls[5]."**".$barcode_no."**".$order_dtls[7]."**".$order_dtls[8]."**".$order_dtls[9]."**".$barcode_suffix_no[2];
			}
			else
			{
				/*
				|
				|	Here Old saved barcodes for Edit quantity
				|	
				*/
				$existing_barcode_order = $saved_barcode_order_arr[$order_dtls[6]];
				$existing_barcode_ref_for_edit[$existing_barcode_order] += $order_dtls[1];

				$order_id = $existing_barcode_order;
				$order_qnty_roll_wise = $order_dtls[1];
				$order_qnty_roll_wise_pcs = $order_dtls[7];
				$coller_cuff_size_roll_wise = $order_dtls[8];
				$rf_id = $order_dtls[9];
				$roll_reject_qty = $order_dtls[2];
				$roll_no = $order_dtls[3];
				$roll_not_delete_id = $order_dtls[4];
				$roll_id = $order_dtls[5];
				$roll_amount = $order_qnty_roll_wise * $roll_rate;

				if ($order_id <= 0) {
					$order_id = '';
				}

				if ($roll_no == "") {
					$roll_no = $roll_arr[$order_id] + 1;
					$roll_arr[$order_id] += 1;
				}


				$roll_id_arr[] = $roll_id;
				$roll_data_array_update[$roll_id] = explode("*", ($order_id . "*'" . str_replace("'", "", $txt_booking_no) . "'*'" . str_replace("'", "", $booking_without_order) . "'*'" . $order_qnty_roll_wise . "'*'" . $order_qnty_roll_wise . "'*'" . $order_qnty_roll_wise_pcs . "'*'" . $coller_cuff_size_roll_wise . "'*'" . $roll_reject_qty . "'*'" . $roll_no . "'*'" . $roll_rate . "'*'" . $roll_amount ."'*'" .$rf_id. "'*" . $_SESSION['logic_erp']['user_id'] . "*'" . $pc_date_time . "'"));
				

				if (array_key_exists($order_id, $po_array)) {
					$po_array[$order_id] += $order_qnty_roll_wise;
					$po_array_pcs[$order_id] += $order_qnty_roll_wise_pcs;
					$po_reject_qty_array[$order_id] += $roll_reject_qty;
				} else {
					$po_array[$order_id] = $order_qnty_roll_wise;
					$po_array_pcs[$order_id] = $order_qnty_roll_wise_pcs;
					$po_reject_qty_array[$order_id] += $roll_reject_qty;
				}
				if($po_array_coller_cuff_size[$order_id]!="") 
				{
					$po_array_coller_cuff_size[$order_id] .=",". $coller_cuff_size_roll_wise;
				}
				else  {
					$po_array_coller_cuff_size[$order_id] = $coller_cuff_size_roll_wise;
				}


			}
		}

		/*
		|
		|	Here Order assigning for Unsaved quantity
		|
		*/
		foreach ($po_sql as $val) 
		{	
			$po_qnty_with_over_perc = ($val[csf("qnty")]*$over_production_percentage)/100 + $val[csf("qnty")];
			//$remain_required = $val[csf("qnty")] - $program_recv_qnty_array[$val[csf('id')]] + $existing_barcode_ref_for_edit[$existing_barcode_order];
			$remain_required = $po_qnty_with_over_perc - $program_recv_qnty_array[$val[csf('id')]] + $existing_barcode_ref_for_edit[$existing_barcode_order];
			//Remain 		= program qnty 		-	previous receive without this details 	+ current barcode qnty
			foreach ($save_data_stylewise_arr as $BARCODE=>$row_srt) 
			{
				$order_dtls = explode("**", $row_srt);
				if($remain_required > 0)
				{
					//echo $BARCODE."<br>";
					if($barcode_po_ref[$BARCODE] =="")
					{
						$remain_required= $remain_required-$order_dtls[1]*1;
						$barcode_po_ref[$BARCODE] = $val[csf("id")];

						$order_id = $val[csf("id")]; 
						$order_qnty_roll_wise = $order_dtls[1];
						$order_qnty_roll_wise_pcs = $order_dtls[7];
						$coller_cuff_size_roll_wise = $order_dtls[8];
						$rf_id = $order_dtls[9];
						$roll_reject_qty = $order_dtls[2];
						$roll_amount = $order_qnty_roll_wise * $roll_rate;
						$roll_no = $roll_arr[$order_id] + 1;
						$roll_arr[$order_id] += 1;

						$barcode_suffix_number = $order_dtls[10];

						if ($order_id <= 0) {
							$order_id = '';
						}

						$id_roll = return_next_id_by_sequence("PRO_ROLL_DTLS_PK_SEQ", "pro_roll_details", $con);
						if ($data_array_roll == "") $add_comma = ""; else $add_comma = ",";
						$data_array_roll .= "$add_comma(" . $id_roll . "," . $barcode_year . "," . $barcode_suffix_number . "," . $BARCODE . "," . $update_id . "," . $update_dtls_id . "," . $order_id . ",2,'" . $order_qnty_roll_wise . "','" . $order_qnty_roll_wise . "','" . $order_qnty_roll_wise_pcs . "','" . $coller_cuff_size_roll_wise . "','" . $roll_reject_qty . "','" . $roll_no . "','" . $roll_rate . "','" . $roll_amount . "','" . str_replace("'", "", $txt_booking_no) . "','" . str_replace("'", "", $booking_without_order) . "'," . $cbo_receive_basis . ",'" . $is_salesOrder . "','" . $rf_id . "'," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "')";

						$all_barcode_no .= str_replace("'", "", $BARCODE) . ",";

						if (array_key_exists($order_id, $po_array)) 
						{
							$po_array[$order_id] += $order_qnty_roll_wise;
							$po_array_pcs[$order_id] += $order_qnty_roll_wise_pcs;
							$po_reject_qty_array[$order_id] += $roll_reject_qty;
						} else {
							$po_array[$order_id] = $order_qnty_roll_wise;
							$po_array_pcs[$order_id] = $order_qnty_roll_wise_pcs;
							$po_reject_qty_array[$order_id] += $roll_reject_qty;
						}
						if($po_array_coller_cuff_size[$order_id]!="") 
						{
							$po_array_coller_cuff_size[$order_id] .=",". $coller_cuff_size_roll_wise;
						}
						else
						{
							$po_array_coller_cuff_size[$order_id] = $coller_cuff_size_roll_wise;
						}
					}
				}
			}
		}
		
		/*echo "10**";
		print_r($data_array_roll);die;*/

		//=================================

		
		/*
			$po_array = array();
			$po_reject_qty_array = array();
			$not_delete_roll_table_id = '';
			$roll_rate = $yarn_rate_taka + $knitting_charge_taka;
			$all_barcode_no = "";
			for ($i = 0; $i < count($save_string); $i++) 
			{
				$order_dtls = explode("**", $save_string[$i]);

				$order_id = trim($order_dtls[0]);
				$order_qnty_roll_wise = $order_dtls[1];
				$order_qnty_roll_wise_pcs = $order_dtls[7];
				$coller_cuff_size_roll_wise = $order_dtls[8];
				$rf_id = $order_dtls[9];
				$roll_reject_qty = $order_dtls[2];
				$roll_no = $order_dtls[3];
				$roll_not_delete_id = $order_dtls[4];
				$roll_id = $order_dtls[5];
				$roll_amount = $order_qnty_roll_wise * $roll_rate;

				if ($order_id <= 0) {
					$order_id = '';
				}

				if ($roll_no == "") {
					$roll_no = $roll_arr[$order_id] + 1;
					$roll_arr[$order_id] += 1;
				}

				if ($roll_id == "" || $roll_id == 0) 
				{
					$id_roll = return_next_id_by_sequence("PRO_ROLL_DTLS_PK_SEQ", "pro_roll_details", $con);
					$barcode_suffix_no = explode("*", return_next_id_by_sequence("ROLL_BARCODE_SUFFIX_NO_SEQ", "pro_roll_details",$con,1,0,'',2,date("Y",time()),13 ));
					$barcode_no = $barcode_year . "02" . str_pad($barcode_suffix_no[2], 7, "0", STR_PAD_LEFT);

					if ($data_array_roll != "") $data_array_roll .= ",";
					$data_array_roll .= "(" . $id_roll . "," . $barcode_year . "," . $barcode_suffix_no[2] . "," . $barcode_no . "," . $update_id . "," . $update_dtls_id . "," . $order_id . ",2,'" . $order_qnty_roll_wise . "','" . $order_qnty_roll_wise . "','" . $order_qnty_roll_wise_pcs . "','" . $coller_cuff_size_roll_wise . "','" . $roll_reject_qty . "','" . $roll_no . "','" . $roll_rate . "','" . $roll_amount . "','" . str_replace("'", "", $txt_booking_no) . "','" . str_replace("'", "", $booking_without_order) . "'," . $cbo_receive_basis . ",'" . $is_salesOrder . "','" .$rf_id. "',". $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "')";
					$all_barcode_no .= $barcode_no . ",";
				} else {
					$roll_id_arr[] = $roll_id;
					$roll_data_array_update[$roll_id] = explode("*", ($order_id . "*'" . str_replace("'", "", $txt_booking_no) . "'*'" . str_replace("'", "", $booking_without_order) . "'*'" . $order_qnty_roll_wise . "'*'" . $order_qnty_roll_wise . "'*'" . $order_qnty_roll_wise_pcs . "'*'" . $coller_cuff_size_roll_wise . "'*'" . $roll_reject_qty . "'*'" . $roll_no . "'*'" . $roll_rate . "'*'" . $roll_amount ."'*'" .$rf_id. "'*" . $_SESSION['logic_erp']['user_id'] . "*'" . $pc_date_time . "'"));
				}

				if (array_key_exists($order_id, $po_array)) {
					$po_array[$order_id] += $order_qnty_roll_wise;
					$po_array_pcs[$order_id] += $order_qnty_roll_wise_pcs;
					$po_reject_qty_array[$order_id] += $roll_reject_qty;
				} else {
					$po_array[$order_id] = $order_qnty_roll_wise;
					$po_array_pcs[$order_id] = $order_qnty_roll_wise_pcs;
					$po_reject_qty_array[$order_id] += $roll_reject_qty;
				}
				if($po_array_coller_cuff_size[$order_id]!="") $po_array_coller_cuff_size[$order_id] .=",". $coller_cuff_size_roll_wise;
				else 										  $po_array_coller_cuff_size[$order_id] = $coller_cuff_size_roll_wise;
			}
		*/

		/*######### barcode check before operation  start  ############ */

		if ($data_array_roll != "" && str_replace("'", "", $roll_maintained) == 1) {
			$all_barcode_no = chop($all_barcode_no, ",");
			//$barcod_check = return_field_value("barcode_no", "pro_roll_details", "status_active=1 and barcode_no in($all_barcode_no)", "barcode_no");

			/*if ($barcod_check != "") {
				echo "15**0**Database is busy now.";
				check_table_status($_SESSION['menu_id'], 0);
				disconnect($con);
				die;
			}*/
		}

		/*######### barcode check before operation  end  ############ */


		//echo "10**".bulk_update_sql_statement( "pro_roll_details", "id", $field_array_roll_update, $roll_data_array_update, $roll_id_arr );die;


		$field_array_proportionate = "id, trans_id, trans_type, entry_form, dtls_id, po_breakdown_id, prod_id, quantity,quantity_pcs,coller_cuff_size, returnable_qnty, is_sales, inserted_by, insert_date";
		//$id_prop = return_next_id("id", "order_wise_pro_details", 1);
		foreach ($po_array as $key => $val) {
			$id_prop = return_next_id_by_sequence("ORDER_WISE_PROP_PK_SEQ", "order_wise_pro_details", $con);
			$order_id = $key;
			$order_qnty = $val;
			$reject_qty = $po_reject_qty_array[$key];
			$order_qnty_pcs = $po_array_pcs[$key];
			$order_coller_cuff=$po_array_coller_cuff_size[$key];

			if ($data_array_prop != "") $data_array_prop .= ",";
			$data_array_prop .= "$add_comma(" . $id_prop . "," . $update_trans_id . ",1,2," . $update_dtls_id . "," . $order_id . ",'" . $prod_id . "','" . $order_qnty . "','" . $order_qnty_pcs . "','" . $order_coller_cuff . "','" . $reject_qty . "','" . $is_salesOrder . "'," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "')";//,'".$color_id."'
			//$id_prop = $id_prop + 1;
		}

		if (str_replace("'", "", $cbo_receive_basis) == 4) {
			$id_prop = return_next_id_by_sequence("ORDER_WISE_PROP_PK_SEQ", "order_wise_pro_details", $con);
			$data_array_prop = "(" . $id_prop . "," . $update_trans_id . ",1,2," . $update_dtls_id . "," . $txt_booking_no_id . ",'" . $prod_id . "'," . $txt_receive_qnty . "," . $txt_receive_qnty_pcs . ",'" . $order_coller_cuff . "'," . $txt_reject_fabric_recv_qnty . ",'1'," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "')";
		}

		$rID = sql_update("inv_receive_master", $field_array_update, $data_array_update, "id", $update_id, 0);
		if ($rID) $flag = 1; else $flag = 0;

		if (count($row_prod) > 0) 
		{
			if ($prod_id == str_replace("'", "", $previous_prod_id)) {
				if (str_replace("'", "", $fabric_store_auto_update) == 1) {
					//echo "update product_details_master set(".$field_array_prod_update.")=".$data_array_prod_update; die;
					$rID2 = sql_update("product_details_master", $field_array_prod_update, $data_array_prod_update, "id", $prod_id, 0);
					if ($flag == 1) {
						if ($rID2) $flag = 1; else $flag = 0;
					}
				}
			} else {
				if (str_replace("'", "", $fabric_store_auto_update) == 1) {
					$rID_adjust = sql_update("product_details_master", $field_array_adjust, $data_array_adjust, "id", $previous_prod_id, 0);
					if ($flag == 1) {
						if ($rID_adjust) $flag = 1; else $flag = 0;
					}

					$rID2 = sql_update("product_details_master", $field_array_prod_update, $data_array_prod_update, "id", $prod_id, 0);
					if ($flag == 1) {
						if ($rID2) $flag = 1; else $flag = 0;
					}
				}
			}
		} else {
			if (str_replace("'", "", $fabric_store_auto_update) == 1) {
				$rID_adjust = sql_update("product_details_master", $field_array_adjust, $data_array_adjust, "id", $previous_prod_id, 0);
				if ($flag == 1) {
					if ($rID_adjust) $flag = 1; else $flag = 0;
				}
			}

			$rID2 = sql_insert("product_details_master", $field_array_prod, $data_array_prod, 0);
			if ($flag == 1) {
				if ($rID2) $flag = 1; else $flag = 0;
			}
		}
		if (str_replace("'", "", $fabric_store_auto_update) == 1) {
			$rID4 = sql_update("inv_transaction", $field_array_trans_update, $data_array_trans_update, "id", $update_trans_id, 0);
			if ($flag == 1) {
				if ($rID4) $flag = 1; else $flag = 0;
			}
		}
		$rID5 = sql_update("pro_grey_prod_entry_dtls", $field_array_dtls_update, $data_array_dtls_update, "id", $update_dtls_id, 0);
		if ($flag == 1) {
			if ($rID5) $flag = 1; else $flag = 0;
		}

		if (str_replace("'", "", $roll_maintained) == 1) 
		{
			/*if($not_delete_roll_table_id=="") $delete_cond=""; else $delete_cond="and id not in($not_delete_roll_table_id)";
			$delete_roll=execute_query( "delete from pro_roll_details where dtls_id=$update_dtls_id and entry_form=1 $delete_cond",0);
			if($flag==1)
			{
				if($delete_roll) $flag=1; else $flag=0;
			} */
			$txt_deleted_id = str_replace("'", "", $txt_deleted_id);
			if ($txt_deleted_id != "") {
				$field_array_status = "updated_by*update_date*status_active*is_deleted";
				$data_array_status = $_SESSION['logic_erp']['user_id'] . "*'" . $pc_date_time . "'*0*1";

				$statusChange = sql_multirow_update("pro_roll_details", $field_array_status, $data_array_status, "id", $txt_deleted_id, 0);
				if ($flag == 1) {
					if ($statusChange) $flag = 1; else $flag = 0;
				}
			}

			if (count($roll_data_array_update) > 0) {
				$rollUpdate = execute_query(bulk_update_sql_statement("pro_roll_details", "id", $field_array_roll_update, $roll_data_array_update, $roll_id_arr));
				if ($flag == 1) {
					if ($rollUpdate) $flag = 1; else $flag = 0;
				}
			}

			if ($data_array_roll != "")// && str_replace("'","",$booking_without_order)!=1
			{
				$rID6 = sql_insert("pro_roll_details", $field_array_roll, $data_array_roll, 0);
				if ($flag == 1) {
					if ($rID6) $flag = 1; else $flag = 0;
				}
			}
		}

		$delete_prop = execute_query("delete from order_wise_pro_details where dtls_id=$update_dtls_id and trans_id=$update_trans_id and entry_form=2", 0);
		if ($flag == 1) {
			if ($delete_prop) $flag = 1; else $flag = 0;
		}

		if ($data_array_prop != "" && (str_replace("'", "", $booking_without_order) != 1 || str_replace("'", "", $cbo_receive_basis) == 4)) {
			//echo "insert into order_wise_pro_details($field_array_proportionate)values".$data_array_prop;die;
			$rID7 = sql_insert("order_wise_pro_details", $field_array_proportionate, $data_array_prop, 0);
			if ($flag == 1) {
				if ($rID7) $flag = 1; else $flag = 0;
			}
		}

		if(str_replace("'","",$cbo_receive_basis)==2)
		{
			//for program status
			if($is_status_closed == 1)
			{
				$update_status = ', status = 4';
			}
			else
			{
				$update_status = ', status = 0';
			}

			$rID9 = execute_query("update ppl_planning_info_entry_dtls set is_posted_sql=2".$update_status." where id = $txt_booking_no_id");
			if ($flag == 1)
			{
				if ($rID9)
					$flag = 1;
				else
					$flag = 0;
			}
		}

		//  for accounting process rate********************************************************************************

		if (str_replace("'", "", $process_costing_maintain) == 1) {
			if (count($material_data_array_update) > 0) {
				//echo bulk_update_sql_statement( "pro_material_used_dtls", "id", $field_array_material_update, $material_data_array_update, $material_id_arr );
				$materialUpdate = execute_query(bulk_update_sql_statement("pro_material_used_dtls", "id", $field_array_material_update, $material_data_array_update, $material_id_arr));
				if ($flag == 1) {
					if ($materialUpdate) $flag = 1; else $flag = 0;
				}
			}

			if ($data_array_material_used != "") {
				//echo "insert into pro_material_used_dtls (".$field_array_material.") values ".$data_array_material_used;die;
				$rID8 = sql_insert("pro_material_used_dtls", $field_array_material, $data_array_material_used, 0);
				if ($flag == 1) {
					if ($rID8) $flag = 1; else $flag = 0;
				}
			}
			if ($material_deleted_id != "") {
				$deletedMaterial = execute_query("delete from pro_material_used_dtls where id in($material_deleted_id) and entry_form=2", 0);
				if ($flag == 1) {
					if ($deletedMaterial) $flag = 1; else $flag = 0;
				}
			}
		}
		//echo "10**".$field_array_update."<br>".$data_array_update;die;
		//echo "10**".$flag."=".$deletedMaterial.'='.$rID8.'='.$materialUpdate.'='.$rID7.'='.$delete_prop.'='.$rID6.'='.$rID5.'='.$rID4.'='.$rID2.'='.$rID."*";oci_rollback($con);die;

		if ($db_type == 0) {
			if ($flag == 1) {
				mysql_query("COMMIT");
				echo "1**" . str_replace("'", '', $update_id) . "**" . str_replace("'", '', $txt_recieved_id) . "**0**" . str_replace("'", '', $update_dtls_id) . "**" . $rr;
			} else {
				mysql_query("ROLLBACK");
				echo "6**0**0**1";
			}
		} 
		else if ($db_type == 2 || $db_type == 1) 
		{
			if ($flag == 1) {
				oci_commit($con);
				echo "1**" . str_replace("'", '', $update_id) . "**" . str_replace("'", '', $txt_recieved_id) . "**0**" . str_replace("'", '', $update_dtls_id) . "**" . $rr;
			} else {
				oci_rollback($con);
				echo "6**0**0**1";
			}
		}

		//check_table_status($_SESSION['menu_id'], 0);
		disconnect($con);
		die;
	}
}

if ($action == "grey_receive_popup_search") {
	echo load_html_head_contents("Grey Receive Info", "../../", 1, 1, '', '', '');
	extract($_REQUEST);
	?>

	<script>

		function js_set_value(id) {
			$('#hidden_recv_id').val(id);
			parent.emailwindow.hide();
		}

	</script>

</head>

<body>
	<div align="center" style="width:880px;">
		<form name="searchwofrm" id="searchwofrm">
			<fieldset style="width:875px; margin-left:5px">
				<legend>Enter search words</legend>
				<table cellpadding="0" cellspacing="0" width="820" border="1" rules="all" class="rpt_table">
					<thead>
						<th>Buyer</th>
						<th>Received Date Range</th>
						<th>Search By</th>
						<th id="search_by_td_up" width="200">Enter Receive No</th>
						<th>
							<input type="reset" name="reset" id="reset" value="Reset" style="width:100px"
							class="formbutton"/>
							<input type="hidden" name="txt_company_id" id="txt_company_id" class="text_boxes"
							value="<? echo $cbo_company_id; ?>">
							<input type="hidden" name="hidden_recv_id" id="hidden_recv_id" class="text_boxes" value="">
						</th>
					</thead>
					<tr class="general">
						<td align="center">
							<?
							echo create_drop_down("cbo_buyer_name", 150, "select buy.id, buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$cbo_company_id' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buy.buyer_name", "id,buyer_name", 1, "-- Select Buyer --", $selected, "", $data[0]);
							?>
						</td>
						<td align="center">
							<input type="text" name="txt_date_from" id="txt_date_from" class="datepicker"
							style="width:70px" readonly>To
							<input type="text" name="txt_date_to" id="txt_date_to" class="datepicker" style="width:70px"
							readonly>
						</td>
						<td align="center">
							<?
							$search_by_arr = array(1 => "Received ID", 2 => "Challan No", 3 => "Booking No", 4=>"Plan No");
							$dd = "change_search_event(this.value, '0*0*0*0', '0*0*0*0', '../../') ";
							echo create_drop_down("cbo_search_by", 150, $search_by_arr, "", 0, "--Select--", 1, $dd, 0);
							?>
						</td>
						<td align="center" id="search_by_td">
							<input type="text" style="width:130px" class="text_boxes" name="txt_search_common"
							id="txt_search_common"/>
						</td>
						<td align="center">
							<input type="button" name="button2" class="formbutton" value="Show"
							onClick="show_list_view ( document.getElementById('txt_search_common').value+'_'+document.getElementById('cbo_search_by').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('txt_company_id').value+'_'+document.getElementById('cbo_buyer_name').value+'_'+document.getElementById('cbo_year_selection').value, 'create_grey_recv_search_list_view', 'search_div', 'grey_production_entry_controller_v2', 'setFilterGrid(\'tbl_list_search\',-1);')"
							style="width:100px;"/>
						</td>
					</tr>
					<tr>
						<td colspan="5" align="center" height="40"
						valign="middle"><? echo load_month_buttons(1); ?></td>
					</tr>
				</table>
				<div style="width:100%; margin-top:15px; margin-left:3px" id="search_div" align="left"></div>
			</fieldset>
		</form>
	</div>
</body>
<script src="../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
}

if ($action == "create_grey_recv_search_list_view") {
	$data = explode("_", $data);

	$search_string 	= "%" . trim($data[0]) . "%";
	$search_by 		= $data[1];
	$start_date 	= $data[2];
	$end_date 		= $data[3];
	$company_id 	= $data[4];
	$buyer_id 		= $data[5];
	$selectedYear 	= $data[6];

	if ($buyer_id == 0) $buyer_name = ""; else $buyer_name = " and buyer_id=$buyer_id ";

	if ($start_date != "" && $end_date != "") {
		if ($db_type == 0) {
			$date_cond = "and a.receive_date between '" . change_date_format(trim($start_date), "yyyy-mm-dd", "-") . "' and '" . change_date_format(trim($end_date), "yyyy-mm-dd", "-") . "'";
		} else {
			$date_cond = "and a.receive_date between '" . change_date_format(trim($start_date), '', '', 1) . "' and '" . change_date_format(trim($end_date), '', '', 1) . "'";
		}
	} else {
		$date_cond = "";
		if($selectedYear!="")
		{
			if($db_type == 0)
			{
				$yearCond = " and a.insert_date like '%$selectedYear%'";
			} else {
				$yearCond = " and to_char(a.insert_date,'YYYY') like '%$selectedYear%'";
			}
		}
	}

	if (trim($data[0]) != "") {
		if ($search_by == 3)
			$search_field_cond = "and booking_no like '$search_string'";
		else if ($search_by == 1) {
			$search_string = "%" . trim($data[0]);
			$search_field_cond = "and recv_number like '$search_string'";
		} else if ($search_by == 4) {
			$search_field_cond ="and booking_no like '$search_string'";
		}else{
			$search_field_cond = "and challan_no like '$search_string'";
		}
	} else {
		$search_field_cond = "";
	}

	if ($db_type == 0) $year_field = "YEAR(a.insert_date) as year,";
	else if ($db_type == 2) $year_field = "to_char(a.insert_date,'YYYY') as year,";
	else $year_field = "";

	/*$sql = " select a.id, $year_field a.recv_number_prefix_num, a.recv_number, a.booking_no, a.buyer_id, a.knitting_source, a.knitting_company, a.receive_date, a.challan_no, a.within_group,c.is_sales,c.po_breakdown_id,
	sum( b.grey_receive_qnty ) grey_receive_qnty
	from inv_receive_master a,pro_grey_prod_entry_dtls b left join order_wise_pro_details c on b.id=c.dtls_id and c.status_active=1 and c.is_deleted=0
	where a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and a.company_id=$company_id $buyer_name $search_field_cond $date_cond $yearCond and a.id=b.mst_id and b.status_active=1 and b.is_deleted=0
	group by a.id, a.insert_date, a.recv_number_prefix_num, a.recv_number, a.booking_no, a.buyer_id, a.knitting_source, a.knitting_company, a.receive_date, a.challan_no, a.within_group,c.is_sales,c.po_breakdown_id";*/
	$sql = " select a.id, $year_field a.recv_number_prefix_num, a.recv_number, a.booking_no, a.buyer_id, a.knitting_source, a.knitting_company, a.receive_date, a.challan_no, a.within_group,sum( b.grey_receive_qnty ) grey_receive_qnty

	from inv_receive_master a,pro_grey_prod_entry_dtls b
	where a.id=b.mst_id and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and a.company_id=$company_id $buyer_name $search_field_cond $date_cond $yearCond  and b.status_active=1 and b.is_deleted=0
	group by a.id, a.insert_date, a.recv_number_prefix_num, a.recv_number, a.booking_no, a.buyer_id, a.knitting_source, a.knitting_company, a.receive_date, a.challan_no, a.within_group";

	$result = sql_select($sql);
	/*foreach ($result as $row)
	{
		$is_sales = $row[csf('is_sales')];
		$po_arr[$row[csf('po_breakdown_id')]] = $row[csf('po_breakdown_id')];
	}

	if(!empty($po_arr) && $is_sales == 1){
		$po_buyer = return_library_array("select id, po_buyer from fabric_sales_order_mst where id in(".implode(",", $po_arr).") and status_active=1 and is_deleted=0", 'id', 'po_buyer');
	}*/

	$buyer_arr 		= return_library_array("select id, short_name from lib_buyer", 'id', 'short_name');
	$company_arr 	= return_library_array("select id, company_short_name from lib_company", 'id', 'company_short_name');
	$supllier_arr 	= return_library_array("select id, supplier_name from lib_supplier", 'id', 'supplier_name');
	?>
	<table cellspacing="0" cellpadding="0" border="1" rules="all" width="850" class="rpt_table">
		<thead>
			<th width="40">SL</th>
			<th width="70">Received ID</th>
			<th width="60">Year</th>
			<th width="115">Booking No/ Knit Id</th>
			<th width="100">Knitting Source</th>
			<th width="110">Knitting Company</th>
			<th width="80">Receive date</th>
			<th width="80">Receive Qnty</th>
			<th width="80">Challan No</th>
			<th>Buyer</th>
		</thead>
	</table>
	<div style="width:870px; max-height:240px; overflow-y:scroll" id="list_container_batch" align="left">
		<table cellspacing="0" cellpadding="0" border="1" rules="all" width="850" class="rpt_table"
		id="tbl_list_search">
		<?
		$i = 1;
		foreach ($result as $row) {
			if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";

			if ($row[csf('knitting_source')] == 1)
			{
				$knit_comp = $company_arr[$row[csf('knitting_company')]];
			}
			else{
				$knit_comp = $supllier_arr[$row[csf('knitting_company')]];
			}
			$buyer = $buyer_arr[$row[csf('buyer_id')]];

			$recv_qnty = $row[csf('grey_receive_qnty')];

			?>
			<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
				onClick="js_set_value(<? echo $row[csf('id')]; ?>);">
				<td width="40"><? echo $i; ?></td>
				<td width="70"><p>&nbsp;<? echo $row[csf('recv_number_prefix_num')]; ?></p></td>
				<td width="60" align="center"><p><? echo $row[csf('year')]; ?></p></td>
				<td width="115"><p><? echo $row[csf('booking_no')]; ?></p></td>
				<td width="100"><p><? echo $knitting_source[$row[csf('knitting_source')]]; ?></p></td>
				<td width="110"><p><? echo $knit_comp; ?></p></td>
				<td width="80" align="center"><? echo change_date_format($row[csf('receive_date')]); ?></td>
				<td width="80" align="right"><? echo number_format($recv_qnty, 2, '.', ''); ?></td>
				<td width="80"><p><? echo $row[csf('challan_no')]; ?></p></td>
				<td><p><? echo $buyer; ?></p></td>
			</tr>
			<?
			$i++;
		}
		?>
	</table>
</div>
<?
exit();
}

if ($action == 'populate_data_from_grey_recv') {
	$data_array = sql_select("select id, recv_number, company_id, receive_basis, booking_id, booking_no, booking_without_order, buyer_id, store_id, location_id, knitting_source, sub_contract, knitting_company,knitting_location_id, receive_date, challan_no, yarn_issue_challan_no, remarks, roll_maintained,service_booking_no,service_booking_without_order, within_group from inv_receive_master where id='$data'  and status_active=1 and is_deleted=0");
	foreach ($data_array as $row) {

		$is_sales 		= $row[csf("is_sales")];
		$within_group 	= $row[csf("within_group")];
		$booking_without_order = $row[csf("booking_without_order")];
		$receive_basis  = $row[csf("receive_basis")];
		$book_plan_id = $row[csf("booking_id")];

		echo "document.getElementById('txt_recieved_id').value 				= '" . $row[csf("recv_number")] . "';\n";
		echo "document.getElementById('cbo_company_id').value 				= '" . $row[csf("company_id")] . "';\n";
		echo "document.getElementById('cbo_receive_basis').value 			= '" . $row[csf("receive_basis")] . "';\n";
		
		$buyer_td_id = create_drop_down("cbo_buyer_name", 152, "select buy.id, buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='".$row[csf("company_id")]."' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buy.buyer_name", "id,buyer_name", 1, "-- Select Buyer --", $selected, "", '');
		echo "document.getElementById('buyer_td_id').innerHTML = '".$buyer_td_id."';\n";

		echo "set_receive_basis(0);\n";
		echo "document.getElementById('txt_receive_date').value 			= '" . change_date_format($row[csf("receive_date")]) . "';\n";
		echo "document.getElementById('txt_receive_chal_no').value 			= '" . $row[csf("challan_no")] . "';\n";
		echo "document.getElementById('txt_booking_no').value 				= '" . $row[csf("booking_no")] . "';\n";
		echo "document.getElementById('txt_booking_no_id').value 			= '" . $row[csf("booking_id")] . "';\n";
		echo "document.getElementById('booking_without_order').value 		= '" . $row[csf("booking_without_order")] . "';\n";
		echo "document.getElementById('within_group').value 				= '" . $row[csf("within_group")] . "';\n";

		if ($row[csf("booking_without_order")] == 1 && $row[csf("roll_maintained")] == 0) {
			echo "$('#txt_receive_qnty').removeAttr('readonly','readonly');\n";
			echo "$('#txt_receive_qnty').removeAttr('onClick','onClick');\n";
			echo "$('#txt_receive_qnty').removeAttr('placeholder','Single Click');\n";

			echo "$('#txt_coller_cuff_size').attr('disabled',false);\n";

			echo "$('#txt_reject_fabric_recv_qnty').removeAttr('readonly','readonly');\n";
			echo "$('#txt_reject_fabric_recv_qnty').removeAttr('placeholder','Write');\n";
		} else {
			echo "$('#txt_receive_qnty').attr('readonly','readonly');\n";
			echo "$('#txt_receive_qnty').attr('onClick','openmypage_po();');\n";
			echo "$('#txt_receive_qnty').attr('placeholder','Single Click');\n";
			echo "$('#txt_coller_cuff_size').attr('disabled','disabled');\n";


			echo "$('#txt_reject_fabric_recv_qnty').attr('readonly','readonly');\n";
			echo "$('#txt_reject_fabric_recv_qnty').attr('placeholder','Display');\n";
		}

		echo "document.getElementById('cbo_knitting_source').value 			= '" . $row[csf("knitting_source")] . "';\n";

		//echo "load_drop_down( 'requires/grey_production_entry_controller_v2', " . $row[csf("knitting_source")] . "+'_'+" . $row[csf("company_id")] . ", 'load_drop_down_knitting_com','knitting_com');\n";
		
		if ($row[csf("knitting_source")] == 1) {
			$knitting_com_td_show =  create_drop_down("cbo_knitting_company", 152, "select comp.id, comp.company_name from lib_company comp where comp.status_active=1 and comp.is_deleted=0 $company_cond order by comp.company_name", "id,company_name", 1, "--Select Knit Company--", "", "load_location();load_drop_down( \'requires/grey_production_entry_controller_v2\', this.value, \'load_drop_down_floor\', \'prod_floor_td\' );load_drop_down( \'requires/grey_production_entry_controller_v2\', this.value, \'load_drop_machine\', \'machine_td\');", "");
		}else if ($row[csf("knitting_source")] == 3) {
			$knitting_com_td_show = create_drop_down("cbo_knitting_company", 152, "select a.id,a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type=20 and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id,supplier_name", 1, "--Select Knit Company--", 0, "load_location();");
		} else {
			$knitting_com_td_show = create_drop_down("cbo_knitting_company", 152, $blank_array, "", 1, "--Select Knit Company--", 0, "load_location();");
		}
		echo "document.getElementById('knitting_com').innerHTML = '".$knitting_com_td_show."';\n";


		if ($row[csf("receive_basis")] == 1 && $row[csf("booking_without_order")] != 1) {
			$job_no = return_field_value("job_no", "wo_booking_mst", "id='" . $row[csf("booking_id")] . "'");
			echo "document.getElementById('txt_job_no').value 					= '" . $job_no . "';\n";

		} else if ($row[csf("receive_basis")] == 2) {
			if($is_sales == 0){
				$job_no = return_field_value("a.job_no_mst as job_no", "wo_po_break_down a, ppl_planning_entry_plan_dtls b", "a.id=b.po_id and b.dtls_id='" . $row[csf("booking_id")] . "' group by a.job_no_mst", "job_no");
			}

		} else {
			if ($row[csf("within_group")] == 1) {
				$job_no = return_field_value("a.job_no_mst as job_no", "wo_po_break_down a, ppl_planning_entry_plan_dtls b", "a.id=b.po_id and b.dtls_id='" . $row[csf("booking_id")] . "' group by a.job_no_mst", "job_no");
			}else{
				$job_no = '';
			}
		}

		echo "document.getElementById('cbo_knitting_company').value 		= '" . $row[csf("knitting_company")] . "';\n";
		
		//echo "load_location();\n";
		$location_td= create_drop_down("cbo_location_name", 152, "select id,location_name from lib_location where company_id='".$row[csf("knitting_company")]."' $location_credential_cond and status_active =1 and is_deleted=0 order by location_name", "id,location_name", 1, "-- Select Location --", 0, "load_floor();store_load(this.value);");
		echo "document.getElementById('location_td').innerHTML = '".$location_td."';\n";


		echo "document.getElementById('cbo_com_location_name').value 			= '" . $row[csf("location_id")] . "';\n";
		echo "document.getElementById('cbo_location_name').value 			= '" . $row[csf("knitting_location_id")] . "';\n";
		echo "store_load('" . $row[csf("location_id")] . "');\n";
		
		//echo "load_floor();\n";
		if($row[csf("knitting_source")]==1)
		{
			if ($row[csf("knitting_location_id")] == 0 || $row[csf("knitting_location_id")] == "") $location_cond = ""; else $location_cond = " and b.location_id=".$row[csf("knitting_location_id")];

			$prod_floor_td= create_drop_down("cbo_floor_id", 132, "select a.id, a.floor_name from lib_prod_floor a, lib_machine_name b where a.id=b.floor_id and b.category_id=1 and b.company_id=".$row[csf("knitting_company")]." and b.status_active=1 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and a.production_process=2 $location_cond group by a.id, a.floor_name order by a.floor_name", "id,floor_name", 1, "-- Select Floor --", 0, "load_machine();", "");
		}
		else
		{
			if ($row[csf("knitting_location_id")] == 0 || $row[csf("knitting_location_id")] == "") $location_cond = ""; else $location_cond = " and b.location_id=".$row[csf("knitting_location_id")];

			$prod_floor_td= create_drop_down("cbo_floor_id", 132, "select a.id, a.floor_name from lib_prod_floor a, lib_machine_name b where a.id=b.floor_id and b.category_id=1 and b.company_id=".$row[csf("company_id")]." and b.status_active=1 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and a.production_process=2 $location_cond group by a.id, a.floor_name order by a.floor_name", "id,floor_name", 1, "-- Select Floor --", 0, "load_machine();", "");
		}
		echo "document.getElementById('prod_floor_td').innerHTML = '".$prod_floor_td."';\n";

		echo "document.getElementById('cbo_store_name').value 				= '" . $row[csf("store_id")] . "';\n";
		echo "document.getElementById('txt_service_booking').value 				= '" . $row[csf("service_booking_no")] . "';\n";
		echo "document.getElementById('service_booking_without_order').value 			= '" . $row[csf("service_booking_without_order")] . "';\n";
		if ($row[csf("knitting_source")] == 3 && $row[csf("receive_basis")] == 2) {

			if($row[csf("service_booking_without_order")]==0){

				$service_booking_id = return_field_value("id as service_booking_id", "wo_booking_mst", "booking_no='" . $row[csf("service_booking_no")] . "'", "service_booking_id");
			}else{

				$service_booking_id = return_field_value("id as service_booking_id", "wo_non_ord_knitdye_booking_mst", "booking_no='" . $row[csf("service_booking_no")] . "'", "service_booking_id");
			}
			echo "document.getElementById('service_booking_id').value 		= '" . $service_booking_id . "';\n";
		}

		echo "document.getElementById('txt_yarn_issue_challan_no').value 	= '" . $row[csf("yarn_issue_challan_no")] . "';\n";

		echo "document.getElementById('txt_remarks').value 					= '" . $row[csf("remarks")] . "';\n";
		echo "document.getElementById('cbo_sub_contract').value 					= '" . $row[csf("sub_contract")] . "';\n";
		echo "document.getElementById('update_id').value 					= '" . $row[csf("id")] . "';\n";
		echo "$('#cbo_company_id').attr('disabled','disabled')" . ";\n";
		echo "$('#cbo_receive_basis').attr('disabled','disabled')" . ";\n";
		echo "$('#txt_booking_no').attr('disabled','disabled')" . ";\n";
		echo "$('#cbo_com_location_name').attr('disabled','disabled')" . ";\n";

		echo "set_button_status(0, '" . $_SESSION['page_permission'] . "', 'fnc_grey_production_entry',1);\n";

	}

	if ($receive_basis == 4) // Sales Order
	{
		if ($within_group == 1) 
		{
			$buyer_name = return_field_value("company_short_name", "lib_company", "id='" . $row[csf("buyer_id")] . "'");
			echo "$('#cbo_buyer_name option[value!=0]').remove();\n";
			echo "$('#txt_reject_fabric_recv_qnty').attr('readonly','readonly');\n";
			echo "$('#cbo_buyer_name').append('<option selected value=" . $row[csf('buyer_id')] . ">" . $buyer_name . "</option>');\n";
		} 
		else 
		{
			echo "document.getElementById('cbo_buyer_name').value 				= '" . $row[csf("buyer_id")] . "';\n";
		}
	} 
	else 
	{
		if ($receive_basis == 2 && $within_group == 1) 
		{
			//echo "'string-1<br>$within_group'\n";
			$fso_info = sql_select("select d.po_buyer,d.po_job_no
				from pro_grey_prod_entry_dtls b,order_wise_pro_details c,fabric_sales_order_mst d
				where b.mst_id=$data and b.id=c.dtls_id and c.po_breakdown_id=d.id and b.status_active=1 and c.status_active=1 and c.entry_form=2 and d.status_active=1");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $fso_info[0][csf("po_buyer")]);
			echo "$('#cbo_buyer_name option[value!=0]').remove();\n";
			echo "$('#txt_reject_fabric_recv_qnty').attr('readonly','readonly');\n";
			echo "$('#cbo_buyer_name').append('<option selected value=" . $fso_info[0][csf("po_buyer")] . ">" . $buyer_name . "</option>');\n";
			$job_no = $fso_info[0][csf("po_job_no")];
			echo "document.getElementById('txt_job_no').value 					= '" . $job_no . "';\n";
		} 
		else 
		{
			//echo "string-2<br>";
			if ($receive_basis == 2 && $booking_without_order == 1) // Program without order
			{
				//echo "'string-3=$within_group=$receive_basis=$booking_without_order';\n";
				echo "document.getElementById('cbo_buyer_name').value 				= '" . $row[csf("buyer_id")] . "';\n";
			}
			else if ($receive_basis == 1 && $booking_without_order == 1) // booking basis without order
			{
				//echo "'string-4<br>$within_group'\n";
				$buyer_id = return_field_value("buyer_id", "wo_non_ord_samp_booking_mst", "booking_no='" . $row[csf("booking_no")] . "'");
				echo "document.getElementById('cbo_buyer_name').value 				= '" . $buyer_id . "';\n";
			} 
			else 
			{
				//echo "'string-5=$within_group=$receive_basis=$booking_without_order';\n";
				echo "document.getElementById('cbo_buyer_name').value 				= '" . $row[csf("buyer_id")] . "';\n";
			}
		}
	}

	if($receive_basis == 2)
	{
		if ($db_type == 0) {
			$reqsn_dataArray = sql_select("select a.knit_id, group_concat(distinct(b.id)) as yarn_prod_id from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.knit_id = $book_plan_id and a.status_active=1 and a.is_deleted=0 group by a.knit_id");
		} else {
			$reqsn_dataArray = sql_select("select a.knit_id, LISTAGG(b.id, ',') WITHIN GROUP (ORDER BY b.id) as yarn_prod_id from ppl_yarn_requisition_entry a, product_details_master b where a.prod_id=b.id and a.knit_id = $book_plan_id and a.status_active=1 and a.is_deleted=0 group by a.knit_id");
		}
		foreach ($reqsn_dataArray as $row) {
			$yarn_prod_id = $row[csf('yarn_prod_id')];
		}
	}

	echo "document.getElementById('yarn_prod_id').value	= '" . $yarn_prod_id . "';\n";

	exit();
}

if ($action == "show_grey_prod_listview") 
{
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$machine_arr = return_library_array("select id, machine_no from lib_machine_name", "id", "machine_no");
	$user_arr = return_library_array("select id, user_name from user_passwd", "id", "user_name");
	$fabric_desc_arr = return_library_array("select id, item_description from product_details_master where item_category_id=13", "id", "item_description");
	$composition_arr = array();
	$sql_deter = "select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
	$data_array = sql_select($sql_deter);
	if (count($data_array) > 0) {
		foreach ($data_array as $row) {
			if (array_key_exists($row[csf('id')], $composition_arr)) {
				$composition_arr[$row[csf('id')]] = $composition_arr[$row[csf('id')]] . " " . $composition[$row[csf('copmposition_id')]] . " " . $row[csf('percent')] . "%";
			} else {
				$composition_arr[$row[csf('id')]] = $row[csf('construction')] . ", " . $composition[$row[csf('copmposition_id')]] . " " . $row[csf('percent')] . "%";
			}
		}
	}

	$sql = "SELECT id, prod_id, body_part_id, febric_description_id, gsm, width, grey_receive_qnty, reject_fabric_receive, uom, yarn_lot, no_of_roll, brand_id, shift_name, machine_no_id, inserted_by from pro_grey_prod_entry_dtls where mst_id='$data' and status_active = '1' and is_deleted = '0'";
	$result = sql_select($sql);

	?>
	<table cellspacing="0" cellpadding="0" border="1" rules="all" width="950" class="rpt_table">
		<thead>
			<th width="80">Body Part</th>
			<th width="140">Fabric Description</th>
			<th width="40">GSM</th>
			<th width="60">Dia / Width</th>
			<th width="80">Grey Recv. Qnty</th>
			<th width="80">Reject Feb. Qty</th>
			<th width="30">UOM</th>
			<th width="80">Yarn Lot</th>
			<th width="60">No of Roll</th>
			<th width="70">Brand</th>
			<th width="60">Shift Name</th>
			<th width="70">Machine No</th>
			<th>User Name</th>
		</thead>
	</table>
	<div style="width:950px; max-height:200px; overflow-y:scroll" id="list_container_batch" align="left">
		<table cellspacing="0" cellpadding="0" border="1" rules="all" width="930" class="rpt_table" id="list_view">
			<?
			$i = 1;
			foreach ($result as $row) 
			{
				if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";

				if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "")
					$fabric_desc = $fabric_desc_arr[$row[csf('prod_id')]];
				else
					$fabric_desc = $composition_arr[$row[csf('febric_description_id')]];
				?>
				<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
					onClick="put_data_dtls_part(<? echo $row[csf('id')]; ?>,'populate_grey_details_form_data', 'requires/grey_production_entry_controller_v2');">
					<td width="80"><p><? echo $body_part[$row[csf('body_part_id')]]; ?></p></td>
					<td width="140"><p><? echo $fabric_desc; ?></p></td>
					<td width="40"><p><? echo $row[csf('gsm')]; ?>&nbsp;</p></td>
					<td width="60"><p><? echo $row[csf('width')]; ?>&nbsp;</p></td>
					<td width="80" align="right"><? echo number_format($row[csf('grey_receive_qnty')], 2); ?></td>
					<td width="80" align="right"><? echo number_format($row[csf('reject_fabric_receive')], 2); ?>
				&nbsp;</td>
				<td width="30"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?>&nbsp;</p></td>
				<td width="80"><p><? echo $row[csf('yarn_lot')]; ?>&nbsp;</p></td>
				<td width="60"><p><? echo $row[csf('no_of_roll')]; ?>&nbsp;</p></td>
				<td width="70"><p><? echo $brand_arr[$row[csf('brand_id')]]; ?></p></td>
				<td width="60"><p><? echo $shift_name[$row[csf('shift_name')]]; ?></p></td>
				<td width="70"><p><? echo $machine_arr[$row[csf('machine_no_id')]]; ?>&nbsp;</p></td>
				<td><p><? echo $user_arr[$row[csf('inserted_by')]]; ?>&nbsp;</p></td>
			</tr>
			<?
			$i++;
		}
		?>
	</table>
	</div>
	<?
	exit();
}

if ($action == 'populate_grey_details_form_data') 
{
	$data = explode("**", $data);
	$id = $data[0];
	//$roll_maintained=$data[1];
	$roll_maintained = return_field_value("roll_maintained as roll_maintained", "inv_receive_master a, pro_grey_prod_entry_dtls b ", "a.id=b.mst_id and b.id='$id'", "roll_maintained");
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$body_part_type_arr = return_library_array("select id, body_part_type from lib_body_part", 'id', 'body_part_type');

	$data_array = sql_select("select id, body_part_id, trans_id, prod_id, febric_description_id, no_of_roll, gsm, width, grey_receive_qnty,grey_receive_qnty_pcs, reject_fabric_receive, uom, yarn_lot,yarn_prod_id, yarn_count, brand_id, shift_name, floor_id, machine_no_id, order_id, room, rack, self, store_floor, color_id, color_range_id, stitch_length, machine_dia, machine_gg,operator_name, yarn_rate, kniting_charge, order_yarn_rate, order_knitting_charge,coller_cuff_size, rate from pro_grey_prod_entry_dtls where id='$id' and status_active=1 and is_deleted=0");
	foreach ($data_array as $row) {
		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				$comp = $determination_sql[0][csf('construction')] . ", ";
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}

		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');
		$body_part_id=$body_part_type_arr[$row[csf("body_part_id")]];


		echo "document.getElementById('cbo_body_part').value 				= '" . $row[csf("body_part_id")] . "';\n";
		echo "document.getElementById('body_part_type_id').value 				= '" . $body_part_id . "';\n";
		echo "document.getElementById('txt_fabric_description').value 		= '" . $comp . "';\n";
		echo "document.getElementById('fabric_desc_id').value 				= '" . $row[csf("febric_description_id")] . "';\n";
		echo "document.getElementById('txt_gsm').value 						= '" . $row[csf("gsm")] . "';\n";
		echo "document.getElementById('txt_width').value 					= '" . $row[csf("width")] . "';\n";
		echo "document.getElementById('txt_roll_no').value 					= '" . $row[csf("no_of_roll")] . "';\n";
		echo "document.getElementById('txt_receive_qnty').value 			= '" . number_format($row[csf("grey_receive_qnty")] ,2,'.',''). "';\n";
		echo "document.getElementById('txt_receive_qnty_pcs').value 		= '" . $row[csf("grey_receive_qnty_pcs")] . "';\n";
		echo "document.getElementById('txt_coller_cuff_size').value 		= '" . $row[csf("coller_cuff_size")] . "';\n";

		echo "document.getElementById('previous_receive_qnty').value 		= '" . $row[csf("grey_receive_qnty")] . "';\n";
		echo "document.getElementById('txt_reject_fabric_recv_qnty').value 	= '" . $row[csf("reject_fabric_receive")] . "';\n";
		echo "document.getElementById('txt_color').value 					= '" . $color . "';\n";
		echo "document.getElementById('color_id').value 					= '" . $row[csf("color_id")] . "';\n";
		echo "document.getElementById('cbo_color_range').value 				= '" . $row[csf("color_range_id")] . "';\n";
		echo "document.getElementById('txt_stitch_length').value 			= '" . $row[csf("stitch_length")] . "';\n";
		echo "document.getElementById('txt_machine_dia').value 				= '" . $row[csf("machine_dia")] . "';\n";
		echo "document.getElementById('txt_machine_gg').value 				= '" . $row[csf("machine_gg")] . "';\n";
		echo "document.getElementById('cbo_uom').value 						= '" . $row[csf("uom")] . "';\n";
		echo "document.getElementById('txt_yarn_lot').value 				= '" . $row[csf("yarn_lot")] . "';\n";


		echo "document.getElementById('yarn_prod_id').value 				= '" . $row[csf("yarn_prod_id")] . "';\n";
		echo "document.getElementById('cbo_yarn_count').value 				= '" . $row[csf("yarn_count")] . "';\n";
		echo "set_multiselect('cbo_yarn_count','0','1','" . $row[csf('yarn_count')] . "','0');\n";
		echo "document.getElementById('txt_brand').value 					= '" . $brand_arr[$row[csf("brand_id")]] . "';\n";
		echo "document.getElementById('txt_shift_name').value 				= '" . $row[csf("shift_name")] . "';\n";
		echo "document.getElementById('cbo_floor_id').value 				= '" . $row[csf("floor_id")] . "';\n";

		echo "load_machine(".$row[csf("machine_no_id")].");\n";
		echo "load_operator();\n";

		//echo "populate_operator();\n";
		$operatorName = return_field_value("first_name", "lib_employee", "id=" . $row[csf('operator_name')]);
		echo "document.getElementById('txt_operator_id').value 				= '" . $row[csf("operator_name")] . "';\n";
		echo "document.getElementById('txt_operator_name').value 			= '" . $operatorName . "';\n";
		

		$order_ids=rtrim($row[csf("order_id")],',');
		echo "document.getElementById('cbo_machine_name').value 			= '" . $row[csf("machine_no_id")] . "';\n";
		echo "document.getElementById('cbo_floor').value 					= '" . $row[csf("store_floor")] . "';\n";
		echo "document.getElementById('cbo_room').value 					= '" . $row[csf("room")] . "';\n";
		echo "document.getElementById('txt_rack').value 					= '" . $row[csf("rack")] . "';\n";
		echo "document.getElementById('txt_shelf').value 					= '" . $row[csf("self")] . "';\n";
		//echo "document.getElementById('txt_binbox').value 					= '" . $row[csf("bin_box")] . "';\n";
		echo "document.getElementById('hidden_receive_qnty').value 			= '" . $row[csf("grey_receive_qnty")] . "';\n";
		echo "document.getElementById('hidden_receive_rate').value 			= '" . $row[csf("rate")] . "';\n";
		echo "document.getElementById('all_po_id').value 					= '" . $order_ids . "';\n";
		echo "document.getElementById('previous_prod_id').value 			= '" . $row[csf("prod_id")] . "';\n";
		echo "document.getElementById('update_dtls_id').value 				= '" . $row[csf("id")] . "';\n";
		echo "document.getElementById('update_trans_id').value 				= '" . $row[csf("trans_id")] . "';\n";
		echo "document.getElementById('txt_deleted_id').value 				= '';\n";
		$knittin_charge_string=$row[csf("kniting_charge")]."*".$row[csf("order_knitting_charge")]."*".$row[csf("yarn_rate")]."*".$row[csf("order_yarn_rate")];
		echo "document.getElementById('knitting_charge_string').value 				= '".$knittin_charge_string."';\n";

		$save_string = '';
		if ($roll_maintained == 1) 
		{
			/*$data_roll_array = sql_select("SELECT id, roll_used, po_breakdown_id, qnty,qc_pass_qnty_pcs, roll_no, barcode_no, reject_qnty,coller_cuff_size,rf_id from pro_roll_details where dtls_id='$id' and entry_form=2 and status_active=1 and is_deleted=0 order by id");
			foreach ($data_roll_array as $row_roll) 
			{
				if ($row_roll[csf('roll_used')] == 1) $roll_id = $row_roll[csf('id')]; else $roll_id = 0;
				//$roll_id=$row_roll[csf('id')];

				if ($save_string == "") 
				{
					$save_string = $row_roll[csf("po_breakdown_id")] . "**" . number_format($row_roll[csf("qnty")],2,'.','') . "**" . $row_roll[csf("reject_qnty")] . "**" . $row_roll[csf("roll_no")] . "**" . $roll_id . "**" . $row_roll[csf("id")] . "**" . $row_roll[csf("barcode_no")] . "**" . $row_roll[csf("qc_pass_qnty_pcs")]. "**" . $row_roll[csf("coller_cuff_size")]. "**" . $row_roll[csf("rf_id")];
				} 
				else 
				{
					$save_string .= "," . $row_roll[csf("po_breakdown_id")] . "**" . number_format($row_roll[csf("qnty")],2,'.','') . "**" . $row_roll[csf("reject_qnty")] . "**" . $row_roll[csf("roll_no")] . "**" . $roll_id . "**" . $row_roll[csf("id")] . "**" . $row_roll[csf("barcode_no")] . "**" . $row_roll[csf("qc_pass_qnty_pcs")]. "**" . $row_roll[csf("coller_cuff_size")]. "**" . $row_roll[csf("rf_id")];
				}
			}*/
			$data_roll_array = sql_select("SELECT a.id, c.job_no, c.style_ref_no, a.roll_used, a.po_breakdown_id, a.qnty, a.qc_pass_qnty_pcs, a.roll_no, a.barcode_no, a.reject_qnty, a.coller_cuff_size, a.rf_id 
			from pro_roll_details a, wo_po_break_down b, wo_po_details_master c
			where a.is_sales=0 and a.booking_without_order=0 and a.po_breakdown_id=b.id and b.job_id=c.id and a.dtls_id='$id' and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 
			union all
			SELECT a.id, b.job_no, b.style_ref_no, a.roll_used, a.po_breakdown_id, a.qnty, a.qc_pass_qnty_pcs, a.roll_no, a.barcode_no, a.reject_qnty, a.coller_cuff_size, a.rf_id
			from pro_roll_details a, fabric_sales_order_mst b
			where a.is_sales=1 and a.booking_without_order=0 and a.po_breakdown_id=b.id and a.dtls_id='$id' and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 
			union all
			SELECT a.id, b.booking_no as job_no, null as style_ref_no, a.roll_used, a.po_breakdown_id, a.qnty, a.qc_pass_qnty_pcs, a.roll_no, a.barcode_no, a.reject_qnty, a.coller_cuff_size, a.rf_id 
			from pro_roll_details a, wo_non_ord_samp_booking_mst b
			where a.is_sales in (0,2) and a.booking_without_order=1 and a.po_breakdown_id=b.id and a.dtls_id='$id' and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 
			order by id");

			foreach ($data_roll_array as $row_roll) 
			{
				if ($row_roll[csf('roll_used')] == 1) $roll_id = $row_roll[csf('id')]; else $roll_id = 0;

				if ($save_string == "") 
				{
					$save_string = $row_roll[csf("po_breakdown_id")] . "**" . number_format($row_roll[csf("qnty")],2,'.','') . "**" . $row_roll[csf("reject_qnty")] . "**" . $row_roll[csf("roll_no")] . "**" . $roll_id . "**" . $row_roll[csf("id")] . "**" . $row_roll[csf("barcode_no")] . "**" . $row_roll[csf("qc_pass_qnty_pcs")]. "**" . $row_roll[csf("coller_cuff_size")]. "**" . $row_roll[csf("rf_id")];
				} 
				else 
				{
					$save_string .= "," . $row_roll[csf("po_breakdown_id")] . "**" . number_format($row_roll[csf("qnty")],2,'.','') . "**" . $row_roll[csf("reject_qnty")] . "**" . $row_roll[csf("roll_no")] . "**" . $roll_id . "**" . $row_roll[csf("id")] . "**" . $row_roll[csf("barcode_no")] . "**" . $row_roll[csf("qc_pass_qnty_pcs")]. "**" . $row_roll[csf("coller_cuff_size")]. "**" . $row_roll[csf("rf_id")];
				}


				if ($save_string_stylewise == "") 
				{
					$save_string_stylewise = $row_roll[csf("job_no")] . "**" . number_format($row_roll[csf("qnty")],2,'.','') . "**" . $row_roll[csf("reject_qnty")] . "**" . $row_roll[csf("roll_no")] . "**" . $roll_id . "**" . $row_roll[csf("id")] . "**" . $row_roll[csf("barcode_no")] . "**" . $row_roll[csf("qc_pass_qnty_pcs")]. "**" . $row_roll[csf("coller_cuff_size")]. "**" . $row_roll[csf("rf_id")]. "**" . $row_roll[csf("style_ref_no")];
				} 
				else 
				{
					$save_string_stylewise .= "," . $row_roll[csf("job_no")] . "**" . number_format($row_roll[csf("qnty")],2,'.','') . "**" . $row_roll[csf("reject_qnty")] . "**" . $row_roll[csf("roll_no")] . "**" . $roll_id . "**" . $row_roll[csf("id")] . "**" . $row_roll[csf("barcode_no")] . "**" . $row_roll[csf("qc_pass_qnty_pcs")]. "**" . $row_roll[csf("coller_cuff_size")]. "**" . $row_roll[csf("rf_id")]. "**" . $row_roll[csf("style_ref_no")];
				}
			}
		} 
		else 
		{
			$data_po_array = sql_select("SELECT id, po_breakdown_id, quantity, quantity_pcs, returnable_qnty,coller_cuff_size from order_wise_pro_details where dtls_id='$id' and entry_form=2 and status_active=1 and is_deleted=0");
			foreach ($data_po_array as $row_po) 
			{
				if ($save_string == "") 
				{
					$save_string = $row_po[csf("po_breakdown_id")] . "**" . $row_po[csf("quantity")] . "**" . $row_po[csf("returnable_qnty")] . "**" . 0 . "**" . 0 . "**" . $row_po[csf("id")] . "**" . 0 . "**" . $row_po[csf("quantity_pcs")]. "**" . $row_po[csf("coller_cuff_size")]. "**" . 0;
				} 
				else 
				{
					$save_string .= "," . $row_po[csf("po_breakdown_id")] . "**" . $row_po[csf("quantity")] . "**" . $row_po[csf("returnable_qnty")] . "**" . 0 . "**" . 0 . "**" . $row_po[csf("id")] . "**" . 0 . "**" . $row_po[csf("quantity_pcs")]. "**" . $row_po[csf("coller_cuff_size")]. "**" . 0;
				}
			}
		}

		echo "document.getElementById('save_data').value 				= '" . $save_string . "';\n";
		echo "document.getElementById('save_data_stylewise').value 				= '" . $save_string_stylewise . "';\n";

		//echo "$('#txt_yarn_lot').removeAttr('disabled','disabled');\n";
		if ($roll_maintained == 1)
		{
			$nxt_process = sql_select("select a.barcode_no from pro_roll_details a, pro_roll_details b where a.dtls_id = $id and a.barcode_no = b.barcode_no and a.entry_form = 2 and a.status_active = 1 and a.is_deleted = 0 and b.entry_form != 2 and b.status_active = 1 and b.is_deleted = 0");
			if(!empty($nxt_process))
			{
				//echo "$('#txt_yarn_lot').attr('disabled','disabled');\n";
				echo "$('#next_process_check').val('1');\n";
				echo "$('#txt_stitch_length').attr('disabled','disabled');\n";
			}
		}
		else
		{
			echo "$('#txt_yarn_lot').removeAttr('disabled','disabled');\n";
			echo "$('#txt_stitch_length').removeAttr('disabled','disabled');\n";
		}
		echo "$('#cbo_machine_name').attr('disabled','disabled');\n";

		echo "disable_enable_fields('cbo_com_location_name*cbo_company_id*cbo_com_location_name*txt_receive_date*cbo_location_name*cbo_store_name*txt_service_booking*txt_gsm*txt_width*txt_shift_name*cbo_floor_id*txt_stitch_length*cbo_machine_name*txt_color*txt_yarn_lot*cbo_color_range*show_textcbo_yarn_count*txt_brand*cbo_uom*cbo_floor*cbo_room*txt_rack*txt_shelf*txt_roll_no',1);\n";


		echo "set_button_status(1, '" . $_SESSION['page_permission'] . "', 'fnc_grey_production_entry',1);\n";
		exit();
	}
}

if ($action == "roll_duplication_check") {
	$data = explode("**", $data);
	$po_id = $data[0];
	$roll_no = trim($data[1]);
	$roll_id = $data[2];

	if ($roll_id == "" || $roll_id == "0") {
		$sql = "select a.recv_number from inv_receive_master a, pro_roll_details b where a.id=b.mst_id and b.po_breakdown_id='$po_id' and b.roll_no='$roll_no' and a.is_deleted=0 and a.status_active=1 and b.entry_form=2 and b.is_deleted=0 and b.status_active=1";
	} else {
		$sql = "select a.recv_number from inv_receive_master a, pro_roll_details b where a.id=b.mst_id and b.po_breakdown_id='$po_id' and b.roll_no='$roll_no' and a.is_deleted=0 and a.status_active=1 and b.entry_form=2 and b.id<>$roll_id and b.is_deleted=0 and b.status_active=1";
	}
	//echo $sql;
	$data_array = sql_select($sql, 1);
	if (count($data_array) > 0) {
		echo "1" . "_" . $data_array[0][csf('recv_number')];
	} else {
		echo "0_";
	}

	exit();
}

if ($action == "roll_maintained") {
	/*$variable_data=sql_select("select variable_list, fabric_roll_level, smv_source from variable_settings_production where company_name ='$data' and variable_list in(3,27) and is_deleted=0 and status_active=1");
	foreach($variable_data as $row)
	{
		if($row[csf('variable_list')]==3)
		{
			$roll_maintained=$row[csf('fabric_roll_level')];
		}
		else
		{
			$barcode_generation=$row[csf('smv_source')];
		}
	}*/

	/*$barcode_generation = return_field_value("smv_source", "variable_settings_production", "company_name ='$data' and variable_list=27 and is_deleted=0 and status_active=1");
	if ($barcode_generation == 2) $barcode_generation = $barcode_generation; else $barcode_generation = 1;*/

	$roll_maintained = '';
	$fabric_store_auto_update = '';
	$production_control = '';
	$hidden_qc_result = '';
	/*$fabricData = sql_select("select variable_list, auto_update, fabric_roll_level from variable_settings_production where company_name ='$data' and variable_list in(3,15,35) and item_category_id=13 and is_deleted=0 and status_active=1");
	foreach ($fabricData as $row) {
		if ($row[csf('variable_list')] == 3) {
			$roll_maintained = $row[csf('fabric_roll_level')];
		} else if ($row[csf('variable_list')] == 15) {
			$fabric_store_auto_update = $row[csf('auto_update')];
		} else {
			$production_control = $row[csf('auto_update')];
		}
	}*/


	$varialbe_production_sql = sql_select("select variable_list, distribute_qnty, smv_source, auto_update, fabric_roll_level, item_category_id,hide_qc_result from variable_settings_production where company_name ='$data' and variable_list in(3,15,27,51,62) and is_deleted=0 and status_active=1");

	foreach ($varialbe_production_sql as $row) 
	{
		if ($row[csf('variable_list')] == 27) 
		{
			if($row[csf('smv_source')] ==2)
			{
				$barcode_generation = $row[csf('smv_source')];
			}else{
				// $barcode_generation =1;
				$barcode_generation =$row[csf('smv_source')];
			}
		}

		if ($row[csf('item_category_id')] == 13) 
		{
			if ($row[csf('variable_list')] == 3) 
			{
				$roll_maintained = $row[csf('fabric_roll_level')];
			}
			else if ($row[csf('variable_list')] == 15) 
			{
				$fabric_store_auto_update = $row[csf('auto_update')];
			}
		}

		if ($row[csf('item_category_id')] == 1) 
		{
			if ($row[csf('variable_list')] == 51) 
			{
				$production_control = $row[csf('auto_update')];
			}
		}
		if ($row[csf('variable_list')] == 62) 
		{
			$hidden_qc_result = $row[csf('hide_qc_result')];
		}
	}

	//$roll_maintained=return_field_value("fabric_roll_level","variable_settings_production","company_name ='$data' and variable_list=3 and is_deleted=0 and status_active=1");
	//$fabric_store_auto_update=return_field_value("auto_update","variable_settings_production","company_name ='$data' and variable_list=15 and item_category_id=13 and is_deleted=0 and status_active=1");

	$variable_inventory_sql=sql_select("select store_method, rack_balance from variable_settings_inventory  where company_name=$data and item_category_id=13 and variable_list=21 and status_active=1 and is_deleted=0 and rack_balance=1");
	$store_method=$variable_inventory_sql[0][csf("store_method")];
	if($store_method=="") $store_method=0;

	if ($roll_maintained == 1) $roll_maintained = $roll_maintained; else $roll_maintained = 0;
	//if ($fabric_store_auto_update == 2) $fabric_store_auto_update = 0; else $fabric_store_auto_update = 1;
	if($fabric_store_auto_update==1) $fabric_store_auto_update=$fabric_store_auto_update; else $fabric_store_auto_update=0;
	if ($production_control == 1) {$production_control = $production_control;} else {$production_control = 0;}
	if ($barcode_generation =="") {$barcode_generation=0;}
	if ($hidden_qc_result =="") {$hidden_qc_result=0;}
	if ($hidden_qc_result == 1) 
	{
		echo "$('#knit_defect').hide();\n";
	}
	else
	{
		echo "$('#knit_defect').show().css('width', '200px');\n";
	}
	echo "document.getElementById('roll_maintained').value 					= '" . $roll_maintained . "';\n";
	echo "document.getElementById('barcode_generation').value 				= '" . $barcode_generation . "';\n";
	echo "document.getElementById('fabric_store_auto_update').value 		= '" . $fabric_store_auto_update . "';\n";
	echo "document.getElementById('production_control').value 				= '" . $production_control . "';\n";
	echo "document.getElementById('store_update_upto').value 				= '" . $store_method . "';\n";

	echo "reset_form('greyproductionentry_1','list_fabric_desc_container','','','set_receive_basis();','update_id*txt_recieved_id*cbo_company_id*cbo_receive_basis*txt_receive_date*txt_receive_chal_no*cbo_store_name*cbo_knitting_source*cbo_knitting_company*txt_remarks*roll_maintained*barcode_generation*fabric_store_auto_update*store_update_upto*production_control*txt_yarn_issue_challan_no*txt_shift_name*txt_width*txt_gsm*cbo_floor_id*cbo_machine_name*txt_room*txt_rack*txt_reject_fabric_recv_qnty*txt_shelf*cbo_uom*txt_binbox*txt_yarn_lot*cbo_yarn_count*txt_brand*txt_stitch_length*txt_machine_dia*txt_machine_gg*txt_color*cbo_color_range*hidden_qc_result');\n";
	exit();
}


if ($action == "process_costing_maintain") {
	$process_costing_maintain = 0;

	$variable_data = sql_select("select variable_list, process_costing_maintain from variable_settings_production where company_name ='$data' and variable_list=34 and is_deleted=0 and status_active=1");

	foreach ($variable_data as $row) 
	{
		echo "document.getElementById('process_costing_maintain').value='" . $row[csf('process_costing_maintain')] . "';\n";
		$process_costing_maintain = $row[csf('process_costing_maintain')];
	}
	if ($process_costing_maintain == 1) 
	{
		echo "$('#txt_yarn_lot').attr('readonly', 'readonly');\n";
		echo "$('#txt_yarn_lot').attr('placeholder', 'Browse');\n";
		echo "$('#txt_yarn_lot').attr('onclick', 'proces_costing_popup()');\n";
	} 
	else 
	{
		echo "$('#txt_yarn_lot').removeAttr('readonly');\n";
		echo "$('#txt_yarn_lot').removeAttr('placeholder');\n";
		echo "$('#txt_yarn_lot').removeAttr('onclick');\n";
	}
	exit();
}

if ($action == "load_color") {
	$data = explode("**", $data);
	$booking_id = $data[0];
	$is_sample = $data[1];
	$receive_basis = $data[2];

	if ($receive_basis == 1) {
		if ($is_sample == 0) {
			$sql = "select c.color_name from wo_booking_mst a, wo_booking_dtls b, lib_color c where a.booking_no=b.booking_no and b.fabric_color_id=c.id and a.id=$booking_id and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.fabric_color_id, c.color_name";
		} else {
			$sql = "select c.color_name from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b, lib_color c where a.booking_no=b.booking_no and b.fabric_color=c.id and a.id=$booking_id and a.item_category=2 and b.fabric_source=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.fabric_color, c.color_name";
		}
	} else {
		$sql = "select c.color_name from wo_booking_mst a, wo_booking_dtls b, lib_color c, ppl_planning_info_entry_mst d, ppl_planning_info_entry_dtls e where d.id=e.mst_id and  a.booking_no=b.booking_no and a.booking_no=d.booking_no and b.fabric_color_id=c.id and e.id=$booking_id and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.fabric_color_id, c.color_name";
	}
	//echo $sql;die;
	echo "var str_color = [" . substr(return_library_autocomplete($sql, "color_name"), 0, -1) . "];\n";
	echo "$('#txt_color').autocomplete({
		source: str_color
	});\n";
	exit();
}

if ($action == "issue_challan_no_popup") {
	echo load_html_head_contents("Issue Challan Info", "../../", 1, 1, '', '', '');
	extract($_REQUEST);
	?>
	<script>

		function js_set_value(id) {
			$('#issue_challan').val(id);
			parent.emailwindow.hide();
		}
	</script>
	<input type="hidden" name="issue_challan" id="issue_challan" value=""/>
	<?
	if ($db_type == 0) {
		$year_cond = "year(insert_date) as year";
	} else if ($db_type == 2) {
		$year_cond = "TO_CHAR(insert_date,'YYYY') as year";
	}
	if ($receive_basis == 2) {
		$sql = "select a.issue_number_prefix_num,a. issue_number,b.requisition_no ,TO_CHAR(a.insert_date,'YYYY') as year from inv_issue_master a,inv_transaction b where a.id=b.mst_id and b.requisition_no='$req_no' and a.company_id=$cbo_company_id and a.status_active=1 and a.is_deleted=0 order by a.issue_number_prefix_num DESC";
	} else {
		$sql = "select issue_number_prefix_num, issue_number, $year_cond from inv_issue_master where booking_id=$booking_id and company_id=$cbo_company_id and entry_form=3 and status_active=1 and is_deleted=0 order by issue_number_prefix_num DESC";
	}

	//$sql="select issue_number_prefix_num, issue_number, $year_cond from inv_issue_master where company_id=$cbo_company_id and entry_form=3 and status_active=1 and is_deleted=0 order by issue_number_prefix_num DESC";
	echo create_list_view("tbl_list_search", "System ID, Challan No,Year", "150,80,70", "380", "350", 0, $sql, "js_set_value", "issue_number_prefix_num", "", 1, "0,0,0", $arr, "issue_number,issue_number_prefix_num,year", "", 'setFilterGrid("tbl_list_search",-1);', '0,0,0', '', 0);
	exit();
}

if ($action == "operator_name_popup") {
	echo load_html_head_contents("Operator Name Info", "../../", 1, 1, '', '', '');
	extract($_REQUEST);
	?>
	<script>

		function js_set_value(id) {
			$('#operator_hdn').val(id);
			parent.emailwindow.hide();
		}
	</script>
	<input type="hidden" name="operator_hdn" id="operator_hdn" value=""/>
	<?
		$sql = "select id, first_name from lib_employee where  company_id=$cbo_knitting_company and location_id=$cbo_location_name and status_active=1 and is_deleted=0 order by first_name";//$cbo_company_id

	echo create_list_view("tbl_list_search", "Operator Name", "150", "270", "160", 0, $sql, "js_set_value", "id,first_name", "", 1, "0", $arr, "first_name", "", 'setFilterGrid("tbl_list_search",-1);', '0', '', 0);
	exit();
}

if ($action =="load_operator_name") {

	//$operator_name= return_field_value("first_name","lib_employee","id_card_no ='$data' and designation_id in (1113, 1115) and is_deleted=0 and status_active=1"); 
	$dataArr = explode("_",$data);
	$id_card_no = $dataArr[0];
	$machine_id = $dataArr[1];

	$machine_data = sql_select("select pipe_weight as PIPE_WEIGHT from lib_machine_name where id='" . $machine_id. "'");
	$operator_sql = sql_select("SELECT id, first_name from lib_employee where id_card_no ='$id_card_no' and designation_id in (1113, 1115) and is_deleted=0 and status_active=1");
	
	if(!empty($operator_sql))
	{
		echo $operator_sql[0][csf("id")]."**".$operator_sql[0][csf("first_name")]."**".$machine_data[0]['PIPE_WEIGHT'];
	}else{
		echo "0";
	}
	exit();
	
}

if ($action == "color_popup") {
	echo load_html_head_contents("Color Info", "../../", 1, 1, '', '', '');
	extract($_REQUEST);
	?>
	<script>

		$(document).ready(function (e) {
			setFilterGrid('tbl_list_search', -1);
			set_all();
		});

		var selected_id = new Array();
		var selected_name = new Array();

		function check_all_data(is_checked) {
			var tbl_row_count = document.getElementById('tbl_list_search').rows.length;
			tbl_row_count = tbl_row_count - 1;

			for (var i = 1; i <= tbl_row_count; i++) {
				js_set_value(i);
			}
		}

		function toggle(x, origColor) {
			var newColor = 'yellow';
			if (x.style) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor ) ? origColor : newColor;
			}
		}

		function set_all() {
			var old = document.getElementById('txt_color_row_id').value;
			if (old != "") {
				old = old.split(",");
				for (var i = 0; i < old.length; i++) {
					js_set_value(old[i])
				}
			}
		}

		function js_set_value(str) {
			toggle(document.getElementById('search' + str), '#FFFFCC');

			if (jQuery.inArray($('#txt_individual_id' + str).val(), selected_id) == -1) {
				selected_id.push($('#txt_individual_id' + str).val());
				selected_name.push($('#txt_individual' + str).val());
			}
			else {
				for (var i = 0; i < selected_id.length; i++) {
					if (selected_id[i] == $('#txt_individual_id' + str).val()) break;
				}
				selected_id.splice(i, 1);
				selected_name.splice(i, 1);
			}
			var id = '';
			var name = '';
			for (var i = 0; i < selected_id.length; i++) {
				id += selected_id[i] + ',';
				name += selected_name[i] + ',';
			}
			id = id.substr(0, id.length - 1);
			name = name.substr(0, name.length - 1);

			$('#hidden_color_id').val(id);
			$('#hidden_color_no').val(name);
		}

	</script>
	<input type="hidden" name="hidden_color_id" id="hidden_color_id" value=""/>
	<input type="hidden" name="hidden_color_no" id="hidden_color_no" value=""/>
	<div>
		<table cellspacing="0" cellpadding="0" border="1" rules="all" width="340" class="rpt_table">
			<thead>
				<th width="50">SL</th>
				<th>Color Name</th>
			</thead>
		</table>
		<div style="width:340px; max-height:280px; overflow-y:scroll">
			<table cellspacing="0" cellpadding="0" border="1" rules="all" width="320" class="rpt_table"
			id="tbl_list_search">
			<?php
			$i = 1;
			$color_row_id = "";
			$color_id = explode(",", $color_id);
			if ($recieve_basis == 1) {
				if ($booking_without_order == 0) {
					$sql = "select c.id, c.color_name from wo_booking_mst a, wo_booking_dtls b, lib_color c where a.booking_no=b.booking_no and b.fabric_color_id=c.id and a.id=$booking_id and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by c.id, c.color_name";
				} else {
					$sql = "select c.id, c.color_name from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b, lib_color c where a.booking_no=b.booking_no and b.fabric_color=c.id and a.id=$booking_id and a.item_category=2 and b.fabric_source=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by c.id, c.color_name
					union

					SELECT c.id, c.color_name from   wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b, lib_color c  ,sample_development_rf_color d where a.booking_no=b.booking_no and d.fabric_color=c.id and a.id=$booking_id and d.mst_id=b.style_id and d.status_active=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by c.id, c.color_name";
				}
			} else if ($recieve_basis == 2) {
					//$sql="select c.id, c.color_name from lib_color c, ppl_planning_info_entry_mst d, ppl_planning_info_entry_dtls e where d.id=e.mst_id and e.color_id=c.id and e.id=$booking_id and e.status_active=1 and e.is_deleted=0 and d.status_active=1 and d.is_deleted=0 group by c.id, c.color_name";

				$plan_info = sql_select("select booking_no,po_id,is_sales from ppl_planning_entry_plan_dtls where dtls_id=$booking_id");
				if(!empty($plan_info)){
					$is_salesOrder = $plan_info[0][csf("is_sales")];
					$order_id = $plan_info[0][csf("po_id")];
					$booking_no = $plan_info[0][csf("booking_no")];
					if ($is_salesOrder == 1) {
						$sql = "select c.id,c.color_name from fabric_sales_order_dtls b,lib_color c where b.color_id=c.id and b.mst_id=$order_id and b.status_active=1 and b.is_deleted=0 group by c.id, c.color_name";
					}else{
						$sql = "select c.id, c.color_name from wo_booking_mst a, wo_booking_dtls b, lib_color c, ppl_planning_info_entry_mst d, ppl_planning_info_entry_dtls e where d.id=e.mst_id and a.booking_no=b.booking_no and a.booking_no=d.booking_no and b.fabric_color_id=c.id and e.id=$booking_id and a.item_category=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by c.id, c.color_name";
					}
				}
			} else if ($recieve_basis == 4) {
				$sql = "select c.id, c.color_name from fabric_sales_order_dtls b, lib_color c where b.color_id=c.id and b.mst_id=$booking_id and b.status_active=1 and b.is_deleted=0 group by c.id, c.color_name";
			} else {
				$sql = "select id, color_name from lib_color where status_active=1 and is_deleted=0 order by color_name";
			}
			$nameArray = sql_select($sql);
			foreach ($nameArray as $selectResult) {
				if ($i % 2 == 0)
					$bgcolor = "#E9F3FF";
				else
					$bgcolor = "#FFFFFF";

				if (in_array($selectResult[csf('id')], $color_id)) {
					if ($color_row_id == "") $color_row_id = $i; else $color_row_id .= "," . $i;
				}
				?>
				<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
					id="search<? echo $i; ?>" onClick="js_set_value(<? echo $i; ?>)">
					<td width="50" align="center"><?php echo "$i"; ?>
					<input type="hidden" name="txt_individual_id" id="txt_individual_id<?php echo $i; ?>"
					value="<?php echo $selectResult[csf('id')]; ?>"/>
					<input type="hidden" name="txt_individual" id="txt_individual<?php echo $i; ?>"
					value="<?php echo $selectResult[csf('color_name')]; ?>"/>
				</td>
				<td><p><?php echo $selectResult[csf('color_name')]; ?></p></td>
			</tr>
			<?
			$i++;
		}
		?>
		<input type="hidden" name="txt_color_row_id" id="txt_color_row_id"
		value="<?php echo $color_row_id; ?>"/>
	</table>
</div>
<table width="340" cellspacing="0" cellpadding="0" border="1" align="center">
	<tr>
		<td align="center" height="30" valign="bottom">
			<div style="width:100%">
				<div style="width:45%; float:left" align="left">
					<input type="checkbox" name="check_all" id="check_all"
					onClick="check_all_data(this.checked)"/> Check / Uncheck All
				</div>
				<div style="width:55%; float:left" align="left">
					<input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton"
					value="Close" style="width:100px"/>
				</div>
			</div>
		</td>
	</tr>
</table>
</div>
<?
exit();
}

if ($action == "yarn_lot_popup") {
	echo load_html_head_contents("Yarn Lot Info", "../../", 1, 1, '', '', '');
	extract($_REQUEST);
	//echo $fabric_description_id;die;
	$row_cond = "";
	$row_limit = "";
	if ($db_type == 0) {
		$txt_receive_date = change_date_format($txt_receive_date, 'yyyy-mm-dd', '-');
		$row_limit = " limit 1";
	} else {
		$txt_receive_date = change_date_format($txt_receive_date, 'yyyy-mm-dd', '-', 1);
		$row_cond = " and rownum=1";
	}

	if($txt_service_booking!=""){
		//echo $txt_service_booking;die;
		$precost_exchange_rate = return_field_value("exchange_rate", "wo_booking_mst", "booking_no='$txt_service_booking'");
		//echo $precost_exchange_rate;die;
	}else if ($recieve_basis == 1 && $booking_without_order == 1) {
		$precost_exchange_rate = return_field_value("exchange_rate", "wo_non_ord_samp_booking_mst", "id='$booking_id'");
	} else {
		$precost_exchange_rate = return_field_value("exchange_rate", "wo_pre_cost_mst", "job_no='$txt_job_no'");
	}
	//echo "==".$precost_exchange_rate;die;
	$exchange_rate = sql_select("select conversion_rate,max(con_date) con_date from currency_conversion_rate where con_date<='$txt_receive_date' and currency=2  $row_cond group by conversion_rate,con_date order by con_date desc $row_limit");

	$vari_knit_charge_source_arr = sql_select("select editable from  variable_order_tracking where company_name='$cbo_company_id' and variable_list=70 and status_active=1");
	if($vari_knit_charge_source_arr[0][csf("editable")] == 2)
	{
		$vari_knit_charge_source = $vari_knit_charge_source_arr[0][csf("editable")];
	}else{
		$vari_knit_charge_source = 1;
	}

	?>
	<script>

		function fnc_process_cost() {
			var vari_knit_charge_source = "<? echo $vari_knit_charge_source?>";
			var process_string = "";
			var knitting_rate_string = "";
			var receive_qty = "<? echo $txt_receive_qnty; ?>";
			var precost_exchange_rate = "<? echo $precost_exchange_rate; ?>";
			var exchange_rate =<? echo $exchange_rate[0][csf('conversion_rate')]; ?>;
			var rate_with_knitting_charge = 0;
			var total_amount = 0;
			var total_lot = "";
			var total_yarn_prod_id = "";
			var total_count = "";
			var total_brand = "";
			var brand_name = "";
			var all_deleted_id = "";
			var total_used_qty = 0;
			var tempCountId = '';

			if($("#txt_knitting_charge_taka").val() * 1 <= 0 && vari_knit_charge_source ==2)
			{
				alert("Knitting Charge Needed");
				return;
			}

			var yarn_count_arr = new Array(); var i=0; var total_percentage=0;
			$("#tbl_lot_list").find('tr').each(function () {
				var txt_used = ($(this).find('input[name="txt_used_qty[]"]').val()) * 1;
				if (txt_used > 0) {
					total_used_qty = total_used_qty + txt_used;
					var txt_prod_id = $(this).find('input[name="txt_prod_id[]"]').val();
					var txt_cons_rate = $(this).find('input[name="txt_cons_rate[]"]').val();
					var txt_net_used = $(this).find('input[name="txt_net_used[]"]').val();
					var txt_material_update_id = $(this).find('input[name="update_material_id[]"]').val();
					var lot_id = $(this).find('input[name="txt_lot[]"]').val();
					var brand = $(this).find('input[name="txt_brand[]"]').val();
					var yarn_count_id = $(this).find('input[name="txt_yarn_count_id[]"]').val();

					var txt_yarn_percentage = $(this).find('input[name="txt_yarn_percentage[]"]').val();
					var txt_process_loss = $(this).find('input[name="txt_process_loss[]"]').val();

					total_percentage += txt_yarn_percentage*1;

					if (trim(lot_id) != "") {
						if (trim(total_lot) != "") total_lot = total_lot + "," + lot_id;
						else                     total_lot = lot_id;
					}

					if (trim(txt_prod_id) != "") {
						if (trim(total_yarn_prod_id) != "") total_yarn_prod_id = total_yarn_prod_id + "," + txt_prod_id;
						else                     total_yarn_prod_id = txt_prod_id;
					}

					if (trim(yarn_count_id) != "") {
						yarn_count_id = trim(yarn_count_id);
						/*tempCountId = yarn_count_id;
						if ( (trim(total_count) != "") && (yarn_count_id!=tempCountId) )
						{
							total_count = total_count + "," + yarn_count_id;
						}
						else
						{
							total_count = yarn_count_id;
						}*/


						if(yarn_count_arr.indexOf(yarn_count_id) != -1)
						{

						}
						else
						{
							yarn_count_arr[i] = yarn_count_id;

							if(total_count ==""){
								total_count = yarn_count_id;
							}else{
								total_count = total_count + "," + yarn_count_id;
							}
						}
					}
					i++;
					//alert(total_count);
					//alert(yarn_count_arr.length);
					if (trim(brand) != "") {
						if (trim(total_brand) != "") total_brand = total_brand + "," + brand;
						else                      total_brand = brand;
					}

					var txt_yarn_cost = txt_cons_rate * txt_used;

					total_amount += txt_yarn_cost;
					var yarn_rate = txt_yarn_cost / txt_net_used;

					if (trim(process_string) == "") {
						process_string = txt_prod_id + "*" + txt_used + "*" + txt_cons_rate + "*" + txt_material_update_id + "*" + txt_yarn_percentage + "*" + txt_process_loss;
					}
					else {
						process_string = process_string + "__" + txt_prod_id + "*" + txt_used + "*" + txt_cons_rate + "*" + txt_material_update_id + "*" + txt_yarn_percentage + "*" + txt_process_loss;
					}
				}
				else {
					if ($(this).find('input[name="update_material_id[]"]').val() > 0) {
						if (trim(all_deleted_id) != "") {
							all_deleted_id = all_deleted_id = "," + $(this).find('input[name="update_material_id[]"]').val();
						}
						else {
							all_deleted_id = $(this).find('input[name="update_material_id[]"]').val();
						}
					}
				}
			});

			if(total_percentage >100){
				alert("Total Yarn Percentage Must be Less or equal to 100");
				return;
			}

			if (total_brand != "") {
				total_brand = total_brand.split(",");
				if (total_brand.length == 1) brand_name = total_brand[0];
				else                      brand_name = "";
				;
			}

			if (total_used_qty < receive_qty) {
				alert("Total Used Qty Must be Greater or Equal to Receive Qty.");
				return;
			}

			var total_rate = total_amount / receive_qty;
			var total_rate_usd = total_rate / exchange_rate;

			if(vari_knit_charge_source ==1)
			{
				var knitting_charge = $("#txt_knitting_charge").val() * 1;
				var knitting_charge_taka = knitting_charge * precost_exchange_rate;
			}
			else
			{
				//N. B. as saved taka need to show so other currency data will come runtime calc as discussed
				var knitting_charge_taka = $("#txt_knitting_charge_taka").val() * 1; 
				var knitting_charge = knitting_charge_taka / precost_exchange_rate;;
			}
			

			rate_with_knitting_charge = total_rate + knitting_charge_taka;
			knitting_rate_string = knitting_charge_taka + "*" + knitting_charge + "*" + total_rate + "*" + total_rate_usd + "*" + total_lot + "*" + total_count + "*" + brand_name + "*" + all_deleted_id + "*" + total_yarn_prod_id;
            // alert(knitting_rate_string);return;
            $('#hidden_process_string').val(process_string);
            $('#hidden_knitting_rate').val(knitting_rate_string);
            parent.emailwindow.hide();
        }


        function calculate_net_qty(yarn_percentage, id, receive_qty) {
        	if (yarn_percentage > 100) {
        		alert("Yarn Percentage Must be Less or equal to 100");
        		$("#txt_yarn_percentage_" + id).val('');
        		$("#net_used_td_" + id).text("");
            	$("#txt_net_used" + id).val("");
            	$("#txt_used_qty_" + id).val("");
        		tot_calculate();
        		return;
        	}

        	var tot_yarn_perc=0;
        	$("#tbl_lot_list").find('tbody tr').each(function(index, element) {
				tot_yarn_perc += $(this).find('input[name="txt_yarn_percentage[]"]').val()*1;
            });

        	if (tot_yarn_perc > 100) 
        	{
        		alert("Total Yarn Percentage Must be Less or equal to 100");
        		$("#txt_yarn_percentage_" + id).val('');
        		$("#net_used_td_" + id).text("");
            	$("#txt_net_used" + id).val("");
            	$("#txt_used_qty_" + id).val("");
        		tot_calculate();
        		return;
        	}

        	var process_loss = $("#txt_process_loss_" + id).val();
        	var calculateed_net_used = (receive_qty * yarn_percentage) / 100;
            //alert(calculateed_net_used)
            $("#net_used_td_" + id).text(calculateed_net_used);
            $("#txt_net_used" + id).val(calculateed_net_used);
            var used_qty = 0;
            used_qty = (100 / (100 - process_loss)) * calculateed_net_used;
            $("#txt_used_qty_" + id).val(used_qty);
            tot_calculate();
        }


        function calculate_used_qty(process_loss, id, receive_qty) {
        	var yarn_percentage = $("#txt_yarn_percentage_" + id).val();
        	if (yarn_percentage > 100) {
        		alert("Yarn Percentage Must be Less or equal to 100");
        		$("#txt_yarn_percentage_" + id).val('');
        		tot_calculate();
        		return;
        	}

        	var calculateed_net_used = (receive_qty * yarn_percentage) / 100;
            //alert(calculateed_net_used)
            $("#net_used_td_" + id).text(calculateed_net_used);
            $("#txt_net_used" + id).val(calculateed_net_used);
            var used_qty = 0;
            used_qty = (100 / (100 - process_loss)) * calculateed_net_used;
            $("#txt_used_qty_" + id).val(used_qty);
            tot_calculate();
        }

        function tot_calculate()
        {
        	var tot_net_qnty=0;
        	var tot_used_qnty=0;
        	$("#tbl_lot_list").find('tbody tr').each(function(index, element) 
        	{
				tot_net_qnty += $(this).find('input[name="txt_net_used[]"]').val()*1;
				tot_used_qnty += $(this).find('input[name="txt_used_qty[]"]').val()*1;
            });
        	tot_used_qnty = number_format(tot_used_qnty,4);
        	$("#tot_net_qnty").text(tot_net_qnty);
        	$("#tot_used_qnty").text(tot_used_qnty);

        }
    </script>
    <input type="hidden" name="hidden_process_string" id="hidden_process_string" value=""/>
    <input type="hidden" name="hidden_knitting_rate" id="hidden_knitting_rate" value=""/>

    <div>
    	<?
		/*
				$sql = "
					select
						a.id, a.booking_no, a.buyer_id, a.body_part_id, a.determination_id, a.fabric_desc, a.gsm_weight, a.dia, b.fabric_dia, b.color_range,
						b.color_id, b.id as knit_id, b.knitting_source, b.knitting_party, b.stitch_length, b.machine_dia, b.machine_gg,
						c.po_id 
					from
						ppl_planning_info_entry_mst a,
						ppl_planning_info_entry_dtls b,
						ppl_planning_entry_plan_dtls c
					where
						a.id=b.mst_id and b.id=c.dtls_id and a.company_id = ".$company_id." and a.buyer_id like '".$buyer_id."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.is_sales = 2 $search_field_cond 
					group by
						b.id, b.knitting_source, b.knitting_party, b.stitch_length, b.color_range, b.color_id, b.fabric_dia, b.machine_dia, b.machine_gg, a.id, a.booking_no, a.buyer_id, a.body_part_id, a.determination_id, a.fabric_desc, a.gsm_weight, a.dia,c.po_id 
					order by
						b.id desc";
		*/
		
		/*
			N. B. 12/09/2020 (tofael) Library->varriable->merchandising->Knitting Charge Source is YARN COUNT DETERMINATION then knitting_charge will come from Library->Merchandising details->Yarn Count Determination page process loss break up popup with determitaion id which is editable here.

		*/
		
    	$yarn_count_arr = return_library_array("select id,yarn_count from lib_yarn_count", 'id', 'yarn_count');
    	$brand_arr = return_library_array("select id,brand_name  from  lib_brand", 'id', 'brand_name');
    	if($txt_service_booking!=""){
    		$conversion_cost = sql_select("select sum(a.amount)/ sum(a.wo_qnty) as charge_unit from wo_booking_dtls a , wo_pre_cost_fab_conv_cost_dtls b, wo_pre_cost_fabric_cost_dtls c where a.pre_cost_fabric_cost_dtls_id=b.id and b.cons_process=1 and b.fabric_description=c.id and c.lib_yarn_count_deter_id=".$fabric_description_id." and a.booking_no='".$txt_service_booking."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and c.status_active=1 and b.is_deleted=0 and c.is_deleted=0");

    	}else if ($recieve_basis == 1 && $booking_without_order == 1) {
    		$conversion_cost = sql_select("select a.id,b.rate as charge_unit from wo_non_ord_samp_booking_mst a,wo_non_ord_samp_booking_dtls b where a.booking_no =b.booking_no and a.id=$booking_id and b.lib_yarn_count_deter_id=" . $fabric_description_id . " and a.status_active=1 and b.status_active=1");
    	} else {
    		$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=$booking_id");
			if ($is_salesOrder == 1) {
    		} else if($is_salesOrder == 2){
				$conversion_cost = sql_select("select a.id,b.rate as charge_unit from wo_non_ord_samp_booking_mst a, wo_non_ord_samp_booking_dtls b , ppl_planning_info_entry_mst c, ppl_planning_info_entry_dtls d where a.booking_no = b.booking_no and b.booking_no = c.booking_no and c.id = d.mst_id and d.id=$booking_id and b.lib_yarn_count_deter_id=" . $fabric_description_id . " and a.status_active=1 and b.status_active=1");
			} else{
    			$conversion_cost = sql_select("select a.id,a.charge_unit from  wo_pre_cost_fab_conv_cost_dtls a,wo_pre_cost_fabric_cost_dtls b where a.job_no='$txt_job_no' and a.fabric_description=b.id and a.job_no=b.job_no and b.lib_yarn_count_deter_id=" . $fabric_description_id . " and a.cons_process in (1,3,4) order by id");
    			//echo "select a.id,a.charge_unit from  wo_pre_cost_fab_conv_cost_dtls a,wo_pre_cost_fabric_cost_dtls b where a.job_no='$txt_job_no' and a.fabric_description=b.id and a.job_no=b.job_no and b.lib_yarn_count_deter_id=" . $fabric_description_id . " and a.cons_process in (1,3,4) order by id";
    		}
    	}
    	$processloss_sql = sql_select("select process_loss, rate, process_id from conversion_process_loss where  mst_id=" .$fabric_description_id ." and process_id in (1,3,4) and status_active=1 and is_deleted=0");
    	foreach ($processloss_sql as $val) 
    	{
    		$process_loss += $val[csf('process_loss')];
    		if($val[csf('process_id')] == 1)
    		{
    			$deter_knitting_rate = $val[csf('rate')];
    		}
    	}
    	//$process_loss = $processloss_sql[0][csf('process_loss')];  $vari_knit_charge_source


    	if (empty($process_loss)) $process_loss = 0;
    	?>
    	<table cellspacing="0" cellpadding="0" border="0" rules="all" width="840" class="" align="center">
    		<tr>
    			<td colspan="5" align="center" style="font-size:16px"><strong>Knitting Process Loss: <?php echo $process_loss . " %"; ?></strong>
    			</td>
    			<td colspan="5" align="center" style="font-size:16px">
    				<strong>Knitting Charge:
    					<?php 
    					if($vari_knit_charge_source == 1)
    					{
    						echo number_format($conversion_cost[0][csf('charge_unit')] * $precost_exchange_rate, 2) . ""; 
    						?>
    						<input type="hidden" name="txt_knitting_charge_taka" id="txt_knitting_charge_taka" class="text_boxes_numeric" value="<? echo number_format($conversion_cost[0][csf('charge_unit')] * $precost_exchange_rate, 2,'.',''); ?>">
    						<?
    					}
    					else
    					{
    						if(str_replace("'","",$update_dtls_id) != "")
    						{
    							$knitting_charge_string = str_replace("'","",$knitting_charge_string);
    							$knitting_charge_string_arr = explode("*", $knitting_charge_string);
    							$knitting_charge_taka = $knitting_charge_string_arr[0]*1;
    						}else{
    							$knitting_charge_taka = $deter_knitting_rate;
    						}
    						
    						?>
    						<input type="text" name="txt_knitting_charge_taka" id="txt_knitting_charge_taka" class="text_boxes_numeric" value="<? echo $knitting_charge_taka; ?>">
    						<?
    					}
    					?>
    					 Tk./Kg
    				</strong>
    			</td>
    		</tr>
    	</table>

    	<table cellspacing="0" cellpadding="0" border="1" rules="all" width="860" class="rpt_table">
    		<thead>
    			<th width="30">SL</th>
    			<th width="50">Prod Id</th>
    			<th width="80">Lot</th>
    			<th width="50">Count</th>
    			<th width="120">Composition</th>
    			<th width="60">Type</th>
    			<th width="70">Brand</th>
    			<th width="50">Yarn %</th>
    			<th width="100">Avg Yarn Rate /Kg (Tk.)</th>
    			<th width="60">Net Qty</th>
    			<th width="70">Process Loss %</th>
    			<th>Used Qty</th>
    		</thead>
    	</table>
    	<div style="width:860px; max-height:280px; overflow-y:scroll">
    		<table cellspacing="0" cellpadding="0" border="1" rules="all" width="840" class="rpt_table"
    		id="tbl_lot_list">
    		<?php
    		$i = 1;
    		$update_dtls_id=str_replace("'","",$update_dtls_id);
    		$next_process_check=str_replace("'","",$next_process_check);
    		if(($update_dtls_id!=0 || $update_dtls_id!="") && $next_process_check==1) $disable_con="disabled";else $disable_con="";
			$sql_determination = sql_select("select b.count_id,b.type_id, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $fabric_description_id . "");
    		$serch_count_arr = array();
    		$serch_composition_arr = array();
    		$serch_type_arr = array();
    		$determination_arr = array();
    		foreach ($sql_determination as $inv) {
    			$serch_count_arr[] = $inv[csf('count_id')];
    			$serch_composition_arr[] = $inv[csf('copmposition_id')];
    			$serch_type_arr[] = $inv[csf('type_id')];
    			$determination_arr[$inv[csf('count_id')]][$inv[csf('copmposition_id')]][$inv[csf('type_id')]] = $inv[csf('percent')];
    		}
    		$sql_cond = "";
    		if ($serch_count_arr > 0) $sql_cond = " and c.yarn_count_id in (" . implode(",", $serch_count_arr) . ") ";
    		if ($serch_composition_arr > 0) $sql_cond .= " and c.yarn_comp_type1st in (" . implode(",", $serch_composition_arr) . ") ";
    		if ($serch_type_arr > 0) $sql_cond .= " and c.yarn_type in (" . implode(",", $serch_type_arr) . ") ";
    		if ($recieve_basis == 1) {
    			if ($booking_without_order == 0) {
    				$sql = "select c.id,c.lot,c.brand, c.yarn_count_id, c.yarn_comp_type1st, c.yarn_comp_percent1st, c.yarn_comp_type2nd, c.yarn_comp_percent2nd, c.yarn_type,sum(b.cons_quantity) issue_qty,sum(b.cons_amount) cons_amount from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_id=$booking_id and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by c.id,c.lot,c.brand,c.supplier_id, c.yarn_count_id, c.yarn_comp_type1st, c.yarn_comp_percent1st, c.yarn_comp_type2nd, c.yarn_comp_percent2nd, c.yarn_type";


    			} else {
    				$sql = "select c.id,c.lot,c.brand, c.yarn_count_id, c.yarn_comp_type1st, c.yarn_comp_percent1st, c.yarn_comp_type2nd, c.yarn_comp_percent2nd, c.yarn_type,sum(b.cons_quantity) issue_qty,sum(b.cons_amount) cons_amount from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_no='$txt_booking_no' and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by c.id,c.lot,c.brand,c.supplier_id, c.yarn_count_id, c.yarn_comp_type1st, c.yarn_comp_percent1st, c.yarn_comp_type2nd, c.yarn_comp_percent2nd, c.yarn_type";
    			}
    		} else if ($recieve_basis == 2) {
    			$reqsition_sql = sql_select("select  requisition_no from ppl_yarn_requisition_entry where knit_id='$booking_id'");
    			$reqsition_number = "";
    			foreach ($reqsition_sql as $inf) {
    				if (trim($reqsition_number) != "") {
    					$reqsition_number .= ",'" . $inf[csf('requisition_no')] . "'";
    				} else {
    					$reqsition_number = "'" . $inf[csf('requisition_no')] . "'";
    				}
    			}

    			$sql = "select c.id,c.lot,c.brand, c.yarn_count_id, c.yarn_comp_type1st, c.yarn_comp_percent1st, c.yarn_comp_type2nd, c.yarn_comp_percent2nd, c.yarn_type,sum(b.cons_quantity) issue_qty,sum(b.cons_amount) cons_amount from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and b.requisition_no in($reqsition_number) and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1 and b.status_active=1 and b.is_deleted=0 group by c.id, c.lot, c.brand, c.supplier_id, c.yarn_count_id, c.yarn_comp_type1st, c.yarn_comp_percent1st, c.yarn_comp_type2nd, c.yarn_comp_percent2nd, c.yarn_type";
    		}
			
			//echo $sql;
    		if ($update_dtls_id != "") {
    			$update_sql = sql_select("select id,prod_id,used_qty,rate,amount,yarn_percentage,porcess_loss from pro_material_used_dtls where mst_id=$update_id and dtls_id =$update_dtls_id");
    			$update_data_arr = array();
    			foreach ($update_sql as $val) {
    				$update_data_arr[$val[csf('prod_id')]]['prod_id'] = $val[csf('prod_id')];
    				$update_data_arr[$val[csf('prod_id')]]['id'] = $val[csf('id')];
    				$update_data_arr[$val[csf('prod_id')]]['used_qty'] = $val[csf('used_qty')];
    				$update_data_arr[$val[csf('prod_id')]]['rate'] = $val[csf('rate')];
    				$update_data_arr[$val[csf('prod_id')]]['yarn_percentage'] = $val[csf('yarn_percentage')];
    				$update_data_arr[$val[csf('prod_id')]]['porcess_loss'] = $val[csf('porcess_loss')];
    				$update_data_arr[$val[csf('prod_id')]]['amount'] = $val[csf('amount')];
    				$check_arr[] = $val[csf('prod_id')];
    			}
    		}
				//echo $sql;
    		$nameArray = sql_select($sql);
    		foreach ($nameArray as $row) {
    			if ($i % 2 == 0)
    				$bgcolor = "#E9F3FF";
    			else
    				$bgcolor = "#FFFFFF";

    			$composition_string = $composition[$row[csf('yarn_comp_type1st')]] . " " . $row[csf('yarn_comp_percent1st')] . "%";
    			if ($row[csf('yarn_comp_type2nd')] != 0) $composition_string .= " " . $composition[$row[csf('yarn_comp_type2nd')]] . " " . $row[csf('yarn_comp_percent2nd')] . "%";
    			$yarn_percentage = $determination_arr[$row[csf('yarn_count_id')]][$row[csf('yarn_comp_type1st')]][$row[csf('yarn_type')]];
    			$net_used = ($txt_receive_qnty * $yarn_percentage) / 100;
    			$process_loss_used = ($net_used * 100) / (100 - $process_loss);
    			if (in_array($row[csf("id")], $check_arr)) {
    				$update_process_loss_used = $update_data_arr[$row[csf('id')]]['used_qty'];
    				$update_yarn_percentage = $update_data_arr[$row[csf('id')]]['yarn_percentage'];

    				$net_used = ($txt_receive_qnty * $update_yarn_percentage) / 100;
    				if (empty($update_yarn_percentage)) $update_yarn_percentage = $yarn_percentage;

    				?>
    				<tr bgcolor="#FFFF99" style="text-decoration:none; cursor:pointer" id="search<? echo $i; ?>">
    					<td width="30" align="center"><?php echo "$i"; ?>
    					<input type="hidden" name="update_material_id[]" id="update_material_id<?php echo $i; ?>" value="<?php echo $update_data_arr[$row[csf('id')]]['id']; ?>"/>
    					<input type="hidden" name="txt_net_used[]" id="txt_net_used<?php echo $i; ?>" value="<?php echo $net_used; ?>"/>
    					<input type="hidden" name="txt_cons_rate[]" id="txt_cons_rate<?php echo $i; ?>" value="<?php echo $update_data_arr[$row[csf('id')]]['rate']; ?>"/>
    					<input type="hidden" name="txt_prod_id[]" id="txt_prod_id<?php echo $i; ?>" value="<?php echo $row[csf('id')]; ?>"/>
    					<input type="hidden" name="txt_yarn_count_id[]" id="txt_yarn_count_id<?php echo $i; ?>" value="<?php echo $row[csf('yarn_count_id')]; ?>"/>
    					<input type="hidden" name="txt_brand[]" id="txt_brand<?php echo $i; ?>" value="<?php echo $brand_arr[$row[csf('brand')]]; ?>"/> <input type="hidden" name="txt_lot[]" id="txt_lot<?php echo $i; ?>" value="<?php echo $row[csf('lot')]; ?>"/>

    				</td>
    				<td width="50"><p><?php echo $row[csf('id')]; ?></p></td>
    				<td width="80"><p><?php echo $row[csf('lot')]; ?></p></td>
    				<td width="50"><p><?php echo $yarn_count_arr[$row[csf('yarn_count_id')]]; ?></p></td>
    				<td width="120"><p><?php echo $composition_string; ?></p></td>
    				<td width="60"><p><?php echo $yarn_type[$row[csf('yarn_type')]]; ?></p></td>
    				<td width="70"><p><?php echo $brand_arr[$row[csf('brand')]]; ?></p></td>
    				<td width="50" align="right">
    					<input type="text" id="txt_yarn_percentage_<? echo $i; ?>"
    					name="txt_yarn_percentage[]" style="width:35px"
    					class="text_boxes_numeric"
    					value="<?php echo $update_data_arr[$row[csf('id')]]['yarn_percentage']; ?>"
    					onKeyUp="calculate_net_qty(this.value,<? echo $i; ?>,<? echo $txt_receive_qnty; ?>)" <? echo $disable_con;?>/>
    				</td>
    				<td width="100" align="right">
    					<p><?php echo number_format($update_data_arr[$row[csf('id')]]['rate'],2); ?></p>
    				</td>
    				<td width="70" align="right" id="net_used_td_<? echo $i; ?>">
    					<p><?php echo number_format($net_used, 4, ".", ""); ?></p>
    				</td>
    				<td width="70" align="right">
    					<input type="text" id="txt_process_loss_<? echo $i; ?>" name="txt_process_loss[]" style="width:35px" class="text_boxes_numeric"
    					value="<?php echo $update_data_arr[$row[csf('id')]]['porcess_loss']; ?>" onKeyUp="calculate_used_qty(this.value,<? echo $i; ?>,<? echo $txt_receive_qnty; ?>)" <? echo $disable_con;?>/>
    				</td>
    				<td align="right"><input type="text" id="txt_used_qty_<? echo $i; ?>" name="txt_used_qty[]" style="width:60px" class="text_boxes_numeric" value="<? echo number_format($update_process_loss_used, 4, ".", ""); ?>" <? echo $disable_con;?>/>
    				</td>
    			</tr>
    			<?
    			$i++;
    		} else {
    			?>
    			<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
    				id="search<? echo $i; ?>">
    				<td width="30" align="center"><?php echo "$i"; ?>
    				<input type="hidden" name="update_material_id[]"
    				id="update_material_id<?php echo $i; ?>" value="0"/>
    				<input type="hidden" name="txt_net_used[]" id="txt_net_used<?php echo $i; ?>"
    				value="<?php echo $net_used; ?>"/>
    				<input type="hidden" name="txt_cons_rate[]" id="txt_cons_rate<?php echo $i; ?>"
    				value="<?php echo $row[csf('cons_amount')] / $row[csf('issue_qty')]; ?>"/>
    				<input type="hidden" name="txt_prod_id[]" id="txt_prod_id<?php echo $i; ?>"
    				value="<?php echo $row[csf('id')]; ?>"/>
    				<input type="hidden" name="txt_yarn_count_id[]" id="txt_yarn_count_id<?php echo $i; ?>"
    				value="<?php echo $row[csf('yarn_count_id')]; ?>"/>
    				<input type="hidden" name="txt_brand[]" id="txt_brand<?php echo $i; ?>"
    				value="<?php echo $brand_arr[$row[csf('brand')]]; ?>"/>
    				<input type="hidden" name="txt_lot[]" id="txt_lot<?php echo $i; ?>"
    				value="<?php echo $row[csf('lot')]; ?>"/>
    			</td>
    			<td width="50"><p><?php echo $row[csf('id')]; ?></p></td>
    			<td width="80"><p><?php echo $row[csf('lot')]; ?></p></td>
    			<td width="50"><p><?php echo $yarn_count_arr[$row[csf('yarn_count_id')]]; ?></p></td>
    			<td width="120"><p><?php echo $composition_string; ?></p></td>
    			<td width="60"><p><?php echo $yarn_type[$row[csf('yarn_type')]]; ?></p></td>
    			<td width="70"><p><?php echo $brand_arr[$row[csf('brand')]]; ?></p></td>
    			<td width="50" align="right"><input type="text" id="txt_yarn_percentage_<? echo $i; ?>"
    				name="txt_yarn_percentage[]" style="width:35px"
    				class="text_boxes_numeric"
    				value="<? echo number_format($yarn_percentage, 2, ".", ""); ?>"
    				onKeyUp="calculate_net_qty(this.value,<? echo $i; ?>,<? echo $txt_receive_qnty; ?>)" <? echo $disable_con;?>/>
    			</td>
    			<td width="100" align="right">
    				<p><?php echo number_format($row[csf('cons_amount')] / $row[csf('issue_qty')],2); ?></p></td>
    				<td width="70" align="right" id="net_used_td_<? echo $i; ?>"><p><?php echo number_format($net_used,4,".",""); ?></p>
    				</td>
    				<td width="70" align="right"><input type="text" id="txt_process_loss_<? echo $i; ?>"
    					name="txt_process_loss[]" style="width:35px"
    					class="text_boxes_numeric"
    					value="<?php echo $process_loss; ?>"
    					onKeyUp="calculate_used_qty(this.value,<? echo $i; ?>,<? echo $txt_receive_qnty; ?>)" <? echo $disable_con;?>/>
    				</td>
    				<td align="right"><input type="text" id="txt_used_qty_<? echo $i; ?>" name="txt_used_qty[]"
    					style="width:60px" class="text_boxes_numeric"
    					value="<? if (count($check_arr) == 0) echo number_format($process_loss_used, 4, ".", ""); ?>" <? echo $disable_con;?>/>
    				</td>
    			</tr>
    			<?
    			$i++;
    		}
    	}
    	?>
			<tfoot>
				<th width="30">&nbsp;</th>
				<th width="50">&nbsp;</th>
				<th width="80">&nbsp;</th>
				<th width="50">&nbsp;</th>
				<th width="120">&nbsp;</th>
				<th width="60">&nbsp;</th>
				<th width="70">&nbsp;</th>
				<th width="50">&nbsp;</th>
				<th width="100">Total:</th>
				<th width="60" id="tot_net_qnty">&nbsp;</th>
				<th width="70">&nbsp;</th>
				<th id="tot_used_qnty">&nbsp;</th>
			</tfoot>
    	<input type="hidden" name="txt_color_row_id" id="txt_color_row_id"
    	value="<?php echo $color_row_id; ?>"/>
    </table>
</div>
<table width="640" cellspacing="0" cellpadding="0" border="1" align="center">
	<tr>
		<td align="center" height="30" valign="bottom">
			<div style="width:100%">
				<div style="width:100%; float:left" align="center">
					<input type="hidden" name="txt_knitting_charge" id="txt_knitting_charge" value="<?php echo $conversion_cost[0][csf('charge_unit')]; ?>"/>

					<input type="button" name="close" onClick="fnc_process_cost();" class="formbutton"
					value="Close" style="width:100px"/>
				</div>
			</div>
		</td>
	</tr>
</table>
</div>
<?
exit();
}


if ($action == "show_roll_listview") {

	$data = explode("**", str_replace("'", "", $data));
	$dtls_id = $data[0];
	$barcode_generation = $data[1];
	$mstData = sql_select("select booking_no, booking_without_order, receive_basis from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and b.id=$dtls_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
	
	$print_report_format=0;
	$print_report_format=return_field_value("format_id","lib_report_template","template_name ='".$data[2]."' and module_id=7 and report_id=140 and is_deleted=0 and status_active=1");

	// echo $print_report_format;die;
	$report_format_id=explode(',',$print_report_format);

	if ($mstData[0][csf('receive_basis')] == 2)
	{
		$caption = "PO No.";
		$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $mstData[0][csf('booking_no')]);
		if ($is_salesOrder == 1)
		{
			$query = "select a.id, a.roll_no, a.barcode_no, a.po_breakdown_id, a.qnty, b.job_no as po_number, a.rf_id from pro_roll_details a, fabric_sales_order_mst b where a.po_breakdown_id=b.id and a.dtls_id=$dtls_id and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.barcode_no";
		}
		elseif($is_salesOrder == 2)
		{
			$query = "select a.id, a.roll_no, a.barcode_no, a.po_breakdown_id, a.qnty, b.booking_no as po_number, a.rf_id from pro_roll_details a, wo_non_ord_samp_booking_mst b where a.po_breakdown_id=b.id and a.dtls_id=$dtls_id and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,3) and b.is_deleted=0 order by a.barcode_no";
			$caption = "Booking No.";
		}
		else
		{
			$query = "select a.id, a.roll_no, a.barcode_no, a.po_breakdown_id, a.qnty, b.po_number, a.rf_id from pro_roll_details a, wo_po_break_down b where a.po_breakdown_id=b.id and a.dtls_id=$dtls_id and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,3) and b.is_deleted=0 order by a.barcode_no";
		}
	}
	else
	{
		if ($mstData[0][csf('booking_without_order')] == 1)
		{
			$query = "select id,roll_no,barcode_no,po_breakdown_id,qnty,booking_no as po_number, rf_id from pro_roll_details where dtls_id=$dtls_id and entry_form=2 and status_active=1 and is_deleted=0 order by barcode_no";
			$caption = "Booking No.";
		}
		else
		{
			$query = "select a.id, a.roll_no, a.barcode_no, a.po_breakdown_id, a.qnty, b.po_number, a.rf_id from pro_roll_details a, wo_po_break_down b where a.po_breakdown_id=b.id and a.dtls_id=$dtls_id and a.entry_form=2 and a.status_active=1 and a.is_deleted=0 and b.status_active in(1,3) and b.is_deleted=0 order by a.barcode_no";
			$caption = "PO No.";
		}
	}
	?>
	<div align="center" id="button_data_panel">
		<?
		if ($barcode_generation == 2) {
			?>
			<input type="button" id="btn_send_to_printer" name="btn_send_to_printer" value="Send To Printer"
			class="formbutton" onClick="fnc_send_printer_text()"/>
			<?
		} elseif($barcode_generation == 1) {
			?>
			<input type="button" id="btn_barcode_generation" name="btn_barcode_generation" value="Barcode Generation"
			class="formbutton" onClick="fnc_barcode_generation()"/>
			<?
		}


		foreach($report_format_id as $result){

			if($result==315){?>
				
				<input type="button" id="btn_barcode_extranal_db" name="btn_barcode_extranal_db" value="Send To Ex. DB" class="formbutton" onClick="fnc_barcode_For_extranal_database()"/>
				
  			<?}elseif($result==316){?>
				<input type="button" id="btn_barcode_128" name="btn_barcode_128" value="Barcode 128" class="formbutton" onClick="fnc_barcode_code128(1)"/>
		
			<?}elseif($result==317){?>
				<input type="button" id="btn_barcode_128" name="btn_barcode_128" value="Barcode 128 v2" class="formbutton" onClick="fnc_barcode_code128(2)"/>
			<?}elseif($result==318){?>
				<input type="button" id="btn_barcode_88" name="btn_barcode_88" value="Barcode 88X50" class="formbutton" onClick="fnc_barcode_code128(3)"/>
			<?}elseif($result==319){?>
				<input type="button" id="btn_barcode_m" name="btn_barcode_m" value="Barcode M" class="formbutton" onClick="fnc_barcode_code128(4)"/>
			<?}elseif($result==320){?>
				<input type="button" id="btn_barcode_128" name="btn_barcode_128" value="Direct Print" class="formbutton" onClick="fnc_barcode_code128(5)"/> 
			<?}elseif($result==321){?>
				<input type="button" id="btn_barcode_for_database" name="btn_barcode_for_database" value="Send To Database" class="formbutton" onClick="fnc_barcode_For_database()"/>		

			<?	}elseif($result==322){?>
				<input type="button" id="btn_barcode_for_database" name="btn_barcode_for_database" value="Barcode N" class="formbutton" onClick="fnc_barcode_code128(6)"/>
			<?	}elseif($result==337){?>
				<input type="button" id="btn_barcode_a" name="btn_barcode_a" value="Barcode A" class="formbutton" onClick="fnc_barcode_code128(8)"/>
			<?}elseif($result==748){?>
				<input type="button" id="btn_barcode_88Y" name="btn_barcode_88Y" value="Barcode 88X50 Y" class="formbutton" onClick="fnc_barcode_code128(7)"/>
			<?}elseif($result==355){?>
				<input type="button" id="btn_barcode_b" name="btn_barcode_b" value="Printout" class="formbutton" onClick="fnc_barcode_code128(9)"/>
			<?}elseif($result==331){?>
				<input type="button" id="btn_barcode_128v4" name="btn_barcode_128v4" value="Barcode 128 v3" class="formbutton" onClick="fnc_barcode_code128(10)"/>
			<?}elseif($result==66){?>
				<input type="button" id="btn_direct_print2" name="btn_direct_print2" value="Direct Print 2" class="formbutton" onClick="fnc_barcode_code128(11)"/>
			<?}elseif($result==136){?>
				<input type="button" id="btn_barcode_direct3" name="btn_barcode_direct3" value="Direct Print 3" class="formbutton" onClick="fnc_barcode_code128(12)"/>
			<?}elseif($result==137){?>
				<input type="button" id="btn_barcode_direct4" name="btn_barcode_direct4" value="Direct Print 4" class="formbutton" onClick="fnc_barcode_code128(13)"/>
			<?}elseif($result==129){?>
				<input type="button" id="btn_barcode_direct5" name="btn_barcode_direct5" value="Direct Print 5" class="formbutton" onClick="fnc_barcode_code128(14)"/>
			<?}elseif($result==810){?>
				<input type="button" id="btn_barcode_ccl" name="btn_barcode_ccl" value="Barcode CCL" class="formbutton" onClick="fnc_barcode_code128(15)"/>
			<?}
		}
	?>
	
	

	</div>
	<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="100%">
		<thead>
			<th width="90"><? echo $caption; ?></th>
			<th width="45">Roll No.</th>
			<th width="60">Roll Qty.</th>
			<th width="70">Barcode No.</th>
			<th width="60">RFID</th>
			<th>Check All <input type="checkbox" name="check_all" id="check_all" onClick="check_all_report()"></th>
		</thead>
	</table>
	<div style="width:100%; max-height:200px; overflow-y:scroll" id="list_container" align="left">
		<table class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all" width="100%"
		id="tbl_list_search">
		<?
		$i = 1;
		$result = sql_select($query);
		foreach ($result as $row) {
			if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
			?>
			<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
				<td width="90">
					<p><? echo $row[csf('po_number')]; ?></p>
					<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>"
					value="<? echo $row[csf('id')]; ?>">
				</td>
				<td width="43" style="padding-left:2px"><? echo $row[csf('roll_no')]; ?></td>
				<td align="right" width="58" style="padding-right:2px"><? echo number_format($row[csf('qnty')],2); ?></td>
				<td width="68" style="padding-left:2px"><? echo $row[csf('barcode_no')]; ?></td>
				<td width="58" style="padding-left:2px"><p><? echo $row[csf('rf_id')]; ?></p></td>
				<td align="center" valign="middle">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input
					id="chkBundle_<? echo $i; ?>" type="checkbox" name="chkBundle"></td>
				</tr>
				<?
				$i++;
			}
			?>
		</table>
	</div>
	<?
	exit();
}

if ($action == "print_barcode_one_128") {
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');


	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');

	$sql = "select a.company_id,a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		$booking_no = $row[csf('booking_no')];
		$booking_without_order = $row[csf('booking_without_order')];

		$prod_date = date("d-m-Y", strtotime($row[csf('insert_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));

		$order_id = $row[csf('order_id')];
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];
		$operator_name = $row[csf('operator_name')];
		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];
		$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];
			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				$comp = $determination_sql[0][csf('construction')] . ", ";
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);
	}

	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		if ($row[csf("receive_basis")] == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $row[csf("booking_id")] . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
		}
	} else {
		$is_salesOrder = 0;
		if ($row[csf("receive_basis")] == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $row[csf("booking_id")]);
		}
		if ($is_salesOrder == 1) {
			$po_sql = sql_select("select a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
			}
		} else {
			$po_sql = sql_select("select a.job_no, a.job_no_prefix_num, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
			}
			//$order_no = $po_array[$order_id]['no'];
		}
	}

	$i = 1;
	$barcode_array = array();
	$query = "select a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$res = sql_select($query);
	$pdf=new PDF_Code128('P','mm','a128');
	$pdf->AddPage();
	$pdf->SetFont('Arial','B',10);


	$i=2; $j=3; $k=0; $br=0; $n=0;
	foreach ($res as $row) {


		$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=2; $j=3; $k=0;
		}

	/*	if ($booking_without_order == 1) {
			$txt = $row[csf('barcode_no')] . "; " . $party_name . " Booking No." . $booking_no_prefix . ";<br>";
		} else {
			$txt = $row[csf('barcode_no')] . "; " . $party_name . " Job No." . $po_array[$row[csf('po_breakdown_id')]]['prefix'] . ";<br>";
		}
		$txt .= "M/C: " . $machine_name . "; M/C Dia X Gauge-" . $machine_dia_width . "X" . $machine_gauge . ";<br>";
		$txt .= "Date: " . $prod_date . ";<br>";
		$txt .= "Buyer: " . $buyer_name . ", Order No: " . $order_no . ";<br>";
		$txt .= $comp . "<br>";
		$txt .= "G/Dia: " . $grey_dia . "; SL: " . trim($stitch_length) . "; " . trim($tube_type) . "; F/Dia: " . trim($finish_dia) . ";<br>";
		$txt .= "GSM: " . $gsm . "; ";
		$txt .= $yarn_count . "; Lot: " . $yarn_lot . ";<br>";
		$txt .= "Prg: " . $program_no . "; Roll Wt: " . number_format($row[csf('qnty')], 2, '.', '') . " Kg;<br>";
		$txt .= "Custom Roll No: " . $row[csf('roll_no')] . ";";
		if (trim($color) != "") $txt .= " Color: " . trim($color) . ";<br>";

			if (trim($row[csf('fabric_grade')]) != "") $txt .= "Grade: " . trim($row[csf('fabric_grade')]) . ";";
			if ($operator_name != "") $txt .= "OP: " . $operator_name_arr[$operator_name] . ";";*/


			$pdf->SetXY($i, $j);
			$pdf->Write(0, $row[csf("barcode_no")]. " ".$company_short_name." Job No." . $po_array[$row[csf('po_breakdown_id')]]['prefix']);

			$pdf->SetXY($i, $j+3.3);
		$pdf->Write(0, "M/C: " . $machine_name . "; M/C Dia X GG-" . $machine_dia_width . "X" . $machine_gauge );//24

		$pdf->SetXY($i, $j+6.6);
		$pdf->Write(0, "Date: " . $prod_date ." ".$buyer_name);


		$pdf->SetXY($i, $j+9.9);
		$pdf->Write(0, "Po: " . $order_no);//24 $style_name


		$pdf->SetXY($i, $j+13.2);
		$pdf->Write(0, $comp);
		//$pdf->Write(0, "G/Dia: " . $grey_dia . "; SL: " . trim($stitch_length) . "; " . trim($tube_type) . "; F/Dia: " . trim($finish_dia));
		$pdf->SetXY($i, $j+16.5);
		$pdf->Write(0, "G/Dia: " . $grey_dia. "; F/Dia: " . trim($finish_dia). ";F/GSM: " . $gsm);

		$pdf->SetXY($i, $j+19.8);
		$pdf->Write(0, "Count:".$yarn_count . "; Lot: " . $yarn_lot);
		$pdf->SetXY($i, $j+23.1);
		$pdf->Write(0, "SL: " . trim($stitch_length).";Clr: " .substr($color, 0, 25));

		$pdf->SetXY($i, $j+26.4);
		$pdf->Write(0, "Prg: " . $program_no . "; Roll Wt: " . number_format($row[csf('qnty')], 2, '.', ''). " Kg");

		$pdf->SetXY($i, $j+29.7);
		$pdf->Write(0, "Roll No: " . $row[csf('roll_no')] .";D/Type: " .trim($tube_type));

		$pdf->Code128($i+1,$j+32.5,$row[csf("barcode_no")],50,8);

		$k++;
		$br++;
	}

	foreach (glob(""."*.pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}

if ($action == "direct_print_barcode") {
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');


	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');

	$sql = "select a.company_id,a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name, b.shift_name from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';$yarn_type_cond = ''; 
	//$yarn_type = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	$operator_name = '';
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		if ($row[csf('knitting_source')] == 1) {
			$party_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name_full = return_field_value("supplier_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}
		$booking_id=$row[csf("booking_id")];
		$recieve_basis=$row[csf("receive_basis")];
		$booking_no = $row[csf('booking_no')];
		$booking_without_order = $row[csf('booking_without_order')];

		// $prod_date = date("d-m-Y", strtotime($row[csf('insert_date')]));
		$prod_date = date("d-m-Y", strtotime($row[csf('receive_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));

		$order_id = $row[csf('order_id')];
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];

		$operator_name = $operator_name_arr[$row[csf('operator_name')]];
		$shift_name_full = $shift_name[$row[csf('shift_name')]];

		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];
		$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = ''; 
		//$yarn_type = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
				
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg,a.booking_no from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];
			if($machine_gauge!=""){$machine_dia_width=$machine_dia_width."X".$machine_gauge;}else{$machine_dia_width=$machine_dia_width;}
			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
			$bookingNo = $planning_data[0][csf('booking_no')];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

			if ($row[csf("within_group")] == 1)
			$buyer_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name_full = return_field_value("buyer_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
	

		$comp = '';$yarn_type_cond = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
			//echo "select yarn_type from product_details_master where  id=".$row[csf('prod_id')]." ";
			//echo "select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')];
			//echo $yarn_typeId.'DD';
				$yarn_type_cond=$yarn_type[$yarn_typeId];
			if ($determination_sql[0][csf('construction')] != "") {
				$comp = $determination_sql[0][csf('construction')] . ", ";
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
				
				//$yarn_type_cond .= $yarn_type[$d_row[csf('type_id')]];
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);

		
	}
	
			/// yarn Type start booking_id 
			
			if ($recieve_basis == 1) {
    			if ($booking_without_order == 0) {
    				$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_id=$booking_id and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by  c.yarn_type";


    			} else {
    				$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_no='$booking_no' and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by c.yarn_type";
    			}
    		} else if ($recieve_basis == 2) {
    			$reqsition_sql = sql_select("select  requisition_no from ppl_yarn_requisition_entry where knit_id='$booking_id'");
    			$reqsition_number = "";
    			foreach ($reqsition_sql as $inf) {
    				if (trim($reqsition_number) != "") {
    					$reqsition_number .= ",'" . $inf[csf('requisition_no')] . "'";
    				} else {
    					$reqsition_number = "'" . $inf[csf('requisition_no')] . "'";
    				}
    			}

    			$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and b.requisition_no in($reqsition_number) and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1 and b.status_active=1 and b.is_deleted=0 group by  c.yarn_type";
    		}
			$sql_yarn_result = sql_select($sql_yarn);
			//echo $sql_yarn;
			$yarn_typeCond="";
			foreach ($sql_yarn_result as $row)
			{
				$yarn_typeCond.=$yarn_type[$row[csf('yarn_type')]].',';
			}
			$yarntypeCond=rtrim($yarn_typeCond,',');
			$yarn_type_cond=implode(",",array_unique(explode(",",$yarntypeCond)));
			//echo $yarn_type_cond.'SS';
	//Yarn Type
	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		if ($row[csf("receive_basis")] == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $row[csf("booking_id")] . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
			$bookingNo = $sales_info[0][csf('sales_booking_no')];
		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$non_internal_ref= return_field_value("grouping", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$bookingNo = $booking_no;
		}
	} else {
		$is_salesOrder = 0;
		if ($recieve_basis == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $booking_id);
		}
		if ($is_salesOrder == 1) {
			$po_sql = sql_select("select a.id,a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no,b.buyer_id,a.po_job_no from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id in($order_id)");
			$salesBooking="";
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['po_job_no'] = $row[csf('po_job_no')];
				$po_array[$row[csf('id')]]['sales_booking_no'] = $row[csf('sales_booking_no')];
				$po_array[$row[csf('id')]]['prefix'] = 0; //CRM ID: 22402
				$bookingNo = $row[csf('po_number')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
				$salesBooking.="'".$row[csf('sales_booking_no')]."',";
			}
			$salesBooking=chop($salesBooking,',');
			$internalRef_sql = sql_select("select a.job_no,a.booking_no,b.grouping from wo_booking_dtls a, wo_po_break_down b where a.job_no=b.job_no_mst and a.booking_no in($salesBooking) group by a.job_no,a.booking_no,b.grouping");
			foreach ($internalRef_sql as $row) {
				$internalRefArr[$row[csf('booking_no')]]['grouping'] = $row[csf('grouping')];
			}
		} else {
			$po_sql = sql_select("select a.job_no, a.job_no_prefix_num, b.id,b.grouping, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id) group by a.job_no,a.job_no_prefix_num,b.id,b.grouping,b.po_number");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
			}
			//$order_no = $po_array[$order_id]['no'];
		}
	}

	$i = 1;
	$barcode_array = array();
	$query = "select a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$res = sql_select($query);
	$pdf=new PDF_Code128('P','mm', array(65,55));
	$pdf->AddPage();
	$pdf->SetFont('Arial','B',8);

	$pdf->SetAutoPageBreak(false);
	$pdf->SetRightMargin(0);

	$i=2; $j=3; $k=0; $br=0; $n=0;
	foreach ($res as $row) {
		

		$operatorName = substr($operator_name, 0, 13);

		if ($is_salesOrder == 1) {
			//$poNO=0;
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['po_job_no'];
			$order_no = $bookingNo;
		}
		else
		{
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['prefix'];
			$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		}

		

		if ($row[csf("receive_basis")] == 1 && $booking_without_order=1)
		{
			$internal_ref=$non_internal_ref;
		}
		else
		{
			if($po_array[$row[csf('po_breakdown_id')]]['grouping']!="") 
			{
				$internal_ref=$po_array[$row[csf('po_breakdown_id')]]['grouping'];
			}
			else {
				$internal_ref=$internalRefArr[$po_array[$row[csf('po_breakdown_id')]]['sales_booking_no']]['grouping'];
			}
		}

		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=2; $j=3; $k=0;
		}

		if ($is_salesOrder == 1)
		{
			$bookingNos=$po_array[$row[csf('po_breakdown_id')]]['sales_booking_no'];
		}
		else
		{
			$bookingNoArr=explode("-", $bookingNo);
			$bookingNos=$bookingNoArr[1]."-".$bookingNoArr[2]."-".$bookingNoArr[3];
		}


	/*	if ($booking_without_order == 1) {
			$txt = $row[csf('barcode_no')] . "; " . $party_name . " Booking No." . $booking_no_prefix . ";<br>";
		} else {
			$txt = $row[csf('barcode_no')] . "; " . $party_name . " Job No." . $po_array[$row[csf('po_breakdown_id')]]['prefix'] . ";<br>";
		}
		$txt .= "M/C: " . $machine_name . "; M/C Dia X Gauge-" . $machine_dia_width . "X" . $machine_gauge . ";<br>";
		$txt .= "Date: " . $prod_date . ";<br>";
		$txt .= "Buyer: " . $buyer_name . ", Order No: " . $order_no . ";<br>";
		$txt .= $comp . "<br>";
		$txt .= "G/Dia: " . $grey_dia . "; SL: " . trim($stitch_length) . "; " . trim($tube_type) . "; F/Dia: " . trim($finish_dia) . ";<br>";
		$txt .= "GSM: " . $gsm . "; ";
		$txt .= $yarn_count . "; Lot: " . $yarn_lot . ";<br>";
		$txt .= "Prg: " . $program_no . "; Roll Wt: " . number_format($row[csf('qnty')], 2, '.', '') . " Kg;<br>";
		$txt .= "Custom Roll No: " . $row[csf('roll_no')] . ";";
		if (trim($color) != "") $txt .= " Color: " . trim($color) . ";<br>";

			if (trim($row[csf('fabric_grade')]) != "") $txt .= "Grade: " . trim($row[csf('fabric_grade')]) . ";";
			if ($operator_name != "") $txt .= "OP: " . $operator_name_arr[$operator_name] . ";";*/

		if ($operatorName != "") $operatorName = "; OP : " . $operatorName;

		$pdf->SetXY($i, $j);
		$pdf->Write(0, "WC:" . substr($party_name_full,0,45) );
		
		$pdf->SetXY($i, $j+3.5);
		$pdf->Write(0, "D:" . $prod_date ."; B:" . $buyer_name."; Shift:".$shift_name_full);

		$pdf->SetXY($i, $j+6.5);
		$pdf->Write(0, $company_short_name."; Job No." . $poNO."; IR:".$internal_ref);

		$pdf->SetXY($i, $j+9.5);
		$pdf->Write(0, "Po:" . substr($order_no,0,25) );

		$pdf->SetXY($i, $j+12.5);
		$pdf->Write(0, substr($comp,0,45) );

		$pdf->SetXY($i, $j+16);
		$pdf->Write(0, "F/GSM: " . $gsm.";Clr: " .substr($color, 0, 25));

		$pdf->SetXY($i, $j+19);
		$pdf->Write(0, "C:".$yarn_count . "; L: " . $yarn_lot);
		//$pdf->Write(0, "C: " . substr($gsm, 0, 25) .";Clr: " .substr($color, 0, 25));

		$pdf->SetXY($i, $j+22.5);
		$pdf->Write(0, "Br: " .  $brand .";T: " . $yarn_type_cond);

		$pdf->SetXY($i, $j+25.5);
		$pdf->Write(0, "M/C: " . $machine_name . "; DiaXGG-" . $machine_dia_width . "; B-" . $bookingNos);//24

		$pdf->SetXY($i, $j+28.5);
		$pdf->Write(0, "F/Dia: " . trim($finish_dia).";D/Type: " .trim($tube_type));

		$pdf->SetXY($i, $j+31.5);
		$pdf->Write(0, "SL: " . trim($stitch_length).";Prg: " .$program_no);

		$pdf->SetXY($i, $j+34.5);
		$pdf->Write(0, "Roll No: " . $row[csf('roll_no')] ."; Roll Wt: " . number_format($row[csf('qnty')], 2, '.', ''). " Kg");


		$pdf->SetXY($i, $j+37.5);
		$pdf->Write(0, $row[csf("barcode_no")] . $operatorName);
		
		$pdf->Code128($i+1,$j+40.5,$row[csf("barcode_no")],50,8);

		$k++;
		$br++;
	}

	foreach (glob(""."*.pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}

if ($action == "print_barcode_one_128_v2") {
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');


	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$user_arr = return_library_array("select id, user_name from user_passwd", 'id', 'user_name');
	$brand_id_arr = return_library_array("select lot, brand from product_details_master where item_category_id=1", 'lot', 'brand');
	///print_r($brand_id_arr['6112018']);die;
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');

	$sql = "select a.company_id,a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		$receive_date=$row[csf('receive_date')];
		$booking_no = $row[csf('booking_no')];
		$booking_without_order = $row[csf('booking_without_order')];

		$prod_date = date("d-m-Y", strtotime($row[csf('insert_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));

		$order_id = $row[csf('order_id')];
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];
		$operator_name = $row[csf('operator_name')];
		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];

		$brand='';
		$lot_string = explode(",", $row[csf('yarn_lot')]);
		foreach ($lot_string as $val) {
			if ($val!="") $brand .= $brand_arr[$brand_id_arr[$val]] . ",";
		}
		$brand = chop($brand, ',');
		//$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];

			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				//$comp = $determination_sql[0][csf('construction')] . ", ";
				$constuction = $determination_sql[0][csf('construction')];
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);
	}

	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		if ($row[csf("receive_basis")] == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $row[csf("booking_id")] . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
		}
	} else {
		$is_salesOrder = 0;
		if ($row[csf("receive_basis")] == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $row[csf("booking_id")]);
		}
		if ($is_salesOrder == 1) {
			$po_sql = sql_select("select a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
			}
		} else {

			if ($row[csf("receive_basis")] == 2)
			{
				$planning_booking_sql = sql_select("select a.booking_no_prefix_num from wo_booking_mst a,ppl_planning_entry_plan_dtls b where a.booking_no=b.booking_no and   b.dtls_id='" . $row[csf('booking_id')] . "'");
				$planning_booking_prefix=$planning_booking_sql[0][csf('booking_no_prefix_num')];

			}

			$po_sql = sql_select("select a.job_no,a.job_no_prefix_num,a.buyer_name,b.id,b.po_number,d.booking_no_prefix_num from wo_po_details_master a, wo_po_break_down b,wo_booking_dtls c,wo_booking_mst d where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and c.booking_no=d.booking_no and d.booking_type=1 and d.is_short=2 and a.status_active=1 and b.status_active=1 and c.status_active=1 and b.id in($order_id)");
			foreach ($po_sql as $row1) {
				$po_array[$row1[csf('id')]]['no'] = $row1[csf('po_number')];
				$po_array[$row1[csf('id')]]['job_no'] = $row1[csf('job_no')];
				$po_array[$row1[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				if ($row[csf("receive_basis")] == 2)
				{
					$po_array[$row1[csf('id')]]['booking_no'] = $planning_booking_prefix;
				}
				else
				{
					$po_array[$row1[csf('id')]]['booking_no'] = $row1[csf('booking_no_prefix_num')];
				}

				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row1[csf('buyer_name')]);
			}
		}
	}
	$i = 1;
	$barcode_array = array();
	//$query = "select a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$query = "select a.id,a.inserted_by, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade,c.shift_name,d.recv_number_prefix_num from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no left join pro_grey_prod_entry_dtls c on a.dtls_id=c.id left join inv_receive_master d on c.mst_id=d.id where a.id in($data[0])";
	$res = sql_select($query);


	$pdf=new PDF_Code128('P','mm',array(80,65));
	$pdf->AddPage();
	$pdf->SetFont('Times','',10);


	$i=2; $j=1; $k=0; $br=0; $n=0;
	foreach ($res as $row) {


		$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=2; $j=1; $k=0;
		}


		$pdf->Code128($i+1,$j,$row[csf("barcode_no")],50,8);
		$pdf->SetXY($i, $j+10);
		$pdf->Write(0, $row[csf("barcode_no")]. ",Dt:".change_date_format($receive_date). ",Pg:".$program_no. ",S:".$shift_name[$row[csf('shift_name')]]);

		$pdf->SetXY($i, $j+14);
		//." B: " . $po_array[$row[csf('po_breakdown_id')]]['booking_no']
		$pdf->Write(0, $company_short_name.":" . $po_array[$row[csf('po_breakdown_id')]]['booking_no'].",M/C:" . $machine_name . "," . $machine_dia_width . "X" . $machine_gauge. ",RW:" . number_format($row[csf('qnty')], 2, '.', ''));

		$pdf->SetXY($i, $j+18);
		$pdf->Write(0, $buyer_name . ",Po:" . $order_no);//24

		$pdf->SetXY($i, $j+22);
		$pdf->Write(0, "Clr:" .substr($color, 0, 35));

		$pdf->SetXY($i, $j+26);
		$pdf->Write(0, "Ct:".$yarn_count.",Lt:".$yarn_lot);

		$pdf->SetXY($i, $j+30);
		$pdf->Write(0, "Br:". $brand.",".$constuction);
	//
		$pdf->SetXY($i, $j+34);
		$pdf->Write(0, substr($comp, 0, 45));

		$pdf->SetXY($i, $j+38);
		$pdf->Write(0, "G/F Dia:" . $grey_dia. "," . trim($finish_dia).",GSM:". $gsm.",SL:" . trim($stitch_length));

		$pdf->SetXY($i, $j+42);
		$pdf->Write(0, "Prd:".$row[csf('recv_number_prefix_num')]. ",RL No:" . $row[csf('roll_no')] .",ID:" .$user_arr[$row[csf('inserted_by')]]);
	//"D/T: " .trim($tube_type).

		$k++;
		$br++;
	}

	foreach (glob("*".$userid.".pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'_'.$userid.'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}

if ($action == "print_barcode_one_128_v4")  // Barcode 128 v3 button
{
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');

	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$user_arr = return_library_array("select id, user_name from user_passwd", 'id', 'user_name');
	$brand_id_arr = return_library_array("select lot, brand from product_details_master where item_category_id=1", 'lot', 'brand');
	///print_r($brand_id_arr['6112018']);die;
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');

	$sql = "SELECT a.company_id,a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and b.id=$data[1] order by yarn_count";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	foreach ($result as $row) 
	{
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		$receive_date=$row[csf('receive_date')];
		$booking_no = $row[csf('booking_no')];
		$booking_without_order = $row[csf('booking_without_order')];

		$prod_date = date("d-m-Y", strtotime($row[csf('insert_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));

		$order_id = $row[csf('order_id')];
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];
		$operator_name = $row[csf('operator_name')];
		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];

		$brand='';
		$lot_string = explode(",", $row[csf('yarn_lot')]);
		foreach ($lot_string as $val) {
			if ($val!="") $brand .= $brand_arr[$brand_id_arr[$val]] . ",";
		}
		$brand = chop($brand, ',');
		//$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) 
		{
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}

		$program_dye_type = '';
		if ($row[csf("receive_basis")] == 2) 
		{
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("SELECT a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg, b.batch_no, b.dye_type from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];
			//$program_batch_no = $planning_data[0][csf('batch_no')];
			$program_dye_type = $planning_data[0][csf('dye_type')];

			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
		} 
		else 
		{
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		/*if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);*/

		$determination_sql = sql_select("SELECT a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

		if ($determination_sql[0][csf('construction')] != "") {
			//$comp = $determination_sql[0][csf('construction')] . ", ";
			$constuction = $determination_sql[0][csf('construction')];
		}

		$booking_id=$row[csf('booking_id')];
		$y_requisition = sql_select("SELECT prod_id, no_of_cone, requisition_date, yarn_qnty from ppl_yarn_requisition_entry where knit_id=$booking_id and status_active = '1' and is_deleted = '0'");
		$y_prod_arr=array();
		foreach ($y_requisition as $value) 
		{
			$y_prod_arr[$value[csf('prod_id')]]=$value[csf('prod_id')];
		}
		$y_prod=implode(",", $y_prod_arr);
		$count_ids=implode(",", $count_id);

		$dataArray_prod = sql_select("SELECT lot, yarn_comp_type1st, yarn_comp_percent1st, yarn_comp_type2nd, yarn_comp_percent2nd, yarn_count_id, yarn_type, color from product_details_master where status_active=1 and is_deleted=0 and id in($y_prod) and yarn_count_id in($count_ids) order by yarn_count_id");
		$comp = '';
		foreach ($dataArray_prod as $key => $rows) 
		{
			if ($rows[csf('yarn_comp_percent2nd')] != 0)
			{
				$comp = $composition[$rows[csf('yarn_comp_type1st')]]. "" . $composition[$rows[csf('yarn_comp_type2nd')]].',';
			}
			else
			{
				$comp .= $composition[$rows[csf('yarn_comp_type1st')]]. "" . $composition[$rows[csf('yarn_comp_type2nd')]].',';
			}
		}

		
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);
	}

	$op_sql_data = sql_select("select id, first_name, id_card_no from lib_employee where id=$operator_name and status_active=1 and is_deleted=0");
	$op_data_arr=array();
	foreach ($op_sql_data as $row2) 
	{
		$op_data_arr[$row2[csf('id')]]['op_name']=$row2[csf('first_name')];
		$op_data_arr[$row2[csf('id')]]['op_card_no']=$row2[csf('id_card_no')];
	}

	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) 
	{
		if ($row[csf("receive_basis")] == 4) 
		{
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $row[csf("booking_id")] . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
		} 
		else 
		{
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
		}
	} 
	else 
	{
		$is_salesOrder = 0;
		if ($row[csf("receive_basis")] == 2) 
		{
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $row[csf("booking_id")]);
			//echo "SELECT is_sales FROM ppl_planning_info_entry_dtls WHERE id=" . $row[csf('booking_id')] . "";
		}
		if ($is_salesOrder == 1) 
		{
			$po_sql = sql_select("SELECT a.id, a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no, a.customer_buyer as buyer_id, a.sales_booking_no from fabric_sales_order_mst a where a.id in($order_id)");
			
			foreach ($po_sql as $row)
			{
				$po_array[$row[csf('id')]]['booking_no'] = $row[csf('sales_booking_no')];
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
			}
		} 
		/*else 
		{
			if ($row[csf("receive_basis")] == 2)
			{
				$planning_booking_sql = sql_select("select a.booking_no_prefix_num from wo_booking_mst a,ppl_planning_entry_plan_dtls b where a.booking_no=b.booking_no and   b.dtls_id='" . $row[csf('booking_id')] . "'");
				$planning_booking_prefix=$planning_booking_sql[0][csf('booking_no_prefix_num')];
			}

			$po_sql = sql_select("SELECT a.job_no,a.job_no_prefix_num,a.buyer_name,b.id,b.po_number,d.booking_no_prefix_num 
			from wo_po_details_master a, wo_po_break_down b,wo_booking_dtls c,wo_booking_mst d 
			where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and c.booking_no=d.booking_no and d.booking_type=1 and d.is_short=2 and a.status_active=1 and b.status_active=1 and c.status_active=1 and b.id in($order_id)");
			foreach ($po_sql as $row1) 
			{
				$po_array[$row1[csf('id')]]['no'] = $row1[csf('po_number')];
				$po_array[$row1[csf('id')]]['job_no'] = $row1[csf('job_no')];
				$po_array[$row1[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				if ($row[csf("receive_basis")] == 2)
				{
					$po_array[$row1[csf('id')]]['booking_no'] = $planning_booking_prefix;
				}
				else
				{
					$po_array[$row1[csf('id')]]['booking_no'] = $row1[csf('booking_no_prefix_num')];
				}

				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row1[csf('buyer_name')]);
			}
		}*/
	}
	// echo "<pre>";print_r($po_array);

	$coller_cuff_size_sql="SELECT c.coller_cuff_size, c.qc_pass_qnty_pcs, c.barcode_no
    from inv_receive_master a, pro_grey_prod_entry_dtls b, pro_roll_details c
    where a.id=b.mst_id and b.id=c.dtls_id and a.entry_form=2 and c.entry_form=2 and c.status_active = 1 and c.is_deleted=0 and b.status_active = 1 and b.is_deleted = 0 and c.id in($data[0])";
    // echo $coller_cuff_size;
    $coller_cuff_size_res = sql_select($coller_cuff_size_sql);
    $coller_cuff_size_arr = array();
    foreach ($coller_cuff_size_res as $row)
	{
		$coller_cuff_size_arr[$row[csf('barcode_no')]]['coller_cuff_size'] = $row[csf('coller_cuff_size')];
		$coller_cuff_size_arr[$row[csf('barcode_no')]]['qc_pass_qnty_pcs'] = $row[csf('qc_pass_qnty_pcs')];
	}

	$i = 1;
	$barcode_array = array();
	$query = "SELECT a.id,a.inserted_by, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade,c.shift_name,d.recv_number_prefix_num, d.recv_number from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no left join pro_grey_prod_entry_dtls c on a.dtls_id=c.id left join inv_receive_master d on c.mst_id=d.id where a.id in($data[0])";
	$res = sql_select($query);


	$pdf=new PDF_Code128('P','mm',array(59,44)); // Convert Pixel to Millimeter array(mm,mm)
	$pdf->SetAutoPageBreak(false);
	$pdf->AddPage();
	$pdf->SetFont('Times','',8);


	$i=2; $j=1; $k=0; $br=0; $n=0;
	foreach ($res as $row) 
	{
		$order_no = $po_array[$row[csf('po_breakdown_id')]]['prefix'];
		$booking_no = $po_array[$row[csf('po_breakdown_id')]]['booking_no'];
		$coller_cuff_size = $po_array[$row[csf('barcode_no')]]['coller_cuff_size'];
		$qc_pass_qnty_pcs = $po_array[$row[csf('barcode_no')]]['qc_pass_qnty_pcs'];
		$recv_number=explode("-", $row[csf('recv_number')]);
		$recv_number=$recv_number[2]."-".$recv_number[3];

		$op_name=$op_data_arr[$operator_name]['op_name'];
		$op_card_no=$op_data_arr[$operator_name]['op_card_no'];

		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=2; $j=1; $k=0;
		}


		$pdf->Code128($i+1,$j,$row[csf("barcode_no")],50,8);
		$pdf->SetXY($i, $j+10);
		$pdf->Write(0, $row[csf("barcode_no")]. ",Dt:".change_date_format($receive_date). ",S:".$shift_name[$row[csf('shift_name')]].",".$company_short_name);

		$pdf->SetXY($i, $j+14);
		//." B: " . $po_array[$row[csf('po_breakdown_id')]]['booking_no']
		$pdf->Write(0, $machine_name . "," . $machine_dia_width . "X" . $machine_gauge. ",RW:" . number_format($row[csf('qnty')], 2, '.', '') . ",S-" . $coller_cuff_size. ",P-" . number_format($qc_pass_qnty_pcs));

		$pdf->SetXY($i, $j+18);
		$pdf->Write(0, $buyer_name . ",B/N:" . $booking_no . ",Pg:" .$program_no.",FSO:". $order_no);//24

		$pdf->SetXY($i, $j+22);
		$pdf->Write(0, "Clr:" .substr($color, 0, 35).",".$program_dye_type);

		$pdf->SetXY($i, $j+26);
		$pdf->Write(0, "Ct:".$yarn_count.",Lt:".$yarn_lot);

		$pdf->SetXY($i, $j+30);
		$pdf->Write(0, substr($comp, 0, 45));

		$pdf->SetXY($i, $j+34);
		$pdf->Write(0, $constuction.", Br:".$brand);

		$pdf->SetXY($i, $j+38);
		$pdf->Write(0, "F/D:" . trim($finish_dia).",GSM:". $gsm.",SL:" . trim($stitch_length));

		$pdf->SetXY($i, $j+41);
		$pdf->Write(0, "Op-". $op_name .",ID-" .$op_card_no.",P/ID-".$recv_number);
		//"D/T: " .trim($tube_type).

		$k++;
		$br++;
	}

	foreach (glob("*".$userid.".pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'_'.$userid.'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}

if ($action == "print_barcode_a") {
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');


	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$user_arr = return_library_array("select id, user_name from user_passwd", 'id', 'user_name');
	$brand_id_arr = return_library_array("select lot, brand from product_details_master where item_category_id=1", 'lot', 'brand');
	///print_r($brand_id_arr['6112018']);die;
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');

	$sql = "select a.company_id,a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		$receive_date=$row[csf('receive_date')];
		$booking_no = $row[csf('booking_no')];
		$booking_without_order = $row[csf('booking_without_order')];

		$prod_date = date("d-m-Y", strtotime($row[csf('insert_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));

		$order_id = $row[csf('order_id')];
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];
		$operator_name = $row[csf('operator_name')];
		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];

		$brand='';
		$lot_string = explode(",", $row[csf('yarn_lot')]);
		foreach ($lot_string as $val) {
			if ($val!="") $brand .= $brand_arr[$brand_id_arr[$val]] . ",";
		}
		$brand = chop($brand, ',');
		//$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];

			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				//$comp = $determination_sql[0][csf('construction')] . ", ";
				$constuction = $determination_sql[0][csf('construction')];
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);
	}

	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		if ($row[csf("receive_basis")] == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $row[csf("booking_id")] . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
		}
	} else {
		$is_salesOrder = 0;
		if ($row[csf("receive_basis")] == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $row[csf("booking_id")]);
		}
		if ($is_salesOrder == 1) {
			$po_sql = sql_select("select a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
			}
		} else {

			if ($row[csf("receive_basis")] == 2)
			{
				$planning_booking_sql = sql_select("select a.booking_no_prefix_num from wo_booking_mst a,ppl_planning_entry_plan_dtls b where a.booking_no=b.booking_no and   b.dtls_id='" . $row[csf('booking_id')] . "'");
				$planning_booking_prefix=$planning_booking_sql[0][csf('booking_no_prefix_num')];

			}

			$po_sql = sql_select("select a.job_no,a.job_no_prefix_num,a.buyer_name,b.id,b.po_number,d.booking_no_prefix_num,a.style_ref_no from wo_po_details_master a, wo_po_break_down b,wo_booking_dtls c,wo_booking_mst d where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and c.booking_no=d.booking_no and d.booking_type=1 and d.is_short=2 and a.status_active=1 and b.status_active=1 and c.status_active=1 and b.id in($order_id)");
			foreach ($po_sql as $row1) {
				$po_array[$row1[csf('id')]]['no'] = $row1[csf('po_number')];
				$po_array[$row1[csf('id')]]['job_no'] = $row1[csf('job_no')];
				$po_array[$row1[csf('id')]]['prefix'] = $row1[csf('job_no_prefix_num')];
				$po_array[$row1[csf('id')]]['style'] = $row1[csf('style_ref_no')];
				if ($row[csf("receive_basis")] == 2)
				{
					$po_array[$row1[csf('id')]]['booking_no'] = $planning_booking_prefix;
				}
				else
				{
					$po_array[$row1[csf('id')]]['booking_no'] = $row1[csf('booking_no_prefix_num')];
				}

				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row1[csf('buyer_name')]);
			}
		}
	}
	$i = 1;
	$barcode_array = array();
	//$query = "select a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$query = "select a.id,a.inserted_by, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade,c.shift_name,d.recv_number_prefix_num from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no left join pro_grey_prod_entry_dtls c on a.dtls_id=c.id left join inv_receive_master d on c.mst_id=d.id where a.id in($data[0])";
	$res = sql_select($query);


	$pdf=new PDF_Code128('P','mm',array(80,65));
	$pdf->AddPage();
	$pdf->SetFont('Times','',10);

	$pdf->SetAutoPageBreak(false);

	$i=2; $j=1; $k=0; $br=0; $n=0;
	foreach ($res as $row) {

		$charCount = 26;
		$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		$style = $po_array[$row[csf('po_breakdown_id')]]['style'];
		$lotCharCount = strlen($yarn_lot);
		$styleCharCount = strlen($style);
		$remainingCount = $charCount - $lotCharCount;
		if ($remainingCount < $styleCharCount) {
			$style = substr($style, 0, $remainingCount);
		}
		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=2; $j=1; $k=0;
		}


		$pdf->Code128($i+1,$j,$row[csf("barcode_no")],50,8);
		$pdf->SetXY($i, $j+10);
		$pdf->Write(0, $row[csf("barcode_no")]. ",Dt:".change_date_format($receive_date). ",Pg:".$program_no. ",S:".$shift_name[$row[csf('shift_name')]]);

		$pdf->SetXY($i, $j+14);
		//." B: " . $po_array[$row[csf('po_breakdown_id')]]['booking_no']
		$pdf->Write(0, $company_short_name.":" . $po_array[$row[csf('po_breakdown_id')]]['booking_no'].",M/C:" . $machine_name . "," . $machine_dia_width . "X" . $machine_gauge. ",RW:" . number_format($row[csf('qnty')], 2, '.', ''));

		$pdf->SetXY($i, $j+18);
		$pdf->Write(0, $buyer_name . ",Stl:" . $style. ",Po:" . $order_no);//24

		$pdf->SetXY($i, $j+22);
		$pdf->Write(0, "Clr:" .substr($color, 0, 35));

		$pdf->SetXY($i, $j+26);
		$pdf->Write(0, "Ct:".$yarn_count.",Lt:".$yarn_lot);

		$pdf->SetXY($i, $j+30);
		$pdf->Write(0, "Br:". $brand.",".$constuction);
//
		$pdf->SetXY($i, $j+34);
		$pdf->Write(0, substr($comp, 0, 45));

		$pdf->SetXY($i, $j+38);
		$pdf->Write(0, "G/F Dia:" . $grey_dia. "," . trim($finish_dia).",GSM:". $gsm.",SL:" . trim($stitch_length));

		$pdf->SetXY($i, $j+42);
		$pdf->Write(0, "Prd:".$row[csf('recv_number_prefix_num')]. ",RL No:" . $row[csf('roll_no')] .",ID:" .$user_arr[$row[csf('inserted_by')]]);

		$pdf->SetXY($i, $j+46);
		$pdf->Write(0, "K. Com: ".$party_name );
	//"D/T: " .trim($tube_type).

		$k++;
		$br++;
	}

	foreach (glob("*".$userid.".pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'_'.$userid.'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}


if ($action == "print_barcode_one_128_v3") 
{
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');


	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$user_arr = return_library_array("select id, user_name from user_passwd", 'id', 'user_name');
	$brand_id_arr = return_library_array("select lot, brand from product_details_master where item_category_id=1", 'lot', 'brand');
	///print_r($brand_id_arr['6112018']);die;
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');

	$sql = "SELECT a.company_id,a.receive_basis,a.booking_id,a.recv_number, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name,b.body_part_id,b.grey_receive_qnty_pcs from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$recv_number = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	foreach ($result as $row) 
	{
		
		$body_part_name = $body_part[$row[csf('body_part_id')]];
		if ($row[csf('knitting_source')] == 1) 
		{
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} 
		else if ($row[csf('knitting_source')] == 3) 
		{
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		$receive_date=$row[csf('receive_date')];
		$booking_no = $row[csf('booking_no')];
		$recv_number_ex = explode("-", $row[csf('recv_number')]);
		$recv_number = $recv_number_ex[2]."-".$recv_number_ex[3];
		$booking_without_order = $row[csf('booking_without_order')];
		$qtyInPcs = $row[csf('grey_receive_qnty_pcs')];

		$prod_date = date("d-m-Y", strtotime($row[csf('insert_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));

		$order_id = $row[csf('order_id')];
		$job_no = return_field_value("job_no_mst", "wo_po_break_down", "id in(" . $row[csf("order_id")] . ")");
		//echo "SELECT job_no_mst from wo_po_break_down where id in('" . $row[csf("order_id")] . "')";die;
		//echo $job_no.'='.$row[csf("order_id")].'***';die;
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];
		$operator_name = $row[csf('operator_name')];
		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) 
		{
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];

		$brand='';
		$lot_string = explode(",", $row[csf('yarn_lot')]);
		foreach ($lot_string as $val) 
		{
			if ($val!="") $brand .= $brand_arr[$brand_id_arr[$val]] . ",";
		}
		$brand = chop($brand, ',');
		//$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) 
		{
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}

		if ($row[csf("receive_basis")] == 2) 
		{
			$machine_data = sql_select("SELECT machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("SELECT a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg,a.body_part_id from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];

			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			// $fabric_typee = array(1 => "Open Width", 2 => "Tubular", 3 => "Needle Open");			
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
			$tube_type_nm = '';
			if($tube_type=="Open Width")
			{
				$tube_type_nm = "O";
			}
			elseif ($tube_type=="Tubular") 
			{
				$tube_type_nm = "T";
			}
			else
			{
				$tube_type_nm = "NO";
			}
			
		} 
		else 
		{
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
			$program_no = $row[csf('booking_id')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") 
		{
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} 
		else 
		{
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				//$comp = $determination_sql[0][csf('construction')] . ", ";
				$constuction = $determination_sql[0][csf('construction')];
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);
	}

	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) 
	{
		if ($row[csf("receive_basis")] == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $row[csf("booking_id")] . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
		}
	} 
	else 
	{
		$is_salesOrder = 0;
		if ($row[csf("receive_basis")] == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $row[csf("booking_id")]);
		}
		if ($is_salesOrder == 1) 
		{
			$po_sql = sql_select("SELECT a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
			}
		}
		else
		{

			if ($row[csf("receive_basis")] == 2)
			{
				$planning_booking_sql = sql_select("SELECT a.booking_no_prefix_num from wo_booking_mst a,ppl_planning_entry_plan_dtls b where a.booking_no=b.booking_no and   b.dtls_id='" . $row[csf('booking_id')] . "'");
				$planning_booking_prefix=$planning_booking_sql[0][csf('booking_no_prefix_num')];

			}

			$po_sql = sql_select("SELECT a.job_no,a.job_no_prefix_num,a.buyer_name,b.id,b.po_number,d.booking_no_prefix_num from wo_po_details_master a, wo_po_break_down b,wo_booking_dtls c,wo_booking_mst d where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and c.booking_no=d.booking_no and d.booking_type=1 and d.is_short=2 and a.status_active=1 and b.status_active=1 and c.status_active=1 and b.id in($order_id)");
			foreach ($po_sql as $row1) {
				$po_array[$row1[csf('id')]]['no'] = $row1[csf('po_number')];
				$po_array[$row1[csf('id')]]['job_no'] = $row1[csf('job_no')];
				$po_array[$row1[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				if ($row[csf("receive_basis")] == 2)
				{
					$po_array[$row1[csf('id')]]['booking_no'] = $planning_booking_prefix;
				}
				else
				{
					$po_array[$row1[csf('id')]]['booking_no'] = $row1[csf('booking_no_prefix_num')];
				}

				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row1[csf('buyer_name')]);
			}
		}
	}
	$i = 1;
	$barcode_array = array();
	//$query = "select a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$query = "SELECT a.id,a.inserted_by, a.roll_no, a.po_breakdown_id, a.coller_cuff_size,a.qc_pass_qnty_pcs,a.barcode_no, a.qnty, b.fabric_grade,c.shift_name,d.recv_number_prefix_num from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no left join pro_grey_prod_entry_dtls c on a.dtls_id=c.id left join inv_receive_master d on c.mst_id=d.id where a.id in($data[0]) order by a.barcode_no";
	$res = sql_select($query);
	
	$sl_yc = "SL-".$stitch_length."::C-".substr($yarn_count,0,30);
	$body_cons = $body_part_name."::".substr($constuction,0,20);

	$pdf=new PDF_Code128('P','mm',array(60,40));
	$pdf->SetAutoPageBreak(false);
	$pdf->AddPage();
	$pdf->SetFont('Arial','B',7);


	$i=1; $j=1; $k=0; $br=0; $n=0;
	foreach ($res as $row) 
	{
		$coller_cuff_size = $row[csf('coller_cuff_size')];
		$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=1; $j=1; $k=0;
		}


		$pdf->Code128($i+3,$j,$row[csf("barcode_no")],51,7);
		$pdf->SetXY($i, $j+10);
		$pdf->Write(0, $row[csf("barcode_no")]."R".$row[csf('roll_no')]. "    :: Pcs-".number_format($row[csf("qc_pass_qnty_pcs")], 0). "    :: WT-".number_format($row[csf('qnty')], 2, '.', ''));

		$pdf->Line(0, 13,300, 13);

		/*$pdf->SetXY($i, $j+11);
		$pdf->Write(0, "----------------------------------------");*/

		$pdf->SetXY($i, $j+14);
		$pdf->Write(0, $job_no."::" . $buyer_name ."::" . $machine_dia_width . "X" . $machine_gauge. "::" . $coller_cuff_size);

		$pdf->SetXY($i, $j+17);
		$pdf->Write(0, "D-".$finish_dia . "/". $tube_type_nm . ":: GSM-". $gsm. "::" . substr($color, 0, 23));//24

		$pdf->Line(0, 20,300, 20);

		$pdf->SetXY($i, $j+21);
		$pdf->Write(0, $body_cons);		
		// $pdf->Write(0, $body_part_name."::".$constuction);		

		$pdf->SetXY($i, $j+24);
		$pdf->Write(0, substr($comp, 0, 45));

		$pdf->SetXY($i, $j+27);
		$pdf->Write(0, $sl_yc);
		// $pdf->SetXY($i+$sl_width, $j+27);
		// $pdf->Write(0, "::C-".substr($yarn_count,0,30));
		$pdf->SetXY($i, $j+30);
		$pdf->Write(0, "L-".$yarn_lot);

		$pdf->Line(0, 33,300, 33);

		$pdf->SetXY($i, $j+35);
		$pdf->Write(0, $party_name);
		$pdf->SetXY($i+15, $j+35);
		$pdf->Write(0, "::KP-" . $program_no);
		$pdf->SetXY($i+35, $j+35);
		$pdf->Write(0, "::PI-" . $recv_number);
	
		$k++;
		$br++;
	}

	foreach (glob("*".$userid.".pdf") as $filename) 
	{
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'_'.$userid.'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}



if ($action == "print_barcode_one_88") {
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');


	$data = explode("***", $data);
	//$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$user_arr = return_library_array("select id, user_name from user_passwd", 'id', 'user_name');
	//$brand_id_arr = return_library_array("select lot, brand from product_details_master where item_category_id=1", 'lot', 'brand');
	///print_r($brand_id_arr['6112018']);die;
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');
//quality_level
	$sql = "select a.company_id,a.receive_basis,a.recv_number_prefix_num, a.booking_id,a.location_id,a.store_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name,b.body_part_id,b.floor_id from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	foreach ($result as $row) 
	{
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
			$location_name = return_field_value("location_name", "lib_location", "id=" . $row[csf('location_id')]);
			//$floor_name = return_library_array("select id, floor_name from lib_prod_floor", 'id', 'floor_name');
			$floor_name = return_field_value("floor_name", "lib_prod_floor", "id=" . $row[csf('floor_id')]);
			$location_store=",".$location_name.", ".$floor_name;
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		$body_part_type=return_field_value("body_part_type","lib_body_part","id=".$row[csf('body_part_id')]." and status_active=1");
		//echo $body_part_type;die;
		$receive_date=$row[csf('receive_date')];
		$booking_no = $row[csf('booking_no')];
		$booking_id = $row[csf('booking_id')];
		$booking_without_order = $row[csf('booking_without_order')];
		$receive_basis= $row[csf('receive_basis')];
		$prod_date = date("d-m-Y", strtotime($row[csf('insert_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));
		$body_part_name=$body_part[$row[csf('body_part_id')]];
		$avg_color=$color_range[$row[csf('color_range_id')]];
		$order_id = $row[csf('order_id')];
		$brand_id=$row[csf('brand_id')];
		$recv_number_prefix_num = $row[csf('recv_number_prefix_num')];
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];
		$operator_name = $row[csf('operator_name')];
		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];

		/*$brand='';
		$lot_string = explode(",", $row[csf('yarn_lot')]);
		foreach ($lot_string as $val) {
			if ($val!="") $brand .= $brand_arr[$brand_id_arr[$val]] . ",";
		}
		$brand = chop($brand, ',');*/
		//$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];

			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				//$comp = $determination_sql[0][csf('construction')] . ", ";
				$constuction = $determination_sql[0][csf('construction')];
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);
	}

	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		if ($receive_basis == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $booking_id . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
		} else {

			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$non_internal_ref= return_field_value("grouping", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
		}
	} 
	else 
	{
		$is_salesOrder = 0;
		if ($receive_basis == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $booking_id);
		}

		if ($is_salesOrder == 1) {
			$po_sql = sql_select("select a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no,b.buyer_id,b.quality_level from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				if($row[csf('quality_level')]>0)
				{
				$po_array[$row[csf('id')]]['nature'] = $row[csf('quality_level')];
				}
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
			}
		} else {

			if ($receive_basis == 2)
			{
				$planning_booking_sql = sql_select("select a.quality_level,a.booking_no_prefix_num from wo_booking_mst a,ppl_planning_entry_plan_dtls b where a.booking_no=b.booking_no and   b.dtls_id='" . $booking_id . "'");
			}
			$po_sql = sql_select("select a.job_no,a.job_no_prefix_num,a.buyer_name,b.id,b.grouping,b.po_number,d.quality_level,d.booking_no_prefix_num,d.booking_no from wo_po_details_master a, wo_po_break_down b,wo_booking_dtls c,wo_booking_mst d where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and c.booking_no=d.booking_no and d.booking_type=1 and d.is_short=2 and a.status_active=1 and b.status_active=1 and c.status_active=1 and b.id in($order_id) group by a.job_no,a.job_no_prefix_num,a.buyer_name,b.id,b.grouping,b.po_number,d.quality_level,d.booking_no_prefix_num,d.booking_no");
			
			foreach ($po_sql as $row1) {
				$po_array[$row1[csf('id')]]['no'] = $row1[csf('po_number')];
				$po_array[$row1[csf('id')]]['job_no'] = $row1[csf('job_no')];
				$po_array[$row1[csf('id')]]['prefix'] = $row1[csf('job_no_prefix_num')];
				$po_array[$row1[csf('id')]]['grouping'] = $row1[csf('grouping')];
				if($row1[csf('quality_level')]>0)
				{
				$po_array[$row1[csf('id')]]['nature'] = $row1[csf('quality_level')];
				}
				$po_array[$row1[csf('id')]]['booking_no'] = $row1[csf('booking_no')];


				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row1[csf('buyer_name')]);
			}
		}
	}


	if ($receive_basis == 2)
	{
		$probram_no=$booking_no;
	}
	else $probram_no="";
	$barcode_array = array();
	//$query = "select a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$query = "select a.id,a.inserted_by, a.roll_no,b.reject_qnty,a.qc_pass_qnty_pcs,a.coller_cuff_size, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade,c.shift_name from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no left join pro_grey_prod_entry_dtls c on a.dtls_id=c.id where a.id in($data[0])";
	$res = sql_select($query);

	$brand_arr = return_library_array("select id, brand_name from lib_brand where id=$brand_id", 'id', 'brand_name');
	/*if($body_part_type==40 || $body_part_type==50)
	{
		$pdf=new PDF_Code128('P','mm',array(88,53));
	}
	else */
	$pdf=new PDF_Code128('P','mm',array(88,53));

	$pdf->SetAutoPageBreak(false);
	$pdf->AddPage();
	$pdf->SetFont('Times','',7);


	$i=1; $j=1; $k=0; $br=0; $n=0;
	foreach ($res as $row) {


		$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		$order_nature = $fbooking_order_nature[$po_array[$row[csf('po_breakdown_id')]]['nature']];
		//echo $nature.'DDDDDDDDD';
		if ($receive_basis == 1)
		{
			$fabric_booking_no=$booking_no;
		}
		else
		{
			$fabric_booking_no=$po_array[$row[csf('po_breakdown_id')]]['booking_no'];
		}
		if ($receive_basis == 1 && $booking_without_order=1)
		{
			$internal_ref=$non_internal_ref;
		}
		else
		{
			if($po_array[$row[csf('po_breakdown_id')]]['grouping']!="") $internal_ref=$po_array[$row[csf('po_breakdown_id')]]['grouping'];
			else $internal_ref="";
		}
		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=1; $j=1; $k=0;
		}

		$pdf->SetXY($i, $j+2.5);
		$pdf->Write(0, $party_name."".$location_store.",".$buyer_name.",".$order_nature);
		$pdf->Code128($i,$j+5,$row[csf("barcode_no")],50,8);
		$pdf->SetXY($i+52, $j+6);
		$pdf->Write(0, $row[csf("barcode_no")]);
		$pdf->SetXY($i+52, $j+9);
		$pdf->Write(0, $probram_no);
		$pdf->SetXY($i+52, $j+12);
		$pdf->Write(0, "$internal_ref");
		$pdf->SetXY($i, $j+15.5);
		$pdf->Write(0, "M/C:" . $machine_name . "," . $machine_dia_width . "X" . $machine_gauge. ",SL:". trim($stitch_length).",".trim($tube_type));

		$pdf->SetXY($i, $j+19);
		$pdf->Write(0,  $constuction . "," . $body_part_name );
		$pdf->SetXY($i, $j+23);
		$pdf->Write(0,  substr($comp, 0, 80));

		$pdf->SetXY($i, $j+27);
		$pdf->Write(0, "YC:".substr($yarn_count, 0, 35).", Lot:".substr($yarn_lot, 0, 45));
		$pdf->SetXY($i, $j+31);
		$pdf->Write(0, "Brnd:". substr($brand_arr[$brand_id], 0, 70));
		$pdf->SetXY($i, $j+35);
		$pdf->Write(0, $avg_color.",Color:" .substr($color, 0, 50));
		$pdf->SetXY($i, $j+39);
		$pdf->Write(0, "Qty:" .$row[csf("qnty")].", Rej. Qty:" .$row[csf("reject_qnty")].", Roll No:" .$row[csf('roll_no')].", Shift:" .$shift_name[$row[csf('shift_name')]]);
		$pdf->SetXY($i, $j+43);
		//." B: " . $po_array[$row[csf('po_breakdown_id')]]['booking_no']
		$pdf->Write(0, "P.ID:".$recv_number_prefix_num.", P Date:".change_date_format($receive_date).",FB No:" . $fabric_booking_no);
		$pdf->SetXY($i, $j+47);
		//." B: " . $po_array[$row[csf('po_breakdown_id')]]['booking_no']
		if($body_part_type==40)
		{
			$pdf->Write(0, "Clr Size:".$row[csf('coller_cuff_size')].", Qnty:".$row[csf('qc_pass_qnty_pcs')].",GSM:". $gsm . ",F Dia:" . $finish_dia);
		}

		else if($body_part_type==50)
		{
			$pdf->Write(0, "Cuff Size:".$row[csf('coller_cuff_size')].", Qnty:".$row[csf('qc_pass_qnty_pcs')].",GSM:". $gsm . ",F Dia:" . $finish_dia);
		}
		else $pdf->Write(0, "GSM:". $gsm . ",F Dia:" . $finish_dia);

		//$pdf->Write(0, $row[csf("barcode_no")]. ",Dt:".change_date_format($receive_date). ",Pg:".$program_no. ",S:".$shift_name[$row[csf('shift_name')]]);

		//$pdf->SetXY($i, $j+14);
		//." B: " . $po_array[$row[csf('po_breakdown_id')]]['booking_no']
		//$pdf->Write(0, "$company_short_name.":" . $po_array[$row[csf('po_breakdown_id')]]['booking_no'].","M/C:" . $machine_name . "," . $machine_dia_width . "X" . $machine_gauge. ",RW:" . number_format($row[csf('qnty')], 2, '.', ''));

		//$pdf->SetXY($i, $j+18);
		//$pdf->Write(0, $buyer_name . ",Po:" . $order_no);//24

		//$pdf->SetXY($i, $j+22);
		//$pdf->Write(0, "Clr:" .substr($color, 0, 35));

		//$pdf->SetXY($i, $j+26);
		//$pdf->Write(0, "Ct:".$yarn_count.",Lt:".$yarn_lot);

		//$pdf->SetXY($i, $j+30);
		//$pdf->Write(0, "Br:". $brand.",".$constuction);
//
		//$pdf->SetXY($i, $j+34);
		//$pdf->Write(0, substr($comp, 0, 45));

		//$pdf->SetXY($i, $j+38);
		//$pdf->Write(0, "G/F Dia:" . $grey_dia. "," . trim($finish_dia).",GSM:". $gsm.",SL:" . trim($stitch_length));

		//$pdf->SetXY($i, $j+42);
		//$pdf->Write(0, "Prd:".$row[csf('recv_number_prefix_num')]. ",RL No:" . $row[csf('roll_no')] .",ID:" .$user_arr[$row[csf('inserted_by')]]);
	//"D/T: " .trim($tube_type).

		$k++;
		$br++;
	}

	foreach (glob("*".$userid.".pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'_'.$userid.'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}

if ($action == "print_barcode_one_88Y") // For Youth Group Create by Tipu
{
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');


	$data = explode("***", $data);
	//$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$user_arr = return_library_array("select id, user_name from user_passwd", 'id', 'user_name');
	//$brand_id_arr = return_library_array("select lot, brand from product_details_master where item_category_id=1", 'lot', 'brand');
	///print_r($brand_id_arr['6112018']);die;
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');
	//quality_level
	$sql = "select a.company_id,a.receive_basis,a.recv_number_prefix_num, a.booking_id,a.location_id,a.store_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name,b.body_part_id,b.floor_id from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	foreach ($result as $row) 
	{
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
			$location_name = return_field_value("location_name", "lib_location", "id=" . $row[csf('location_id')]);
			//$floor_name = return_library_array("select id, floor_name from lib_prod_floor", 'id', 'floor_name');
			$floor_name = return_field_value("floor_name", "lib_prod_floor", "id=" . $row[csf('floor_id')]);
			$prod_floor=",".$floor_name;
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		$body_part_type=return_field_value("body_part_type","lib_body_part","id=".$row[csf('body_part_id')]." and status_active=1");
		//echo $body_part_type;die;
		$receive_date=$row[csf('receive_date')];
		$booking_no = $row[csf('booking_no')];
		$booking_id = $row[csf('booking_id')];
		$booking_without_order = $row[csf('booking_without_order')];
		$receive_basis= $row[csf('receive_basis')];
		$prod_date = date("d-m-Y", strtotime($row[csf('insert_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));
		$body_part_name=$body_part[$row[csf('body_part_id')]];
		$avg_color=$color_range[$row[csf('color_range_id')]];
		$order_id = $row[csf('order_id')];
		$brand_id=$row[csf('brand_id')];
		$recv_number_prefix_num = $row[csf('recv_number_prefix_num')];
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];
		$operator_name = $row[csf('operator_name')];
		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];

		/*$brand='';
		$lot_string = explode(",", $row[csf('yarn_lot')]);
		foreach ($lot_string as $val) {
			if ($val!="") $brand .= $brand_arr[$brand_id_arr[$val]] . ",";
		}
		$brand = chop($brand, ',');*/
		//$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];

			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				//$comp = $determination_sql[0][csf('construction')] . ", ";
				$constuction = $determination_sql[0][csf('construction')];
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);
	}

	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		if ($receive_basis == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $booking_id . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
		} else {

			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$non_internal_ref= return_field_value("grouping", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
		}
	} 
	else 
	{
		$is_salesOrder = 0;
		if ($receive_basis == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $booking_id);
		}

		if ($is_salesOrder == 1) {
			$po_sql = sql_select("select a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no,b.buyer_id,b.quality_level from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				if($row[csf('quality_level')]>0)
				{
				$po_array[$row[csf('id')]]['nature'] = $row[csf('quality_level')];
				}
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
			}
		} else {

			if ($receive_basis == 2)
			{
				$planning_booking_sql = sql_select("select a.quality_level,a.booking_no_prefix_num from wo_booking_mst a,ppl_planning_entry_plan_dtls b where a.booking_no=b.booking_no and   b.dtls_id='" . $booking_id . "'");
			}
			$po_sql = sql_select("select a.job_no,a.job_no_prefix_num,a.buyer_name,b.id,b.grouping,b.po_number,d.quality_level,d.booking_no_prefix_num,d.booking_no from wo_po_details_master a, wo_po_break_down b,wo_booking_dtls c,wo_booking_mst d where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and c.booking_no=d.booking_no and d.booking_type=1 and d.is_short=2 and a.status_active=1 and b.status_active=1 and c.status_active=1 and b.id in($order_id) group by a.job_no,a.job_no_prefix_num,a.buyer_name,b.id,b.grouping,b.po_number,d.quality_level,d.booking_no_prefix_num,d.booking_no");
			
			foreach ($po_sql as $row1) {
				$po_array[$row1[csf('id')]]['no'] = $row1[csf('po_number')];
				$po_array[$row1[csf('id')]]['job_no'] = $row1[csf('job_no')];
				$po_array[$row1[csf('id')]]['prefix'] = $row1[csf('job_no_prefix_num')];
				$po_array[$row1[csf('id')]]['grouping'] = $row1[csf('grouping')];
				if($row1[csf('quality_level')]>0)
				{
				$po_array[$row1[csf('id')]]['nature'] = $row1[csf('quality_level')];
				}
				$po_array[$row1[csf('id')]]['booking_no'] = $row1[csf('booking_no')];


				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row1[csf('buyer_name')]);
			}
		}
	}


	if ($receive_basis == 2)
	{
		$probram_no=$booking_no;
	}
	else $probram_no="";
	$barcode_array = array();
	//$query = "select a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$query = "select a.id,a.inserted_by, a.roll_no,b.reject_qnty,a.qc_pass_qnty_pcs,a.coller_cuff_size, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade,c.shift_name from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no left join pro_grey_prod_entry_dtls c on a.dtls_id=c.id where a.id in($data[0])";
	$res = sql_select($query);

	$brand_arr = return_library_array("select id, brand_name from lib_brand where id=$brand_id", 'id', 'brand_name');

	$pdf=new PDF_Code128('P','mm',array(60,44));

	$pdf->SetAutoPageBreak(false);
	$pdf->AddPage();
	$pdf->SetFont('Arial','IB',7);

	$i=1; $j=1; $k=0; $br=0; $n=0;
	foreach ($res as $row) 
	{
		$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		$order_nature = $fbooking_order_nature[$po_array[$row[csf('po_breakdown_id')]]['nature']];
		//echo $nature.'DDDDDDDDD';
		if ($receive_basis == 1)
		{
			$fabric_booking_no=$booking_no;
		}
		else
		{
			$fabric_booking_no=$po_array[$row[csf('po_breakdown_id')]]['booking_no'];
		}
		if ($receive_basis == 1 && $booking_without_order=1)
		{
			$internal_ref=$non_internal_ref;
		}
		else
		{
			if($po_array[$row[csf('po_breakdown_id')]]['grouping']!="") $internal_ref=$po_array[$row[csf('po_breakdown_id')]]['grouping'];
			else $internal_ref="";
		}
		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=1; $j=1; $k=0;
		}

		$pdf->SetXY($i, $j+2.5);
		$pdf->Write(0, $party_name."".$prod_floor.",".$buyer_name);
		$pdf->Code128($i,$j+5,$row[csf("barcode_no")],35,7);

		$pdf->SetXY($i+35, $j+6);
		$pdf->Write(0, substr($internal_ref, 0, 15));
		$pdf->SetXY($i+35, $j+9);
		$pdf->Write(0, $probram_no);

		$pdf->SetXY($i, $j+15.5);
		$pdf->Write(0, "M/C:" . $machine_name . "," . $machine_dia_width . "X" . $machine_gauge. ",SL:". substr(trim($stitch_length), 0, 15).",".trim($tube_type).','.$finish_dia);

		$pdf->SetXY($i, $j+19);
		$pdf->Write(0, $constuction.",GSM:". $gsm);

		$pdf->SetXY($i, $j+23);
		$pdf->Write(0, substr($yarn_count, 0, 35).",".substr($brand_arr[$brand_id], 0, 70).",Lot:".substr($yarn_lot, 0, 14));

		$pdf->SetXY($i, $j+26.5);
		$pdf->Write(0, substr($comp, 0, 45));

		$pdf->SetXY($i, $j+30);
		$pdf->Write(0, $avg_color.",Color:" .substr($color, 0, 50));

		$pdf->SetXY($i, $j+34);
		$pdf->Write(0, "KG:" .$row[csf("qnty")].",Pcs:" .$row[csf("qc_pass_qnty_pcs")].",Rej:" .$row[csf("reject_qnty")].','.date_format(date_create($receive_date),"d-m-y").",Shf:" .$shift_name[$row[csf('shift_name')]].",EI:".$operator_name);
		// .",".substr($operator_name_arr[$operator_name], 0, 6)

		$pdf->SetXY($i, $j+38);
		$pdf->Write(0, "P.ID:".$recv_number_prefix_num."," . $fabric_booking_no.",".$row[csf("barcode_no")].",".$row[csf('coller_cuff_size')]);

		$k++;
		$br++;
	}

	foreach (glob("*".$userid.".pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'_'.$userid.'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}

if ($action == 'print_barcode_metro') {
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');

	$data = explode("***", $data);
	$user_arr = return_library_array("select id, user_name from user_passwd", 'id', 'user_name');
	//$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	//$brand_id_arr = return_library_array("select lot, brand from product_details_master where item_category_id=1", 'lot', 'brand');
	///print_r($brand_id_arr['6112018']);die;
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');
	// $floor_name_arr = return_library_array("select id, floor_name from lib_prod_floor", 'id', 'floor_name');
	//quality_level
	$sql = "select a.company_id,a.receive_basis,a.recv_number_prefix_num, a.booking_id, a.location_id, a.store_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm, b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id, b.operator_name, b.body_part_id, b.floor_id, b.shift_name, b.grey_receive_qnty_pcs
	from inv_receive_master a, pro_grey_prod_entry_dtls b
	where a.id=b.mst_id and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	foreach ($result as $row) 
	{
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
			$location_name = return_field_value("location_name", "lib_location", "id=" . $row[csf('location_id')]);
			$location_store=",".$location_name.", ".$floor_name;
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		$floor_name = return_field_value("floor_name", "lib_prod_floor", "id=" . $row[csf('floor_id')]);

		$body_part_type=return_field_value("body_part_type","lib_body_part","id=".$row[csf('body_part_id')]." and status_active=1");
		//echo $body_part_type;die;
		$receive_date=$row[csf('receive_date')];
		$booking_no = $row[csf('booking_no')];
		$booking_id = $row[csf('booking_id')];
		$booking_without_order = $row[csf('booking_without_order')];
		$receive_basis= $row[csf('receive_basis')];
		$prod_date = date("d-m-Y", strtotime($row[csf('insert_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));
		$body_part_name=$body_part[$row[csf('body_part_id')]];
		$color_range=$color_range[$row[csf('color_range_id')]];
		$order_id = $row[csf('order_id')];
		$brand_id=$row[csf('brand_id')];
		$recv_number_prefix_num = $row[csf('recv_number_prefix_num')];
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];
		$operator_name = $operator_name_arr[$row[csf('operator_name')]];
		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		$shift = $row[csf('shift_name')];
		$qtyInPcs = $row[csf('grey_receive_qnty_pcs')];
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];

		/*$brand='';
		$lot_string = explode(",", $row[csf('yarn_lot')]);
		foreach ($lot_string as $val) {
			if ($val!="") $brand .= $brand_arr[$brand_id_arr[$val]] . ",";
		}
		$brand = chop($brand, ',');*/
		//$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];

			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				//$comp = $determination_sql[0][csf('construction')] . ", ";
				$construction = $determination_sql[0][csf('construction')];
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);
	}

	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		if ($receive_basis == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $booking_id . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
		} else {

			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$non_internal_ref= return_field_value("grouping", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
		}
	} 
	else 
	{
		$is_salesOrder = 0;
		if ($receive_basis == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $booking_id);
		}

		if ($is_salesOrder == 1) {
			$po_sql = sql_select("select a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no,b.buyer_id,b.quality_level
				from fabric_sales_order_mst a
				inner join wo_booking_mst b on a.sales_booking_no = b.booking_no
				where a.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				if($row[csf('quality_level')]>0)
				{
				$po_array[$row[csf('id')]]['nature'] = $row[csf('quality_level')];
				}
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
			}
		} else {

			if ($receive_basis == 2) {
				$planning_booking_result = sql_select("select a.quality_level, a.booking_no_prefix_num, a.booking_no, b.po_id from wo_booking_mst a,ppl_planning_entry_plan_dtls b where a.booking_no=b.booking_no and b.dtls_id='" . $booking_id . "'");

				foreach ($planning_booking_result as $row) {
					$po_array[$row[csf('po_id')]]['booking_no'] = $row[csf('booking_no')];
				}
			}
			$po_sql = sql_select("select a.job_no,a.job_no_prefix_num,a.buyer_name,b.id,b.grouping,b.po_number,d.quality_level,d.booking_no_prefix_num,c.booking_no,a.style_ref_no
				from wo_po_details_master a, wo_po_break_down b, wo_booking_dtls c, wo_booking_mst d
				where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and c.booking_no=d.booking_no and d.booking_type=1 and d.is_short=2 and a.status_active=1 and b.status_active=1 and c.status_active=1 and b.id in($order_id)
				group by a.job_no,a.job_no_prefix_num,a.buyer_name,b.id,b.grouping,b.po_number,d.quality_level,d.booking_no_prefix_num,c.booking_no,a.style_ref_no");
			
			foreach ($po_sql as $row1) {
				$po_array[$row1[csf('id')]]['no'] = $row1[csf('po_number')];
				$po_array[$row1[csf('id')]]['job_no'] = $row1[csf('job_no')];
				$po_array[$row1[csf('id')]]['prefix'] = $row1[csf('job_no_prefix_num')];
				$po_array[$row1[csf('id')]]['grouping'] = $row1[csf('grouping')];
				$po_array[$row1[csf('id')]]['style'] = $row1[csf('style_ref_no')];
				if($row1[csf('quality_level')]>0)
				{
				$po_array[$row1[csf('id')]]['nature'] = $row1[csf('quality_level')];
				}
				if ($receive_basis != 2) {
					$po_array[$row1[csf('id')]]['booking_no'] = $row1[csf('booking_no')];
				}

				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row1[csf('buyer_name')]);
			}
		}
	}


	if ($receive_basis == 2) {
		$probram_no=$booking_no;
	}
	else $probram_no="";
	$barcode_array = array();
	//$query = "select a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$query = "select a.id,a.inserted_by, a.roll_no, b.reject_qnty, a.qc_pass_qnty_pcs, a.coller_cuff_size, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade, c.shift_name, c.reject_fabric_receive
	from pro_roll_details a
	left join pro_qc_result_mst b on a.barcode_no=b.barcode_no
	left join pro_grey_prod_entry_dtls c on a.dtls_id=c.id
	where a.id in($data[0])";
	$res = sql_select($query);

	$brand_arr = return_library_array("select id, brand_name from lib_brand where id=$brand_id", 'id', 'brand_name');
	/*if($body_part_type==40 || $body_part_type==50)
	{
		$pdf=new PDF_Code128('P','mm',array(88,53));
	}
	else */
	$pdf=new PDF_Code128('P', 'mm', array(60,42));
	$pdf->AddPage();

	$pdf->SetAutoPageBreak(false);
	$pdf->SetRightMargin(0);
	// $pdf->SetFont('Arial', 'B', 7);

	$i=1; $j=1; $k=0; $br=0; $n=0;
	foreach ($res as $row) {
		$floor_name = substr($floor_name, 0, 5);
		$machine_name = substr($machine_name, 0, 5);
		$operatorName = substr($operator_name, 0, 13);
		$construction = substr($construction, 0, 13);
		$charCount = 26;
		$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		$style = $po_array[$row[csf('po_breakdown_id')]]['style'];
		$lotCharCount = strlen($yarn_lot);
		$styleCharCount = strlen($style);
		$size = $row[csf('coller_cuff_size')];
		$remainingCount = $charCount - $lotCharCount;
		$order_nature = $fbooking_order_nature[$po_array[$row[csf('po_breakdown_id')]]['nature']];
		$buyer_name = substr($buyer_name, 0, 24);
		$color = substr($color, 0, 30);
		$comp = substr($comp, 0, 38);
		$qcPassQty = $row[csf('qc_pass_qnty_pcs')];

		if ($remainingCount < $styleCharCount) {
			$style = substr($style, 0, $remainingCount);
		}

		// $style = "$charCount, $lotCharCount, $styleCharCount, $remainingCount";
		
		// $operator_name = substr($operator_name, 0, 3);
		//echo $nature.'DDDDDDDDD';
		if ($receive_basis == 1) {
			$fabric_booking_no=$booking_no;
		} else {
			$fabric_booking_no=$po_array[$row[csf('po_breakdown_id')]]['booking_no'] . '(S)';
		}
		if ($receive_basis == 1 && $booking_without_order=1) {
			$internal_ref=$non_internal_ref;
		} else {
			if($po_array[$row[csf('po_breakdown_id')]]['grouping']!="") $internal_ref=$po_array[$row[csf('po_breakdown_id')]]['grouping'];
			else $internal_ref="";
		}
		if($br==1) {
			$pdf->AddPage();
			$br=0; $i=1; $j=1; $k=0;
		}

		$pdf->SetFont('Arial', 'B', 7);
		$pdf->SetXY($i, $j+1);
		$pdf->Write(0, "F- {$floor_name},MC- {$machine_name},DXG- {$machine_dia_width}X{$machine_gauge},DT- {$receive_date}");

		$pdf->Code128(3, $j+3,$row[csf("barcode_no")],45,5);
		$pdf->SetXY($i, $j+9.5);
		$pdf->Write(0, "FD- {$machine_dia_width}/{$finish_dia}, {$tube_type},SL- {$stitch_length}");
		$pdf->SetXY($i, $j+12.3);
		$pdf->Write(0, "{$buyer_name},Melange- {$color_range}");
		$pdf->SetXY($i, $j+15);
		$pdf->Write(0, "C- {$color}");
		$pdf->SetXY($i, $j+18);
		$pdf->Write(0, "{$body_part_name},FT- {$construction}" );
		$pdf->SetXY($i, $j+22);
		$pdf->Write(0, "Y-{$yarn_count},B- ".substr($brand_arr[$brand_id], 0, 15));
		$pdf->SetXY($i, $j+26);
		$pdf->Write(0, "L- {$yarn_lot},FG- {$gsm},ST- {$style}");
		$pdf->SetXY($i, $j+30);
		$pdf->Write(0, "COM- {$comp}");
		$pdf->SetFont('Arial', 'B', 7);
		$pdf->SetXY($i, $j+33);
		$pdf->Write(0, "Rej- {$row[csf("reject_fabric_receive")]},PCS- {$qcPassQty},S- {$shift_name[$shift]},OP- $operatorName");
		$pdf->SetXY($i, $j+36.5);
		$pdf->Write(0, "{$fabric_booking_no},R- {$row[csf('roll_no')]},W- {$row[csf("qnty")]},SZ- {$size}");
		$pdf->SetXY($i, $j+39.5);
		$pdf->Write(0, "VC- {$row[csf("barcode_no")]},PO- {$order_no}");
		// $pdf->Write(0, "WWWWWWWWWWWWWWWWWWWWWWWW"); // 24 character
		// $pdf->SetXY($i, $j+42);

		$k++;
		$br++;
	}

	foreach (glob("*".$userid.".pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'_'.$userid.'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}



if ($action == "print_barcode_one_128_v2_old") {
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');


	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$user_arr = return_library_array("select id, user_name from user_passwd", 'id', 'user_name');
	$brand_id_arr = return_library_array("select lot, brand from product_details_master where item_category_id=1", 'lot', 'brand');
	///print_r($brand_id_arr['6112018']);die;
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');

	$sql = "select a.company_id,a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		$receive_date=$row[csf('receive_date')];
		$booking_no = $row[csf('booking_no')];
		$booking_without_order = $row[csf('booking_without_order')];

		$prod_date = date("d-m-Y", strtotime($row[csf('insert_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));

		$order_id = $row[csf('order_id')];
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];
		$operator_name = $row[csf('operator_name')];
		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];

		$brand='';
		$lot_string = explode(",", $row[csf('yarn_lot')]);
		foreach ($lot_string as $val) {
			if ($val > 0) $brand .= $brand_arr[$brand_id_arr[$val]] . ",";
		}
		$brand = chop($brand, ',');
		//$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];
			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				//$comp = $determination_sql[0][csf('construction')] . ", ";
				$constuction = $determination_sql[0][csf('construction')];
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);
	}

	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		if ($row[csf("receive_basis")] == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $row[csf("booking_id")] . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
		}
	} else {
		$is_salesOrder = 0;
		if ($row[csf("receive_basis")] == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $row[csf("booking_id")]);
		}
		if ($is_salesOrder == 1) {
			$po_sql = sql_select("select a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
			}
		} else {
			$po_sql = sql_select("select a.job_no,a.job_no_prefix_num,a.buyer_name,b.id,b.po_number,d.booking_no_prefix_num from wo_po_details_master a, wo_po_break_down b,wo_booking_dtls c,wo_booking_mst d where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and c.booking_no=d.booking_no and d.booking_type=1 and d.is_short=2 and a.status_active=1 and b.status_active=1 and c.status_active=1 and b.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['booking_no'] = $row[csf('booking_no_prefix_num')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_name')]);
			}
		}
	}
	$i = 1;
	$barcode_array = array();
	//$query = "select a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$query = "select a.id,a.inserted_by, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade,c.shift_name,d.recv_number_prefix_num from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no left join pro_grey_prod_entry_dtls c on a.dtls_id=c.id left join inv_receive_master d on c.mst_id=d.id where a.id in($data[0])";
	$res = sql_select($query);


	$pdf=new PDF_Code128('P','mm',array(80,72));
	$pdf->AddPage();
	$pdf->SetFont('Times','',11);


	$i=2; $j=3; $k=0; $br=0; $n=0;
	foreach ($res as $row) {


		$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=2; $j=3; $k=0;
		}
		$pdf->SetXY($i, $j);
		$pdf->Write(0, $row[csf("barcode_no")]. " Date:".change_date_format($receive_date));

		$pdf->SetXY($i, $j+4);
		$pdf->Write(0, $buyer_name . ",Po: " . $order_no);//24

		$pdf->SetXY($i, $j+8);
		$pdf->Write(0, "M/C: " . $machine_name . "; M/C Dia X GG-" . $machine_dia_width . "X" . $machine_gauge );//24

		//1
		//$pdf->SetXY($i, $j);
		//$pdf->Write(0, $row[csf("barcode_no")]. " ".$company_short_name." Job No." . $po_array[$row[csf('po_breakdown_id')]]['prefix']);


		//2
		//$pdf->SetXY($i, $j+3.3);
		//$pdf->Write(0, "M/C: " . $machine_name . "; M/C Dia X GG-" . $machine_dia_width . "X" . $machine_gauge );//24

		//3
		//$pdf->SetXY($i, $j+6.6);
		//$pdf->Write(0, "Date: " . $prod_date ." ".$buyer_name);

		$pdf->SetXY($i, $j+12);
		$pdf->Write(0, "Prg:" . $program_no . ";RW: " . number_format($row[csf('qnty')], 2, '.', ''). "Kg".";Job." . $po_array[$row[csf('po_breakdown_id')]]['prefix']);

		//$pdf->Write(0, "Po: " . $order_no);//24 $style_name

		$pdf->SetXY($i, $j+16);
		$pdf->Write(0, $company_short_name." B: " . $po_array[$row[csf('po_breakdown_id')]]['booking_no']."; S:".$shift_name[$row[csf('shift_name')]]."; Prd:".$row[csf('recv_number_prefix_num')]);

		//$pdf->Write(0, $comp);
		$pdf->SetXY($i, $j+20);
		$pdf->Write(0, "Ct:".$yarn_count);

		$pdf->SetXY($i, $j+24);
		$pdf->Write(0, "Lt: " . $yarn_lot);
		//$pdf->Write(0, "G/Dia: " . $grey_dia. "; F/Dia: " . trim($finish_dia). ";F/GSM: " . $gsm);

		$pdf->SetXY($i, $j+28);
		$pdf->Write(0, $constuction);
		//$pdf->Write(0, "Count:".$yarn_count . "; Lot: " . $yarn_lot);
		$pdf->SetXY($i, $j+32);
		$pdf->Write(0, $comp);
		//$pdf->Write(0, "SL: " . trim($stitch_length).";Clr: " .substr($color, 0, 25));

		$pdf->SetXY($i, $j+36);
		$pdf->Write(0, "F/GSM: " . $gsm.";D/T: " .trim($tube_type));

		//$pdf->Write(0, "Prg: " . $program_no . "; Roll Wt: " . number_format($row[csf('qnty')], 2, '.', ''). " Kg");

		$pdf->SetXY($i, $j+40);
		$pdf->Write(0, "G/Dia: " . $grey_dia. "; F/Dia: " . trim($finish_dia)."; Br:". $brand);

		//$pdf->Write(0, "Roll No: " . $row[csf('roll_no')] .";D/Type: " .trim($tube_type));

		$pdf->SetXY($i, $j+44);
		$pdf->Write(0, "Clr: " .substr($color, 0, 35));

		$pdf->SetXY($i, $j+48);
		$pdf->Write(0, "Roll: " . $row[csf('roll_no')] ."SL: " . trim($stitch_length)." ID:" .$user_arr[$row[csf('inserted_by')]]);
		//$pdf->Write(0, "B: " . $po_array[$row[csf('po_breakdown_id')]]['booking_no']."; S:".$shift_name[$row[csf('shift_name')]]."; P:".$row[csf('recv_number_prefix_num')]);

		$pdf->Code128($i+1,$j+51,$row[csf("barcode_no")],50,8);

		$k++;
		$br++;
	}

	foreach (glob("*".$userid.".pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'_'.$userid.'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}


if ($action == "report_barcode_generation") {
	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');

	$sql = "select a.company_id,a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and b.id=$data[1]";
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		$booking_no = $row[csf('booking_no')];
		$booking_without_order = $row[csf('booking_without_order')];

		$prod_date = date("d-m-Y", strtotime($row[csf('insert_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));

		$order_id = $row[csf('order_id')];
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];
		$operator_name = $row[csf('operator_name')];
		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];
		$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];
			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				$comp = $determination_sql[0][csf('construction')] . ", ";
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}
	}

	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		if ($row[csf("receive_basis")] == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $row[csf("booking_id")] . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
		}
	} else {
		$is_salesOrder = 0;
		if ($row[csf("receive_basis")] == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $row[csf("booking_id")]);
		}
		if ($is_salesOrder == 1) {
			$po_sql = sql_select("select a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
			}
		} else {
			$po_sql = sql_select("select a.job_no, a.job_no_prefix_num, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
			}
			$order_no = $po_array[$order_id]['no'];
		}
	}

	$i = 1;
	$barcode_array = array();
	$query = "select a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$res = sql_select($query);
	echo '<table width="800" border="0"><tr>';
	foreach ($res as $row) {
		$barcode_array[$i] = $row[csf('barcode_no')];
		if ($booking_without_order == 1) {
			$txt = $row[csf('barcode_no')] . "; " . $party_name . " Booking No." . $booking_no_prefix . ";<br>";
		} else {
			$txt = $row[csf('barcode_no')] . "; " . $party_name . " Job No." . $po_array[$row[csf('po_breakdown_id')]]['prefix'] . ";<br>";
		}
		$txt .= "M/C: " . $machine_name . "; M/C Dia X Gauge-" . $machine_dia_width . "X" . $machine_gauge . ";<br>";
		$txt .= "Date: " . $prod_date . ";<br>";
		$txt .= "Buyer: " . $buyer_name . ", Order No: " . $order_no . ";<br>";
		$txt .= $comp . "<br>";
		$txt .= "G/Dia: " . $grey_dia . "; SL: " . trim($stitch_length) . "; " . trim($tube_type) . "; F/Dia: " . trim($finish_dia) . ";<br>";
		$txt .= "GSM: " . $gsm . "; ";
		$txt .= $yarn_count . "; Lot: " . $yarn_lot . ";<br>";
		$txt .= "Prg: " . $program_no . "; Roll Wt: " . number_format($row[csf('qnty')], 2, '.', '') . " Kg;<br>";
		$txt .= "Custom Roll No: " . $row[csf('roll_no')] . ";";
		if (trim($color) != "") $txt .= " Color: " . trim($color) . ";<br>";
		if (trim($row[csf('fabric_grade')]) != "") $txt .= "Grade: " . trim($row[csf('fabric_grade')]) . ";";
		if ($operator_name != "") $txt .= "OP: " . $operator_name_arr[$operator_name] . ";";

		echo '<td style="padding-left:7px;padding-top:10px;padding-bottom:5px"><div id="div_' . $i . '"></div>' . $txt . '</td>';//border:dotted;
		if ($i % 3 == 0) echo '</tr><tr>';
		$i++;
	}
	echo '</tr></table>';
	?>

	<script type="text/javascript" src="../../js/jquery.js"></script>
	<script type="text/javascript" src="../../js/jquerybarcode.js"></script>
	<script>
		var barcode_array =<? echo json_encode($barcode_array); ?>;
		function generateBarcode(td_no, valuess) {
            var value = valuess;//$("#barcodeValue").val();
            //alert(value)
            var btype = 'code39';//$("input[name=btype]:checked").val();
            var renderer = 'bmp';// $("input[name=renderer]:checked").val();

            var settings = {
            	output: renderer,
            	bgColor: '#FFFFFF',
            	color: '#000000',
            	barWidth: 1,
            	barHeight: 30,
            	moduleSize: 5,
            	posX: 10,
            	posY: 20,
            	addQuietZone: 1
            };
            //$("#barcode_img_id").html('11');
            value = {code: value, rect: false};

            $("#div_" + td_no).show().barcode(value, btype, settings);
        }

        for (var i in barcode_array) {
        	generateBarcode(i, barcode_array[i]);
        }
    </script>
    <?
    exit();
}

if ($action == "report_barcode_text_file") {
	// var_dump($_REQUEST);
	$data = explode("***", $data);

	// For "Grey Fabric Bar-code Striker Export Report" report page
	if ($data[2] != '' || $data[3] != '') {
		$batch_no_condition = ($data[2] != "") ? " and a.batch_no='" . $data[2] . "'" : "";
		$barcode_condition = ($data[3] != "") ? " and b.barcode_no='" . $data[3] . "'" : "";

		$barcodeData = sql_select("select a.id, a.batch_no,b.barcode_no, b.roll_id, c.dtls_id from pro_batch_create_mst a
			inner join pro_batch_create_dtls b on a.id = b.mst_id inner join pro_roll_details c on b.roll_id = c.id where a.company_id=1 and a.status_active=1 and a.is_deleted=0 $batch_id_condition $batch_no_condition $barcode_condition");
		if (!empty($barcodeData)) {
			foreach ($barcodeData as $value) {
				$barcode_nos .= $value[csf('roll_id')] . ',';
				$dtls_id = $value[csf('dtls_id')];
				$batch_no = $value[csf('batch_no')];
			}
			$data[0] = rtrim($barcode_nos, ',');
			$data[1] = $dtls_id;
		} else {
			echo "Not Found";
		}
	}
	// For "Grey Fabric Bar-code Striker Export Report" report page (end)

	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$machine_no_arr = return_library_array("select id, machine_no from lib_machine_name", 'id', 'machine_no');
	$machine_brand_arr = return_library_array("select id, brand from lib_machine_name", 'id', 'brand'); // Temporary
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');
	$floor_name_arr = return_library_array("select id, floor_name from lib_prod_floor", 'id', 'floor_name');
	//$body_part_type_arr = return_library_array("select id, body_part_type from lib_body_part", 'id', 'body_part_type');
	//$body_part

	$sql_yarn_info=sql_select("select a.prod_id,b.brand,b.yarn_type,b.yarn_comp_type1st,b.yarn_comp_type2nd,b.yarn_comp_percent1st,b.yarn_comp_percent2nd,b.lot,b.yarn_count_id from pro_material_used_dtls a,product_details_master b  where a.prod_id=b.id and  a.mst_id=".$data[4]." and a.dtls_id=".$data[1]." and a.entry_form=2
		and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

	$yarn_information_string=""; $all_yarn_type=''; $yarn_information_string_without_compo=''; $yarn_counter=4;
	$yarn_dtls_arr=array();
	foreach($sql_yarn_info as $p_val)
	{
		$costing_yarn_composition='';
		$costing_yarn_band=$brand_arr[$p_val[csf('brand')]];
		$costing_yarn_lot=trim($p_val[csf('lot')]);
		$costing_yarn_count=$count_arr[$p_val[csf('yarn_count_id')]];
		$costing_yarn_composition=$composition[$p_val[csf('yarn_comp_type1st')]] . " " . $p_val[csf('yarn_comp_percent1st')] . "%";
		if ($p_val[csf('yarn_comp_type2nd')] != 0) $costing_yarn_composition .= " " . $composition[$p_val[csf('yarn_comp_type2nd')]] . " " . $p_val[csf('yarn_comp_percent2nd')] . "%";
		$yarn_information_string.=$costing_yarn_band." ".$costing_yarn_lot." ".$costing_yarn_count." ".$costing_yarn_composition. "\r\n";
		$yarn_information_string_without_compo.=$costing_yarn_band." ".$costing_yarn_lot." ".$costing_yarn_count. "\r\n";
		$all_yarn_type.=",".$yarn_type[$p_val[csf('yarn_type')]];
		$yarn_counter--;
	}

	//echo $yarn_information_string_without_compo."**".$yarn_information_string;die;
	$sql_yarn_infos=sql_select("select b.brand,b.yarn_type,b.yarn_comp_type1st,b.yarn_comp_type2nd,b.yarn_comp_percent1st,b.yarn_comp_percent2nd, b.lot,b.yarn_count_id from product_details_master b  where item_category_id=1 and b.status_active=1 and b.is_deleted=0");

	//$yarn_information_string="";
	//$all_yarn_type='';
	$yarn_dtls_arr=array();
	foreach($sql_yarn_infos as $p_val)
	{
		$yarn_dtls_arr[$p_val[csf('yarn_count_id')]] = $composition[$p_val[csf('yarn_comp_type1st')]] . " " . $p_val[csf('yarn_comp_percent1st')] . "%";
	}

	$sql = "SELECT a.company_id, a.recv_number, a.knitting_location_id, a.location_id, a.receive_basis, a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date, a.buyer_id, a.knitting_source, a.knitting_company,a.yarn_issue_challan_no, b.order_id, b.prod_id, b.gsm, b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.shift_name, b.insert_date,b.operator_name, b.color_range_id, b.body_part_id, b.floor_id  from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and b.id=$data[1]";
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	$shiftName = '';
	$colorRange = '';
	$productionId = '';

	$bodyPartId	= '';

	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}
		$yarn_type_data = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);

		$booking_no = $row[csf('booking_no')];
		$booking_id = $row[csf('booking_id')];
		$operator_name = $operator_name_arr[$row[csf('operator_name')]];
		$floor_name = $floor_name_arr[$row[csf('floor_id')]];
		$yarn_issue_challan_no=$row[csf('yarn_issue_challan_no')];
		$booking_without_order = $row[csf('booking_without_order')];
		$productionId = $row[csf('recv_number')];
		$prod_date = date("d-m-Y", strtotime($row[csf('receive_date')]));
		$location_name=return_field_value("location_name","lib_location", "id=".$row[csf('knitting_location_id')]);
		$order_id = $row[csf('order_id')];
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];
		$shiftName = $shift_name[$row[csf('shift_name')]];

		$colorRange = $color_range[$row[csf('color_range_id')]];
		$bodyPartId	= $body_part[$row[csf('body_part_id')]];


		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');
		if (trim($color) != "") {
			//$color=", ".$color;
			//$color="".$color;
		}

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];
		$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}

		if ($row[csf('receive_basis')] == 0 || $row[csf('receive_basis')] == 1 || $row[csf('receive_basis')] == 4)
		{
			$machine_data = sql_select("select machine_no, dia_width, gauge,brand from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			//$machine_dia_width=$machine_data[0][csf('dia_width')];
			//$machine_gauge=$machine_data[0][csf('gauge')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
			$machine_brand = $row[csf('brand')];
			if($row[csf('receive_basis')]==1)
			{

				$sql_precost_tube=sql_select("select  b.width_dia_type,b.color_type_id from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b where a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no='$booking_no' and a.job_no=b.job_no and a.status_active=1 and a.is_deleted=0 and b.body_part_id=".$row[csf('body_part_id')]." and b.lib_yarn_count_deter_id=".$row[csf('febric_description_id')]."");
				foreach($sql_precost_tube as $t_val)
				{
					$tube_type = $fabric_typee[$t_val[csf('width_dia_type')]];
					$color_type_name = $color_type[$t_val[csf('color_type_id')]];
				}
			}

		}
		else if ($row[csf('receive_basis')] == 2) //Knitting Plan
		{
			$program_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg, b.machine_id, b.batch_no,b.tube_ref_no from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$program_no = $row[csf('booking_id')];
			$grey_dia = $program_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$program_data[0][csf('width_dia_type')]];
			$machine_dia_width = $program_data[0][csf('machine_dia')];
			$machine_gauge = $program_data[0][csf('machine_gg')];
			$batch_no = $program_data[0][csf('batch_no')];
			$tube_ref_no = $program_data[0][csf('tube_ref_no')];
			//$machine_no_arr
			$machine_brand = $machine_brand_arr[$row[csf('machine_no_id')]];
			$machine_name = $machine_no_arr[$row[csf('machine_no_id')]];
			//$machine_name=explode(",",$program_data[0][csf('machine_id')]);
			$row[csf("within_group")] = $program_data[0][csf('within_group')];
		}

		//$location_name=return_field_value("location_name","lib_location", "id=".$row[csf('location_id')]);
		//$buyer_name=return_field_value("short_name","lib_buyer", "id=".$row[csf('buyer_id')]);
		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id='" . $row[csf('buyer_id')] . "'");
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);


		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				$comp = $determination_sql[0][csf('construction')] . ", ";
				$construction = $determination_sql[0][csf('construction')];
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
				$composi .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}
	}


	//echo "select a.job_no,a.job_no_prefix_num,b.id,b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id)";
	//echo $booking_without_order."Unable to open file!";die;
	$po_array = array();
	$booking_no_prefix = '';

	if ($booking_without_order == 1)
	{
		//echo $booking_without_order."Unable to open file!";die;
		//$booking_no_prefix=return_field_value("booking_no_prefix_num","wo_non_ord_samp_booking_mst", "booking_no='".$booking_no."'");
		if ($row[csf("receive_basis")] == 4) {

			$fb_sales_sql = "select id,job_no_prefix_num,job_no,style_ref_no,within_group from fabric_sales_order_mst where id = " . $row[csf('booking_id')];
			$fb_salesResult = sql_select($fb_sales_sql);
			$booking_no_prefix = $fb_salesResult[0][csf('job_no_prefix_num')];
			$full_booking_no = $fb_salesResult[0][csf('job_no')];
			$style_ref_no = $fb_salesResult[0][csf('style_ref_no')];
			$sales_id = $fb_salesResult[0][csf('id')];

			//$booking_no_prefix=return_field_value("job_no_prefix_num","fabric_sales_order_mst", "id='".$row[csf("booking_id")]."'");
			//$full_booking_no=return_field_value("job_no","fabric_sales_order_mst", "id='".$row[csf("booking_id")]."'");
			$no_arr = explode("-", $full_booking_no);
			array_shift($no_arr); //remove 1st index
			$full_booking_no = implode("-", $no_arr);
			//$style_ref_no=return_field_value("style_ref_no","fabric_sales_order_mst", "id='".$row[csf("booking_id")]."'");
			//$sales_id=return_field_value("id","fabric_sales_order_mst", "id='".$row[csf("booking_id")]."'");
			$po_array[$sales_id]['style_ref'] = $style_ref_no;

		}
		else
		{
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$full_booking_no = $booking_no;

			$internal_reference_no = return_field_value("grouping", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");

			$sql_color_type=sql_select("select color_type_id from wo_non_ord_samp_booking_dtls where booking_no='".$booking_no."' and body_part=".$row[csf('body_part_id')]." and lib_yarn_count_deter_id =".$row[csf('febric_description_id')]." and status_active=1 and is_deleted=0  ");
			foreach($sql_color_type as $n_val)
			{
				$color_type_arr[]= $color_type[$n_val[csf('color_type_id')]];
			}
			$color_type_name=implode(",",array_unique($color_type_arr));
		}
		if ($row[csf("receive_basis")] == 2) // Knitting Plan
		{
			//$booking_program=$booking_no;
			$booking_no = return_field_value("b.booking_no as booking_no", "ppl_planning_info_entry_dtls a,ppl_planning_info_entry_mst b", " b.id=a.mst_id and a.id='" . $booking_id . "'", "booking_no");
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$full_booking_no = $booking_no;

			$internal_reference_no = return_field_value("grouping", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");

			$sql_color_type=sql_select("select color_type_id from wo_non_ord_samp_booking_dtls where booking_no='".$booking_no."' and body_part=".$row[csf('body_part_id')]." and lib_yarn_count_deter_id =".$row[csf('febric_description_id')]." and status_active=1 and is_deleted=0  ");
			foreach($sql_color_type as $n_val)
			{
				$color_type_arr[]= $color_type[$n_val[csf('color_type_id')]];
			}
			$color_type_name=implode(",",array_unique($color_type_arr));
			
			// $booking_no=$booking_no.'='.$booking_program;
		}
		// echo "Tipu**".$booking_no;die;
	}
	else
	{
		//echo "reaz**".$booking_no;die;

		$is_salesOrder = 0;
		if ($row[csf("receive_basis")] == 2)
		{
			$booking_no2 =$booking_no;
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id='" . $row[csf("booking_id")] . "'");
			$booking_no = return_field_value("b.booking_no as booking_no", "ppl_planning_info_entry_dtls a,ppl_planning_info_entry_mst b", " b.id=a.mst_id and a.id='" . $booking_id . "'", "booking_no");
			$cound_feed = sql_select("select seq_no,count_id,feeding_id from ppl_planning_count_feed_dtls where dtls_id=" . $row[csf("booking_id")] . " and status_active=1 and is_deleted=0 order by seq_no");

			$fidder_count=4;
			foreach ($cound_feed as $feed_row) {
				$count_feed_arr[] = $feed_row[csf("seq_no")]."*".$feed_row[csf("count_id")]."*".$feed_row[csf("feeding_id")];
				$fidder_count--;
			}

			$sql_color_type=sql_select("select color_type_id from ppl_planning_entry_plan_dtls where dtls_id='".$booking_no2."' and body_part_id=".$row[csf('body_part_id')]."  and status_active=1 and is_deleted=0  ");
			foreach($sql_color_type as $n_val)
			{
				$color_type_arr[]= $color_type[$n_val[csf('color_type_id')]];
			}

			$color_type_name=implode(",",array_unique($color_type_arr));

		}
		if ($is_salesOrder == 1)
		{
			if ($row[csf("within_group")] == 1) {
				$po_sql = sql_select("select a.id, a.job_no as po_number, a.style_ref_no, a.job_no_prefix_num, a.sales_booking_no,b.buyer_id,a.within_group from fabric_sales_order_mst a,wo_booking_mst b where a.sales_booking_no=b.booking_no and a.within_group=1 and a.id in($order_id) union all select a.id, a.job_no as po_number, a.style_ref_no, a.job_no_prefix_num, a.sales_booking_no,b.buyer_id,a.within_group from fabric_sales_order_mst a,wo_non_ord_samp_booking_mst b where a.sales_booking_no=b.booking_no and a.within_group=1 and a.id in($order_id)");
			} else {
				$po_sql = sql_select("select a.id, a.job_no as po_number, a.style_ref_no, a.job_no_prefix_num, a.sales_booking_no,a.buyer_id,a.within_group from fabric_sales_order_mst a where a.id in($order_id)");
			}
			foreach ($po_sql as $row) {
				$no_arr = explode("-", $row[csf('job_no')]);
				array_shift($no_arr); //remove 1st index
				$full_booking_no = implode("-", $no_arr);

				$po_no_arr = explode("-", $row[csf('po_number')]);
				array_shift($po_no_arr); //remove 1st index
				$po_no_arr = implode("-", $po_no_arr);
				$po_array[$row[csf('id')]]['no'] = $po_no_arr;//$row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $full_booking_no;
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
				$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_id')];
			}

			//print_r($po_array);

		}
		else
		{
			$order_id=chop($order_id,",");
			$po_sql = sql_select("select a.job_no, a.style_ref_no, a.buyer_name, a.job_no_prefix_num, b.id, b.po_number, b.grouping, b.file_no from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
				$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
				$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
				$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
			}
		}
	}
	$within_group = $row[csf("within_group")];
	foreach (glob('norsel_bundle_'.$userid."*.zip") as $filename) {
		@unlink($filename);
	}
	//echo $within_group;die;
	//exit;
	$i = 1;
	$zip = new ZipArchive();            // Load zip library
	//$filename = str_replace(".sql", ".zip", "files/".$_SESSION['logic_erp']['user_id']."/norsel_bundle.sql");            // Zip name
	$filename = str_replace(".sql",".zip",'norsel_bundle_'.$userid.".sql");			// Zip name
	if ($zip->open($filename, ZIPARCHIVE::CREATE) !== TRUE) {        // Opening zip file to load files
		$error .= "* Sorry ZIP creation failed at this time<br/>";
		echo $error;
	}

	$i = 1;
	$year = date("y");
	$query = "select a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty,a.reject_qnty, b.batch_wgt,qc_pass_qnty_pcs,coller_cuff_size  from pro_roll_details a left join pro_grey_batch_dtls b on a.id = b.roll_id where a.id in($data[0]) order by a.barcode_no asc";
	//echo $query;die;
	$res = sql_select($query);
	$split_data_arr = array();
	$created_files=array();

	//if (!file_exists("files/".$_SESSION['logic_erp']['user_id']."/")) {
	//	mkdir("files/".$_SESSION['logic_erp']['user_id']."/", 0777, true);
	//}

	foreach ($res as $row) {
		$split_roll_id = $row[csf('id')];
		//	$roll_split_query = sql_select("select a.barcode_no, a.qnty, a.id, a.roll_split_from from pro_roll_details a where a.roll_id = $split_roll_id and a.roll_split_from != 0");
		$file_name = "NORSEL-IMPORT_".$userid."_" . $i;
		$created_files[]=$file_name.".txt";
		$myfile = fopen($file_name . ".txt", "w") or die("Unable to open file!");
		$txt = "Norsel_imp\r\n1\r\n";
		if ($booking_without_order == 1)
		{
			$txt .= $party_name . "\r\n";
			$txt .= $booking_no_prefix . "\r\n";
			$txt .= $machine_name . "-" . $machine_dia_width . "X" . $machine_gauge . "\r\n";
			$full_job_no = $full_booking_no;
			//$txt .=$party_name." Booking No.".$booking_no_prefix." M/C:".$machine_name."-".$machine_dia_width."X".$machine_gauge."\r\n";
		}
		else
		{
			$txt .= $party_name . "\r\n";
			$txt .= $po_array[$row[csf('po_breakdown_id')]]['prefix'] . "\r\n";
			$txt .= $machine_name . "-" . $machine_dia_width . "X" . $machine_gauge . "\r\n";
			$full_job_no = $po_array[$row[csf('po_breakdown_id')]]['job_no'];
			//$txt .=$party_name." Job No.".$po_array[$row[csf('po_breakdown_id')]]['prefix']." M/C:".$machine_name."-".$machine_dia_width."X".$machine_gauge."\r\n";
			//$txt .=$party_name." Job No.".$po_array[$row[csf('po_breakdown_id')]]['prefix']." M/C:".$machine_name."-".$machine_dia_width."X".$machine_gauge."\r\n";
		}
		//print_r($roll_split_query);
		/*if (!empty($roll_split_query)) {
			$qnty = number_format($roll_split_query[0]['qnty'], 2, '.', '');
			$barcode = $roll_split_query[0]['barcode_no'];
		} else {*/
			$qnty = number_format($row[csf('QNTY')], 2, '.', '');
			$barcode = $row[csf('barcode_no')];
		//}
		$txt .= $barcode . "\r\n";
		//$txt .="Barcode No: ".$row[csf('barcode_no')]."\r\n";
		$txt .= $barcode . "\r\n";
		$txt .= "" . $prod_date . "\r\n";
		$txt .= $buyer_name . "\r\n";
		$txt .= "" . $po_array[$row[csf('po_breakdown_id')]]['no'] . "\r\n";
		$txt .= "" . $po_array[$row[csf('po_breakdown_id')]]['file_no'] . "\r\n";
		$txt .= "" . $po_array[$row[csf('po_breakdown_id')]]['grouping'] . "\r\n";
		$txt .= $comp . "\r\n";
		$dia_length_tube=trim($grey_dia);
		if($dia_length_tube!="") $dia_length_tube.="/";
		$dia_length_tube.=trim($finish_dia) . " " . trim($stitch_length) . " " . trim($tube_type) . " " . $row[csf('coller_cuff_size')] . "\r\n";
		//$txt .= "" . trim($grey_dia) . "/" . trim($finish_dia) . " " . trim($stitch_length) . " " . trim($tube_type) . "\r\n";
		$txt.=$dia_length_tube;
		$txt .= "" . $gsm . "\r\n";
		$txt .= $yarn_count . "\r\n";//.$brand." Lot:".$yarn_lot."\r\n";
		$txt .= $brand . "\r\n";
		$txt .= $yarn_lot . "\r\n";
		$txt .= "" . $program_no . "\r\n";
		$txt .= $qnty . "Kg\r\n";
		$txt .= $shiftName . "\r\n";
		$txt .= "" . $row[csf('roll_no')] . "\r\n";
		$txt .= trim($color) . "\r\n";
		$txt .= "" . trim($colorRange) . "\r\n";
		$txt .= "" . $po_array[$row[csf('po_breakdown_id')]]['style_ref'] . "\r\n";
		//if ($booking_without_order != 1) {
		$txt .= "" . $booking_no . "\r\n";
		//} else
			//$txt .= " \r\n";
		$txt .= "" . $operator_name . "\r\n";
		$txt .= "" . $productionId . "\r\n";
		$txt .= "Batch No : ". $batch_no . "\r\n";
		$txt .= "Tube Ref : ". $tube_ref_no . "\r\n";
		if ($within_group == 1)
		{
			$txt .= "" . return_field_value("short_name", "lib_buyer", "id=" . $po_array[$row[csf('po_breakdown_id')]]['buyer_name']) . "\r\n";
		}
		else
		{
			$txt .= $buyer_name . "\r\n";
		}
		$txt .= "" . $machine_brand . "\r\n";
		$txt .= "" . $yarn_type[$yarn_type_data] . "\r\n";

		$txt .= "" . $construction . "\r\n";
		$txt .= "" . $composi . "\r\n";
		$txt .= "" . $floor_name . "\r\n";
		$txt .= $machine_name . "\r\n";
		$txt .= $machine_dia_width . "X" . $machine_gauge . "\r\n";
		$txt .= $full_job_no . "\r\n";
		$dia_tube=trim($grey_dia);
		if($dia_tube!="") $dia_tube.="/";
		$dia_tube.=trim($finish_dia) ." ". trim($tube_type) . "\r\n";
		$txt.=$dia_tube;
		//$txt .= "" . trim($grey_dia) . "/" . trim($finish_dia) . " " . trim($tube_type) . "\r\n";
		$txt .= trim($stitch_length) . "\r\n";
		$txt .= "Rej. Qty.:" . $row[csf('reject_qnty')] . "\r\n";
		$txt.=$yarn_information_string;

		if($yarn_counter>0) //blank line for yarn
		{
			for($sl=1;$sl<=$yarn_counter;$sl++)
			{
				$txt .="\r\n";
			}
		}

		$txt.=ltrim($all_yarn_type,","). "\r\n";
		$txt .=$location_name. "\r\n";
		$txt .=$color_type_name. "\r\n";
		//print_r($count_feed_arr);
		/*if(!empty($count_feed_arr)){
			foreach ($count_feed_arr as $feed) {
				$count_feed = explode("*",$feed);
				if(in_array($count_feed[1], $count_id)){
					$composition_name = ",".$yarn_dtls_arr[$count_feed[1]];
				}
				$feeding = ($count_feed[2] >0)?",".$count_feed[2]:"";
				$txt .= $count_arr[$count_feed[1]]."".$feeding."".$composition_name."\r\n";
			}
		}*/
		if($fidder_count==0){$fidder_count=4;}
		if($fidder_count>0) //blank line for feeder
		{
			for($sl=1;$sl<=$fidder_count;$sl++)
			{
				$txt .="\r\n";
			}
		}

		$txt .=$bodyPartId. "\r\n";
		$txt .=$colorRange. "\r\n";
		$txt .=$yarn_information_string_without_compo. "\r\n";

		if($yarn_counter>0) //blank line for yarn
		{
			for($sl=1;$sl<=$yarn_counter;$sl++)
			{
				$txt .="\r\n";
			}
		}

		$txt .=$yarn_issue_challan_no. "\r\n";
		$txt .=$row[csf('qc_pass_qnty_pcs')]. "\r\n";
		$txt .=$row[csf('coller_cuff_size')]. "\r\n";
		$txt .=$internal_reference_no. "\r\n";



		fwrite($myfile, $txt);
		fclose($myfile);

		$i++;
	}

	//echo $txt;die;  $file_name = "NORSEL-IMPORT_".$userid."_" . $i;
	foreach (glob("NORSEL-IMPORT_".$userid."*.txt") as $filenames)
	{
		$zip->addFile($file_folder.$filenames);
	}
	$zip->close();

	foreach (glob("NORSEL-IMPORT_".$userid."*.txt") as $filename)
	{
		@unlink($filename);
	}

	echo 'norsel_bundle_'.$userid; //str_replace(".zip","",$file_folder);//"norsel_bundle";
	exit();
}


if ($action == "save_barcode_for_norsel") {
	$data = explode("***", $data);
	// For "Grey Fabric Bar-code Striker Export Report" report page
	if ($data[2] != '' || $data[3] != '') {
		$batch_no_condition = ($data[2] != "") ? " and a.batch_no='" . $data[2] . "'" : "";
		$barcode_condition = ($data[3] != "") ? " and b.barcode_no='" . $data[3] . "'" : "";

		$barcodeData = sql_select("select a.id, a.batch_no,b.barcode_no, b.roll_id, c.dtls_id from pro_batch_create_mst a
			inner join pro_batch_create_dtls b on a.id = b.mst_id inner join pro_roll_details c on b.roll_id = c.id where a.company_id=1 and a.status_active=1 and a.is_deleted=0 $batch_id_condition $batch_no_condition $barcode_condition");
		if (!empty($barcodeData)) {
			foreach ($barcodeData as $value) {
				$barcode_nos .= $value[csf('roll_id')] . ',';
				$dtls_id = $value[csf('dtls_id')];
				$batch_no = $value[csf('batch_no')];
			}
			$data[0] = rtrim($barcode_nos, ',');
			$data[1] = $dtls_id;
		} else {
			echo "Not Found";
		}
	}
	// For "Grey Fabric Bar-code Striker Export Report" report page (end)

	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$machine_no_arr = return_library_array("select id, machine_no from lib_machine_name", 'id', 'machine_no');
	$machine_brand_arr = return_library_array("select id, brand from lib_machine_name", 'id', 'brand'); // Temporary
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');
	$floor_name_arr = return_library_array("select id, floor_name from lib_prod_floor", 'id', 'floor_name');

	$sql_yarn_info=sql_select("select a.prod_id,b.brand,b.yarn_type,b.yarn_comp_type1st,b.yarn_comp_type2nd,b.yarn_comp_percent1st,b.yarn_comp_percent2nd,b.lot,b.yarn_count_id from pro_material_used_dtls a,product_details_master b  where a.prod_id=b.id and  a.mst_id=".$data[4]." and a.dtls_id=".$data[1]." and a.entry_form=2
		and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

	$yarn_information_string=""; $all_yarn_type='';
	foreach($sql_yarn_info as $p_val)
	{
		$costing_yarn_composition='';
		$costing_yarn_band=$brand_arr[$p_val[csf('brand')]];
		$costing_yarn_lot=trim($p_val[csf('lot')]);
		$costing_yarn_count=$count_arr[$p_val[csf('yarn_count_id')]];
		$costing_yarn_composition=$composition[$p_val[csf('yarn_comp_type1st')]] . " " . $p_val[csf('yarn_comp_percent1st')] . "%";
		if ($p_val[csf('yarn_comp_type2nd')] != 0) $costing_yarn_composition .= " " . $composition[$p_val[csf('yarn_comp_type2nd')]] . " " . $p_val[csf('yarn_comp_percent2nd')] . "%";
		$yarn_information_string.=$costing_yarn_band." ".$costing_yarn_lot." ".$costing_yarn_count." ".$costing_yarn_composition. "\r\n";
		$all_yarn_type.=",".$yarn_type[$p_val[csf('yarn_type')]];

	}

	$sql = "select a.company_id, a.recv_number, a.location_id, a.receive_basis, a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date, a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm, b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.shift_name, b.insert_date,b.operator_name, b.color_range_id, b.floor_id  from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	$shiftName = '';
	$colorRange = '';
	$productionId = '';
	$receive_basis=$row[csf('receive_basis')];
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}
		$yarn_type_data = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);

		$booking_no = $row[csf('booking_no')];
		$booking_id = $row[csf('booking_id')];
		$operator_name = $operator_name_arr[$row[csf('operator_name')]];
		$floor_name = $floor_name_arr[$row[csf('floor_id')]];

		$booking_without_order = $row[csf('booking_without_order')];
		$productionId = $row[csf('recv_number')];

		//$prod_date=date("d-m-Y",strtotime($row[csf('insert_date')]));
		//$prod_time=date("H:i",strtotime($row[csf('insert_date')]));
		$prod_date = date("d-m-Y", strtotime($row[csf('receive_date')]));

		$order_id = $row[csf('order_id')];
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];
		$shiftName = $shift_name[$row[csf('shift_name')]];
		$colorRange = $color_range[$row[csf('color_range_id')]];

		//$color=$color_arr[$row[csf('color_id')]];
		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');
		if (trim($color) != "") {
			//$color=", ".$color;
			//$color="".$color;
		}

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];
		$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}

		if ($row[csf('receive_basis')] == 0 || $row[csf('receive_basis')] == 1 || $row[csf('receive_basis')] == 4) {
			$machine_data = sql_select("select machine_no, dia_width, gauge,brand from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			//$machine_dia_width=$machine_data[0][csf('dia_width')];
			//$machine_gauge=$machine_data[0][csf('gauge')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
			$machine_brand = $row[csf('brand')];
			if($row[csf('receive_basis')]==1)
			{

				$sql_precost_tube=sql_select("select  b.width_dia_type from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b where a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no='$booking_no' and a.job_no=b.job_no and a.status_active=1 and a.is_deleted=0 and b.lib_yarn_count_deter_id=".$row[csf('febric_description_id')]."");
				foreach($sql_precost_tube as $t_val)
				{
					$tube_type = $fabric_typee[$t_val[csf('width_dia_type')]];
				}
			//	echo $sql_precost_tube;die;
				//$grey_dia = $program_data[0][csf('machine_dia')];
				//$tube_type = $fabric_typee[$program_data[0][csf('width_dia_type')]];
			}

		} else if ($row[csf('receive_basis')] == 2) //Knitting Plan
		{
			$program_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg, b.machine_id from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$program_no = $row[csf('booking_id')];
			$grey_dia = $program_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$program_data[0][csf('width_dia_type')]];
			$machine_dia_width = $program_data[0][csf('machine_dia')];
			$machine_gauge = $program_data[0][csf('machine_gg')];
			//$machine_no_arr
			$machine_brand = $machine_brand_arr[$row[csf('machine_no_id')]];
			$machine_name = $machine_no_arr[$row[csf('machine_no_id')]];
			//$machine_name=explode(",",$program_data[0][csf('machine_id')]);
			$row[csf("within_group")] = $program_data[0][csf('within_group')];
		}

		//$location_name=return_field_value("location_name","lib_location", "id=".$row[csf('location_id')]);
		//$buyer_name=return_field_value("short_name","lib_buyer", "id=".$row[csf('buyer_id')]);
		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id='" . $row[csf('buyer_id')] . "'");
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);


		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				$comp = $determination_sql[0][csf('construction')] . ", ";
				$construction = $determination_sql[0][csf('construction')];
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
				$composi .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}
	}


	//echo "select a.job_no,a.job_no_prefix_num,b.id,b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id)";
	//echo $booking_id;die;
	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		//$booking_no_prefix=return_field_value("booking_no_prefix_num","wo_non_ord_samp_booking_mst", "booking_no='".$booking_no."'");
		if ($row[csf("receive_basis")] == 4) {

			$fb_sales_sql = "select id,job_no_prefix_num,job_no,style_ref_no,within_group from fabric_sales_order_mst where id = " . $row[csf('booking_id')];
			$fb_salesResult = sql_select($fb_sales_sql);
			$booking_no_prefix = $fb_salesResult[0][csf('job_no_prefix_num')];
			$full_booking_no = $fb_salesResult[0][csf('job_no')];
			$style_ref_no = $fb_salesResult[0][csf('style_ref_no')];
			$sales_id = $fb_salesResult[0][csf('id')];

			//$booking_no_prefix=return_field_value("job_no_prefix_num","fabric_sales_order_mst", "id='".$row[csf("booking_id")]."'");
			//$full_booking_no=return_field_value("job_no","fabric_sales_order_mst", "id='".$row[csf("booking_id")]."'");
			$no_arr = explode("-", $full_booking_no);
			array_shift($no_arr); //remove 1st index
			$full_booking_no = implode("-", $no_arr);
			//$style_ref_no=return_field_value("style_ref_no","fabric_sales_order_mst", "id='".$row[csf("booking_id")]."'");
			//$sales_id=return_field_value("id","fabric_sales_order_mst", "id='".$row[csf("booking_id")]."'");
			$po_array[$sales_id]['style_ref'] = $style_ref_no;

		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$full_booking_no = $booking_no;
		}
	} else {
		$is_salesOrder = 0;
		if ($row[csf("receive_basis")] == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id='" . $row[csf("booking_id")] . "'");
			$booking_no = return_field_value("b.booking_no as booking_no", "ppl_planning_info_entry_dtls a,ppl_planning_info_entry_mst b", " b.id=a.mst_id and a.id='" . $booking_id . "'", "booking_no");
		}
		if ($is_salesOrder == 1) {
			//echo "select a.id, a.job_no as po_number, a.style_ref_no, a.job_no_prefix_num, a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a,wo_booking_mst b where a.sales_booking_no=b.booking_no and id in($order_id)";
			if ($row[csf("within_group")] == 1) {
				$po_sql = sql_select("select a.id, a.job_no as po_number, a.style_ref_no, a.job_no_prefix_num, a.sales_booking_no,b.buyer_id,a.within_group from fabric_sales_order_mst a,wo_booking_mst b where a.sales_booking_no=b.booking_no and a.id in($order_id)");
			} else {
				$po_sql = sql_select("select a.id, a.job_no as po_number, a.style_ref_no, a.job_no_prefix_num, a.sales_booking_no,a.buyer_id,a.within_group from fabric_sales_order_mst a where a.id in($order_id)");
			}
			foreach ($po_sql as $row) {
				$no_arr = explode("-", $row[csf('job_no')]);
				array_shift($no_arr); //remove 1st index
				$full_booking_no = implode("-", $no_arr);

				$po_no_arr = explode("-", $row[csf('po_number')]);
				array_shift($po_no_arr); //remove 1st index
				$po_no_arr = implode("-", $po_no_arr);
				$po_array[$row[csf('id')]]['no'] = $po_no_arr;//$row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $full_booking_no;
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
				$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_id')];

			}

			//print_r($po_array);

		} else {
			$po_sql = sql_select("select a.job_no, a.style_ref_no, a.buyer_name, a.job_no_prefix_num, b.id, b.po_number, b.grouping, b.file_no from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
				$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
				$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
				$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
			}
		}
	}
	$within_group = $row[csf("within_group")];



	$i = 1;
	$year = date("y");
	$query = "select a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty,a.reject_qnty, b.batch_wgt from pro_roll_details a left join pro_grey_batch_dtls b on a.id = b.roll_id where a.id in($data[0]) order by a.barcode_no asc";
	$res = sql_select($query);
	$split_data_arr = array();
	foreach ($res as $row) {
		$split_roll_id = $row[csf('id')];
		$roll_split_query = sql_select("select a.barcode_no, a.qnty, a.id, a.roll_split_from from pro_roll_details a where a.roll_id = $split_roll_id and a.roll_split_from != 0");
		if ($booking_without_order == 1) {
			$field1=$party_name." Job No.".$booking_no_prefix." M/C".$machine_name . "-" . $machine_dia_width . "X" . $machine_gauge;
		} else {

			$field1=$party_name." Job No.".$po_array[$row[csf('po_breakdown_id')]]['prefix']." M/C".$machine_name . "-" . $machine_dia_width . "X" . $machine_gauge;
		}
		//print_r($roll_split_query);
		if (!empty($roll_split_query)) {
			$qnty = number_format($roll_split_query[0]['qnty'], 2, '.', '');
			$barcode = $roll_split_query[0]['barcode_no'];
		} else {
			$qnty = number_format($row[csf('QNTY')], 2, '.', '');
			$barcode = $row[csf('barcode_no')];
		}
		$field2= $barcode;
		$field3="ID:".$barcode." D:".$prod_date." ".$buyer_name;
		$field4="Order No: ". $po_array[$row[csf('po_breakdown_id')]]['no'];
		$field5=$comp;
		$field6="G/F-Dia:".trim($grey_dia) ."/ ".trim($finish_dia)." ".trim($stitch_length);
		$field7="GSM:".$gsm." ".$yarn_count." ".$brand."Lot:".$yarn_lot;
		if($receive_basis==2) $program_no=$booking_no;
		$field8="Prg:".$program_no." Wt:".$qnty." Kg.Sft:".$shiftName;
		$field9="Roll No:".$row[csf('roll_no')]." ".trim($color)." ".trim($colorRange);
		if($data_array_print!="") $data_array_print.=",";
		$data_array_print.="('".$field1."','".$field2."','".$field3."','".$field4."','".$field5."','".$field6."','".$field7."','".$field8."','".$field9."','')";

		$i++;
	}

	$con = connect();
	$field_array_bundle="I1,I2,I3,I4,I5,I6,I7,I8,I9,I10";
		//echo "insert into LABEL_OUT($field_array_bundle)values".$data_array_print;die;
	$rID=sql_insert("LABEL_OUT",$field_array_bundle,$data_array_print,1);

	if($db_type==0)
	{
		if($rID)
		{
			mysql_query("COMMIT");
			echo 0;
		}
		else
		{
			mysql_query("ROLLBACK");
			echo 10;
		}
	}
	if($db_type==2 || $db_type==1 )
	{
		if($rID)
		{
			oci_commit($con);
			echo 0;
		}
		else
		{
			oci_rollback($con);
			echo 10;
		}
	}
	disconnect($con);
	die;
}

if ($action == "save_barcode_for_extranal_database") {
	$data = explode("***", $data);
	// For "Grey Fabric Bar-code Striker Export Report" report page
	if ($data[2] != '' || $data[3] != '') {
		$batch_no_condition = ($data[2] != "") ? " and a.batch_no='" . $data[2] . "'" : "";
		$barcode_condition = ($data[3] != "") ? " and b.barcode_no='" . $data[3] . "'" : "";

		$barcodeData = sql_select("select a.id, a.batch_no,b.barcode_no, b.roll_id, c.dtls_id from pro_batch_create_mst a
			inner join pro_batch_create_dtls b on a.id = b.mst_id inner join pro_roll_details c on b.roll_id = c.id where a.company_id=1 and a.status_active=1 and a.is_deleted=0 $batch_id_condition $batch_no_condition $barcode_condition");
		if (!empty($barcodeData)) {
			foreach ($barcodeData as $value) {
				$barcode_nos .= $value[csf('roll_id')] . ',';
				$dtls_id = $value[csf('dtls_id')];
				$batch_no = $value[csf('batch_no')];
			}
			$data[0] = rtrim($barcode_nos, ',');
			$data[1] = $dtls_id;
		} else {
			echo "Not Found";
		}
	}
	// For "Grey Fabric Bar-code Striker Export Report" report page (end)

	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$machine_no_arr = return_library_array("select id, machine_no from lib_machine_name", 'id', 'machine_no');
	$machine_brand_arr = return_library_array("select id, brand from lib_machine_name", 'id', 'brand'); // Temporary
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');
	$floor_name_arr = return_library_array("select id, floor_name from lib_prod_floor", 'id', 'floor_name');

	$sql_yarn_info=sql_select("select a.prod_id,b.brand,b.yarn_type,b.yarn_comp_type1st,b.yarn_comp_type2nd,b.yarn_comp_percent1st,b.yarn_comp_percent2nd,b.lot,b.yarn_count_id from pro_material_used_dtls a,product_details_master b  where a.prod_id=b.id and  a.mst_id=".$data[4]." and a.dtls_id=".$data[1]." and a.entry_form=2
		and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

	$yarn_information_string=""; $all_yarn_type='';
	foreach($sql_yarn_info as $p_val)
	{
		$costing_yarn_composition='';
		$costing_yarn_band=$brand_arr[$p_val[csf('brand')]];
		$costing_yarn_lot=trim($p_val[csf('lot')]);
		$costing_yarn_count=$count_arr[$p_val[csf('yarn_count_id')]];
		$costing_yarn_composition=$composition[$p_val[csf('yarn_comp_type1st')]] . " " . $p_val[csf('yarn_comp_percent1st')] . "%";
		if ($p_val[csf('yarn_comp_type2nd')] != 0) $costing_yarn_composition .= " " . $composition[$p_val[csf('yarn_comp_type2nd')]] . " " . $p_val[csf('yarn_comp_percent2nd')] . "%";
		$yarn_information_string.=$costing_yarn_band." ".$costing_yarn_lot." ".$costing_yarn_count." ".$costing_yarn_composition. "\r\n";
		$all_yarn_type.=",".$yarn_type[$p_val[csf('yarn_type')]];

	}

	$sql = "select a.company_id, a.recv_number, a.location_id, a.receive_basis, a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date, a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm, b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.shift_name, b.insert_date,b.operator_name, b.color_range_id, b.floor_id  from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	$shiftName = '';
	$colorRange = '';
	$productionId = '';
	$receive_basis=$row[csf('receive_basis')];
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}
		$yarn_type_data = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);

		$booking_no = $row[csf('booking_no')];
		$booking_id = $row[csf('booking_id')];
		$operator_name = $operator_name_arr[$row[csf('operator_name')]];
		$floor_name = $floor_name_arr[$row[csf('floor_id')]];

		$booking_without_order = $row[csf('booking_without_order')];
		$productionId = $row[csf('recv_number')];

		//$prod_date=date("d-m-Y",strtotime($row[csf('insert_date')]));
		//$prod_time=date("H:i",strtotime($row[csf('insert_date')]));
		$prod_date = date("d-m-Y", strtotime($row[csf('receive_date')]));

		$order_id = $row[csf('order_id')];
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];
		$shiftName = $shift_name[$row[csf('shift_name')]];
		$colorRange = $color_range[$row[csf('color_range_id')]];

		//$color=$color_arr[$row[csf('color_id')]];
		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');
		if (trim($color) != "") {
			//$color=", ".$color;
			//$color="".$color;
		}

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];
		$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}

		if ($row[csf('receive_basis')] == 0 || $row[csf('receive_basis')] == 1 || $row[csf('receive_basis')] == 4) {
			$machine_data = sql_select("select machine_no, dia_width, gauge,brand from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			//$machine_dia_width=$machine_data[0][csf('dia_width')];
			//$machine_gauge=$machine_data[0][csf('gauge')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
			$machine_brand = $row[csf('brand')];
			if($row[csf('receive_basis')]==1)
			{

				$sql_precost_tube=sql_select("select  b.width_dia_type from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b where a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no='$booking_no' and a.job_no=b.job_no and a.status_active=1 and a.is_deleted=0 and b.lib_yarn_count_deter_id=".$row[csf('febric_description_id')]."");
				foreach($sql_precost_tube as $t_val)
				{
					$tube_type = $fabric_typee[$t_val[csf('width_dia_type')]];
				}
			//	echo $sql_precost_tube;die;
				//$grey_dia = $program_data[0][csf('machine_dia')];
				//$tube_type = $fabric_typee[$program_data[0][csf('width_dia_type')]];
			}

		} else if ($row[csf('receive_basis')] == 2) //Knitting Plan
		{
			$program_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg, b.machine_id from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$program_no = $row[csf('booking_id')];
			$grey_dia = $program_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$program_data[0][csf('width_dia_type')]];
			$machine_dia_width = $program_data[0][csf('machine_dia')];
			$machine_gauge = $program_data[0][csf('machine_gg')];
			//$machine_no_arr
			$machine_brand = $machine_brand_arr[$row[csf('machine_no_id')]];
			$machine_name = $machine_no_arr[$row[csf('machine_no_id')]];
			//$machine_name=explode(",",$program_data[0][csf('machine_id')]);
			$row[csf("within_group")] = $program_data[0][csf('within_group')];
		}

		//$location_name=return_field_value("location_name","lib_location", "id=".$row[csf('location_id')]);
		//$buyer_name=return_field_value("short_name","lib_buyer", "id=".$row[csf('buyer_id')]);
		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id='" . $row[csf('buyer_id')] . "'");
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);


		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				$comp = $determination_sql[0][csf('construction')] . ", ";
				$construction = $determination_sql[0][csf('construction')];
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
				$composi .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}
	}


	//echo "select a.job_no,a.job_no_prefix_num,b.id,b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id)";
	//echo $booking_id;die;
	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		//$booking_no_prefix=return_field_value("booking_no_prefix_num","wo_non_ord_samp_booking_mst", "booking_no='".$booking_no."'");
		if ($row[csf("receive_basis")] == 4) {

			$fb_sales_sql = "select id,job_no_prefix_num,job_no,style_ref_no,within_group from fabric_sales_order_mst where id = " . $row[csf('booking_id')];
			$fb_salesResult = sql_select($fb_sales_sql);
			$booking_no_prefix = $fb_salesResult[0][csf('job_no_prefix_num')];
			$full_booking_no = $fb_salesResult[0][csf('job_no')];
			$style_ref_no = $fb_salesResult[0][csf('style_ref_no')];
			$sales_id = $fb_salesResult[0][csf('id')];

			//$booking_no_prefix=return_field_value("job_no_prefix_num","fabric_sales_order_mst", "id='".$row[csf("booking_id")]."'");
			//$full_booking_no=return_field_value("job_no","fabric_sales_order_mst", "id='".$row[csf("booking_id")]."'");
			$no_arr = explode("-", $full_booking_no);
			array_shift($no_arr); //remove 1st index
			$full_booking_no = implode("-", $no_arr);
			//$style_ref_no=return_field_value("style_ref_no","fabric_sales_order_mst", "id='".$row[csf("booking_id")]."'");
			//$sales_id=return_field_value("id","fabric_sales_order_mst", "id='".$row[csf("booking_id")]."'");
			$po_array[$sales_id]['style_ref'] = $style_ref_no;

		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$full_booking_no = $booking_no;
		}
	} else {
		$is_salesOrder = 0;
		if ($row[csf("receive_basis")] == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id='" . $row[csf("booking_id")] . "'");
			$booking_no = return_field_value("b.booking_no as booking_no", "ppl_planning_info_entry_dtls a,ppl_planning_info_entry_mst b", " b.id=a.mst_id and a.id='" . $booking_id . "'", "booking_no");
		}
		if ($is_salesOrder == 1) {
			//echo "select a.id, a.job_no as po_number, a.style_ref_no, a.job_no_prefix_num, a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a,wo_booking_mst b where a.sales_booking_no=b.booking_no and id in($order_id)";
			if ($row[csf("within_group")] == 1) {
				$po_sql = sql_select("select a.id, a.job_no as po_number, a.style_ref_no, a.job_no_prefix_num, a.sales_booking_no,b.buyer_id,a.within_group from fabric_sales_order_mst a,wo_booking_mst b where a.sales_booking_no=b.booking_no and a.id in($order_id)");
			} else {
				$po_sql = sql_select("select a.id, a.job_no as po_number, a.style_ref_no, a.job_no_prefix_num, a.sales_booking_no,a.buyer_id,a.within_group from fabric_sales_order_mst a where a.id in($order_id)");
			}
			foreach ($po_sql as $row) {
				$no_arr = explode("-", $row[csf('job_no')]);
				array_shift($no_arr); //remove 1st index
				$full_booking_no = implode("-", $no_arr);

				$po_no_arr = explode("-", $row[csf('po_number')]);
				array_shift($po_no_arr); //remove 1st index
				$po_no_arr = implode("-", $po_no_arr);
				$po_array[$row[csf('id')]]['no'] = $po_no_arr;//$row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $full_booking_no;
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
				$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_id')];

			}

			//print_r($po_array);

		} else {
			$po_sql = sql_select("select a.job_no, a.style_ref_no, a.buyer_name, a.job_no_prefix_num, b.id, b.po_number, b.grouping, b.file_no from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
				$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
				$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
				$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
			}
		}
	}
	$within_group = $row[csf("within_group")];



	$i = 1;
	$year = date("y");
	$query = "select a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty,a.reject_qnty, b.batch_wgt from pro_roll_details a left join pro_grey_batch_dtls b on a.id = b.roll_id where a.id in($data[0]) order by a.barcode_no asc";
	$res = sql_select($query);
	$split_data_arr = array();
	foreach ($res as $row) {
		$split_roll_id = $row[csf('id')];
		$roll_split_query = sql_select("select a.barcode_no, a.qnty, a.id, a.roll_split_from from pro_roll_details a where a.roll_id = $split_roll_id and a.roll_split_from != 0");
		if ($booking_without_order == 1) {
			$field1=$party_name." Job No.".$booking_no_prefix." M/C".$machine_name . "-" . $machine_dia_width . "X" . $machine_gauge;
		} else {

			$field1=$party_name." Job No.".$po_array[$row[csf('po_breakdown_id')]]['prefix']." M/C".$machine_name . "-" . $machine_dia_width . "X" . $machine_gauge;
		}
		//print_r($roll_split_query);
		if (!empty($roll_split_query)) {
			$qnty = number_format($roll_split_query[0]['qnty'], 2, '.', '');
			$barcode = $roll_split_query[0]['barcode_no'];
		} else {
			$qnty = number_format($row[csf('QNTY')], 2, '.', '');
			$barcode = $row[csf('barcode_no')];
		}
		$field2= $barcode;
		$field3="ID:".$barcode." D:".$prod_date." ".$buyer_name;
		$field4="Order No: ". $po_array[$row[csf('po_breakdown_id')]]['no'];
		$field5=$comp;
		$field6="G/F-Dia:".trim($grey_dia) ."/ ".trim($finish_dia)." ".trim($stitch_length);
		$field7="GSM:".$gsm." ".$yarn_count." ".$brand."Lot:".$yarn_lot;
		if($receive_basis==2) $program_no=$booking_no;
		$field8="Prg:".$program_no." Wt:".$qnty." Kg.Sft:".$shiftName;
		$field9="Roll No:".$row[csf('roll_no')]." ".trim($color)." ".trim($colorRange);
		if($data_array_print!="") $data_array_print.=",";
		$data_array_print.="('".$field1."','".$field2."','".$field3."','".$field4."','".$field5."','".$field6."','".$field7."','".$field8."','".$field9."','')";

		$i++;
	}

/*	function extranal_connect( $server='localhost', $user='root', $passwd='', $db_name='logic_erp_2nd_version' )
	{
		$new_con_insert = mysql_connect( $server, $user, $passwd );
		if(!$new_con_insert)
		{
			trigger_error("Problem connecting to server");
		}
		$DB =  mysql_select_db($db_name, $new_con_insert);
		if(!$DB)
		{
			trigger_error("Problem selecting database");
		}
		//mysql_query("START TRANSACTION");
		return $new_con_insert;
	}*/

	function sql_insert_new($strTable,$arrNames,$arrValues, $commit )
	{
		//if($db_type
		$server='localhost';
		$user='norsel';
		$passwd='norsel@123';
		$db_name='norsel'; // extranal database
		$new_con_insert = mysql_connect( $server, $user, $passwd );
		if(!$new_con_insert)
		{
			trigger_error("Problem connecting to server");
		}

		$DB =  mysql_select_db($db_name, $new_con_insert);
		if(!$DB)
		{
			trigger_error("Problem selecting database");
		}

		$strQuery= "INSERT INTO ".$strTable." (".$arrNames.") VALUES ".$arrValues."";
		 //return $strQuery; die;
		mysql_query("SET character_set_results = 'utf8', character_set_client = 'utf8', character_set_connection = 'utf8', character_set_database = 'utf8', character_set_server = 'utf8'");
		$result=mysql_query($strQuery);
		return $result;
		disconnect($new_con_insert);
		die;
	}

	$field_array_bundle="I1,I2,I3,I4,I5,I6,I7,I8,I9,I10";
		//echo "insert into LABEL_OUT($field_array_bundle)values".$data_array_print;die;
	$rID=sql_insert_new("LABEL_OUT",$field_array_bundle,$data_array_print,1);

	if($db_type==0)
	{
		if($rID)
		{
			mysql_query("COMMIT");
			echo 0;
		}
		else
		{
			mysql_query("ROLLBACK");
			echo 10;
		}
	}
	if($db_type==2 || $db_type==1 )
	{
		if($rID)
		{
			oci_commit($con);
			echo 0;
		}
		else
		{
			oci_rollback($con);
			echo 10;
		}
	}
	disconnect($con);
	die;
}

if ($action == "report_barcode_text_file_prev") {
	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');

	$sql = "select a.company_id, a.location_id, a.receive_basis, a.booking_id, a.receive_date, a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm, b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.color_id, b.febric_description_id, b.insert_date from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and b.id=$data[1]";
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		$prod_date = date("d-m-Y", strtotime($row[csf('insert_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));

		$order_id = $row[csf('order_id')];
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];

		//$color=$color_arr[$row[csf('color_id')]];
		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];
		$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}

		$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
		$machine_name = $machine_data[0][csf('machine_no')];
		$machine_dia_width = $machine_data[0][csf('dia_width')];
		$machine_gauge = $machine_data[0][csf('gauge')];

		$location_name = return_field_value("location_name", "lib_location", "id=" . $row[csf('location_id')]);
		$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				$comp = $determination_sql[0][csf('construction')] . ", ";
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}

		if ($row[csf('receive_basis')] == 2) {
			$program_data = sql_select("select width_dia_type, machine_dia from ppl_planning_info_entry_dtls where id='" . $row[csf('booking_id')] . "'");
			$program_no = $row[csf('booking_id')];
			$grey_dia = $program_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$program_data[0][csf('width_dia_type')]];
		}
	}
	//echo "select a.job_no,a.job_no_prefix_num,b.id,b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id)";
	$po_array = array();
	$po_sql = sql_select("select a.job_no, a.job_no_prefix_num, b.id, b.po_number, b.grouping, b.file_no from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id)");
	foreach ($po_sql as $row) {
		$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
		$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
		$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
		$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
	}

	foreach (glob("" . "*.zip") as $filename) {
		@unlink($filename);
	}

	$i = 1;
	$zip = new ZipArchive();            // Load zip library
	$filename = str_replace(".sql", ".zip", 'norsel_bundle.sql');            // Zip name
	if ($zip->open($filename, ZIPARCHIVE::CREATE) !== TRUE) {        // Opening zip file to load files
		$error .= "* Sorry ZIP creation failed at this time<br/>";
		echo $error;
	}

	$i = 1;
	$year = date("y");
	$query = "select id, roll_no, po_breakdown_id, barcode_no, qnty from pro_roll_details where id in($data[0])";
	$res = sql_select($query);
	foreach ($res as $row) {
		$file_name = "NORSEL-IMPORT_" . $i;
		$myfile = fopen($file_name . ".txt", "w") or die("Unable to open file!");
		$txt = "Norsel_imp\r\n1\r\n";
		$txt .= $party_name . " Job No." . $po_array[$row[csf('po_breakdown_id')]]['prefix'] . " M/C:" . $machine_name . "-" . $machine_dia_width . "X" . $machine_gauge . "\r\n";
		$txt .= $row[csf('barcode_no')] . "\r\n";
		$txt .= "Barcode No: " . $row[csf('barcode_no')] . " D:" . $prod_date . " T:" . $prod_time . "\r\n";
		$txt .= $buyer_name . ", Order No:" . $po_array[$row[csf('po_breakdown_id')]]['no'] . "\r\n";
		$txt .= $comp . "\r\n";
		$txt .= "G/F-Dia:" . trim($grey_dia) . "/" . trim($finish_dia) . " " . trim($stitch_length) . " " . trim($tube_type) . "\r\n";
		$txt .= "GSM:" . $gsm . " ";
		$txt .= $yarn_count . " " . $brand . " Lot:" . $yarn_lot . "\r\n";
		$txt .= "Prg: " . $program_no . "/Roll Wt:" . number_format($row[csf('qnty')], 2, '.', '') . " Kg " . "\r\n";
		$txt .= "Roll Sl. " . $row[csf('roll_no')] . ", " . trim($color) . "\r\n";
		$txt .= "Unit: " . $location_name . "\r\n";
		$txt .= "Ref. " . $po_array[$row[csf('po_breakdown_id')]]['grouping'] . ", File: " . $po_array[$row[csf('po_breakdown_id')]]['file_no'] . "\r\n";
		//Wt:".number_format($row[csf('qnty')],2,'.','')." Kg "."\r\n";
		//$txt .= "Prod Date: ".$prod_date;

		fwrite($myfile, $txt);
		fclose($myfile);

		$i++;
	}

	foreach (glob("" . "*.txt") as $filenames) {
		$zip->addFile($file_folder . $filenames);
	}
	$zip->close();

	foreach (glob("" . "*.txt") as $filename) {
		@unlink($filename);
	}
	echo "norsel_bundle";
	exit();
}

if ($action == "knit_defect_popup") {
	echo load_html_head_contents("Order Search", "../../", 1, 1, $unicode);
	extract($_REQUEST);
	//echo "blala";
	//echo $update_dtls_id."**".$roll_maintained."**".$company_id."**".$mst_id."**jahid";die();
	$variable_data = sql_select("select fabric_grade, get_upto_first, get_upvalue_first, get_upto_second,company_name, get_upvalue_second from variable_settings_production where  variable_list=36 order by company_name,get_upvalue_first asc"); //company_name=$company_id and
	//echo "select fabric_grade, get_upto_first, get_upvalue_first, get_upto_second,company_name, get_upvalue_second from variable_settings_production where  variable_list=36 order by company_name,get_upvalue_first asc";
	$exc_perc = array();
	$i = 0;
	$variable_data_count = count($variable_data);
	foreach ($variable_data as $row) {
		if ($exp[$row[csf("company_name")]] == '') $i = 0;
		$exc_perc[$row[csf("company_name")]]['limit'][$i] = $row[csf("get_upvalue_first")] . "__" . $row[csf("get_upvalue_second")];
		$exc_perc[$row[csf("company_name")]]['grade'][$i] = $row[csf("fabric_grade")];
		$i++;
		$exp[$row[csf("company_name")]] = 1;

	}
	//print_r($exc_perc);
	//$js_variable_data_arr=json_encode($exc_perc);


	echo load_html_head_contents("Grey Production Entry", "../../", 1, 1, $unicode, '', '');
	$supplier_arr = return_library_array("select id, short_name from  lib_supplier", "id", "short_name");

	/*$machine_dia_arr=return_library_array("select id, dia_width from lib_machine_name","id","dia_width");
	$color_arr=return_library_array("select id, color_name from  lib_color","id","color_name");
	$yarn_count_arr=return_library_array("select id, yarn_count from  lib_yarn_count","id","yarn_count");
	$supplier_arr=return_library_array("select a.lot, b.short_name from product_details_master a, lib_supplier b where a.supplier_id=b.id and a.item_category_id=1","lot","short_name");*/

	$sql_deter = "select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id order by b.id asc";
	$data_array = sql_select($sql_deter);
	foreach ($data_array as $row) {
		$constructtion_arr[$row[csf('id')]] = $row[csf('construction')];
		$composition_arr[$row[csf('id')]] .= $composition[$row[csf('copmposition_id')]] . " " . $row[csf('percent')] . "% ";
	}

	if ($roll_maintained == 1) {
		/*$data_array=sql_select("SELECT a.id, a.entry_form, a.company_id, a.receive_basis, a.booking_no, a.booking_id, a.knitting_source, a.knitting_company, b.id as dtls_id, b.prod_id, b.body_part_id, b.febric_description_id, b.machine_no_id, b.gsm, b.width, b.color_id, b.yarn_lot, b.yarn_count, c.barcode_no, c.id as roll_id, c.roll_no, c.qnty
		FROM inv_receive_master a, pro_grey_prod_entry_dtls b, pro_roll_details c
		WHERE a.id=b.mst_id and b.id=c.dtls_id and a.entry_form in(2) and c.entry_form in(2) and c.status_active=1 and c.is_deleted=0 and b.id=$update_dtls_id");
		$roll_dtls_data_arr=array();
		foreach($data_array as $row)
		{
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["id"]=$row[csf("id")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["entry_form"]=$row[csf("entry_form")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["company_id"]=$row[csf("company_id")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["receive_basis"]=$row[csf("receive_basis")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["booking_no"]=$row[csf("booking_no")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["booking_id"]=$row[csf("booking_id")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["knitting_source"]=$row[csf("knitting_source")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["knitting_company"]=$row[csf("knitting_company")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["dtls_id"]=$row[csf("dtls_id")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["prod_id"]=$row[csf("prod_id")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["febric_description_id"]=$constructtion_arr[$row[csf("febric_description_id")]]." ".$composition_arr[$row[csf('febric_description_id')]];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["machine_no_id"]=$row[csf("machine_no_id")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["gsm"]=$row[csf("gsm")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["width"]=$row[csf("width")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["color_id"]=$row[csf("color_id")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["yarn_lot"]=$row[csf("yarn_lot")];

			$roll_dtls_data_arr[$row[csf("barcode_no")]]["yarn_count"]=$row[csf("yarn_count")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["barcode_no"]=$row[csf("barcode_no")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["roll_id"]=$row[csf("roll_id")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["roll_no"]=$row[csf("roll_no")];
			$roll_dtls_data_arr[$row[csf("barcode_no")]]["qnty"]=$row[csf("qnty")];
		}*/
	} else {
		$data_array = sql_select("SELECT a.id, a.entry_form, a.company_id, a.receive_basis, a.booking_no, a.booking_id, a.knitting_source, a.knitting_company, b.id as dtls_id, b.prod_id, b.body_part_id, b.febric_description_id, b.machine_no_id, b.gsm, b.width, b.color_id, b.yarn_lot, b.yarn_count, b.grey_receive_qnty as qnty
			FROM inv_receive_master a, pro_grey_prod_entry_dtls b
			WHERE a.id=b.mst_id and a.entry_form in(2) and b.id=$update_dtls_id");
		$roll_dtls_data_arr = array();
		foreach ($data_array as $row) {

			$constraction_comp = $constructtion_arr[$row[csf("febric_description_id")]] . " " . $composition_arr[$row[csf('febric_description_id')]];
			$machine_dia = return_field_value("dia_width", "lib_machine_name", "id=" . $row[csf("machine_no_id")], "dia_width");
			$gsm = $row[csf("gsm")];
			$width = $row[csf("width")];
			$color_id_arr = array_unique(explode(",", $row[csf("color_id")]));
			$all_color = "";
			foreach ($color_id_arr as $color_id) {
				$all_color .= return_field_value("color_name", "lib_color", "id='$color_id'", "color_name") . ",";
			}
			$all_color = chop($all_color, ",");

			$yarn_count_arr = array_unique(explode(",", $row[csf("yarn_count")]));
			$all_yarn_count = "";
			foreach ($yarn_count_arr as $count_id) {
				$all_yarn_count .= return_field_value("yarn_count", "lib_yarn_count", "id='$count_id'", "yarn_count") . ",";
			}
			$all_yarn_count = chop($all_yarn_count, ",");
			$yarn_lot = $row[csf("yarn_lot")];
			$qnty = $row[csf("qnty")];
			$lot_arr = array_unique(explode(",", $row[csf("yarn_lot")]));
			foreach ($lot_arr as $lot) {
				$supplier_id = return_field_value("max(supplier_id) as supplier_id", "product_details_master", "item_category_id=1 and lot='$lot'", "supplier_id");
				$all_supplier .= $supplier_arr[$supplier_id] . ",";
			}
			$all_supplier = chop($all_supplier, ",");
		}
		$disable = "disabled";
	}
	?>
	<script>
		var pemission = '<? echo $_SESSION['page_permission']; ?>';
		var exc_perc =<? echo json_encode($exc_perc); ?>;
        //alert(exc_perc);
        function fabric_grading(comp, point) {
            //alert(comp)
            var newp = exc_perc[comp]["limit"];
            newp = JSON.stringify(newp);
            var newstr = newp.split(",");
            for (var m = 0; m < newstr.length; m++) {
            	var limit = exc_perc[comp]["limit"][m].split("__");
            	if ((limit[1] * 1) == 0 && (point * 1) >= (limit[0] * 1)) {
            		return ( exc_perc[comp]["grade"][m]);
            	}
            	if ((point * 1) >= (limit[0] * 1) && (point * 1) <= (limit[1] * 1)) {
            		return exc_perc[comp]["grade"][m];
            	}
                // alert( newstr[m]+"=="+m)
            }
            return '';
        }

        var roll_maintain = '<? echo $roll_maintained; ?>';
        function fn_barcode() {
        	var dtls_id = $('#hide_dtls_id').val();
        	var roll_maintain = $('#hide_roll_maintain').val();
        	var mstId = $('#hide_mst_id').val();

        	if (dtls_id == "" && roll_maintain != 1) {
        		alert("Select Data First.");
        		return;
        	}
        	else {
        		var title = 'Barcode Or Details Info';
        		var page_link = 'grey_production_entry_controller_v2.php?mstId='+mstId+'&update_dtls_id=' + dtls_id + '&roll_maintained=' + roll_maintain + '&action=barcode_defect_popup';
        		emailwindow = dhtmlmodal.open('EmailBox', 'iframe', page_link, title, 'width=1000px,height=350px,center=1,resize=1,scrolling=0', '../');
        		emailwindow.onclose = function () {
        			var bar_code_ref = this.contentDoc.getElementById("hide_barcode_id").value.split("**");
        			if (bar_code_ref[1] != "") {
        				//get_php_form_data(bar_code_ref[0], 'barcode_roll_find', 'grey_production_entry_controller_v2');
        				if(mstId!="" && dtls_id!="" )
        				{
        					$.ajax({
        						url: 'grey_production_entry_controller_v2.php',
        						type: 'POST',
        						data: {'mstId':mstId,'dtls_id':dtls_id,'bar_code':bar_code_ref[0],'action':'barcode_roll_find'},
        						success: function (data) {
        							var response =data.split("**");

        							if(response[0]==13)
        							{
        								alert(response[1]);
        								return false;
        							}else{
        								eval(data);
        							}
        						}
        					});
        				}
        			}
        		}
        	}
        }


        if (roll_maintain == 1) {
        	$('#txt_barcode').live('keydown', function (e) {
        		if (e.keyCode === 13) {
        			e.preventDefault();

        			var mstId = $('#hide_mst_id').val();
        			var dtls_id = $('#hide_dtls_id').val();
        			var bar_code = $('#txt_barcode').val();
        			//get_php_form_data(bar_code, 'barcode_roll_find', 'grey_production_entry_controller_v2');

        			if(mstId!="" && dtls_id!=""  && bar_code!="" )
        			{
        				$.ajax({
        					url: 'grey_production_entry_controller_v2.php',
        					type: 'POST',
        					data: {'mstId':mstId,'dtls_id':dtls_id,'bar_code':bar_code,'action':'barcode_roll_find'},
        					success: function (data) {
        						var response =data.split("**");

        						if(response[0]==13)
        						{
        							alert(response[1]);
        							return false;
        						}else{
        							eval(data);
        						}
        					}
        				});
        			}
        		}
        	});

        	$(document).ready(function (e) {
        		var roll_maintain = $('#hide_roll_maintain').val() * 1;
        		if (roll_maintain > 0) {
        			$('#txt_barcode').focus();
        		}
        		else {
        			$('#txt_qc_name').focus();
        		}

        	});
        }

        function caculate_roll_length() {
        	var roll_weight = $('#txt_roll_weight').val() * 1;
        	var roll_width = $('#txt_roll_width').val() * 1;
        	var gsm = $('#txt_gsm').val() * 1;
        	var roll_length = ((roll_weight * 1000) / (gsm * roll_width * 0.0254) * 1.09361);
        	$('#txt_roll_length').val(number_format(roll_length, 4, '.', ''));
        }

        function fn_panelty_point(i) {

        	var defect_count = $('#defectcount_' + i).val() * 1;
        	var found_inche = $('#foundInche_' + i).val() * 1;
        	var company_id = $('#company_id').val();
        	var found_inche_calc = "";

        	if (found_inche == 1) found_inche_calc = 1;
        	else if (found_inche == 2) found_inche_calc = 2;
        	else if (found_inche == 3) found_inche_calc = 3;
        	else if (found_inche == 4) found_inche_calc = 4;
        	else if (found_inche == 5) found_inche_calc = 2;
        	else if (found_inche == 6) found_inche_calc = 4;
        	var penalty_val = defect_count * found_inche_calc;
        	$('#penaltycount_' + i).val(penalty_val);
        	var ddd = {dec_type: 4, comma: 0, currency: ''}
        	var numRow = $('table#dtls_part tbody tr').length;
        	math_operation("total_penalty_point", "penaltycount_", "+", numRow, ddd);
        	var penalty_ratio = (($('#total_penalty_point').val() * 1) * 36 * 100) / (($('#txt_roll_length').val() * 1) * ($('#txt_roll_width').val() * 1));
        	$('#total_point').val(number_format(penalty_ratio, 4, '.', ''));
            //alert(penalty_ratio);
            /*if(penalty_ratio<21) fab_grade="A";
             else if(penalty_ratio<29 && penalty_ratio>20) fab_grade="B";
             else fab_grade="Reject";*/

             $('#fabric_grade').val(fabric_grading(company_id, penalty_ratio));
         }
         function generate_report_file(data,action,page)
         {
         	window.open("grey_production_entry_controller_v2.php?data=" + data+'&action='+action, true );
         }

         function fnc_grey_defect_entry(operation) {
         	if (operation == 2) {
         		show_msg('13');
         		return;
         	}

         	if(operation == 4)
         	{
         		generate_report_file($('#update_id').val() ,
         			'KnittingProductionPrint', 'requires/grey_production_entry_controller_v2');
         		return;
         	}
         	if(operation == 5)
         	{
         		generate_report_file($('#update_id').val() ,
         			'KnittingProductionPrint_2', 'requires/grey_production_entry_controller_v2');
         		return;
         	}

         	if (form_validation('txt_roll_length*txt_qc_date*fabric_grade', 'Roll Length*QC Date*Fabric Grade') == false) {
         		return;
         	}
         	var table_length = $('#dtls_part tbody tr').length;
         	var data_string = "";
         	var k = 1;
         	var count_tbl_length = 0;
         	for (var i = 1; i <= table_length; i++) {
         		var defect_name = $('#defectId_' + i).val();
         		var defect_count = $('#defectcount_' + i).val();
         		var found_in_inche = $('#foundInche_' + i).val();
         		var found_inche_val = "";
         		var penalty_point = $('#penaltycount_' + i).val() * 1;
         		if (penalty_point !="") {
         		//if (penalty_point > 0) {
         			if (found_in_inche == 5) found_inche_val = 2;
         			else if (found_in_inche == 6) found_inche_val = 4;
         			else found_inche_val = found_in_inche;
         			data_string += '&defectId_' + k + '=' + defect_name + '&defectcount_' + k + '=' + defect_count + '&foundInche_' + k + '=' + found_in_inche + '&foundIncheVal_' + k + '=' + found_inche_val + '&penaltycount_' + k + '=' + penalty_point;
         			count_tbl_length++;
         			k++;

         		}
         	}
         	data_string = data_string + '&count_tbl_length=' + count_tbl_length;


         	var data = "action=save_update_delete_defect&operation=" + operation + get_submitted_data_string('hide_dtls_id*hide_mst_id*company_id*hide_roll_maintain*txt_barcode*txt_roll_no*roll_id*txt_qc_name*txt_roll_width*txt_roll_weight*txt_roll_length*txt_reject_qnty*txt_qc_date*total_penalty_point*total_point*fabric_grade*fabric_comments*update_id*txt_reject_qnty_pre', "../../") + data_string;
            //alert(data);return;
            //alert(data);
            freeze_window(operation);

            http.open("POST", "grey_production_entry_controller_v2.php", true);
            http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            http.send(data);
            http.onreadystatechange = fnc_grey_defect_entry_response;
        }

        function fnc_grey_defect_entry_response() {
        	if (http.readyState == 4) {
                //release_freezing();return;
                var reponse = trim(http.responseText).split('**');
                if (reponse[0] == 20) {
                	alert(reponse[1]);
                	release_freezing();
                	return;
                }
                show_msg(reponse[0]);
                if ((reponse[0] == 0 || reponse[0] == 1)) {
                	document.getElementById('update_id').value = reponse[1];
                	var prod_dtls_id = $('#hide_dtls_id').val();
                	$('#dtls_list_container').html("");
                	show_list_view(prod_dtls_id, 'show_qc_listview', 'dtls_list_container', 'grey_production_entry_controller_v2', '');
                	set_button_status(0, pemission, 'fnc_grey_defect_entry', 1);
                	$('#master_part').find('input', 'select').val("");
                	release_freezing();
                }
                else {
                	release_freezing();
                }

            }
        }

        function fn_recet_details() {
        	$('#dtls_part').find('input').val("");
        	$('#dtls_part').find('select').val(0);
        }

       /* function checkProductionQnty()
        {
        	var oldQty = $("#old_qty").val()*1;
        	var roll_weight = $("#txt_roll_weight").val()*1;
        	var reject_qnty = $("#txt_reject_qnty").val()*1;

        	if(roll_weight>oldQty)
        	{
        		$("#txt_roll_weight").val(oldQty);
        	}else {
        		$("#txt_roll_weight").val(roll_weight);
        	}
        }

        function checkRejectiontionQnty()
        {
        	var oldQty = $("#old_qty").val()*1;
        	var reject_qnty = $("#txt_reject_qnty").val()*1;

        	if(reject_qnty>oldQty)
        	{
        		$("#txt_reject_qnty").val(oldQty);
        	}else {
        		$("#txt_reject_qnty").val(reject_qnty);
        	}
        }*/

    </script>
    <body onLoad="set_hotkey()">
    	<? echo load_freeze_divs("../../", $permission); ?>
    	<form name="defectQcResult_1" id="defectQcResult_1" autocomplete="off">
    		<div style="width:1160px">
    			<input type="hidden" id="hide_dtls_id" value="<? echo $update_dtls_id; ?>"/>
    			<input type="hidden" id="hide_mst_id" value="<? echo $mst_id; ?>"/>
    			<input type="hidden" id="hide_roll_maintain" value="<? echo $roll_maintained; ?>"/>
    			<input type="hidden" id="company_id" value="<? echo $company_id; ?>"/>
    			<table width="1100" border="0">
    				<tr>
    					<td width="400" valign="top">
    						<table cellpadding="0" cellspacing="0" border="1" width="400" class="rpt_table" rules="all"
    						id="master_part">
    						<tr bgcolor="#E9F3FF">
    							<td width="200">Barcode Number</td>
    							<td align="center"><input type="text" id="txt_barcode" name="txt_barcode"
    								class="text_boxes" style="width:150px;"
    								onDblClick="fn_barcode()"
    								placeholder="Browse or Scan" <? echo $disable; ?> ></td>
    							</tr>
    							<tr bgcolor="#FFFFFF">
    								<td>Roll Number</td>
    								<td align="center">
    									<input type="text" id="txt_roll_no" name="txt_roll_no" class="text_boxes"
    									style="width:150px;" readonly placeholder="Display" <? echo $disable; ?> >
    									<input type="hidden" id="roll_id" name="roll_id">
    								</td>
    							</tr>
    							<tr bgcolor="#FFFFFF">
    								<td>QC Date</td>
    								<td align="center"><input type="text" id="txt_qc_date" name="txt_qc_date"
    									class="datepicker" style="width:150px;" placeholder="write"
    									readonly></td>
    								</tr>
    								<tr bgcolor="#E9F3FF">
    									<td>QC Name</td>
    									<td align="center"><input type="text" id="txt_qc_name" name="txt_qc_name"
    										class="text_boxes" style="width:150px;" placeholder="write">
    									</td>
    								</tr>
    								<tr bgcolor="#FFFFFF">
    									<td>Roll Width (inch)</td>
    									<td align="center"><input type="text" id="txt_roll_width" name="txt_roll_width"
    										class="text_boxes_numeric" style="width:150px;"
    										placeholder="write" onBlur="caculate_roll_length();"></td>
    									</tr>
    									<tr bgcolor="#E9F3FF">
    										<td>Roll Wgt. (Kg)</td>
    										<td align="center">
    											<input type="text" id="txt_roll_weight" name="txt_roll_weight"
    											class="text_boxes_numeric" style="width:150px;"
    											value="<? echo $qnty; ?>" placholder="Display" readonly>
    											<input type="hidden" id="old_qty" value="<? echo $qnty; ?>">
    										</td>
    									</tr>
    									<tr bgcolor="#FFFFFF">
    										<td>Roll Length (Yds)</td>
    										<td align="center"><input type="text" id="txt_roll_length" name="txt_roll_length"
    											class="text_boxes_numeric" style="width:150px;"
    											placeholder="Display"></td>
    										</tr>
    										<tr bgcolor="#E9F3FF">
    											<td>Reject Qty</td>
    											<td align="center"><input type="text" id="txt_reject_qnty" name="txt_reject_qnty"
    												class="text_boxes_numeric" style="width:150px;"
    												placeholder="write">
    												<input type="hidden" id="txt_reject_qnty_pre" name="txt_reject_qnty_pre"
    												class="text_boxes_numeric" style="width:150px;"
    												placeholder="write">

    											</td>
    										</tr>
    										<tr bgcolor="#FFFFFF">
    											<td>Construction & Composition</td>
    											<td align="center"><input type="text" id="txt_constract_comp" name="txt_constract_comp"
    												class="text_boxes" style="width:150px;" readonly
    												placeholder="Display" value="<? echo $constraction_comp; ?>">
    											</td>
    										</tr>
    										<tr bgcolor="#E9F3FF">
    											<td>GSM</td>
    											<td align="center"><input type="text" id="txt_gsm" name="txt_gsm" class="text_boxes"
    												style="width:150px;" readonly placeholder="Display"
    												value="<? echo $gsm; ?>"></td>
    											</tr>
    											<tr bgcolor="#FFFFFF">
    												<td>Dia</td>
    												<td align="center"><input type="text" id="txt_dia" name="txt_dia" class="text_boxes"
    													style="width:150px;" readonly placeholder="Display"
    													value="<? echo $width; ?>"></td>
    												</tr>
    												<tr bgcolor="#E9F3FF">
    													<td>M/C Dia</td>
    													<td align="center"><input type="text" id="txt_mc_dia" name="txt_mc_dia"
    														class="text_boxes" style="width:150px;" readonly
    														placeholder="Display" value="<? echo $machine_dia; ?>"></td>
    													</tr>
    													<tr bgcolor="#FFFFFF">
    														<td>Color</td>
    														<td align="center"><input type="text" id="txt_color" name="txt_color" class="text_boxes"
    															style="width:150px;" readonly placeholder="Display"
    															value="<? echo $all_color; ?>"></td>
    														</tr>

    														<tr bgcolor="#E9F3FF">
    															<td>Yarn Count</td>
    															<td align="center"><input type="text" id="txt_yarn_count" name="txt_yarn_count"
    																class="text_boxes" style="width:150px;" readonly
    																placeholder="Display" value="<? echo $all_yarn_count; ?>">
    															</td>
    														</tr>
    														<tr bgcolor="#FFFFFF">
    															<td>Yarn Lot</td>
    															<td align="center"><input type="text" id="txt_yarn_lot" name="txt_yarn_lot"
    																class="text_boxes" style="width:150px;" readonly
    																placeholder="Display" value="<? echo $yarn_lot; ?>"></td>
    															</tr>
    															<tr bgcolor="#E9F3FF">
    																<td>Spinning Mill</td>
    																<td align="center"><input type="text" id="txt_spning_mill" name="txt_spning_mill"
    																	class="text_boxes" style="width:150px;" readonly
    																	placeholder="Display" value="<? echo $all_supplier; ?>"></td>
    																</tr>


    															</table>
    														</td>
    														<td width="50">&nbsp;</td>
    														<td width="600">
    															<table cellpadding="0" cellspacing="0" border="1" width="600" class="rpt_table" rules="all">
    																<tr>
    																	<td colspan="5" align="center"><input type="button" id="reset_details"
    																		class="formbuttonplasminus"
    																		value="Reset Defect Counter" style="width:200px;"
    																		onClick="fn_recet_details();"></td>
    																	</tr>
    																</table>

    																<table cellpadding="0" cellspacing="0" border="1" width="600" class="rpt_table" rules="all"
    																id="dtls_part">
    																<thead>
    																	<tr>
    																		<th width="50">SL</th>
    																		<th width="150">Defect Name</th>
    																		<th width="100">Defect Count</th>
    																		<th width="150">Found in (Inch)</th>
    																		<th>Penalty Point</th>
    																	</tr>
    																</thead>
    																<tbody>
    																	<?
    																	$i = 1;
    																	foreach ($knit_defect_array as $defect_id => $val) {
    																		if ($i % 2 == 0)
    																			$bgcolor = "#E9F3FF";
    																		else
    																			$bgcolor = "#FFFFFF";
    																		?>
    																		<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
    																			<td align="center"><? echo $i; ?></td>
    																			<td><p><? echo $val; ?></p>
    																				<input type="hidden" id="defectId_<? echo $i; ?>" name="defectId[]" class="defectId" value="<? echo $defect_id; ?>">
    																				<input type="hidden" class="UpdefectId" id="UpdefectId_<? echo $i; ?>" name="UpdefectId[]"
    																				value="">
    																			</td>
    																			<td><p><input type="text" id="defectcount_<? echo $i; ?>" name="defectcount[]"
    																				class="text_boxes_numeric" style="width:90px"
    																				onBlur="fn_panelty_point(<? echo $i; ?>)"></p></td>
    																				<?
    																				if ($defect_id == 1) $defect_show = '5,6'; else $defect_show = '1,2,3,4';
    																				?>
    																				<td>
    																					<p><? echo create_drop_down("foundInche_" . $i, 152, $knit_defect_inchi_array, "", 1, "-- Select --", 0, "fn_panelty_point(" . $i . ")", '', $defect_show); ?></p>
    																					<input type="hidden" id="foundInchePoint_<? echo $i; ?>"
    																					name="foundInchePoint[]" value="">
    																				</td>
    																				<td><p><input type="text" id="penaltycount_<? echo $i; ?>" name="penaltycount[]"
    																					class="text_boxes_numeric" style="width:130px" readonly></p></td>
    																				</tr>
    																				<?
    																				$i++;
    																			}
    																			?>
    																		</tbody>
    																		<tfoot>
    																			<tr bgcolor="#CCCCCC">
    																				<td colspan="4" align="right">Total Penalty Point: &nbsp;</td>
    																				<td align="center"><input type="text" class="text_boxes_numeric"
    																					id="total_penalty_point" name="total_penalty_point"
    																					style="width:130px" readonly></td>
    																				</tr>
    																				<tr bgcolor="#CCCCCC">
    																					<td colspan="4" align="right" title="(total penalty point * 36 * 100)/(roll length*roll width)">Total Point: &nbsp;</td>
    																					<td align="center"><input type="text" class="text_boxes_numeric" id="total_point"
    																						name="total_point" style="width:130px" readonly></td>
    																					</tr>
    																					<tr bgcolor="#CCCCCC">
    																						<td colspan="4" align="right">Fabric Grade: &nbsp;</td>
    																						<td align="center"><input type="text" class="text_boxes" id="fabric_grade"
    																							name="fabric_grade" style="width:130px" readonly></td>
    																						</tr>
    																						<tr>
    																							<td>Comments</td>
    																							<td colspan="4"><input type="text" class="text_boxes" id="fabric_comments"
    																								name="fabric_comments" style="width:98%"></td>
    																							</tr>
    																						</tfoot>
    																					</table>
    																				</td>
    																			</tr>
    																			<tr>
    																				<td colspan="3">&nbsp;</td>
    																			</tr>
    																			<tr>
    																				<td colspan="3" align="center" class="button_container">
    																					<?
												echo load_submit_buttons($permission, "fnc_grey_defect_entry", 0, 1, "reset_form('','','','')", 1);//set_auto_complete(1);
												?>
												<input type="hidden" id="update_id" name="update_id"/>

												<input type="button" id="print2" class="formbutton"  style="width:80px;" onClick="fnc_grey_defect_entry(5)" name="print2" value="Print 2">

											</td>
										</tr>
									</table>
									<div id="dtls_list_container" style="margin-top:5px;" align="center">
										<?
										$sql_dtls = sql_select("select id, pro_dtls_id, barcode_no, roll_id, roll_no, total_penalty_point, total_point, fabric_grade, comments from pro_qc_result_mst where pro_dtls_id=$update_dtls_id and status_active = 1");
										if (count($sql_dtls) > 0) {
											?>
											<table cellspacing="0" cellpadding="0" border="1" rules="all" width="850" class="rpt_table">
												<thead>
													<tr>
														<th width="50">SL</th>
														<th width="100">Roll No</th>
														<th width="100">Barcode</th>
														<th width="100">Penalty Point</th>
														<th width="100">Total Point</th>
														<th width="100">Fabric Grade</th>
														<th>Comments</th>
													</tr>
												</thead>
												<tbody>
													<?
													$i = 1;
													foreach ($sql_dtls as $row) {
														if ($i % 2 == 0)
															$bgcolor = "#E9F3FF";
														else
															$bgcolor = "#FFFFFF";
														?>
														<tr bgcolor="<? echo $bgcolor; ?>"
															onClick='get_php_form_data(<? echo $row[csf("id")]; ?>, "populate_qc_from_grey_recv", "grey_production_entry_controller_v2" );'
															style="cursor:pointer;">
															<td align="center"><? echo $i; ?></td>
															<td align="center"><? echo $row[csf("roll_no")]; ?></td>
															<td align="center"><? echo $row[csf("barcode_no")]; ?></td>
															<td align="right"><? echo number_format($row[csf("total_penalty_point")], 2); ?></td>
															<td align="right"><? echo number_format($row[csf("total_point")], 2); ?></td>
															<td><? echo $row[csf("fabric_grade")]; ?></td>
															<td><? echo $row[csf("comments")]; ?></td>
														</tr>
														<?
														$i++;
													}
													?>
												</tbody>
                        <!--<tfoot>
				<tr>
					<th></th>
					<th></th>
					<th></th>
					<th></th>
					<th></th>
					<th></th>
					<th></th>
				</tr>
			</tfoot>-->
		</table>
		<?
	}
	?>
</div>
</div>
</form>
</body>
<script src="../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if ($action == "barcode_defect_popup") {
	extract($_REQUEST);
	echo load_html_head_contents("Barcode Popup", "../../", 1, 1, '', '', '');
	?>
	<script>
		function js_set_value(str) {
			$('#hide_barcode_id').val(str);
			parent.emailwindow.hide();
		}
	</script>
	<?

	$sql = "SELECT a.recv_number, a.location_id, b.prod_id, c.barcode_no, c.id as roll_id, c.roll_no, c.qnty, d.po_number, d.pub_shipment_date, d.job_no_mst, d.file_no, d.grouping
	FROM inv_receive_master a, pro_grey_prod_entry_dtls b, pro_roll_details c, wo_po_break_down d
	WHERE a.id=b.mst_id and b.id=c.dtls_id and c.po_breakdown_id=d.id and a.id=$mstId and b.id=$update_dtls_id and a.entry_form in(2) and c.entry_form in(2) and c.status_active=1 and c.is_deleted=0 and c.roll_no>0";

	//echo $sql;//die;
	$result = sql_select($sql);
	$data_arr = array();
	foreach ($result as $row) {
		$data_arr[$row[csf('barcode_no')]]['barcode_no'] 	=$row[csf('barcode_no')];
		$data_arr[$row[csf('barcode_no')]]['prod_id']		=$row[csf('prod_id')];
		$data_arr[$row[csf('barcode_no')]]['job_no_mst']	=$row[csf('job_no_mst')];
		$data_arr[$row[csf('barcode_no')]]['po_number']		=$row[csf('po_number')];
		$data_arr[$row[csf('barcode_no')]]['location_id']	=$row[csf('location_id')];
		$data_arr[$row[csf('barcode_no')]]['file_no']		=$row[csf('file_no')];
		$data_arr[$row[csf('barcode_no')]]['grouping']		=$row[csf('grouping')];
		$data_arr[$row[csf('barcode_no')]]['shipment_date']	=$row[csf('pub_shipment_date')];
		$data_arr[$row[csf('barcode_no')]]['roll_no']		=$row[csf('roll_no')];
		$data_arr[$row[csf('barcode_no')]]['roll_id']		=$row[csf('roll_id')];
		$data_arr[$row[csf('barcode_no')]]['qnty']			=$row[csf('qnty')];

		$locationId = $row[csf('location_id')];
		$product_id = $row[csf('prod_id')];

		$barcodeArr[$row[csf('barcode_no')]] =  $row[csf('barcode_no')];
	}

	$product_arr = return_library_array("select id, product_name_details from product_details_master where item_category_id=13 and status_active=1 and is_deleted=0 and id=$product_id", 'id', 'product_name_details');

	$location_arr = return_library_array("select id, location_name from lib_location where status_active=1 and is_deleted=0 and id=$locationId", 'id', 'location_name');

	if(!empty($barcodeArr))
	{
		$data_delivery_array = sql_select("select d.barcode_num from pro_grey_prod_delivery_dtls d where  d.entry_form=56 and d.status_active=1 and d.is_deleted=0 and barcode_num in (".implode(",",$barcodeArr).")");

		foreach ($data_delivery_array as $row) {
			unset($data_arr[$row[csf('barcode_num')]]);
		}
	}

	?>
	<input type="hidden" id="hide_barcode_id"/>
	<table cellspacing="0" cellpadding="0" border="1" rules="all" width="940" class="rpt_table">
		<thead>
			<th width="30">SL</th>
			<th width="150">Fabric Description</th>
			<th width="100">Job No</th>
			<th width="110">Order No</th>
			<th width="110">Location</th>
			<th width="70">File NO</th>
			<th width="70">Ref No</th>
			<th width="70">Shipment Date</th>
			<th width="90">Barcode No</th>
			<th width="50">Roll No</th>
			<th>Roll Qty.</th>
		</thead>
	</table>
	<div style="width:960px; max-height:210px; overflow-y:scroll" id="list_container_batch" align="left">
		<table cellspacing="0" cellpadding="0" border="1" rules="all" width="940" class="rpt_table"
		id="tbl_list_search">
		<?
		$i = 1;
		foreach ($data_arr as $barcode=>$row) {
			if ($i % 2 == 0) $bgcolor = "#E9F3FF"; else $bgcolor = "#FFFFFF";
			?>
			<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer"
				id="search<? echo $i; ?>"
				onClick="js_set_value('<? echo $row['barcode_no'] . "**" . $row['roll_id']; ?>')">
				<td width="30" align="center">
					<? echo $i; ?>
					<input type="hidden" name="txt_individual_id" id="txt_individual_id<?php echo $i; ?>"
					value="<?php echo $row['barcode_no']; ?>"/>
				</td>
				<td width="150"><p><? echo $product_arr[$row['prod_id']]; ?></p></td>
				<td width="100"><p><? echo $row['job_no_mst']; ?></p></td>
				<td width="110"><p><? echo $row['po_number']; ?></p></td>
				<td width="110" align="center"><? echo $location_arr[$row['location_id']]; ?></td>
				<td width="70" align="center"><? echo $row['file_no']; ?></td>
				<td width="70" align="center"><? echo $row['grouping']; ?></td>
				<td width="70" align="center"><? echo change_date_format($row['pub_shipment_date']); ?></td>
				<td width="90"><p><? echo $row['barcode_no']; ?>&nbsp;</p></td>
				<td width="50" align="center"><? echo $row['roll_no']; ?></td>
				<td align="right"><? echo number_format($row['qnty'], 2); ?></td>
			</tr>
			<?
			$i++;
		}
		?>
	</table>
</div>
<?
exit();
}

if ($action == "barcode_roll_find") {

	extract($_REQUEST);

	$supplier_arr = return_library_array("select id, short_name from  lib_supplier", "id", "short_name");

	$data_array = sql_select("SELECT a.id, a.entry_form, a.company_id, a.receive_basis, a.booking_no, a.booking_id, a.knitting_source, a.knitting_company, b.id as dtls_id, b.prod_id, b.body_part_id, b.febric_description_id, b.machine_no_id, b.gsm, b.width, b.color_id,b.yarn_prod_id, b.yarn_lot, b.yarn_count, c.barcode_no, c.id as roll_id, c.roll_no, c.qnty
		FROM inv_receive_master a, pro_grey_prod_entry_dtls b, pro_roll_details c
		WHERE a.id=b.mst_id and b.id=c.dtls_id and a.entry_form in(2) and c.entry_form in(2) and c.status_active=1 and c.is_deleted=0 and c.barcode_no=$bar_code and a.id=$mstId and c.dtls_id=$dtls_id");
	
	$febric_description_id="";
	foreach ($data_array as $val) 
	{
		$febric_description_id .= $val[csf('febric_description_id')].",";
	}

	$febric_description_id = chop($febric_description_id,",");

	if($febric_description_id !="")
	{
		$sql_deter = "select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id in ($febric_description_id) order by b.id asc";
		$deter_array = sql_select($sql_deter);
		foreach ($deter_array as $row)
		{
			$constructtion_arr[$row[csf('id')]] = $row[csf('construction')];
			$composition_arr[$row[csf('id')]] .= $composition[$row[csf('copmposition_id')]] . " " . $row[csf('percent')] . "% ";
		}
	}

	if(!empty($data_array) && $bar_code!="")
	{
		$data_delivery = sql_select("select c.sys_number,d.barcode_num from pro_grey_prod_delivery_mst c,pro_grey_prod_delivery_dtls d where  d.entry_form=56 and d.status_active=1 and d.is_deleted=0 and barcode_num=$bar_code and c.id=d.mst_id");

		foreach ($data_delivery as $row) {

			if($row[csf('barcode_num')]!="")
			{
				exit("13**This barcode is allready delivered.\n Delivered No is '". $row[csf('sys_number')]."'\n");
			}
		}
	}

	foreach ($data_array as $row) {
		echo "document.getElementById('txt_barcode').value 			= '" . $row[csf("barcode_no")] . "';\n";
		echo "document.getElementById('txt_roll_no').value 			= '" . $row[csf("roll_no")] . "';\n";
		echo "document.getElementById('roll_id').value 				= '" . $row[csf("roll_id")] . "';\n";
		echo "document.getElementById('txt_roll_weight').value 		= '" . $row[csf("qnty")] . "';\n";
		echo "document.getElementById('old_qty').value 				= '" . $row[csf("qnty")] . "';\n";
		echo "document.getElementById('txt_constract_comp').value 	= '" . $constructtion_arr[$row[csf("febric_description_id")]] . ' ' . $composition_arr[$row[csf('febric_description_id')]] . "';\n";
		echo "document.getElementById('txt_gsm').value 				= '" . $row[csf("gsm")] . "';\n";
		echo "document.getElementById('txt_dia').value 				= '" . $row[csf("width")] . "';\n";
		$machine_dia = return_field_value("dia_width", "lib_machine_name", "id=" . $row[csf("machine_no_id")], "dia_width");
		echo "document.getElementById('txt_mc_dia').value 				= '" . $machine_dia . "';\n";
		$color_id_arr = array_unique(explode(",", $row[csf("color_id")]));
		$all_color = "";
		foreach ($color_id_arr as $color_id) {
			$all_color .= return_field_value("color_name", "lib_color", "id='$color_id'", "color_name") . ",";
		}
		$all_color = chop($all_color, ",");
		echo "document.getElementById('txt_color').value 				= '" . $all_color . "';\n";
		$yarn_count_arr = array_unique(explode(",", $row[csf("yarn_count")]));
		$all_yarn_count = "";
		foreach ($yarn_count_arr as $count_id) {
			$all_yarn_count .= return_field_value("yarn_count", "lib_yarn_count", "id='$count_id'", "yarn_count") . ",";
		}
		$all_yarn_count = chop($all_yarn_count, ",");
		echo "document.getElementById('txt_yarn_count').value 				= '" . $all_yarn_count . "';\n";
		echo "document.getElementById('txt_yarn_lot').value 				= '" . $row[csf("yarn_lot")] . "';\n";
		/*$lot_arr = array_unique(explode(",", $row[csf("yarn_lot")]));
		foreach ($lot_arr as $lot) {
			$supplier_id = return_field_value("max(supplier_id) as supplier_id", "product_details_master", "item_category_id=1 and lot='$lot'", "supplier_id");
			$all_supplier .= $supplier_arr[$supplier_id] . ",";
		}*/

		$yarn_prod_arr = array_filter(array_unique(explode(",", $row[csf("yarn_prod_id")])));

		if(!empty($yarn_prod_arr))
		{
			$yarn_prod_sql = sql_select("select supplier_id from product_details_master where item_category_id =1 and id in (". implode(",",$yarn_prod_arr).")");
			foreach ($yarn_prod_sql as $row)
			{
				$all_supplier .= $supplier_arr[$row[csf("supplier_id")]] . ",";
			}
		}
		$all_supplier = implode(",",array_unique(explode(",",chop($all_supplier, ','))));
		echo "document.getElementById('txt_spning_mill').value 				= '" . $all_supplier . "';";
	}

	exit();
}


if ($action == "save_update_delete_defect") {
	$process = array(&$_POST);
	extract(check_magic_quote_gpc($process));

	$variable_settingAutoQC = sql_select("select auto_update from variable_settings_production where company_name =$company_id and variable_list in(47) and item_category_id=13 and is_deleted=0 and status_active=1");

	$autoProductionQuantityUpdatebyQC = $variable_settingAutoQC[0][csf("auto_update")];

	$prod_dtls_id = str_replace("'", "", $hide_dtls_id);
	$barcode_no = str_replace("'", "", $txt_barcode);
	$roll_maintain = str_replace("'", "", $hide_roll_maintain);
	$production_mst_id = str_replace("'", "", $hide_mst_id);

	$qnty = str_replace("'", "", $txt_roll_weight);
	$rejectQty = str_replace("'", "", $txt_reject_qnty);
	$reject_qnty_pre = str_replace("'", "", $txt_reject_qnty_pre);

	$qc_qnty = ($qnty-$rejectQty+($reject_qnty_pre*1));
	$roll_qc_rj_result =sql_select("SELECT sum(qnty) as qc_qnty,sum(reject_qnty) as reject_qnty from pro_roll_details where dtls_id=$prod_dtls_id and barcode_no != $txt_barcode and status_active=1 and is_deleted=0 and entry_form=2");
	$details_reject_qty=$roll_qc_rj_result[0][csf('reject_qnty')]+$rejectQty;
	$details_qc_qty=$roll_qc_rj_result[0][csf('qc_qnty')]+$qc_qnty;
//echo "10**".$details_reject_qty."**".$details_qc_qty;die;
	if ($operation == 0)  // Insert Here
	{
		$con = connect();
		if ($db_type == 0) {
			mysql_query("BEGIN");
		}

		if (str_replace("'", "", $prod_dtls_id) != "")
		{
			if ($roll_maintain == 1)
			{
				$pre_count =  sql_select("select count(id) as count from pro_qc_result_mst where pro_dtls_id=$prod_dtls_id and barcode_no='$barcode_no' and status_active=1 and is_deleted=0");
				if ($pre_count[0][csf("count")] > 0)
				{
					echo "20**Barcode Number is Already Exists";
					die;
				}
			} else
			{
				$pre_count =  sql_select("select count(id) as count from pro_qc_result_mst where pro_dtls_id=$prod_dtls_id and status_active=1 and is_deleted=0");
				if($pre_count[0][csf("count")] > 0)
				{
					echo "20**Duplicate Fabric is Not Allow in Same QC.";
					die;
				}
			}
		}

		//$id = return_next_id("id", "pro_qc_result_mst", 1);
		$id = return_next_id_by_sequence("PRO_QC_RESULT_MST_SEQ", "pro_qc_result_mst", $con);
		$field_array_mst = "id, pro_dtls_id, roll_maintain, barcode_no, roll_id, roll_no, qc_name, roll_width, roll_weight, roll_length, reject_qnty, qc_date, total_penalty_point, total_point, fabric_grade, comments, inserted_by, insert_date";

		$data_array_mst = "(" . $id . "," . $hide_dtls_id . "," . $hide_roll_maintain . "," . $txt_barcode . "," . $roll_id . "," . $txt_roll_no . "," . $txt_qc_name . "," . $txt_roll_width . "," . $qc_qnty . "," . $txt_roll_length . "," . $txt_reject_qnty . "," . $txt_qc_date . "," . $total_penalty_point . "," . $total_point . "," . $fabric_grade . "," . $fabric_comments . "," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "')";

		//echo "insert into inv_receive_master (".$field_array.") values ".$data_array;die;
		$qc_update_id = $id;

		$count_tbl_length = str_replace("'", "", $count_tbl_length);

		//$dtls_id = return_next_id("id", "pro_qc_result_dtls", 1);
		$field_array_dtls = "id, mst_id, defect_name, defect_count, found_in_inch, found_in_inch_point, penalty_point, inserted_by, insert_date";
		$data_array_dtls = "";

		for ($i = 1; $i <= $count_tbl_length; $i++) {
			$dtls_id = return_next_id_by_sequence("PRO_QC_RESULT_DTLS_SEQ", "pro_qc_result_dtls", $con);

			$defectId = 'defectId_' . $i;
			$defectcount = 'defectcount_' . $i;
			$foundInche = 'foundInche_' . $i;
			$foundIncheVal = 'foundIncheVal_' . $i;
			$penaltycount = 'penaltycount_' . $i;

			if ($data_array_dtls != "") $data_array_dtls .= ",";

			$data_array_dtls .= "(" . $dtls_id . "," . $id . ",'" . $$defectId . "','" . $$defectcount . "','" . $$foundInche . "','" . $$foundIncheVal . "','" . $$penaltycount . "'," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "')";
			//$dtls_id++;
		}



		//echo "10**10 insert into pro_qc_result_mst (".$field_array_mst.") values ".$data_array_mst;die;

		$rID = $rID2 = true;
		$rID = sql_insert("pro_qc_result_mst", $field_array_mst, $data_array_mst, 0);
		if($data_array_dtls!=""){

			$rID2 = sql_insert("pro_qc_result_dtls", $field_array_dtls, $data_array_dtls, 0);
		}

		if($autoProductionQuantityUpdatebyQC == 1)
		{
			$pro_roll_sql ="UPDATE pro_roll_details SET qnty=$qc_qnty,reject_qnty='$rejectQty' WHERE barcode_no = $txt_barcode AND entry_form=2 and dtls_id=$prod_dtls_id";


			$rID3 = execute_query($pro_roll_sql,1);

			if($rID3)
			{
				$pro_grey_prod_sql ="UPDATE pro_grey_prod_entry_dtls SET grey_receive_qnty=".$details_qc_qty.",reject_fabric_receive=".$details_reject_qty." WHERE id=$prod_dtls_id";

				$rID4 = execute_query($pro_grey_prod_sql,1);
			}

		}


		//echo "10**$rID && $rID2 && $rID3 && $rID4";die;
		if ($db_type == 0) {
			if($autoProductionQuantityUpdatebyQC == 1)
			{
				if ($rID && $rID2 && $rID3 && $rID4) {
					mysql_query("COMMIT");
					echo "0**" . $qc_update_id;
				} else {
					mysql_query("ROLLBACK");
					echo "5**0";
				}
			}else {
				if ($rID && $rID2) {
					mysql_query("COMMIT");
					echo "0**" . $qc_update_id;
				} else {
					mysql_query("ROLLBACK");
					echo "5**0";
				}
			}

		} else if ($db_type == 2 || $db_type == 1) {
			if($autoProductionQuantityUpdatebyQC == 1)
			{
				//echo "$rID && $rID2 && $rID3 && $rID4" ; die();
				if ($rID && $rID2 && $rID3 && $rID4) {
					oci_commit($con);
					echo "0**" . $qc_update_id;
				} else {
					oci_rollback($con);
					echo "5**0";
				}
			}else {
				if ($rID && $rID2) {
					oci_commit($con);
					echo "0**" . $qc_update_id;
				} else {
					oci_rollback($con);
					echo "5**0";
				}
			}
		}

		disconnect($con);
		die;
	}
	else if ($operation == 1)   // Update Here
	{
		$con = connect();
		if ($db_type == 0) {
			mysql_query("BEGIN");
		}

		$roll_maintain = str_replace("'", "", $hide_roll_maintain);
		if ($roll_maintain == 1)
		{
			$pre_count =  sql_select("select count(id) as count from pro_qc_result_mst where pro_dtls_id=$hide_dtls_id and barcode_no=$txt_barcode and id <> $update_id and status_active=1 and is_deleted=0");
			if ($pre_count[0][csf("count")] > 0)
			{
				echo "20**Barcode Number is Already Exists.";
				die;
			}
		}

		$field_array_update = "pro_dtls_id*roll_maintain*barcode_no*roll_id*roll_no*qc_name*roll_width*roll_weight*roll_length*reject_qnty*qc_date*total_penalty_point*total_point*fabric_grade*comments*update_by*update_date";

		$data_array_update = $hide_dtls_id . "*" . $hide_roll_maintain . "*" . $txt_barcode . "*" . $roll_id . "*" . $txt_roll_no . "*" . $txt_qc_name . "*" . $txt_roll_width . "*" . $qc_qnty . "*" . $txt_roll_length . "*" . $txt_reject_qnty . "*" . $txt_qc_date . "*" . $total_penalty_point . "*" . $total_point . "*" . $fabric_grade . "*" . $fabric_comments . "*" . $_SESSION['logic_erp']['user_id'] . "*'" . $pc_date_time . "'";

		$deleteDetails = execute_query("delete from  pro_qc_result_dtls where mst_id=$update_id and form_type is null");

		//$dtls_id = return_next_id("id", "pro_qc_result_dtls", 1);
		$field_array_dtls = "id, mst_id, defect_name, defect_count, found_in_inch, found_in_inch_point, penalty_point, inserted_by, insert_date";
		$data_array_dtls = "";

		for ($i = 1; $i <= $count_tbl_length; $i++)

		{
			$dtls_id = return_next_id_by_sequence("PRO_QC_RESULT_DTLS_SEQ", "pro_qc_result_dtls", $con);
			$defectId = 'defectId_' . $i;
			$defectcount = 'defectcount_' . $i;
			$foundInche = 'foundInche_' . $i;
			$foundIncheVal = 'foundIncheVal_' . $i;
			$penaltycount = 'penaltycount_' . $i;

			if ($data_array_dtls != "") $data_array_dtls .= ",";

			$data_array_dtls .= "(" . $dtls_id . "," . $update_id . ",'" . $$defectId . "','" . $$defectcount . "','" . $$foundInche . "','" . $$foundIncheVal . "','" . $$penaltycount . "'," . $_SESSION['logic_erp']['user_id'] . ",'" . $pc_date_time . "')";
			//$dtls_id++;
		}
		//echo "insert into pro_qc_result_dtls (".$field_array_dtls.") values ".$data_array_dtls;die;
		$rID2=true;
		$rID = sql_update("pro_qc_result_mst", $field_array_update, $data_array_update, "id", $update_id, 0);

		if($data_array_dtls!=""){
			$rID2 = sql_insert("pro_qc_result_dtls", $field_array_dtls, $data_array_dtls, 0);
		}

		if($autoProductionQuantityUpdatebyQC == 1)
		{

			$pro_roll_sql ="UPDATE pro_roll_details SET qnty=$qc_qnty,reject_qnty='$rejectQty' WHERE barcode_no = $txt_barcode AND entry_form=2 and dtls_id=$prod_dtls_id and status_active=1 and is_deleted=0";
			$rID3 = execute_query($pro_roll_sql,1);

			if($rID3)
			{
				//$roll_qc_rj_result =sql_select("SELECT sum(qnty) as qc_qnty,sum(reject_qnty) as reject_qnty from pro_roll_details where dtls_id=$prod_dtls_id and status_active=1 and is_deleted=0 and entry_form=2");

				//$pro_grey_prod_sql ="UPDATE pro_grey_prod_entry_dtls SET grey_receive_qnty=".$roll_qc_rj_result[0][csf('qc_qnty')].",reject_fabric_receive=".$roll_qc_rj_result[0][csf('reject_qnty')]." WHERE id=$prod_dtls_id";
				$pro_grey_prod_sql ="UPDATE pro_grey_prod_entry_dtls SET grey_receive_qnty=".$details_qc_qty.",reject_fabric_receive=".$details_reject_qty." WHERE id=$prod_dtls_id";
				$rID4 = execute_query($pro_grey_prod_sql,1);
			}
		}


		//echo "10**$rID###$rID2";die;
		$qc_update_id = str_replace("'", "", $update_id);

		if ($db_type == 0) {
			if($autoProductionQuantityUpdatebyQC == 1)
			{
				if ($rID && $deleteDetails && $rID2 && $rID3 && $rID4) {
					mysql_query("COMMIT");
					echo "1**" . $qc_update_id;
				} else {
					mysql_query("ROLLBACK");
					echo "6**0";
				}
			}else {
				if ($rID && $deleteDetails && $rID2) {
					mysql_query("COMMIT");
					echo "1**" . $qc_update_id;
				} else {
					mysql_query("ROLLBACK");
					echo "6**0";
				}
			}

		} else if ($db_type == 2 || $db_type == 1) {

			if($autoProductionQuantityUpdatebyQC == 1)
			{
				//echo "$rID && $deleteDetails && $rID2 && $rID3"; die();
				if ($rID && $deleteDetails && $rID2 && $rID3 && $rID4) {
					oci_commit($con);
					echo "1**" . $qc_update_id;
				} else {
					oci_rollback($con);
					echo "6**0";
				}
			}else{
				if ($rID && $deleteDetails && $rID2) {
					oci_commit($con);
					echo "1**" . $qc_update_id;
				} else {
					oci_rollback($con);
					echo "6**0";
				}
			}

		}
		disconnect($con);
		die;
	}
	exit();
}

if ($action == "show_qc_listview") {
	$sql_dtls = sql_select("select id, pro_dtls_id, barcode_no, roll_id, roll_no, total_penalty_point, total_point, fabric_grade, comments from pro_qc_result_mst where pro_dtls_id=$data and status_active=1");
	?>
	<table cellspacing="0" cellpadding="0" border="1" rules="all" width="850" class="rpt_table">
		<thead>
			<tr>
				<th width="50">SL</th>
				<th width="100">Roll No</th>
				<th width="100">Barcode</th>
				<th width="100">Penalty Point</th>
				<th width="100">Total Point</th>
				<th width="100">Fabric Grade</th>
				<th>Comments</th>
			</tr>
		</thead>
		<tbody>
			<?
			$i = 1;
			foreach ($sql_dtls as $row) {
				if ($i % 2 == 0)
					$bgcolor = "#E9F3FF";
				else
					$bgcolor = "#FFFFFF";
				?>
				<tr bgcolor="<? echo $bgcolor; ?>"
					onClick='get_php_form_data(<? echo $row[csf("id")]; ?>, "populate_qc_from_grey_recv", "grey_production_entry_controller_v2" );'
					style="cursor:pointer;">
					<td align="center"><? echo $i; ?></td>
					<td><? echo $row[csf("roll_no")]; ?></td>
					<td><? echo $row[csf("barcode_no")]; ?></td>
					<td align="right"><? echo number_format($row[csf("total_penalty_point")], 2); ?></td>
					<td align="right"><? echo number_format($row[csf("total_point")], 2); ?></td>
					<td><? echo $row[csf("fabric_grade")]; ?></td>
					<td><? echo $row[csf("comments")]; ?></td>
				</tr>
				<?
				$i++;
			}
			?>
		</tbody>
        <!--<tfoot>
        	<tr>
            	<th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </tfoot>-->
    </table>
    <?
    exit();
}

if ($action == "populate_qc_from_grey_recv") {
	$supplier_arr = return_library_array("select id, short_name from  lib_supplier", "id", "short_name");
	$sql_deter = "select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id order by b.id asc";
	$data_array = sql_select($sql_deter);
	foreach ($data_array as $row) {
		$constructtion_arr[$row[csf('id')]] = $row[csf('construction')];
		$composition_arr[$row[csf('id')]] .= $composition[$row[csf('copmposition_id')]] . " " . $row[csf('percent')] . "% ";
	}
	$sql_qc = sql_select("select id, pro_dtls_id, roll_maintain, barcode_no, roll_id, roll_no, qc_name, roll_width, roll_weight, roll_length, reject_qnty, qc_date, total_penalty_point, total_point, fabric_grade, comments from pro_qc_result_mst where id=$data");

	foreach ($sql_qc as $row)
	{
		$mst_id=$row[csf("id")];
		$total_penalty_point=$row[csf("total_penalty_point")];
		$total_point=$row[csf("total_point")];
		$fabric_grade=$row[csf("fabric_grade")];
		$comments=$row[csf("comments")];
		echo "document.getElementById('update_id').value 			= '" . $row[csf("id")] . "';\n";
		echo "document.getElementById('txt_barcode').value 			= '" . $row[csf("barcode_no")] . "';\n";
		echo "document.getElementById('txt_roll_no').value 			= '" . $row[csf("roll_no")] . "';\n";
		echo "document.getElementById('roll_id').value 				= '" . $row[csf("roll_id")] . "';\n";
		echo "document.getElementById('txt_qc_name').value 			= '" . $row[csf("qc_name")] . "';\n";
		echo "document.getElementById('txt_roll_width').value 		= '" . $row[csf("roll_width")] . "';\n";
		echo "document.getElementById('txt_roll_weight').value 		= '" . $row[csf("roll_weight")] . "';\n";
		echo "document.getElementById('old_qty').value 				= '" . $row[csf("roll_weight")] . "';\n";
		echo "document.getElementById('txt_roll_length').value 		= '" . $row[csf("roll_length")] . "';\n";
		echo "document.getElementById('txt_reject_qnty').value 		= '" . $row[csf("reject_qnty")] . "';\n";
		echo "document.getElementById('txt_reject_qnty_pre').value 		= '" . $row[csf("reject_qnty")] . "';\n";
		echo "document.getElementById('txt_qc_date').value 			= '" . change_date_format($row[csf("qc_date")]) . "';\n";


		$data_array = sql_select("SELECT  b.body_part_id, b.febric_description_id, b.machine_no_id, b.gsm, b.width, b.color_id, b.yarn_lot, b.yarn_count, b.yarn_prod_id
			FROM  pro_grey_prod_entry_dtls b
			WHERE b.id=" . $row[csf("pro_dtls_id")]);


		echo "document.getElementById('txt_constract_comp').value 				= '" . $constructtion_arr[$data_array[0][csf("febric_description_id")]] . ' ' . $composition_arr[$data_array[0][csf("febric_description_id")]] . "';\n";


		echo "document.getElementById('txt_gsm').value 				= '" . $data_array[0][csf("gsm")] . "';\n";
		echo "document.getElementById('txt_dia').value 				= '" . $data_array[0][csf("width")] . "';\n";
		$machine_dia = return_field_value("dia_width", "lib_machine_name", "id=" . $data_array[0][csf("machine_no_id")], "dia_width");
		echo "document.getElementById('txt_mc_dia').value 				= '" . $machine_dia . "';\n";

		$color_id_arr = array_unique(explode(",", $data_array[0][csf("color_id")]));
		$all_color = "";
		foreach ($color_id_arr as $color_id) {
			$all_color .= return_field_value("color_name", "lib_color", "id='$color_id'", "color_name") . ",";
		}
		$all_color = chop($all_color, ",");
		echo "document.getElementById('txt_color').value 				= '" . $all_color . "';\n";
		$yarn_count_arr = array_unique(explode(",", $data_array[0][csf("yarn_count")]));
		$all_yarn_count = "";
		foreach ($yarn_count_arr as $count_id) {
			$all_yarn_count .= return_field_value("yarn_count", "lib_yarn_count", "id='$count_id'", "yarn_count") . ",";
		}
		$all_yarn_count = chop($all_yarn_count, ",");
		echo "document.getElementById('txt_yarn_count').value 				= '" . $all_yarn_count . "';\n";
		echo "document.getElementById('txt_yarn_lot').value 				= '" . $data_array[0][csf("yarn_lot")] . "';\n";

		/*$lot_arr = array_unique(explode(",", $data_array[0][csf("yarn_lot")]));
		foreach ($lot_arr as $lot) {
			$supplier_id = return_field_value("max(supplier_id) as supplier_id", "product_details_master", "item_category_id=1 and lot='$lot'", "supplier_id");
			$all_supplier .= $supplier_arr[$supplier_id] . ",";
		}*/

		$yarn_prod_arr = array_filter(array_unique(explode(",", $data_array[0][csf("yarn_prod_id")])));
		if(!empty($yarn_prod_arr))
		{
			$yarn_prod_sql = sql_select("select supplier_id from product_details_master where item_category_id =1 and id in (". implode(",",$yarn_prod_arr).")");
			foreach ($yarn_prod_sql as $row)
			{
				$all_supplier .= $supplier_arr[$row[csf("supplier_id")]] . ",";
			}
		}
		$all_supplier = implode(",",array_unique(explode(",",chop($all_supplier, ','))));

		// $sup=return_field_value("supplier_id", "lib_supplier", "id=1");
		// return_field_value("buyer_name", "lib_buyer", "id=1");

		echo "document.getElementById('txt_spning_mill').value 				= '" . $all_supplier . "';\n";
		//echo "document.getElementById('txt_qc_date').value 				= '" . change_date_format($row[csf("qc_date")]) . "';\n";

		$dtls_part_tbody_data = "";
		$dtls_sql = sql_select("select id, defect_name, defect_count, found_in_inch, found_in_inch_point, penalty_point from pro_qc_result_dtls where mst_id='$mst_id' and status_active=1 and is_deleted=0 and form_type is null");
		$dtls_data_arr = array();
		foreach ($dtls_sql as $dtls_row) {
			$dtls_data_arr[$dtls_row[csf("defect_name")]]["dtls_id"] = $dtls_row[csf("id")];
			$dtls_data_arr[$dtls_row[csf("defect_name")]]["defect_name"] = $dtls_row[csf("defect_name")];
			$dtls_data_arr[$dtls_row[csf("defect_name")]]["defect_count"] = $dtls_row[csf("defect_count")];
			$dtls_data_arr[$dtls_row[csf("defect_name")]]["found_in_inch"] = $dtls_row[csf("found_in_inch")];
			$dtls_data_arr[$dtls_row[csf("defect_name")]]["found_in_inch_point"] = $dtls_row[csf("found_in_inch_point")];
			$dtls_data_arr[$dtls_row[csf("defect_name")]]["penalty_point"] = $dtls_row[csf("penalty_point")];
		}
		$i = 1;
		echo "$('#dtls_part').find('input').not('.defectId, .UpdefectId').val('');\n";
		foreach ($knit_defect_array as $defect_id => $val) {
			if ($dtls_data_arr[$defect_id]["defect_name"] > 0) {
				echo "document.getElementById('UpdefectId_$i').value 				= '" . $dtls_data_arr[$defect_id]["defect_name"] . "';\n";
				echo "document.getElementById('defectcount_$i').value 				= '" . $dtls_data_arr[$defect_id]["defect_count"] . "';\n";
				echo "document.getElementById('foundInche_$i').value 				= '" . $dtls_data_arr[$defect_id]["found_in_inch"] . "';\n";
				echo "document.getElementById('foundInchePoint_$i').value 				= '" . $dtls_data_arr[$defect_id]["found_in_inch_point"] . "';\n";
				echo "document.getElementById('penaltycount_$i').value 				= '" . $dtls_data_arr[$defect_id]["penalty_point"] . "';\n";
			}
			$i++;
		}

		echo "document.getElementById('total_penalty_point').value 				= '" .$total_penalty_point. "';\n";
		echo "document.getElementById('total_point').value 				= '" . $total_point. "';\n";
		echo "document.getElementById('fabric_grade').value 				= '" . $fabric_grade . "';\n";
		echo "document.getElementById('fabric_comments').value 				= '" . $comments. "';\n";
		echo "set_button_status(1, '" . $_SESSION['page_permission'] . "', 'fnc_grey_defect_entry',1);\n";
		exit();
	}
}
// if($action="get_receive_basis"){
// 	$process = array( &$_POST );
// 	extract(check_magic_quote_gpc( $process ));

// 	$variable_set_invent=return_field_value("independent_controll","variable_settings_inventory","company_name='$company_id' and variable_list=20 and menu_page_id=180 and status_active=1 and is_deleted=0","independent_controll");
// 	$receive_basis=array(0=>"Independent",1=>"Fabric Booking",2=>"Knitting Plan",4=>"Sales Order");
// 	$is_independent_controlled = ($variable_set_invent ==1)?"0,1,2,4":"1,2,4";
// 	echo create_drop_down("cbo_receive_basis",152,$receive_basis,"",0,"",1,"set_receive_basis();service_booking_check();",$is_independent_controlled);
// 	exit();
// }

if ($action == "load_drop_down_sub_contract") {

	echo create_drop_down("cbo_sub_contract", 151, "select a.supplier_id ,(select c.supplier_name from lib_supplier c where c.id = a.supplier_id ) as supplier from lib_supplier_party_type a, lib_supplier_tag_company b where a.supplier_id = b.supplier_id and a.party_type = 20 and b.tag_company = '$data' order by supplier", "supplier_id,supplier", 1, "-- Select subcontract --", 0, "", "");
	exit();
}

if ($action == "rejection_challan_print") {
	extract($_REQUEST);
	$data = explode('*', $data);
	$company = $data[0];
	$txt_challan_no = $data[1];
	$update_id = $data[2];
	$all_po_id = $data[3];
			//echo $all_po_id;die;
	$company_array = array();
	$company_data = sql_select("select id, company_name, company_short_name from lib_company");
	foreach ($company_data as $row) {
		$company_array[$row[csf('id')]]['shortname'] = $row[csf('company_short_name')];
		$company_array[$row[csf('id')]]['name'] = $row[csf('company_name')];
	}

	$company_arr = return_library_array("select id, company_name from lib_company", 'id', 'company_name');
	$supplier_arr = return_library_array("select id, supplier_name from  lib_supplier", "id", "supplier_name");
	$location_arr = return_library_array("select id, location_name from  lib_location", 'id', 'location_name');
	$buyer_array = return_library_array("select id, short_name from lib_buyer", "id", "short_name");
	$machine_details = return_library_array("select id, machine_no from lib_machine_name", "id", "machine_no");
	$brand_details = return_library_array("select id, brand_name from lib_brand", "id", "brand_name");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$yarn_count_details = return_library_array("select id,yarn_count from lib_yarn_count", "id", "yarn_count");

	$all_po_id="";
	if($all_po_id==""){
		$po_id_sql = sql_select("select order_id from pro_grey_prod_entry_dtls where mst_id=$update_id and status_active=1 and is_deleted=0");
		foreach ($po_id_sql as $po_id_row) {
			$all_po_id .= $po_id_row[csf('order_id')].",";
		}
		$all_po_id = chop($all_po_id,",");
	}

	$job_array = array();
	$job_sql = "select a.job_no_prefix_num, a.job_no, b.id, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.id in ($all_po_id)";
	$job_sql_result = sql_select($job_sql);
	foreach ($job_sql_result as $row) {
		$job_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
		$job_array[$row[csf('id')]]['order_no'] = $row[csf('po_number')];
	}

	$composition_arr = array();
	$sql_deter = "select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id";
	$data_array = sql_select($sql_deter);
	foreach ($data_array as $row) {
		if (array_key_exists($row[csf('id')], $composition_arr)) {
			$composition_arr[$row[csf('id')]] = $composition_arr[$row[csf('id')]] . " " . $composition[$row[csf('copmposition_id')]] . " " . $row[csf('percent')] . "%";
		} else {
			$composition_arr[$row[csf('id')]] = $row[csf('construction')] . ", " . $composition[$row[csf('copmposition_id')]] . " " . $row[csf('percent')] . "%";
		}
	}

	$all_po_ids = explode(",", $all_po_id);
	foreach (array_unique($all_po_ids) as $po_ids)
	{
		$job_no=$job_array[$po_ids]['job_no'];
		$order_no.=$job_array[$po_ids]['order_no'].",";
	}

	$sql_data = sql_select("select  receive_date,company_id,buyer_id, knitting_source, knitting_company,knitting_location_id as location_id, remarks from inv_receive_master where id=$update_id and status_active=1 and is_deleted=0 and company_id=$company ");
	?>
	<div>
		<table width="100%" cellspacing="0" align="center" border="0"
		style="font-family: tahoma; font-size: 12px;">
		<tr>
			<td align="center" style="font-size:x-large">
				<strong><? echo $company_array[$company]['name']; ?></strong></td>
			</tr>
			<tr>
				<td align="center" style="font-size:20px;">
					<strong>Rejection Challan</strong></td>
				</tr>

				<tr>
					<td align="center" style="font-size:14px"><strong><u>Knitting Section</u></strong></td>
				</tr>

			</table>
			<br>

			<table width="100%" cellspacing="0" align="center" border="0"
			style="font-family: tahoma; font-size: 12px;">
			<tr>
				<td width="" id="barcode_img_id" colspan="2"></td>
			</tr>
			<tr>
				<td style="font-size:14px; font-weight:bold;" width="150">Challan No</td>
				<td width="200" style="font-size:16px; font-weight:bold;">
					:&nbsp;<? echo $txt_challan_no; ?></td>
					<td width="80" style="font-size:16px; font-weight:bold;">Job</td>
					<td width="250" style="font-size:16px;">:&nbsp;<? echo $job_no; ?></td>
					<td width="100" style="font-size:16px; font-weight:bold;">Production Date</td>
					<td width="">:&nbsp;<? echo change_date_format($sql_data[0][csf('receive_date')]); ?></td>
				</tr>
				<tr>
					<td style="font-size:14px; font-weight:bold;" width="150">Buyer Name</td>
					<td width="200">
						:&nbsp;<? echo $buyer_array[$sql_data[0][csf('buyer_id')]]; ?></td>
						<td style="font-size:14px; font-weight:bold;" width="80">Order No</td>
						<td width="250">
							:&nbsp;<? echo substr("$order_no",0,-1); ?></td>
							<td style="font-size:14px; font-weight:bold;" width="150">Knitting Source</td>
							<td width="200">:&nbsp;<? echo $knitting_source[$sql_data[0][csf('knitting_source')]]; ?></td>
						</tr>
						<tr>
							<td style="font-size:14px; font-weight:bold;" width="80">Knitting Com</td>
							<td width="250" style="font-weight:bold;">:&nbsp;
								<? 
								if ($sql_data[0][csf('knitting_source')]==1) 
								{
									echo $company_arr[$sql_data[0][csf('knitting_company')]];
								}
								else{
									echo $supplier_arr[$sql_data[0][csf('knitting_company')]];
								}
								?>
							</td>
							<td style="font-size:14px; font-weight:bold;" width="150">Knit. Location</td>
							<td width="200" id="" align="">:&nbsp;<? echo $location_arr[$sql_data[0][csf('location_id')]]; ?></td>
						</tr>
						<tr>


							<td style="font-size:14px; font-weight:bold;" width="150">Remarks</td>
							<td width="200">:&nbsp;<? echo $sql_data[0][csf('remarks')]; ?></td>
						</tr>
					</table>
					<br>
					<table cellspacing="0" cellpadding="3" border="1" rules="all" width="1310" class="rpt_table"
					style="font-family: tahoma; font-size: 12px;">
					<thead>
						<tr>
							<th width="30">SL</th>

							<th width="110">Production Basis</th>
							<th width="100">Prog/Booking No</th>
							<th width="80">Yarn Count</th>
							<th width="100">Yarn Brand</th>
							<th width="80">Lot No</th>
							<th width="80">Fab Color</th>
							<th width="150">Fabric Type</th>
							<th width="50">Stich</th>
							<th width="50">Fin GSM</th>
							<th width="50">Fab. Dia</th>
							<th width="50">MC. Dia</th>
							<th width="50">Machine No</th>
							<th width="50">Shift</th>
							<th width="80">Total Roll Qty</th>
							<th>Total Reject Qty</th>
						</tr>
					</thead>
					<?
					$roll_sql=sql_select("select mst_id,dtls_id,reject_qnty from pro_roll_details where mst_id=$update_id and entry_form=2 and status_active=1 and is_deleted=0");
					foreach ($roll_sql as $roll_velue) {
						if($roll_velue[csf('reject_qnty')]>0)
						{
							$roll_data_array[$roll_velue[csf('dtls_id')]]['roll_no'] +=1;
						}
					}

					$select_field = "";
					if($db_type == 0){
						$select_field .= " group_concat(distinct(a.booking_no)) as booking_no,";
						$select_field .= " group_concat(distinct(a.receive_basis)) as receive_basis";

					}else{
						$select_field .= " listagg( cast(a.booking_no as varchar2(4000)) , ',') within group (order by a.booking_no) as booking_no,";

						$select_field .= " listagg(a.receive_basis  , ',') within group (order by a.receive_basis) as receive_basis ";
					}

					$receive_basis = array(0 => "Independent", 1 => "Fabric Booking", 2 => "Knitting Plan");
					$sql="select a.id, $select_field, b.id, b.yarn_count,b.brand_id, b.yarn_lot,b.color_id,b.febric_description_id,b.stitch_length,b.gsm,b.width,b.machine_dia,b.machine_no_id,b.shift_name, count(b.no_of_roll) as no_of_roll, sum(b.reject_fabric_receive) as reject_fab_receive
					from inv_receive_master a, pro_grey_prod_entry_dtls b
					where a.id=b.mst_id and a.entry_form=2 and a.id=$update_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0
					group by a.id,b.id,b.yarn_count,b.brand_id, b.yarn_lot,b.color_id,b.febric_description_id,b.stitch_length,b.gsm,b.width,b.machine_dia,b.machine_no_id,b.shift_name";
					//echo $sql;//die;

					$i = 1;
					$data_array_mst = sql_select($sql);

					foreach ($data_array_mst as $row) {

						$receive_basiss	=$row[csf('receive_basis')];
						$booking_no     =$row[csf('booking_no')];
						$yarn_count     =$row[csf('yarn_count')];
						$brand_id       =$row[csf('brand_id')];
						$yarn_lot       =$row[csf('yarn_lot')];
						$color_id       =$row[csf('color_id')];
						$febric_desc_id =$row[csf('febric_description_id')];
						$stitch_length  =$row[csf('stitch_length')];
						$gsm            =$row[csf('gsm')];
						$width          =$row[csf('width')];
						$machine_dia    =$row[csf('machine_dia')];
						$machine_no_id  =$row[csf('machine_no_id')];
						$shift_names    =$row[csf('shift_name')];
						//$no_of_roll     =$row[csf('no_of_roll')];
						$reject_fab_rcv =$row[csf('reject_fab_receive')];

						$no_of_roll=$roll_data_array[$row[csf('id')]]['roll_no'];
						?>
						<tr>
							<td width="30"><? echo $i; ?></td>
							<td width="110" align="center">
								<?
								$rcv_basises = "";
								foreach(explode(",", $receive_basiss) as $rcv_basis)
								{
									$rcv_basises .= $receive_basis[$rcv_basis].",";
								}
								$rcv_basises = chop($rcv_basises,",");
								echo $rcv_basises;
								?>

							</td>
							<td width="100" style="word-break:break-all;" align="center"><? echo $booking_no; ?></td>
							<td width="80" style="word-break:break-all;" align="center">
								<?
								$yarn_counts = "";
								foreach (explode(",",$yarn_count) as $yarn_row) {
									$yarn_counts .= $yarn_count_details[$yarn_row].",";
								}
								$yarn_counts = chop($yarn_counts,",");
								echo $yarn_counts;
								?>
							</td>
							<td width="100" style="word-break:break-all;" align="center"><?echo $brand_details[$brand_id]; ?></td>
							<td width="80" style="word-break:break-all;" align="center"><?echo $yarn_lot; ?></td>
							<td width="80" style="word-break:break-all;" align="center"><? echo $color_arr[$color_id]; ?></td>
							<td width="150" style="word-break:break-all;" align="center"><?echo $composition_arr[$febric_desc_id]; ?></td>
							<td width="50" style="word-break:break-all;" align="center"><? echo $stitch_length; ?></td>
							<td width="50" style="word-break:break-all;" align="center"><? echo $gsm; ?></td>
							<td width="50" style="word-break:break-all;" align="center"><? echo $width; ?></td>
							<td width="50" style="word-break:break-all;" align="center"><? echo $machine_dia; ?></td>
							<td width="50" style="word-break:break-all;" align="center"><? echo $machine_details[$machine_no_id]; ?></td>
							<td width="50" align="center"><? echo $shift_name[$shift_names]; ?></td>
							<td width="80" align="center"><? echo $no_of_roll; ?></td>
							<td align="right"><? echo number_format($reject_fab_rcv, 2); ?></td>
						</tr>
						<?
						$tot_roll_qty += $no_of_roll;
						$tot_reject_qty += $reject_fab_rcv;
						$i++;
					}
					// echo "<pre>";
					// print_r($rpt_data);
					// die;
					?>
					<tr>
						<td align="right" colspan="14"><strong>Total= </strong></td>
						<td align="center"><? echo $tot_roll_qty; ?></td>
						<td align="right"><? echo number_format($tot_reject_qty, 2, '.', ''); ?></td>
					</tr>
				</table>
			</div>
			<? echo signature_table(230, $company, "1210px"); ?>
			<script type="text/javascript" src="../../../js/jquery.js"></script>
			<script type="text/javascript" src="../../../js/jquerybarcode.js"></script>
			<script>
				function generateBarcode(valuess) {
                    var value = valuess;//$("#barcodeValue").val();
                    //alert(value)
                    var btype = 'code39';//$("input[name=btype]:checked").val();
                    var renderer = 'bmp';// $("input[name=renderer]:checked").val();

                    var settings = {
                    	output: renderer,
                    	bgColor: '#FFFFFF',
                    	color: '#000000',
                    	barWidth: 1,
                    	barHeight: 40,
                    	moduleSize: 5,
                    	posX: 10,
                    	posY: 20,
                    	addQuietZone: 1
                    };
                    //$("#barcode_img_id").html('11');
                    value = {code: value, rect: false};

                    $("#barcode_img_id").show().barcode(value, btype, settings);
                }
                generateBarcode('<? echo $txt_challan_no; ?>');
	    </script>
	    <?
	    exit();
	}






        if ($action == 'KnittingProductionPrint') {
        	echo load_html_head_contents("WO Info", "../../", 1, 1, '', '', '');

        	$sqls_mst = "SELECT a.id, a.pro_dtls_id, a.roll_maintain, a.barcode_no, a.roll_id, a.roll_no, a.qc_name, a.roll_width, a.roll_weight, a.roll_length, a.reject_qnty, a.qc_date, a.total_penalty_point, a.total_point, a.fabric_grade, a.comments,b.body_part_id, b.febric_description_id, b.machine_no_id, b.gsm, b.width, b.color_id, b.yarn_lot, b.yarn_count FROM  pro_qc_result_mst a,   pro_grey_prod_entry_dtls b where a.pro_dtls_id=b.id and a.id=$data and b.status_active=1 and b.is_deleted=0";
        	$results=sql_select($sqls_mst);


        	$sql_dtls="SELECT id, mst_id, defect_name, defect_count, found_in_inch, found_in_inch_point, penalty_point from PRO_QC_RESULT_DTLS
        	where mst_id=$data";
        	$results_dtls=sql_select($sql_dtls);
        	foreach($results_dtls as $val_dtls)
        	{
        		$array_for_dtls_data[$val_dtls[csf("mst_id")]][$val_dtls[csf("defect_name")]]['name']=$val_dtls[csf("defect_name")];
        		$array_for_dtls_data[$val_dtls[csf("mst_id")]][$val_dtls[csf("defect_name")]]['counts']=$val_dtls[csf("defect_count")];
        		$array_for_dtls_data[$val_dtls[csf("mst_id")]][$val_dtls[csf("defect_name")]]['inch']=$val_dtls[csf("found_in_inch")];
        		$array_for_dtls_data[$val_dtls[csf("mst_id")]][$val_dtls[csf("defect_name")]]['inch_point']=$val_dtls[csf("found_in_inch_point")];
        		$array_for_dtls_data[$val_dtls[csf("mst_id")]][$val_dtls[csf("defect_name")]]['penalty']=$val_dtls[csf("penalty_point")];

        	}

        	if($results[0][csf("febric_description_id")] != "")
        	{
        		$sql_deter = "select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id =".$results[0][csf("febric_description_id")]." order by b.id asc";
				$deter_array = sql_select($sql_deter);
				foreach ($deter_array as $row)
				{
					$constructtion_arr[$row[csf('id')]] = $row[csf('construction')];
					$composition_arr[$row[csf('id')]] .= $composition[$row[csf('copmposition_id')]] . " " . $row[csf('percent')] . "% ";
				}
        	}

			//echo $data_array = sql_select("SELECT  b.body_part_id,c.pro_dtls_id ,c.id, b.febric_description_id, b.machine_no_id, b.gsm, b.width, b.color_id, b.yarn_lot, b.yarn_count FROM  pro_grey_prod_entry_dtls b,pro_qc_result_mst c WHERE b.id=c.pro_dtls_id");
        	$yarn_count_arr = return_library_array("select id,yarn_count from lib_yarn_count", 'id', 'yarn_count');
        	$color_arr = return_library_array("select id, color_name from lib_color where status_active=1 and id=".$results[0][csf("color_id")], 'id', 'color_name');
        	$cons_and_comp=$constructtion_arr[$results[0][csf("febric_description_id")]] . ' ' . $composition_arr[$results[0][csf("febric_description_id")]];

        	$machine_dia = return_field_value("dia_width", "lib_machine_name", "id=" . $results[0][csf("machine_no_id")], "dia_width");

			//echo "document.getElementById('txt_mc_dia').value 				= '" . $machine_dia . "';\n";

        	$supplier_arr = return_library_array("select id, short_name from  lib_supplier", "id", "short_name");

        	$lot_arr = array_unique(explode(",", $results[0][csf("yarn_lot")]));
        	foreach ($lot_arr as $lot) {
        		$supplier_id = return_field_value("max(supplier_id) as supplier_id", "product_details_master", "item_category_id=1 and lot='$lot'", "supplier_id");
        		$all_supplier .= $supplier_arr[$supplier_id] . ",";
        	}
        	$all_supplier = chop($all_supplier, ',');


        	?>
        	<div style="margin-top: 5px;">&nbsp;</div>
        	<div>
        		<div style="float: left;">
        			<table class="rpt_table" width="100%" border="1" cellpadding="3" cellspacing="0" style="font: 12px tahoma; border-bottom: 1px solid #999; margin-bottom: 2px;" >
        				<tr>
        					<td>Barcode Number</td>
        					<td><? echo $results[0][csf("barcode_no")];?></td>
        				</tr>

        				<tr>
        					<td>Roll Number</td>
        					<td><? echo $results[0][csf("roll_no")];?></td>
        				</tr>

        				<tr>
        					<td>QC Date</td>
        					<td><? echo $results[0][csf("qc_date")];?></td>
        				</tr>

        				<tr>
        					<td>QC Name</td>
        					<td><? echo $results[0][csf("qc_name")];?></td>
        				</tr>

        				<tr>
        					<td>Roll Width (inch)</td>
        					<td><? echo $results[0][csf("roll_width")];?></td>
        				</tr>

        				<tr>
        					<td>Roll Wgt. (Kg)</td>
        					<td><? echo $results[0][csf("roll_weight")];?></td>
        				</tr>
        				<tr>
        					<td>Roll Length (Yds)</td>
        					<td><? echo $results[0][csf("roll_length")];?></td>
        				</tr>

        				<tr>
        					<td>Reject Qty</td>
        					<td><? echo $results[0][csf("reject_qnty")];?></td>
        				</tr>

        				<tr>
        					<td>Construction & Composition</td>
        					<td><? echo $cons_and_comp;?></td>
        				</tr>
        				<tr>
        					<td>GSM</td>
        					<td><? echo $results[0][csf("gsm")];?></td>
        				</tr>

        				<tr>
        					<td>Dia</td>
        					<td><? echo $results[0][csf("width")];?></td>
        				</tr>

        				<tr>
        					<td>M/C Dia</td>
        					<td><? echo $machine_dia;?></td>
        				</tr>

        				<tr>
        					<td>Color</td>
        					<td><? echo $color_arr[$results[0][csf("color_id")]];?></td>
        				</tr>

        				<tr>
        					<td>Yarn Count</td>
        					<td><? echo $yarn_count_arr[$results[0][csf("yarn_count")]];?></td>
        				</tr>

        				<tr>
        					<td>Yarn Lot</td>
        					<td><? echo $results[0][csf("yarn_lot")];?></td>
        				</tr>

        				<tr>
        					<td>Spinning Mill</td>
        					<td><? echo $all_supplier;?></td>
        				</tr>

        			</table>
        		</div>
        		<div style="float: left;margin-left: 150px;">
        			<table class="rpt_table" width="100%" border="1" cellpadding="3" cellspacing="0" style="font: 12px tahoma; border-bottom: 1px solid #999; margin-bottom: 2px;">
        				<tr>
        					<td colspan="5" align="center"><h3 >Knitting Production</h3></td>
        				</tr>
        				<tr>
        					<th align="center">SL</th>
        					<th align="center">Defect Name</th>
        					<th align="center">Defect Count </th>
        					<th align="center">Found in (Inch) </th>
        					<th align="center">Penalty Point</th>
        				</tr>

        				<tr>
        					<?
        					$i=1;
							//name counts inch inch_point penalty
        					foreach ($knit_defect_array as $defect_id => $val)
        					{
        						?>
        						<tr>
        							<td align="center"><? echo $i;?></td>
        							<td align="center"><? echo $val;?></td>
        							<td align="center"><? echo $array_for_dtls_data[$data][$defect_id]['counts'];?></td>
        							<td align="center"><? echo $knit_defect_inchi_array[$array_for_dtls_data[$data][$defect_id]['inch']];?></td>
        							<td align="center"><? echo $array_for_dtls_data[$data][$defect_id]['penalty']; $total_penalty+=$array_for_dtls_data[$data][$defect_id]['penalty'];?></td>
        						</tr>

        						<?
        						$i++;
        					}
        					?>
        				</tr>

        				<tr>
        					<td align="right" colspan="4">Total Penalty Point:</td>
        					<td align="center"><? echo $total_penalty;?></td>
        				</tr>

        				<tr>
        					<td align="right" colspan="4">Total  Point:</td>
        					<td align="center"><? //echo $total_penalty;?></td>
        				</tr>

        				<tr>
        					<td align="right" colspan="4">Febric Grade:</td>
        					<td align="center"><? echo $results[0][csf("fabric_grade")];?></td>
        				</tr>

        				<tr>
        					<td align="center">Comments</td>
        					<td align="left" colspan="4"><? echo $results[0][csf("comments")];?></td>
        				</tr>

        			</table>
        		</div>
        	</div>

        	<?php
        	exit();
        }
        if ($action == 'KnittingProductionPrint_2') {
        	echo load_html_head_contents("WO Info", "../../", 1, 1, '', '', '');
			// query from receive,dtls table

        	$sqls_mst = "SELECT a.id, a.pro_dtls_id, a.roll_maintain, a.barcode_no, a.roll_id, a.roll_no, a.qc_name, a.roll_width, a.roll_weight, a.roll_length, a.reject_qnty, a.qc_date, a.total_penalty_point, a.total_point, a.fabric_grade, a.comments,b.body_part_id, b.febric_description_id, b.machine_no_id,b.machine_gg,b.machine_no_id,b.stitch_length,b.floor_id,b.operator_name,b.shift_name, b.gsm, b.width, b.color_id, b.yarn_lot, b.yarn_count,b.brand_id,b.yarn_prod_id,c.receive_date,c.knitting_source,c.buyer_id,c.knitting_company,c.location_id,c.booking_id,c.booking_no,c.receive_basis,c.booking_without_order,c.within_group,c.company_id,c.id as mst_id FROM  pro_qc_result_mst a, pro_grey_prod_entry_dtls b,inv_receive_master c where a.pro_dtls_id=b.id and a.id=$data and b.mst_id=c.id and b.status_active=1 and b.is_deleted=0";

        	$results=sql_select($sqls_mst);
        	$brandID=$results[0][csf("brand_id")];
        	$companyID=$results[0][csf("company_id")];
        	$machineID=$results[0][csf("machine_no_id")];
        	$prodFloorID=$results[0][csf("floor_id")];
        	$operator_name=$results[0][csf("operator_name")];
        	$recv_mst_id=$results[0][csf("mst_id")];
        	$yarn_prod_id=$results[0][csf("yarn_prod_id")];

        	$sql_dtls="SELECT id, mst_id, defect_name, defect_count, found_in_inch, found_in_inch_point, penalty_point from pro_qc_result_dtls
        	where mst_id=$data and form_type is null";
        	$results_dtls=sql_select($sql_dtls);
        	foreach($results_dtls as $val_dtls)
        	{
        		$array_for_dtls_data[$val_dtls[csf("mst_id")]][$val_dtls[csf("defect_name")]]['name']=$val_dtls[csf("defect_name")];
        		$array_for_dtls_data[$val_dtls[csf("mst_id")]][$val_dtls[csf("defect_name")]]['counts']=$val_dtls[csf("defect_count")];
        		$array_for_dtls_data[$val_dtls[csf("mst_id")]][$val_dtls[csf("defect_name")]]['inch']=$val_dtls[csf("found_in_inch")];
        		$array_for_dtls_data[$val_dtls[csf("mst_id")]][$val_dtls[csf("defect_name")]]['inch_point']=$val_dtls[csf("found_in_inch_point")];
        		$array_for_dtls_data[$val_dtls[csf("mst_id")]][$val_dtls[csf("defect_name")]]['penalty']=$val_dtls[csf("penalty_point")];

        	}

        	if($results[0][csf("febric_description_id")] != "")
        	{
        		$sql_deter = "select a.id, a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id =".$results[0][csf("febric_description_id")]." order by b.id asc";
				$deter_array = sql_select($sql_deter);
				foreach ($deter_array as $row)
				{
					$constructtion_arr[$row[csf('id')]] = $row[csf('construction')];
					$composition_arr[$row[csf('id')]] .= $composition[$row[csf('copmposition_id')]] . " " . $row[csf('percent')] . "% ";
				}
        	}


			//echo $data_array = sql_select("SELECT  b.body_part_id,c.pro_dtls_id ,c.id, b.febric_description_id, b.machine_no_id, b.gsm, b.width, b.color_id, b.yarn_lot, b.yarn_count FROM  pro_grey_prod_entry_dtls b,pro_qc_result_mst c WHERE b.id=c.pro_dtls_id");
        	$yarn_count_arr = return_library_array("select id,yarn_count from lib_yarn_count", 'id', 'yarn_count');
        	$color_arr = return_library_array("select id, color_name from lib_color where status_active=1 and id=".$results[0][csf("color_id")], 'id', 'color_name');
        	$company_arr = return_library_array("select id, company_name from lib_company", 'id', 'company_name');
        	$buyer_arr = return_library_array("select id, buyer_name from lib_buyer", 'id', 'buyer_name');
        	$cons_and_comp=$constructtion_arr[$results[0][csf("febric_description_id")]] . ' ' . $composition_arr[$results[0][csf("febric_description_id")]];

        	$machine_dia = return_field_value("dia_width", "lib_machine_name", "id=" . $results[0][csf("machine_no_id")], "dia_width");
			//echo "document.getElementById('txt_mc_dia').value 				= '" . $machine_dia . "';\n";

        	$supplier_arr = return_library_array("select id, short_name from  lib_supplier", "id", "short_name");
        	$supplier_arr_2 = return_library_array("select a.id,a.supplier_name from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type=20 and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id","supplier_name");
        	$location_arr=return_library_array("select id,location_name from lib_location where company_id='$companyID' and status_active =1 and is_deleted=0 order by location_name", "id","location_name");
        	$brand_arr=return_library_array("select id,brand_name from lib_brand where id='$brandID' and status_active =1 and is_deleted=0 order by brand_name", "id","brand_name");
        	$machine_arr=return_library_array("select id,machine_no from lib_machine_name where id='$machineID' and status_active =1 and is_deleted=0 order by machine_no", "id","machine_no");
        	$prod_floor_arr=return_library_array("select id,floor_name from lib_prod_floor where id='$prodFloorID' and status_active =1 and is_deleted=0 order by floor_name", "id","floor_name");
        	$operator_arr=return_library_array("select id, first_name from lib_employee where  company_id=$companyID and floor_id='$prodFloorID' and status_active=1 and is_deleted=0 order by first_name", "id","first_name");

        	$lot_arr = array_unique(explode(",", $results[0][csf("yarn_lot")]));
        	foreach ($lot_arr as $lot) {
        		$supplier_id = return_field_value("max(supplier_id) as supplier_id", "product_details_master", "item_category_id=1 and lot='$lot'", "supplier_id");
        		$all_supplier .= $supplier_arr[$supplier_id] . ",";
        	}
        	$all_supplier = chop($all_supplier, ',');
        	$yarn_type_arr=return_library_array("select id, yarn_type from product_details_master where  company_id=$companyID and id in($yarn_prod_id) and status_active=1 and is_deleted=0 order by id", "id","yarn_type");
        	?>
        	<div style="margin-top: 5px;">&nbsp;</div>
        	<div>
        		<div>
        			<table>
        				<tr>
        					<td><h2><?
        					echo $company_arr[$companyID];
        					?></h2></td>
        				</tr>
        				<tr>
        					<td>
        						<?
        						$nameArray = sql_select("select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$companyID");
        						foreach ($nameArray as $result) {
        							?>
        							Plot No: <? echo $result['plot_no']; ?>
        							Level No: <? echo $result['level_no'] ?>
        							Road No: <? echo $result['road_no']; ?>
        							Block No: <? echo $result['block_no']; ?>
        							City No: <? echo $result['city']; ?>
        							Zip Code: <? echo $result['zip_code']; ?>
        							Country: <? echo $country_arr[$result['country_id']]; ?><br>
        							Email Address: <? echo $result['email']; ?>
        							Website No: <?
        							echo $result['website'];
        						}
        						?>
        					</td>
        				</tr>
        				<tr>
        					<td><h3>Grey Fabric Inspection Report</h3></td>
        				</tr>
        			</table>
        		</div>
        		<div>
        			<?

        			$bookingID=$results[0][csf("booking_id")];
        			$bookingNO=$results[0][csf("booking_no")];
        			$barcodeNO=$results[0][csf("barcode_no")];
					//$recvID=$results[0][csf("id")];

        			if ($results[0][csf("receive_basis")]==1) {
        				if ($results[0][csf("booking_without_order")] != 1) {
        					$po_sql = sql_select("select a.job_no,b.po_number from wo_booking_dtls a,wo_po_break_down b where a.po_break_down_id=b.id and a.status_active!=0 and a.is_deleted!=1 and b.status_active=1 and b.is_deleted=0 and a.booking_no='$bookingNO' group by a.job_no,b.po_number");
        					$job_no=$po_sql[0][csf("job_no")];
        					$poNo=$po_sql[0][csf("po_number")];
        				}else{
        					$job_no=$poNo="";
        				}
        			}else if ($results[0][csf("receive_basis")] == 2) {
        				if ($db_type == 0) {
        					$po_sql = sql_select("select  group_concat(a.job_no_mst) as job_no,group_concat(a.po_number) as po_number from wo_po_break_down a,ppl_planning_entry_plan_dtls b where a.id=b.po_id and b.dtls_id=$bookingID and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  group by a.job_no_mst,a.po_number");
        				}
        				else
        				{
        					$po_sql = sql_select("select listagg(cast(a.job_no_mst as varchar(4000)),',')  within group (order by a.job_no_mst) as job_no, listagg(cast(a.po_number as varchar(4000)),',') within group (order by a.po_number) as po_number  from wo_po_break_down a,ppl_planning_entry_plan_dtls b where a.id=b.po_id and b.dtls_id=$bookingID and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  group by a.job_no_mst,a.po_number");
        				}

        				$job_no=$po_sql[0][csf("job_no")];
        				$poNo=$po_sql[0][csf("po_number")];
        			}
        			if($results[0][csf("receive_basis")]==2){
        				$sql_feeder= sql_select("select feeder,width_dia_type from ppl_planning_info_entry_dtls where id=$data  and status_active=1 and is_deleted=0");
        			}
        			$sql_qc_qnty= sql_select("select b.qnty as qc_passQnty from inv_receive_master a,pro_roll_details b where a.id=$recv_mst_id and b.barcode_no=$barcodeNO and b.entry_form=2 and a.id=b.mst_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
        			?>
        			<table  class="rpt_table" width="63%" border="1" cellpadding="3" cellspacing="0" style="font: 12px tahoma;">
        				<tr>
        					<td width="120"><b>Production Date</b></td>
        					<td width="120"><? echo $results[0][csf("receive_date")]; ?></td>
        					<td width="120"><b>Knitting Source </b></td>
        					<td width="120"><? echo $knitting_source[$results[0][csf("knitting_source")]]; ?></td>
        					<td width="100"><b>Buyer Name</b></td>
        					<td width="120"><? echo $buyer_arr[$results[0][csf("buyer_id")]]; ?></td>
        				</tr>
        				<tr>
        					<td><b>QC Date</b></td>
        					<td><? echo $results[0][csf("qc_date")];?></td>
        					<td><b>Knitting Company</b></td>
        					<td><? if($results[0][csf("knitting_source")]==1){ echo $company_arr[$results[0][csf("knitting_company")]]; }else{$supplier_arr_2[$results[0][csf("knitting_company")]]; } ?></td>
        					<td><b>Job No.</b></td>
        					<td><? echo $job_no; ?></td>
        				</tr>
        				<tr>
        					<td><b>QC By</b></td>
        					<td><? echo $results[0][csf("qc_name")];?></td>
        					<td><b>Knitting Location</b></td>
        					<td><? echo $location_arr[$results[0][csf("location_id")]]; ?></td>
        					<td><b>PO No/Sales No.</b></td>
        					<td><? echo $poNo; ?></td>
        				</tr>
        			</table>
        		</div>
        		<br/>
        		<div style="float: left;">
        			<table class="rpt_table" width="100%" border="1" cellpadding="3" cellspacing="0" style="font: 12px tahoma; border-bottom: 1px solid #999; margin-bottom: 2px;" >
        				<thead>
        					<th colspan="2">Roll & Fabric Details</th>
        				</thead>
        				<tr>
        					<td>Barcode Number</td>
        					<td><? echo $results[0][csf("barcode_no")];?></td>
        				</tr>

        				<tr>
        					<td>Roll Number</td>
        					<td><? echo $results[0][csf("roll_no")];?></td>
        				</tr>

        				<tr>
        					<td>Roll Width (inch)</td>
        					<td><? echo $results[0][csf("roll_width")];?></td>
        				</tr>

        				<tr>
        					<td>Roll Wgt. (Kg)</td>
        					<td><? echo $results[0][csf("roll_weight")];?></td>
        				</tr>
        				<tr>
        					<td>Roll Length (Yds)</td>
        					<td><? echo $results[0][csf("roll_length")];?></td>
        				</tr>

        				<tr>
        					<td>Construction & Composition</td>
        					<td><? echo $cons_and_comp;?></td>
        				</tr>
        				<tr>
        					<td>GSM</td>
        					<td><? echo $results[0][csf("gsm")];?></td>
        				</tr>

        				<tr>
        					<td>Dia</td>
        					<td><? echo $results[0][csf("width")];?></td>
        				</tr>

        				<tr>
        					<td>Color</td>
        					<td><? echo $color_arr[$results[0][csf("color_id")]];?></td>
        				</tr>
        			</table>
        			<table class="rpt_table" width="100%" border="1" cellpadding="3" cellspacing="0" style="font: 12px tahoma; border-bottom: 1px solid #999; margin-bottom: 2px;" >
        				<thead>
        					<th colspan="2">Yarn Details</th>
        				</thead>
        				<tr>
        					<td>Yarn Issue Ch. No</td>
        					<td><? echo "";?></td>
        				</tr>
        				<tr>
        					<td>Yarn Count</td>
        					<td><?
        					$yarnCoundName="";
        					$yarnCount=explode(",", $results[0][csf("yarn_count")]);
        					foreach ($yarnCount as $countID) {
        						$yarnCoundName.=$yarn_count_arr[$countID].",";
        					}
        					echo chop($yarnCoundName,",");

    ?></td>
        				</tr>
        				<tr>
        					<td>Yarn Type</td>
        					<td><?
        					$yarnTypeName="";
        					$yarn_prod_id=explode(",", $results[0][csf("yarn_prod_id")]);
        					foreach ($yarn_prod_id as $yTypeID) {
        						$yarnTypeName.=$yarn_type_arr[$yTypeID].",";
        					}
        					echo chop($yarnTypeName,",");
        					?></td>
        				</tr>
        				<tr>
        					<td>Yarn Lot</td>
        					<td><? echo $results[0][csf("yarn_lot")];?></td>
        				</tr>
        				<tr>
        					<td>Brand</td>
        					<td><? echo $brand_arr[$results[0][csf("brand_id")]];?></td>
        				</tr>
        				<tr>
        					<td>Supplier</td>
        					<td><? echo $all_supplier;?></td>
        				</tr>
        			</table>
        			<table class="rpt_table" width="100%" border="1" cellpadding="3" cellspacing="0" style="font: 12px tahoma; border-bottom: 1px solid #999; margin-bottom: 2px;" >
        				<thead>
        					<th colspan="2">Knit MC & Prod. Details</th>
        				</thead>
        				<tr>
        					<td>Machine No.</td>
        					<td><? echo $machine_arr[$results[0][csf("machine_no_id")]];?></td>
        				</tr>
        				<tr>
        					<td>M/C Dia</td>
        					<td><? echo $machine_dia;?></td>
        				</tr>
        				<tr>
        					<td>Dia Type</td>
        					<td><? echo $fabric_typee[$sql_feeder[0][csf("width_dia_type")]];?></td>
        				</tr>
        				<tr>
        					<td>MC Gauge</td>
        					<td><? echo $results[0][csf("machine_gg")];?></td>
        				</tr>
        				<tr>
        					<td>Stitch Length</td>
        					<td><? echo $results[0][csf("stitch_length")];?></td>
        				</tr>
        				<tr>
        					<td>Feeder</td>
        					<td><? echo $feeder[$sql_feeder[0][csf("feeder")]];?></td>
        				</tr>
        				<tr>
        					<td>QC Pass Qty</td>
        					<td><? echo $sql_qc_qnty[0][csf("qc_passQnty")];?></td>
        				</tr>
        				<tr>
        					<td>Reject Qty</td>
        					<td><? echo $results[0][csf("reject_qnty")];?></td>
        				</tr>
        				<tr>
        					<td>Prod. Floor</td>
        					<td><? echo  $prod_floor_arr[$results[0][csf("floor_id")]];?></td>
        				</tr>
        				<tr>
        					<td>Shift Name</td>
        					<td><? echo $shift_name[$results[0][csf("shift_name")]];?></td>
        				</tr>
        				<tr>
        					<td>Operator Name</td>
        					<td><? echo $operator_arr[$results[0][csf("operator_name")]];?></td>
        				</tr>
        			</table>

        		</div>
        		<div style="float: left;margin-left: 150px;">
        			<table class="rpt_table" width="100%" border="1" cellpadding="3" cellspacing="0" style="font: 12px tahoma; border-bottom: 1px solid #999; margin-bottom: 2px;">
        				<tr>
        					<td colspan="5" align="center"><h3 >Knitting Production</h3></td>
        				</tr>
        				<tr>
        					<th align="center">SL</th>
        					<th align="center">Defect Name</th>
        					<th align="center">Defect Count </th>
        					<th align="center">Found in (Inch) </th>
        					<th align="center">Penalty Point</th>
        				</tr>

        				<tr>
        					<?
        					$i=1;
							//name counts inch inch_point penalty
        					foreach ($knit_defect_array as $defect_id => $val)
        					{
        						?>
        						<tr>
        							<td align="center"><? echo $i;?></td>
        							<td align="center"><? echo $val;?></td>
        							<td align="center"><? echo $array_for_dtls_data[$data][$defect_id]['counts'];?></td>
        							<td align="center"><? echo $knit_defect_inchi_array[$array_for_dtls_data[$data][$defect_id]['inch']];?></td>
        							<td align="center"><? echo $array_for_dtls_data[$data][$defect_id]['penalty']; $total_penalty+=$array_for_dtls_data[$data][$defect_id]['penalty'];?></td>
        						</tr>

        						<?
        						$i++;
        					}
        					?>
        				</tr>

        				<tr>
        					<td align="right" colspan="4">Total Penalty Point:</td>
        					<td align="center"><? echo $total_penalty;?></td>
        				</tr>

        				<tr>
        					<td align="right" colspan="4">Total  Point:</td>
        					<td align="center"><? //echo $total_penalty;?></td>
        				</tr>

        				<tr>
        					<td align="right" colspan="4">Febric Grade:</td>
        					<td align="center"><? echo $results[0][csf("fabric_grade")];?></td>
        				</tr>

        				<tr>
        					<td align="center">Comments</td>
        					<td align="left" colspan="4"><? echo $results[0][csf("comments")];?></td>
        				</tr>



        			</table>
        		</div>
        	</div>
        	<?php
        	exit();
        }

if($action=="company_wise_load")
{
	$company_id = $data;
	
	 
	//location load
	$com_location_td=  create_drop_down("cbo_com_location_name", 152, "select id,location_name from lib_location where company_id='$company_id' $location_credential_cond and status_active =1 and is_deleted=0 order by location_name", "id,location_name", 1, "-- Select Location --", 0, "store_load(this.value)");
	echo "document.getElementById('com_location_td').innerHTML = '".$com_location_td."';\n";

	//machine load
	$floor_id = "";
	$machine_id = "";
	if ($floor_id == 0 || $floor_id == "") $floor_cond = ""; else $floor_cond = " and floor_id=$floor_id";
	if ($machine_id == 0 || $machine_id == "") $machine_cond = ""; else $machine_cond = " or id=$machine_id";

	$machine_td = create_drop_down("cbo_machine_name", 132, "select id, machine_no as machine_name from lib_machine_name where category_id=1 and company_id=$company_id and status_active=1 and is_deleted=0 and is_locked=0 and is_subcon =2 $floor_cond $machine_cond order by seq_no", "id,machine_name", 1, "-- Select Machine --", 0, "", "");
	echo "document.getElementById('machine_td').innerHTML = '".$machine_td."';\n";

	//roll maintain load
	$roll_maintained = '';
	$fabric_store_auto_update = '';
	$production_control = '';
	$hidden_qc_result = '';

	$varialbe_production_sql = sql_select("select variable_list, distribute_qnty, smv_source, auto_update, fabric_roll_level, item_category_id,hide_qc_result, process_costing_maintain, production_entry from variable_settings_production where company_name ='$company_id' and variable_list in(3,15,27,51,62,34,70) and is_deleted=0 and status_active=1");

	foreach ($varialbe_production_sql as $row) 
	{
		if ($row[csf('variable_list')] == 27) 
		{
			if($row[csf('smv_source')] ==2)
			{
				$barcode_generation = $row[csf('smv_source')];
			}else{
				// $barcode_generation =1;
				$barcode_generation =$row[csf('smv_source')];
			}
		}

		if ($row[csf('item_category_id')] == 13) 
		{
			if ($row[csf('variable_list')] == 3) 
			{
				$roll_maintained = $row[csf('fabric_roll_level')];
			}
			else if ($row[csf('variable_list')] == 15) 
			{
				$fabric_store_auto_update = $row[csf('auto_update')];
			}
		}

		if ($row[csf('item_category_id')] == 1) 
		{
			if ($row[csf('variable_list')] == 51) 
			{
				$production_control = $row[csf('auto_update')];
			}
		}
		if ($row[csf('variable_list')] == 62) 
		{
			$hidden_qc_result = $row[csf('hide_qc_result')];
		}

		if ($row[csf('variable_list')] == 34) 
		{
			$process_costing_maintain = $row[csf('process_costing_maintain')];
		}

		if ($row[csf('variable_list')] == 70) 
		{
			//Auto save and print generate
			$auto_barcode_generate = $row[csf('production_entry')];
		}
	}

	$variable_inventory_sql=sql_select("select store_method, rack_balance from variable_settings_inventory  where company_name=$company_id and item_category_id=13 and variable_list=21 and status_active=1 and is_deleted=0 and rack_balance=1");
	$store_method=$variable_inventory_sql[0][csf("store_method")];
	if($store_method=="") $store_method=0;

	if ($roll_maintained == 1) $roll_maintained = $roll_maintained; else $roll_maintained = 0;
	if ($fabric_store_auto_update == 2) $fabric_store_auto_update = 0; else $fabric_store_auto_update = 1;
	if ($production_control == 1) {$production_control = $production_control;} else {$production_control = 0;}
	if ($barcode_generation =="") {$barcode_generation=0;}
	if ($hidden_qc_result =="") {$hidden_qc_result=0;}
	if ($hidden_qc_result == 1) 
	{
		echo "$('#knit_defect').hide();\n";
	}
	else
	{
		echo "$('#knit_defect').show().css('width', '200px');\n";
	}
	echo "document.getElementById('roll_maintained').value 					= '" . $roll_maintained . "';\n";
	echo "document.getElementById('barcode_generation').value 				= '" . $barcode_generation . "';\n";
	echo "document.getElementById('fabric_store_auto_update').value 		= '" . $fabric_store_auto_update . "';\n";
	echo "document.getElementById('production_control').value 				= '" . $production_control . "';\n";
	echo "document.getElementById('store_update_upto').value 				= '" . $store_method . "';\n";
	echo "document.getElementById('auto_barcode_generate').value 			= '" . $auto_barcode_generate . "';\n";

	echo "reset_form('greyproductionentry_1','list_fabric_desc_container','','','set_receive_basis(0);','update_id*txt_recieved_id*cbo_company_id*cbo_receive_basis*txt_receive_date*txt_receive_chal_no*cbo_store_name*cbo_knitting_source*cbo_knitting_company*txt_remarks*roll_maintained*barcode_generation*fabric_store_auto_update*store_update_upto*production_control*auto_barcode_generate*txt_yarn_issue_challan_no*txt_shift_name*txt_width*txt_gsm*cbo_floor_id*cbo_machine_name*txt_room*txt_rack*txt_reject_fabric_recv_qnty*txt_shelf*cbo_uom*txt_binbox*txt_yarn_lot*cbo_yarn_count*txt_brand*txt_stitch_length*txt_machine_dia*txt_machine_gg*txt_color*cbo_color_range*hidden_qc_result');\n";
	
	if($company_id!=0)
	{
		$buyer_td_id = create_drop_down("cbo_buyer_name", 152, "select buy.id, buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$company_id' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buy.buyer_name", "id,buyer_name", 1, "-- Select Buyer --", $selected, "", '');
		echo "document.getElementById('buyer_td_id').innerHTML = '".$buyer_td_id."';\n";

	}else{
		$buyer_td_id = create_drop_down( "cbo_buyer_name", 152, $blank_array,"", 1, "-- Select Buyer --", 0, "",1 );
		echo "document.getElementById('buyer_td_id').innerHTML = '".$buyer_td_id."';\n";
	}

	//process costing maintain
	echo "document.getElementById('process_costing_maintain').value='" . $process_costing_maintain . "';\n";
	if ($process_costing_maintain == 1) 
	{
		echo "$('#txt_yarn_lot').attr('readonly', 'readonly');\n";
		echo "$('#txt_yarn_lot').attr('placeholder', 'Browse');\n";
		echo "$('#txt_yarn_lot').attr('onclick', 'proces_costing_popup()');\n";
	} 
	else 
	{
		echo "$('#txt_yarn_lot').removeAttr('readonly');\n";
		echo "$('#txt_yarn_lot').removeAttr('placeholder');\n";
		echo "$('#txt_yarn_lot').removeAttr('onclick');\n";
	}

	$subcontract_td_id = create_drop_down("cbo_sub_contract", 151, "select a.supplier_id ,(select c.supplier_name from lib_supplier c where c.id = a.supplier_id ) as supplier from lib_supplier_party_type a, lib_supplier_tag_company b where a.supplier_id = b.supplier_id and a.party_type = 20 and b.tag_company = '$company_id' order by supplier", "supplier_id,supplier", 1, "-- Select subcontract --", 0, "", "");

	echo "document.getElementById('subcontract_td_id').innerHTML = '".$subcontract_td_id."';\n";
}

if ($action == "print_barcode_b") {
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');

	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	//$user_arr = return_library_array("select id, user_name from user_passwd", 'id', 'user_name');
	$brand_id_arr = return_library_array("select lot, brand from product_details_master where item_category_id=1", 'lot', 'brand');
	///print_r($brand_id_arr['6112018']);die;
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');

	//N.B. Only for Knitting plan basis with Sales Order

	$sql ="SELECT a.company_id, a.recv_number, a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id, b.shift_name, b.operator_name, c.is_sales 
	 from inv_receive_master a, pro_grey_prod_entry_dtls b, pro_roll_details c
	 where a.id=b.mst_id and b.id=c.dtls_id and c.entry_form=2 and b.id=$data[1] and c.is_sales in(0,1) and a.receive_basis=2
	 group by a.company_id, a.recv_number, a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id, b.shift_name, b.operator_name, c.is_sales";


	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	foreach ($result as $row) 
	{
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		$receive_date=$row[csf('receive_date')];
		$booking_no = $row[csf('booking_no')];
		$booking_without_order = $row[csf('booking_without_order')];

		$prod_date = date("d-m-Y", strtotime($row[csf('insert_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));

		$order_id = $row[csf('order_id')];
		$is_sales = $row[csf('is_sales')];
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];
		$operator_name = $row[csf('operator_name')];
		$shift_name_id = $row[csf('shift_name')];
		$recv_number = $row[csf('recv_number')];
		$color_range_id = $row[csf('color_range_id')];

		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];

		$brand='';
		$lot_string = explode(",", $row[csf('yarn_lot')]);
		foreach ($lot_string as $val) {
			if ($val!="") $brand .= $brand_arr[$brand_id_arr[$val]] . ",";
		}
		$brand = chop($brand, ',');
		//$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}


		$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
		$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg, b.batch_no, b.tube_ref_no from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
		
		$batch_no = $planning_data[0][csf('batch_no')];
		$tube_ref_no = $planning_data[0][csf('tube_ref_no')];
		$machine_name = $machine_data[0][csf('machine_no')];
		$machine_dia_width = $planning_data[0][csf('machine_dia')];
		$machine_gauge = $planning_data[0][csf('machine_gg')];
		$row[csf("within_group")] = $planning_data[0][csf('within_group')];

		$program_no = $row[csf('booking_id')];
		$grey_dia = $planning_data[0][csf('machine_dia')];
		$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
		

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				$comp = $determination_sql[0][csf('construction')] . ", ";
				$constuction = $determination_sql[0][csf('construction')];
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);
	}

	if ($is_sales==1) 
	{
		$sales_info = sql_select("select a.job_no, a.style_ref_no, a.within_group, a.sales_booking_no, a.buyer_id, a.po_buyer from fabric_sales_order_mst a where a.id='" . $order_id . "'");
		if($sales_info[0][csf("within_group")] ==1)
		{
			$buyer_id = $sales_info[0][csf("po_buyer")];
		}else{
			$buyer_id = $sales_info[0][csf("buyer_id")];
		}
		$sales_booking_no = $sales_info[0][csf("sales_booking_no")];
		$style_ref_no = $sales_info[0][csf("style_ref_no")];
		$sales_order_str = $sales_info[0][csf("job_no")];
		$sales_order_arr = explode("-", $sales_order_str);
		$sales_order_str =  $sales_order_arr[2]."-".$sales_order_arr[3];
		$sales_order_str = "FSO: " . $sales_order_str;

		$batch_no="Batch No: ".$batch_no;
		$tube_ref_no="Tube Ref: ".$tube_ref_no;
	}
	else
	{
		if ($row[csf("receive_basis")] == 2)
		{
			$planning_booking_sql = sql_select("select a.booking_no from wo_booking_mst a,ppl_planning_entry_plan_dtls b where a.booking_no=b.booking_no and   b.dtls_id='" . $row[csf('booking_id')] . "'");
			$planning_booking_prefix=$planning_booking_sql[0][csf('booking_no')];

		}

		$po_sql = sql_select("SELECT a.job_no,a.job_no_prefix_num,a.buyer_name,b.id,b.po_number,d.booking_no ,a.style_ref_no from wo_po_details_master a, wo_po_break_down b,wo_booking_dtls c,wo_booking_mst d where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and c.booking_no=d.booking_no and d.booking_type=1 and d.is_short=2 and a.status_active=1 and b.status_active=1 and c.status_active=1 and b.id in($order_id) group by a.job_no,a.job_no_prefix_num,a.buyer_name,b.id,b.po_number,d.booking_no,a.style_ref_no");

		$buyer_id = $po_sql[0][csf("buyer_name")];
		$sales_booking_no = $po_sql[0][csf('booking_no')];
		$style_ref_no = $po_sql[0][csf('style_ref_no')];
		$sales_order_str = "Job No: " . $po_sql[0][csf('job_no')];
		$batch_no='';
		$tube_ref_no='';
	}
	

	$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $buyer_id);



	$i = 1;
	$barcode_array = array();
	$query = "SELECT a.id,a.inserted_by, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, a.coller_cuff_size from pro_roll_details a where a.id in($data[0]) and a.is_sales in(0,1)";
	$res = sql_select($query);


	//$pdf=new PDF_Code128('P','mm',array(80,65));
	$pdf=new PDF_Code128('P','mm',array(76.2,76.2));
	$pdf->AddPage();
	$pdf->SetFont('Times','',10);

	$pdf->SetAutoPageBreak(false);


	$i=2; $j=1; $k=0; $br=0; $n=0;

	foreach ($res as $row) 
	{
		$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=2; $j=1; $k=0;
		}

		$pdf->SetXY($i, $j+2);
		$pdf->Write(0, $company_short_name.", " . $sales_order_str.", M/C:" . $machine_name . " - " . $machine_dia_width . "X" . $machine_gauge);
		

		$pdf->Code128($i,$j+4,$row[csf("barcode_no")],50,8);
		$pdf->SetXY($i, $j+14);
		$pdf->Write(0, $row[csf("barcode_no")]);
		$pdf->SetXY($i, $j+18);

		$pdf->Write(0, "Dt:".change_date_format($receive_date). ",BUY:".$buyer_name);
		$pdf->SetXY($i, $j+22);

		$pdf->Write(0, "Fab:".substr($comp, 0, 45));
		$pdf->SetXY($i, $j+26);

		$dia_length_tube=trim($grey_dia);
		if($dia_length_tube!="") $dia_length_tube.="/";
		$dia_length_tube.=trim($finish_dia) ." ". trim($tube_type) . ", S/L :" . trim($stitch_length) ;

		$pdf->Write(0, "Dia:".$dia_length_tube );
		$pdf->SetXY($i, $j+30);
		 
		$pdf->Write(0, "GSM:". $gsm .", ". $yarn_count . ", ". $brand );
		$pdf->SetXY($i, $j+34);

		$pdf->Write(0, "LOT: ". $yarn_lot);
		$pdf->SetXY($i, $j+38);

		$pdf->Write(0, "WT:" . number_format($row[csf('qnty')], 2, '.', '').", Sft:". $shift_name[$shift_name_id]);
		$pdf->SetXY($i, $j+42);

		$pdf->Write(0, "Roll No:". $row[csf("roll_no")].", Clr:" .substr($color, 0, 35));
		$pdf->SetXY($i, $j+46);

		$pdf->Write(0, "Color Range:". $color_range[$color_range_id]);
		$pdf->SetXY($i, $j+50);

		$pdf->Write(0, "Style Ref:". $style_ref_no);
		$pdf->SetXY($i, $j+54);

		$pdf->Write(0,  $sales_booking_no);
		$pdf->SetXY($i, $j+58);

		$pdf->Write(0, $recv_number);
		$pdf->SetXY($i, $j+62);

		$pdf->Write(0, $batch_no);
		$pdf->SetXY($i, $j+66);

		$pdf->Write(0, $tube_ref_no);

		$k++;
		$br++;
	}


	foreach (glob("*".$userid.".pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'_'.$userid.'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}

if($action == "load_production_floor")
{
	$machine_floor_arr = return_field_value("select id, floor_id from lib_machine_name where status_active=1 and id=$data", "id", "floor_id");
	$floor_id = return_field_value("floor_id", "lib_machine_name", "id=" . $data);
	echo "document.getElementById('cbo_floor_id').value 				= '" . $floor_id . "';\n";
}

if ($action == "direct_print_barcode_3") 
{
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');


	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');
	$yarn_count_arr=return_library_array("select id,yarn_count from  lib_yarn_count where status_active=1 and is_deleted=0 order by id, yarn_count","id","yarn_count");

	$sql = "SELECT a.company_id,a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name, b.shift_name, b.body_part_id, c.po_breakdown_id, b.yarn_prod_id from inv_receive_master a, pro_grey_prod_entry_dtls b, pro_roll_details c where a.id=b.mst_id and b.id=c.dtls_id and c.entry_form=2 and c.status_active=1 and c.is_deleted=0 and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';$yarn_type_cond = '';
	//$yarn_type = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	$operator_name = '';
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		if ($row[csf('knitting_source')] == 1) {
			$party_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name_full = return_field_value("supplier_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}
		$booking_id=$row[csf("booking_id")];
		$recieve_basis=$row[csf("receive_basis")];
		$booking_no = $row[csf('booking_no')];
		$booking_without_order = $row[csf('booking_without_order')];

		$insert_time = date("H:i", strtotime($row[csf('insert_date')]));
		$prod_date = date("d-m-Y", strtotime($row[csf('receive_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));

		//$order_id = $row[csf('order_id')];
		$order_id .= $row[csf('po_breakdown_id')].",";
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];

		$operator_name = $operator_name_arr[$row[csf('operator_name')]];
		$shift_name_id = $row[csf('shift_name')];
		$body_part_id = $row[csf('body_part_id')];

		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_prod_id = $row[csf('yarn_prod_id')];
		$yarn_lot = $row[csf('yarn_lot')];
		$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = ''; 
		//$yarn_type = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
				
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg,a.booking_no from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];
			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
			$bookingNo = $planning_data[0][csf('booking_no')];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

			if ($row[csf("within_group")] == 1)
			$buyer_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name_full = return_field_value("buyer_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
	

		$comp = '';$yarn_type_cond = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
			//echo "select yarn_type from product_details_master where  id=".$row[csf('prod_id')]." ";
			//echo "select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')];
			//echo $yarn_typeId.'DD';
				$yarn_type_cond=$yarn_type[$yarn_typeId];
			if ($determination_sql[0][csf('construction')] != "") {
				$comp = $determination_sql[0][csf('construction')] . ", ";
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
				
				//$yarn_type_cond .= $yarn_type[$d_row[csf('type_id')]];
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);

		
	}
	
	// yarn Type start booking_id 
	
	if ($recieve_basis == 1) {
		if ($booking_without_order == 0) {
			$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_id=$booking_id and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by  c.yarn_type";
		} else {
			$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_no='$booking_no' and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by c.yarn_type";
		}
	} else if ($recieve_basis == 2) {
		$reqsition_sql = sql_select("select  requisition_no from ppl_yarn_requisition_entry where knit_id='$booking_id'");
		$reqsition_number = "";
		foreach ($reqsition_sql as $inf) {
			if (trim($reqsition_number) != "") {
				$reqsition_number .= ",'" . $inf[csf('requisition_no')] . "'";
			} else {
				$reqsition_number = "'" . $inf[csf('requisition_no')] . "'";
			}
		}

		$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and b.requisition_no in($reqsition_number) and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1 and b.status_active=1 and b.is_deleted=0 group by  c.yarn_type";
	}
	$sql_yarn_result = sql_select($sql_yarn);
	//echo $sql_yarn;
	$yarn_typeCond="";
	foreach ($sql_yarn_result as $row)
	{
		$yarn_typeCond.=$yarn_type[$row[csf('yarn_type')]].',';
	}
	$yarntypeCond=rtrim($yarn_typeCond,',');
	$yarn_type_cond=implode(",",array_unique(explode(",",$yarntypeCond)));

	//$yarn_prod_id=implode(",",array_filter(array_unique(explode(",",$yarn_prod_id))));



	if($yarn_prod_id)
	{
		$yarn_details =sql_select("select id, product_name_details, yarn_count_id, yarn_type, lot, brand from product_details_master where id in ($yarn_prod_id)");
		foreach($yarn_details as $yrow){
			$yarnArr[$yrow[csf("id")]]['count'] = $count_arr[$yrow[csf("yarn_count_id")]];
			$yarnArr[$yrow[csf("id")]]['type'] = $yarn_type[$yrow[csf("yarn_type")]];
			$yarnArr[$yrow[csf("id")]]['lot'] = $yrow[csf("lot")];
			$yarnArr[$yrow[csf("id")]]['brand'] = $brand_arr[$yrow[csf("brand")]];
		}
	}

	$order_id=implode(",",array_unique(explode(",",chop($order_id,","))));

	//echo $yarn_type_cond.'SS';
	//Yarn Type
	$po_array = array();
	$booking_no_prefix = '';$within_group="";
	if ($booking_without_order == 1) {
		if ($row[csf("receive_basis")] == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id, a.within_group from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $row[csf("booking_id")] . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
			$bookingNo = $sales_info[0][csf('sales_booking_no')];
			$within_group = $sales_info[0][csf('within_group')];
		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$non_internal_ref= return_field_value("grouping", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$bookingNo = $booking_no;
		}
	} else {
		$is_salesOrder = 0;
		if ($recieve_basis == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $booking_id);
		}
		if ($is_salesOrder == 1) {
			$po_sql = sql_select("select a.id, a.job_no_prefix_num,a.po_job_no as po_number,a.sales_booking_no, customer_buyer, within_group from fabric_sales_order_mst a where a.id in ($order_id) ");

			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no')]; //CRM ID: 22402
				$bookingNo = $row[csf('sales_booking_no')];
				$within_group = $row[csf('within_group')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('customer_buyer')]);
				$grouping = return_field_value("grouping", "wo_po_break_down", "job_no_mst in ('" . $row[csf('po_number')]."') and status_active=1");
				$po_array[$row[csf('id')]]['grouping'] = $grouping;
			}
		} else {
			$po_sql = sql_select("select a.job_no, a.job_no_prefix_num, b.id,b.grouping, b.po_number, a.buyer_name from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id and b.id in($order_id) group by a.job_no,a.job_no_prefix_num,b.id,b.grouping,b.po_number");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_name')]);
			}
			//$order_no = $po_array[$order_id]['no'];
		}
	}

	$body_part_type = return_field_value("body_part_type", "lib_body_part", "id=$body_part_id and body_part_type in(40,50) and status_active=1 and is_deleted=0" );
	

	$i = 1;
	$barcode_array = array();
	$query = "SELECT a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade, a.qc_pass_qnty_pcs as qnty_pcs, a.coller_cuff_size from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$res = sql_select($query);
	$pdf=new PDF_Code128('P','mm', array(65,55));
	$pdf->AddPage();
	$pdf->SetFont('Arial','',9);

	$pdf->SetAutoPageBreak(false);
	$pdf->SetRightMargin(0);

	$i=2; $j=3; $k=0; $br=0; $n=0;
	foreach ($res as $row) {
		

		$operatorName = substr($operator_name, 0, 13);

		if ($is_salesOrder == 1) {
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['job_no'];;
			$order_no = $bookingNo;
		}
		else
		{
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['job_no'];
			$order_no = $po_array[$row[csf('po_breakdown_id')]]['no']; 
		}

		

		if ($row[csf("receive_basis")] == 1 && $booking_without_order=1)
		{
			$internal_ref=$non_internal_ref;
		}
		else
		{
			if($po_array[$row[csf('po_breakdown_id')]]['grouping']!="") {
				$internal_ref=$po_array[$row[csf('po_breakdown_id')]]['grouping'];
			}
			else {
				$internal_ref="";
			}
		}

		$qnty_pcs='';$coller_cuff_size="";
		if ($body_part_type == 40 || $body_part_type == 50)
		{
			$qnty_pcs = " - Pcs= " . $row[csf('qnty_pcs')];
			$coller_cuff_size = "Size= " . $row[csf('coller_cuff_size')];
		}

		foreach ($yarn_details as $yName) 
		{
			$yarn_desc = $yarnArr[$yName[csf("id")]]['count']." ".trim($yarnArr[$yName[csf("id")]]['type'])." ".trim($yarnArr[$yName[csf("id")]]['lot'])." ".trim($yarnArr[$yName[csf("id")]]['brand']);
			$yarn_desc_arr[$yarn_desc]=$yarn_desc;
		}

		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=2; $j=3; $k=0;
		}


		$bookingNoArr=explode("-", $bookingNo);
		$bookingNos=$bookingNoArr[1]."-".$bookingNoArr[2]."-".$bookingNoArr[3];
		if($within_group ==2 && $is_salesOrder == 1)
		{
			$bookingNos=$bookingNo;
		}

		if ($operatorName != "") $operatorName = "; OP : " . $operatorName;

		$pdf->SetXY($i, $j);
		$pdf->Write(0, "" . substr($party_name,0,45) ." ".$prod_date." -". $shift_name[$shift_name_id]);
		
		$pdf->SetFont('Arial','B',10);

		$pdf->SetXY($i, $j+3.5);
		$pdf->Write(0, "" . $buyer_name ." ". $internal_ref );

		$pdf->SetFont('Arial','',8);

		$pdf->SetXY($i, $j+6.5);
		$pdf->Write(0, "J/No.:" . $poNO." F/GSM: " . $gsm);

		$pdf->SetXY($i, $j+9.5);
		$pdf->Write(0, "B/No:" . substr($bookingNos,0,25) .", Prg-".$program_no );

		$pdf->SetXY($i, $j+12.5);
		$pdf->Write(0, substr($comp,0,45) );

		$pdf->SetFont('Arial','B',10);
		$pdf->SetXY($i, $j+16);
		$pdf->Write(0, "" .substr($color, 0, 25));

		$rowIndx = 16;
		foreach ($yarn_desc_arr as $key => $yarn_desc) 
		{
			$rowIndx = $rowIndx+3;
			$pdf->SetXY($i, $j+$rowIndx);
			$pdf->Write(0, substr($yarn_desc, 0, 31));
		}

		$pdf->SetFont('Arial','',8);
		$pdf->SetXY($i, $j+$rowIndx+3);
		$pdf->Write(0, "M/C: " . $machine_name . "-" . $machine_dia_width."X".$machine_gauge . " F/Dia-" . trim($finish_dia)."; " .trim($tube_type));
		
		$pdf->SetFont('Arial','B',8);
		$pdf->SetXY($i, $j+$rowIndx+6);
		$pdf->Write(0, "R. No- " . $row[csf('roll_no')] ." W: " . number_format($row[csf('qnty')], 2, '.', ''). " Kg, " ."S/L: " . trim($stitch_length));

		$pdf->SetFont('Arial','',8);
		$pdf->SetXY($i, $j+$rowIndx+9);
		$pdf->Write(0, $coller_cuff_size."".$qnty_pcs);
		
		$pdf->SetXY($i, $j+$rowIndx+12);
		$pdf->Write(0, $row[csf("barcode_no")]);
		
		$pdf->Code128($i+1,$j+$rowIndx+15,$row[csf("barcode_no")],50,8);

		$k++;
		$br++;
	}

	foreach (glob(""."*.pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}

if ($action == "populate_data_from_po_popup_stylewise")
{
	//echo load_html_head_contents("PO Info", "../../", 1, 1, '', '', '');
	extract($_REQUEST);

	/*$data = explode("_", $data);
	$po_id = $data[0];
	$type = $data[1];*/


	//receive_basis+'**'+cbo_company_id+'**'+booking_no+'**'+dtls_id+'**'+all_po_id+'**'+roll_maintained+'**'+production_control+'**'+barcode_generation+'**'+save_data_stylewise+'**'+txt_receive_qnty+'**'+txt_receive_qnty_pcs+'**'+prev_distribution_method+'**'+cbo_body_part+'**'+txt_gsm+'**'+txt_width+'**'+fabric_desc_id+'**'+txt_deleted_id+'**'+txt_reject_fabric_recv_qnty+'**'+booking_without_order+'**'+booking_id+'**'+cbo_com_location_name+'**'+cbo_store_name+'**'+fabric_store_auto_update+'**'+store_update_upto

	$data = explode("**", $data);
	$receive_basis = $data[0];
	$cbo_company_id = $data[1];
	$booking_no = $data[2];
	$dtls_id = $data[3];
	$all_po_id = $data[4];
	$roll_maintained = $data[5];
	$production_control = $data[6];
	$barcode_generation = $data[7];
	$save_data_stylewise = $data[8];
	$txt_receive_qnty = $data[9];
	$txt_receive_qnty_pcs = $data[10];
	$prev_distribution_method = $data[11];
	$cbo_body_part = $data[12];
	$txt_gsm = $data[13];
	$txt_width = $data[14];
	$fabric_desc_id = $data[15];
	$txt_deleted_id = $data[16];
	$txt_reject_fabric_recv_qnty = $data[17];
	$booking_without_order = $data[18];
	$booking_id = $data[19];
	$cbo_com_location_name = $data[20];
	$cbo_store_name = $data[21];
	$fabric_store_auto_update = $data[22];
	$store_update_upto = $data[23];
	$api_weight = $data[24];





	//echo $booking_without_order;
	//echo "**".$type;die;

	$max_roll_weight = return_field_value("max_roll_weight", "variable_settings_production", "status_active=1 and company_name=$cbo_company_id and variable_list=49");

	if ($receive_basis == 0) {
		$booking_without_order = 0;
	}

	$is_salesOrder = 0;
	if ($receive_basis == 4)
	{
		$is_salesOrder = 1;
	}
	else if ($receive_basis == 2)
	{
		$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=$booking_id");
		if ($is_salesOrder == "")
			$is_salesOrder = 0;
	}

	if ($type == 1) {
		$dtls_id = $data[2];
		$roll_maintained = $data[3];
		$save_data = $data[4];
		$prev_distribution_method = $data[5];
		$receive_basis = $data[6];
		$txt_deleted_id = $data[7];
		$txt_reject_fabric_recv_qnty = $data[8];
		$production_control = $data[9];
		$cbo_body_part = $data[10];
		$booking_without_order = 0;

	}
	//$cbo_body_part=503;
	//echo $cbo_body_part.'ddd';
	$recv_qnty_array = array();
	if ($receive_basis == 1 || $receive_basis == 2 || $receive_basis == 4)
	{
		if ($booking_without_order == 1 && $receive_basis == 1)
		{
			if ($dtls_id == "") $dtls_id_cond = ""; else $dtls_id_cond = "and b.id<>$dtls_id";
			$recvData = sql_select("select sum(b.grey_receive_qnty) as grey_prod_qnty from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and a.booking_no='$booking_no' and a.booking_without_order=1 and b.febric_description_id='$fabric_desc_id' and b.gsm='$txt_gsm' and b.width='$txt_width' and b.body_part_id='$cbo_body_part' and a.entry_form=2 and b.is_deleted=0 and b.status_active=1 $dtls_id_cond");
			$recv_qnty = $recvData[0][csf('grey_prod_qnty')];
		}
		else
		{
			if ($dtls_id == "") $dtls_id_cond = ""; else $dtls_id_cond = "and a.dtls_id<>$dtls_id";
			/*$recvData = sql_select("select a.po_breakdown_id, sum(quantity) as grey_prod_qnty from order_wise_pro_details a, pro_grey_prod_entry_dtls b where a.dtls_id=b.id and a.prod_id=b.prod_id and b.febric_description_id='$fabric_desc_id' and b.gsm='$txt_gsm' and b.width='$txt_width' and b.body_part_id='$cbo_body_part' and a.entry_form=2 and a.is_deleted=0 and a.status_active=1 and a.is_sales=$is_salesOrder $dtls_id_cond group by a.po_breakdown_id");*/
			$recvData = sql_select("select d.job_no, sum(quantity) as grey_prod_qnty from order_wise_pro_details a, pro_grey_prod_entry_dtls b, wo_po_break_down c, wo_po_details_master d where a.dtls_id=b.id and a.prod_id=b.prod_id and a.po_breakdown_id=c.id and c.job_id=d.id and b.febric_description_id='$fabric_desc_id' and b.gsm='$txt_gsm' and b.width='$txt_width' and b.body_part_id='$cbo_body_part' and a.entry_form=2 and a.is_deleted=0 and a.status_active=1 and a.is_sales=$is_salesOrder $dtls_id_cond group by d.job_no");


			foreach ($recvData as $row)
			{
				$recv_qnty_array[$row[csf('po_breakdown_id')]] = $row[csf('grey_prod_qnty')];
			}
		}
	}

	if ($production_control == 1)
	{
		$yarn_balance_qty_arr = array();

		if ($dtls_id == "") $dtls_id_cond2 = ""; else $dtls_id_cond2 = "and dtls_id<>$dtls_id";
		if($receive_basis==2)
		{
			/*$yarn_issue_sql = sql_select("select distinct (d.id), (d.quantity) as issue_qnty,c.id as issue_id, d.po_breakdown_id from ppl_yarn_requisition_entry a, inv_transaction b, inv_issue_master c, order_wise_pro_details d where a.requisition_no= b.requisition_no and b.item_category =1 and b.transaction_type =2 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted =0 and d.status_active =1 and d.is_deleted = 0 and b.company_id = $cbo_company_id and  a.knit_id=$booking_id and b.mst_id = c.id and c.entry_form =3 and c.issue_basis in (3,8) and b.receive_basis in (3,8) and b.id=d.trans_id and d.entry_form =3 ");*/
			if($is_salesOrder == 1)
			{
				$yarn_issue_sql = sql_select("select distinct (d.id), (d.quantity) as issue_qnty,c.id as issue_id, e.job_no from ppl_yarn_requisition_entry a, inv_transaction b, inv_issue_master c, order_wise_pro_details d, fabric_sales_order_mst e where a.requisition_no= b.requisition_no and b.item_category =1 and b.transaction_type =2 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted =0 and d.status_active =1 and d.is_deleted = 0 and b.company_id = $cbo_company_id and a.knit_id=$booking_id and b.mst_id = c.id and c.entry_form =3 and c.issue_basis in (3,8) and b.receive_basis in (3,8) and b.id=d.trans_id and d.entry_form =3 and d.po_breakdown_id=e.id and d.is_sales=1");
			}
			else
			{
				$yarn_issue_sql = sql_select("select distinct (d.id), (d.quantity) as issue_qnty,c.id as issue_id, f.job_no from ppl_yarn_requisition_entry a, inv_transaction b, inv_issue_master c, order_wise_pro_details d, wo_po_break_down e, wo_po_details_master f where a.knit_id=$booking_id and a.requisition_no= b.requisition_no and b.item_category =1 and b.transaction_type =2 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted =0 and d.status_active =1 and d.is_deleted = 0 and b.company_id = $cbo_company_id and b.mst_id = c.id and c.entry_form =3 and c.issue_basis in (3,8) and b.receive_basis in (3,8) and b.id=d.trans_id and d.entry_form =3 and d.po_breakdown_id=e.id and e.job_id=f.id and d.is_sales=0");
			}
			
			

			$yarn_issue_qnty=0; $yarn_issue_return_qnty =0;
			foreach ($yarn_issue_sql as $val)
			{
				$yarn_issue_qnty_arr[$val[csf('job_no')]] += $val[csf("issue_qnty")];
				$yarn_balance_qty_arr[$val[csf('job_no')]] += $val[csf("issue_qnty")];
				$yarn_issue_id_arr[$val[csf("issue_id")]] = $val[csf("issue_id")];
			}

			$yarn_issue_id_arr =array_filter($yarn_issue_id_arr);

			if(count($yarn_issue_id_arr)>0)
			{
				$yarn_issue_ids = implode(",", $yarn_issue_id_arr);
				$all_yarn_issue_cond=""; $barCond="";
				if($db_type==2 && count($yarn_issue_id_arr)>999)
				{
					$yarn_issue_id_arr_chunk=array_chunk($yarn_issue_id_arr,999) ;
					foreach($yarn_issue_id_arr_chunk as $chunk_arr)
					{
						$chunk_arr_value=implode(",",$chunk_arr);
						$issCond.="  a.issue_id in($chunk_arr_value) or ";
					}
					$all_yarn_issue_cond.=" and (".chop($issCond,'or ').")";
				}
				else
				{
					$all_yarn_issue_cond=" and a.issue_id in($yarn_issue_ids)";
				}

				if($is_salesOrder==1)
				{
					$yarn_issue_return_sql = sql_select("SELECT d.id, d.quantity, e.job_no from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c, order_wise_pro_details d, fabric_sales_order_mst e 
					where a.id = b.mst_id and a.entry_form =  9 and a.receive_basis = 3 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_id = c.requisition_no and d.po_breakdown_id=e.id and d.is_sales=1 and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.id = d.trans_id and d.entry_form =9 and b.status_active=1 and c.status_active=1 and d.status_active=1 group by d.id, d.quantity, e.job_no
					union all
					select d.id, d.quantity, e.job_no 
					from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c, order_wise_pro_details d, fabric_sales_order_mst e
					where a.id=b.mst_id and a.entry_form =9 and a.receive_basis =8 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id 
					and a.booking_no=cast(c.requisition_no as varchar(200)) and d.po_breakdown_id=e.id and d.is_sales=1 and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.id=d.trans_id and d.entry_form =9 and b.status_active=1 and c.status_active=1 and d.status_active=1 group by d.id, d.quantity, e.job_no");
				}
				else
				{
					$yarn_issue_return_sql = sql_select("SELECT d.id, d.quantity, f.job_no 
						from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c, order_wise_pro_details d, wo_po_break_down e, wo_po_details_master f 
						where a.id = b.mst_id and a.entry_form =  9 and a.receive_basis = 3 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_id = c.requisition_no and d.po_breakdown_id=e.id and e.job_id=f.id and d.is_sales=0 and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.id = d.trans_id and d.entry_form =9 and b.status_active=1 and c.status_active=1 and d.status_active=1 group by d.id, d.quantity, f.job_no
					union all
					select d.id, d.quantity, f.job_no 
					from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c, order_wise_pro_details d, wo_po_break_down e, wo_po_details_master f
					where a.id=b.mst_id and a.entry_form =9 and a.receive_basis =8 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_no=cast(c.requisition_no as varchar(200)) and d.po_breakdown_id=e.id and e.job_id=f.id and d.is_sales=0 and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.id=d.trans_id and d.entry_form =9 and b.status_active=1 and c.status_active=1 and d.status_active=1 group by d.id, d.quantity, f.job_no ");
				}

				foreach ($yarn_issue_return_sql as $val)
				{
					$yarn_balance_qty_arr[$val[csf('job_no')]] -= $val[csf("quantity")];
					$yarn_issue_return_qnty_arr[$val[csf('job_no')]] += $val[csf("quantity")];
				}
			}

			if($is_salesOrder==1)
			{
				$prod_qnty_arr = sql_select("select c.quantity, d.job_no, b.id from inv_receive_master a, pro_grey_prod_entry_dtls b, order_wise_pro_details c ,fabric_sales_order_mst d where a.id =b.mst_id and b.id = c.dtls_id and c.po_breakdown_id=d.id and c.is_sales=1 and a.receive_basis =2 and a.entry_form =2 and c.entry_form =2 and a.booking_id =$booking_id and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted =0 and c.status_active =1 and c.is_deleted=0 and a.company_id= $cbo_company_id");
			}else{
				$prod_qnty_arr = sql_select("select c.quantity, e.job_no, b.id from inv_receive_master a, pro_grey_prod_entry_dtls b, order_wise_pro_details c ,wo_po_break_down d, wo_po_details_master e where a.id =b.mst_id and b.id = c.dtls_id and c.po_breakdown_id=d.id and d.job_id=e.id and c.is_sales=0 and a.receive_basis =2 and a.entry_form =2 and c.entry_form =2 and a.booking_id =$booking_id and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted =0 and c.status_active =1 and c.is_deleted=0 and a.company_id= $cbo_company_id");
			}

			

			$production_qnty=0;
			foreach ($prod_qnty_arr as $val)
			{
				$production_qnty += $val[csf("quantity")];
				$yarn_balance_qty_arr[$val[csf('job_no')]] -= $val[csf("quantity")];
				$this_challan_rcv[$val[csf('id')]][$val[csf('job_no')]] += $val[csf("quantity")];
				$grey_production_qnty_arr[$val[csf('job_no')]] += $val[csf("quantity")];
			}
		}
		else
		{

			if($is_salesOrder==1){
				$sqlControl = "SELECT b.job_no,
				sum(CASE WHEN a.entry_form ='3' THEN a.quantity ELSE 0 END) AS issue_qnty,
				sum(CASE WHEN a.entry_form ='9' THEN a.quantity ELSE 0 END) AS return_qnty,
				sum(CASE WHEN a.entry_form ='11' and a.trans_type=6 THEN a.quantity ELSE 0 END) AS transfer_out_qnty,
				sum(CASE WHEN a.entry_form ='11' and a.trans_type=5 THEN a.quantity ELSE 0 END) AS transfer_in_qnty,
				sum(CASE WHEN a.entry_form=2 $dtls_id_cond2 THEN a.quantity ELSE 0 END) AS knit_qnty
				from order_wise_pro_details a, fabric_sales_order_mst b 
				where a.status_active=1 and a.is_deleted=0 and a.po_breakdown_id=b.id and a.is_sales=1 group by b.job_no";
			}else{
				$sqlControl = "SELECT c.job_no,
				sum(CASE WHEN a.entry_form ='3' THEN a.quantity ELSE 0 END) AS issue_qnty,
				sum(CASE WHEN a.entry_form ='9' THEN a.quantity ELSE 0 END) AS return_qnty,
				sum(CASE WHEN a.entry_form ='11' and a.trans_type=6 THEN a.quantity ELSE 0 END) AS transfer_out_qnty,
				sum(CASE WHEN a.entry_form ='11' and a.trans_type=5 THEN a.quantity ELSE 0 END) AS transfer_in_qnty,
				sum(CASE WHEN a.entry_form=2 $dtls_id_cond2 THEN a.quantity ELSE 0 END) AS knit_qnty
				from order_wise_pro_details a, wo_po_break_down b, wo_po_details_master c 
				where a.status_active=1 and a.is_deleted=0 and a.po_breakdown_id=b.id and b.job_id=c.id and a.is_sales=0 group by c.job_no";
			}

			$dataArray = sql_select($sqlControl);

			foreach ($dataArray as $row) {
				$yarn_balance_qty_arr[$row[csf('job_no')]] = $row[csf('issue_qnty')] - $row[csf('return_qnty')] + $row[csf('transfer_in_qnty')] - $row[csf('transfer_out_qnty')] - $row[csf('knit_qnty')];


				$yarn_issue_qnty_arr[$row[csf('job_no')]] += $row[csf("issue_qnty")];
				$grey_production_qnty_arr[$row[csf('job_no')]] += $row[csf("knit_qnty")];
				$yarn_issue_return_qnty_arr[$row[csf('job_no')]] += $row[csf("return_qnty")];

				$this_challan_rcv[$dtls_id][$row[csf('job_no')]] += $row[csf("knit_qnty")];
			}
		}

		unset($dataArray);
		//print_r($yarn_balance_qty_arr);


		$over_production_percentage= return_field_value("distribute_qnty","variable_settings_production","company_name ='$cbo_company_id' and variable_list=51 and item_category_id=1 and is_deleted=0 and status_active=1");
		$over_production_percentage = $over_production_percentage*1;
	}

	if ($roll_maintained == 1) {
		$width = "1020";
	}
	else $width = "930";

	$body_part_type=return_library_array("select id, body_part_type from lib_body_part where status_active=1",'id','body_part_type');
	//echo $cbo_body_part;
	//echo $body_part_type[$cbo_body_part];die;
	if($body_part_type[$cbo_body_part] == 40 || $body_part_type[$cbo_body_part] == 50){
		$disable_td = "";
	} else {
		$disable_td = "disabled";
	}
	//echo $fabric_store_auto_update.test;die;

	$save_string="";

	if($is_salesOrder != 2)	
	{
		if ($save_data_stylewise != "" && $receive_basis == 2) //Kniting plan
		{
			echo "alert('Update data will come in this action');\n";
			die;
			if ($roll_maintained == 1)
			{
				$all_po_id = explode(",", $all_po_id);
				$explSaveData = explode(",", $save_data_stylewise);

				for ($z = 0; $z < count($explSaveData); $z++) {

					$po_wise_data = explode("**", $explSaveData[$z]);

					for ($y = 0; $y < count($po_wise_data); $y++) {

						//$order_id[$po_wise_data[0]] = $po_wise_data[0];
						$job_no_arr[$po_wise_data[0]] = $po_wise_data[0];
						$roll_id[$po_wise_data[5]] = $po_wise_data[5];
						$barcode_num[$po_wise_data[6]] = $po_wise_data[6];

					}
				}

				$job_nos = "'".implode("','",array_keys($job_no_arr))."'";
				$order_ids = implode(',',array_keys($order_id));
				$roll_ids = implode(',',array_keys($roll_id));
				$barcode_nums = rtrim(implode(',',array_keys($barcode_num)),',') ;

				if($job_nos!="")
				{
					if ($is_salesOrder == 1) 
					{
						//$po_data = sql_select("select a.id,a.job_no as po_number, sum(b.grey_qty) as po_qnty_in_pcs from fabric_sales_order_mst a, fabric_sales_order_dtls b where a.id=b.mst_id and a.id in ($order_ids) group by a.id, a.job_no");

						$po_data = sql_select("select a.id as pos, a.job_no, a.style_ref_no, sum(b.grey_qty) as po_qnty_in_pcs from fabric_sales_order_mst a, fabric_sales_order_dtls b, ppl_planning_entry_plan_dtls c where a.id=b.mst_id and b.mst_id=c.po_id and c.dtls_id=$booking_no group by a.id, a.job_no, a.style_ref_no");
						$allPoId="";
						$po_data_arr = array();
						foreach ($po_data as $row) 
						{
							$allPoId.= $row[csf('pos')].',';
							$job_data_arr[$row[csf('job_no')]]['po_qnty_in_pcs'] 		=  $row[csf('po_qnty_in_pcs')];
							$job_data_arr[$row[csf('job_no')]]['style_ref_no'] 		=  $row[csf('style_ref_no')];
							$job_data_arr[$row[csf('job_no')]]['job_no'] 		=  $row[csf('job_no')];
						}
						$allPoId=chop($allPoId,",");

						//echo "=============";die;

						$greyRecvQty = sql_select("select d.job_no, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c, fabric_sales_order_mst d where a.id=b.mst_id and b.id=c.dtls_id and a.status_active=1 and a.entry_form=2  and a.receive_basis=2  and c.entry_form=2 and a.booking_no='$booking_no' and c.po_breakdown_id in($allPoId) and c.po_breakdown_id=d.id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 group by d.job_no");

						$program_qnty_array = return_library_array("select d.job_no, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b, fabric_sales_order_mst c where a.id=b.dtls_id and b.po_id=c.id and b.dtls_id='$booking_no' and b.status_active=1 and b.is_deleted=0 group by d.job_no", "job_no", "qnty");
					} 
					else 
					{
						//$po_data = sql_select("select b.id,b.po_number, (a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs, b.pub_shipment_date, b.grouping,b.po_quantity from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_ids)");

						if($db_type == 0){
							$pos_select= "group_concat(b.id) as pos,";
						}else{
							$pos_select= "listagg(cast(b.id as varchar(4000)) ,',' ) within group (order by b.id) as pos,";
						}
						$po_data = sql_select("select $pos_select a.job_no, a.style_ref_no, sum(a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs from wo_po_details_master a, wo_po_break_down b, ppl_planning_entry_plan_dtls c where a.id=b.job_id and b.id=c.po_id and c.dtls_id=$booking_no and a.job_no in ($job_nos) group by a.job_no, a.style_ref_no");

						$allPoId="";
						$po_data_arr = array();
						foreach ($po_data as $row) 
						{
							$allPoId.= $row[csf('pos')].',';
							$job_data_arr[$row[csf('job_no')]]['po_qnty_in_pcs'] 		=  $row[csf('po_qnty_in_pcs')];
							$job_data_arr[$row[csf('job_no')]]['style_ref_no'] 		=  $row[csf('style_ref_no')];
							$job_data_arr[$row[csf('job_no')]]['job_no'] 		=  $row[csf('job_no')];
						}
						$allPoId=chop($allPoId,",");

						$greyRecvQty = sql_select("select e.job_no, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c, wo_po_break_down d, wo_po_details_master e where a.id=b.mst_id and b.id=c.dtls_id and c.po_breakdown_id=d.id and d.job_id=e.id and a.status_active=1 and a.entry_form=2 and a.receive_basis=2 and c.entry_form=2 and a.booking_no='$booking_no' and c.po_breakdown_id in($allPoId) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 group by e.job_no");
						$program_qnty_array = return_library_array("select d.job_no, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b, wo_po_break_down c, wo_po_details_master d where a.id=b.dtls_id and b.po_id=c.id and c.job_id=d.id and b.dtls_id='$booking_no' and b.status_active=1 and b.is_deleted=0 group by d.job_no", "job_no", "qnty");
					}
				}

				/*$greyRecvQty =sql_select("select po_breakdown_id,sum(quantity) as prod_quantity from order_wise_pro_details where po_breakdown_id in($allPoId) and entry_form=2 and status_active=1 and is_deleted=0 group by po_breakdown_id");*/

				foreach ($greyRecvQty as $row) {
					$grey_receive_qnty_arr[$row[csf("job_no")]]["prod_quantity"] = $row[csf("recv_qnty")];
				}

				if($roll_ids!="")
				{
					$sqlroll = sql_select("select barcode_no,roll_used from pro_roll_details where status_active=1 and is_deleted=0 and id in($roll_ids)");
					foreach ($sqlroll as $row) {
						$rollData[$row[csf("barcode_no")]]['roll_used'] = $row[csf("roll_used")];
					}
				}

				if($barcode_nums!="")
				{
					$qcRollSql = sql_select("SELECT barcode_no from PRO_QC_RESULT_MST where status_active=1 and is_deleted=0 and barcode_no in($barcode_nums)");
					$qcRollData=array();
					foreach ($qcRollSql as $row) 
					{
						$qcRollData[$row[csf("barcode_no")]] = $row[csf("barcode_no")];
					}
				}
				
				//echo count($explSaveData)."===";die;
			   	for ($z = 0; $z < count($explSaveData); $z++)
			   	{
					if ($i % 2 == 0)
						$bgcolor = "#E9F3FF";
					else
						$bgcolor = "#FFFFFF";

					$job_wise_data = explode("**", $explSaveData[$z]);
					//$order_id = $po_wise_data[0];
					$job_no = $job_wise_data[0];
					$grey_qnty = $job_wise_data[1];
					$reject_qnty = $job_wise_data[2];
					$roll_no = $job_wise_data[3];
					$roll_not_delete_id = $job_wise_data[4];
					$roll_id = $job_wise_data[5];
					$barcode_no = $job_wise_data[6];
					$grey_qnty_pcs = $job_wise_data[7];
					$size_qty = $job_wise_data[8];
					$rft_id = $job_wise_data[9];
					$r_floor_id = $job_wise_data[10];
					$r_room_id = $job_wise_data[11];
					$r_rack_id = $job_wise_data[12];
					$r_self_id = $job_wise_data[12];

					$req_qnty = $program_qnty_array[$job_no];
					$bl_qnty = $req_qnty - $recv_qnty_array[$job_no];

					//echo $req_qnty."=".$recv_qnty_array[$order_id]."<br>";

					$roll_used = $rollData[$barcode_no]['roll_used'];
					$qc_barcode_no = $qcRollData[$barcode_no];

					if (!(in_array($job_no, $job_no_array))) {
						if ($roll_not_delete_id == 0) $tot_po_qnty += $job_wise_data[$job_no]['po_qnty_in_pcs'];
						$orginal_val = 1;
						$job_no_array[] = $job_no;
					} else {
						if ($roll_used == 1) $orginal_val = 1; else $orginal_val = 0;
					}

					if ($roll_used == 1) {
						$disable = "disabled='disabled'";
						$roll_not_delete_id = $roll_not_delete_id;
					} else {
						$disable = "";
						$roll_not_delete_id = 0;
					}

					$tot_grey_qnty += $grey_qnty;
					$tot_grey_qnty_pcs += $grey_qnty_pcs;
					$tot_reject_qnty += $reject_qnty;

					$prev_own_rcv = $this_challan_rcv[$dtls_id][$job_no];
					//$balanceQty = number_format($yarn_balance_qty_arr[$order_id]+$prev_own_rcv,2,".","");

					$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$job_no],2,".","");
					$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
					$yarn_over_balance =$yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$job_no] - $grey_production_qnty_arr[$job_no] + $prev_own_rcv;

					$balanceQty = number_format($yarn_over_balance,2,".","");

					if($production_control == 1)
					{
						$balanceQty = $balanceQty;
					}else{
						$balanceQty = $bl_qnty;
					}

					?>
					<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
						<td width="110">
							<p><? echo $job_no//$po_data_arr[$order_id]['po_number']; ?></p>
							<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $job_no; ?>">
							<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
							<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
							<!--This is used for not delete row which is used in batch -->
							<input type="hidden" name="txtQcBarcode[]" id="txtQcBarcode_<? echo $i; ?>" value="<? echo $qc_barcode_no; ?>">
							<input type="hidden" name="preQCPassQty[]" id="preQCPassQty_<? echo $i; ?>" value="<? echo $grey_qnty; ?>"><!-- after qc roll qty not change -->
							
							<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
							<!--This is used for Duplication Check -->
							<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
						</td>
						<td width="60"><p><? echo $job_data_arr[$job_no]['style_ref_no'] ; ?>&nbsp;</p>
						</td>
						<td width="80" align="right">
							<? echo $job_data_arr[$job_no]['po_qnty_in_pcs']; ?>
							<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $job_data_arr[$job_no]['po_qnty_in_pcs']; ?>">
						</td>

						<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?> </td>
						<td width="80" align="right"><input type="text" name="txtGreyQntyCumulative[]" id="txtGreyQntyCumulative_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px;" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> disabled></td>
						<td width="80" align="right"><? echo number_format(($balanceQty-$grey_qnty),2,".","");//echo number_format($req_qnty-$grey_receive_qnty_arr[$row[csf("po_id")]]["prod_quantity"], 2, '.', ''); ?></td>
						
						<td align="center" width="80">
							<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" <? echo $disable; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
						</td>

						<td align="center" width="80">
							<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?> placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
						</td>
						<td align="center" width="60">
							<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? echo $size_qty; ?>" <? echo $disable_td; ?> placeholder="B/W" onDblClick="func_onDblClick_finishSize(<? echo $i; ?>);" />
						</td>
						<td width="80" align="center">
							<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>" <? echo $disable; ?> onKeyUp="calculate_tot_qnty();">
						</td>
						<td align="center" width="60">
						<input type="text" name="txtRoll[]" id="txtRoll_<? echo $i; ?>" class="text_boxes_numeric" style="width:50px" value="<? if ($roll_no != 0) echo $roll_no; ?>" <? echo $disable; ?> placeholder="<? //echo $roll_arr[$order_id]+1; ?>" onBlur="roll_duplication_check(<? echo $i; ?>);" readonly/>
					   </td>
					   <td width="70">
						<input type="text" name="txtBarcodeNo[]" id="txtBarcodeNo_<? echo $i; ?>" class="text_boxes_numeric" style="width:55px" value="<? echo $barcode_no; ?>" disabled/>
					   </td>
					   <td width="70">
						<input type="text" name="txtRFId[]" id="txtRFId_<? echo $i; ?>" class="text_boxes" style="width:55px" value="<? echo $rft_id; ?>" />
					   </td>
					   <td width="65">
						<input type="button" id="increase_<? echo $i; ?>" name="increase[]" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr( <? echo $i; ?> )"/>
						<input type="button" id="decrease_<? echo $i; ?>" name="decrease[]" style="width:30px" class="formbutton" value="-" onClick="fn_deleteRow(<? echo $i; ?>);"/>
					   </td>
				   	</tr>
				   <?
				   $i++;
			   	}
			}
			else
			{
				$program_qnty_array = return_library_array("select b.po_id, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b where a.id=b.dtls_id and b.dtls_id='$booking_no' and b.determination_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and b.status_active=1 and b.is_deleted=0 group by b.po_id", "po_id", "qnty");

				$prev_po_qnty_arr = array();
				$prev_po_qnty_pcs_arr = array();
				$prev_reject_qnty_arr = array();
				$explSaveData = explode(",", $save_data);
				for ($z = 0; $z < count($explSaveData); $z++) 
				{
					$po_wise_data = explode("**", $explSaveData[$z]);
					/*echo "<pre>";
					print_r($po_wise_data);*/
					$order_id = $po_wise_data[0];
					$grey_qnty = $po_wise_data[1];
					$grey_qnty_pcs = $po_wise_data[7];
					$reject_qnty = $po_wise_data[2];
					$size = $po_wise_data[8];
					$prev_po_qnty_arr[$order_id] = $grey_qnty;
					$prev_po_qnty_pcs_arr[$order_id] = $grey_qnty_pcs;
					$prev_reject_qnty_arr[$order_id] = $reject_qnty;
					$prev_size_arr[$order_id] = $size;
				}

				$i = 1;
				$orginal_val = 1;
				$roll_id = 0;
				$roll_not_delete_id = 0;

				if ($is_salesOrder == 1) {
					$po_data = sql_select("select a.id, a.job_no as po_number, sum(b.grey_qty) as po_quantity, 1 as total_set_qnty from fabric_sales_order_mst a, fabric_sales_order_dtls b, ppl_planning_entry_plan_dtls c where a.id=b.mst_id and b.mst_id=c.po_id and c.dtls_id=$booking_no group by a.id, a.job_no");
				} else {
					$po_data = sql_select("select b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping from wo_po_details_master a, wo_po_break_down b, ppl_planning_entry_plan_dtls c where a.job_no=b.job_no_mst and b.id=c.po_id and c.dtls_id=$booking_no group by b.id, b.po_number, a.total_set_qnty, b.po_quantity, b.pub_shipment_date, b.grouping order by b.pub_shipment_date, b.id");
				}

				$allPoId="";
				foreach ($po_data as $row) {
					$allPoId.= "'".$row[csf('id')]."'".',';
				}
				$allPoId=chop($allPoId,",");

				if($dtls_id) $dtls_id_cond = " and b.id<>$dtls_id";
				$program_recv_qnty_array = return_library_array("select c.po_breakdown_id, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c where a.id=b.mst_id and b.id=c.dtls_id and a.status_active=1 and a.entry_form=2  and a.receive_basis=2  and c.entry_form=2 and a.booking_no='$booking_no' and b.febric_description_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and  c.po_breakdown_id in($allPoId) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 $dtls_id_cond group by c.po_breakdown_id", "po_breakdown_id", "recv_qnty");

				foreach ($po_data as $row) {
					$po_qnty_in_pcs = $row[csf('po_quantity')] * $row[csf('total_set_qnty')];
					$tot_po_qnty += $po_qnty_in_pcs;
					$req_qnty = $program_qnty_array[$row[csf('id')]];
					//$bl_qnty = $req_qnty - $recv_qnty_array[$row[csf('id')]];

					$grey_qnty = $prev_po_qnty_arr[$row[csf('id')]];
					$grey_qnty_pcs = $prev_po_qnty_pcs_arr[$row[csf('id')]];
					$grey_size = $prev_size_arr[$row[csf('id')]];
					$tot_grey_qnty += $grey_qnty;
					$tot_grey_qnty_pcs += $grey_qnty_pcs;
					$reject_qnty = $prev_reject_qnty_arr[$row[csf('id')]];
					$tot_reject_qnty += $reject_qnty;
					$prev_own_rcv = $this_challan_rcv[$dtls_id][$row[csf('id')]];

					$production_balance = $req_qnty - $program_recv_qnty_array[$row[csf('id')]];
					$req_qnty_with_over_perc = ($req_qnty*$over_production_percentage)/100 + $req_qnty;
					$production_over_balance = $req_qnty_with_over_perc - $program_recv_qnty_array[$row[csf('id')]];

					$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$row[csf('id')]],2,".","");
					$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
					$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$row[csf('id')]] - $grey_production_qnty_arr[$row[csf('id')]] + $prev_own_rcv;
					$balanceQty = number_format($yarn_over_balance,2,".","");


					if ($i % 2 == 0)
						$bgcolor = "#E9F3FF";
					else
						$bgcolor = "#FFFFFF";
					?>
					<tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>">
						<td width="110">
							<p><? echo $row[csf('po_number')]; ?></p>
							<input type="hidden" name="txtPoId[]" id="txtPoId_<? echo $i; ?>" value="<? echo $row[csf('id')]; ?>">
							<input type="hidden" name="txtOrginal[]" id="txtOrginal_<? echo $i; ?>" value="<? echo $orginal_val; ?>">
							<input type="hidden" name="txtRollId[]" id="txtRollId_<? echo $i; ?>" value="<? echo $roll_not_delete_id; ?>">
							<!--This is used for not delete row which is used in batch -->
							<input type="hidden" name="txtRollTableId[]" id="txtRollTableId_<? echo $i; ?>" value="<? echo $roll_id; ?>">
							<!--This is used for Duplication Check -->
							<input type="hidden" name="balanceQty[]" id="balanceQty_<? echo $i; ?>" value="<? echo $balanceQty; ?>">
						</td>
						<td width="60"><p><? echo $row[csf('grouping')]; ?>&nbsp;</p></td>
						<td width="80" align="right">
							<? echo $po_qnty_in_pcs; ?>
							<input type="hidden" name="txtPoQnty[]" id="txtPoQnty_<? echo $i; ?>" value="<? echo $po_qnty_in_pcs; ?>">
						</td>
						<td width="70" align="center"><? if ($is_salesOrder != 1) echo change_date_format($row[csf('pub_shipment_date')]); ?> &nbsp;</td>
						<td width="80" align="right"><? echo number_format($req_qnty, 2, '.', ''); ?></td>

						<td width="80" align="right"><input type="text" name="txtGreyQntyCumulative[]" id="txtGreyQntyCumulative_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px;" value="<? echo $program_recv_qnty_array[$row[csf('id')]]; ?>" <? echo $disable; ?> disabled></td>

						<td width="80" align="right" title="with over production %  balance: <? echo $production_over_balance ?> and Yarn balance: <? echo $yarn_over_balance;?>"><? echo number_format($production_balance,2,".",""); ?></td>
						<td align="center" width="80">
							<input type="text" name="txtGreyQnty[]" id="txtGreyQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty; ?>" placeholder="<? if ($roll_maintained == 0) echo number_format($production_balance, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();fn_check_max_roll_weight('txtGreyQnty_<? echo $i; ?>');">
						</td>
						<td align="center" width="80">
							<input type="text" name="txtGreyQntyPcs[]" id="txtGreyQntyPcs_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $grey_qnty_pcs; ?>" placeholder="<? if ($roll_maintained == 0) echo number_format($bl_qnty_pcs, 2, '.', ''); ?>" onKeyUp="fn_check_balance(<? echo $i; ?>);calculate_tot_qnty();">
						</td>
						<td align="center" width="60">
							<input type="text" name="txtCollerCuffSize[]" id="txtCollerCuffSize_<? echo $i; ?>" class="text_boxes" style="width:50px" value="<? echo $grey_size;//echo $grey_qnty_pcs; ?>" <? echo $disable_td; ?>>
						</td>
						<td width="80" align="center">
							<input type="text" name="txtRejectQnty[]" id="txtRejectQnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $reject_qnty; ?>" onKeyUp="calculate_tot_qnty();">
						</td>
					</tr>
					<?
					$i++;
				}
			}
		}
		else if ($save_data_stylewise == "" && $receive_basis == 2) //Kniting plan un-save data
		{
			$i = 1;
			$orginal_val = 1;
			$roll_id = 0;
			$roll_not_delete_id = 0;
			$disable = "";
			if ($is_salesOrder == 1) 
			{

				$po_data = sql_select("select a.id as pos, a.job_no, a.style_ref_no, sum(b.grey_qty) as po_qnty_in_pcs from fabric_sales_order_mst a, fabric_sales_order_dtls b, ppl_planning_entry_plan_dtls c where a.id=b.mst_id and b.mst_id=c.po_id and c.dtls_id=$booking_no group by a.id, a.job_no, a.style_ref_no");

				$program_qnty_array = return_library_array("select c.job_no, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b, fabric_sales_order_mst c where a.id=b.dtls_id and b.dtls_id='$booking_no' and b.determination_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and b.status_active=1 and b.is_deleted=0 and b.po_id=c.id group by c.job_no", "job_no", "qnty");
				$allPoId="";
				foreach ($po_data as $row) {
					$allPoId.= "'".$row[csf('pos')]."'".',';
				}
				$allPoId=chop($allPoId,",");
				$program_recv_qnty_array = return_library_array("  select d.job_no, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c, fabric_sales_order_mst d where a.id=b.mst_id and b.id=c.dtls_id and a.status_active=1 and a.entry_form=2  and a.receive_basis=2  and c.entry_form=2 and a.booking_no='$booking_no' and b.febric_description_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and  c.po_breakdown_id in($allPoId) and c.po_breakdown_id=d.id and b.status_active=1 and b.is_deleted=0 and c.status_active=1 group by d.job_no", "job_no", "recv_qnty");
			} 
			else 
			{

				if($db_type == 0){
					$pos_select= "group_concat(b.id) as pos,";
				}else{
					$pos_select= "listagg(cast(b.id as varchar(4000)) ,',' ) within group (order by b.id) as pos,";
				}
				$po_data = sql_select("select $pos_select a.job_no, a.style_ref_no, sum(a.total_set_qnty*b.po_quantity) as po_qnty_in_pcs from wo_po_details_master a, wo_po_break_down b, ppl_planning_entry_plan_dtls c where a.id=b.job_id and b.id=c.po_id and c.dtls_id=$booking_no group by a.job_no, a.style_ref_no");

				$program_qnty_array = return_library_array("select d.job_no, sum(b.program_qnty) as qnty from ppl_planning_info_entry_dtls a, ppl_planning_entry_plan_dtls b, wo_po_break_down c, wo_po_details_master d where a.id=b.dtls_id and b.dtls_id='$booking_no' and b.determination_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and b.status_active=1 and b.is_deleted=0 and b.po_id=c.id and c.job_id=d.id group by d.job_no", "job_no", "qnty");

				$allPoId="";
				foreach ($po_data as $row) {
					$allPoId.= "'".$row[csf('pos')]."'".',';
				}
				$allPoId=chop($allPoId,",");

				$program_recv_qnty_array = return_library_array("select e.job_no, sum( c.quantity) as recv_qnty from inv_receive_master a,pro_grey_prod_entry_dtls b,order_wise_pro_details c, wo_po_break_down d, wo_po_details_master e where a.id=b.mst_id and b.id=c.dtls_id and c.po_breakdown_id=d.id and d.job_id=e.id and a.status_active=1 and a.entry_form=2 and a.receive_basis=2 and c.entry_form=2 and a.booking_no='$booking_no' and b.febric_description_id='$fabric_desc_id' and b.body_part_id='$cbo_body_part' and c.po_breakdown_id in($allPoId) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 group by e.job_no", "job_no", "recv_qnty");
			}
			
			foreach ($po_data as $row)
			{//echo $row[csf('job_no')];die;
				$po_qnty_in_pcs =  $row[csf('po_qnty_in_pcs')];//  $row[csf('po_quantity')] * $row[csf('total_set_qnty')];
				$tot_po_qnty += $po_qnty_in_pcs;

				//===================
				
				//echo $row[csf('id')];
				$req_qnty = $program_qnty_array[$row[csf('job_no')]];
				$bl_qnty = $req_qnty - $recv_qnty_array[$row[csf('job_no')]];
				
				//$grey_qnty = $prev_po_qnty_arr[$row[csf('id')]];

				$production_balance =$req_qnty-$program_recv_qnty_array[$row[csf('job_no')]];

				$req_qnty_with_over_perc = ($req_qnty*$over_production_percentage)/100 + $req_qnty;
				$production_over_balance = $req_qnty_with_over_perc - $recv_qnty_array[$row[csf('job_no')]];
				
				//------------------------------------------------------


				$yarn_issue_quantity = number_format($yarn_issue_qnty_arr[$row[csf('job_no')]],2,".","");
				$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
				$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr[$row[csf('job_no')]] - $grey_production_qnty_arr[$row[csf('job_no')]];
				//echo $row[csf('job_no')]."=".$yarn_issue_quantity."=".$yarn_issue_with_over_perc."=".$yarn_issue_return_qnty_arr[$row[csf('job_no')]]."=".$grey_production_qnty_arr[$row[csf('job_no')]];
				$balanceQty = number_format($yarn_over_balance,2,".","");
				//$yarn_over_balance = ($balanceQty*$over_production_percentage)/100 + $balanceQty;


				//$save_string = txtPoId + "**" + txtGreyQnty + "**" + txtRejectQnty + "**" + txtRoll + "**" + txtRollId + "**" + txtRollTableId + "**" + txtBarcodeNo + "**" + txtGreyQnty_pcs+ "**" + txtSizeQty + "**" + txtRFId;

				if ($roll_maintained == 1){
					$roll_no=$roll_no;
				}else{
					$roll_no=0;
				}

				if ($save_string == "") 
				{
					$save_string = $row[csf('job_no')] . "**" . $api_weight . "**" . $txtRejectQnty . "**" . $roll_no . "**" . $roll_not_delete_id . "**" . $roll_id . "**" . $txtBarcodeNo . "**" . $txtGreyQnty_pcs . "**" . $txtSizeQty . "**" . $txtRFId;
				}
				else {
					$save_string .= "," . $row[csf('job_no')] . "**" . $api_weight . "**" . $txtRejectQnty . "**" . $roll_no . "**" . $roll_not_delete_id . "**" . $roll_id . "**" . $txtBarcodeNo . "**" . $txtGreyQnty_pcs . "**" . $txtSizeQty . "**" . $txtRFId;
				}

				$all_po_id = $row[csf('job_no')];
			}
		}
	}
	else
	{
		if ($receive_basis == 2)
		{
			$disabled = "";
			$disabled_dropdown = 0;
			if ($receive_basis == 0 || $roll_maintained == 1)
			{
				$prev_distribution_method = 2;
				$disabled = "disabled='disabled'";
				$disabled_dropdown = 1;
			
			}
			//for yarn issue check
			if ($production_control == 1)
			{
				$yarn_balance_qty_arr = array();
				if ($dtls_id == "")
					$dtls_id_cond2 = "";
				else
					$dtls_id_cond2 = "and dtls_id<>$dtls_id";

				/*
				|--------------------------------------------------------------------------
				| for yarn issue
				|--------------------------------------------------------------------------
				|
				*/
				$yarn_issue_sql = sql_select("select (b.cons_quantity) as issue_qnty, c.id as issue_id 
				from ppl_yarn_requisition_entry a, inv_transaction b, inv_issue_master c 
				where a.requisition_no= b.requisition_no and b.item_category =1 and b.transaction_type =2 and a.status_active =1 and a.is_deleted =0 and b.status_active =1 and b.is_deleted =0 and b.company_id = $cbo_company_id and  a.knit_id=$booking_id and b.mst_id = c.id and c.entry_form =3 and c.issue_basis in (3,8) and b.receive_basis in (3,8)");
				$yarn_issue_qnty=0;
				$yarn_issue_return_qnty =0;
				foreach ($yarn_issue_sql as $val)
				{
					$yarn_issue_qnty_arr += $val[csf("issue_qnty")];
					//$yarn_balance_qty_arr += $val[csf("issue_qnty")];
					$yarn_issue_id_arr[$val[csf("issue_id")]] = $val[csf("issue_id")];
				}
		
				if($yarn_issue_id_arr>0)
				{
					$yarn_issue_ids = implode(",", $yarn_issue_id_arr);
					$all_yarn_issue_cond="";
					$barCond="";
					if($db_type==2 && count($yarn_issue_id_arr)>999)
					{
						$yarn_issue_id_arr_chunk=array_chunk($yarn_issue_id_arr,999) ;
						foreach($yarn_issue_id_arr_chunk as $chunk_arr)
						{
							$chunk_arr_value=implode(",",$chunk_arr);
							$issCond.="  a.issue_id in($chunk_arr_value) or ";
						}
						$all_yarn_issue_cond.=" and (".chop($issCond,'or ').")";
					}
					else
					{
						$all_yarn_issue_cond=" and a.issue_id in($yarn_issue_ids)";
					}
		
					/*
					|--------------------------------------------------------------------------
					| for yarn issue return
					|--------------------------------------------------------------------------
					|
					*/
					$yarn_issue_return_sql = sql_select("select b.cons_quantity as quantity
					from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c 
					where a.id = b.mst_id and a.entry_form =  9 and a.receive_basis = 3 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_id = c.requisition_no and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.status_active=1 and c.status_active=1
					union all
					select b.cons_quantity as quantity 
					from inv_receive_master a, inv_transaction b, ppl_yarn_requisition_entry c 
					where a.id=b.mst_id and a.entry_form =9 and a.receive_basis =8 and b.transaction_type =4 and b.item_category =1 and c.knit_id =$booking_id and a.booking_no=c.requisition_no and a.company_id= $cbo_company_id $all_yarn_issue_cond and b.status_active=1 and c.status_active=1");
		
					foreach ($yarn_issue_return_sql as $val)
					{
						//$yarn_balance_qty_arr -= $val[csf("quantity")];
						$yarn_issue_return_qnty_arr += $val[csf("quantity")];
					}
				}
			}

            $i = 0;
            $tot_po_qnty = 0;
            $tot_grey_qnty = 0;
            $tot_grey_qnty_pcs = 0;
            $tot_reject_qnty = 0;
            $po_array = array();
            
            $orginal_val = 1;
            $roll_id = 0;
            $roll_not_delete_id = 0;
            $disable = "";

            /*
			|--------------------------------------------------------------------------
			| for program qty
			|--------------------------------------------------------------------------
			|
			*/
			$programSql = "
                SELECT
                    b.dtls_id as program_id, sum(b.program_qnty) as qnty, c.id as booking_id 
                FROM
                    ppl_planning_info_entry_dtls a,
                    ppl_planning_entry_plan_dtls b,
					wo_non_ord_samp_booking_mst c
					
                WHERE
                    a.id=b.dtls_id
					AND b.booking_no=c.booking_no 
                    AND b.dtls_id='".$booking_no."' 
                    AND b.determination_id='".$fabric_desc_id."' 
                    AND b.body_part_id='".$cbo_body_part."' 
                    AND b.status_active=1 
                    AND b.is_deleted=0
                GROUP BY
                    b.dtls_id, c.id
            ";
            // and b.gsm_weight='$txt_gsm' and a.fabric_dia='$txt_width'
            //echo $programSql;
			$programArr = sql_select($programSql);
            //echo "<pre>";
            //print_r($programArr);
            
            $programIdArr = array();
			$sampleBookingId = 0;
            foreach ($programArr as $row)
            {
                $sampleBookingId = $row[csf('booking_id')];
				$programIdArr[$row[csf('program_id')]] = $row[csf('program_id')];
            }
            $programIdString = implode(",", $programIdArr);
            //echo $programIdString;
            
            /*
			|--------------------------------------------------------------------------
			| for production qty
			|--------------------------------------------------------------------------
			|
			*/
			$productionQtyArr = array();
            if($programIdString != '')
            {									
                if($dtls_id!="")
                    $dtls_id_cond = " AND a.id <> ".$dtls_id."";
                    
                $productionSql ="
                    SELECT
                        b.booking_id AS program_id, SUM(a.grey_receive_qnty) AS prod_quantity 
                    FROM
                        pro_grey_prod_entry_dtls a,
                        inv_receive_master b 
                    WHERE
                        a.mst_id = b.id 
                        AND b.entry_form = 2 
                        AND b.booking_id IN (".$programIdString.") 
                        AND a.febric_description_id = '".$fabric_desc_id."' 
                        AND a.body_part_id='".$cbo_body_part."' 
                        AND a.gsm='".$txt_gsm."' 
                        AND a.status_active=1 
                        AND b.status_active=1 
                        ".$dtls_id_cond." 
                    GROUP BY
                        b.booking_id
                ";
                //echo $productionSql;
                $productionSqlArr =sql_select($productionSql);
                foreach ($productionSqlArr as $row)
                {
                    $productionQtyArr[$row[csf('program_id')]]['prod_quantity']=$row[csf('prod_quantity')];
                }
            }
            
            $programQty = $programArr[0][csf('qnty')];
            $productionQty = 0;
            if(!empty($productionQtyArr))
            {
                $productionQty = $productionQtyArr[$programArr[0][csf('program_id')]]['prod_quantity'];
            }
            //$productionBalance = $programQty - $productionQty;
			
			$req_qnty_with_over_perc = ($programQty*$over_production_percentage)/100 + $programQty;
			$production_over_balance = $req_qnty_with_over_perc - $productionQty;
			$yarn_issue_quantity = number_format($yarn_issue_qnty_arr,2,".","");
			$yarn_issue_with_over_perc = ($yarn_issue_quantity*$over_production_percentage)/100 + $yarn_issue_quantity;
			$yarn_over_balance = $yarn_issue_with_over_perc - $yarn_issue_return_qnty_arr*1 - $productionQty;
			$productionBalance = number_format($yarn_over_balance,2,".","");
			
            if($save_data_stylewise == "")
            {
                if ($production_control == 1)
				{
					if ($api_weight > $productionBalance*1) {
						echo "alert('QC Pass Qty. Exceeds Yarn Issued Qty.');";
						die;
					}
				}

				if ($roll_maintained == 0){
					$roll_no=0;
				}else{
					$roll_no=$roll_no;
				}

				if ($save_string == "") 
				{
					$save_string = $sampleBookingId . "**" . $api_weight . "**" . $txtRejectQnty . "**" . $roll_no . "**" . $roll_not_delete_id . "**" . $roll_id . "**" . $txtBarcodeNo . "**" . $txtGreyQnty_pcs . "**" . $txtSizeQty . "**" . $txtRFId;
				}
				else {
					$save_string .= "," . $sampleBookingId . "**" . $api_weight . "**" . $txtRejectQnty . "**" . $roll_no . "**" . $roll_not_delete_id . "**" . $roll_id . "**" . $txtBarcodeNo . "**" . $txtGreyQnty_pcs . "**" . $txtSizeQty . "**" . $txtRFId;
				}

				$all_po_id = $sampleBookingId;
            }
		}
	}

	if ($production_control == 1)
	{
		if ($api_weight > $balanceQty*1) {
			echo "alert('QC Pass Qty. Exceeds Yarn Issued Qty.');";
			die;
		}
	}

	if($api_weight > $max_roll_weight*1 && $max_roll_weight*1 >0){
		echo "alert('Maximum Roll Weight Not Allow.\n You can change this weight qty from library.\n Maxamum allowed Weight ');\n";
		die;
	}
	
	echo "$('#save_data_stylewise').val('$save_string');\n";
	echo "$('#txt_coller_cuff_size').val('');\n";
	echo "$('#txt_receive_qnty').val(".$api_weight.");\n";
	echo "$('#txt_receive_qnty_pcs').val('');\n";
	echo "$('#txt_reject_fabric_recv_qnty').val('');\n";

	if ($roll_maintained == 1)
	{
		echo "$('#txt_roll_no').val(1);\n";
		echo "$('#txt_deleted_id').val(".$txt_deleted_id.");\n";
	}
	else
	{
		echo "$('#txt_deleted_id').val('');\n";
	}

	echo "$('#string_size_qty').val('');\n";
	echo "$('#number_of_roll').val('1');\n";
	echo "$('#all_po_id').val('".$all_po_id."');\n";
	echo "$('#distribution_method_id').val('2');\n";


	exit();
}


if ($action == "report_barcode_text_file_for_api") 
{
	$data = explode("***", $data);

	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	//$machine_no_arr = return_library_array("select id, machine_no from lib_machine_name", 'id', 'machine_no');
	//$machine_brand_arr = return_library_array("select id, brand from lib_machine_name", 'id', 'brand'); // Temporary
	$machine_library = sql_select("select id, machine_no, brand, norsel_printer_api, norsel_printer from lib_machine_name");
	foreach ($machine_library as $val) 
	{
		$machine_no_arr[$val[csf("id")]] = $val[csf("machine_no")];
		$machine_brand_arr[$val[csf("id")]] = $val[csf("brand")];
		//$machine_norsel_data[$val[csf("id")]]["norsel_printer_api"] = $val[csf("norsel_printer_api")];
		//$machine_norsel_data[$val[csf("id")]]["norsel_printer"] = $val[csf("norsel_printer")];
	}

	$user_api_data = sql_select("select norsel_printer_api, norsel_printer from user_passwd where id=$userid and status_active=1 ");
	$norsel_printer_api = $user_api_data[0][csf("norsel_printer_api")];
	$norsel_printer = $user_api_data[0][csf("norsel_printer")];

	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');
	$floor_name_arr = return_library_array("select id, floor_name from lib_prod_floor", 'id', 'floor_name');

	$sql_yarn_info=sql_select("select a.prod_id,b.brand,b.yarn_type,b.yarn_comp_type1st,b.yarn_comp_type2nd,b.yarn_comp_percent1st,b.yarn_comp_percent2nd,b.lot,b.yarn_count_id from pro_material_used_dtls a,product_details_master b  where a.prod_id=b.id and  a.mst_id=".$data[4]." and a.dtls_id=".$data[1]." and a.entry_form=2
		and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");

	$yarn_information_string=""; $all_yarn_type=''; $yarn_information_string_without_compo=''; $yarn_counter=4;
	$yarn_dtls_arr=array();
	foreach($sql_yarn_info as $p_val)
	{
		$costing_yarn_composition='';
		$costing_yarn_band=$brand_arr[$p_val[csf('brand')]];
		$costing_yarn_lot=trim($p_val[csf('lot')]);
		$costing_yarn_count=$count_arr[$p_val[csf('yarn_count_id')]];
		$costing_yarn_composition=$composition[$p_val[csf('yarn_comp_type1st')]] . " " . $p_val[csf('yarn_comp_percent1st')] . "%";
		if ($p_val[csf('yarn_comp_type2nd')] != 0) $costing_yarn_composition .= " " . $composition[$p_val[csf('yarn_comp_type2nd')]] . " " . $p_val[csf('yarn_comp_percent2nd')] . "%";
		$yarn_information_string.=$costing_yarn_band." ".$costing_yarn_lot." ".$costing_yarn_count." ".$costing_yarn_composition. "\r\n";
		$yarn_information_string_without_compo.=$costing_yarn_band." ".$costing_yarn_lot." ".$costing_yarn_count. "\r\n";
		$all_yarn_type.=",".$yarn_type[$p_val[csf('yarn_type')]];
		$yarn_counter--;
	}

	//echo $yarn_information_string_without_compo."**".$yarn_information_string;die;
	$sql_yarn_infos=sql_select("select b.brand,b.yarn_type,b.yarn_comp_type1st,b.yarn_comp_type2nd,b.yarn_comp_percent1st,b.yarn_comp_percent2nd, b.lot,b.yarn_count_id from product_details_master b  where item_category_id=1 and b.status_active=1 and b.is_deleted=0");

	$yarn_dtls_arr=array();
	foreach($sql_yarn_infos as $p_val)
	{
		$yarn_dtls_arr[$p_val[csf('yarn_count_id')]] = $composition[$p_val[csf('yarn_comp_type1st')]] . " " . $p_val[csf('yarn_comp_percent1st')] . "%";
	}

	$sql = "SELECT a.company_id, a.recv_number, a.knitting_location_id, a.location_id, a.receive_basis, a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date, a.buyer_id, a.knitting_source, a.knitting_company,a.yarn_issue_challan_no, b.order_id, b.prod_id, b.gsm, b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.shift_name, b.insert_date,b.operator_name, b.color_range_id, b.body_part_id, b.floor_id, b.yarn_prod_id, c.po_breakdown_id from inv_receive_master a, pro_grey_prod_entry_dtls b, pro_roll_details c where a.id=b.mst_id and b.id=c.dtls_id and c.entry_form=2 and c.status_active=1 and c.is_deleted=0 and b.id=$data[1] and b.status_active=1";
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	$shiftName = '';
	$colorRange = '';
	$productionId = '';

	$bodyPartId	= '';

	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}
		//$yarn_type_data = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
		$yarn_type_data="";
		if($row[csf('yarn_prod_id')] !=""){
			$yarnTypeSql = sql_select("select yarn_type from product_details_master where id in (".$row[csf('yarn_prod_id')].")");
			foreach ($yarnTypeSql as $tval) 
			{
				$yarn_type_data .= $yarn_type[$tval[csf('yarn_type')]]."__";
			}
		}

		$yarn_type_data = implode(",",array_unique(explode(",",chop($yarn_type_data,"__"))));


		$booking_no = $row[csf('booking_no')];
		$booking_id = $row[csf('booking_id')];
		$operator_name = $operator_name_arr[$row[csf('operator_name')]];
		$floor_name = $floor_name_arr[$row[csf('floor_id')]];
		$yarn_issue_challan_no=$row[csf('yarn_issue_challan_no')];
		$booking_without_order = $row[csf('booking_without_order')];
		$productionId = $row[csf('recv_number')];
		$prod_date = date("d-m-Y", strtotime($row[csf('receive_date')]));
		$location_name=return_field_value("location_name","lib_location", "id=".$row[csf('knitting_location_id')]);
		//$order_id = $row[csf('order_id')];
		$order_id .= $row[csf('po_breakdown_id')].",";
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];
		$shiftName = $shift_name[$row[csf('shift_name')]];

		$colorRange = $color_range[$row[csf('color_range_id')]];
		$bodyPartId	= $body_part[$row[csf('body_part_id')]];


		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');
		if (trim($color) != "") {
			//$color=", ".$color;
			//$color="".$color;
		}

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];
		$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
			}
		}

		if ($row[csf('receive_basis')] == 0 || $row[csf('receive_basis')] == 1 || $row[csf('receive_basis')] == 4)
		{
			$machine_data = sql_select("select machine_no, dia_width, gauge,brand from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
			$machine_brand = $row[csf('brand')];
			if($row[csf('receive_basis')]==1)
			{

				$sql_precost_tube=sql_select("select  b.width_dia_type,b.color_type_id from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b where a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no='$booking_no' and a.job_no=b.job_no and a.status_active=1 and a.is_deleted=0 and b.body_part_id=".$row[csf('body_part_id')]." and b.lib_yarn_count_deter_id=".$row[csf('febric_description_id')]."");
				foreach($sql_precost_tube as $t_val)
				{
					$tube_type = $fabric_typee[$t_val[csf('width_dia_type')]];
					$color_type_name = $color_type[$t_val[csf('color_type_id')]];
				}
			}

		}
		else if ($row[csf('receive_basis')] == 2) //Knitting Plan
		{
			$program_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg, b.machine_id, b.batch_no,b.tube_ref_no from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$program_no = $row[csf('booking_id')];
			$grey_dia = $program_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$program_data[0][csf('width_dia_type')]];
			$machine_dia_width = $program_data[0][csf('machine_dia')];
			$machine_gauge = $program_data[0][csf('machine_gg')];
			$batch_no = $program_data[0][csf('batch_no')];
			$tube_ref_no = $program_data[0][csf('tube_ref_no')];
			//$machine_no_arr
			$machine_brand = $machine_brand_arr[$row[csf('machine_no_id')]];
			$machine_name = $machine_no_arr[$row[csf('machine_no_id')]];
			//$machine_name=explode(",",$program_data[0][csf('machine_id')]);
			$row[csf("within_group")] = $program_data[0][csf('within_group')];

			//$norsel_printer_api = $machine_norsel_data[$row[csf('machine_no_id')]]["norsel_printer_api"];
			//$norsel_printer = $machine_norsel_data[$row[csf('machine_no_id')]]["norsel_printer"];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id='" . $row[csf('buyer_id')] . "'");
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);


		$comp = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);

			if ($determination_sql[0][csf('construction')] != "") {
				$comp = $determination_sql[0][csf('construction')] . ", ";
				$construction = $determination_sql[0][csf('construction')];
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
				$composi .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
			}
		}
	}

	$order_id=implode(",",array_unique(explode(",",chop($order_id,","))));

	$po_array = array();
	$booking_no_prefix = '';

	if ($booking_without_order == 1)
	{
		if ($row[csf("receive_basis")] == 4) {

			$fb_sales_sql = "select id,job_no_prefix_num,job_no,style_ref_no,within_group from fabric_sales_order_mst where id = " . $row[csf('booking_id')];
			$fb_salesResult = sql_select($fb_sales_sql);
			$booking_no_prefix = $fb_salesResult[0][csf('job_no_prefix_num')];
			$full_booking_no = $fb_salesResult[0][csf('job_no')];
			$style_ref_no = $fb_salesResult[0][csf('style_ref_no')];
			$sales_id = $fb_salesResult[0][csf('id')];
			$no_arr = explode("-", $full_booking_no);
			array_shift($no_arr); //remove 1st index
			$full_booking_no = implode("-", $no_arr);
			$po_array[$sales_id]['style_ref'] = $style_ref_no;

		}
		else
		{
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$full_booking_no = $booking_no;

			$internal_reference_no = return_field_value("grouping", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");

			$sql_color_type=sql_select("select color_type_id from wo_non_ord_samp_booking_dtls where booking_no='".$booking_no."' and body_part=".$row[csf('body_part_id')]." and lib_yarn_count_deter_id =".$row[csf('febric_description_id')]." and status_active=1 and is_deleted=0  ");
			foreach($sql_color_type as $n_val)
			{
				$color_type_arr[]= $color_type[$n_val[csf('color_type_id')]];
			}
			$color_type_name=implode(",",array_unique($color_type_arr));
		}
		if ($row[csf("receive_basis")] == 2) // Knitting Plan
		{
			//$booking_program=$booking_no;
			$booking_no = return_field_value("b.booking_no as booking_no", "ppl_planning_info_entry_dtls a,ppl_planning_info_entry_mst b", " b.id=a.mst_id and a.id='" . $booking_id . "'", "booking_no");
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$full_booking_no = $booking_no;

			$internal_reference_no = return_field_value("grouping", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");

			$sql_color_type=sql_select("select color_type_id from wo_non_ord_samp_booking_dtls where booking_no='".$booking_no."' and body_part=".$row[csf('body_part_id')]." and lib_yarn_count_deter_id =".$row[csf('febric_description_id')]." and status_active=1 and is_deleted=0  ");
			foreach($sql_color_type as $n_val)
			{
				$color_type_arr[]= $color_type[$n_val[csf('color_type_id')]];
			}
			$color_type_name=implode(",",array_unique($color_type_arr));
		}
	}
	else
	{
		$is_salesOrder = 0;
		if ($row[csf("receive_basis")] == 2)
		{
			$booking_no2 =$booking_no;
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id='" . $row[csf("booking_id")] . "'");
			$booking_no = return_field_value("b.booking_no as booking_no", "ppl_planning_info_entry_dtls a,ppl_planning_info_entry_mst b", " b.id=a.mst_id and a.id='" . $booking_id . "'", "booking_no");
			$cound_feed = sql_select("select seq_no,count_id,feeding_id from ppl_planning_count_feed_dtls where dtls_id=" . $row[csf("booking_id")] . " and status_active=1 and is_deleted=0 order by seq_no");

			$fidder_count=4;
			foreach ($cound_feed as $feed_row) {
				$count_feed_arr[] = $feed_row[csf("seq_no")]."*".$feed_row[csf("count_id")]."*".$feed_row[csf("feeding_id")];
				$fidder_count--;
			}

			$sql_color_type=sql_select("select color_type_id from ppl_planning_entry_plan_dtls where dtls_id='".$booking_no2."' and body_part_id=".$row[csf('body_part_id')]."  and status_active=1 and is_deleted=0  ");
			foreach($sql_color_type as $n_val)
			{
				$color_type_arr[]= $color_type[$n_val[csf('color_type_id')]];
			}

			$color_type_name=implode(",",array_unique($color_type_arr));

		}
		if ($is_salesOrder == 1)
		{
			if ($row[csf("within_group")] == 1) {
				$po_sql = sql_select("select a.id, a.job_no as po_number, a.style_ref_no, a.job_no_prefix_num, a.sales_booking_no,b.buyer_id,a.within_group from fabric_sales_order_mst a,wo_booking_mst b where a.sales_booking_no=b.booking_no and a.within_group=1 and a.id in($order_id) union all select a.id, a.job_no as po_number, a.style_ref_no, a.job_no_prefix_num, a.sales_booking_no,b.buyer_id,a.within_group from fabric_sales_order_mst a,wo_non_ord_samp_booking_mst b where a.sales_booking_no=b.booking_no and a.within_group=1 and a.id in($order_id)");
			} else {
				$po_sql = sql_select("select a.id, a.job_no as po_number, a.style_ref_no, a.job_no_prefix_num, a.sales_booking_no,a.buyer_id,a.within_group from fabric_sales_order_mst a where a.id in($order_id)");
			}
			foreach ($po_sql as $row) {
				$no_arr = explode("-", $row[csf('job_no')]);
				array_shift($no_arr); //remove 1st index
				$full_booking_no = implode("-", $no_arr);

				$po_no_arr = explode("-", $row[csf('po_number')]);
				array_shift($po_no_arr); //remove 1st index
				$po_no_arr = implode("-", $po_no_arr);
				$po_array[$row[csf('id')]]['no'] = $po_no_arr;//$row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $full_booking_no;
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
				$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_id')];
			}
		}
		else
		{
			$order_id=chop($order_id,",");
			$po_sql = sql_select("select a.job_no, a.style_ref_no, a.buyer_name, a.job_no_prefix_num, b.id, b.po_number, b.grouping, b.file_no from wo_po_details_master a, wo_po_break_down b where a.id=b.job_id and b.id in($order_id)");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
				$po_array[$row[csf('id')]]['file_no'] = $row[csf('file_no')];
				$po_array[$row[csf('id')]]['style_ref'] = $row[csf('style_ref_no')];
				$po_array[$row[csf('id')]]['buyer_name'] = $row[csf('buyer_name')];
			}
		}
	}
	$within_group = $row[csf("within_group")];

	//echo $within_group;die;
	//exit;
	$i = 1;


	$i = 1;
	$year = date("y");
	$query = "select a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty,a.reject_qnty, b.batch_wgt,qc_pass_qnty_pcs,coller_cuff_size  from pro_roll_details a left join pro_grey_batch_dtls b on a.id = b.roll_id where a.dtls_id=$data[1] and a.entry_form=2 order by a.barcode_no asc";
	//a.id in($data[0]) 
	//echo $query;die;
	$res = sql_select($query);
	$split_data_arr = array();
	$created_files=array();


	//header('Content-type: application/json');
    $response = array();

	foreach ($res as $row) 
	{
		$split_roll_id = $row[csf('id')];
		if ($booking_without_order == 1)
		{
			$full_job_no = $full_booking_no;
			$book_or_po_no_prefix = $booking_no_prefix;
		}
		else
		{
			$full_job_no = $po_array[$row[csf('po_breakdown_id')]]['job_no'];
			$book_or_po_no_prefix = $po_array[$row[csf('po_breakdown_id')]]['prefix'];
			$internal_reference_no = $po_array[$row[csf('po_breakdown_id')]]['grouping'];
		}

		$machine_dia_gause = $machine_name . "-" . $machine_dia_width . "X" . $machine_gauge;
		$qnty = number_format($row[csf('QNTY')], 2, '.', '');
		$barcode = $row[csf('barcode_no')];


		$dia_length_tube=trim($grey_dia);
		if($dia_length_tube!="") $dia_length_tube.="/";
		$dia_length_tube.=trim($finish_dia) . " " . trim($stitch_length) . " " . trim($tube_type) . " " . $row[csf('coller_cuff_size')] . "";


		if ($within_group == 1)
		{
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $po_array[$row[csf('po_breakdown_id')]]['buyer_name']);
		}
		else
		{
			$buyer_name= $buyer_name;
		}

		$dia_width_gauge = $machine_dia_width . "X" . $machine_gauge;


		$dia_tube=trim($grey_dia);
		if($dia_tube!="") $dia_tube.="/";
		$dia_tube.=trim($finish_dia) ." ". trim($tube_type) ;

		$response = array(
		    "printer_id" => $norsel_printer,//"ptr1",
		    //"norsel_ip" => $norsel_ip,
		    "party_name" => $party_name,
		    "book_or_po_no_prefix" => $book_or_po_no_prefix,
		    "machine_dia_gause" => $machine_dia_gause,
		    "barcode" => $barcode,
		    "prod_date" => $prod_date,
		    "buyer_name" => $buyer_name,
		    "po_no" => $po_array[$row[csf('po_breakdown_id')]]['no'],
		    "file_no" => $po_array[$row[csf('po_breakdown_id')]]['file_no'],
		    "grouping" => $po_array[$row[csf('po_breakdown_id')]]['grouping'],
		   	"comp" => $comp ,
		    "dia_length_tube_size" => $dia_length_tube ,
		    "gsm" => $gsm,
		    "yarn_count" => $yarn_count,
		    "brand" => $brand,
		    "yarn_lot" => $yarn_lot,
		    "program_no" => $program_no,
		    "qnty" => $qnty."Kg",
		    "shiftName" => $shiftName,
		    "roll_no" => $row[csf('roll_no')],
		    "color" => $color,
		    "colorRange" => $colorRange,
		    "style_ref" => $po_array[$row[csf('po_breakdown_id')]]['style_ref'],
		    "booking_no" => $booking_no,
		    "operator_name" => $operator_name,
		    "productionId" => $productionId,
		    "batch_no" => $batch_no,
		    "tube_ref_no" => $tube_ref_no,
		    "machine_brand" => $machine_brand,
		    "yarn_type" => $yarn_type_data,//$yarn_type[$yarn_type_data],
		    "construction" => $construction,
		    "composi" => $composi ,
		    "floor_name" => $floor_name,
		    "machine_name" => $machine_name,
		    "dia_width_gauge" => $dia_width_gauge,
		    "full_job_no" => $full_job_no,
		    "dia_tube" => $dia_tube,
		    "stitch_length" => trim($stitch_length),
		    "reject_qty" => $row[csf('reject_qnty')],
		    "yarn_information_string" => $yarn_information_string,
		    "all_yarn_type" => ltrim($all_yarn_type,","),
		    "location_name" => $location_name,
		    "color_type_name" => $color_type_name,
		    "bodyPartId" => $bodyPartId,
		    "yarn_information_string_without_compo" => $yarn_information_string_without_compo,
		    "yarn_issue_challan_no" => $yarn_issue_challan_no,
		    "qc_pass_qnty_pcs" => $row[csf('qc_pass_qnty_pcs')],
		    "coller_cuff_size" => $row[csf('coller_cuff_size')],
		    "internal_reference_no" => $internal_reference_no
    	);
	}

	//echo json_encode($response); 

	$data_json = json_encode($response);

	/*echo "<pre>";
	print_r($data_json); 
	die;*/

	// API URL to send data
	$url = "http://".$norsel_printer_api;
	//$url = 'http://192.168.10.233:9080/api/print';

	$curl = curl_init($url);
	curl_setopt($curl, CURLOPT_URL, $url);
	curl_setopt($curl, CURLOPT_POST, true);
	curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);

	$headers = array(
	   "Content-Type: application/json",
	);
	curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);

	curl_setopt($curl, CURLOPT_POSTFIELDS, $data_json);

	//for debug only!
	curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);
	curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);

	$resp = curl_exec($curl);

	/*$error = curl_error($curl);
	if($error){
		die("Curl returned some errors: ". $error);
	}*/
	
	curl_close($curl);
	//var_dump($resp);

}

if ($action == "direct_print_barcode_2") 
{
	 
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');


	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');

	$sql = "SELECT a.company_id,a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name, b.shift_name, b.body_part_id, c.po_breakdown_id from inv_receive_master a, pro_grey_prod_entry_dtls b, pro_roll_details c where a.id=b.mst_id and b.id=c.dtls_id and c.entry_form=2 and c.status_active=1 and c.is_deleted=0 and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';$yarn_type_cond = '';
	//$yarn_type = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	$operator_name = '';
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		if ($row[csf('knitting_source')] == 1) {
			$party_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name_full = return_field_value("supplier_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}
		$booking_id=$row[csf("booking_id")];
		$recieve_basis=$row[csf("receive_basis")];
		$booking_no = $row[csf('booking_no')];
		$booking_without_order = $row[csf('booking_without_order')];

		$insert_time = date("H:i", strtotime($row[csf('insert_date')]));
		$prod_date = date("d-m-Y", strtotime($row[csf('receive_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));

		//$order_id = $row[csf('order_id')];
		$order_id .= $row[csf('po_breakdown_id')].",";
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];

		$operator_name = $operator_name_arr[$row[csf('operator_name')]];
		$shift_name_id = $row[csf('shift_name')];
		$body_part_id = $row[csf('body_part_id')];

		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];
		$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = ''; 
		//$yarn_type = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
				
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg,a.booking_no from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];
			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
			$bookingNo = $planning_data[0][csf('booking_no')];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

			if ($row[csf("within_group")] == 1)
			$buyer_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name_full = return_field_value("buyer_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
	

		$comp = '';$yarn_type_cond = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
			//echo "select yarn_type from product_details_master where  id=".$row[csf('prod_id')]." ";
			//echo "select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')];
			//echo $yarn_typeId.'DD';
				$yarn_type_cond=$yarn_type[$yarn_typeId];
			if ($determination_sql[0][csf('construction')] != "") {
				$comp = $determination_sql[0][csf('construction')] . ", ";
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
				
				//$yarn_type_cond .= $yarn_type[$d_row[csf('type_id')]];
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);

		
	}
	
	// yarn Type start booking_id 
	
	if ($recieve_basis == 1) {
		if ($booking_without_order == 0) {
			$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_id=$booking_id and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by  c.yarn_type";
		} else {
			$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_no='$booking_no' and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by c.yarn_type";
		}
	} else if ($recieve_basis == 2) {
		$reqsition_sql = sql_select("select  requisition_no from ppl_yarn_requisition_entry where knit_id='$booking_id'");
		$reqsition_number = "";
		foreach ($reqsition_sql as $inf) {
			if (trim($reqsition_number) != "") {
				$reqsition_number .= ",'" . $inf[csf('requisition_no')] . "'";
			} else {
				$reqsition_number = "'" . $inf[csf('requisition_no')] . "'";
			}
		}

		$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and b.requisition_no in($reqsition_number) and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1 and b.status_active=1 and b.is_deleted=0 group by  c.yarn_type";
	}
	$sql_yarn_result = sql_select($sql_yarn);
	//echo $sql_yarn;
	$yarn_typeCond="";
	foreach ($sql_yarn_result as $row)
	{
		$yarn_typeCond.=$yarn_type[$row[csf('yarn_type')]].',';
	}
	$yarntypeCond=rtrim($yarn_typeCond,',');
	$yarn_type_cond=implode(",",array_unique(explode(",",$yarntypeCond)));

	$order_id=implode(",",array_unique(explode(",",chop($order_id,","))));

	//echo $yarn_type_cond.'SS';
	//Yarn Type
 

	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		if ($row[csf("receive_basis")] == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $row[csf("booking_id")] . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
			$bookingNo = $sales_info[0][csf('sales_booking_no')];
		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$non_internal_ref= return_field_value("grouping", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$bookingNo = $booking_no;
		}
	} else {
		$is_salesOrder = 0;
		if ($recieve_basis == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $booking_id);
		}
		if ($is_salesOrder == 1) {
			//echo "select a.id, a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no, customer_buyer from fabric_sales_order_mst a where a.id in ($order_id) ";die;
			$po_sql = sql_select("select a.id, a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no,customer_buyer,case when booking_type=1 then 'Main' when booking_type=4 then 'Sample' when booking_type=9 then 'Excess' end as booking_type from fabric_sales_order_mst a where a.id in ($order_id) ");

			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no')]; //CRM ID: 22402
				$bookingNo = $row[csf('sales_booking_no')];
				$bookingType = $row[csf('booking_type')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('customer_buyer')]);
			}
		} else {
			$po_sql = sql_select("select a.job_no, a.job_no_prefix_num, b.id,b.grouping, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id) group by a.job_no,a.job_no_prefix_num,b.id,b.grouping,b.po_number");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
			}
			//$order_no = $po_array[$order_id]['no'];
		}
	}

	$body_part_type = return_field_value("body_part_type", "lib_body_part", "id=$body_part_id and body_part_type in(40,50) and status_active=1 and is_deleted=0" );

	$i = 1;
	$barcode_array = array();
	$query = "SELECT a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade, a.qc_pass_qnty_pcs as qnty_pcs, a.coller_cuff_size from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$res = sql_select($query);

	 
	$pdf=new PDF_Code128('P','mm', array(65,55));
	$pdf->AddPage();
	$pdf->SetFont('Calibri','',12);

	$pdf->SetAutoPageBreak(false);
	$pdf->SetRightMargin(0);

	$i=2; $j=3; $k=0; $br=0; $n=0;
	foreach ($res as $row) {
		

		$operatorName = substr($operator_name, 0, 13);

		if ($is_salesOrder == 1) {
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['job_no'];
			$order_no = $bookingNo;
			$booking_type = $bookingType;
		}
		else
		{
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['job_no'];
			$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		}

		

		if ($row[csf("receive_basis")] == 1 && $booking_without_order=1)
		{
			$internal_ref=$non_internal_ref;
		}
		else
		{
			if($po_array[$row[csf('po_breakdown_id')]]['grouping']!="") $internal_ref=$po_array[$row[csf('po_breakdown_id')]]['grouping'];
			else $internal_ref="";
		}

		$qnty_pcs='';$coller_cuff_size="";
		if ($body_part_type == 40 || $body_part_type == 50)
		{
			$qnty_pcs = "Qty:" . $row[csf('qnty_pcs')]. " Pcs";
			$coller_cuff_size = "SZ: " . $row[csf('coller_cuff_size')];
		}

		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=2; $j=3; $k=0;
		}


		$bookingNoArr=explode("-", $bookingNo);
		$bookingNos=$bookingNoArr[1]."-".$bookingNoArr[2]."-".$bookingNoArr[3];


		if ($operatorName != "") $operatorName = "; OP : " . $operatorName;

		$pdf->SetFont('Calibri','',11);
		$pdf->SetXY($i, $j);
		$pdf->Write(0, "" . substr($party_name_full,0,45) );
		
		$pdf->SetFont('Calibri','',10);

		$pdf->SetXY($i, $j+3.5);
		$pdf->Write(0, "D:" . $prod_date ."; B:" . $buyer_name);

		$pdf->SetFont('Calibri','',8);

		$pdf->SetXY($i, $j+6.5);
		$pdf->Write(0, "Tx Ref.:" . $poNO."; Sft:".$shift_name[$shift_name_id]."; Tm:".$insert_time);

		$pdf->SetXY($i, $j+9.5);
		$pdf->Write(0, "Po:" . substr($order_no,0,25).' '."[".$booking_type."]" );

		$pdf->SetXY($i, $j+12.5);
		$pdf->Write(0, substr($comp,0,45) );

		$pdf->SetFont('Calibri','',9);

		$pdf->SetXY($i, $j+16);
		$pdf->Write(0, "F/GSM: " . $gsm.";Clr: " .substr($color, 0, 25));
		
		$pdf->SetXY($i, $j+19);
		$pdf->Write(0, "C:".$yarn_count . "; L: " .substr($yarn_lot,0,30));
		//$pdf->Write(0, "C: " . substr($gsm, 0, 25) .";Clr: " .substr($color, 0, 25));

		$pdf->SetFont('Calibri','',8);
		$pdf->SetXY($i, $j+22.5);
		$pdf->Write(0, "Br: " .  $brand .";T: " . $yarn_type_cond);

		$pdf->SetFont('Calibri','',9);

		$pdf->SetXY($i, $j+25.5);
		$pdf->Write(0, "M/C: " . $machine_name . "; DiaXGG-" . $machine_dia_width."X".$machine_gauge . "; B-" . $bookingNos);//24

		
		$pdf->SetXY($i, $j+28.5);
		$pdf->Write(0, "F/Dia: " . trim($finish_dia).";D/Type: " .trim($tube_type));

		$pdf->SetXY($i, $j+31.5);
		$pdf->Write(0, "SL: " . trim($stitch_length).";Prg: " .$program_no . $operatorName);

		
		$pdf->SetXY($i, $j+34.5);
		$pdf->Write(0, "Roll No: " . $row[csf('roll_no')] ."; Roll Wt: " . number_format($row[csf('qnty')], 2, '.', ''). " Kg");

		$pdf->SetFont('Calibri','',10);
		$pdf->SetXY($i, $j+37.5);
		$pdf->Write(0, $row[csf("barcode_no")]."; ".$qnty_pcs."; ".$coller_cuff_size);
		

		$pdf->Code128($i+1,$j+40.5,$row[csf("barcode_no")],50,8);

		$k++;
		$br++;
	}

	foreach (glob(""."*.pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}

if ($action == "direct_print_barcode_2_old") 
{
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');


	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');

	$sql = "SELECT a.company_id,a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name, b.shift_name, b.body_part_id, c.po_breakdown_id from inv_receive_master a, pro_grey_prod_entry_dtls b, pro_roll_details c where a.id=b.mst_id and b.id=c.dtls_id and c.entry_form=2 and c.status_active=1 and c.is_deleted=0 and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';$yarn_type_cond = '';
	//$yarn_type = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	$operator_name = '';
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		if ($row[csf('knitting_source')] == 1) {
			$party_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name_full = return_field_value("supplier_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}
		$booking_id=$row[csf("booking_id")];
		$recieve_basis=$row[csf("receive_basis")];
		$booking_no = $row[csf('booking_no')];
		$booking_without_order = $row[csf('booking_without_order')];

		$insert_time = date("H:i", strtotime($row[csf('insert_date')]));
		$prod_date = date("d-m-Y", strtotime($row[csf('receive_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));

		//$order_id = $row[csf('order_id')];
		$order_id .= $row[csf('po_breakdown_id')].",";
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];

		$operator_name = $operator_name_arr[$row[csf('operator_name')]];
		$shift_name_id = $row[csf('shift_name')];
		$body_part_id = $row[csf('body_part_id')];

		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];
		$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = ''; 
		//$yarn_type = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
				
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg,a.booking_no from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];
			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
			$bookingNo = $planning_data[0][csf('booking_no')];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

			if ($row[csf("within_group")] == 1)
			$buyer_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name_full = return_field_value("buyer_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
	

		$comp = '';$yarn_type_cond = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
			//echo "select yarn_type from product_details_master where  id=".$row[csf('prod_id')]." ";
			//echo "select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')];
			//echo $yarn_typeId.'DD';
				$yarn_type_cond=$yarn_type[$yarn_typeId];
			if ($determination_sql[0][csf('construction')] != "") {
				$comp = $determination_sql[0][csf('construction')] . ", ";
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
				
				//$yarn_type_cond .= $yarn_type[$d_row[csf('type_id')]];
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);

		
	}
	
	// yarn Type start booking_id 
	
	if ($recieve_basis == 1) {
		if ($booking_without_order == 0) {
			$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_id=$booking_id and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by  c.yarn_type";
		} else {
			$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_no='$booking_no' and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by c.yarn_type";
		}
	} else if ($recieve_basis == 2) {
		$reqsition_sql = sql_select("select  requisition_no from ppl_yarn_requisition_entry where knit_id='$booking_id'");
		$reqsition_number = "";
		foreach ($reqsition_sql as $inf) {
			if (trim($reqsition_number) != "") {
				$reqsition_number .= ",'" . $inf[csf('requisition_no')] . "'";
			} else {
				$reqsition_number = "'" . $inf[csf('requisition_no')] . "'";
			}
		}

		$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and b.requisition_no in($reqsition_number) and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1 and b.status_active=1 and b.is_deleted=0 group by  c.yarn_type";
	}
	$sql_yarn_result = sql_select($sql_yarn);
	//echo $sql_yarn;
	$yarn_typeCond="";
	foreach ($sql_yarn_result as $row)
	{
		$yarn_typeCond.=$yarn_type[$row[csf('yarn_type')]].',';
	}
	$yarntypeCond=rtrim($yarn_typeCond,',');
	$yarn_type_cond=implode(",",array_unique(explode(",",$yarntypeCond)));

	$order_id=implode(",",array_unique(explode(",",chop($order_id,","))));

	//echo $yarn_type_cond.'SS';
	//Yarn Type
	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		if ($row[csf("receive_basis")] == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $row[csf("booking_id")] . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
			$bookingNo = $sales_info[0][csf('sales_booking_no')];
		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$non_internal_ref= return_field_value("grouping", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$bookingNo = $booking_no;
		}
	} else {
		$is_salesOrder = 0;
		if ($recieve_basis == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $booking_id);
		}
		if ($is_salesOrder == 1) {
			$po_sql = sql_select("select a.id, a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no, customer_buyer from fabric_sales_order_mst a where a.id in ($order_id) ");

			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no')]; //CRM ID: 22402
				$bookingNo = $row[csf('sales_booking_no')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('customer_buyer')]);
			}
		} else {
			$po_sql = sql_select("select a.job_no, a.job_no_prefix_num, b.id,b.grouping, b.po_number from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id) group by a.job_no,a.job_no_prefix_num,b.id,b.grouping,b.po_number");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
			}
			//$order_no = $po_array[$order_id]['no'];
		}
	}

	$body_part_type = return_field_value("body_part_type", "lib_body_part", "id=$body_part_id and body_part_type in(40,50) and status_active=1 and is_deleted=0" );

	$i = 1;
	$barcode_array = array();
	$query = "SELECT a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade, a.qc_pass_qnty_pcs as qnty_pcs, a.coller_cuff_size from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$res = sql_select($query);
	$pdf=new PDF_Code128('P','mm', array(65,55));
	$pdf->AddPage();
	$pdf->SetFont('Arial','',12);

	$pdf->SetAutoPageBreak(false);
	$pdf->SetRightMargin(0);

	$i=2; $j=3; $k=0; $br=0; $n=0;
	foreach ($res as $row) {
		

		$operatorName = substr($operator_name, 0, 13);

		if ($is_salesOrder == 1) {
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['job_no'];;
			$order_no = $bookingNo;
		}
		else
		{
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['job_no'];
			$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		}

		

		if ($row[csf("receive_basis")] == 1 && $booking_without_order=1)
		{
			$internal_ref=$non_internal_ref;
		}
		else
		{
			if($po_array[$row[csf('po_breakdown_id')]]['grouping']!="") $internal_ref=$po_array[$row[csf('po_breakdown_id')]]['grouping'];
			else $internal_ref="";
		}

		$qnty_pcs='';$coller_cuff_size="";
		if ($body_part_type == 40 || $body_part_type == 50)
		{
			$qnty_pcs = "Qty:" . $row[csf('qnty_pcs')]. " Pcs";
			$coller_cuff_size = "SZ: " . $row[csf('coller_cuff_size')];
		}

		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=2; $j=3; $k=0;
		}


		$bookingNoArr=explode("-", $bookingNo);
		$bookingNos=$bookingNoArr[1]."-".$bookingNoArr[2]."-".$bookingNoArr[3];


		if ($operatorName != "") $operatorName = "; OP : " . $operatorName;

		$pdf->SetXY($i, $j);
		$pdf->Write(0, "" . substr($party_name_full,0,45) );
		
		$pdf->SetFont('Arial','',11);

		$pdf->SetXY($i, $j+3.5);
		$pdf->Write(0, "D:" . $prod_date ."; B:" . $buyer_name);

		$pdf->SetFont('Arial','',8);

		$pdf->SetXY($i, $j+6.5);
		$pdf->Write(0, "Tx Ref.:" . $poNO."; Sft:".$shift_name[$shift_name_id]."; Tm:".$insert_time);

		$pdf->SetXY($i, $j+9.5);
		$pdf->Write(0, "Po:" . substr($order_no,0,25) );

		$pdf->SetXY($i, $j+12.5);
		$pdf->Write(0, substr($comp,0,45) );

		$pdf->SetXY($i, $j+16);
		$pdf->Write(0, "F/GSM: " . $gsm.";Clr: " .substr($color, 0, 25));

		$pdf->SetXY($i, $j+19);
		$pdf->Write(0, "C:".$yarn_count . "; L: " . $yarn_lot);
		//$pdf->Write(0, "C: " . substr($gsm, 0, 25) .";Clr: " .substr($color, 0, 25));

		$pdf->SetXY($i, $j+22.5);
		$pdf->Write(0, "Br: " .  $brand .";T: " . $yarn_type_cond);

		$pdf->SetXY($i, $j+25.5);
		$pdf->Write(0, "M/C: " . $machine_name . "; DiaXGG-" . $machine_dia_width."X".$machine_gauge . "; B-" . $bookingNos);//24

		$pdf->SetXY($i, $j+28.5);
		$pdf->Write(0, "F/Dia: " . trim($finish_dia).";D/Type: " .trim($tube_type));

		$pdf->SetXY($i, $j+31.5);
		$pdf->Write(0, "SL: " . trim($stitch_length).";Prg: " .$program_no . $operatorName);

		$pdf->SetFont('Arial','',11);
		$pdf->SetXY($i, $j+34.5);
		$pdf->Write(0, "Roll No: " . $row[csf('roll_no')] ."; Roll Wt: " . number_format($row[csf('qnty')], 2, '.', ''). " Kg");

		$pdf->SetFont('Arial','',8);
		$pdf->SetXY($i, $j+37.5);
		$pdf->Write(0, $row[csf("barcode_no")]."; ".$qnty_pcs."; ".$coller_cuff_size);
		
		$pdf->Code128($i+1,$j+40.5,$row[csf("barcode_no")],50,8);

		$k++;
		$br++;
	}

	foreach (glob(""."*.pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}

if ($action == "direct_print_barcode_4") 
{
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');


	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');

	$sql = "SELECT a.company_id,a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name, b.shift_name, b.body_part_id, c.po_breakdown_id from inv_receive_master a, pro_grey_prod_entry_dtls b, pro_roll_details c where a.id=b.mst_id and b.id=c.dtls_id and c.entry_form=2 and c.status_active=1 and c.is_deleted=0 and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';$yarn_type_cond = '';
	//$yarn_type = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	$operator_name = '';
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		if ($row[csf('knitting_source')] == 1) {
			$party_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name_full = return_field_value("supplier_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}
		$booking_id=$row[csf("booking_id")];
		$recieve_basis=$row[csf("receive_basis")];
		$booking_no = $row[csf('booking_no')];
		$booking_without_order = $row[csf('booking_without_order')];

		$insert_time = date("H:i", strtotime($row[csf('insert_date')]));
		$prod_date = date("d-m-Y", strtotime($row[csf('receive_date')]));
		$prod_time = date("H:i", strtotime($row[csf('insert_date')]));

		//$order_id = $row[csf('order_id')];
		$order_id .= $row[csf('po_breakdown_id')].",";
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];

		$operator_name = $operator_name_arr[$row[csf('operator_name')]];
		$shift_name_id = $row[csf('shift_name')];
		$body_part_id = $row[csf('body_part_id')];

		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];
		$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = ''; 
		//$yarn_type = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
				
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg,a.booking_no from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];
			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
			$bookingNo = $planning_data[0][csf('booking_no')];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

			if ($row[csf("within_group")] == 1)
			$buyer_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name_full = return_field_value("buyer_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
	

		$comp = '';$yarn_type_cond = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
			//echo "select yarn_type from product_details_master where  id=".$row[csf('prod_id')]." ";
			//echo "select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')];
			//echo $yarn_typeId.'DD';
				$yarn_type_cond=$yarn_type[$yarn_typeId];
			if ($determination_sql[0][csf('construction')] != "") {
				$comp = $determination_sql[0][csf('construction')] . ", ";
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
				
				//$yarn_type_cond .= $yarn_type[$d_row[csf('type_id')]];
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);

		
	}
	
	// yarn Type start booking_id 
	
	if ($recieve_basis == 1) {
		if ($booking_without_order == 0) {
			$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_id=$booking_id and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by  c.yarn_type";
		} else {
			$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_no='$booking_no' and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by c.yarn_type";
		}
	} else if ($recieve_basis == 2) {
		$reqsition_sql = sql_select("select  requisition_no from ppl_yarn_requisition_entry where knit_id='$booking_id'");
		$reqsition_number = "";
		foreach ($reqsition_sql as $inf) {
			if (trim($reqsition_number) != "") {
				$reqsition_number .= ",'" . $inf[csf('requisition_no')] . "'";
			} else {
				$reqsition_number = "'" . $inf[csf('requisition_no')] . "'";
			}
		}

		$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and b.requisition_no in($reqsition_number) and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1 and b.status_active=1 and b.is_deleted=0 group by  c.yarn_type";
	}
	$sql_yarn_result = sql_select($sql_yarn);
	//echo $sql_yarn;
	$yarn_typeCond="";
	foreach ($sql_yarn_result as $row)
	{
		$yarn_typeCond.=$yarn_type[$row[csf('yarn_type')]].',';
	}
	$yarntypeCond=rtrim($yarn_typeCond,',');
	$yarn_type_cond=implode(",",array_unique(explode(",",$yarntypeCond)));

	$order_id=implode(",",array_unique(explode(",",chop($order_id,","))));

	//echo $yarn_type_cond.'SS';
	//Yarn Type
	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		if ($row[csf("receive_basis")] == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $row[csf("booking_id")] . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
			$bookingNo = $sales_info[0][csf('sales_booking_no')];
		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$non_internal_ref= return_field_value("grouping", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$bookingNo = $booking_no;
		}
	} else {
		$is_salesOrder = 0;
		if ($recieve_basis == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $booking_id);
		}
		if ($is_salesOrder == 1) {
			$po_sql = sql_select("select a.id, a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no,a.style_ref_no, customer_buyer from fabric_sales_order_mst a where a.id in ($order_id) ");

			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
				$bookingNo = $row[csf('sales_booking_no')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('customer_buyer')]);
			}
		} else {
			$po_sql = sql_select("select a.job_no, a.job_no_prefix_num, b.id,b.grouping, b.po_number,a.style_ref_no from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id) group by a.job_no,a.job_no_prefix_num,b.id,b.grouping,b.po_number");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
				$po_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
			}
			//$order_no = $po_array[$order_id]['no'];
		}
	}

	$body_part_type = return_field_value("body_part_type", "lib_body_part", "id=$body_part_id and body_part_type in(40,50) and status_active=1 and is_deleted=0" );

	$i = 1;
	$barcode_array = array();
	$query = "SELECT a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade, a.qc_pass_qnty_pcs as qnty_pcs, a.coller_cuff_size from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$res = sql_select($query);
	$pdf=new PDF_Code128('P','mm', array(65,55));
	$pdf->AddPage();
	$pdf->SetFont('Calibri','',12);

	$pdf->SetAutoPageBreak(false);
	$pdf->SetRightMargin(0);

	$i=2; $j=3; $k=0; $br=0; $n=0;
	foreach ($res as $row) {
		

		$operatorName = substr($operator_name, 0, 13);

		if ($is_salesOrder == 1) {
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['job_no'];
			$order_no = $bookingNo;
		}
		else
		{
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['job_no'];
			$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		}

		$style_ref_no=$po_array[$row[csf('po_breakdown_id')]]['style_ref_no'];

		if ($row[csf("receive_basis")] == 1 && $booking_without_order=1)
		{
			$internal_ref=$non_internal_ref;
		}
		else
		{
			if($po_array[$row[csf('po_breakdown_id')]]['grouping']!="") $internal_ref=$po_array[$row[csf('po_breakdown_id')]]['grouping'];
			else $internal_ref="";
		}

		$qnty_pcs='';$coller_cuff_size="";
		if ($body_part_type == 40 || $body_part_type == 50)
		{
			$qnty_pcs = "Qty:" . $row[csf('qnty_pcs')]. " Pcs";
			$coller_cuff_size = "SZ: " . $row[csf('coller_cuff_size')];
		}

		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=2; $j=3; $k=0;
		}


		$bookingNoArr=explode("-", $bookingNo);
		$bookingNos=$bookingNoArr[1]."-".$bookingNoArr[2]."-".$bookingNoArr[3];


		//if ($operatorName != "") $operatorName = "; OP : " . $operatorName;

		$pdf->SetFont('Calibri','',11);
		$pdf->SetXY($i, $j);
		$pdf->Write(0, "" . substr($party_name_full,0,45) );
		
		$pdf->SetFont('Calibri','',10);

		$pdf->SetXY($i, $j+3.5);
		$pdf->Write(0, "D:" . $prod_date .", B:" . $buyer_name);

		$pdf->SetFont('Calibri','',8);

		$pdf->SetXY($i, $j+6.5);
		$pdf->Write(0, "Sh:".$shift_name[$shift_name_id].", OP:".$operatorName);

		$pdf->SetXY($i, $j+9.5);
		$pdf->Write(0, "PO:" . $bookingNos );
		//substr($order_no,0,25)

		$pdf->SetXY($i, $j+12.5);
		$pdf->Write(0, substr($comp,0,45) );

		$pdf->SetFont('Calibri','',9);

		$pdf->SetXY($i, $j+16);
		$pdf->Write(0, "GSM: " . $gsm.", CLR: " .substr($color, 0, 25));
		
		$pdf->SetXY($i, $j+19);
		$pdf->Write(0, "Y/C:".$yarn_count . ", L: " . $yarn_lot);
		//$pdf->Write(0, "C: " . substr($gsm, 0, 25) .";Clr: " .substr($color, 0, 25));

		$pdf->SetFont('Calibri','',8);
		$pdf->SetXY($i, $j+22.5);
		$pdf->Write(0, "Y/B: " .  $brand .", Y/T: " . $yarn_type_cond);

		$pdf->SetFont('Calibri','',9);

		$pdf->SetXY($i, $j+25.5);
		$pdf->Write(0, "M: " . $machine_name . ", ST: " . $style_ref_no);//24
		//DiaXGG-" . $machine_dia_width."X".$machine_gauge . "; B-" . $bookingNos)
		
		$pdf->SetXY($i, $j+28.5);
		$pdf->Write(0, "F/Dia: " . trim($finish_dia).", D/Type: " .trim($tube_type));

		$pdf->SetXY($i, $j+31.5);
		$pdf->Write(0, "SL: " . trim($stitch_length).", Prog: " .$program_no);

		
		$pdf->SetXY($i, $j+34.5);
		$pdf->Write(0, "Roll : " . $row[csf('roll_no')] .", WT: " . number_format($row[csf('qnty')], 2, '.', ''). " Kg");

		$pdf->SetFont('Calibri','',10);
		$pdf->SetXY($i, $j+37.5);
		$qnt_colr_str = "";
		if(!empty($qnty_pcs))
		{
			$qnt_colr_str = ", ".$qnty_pcs;
		}
		if(!empty($coller_cuff_size))
		{
			$qnt_colr_str.= ", ".$coller_cuff_size;
		}
		$pdf->Write(0, $row[csf("barcode_no")].$qnt_colr_str);
		

		$pdf->Code128($i+1,$j+40.5,$row[csf("barcode_no")],50,8);

		$k++;
		$br++;
	}

	foreach (glob(""."*.pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}

if ($action == "direct_print_barcode_5") 
{
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');


	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');

	$sql = "SELECT a.company_id,a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name, b.shift_name, b.body_part_id, c.po_breakdown_id from inv_receive_master a, pro_grey_prod_entry_dtls b, pro_roll_details c where a.id=b.mst_id and b.id=c.dtls_id and c.entry_form=2 and c.status_active=1 and c.is_deleted=0 and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';$yarn_type_cond = '';
	//$yarn_type = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	$operator_name = '';
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		if ($row[csf('knitting_source')] == 1) {
			$party_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name_full = return_field_value("supplier_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}
		$booking_id=$row[csf("booking_id")];
		$recieve_basis=$row[csf("receive_basis")];
		$booking_no = $row[csf('booking_no')];
		$booking_without_order = $row[csf('booking_without_order')];

		$insert_time = date("H:i", strtotime($row[csf('insert_date')]));
		$prod_date = date("d-m-Y", strtotime($row[csf('receive_date')]));
		$prod_time = date("h:i:a", strtotime($row[csf('insert_date')]));

		//$order_id = $row[csf('order_id')];
		$order_id .= $row[csf('po_breakdown_id')].",";
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];

		$operator_name = $operator_name_arr[$row[csf('operator_name')]];
		$shift_name_id = $row[csf('shift_name')];
		$body_part_id = $row[csf('body_part_id')];

		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];
		$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = ''; 
		//$yarn_type = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
				
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg,a.booking_no from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];
			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
			$bookingNo = $planning_data[0][csf('booking_no')];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

			if ($row[csf("within_group")] == 1)
			$buyer_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name_full = return_field_value("buyer_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
	

		$comp = '';$yarn_type_cond = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
			//echo "select yarn_type from product_details_master where  id=".$row[csf('prod_id')]." ";
			//echo "select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')];
			//echo $yarn_typeId.'DD';
				$yarn_type_cond=$yarn_type[$yarn_typeId];
			if ($determination_sql[0][csf('construction')] != "") {
				$comp = $determination_sql[0][csf('construction')] . ", ";
			}

			foreach ($determination_sql as $d_row) {
				$comp .= $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
				
				//$yarn_type_cond .= $yarn_type[$d_row[csf('type_id')]];
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);

		
	}
	
	// yarn Type start booking_id 
	
	if ($recieve_basis == 1) {
		if ($booking_without_order == 0) {
			$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_id=$booking_id and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by  c.yarn_type";
		} else {
			$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_no='$booking_no' and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by c.yarn_type";
		}
	} else if ($recieve_basis == 2) {
		$reqsition_sql = sql_select("select  requisition_no from ppl_yarn_requisition_entry where knit_id='$booking_id'");
		$reqsition_number = "";
		foreach ($reqsition_sql as $inf) {
			if (trim($reqsition_number) != "") {
				$reqsition_number .= ",'" . $inf[csf('requisition_no')] . "'";
			} else {
				$reqsition_number = "'" . $inf[csf('requisition_no')] . "'";
			}
		}

		$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and b.requisition_no in($reqsition_number) and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1 and b.status_active=1 and b.is_deleted=0 group by  c.yarn_type";
	}
	$sql_yarn_result = sql_select($sql_yarn);
	//echo $sql_yarn;
	$yarn_typeCond="";
	foreach ($sql_yarn_result as $row)
	{
		$yarn_typeCond.=$yarn_type[$row[csf('yarn_type')]].',';
	}
	$yarntypeCond=rtrim($yarn_typeCond,',');
	$yarn_type_cond=implode(",",array_unique(explode(",",$yarntypeCond)));

	$order_id=implode(",",array_unique(explode(",",chop($order_id,","))));

	//echo $yarn_type_cond.'SS';
	//Yarn Type
	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		if ($row[csf("receive_basis")] == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $row[csf("booking_id")] . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
			$bookingNo = $sales_info[0][csf('sales_booking_no')];
		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$non_internal_ref= return_field_value("grouping", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$bookingNo = $booking_no;
		}
	} else {
		$is_salesOrder = 0;
		if ($recieve_basis == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $booking_id);
		}
		if ($is_salesOrder == 1) {
			$po_sql = sql_select("select a.id, a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no,a.style_ref_no, customer_buyer from fabric_sales_order_mst a where a.id in ($order_id) ");

			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
				$bookingNo = $row[csf('sales_booking_no')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('customer_buyer')]);
			}
		} else {
			$po_sql = sql_select("select a.job_no, a.job_no_prefix_num, b.id,b.grouping, b.po_number,a.style_ref_no from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id) group by a.job_no,a.job_no_prefix_num,b.id,b.grouping,b.po_number");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
				$po_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
			}
			//$order_no = $po_array[$order_id]['no'];
		}
	}

	$body_part_type = return_field_value("body_part_type", "lib_body_part", "id=$body_part_id and body_part_type in(40,50) and status_active=1 and is_deleted=0" );

	$i = 1;
	$barcode_array = array();
	$query = "SELECT a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade, a.qc_pass_qnty_pcs as qnty_pcs, a.coller_cuff_size from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$res = sql_select($query);
	$pdf=new PDF_Code128('P','mm', array(65,55));
	$pdf->AddPage();
	$pdf->SetFont('Arial','',10);

	$pdf->SetAutoPageBreak(false);
	$pdf->SetRightMargin(0);

	$i=2; $j=3; $k=0; $br=0; $n=0;
	foreach ($res as $row) {
		

		$operatorName = substr($operator_name, 0, 13);

		if ($is_salesOrder == 1) {
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['job_no'];
			$order_no = $bookingNo;
		}
		else
		{
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['job_no'];
			$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		}

		$style_ref_no=$po_array[$row[csf('po_breakdown_id')]]['style_ref_no'];

		if ($row[csf("receive_basis")] == 1 && $booking_without_order=1)
		{
			$internal_ref=$non_internal_ref;
		}
		else
		{
			if($po_array[$row[csf('po_breakdown_id')]]['grouping']!="") $internal_ref=$po_array[$row[csf('po_breakdown_id')]]['grouping'];
			else $internal_ref="";
		}

		$qnty_pcs='';$coller_cuff_size="";
		if ($body_part_type == 40 || $body_part_type == 50)
		{
			$qnty_pcs = "Qty:" . $row[csf('qnty_pcs')]. " Pcs";
			$coller_cuff_size = "SZ: " . $row[csf('coller_cuff_size')];
		}

		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=2; $j=3; $k=0;
		}


		$bookingNoArr=explode("-", $bookingNo);
		$bookingNos=$bookingNoArr[1]."-".$bookingNoArr[2]."-".$bookingNoArr[3];


		//if ($operatorName != "") $operatorName = "; OP : " . $operatorName;

		//$pdf->SetFont('Calibri','',11);
		$pdf->SetFont('Arial','B',8);
		$pdf->SetXY($i, $j);
		$pdf->Write(0, substr($party_name_full,0,45).", P:".$program_no );
		
		$pdf->SetFont('Arial','',8);
		$pdf->SetXY($i, $j+3.2);
		$pdf->Write(0, $prod_date .", ". $prod_time .", Sh:" . $shift_name[$shift_name_id].", OP:".$operatorName);

		$pdf->SetFont('Arial','B',8);
		$pdf->SetXY($i, $j+7.2);
		$pdf->Write(0, "B No:".$bookingNos);
		$pdf->SetFont('Arial','',8);
		$pdf->Write(0, ", B:".$buyer_name);

		$pdf->SetXY($i, $j+11.2);
		$pdf->Write(0, "Style:" . $style_ref_no );

		$pdf->SetFont('Arial','B',9);
		$pdf->SetXY($i, $j+15.2);
		$pdf->Write(0, "M/C: " . $machine_name );
		$pdf->SetFont('Arial','B',8);
		$pdf->Write(0, ", ".$machine_dia_width."X".$machine_gauge.", F/Dia: " . trim($finish_dia).", St/L: " . trim($stitch_length) );

		$pdf->SetFont('Arial','',8);
		$pdf->SetXY($i, $j+19.2);
		$pdf->Write(0, substr($comp,0,45) );

		$pdf->SetXY($i, $j+23.2);
		$pdf->Write(0, "GSM: " . $gsm.", CLR: " .substr($color, 0, 25));
		
		$pdf->SetFont('Arial','B',8);
		$pdf->SetXY($i, $j+27.2);
		$pdf->Write(0, "Y/C:".$yarn_count . ", Y/B: " . $brand);

		$pdf->SetXY($i, $j+31.2);
		$pdf->Write(0, "Y/T: " . $yarn_type_cond. ", Y/L: " . $yarn_lot);

		$pdf->SetFont('Arial','',8);
		$pdf->SetXY($i, $j+35.2);
		$pdf->Write(0, "Roll : " . $row[csf('roll_no')] );
		$pdf->SetFont('Arial','B',8);
		$pdf->Write(0, ", W/T: " . number_format($row[csf('qnty')], 2, '.', ''). " Kg");

		$pdf->SetFont('Arial','',10);
		$pdf->SetXY($i, $j+39.2);
		$pdf->Write(0, $row[csf("barcode_no")]);

		$pdf->Code128($i+1,$j+42.2,$row[csf("barcode_no")],50,8);

		$k++;
		$br++;
	}

	foreach (glob(""."*.pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}


if($action=="print_barcode_ccl")
{
    //echo "1000".$data;die;

	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');

	$sql = "SELECT a.company_id,a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name, b.shift_name, b.body_part_id, c.po_breakdown_id from inv_receive_master a, pro_grey_prod_entry_dtls b, pro_roll_details c where a.id=b.mst_id and b.id=c.dtls_id and c.entry_form=2 and c.status_active=1 and c.is_deleted=0 and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';$yarn_type_cond = '';
	//$yarn_type = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	$operator_name = '';
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		if ($row[csf('knitting_source')] == 1) {
			$party_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name_full = return_field_value("supplier_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}
		$booking_id=$row[csf("booking_id")];
		$recieve_basis=$row[csf("receive_basis")];
		$booking_no = $row[csf('booking_no')];
		$booking_without_order = $row[csf('booking_without_order')];

		$insert_time = date("H:i", strtotime($row[csf('insert_date')]));
		$prod_date = date("d-m-Y", strtotime($row[csf('receive_date')]));
		$prod_time = date("h:i:a", strtotime($row[csf('insert_date')]));

		//$order_id = $row[csf('order_id')];
		$order_id .= $row[csf('po_breakdown_id')].",";
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];

		$operator_name = $operator_name_arr[$row[csf('operator_name')]];
		//$operator_name = $operator_name_arr[$row[csf('operator_name')]];
		$operator_id = $row[csf('operator_name')];
		$shift_name_id = $row[csf('shift_name')];
		$body_part_id = $row[csf('body_part_id')];

		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];
		$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = ''; 
		//$yarn_type = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
				
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg,a.booking_no from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];
			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
			$bookingNo = $planning_data[0][csf('booking_no')];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

			if ($row[csf("within_group")] == 1)
			$buyer_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name_full = return_field_value("buyer_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
	

			$cons = '';$comp = '';$yarn_type_cond = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
			//echo "select yarn_type from product_details_master where  id=".$row[csf('prod_id')]." ";
			//echo "select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')];
			//echo $yarn_typeId.'DD';
				$yarn_type_cond=$yarn_type[$yarn_typeId];
			if ($determination_sql[0][csf('construction')] != "") {
				$cons = $determination_sql[0][csf('construction')];
			}

			foreach ($determination_sql as $d_row) {
				$comp = $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
				
				//$yarn_type_cond .= $yarn_type[$d_row[csf('type_id')]];
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);

		
	}
	
	// yarn Type start booking_id 
	
	if ($recieve_basis == 1) {
		if ($booking_without_order == 0) {
			$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_id=$booking_id and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by  c.yarn_type";
		} else {
			$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_no='$booking_no' and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by c.yarn_type";
		}
	} else if ($recieve_basis == 2) {
		$reqsition_sql = sql_select("select  requisition_no from ppl_yarn_requisition_entry where knit_id='$booking_id'");
		$reqsition_number = "";
		foreach ($reqsition_sql as $inf) {
			if (trim($reqsition_number) != "") {
				$reqsition_number .= ",'" . $inf[csf('requisition_no')] . "'";
			} else {
				$reqsition_number = "'" . $inf[csf('requisition_no')] . "'";
			}
		}

		$sql_yarn = "select c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and b.requisition_no in($reqsition_number) and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1 and b.status_active=1 and b.is_deleted=0 group by c.yarn_type";
	}
	//echo $sql_yarn;die;
	$sql_yarn_result = sql_select($sql_yarn);
	
	$yarn_typeCond="";
	foreach ($sql_yarn_result as $row)
	{
		$yarn_typeCond.=$yarn_type[$row[csf('yarn_type')]].',';
	}
	$yarntypeCond=rtrim($yarn_typeCond,',');
	$yarn_type_cond=implode(",",array_unique(explode(",",$yarntypeCond)));

	$order_id=implode(",",array_unique(explode(",",chop($order_id,","))));

	//echo $yarn_type_cond.'SS';
	//Yarn Type
	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		if ($row[csf("receive_basis")] == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $row[csf("booking_id")] . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
			$bookingNo = $sales_info[0][csf('sales_booking_no')];
		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$non_internal_ref= return_field_value("grouping", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$bookingNo = $booking_no;
		}
	} else {
		$is_salesOrder = 0;
		if ($recieve_basis == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $booking_id);
		}
		if ($is_salesOrder == 1) {
		
		
			$po_sql = sql_select("select a.id, a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no,a.style_ref_no, customer_buyer,a.booking_id from fabric_sales_order_mst a where a.id in ($order_id) ");
			$booking_id_arr = array();
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
				$bookingNo = $row[csf('sales_booking_no')];
				$bookingId = $row[csf('booking_id')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('customer_buyer')]);

				array_push($booking_id_arr,$row[csf('booking_id')]);

			}

			$booking_sql_rslt = sql_select("select a.booking_mst_id, a.po_break_down_id,b.grouping from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id = b.id ".where_con_using_array($booking_id_arr,0,'a.booking_mst_id')." group by a.booking_mst_id, a.po_break_down_id,b.grouping");
			foreach ($booking_sql_rslt as $row) 
			{
				$booking_po_array[$row[csf('booking_mst_id')]]['grouping'] = $row[csf('grouping')];
			}

		} else {
			$po_sql = sql_select("select a.job_no, a.job_no_prefix_num, b.id,b.grouping, b.po_number,a.style_ref_no from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id) group by a.job_no,a.job_no_prefix_num,b.id,b.grouping,b.po_number");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
				$po_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
			}
			//$order_no = $po_array[$order_id]['no'];
		}
	}

	$body_part_type = return_field_value("body_part_type", "lib_body_part", "id=$body_part_id and body_part_type in(40,50) and status_active=1 and is_deleted=0" );

	$i = 1;
	$barcode_array = array();
	$query = "SELECT a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade, a.qc_pass_qnty_pcs as qnty_pcs, a.coller_cuff_size from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	//echo $query;
	$res = sql_select($query);
	
    require_once("../../ext_resource/mpdf60/mpdf.php");

    $mpdf = new mPDF('',    // mode - default ''
	array(197,110),//array(297,210),		// array(65,210),    // format - A4, for example, default ''
        18,     // font size - default 0
        '',    // default font family
        1,    // margin_left
        1,    // margin right
        1,     // margin top
        1,    // margin bottom
        1,     // margin header
        1,     // margin footer
        'P');
 
    $i 		=1;
    $html 	='';
 

	foreach ($res as $row)
	{
		$operatorName = substr($operator_name, 0, 13);

		if ($is_salesOrder == 1) {
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['job_no'];
			$order_no = $bookingNo;
		}
		else
		{
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['job_no'];
			$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		}

		$style_ref_no=$po_array[$row[csf('po_breakdown_id')]]['style_ref_no'];

		if ($row[csf("receive_basis")] == 1 && $booking_without_order=1)
		{
			$internal_ref=$non_internal_ref;
		}
		else
		{
			if ($is_salesOrder == 1) 
			{
				$internal_ref=$booking_po_array[$bookingId]['grouping'];
			}
			else
			{
				if($po_array[$row[csf('po_breakdown_id')]]['grouping']!="") $internal_ref=$po_array[$row[csf('po_breakdown_id')]]['grouping'];
				else $internal_ref="";
			}
			
		}

		$qnty_pcs='';$coller_cuff_size="";
		if ($body_part_type == 40 || $body_part_type == 50)
		{
			$qnty_pcs = "Qty:" . $row[csf('qnty_pcs')]. " Pcs";
			$coller_cuff_size = "SZ: " . $row[csf('coller_cuff_size')];
		}
		
		$mpdf->AddPage('',    // mode - default ''
		array(197,110),//array(297,210),		// array(65,210),    // format - A4, for example, default ''
			18,     // font size - default 0
			'',    // default font family
			1,    // margin_left
			1,    // margin right
			1,     // margin top
			1,    // margin bottom
			1,     // margin header
			1,     // margin footer
			'P');
		$html .= '<style>
					td, th {
						border: .4px solid black;
					}
				</style>';
		$html .='<table width="100%" border="0" style="border:none;">';
		
			$html .='<tr style="border:none;">';
			
			$html .= '<td style="border:none; "><table cellpadding="0" cellspacing="0" width="100%" height="100%" class="" style="font-weight:normal;margin:0 auto;font-size:9px;" rules="all" id="" border="1" align="left">
					
			        <tr><td style="border:none; padding: 1.5px 0px 1.5px 0px;font-weight:bold;font-size:50px; "><td></td></tr>
					<tr>
						<td align="center" style="border:none; padding: 1.5px 0px 1.5px 0px;font-weight:bold;font-size:50px; "><barcode code="'.$row[csf("barcode_no")].'" type="C39" size="1.5"  height="2.0" /></td>
					</tr>
					<tr>
						<td align="center" style="border:none; padding: 1.5px 0px 1.5px 0px;font-weight:bold;font-size:40px;"> ' . $row[csf("barcode_no")] . '</td>
					</tr>
					<tr>
						<td  style="border:none; padding: 1.5px 0px 1.5px 0px;font-size:40px;"> <span style="font-weight:bold;">Dt :</span>' . $prod_date .', <span style="font-weight:bold;">M/N :</span>'.$machine_name.', <span style="font-weight:bold;">Shift :</span>'.$shift_name[$shift_name_id]. '</td>
					</tr>
					<tr>
						<td  style="border:none; padding: 1.5px 0px 1.5px 0px;font-size:35px;"> <span style="font-weight:bold;">Buyer :</span>' . $buyer_name .', <span style="font-weight:bold;">Int.B :</span>'.$internal_ref.'</td>
					</tr>
					<tr>
						<td style="border:none; padding: 1.5px 0px 1.5px 0px;font-size:35px;"> <span style="font-weight:bold;">F.Const :</span>' . $cons .', '.$machine_dia_width."X".$machine_gauge.', '.trim($tube_type).', '.$gsm.'</td>
					</tr>
					<tr>
						<td  style="border:none; padding: 1.5px 0px 1.5px 0px;font-size:35px;"> <span style="font-weight:bold;">F.Comp :</span>' . $comp .'</td>
					</tr>
					<tr>
						<td  style="border:none; padding: 1.5px 0px 1.5px 0px;font-size:35px;"> <span style="font-weight:bold;">F.Clr :</span>' . substr($color, 0, 25) .'</td>
					</tr>
					<tr>
						<td  style="border:none; padding: 1.5px 0px 1.5px 0px;font-size:35px;"> <span style="font-weight:bold;">YC :</span>' . $yarn_count.', <span style="font-weight:bold;">YT :</span>'.$yarn_type_cond .'</td>
					</tr>
					<tr>
						<td  style="border:none; padding: 1.5px 0px 1.5px 0px;font-size:35px;"> <span style="font-weight:bold;">B :</span>' . $brand.', <span style="font-weight:bold;">L :</span>'.$yarn_lot .'</td>
					</tr>
					<tr>
						<td  style="border:none; padding: 1.5px 0px 1.5px 0px;font-size:35px;"> <span style="font-weight:bold;">OC :</span>' . $company_short_name.', <span style="font-weight:bold;">KC :</span>'.$party_name.', <span style="font-weight:bold;">St/L :</span>'.trim($stitch_length).', <span style="font-weight:bold;">R.WT :'.number_format($row[csf('qnty')], 2, '.', ''). " Kg </span>" .'</td>
					</tr>
					<tr>
						<td  style="border:none; padding: 1.5px 0px 1.5px 0px;font-size:35px;"> <span style="font-weight:bold;">OP :</span>' . $operatorName.'['.$operator_id.']' .'</td>
					</tr>

					
					
				</table></td>';
			
			$html .='</tr>';
		
		$html .= "</table>";
		$mpdf->WriteHTML($html);
		$html='';
		$i++;

	}
    $mpdf->WriteHTML($html);
    foreach (glob("*.pdf") as $filename) {
        @unlink($filename);
    }
    $name = 'knitting_barcode_' . date('j-M-Y_h-iA') .'_'.$user_id.'.pdf';
    $mpdf->Output($name, 'F');
	echo "requires/".$name;

    exit();

}



if ($action == "print_barcode_ccl__") 
{
	require('../../ext_resource/pdf/code128.php');
	define('FPDF_FONTPATH', '../../ext_resource/pdf/fpdf/font/');


	$data = explode("***", $data);
	$brand_arr = return_library_array("select id, brand_name from lib_brand", 'id', 'brand_name');
	$count_arr = return_library_array("select id, yarn_count from lib_yarn_count", "id", "yarn_count");
	$color_arr = return_library_array("select id, color_name from lib_color", 'id', 'color_name');
	$operator_name_arr = return_library_array("select id, first_name from lib_employee", 'id', 'first_name');

	$sql = "SELECT a.company_id,a.receive_basis,a.booking_id, a.booking_no, a.booking_without_order, a.within_group, a.receive_date,a.buyer_id, a.knitting_source, a.knitting_company, b.order_id, b.prod_id, b.gsm,b.width, b.yarn_lot, b.yarn_count, b.brand_id, b.machine_no_id, b.stitch_length, b.machine_dia, b.machine_gg, b.color_id, b.febric_description_id, b.insert_date, b.color_range_id,b.operator_name, b.shift_name, b.body_part_id, c.po_breakdown_id from inv_receive_master a, pro_grey_prod_entry_dtls b, pro_roll_details c where a.id=b.mst_id and b.id=c.dtls_id and c.entry_form=2 and c.status_active=1 and c.is_deleted=0 and b.id=$data[1]";
	//echo $sql;die;
	$result = sql_select($sql);
	$party_name = '';
	$prod_date = '';
	$order_id = '';
	$buyer_name = '';
	$grey_dia = '';
	$tube_type = '';
	$program_no = '';
	$booking_no = '';
	$booking_without_order = '';
	$yarn_lot = '';
	$yarn_count = '';$yarn_type_cond = '';
	//$yarn_type = '';
	$brand = '';
	$gsm = '';
	$finish_dia = '';
	$operator_name = '';
	foreach ($result as $row) {
		if ($row[csf('knitting_source')] == 1) {
			$party_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name = return_field_value("short_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}

		if ($row[csf('knitting_source')] == 1) {
			$party_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('knitting_company')]);
		} else if ($row[csf('knitting_source')] == 3) {
			$party_name_full = return_field_value("supplier_name", "lib_supplier", "id=" . $row[csf('knitting_company')]);
		}
		$booking_id=$row[csf("booking_id")];
		$recieve_basis=$row[csf("receive_basis")];
		$booking_no = $row[csf('booking_no')];
		$booking_without_order = $row[csf('booking_without_order')];

		$insert_time = date("H:i", strtotime($row[csf('insert_date')]));
		$prod_date = date("d-m-Y", strtotime($row[csf('receive_date')]));
		$prod_time = date("h:i:a", strtotime($row[csf('insert_date')]));

		//$order_id = $row[csf('order_id')];
		$order_id .= $row[csf('po_breakdown_id')].",";
		$gsm = $row[csf('gsm')];
		$finish_dia = $row[csf('width')];

		$operator_name = $operator_name_arr[$row[csf('operator_name')]];
		$operator_id = $row[csf('operator_name')];
		$shift_name_id = $row[csf('shift_name')];
		$body_part_id = $row[csf('body_part_id')];

		$color = '';
		$color_id = explode(",", $row[csf('color_id')]);
		foreach ($color_id as $val) {
			if ($val > 0) $color .= $color_arr[$val] . ",";
		}
		$color = chop($color, ',');

		$stitch_length = $row[csf('stitch_length')];
		$yarn_lot = $row[csf('yarn_lot')];
		$brand = $brand_arr[$row[csf('brand_id')]];
		$yarn_count = ''; 
		//$yarn_type = '';
		$count_id = explode(",", $row[csf('yarn_count')]);
		foreach ($count_id as $val) {
			if ($val > 0) {
				if ($yarn_count == "") $yarn_count = $count_arr[$val]; else $yarn_count .= "," . $count_arr[$val];
				
			}
		}

		if ($row[csf("receive_basis")] == 2) {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$planning_data = sql_select("select a.within_group, b.width_dia_type, b.machine_dia, b.machine_gg,a.booking_no from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and b.id='" . $row[csf('booking_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $planning_data[0][csf('machine_dia')];
			$machine_gauge = $planning_data[0][csf('machine_gg')];
			$row[csf("within_group")] = $planning_data[0][csf('within_group')];

			$program_no = $row[csf('booking_id')];
			$grey_dia = $planning_data[0][csf('machine_dia')];
			$tube_type = $fabric_typee[$planning_data[0][csf('width_dia_type')]];
			$bookingNo = $planning_data[0][csf('booking_no')];
		} else {
			$machine_data = sql_select("select machine_no, dia_width, gauge from lib_machine_name where id='" . $row[csf('machine_no_id')] . "'");
			$machine_name = $machine_data[0][csf('machine_no')];
			$machine_dia_width = $row[csf('machine_dia')];
			$machine_gauge = $row[csf('machine_gg')];
		}

		if ($row[csf("within_group")] == 1)
			$buyer_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);

			if ($row[csf("within_group")] == 1)
			$buyer_name_full = return_field_value("company_name", "lib_company", "id=" . $row[csf('buyer_id')]);
		else
			$buyer_name_full = return_field_value("buyer_name", "lib_buyer", "id=" . $row[csf('buyer_id')]);
	

			$cons = '';$comp = '';$yarn_type_cond = '';
		if ($row[csf('febric_description_id')] == 0 || $row[csf('febric_description_id')] == "") {
			$comp = return_field_value("item_description", "product_details_master", "id=" . $row[csf('prod_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
		} else {
			$determination_sql = sql_select("select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')]);
			//$yarn_typeId = return_field_value("yarn_type", "product_details_master", "id=" . $row[csf('prod_id')]);
			//echo "select yarn_type from product_details_master where  id=".$row[csf('prod_id')]." ";
			//echo "select a.construction, b.copmposition_id,b.type_id, b.percent from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=" . $row[csf('febric_description_id')];
			//echo $yarn_typeId.'DD';
				$yarn_type_cond=$yarn_type[$yarn_typeId];
			if ($determination_sql[0][csf('construction')] != "") {
				$cons = $determination_sql[0][csf('construction')];
			}

			foreach ($determination_sql as $d_row) {
				$comp = $composition[$d_row[csf('copmposition_id')]] . " " . $d_row[csf('percent')] . "% ";
				
				//$yarn_type_cond .= $yarn_type[$d_row[csf('type_id')]];
			}
		}
		$company_short_name = return_field_value("company_short_name", "lib_company", "id=" . $row[csf('company_id')]);

		
	}
	
	// yarn Type start booking_id 
	
	if ($recieve_basis == 1) {
		if ($booking_without_order == 0) {
			$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_id=$booking_id and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by  c.yarn_type";
		} else {
			$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and  a.booking_no='$booking_no' and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1  and b.status_active=1 and b.is_deleted=0 and a.knit_dye_source in(1,3) group by c.yarn_type";
		}
	} else if ($recieve_basis == 2) {
		$reqsition_sql = sql_select("select  requisition_no from ppl_yarn_requisition_entry where knit_id='$booking_id'");
		$reqsition_number = "";
		foreach ($reqsition_sql as $inf) {
			if (trim($reqsition_number) != "") {
				$reqsition_number .= ",'" . $inf[csf('requisition_no')] . "'";
			} else {
				$reqsition_number = "'" . $inf[csf('requisition_no')] . "'";
			}
		}

		$sql_yarn = "select  c.yarn_type from inv_issue_master a, inv_transaction b, product_details_master c where a.id=b.mst_id and b.requisition_no in($reqsition_number) and a.entry_form=3 and b.prod_id=c.id and a.item_category=1 and a.status_active=1 and a.is_deleted=0 and b.transaction_type=2 and b.item_category=1 and b.status_active=1 and b.is_deleted=0 group by  c.yarn_type";
	}
	$sql_yarn_result = sql_select($sql_yarn);
	//echo $sql_yarn;
	$yarn_typeCond="";
	foreach ($sql_yarn_result as $row)
	{
		$yarn_typeCond.=$yarn_type[$row[csf('yarn_type')]].',';
	}
	$yarntypeCond=rtrim($yarn_typeCond,',');
	$yarn_type_cond=implode(",",array_unique(explode(",",$yarntypeCond)));

	$order_id=implode(",",array_unique(explode(",",chop($order_id,","))));

	//echo $yarn_type_cond.'SS';
	//Yarn Type
	$po_array = array();
	$booking_no_prefix = '';
	if ($booking_without_order == 1) {
		if ($row[csf("receive_basis")] == 4) {
			$sales_info = sql_select("select a.job_no_prefix_num,a.job_no,a.sales_booking_no,b.buyer_id from fabric_sales_order_mst a inner join wo_booking_mst b on a.sales_booking_no = b.booking_no where a.id='" . $row[csf("booking_id")] . "'");
			$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $sales_info[0][csf('buyer_id')]);
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_booking_mst", "booking_no='" . $sales_info[0][csf('sales_booking_no')] . "'");
			$order_no = $sales_info[0][csf('job_no')];
			$bookingNo = $sales_info[0][csf('sales_booking_no')];
		} else {
			$booking_no_prefix = return_field_value("booking_no_prefix_num", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$non_internal_ref= return_field_value("grouping", "wo_non_ord_samp_booking_mst", "booking_no='" . $booking_no . "'");
			$bookingNo = $booking_no;
		}
	} else {
		$is_salesOrder = 0;
		if ($recieve_basis == 2) {
			$is_salesOrder = return_field_value("is_sales", "ppl_planning_info_entry_dtls", "id=" . $booking_id);
		}
		if ($is_salesOrder == 1) {
			$po_sql = sql_select("select a.id, a.job_no_prefix_num,a.job_no as po_number,a.sales_booking_no,a.style_ref_no, customer_buyer from fabric_sales_order_mst a where a.id in ($order_id) ");

			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
				$bookingNo = $row[csf('sales_booking_no')];
				$buyer_name = return_field_value("short_name", "lib_buyer", "id=" . $row[csf('customer_buyer')]);
			}
		} else {
			$po_sql = sql_select("select a.job_no, a.job_no_prefix_num, b.id,b.grouping, b.po_number,a.style_ref_no from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.id in($order_id) group by a.job_no,a.job_no_prefix_num,b.id,b.grouping,b.po_number");
			foreach ($po_sql as $row) {
				$po_array[$row[csf('id')]]['no'] = $row[csf('po_number')];
				$po_array[$row[csf('id')]]['job_no'] = $row[csf('job_no')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['prefix'] = $row[csf('job_no_prefix_num')];
				$po_array[$row[csf('id')]]['grouping'] = $row[csf('grouping')];
				$po_array[$row[csf('id')]]['style_ref_no'] = $row[csf('style_ref_no')];
			}
			//$order_no = $po_array[$order_id]['no'];
		}
	}

	$body_part_type = return_field_value("body_part_type", "lib_body_part", "id=$body_part_id and body_part_type in(40,50) and status_active=1 and is_deleted=0" );

	$i = 1;
	$barcode_array = array();
	$query = "SELECT a.id, a.roll_no, a.po_breakdown_id, a.barcode_no, a.qnty, b.fabric_grade, a.qc_pass_qnty_pcs as qnty_pcs, a.coller_cuff_size from pro_roll_details a left join pro_qc_result_mst b on a.barcode_no=b.barcode_no where a.id in($data[0])";
	$res = sql_select($query);
	$pdf=new PDF_Code128('P','mm', array(65,55));
	$pdf->AddPage();
	$pdf->SetFont('Arial','',10);

	$pdf->SetAutoPageBreak(false);
	$pdf->SetRightMargin(0);

	$i=2; $j=3; $k=0; $br=0; $n=0;
	foreach ($res as $row) {
		

		$operatorName = substr($operator_name, 0, 13);

		if ($is_salesOrder == 1) {
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['job_no'];
			$order_no = $bookingNo;
		}
		else
		{
			$poNO=$po_array[$row[csf('po_breakdown_id')]]['job_no'];
			$order_no = $po_array[$row[csf('po_breakdown_id')]]['no'];
		}

		$style_ref_no=$po_array[$row[csf('po_breakdown_id')]]['style_ref_no'];

		if ($row[csf("receive_basis")] == 1 && $booking_without_order=1)
		{
			$internal_ref=$non_internal_ref;
		}
		else
		{
			if($po_array[$row[csf('po_breakdown_id')]]['grouping']!="") $internal_ref=$po_array[$row[csf('po_breakdown_id')]]['grouping'];
			else $internal_ref="";
		}

		$qnty_pcs='';$coller_cuff_size="";
		if ($body_part_type == 40 || $body_part_type == 50)
		{
			$qnty_pcs = "Qty:" . $row[csf('qnty_pcs')]. " Pcs";
			$coller_cuff_size = "SZ: " . $row[csf('coller_cuff_size')];
		}

		if($br==1)
		{
			$pdf->AddPage(); $br=0; $i=2; $j=3; $k=0;
		}


		$bookingNoArr=explode("-", $bookingNo);
		$bookingNos=$bookingNoArr[1]."-".$bookingNoArr[2]."-".$bookingNoArr[3];


		//$pdf->SetFont('Calibri','',11);
		$pdf->SetFont('Arial','B',10);
		$pdf->Code128($i+5,$j,$row[csf("barcode_no")],50,8);

		$pdf->SetFont('Arial','',10);
		$pdf->SetXY($i+18, $j+11.2);
		$pdf->Write(0, $row[csf("barcode_no")]);

		$pdf->SetXY($i, $j+15.2);
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, "Dt: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, $prod_date );
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, ", M/N: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, $machine_name );
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, ", Shift: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, $shift_name[$shift_name_id] );

		$pdf->SetXY($i, $j+19.2);
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, "Buyer: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, $buyer_name );
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, ", Int.B: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, $internal_ref );

		$pdf->SetXY($i, $j+23.2);
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, "F.Const: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, $cons.', '.$machine_dia_width."X".$machine_gauge.', '.trim($tube_type).', '.$gsm  );

		$pdf->SetXY($i, $j+27.2);
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, "F.Comp: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, $comp);

		$pdf->SetXY($i, $j+31.2);
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, "F.Clr: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, substr($color, 0, 25) );

		$pdf->SetXY($i, $j+35.2);
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, "YC: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, $yarn_count );
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, ", YT: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, $yarn_type_cond );

		$pdf->SetXY($i, $j+39.2);
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, "B: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, $brand );
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, ", L: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, $yarn_lot );

		$pdf->SetXY($i, $j+43.2);
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, "OC: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, $company_short_name );
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, ", KC: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, $party_name );
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, ", St/L: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, trim($stitch_length) );
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, ", R.WT: ");
		$pdf->SetFont('Arial','',7);
		$pdf->Write(0, number_format($row[csf('qnty')], 2, '.', ''). " Kg" );

		$pdf->SetXY($i, $j+47.2);
		$pdf->SetFont('Arial','B',7);
		$pdf->Write(0, "OP: ".$operatorName[$operator_id]);
		
		$k++;
		$br++;
	}

	foreach (glob(""."*.pdf") as $filename) {
		@unlink($filename);
	}
	$name ='knitting_barcode_'.date('j-M-Y_h-iA').'.pdf';
	$pdf->Output( "".$name, 'F');
	echo "requires/".$name;
	exit();
}



?>
